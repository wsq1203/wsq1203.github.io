<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>系统启动和内核管理 | ૮(˶ᵔ ᵕ ᵔ˶)ა</title><meta name="author" content="૮(˶ᵔ ᵕ ᵔ˶)ა"><meta name="copyright" content="૮(˶ᵔ ᵕ ᵔ˶)ა"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="ffffff"><meta name="description" content="Site Reliability Engineering">
<meta property="og:type" content="article">
<meta property="og:title" content="系统启动和内核管理">
<meta property="og:url" content="http://example.com/2024/12/01/SRE-%E7%B3%BB%E7%BB%9F%E5%90%AF%E5%8A%A8%E5%92%8C%E5%86%85%E6%A0%B8%E7%AE%A1%E7%90%86/index.html">
<meta property="og:site_name" content="૮(˶ᵔ ᵕ ᵔ˶)ა">
<meta property="og:description" content="Site Reliability Engineering">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://example.com/images/TITLE/linux4.jpg">
<meta property="article:published_time" content="2024-11-30T16:00:00.000Z">
<meta property="article:modified_time" content="2025-04-01T11:34:55.980Z">
<meta property="article:author" content="૮(˶ᵔ ᵕ ᵔ˶)ა">
<meta property="article:tag" content="SRE">
<meta property="article:tag" content="Linux">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://example.com/images/TITLE/linux4.jpg"><link rel="shortcut icon" href="/../images/TITLE/user.webp"><link rel="canonical" href="http://example.com/2024/12/01/SRE-%E7%B3%BB%E7%BB%9F%E5%90%AF%E5%8A%A8%E5%92%8C%E5%86%85%E6%A0%B8%E7%AE%A1%E7%90%86/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//fonts.googleapis.com" crossorigin=""/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Titillium+Web&amp;display=swap" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":false,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: true,
    post: true
  },
  runtime: '天',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: {"chs_to_cht":"你已切换为繁体","cht_to_chs":"你已切换为简体","day_to_night":"你已切换为深色模式","night_to_day":"你已切换为浅色模式","bgLight":"#49b1f5","bgDark":"#1f1f1f","position":"top-center"},
  source: {
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: true,
  }
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: '系统启动和内核管理',
  isPost: true,
  isHome: false,
  isHighlightShrink: undefined,
  isToc: true,
  postUpdate: '2025-04-01 19:34:55'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
    win.getCSS = (url,id = false) => new Promise((resolve, reject) => {
      const link = document.createElement('link')
      link.rel = 'stylesheet'
      link.href = url
      if (id) link.id = id
      link.onerror = reject
      link.onload = link.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        link.onload = link.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(link)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', 'ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><link rel="stylesheet" href="/css/custom.css"  media="defer" onload="this.media='all'"><meta name="generator" content="Hexo 5.4.2"></head><body><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="/../images/TITLE/user.webp" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">99</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">41</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">34</div></a></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间线</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('/../images/TITLE/linux4.jpg')"><nav id="nav"><span id="blog-info"><a href="/" title="૮(˶ᵔ ᵕ ᵔ˶)ა"><span class="site-name">૮(˶ᵔ ᵕ ᵔ˶)ა</span></a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间线</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">系统启动和内核管理</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2024-11-30T16:00:00.000Z" title="发表于 2024-12-01 00:00:00">2024-12-01</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2025-04-01T11:34:55.980Z" title="更新于 2025-04-01 19:34:55">2025-04-01</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/Linux/">Linux</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">字数总计:</span><span class="word-count">10.5k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>48分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="系统启动和内核管理"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="CentOS-6启动管理"><a href="#CentOS-6启动管理" class="headerlink" title="CentOS 6启动管理"></a>CentOS 6启动管理</h1><p><strong>CentOS 6 启动流程</strong></p>
<p><img src="../../../../images/SRE/day14/1.png" alt="1"></p>
<ol>
<li>加载BIOS的硬件信息，获取第一个启动设备</li>
<li>读取第一个启动设备MBR的引导加载程序(grub)的启动信息 </li>
<li>加载核心操作系统的核心信息，核心开始解压缩，并尝试驱动所有的硬件设备</li>
<li>核心执行init程序，并获取默认的运行信息</li>
<li>init程序执行/etc/rc.d/rc.sysinit文件，重新挂载根文件系统</li>
<li>启动核心的外挂模块</li>
<li>init执行运行的各个批处理文件(scripts)</li>
<li>init执行/etc/rc.d/rc.local</li>
<li>执行/bin/login程序，等待用户登录</li>
<li>登录之后开始以Shell控制主机</li>
</ol>
<h2 id="硬件启动POST"><a href="#硬件启动POST" class="headerlink" title="硬件启动POST"></a>硬件启动POST</h2><p>POST：Power-On-Self-Test，加电自检，是BIOS功能的一个主要部分。负责完成对CPU、主板、内存、硬盘子系统、显示子系统、串并行接口、键盘等硬件情况的检测</p>
<p>主板的ROM：BIOS，Basic Input and Output System，保存着有关计算机系统最重要的基本输入输出程序，系统信息设置、开机加电自检程序和系统启动自举程序等</p>
<p>主板的RAM：CMOS互补金属氧化物半导体，保存各项参数的设定，按次序查找引导设备，第一个有引导程序的设备为本次启动设备</p>
<h2 id="启动加载器-bootloader"><a href="#启动加载器-bootloader" class="headerlink" title="启动加载器 bootloader"></a>启动加载器 bootloader</h2><h3 id="grub-功能和组成"><a href="#grub-功能和组成" class="headerlink" title="grub 功能和组成"></a>grub 功能和组成</h3><p>bootloader: 引导加载器，引导程序</p>
<ul>
<li>Windows: ntloader，仅是启动OS </li>
<li>Linux：功能丰富，提供菜单，允许用户选择要启动系统或不同的内核版本；把用户选定的内核装载到内存中的特定空间中，解压、展开，并把系统控制权移交给内核</li>
</ul>
<p>Linux的bootloader</p>
<ul>
<li>LILO：LInux LOader，早期的bootloader，功能单一</li>
<li>GRUB: GRand Unified Bootloader, CentOS 5,6 GRUB 0.97: GRUB Legacy， CentOS 7 以后使用GRUB 2.02 </li>
</ul>
<p>GRUB 启动阶段</p>
<ul>
<li><p>primary boot loader :  </p>
<p>1st stage：MBR的前446个字节 </p>
<p>1.5 stage：MBR 之后的扇区，让stage1中的bootloader能识别stage2所在的分区上的文件系统 </p>
<p>secondary boot loader ：2nd stage，分区文件/boot/grub/</p>
</li>
</ul>
<h3 id="CentOS-6-grub-安装"><a href="#CentOS-6-grub-安装" class="headerlink" title="CentOS 6 grub 安装"></a>CentOS 6 grub 安装</h3><p>安装 grub的两种方法： </p>
<p>(1) grub-install 安装grub stage1和stage1_5到/dev/DISK磁盘上，并复制GRUB相关文件到 DIR/boot目录下</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">grub-install --root-directory=DIR /dev/DISK</span><br></pre></td></tr></table></figure>

<p>(2) grub命令</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#grub</span></span><br><span class="line">grub&gt; root (hd<span class="comment">#,#)</span></span><br><span class="line">grub&gt; setup (hd<span class="comment">#)</span></span><br></pre></td></tr></table></figure>

<p>范例: 利用grub命令修复grub</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">[root@centos6 ~]<span class="comment"># dd if=/dev/zero of=/dev/sda bs=1 count=446</span></span><br><span class="line">446+0 records <span class="keyword">in</span></span><br><span class="line">446+0 records out</span><br><span class="line">446 bytes (446 B) copied, 0.00070171 s, 636 kB/s</span><br><span class="line"></span><br><span class="line">[root@centos6 ~]<span class="comment"># grub</span></span><br><span class="line">Probing devices to guess BIOS drives. This may take a long time.</span><br><span class="line">   GNU GRUB version 0.97 (640K lower / 3072K upper memory)</span><br><span class="line"> [ Minimal BASH-like line editing is supported. For the first word, TAB</span><br><span class="line">   lists possible <span class="built_in">command</span> completions. Anywhere <span class="keyword">else</span> TAB lists the possible</span><br><span class="line">   completions of a device/filename.]</span><br><span class="line">grub&gt; root (hd0,0)</span><br><span class="line">root (hd0,0)</span><br><span class="line"> Filesystem <span class="built_in">type</span> is ext2fs, partition <span class="built_in">type</span> 0x83</span><br><span class="line">grub&gt; setup (hd0) </span><br><span class="line">setup (hd0)</span><br><span class="line"> Checking <span class="keyword">if</span> <span class="string">&quot;/boot/grub/stage1&quot;</span> exists... no</span><br><span class="line"> Checking <span class="keyword">if</span> <span class="string">&quot;/grub/stage1&quot;</span> exists... <span class="built_in">yes</span></span><br><span class="line"> Checking <span class="keyword">if</span> <span class="string">&quot;/grub/stage2&quot;</span> exists... <span class="built_in">yes</span></span><br><span class="line"> Checking <span class="keyword">if</span> <span class="string">&quot;/grub/e2fs_stage1_5&quot;</span> exists... <span class="built_in">yes</span></span><br><span class="line"> Running <span class="string">&quot;embed /grub/e2fs_stage1_5 (hd0)&quot;</span>...  27 sectors are embedded.</span><br><span class="line">succeeded</span><br><span class="line"> Running <span class="string">&quot;install /grub/stage1 (hd0) (hd0)1+27 p (hd0,0)/grub/stage2 </span></span><br><span class="line"><span class="string">/grub/grub.conf&quot;</span>... succeeded</span><br><span class="line">Done.</span><br><span class="line">grub&gt; quit</span><br><span class="line">[root@centos6 ~]<span class="comment">#</span></span><br></pre></td></tr></table></figure>

<p>范例：grub的第1阶段故障无法启动,进行修复</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><span class="line">[root@centos6 grub]<span class="comment">#hexdump -C -n 512 /dev/sda</span></span><br><span class="line">00000000 eb 48 90 10 8e d0 bc 00 b0 b8 00 00 8e d8 8e c0 |.H..............|</span><br><span class="line">00000010 fb be 00 7c bf 00 06 b9  00 02 f3 a4 ea 21 06 00 |...|.........!..|</span><br><span class="line">00000020  00 be be 07 38 04 75 0b  83 c6 10 81 fe fe 07 75 |....8.u........u|</span><br><span class="line">00000030 f3 eb 16 b4 02 b0 01 bb  00 7c b2 80 8a 74 03 02 |.........|...t..|</span><br><span class="line">00000040  80 00 00 80 b0 0c 05 00  00 08 fa 90 90 f6 c2 80 |................|</span><br><span class="line">00000050  75 02 b2 80 ea 59 7c 00  00 31 c0 8e d8 8e d0 bc |u....Y|..1......|</span><br><span class="line">00000060  00 20 fb a0 40 7c 3c ff  74 02 88 c2 52 f6 c2 80 |. ..@|&lt;.t...R...|</span><br><span class="line">00000070  74 54 b4 41 bb aa 55 <span class="built_in">cd</span>  13 5a 52 72 49 81 fb 55 |tT.A..U..ZRrI..U|</span><br><span class="line">00000080 aa 75 43 a0 41 7c 84 c0  75 05 83 e1 01 74 37 66 |.uC.A|..u....t7f|</span><br><span class="line">00000090 8b 4c 10 be 05 7c c6 44 ff 01 66 8b 1e 44 7c c7 |.L...|.D..f..D|.|</span><br><span class="line">000000a0  04 10 00 c7 44 02 01 00  66 89 5c 08 c7 44 06 00 |....D...f.\..D..|</span><br><span class="line">000000b0  70 66 31 c0 89 44 04 66  89 44 0c b4 42 <span class="built_in">cd</span> 13 72 |pf1..D.f.D..B..r|</span><br><span class="line">000000c0  05 bb 00 70 eb 7d b4 08  <span class="built_in">cd</span> 13 73 0a f6 c2 80 0f |...p.&#125;....s.....|</span><br><span class="line">000000d0  84 f0 00 e9 8d 00 be 05 7c c6 44 ff 00 66 31 c0 |........|.D..f1.|</span><br><span class="line">000000e0  88 f0 40 66 89 44 04 31 d2 88 ca c1 e2 02 88 e8 |..@f.D.1........|</span><br><span class="line">000000f0  88 f4 40 89 44 08 31 c0  88 d0 c0 e8 02 66 89 04 |..@.D.1......f..|</span><br><span class="line">00000100  66 a1 44 7c 66 31 d2 66 f7 34 88 54 0a 66 31 d2 |f.D|f1.f.4.T.f1.|</span><br><span class="line">00000110  66 f7 74 04 88 54 0b 89  44 0c 3b 44 08 7d 3c 8a |f.t..T..D.;D.&#125;&lt;.|</span><br><span class="line">00000120  54 0d c0 e2 06 8a 4c 0a fe c1 08 d1 8a 6c 0c 5a |T.....L......l.Z|</span><br><span class="line">00000130 8a 74 0b bb 00 70 8e c3  31 db b8 01 02 <span class="built_in">cd</span> 13 72 |.t...p..1......r|</span><br><span class="line">00000140 2a 8c c3 8e 06 48 7c 60 1e b9 00 01 8e db 31 f6 |*....H|`......1.|</span><br><span class="line">00000150  31 ff <span class="built_in">fc</span> f3 a5 1f 61 ff  26 42 7c be 7f 7d e8 40 |1.....a.&amp;B|..&#125;.@|</span><br><span class="line">00000160  00 eb 0e be 84 7d e8 38  00 eb 06 be 8e 7d e8 30 |.....&#125;.8.....&#125;.0|</span><br><span class="line">00000170  00 be 93 7d e8 2a 00 eb fe 47 52 55 42 20 00 47 |...&#125;.*...GRUB .G|</span><br><span class="line">00000180  65 6f 6d 00 48 61 72 64  20 44 69 73 6b 00 52 65 |eom.Hard Disk.Re|</span><br><span class="line">00000190  61 64 00 20 45 72 72 6f  72 00 bb 01 00 b4 0e <span class="built_in">cd</span> |ad. Error.......|</span><br><span class="line">000001a0  10 ac 3c 00 75 f4 c3 00  00 00 00 00 00 00 00 00 |..&lt;.u...........|</span><br><span class="line">000001b0  00 00 00 00 00 00 00 00 e0 96 01 00 00 00 80 20 |............... |</span><br><span class="line">000001c0  21 00 83 aa 28 82 00 08  00 00 00 00 20 00 00 aa |!...(....... ...|</span><br><span class="line">000001d0  29 82 83 fe ff ff 00 08  20 00 00 80 1a 06 00 fe |)....... .......|</span><br><span class="line">000001e0 ff ff 83 fe ff ff 00 88 3a 06 00 00 71 02 00 fe |........:...q...|</span><br><span class="line">000001f0 ff ff 05 fe ff ff 00 88  ab 08 00 78 54 10 55 aa |...........xT.U.|</span><br><span class="line">00000200</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#破坏grub第1阶段</span></span><br><span class="line">[root@centos6 grub]<span class="comment">#dd if=/dev/zero of=/dev/sda bs=1 count=446</span></span><br><span class="line">446+0 records <span class="keyword">in</span></span><br><span class="line">446+0 records out</span><br><span class="line">446 bytes (446 B) copied, 0.000871905 s, 512 kB/s</span><br><span class="line">[root@centos6 grub]<span class="comment">#hexdump -C -n 512 /dev/sda</span></span><br><span class="line">00000000  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00 |................|</span><br><span class="line">*</span><br><span class="line">000001b0  00 00 00 00 00 00 00 00  00 00 00 00 00 00 80 20 |............... |</span><br><span class="line">000001c0  21 00 83 aa 28 82 00 08  00 00 00 00 20 00 00 aa |!...(....... ...|</span><br><span class="line">000001d0  29 82 83 fe ff ff 00 08  20 00 00 80 1a 06 00 fe |)....... .......|</span><br><span class="line">000001e0 ff ff 83 fe ff ff 00 88 3a 06 00 00 71 02 00 fe |........:...q...|</span><br><span class="line">000001f0 ff ff 05 fe ff ff 00 88  ab 08 00 78 54 10 55 aa |...........xT.U.|</span><br><span class="line">00000200</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@centos6 grub]<span class="comment">#hexdump -C -n 512 /dev/sda -v</span></span><br><span class="line">00000000  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00 |................|</span><br><span class="line">00000010  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00 |................|</span><br><span class="line">00000020  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00 |................|</span><br><span class="line">00000030  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00 |................|</span><br><span class="line">00000040  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00 |................|</span><br><span class="line">00000050  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00 |................|</span><br><span class="line">00000060  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00 |................|</span><br><span class="line">00000070  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00 |................|</span><br><span class="line">00000080  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00 |................|</span><br><span class="line">00000090  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00 |................|</span><br><span class="line">000000a0  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00 |................|</span><br><span class="line">000000b0  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00 |................|</span><br><span class="line">000000c0  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00 |................|</span><br><span class="line">000000d0  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00 |................|</span><br><span class="line">000000e0  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00 |................|</span><br><span class="line">000000f0  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00 |................|</span><br><span class="line">00000100  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00 |................|</span><br><span class="line">00000110  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00 |................|</span><br><span class="line">00000120  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00 |................|</span><br><span class="line">00000130  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00 |................|</span><br><span class="line">00000140  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00 |................|</span><br><span class="line">00000150  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00 |................|</span><br><span class="line">00000160  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00 |................|</span><br><span class="line">00000170  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00 |................|</span><br><span class="line">00000180  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00 |................|</span><br><span class="line">00000190  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00 |................|</span><br><span class="line">000001a0  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00 |................|</span><br><span class="line">000001b0  00 00 00 00 00 00 00 00  00 00 00 00 00 00 80 20 |............... |</span><br><span class="line">000001c0  21 00 83 aa 28 82 00 08  00 00 00 00 20 00 00 aa |!...(....... ...|</span><br><span class="line">000001d0  29 82 83 fe ff ff 00 08  20 00 00 80 1a 06 00 fe |)....... .......|</span><br><span class="line">000001e0 ff ff 83 fe ff ff 00 88 3a 06 00 00 71 02 00 fe |........:...q...|</span><br><span class="line">000001f0 ff ff 05 fe ff ff 00 88  ab 08 00 78 54 10 55 aa |...........xT.U.|</span><br><span class="line">00000200</span><br><span class="line"></span><br><span class="line">[root@centos6 grub]<span class="comment">#reboot</span></span><br><span class="line"><span class="comment">#无法启动，出现下面提示</span></span><br></pre></td></tr></table></figure>

<p><img src="../../../../images/SRE/day14/2.png" alt="2"></p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">光盘启动，进入rescue模式</span><br><span class="line">#chroot /mnt/sysimage</span><br><span class="line">#grub-install /dev/sda</span><br><span class="line">#sync </span><br><span class="line">#exit</span><br><span class="line">#exit</span><br></pre></td></tr></table></figure>

<p>范例：修复grub的第1.5 阶段故障</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@centos6 ~]<span class="comment">#dd if=/dev/zero of=/dev/sda bs=512 count=25 seek=1</span></span><br><span class="line">[root@centos6 ~]<span class="comment">#reboot</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#无法启动，显示下黑屏</span></span><br></pre></td></tr></table></figure>

<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">光盘启动，进入rescue模式</span><br><span class="line"><span class="comment">#chroot /mnt/sysimage</span></span><br><span class="line"><span class="comment">#grub-install /dev/sda</span></span><br><span class="line"><span class="comment">#sync </span></span><br><span class="line"><span class="comment">#按 ctrl+alt+delete 三个键重启动</span></span><br></pre></td></tr></table></figure>

<h3 id="grub-legacy-管理"><a href="#grub-legacy-管理" class="headerlink" title="grub legacy 管理"></a>grub legacy 管理</h3><p>配置文件：/boot/grub/grub.conf &lt;– /etc/grub.conf</p>
<p>stage2及内核等通常放置于一个基本磁盘分区</p>
<p>grub legacy 功用：</p>
<p>(1) 提供启动菜单、并提供交互式接口 </p>
<p> a：内核参数<br> e：编辑模式，用于编辑菜单<br> c：命令模式，交互式接口</p>
<p>(2) 加载用户选择的内核或操作系统 允许传递参数给内核 可隐藏启动菜单</p>
<p>(3) 为菜单提供了保护机制 为编辑启动菜单进行认证 为启用内核或操作系统进行认证</p>
<p>grub的命令行接口</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">help</span>: 获取帮助列表</span><br><span class="line"><span class="built_in">help</span> KEYWORD: 详细帮助信息</span><br><span class="line">find (hd<span class="comment">#,#)/PATH/TO/SOMEFILE：</span></span><br><span class="line">root (hd<span class="comment">#,#)</span></span><br><span class="line">kernel /PATH/TO/KERNEL_FILE: 设定本次启动的内核文件；额外还可添加许多内核支持使用的cmdline参数</span><br><span class="line"></span><br><span class="line"> 例如：max_loop=100 selinux=0 init=/path/to/init</span><br><span class="line">initrd /PATH/TO/INITRAMFS_FILE: 设定为选定的内核提供额外文件的ramdisk</span><br><span class="line">boot: 引导启动选定的内核</span><br></pre></td></tr></table></figure>

<p>cat /proc/cmdline 内核参数</p>
<p>内核参数文档:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/usr/share/doc/kernel-doc-2.6.32/Documentation/kernel-parameters.txt</span><br></pre></td></tr></table></figure>

<p>grub legacy识别硬盘设备</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">(hd<span class="comment">#,#)</span></span><br><span class="line">hd<span class="comment">#: 磁盘编号，用数字表示；从0开始编号</span></span><br><span class="line"><span class="comment">#: 分区编号，用数字表示; 从0开始编号</span></span><br><span class="line"></span><br><span class="line">示例：</span><br><span class="line">(hd0,0) 第一块硬盘，第一个分区</span><br></pre></td></tr></table></figure>

<p>手动在grub命令行接口启动系统</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">grub&gt; root (hd<span class="comment">#,#)</span></span><br><span class="line">grub&gt; kernel /vmlinuz-VERSION-RELEASE ro root=/dev/DEVICE </span><br><span class="line">grub&gt; initrd /initramfs-VERSION-RELEASE.img</span><br><span class="line">grub&gt; boot</span><br></pre></td></tr></table></figure>

<p>grub legacy配置文件：/boot/grub/grub.conf</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">default=<span class="comment">#:                              #设定默认启动的菜单项；落单项(title)编号从0开始</span></span><br><span class="line"><span class="built_in">timeout</span>=<span class="comment">#:                              #指定菜单项等待选项选择的时长</span></span><br><span class="line">splashimage=(hd<span class="comment">#,#)/PATH/XPM_FILE:      #菜单背景图片文件路径</span></span><br><span class="line">password [--md5| --encrypt] STRING:     <span class="comment">#启动菜单编辑认证</span></span><br><span class="line">hiddenmenu:                             <span class="comment">#隐藏菜单</span></span><br><span class="line">title TITLE:                            <span class="comment">#定义菜单项“标题”, 可出现多次</span></span><br><span class="line">root (hd<span class="comment">#,#):                           #查找stage2及kernel文件所在设备分区；为grub的根</span></span><br><span class="line">kernel /PATH/TO/VMLINUZ_FILE [PARAMETERS]: <span class="comment">#启动的内核</span></span><br><span class="line">initrd /PATH/TO/INITRAMFS_FILE:            <span class="comment">#内核匹配的ramfs文件</span></span><br><span class="line">password [--md5|--encrypted ] STRING:      <span class="comment">#启动选定的内核或操作系统时进行认证</span></span><br></pre></td></tr></table></figure>

<p>grub加密生成grub口令</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">grub-md5-crypt</span><br><span class="line">grub-crypt</span><br></pre></td></tr></table></figure>

<p>破解root口令：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">(1) 编辑grub菜单(选定要编辑的title，而后使用a 或 e 命令)</span><br><span class="line">(2) 在选定的kernel后附加1, s, S，single 都可以进入单用户模式</span><br><span class="line">(3) 在kernel所在行，键入“b”命令</span><br></pre></td></tr></table></figure>

<p>范例: 给grub 添加密码,防止破解root密码</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[root@centos6 ~]<span class="comment">#grub-crypt </span></span><br><span class="line">Password: </span><br><span class="line">Retype password: </span><br><span class="line">$6$RedtvBe0D0sM8yKq<span class="variable">$yKwmmnHSDb9wDRUuZbC3H1ZNwIlf</span>/Mh88MXa3JzXloXyy0hXIxFwLIoMdgmYFfkWXxkP.vW3ypIla4P5zUKuT.</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@centos6 ~]<span class="comment">#vim /boot/grub/grub.conf</span></span><br><span class="line">default=0</span><br><span class="line"><span class="built_in">timeout</span>=5</span><br><span class="line">password --encrypt</span><br><span class="line">$6$RedtvBe0D0sM8yKq<span class="variable">$yKwmmnHSDb9wDRUuZbC3H1ZNwIlf</span>/Mh88MXa3JzXloXyy0hXIxFwLIoMdgmYFfkWXxkP.vW3ypIla4P5zUKuT.</span><br><span class="line">splashimage=(hd0,0)/grub/splash.xpm.gz</span><br><span class="line">hiddenmenu</span><br><span class="line">title CentOS 6 (2.6.32-754.el6.x86_64)</span><br></pre></td></tr></table></figure>

<p>范例：生成grub启动背景图片</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@centos6 ~]<span class="comment">#convert -resize 640x480 -colors 14 winner.png splash.xpm</span></span><br><span class="line">[root@centos6 ~]<span class="comment">#more splash.xpm</span></span><br><span class="line"><span class="comment">#生成splash.xpm.gz</span></span><br><span class="line">[root@centos6 ~]<span class="comment">#gzip   splash.xpm </span></span><br><span class="line">[root@centos6 ~]<span class="comment">#mv splash.xpm.gz /boot/grub</span></span><br></pre></td></tr></table></figure>

<h2 id="加载-kernel"><a href="#加载-kernel" class="headerlink" title="加载 kernel"></a>加载 kernel</h2><p>kernel 自身初始化过程</p>
<ol>
<li>探测可识别到的所有硬件设备 </li>
<li>加载硬件驱动程序（借助于ramdisk加载驱动）</li>
<li>以只读方式挂载根文件系统</li>
<li>运行用户空间的第一个应用程序：/sbin/init </li>
</ol>
<p>Linux内核特点：</p>
<ul>
<li>支持模块化：.ko（内核对象），如：文件系统，硬件驱动，网络协议等</li>
<li>支持内核模块的动态装载和卸载</li>
</ul>
<p>内核组成部分：</p>
<ul>
<li>核心文件：/boot/vmlinuz-VERSION-release</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">ramdisk：辅助的伪根系统，加载相应的硬件驱动，ramdisk --&gt; ramfs 提高速度</span><br><span class="line"></span><br><span class="line">CentOS 5 /boot/initrd-VERSION-release.img</span><br><span class="line"></span><br><span class="line">CentOS 6 以后版本 /boot/initramfs-VERSION-release.img  </span><br></pre></td></tr></table></figure>

<ul>
<li>模块文件：/lib/modules/VERSION-release </li>
</ul>
<p>范例：误删除内核文件/boot/vmlinuz-2.6.32-754.el6.x86_64无法启动，故障恢复</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[root@centos6 ~]<span class="comment">#rm -f /boot/vmlinuz-2.6.32-754.el6.x86_64</span></span><br><span class="line"></span><br><span class="line">[root@centos6 ~]<span class="comment">#reboot</span></span><br><span class="line"><span class="comment">#进入rescue模式</span></span><br><span class="line"><span class="comment">#chroot /mnt/sysimage</span></span><br><span class="line"><span class="comment">#mount /dev/sr0 /mnt/</span></span><br><span class="line"><span class="comment">#cp /mnt/isolinux/vmlinuz /boot/vmlinuz-2.6.32-754.el6.x86_64</span></span><br><span class="line"><span class="comment">#sync</span></span><br><span class="line"><span class="comment">#exit</span></span><br><span class="line"><span class="comment">#reboot</span></span><br></pre></td></tr></table></figure>

<p>ramdisk文件的制作：</p>
<ul>
<li>mkinitrd命令</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mkinitrd /boot/initramfs-$(<span class="built_in">uname</span> -r).img $(<span class="built_in">uname</span> -r)</span><br></pre></td></tr></table></figure>

<ul>
<li>dracut命令</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dracut /boot/initramfs-$(<span class="built_in">uname</span> -r).img $(<span class="built_in">uname</span> -r) </span><br></pre></td></tr></table></figure>

<p>范例：误删除/boot/initramfs-2.6.32-754.el6.x86_64.img无法启动，故障恢复</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@centos6 ~]<span class="comment">#rm -f /boot/initramfs-2.6.32-754.el6.x86_64.img</span></span><br><span class="line">[root@centos6 ~]<span class="comment">#reboot</span></span><br><span class="line"><span class="comment">#进入rescue模式</span></span><br><span class="line"><span class="comment">#chroot /mnt/sysimage</span></span><br><span class="line"><span class="comment">#mkinitrd /boot/initramfs-$(uname -r).img $(uname -r)</span></span><br><span class="line"><span class="comment">#sync</span></span><br><span class="line"><span class="comment">#exit</span></span><br><span class="line"><span class="comment">#exit</span></span><br><span class="line"><span class="comment">#reboot</span></span><br></pre></td></tr></table></figure>

<h2 id="init初始化"><a href="#init初始化" class="headerlink" title="init初始化"></a>init初始化</h2><p>POST –&gt; BootSequence (BIOS) –&gt; Bootloader(MBR) –&gt; kernel(ramdisk) –&gt; rootfs(只读) –&gt; init（systemd）</p>
<p>init程序的类型：</p>
<p>SysV: init, CentOS 5之前</p>
<p>​        配置文件：/etc/inittab</p>
<p>Upstart: init,CentOS 6</p>
<p>​        配置文件：/etc/inittab, /etc/init/*.conf\</p>
<p>Systemd：systemd, CentOS 7</p>
<p>​        配置文件：/usr/lib/systemd/system</p>
<p>​                            /etc/systemd/system</p>
<h3 id="运行级别"><a href="#运行级别" class="headerlink" title="运行级别"></a>运行级别</h3><p>运行级别：为系统运行或维护等目的而设定；0-6：7个级别，一般使用3, 5做为默认级别</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">0：关机</span><br><span class="line">1：单用户模式(root自动登录), single, 维护模式</span><br><span class="line">2：多用户模式，启动网络功能，但不会启动NFS；维护模式</span><br><span class="line">3：多用户模式，正常模式；文本界面</span><br><span class="line">4：预留级别；可同3级别</span><br><span class="line">5：多用户模式，正常模式；图形界面</span><br><span class="line">6：重启</span><br></pre></td></tr></table></figure>

<p>切换级别：</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">init #</span><br></pre></td></tr></table></figure>

<p>查看级别：</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">runlevel</span><br><span class="line">who -r</span><br></pre></td></tr></table></figure>

<p>定义运行级别</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/etc/inittab</span><br></pre></td></tr></table></figure>

<p>CentOS 5 的inittab文件还定义以下内容</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">初始运行级别(RUN LEVEL)</span><br><span class="line">系统初始化脚本</span><br><span class="line">对应运行级别的脚本目录</span><br><span class="line">捕获某个关键字顺序</span><br><span class="line">定义UPS电源终端/恢复脚本</span><br><span class="line">在虚拟控制台生成getty</span><br><span class="line">在运行级别5初始化X</span><br></pre></td></tr></table></figure>

<p>CentOS 5 的inittab文件每一行格式：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">id</span>:runlevel:action:process</span><br><span class="line"></span><br><span class="line"><span class="built_in">id</span>：是惟一标识该项的字符序列</span><br><span class="line">runlevels： 定义了操作所使用的运行级别</span><br><span class="line">action： 指定了要执行的特定操作</span><br><span class="line">         <span class="built_in">wait</span>: 切换至此级别运行一次</span><br><span class="line">         respawn：此process终止，就重新启动之</span><br><span class="line">         initdefault：设定默认运行级别；process省略</span><br><span class="line">         sysinit：设定系统初始化方式</span><br><span class="line">process：定义了要执行的进程</span><br></pre></td></tr></table></figure>

<p>范例：CentOS 5 的inittab文件</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">id</span>:5:initdefault:</span><br><span class="line">si::sysinit:/etc/rc.d/rc.sysinit</span><br><span class="line">l0:0:<span class="built_in">wait</span>:/etc/rc.d/rc 0</span><br><span class="line">l1:1:<span class="built_in">wait</span>:/etc/rc.d/rc 1</span><br><span class="line">l2:2:<span class="built_in">wait</span>:/etc/rc.d/rc 2</span><br><span class="line">l3:3:<span class="built_in">wait</span>:/etc/rc.d/rc 3</span><br><span class="line">l4:4:<span class="built_in">wait</span>:/etc/rc.d/rc 4</span><br><span class="line">l5:5:<span class="built_in">wait</span>:/etc/rc.d/rc 5</span><br><span class="line">l6:6:<span class="built_in">wait</span>:/etc/rc.d/rc 6</span><br><span class="line">ca::ctrlaltdel:/sbin/shutdown -t3 -r now</span><br><span class="line">pf::powerfail:/sbin/shutdown -f -h +2 <span class="string">&quot;Power Failure; System Shutting Down”</span></span><br><span class="line"><span class="string">pr:12345:powerokwait:/sbin/shutdown -c &quot;</span>Power Restored; Shutdown Cancelled”</span><br><span class="line">1:2345:respawn:/sbin/mingetty tty1</span><br><span class="line">2:2345:respawn:/sbin/mingetty tty2</span><br><span class="line">3:2345:respawn:/sbin/mingetty tty3</span><br><span class="line">4:2345:respawn:/sbin/mingetty tty4</span><br><span class="line">5:2345:respawn:/sbin/mingetty tty5</span><br><span class="line">6:2345:respawn:/sbin/mingetty tty6</span><br><span class="line">x:5:respawn:/etc/X11/prefdm -nodaemon</span><br></pre></td></tr></table></figure>

<p>CentOS 6 /etc/inittab和相关文件</p>
<p>CentOS 6 init程序为 upstart, 其配置文件/etc/inittab, /etc/init/*.conf，配置文件的语法 遵循 upstart配置文件语法格式，和CentOS5不同</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">/etc/inittab 设置系统默认的运行级别</span><br><span class="line">/etc/init/control-alt-delete.conf</span><br><span class="line">/etc/init/tty.conf</span><br><span class="line">/etc/init/start-ttys.conf</span><br><span class="line">/etc/init/rc.conf</span><br><span class="line">/etc/init/prefdm.conf</span><br></pre></td></tr></table></figure>

<h3 id="初始化脚本-sysinit"><a href="#初始化脚本-sysinit" class="headerlink" title="初始化脚本 sysinit"></a>初始化脚本 sysinit</h3><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/etc/rc.d/rc.sysinit</span><br></pre></td></tr></table></figure>

<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@centos6 ~]<span class="comment">#cat /etc/init/rcS.conf </span></span><br></pre></td></tr></table></figure>

<p>系统初始化脚本功能</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">(1) 设置主机名</span><br><span class="line">(2) 设置欢迎信息</span><br><span class="line">(3) 激活udev和selinux </span><br><span class="line">(4) 挂载/etc/fstab文件中定义的文件系统</span><br><span class="line">(5) 检测根文件系统，并以读写方式重新挂载根文件系统</span><br><span class="line">(6) 设置系统时钟</span><br><span class="line">(7) 激活swap设备</span><br><span class="line">(8) 根据/etc/sysctl.conf文件设置内核参数</span><br><span class="line">(9) 激活lvm及software raid设备</span><br><span class="line">(10)加载额外设备的驱动程序</span><br><span class="line">(11)清理操作</span><br></pre></td></tr></table></figure>

<h3 id="服务管理"><a href="#服务管理" class="headerlink" title="服务管理"></a>服务管理</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">[root@centos6 ~]<span class="comment">#cat /etc/init/rc.conf </span></span><br><span class="line"><span class="comment"># rc - System V runlevel compatibility</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># This task runs the old sysv-rc runlevel scripts. It</span></span><br><span class="line"><span class="comment"># is usually started by the telinit compatibility wrapper.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Do not edit this file directly. If you want to change the behaviour,</span></span><br><span class="line"><span class="comment"># please create a file rc.override and put your changes there.</span></span><br><span class="line">start on runlevel [0123456]</span><br><span class="line"></span><br><span class="line">stop on runlevel [!<span class="variable">$RUNLEVEL</span>]</span><br><span class="line"></span><br><span class="line">task</span><br><span class="line"></span><br><span class="line"><span class="built_in">export</span> RUNLEVEL</span><br><span class="line">console output</span><br><span class="line"><span class="built_in">exec</span> /etc/rc.d/rc <span class="variable">$RUNLEVEL</span></span><br></pre></td></tr></table></figure>

<p>service 命令：手动管理服务</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">service 服务 start|stop|restart</span><br><span class="line">service --status-all</span><br></pre></td></tr></table></figure>

<p>/etc/rc.d/rc 控制服务脚本的开机自动运行</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> srv <span class="keyword">in</span> /etc/rc.d/rcN.d/K*; <span class="keyword">do</span></span><br><span class="line">    <span class="variable">$srv</span> stop</span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> srv <span class="keyword">in</span> /etc/rc.d/rcN.d/S*; <span class="keyword">do</span></span><br><span class="line">    <span class="variable">$srv</span> start</span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></table></figure>

<p>说明：rc N –&gt; 意味着读取/etc/rc.d/rcN.d/ </p>
<p>K: K##：##运行次序；数字越小，越先运行；数字越小的服务，通常为依赖到别的服务 </p>
<p>S: S##：##运行次序；数字越小，越先运行；数字越小的服务，通常为被依赖到的服务</p>
<p>配置服务开机启动</p>
<ul>
<li>chkconfig命令</li>
<li>ntsysv命令 </li>
</ul>
<p>chkconfig 命令管理服务</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#查看服务在所有级别的启动或关闭设定情形：</span></span><br><span class="line">chkconfig [--list] [name]</span><br><span class="line"></span><br><span class="line"><span class="comment">#添加服务</span></span><br><span class="line">SysV的服务脚本放置于/etc/rc.d/init.d (/etc/init.d)</span><br><span class="line"><span class="comment">#!/bin/bash</span></span><br><span class="line">chkconfig: LLLL nn nn  <span class="comment">#LLLL 表示初始在哪个级别下启动，-表示都不启动</span></span><br><span class="line">description : 描述信息</span><br><span class="line"></span><br><span class="line">chkconfig --add name</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#删除服务</span></span><br><span class="line">chkconfig --del name</span><br><span class="line"></span><br><span class="line"><span class="comment">#修改指定的运行级别</span></span><br><span class="line">chkconfig [--level levels] name &lt;on|off|reset&gt;</span><br><span class="line">说明：--level LLLL: 指定要设置的级别；省略时表示2345</span><br></pre></td></tr></table></figure>

<p>范例: 自定义服务脚本</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">[root@centos6 ~]<span class="comment">#cat /etc/init.d/testsrv </span></span><br><span class="line"><span class="comment">#!/bin/bash</span></span><br><span class="line"><span class="comment"># chkconfig: - 96 3</span></span><br><span class="line"><span class="comment"># description: This is test service script</span></span><br><span class="line">. /etc/init.d/functions </span><br><span class="line"><span class="function"><span class="title">start</span></span>()&#123;</span><br><span class="line">   [ -e /var/lock/subsys/testsrv ] &amp;&amp; <span class="built_in">exit</span> || <span class="built_in">touch</span> /var/lock/subsys/testsrv</span><br><span class="line">    <span class="built_in">echo</span> <span class="variable">$PATH</span></span><br><span class="line">   action <span class="string">&quot;Starting testsrv&quot;</span></span><br><span class="line">    <span class="built_in">sleep</span> 3</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="title">stop</span></span>()&#123;</span><br><span class="line">   [ -e   /var/lock/subsys/testsrv ] &amp;&amp; <span class="built_in">rm</span> /var/lock/subsys/testsrv || <span class="built_in">exit</span></span><br><span class="line">   action <span class="string">&quot;Stopping testsrv&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="title">status</span></span>()&#123;</span><br><span class="line">   [ -e /var/lock/subsys/testsrv ] &amp;&amp; <span class="built_in">echo</span> <span class="string">&quot;testsrv is running...&quot;</span> || <span class="built_in">echo</span></span><br><span class="line"><span class="string">&quot;testsrv is stopped&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">case</span> <span class="variable">$1</span> <span class="keyword">in</span></span><br><span class="line">start)</span><br><span class="line">    start</span><br><span class="line">   ;;</span><br><span class="line">stop)</span><br><span class="line">    stop</span><br><span class="line">   ;;</span><br><span class="line">restart)</span><br><span class="line">    stop</span><br><span class="line">    start</span><br><span class="line">   ;;</span><br><span class="line">status)</span><br><span class="line">   status</span><br><span class="line">   ;;</span><br><span class="line">*)</span><br><span class="line">    <span class="built_in">echo</span> $<span class="string">&quot;Usage: <span class="variable">$0</span> &#123;start|stop|status|restart&#125;&quot;</span></span><br><span class="line">    <span class="built_in">exit</span> 2</span><br><span class="line"><span class="keyword">esac</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@centos6 ~]<span class="comment">#chkconfig --add testsrv</span></span><br><span class="line">[root@centos6 ~]<span class="comment">#chkconfig --list testsrv</span></span><br><span class="line">testsrv       0:off 1:off 2:off 3:off 4:off 5:off 6:off</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@centos6 ~]<span class="comment">#service testsrv start</span></span><br><span class="line">/sbin:/usr/sbin:/bin:/usr/bin</span><br><span class="line">Starting testsrv                                           [ OK ]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@centos6 ~]<span class="comment">#chkconfig --del testsrv</span></span><br></pre></td></tr></table></figure>

<h3 id="非独立服务"><a href="#非独立服务" class="headerlink" title="非独立服务"></a>非独立服务</h3><p>服务分为独立服务和非独立服务</p>
<p>瞬态（Transient）服务被超级守护进程 xinetd 进程所管理，也称为非独立服务</p>
<p>进入的请求首先被xinetd代理</p>
<p>配置文件：</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">/etc/xinetd.conf</span><br><span class="line">/etc/xinetd.d/&lt;service&gt;</span><br></pre></td></tr></table></figure>

<p>用chkconfig控制非独立服务开机启动</p>
<p>示例：</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">chkconfig tftp on</span><br></pre></td></tr></table></figure>

<p>范例: CentOS6 开启 telnet服务</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@centos6 ~]<span class="comment">#yum -y install telnet-server</span></span><br><span class="line">[root@centos6 ~]<span class="comment">#chkconfig telnet on</span></span><br><span class="line">[root@centos6 ~]<span class="comment">#service xinetd start</span></span><br></pre></td></tr></table></figure>

<h3 id="开机启动文件-rc-local"><a href="#开机启动文件-rc-local" class="headerlink" title="开机启动文件 rc.local"></a>开机启动文件 rc.local</h3><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">/etc/rc.local</span><br><span class="line">/etc/rc.d/rc.local</span><br></pre></td></tr></table></figure>

<p>注意：正常级别下，最后启动一个服务S99local没有链接至/etc/rc.d/init.d一个服务脚本，而是指向了/etc/rc.d/rc.local脚本</p>
<p>不便或不需写为服务脚本放置于/etc/rc.d/init.d/目录，且又想开机时自动运行的命令，可直接放置于/etc/rc.d/rc.local文件中</p>
<p>/etc/rc.d/rc.local在指定运行级别脚本后运行</p>
<p><strong>注意: 默认Ubuntu 无 /etc/rc.local 文件,可以创建此脚本文件并添加执行权限,rc.local的首行必须有shebang机制</strong></p>
<h2 id="CentOS-6-启动过程总结"><a href="#CentOS-6-启动过程总结" class="headerlink" title="CentOS 6 启动过程总结"></a>CentOS 6 启动过程总结</h2><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">POST</span><br><span class="line">boot loader</span><br><span class="line">vmlinux(initramfs.img)</span><br><span class="line">roofs</span><br><span class="line">/sbin/init</span><br><span class="line">/etc/inittab 设置默认运行级别</span><br><span class="line">/etc/rc.d/rc.sysinit 运行系统初始脚本完成系统初始化</span><br><span class="line">/etc/rc#.d/Sxxxx 启动需要启动服务关闭对应下需要关闭的服务</span><br><span class="line">/etc/rc.d/rc.local</span><br><span class="line">设置登录终端</span><br></pre></td></tr></table></figure>

<p>参看：<a target="_blank" rel="noopener" href="http://s4.51cto.com/wyfs02/M02/87/20/wKiom1fVBELjXsvaAAUkuL83t2Q304.jpg">http://s4.51cto.com/wyfs02/M02/87/20/wKiom1fVBELjXsvaAAUkuL83t2Q304.jpg</a></p>
<p><img src="https://s4.51cto.com/wyfs02/M02/87/20/wKiom1fVBELjXsvaAAUkuL83t2Q304.jpg" alt="3"></p>
<h1 id="systemd和启动流程"><a href="#systemd和启动流程" class="headerlink" title="systemd和启动流程"></a>systemd和启动流程</h1><h2 id="systemd-特性"><a href="#systemd-特性" class="headerlink" title="systemd 特性"></a>systemd 特性</h2><p>Systemd：从 CentOS 7 版本之后开始用 systemd 实现init进程，系统启动和服务器守护进程管理器，负责在系统启动或运行时，激活系统资源，服务器进程和其它进程</p>
<p><strong>Systemd 新特性</strong></p>
<ul>
<li>系统引导时实现服务并行启动 </li>
<li>按需启动守护进程 </li>
<li>自动化的服务依赖关系管理 </li>
<li>同时采用socket式与D-Bus总线式激活服务 </li>
<li>socket与服务程序分离 </li>
<li>向后兼容sysv init脚本 </li>
<li>使用systemctl 命令管理，systemctl命令固定不变，不可扩展，非由systemd启动的服务，systemctl无法与之通信和控制 </li>
<li>系统状态快照 </li>
</ul>
<p>systemd 核心概念：unit</p>
<p>unit表示不同类型的systemd对象，通过配置文件进行标识和配置；文件中主要包含了系统服务、监听socket、保存的系统快照以及其它与init相关的信息 </p>
<p>Unit类型：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#查看unit类型</span></span><br><span class="line">[root@centos8 ~]<span class="comment">#systemctl -t help </span></span><br><span class="line">Available unit types:</span><br><span class="line">service</span><br><span class="line">socket</span><br><span class="line">target</span><br><span class="line">device</span><br><span class="line">mount</span><br><span class="line">automount</span><br><span class="line">swap</span><br><span class="line">timer</span><br><span class="line">path</span><br><span class="line">slice</span><br><span class="line">scope</span><br></pre></td></tr></table></figure>

<ul>
<li>service unit: 文件扩展名为.service, 用于定义系统服务 </li>
<li>Socket unit: .socket, 定义进程间通信用的socket文件，也可在系统启动时，延迟启动服务，实现按需启动 </li>
<li>Target unit: 文件扩展名为.target，用于模拟实现运行级别 </li>
<li>Device unit: .device, 用于定义内核识别的设备 </li>
<li>Mount unit: .mount, 定义文件系统挂载点 </li>
<li>Snapshot unit: .snapshot, 管理系统快照 </li>
<li>Swap unit: .swap, 用于标识swap设备 </li>
<li>Automount unit: .automount，文件系统的自动挂载点 </li>
<li>Path unit: .path，用于定义文件系统中的一个文件或目录使用,常用于当文件系统变化时，延迟激活服务，如：spool 目录 </li>
</ul>
<p>unit的配置文件</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">/usr/lib/systemd/system      <span class="comment">#每个服务最主要的启动脚本设置，类似于之前的/etc/init.d/</span></span><br><span class="line">/lib/systemd/system          <span class="comment">#ubutun的对应目录,兼容于CentOS7,8和Ubuntu</span></span><br><span class="line">/run/systemd/system          <span class="comment">#系统执行过程中所产生的服务脚本，比上面目录优先运行</span></span><br><span class="line">/etc/systemd/system          <span class="comment">#管理员建立的执行脚本，类似于/etc/rcN.d/Sxx的功能，比上面目录优先运行</span></span><br></pre></td></tr></table></figure>

<p>范例: systemd实现部分服务的socket 和 service 分离</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">[root@rocky8 ~]<span class="comment">#yum -y install httpd</span></span><br><span class="line">[root@rocky8 ~]<span class="comment">#systemctl start httpd.socket</span></span><br><span class="line">[root@rocky8 ~]<span class="comment">#systemctl is-active httpd.socket</span></span><br><span class="line">active</span><br><span class="line"></span><br><span class="line">[root@rocky8 ~]<span class="comment">#systemctl is-active httpd.service </span></span><br><span class="line">inactive</span><br><span class="line"></span><br><span class="line">[root@rocky8 ~]<span class="comment">#ss -ntlp |grep :80</span></span><br><span class="line">LISTEN 0      128               *:80             *:*   <span class="built_in">users</span>: ((&quot;systemd&quot;,pid=<span class="number">1</span>,fd=<span class="number">32</span>)) </span><br><span class="line"></span><br><span class="line"><span class="comment">#访问httpd的socket,自动激活service</span></span><br><span class="line">[root@rocky8 ~]<span class="comment">#curl 127.0.0.1</span></span><br><span class="line">[root@rocky8 ~]<span class="comment">#systemctl is-active httpd.service </span></span><br><span class="line">active</span><br><span class="line"></span><br><span class="line">[root@rocky8 ~]<span class="comment">#ss -ntlp |grep :80</span></span><br><span class="line">LISTEN 0      128               *:80             *:*   <span class="built_in">users</span>:</span><br><span class="line">((&quot;httpd&quot;,pid=<span class="number">16775</span>,fd=<span class="number">3</span>),(&quot;httpd&quot;,pid=<span class="number">16774</span>,fd=<span class="number">3</span>),(&quot;httpd&quot;,pid=<span class="number">16773</span>,fd=<span class="number">3</span>),</span><br><span class="line">(&quot;httpd&quot;,pid=<span class="number">16771</span>,fd=<span class="number">3</span>),(&quot;systemd&quot;,pid=<span class="number">1</span>,fd=<span class="number">32</span>))</span><br></pre></td></tr></table></figure>

<h2 id="systemctl管理系统服务service-unit"><a href="#systemctl管理系统服务service-unit" class="headerlink" title="systemctl管理系统服务service unit"></a>systemctl管理系统服务service unit</h2><p>命令：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl COMMAND name.service</span><br></pre></td></tr></table></figure>

<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#启动：相当于service name start </span></span><br><span class="line">systemctl start name1.service [name2.service] ...</span><br><span class="line"></span><br><span class="line"><span class="comment">#停止：相当于service name stop</span></span><br><span class="line">systemctl stop name.service</span><br><span class="line"></span><br><span class="line"><span class="comment">#重启：相当于service name restart </span></span><br><span class="line">systemctl restart name.service </span><br><span class="line"></span><br><span class="line"><span class="comment">#查看状态：相当于service name status</span></span><br><span class="line">systemctl status name.service</span><br><span class="line"></span><br><span class="line"><span class="comment">#禁止自动和手动启动：</span></span><br><span class="line">systemctl mask name.service</span><br><span class="line"></span><br><span class="line"><span class="comment">#取消禁止</span></span><br><span class="line">systemctl unmask name.service</span><br><span class="line"></span><br><span class="line"><span class="comment">#查看某服务当前激活与否的状态：</span></span><br><span class="line">systemctl is-active name.service</span><br><span class="line"></span><br><span class="line"><span class="comment">#查看service文件内容</span></span><br><span class="line">systemctl <span class="built_in">cat</span> sshd</span><br><span class="line"></span><br><span class="line"><span class="comment">#查看所有已经激活的服务：</span></span><br><span class="line">systemctl list-units --<span class="built_in">type</span>|-t service</span><br><span class="line"></span><br><span class="line"><span class="comment">#查看所有服务：</span></span><br><span class="line">systemctl list-units --<span class="built_in">type</span> service --all|-a</span><br><span class="line"></span><br><span class="line"><span class="comment">#设定某服务开机自启，相当于chkconfig name on </span></span><br><span class="line">systemctl <span class="built_in">enable</span> name.service </span><br><span class="line"></span><br><span class="line"><span class="comment">#设定某服务开机禁止启动：相当于chkconfig name off</span></span><br><span class="line">systemctl <span class="built_in">disable</span> name.service</span><br><span class="line"></span><br><span class="line"><span class="comment">#查看所有服务的开机自启状态，相当于chkconfig --list</span></span><br><span class="line">systemctl list-unit-files --<span class="built_in">type</span> service</span><br><span class="line"></span><br><span class="line"><span class="comment">#用来列出该服务在哪些运行级别下启用和禁用：chkconfig –list name</span></span><br><span class="line"><span class="built_in">ls</span> /etc/systemd/system/*.wants/name.service</span><br><span class="line"></span><br><span class="line"><span class="comment">#查看服务是否开机自启：</span></span><br><span class="line">systemctl is-enabled name.service</span><br><span class="line"></span><br><span class="line"><span class="comment">#列出失败的服务</span></span><br><span class="line">systemctl --failed --<span class="built_in">type</span>=service</span><br><span class="line"> </span><br><span class="line"><span class="comment">#开机并立即启动或停止</span></span><br><span class="line">systemctl <span class="built_in">enable</span> --now postfix </span><br><span class="line">systemctl <span class="built_in">disable</span>  --now postfix</span><br><span class="line"></span><br><span class="line"><span class="comment">#查看服务的依赖关系：</span></span><br><span class="line">systemctl list-dependencies name.service</span><br><span class="line"></span><br><span class="line"><span class="comment">#杀掉进程：</span></span><br><span class="line">systemctl <span class="built_in">kill</span> unitname</span><br></pre></td></tr></table></figure>

<p>服务状态</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">#显示状态</span><br><span class="line">systemctl list-unit-files --type service --all</span><br></pre></td></tr></table></figure>

<ul>
<li>loaded Unit配置文件已处理 </li>
<li>active(running) 一次或多次持续处理的运行 </li>
<li>active(exited) 成功完成一次性的配置 </li>
<li>active(waiting) 运行中，等待一个事件 </li>
<li>inactive 不运行 </li>
<li>enabled 开机启动 </li>
<li>disabled 开机不启动 </li>
<li>static 开机不启动，但可被另一个启用的服务激活 </li>
<li>indirect 重定向到别处</li>
</ul>
<p>范例：systemctl 命令示例</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#显示所有单元状态</span></span><br><span class="line">systemctl 或 systemctl list-units</span><br><span class="line"></span><br><span class="line"><span class="comment">#只显示服务单元的状态</span></span><br><span class="line">systemctl --<span class="built_in">type</span>=service</span><br><span class="line"></span><br><span class="line"><span class="comment">#显示sshd服务单元</span></span><br><span class="line">systemctl –l status sshd.service</span><br><span class="line"></span><br><span class="line"><span class="comment">#验证sshd服务当前是否活动</span></span><br><span class="line">systemctl is-active sshd</span><br><span class="line"></span><br><span class="line"><span class="comment">#启动，停止和重启sshd服务</span></span><br><span class="line">systemctl start sshd.service</span><br><span class="line">systemctl stop sshd.service</span><br><span class="line">systemctl restart sshd.service</span><br><span class="line"></span><br><span class="line"><span class="comment">#重新加载配置</span></span><br><span class="line">systemctl reload sshd.service</span><br><span class="line"></span><br><span class="line"><span class="comment">#列出活动状态的所有服务单元</span></span><br><span class="line">systemctl list-units --<span class="built_in">type</span>=service</span><br><span class="line"></span><br><span class="line"><span class="comment">#列出所有服务单元</span></span><br><span class="line">systemctl list-units --<span class="built_in">type</span>=service --all</span><br><span class="line"></span><br><span class="line"><span class="comment">#查看服务单元的启用和禁用状态</span></span><br><span class="line">systemctl list-unit-files  --<span class="built_in">type</span>=service</span><br><span class="line"></span><br><span class="line"><span class="comment">#列出依赖的单元</span></span><br><span class="line">systemctl list-dependencies sshd</span><br><span class="line">验证sshd服务是否开机启动</span><br><span class="line">systemctl is-enabled sshd</span><br><span class="line">禁用network，使之不能自动启动,但手动可以</span><br><span class="line">systemctl <span class="built_in">disable</span> network</span><br><span class="line"></span><br><span class="line"><span class="comment">#启用network</span></span><br><span class="line">systemctl <span class="built_in">enable</span> network</span><br><span class="line"></span><br><span class="line"><span class="comment">#禁用network，使之不能手动或自动启动</span></span><br><span class="line">systemctl mask network</span><br><span class="line"></span><br><span class="line"><span class="comment">#启用network</span></span><br><span class="line">systemctl unmask network</span><br></pre></td></tr></table></figure>

<h2 id="service-unit文件格式"><a href="#service-unit文件格式" class="headerlink" title="service unit文件格式"></a>service unit文件格式</h2><p>/etc/systemd/system：系统管理员和用户使用</p>
<p>/usr/lib/systemd/system：发行版打包者使用</p>
<p>帮助参考：</p>
<p>systemd.directives（7），systemd.unit(5),systemd.service(5), systemd.socket(5),  systemd.target(5),systemd.exec(5) </p>
<p>参考链接</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://www.jinbuguo.com/systemd/systemd.service.html</span><br></pre></td></tr></table></figure>

<p>unit 格式说明： </p>
<ul>
<li>以 “#” 开头的行后面的内容会被认为是注释 </li>
<li>相关布尔值，1、yes、on、true 都是开启，0、no、off、false 都是关闭</li>
<li>时间单位默认是秒，所以要用毫秒（ms）分钟（m）等须显式说明 </li>
</ul>
<p>service unit file文件通常由三部分组成： </p>
<ul>
<li>[Unit]：定义与Unit类型无关的通用选项；用于提供unit的描述信息、unit行为及依赖关系等</li>
<li>[Service]：与特定类型相关的专用选项；此处为Service类型</li>
<li>[Install]：定义由“systemctl enable”以及”systemctl disable“命令在实现服务启用或禁用时用到的一些选项 </li>
</ul>
<p>Unit段的常用选项： </p>
<ul>
<li>Description：描述信息 </li>
<li>After：定义unit的启动次序，表示当前unit应该晚于哪些unit启动，其功能与Before相反 </li>
<li>Requires：依赖到的其它units，强依赖，被依赖的units无法激活时，当前unit也无法激活 </li>
<li>Wants：依赖到的其它units，弱依赖 </li>
<li>Conflicts：定义units间的冲突关系</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ~]<span class="comment">#head -n 5 /lib/systemd/system/postfix.service </span></span><br><span class="line">[Unit]</span><br><span class="line">Description=Postfix Mail Transport Agent</span><br><span class="line">After=syslog.target network.target</span><br><span class="line">Conflicts=sendmail.service exim.service</span><br></pre></td></tr></table></figure>

<p>Service段的常用选项： </p>
<ul>
<li><p>Type：定义影响ExecStart及相关参数的功能的unit进程启动类型</p>
<ul>
<li><p>simple：默认值，这个daemon主要由ExecStart接的指令串来启动，启动后常驻于内存中 </p>
</li>
<li><p>forking：由ExecStart启动的程序透过spawns延伸出其他子程序来作为此daemon的主要服务。原生父程序在启动结束后就会终止 </p>
</li>
<li><p>oneshot：与simple类似，不过这个程序在工作完毕后就结束了，不会常驻在内存中 </p>
</li>
<li><p>dbus：与simple类似，但这个daemon必须要在取得一个D-Bus的名称后，才会继续运作.因此通常也要同时设定BusNname= 才行 </p>
</li>
<li><p>notify：在启动完成后会发送一个通知消息。还需要配合 NotifyAccess 来让 Systemd 接收消息 </p>
</li>
<li><p>idle：与simple类似，要执行这个daemon必须要所有的工作都顺利执行完毕后才会执行。这类的daemon通常是开机到最后才执行即可的服务 </p>
</li>
<li><p>EnvironmentFile：环境配置文件 </p>
</li>
<li><p>ExecStart：指明启动unit要运行命令或脚本的绝对路径 </p>
</li>
<li><p>ExecStartPre： ExecStart前运行 </p>
</li>
<li><p>ExecStartPost： ExecStart后运行 </p>
</li>
<li><p>ExecStop：指明停止unit要运行的命令或脚本 </p>
</li>
<li><p>Restart：当设定Restart=1 时，则当次daemon服务意外终止后，会再次自动启动此服务 RestartSec: 设置在重启服务( Restart= )前暂停多长时间。 默认值是100毫秒(100ms)。 如果未指定时间单位，那么将视为以秒为单位。 例如设为”20”等价于设为”20s”。 </p>
</li>
<li><p>PrivateTmp：设定为yes时，会在生成/tmp/systemd-private-UUID-NAME.service-XXXXX/tmp/目录 </p>
</li>
</ul>
<p>Install段的常用选项： </p>
<ul>
<li>Alias：别名，可使用systemctl command Alias.service </li>
<li>RequiredBy：被哪些units所依赖，强依赖 </li>
<li>WantedBy：被哪些units所依赖，弱依赖 </li>
<li>Also：安装本服务的时候还要安装别的相关服务 </li>
</ul>
<p>注意：对于新创建的unit文件，或者修改了的unit文件，要通知systemd重载此配置文件,而后可以选择重启</p>
</li>
</ul>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl daemon-reload</span><br></pre></td></tr></table></figure>

<p>范例：查看service文件</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">[root@rocky8 ~]<span class="comment">#systemctl cat sshd.service </span></span><br><span class="line"><span class="comment"># /usr/lib/systemd/system/sshd.service</span></span><br><span class="line">[Unit]</span><br><span class="line">Description=OpenSSH server daemon</span><br><span class="line">Documentation=man:sshd(8) man:sshd_config(5)</span><br><span class="line">After=network.target sshd-keygen.target</span><br><span class="line">Wants=sshd-keygen.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">Type=notify</span><br><span class="line">EnvironmentFile=-/etc/crypto-policies/back-ends/opensshserver.config</span><br><span class="line">EnvironmentFile=-/etc/sysconfig/sshd</span><br><span class="line">ExecStart=/usr/sbin/sshd -D <span class="variable">$OPTIONS</span> <span class="variable">$CRYPTO_POLICY</span></span><br><span class="line">ExecReload=/bin/kill -HUP <span class="variable">$MAINPID</span></span><br><span class="line">KillMode=process</span><br><span class="line">Restart=on-failure</span><br><span class="line">RestartSec=42s</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br></pre></td></tr></table></figure>

<p>范例：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ~]<span class="comment">#head -n 5 /lib/systemd/system/postfix.service </span></span><br><span class="line">[Unit]</span><br><span class="line">Description=Postfix Mail Transport Agent</span><br><span class="line">After=syslog.target network.target</span><br><span class="line">Conflicts=sendmail.service exim.service</span><br></pre></td></tr></table></figure>

<p>范例: 自定义service的unit文件</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ~]<span class="comment">#vim /lib/systemd/system/hello.service </span></span><br><span class="line">[Unit] </span><br><span class="line">Description=Hello World </span><br><span class="line"></span><br><span class="line">[Service] </span><br><span class="line">TimeoutStartSec=0</span><br><span class="line">ExecStart=/bin/sh -c <span class="string">&quot;while true; do echo Hello World; sleep 1; done&quot;</span></span><br><span class="line">ExecStop=/bin/kill sh</span><br><span class="line"></span><br><span class="line">[Install] </span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@centos8 ~]<span class="comment">#systemctl daemon-reload</span></span><br><span class="line">[root@centos8 ~]<span class="comment">#systemctl enable --now   hello</span></span><br><span class="line">[root@centos8 ~]<span class="comment">#systemctl status hello</span></span><br><span class="line">● hello.service - Hello World</span><br><span class="line">   Loaded: loaded (/usr/lib/systemd/system/hello.service; enabled; vendor preset: </span><br><span class="line">disabled)</span><br><span class="line">   Active: active (running) since Thu 2020-06-11 10:02:05 CST; 3min 16s ago</span><br><span class="line"> Main PID: 661 (sh)</span><br><span class="line">   Tasks: 2 (<span class="built_in">limit</span>: 4895)</span><br><span class="line">   Memory: 1.0M</span><br><span class="line">   CGroup: /system.slice/hello.service</span><br><span class="line">           ├─ 661 /bin/sh -c <span class="keyword">while</span> <span class="literal">true</span>; <span class="keyword">do</span> <span class="built_in">echo</span> Hello World; <span class="built_in">sleep</span> 1; <span class="keyword">done</span></span><br><span class="line">           └─1535 <span class="built_in">sleep</span> 1</span><br><span class="line">Jun 11 10:05:12 centos8.wangxiaochun.com sh[661]: Hello World</span><br><span class="line">Jun 11 10:05:13 centos8.wangxiaochun.com sh[661]: Hello World</span><br><span class="line">Jun 11 10:05:14 centos8.wangxiaochun.com sh[661]: Hello World</span><br><span class="line">Jun 11 10:05:15 centos8.wangxiaochun.com sh[661]: Hello World</span><br><span class="line">Jun 11 10:05:16 centos8.wangxiaochun.com sh[661]: Hello World</span><br><span class="line">Jun 11 10:05:17 centos8.wangxiaochun.com sh[661]: Hello World</span><br><span class="line">Jun 11 10:05:18 centos8.wangxiaochun.com sh[661]: Hello World</span><br><span class="line">Jun 11 10:05:19 centos8.wangxiaochun.com sh[661]: Hello World</span><br><span class="line">Jun 11 10:05:20 centos8.wangxiaochun.com sh[661]: Hello World</span><br><span class="line">Jun 11 10:05:21 centos8.wangxiaochun.com sh[661]: Hello World</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@centos8 ~]<span class="comment">#tail /var/log/messages   -f</span></span><br><span class="line">Sep  2 09:54:32 centos8 sh[26543]: Hello World</span><br><span class="line">Sep  2 09:54:33 centos8 sh[26543]: Hello World</span><br><span class="line">Sep  2 09:54:34 centos8 sh[26543]: Hello World</span><br><span class="line">Sep  2 09:54:35 centos8 sh[26543]: Hello World</span><br><span class="line">Sep  2 09:54:36 centos8 sh[26543]: Hello World</span><br><span class="line">Sep  2 09:54:37 centos8 sh[26543]: Hello World</span><br><span class="line">Sep  2 09:54:38 centos8 sh[26543]: Hello World</span><br><span class="line">Sep  2 09:54:39 centos8 sh[26543]: Hello World</span><br><span class="line">Sep  2 09:54:40 centos8 systemd[1]: Stopping Hello World...</span><br><span class="line">Sep  2 09:54:40 centos8 systemd[1]: Stopped Hello World.</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#上面serivce文件也可支持ubuntu18,04</span></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment">#tail /var/log/syslog</span></span><br><span class="line">Apr 23 09:49:31 ubuntu1804 systemd[1]: Started Terminate Plymouth Boot Screen.</span><br><span class="line">Apr 23 09:49:31 ubuntu1804 systemd[1]: Reached target Multi-User System.</span><br><span class="line">Apr 23 09:49:31 ubuntu1804 systemd[1]: Reached target Graphical Interface.</span><br><span class="line">Apr 23 09:49:31 ubuntu1804 systemd[1]: Starting Update UTMP about System </span><br><span class="line">Runlevel Changes...</span><br><span class="line">Apr 23 09:49:31 ubuntu1804 systemd[1]: Started Update UTMP about System Runlevel </span><br><span class="line">Changes.</span><br><span class="line">Apr 23 09:49:31 ubuntu1804 systemd[1]: Startup finished <span class="keyword">in</span> 3.623s (kernel) +</span><br><span class="line">12.818s (userspace) = 16.441s.</span><br><span class="line">Apr 23 09:49:52 ubuntu1804 systemd-timesyncd[688]: Synchronized to time server </span><br><span class="line">91.189.89.198:123 (ntp.ubuntu.com).</span><br><span class="line">Apr 23 09:50:43 ubuntu1804 systemd[1]: Reloading.</span><br><span class="line">Apr 23 09:50:44 ubuntu1804 systemd[1]: Started Hello World.</span><br><span class="line">Apr 23 09:50:44 ubuntu1804 sh[1202]: Hello World</span><br></pre></td></tr></table></figure>

<p>范例：服务Unit文件</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">[Unit]</span><br><span class="line">Description=The Nginx HTTP Server daemon                  <span class="comment"># 描述信息</span></span><br><span class="line">After=network.target remote-fs.target nss-lookup.target   <span class="comment"># 指定启动nginx之前需要其他的其他服务，如network.target等</span></span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line"><span class="comment"># Type为服务类型，仅启动一个主进程的服务为simple，需要启动若干子进程的服务为forking</span></span><br><span class="line">Type=forking</span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置执行systemctl start nginx后需要启动的具体命令</span></span><br><span class="line">ExecStart=/usr/local/nginx/sbin/nginx</span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置执行systemctl reload nginx后需要执行的具体命令</span></span><br><span class="line">ExecReload=/usr/local/nginx/sbin/nginx -s reload</span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置执行systemctl stop nginx后需要执行的具体命令</span></span><br><span class="line">ExecStop=/bin/kill -s QUIT <span class="variable">$&#123;MAINPID&#125;</span></span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line"><span class="comment"># 设置在什么模式下被安装，设置开机启动的时候需要</span></span><br><span class="line">WantedBy=multi-user.target</span><br></pre></td></tr></table></figure>

<p>范例：服务Unit文件</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">vim /usr/lib/systemd/system/tomcat.service</span><br><span class="line"></span><br><span class="line">[Unit]</span><br><span class="line">Description=java tomcat project</span><br><span class="line">After=syslog.target network.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">Type=forking</span><br><span class="line">EnvironmentFile=/usr/local/tomcat/conf/tomcat.conf</span><br><span class="line">ExecStart=/usr/local/tomcat/bin/startup.sh</span><br><span class="line">ExecStop=/usr/local/tomcat/bin/shutdown.sh</span><br><span class="line">PrivateTmp=<span class="literal">true</span></span><br><span class="line">User=tomcat</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br></pre></td></tr></table></figure>

<p>范例：服务Unit文件</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/systemd/system/bak.service</span><br><span class="line"></span><br><span class="line">[Unit]</span><br><span class="line">Description=backup /etc</span><br><span class="line">Requires=atd.service</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">Type=simple</span><br><span class="line">ExecStart=/bin/bash -c <span class="string">&quot;echo /data/bak.sh | at now&quot;</span></span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line"></span><br><span class="line">systemctl daemon-reload</span><br><span class="line">systemctl start bak</span><br></pre></td></tr></table></figure>

<p>范例：Ubuntu实现开机自动运行程序</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">[root@ubuntu1804 ~]<span class="comment"># vim /etc/rc.local</span></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment"># cat /etc/rc.local</span></span><br><span class="line"><span class="comment">#!/bin/bash</span></span><br><span class="line"><span class="built_in">echo</span> -e <span class="string">&#x27;\E[31;1mstarting test service\E[0m&#x27;</span></span><br><span class="line"><span class="built_in">sleep</span> 10</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment"># chmod +x /etc/rc.local</span></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment"># reboot</span></span><br><span class="line">[root@ubuntu2004 ~]<span class="comment"># systemctl status rc-local.service</span></span><br><span class="line">● rc-local.service - /etc/rc.local Compatibility</span><br><span class="line">     Loaded: loaded (/lib/systemd/system/rc-local.service; enabled-runtime; </span><br><span class="line">vendor preset: enabled)</span><br><span class="line">   Drop-In: /usr/lib/systemd/system/rc-local.service.d</span><br><span class="line">             └─debian.conf</span><br><span class="line">     Active: active (exited) since Mon 2022-01-10 02:51:30 UTC; 29s ago</span><br><span class="line">       Docs: man:systemd-rc-local-generator(8)</span><br><span class="line">   Process: 814 ExecStart=/etc/rc.local start (code=exited, status=0/SUCCESS)</span><br><span class="line">Jan 10 02:51:30 ubuntu2004.magedu.org systemd[1]: Starting /etc/rc.local Compatibility...</span><br><span class="line">Jan 10 02:51:30 ubuntu2004.magedu.org systemd[1]: Started /etc/rc.local Compatibility.</span><br></pre></td></tr></table></figure>

<h2 id="运行级别-1"><a href="#运行级别-1" class="headerlink" title="运行级别"></a>运行级别</h2><p>target units：相当于CentOS 6之前的runlevel ,unit配置文件：.target</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">ls</span> /usr/lib/systemd/system/*.target</span><br><span class="line">systemctl list-unit-files --<span class="built_in">type</span> target  --all</span><br></pre></td></tr></table></figure>

<p>和运行级别对应关系</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">0  ==&gt; runlevel0.target, poweroff.target</span><br><span class="line">1  ==&gt; runlevel1.target, rescue.target</span><br><span class="line">2  ==&gt; runlevel2.target, multi-user.target</span><br><span class="line">3  ==&gt; runlevel3.target, multi-user.target</span><br><span class="line">4  ==&gt; runlevel4.target, multi-user.target</span><br><span class="line">5  ==&gt; runlevel5.target, graphical.target</span><br><span class="line">6  ==&gt; runlevel6.target, reboot.target</span><br></pre></td></tr></table></figure>

<p>查看依赖性：</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl list-dependencies graphical.target</span><br></pre></td></tr></table></figure>

<p>级别切换：相当于 init N </p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl isolate name.target</span><br></pre></td></tr></table></figure>

<p>进入默认target</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl default</span><br></pre></td></tr></table></figure>

<p>范例：</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">#切换至字符模式</span><br><span class="line">systemctl isolate multi-user.target</span><br></pre></td></tr></table></figure>

<p>注意：只有/lib/systemd/system/*.target文件中AllowIsolate=yes 才能切换(修改文件需执行systemctl  daemon-reload才能生效) </p>
<p>获取默认运行级别： 相当于查看 /etc/inittab</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl get-default</span><br></pre></td></tr></table></figure>

<p>修改默认级别：相当于修改 /etc/inittab</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl set-default name.target</span><br></pre></td></tr></table></figure>

<p>范例：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ~]<span class="comment">#systemctl set-default multi-user.target</span></span><br><span class="line">[root@centos8 ~]<span class="comment">#ls -l /etc/systemd/system/default.target</span></span><br><span class="line">lrwxrwxrwx. 1 root root 37 Nov  7 19:32 /etc/systemd/system/default.target -&gt; /lib/systemd/system/multi-user.target</span><br></pre></td></tr></table></figure>

<p>切换至紧急救援模式：</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl rescue</span><br></pre></td></tr></table></figure>

<p>切换至emergency模式：</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl emergency</span><br></pre></td></tr></table></figure>

<p>说明：rescue.target 比emergency 支持更多的功能，例如日志等 </p>
<p>传统命令init，poweroff，halt，reboot都成为systemctl的软链接</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#关机</span></span><br><span class="line">systemctl halt、systemctl poweroff</span><br><span class="line"> </span><br><span class="line"><span class="comment">#重启：</span></span><br><span class="line">systemctl reboot</span><br><span class="line"></span><br><span class="line"><span class="comment">#挂起：</span></span><br><span class="line">systemctl <span class="built_in">suspend</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#休眠：</span></span><br><span class="line">systemctl hibernate</span><br><span class="line"></span><br><span class="line"><span class="comment">#休眠并挂起：</span></span><br><span class="line">systemctl hybrid-sleep</span><br></pre></td></tr></table></figure>

<p>范例：禁用ctrl+alt+delete 重启快捷键</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ~]<span class="comment">#ls -l /lib/systemd/system/ctrl-alt-del.target    </span></span><br><span class="line">lrwxrwxrwx. 1 root root 13 May 23  2019 /lib/systemd/system/ctrl-alt-del.target -&gt; reboot.target</span><br><span class="line"></span><br><span class="line">[root@centos8 ~]<span class="comment">#systemctl mask ctrl-alt-del.target </span></span><br><span class="line">Created symlink /etc/systemd/system/ctrl-alt-del.target → /dev/null.</span><br><span class="line"></span><br><span class="line"><span class="comment">#以下两者功能相同</span></span><br><span class="line">[root@centos8 ~]<span class="comment">#init q </span></span><br><span class="line">[root@centos8 ~]<span class="comment">#systemctl daemon-reload</span></span><br></pre></td></tr></table></figure>

<h2 id="设置内核参数"><a href="#设置内核参数" class="headerlink" title="设置内核参数"></a>设置内核参数</h2><p>设置内核参数，只影响当次启动</p>
<p>启动时，到启动菜单，按e键，找到在linux 开头的行后添加systemd.unit=desired.target</p>
<p>比如：</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">systemd.unit=multi-user.target</span><br><span class="line">systemd.unit=emergency.target </span><br><span class="line">systemd.unit=rescue.target</span><br></pre></td></tr></table></figure>

<h2 id="CentOS-7之后版本引导顺序"><a href="#CentOS-7之后版本引导顺序" class="headerlink" title="CentOS 7之后版本引导顺序"></a>CentOS 7之后版本引导顺序</h2><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://www.junmajinlong.com/linux/systemd/systemd_bootup/</span><br></pre></td></tr></table></figure>

<ol>
<li>UEFi或BIOS初始化，运行POST开机自检 </li>
<li>选择启动设备 </li>
<li>引导装载程序, centos7是grub2,加载装载程序的配置文件： /etc/grub.d/ /etc/default/grub  /boot/grub2/grub.cfg </li>
<li>加载initramfs驱动模块（可以实现根文件系统的挂载） </li>
<li>加载虚拟根中的内核 </li>
<li>虚拟根的内核初始化，Centos7使用systemd代替init,第一个进程 </li>
<li>执行initrd.target所有单元，包括挂载/etc/fstab </li>
<li>从initramfs根文件系统切换到磁盘根目录 </li>
<li>systemd执行默认target配置，配置文件/etc/systemd/system/default.target</li>
<li>systemd执行sysinit.target初始化系统及basic.target准备操作系统 </li>
<li>systemd启动multi-user.target下的本机与服务器服务 </li>
<li>systemd执行multi-user.target下的/etc/rc.d/rc.local</li>
<li>Systemd执行multi-user.target下的getty.target及登录服务</li>
<li>systemd执行graphical需要的服务 </li>
</ol>
<p>范例：查看initramfs- uname -r .img的内容</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@rocky8 ~]<span class="comment">#cd /opt</span></span><br><span class="line">[root@rocky8 opt]<span class="comment">#/usr/lib/dracut/skipcpio /boot/initramfs-$(uname -r).img | zcat | cpio -idmv</span></span><br><span class="line">[root@rocky8 opt]<span class="comment">#ls</span></span><br><span class="line">bin dev etc init lib lib64 proc root run sbin shutdown sys sysroot </span><br><span class="line">tmp usr var</span><br></pre></td></tr></table></figure>

<p>范例：multi-user.target的依赖</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[root@rocky8 ~]<span class="comment"># systemctl list-dependencies multi-user.target</span></span><br><span class="line">● ├─atd.service</span><br><span class="line">● ├─auditd.service</span><br><span class="line">● ├─autofs.service</span><br><span class="line">● ├─chronyd.service</span><br><span class="line">● ├─crond.service</span><br><span class="line">● ├─dbus.service</span><br><span class="line">● ├─httpd.service</span><br><span class="line">● ├─irqbalance.service</span><br><span class="line">● ├─kdump.service</span><br><span class="line">● ├─NetworkManager.service</span><br><span class="line">● ├─plymouth-quit-wait.service</span><br><span class="line">● ├─plymouth-quit.service</span><br><span class="line">........</span><br></pre></td></tr></table></figure>

<p>通过systemd-analyze 工具可以了解启动的详细过程</p>
<p>范例：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ~]<span class="comment">#systemd-analyze blame</span></span><br><span class="line">          1.862s kdump.service</span><br><span class="line">          1.047s tuned.service</span><br><span class="line">           666ms dracut-initqueue.service</span><br><span class="line">           523ms auditd.service</span><br><span class="line">           379ms initrd-switch-root.service</span><br><span class="line">           314ms sssd.service</span><br><span class="line">           302ms systemd-rfkill.service</span><br><span class="line">           219ms NetworkManager-wait-online.service</span><br><span class="line">           211ms polkit.service</span><br><span class="line">           178ms systemd-udev-trigger.service</span><br><span class="line">           159ms dracut-pre-pivot.service</span><br><span class="line">           138ms autofs.service</span><br><span class="line">           129ms systemd-vconsole-setup.service</span><br><span class="line">           109ms NetworkManager.service</span><br><span class="line">           104ms sysroot.mount</span><br><span class="line">           96ms boot.mount</span><br><span class="line">           80ms initrd-parse-etc.service</span><br><span class="line">           ........</span><br></pre></td></tr></table></figure>

<p>范例：生成网页</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemd-analyze plot &gt; boot.html</span><br></pre></td></tr></table></figure>

<h2 id="破解-root-密码"><a href="#破解-root-密码" class="headerlink" title="破解 root 密码"></a>破解 root 密码</h2><p>范例：破解CentOS8,7的root密码 </p>
<p>方法一</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">启动时任意键暂停启动</span><br><span class="line">按e键进入编辑模式</span><br><span class="line">将光标移动linux 开始的行，添加内核参数 rd.break</span><br><span class="line">按ctrl-x启动</span><br><span class="line"></span><br><span class="line">mount –o remount,rw /sysroot</span><br><span class="line"><span class="built_in">chroot</span> /sysroot</span><br><span class="line">passwd root</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#如果SELinux是启用的,才需要执行下面操作,如查没有启动,不需要执行</span></span><br><span class="line"><span class="built_in">touch</span> /.autorelabel</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="built_in">exit</span></span><br><span class="line">reboot</span><br></pre></td></tr></table></figure>

<p>方法二</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#此方式也适用于ubuntu18.04</span></span><br><span class="line">启动时任意键暂停启动</span><br><span class="line">按e键进入编辑模式</span><br><span class="line">将光标移动linux 开始的行，改为 rw init=/sysroot/bin/sh</span><br><span class="line">按ctrl-x启动</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="built_in">chroot</span> /sysroot</span><br><span class="line">passwd root</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#如果SELinux是启用的,才需要执行下面操作,如查没有启动,不需要执行</span></span><br><span class="line"><span class="built_in">touch</span> /.autorelabel</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="built_in">exit</span></span><br><span class="line">reboot</span><br></pre></td></tr></table></figure>

<p>范例：破解Ubuntu20.04的root密码</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">开机shift键，看到下面界面</span><br></pre></td></tr></table></figure>

<p><img src="../../../../images/SRE/day14/4.png" alt="4"></p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">按下面的提示，按e键，进入下面界面</span><br></pre></td></tr></table></figure>

<p><img src="../../../../images/SRE/day14/5.png" alt="5"></p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">修改上面的linux开头的行，为下面形式： ro init=/bin/bash</span><br></pre></td></tr></table></figure>

<p><img src="../../../../images/SRE/day14/6.png" alt="6"></p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">按下面提示，按ctrl-x或者F10键，进入下面界面</span><br></pre></td></tr></table></figure>

<p><img src="../../../../images/SRE/day14/7.png" alt="7"></p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">执行命令passwd 直接修改密码后重启即可</span><br></pre></td></tr></table></figure>

<p><img src="../../../../images/SRE/day14/8.png" alt="8"></p>
<h2 id="实现-GRUB2-安全"><a href="#实现-GRUB2-安全" class="headerlink" title="实现 GRUB2 安全"></a>实现 GRUB2 安全</h2><p><img src="../../../../images/SRE/day14/9.png" alt="9"></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#添加grub密码</span></span><br><span class="line">[root@centos8 ~]<span class="comment">#grub2-setpassword </span></span><br><span class="line">Enter password: </span><br><span class="line">Confirm password: </span><br><span class="line"></span><br><span class="line">[root@centos8 ~]<span class="comment">#ls -l /boot/grub2/</span></span><br><span class="line">total 32</span><br><span class="line">drwxr-xr-x 2 root root  4096 Jan 19 15:17 fonts</span><br><span class="line">-rw-r--r-- 1 root root  5101 Jan 19 15:18 grub.cfg</span><br><span class="line">-rw-r--r-- 1 root root  1024 Jan 19 15:18 grubenv</span><br><span class="line">drwxr-xr-x 2 root root 12288 Jan 19 15:17 i386-pc</span><br><span class="line">-rw------- 1 root root   298 Jan 19 18:20 user.cfg</span><br><span class="line"></span><br><span class="line">[root@centos8 ~]<span class="comment">#ls -l /boot/grub2/user.cfg </span></span><br><span class="line">-rw------- 1 root root 298 Jan 19 18:20 /boot/grub2/user.cfg</span><br><span class="line"></span><br><span class="line">[root@centos8 ~]<span class="comment">#cat /boot/grub2/user.cfg</span></span><br><span class="line">GRUB2_PASSWORD=grub.pbkdf2.sha512.10000.60AAA29A65F4DC77E8861EF25BDE2034C9B30CE1</span><br><span class="line">E07EE688D7F30460E7E87E7356B0893A6DFFB250B27D2EB9D3ED3E9207199C494D7882E2E8C772C8</span><br><span class="line">2E2DDB7A.5E42FD69FA04293DECD68F077E83875A8E4572A7FBB89BA9F161B15EAFE54FBA963FE5D</span><br><span class="line">52E16764944823396231803E5118DA1D9CAF3EB73C175A7D7A3682A90</span><br><span class="line"></span><br><span class="line"><span class="comment">#清空grub密码</span></span><br><span class="line">[root@centos8 ~]<span class="comment">#cat /dev/null &gt; /boot/grub2/user.cfg</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#或者</span></span><br><span class="line">[root@centos8 ~]<span class="comment">#rm -f /boot/grub2/user.cfg</span></span><br></pre></td></tr></table></figure>

<h2 id="修复-GRUB2"><a href="#修复-GRUB2" class="headerlink" title="修复 GRUB2"></a>修复 GRUB2</h2><p>GRUB2：CentOS 7，8及ubuntu1804,20.04都使用</p>
<p>引导提示时可以使用命令行界面，可从文件系统引导</p>
<p>主要配置文件：/boot/grub2/grub.cfg</p>
<p>修复配置文件：grub2-mkconfig &gt; /boot/grub2/grub.cfg</p>
<p>修复grub</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">grub2-install /dev/sda      #BIOS环境</span><br><span class="line">grub2-install               #UEFI环境</span><br></pre></td></tr></table></figure>

<p>范例：调整默认启动内核</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ~]<span class="comment">#cat /boot/grub2/grubenv</span></span><br><span class="line"><span class="comment"># GRUB Environment Block</span></span><br><span class="line">saved_entry=5b85fc7444b240a992c42ce2a9f65db5-5.6.12-wanglinux-6.6.6</span><br><span class="line">kernelopts=root=UUID=f7f53add-b184-4ddc-8d2c-5263b84d1e15 ro crashkernel=auto </span><br><span class="line">resume=UUID=eebe3bc7-6d52-4ad9-86aa-916f1a123fd4 rhgb quiet net.ifnames=0</span><br><span class="line">boot_success=0</span><br><span class="line"></span><br><span class="line"><span class="comment">################################################################################</span></span><br><span class="line"><span class="comment">################################################################################</span></span><br><span class="line"><span class="comment">################################################################################</span></span><br><span class="line"><span class="comment">################################################################################</span></span><br><span class="line"><span class="comment">################################################################################</span></span><br><span class="line"><span class="comment">################################################################################</span></span><br><span class="line"><span class="comment">################################################################################</span></span><br><span class="line"><span class="comment">################################################################################</span></span><br><span class="line"><span class="comment">################################################################################</span></span><br><span class="line"><span class="comment">###########################################[root@centos8 ~]#cd </span></span><br><span class="line"></span><br><span class="line">[root@centos8 ~]<span class="comment">#ls /boot/loader/entries/</span></span><br><span class="line">5b85fc7444b240a992c42ce2a9f65db5-0-rescue.conf</span><br><span class="line">5b85fc7444b240a992c42ce2a9f65db5-4.18.0-147.el8.x86_64.conf</span><br><span class="line">5b85fc7444b240a992c42ce2a9f65db5-5.6.12-wanglinux-6.6.6.conf</span><br><span class="line"></span><br><span class="line"><span class="comment">#以下命令是修改 /boot/grub2/grubenv 实现</span></span><br><span class="line">[root@centos8 ~]<span class="comment">#grub2-set-default 1 </span></span><br></pre></td></tr></table></figure>

<p><img src="../../../../images/SRE/day14/10.png" alt="10"></p>
<h2 id="故障排错实战案例"><a href="#故障排错实战案例" class="headerlink" title="故障排错实战案例"></a>故障排错实战案例</h2><h3 id="实战案例1：CentOS-7-8-破坏MBR后进行恢复"><a href="#实战案例1：CentOS-7-8-破坏MBR后进行恢复" class="headerlink" title="实战案例1：CentOS 7,8 破坏MBR后进行恢复"></a>实战案例1：CentOS 7,8 破坏MBR后进行恢复</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">dd</span> <span class="keyword">if</span>=/dev/zero of=/dev/sda bs=1 count=446</span><br><span class="line">光盘进入救援模式</span><br><span class="line">grub2-install --root-directory=/mnt/sysimage /dev/sda</span><br></pre></td></tr></table></figure>

<h3 id="实战案例2：CentOS-7-8-删除-boot-grub2-所有内容进行恢复"><a href="#实战案例2：CentOS-7-8-删除-boot-grub2-所有内容进行恢复" class="headerlink" title="实战案例2：CentOS 7,8 删除 /boot/grub2/ 所有内容进行恢复"></a>实战案例2：CentOS 7,8 删除 /boot/grub2/ 所有内容进行恢复</h3><p><img src="../../../../images/SRE/day14/11.png" alt="11"></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#光盘进入救援模式</span></span><br><span class="line"><span class="built_in">chroot</span> /mnt/sysimage</span><br><span class="line">grub2-install /dev/sda</span><br><span class="line">grub2-mkconfig -o /boot/grub2/grub.cfg</span><br></pre></td></tr></table></figure>

<h3 id="实战案例3：CentOS-7-8-删除-boot-下所有文件后进行恢复"><a href="#实战案例3：CentOS-7-8-删除-boot-下所有文件后进行恢复" class="headerlink" title="实战案例3：CentOS 7,8 删除 /boot/ 下所有文件后进行恢复"></a>实战案例3：CentOS 7,8 删除 /boot/ 下所有文件后进行恢复</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">1 光盘救援模式下安装grub2</span><br><span class="line">特别说明：Centos8 必须先修复grub，再安装kernel,否则安装kernel-core时会提示grub出错</span><br><span class="line"></span><br><span class="line"><span class="comment">#centos8</span></span><br><span class="line"><span class="built_in">chroot</span> /mnt/sysroot</span><br><span class="line"></span><br><span class="line"><span class="comment">#centos7</span></span><br><span class="line"><span class="built_in">chroot</span> /mnt/sysimage</span><br><span class="line"></span><br><span class="line"><span class="comment">#安装grub</span></span><br><span class="line">grub2-install /dev/sda    <span class="comment">#BIOS环境</span></span><br><span class="line">grub2-install             <span class="comment">#UEFI环境</span></span><br><span class="line"></span><br><span class="line">2 安装Kernel</span><br><span class="line"><span class="comment">#CentOS 7 </span></span><br><span class="line">mount /dev/sr0 /mnt</span><br><span class="line">rpm –ivh /mnt/Packages/kernel-3.10.0-1062.el7.x86_64.rpm --force</span><br><span class="line"></span><br><span class="line"><span class="comment">#CentOS 8 </span></span><br><span class="line">mount /dev/sr0 /mnt</span><br><span class="line">rpm -ivh /mnt/BaseOS/Packages/kernel-core-4.18.0-147.el8.x86_64.rpm --force</span><br><span class="line"></span><br><span class="line">3 修复grub配置文件</span><br><span class="line"><span class="comment">#生成grub.cfg文件</span></span><br><span class="line">grub2-mkconfig –o /boot/grub2/grub.cfg</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">4 退出重启</span><br><span class="line"><span class="built_in">sync</span></span><br><span class="line"><span class="built_in">sync</span></span><br><span class="line"><span class="built_in">exit</span></span><br><span class="line"><span class="built_in">exit</span></span><br></pre></td></tr></table></figure>

<h1 id="proc-目录和内核参数管理"><a href="#proc-目录和内核参数管理" class="headerlink" title="/proc 目录和内核参数管理"></a>/proc 目录和内核参数管理</h1><p>/proc目录：内核把自己内部状态信息及统计信息，以及可配置参数通过proc伪文件系统加以输出</p>
<p>帮助：man proc</p>
<p>内核参数： </p>
<ul>
<li>只读：只用于输出信息 </li>
<li>可写：可接受用户指定“新值”来实现对内核某功能或特性的配置 </li>
</ul>
<p>/proc/sys 设置</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sysctl是一个允许改变正在运行中的Linux系统的接口，修改的是针对整个系统的内核参数。sysctl的修改</span><br><span class="line">是立即且临时的（重启后失效）。也可以通过修改sysctl.conf配置文件，达到永久生效。</span><br></pre></td></tr></table></figure>

<ul>
<li>sysctl 命令用于查看或设定此目录中诸多参数</li>
</ul>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sysctl -w path.to.parameter=VALUE</span><br></pre></td></tr></table></figure>

<ul>
<li>默认配置文件：/etc/sysctl.conf 及以下文件</li>
</ul>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">/run/sysctl.d/*.conf</span><br><span class="line">/etc/sysctl.d/*.conf</span><br><span class="line">/usr/local/lib/sysctl.d/*.conf</span><br><span class="line">/usr/lib/sysctl.d/*.conf</span><br><span class="line">/lib/sysctl.d/*.conf</span><br><span class="line">/etc/sysctl.conf</span><br></pre></td></tr></table></figure>

<p>范例：</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sysctl -w kernel.hostname=mail.magedu.com</span><br></pre></td></tr></table></figure>

<ul>
<li>echo命令通过重定向方式也可以修改大多数参数的值</li>
</ul>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">echo &quot;VALUE&quot; &gt; /proc/sys/path/to/parameter</span><br></pre></td></tr></table></figure>

<p>范例：</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">echo “websrv” &gt; /proc/sys/kernel/hostname</span><br></pre></td></tr></table></figure>

<p>sysctl命令：</p>
<p>(1) 临时设置某参数</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sysctl -w parameter=VALUE</span><br></pre></td></tr></table></figure>

<p>(2) 通过读取配置文件设置参数</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sysctl -p [/path/to/conf_file]</span><br></pre></td></tr></table></figure>

<p>(3) 查看指定参数当前值</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sysctl [/path/to/conf_file]</span><br></pre></td></tr></table></figure>

<p>(4) 查看所有生效参数</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sysctl -a</span><br></pre></td></tr></table></figure>

<p>常用的内核参数：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">net.ipv4.ip_forward</span><br><span class="line">net.ipv4.icmp_echo_ignore_all</span><br><span class="line">net.ipv4.ip_nonlocal_bind           <span class="comment">#允许应用程序可以监听本地不存在的IP</span></span><br><span class="line">vm.drop_caches</span><br><span class="line">fs.file-max = 1020000               <span class="comment">#内核可以支持的全局打开文件的最大数</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">vm.overcommit_memory = 0  </span><br><span class="line"><span class="comment">#0表示内核将检查是否有足够可用内存供应用进程使用；如果有足够的可用内存，内存申请允许；否则内存申请失败，并把错误返回给应用进程。</span></span><br><span class="line"><span class="comment">#1表示内核允许分配所有的物理内存，而不管当前的内存状态如何。</span></span><br><span class="line"><span class="comment">#2表示内核允许分配超过所有物理内存和交换空间总和的内存。</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">vm.swappiness = 10                 <span class="comment">#设置内存还剩余10%空闲空间时,就会使用swap空间,默认值为30，值越大表示越倾向于使用swap</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#禁用IPv6</span></span><br><span class="line">net.ipv6.conf.all.disable_ipv6 = 1</span><br><span class="line">net.ipv6.conf.default.disable_ipv6 = 1</span><br></pre></td></tr></table></figure>

<p>范例:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ~]<span class="comment">#cat /proc/sys/net/ipv4/icmp_echo_ignore_all </span></span><br><span class="line">0</span><br><span class="line"></span><br><span class="line">[root@centos8 ~]<span class="comment">#vim /etc/sysctl.d/test.conf</span></span><br><span class="line">[root@centos8 ~]<span class="comment">#cat /etc/sysctl.d/test.conf</span></span><br><span class="line">net.ipv4.icmp_echo_ignore_all=1</span><br><span class="line"></span><br><span class="line">[root@centos8 ~]<span class="comment">#sysctl -p /etc/sysctl.d/test.conf</span></span><br><span class="line">net.ipv4.icmp_echo_ignore_all = 1</span><br><span class="line"></span><br><span class="line">[root@centos8 ~]<span class="comment">#cat /proc/sys/net/ipv4/icmp_echo_ignore_all </span></span><br><span class="line">1</span><br></pre></td></tr></table></figure>

<p>范例: 清除缓存</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ~]<span class="comment">#man proc | grep -A 3 drop_caches</span></span><br><span class="line">       /proc/sys/vm/drop_caches (since Linux 2.6.16)</span><br><span class="line">             Writing to this file causes the kernel to drop clean caches, </span><br><span class="line">dentries, and inodes from memory, causing that memory to become free. This can </span><br><span class="line">be useful</span><br><span class="line">              <span class="keyword">for</span> memory management testing and performing reproducible </span><br><span class="line">filesystem benchmarks. Because writing to this file causes the benefits of </span><br><span class="line">caching to be lost,</span><br><span class="line">             it can degrade overall system performance.</span><br><span class="line">--</span><br><span class="line">                  <span class="built_in">echo</span> 1 &gt; /proc/sys/vm/drop_caches</span><br><span class="line">             To free dentries and inodes, use:</span><br><span class="line">                  <span class="built_in">echo</span> 2 &gt; /proc/sys/vm/drop_caches</span><br><span class="line">             To free pagecache, dentries and inodes, use:</span><br><span class="line">                  <span class="built_in">echo</span> 3 &gt; /proc/sys/vm/drop_caches</span><br><span class="line">             Because writing to this file is a nondestructive operation and </span><br><span class="line">dirty objects are not freeable, the user should run <span class="built_in">sync</span>(1) first.</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@centos8 ~]<span class="comment">#cp /dev/sda /data/f1.img</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@centos8 ~]<span class="comment">#ll -h /data/f1.img</span></span><br><span class="line">-rw-r----- 1 root root 1.3G Aug 31 16:02 /data/f1.img</span><br><span class="line"></span><br><span class="line">[root@centos8 ~]<span class="comment">#free -h</span></span><br><span class="line">             total       used       free     shared buff/cache   available</span><br><span class="line">Mem:         952Mi       115Mi       72Mi       0.0Ki       764Mi       695Mi</span><br><span class="line">Swap:         2.0Gi       71Mi       1.9Gi</span><br><span class="line"></span><br><span class="line">[root@centos8 ~]<span class="comment">#echo 3 &gt; /proc/sys/vm/drop_caches</span></span><br><span class="line">[root@centos8 ~]<span class="comment">#free -h</span></span><br><span class="line">             total       used       free     shared buff/cache   available</span><br><span class="line">Mem:         952Mi       115Mi       787Mi       0.0Ki       48Mi       742Mi</span><br><span class="line">Swap:         2.0Gi       71Mi       1.9Gi</span><br></pre></td></tr></table></figure>

</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="http://example.com">૮(˶ᵔ ᵕ ᵔ˶)ა</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="http://example.com/2024/12/01/SRE-%E7%B3%BB%E7%BB%9F%E5%90%AF%E5%8A%A8%E5%92%8C%E5%86%85%E6%A0%B8%E7%AE%A1%E7%90%86/">http://example.com/2024/12/01/SRE-系统启动和内核管理/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="http://example.com" target="_blank">૮(˶ᵔ ᵕ ᵔ˶)ა</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/SRE/">SRE</a><a class="post-meta__tags" href="/tags/Linux/">Linux</a></div><div class="post_share"><div class="social-share" data-image="/../images/TITLE/linux4.jpg" data-sites="wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2024/11/29/SRE-%E8%BF%9B%E7%A8%8B%EF%BC%8C%E7%B3%BB%E7%BB%9F%E6%80%A7%E8%83%BD%E5%92%8C%E8%AE%A1%E5%88%92%E4%BB%BB%E5%8A%A1/" title="进程，系统性能和计划任务"><img class="cover" src="/../images/SRE/day13/22.png" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">进程，系统性能和计划任务</div></div></a></div><div class="next-post pull-right"><a href="/2024/12/04/SRE-%E5%8A%A0%E5%AF%86%E5%92%8C%E5%AE%89%E5%85%A8/" title="加密和安全"><img class="cover" src="/../images/SRE/day15/13.png" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">加密和安全</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><div><a href="/2024/04/24/SRE-Linux%E5%9F%BA%E6%9C%AC%E6%93%8D%E4%BD%9C%E5%92%8C%E5%B8%AE%E5%8A%A9/" title="Linux基本操作和帮助"><img class="cover" src="/../images/TITLE/linux2.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-04-24</div><div class="title">Linux基本操作和帮助</div></div></a></div><div><a href="/2024/08/27/SRE-Linux%E6%96%87%E4%BB%B6%E7%AE%A1%E7%90%86%E5%92%8CIO%E9%87%8D%E5%AE%9A%E5%90%91/" title="Linux文件管理和IO重定向"><img class="cover" src="/../images/TITLE/linux3.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-08-27</div><div class="title">Linux文件管理和IO重定向</div></div></a></div><div><a href="/2024/12/08/SRE-Linux%E9%98%B2%E7%81%AB%E5%A2%99/" title="Linux防火墙"><img class="cover" src="/../images/SRE/day17/12.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-12-08</div><div class="title">Linux防火墙</div></div></a></div><div><a href="/2024/11/05/SRE-Shell%E8%84%9A%E6%9C%AC%E7%BC%96%E7%A8%8B/" title="shell脚本编程"><img class="cover" src="/../images/TITLE/linux2.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-11-05</div><div class="title">shell脚本编程</div></div></a></div><div><a href="/2024/12/08/SRE-linux%E5%91%BD%E4%BB%A4%E7%B4%A2%E5%BC%95/" title="linux命令索引"><img class="cover" src="/../images/TITLE/linux3.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-12-08</div><div class="title">linux命令索引</div></div></a></div><div><a href="/2024/12/04/SRE-%E5%8A%A0%E5%AF%86%E5%92%8C%E5%AE%89%E5%85%A8/" title="加密和安全"><img class="cover" src="/../images/SRE/day15/13.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-12-04</div><div class="title">加密和安全</div></div></a></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="/../images/TITLE/user.webp" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">૮(˶ᵔ ᵕ ᵔ˶)ა</div><div class="author-info__description">这家伙很勤奋，什么都留下了</div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">99</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">41</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">34</div></a></div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content is-expand"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#CentOS-6%E5%90%AF%E5%8A%A8%E7%AE%A1%E7%90%86"><span class="toc-number">1.</span> <span class="toc-text">CentOS 6启动管理</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%A1%AC%E4%BB%B6%E5%90%AF%E5%8A%A8POST"><span class="toc-number">1.1.</span> <span class="toc-text">硬件启动POST</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%90%AF%E5%8A%A8%E5%8A%A0%E8%BD%BD%E5%99%A8-bootloader"><span class="toc-number">1.2.</span> <span class="toc-text">启动加载器 bootloader</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#grub-%E5%8A%9F%E8%83%BD%E5%92%8C%E7%BB%84%E6%88%90"><span class="toc-number">1.2.1.</span> <span class="toc-text">grub 功能和组成</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#CentOS-6-grub-%E5%AE%89%E8%A3%85"><span class="toc-number">1.2.2.</span> <span class="toc-text">CentOS 6 grub 安装</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#grub-legacy-%E7%AE%A1%E7%90%86"><span class="toc-number">1.2.3.</span> <span class="toc-text">grub legacy 管理</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8A%A0%E8%BD%BD-kernel"><span class="toc-number">1.3.</span> <span class="toc-text">加载 kernel</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#init%E5%88%9D%E5%A7%8B%E5%8C%96"><span class="toc-number">1.4.</span> <span class="toc-text">init初始化</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%BF%90%E8%A1%8C%E7%BA%A7%E5%88%AB"><span class="toc-number">1.4.1.</span> <span class="toc-text">运行级别</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%9D%E5%A7%8B%E5%8C%96%E8%84%9A%E6%9C%AC-sysinit"><span class="toc-number">1.4.2.</span> <span class="toc-text">初始化脚本 sysinit</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9C%8D%E5%8A%A1%E7%AE%A1%E7%90%86"><span class="toc-number">1.4.3.</span> <span class="toc-text">服务管理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%9D%9E%E7%8B%AC%E7%AB%8B%E6%9C%8D%E5%8A%A1"><span class="toc-number">1.4.4.</span> <span class="toc-text">非独立服务</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%BC%80%E6%9C%BA%E5%90%AF%E5%8A%A8%E6%96%87%E4%BB%B6-rc-local"><span class="toc-number">1.4.5.</span> <span class="toc-text">开机启动文件 rc.local</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#CentOS-6-%E5%90%AF%E5%8A%A8%E8%BF%87%E7%A8%8B%E6%80%BB%E7%BB%93"><span class="toc-number">1.5.</span> <span class="toc-text">CentOS 6 启动过程总结</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#systemd%E5%92%8C%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B"><span class="toc-number">2.</span> <span class="toc-text">systemd和启动流程</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#systemd-%E7%89%B9%E6%80%A7"><span class="toc-number">2.1.</span> <span class="toc-text">systemd 特性</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#systemctl%E7%AE%A1%E7%90%86%E7%B3%BB%E7%BB%9F%E6%9C%8D%E5%8A%A1service-unit"><span class="toc-number">2.2.</span> <span class="toc-text">systemctl管理系统服务service unit</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#service-unit%E6%96%87%E4%BB%B6%E6%A0%BC%E5%BC%8F"><span class="toc-number">2.3.</span> <span class="toc-text">service unit文件格式</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%BF%90%E8%A1%8C%E7%BA%A7%E5%88%AB-1"><span class="toc-number">2.4.</span> <span class="toc-text">运行级别</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%AE%BE%E7%BD%AE%E5%86%85%E6%A0%B8%E5%8F%82%E6%95%B0"><span class="toc-number">2.5.</span> <span class="toc-text">设置内核参数</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#CentOS-7%E4%B9%8B%E5%90%8E%E7%89%88%E6%9C%AC%E5%BC%95%E5%AF%BC%E9%A1%BA%E5%BA%8F"><span class="toc-number">2.6.</span> <span class="toc-text">CentOS 7之后版本引导顺序</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%A0%B4%E8%A7%A3-root-%E5%AF%86%E7%A0%81"><span class="toc-number">2.7.</span> <span class="toc-text">破解 root 密码</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0-GRUB2-%E5%AE%89%E5%85%A8"><span class="toc-number">2.8.</span> <span class="toc-text">实现 GRUB2 安全</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BF%AE%E5%A4%8D-GRUB2"><span class="toc-number">2.9.</span> <span class="toc-text">修复 GRUB2</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%95%85%E9%9A%9C%E6%8E%92%E9%94%99%E5%AE%9E%E6%88%98%E6%A1%88%E4%BE%8B"><span class="toc-number">2.10.</span> <span class="toc-text">故障排错实战案例</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9E%E6%88%98%E6%A1%88%E4%BE%8B1%EF%BC%9ACentOS-7-8-%E7%A0%B4%E5%9D%8FMBR%E5%90%8E%E8%BF%9B%E8%A1%8C%E6%81%A2%E5%A4%8D"><span class="toc-number">2.10.1.</span> <span class="toc-text">实战案例1：CentOS 7,8 破坏MBR后进行恢复</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9E%E6%88%98%E6%A1%88%E4%BE%8B2%EF%BC%9ACentOS-7-8-%E5%88%A0%E9%99%A4-boot-grub2-%E6%89%80%E6%9C%89%E5%86%85%E5%AE%B9%E8%BF%9B%E8%A1%8C%E6%81%A2%E5%A4%8D"><span class="toc-number">2.10.2.</span> <span class="toc-text">实战案例2：CentOS 7,8 删除 &#x2F;boot&#x2F;grub2&#x2F; 所有内容进行恢复</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9E%E6%88%98%E6%A1%88%E4%BE%8B3%EF%BC%9ACentOS-7-8-%E5%88%A0%E9%99%A4-boot-%E4%B8%8B%E6%89%80%E6%9C%89%E6%96%87%E4%BB%B6%E5%90%8E%E8%BF%9B%E8%A1%8C%E6%81%A2%E5%A4%8D"><span class="toc-number">2.10.3.</span> <span class="toc-text">实战案例3：CentOS 7,8 删除 &#x2F;boot&#x2F; 下所有文件后进行恢复</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#proc-%E7%9B%AE%E5%BD%95%E5%92%8C%E5%86%85%E6%A0%B8%E5%8F%82%E6%95%B0%E7%AE%A1%E7%90%86"><span class="toc-number">3.</span> <span class="toc-text">&#x2F;proc 目录和内核参数管理</span></a></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2025/04/21/SRE-kafka/" title="消息队列和微服务"><img src="/../images/SRE/day52/30.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="消息队列和微服务"/></a><div class="content"><a class="title" href="/2025/04/21/SRE-kafka/" title="消息队列和微服务">消息队列和微服务</a><time datetime="2025-04-21T15:34:02.000Z" title="发表于 2025-04-21 23:34:02">2025-04-21</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2025/04/19/SRE-redis/" title="企业级NoSQL数据库Redis"><img src="/../images/SRE/day49/1.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="企业级NoSQL数据库Redis"/></a><div class="content"><a class="title" href="/2025/04/19/SRE-redis/" title="企业级NoSQL数据库Redis">企业级NoSQL数据库Redis</a><time datetime="2025-04-19T15:34:02.000Z" title="发表于 2025-04-19 23:34:02">2025-04-19</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2025/04/16/SRE-Keepalived/" title="高可用性集群Keepalived"><img src="/../images/SRE/day48/1.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="高可用性集群Keepalived"/></a><div class="content"><a class="title" href="/2025/04/16/SRE-Keepalived/" title="高可用性集群Keepalived">高可用性集群Keepalived</a><time datetime="2025-04-16T09:15:13.000Z" title="发表于 2025-04-16 17:15:13">2025-04-16</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2025/04/15/SRE-HAProxy/" title="高可用性集群HAProxy"><img src="/../images/SRE/day47/1.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="高可用性集群HAProxy"/></a><div class="content"><a class="title" href="/2025/04/15/SRE-HAProxy/" title="高可用性集群HAProxy">高可用性集群HAProxy</a><time datetime="2025-04-15T15:51:45.000Z" title="发表于 2025-04-15 23:51:45">2025-04-15</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2023 - 2025 By ૮(˶ᵔ ᵕ ᵔ˶)ა</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div><div class="footer_custom_text"><a target="_blank" rel="noopener" href="https://beian.miit.gov.cn/#/Integrated/index"><img src="../images/BEIAN/icp.png" width="15" height="15">豫ICP备2023009931号</a></br><a href="http://www.beian.gov.cn/portal/registerSystemInfo?recordcode=41162702000178" target="_blank"><img src="../images/BEIAN/beian.png" width="15" height="15">豫公网安备 41162702000178号</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.umd.min.js"></script><script src="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.js"></script><script>function panguFn () {
  if (typeof pangu === 'object') pangu.autoSpacingPage()
  else {
    getScript('https://cdn.jsdelivr.net/npm/pangu/dist/browser/pangu.min.js')
      .then(() => {
        pangu.autoSpacingPage()
      })
  }
}

function panguInit () {
  if (true){
    GLOBAL_CONFIG_SITE.isPost && panguFn()
  } else {
    panguFn()
  }
}

document.addEventListener('DOMContentLoaded', panguInit)</script><div class="js-pjax"></div><canvas id="universe"></canvas><script src="/js/universe.js"></script><canvas class="fireworks" mobile="true"></canvas><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/fireworks.min.js"></script><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/activate-power-mode.min.js"></script><script>POWERMODE.colorful = true;
POWERMODE.shake = false;
POWERMODE.mobile = false;
document.body.addEventListener('input', POWERMODE);
</script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>