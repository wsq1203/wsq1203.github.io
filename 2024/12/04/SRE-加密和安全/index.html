<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>加密和安全 | ૮(˶ᵔ ᵕ ᵔ˶)ა</title><meta name="author" content="૮(˶ᵔ ᵕ ᵔ˶)ა"><meta name="copyright" content="૮(˶ᵔ ᵕ ᵔ˶)ა"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="ffffff"><meta name="description" content="Site Reliability Engineering">
<meta property="og:type" content="article">
<meta property="og:title" content="加密和安全">
<meta property="og:url" content="http://example.com/2024/12/04/SRE-%E5%8A%A0%E5%AF%86%E5%92%8C%E5%AE%89%E5%85%A8/index.html">
<meta property="og:site_name" content="૮(˶ᵔ ᵕ ᵔ˶)ა">
<meta property="og:description" content="Site Reliability Engineering">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://example.com/images/SRE/day15/13.png">
<meta property="article:published_time" content="2024-12-03T16:00:00.000Z">
<meta property="article:modified_time" content="2025-04-01T11:34:55.963Z">
<meta property="article:author" content="૮(˶ᵔ ᵕ ᵔ˶)ა">
<meta property="article:tag" content="SRE">
<meta property="article:tag" content="Linux">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://example.com/images/SRE/day15/13.png"><link rel="shortcut icon" href="/../images/TITLE/user.webp"><link rel="canonical" href="http://example.com/2024/12/04/SRE-%E5%8A%A0%E5%AF%86%E5%92%8C%E5%AE%89%E5%85%A8/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//fonts.googleapis.com" crossorigin=""/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Titillium+Web&amp;display=swap" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":false,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: true,
    post: true
  },
  runtime: '天',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: {"chs_to_cht":"你已切换为繁体","cht_to_chs":"你已切换为简体","day_to_night":"你已切换为深色模式","night_to_day":"你已切换为浅色模式","bgLight":"#49b1f5","bgDark":"#1f1f1f","position":"top-center"},
  source: {
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: true,
  }
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: '加密和安全',
  isPost: true,
  isHome: false,
  isHighlightShrink: undefined,
  isToc: true,
  postUpdate: '2025-04-01 19:34:55'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
    win.getCSS = (url,id = false) => new Promise((resolve, reject) => {
      const link = document.createElement('link')
      link.rel = 'stylesheet'
      link.href = url
      if (id) link.id = id
      link.onerror = reject
      link.onload = link.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        link.onload = link.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(link)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', 'ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><link rel="stylesheet" href="/css/custom.css"  media="defer" onload="this.media='all'"><meta name="generator" content="Hexo 5.4.2"></head><body><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="/../images/TITLE/user.webp" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">97</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">37</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">30</div></a></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间线</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('/../images/SRE/day15/13.png')"><nav id="nav"><span id="blog-info"><a href="/" title="૮(˶ᵔ ᵕ ᵔ˶)ა"><span class="site-name">૮(˶ᵔ ᵕ ᵔ˶)ა</span></a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间线</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">加密和安全</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2024-12-03T16:00:00.000Z" title="发表于 2024-12-04 00:00:00">2024-12-04</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2025-04-01T11:34:55.963Z" title="更新于 2025-04-01 19:34:55">2025-04-01</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/Linux/">Linux</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">字数总计:</span><span class="word-count">28.1k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>132分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="加密和安全"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="安全机制"><a href="#安全机制" class="headerlink" title="安全机制"></a>安全机制</h1><h2 id="墨菲定律"><a href="#墨菲定律" class="headerlink" title="墨菲定律"></a>墨菲定律</h2><p>墨菲定律：一种心理学效应，是由爱德华-墨菲（Edward A. Murphy）提出的，原话：如果有两种或两种以上的方式去做某件事情，而其中一种选择方式将导致灾难，则必定有人会做出这种选择，即：做事情不要有侥幸心理 </p>
<p><strong>主要内容：</strong> </p>
<ul>
<li>任何事都没有表面看起来那么简单</li>
<li>所有的事都会比你预计的时间长</li>
<li>会出错的事总会出错</li>
<li>如果你担心某种情况发生，那么它就更有可能发生</li>
</ul>
<h2 id="信息安全防护的目标"><a href="#信息安全防护的目标" class="headerlink" title="信息安全防护的目标"></a>信息安全防护的目标</h2><ul>
<li>保密性 Confidentiality</li>
<li>完整性 Integrity</li>
<li>可用性 Usability</li>
<li>可控制性 Controlability</li>
<li>不可否认性 Non-repudiation</li>
</ul>
<h2 id="安全防护环节"><a href="#安全防护环节" class="headerlink" title="安全防护环节"></a>安全防护环节</h2><ul>
<li>物理安全：各种设备/主机、机房环境</li>
<li>系统安全：主机或设备的操作系统</li>
<li>应用安全：各种网络服务、应用程序</li>
<li>网络安全：对网络访问的控制、防火墙规则</li>
<li>数据安全：信息的备份与恢复、加密解密</li>
<li>管理安全：各种保障性的规范、流程、方法</li>
</ul>
<h2 id="常见的安全攻击-STRIDE"><a href="#常见的安全攻击-STRIDE" class="headerlink" title="常见的安全攻击 STRIDE"></a>常见的安全攻击 STRIDE</h2><ul>
<li>Spoofing 假冒，钓鱼网站</li>
<li>Tampering 篡改</li>
<li>Repudiation 否认</li>
<li>Information Disclosure 信息泄漏</li>
<li>Denial of Service 拒绝服务</li>
<li>Elevation of Privilege 提升权限</li>
</ul>
<p>范例: 捕获上网密码</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">Ace Password Sniffer - LOG</span><br><span class="line"></span><br><span class="line">Date: Dec 10, 2004 15:45:45</span><br><span class="line"></span><br><span class="line">Dec 10, 13:07:21 192.9.101.88-&gt;219.239.110.41(POP3) [U]lixxxx [P]password [OK] </span><br><span class="line">[Info]+OK maildrop locked and ready</span><br><span class="line">Dec 10, 13:08:14 192.9.101.74-&gt;219.239.110.41(HTTP) [U]lixxxx [P]password [OK] </span><br><span class="line">[Info]HTTP/1.1 302 Found</span><br><span class="line">Dec 10, 13:08:24 192.9.101.74-&gt;219.239.110.41(HTTP) [U]lixxxx [P]password [OK] </span><br><span class="line">[Info]HTTP/1.1 302 Found</span><br><span class="line">Dec 10, 13:08:36 192.9.101.74-&gt;219.239.110.41(HTTP) [U]lixxxx [P]password [OK] </span><br><span class="line">[Info]HTTP/1.1 302 Found</span><br><span class="line">Dec 10, 13:09:12 192.9.101.61-&gt;219.239.110.41(POP3) [U]luxxxx [P]hellohelen [OK] </span><br><span class="line">[Info]+OK maildrop locked and ready</span><br><span class="line">Dec 10, 13:09:39 192.9.101.74-&gt;219.239.110.41(HTTP) [U]luxxxx [P]hellohelen [OK] </span><br><span class="line">[Info]HTTP/1.1 302 Found</span><br><span class="line">Dec 10, 13:10:21 192.9.101.88-&gt;219.239.110.41(POP3) [U]lixxxx [P]password [OK] </span><br><span class="line">[Info]+OK maildrop locked and ready</span><br></pre></td></tr></table></figure>

<h2 id="安全设计基本原则"><a href="#安全设计基本原则" class="headerlink" title="安全设计基本原则"></a>安全设计基本原则</h2><ul>
<li>使用成熟的安全系统</li>
<li>以小人之心度输入数据</li>
<li>外部系统是不安全的</li>
<li>最小授权</li>
<li>减少外部接口</li>
<li>缺省使用安全模式</li>
<li>安全不是似是而非</li>
<li>从STRIDE思考</li>
<li>在入口处检查</li>
<li>从管理上保护好你的系统</li>
</ul>
<h2 id="常用安全技术"><a href="#常用安全技术" class="headerlink" title="常用安全技术"></a>常用安全技术</h2><ul>
<li>认证</li>
<li>授权</li>
<li>审计</li>
<li>安全通信</li>
</ul>
<h2 id="加密算法和协议"><a href="#加密算法和协议" class="headerlink" title="加密算法和协议"></a>加密算法和协议</h2><p>古代曾出现凯撒密码的加密方式，用于军事信息的加密处理</p>
<ul>
<li>对称加密</li>
<li>非对称（公钥）加密</li>
<li>单向加密</li>
<li>认证协议</li>
</ul>
<h3 id="对称加密算法"><a href="#对称加密算法" class="headerlink" title="对称加密算法"></a>对称加密算法</h3><p><img src="../../../../images/SRE/day15/1.png" alt="1"></p>
<p>对称加密：加密和解密使用同一个密钥</p>
<p>特性： </p>
<ul>
<li>加密、解密使用同一个密钥，效率高</li>
<li>将原始数据分割成固定大小的块，逐个进行加密</li>
</ul>
<p>缺陷： </p>
<ul>
<li>密钥过多</li>
<li>密钥分发</li>
<li>数据来源无法确认</li>
</ul>
<p>常见对称加密算法: </p>
<ul>
<li>DES：Data Encryption Standard，56bits</li>
<li>3DES：</li>
<li>AES：Advanced (128, 192, 256bits) </li>
<li>Blowfish，Twofish </li>
<li>IDEA，RC6，CAST5</li>
</ul>
<p><img src="../../../../images/SRE/day15/2.png" alt="2"></p>
<h3 id="非对称加密算法"><a href="#非对称加密算法" class="headerlink" title="非对称加密算法"></a>非对称加密算法</h3><h4 id="非对称加密算法介绍"><a href="#非对称加密算法介绍" class="headerlink" title="非对称加密算法介绍"></a>非对称加密算法介绍</h4><p>非对称加密：密钥是成对出现</p>
<ul>
<li>公钥：public key，公开给所有人，主要给别人加密使用</li>
<li>私钥：secret key，private key 自己留存，必须保证其私密性，用于自已加密签名</li>
<li>特点：用公钥加密数据，只能使用与之配对的私钥解密；反之亦然 </li>
</ul>
<p>功能： </p>
<ul>
<li>数据加密：适合加密较小数据,比如: 加密对称密钥</li>
<li>数字签名：主要在于让接收方确认发送方身份 </li>
</ul>
<p>缺点： </p>
<ul>
<li>密钥长,算法复杂</li>
<li>加密解密效率低下</li>
</ul>
<p>常见算法：</p>
<ul>
<li>RSA：由 RSA 公司发明，是一个支持变长密钥的公共密钥算法，需要加密的文件块的长度也是可变的,可实现加密和数字签名</li>
<li>DSA（Digital Signature Algorithm）：数字签名算法，是一种标准的 DSS（数字签名标准）</li>
<li>ECC（Elliptic Curves Cryptography）：椭圆曲线密码编码学，比RSA加密算法使用更小的密钥，提供相当的或更高等级的安全</li>
</ul>
<h4 id="非对称加密实现加密"><a href="#非对称加密实现加密" class="headerlink" title="非对称加密实现加密"></a>非对称加密实现加密</h4><p><img src="../../../../images/SRE/day15/3.png" alt="3"></p>
<p>接收者</p>
<p>​        生成公钥/密钥对：P和S </p>
<p>​        公开公钥P，保密密钥S</p>
<p>发送者</p>
<p>​        使用接收者的公钥来加密消息M</p>
<p>​        将P(M)发送给接收者</p>
<p>接收者</p>
<p>​        使用密钥S来解密：M=S(P(M))</p>
<h4 id="非对称加密实现数字签名"><a href="#非对称加密实现数字签名" class="headerlink" title="非对称加密实现数字签名"></a>非对称加密实现数字签名</h4><p><img src="../../../../images/SRE/day15/4.png" alt="4"></p>
<p>发送者</p>
<p>​        生成公钥/密钥对：P和S</p>
<p>​        公开公钥P，保密密钥S</p>
<p>​        使用密钥S来加密消息M </p>
<p>​        发送给接收者S(M)</p>
<p>接收者</p>
<p>​        使用发送者的公钥来解密M=P(S(M))</p>
<h4 id="RSA和DSA"><a href="#RSA和DSA" class="headerlink" title="RSA和DSA"></a>RSA和DSA</h4><p>RSA：公钥加密算法是1977年由Ron Rivest、Adi Shamirh和LenAdleman在（美国麻省理工学院）开发的，RSA取名来自开发他们三者的名字，后成立RSA数据安全有限公司。RSA是目前最有影响力的公钥加密算法，它能够抵抗到目前为止已知的所有密码攻击，已被ISO推荐为公钥数据加密标准。RSA算法基于一个十分简单的数论事实：将两个大素数相乘十分容易，但那时想要对其乘积进行因式分解却极其困难，因此可以将乘积公开作为加密密钥</p>
<p>DSA (Digital Signature Algorithm)：1991年7月26日提交，并归属于David W. Kravitz前NSA员工，DSA是Schnorr和ElGamal签名算法的变种，被美国NIST作为SS(DigitalSignature Standard)， DSA是基于整数有限域离散对数难题的，其安全性与RSA相比差不多。DSA只是一种算法，和RSA不同之处在于它不能用作加密和解密，也不能进行密钥交换，只用于签名,它比RSA要快很多</p>
<h3 id="单向哈希算法"><a href="#单向哈希算法" class="headerlink" title="单向哈希算法"></a>单向哈希算法</h3><p>哈希算法：也称为散列算法，将任意数据缩小成固定大小的“指纹”，称为digest，即摘要</p>
<p>特性：</p>
<ul>
<li>任意长度输入，固定长度输出</li>
<li>若修改数据，指纹也会改变，且有雪崩效应，数据的一点微小改变，生成的指纹值变化非常大。</li>
<li>无法从指纹中重新生成数据，即不要逆，具有单向性</li>
</ul>
<p>功能：数据完整性</p>
<p>常见算法</p>
<p>md5: 128bits、sha1: 160bits、sha224 、sha256、sha384、sha512</p>
<p>常用工具</p>
<ul>
<li>md5sum | sha1sum [ –check ] file</li>
<li>openssl、gpg</li>
<li>rpm -V </li>
</ul>
<p><strong>数字签名</strong></p>
<p><img src="../../../../images/SRE/day15/5.png" alt="5"></p>
<p>RPM 文件完整性</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">rpm  --verify package_name (or  -V)</span><br><span class="line">rpm  --import /etc/pki/rpm-gpg/RPM-GPG-KEY-redhat*</span><br><span class="line">rpm  --checksig pakage_file_name (or  -K)</span><br></pre></td></tr></table></figure>

<h3 id="综合应用多种加密算法"><a href="#综合应用多种加密算法" class="headerlink" title="综合应用多种加密算法"></a>综合应用多种加密算法</h3><h4 id="实现数据加密"><a href="#实现数据加密" class="headerlink" title="实现数据加密"></a>实现数据加密</h4><p>实现数据加密，无法验证数据完整性和来源</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Key(data)+Pb(key)</span><br></pre></td></tr></table></figure>

<p><img src="../../../../images/SRE/day15/6.png" alt="6"></p>
<p><img src="../../../../images/SRE/day15/7.png" alt="7"></p>
<h4 id="实现数字签名"><a href="#实现数字签名" class="headerlink" title="实现数字签名"></a>实现数字签名</h4><p>不加密数据，可以保证数据来源的可靠性、数据的完整性和一致性</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">data+Sa(hash(data))</span><br></pre></td></tr></table></figure>

<p><img src="../../../../images/SRE/day15/8.png" alt="8"></p>
<h4 id="综合加密和签名"><a href="#综合加密和签名" class="headerlink" title="综合加密和签名"></a>综合加密和签名</h4><p>即实现数据加密，又可以保证数据来源的可靠性、数据的完整性和一致性 </p>
<p><strong>方法1：Pb{Sa[hash(data)]+data}</strong></p>
<p><img src="../../../../images/SRE/day15/9.png" alt="9"></p>
<p><strong>方法2：对称key{Sa[hash(data)]+data}+Pb(对称key)</strong></p>
<p><img src="../../../../images/SRE/day15/10.png" alt="10"></p>
<h3 id="密码交换"><a href="#密码交换" class="headerlink" title="密码交换"></a>密码交换</h3><p>密钥交换：IKE（ Internet Key Exchange ） </p>
<ul>
<li><p>公钥加密：用目标的公钥加密对称密钥 </p>
</li>
<li><p>DH (Deffie-Hellman)：生成对称（会话）密钥 </p>
<p>参看：<a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Diffie%E2%80%93Hellman_key_exchange">https://en.wikipedia.org/wiki/Diffie%E2%80%93Hellman_key_exchange</a> </p>
</li>
</ul>
<p>DH 介绍 </p>
<ul>
<li>这个密钥交换方法，由惠特菲尔德·迪菲（Bailey Whitfield Diffie）和马丁·赫尔曼（Martin Edward Hellman）在1976年发表</li>
<li>它是一种安全协议，让双方在完全没有对方任何预先信息的条件下通过不安全信道建立起一个密钥，这个密钥一般作为“对称加密”的密钥而被双方在后续数据传输中使用。 </li>
<li>DH数学原理是base离散对数问题。做类似事情的还有非对称加密类算法，如：RSA。 </li>
<li>其应用非常广泛，在SSH、VPN、Https…都有应用，勘称现代密码基石</li>
</ul>
<p>DH 实现过程：</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">A</span><span class="punctuation">: </span>g,p 协商生成公开的整数g, 大素数p</span><br><span class="line"><span class="attribute">B</span><span class="punctuation">: </span>g,p</span><br><span class="line">A:生成隐私数据:a (a&lt;p)，计算得出 g^a%p，发送给B</span><br><span class="line">B:生成隐私数据:b,(b&lt;p)，计算得出 g^b%p，发送给A</span><br><span class="line">A:计算得出 [(g^b%p)^a]%p = g^ab%p，生成为密钥</span><br><span class="line">B:计算得出 [(g^a%p)^b]%p = g^ab%p，生成为密钥</span><br></pre></td></tr></table></figure>

<p>DH 特点</p>
<p>泄密风险：私密数据a，b在生成K后将被丢弃，因此不存在a，b过长时间存在导致增加泄密风险。 </p>
<p>中间人攻击：由于DH在传输p，g时并无身份验证，所以有机会被实施中间人攻击，替换双方传输时的数据</p>
<p>范例:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">g=23</span><br><span class="line">p=5</span><br><span class="line"></span><br><span class="line">A:a=6</span><br><span class="line">g^a%p=23^6%5=4</span><br><span class="line"></span><br><span class="line">[(g^b%p)^a]%p=2^6%5=4</span><br><span class="line"></span><br><span class="line">B:b=15</span><br><span class="line">g^b%p=23^15%5=2</span><br><span class="line"></span><br><span class="line">[(g^a%p)^b]%p=4^15%5=4</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@centos8 ~]<span class="comment">#echo 23^15%5|bc</span></span><br><span class="line">2</span><br><span class="line"></span><br><span class="line">[root@centos8 ~]<span class="comment">#echo 23^6%5|bc</span></span><br><span class="line">4</span><br><span class="line"></span><br><span class="line">[root@centos8 ~]<span class="comment">#echo 2^6%5|bc</span></span><br><span class="line">4</span><br><span class="line"></span><br><span class="line">[root@centos8 ~]<span class="comment">#echo 4^15%5|bc</span></span><br><span class="line">4</span><br></pre></td></tr></table></figure>

<h2 id="CA和证书"><a href="#CA和证书" class="headerlink" title="CA和证书"></a>CA和证书</h2><h3 id="中间人攻击"><a href="#中间人攻击" class="headerlink" title="中间人攻击"></a>中间人攻击</h3><p>Man-in-the-middle，简称为 MITM，中间人</p>
<p><img src="../../../../images/SRE/day15/11.png" alt="11"></p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://www.zhihu.com/question/304363663</span><br></pre></td></tr></table></figure>

<p><img src="../../../../images/SRE/day15/12.png" alt="12"></p>
<p><img src="../../../../images/SRE/day15/13.png" alt="13"></p>
<h3 id="CA和证书-1"><a href="#CA和证书-1" class="headerlink" title="CA和证书"></a>CA和证书</h3><p><img src="../../../../images/SRE/day15/14.png" alt="14"></p>
<p><img src="../../../../images/SRE/day15/15.png" alt="15"></p>
<p>PKI：Public Key Infrastructure 公共密钥加密体系 </p>
<p>签证机构：CA（Certificate Authority）</p>
<p>注册机构：RA</p>
<p>证书吊销列表：CRL</p>
<p>证书存取库： </p>
<p>X.509：定义了证书的结构以及认证协议标准</p>
<ul>
<li>版本号</li>
<li>序列号</li>
<li>签名算法</li>
<li>颁发者</li>
<li>有效期限</li>
<li>主体名称 </li>
</ul>
<p>证书类型：</p>
<ul>
<li>证书授权机构的证书</li>
<li>服务器证书</li>
<li>用户证书 </li>
</ul>
<p>获取证书两种方法：</p>
<ul>
<li>自签名的证书： 自已签发自己的公钥</li>
<li>使用证书授权机构：<ul>
<li>生成证书请求（csr） </li>
<li>将证书请求csr发送给CA </li>
<li>CA签名颁发证书</li>
</ul>
</li>
</ul>
<h3 id="安全协议-SSL-TLS"><a href="#安全协议-SSL-TLS" class="headerlink" title="安全协议 SSL/TLS"></a>安全协议 SSL/TLS</h3><h4 id="TLS-介绍"><a href="#TLS-介绍" class="headerlink" title="TLS 介绍"></a>TLS 介绍</h4><p>SSL：Secure Socket Layer，TLS: Transport Layer Security</p>
<p>1994年，NetScape公司设计了SSL协议（Secure Sockets Layer）的1.0版，但是未发布</p>
<p>1995：SSL 2.0 Netscape 开发</p>
<p>1996：SSL 3.0</p>
<p>1999：TLS 1.0</p>
<p>2006：TLS 1.1 IETF(Internet工程任务组) RFC 4346，从2020年3月起，停止支持TLS 1.1及TLS 1.0版本安全协议，谷歌（Chrome）、Mozilla（Firefox）、微软（IE和Edge） 、苹果（Safari） 都会发布新版浏览器执行这个策略</p>
<p>2008：TLS 1.2 当前主要使用</p>
<p>2018：TLS 1.3 </p>
<p>功能：</p>
<ul>
<li>机密性</li>
<li>认证</li>
<li>完整性</li>
<li>重放保护</li>
</ul>
<h4 id="SSL-TLS组成"><a href="#SSL-TLS组成" class="headerlink" title="SSL/TLS组成"></a>SSL/TLS组成</h4><p><img src="../../../../images/SRE/day15/16.png" alt="16"></p>
<ul>
<li>Handshake协议：包括协商安全参数和密码套件、服务器身份认证（客户端身份认证可选）、密钥交换</li>
<li>ChangeCipherSpec 协议：一条消息表明握手协议已经完成 </li>
<li>Alert 协议：对握手协议中一些异常的错误提醒，分为fatal和warning两个级别，fatal类型错误会直接中断SSL链接，而warning级别的错误SSL链接仍可继续，只是会给出错误警告</li>
<li>Record 协议：包括对消息的分段、压缩、消息认证和完整性保护、加密等</li>
</ul>
<h3 id="HTTPS"><a href="#HTTPS" class="headerlink" title="HTTPS"></a>HTTPS</h3><p>HTTPS 协议：就是“HTTP 协议”和“SSL/TLS 协议”的组合。HTTP over SSL 或 HTTP over TLS ，对http协议的文本数据进行加密处理后，成为二进制形式传输</p>
<h4 id="HTTPS-结构"><a href="#HTTPS-结构" class="headerlink" title="HTTPS 结构"></a>HTTPS 结构</h4><p><img src="../../../../images/SRE/day15/17.png" alt="17"></p>
<h4 id="HTTPS-工作的简化过程"><a href="#HTTPS-工作的简化过程" class="headerlink" title="HTTPS 工作的简化过程"></a>HTTPS 工作的简化过程</h4><p><img src="../../../../images/SRE/day15/18.png" alt="18"></p>
<ol>
<li><p>客户端发起HTTPS请求</p>
<p>用户在浏览器里输入一个https网址，然后连接到服务器的443端口</p>
</li>
<li><p>服务端的配置</p>
<p>采用HTTPS协议的服务器必须要有一套数字证书，可以自己制作，也可以向组织申请。区别就是自己颁发的证书需要客户端验证通过，才可以继续访问，而使用受信任的公司申请的证书则不会弹出提示页面。这套证书其实就是一对公钥和私钥</p>
</li>
<li><p>传送服务器的证书给客户端</p>
<p>证书里其实就是公钥，并且还包含了很多信息，如证书的颁发机构，过期时间等等</p>
</li>
<li><p>客户端解析验证服务器证书</p>
<p>这部分工作是由客户端的TLS来完成的，首先会验证公钥是否有效，比如：颁发机构，过期时间等等，如果发现异常，则会弹出一个警告框，提示证书存在问题。如果证书没有问题，那么就生成一个随机值。然后用证书中公钥对该随机值进行非对称加密</p>
</li>
<li><p>客户端将加密信息传送服务器</p>
<p>这部分传送的是用证书加密后的随机值，目的就是让服务端得到这个随机值，以后客户端和服务端的通信就可以通过这个随机值来进行加密解密了 </p>
</li>
<li><p>服务端解密信息 </p>
<p>服务端将客户端发送过来的加密信息用服务器私钥解密后，得到了客户端传过来的随机值 </p>
</li>
<li><p>服务器加密信息并发送信息</p>
<p>服务器将数据利用随机值进行对称加密,再发送给客户端 </p>
</li>
<li><p>客户端接收并解密信息</p>
<p>客户端用之前生成的随机值解密服务段传过来的数据，于是获取了解密后的内容</p>
</li>
</ol>
<h1 id="OpenSSL"><a href="#OpenSSL" class="headerlink" title="OpenSSL"></a>OpenSSL</h1><h2 id="OpenSSL-介绍"><a href="#OpenSSL-介绍" class="headerlink" title="OpenSSL 介绍"></a>OpenSSL 介绍</h2><p><img src="../../../../images/SRE/day15/19.png" alt="19"></p>
<p>官网：<a target="_blank" rel="noopener" href="https://www.openssl.org/">https://www.openssl.org/</a></p>
<p>OpenSSL计划在1998年开始，其目标是发明一套自由的加密工具，在互联网上使用。OpenSSL以Eric Young以及Tim Hudson两人开发的SSLeay为基础，随着两人前往RSA公司任职，SSLeay在1998年12月停止开发。因此在1998年12月，社群另外分支出OpenSSL，继续开发下去 </p>
<p>OpenSSL管理委员会当前由7人组成,有13个开发人员具有提交权限（其中许多人也是OpenSSL管理委员会的一部分）。只有两名全职员工（研究员），其余的是志愿者</p>
<p>该项目每年的预算不到100万美元，主要依靠捐款。 TLS 1.3 的开发由 Akamai 赞助 </p>
<p>OpenSSL是一个开放源代码的软件库包，应用程序可以使用这个包来进行安全通信，避免窃听，同时确认另一端连线者的身份。这个包广泛被应用在互联网的网页服务器上</p>
<p>其主要库是以C语言所写成，实现了基本的加密功能，实现了SSL与TLS协议。OpenSSL可以运行在 OpenVMS、 Microsoft Windows以及绝大多数类Unix操作系统上（包括Solaris，Linux，Mac OS X与各种版本的开放源代码BSD操作系统）</p>
<p>心脏出血漏洞：OpenSSL 1.0.1版本（不含1.0.1g）含有一个严重漏洞，可允许攻击者读取服务器的内存信息。该漏洞于2014年4月被公诸于世，影响三分之二的活跃网站</p>
<p>包括三个组件：</p>
<ul>
<li>libcrypto：用于实现加密和解密的库</li>
<li>libssl：用于实现ssl通信协议的安全库</li>
<li>openssl：多用途命令行工具</li>
</ul>
<h2 id="Base64-编码"><a href="#Base64-编码" class="headerlink" title="Base64 编码"></a>Base64 编码</h2><p>Base64是网络上最常见的用于传输 8Bit 字节码的编码方式之一，Base64就是一种基于64个可打印字符来表示二进制数据的方法</p>
<p><img src="../../../../images/SRE/day15/20.png" alt="20"></p>
<p><strong>base64的编码过程如下：</strong></p>
<p>将每3个字节放入一个24位的缓冲区中，最后不足3个字节的，缓冲区的剩余部分用0来填补。然后每次取出6位（2的6次方为64，使用64个字符即可表示所有），将高2位用0来填充，组成一个新的字节，计算出这个新字节的十进制值，对应上面的编码表，输出相应的字符。这样不断地进行下去，就可完成对所有数据的编码工作。</p>
<p>按照以上规则对文本Man编码如下：</p>
<p><img src="../../../../images/SRE/day15/21.png" alt="21"></p>
<p>范例：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ~]<span class="comment">#echo -n Man | base64</span></span><br><span class="line">TWFu</span><br><span class="line"></span><br><span class="line">[root@centos8 ~]<span class="comment">#echo TWFu | base64 -d</span></span><br><span class="line">Man[root@centos8 ~]<span class="comment">#</span></span><br><span class="line"></span><br><span class="line">[root@centos8 ~]<span class="comment">#echo -n ab | base64</span></span><br><span class="line">YWI=</span><br><span class="line">[root@centos8 ~]<span class="comment">#echo -n ab | base64 | base64 -d</span></span><br><span class="line">ab[root@centos8 ~]<span class="comment">#</span></span><br></pre></td></tr></table></figure>

<p>范例：破解下面密文</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">JXU0RjYwJXU1OTdEJXU2NzBCJXU1M0NCJXVGRjAxJXU2MjExJXU2NjJGJXU3MzhCJXU2NjUzJXU2NjI1JXVGRjBDJXU2MjExJXU3Njg0UVEldUZGMUEyOTMwODYyMCV1RkYwQyV1NTNFRiV1NEVFNSV1NTJBMCV1NEUyQSV1NTk3RCV1NTNDQiV1NTQxNyV1RkYxRiUwQQ==</span><br></pre></td></tr></table></figure>

<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@rocky9 ~]<span class="comment"># echo -n &quot;JXU0RjYwJXU1OTdEJXU2NzBCJXU1M0NCJXVGRjAxJXU2MjExJXU2NjJGJXU3MzhCJXU2NjUzJXU2NjI1JXVGRjBDJXU2MjExJXU3Njg0UVEldUZGMUEyOTMwODYyMCV1RkYwQyV1NTNFRiV1NEVFNSV1NTJBMCV1NEUyQSV1NTk3RCV1NTNDQiV1NTQxNyV1RkYxRiUwQQ==&quot; | base64 -d | perl -CS -pe &#x27;s/%u([\da-fA-F]&#123;4&#125;)/chr(hex($1))/ge; s/%0A/\n/g&#x27;</span></span><br><span class="line">你好朋友！我是王晓春，我的QQ：29308620，可以加个好友吗？</span><br></pre></td></tr></table></figure>

<h2 id="openssl-命令"><a href="#openssl-命令" class="headerlink" title="openssl 命令"></a>openssl 命令</h2><p>两种运行模式：</p>
<ul>
<li>交互模式</li>
<li>批处理模式 </li>
</ul>
<p>三种子命令：</p>
<ul>
<li>标准命令</li>
<li>消息摘要命令</li>
<li>加密命令</li>
</ul>
<p>范例: openssl的交互和非交互式查看版本</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">root@ubuntu2004:~<span class="comment"># openssl version</span></span><br><span class="line">OpenSSL 1.1.1f  31 Mar 2020</span><br><span class="line"></span><br><span class="line">[root@centos8 ~]<span class="comment"># openssl version</span></span><br><span class="line">OpenSSL 1.1.1c FIPS  28 May 2019</span><br><span class="line"></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment"># openssl </span></span><br><span class="line">OpenSSL&gt; version</span><br><span class="line">OpenSSL 1.1.1  11 Sep 2018</span><br><span class="line"></span><br><span class="line">[root@centos7 ~]<span class="comment"># openssl</span></span><br><span class="line">OpenSSL&gt; version</span><br><span class="line">OpenSSL 1.0.2k-fips  26 Jan 2017</span><br></pre></td></tr></table></figure>

<p>范例：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ~]<span class="comment"># openssl version</span></span><br><span class="line">OpenSSL 1.1.1 FIPS  11 Sep 2018</span><br><span class="line"></span><br><span class="line">[root@centos8 ~]<span class="comment"># openssl help</span></span><br><span class="line">Standard commands</span><br><span class="line">asn1parse         ca               ciphers          cms               </span><br><span class="line">crl               crl2pkcs7        dgst             dhparam           </span><br><span class="line">dsa               dsaparam         ec               ecparam           </span><br><span class="line">enc               engine           errstr           gendsa </span><br><span class="line">genpkey           genrsa           <span class="built_in">help</span>             list              </span><br><span class="line">nseq              ocsp             passwd           pkcs12            </span><br><span class="line">pkcs7             pkcs8            pkey            pkeyparam </span><br><span class="line"></span><br><span class="line">[root@centos8 ~]<span class="comment"># openssl</span></span><br><span class="line">OpenSSL&gt; <span class="built_in">help</span></span><br><span class="line">Standard commands</span><br><span class="line">asn1parse         ca               ciphers           cms               </span><br><span class="line">crl               crl2pkcs7         dgst             dhparam           </span><br><span class="line">......       </span><br><span class="line">OpenSSL&gt; ca --<span class="built_in">help</span></span><br><span class="line">Usage: ca [options]</span><br><span class="line">Valid options are:</span><br><span class="line">-<span class="built_in">help</span>                   Display this summary</span><br><span class="line">-verbose               Verbose output during processing</span><br><span class="line">-config val             A config file</span><br><span class="line">......</span><br><span class="line">OpenSSL&gt;q</span><br></pre></td></tr></table></figure>

<h3 id="openssl命令单向哈希加密"><a href="#openssl命令单向哈希加密" class="headerlink" title="openssl命令单向哈希加密"></a>openssl命令单向哈希加密</h3><p>工具：openssl dgst </p>
<p>算法：md5sum, sha1sum, sha224sum,sha256sum… </p>
<p>dgst 命令：帮助：man dgst</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">openssl dgst -md5 [-hex默认] /PATH/SOMEFILE</span><br><span class="line">openssl dgst -md5 testfile</span><br><span class="line"><span class="built_in">md5sum</span> /PATH/TO/SOMEFILE</span><br><span class="line"></span><br><span class="line">[root@centos8 data]<span class="comment"># openssl md5 fstab</span></span><br><span class="line">MD5(fstab)= 8f8e3b0d0c17f1b29d404544c7b310da</span><br><span class="line"></span><br><span class="line">[root@centos8 data]<span class="comment"># openssl sha512 fstab</span></span><br><span class="line">SHA512(fstab)=</span><br><span class="line">81f67107026a43bf60fff2cdd6ebe93f49ad3bf48e3645912aa0e8d27eec8d9647121f608c7b6ad1</span><br><span class="line">94856318f0381db21f6961db862e99644126b64c38a5eeb6</span><br><span class="line"></span><br><span class="line">[root@centos8 data]<span class="comment"># sha512sum fstab</span></span><br><span class="line">81f67107026a43bf60fff2cdd6ebe93f49ad3bf48e3645912aa0e8d27eec8d9647121f608c7b6ad1</span><br><span class="line">94856318f0381db21f6961db862e99644126b64c38a5eeb6 fstab</span><br></pre></td></tr></table></figure>

<p>补充知识：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">MAC: Message Authentication Code，单向加密的一种延伸应用，用于实现网络通信中保证所传输数据的完整性机制</span><br><span class="line">HMAC：hash-based MAC，使用哈希算法</span><br></pre></td></tr></table></figure>

<h3 id="openssl-命令生成用户密码"><a href="#openssl-命令生成用户密码" class="headerlink" title="openssl 命令生成用户密码"></a>openssl 命令生成用户密码</h3><p>passwd命令:帮助：man sslpasswd</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ~]<span class="comment">#openssl passwd --help</span></span><br><span class="line">Usage: passwd [options]</span><br><span class="line">Valid options are:</span><br><span class="line">-<span class="built_in">help</span>               Display this summary</span><br><span class="line">-<span class="keyword">in</span> infile         Read passwords from file</span><br><span class="line">-noverify           Never verify when reading password from terminal</span><br><span class="line">-quiet             No warnings</span><br><span class="line">-table             Format output as table</span><br><span class="line">-reverse           Switch table columns</span><br><span class="line">-salt val           Use provided salt</span><br><span class="line">-stdin             Read passwords from stdin</span><br><span class="line">-6                 SHA512-based password algorithm</span><br><span class="line">-5                 SHA256-based password algorithm</span><br><span class="line">-apr1               MD5-based password algorithm, Apache variant</span><br><span class="line">-1                 MD5-based password algorithm</span><br><span class="line">-aixmd5             AIX MD5-based password algorithm</span><br><span class="line">-crypt             Standard Unix password algorithm (default)</span><br><span class="line">-rand val           Load the file(s) into the random number generator</span><br><span class="line">-writerand outfile Write random data to the specified file</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@centos7 ~]<span class="comment"># openssl passwd --help</span></span><br><span class="line">Usage: passwd [options] [passwords]</span><br><span class="line"><span class="built_in">where</span> options are</span><br><span class="line">-crypt             standard Unix password algorithm (default)</span><br><span class="line">-1                 MD5-based password algorithm</span><br><span class="line">-apr1             MD5-based password algorithm, Apache variant</span><br><span class="line">-salt string       use provided salt</span><br><span class="line">-<span class="keyword">in</span> file           <span class="built_in">read</span> passwords from file</span><br><span class="line">-stdin             <span class="built_in">read</span> passwords from stdin</span><br><span class="line">-noverify         never verify when reading password from terminal</span><br><span class="line">-quiet             no warnings</span><br><span class="line">-table             format output as table</span><br><span class="line">-reverse           switch table columns</span><br></pre></td></tr></table></figure>

<p>范例：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ~]<span class="comment">#getent shadow wang</span></span><br><span class="line">wang:$6$Y16DiwuVQtL6XCQK<span class="variable">$DAQO4BhVbfQmaUMFWKR61hVwFvxk7J9U4pZaFcwf6nBwERUN6bL3wALPonDRebk3CgooupeXHfRuFKRciUe6q</span>.:18373:0:99999:7:::</span><br><span class="line"></span><br><span class="line">[root@centos8 ~]<span class="comment">#echo magedu | openssl passwd -6 -salt Y16DiwuVQtL6XCQK -stdin </span></span><br><span class="line">$6$Y16DiwuVQtL6XCQK<span class="variable">$DAQO4BhVbfQmaUMFWKR61hVwFvxk7J9U4pZaFcwf6nBwERUN6bL3wALPonDRebk3CgooupeXHfRuFKRciUe6q</span>.</span><br><span class="line"></span><br><span class="line">[root@ubuntu ~]<span class="comment">#openssl passwd -6 -salt Y16DiwuVQtL6XCQK magedu</span></span><br><span class="line">$6$Y16DiwuVQtL6XCQK<span class="variable">$DAQO4BhVbfQmaUMFWKR61hVwFvxk7J9U4pZaFcwf6nBwERUN6bL3wALPonDRebk3CgooupeXHfRuFKRciUe6q</span>.</span><br></pre></td></tr></table></figure>

<p>范例: 利用Python程序在CentOS7 生成sha512加密密码</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@centos7 ~]<span class="comment"># python -c &#x27;import  crypt,getpass;pw=&quot;magedu&quot;;print(crypt.crypt(pw))&#x27;</span></span><br><span class="line">$6$pt0SFMf6YqKea3mh$.7Hkslg17uI.Wu7BcMJStVVtkzrwktXrOC8DxcMFC4JO1igrqR7VAi87H5PHOuLTUEjl7eJqKUhMT1e9ixojn1</span><br></pre></td></tr></table></figure>

<p>范例：创建新用户同时指定密码，在CentOS8和Ubuntu都通用</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ~]<span class="comment"># useradd -p `echo magedu | openssl passwd -6 -salt Y16DiwuVQtL6XCQK -stdin` zhang</span></span><br><span class="line"></span><br><span class="line">[root@centos8 ~]<span class="comment"># getent shadow zhang</span></span><br><span class="line">zhang:$6$Y16DiwuVQtL6XCQK<span class="variable">$DAQO4BhVbfQmaUMFWKR61hVwFvxk7J9U4pZaFcwf6nBwERUN6bL3wALPonDRebk3CgooupeXHfRuFKRciUe6q</span>.:18402:0:99999:7:::</span><br><span class="line"></span><br><span class="line">[root@centos8 ~]<span class="comment">#getent shadow zhang wang</span></span><br><span class="line">zhang:$6$Y16DiwuVQtL6XCQK<span class="variable">$DAQO4BhVbfQmaUMFWKR61hVwFvxk7J9U4pZaFcwf6nBwERUN6bL3wALPonDRebk3CgooupeXHfRuFKRciUe6q</span>.:18402:0:99999:7:::</span><br><span class="line">wang:$6$Y16DiwuVQtL6XCQK<span class="variable">$DAQO4BhVbfQmaUMFWKR61hVwFvxk7J9U4pZaFcwf6nBwERUN6bL3wALPonDRebk3CgooupeXHfRuFKRciUe6q</span>.:18373:0:99999:7:::</span><br></pre></td></tr></table></figure>

<p>范例：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">openssl passwd -1 -salt SALT(最多8位)</span><br><span class="line">openssl passwd -1 -salt centos</span><br></pre></td></tr></table></figure>

<h3 id="openssl命令生成随机数"><a href="#openssl命令生成随机数" class="headerlink" title="openssl命令生成随机数"></a>openssl命令生成随机数</h3><p>随机数生成器：伪随机数字，利用键盘和鼠标，块设备中断生成随机数</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">/dev/random       <span class="comment">#仅从熵池返回随机数；随机数用尽，阻塞</span></span><br><span class="line">/dev/urandom      <span class="comment">#从熵池返回随机数；随机数用尽，会利用软件生成伪随机数，非阻塞</span></span><br></pre></td></tr></table></figure>

<p>帮助：man sslrand</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">openssl rand -<span class="built_in">base64</span>|-hex NUM</span><br><span class="line"></span><br><span class="line">NUM: 表示字节数，使用-hex，每个字符为十六进制，相当于4位二进制，出现的字符数为NUM*2</span><br></pre></td></tr></table></figure>

<p>范例：生成随机10位长度密码</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ~]<span class="comment">#openssl rand -base64 9 |head -c10</span></span><br><span class="line">ip97t6qQes[root@centos8 ~]<span class="comment">#</span></span><br><span class="line"></span><br><span class="line">[root@centos8 ~]<span class="comment">#tr -dc &#x27;[:alnum:]&#x27; &lt; /dev/urandom |head -c10</span></span><br><span class="line">DO2mDp3eZu[root@centos8 ~]<span class="comment">#</span></span><br></pre></td></tr></table></figure>

<h3 id="openssl命令实现-PKI"><a href="#openssl命令实现-PKI" class="headerlink" title="openssl命令实现 PKI"></a>openssl命令实现 PKI</h3><p>公钥加密：</p>
<p>​        算法：RSA, ELGamal<br>​        工具：gpg, openssl rsautl（man rsautl）</p>
<p>数字签名：</p>
<p>​        算法：RSA, DSA, ELGamal</p>
<p>密钥交换：</p>
<p>​        算法：dh<br>​        DSA：Digital Signature Algorithm<br>​        DSS：Digital Signature Standard<br>​        RSA： </p>
<p>openssl命令生成密钥对儿：man genrsa</p>
<p><strong>生成私钥</strong></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">openssl genrsa -out /PATH/TO/PRIVATEKEY.FILE [-aes128] [-aes192] [-aes256] [-des3] [NUM_BITS,默认2048]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#对称加密算法:man genrsa</span></span><br><span class="line">-aes128, -aes192, -aes256, -aria128, -aria192, -aria256, </span><br><span class="line">-camellia128, -camellia192, -camellia256, -des, -des3, -idea</span><br></pre></td></tr></table></figure>

<p><strong>解密加密的私钥</strong></p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">openssl rsa -in /PATH/TO/PRIVATEKEY.FILE -out /PATH/TO/PRIVATEKEY2.FILE</span><br></pre></td></tr></table></figure>

<p>范例: 生成的私钥设置权限保证安装</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#对私钥通过设置严格的权限实现安全，应用更广泛</span></span><br><span class="line">[root@centos8 ~]<span class="comment">#(umask 077; openssl genrsa -out /data/app1.key 2048)</span></span><br><span class="line">[root@centos8 ~]<span class="comment">#cat /data/app1.key</span></span><br><span class="line">-----BEGIN RSA PRIVATE KEY-----</span><br><span class="line">MIIEpQIBAAKCAQEA4uAOqFCGYqJ6xh4VAjAtX8Jj35pXVpFgQb3N8G57RElN9X5R</span><br><span class="line">RQNzaAIT7z+3vyar54WqQtT/PIPnWr9xXuUsyVb+MNV6Pbvx+bQzKeMjKtrXfe/o</span><br><span class="line">FFon2d1YBF338QF1dH2NP5DUITN1jiUoMjyKyZlzzazTER9pTehdExL5xmu63n6y</span><br><span class="line">qDXdmiYbgTGzjKub/3WwGYZi4WZ0Urn1DPq7mXQ2Las8xr8/nRFjtckYdXakggGS</span><br><span class="line">YoRPRYKxFCU62tXtD6T1quxg96WwPeeyoXviSbhdwr1DPT/OFL6aFehjTNA2ytCG</span><br><span class="line">FSbVhkz6TzBs3iLjcQGiMhG2stDoBO6gyFcL4QIDAQABAoIBADTp1uFQrpcQmBve</span><br><span class="line">5j11aQ+9cbez8ozBKTcMAp0B14QMqL8J8ABtlpv6aBXTwZI2fb9owFYIAWNmzC2x</span><br><span class="line">GsrsHm7y+CQBlhoR3JTFf21UiV40XjAEJReiE0tPwXh7RhmSoodBxRC/QYpgyxkU</span><br><span class="line">93QIBMKSJJ0iorOKpO/DsvmA4npxM2ChXYLHHEmNkhcBw2vV5RJIlXK2QKC9vqyk</span><br><span class="line">TmlOXPWBynEV68zbsRjVKSTmYh+48AJvDVJzqLSUF/Pyy6qXYnXUcBV1r683YxY4</span><br><span class="line">bppuQtbFhpLoD0p6wQzwv0qdlEYKMuStO644lkf71qX3bQLwx4CGs8kY+ip2LF3q</span><br><span class="line">hOM75yUCgYEA8Twueghbn99cxm4Nw++U62OpxSeVvbk8HU4tENKcz+G/NmQewjxV</span><br><span class="line">gwCxxw8G+f6xZLBfiZP9UItURLw6gf/7pilfphK2FOJaJ7B52z4jCJpNNYwi5VHw</span><br><span class="line">6M/s0S6Pr3w6fmFKqC/LKAVgesusrTD26GajI8oftkjHowDjZV724xMCgYEA8MLg</span><br><span class="line">bEY0VHaBYxEZelBxRFxCO7fHFiilFRKaRctPzCHYm3MNvr55yFNySW1nG4f8pBGg</span><br><span class="line">sthkeU4frPmYBlOkPt+W/pnOmut0y+ePfe/aIIfV/VjGpX41Qvb54G3fRyyK6zIR</span><br><span class="line">Eun1nv1pu35BH7BsrCZz7TNKzCbV9Im7XK2cv7sCgYEAuDBCMEznYHcUCDIJcpwg</span><br><span class="line">MWYkPvONgpHHU3zYLesRbiwoaigh0B5vEBpcoudXZVPRMFb2az5CgNgRHHY3mgDQ</span><br><span class="line">rLsUW+IXgnSdb4ZwVDTqXOwrnYIFNuDMt4XihIkvjkalBs/UR/xN+p24X6nZi1dC</span><br><span class="line">fom3cGEou25wd4X7GfBbQ18CgYEApU+5lr6RmdkQuDv6eXCYhS6vz589VKqtxw1R</span><br><span class="line">3lBeRzSKLRpPusPAjNs3ItG6tT2nK+RqqcJJIr2QpE1wpA90PDN70u863EaFmKgz</span><br><span class="line">b25sIGAEf4MgSmuhGIzKP95RK+aasCldbdY072ji23kyMBcMVxvEB39rgUe9Kr4T</span><br><span class="line">ZuxSL5cCgYEAjPm5H6t4/FbeNIC26TrtI+af2liI3jMYsTVj4ReSOll+wblyWPuc</span><br><span class="line">0TxCBGSJ7p9ZIaqz4ROp9yGu7XHeQ/f7Wfk9ouLhnicHVDIQk+2iLnll8QvHBuAW</span><br><span class="line">BKfUkUuzdov1jy1FgojHLQcADJTW0H9+20gFgNaOJhZaVJtqoTFJg/k=</span><br><span class="line">-----END RSA PRIVATE KEY-----</span><br></pre></td></tr></table></figure>

<p>范例: </p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#用加密对称密钥加密私钥,此方式更安全，但是不方便</span></span><br><span class="line">[root@centos8 ~]<span class="comment">#openssl genrsa -out /data/app2.key -des3 2048</span></span><br><span class="line">Generating RSA private key, 2048 bit long modulus (2 primes)</span><br><span class="line">................................................................................</span><br><span class="line">..................................+++++</span><br><span class="line">....................+++++</span><br><span class="line">e is 65537 (0x010001)</span><br><span class="line">Enter pass phrase <span class="keyword">for</span> /data/app2.key:</span><br><span class="line">Verifying - Enter pass phrase <span class="keyword">for</span> /data/app2.key:</span><br><span class="line">[root@centos8 ~]<span class="comment">#cat /data/app2.key </span></span><br><span class="line">-----BEGIN RSA PRIVATE KEY-----</span><br><span class="line">Proc-Type: 4,ENCRYPTED</span><br><span class="line">DEK-Info: DES-EDE3-CBC,A153AEC7D2C38828</span><br><span class="line">X6FESnpei3oqHGPXEyPnAVLo9pr5Ttd7PYi7lRQzS3jAOy+Z3iil7tv7Loa+F4jx</span><br><span class="line">P6kHMiO+oxI2BFiRWTKUzVSI1Cale3r7lfpbFRRFAlx3rEOqdCAF8MB7M88F/z79</span><br><span class="line">WVL7amGUzubMYERLKxPRuAbMe4jcDIbC2D82Pn0XWU8CGhILTMePm3KpPPTAxMdt</span><br><span class="line">XjWBBryPXr9KTq2yavNW4MtwLqWVELK+As0NnD3TK0wgm+nCLJY2kVxneX2eiAC/</span><br><span class="line">uLuWP5oKcDVml2k12itrOSdGv9zMH0uLtbMPCYxqEz9ETJe/PmutLTLFihLk3nZu</span><br><span class="line">s/TTR8oYh0VaHrFQxxmHtV3Og2ZtETjVZ3jv0WjTVVi+R4AOY/6Pz1Dp/O0TJ87g</span><br><span class="line">1ttoXe4bFN541GQvdnnPB1uLuDEUzbV4EcY33VXStvt7+QPPrLK2C/NLq7xrIxeq</span><br><span class="line">XaYMIZifxPwrNmXrPEp66VuULoyc03r4Y7RGjMh7Asico9X1OkRe3xfpt1FBzd89</span><br><span class="line">J3XNL1+Q83GBdZ+c93ar3vVorBtPoz6klq2F0WciNcC2RCzv8okk6UOi9VoMshhf</span><br><span class="line">8xfCAyyowEmbMdFttFsSoKOFGpP5U08jPfqXam2e+fPTSaW/Z2yCNHuqynu7deeN</span><br><span class="line">ra9VrGPHKrcH/K3C/LPAdgFo1P0MY0qntrgPHN9LSXmNrUONG1I7U5O14hgWC6sm</span><br><span class="line">yqv2f9ygfv9g5ea3UZt/mLtZHnoFfdODHXMEUeeWd4VSxDyzaExwxFfi4OBvFX0b</span><br><span class="line">Y2yghsLyhcoVkrVe8hkRSpgK7lQ+cjW686X6M99yWF6gNZxl/riK/e8eu1YZvPSA</span><br><span class="line">I/YUEdeOKevmk71jOKMvnJkIAC+zIctoiiYYEm4TAmiAmRvqMHo1tiWhejU0vAPW</span><br><span class="line">ECTubVuEzKr1mXIRnk6LxfMYwYhLbkfwV/GtqMIhLL6dEk25MbVVFe9ERMguRKNT</span><br><span class="line">gS/BgYalVNXaIdlBHAtveM8wDtjqXhgFewdAo910VWemoQLwNLr0qZj5xBqevyfh</span><br><span class="line">+y/NMQRz/7u3/8rUV0lgLYq3/NW1h7/HPkbG6piaQkMkoYfkQ+iq8W2q+CR09cqf</span><br><span class="line">NkS+zpVldrKE/73iSUt07m65TrfSwA3epNR767b6KG2Umjdu0R4z8+LCf+0zB9Yo</span><br><span class="line">IJA+G3x4gWpIc1FL1ZNyPoU+02KHh7FdGtkKyhRd1b3q1HzF3mg2tx2yT1F5dC55</span><br><span class="line">mk+561m22cQZsZDuf0ps80rAMobAtu44VGdmnuGhW8U7s7sz3esa0mOBf57G7HKX</span><br><span class="line">97uIp1mTvyu52oDbKfeTD/jjlyYI28svAFl49kGL3cG/4C6peh3qvgRLfF0dB4Gn</span><br><span class="line">Ad5qIU1s0NXluIX02x74g1yAS+iw+PmC372DQedv1qLzJCM2TLKfhdVPvP4Ewo73</span><br><span class="line">O6gMVjVabyUvmNBbQ3n7R8hY5LhCYLDfWFCInbDR673R7diucl90x+xl0+dsP7Nr</span><br><span class="line">ZlvtHOA9mKTCDkX/iNfFUEKg87fY9qFs5TrZVzJm0q3PZciRrpG+hN7UShXL4KlB</span><br><span class="line">/TecIedtaZV+8qPPG0URzDGASgqQinVYqh3qt9oAevb2hqAMrpM3zqAsSVowAwaE</span><br><span class="line">-----END RSA PRIVATE KEY-----</span><br><span class="line">[root@centos8 ~]<span class="comment">#</span></span><br></pre></td></tr></table></figure>

<p><strong>从私钥中提取出公钥</strong></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">openssl rsa -<span class="keyword">in</span> PRIVATEKEYFILE -pubout -out PUBLICKEYFILE</span><br></pre></td></tr></table></figure>

<p>范例：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">openssl rsa -<span class="keyword">in</span> test.key -pubout -out test.key.pub</span><br></pre></td></tr></table></figure>

<p>范例：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">[root@centos7 ~]<span class="comment"># (umask 066;openssl genrsa -out /data/app.key)</span></span><br><span class="line">Generating RSA private key, 2048 bit long modulus</span><br><span class="line">........................+++</span><br><span class="line">.+++</span><br><span class="line">e is 65537 (0x10001)</span><br><span class="line"></span><br><span class="line">[root@centos7 ~]<span class="comment"># ls -l /data/</span></span><br><span class="line">total 4</span><br><span class="line">-rw------- 1 root root 1679 Feb  3 15:26 app.key</span><br><span class="line">[root@centos8 ~]<span class="comment"># openssl genrsa -out /data/app.key 1024</span></span><br><span class="line">Generating RSA private key, 1024 bit long modulus (2 primes)</span><br><span class="line">.............................................................................+++</span><br><span class="line">++</span><br><span class="line">..........+++++</span><br><span class="line">e is 65537 (0x010001)</span><br><span class="line"></span><br><span class="line">[root@centos8 ~]<span class="comment"># ll /data/app.key</span></span><br><span class="line">-rw------- 1 root root 891 Feb  3 14:52 /data/app.key</span><br></pre></td></tr></table></figure>

<p>范例：利用私钥提取公钥</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ~]<span class="comment">#(umask 066;openssl genrsa -out /data/app.key)</span></span><br><span class="line"></span><br><span class="line">[root@centos8 ~]<span class="comment">#openssl rsa -in /data/app.key -pubout -out /data/app.key.pub</span></span><br><span class="line">writing RSA key</span><br><span class="line"></span><br><span class="line">[root@centos8 ~]<span class="comment">#ls -l /data/</span></span><br><span class="line">total 8</span><br><span class="line">-rw------- 1 root root 887 Feb  3 15:28 app.key</span><br><span class="line">-rw-r--r-- 1 root root 272 Feb  3 15:32 app.key.pub</span><br><span class="line"></span><br><span class="line">[root@centos8 ~]<span class="comment">#cat /data/app.key.pub </span></span><br><span class="line">-----BEGIN PUBLIC KEY-----</span><br><span class="line">MIGfMA0GCSqGSIb3DQEBAQUAA4GNADCBiQKBgQCvkS+Z4NWAMoXEwNUyn58J0oI+</span><br><span class="line">ZjXotZUJLfbVHvGd3Ug6Rk52imHp1J629edUn0Cw7KoPfQLegmWsldG4v931HCdl</span><br><span class="line">ELT2vj+QE7KJhc1tGFomzCnX8Q41tRrVVbHPxQYvNmMRXRqIdqXGxFpR758EngxF</span><br><span class="line">zAGcnLTrDz/I2GocrQIDAQAB</span><br><span class="line">-----END PUBLIC KEY-----</span><br></pre></td></tr></table></figure>

<p>范例：利用加密的私钥提取公钥</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ~]<span class="comment">#openssl genrsa -out /data/app2.key -des3 2048</span></span><br><span class="line"></span><br><span class="line">[root@centos8 ~]<span class="comment">#openssl rsa -in /data/app2.key -pubout -out /data/app2.pubkey</span></span><br><span class="line">Enter pass phrase <span class="keyword">for</span> /data/app2.key:</span><br><span class="line">writing RSA key</span><br><span class="line"></span><br><span class="line">[root@centos8 ~]<span class="comment">#cat /data/app2.pubkey</span></span><br><span class="line">-----BEGIN PUBLIC KEY-----</span><br><span class="line">MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEA2VXLcmClBWiqL8u3f1vO</span><br><span class="line">mjCEV+9c6S0qDXNiZrCRiYUyIMKLhyXnVLw+k6uGmC4bdATFgxDU2zjdJF3bptS6</span><br><span class="line">dNZzMQJ5uAQOxQ1KHKm3O+s+Isg+H/LTHUDyc4szQZ3gjJCTKculS60qsWV7lcGP</span><br><span class="line">PNSzXr3/F/TlLMRxv/9GrEjYXDgCAJt2lxWgvgXqX8Y1mc1FFkBRXVZr/CnXaij5</span><br><span class="line">JIA89/OHIJoX+mQIuQEjmwFMCX/6cm64iks2obgmzluvm6fM6dkvlHDGpZicNZI1</span><br><span class="line">5vaQcO7sJ4YTUGwJrDShC9R++vrAvfahvTDV3n/MLmfwS+8nhUA0Dr7M7I0GOYMp</span><br><span class="line">EQIDAQAB</span><br><span class="line">-----END PUBLIC KEY-----</span><br></pre></td></tr></table></figure>

<p>范例：生成加密的私钥，并解密</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ~]<span class="comment">#openssl genrsa -out /data/app.key -des3 1024 </span></span><br><span class="line">Generating RSA private key, 1024 bit long modulus (2 primes)</span><br><span class="line">......+++++</span><br><span class="line">...........+++++</span><br><span class="line">e is 65537 (0x010001)</span><br><span class="line">Enter pass phrase <span class="keyword">for</span> /data/app.key:</span><br><span class="line">Verifying - Enter pass phrase <span class="keyword">for</span> /data/app.key:</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@centos8 ~]<span class="comment">#ls -l /data</span></span><br><span class="line">total 4</span><br><span class="line">-rw------- 1 root root 963 Feb  3 15:27 app.key</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@centos8 ~]<span class="comment">#cat /data/app.key </span></span><br><span class="line">-----BEGIN RSA PRIVATE KEY-----</span><br><span class="line">Proc-Type: 4,ENCRYPTED</span><br><span class="line">DEK-Info: DES-EDE3-CBC,577C3B861BAD86B6</span><br><span class="line">VM8P7vx1UUcSJyXCB0pDO9xgmdNgsMOcl6NitdUvBA9Jx2oLyxsT6TYbbvZvlF55</span><br><span class="line">aQB0bq43atECDBz2+v1ghacPp78S2wuGuTR1hdWwfFKJNr6d/5yXO4y1ZOt3RLvR</span><br><span class="line">E4K6TCeSwZTIUNeQyuh+vstarQmaLQmdObb3lsMG+WipQj3hb0oGdZcWjuQ0gi1B</span><br><span class="line">RKN1duhsWFQbdXZamBqWQqCbvigmqRwjk7S6GE3YwVhys1T4N0BFX/edNCMnzb79</span><br><span class="line">6/mR+LJ2Wz/ecJXB5250rVby3h88ZNsgARg7jUM9zI6jf7G4t1etRlCJ8A9TvDe8</span><br><span class="line">J/5lkDUSWEh1dnB+xw5uamDY7f3GanuKTEe54DxuBwmbBpphV1QTTefSJ01Q6l9K</span><br><span class="line">wS0zV6WE+vCt99dE9J8+GXGD77twRcbmjDWfaoibvwMu00crB9K5dbxdSX50jlD9</span><br><span class="line">Mj+bVr9tcwQW/WzA+V05Ndb74e8OE97pEFjTX8DeIxcZomDUcpNGpQ0eWvyE+A2x</span><br><span class="line">Srux9nN8z9dUF963V4NjQGUg1owQPAlfO6zBGObXnynOqKDmBj+8FfWrnHnZUVt5</span><br><span class="line">3HTV+uSkLuA+8lGoNoxH4/6ZLfvY0Y5+WSg3st2EvwGT74SNNrsNYD0qGt1LujQx</span><br><span class="line">IiwfCI0uv8rqgtLtsYmJmYI0t7hWUVmb6QgX1Qh0Kvzc0A34IMDjY6dhXTKnxeF3</span><br><span class="line">LGkrFAgl3+6tKXxMuQDLB6Jy9m3SOwW/JoXMVVcYHrSPzTgAl2sgAkgEq8nf4yfm</span><br><span class="line">ZP9WHrDe10yXY+5K2h8UiFhvrnQ+YnH4BcTrKuEa9T7pxToo0cTdqg==</span><br><span class="line">-----END RSA PRIVATE KEY-----</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@centos8 ~]<span class="comment">#openssl rsa -in /data/app.key -out /data/app.key</span></span><br><span class="line">Enter pass phrase <span class="keyword">for</span> /data/app.key:</span><br><span class="line">writing RSA key</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@centos8 ~]<span class="comment">#ls -l /data</span></span><br><span class="line">total 4</span><br><span class="line">-rw------- 1 root root 887 Feb  3 15:28 app.key</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@centos8 ~]<span class="comment">#cat /data/app.key </span></span><br><span class="line">-----BEGIN RSA PRIVATE KEY-----</span><br><span class="line">MIICXQIBAAKBgQCvkS+Z4NWAMoXEwNUyn58J0oI+ZjXotZUJLfbVHvGd3Ug6Rk52</span><br><span class="line">imHp1J629edUn0Cw7KoPfQLegmWsldG4v931HCdlELT2vj+QE7KJhc1tGFomzCnX</span><br><span class="line">8Q41tRrVVbHPxQYvNmMRXRqIdqXGxFpR758EngxFzAGcnLTrDz/I2GocrQIDAQAB</span><br><span class="line">AoGAQ/uDJCGkanSlya8lnumiKqqB1mm7nDWb1ScgOhw2UPubeT06Krqg+WtkXdJQ</span><br><span class="line">VjsoUJoDq+WrU7/IYRDOWayp5Be3EXCdyldSrWu1+wqJ1Vnpk2oUAEyr+lzcHhW1</span><br><span class="line">FNQ/5rb8kIUjR7DZpwnsYJxDygnaKaNKiUiF2FsMX8JcS8ECQQDoZt3zSsXYeR4t</span><br><span class="line">Y9kPPA19npQXx9K4Wv2wsCR904pznzoaJ9Kj+6E/3AdxtXcTD0GiZe8vW+H6WCmW</span><br><span class="line">gB1NpGiRAkEAwWTwO9ZncQnA+X2PYTkizBp/JdEdRjcL/D2g+g3rpL2nLChI56C5</span><br><span class="line">zA4NsJFmblE2uY1OLIJBGExiZP/XS74gXQJBAISTOgYyH48P+OEX1plUPrXsorq2</span><br><span class="line">KUU10wbaVNbauF6g9Lo7AXS+dQxC7pQ1Wsoqp9yGnd28Yrs3U/Ig/5ZtNaECQG+/</span><br><span class="line">kKUy3bDOjwhbCjeGmVnQ0bmbXMwO0MkfH15+HrShtfBpEr9s+w8y66wkSEjkere7</span><br><span class="line">M/m6Bj0xHgX4Y4JryS0CQQChBua8JXCCUGLle7+IEEcgQZSF4PdLrmnhrRG7Qrrg</span><br><span class="line">yd6pPuvd2jAGv5fMhjROmf9MWc4DFiRK0B6dz7OyF9j/</span><br><span class="line">-----END RSA PRIVATE KEY-----</span><br></pre></td></tr></table></figure>

<h2 id="建立私有CA实现证书申请颁发"><a href="#建立私有CA实现证书申请颁发" class="headerlink" title="建立私有CA实现证书申请颁发"></a>建立私有CA实现证书申请颁发</h2><p>建立私有CA：</p>
<ul>
<li>OpenCA：OpenCA开源组织使用Perl对OpenSSL进行二次开发而成的一套完善的PKI免费软件</li>
<li>openssl：相关包 openssl和openssl-libs  </li>
</ul>
<p>证书申请及签署步骤：</p>
<p>​     1、生成证书申请请求 </p>
<p>​     2、RA核验 </p>
<p>​     3、CA签署 </p>
<p>​     4、获取证书 </p>
<p>范例：openssl-libs 包</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ~]<span class="comment"># rpm -ql openssl-libs</span></span><br><span class="line">/etc/pki/tls</span><br><span class="line">/etc/pki/tls/certs</span><br><span class="line">/etc/pki/tls/ct_log_list.cnf</span><br><span class="line">/etc/pki/tls/misc</span><br><span class="line">/etc/pki/tls/openssl.cnf</span><br><span class="line">/etc/pki/tls/private</span><br><span class="line">/usr/lib/.build-id</span><br><span class="line">/usr/lib/.build-id/27</span><br><span class="line">/usr/lib/.build-id/27/e3d5f8d63820f2fef5de2026878156fceceddb</span><br></pre></td></tr></table></figure>

<p>openssl的配置文件：</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/etc/pki/tls/openssl.cnf</span><br></pre></td></tr></table></figure>

<p>三种策略：match匹配、optional可选、supplied提供</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">match：要求申请填写的信息跟CA设置信息必须一致</span><br><span class="line">optional：可有可无，跟CA设置信息可不一致</span><br><span class="line">supplied：必须填写这项申请信息</span><br></pre></td></tr></table></figure>

<p>范例：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ~]<span class="comment">#cat /etc/pki/tls/openssl.cnf </span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line">......</span><br><span class="line"><span class="comment">####################################################################</span></span><br><span class="line">[ ca ]</span><br><span class="line">default_ca = CA_default <span class="comment"># The default ca section</span></span><br><span class="line"></span><br><span class="line"><span class="comment">####################################################################</span></span><br><span class="line">[ CA_default ]</span><br><span class="line"></span><br><span class="line"><span class="built_in">dir</span> = /etc/pki/CA <span class="comment"># Where everything is kept</span></span><br><span class="line">certs = <span class="variable">$dir</span>/certs <span class="comment"># Where the issued certs are kept</span></span><br><span class="line">crl_dir = <span class="variable">$dir</span>/crl <span class="comment"># Where the issued crl are kept</span></span><br><span class="line">database = <span class="variable">$dir</span>/index.txt <span class="comment"># database index file.</span></span><br><span class="line"><span class="comment">#unique_subject = no # Set to &#x27;no&#x27; to allow creation of</span></span><br><span class="line"> <span class="comment"># several certs with same subject.</span></span><br><span class="line">new_certs_dir = <span class="variable">$dir</span>/newcerts <span class="comment"># default place for new certs.</span></span><br><span class="line"></span><br><span class="line">certificate = <span class="variable">$dir</span>/cacert.pem <span class="comment"># The CA certificate</span></span><br><span class="line">serial = <span class="variable">$dir</span>/serial <span class="comment"># The current serial number</span></span><br><span class="line">crlnumber = <span class="variable">$dir</span>/crlnumber <span class="comment"># the current crl number</span></span><br><span class="line"> <span class="comment"># must be commented out to leave a V1 CRL</span></span><br><span class="line"> </span><br><span class="line">crl = <span class="variable">$dir</span>/crl.pem <span class="comment"># The current CRL</span></span><br><span class="line">private_key = <span class="variable">$dir</span>/private/cakey.pem<span class="comment"># The private key</span></span><br><span class="line">RANDFILE = <span class="variable">$dir</span>/private/.rand <span class="comment"># private random number file</span></span><br><span class="line">x509_extensions = usr_cert <span class="comment"># The extensions to add to the cert</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Comment out the following two lines for the &quot;traditional&quot;</span></span><br><span class="line"><span class="comment"># (and highly broken) format.</span></span><br><span class="line">name_opt = ca_default <span class="comment"># Subject Name options</span></span><br><span class="line">cert_opt = ca_default <span class="comment"># Certificate field options</span></span><br><span class="line"></span><br><span class="line">default_days = 365 <span class="comment"># how long to certify for</span></span><br><span class="line">default_crl_days= 30 <span class="comment"># how long before next CRL</span></span><br><span class="line">default_md = sha256 <span class="comment"># use SHA-256 by default</span></span><br><span class="line">preserve = no <span class="comment"># keep passed DN ordering</span></span><br><span class="line"></span><br><span class="line">policy = policy_match</span><br><span class="line"></span><br><span class="line"><span class="comment"># For the CA policy</span></span><br><span class="line">[ policy_match ]</span><br><span class="line">countryName = match</span><br><span class="line">stateOrProvinceName = match</span><br><span class="line">organizationName = match</span><br><span class="line">organizationalUnitName = optional</span><br><span class="line">commonName = supplied</span><br><span class="line">emailAddress = optional</span><br><span class="line"></span><br><span class="line"><span class="comment"># For the &#x27;anything&#x27; policy</span></span><br><span class="line"><span class="comment"># At this point in time, you must list all acceptable &#x27;object&#x27;</span></span><br><span class="line"><span class="comment"># types.</span></span><br><span class="line">[ policy_anything ]</span><br><span class="line">countryName = optional</span><br><span class="line">stateOrProvinceName = optional</span><br><span class="line">localityName = optional</span><br><span class="line">organizationName = optional</span><br><span class="line">organizationalUnitName = optional</span><br><span class="line">commonName = supplied</span><br><span class="line">emailAddress = optional</span><br><span class="line">......</span><br></pre></td></tr></table></figure>

<h3 id="创建私有CA"><a href="#创建私有CA" class="headerlink" title="创建私有CA"></a>创建私有CA</h3><p>1、创建CA所需要的文件</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#生成证书索引数据库文件</span></span><br><span class="line"><span class="built_in">touch</span> /etc/pki/CA/index.txt</span><br><span class="line"></span><br><span class="line"><span class="comment">#指定第一个颁发证书的序列号</span></span><br><span class="line"><span class="built_in">echo</span> 01 &gt; /etc/pki/CA/serial </span><br></pre></td></tr></table></figure>

<p>2、 生成CA私钥</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /etc/pki/CA/</span><br><span class="line">(<span class="built_in">umask</span> 066; openssl genrsa -out private/cakey.pem 2048)</span><br></pre></td></tr></table></figure>

<p>3、生成CA自签名证书</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">openssl req -new -x509 -key /etc/pki/CA/private/cakey.pem -days 3650 -out /etc/pki/CA/cacert.pem</span><br></pre></td></tr></table></figure>

<p>选项说明：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">-new：   生成新证书签署请求</span><br><span class="line">-x509：  专用于CA生成自签证书</span><br><span class="line">-key：   生成请求时用到的私钥文件</span><br><span class="line">-days n：证书的有效期限</span><br><span class="line">-out /PATH/TO/SOMECERTFILE: 证书的保存路径</span><br></pre></td></tr></table></figure>

<p>国家代码：<a target="_blank" rel="noopener" href="https://country-code.cl/">https://country-code.cl/</a></p>
<p>范例：生成自签名证书</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ~]<span class="comment"># openssl req -utf8 -newkey rsa:1024 -subj &quot;/CN=www.magedu.org&quot; -keyout app.key -nodes -x509 -out app.crt</span></span><br><span class="line">Generating a RSA private key</span><br><span class="line">...........................+++++</span><br><span class="line">...+++++</span><br><span class="line">writing new private key to <span class="string">&#x27;app.key&#x27;</span></span><br><span class="line">-----</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@centos8 ~]<span class="comment">#openssl x509 -in app.crt -noout -text</span></span><br><span class="line">Certificate:</span><br><span class="line">   Data:</span><br><span class="line">       Version: 3 (0x2)</span><br><span class="line">       Serial Number:</span><br><span class="line">            39:9e:7c:e3:9a:0f:e3:d3:62:ea:8f:02:c9:<span class="built_in">cd</span>:1e:f3:4a:77:cb:ff</span><br><span class="line">       Signature Algorithm: sha256WithRSAEncryption</span><br><span class="line">       Issuer: CN = www.magedu.org</span><br><span class="line">       Validity</span><br><span class="line">           Not Before: Feb  4 15:51:39 2020 GMT</span><br><span class="line">           Not After : Mar  5 15:51:39 2020 GMT</span><br><span class="line">       Subject: CN = www.magedu.org</span><br><span class="line">       Subject Public Key Info:</span><br><span class="line">           Public Key Algorithm: rsaEncryption</span><br><span class="line">               RSA Public-Key: (1024 bit)</span><br><span class="line">               Modulus:</span><br><span class="line">                    00:e1:7e:41:d5:50:03:07:73:13:b2:62:a6:cf:c0:</span><br><span class="line">                    61:b1:25:1c:54:56:3e:8f:b3:aa:0e:97:49:50:de:</span><br><span class="line">                   de:ed:7f:2f:0f:fd:17:22:72:f5:36:19:29:65:ff:</span><br><span class="line">                   ad:ce:81:10:f3:23:8c:fb:af:32:7b:da:bc:3a:a5:</span><br><span class="line">                    62:1c:8d:e3:f8:1b:a8:1d:82:86:e0:bc:d6:e1:28:</span><br><span class="line">                   e0:37:33:16:6c:55:89:76:13:0e:50:37:65:39:da:</span><br><span class="line">                    90:99:a0:d3:6f:af:4e:8d:34:6c:21:e1:ba:10:86:</span><br><span class="line">                   8e:fd:fb:e2:83:fe:e7:8c:18:14:dc:f2:7d:6c:37:</span><br><span class="line">                   fe:4e:e0:8d:99:65:d4:f6:9f</span><br><span class="line">               Exponent: 65537 (0x10001)</span><br><span class="line">       X509v3 extensions:</span><br><span class="line">           X509v3 Subject Key Identifier: </span><br><span class="line">               1F:67:31:48:D6:DA:6E:36:C9:6B:EC:3C:61:85:6A:52:C2:B2:06:17</span><br><span class="line">           X509v3 Authority Key Identifier: </span><br><span class="line">               </span><br><span class="line">keyid:1F:67:31:48:D6:DA:6E:36:C9:6B:EC:3C:61:85:6A:52:C2:B2:06:17</span><br><span class="line">           X509v3 Basic Constraints: critical</span><br><span class="line">               CA:TRUE</span><br><span class="line">   Signature Algorithm: sha256WithRSAEncryption</span><br><span class="line">         4f:75:d5:f8:99:ea:dc:4f:fd:57:05:ba:1e:ad:72:23:ae:b8:</span><br><span class="line">         ea:93:1d:43:21:f8:66:cb:85:49:6c:b8:8f:1e:f4:a0:e5:ac:</span><br><span class="line">         e5:2e:45:03:33:2f:6a:4a:28:97:30:f0:18:<span class="built_in">dd</span>:c1:f7:46:0b:</span><br><span class="line">         3c:b0:b6:d6:bf:23:7d:3b:74:52:75:61:96:f9:b0:04:99:6c:</span><br><span class="line">         52:f4:5d:1c:76:33:52:48:4f:d4:1f:4e:5e:00:0c:18:75:c3:</span><br><span class="line">         ef:75:bc:c7:ea:37:6e:34:36:b2:a0:f6:6f:06:69:0a:c6:74:</span><br><span class="line">         d8:67:4c:16:81:2a:0b:ea:1c:16:ea:8e:48:<span class="built_in">dd</span>:ba:0b:67:69:</span><br><span class="line">         19:1e</span><br><span class="line">[root@centos8 ~]<span class="comment">#</span></span><br></pre></td></tr></table></figure>

<h3 id="申请证书并颁发证书"><a href="#申请证书并颁发证书" class="headerlink" title="申请证书并颁发证书"></a>申请证书并颁发证书</h3><p>1、为需要使用证书的主机生成生成私钥</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(<span class="built_in">umask</span> 066; openssl genrsa -out   /data/test.key 2048)</span><br></pre></td></tr></table></figure>

<p>2、为需要使用证书的主机生成证书申请文件</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">openssl req -new -key /data/test.key -out /data/test.csr</span><br></pre></td></tr></table></figure>

<p>3、在CA签署证书并将证书颁发给请求者</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">openssl ca -<span class="keyword">in</span> /data/test.csr  -out   /etc/pki/CA/certs/test.crt -days 100</span><br></pre></td></tr></table></figure>

<p>注意：默认要求 国家，省，公司名称三项必须和CA一致 </p>
<p>4、查看证书中的信息：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">openssl x509 -<span class="keyword">in</span> /PATH/FROM/CERT_FILE -noout   -text|issuer|subject|serial|dates</span><br><span class="line"></span><br><span class="line"><span class="comment">#查看指定编号的证书状态</span></span><br><span class="line">openssl ca -status SERIAL  </span><br></pre></td></tr></table></figure>

<h3 id="吊销证书"><a href="#吊销证书" class="headerlink" title="吊销证书"></a>吊销证书</h3><p>在客户端获取要吊销的证书的serial</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">openssl x509 -<span class="keyword">in</span> /PATH/FROM/CERT_FILE   -noout   -serial  -subject</span><br></pre></td></tr></table></figure>

<p>在CA上，根据客户提交的serial与subject信息，对比检验是否与index.txt文件中的信息一致，吊销证书：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">openssl ca -revoke /etc/pki/CA/newcerts/SERIAL.pem</span><br></pre></td></tr></table></figure>

<p>指定第一个吊销证书的编号,注意：第一次更新证书吊销列表前，才需要执行</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> 01 &gt; /etc/pki/CA/crlnumber</span><br></pre></td></tr></table></figure>

<p>更新证书吊销列表</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">openssl ca -gencrl -out /etc/pki/CA/crl.pem</span><br></pre></td></tr></table></figure>

<p>查看crl文件：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">openssl crl -<span class="keyword">in</span> /etc/pki/CA/crl.pem -noout -text</span><br></pre></td></tr></table></figure>

<h3 id="CentOS-7-创建自签名证书"><a href="#CentOS-7-创建自签名证书" class="headerlink" title="CentOS 7 创建自签名证书"></a>CentOS 7 创建自签名证书</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br></pre></td><td class="code"><pre><span class="line">[root@centos7 ~]<span class="comment">#cd /etc/pki/tls/certs</span></span><br><span class="line">[root@centos7 certs]<span class="comment"># make</span></span><br><span class="line">This makefile allows you to create:</span><br><span class="line">  o public/private key pairs</span><br><span class="line">  o SSL certificate signing requests (CSRs)</span><br><span class="line">  o self-signed SSL <span class="built_in">test</span> certificates</span><br><span class="line"></span><br><span class="line">To create a key pair, run <span class="string">&quot;make SOMETHING.key&quot;</span>.</span><br><span class="line">To create a CSR, run <span class="string">&quot;make SOMETHING.csr&quot;</span>.</span><br><span class="line">To create a <span class="built_in">test</span> certificate, run <span class="string">&quot;make SOMETHING.crt&quot;</span>.</span><br><span class="line">To create a key and a <span class="built_in">test</span> certificate <span class="keyword">in</span> one file, run <span class="string">&quot;make SOMETHING.pem&quot;</span>.</span><br><span class="line"></span><br><span class="line">To create a key <span class="keyword">for</span> use with Apache, run <span class="string">&quot;make genkey&quot;</span>.</span><br><span class="line">To create a CSR <span class="keyword">for</span> use with Apache, run <span class="string">&quot;make certreq&quot;</span>.</span><br><span class="line">To create a <span class="built_in">test</span> certificate <span class="keyword">for</span> use with Apache, run <span class="string">&quot;make testcert&quot;</span>.</span><br><span class="line"></span><br><span class="line">To create a <span class="built_in">test</span> certificate with serial number other than random, add </span><br><span class="line">SERIAL=num</span><br><span class="line">You can also specify key length with KEYLEN=n and expiration <span class="keyword">in</span> days with DAYS=n</span><br><span class="line">Any additional options can be passed to openssl req via EXTRA_FLAGS</span><br><span class="line"></span><br><span class="line">Examples:</span><br><span class="line">  make server.key</span><br><span class="line">  make server.csr</span><br><span class="line">  make server.crt</span><br><span class="line">  make stunnel.pem</span><br><span class="line">  make genkey</span><br><span class="line">  make certreq</span><br><span class="line">  make testcert</span><br><span class="line">  make server.crt SERIAL=1</span><br><span class="line">  make stunnel.pem EXTRA_FLAGS=-sha384</span><br><span class="line">  make testcert DAYS=600</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@centos7 certs]<span class="comment"># ls</span></span><br><span class="line">ca-bundle.crt ca-bundle.trust.crt make-dummy-cert Makefile renew-dummy-cert</span><br><span class="line"></span><br><span class="line">[root@centos7 certs]<span class="comment"># cat Makefile </span></span><br><span class="line">UTF8 := $(shell locale -c LC_CTYPE -k | grep -q charmap.*UTF-8 &amp;&amp; <span class="built_in">echo</span> -utf8)</span><br><span class="line">DAYS=365</span><br><span class="line">KEYLEN=2048</span><br><span class="line">TYPE=rsa:$(KEYLEN)</span><br><span class="line">EXTRA_FLAGS=</span><br><span class="line">ifdef SERIAL</span><br><span class="line">    EXTRA_FLAGS+=-set_serial $(SERIAL)</span><br><span class="line">endif</span><br><span class="line"></span><br><span class="line">.PHONY: usage</span><br><span class="line">.SUFFIXES: .key .csr .crt .pem</span><br><span class="line">.PRECIOUS: %.key %.csr %.crt %.pem</span><br><span class="line"></span><br><span class="line">usage:</span><br><span class="line">    @<span class="built_in">echo</span> <span class="string">&quot;This makefile allows you to create:&quot;</span></span><br><span class="line">    @<span class="built_in">echo</span> <span class="string">&quot; o public/private key pairs&quot;</span></span><br><span class="line">    @<span class="built_in">echo</span> <span class="string">&quot; o SSL certificate signing requests (CSRs)&quot;</span></span><br><span class="line">    @<span class="built_in">echo</span> <span class="string">&quot; o self-signed SSL test certificates&quot;</span></span><br><span class="line">    @<span class="built_in">echo</span></span><br><span class="line">    @<span class="built_in">echo</span> <span class="string">&quot;To create a key pair, run \&quot;make SOMETHING.key\&quot;.&quot;</span></span><br><span class="line">    @<span class="built_in">echo</span> <span class="string">&quot;To create a CSR, run \&quot;make SOMETHING.csr\&quot;.&quot;</span></span><br><span class="line">    @<span class="built_in">echo</span> <span class="string">&quot;To create a test certificate, run \&quot;make SOMETHING.crt\&quot;.&quot;</span></span><br><span class="line">    @<span class="built_in">echo</span> <span class="string">&quot;To create a key and a test certificate in one file, run \&quot;make SOMETHING.pem\&quot;.&quot;</span></span><br><span class="line">    @<span class="built_in">echo</span></span><br><span class="line">    @<span class="built_in">echo</span> <span class="string">&quot;To create a key for use with Apache, run \&quot;make genkey\&quot;.&quot;</span></span><br><span class="line">    @<span class="built_in">echo</span> <span class="string">&quot;To create a CSR for use with Apache, run \&quot;make certreq\&quot;.&quot;</span></span><br><span class="line">    @<span class="built_in">echo</span> <span class="string">&quot;To create a test certificate for use with Apache, run \&quot;make testcert\&quot;.&quot;</span></span><br><span class="line">    @<span class="built_in">echo</span></span><br><span class="line">    @<span class="built_in">echo</span> <span class="string">&quot;To create a test certificate with serial number other than random, add SERIAL=num&quot;</span></span><br><span class="line">    @<span class="built_in">echo</span> <span class="string">&quot;You can also specify key length with KEYLEN=n and expiration in days with DAYS=n&quot;</span></span><br><span class="line">    @<span class="built_in">echo</span> <span class="string">&quot;Any additional options can be passed to openssl req via EXTRA_FLAGS&quot;</span></span><br><span class="line">    @<span class="built_in">echo</span></span><br><span class="line">    @<span class="built_in">echo</span> Examples:</span><br><span class="line">    @<span class="built_in">echo</span> <span class="string">&quot; make server.key&quot;</span></span><br><span class="line">    @<span class="built_in">echo</span> <span class="string">&quot; make server.csr&quot;</span></span><br><span class="line">    @<span class="built_in">echo</span> <span class="string">&quot; make server.crt&quot;</span></span><br><span class="line">    @<span class="built_in">echo</span> <span class="string">&quot; make stunnel.pem&quot;</span></span><br><span class="line">    @<span class="built_in">echo</span> <span class="string">&quot; make genkey&quot;</span></span><br><span class="line">    @<span class="built_in">echo</span> <span class="string">&quot; make certreq&quot;</span></span><br><span class="line">    @<span class="built_in">echo</span> <span class="string">&quot; make testcert&quot;</span></span><br><span class="line">    @<span class="built_in">echo</span> <span class="string">&quot; make server.crt SERIAL=1&quot;</span></span><br><span class="line">    @<span class="built_in">echo</span> <span class="string">&quot; make stunnel.pem EXTRA_FLAGS=-sha384&quot;</span></span><br><span class="line">    @<span class="built_in">echo</span> <span class="string">&quot; make testcert DAYS=600&quot;</span></span><br><span class="line"></span><br><span class="line">%.pem:</span><br><span class="line">    <span class="built_in">umask</span> 77 ; \</span><br><span class="line">    PEM1=`/bin/mktemp /tmp/openssl.XXXXXX` ; \</span><br><span class="line">    PEM2=`/bin/mktemp /tmp/openssl.XXXXXX` ; \</span><br><span class="line">    /usr/bin/openssl req $(UTF8) -newkey $(TYPE) -keyout $<span class="variable">$PEM1</span> -nodes -x509 -days $(DAYS) -out $<span class="variable">$PEM2</span> $(EXTRA_FLAGS) ; \</span><br><span class="line">    <span class="built_in">cat</span> $<span class="variable">$PEM1</span> &gt;  <span class="variable">$@</span> ; \</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;&quot;</span>   &gt;&gt; <span class="variable">$@</span> ; \</span><br><span class="line">    <span class="built_in">cat</span> $<span class="variable">$PEM2</span> &gt;&gt; <span class="variable">$@</span> ; \</span><br><span class="line">    $(RM) $<span class="variable">$PEM1</span> $<span class="variable">$PEM2</span></span><br><span class="line"></span><br><span class="line">%.key:</span><br><span class="line">    <span class="built_in">umask</span> 77 ; \</span><br><span class="line">    /usr/bin/openssl genrsa -aes128 $(KEYLEN) &gt; <span class="variable">$@</span></span><br><span class="line"></span><br><span class="line">%.csr: %.key</span><br><span class="line">    <span class="built_in">umask</span> 77 ; \</span><br><span class="line">    /usr/bin/openssl req $(UTF8) -new -key $^ -out <span class="variable">$@</span></span><br><span class="line"></span><br><span class="line">%.crt: %.key</span><br><span class="line">    <span class="built_in">umask</span> 77 ; \</span><br><span class="line">    /usr/bin/openssl req $(UTF8) -new -key $^ -x509 -days $(DAYS) -out <span class="variable">$@</span> $(EXTRA_FLAGS)</span><br><span class="line"></span><br><span class="line">TLSROOT=/etc/pki/tls</span><br><span class="line">KEY=$(TLSROOT)/private/localhost.key</span><br><span class="line">CSR=$(TLSROOT)/certs/localhost.csr</span><br><span class="line">CRT=$(TLSROOT)/certs/localhost.crt</span><br><span class="line"> </span><br><span class="line">genkey: $(KEY)</span><br><span class="line">certreq: $(CSR)</span><br><span class="line">testcert: $(CRT)</span><br><span class="line"></span><br><span class="line">$(CSR): $(KEY)</span><br><span class="line">    <span class="built_in">umask</span> 77 ; \</span><br><span class="line">    /usr/bin/openssl req $(UTF8) -new -key $(KEY) -out $(CSR)</span><br><span class="line"></span><br><span class="line">$(CRT): $(KEY)</span><br><span class="line">    <span class="built_in">umask</span> 77 ; \</span><br><span class="line">    /usr/bin/openssl req $(UTF8) -new -key $(KEY) -x509 -days $(DAYS) -out $(CRT) $(EXTRA_FLAGS)</span><br><span class="line"></span><br><span class="line">[root@centos7 certs]<span class="comment"># make app.crt</span></span><br><span class="line"><span class="built_in">umask</span> 77 ; \</span><br><span class="line">/usr/bin/openssl genrsa -aes128 2048 &gt; app.key</span><br><span class="line">Generating RSA private key, 2048 bit long modulus</span><br><span class="line">...............+++</span><br><span class="line">............................................+++</span><br><span class="line">e is 65537 (0x10001)</span><br><span class="line">Enter pass phrase:</span><br><span class="line">Verifying - Enter pass phrase:</span><br><span class="line"><span class="built_in">umask</span> 77 ; \</span><br><span class="line">/usr/bin/openssl req -utf8 -new -key app.key -x509 -days 365 -out app.crt </span><br><span class="line">Enter pass phrase <span class="keyword">for</span> app.key:</span><br><span class="line">You are about to be asked to enter information that will be incorporated</span><br><span class="line">into your certificate request.</span><br><span class="line">What you are about to enter is what is called a Distinguished Name or a DN.</span><br><span class="line">There are quite a few fields but you can leave some blank</span><br><span class="line">For some fields there will be a default value,</span><br><span class="line">If you enter <span class="string">&#x27;.&#x27;</span>, the field will be left blank.</span><br><span class="line">-----</span><br><span class="line">Country Name (2 letter code) [XX]:CN</span><br><span class="line">State or Province Name (full name) []:hubei</span><br><span class="line">Locality Name (eg, city) [Default City]:wuhan</span><br><span class="line">Organization Name (eg, company) [Default Company Ltd]:magedu</span><br><span class="line">Organizational Unit Name (eg, section) []:it</span><br><span class="line">Common Name (eg, your name or your server<span class="string">&#x27;s hostname) []:www.magedu.org</span></span><br><span class="line"><span class="string">Email Address []:admin@magedu.org</span></span><br><span class="line"><span class="string">[root@centos7 certs]#ls</span></span><br><span class="line"><span class="string">app.crt app.key ca-bundle.crt ca-bundle.trust.crt make-dummy-cert Makefile </span></span><br><span class="line"><span class="string">renew-dummy-cert</span></span><br><span class="line"><span class="string">[root@centos7 certs]#openssl x509 -in app.crt -noout -text</span></span><br><span class="line"><span class="string">Certificate:</span></span><br><span class="line"><span class="string">   Data:</span></span><br><span class="line"><span class="string">       Version: 3 (0x2)</span></span><br><span class="line"><span class="string">       Serial Number:</span></span><br><span class="line"><span class="string">            90:d7:97:6a:21:21:f8:5e</span></span><br><span class="line"><span class="string">   Signature Algorithm: sha256WithRSAEncryption</span></span><br><span class="line"><span class="string">       Issuer: C=CN, ST=hubei, L=wuhan, O=magedu, OU=it, </span></span><br><span class="line"><span class="string">CN=www.magedu.org/emailAddress=admin@magedu.org</span></span><br><span class="line"><span class="string">       Validity</span></span><br><span class="line"><span class="string">           Not Before: Feb  5 00:28:31 2020 GMT</span></span><br><span class="line"><span class="string">           Not After : Feb  4 00:28:31 2021 GMT</span></span><br><span class="line"><span class="string">       Subject: C=CN, ST=hubei, L=wuhan, O=magedu, OU=it, </span></span><br><span class="line"><span class="string">CN=www.magedu.org/emailAddress=admin@magedu.org</span></span><br><span class="line"><span class="string">       Subject Public Key Info:</span></span><br><span class="line"><span class="string">           Public Key Algorithm: rsaEncryption</span></span><br><span class="line"><span class="string">               Public-Key: (2048 bit)</span></span><br><span class="line"><span class="string">               Modulus:</span></span><br><span class="line"><span class="string">                    00:f8:dd:d3:ea:0b:f1:97:0f:27:de:44:a2:32:77:</span></span><br><span class="line"><span class="string">                   fb:5c:73:74:17:7b:5f:a4:9c:a2:d4:3b:d4:49:4c:</span></span><br><span class="line"><span class="string">                   da:e0:a2:6a:41:05:6e:10:1e:96:dc:95:34:ed:08:</span></span><br><span class="line"><span class="string">                    05:18:ba:27:c5:e5:f0:7c:65:15:78:f8:9b:bf:ee:</span></span><br><span class="line"><span class="string">                    41:ef:1c:6f:7f:35:29:fd:f5:cf:4a:f1:36:7e:0c:</span></span><br><span class="line"><span class="string">                    37:96:b1:01:e5:aa:7f:6e:a0:56:b0:33:28:ed:db:</span></span><br><span class="line"><span class="string">                   7a:56:34:67:83:be:bd:ad:3d:e7:80:d9:cf:6a:c7:</span></span><br><span class="line"><span class="string">                   c9:7f:d1:83:73:33:7f:77:27:a5:2e:17:84:82:c7:</span></span><br><span class="line"><span class="string">                    50:3d:20:d8:20:f1:5e:61:d2:69:07:8f:0e:cd:ea:</span></span><br><span class="line"><span class="string">                   c2:51:bd:aa:a0:ce:61:18:6f:00:43:13:21:8d:6d:</span></span><br><span class="line"><span class="string">                   3b:85:13:d8:93:ed:fc:65:28:ec:12:d1:67:40:d0:</span></span><br><span class="line"><span class="string">                    98:54:9a:59:1e:10:4f:c5:8c:b5:b1:26:55:2f:e1:</span></span><br><span class="line"><span class="string">                    53:1d:6b:71:88:64:e2:b1:21:28:8c:c7:04:3a:70:</span></span><br><span class="line"><span class="string">                    87:c7:48:41:44:95:43:2f:e8:da:5f:f8:93:1a:9a:</span></span><br><span class="line"><span class="string">                   de:e4:e3:82:57:60:6a:49:08:2e:5f:57:f7:62:b2:</span></span><br><span class="line"><span class="string">                   bb:8a:1f:8b:2b:dc:40:dd:35:30:42:c1:f4:c6:1a:</span></span><br><span class="line"><span class="string">                   0b:61:df:37:ed:bd:25:39:4c:5f:27:32:57:9e:d0:</span></span><br><span class="line"><span class="string">                    11:9d</span></span><br><span class="line"><span class="string">               Exponent: 65537 (0x10001)</span></span><br><span class="line"><span class="string">       X509v3 extensions:</span></span><br><span class="line"><span class="string">           X509v3 Subject Key Identifier: </span></span><br><span class="line"><span class="string">                28:48:D7:B5:02:7E:D7:4B:A1:74:A7:86:4B:3C:E5:FC:39:7B:F4:2E</span></span><br><span class="line"><span class="string">           X509v3 Authority Key Identifier: </span></span><br><span class="line"><span class="string">               </span></span><br><span class="line"><span class="string">keyid:28:48:D7:B5:02:7E:D7:4B:A1:74:A7:86:4B:3C:E5:FC:39:7B:F4:2E</span></span><br><span class="line"><span class="string">           X509v3 Basic Constraints: </span></span><br><span class="line"><span class="string">               CA:TRUE</span></span><br><span class="line"><span class="string">   Signature Algorithm: sha256WithRSAEncryption</span></span><br><span class="line"><span class="string">         a3:66:1b:85:dc:9e:1b:c7:c8:e4:29:3c:32:b2:fc:71:c9:79:</span></span><br><span class="line"><span class="string">         9e:ad:db:78:bd:a4:42:1a:ef:d7:7f:4a:84:d9:46:e1:60:fa:</span></span><br><span class="line"><span class="string">         9f:04:83:67:88:74:fd:99:d2:e3:7b:34:86:27:a1:d0:3c:be:</span></span><br><span class="line"><span class="string">         5f:93:d0:17:e9:d1:f6:19:2b:d5:e7:48:1f:56:ac:65:22:ec:</span></span><br><span class="line"><span class="string">         64:6f:a3:05:0c:83:2f:29:a8:ef:cc:25:51:d0:16:21:93:9e:</span></span><br><span class="line"><span class="string">         85:fc:82:d4:8c:ba:14:47:6e:fd:33:44:71:a7:c4:7f:92:2a:</span></span><br><span class="line"><span class="string">         01:40:f9:69:70:73:27:89:73:82:ea:21:95:48:e2:c1:5d:b8:</span></span><br><span class="line"><span class="string">         ed:e7:61:49:88:1c:b6:8a:a6:bd:cc:83:6b:2c:19:b9:07:21:</span></span><br><span class="line"><span class="string">         46:f8:1f:dc:cb:3c:9c:6d:b9:b1:dc:03:b0:5a:00:de:41:7c:</span></span><br><span class="line"><span class="string">         96:d8:3a:f3:06:fc:24:03:60:54:35:85:a2:1e:79:fc:cb:6e:</span></span><br><span class="line"><span class="string">         fd:e2:c3:7b:16:6e:7c:56:17:d4:64:c9:15:e9:a4:b0:9a:a7:</span></span><br><span class="line"><span class="string">         c5:d6:f8:c8:e4:99:b1:b0:f0:8b:b4:ea:8e:a9:29:c1:4a:19:</span></span><br><span class="line"><span class="string">         69:7a:d7:51:93:23:51:b6:0b:63:e1:45:a7:3f:65:4d:89:55:</span></span><br><span class="line"><span class="string">         e8:52:29:0a:41:d2:fb:76:20:7e:14:da:a8:ad:e6:fc:b0:a9:</span></span><br><span class="line"><span class="string">         5f:10:b0:d3</span></span><br></pre></td></tr></table></figure>

<h3 id="实战案例：在CentOS8上实现私有CA和证书申请"><a href="#实战案例：在CentOS8上实现私有CA和证书申请" class="headerlink" title="实战案例：在CentOS8上实现私有CA和证书申请"></a>实战案例：在CentOS8上实现私有CA和证书申请</h3><h4 id="创建CA相关目录和文件"><a href="#创建CA相关目录和文件" class="headerlink" title="创建CA相关目录和文件"></a>创建CA相关目录和文件</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ~]<span class="comment">#mkdir -pv /etc/pki/CA/&#123;certs,crl,newcerts,private&#125;</span></span><br><span class="line"><span class="built_in">mkdir</span>: created directory <span class="string">&#x27;/etc/pki/CA&#x27;</span></span><br><span class="line"><span class="built_in">mkdir</span>: created directory <span class="string">&#x27;/etc/pki/CA/certs&#x27;</span></span><br><span class="line"><span class="built_in">mkdir</span>: created directory <span class="string">&#x27;/etc/pki/CA/crl&#x27;</span></span><br><span class="line"><span class="built_in">mkdir</span>: created directory <span class="string">&#x27;/etc/pki/CA/newcerts&#x27;</span></span><br><span class="line"><span class="built_in">mkdir</span>: created directory <span class="string">&#x27;/etc/pki/CA/private&#x27;</span></span><br><span class="line"></span><br><span class="line">[root@centos8 ~]<span class="comment">#tree /etc/pki/CA/</span></span><br><span class="line">/etc/pki/CA/</span><br><span class="line">├── certs</span><br><span class="line">├── crl</span><br><span class="line">├── newcerts</span><br><span class="line">└── private</span><br><span class="line">4 directories, 0 files</span><br><span class="line"></span><br><span class="line">[root@centos8 ~]<span class="comment">#touch /etc/pki/CA/index.txt</span></span><br><span class="line">[root@centos8 ~]<span class="comment">#echo 0F &gt; /etc/pki/CA/serial</span></span><br></pre></td></tr></table></figure>

<p>index.txt和serial文件在颁发证书时需要使用，如果不存在，会出现以下错误提示</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ~]<span class="comment">#openssl ca -in /data/app1/app1.csr -out  /etc/pki/CA/certs/app1.crt -days 1000</span></span><br><span class="line">Using configuration from /etc/pki/tls/openssl.cnf</span><br><span class="line">140040142845760:error:02001002:system library:fopen:No such file or </span><br><span class="line">directory:crypto/bio/bss_file.c:72:fopen(<span class="string">&#x27;/etc/pki/CA/index.txt&#x27;</span>,<span class="string">&#x27;r&#x27;</span>)</span><br><span class="line">140040142845760:error:2006D080:BIO routines:BIO_new_file:no such </span><br><span class="line">file:crypto/bio/bss_file.c:79:</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@centos8 ~]<span class="comment">#openssl ca -in /data/app1/app1.csr -out  /etc/pki/CA/certs/app1.crt -days 1000</span></span><br><span class="line">Using configuration from /etc/pki/tls/openssl.cnf</span><br><span class="line">/etc/pki/CA/serial: No such file or directory</span><br><span class="line">error <span class="keyword">while</span> loading serial number</span><br><span class="line">140240559408960:error:02001002:system library:fopen:No such file or </span><br><span class="line">directory:crypto/bio/bss_file.c:72:fopen(<span class="string">&#x27;/etc/pki/CA/serial&#x27;</span>,<span class="string">&#x27;r&#x27;</span>)</span><br><span class="line">140240559408960:error:2006D080:BIO routines:BIO_new_file:no such </span><br><span class="line">file:crypto/bio/bss_file.c:79:</span><br></pre></td></tr></table></figure>

<h4 id="创建CA的私钥"><a href="#创建CA的私钥" class="headerlink" title="创建CA的私钥"></a>创建CA的私钥</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ~]<span class="comment"># cd /etc/pki/CA/</span></span><br><span class="line">[root@centos8 CA]<span class="comment"># (umask 066; openssl genrsa -out private/cakey.pem 2048)</span></span><br><span class="line">Generating RSA private key, 2048 bit long modulus (2 primes)</span><br><span class="line">..........................................................................+++++</span><br><span class="line">.............................+++++</span><br><span class="line">e is 65537 (0x010001)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@centos8 CA]<span class="comment"># tree </span></span><br><span class="line">.</span><br><span class="line">├── certs</span><br><span class="line">├── crl</span><br><span class="line">├── newcerts</span><br><span class="line">└── private</span><br><span class="line">   └── cakey.pem</span><br><span class="line">4 directories, 1 file</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@centos8 CA]<span class="comment"># ll private/</span></span><br><span class="line">total 4</span><br><span class="line">-rw------- 1 root root 1679 May 20 11:55 cakey.pem</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@centos8 CA]<span class="comment"># cat private/cakey.pem </span></span><br><span class="line">-----BEGIN RSA PRIVATE KEY-----</span><br><span class="line">MIIEpQIBAAKCAQEAujCIyGTEHfRk1RBfoFacalTuyulhL05LK7fhZhcuDafdNOPz</span><br><span class="line">YLVKn2wPwmtaga5jZUOs2K6Bz1xGYFYjz092kbQhr8D290M4AvswYRr9dE0e6StP</span><br><span class="line">i/GeNT9HxiJlR38Q5Enw+rt+ek4i408R30VnwO2RDzRSQ5TaGOHBzOMrxsdKHuMc</span><br><span class="line">TSdekUH/jel3Xp9hngUB/+76BL8TL/uRbgU/fc0v4/V+tH17c1S+XF28YEt1t6Rp</span><br><span class="line">OOEVtFJQZtwDBRQYvaApnduHNDJD4sdCi99Hi5shdsexbt9IQHWQnrO3oVxMpbKL</span><br><span class="line">4UU1E/QphCfKBQe+uraxpmZ82deM8fRJbe/3/wIDAQABAoIBAGCFvrNcgcshopBO</span><br><span class="line">L7TYkbgSFcU9nbM/fHrKleAuDiLoLiY4MjilY20oQTdCHiZyeHbL0bR3KzaLmLRi</span><br><span class="line">k6fqgwZgAsKxX5ap00TAYcFFk7WSMX8hg9iBxsnF53iQ5j5dYi1nI7VoM9ZF4ZJD</span><br><span class="line">sHk16ua6geQG9MqyRSp3BtgnwM8IJ3y9U/a5srXKa3qlyD56EJMDP1noiKEsD6lz</span><br><span class="line">H15c+nSC+pk/NBRqRd2fPDiM4rF7Lj0MZ8ikW6e6igpZet8hYLAki4ChicFaCSve</span><br><span class="line">Z0r1IUU5b8k0lXtCcaeLD99kneP6vkES8RbPnlM4JXxWj4cSomvx31tgDyRCBiB1</span><br><span class="line">EsSLoKECgYEA95z/PHqjYu2En40xodmB9PN27UCdlzm58z8Y2+yD5cf16sU5adWy</span><br><span class="line">r9fxDo3eSi1UTW3nQTYjgzZXx0bsrnSi8106SOZ7oRl3LI6FvH3zheCUcrS3WSSx</span><br><span class="line">Mboxyvv7XrzTEJGPuTq8ZgG8TsBM+vDIo+ZBPXEMVzsIaHJPTxADAlECgYEAwH7y</span><br><span class="line">Axm++nXhjFxNsKRYUTktjEuz1WMGYmU4JjHpNL9oMknb1NN41eaI41MglEbjidlQ</span><br><span class="line">A4avGlbPfX3aqQiyq9tA6+lzm3yS4XR2qpx6oe+LK20x5JGzzcwV8ub14g/hP6qq</span><br><span class="line">9pBgVm4mCV9kDx8Unnf81vWp4L+ddjQ5wQGU8U8CgYEAhGOMk+l+MgaMQkJbpw2E</span><br><span class="line">TlNd4rwJhjF3GndB81QhsVmYQk3wxIVdZGcwm3d+wmo6CKwaWON5WU5U4FcrdJso</span><br><span class="line">BLZz00ZoE1pqPYh2OLGe4pWQyUOWRDM6CjxjIwRXAfAzaUhqb77XvDJxXCm0/vZ+</span><br><span class="line">UCNr/k3TK1CEzlNP1BXbhgECgYEAg0ROHsUo0b0fQMsVA5cezsyx/dEF4kbz7Jdf</span><br><span class="line">sdQpVpoMIPby3PAUn7DkujhOqC6rLa6ufKkUsV5vggEX4lsXFFCgtf9toaNSukHk</span><br><span class="line">RjYM/m7OtZ9x/Y9KUNWSRiEvnaf8j6D/ksIjn+zfLVcKcbFdKy9hkOjXnnaslxXI</span><br><span class="line">KJC+k8sCgYEAuTFCw2XTAaVHUlbzibF275Fu1ctsBC/OQx+v+ay1O6vTQ8f8AjVO</span><br><span class="line">DccPsLQUW8w9Sxt8WHSs5l2jxrj5QyeUQI3NxIVN7n5vY1jJ3tSEnPW9yxlZebb4</span><br><span class="line">3FN2AINcDBOVHZSI9p71NQvpzr2D11iwWhCYeIkZtlvXBBQA9ewgAWQ=</span><br><span class="line">-----END RSA PRIVATE KEY-----</span><br></pre></td></tr></table></figure>

<h4 id="给CA颁发自签名证书"><a href="#给CA颁发自签名证书" class="headerlink" title="给CA颁发自签名证书"></a>给CA颁发自签名证书</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ~]<span class="comment">#openssl req -new -x509 -key /etc/pki/CA/private/cakey.pem -days </span></span><br><span class="line">3650 -out     /etc/pki/CA/cacert.pem</span><br><span class="line">You are about to be asked to enter information that will be incorporated</span><br><span class="line">into your certificate request.</span><br><span class="line">What you are about to enter is what is called a Distinguished Name or a DN.</span><br><span class="line">There are quite a few fields but you can leave some blank</span><br><span class="line">For some fields there will be a default value,</span><br><span class="line">If you enter <span class="string">&#x27;.&#x27;</span>, the field will be left blank.</span><br><span class="line">-----</span><br><span class="line">Country Name (2 letter code) [XX]:CN</span><br><span class="line">State or Province Name (full name) []:beijing</span><br><span class="line">Locality Name (eg, city) [Default City]:beijing</span><br><span class="line">Organization Name (eg, company) [Default Company Ltd]:magedu</span><br><span class="line">Organizational Unit Name (eg, section) []:devops</span><br><span class="line">Common Name (eg, your name or your server<span class="string">&#x27;s hostname) []:ca.magedu.org</span></span><br><span class="line"><span class="string">Email Address []:admin@magedu.org</span></span><br><span class="line"><span class="string">[root@centos8 ~]#tree /etc/pki/CA</span></span><br><span class="line"><span class="string">/etc/pki/CA</span></span><br><span class="line"><span class="string">├── cacert.pem</span></span><br><span class="line"><span class="string">├── certs</span></span><br><span class="line"><span class="string">├── crl</span></span><br><span class="line"><span class="string">├── newcerts</span></span><br><span class="line"><span class="string">└── private</span></span><br><span class="line"><span class="string">   └── cakey.pem</span></span><br><span class="line"><span class="string">4 directories, 2 files</span></span><br><span class="line"><span class="string">[root@centos8 ~]#cat /etc/pki/CA/cacert.pem</span></span><br><span class="line"><span class="string">-----BEGIN CERTIFICATE-----</span></span><br><span class="line"><span class="string">MIID+zCCAuOgAwIBAgIUOgPr416WnD8XXPst9HsDrXxCU+swDQYJKoZIhvcNAQEL</span></span><br><span class="line"><span class="string">BQAwgYwxCzAJBgNVBAYTAkNOMRAwDgYDVQQIDAdiZWlqaW5nMRAwDgYDVQQHDAdi</span></span><br><span class="line"><span class="string">ZWlqaW5nMQ8wDQYDVQQKDAZtYWdlZHUxDzANBgNVBAsMBmRldm9wczEWMBQGA1UE</span></span><br><span class="line"><span class="string">AwwNY2EubWFnZWR1Lm9yZzEfMB0GCSqGSIb3DQEJARYQYWRtaW5AbWFnZWR1Lm9y</span></span><br><span class="line"><span class="string">ZzAeFw0yMDA1MjAwNDAxNTFaFw0zMDA1MTgwNDAxNTFaMIGMMQswCQYDVQQGEwJD</span></span><br><span class="line"><span class="string">TjEQMA4GA1UECAwHYmVpamluZzEQMA4GA1UEBwwHYmVpamluZzEPMA0GA1UECgwG</span></span><br><span class="line"><span class="string">bWFnZWR1MQ8wDQYDVQQLDAZkZXZvcHMxFjAUBgNVBAMMDWNhLm1hZ2VkdS5vcmcx</span></span><br><span class="line"><span class="string">HzAdBgkqhkiG9w0BCQEWEGFkbWluQG1hZ2VkdS5vcmcwggEiMA0GCSqGSIb3DQEB</span></span><br><span class="line"><span class="string">AQUAA4IBDwAwggEKAoIBAQC6MIjIZMQd9GTVEF+gVpxqVO7K6WEvTksrt+FmFy4N</span></span><br><span class="line"><span class="string">p9004/NgtUqfbA/Ca1qBrmNlQ6zYroHPXEZgViPPT3aRtCGvwPb3QzgC+zBhGv10</span></span><br><span class="line"><span class="string">TR7pK0+L8Z41P0fGImVHfxDkSfD6u356TiLjTxHfRWfA7ZEPNFJDlNoY4cHM4yvG</span></span><br><span class="line"><span class="string">x0oe4xxNJ16RQf+N6Xden2GeBQH/7voEvxMv+5FuBT99zS/j9X60fXtzVL5cXbxg</span></span><br><span class="line"><span class="string">S3W3pGk44RW0UlBm3AMFFBi9oCmd24c0MkPix0KL30eLmyF2x7Fu30hAdZCes7eh</span></span><br><span class="line"><span class="string">XEylsovhRTUT9CmEJ8oFB766trGmZnzZ14zx9Elt7/f/AgMBAAGjUzBRMB0GA1Ud</span></span><br><span class="line"><span class="string">DgQWBBQS4XEOvZ59bJQCyfEuZrNeErP+XzAfBgNVHSMEGDAWgBQS4XEOvZ59bJQC</span></span><br><span class="line"><span class="string">yfEuZrNeErP+XzAPBgNVHRMBAf8EBTADAQH/MA0GCSqGSIb3DQEBCwUAA4IBAQBs</span></span><br><span class="line"><span class="string">mnrHuGBiM80FL3vKs3+WoSSvjLRftjweQGGijJ685O9mDFqz+OBcFtQtklRGtVQ3</span></span><br><span class="line"><span class="string">SPtadO2j70vGmmoZaiW9zXyOBlQc8CzTxL9BJcykJHWDihYYWeixorfKjzkJ9C4y</span></span><br><span class="line"><span class="string">poG/bIIj+JN3bD76BzQomYeUMzKv20cB7UvFYbg+Y01RuV62+BAM4qZP6W1ROi3e</span></span><br><span class="line"><span class="string">/ZrC5ODgwkcOVo56Fg6vLWeLwcPKN6+fGkWYXUsPMXhb43icQcUHZwKup0fKcLdT</span></span><br><span class="line"><span class="string">vx8uKwI8pfWfTK0Rie+igUSyIrvVGa6cvA6e2uBIk4SoAlNp+OElijY+3mE+jiqO</span></span><br><span class="line"><span class="string">6AWx/63jzwWKe2YvL8at</span></span><br><span class="line"><span class="string">-----END CERTIFICATE-----</span></span><br><span class="line"><span class="string">[root@centos8 ~]#openssl x509 -in /etc/pki/CA/cacert.pem -noout -text</span></span><br><span class="line"><span class="string">Certificate:</span></span><br><span class="line"><span class="string">   Data:</span></span><br><span class="line"><span class="string">       Version: 3 (0x2)</span></span><br><span class="line"><span class="string">       Serial Number:</span></span><br><span class="line"><span class="string">           3a:03:eb:e3:5e:96:9c:3f:17:5c:fb:2d:f4:7b:03:ad:7c:42:53:eb</span></span><br><span class="line"><span class="string">       Signature Algorithm: sha256WithRSAEncryption</span></span><br><span class="line"><span class="string">       Issuer: C = CN, ST = beijing, L = beijing, O = magedu, OU = devops, CN =</span></span><br><span class="line"><span class="string">ca.magedu.org, emailAddress = admin@magedu.org</span></span><br><span class="line"><span class="string">       Validity</span></span><br><span class="line"><span class="string">           Not Before: May 20 04:01:51 2020 GMT</span></span><br><span class="line"><span class="string">           Not After : May 18 04:01:51 2030 GMT</span></span><br><span class="line"><span class="string">       Subject: C = CN, ST = beijing, L = beijing, O = magedu, OU = devops, CN </span></span><br><span class="line"><span class="string">= ca.magedu.org, emailAddress = admin@magedu.org</span></span><br><span class="line"><span class="string">       Subject Public Key Info:</span></span><br><span class="line"><span class="string">           Public Key Algorithm: rsaEncryption</span></span><br><span class="line"><span class="string">               RSA Public-Key: (2048 bit)</span></span><br><span class="line"><span class="string">               Modulus:</span></span><br><span class="line"><span class="string">                    00:ba:30:88:c8:64:c4:1d:f4:64:d5:10:5f:a0:56:</span></span><br><span class="line"><span class="string">                   9c:6a:54:ee:ca:e9:61:2f:4e:4b:2b:b7:e1:66:17:</span></span><br><span class="line"><span class="string">                   2e:0d:a7:dd:34:e3:f3:60:b5:4a:9f:6c:0f:c2:6b:</span></span><br><span class="line"><span class="string">                   5a:81:ae:63:65:43:ac:d8:ae:81:cf:5c:46:60:56:</span></span><br><span class="line"><span class="string">                    23:cf:4f:76:91:b4:21:af:c0:f6:f7:43:38:02:fb:</span></span><br><span class="line"><span class="string">                    30:61:1a:fd:74:4d:1e:e9:2b:4f:8b:f1:9e:35:3f:</span></span><br><span class="line"><span class="string">                    47:c6:22:65:47:7f:10:e4:49:f0:fa:bb:7e:7a:4e:</span></span><br><span class="line"><span class="string">                    22:e3:4f:11:df:45:67:c0:ed:91:0f:34:52:43:94:</span></span><br><span class="line"><span class="string">                   da:18:e1:c1:cc:e3:2b:c6:c7:4a:1e:e3:1c:4d:27:</span></span><br><span class="line"><span class="string">                   5e:91:41:ff:8d:e9:77:5e:9f:61:9e:05:01:ff:ee:</span></span><br><span class="line"><span class="string">                   fa:04:bf:13:2f:fb:91:6e:05:3f:7d:cd:2f:e3:f5:</span></span><br><span class="line"><span class="string">                   7e:b4:7d:7b:73:54:be:5c:5d:bc:60:4b:75:b7:a4:</span></span><br><span class="line"><span class="string">                    69:38:e1:15:b4:52:50:66:dc:03:05:14:18:bd:a0:</span></span><br><span class="line"><span class="string">                    29:9d:db:87:34:32:43:e2:c7:42:8b:df:47:8b:9b:</span></span><br><span class="line"><span class="string">                    21:76:c7:b1:6e:df:48:40:75:90:9e:b3:b7:a1:5c:</span></span><br><span class="line"><span class="string">                   4c:a5:b2:8b:e1:45:35:13:f4:29:84:27:ca:05:07:</span></span><br><span class="line"><span class="string">                   be:ba:b6:b1:a6:66:7c:d9:d7:8c:f1:f4:49:6d:ef:</span></span><br><span class="line"><span class="string">                   f7:ff</span></span><br><span class="line"><span class="string">               Exponent: 65537 (0x10001)</span></span><br><span class="line"><span class="string">       X509v3 extensions:</span></span><br><span class="line"><span class="string">           X509v3 Subject Key Identifier: </span></span><br><span class="line"><span class="string">                12:E1:71:0E:BD:9E:7D:6C:94:02:C9:F1:2E:66:B3:5E:12:B3:FE:5F</span></span><br><span class="line"><span class="string">           X509v3 Authority Key Identifier: </span></span><br><span class="line"><span class="string">               </span></span><br><span class="line"><span class="string">keyid:12:E1:71:0E:BD:9E:7D:6C:94:02:C9:F1:2E:66:B3:5E:12:B3:FE:5F</span></span><br><span class="line"><span class="string">           X509v3 Basic Constraints: critical</span></span><br><span class="line"><span class="string">               CA:TRUE</span></span><br><span class="line"><span class="string">   Signature Algorithm: sha256WithRSAEncryption</span></span><br><span class="line"><span class="string">         6c:9a:7a:c7:b8:60:62:33:cd:05:2f:7b:ca:b3:7f:96:a1:24:</span></span><br><span class="line"><span class="string">         af:8c:b4:5f:b6:3c:1e:40:61:a2:8c:9e:bc:e4:ef:66:0c:5a:</span></span><br><span class="line"><span class="string">         b3:f8:e0:5c:16:d4:2d:92:54:46:b5:54:37:48:fb:5a:74:ed:</span></span><br><span class="line"><span class="string">         a3:ef:4b:c6:9a:6a:19:6a:25:bd:cd:7c:8e:06:54:1c:f0:2c:</span></span><br><span class="line"><span class="string">         d3:c4:bf:41:25:cc:a4:24:75:83:8a:16:18:59:e8:b1:a2:b7:</span></span><br><span class="line"><span class="string">         ca:8f:39:09:f4:2e:32:a6:81:bf:6c:82:23:f8:93:77:6c:3e:</span></span><br><span class="line"><span class="string">         fa:07:34:28:99:87:94:33:32:af:db:47:01:ed:4b:c5:61:b8:</span></span><br><span class="line"><span class="string">         3e:63:4d:51:b9:5e:b6:f8:10:0c:e2:a6:4f:e9:6d:51:3a:2d:</span></span><br><span class="line"><span class="string">         de:fd:9a:c2:e4:e0:e0:c2:47:0e:56:8e:7a:16:0e:af:2d:67:</span></span><br><span class="line"><span class="string">         8b:c1:c3:ca:37:af:9f:1a:45:98:5d:4b:0f:31:78:5b:e3:78:</span></span><br><span class="line"><span class="string">         9c:41:c5:07:67:02:ae:a7:47:ca:70:b7:53:bf:1f:2e:2b:02:</span></span><br><span class="line"><span class="string">         3c:a5:f5:9f:4c:ad:11:89:ef:a2:81:44:b2:22:bb:d5:19:ae:</span></span><br><span class="line"><span class="string">         9c:bc:0e:9e:da:e0:48:93:84:a8:02:53:69:f8:e1:25:8a:36:</span></span><br><span class="line"><span class="string">         3e:de:61:3e:8e:2a:8e:e8:05:b1:ff:ad:e3:cf:05:8a:7b:66:</span></span><br><span class="line"><span class="string">         2f:2f:c6:ad</span></span><br><span class="line"><span class="string">[root@centos8 ~]#sz /etc/pki/CA/cacert.pem </span></span><br><span class="line"><span class="string">#将文件cacert.pem传到windows上，修改文件名为cacert.pem.crt，双击可以看到下面显示</span></span><br></pre></td></tr></table></figure>

<p><img src="../../../../images/SRE/day15/22.png" alt="22"></p>
<p><img src="../../../../images/SRE/day15/23.png" alt="23"></p>
<p><img src="../../../../images/SRE/day15/24.png" alt="24"></p>
<h4 id="用户生成私钥和证书申请"><a href="#用户生成私钥和证书申请" class="headerlink" title="用户生成私钥和证书申请"></a>用户生成私钥和证书申请</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ~]<span class="comment"># mkdir /data/app1</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#生成私钥文件</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># (umask 066; openssl genrsa -out   /data/app1/app1.key 2048)</span></span><br><span class="line">Generating RSA private key, 2048 bit long modulus (2 primes)</span><br><span class="line">....................+++++</span><br><span class="line">....................................+++++</span><br><span class="line">e is 65537 (0x010001)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@centos8 ~]<span class="comment"># cat /data/app1/app1.key</span></span><br><span class="line">-----BEGIN RSA PRIVATE KEY-----</span><br><span class="line">MIIEpQIBAAKCAQEAuTpb5UtXhCa4jMN3gMv8a0uHmmTWMqYip4WULOnDYK2J7QCI</span><br><span class="line">EWIf7HPgZTvL1TiHVqMRaJHxwNH5IdEO6qzrqequI3pD+7M3iCtRowpD9y9Mennd</span><br><span class="line">YLzEgIepUboJtn4xG/LP9e89bC00StgDFJsEl19suaSUZCbwKR9QU/RiWOLZfqLm</span><br><span class="line">b5xEaUO37+eCio01wWi2TSxHu+CUVpyf915Ogg4jOoYGGLS80YknO6qe8HRwCJg6</span><br><span class="line">w0n3s9BkqFgeYsZBZb2J27rzhGpPvE6ECuxaRwqdvkcZlxZnibsBP1VeDi4Vno4q</span><br><span class="line">bQ+vjxTFLlTcDko8Xe6Nct+Q/Z3vQA+YNoH/XQIDAQABAoIBAQCK9s2a6TtvWd17</span><br><span class="line">PeqaJm/pz3Cc1KoetaWqKP1R9M8v6QJhXNS4tfVdYFIpoQL7pL1kslKNMXE+SEmw</span><br><span class="line">pTebuL/Vasvasg/u9jXjYxyMRVdYS5QFDwiXWwfRpfXR6tD+qQ4O+cwrpqFeV0u0</span><br><span class="line">Gvu0qdh3+I+Jd4Ac41mqgGOzmNVv+Piw/kTKv9iSNdcTOkhIRaHqI98xoYXAON9/</span><br><span class="line">22axpb+chtoUzqmfUwEDyA7pD0MZApbX0q8ikuHGWHl/I+5mXSWARIyxrMjwSVw2</span><br><span class="line">oM8TbwvTrKEq8UZ16GY42J8GfW7qo2T9EjdaSKirGT+4HsV4Dqs0zeYbu9xSwSXY</span><br><span class="line">GjFtXqYBAoGBAPJ9Y1ElMeH4qzahYV1/WbdEDrXtEXqsL2tZ1BGF2q2ZPG9D+e6z</span><br><span class="line">nNWb0Tv9tcijbK/9FvH2mlygHDXcJGhvfo6jD3+JQztjV95uycgNPfVEoaNF9wQc</span><br><span class="line">Xgf7Qg1ejbCY9Qh2b9SnbQUPQLUzJx+R9AjNCq/kP4qYOA9yHXDW5OXZAoGBAMOM</span><br><span class="line">QA2JtEKF2No7BfW2aAHdX54g9HEVB+IhtvHX1S3EtsK7GrhFCb1Ff9b+J0Hjs5yV</span><br><span class="line">6Qw1ZDDllQbwCXy/p0WkjdEO8LU6jUERjbOjYxbv9JMMKywEmRH98TSx5aPAmlrh</span><br><span class="line">BVH1SVisTcy+9MRykX+bQYczpPs9gedWUWgQI58lAoGBALk3gQbYDDP4Bn7h4UbT</span><br><span class="line">ISnUeBAJlhJHNqkeodcIkLGMnBa4q0ziMGcQb08NSS6JdVkvTblfjSQ2v5V8IusK</span><br><span class="line">TnaQoiPeKlZQWStzH/kH9E1FMNlPdY/UQxaBmkAv+rXq/y6JmH2rrJ/yuJAvFDEP</span><br><span class="line">AIFAbGtRQh+QiTFzDn3EBm5xAoGASqIbzE7zWrRlGJ2QX8B3n8aS+PJQ+Vvyf08o</span><br><span class="line">2NLsjSRYMKhiwVOwLOn6qd6ksxQp+CiLItq526O0Jkq1BETNndn5OoI+Qp0PTndZ</span><br><span class="line">oudIKXf526m4THuQxHosdlUzdTVMdEUP18ELdmmE5BE5sESd3Zsu/mAqpq1KCDY8</span><br><span class="line">qcAHKHUCgYEAmSZtkSQcu4P3QjNDAIUPWJIJbjrv/HopqJGkbYyu0RKbRuE+qX4S</span><br><span class="line">3fkbpJAzLDtyrD4/UOqYXx7mMwYxslqejNdFiEaIE7TvA7AGp82npakZA+p5Xqm4</span><br><span class="line">UXBg6HuyDrYOQ15j+uaMW/FaIlK1fViGn0LiOMNpqDAKlYpkzlbvCU0=</span><br><span class="line">-----END RSA PRIVATE KEY-----</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#生成证书申请文件</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># openssl req -new -key /data/app1/app1.key -out /data/app1/app1.csr</span></span><br><span class="line">You are about to be asked to enter information that will be incorporated</span><br><span class="line">into your certificate request.</span><br><span class="line">What you are about to enter is what is called a Distinguished Name or a DN.</span><br><span class="line">There are quite a few fields but you can leave some blank</span><br><span class="line">For some fields there will be a default value,</span><br><span class="line">If you enter <span class="string">&#x27;.&#x27;</span>, the field will be left blank.</span><br><span class="line">-----</span><br><span class="line">Country Name (2 letter code) [XX]:CN</span><br><span class="line">State or Province Name (full name) []:beijing</span><br><span class="line">Locality Name (eg, city) [Default City]:bj </span><br><span class="line">Organization Name (eg, company) [Default Company Ltd]:magedu</span><br><span class="line">Organizational Unit Name (eg, section) []:it</span><br><span class="line">Common Name (eg, your name or your server<span class="string">&#x27;s hostname) []:app1.magedu.org</span></span><br><span class="line"><span class="string">Email Address []:root@magedu.org</span></span><br><span class="line"><span class="string">Please enter the following &#x27;</span>extra<span class="string">&#x27; attributes</span></span><br><span class="line"><span class="string">to be sent with your certificate request</span></span><br><span class="line"><span class="string">A challenge password []:</span></span><br><span class="line"><span class="string">An optional company name []:</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">[root@centos8 ~]#ll /data/app1/</span></span><br><span class="line"><span class="string">total 8</span></span><br><span class="line"><span class="string">-rw-r--r-- 1 root root 1045 May 20 14:11 app1.csr</span></span><br><span class="line"><span class="string">-rw------- 1 root root 1679 May 20 14:06 app1.key</span></span><br></pre></td></tr></table></figure>

<p>默认有三项内容必须和CA一致：国家，省份，组织，如果不同，会出现下面的提示</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ~]<span class="comment"># openssl ca -in /data/app2/app2.csr -out  /etc/pki/CA/certs/app2.crt </span></span><br><span class="line">Using configuration from /etc/pki/tls/openssl.cnf</span><br><span class="line">Check that the request matches the signature</span><br><span class="line">Signature ok</span><br><span class="line">The stateOrProvinceName field is different between</span><br><span class="line">CA certificate (beijing) and the request (hubei)</span><br></pre></td></tr></table></figure>

<h4 id="CA颁发证书"><a href="#CA颁发证书" class="headerlink" title="CA颁发证书"></a>CA颁发证书</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ~]<span class="comment">#openssl ca -in /data/app1/app1.csr -out  /etc/pki/CA/certs/app1.crt -days 1000</span></span><br><span class="line">Using configuration from /etc/pki/tls/openssl.cnf</span><br><span class="line">Check that the request matches the signature</span><br><span class="line">Signature ok</span><br><span class="line">Certificate Details:</span><br><span class="line">       Serial Number: 15 (0xf)</span><br><span class="line">       Validity</span><br><span class="line">           Not Before: May 20 06:21:01 2020 GMT</span><br><span class="line">           Not After : Feb 14 06:21:01 2023 GMT</span><br><span class="line">       Subject:</span><br><span class="line">           countryName               = CN</span><br><span class="line">           stateOrProvinceName       = beijing</span><br><span class="line">           organizationName          = magedu</span><br><span class="line">           organizationalUnitName    = it</span><br><span class="line">           commonName                = app1.magedu.org</span><br><span class="line">           emailAddress              = root@magedu.org</span><br><span class="line">       X509v3 extensions:</span><br><span class="line">           X509v3 Basic Constraints: </span><br><span class="line">               CA:FALSE</span><br><span class="line">           Netscape Comment: </span><br><span class="line">               OpenSSL Generated Certificate</span><br><span class="line">           X509v3 Subject Key Identifier: </span><br><span class="line">               BC:C0:D3:08:AE:E3:2C:0C:DB:2E:DC:B9:5F:65:E2:49:6A:D7:C9:30</span><br><span class="line">           X509v3 Authority Key Identifier: </span><br><span class="line">               </span><br><span class="line">keyid:12:E1:71:0E:BD:9E:7D:6C:94:02:C9:F1:2E:66:B3:5E:12:B3:FE:5F</span><br><span class="line">Certificate is to be certified until Feb 14 06:21:01 2023 GMT (1000 days)</span><br><span class="line">Sign the certificate? [y/n]:y</span><br><span class="line">1 out of 1 certificate requests certified, commit? [y/n]y</span><br><span class="line">Write out database with 1 new entries</span><br><span class="line">Data Base Updated</span><br><span class="line"></span><br><span class="line">[root@centos8 ~]<span class="comment"># tree /etc/pki/CA</span></span><br><span class="line">/etc/pki/CA</span><br><span class="line">├── cacert.pem</span><br><span class="line">├── certs</span><br><span class="line">│   └── app1.crt</span><br><span class="line">├── crl</span><br><span class="line">├── index.txt</span><br><span class="line">├── index.txt.attr</span><br><span class="line">├── index.txt.old</span><br><span class="line">├── newcerts</span><br><span class="line">│   └── 0F.pem</span><br><span class="line">├── private</span><br><span class="line">│   └── cakey.pem</span><br><span class="line">├── serial</span><br><span class="line">└── serial.old</span><br><span class="line">4 directories, 9 files</span><br></pre></td></tr></table></figure>

<h4 id="查看证书"><a href="#查看证书" class="headerlink" title="查看证书"></a>查看证书</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ~]<span class="comment">#cat /etc/pki/CA/certs/app1.crt</span></span><br><span class="line">Certificate:</span><br><span class="line">   Data:</span><br><span class="line">       Version: 3 (0x2)</span><br><span class="line">       Serial Number: 15 (0xf)</span><br><span class="line">       Signature Algorithm: sha256WithRSAEncryption</span><br><span class="line">       Issuer: C=CN, ST=beijing, L=beijing, O=magedu, OU=devops, </span><br><span class="line">CN=ca.magedu.org/emailAddress=admin@magedu.org</span><br><span class="line">       Validity</span><br><span class="line">           Not Before: May 20 06:21:01 2020 GMT</span><br><span class="line">           Not After : Feb 14 06:21:01 2023 GMT</span><br><span class="line">       Subject: C=CN, ST=beijing, O=magedu, OU=it, </span><br><span class="line">CN=app1.magedu.org/emailAddress=root@magedu.org</span><br><span class="line">       Subject Public Key Info:</span><br><span class="line">           Public Key Algorithm: rsaEncryption</span><br><span class="line">               RSA Public-Key: (2048 bit)</span><br><span class="line">               Modulus:</span><br><span class="line">                    00:b9:3a:5b:e5:4b:57:84:26:b8:8c:c3:77:80:cb:</span><br><span class="line">                    <span class="built_in">fc</span>:6b:4b:87:9a:64:d6:32:a6:22:a7:85:94:2c:e9:</span><br><span class="line">                    c3:60:ad:89:ed:00:88:11:62:1f:ec:73:e0:65:3b:</span><br><span class="line">                    cb:d5:38:87:56:a3:11:68:91:f1:c0:d1:f9:21:d1:</span><br><span class="line">                    0e:ea:ac:eb:a9:ea:ae:23:7a:43:fb:b3:37:88:2b:</span><br><span class="line">                    51:a3:0a:43:f7:2f:4c:7a:79:<span class="built_in">dd</span>:60:bc:c4:80:87:</span><br><span class="line">                    a9:51:ba:09:b6:7e:31:1b:f2:cf:f5:ef:3d:6c:2d:</span><br><span class="line">                    34:4a:d8:03:14:9b:04:97:5f:6c:b9:a4:94:64:26:</span><br><span class="line">                    f0:29:1f:50:53:f4:62:58:e2:d9:7e:a2:e6:6f:9c:</span><br><span class="line">                    44:69:43:b7:ef:e7:82:8a:8d:35:c1:68:b6:4d:2c:</span><br><span class="line">                    47:bb:e0:94:56:9c:9f:f7:5e:4e:82:0e:23:3a:86:</span><br><span class="line">                    06:18:b4:bc:d1:89:27:3b:aa:9e:f0:74:70:08:98:</span><br><span class="line">                    3a:c3:49:f7:b3:d0:64:a8:58:1e:62:c6:41:65:bd:</span><br><span class="line">                    89:db:ba:f3:84:6a:4f:bc:4e:84:0a:ec:5a:47:0a:</span><br><span class="line">                    9d:be:47:19:97:16:67:89:bb:01:3f:55:5e:0e:2e:</span><br><span class="line">                    15:9e:8e:2a:6d:0f:af:8f:14:c5:2e:54:dc:0e:4a:</span><br><span class="line">                    3c:5d:ee:8d:72:<span class="built_in">df</span>:90:fd:9d:ef:40:0f:98:36:81:</span><br><span class="line">                    ff:5d</span><br><span class="line">               Exponent: 65537 (0x10001)</span><br><span class="line">       X509v3 extensions:</span><br><span class="line">           X509v3 Basic Constraints: </span><br><span class="line">               CA:FALSE</span><br><span class="line">           Netscape Comment: </span><br><span class="line">               OpenSSL Generated Certificate</span><br><span class="line">           X509v3 Subject Key Identifier: </span><br><span class="line">               BC:C0:D3:08:AE:E3:2C:0C:DB:2E:DC:B9:5F:65:E2:49:6A:D7:C9:30</span><br><span class="line">           X509v3 Authority Key Identifier: </span><br><span class="line">               </span><br><span class="line">keyid:12:E1:71:0E:BD:9E:7D:6C:94:02:C9:F1:2E:66:B3:5E:12:B3:FE:5F</span><br><span class="line">   Signature Algorithm: sha256WithRSAEncryption</span><br><span class="line">         28:64:7c:ac:58:b2:07:58:5e:91:58:53:45:64:82:92:65:bd:</span><br><span class="line">         7b:8c:3a:20:b7:23:ed:5f:11:22:de:44:c6:8b:2a:3c:83:f2:</span><br><span class="line">         a7:66:6c:66:77:75:d9:36:fe:0a:53:7e:f8:aa:25:ad:6c:cc:</span><br><span class="line">         0c:b7:6c:63:bc:04:9e:94:06:83:36:bb:86:5d:b6:56:0b:24:</span><br><span class="line">         d9:d7:97:3e:74:42:d8:33:89:ce:a7:5c:83:3e:fb:da:a8:21:</span><br><span class="line">         64:1f:66:90:00:3c:3e:c2:<span class="built_in">fc</span>:bd:01:58:d4:1e:5a:5c:6a:a8:</span><br><span class="line">         33:f8:50:eb:34:65:3c:4f:29:98:d3:e2:4f:7c:d5:15:74:11:</span><br><span class="line">         fe:04:5c:4f:b9:95:b0:97:fb:93:17:fa:03:07:3d:50:b2:67:</span><br><span class="line">         5e:6e:5a:03:6b:7f:76:15:ea:98:3a:69:8e:72:db:2f:47:f9:</span><br><span class="line">         82:fe:f6:2c:0f:fe:e7:24:ab:a3:e9:93:7f:a8:ed:6d:26:97:</span><br><span class="line">         f7:4c:e0:58:4c:b1:c7:66:ff:7c:3c:f1:01:f3:02:7f:73:38:</span><br><span class="line">         85:60:8e:2a:e6:f8:6d:d0:60:e0:11:2b:78:56:0d:76:55:91:</span><br><span class="line">         a5:f7:8e:06:8f:fa:47:0c:94:4b:ab:9e:13:d8:3e:69:23:55:</span><br><span class="line">         b8:95:3a:7a:0a:2d:2c:fd:6b:76:23:aa:62:5c:10:ee:89:d1:</span><br><span class="line">         9f:3c:fa:f6</span><br><span class="line">-----BEGIN CERTIFICATE-----</span><br><span class="line">MIID+jCCAuKgAwIBAgIBDzANBgkqhkiG9w0BAQsFADCBjDELMAkGA1UEBhMCQ04x</span><br><span class="line">EDAOBgNVBAgMB2JlaWppbmcxEDAOBgNVBAcMB2JlaWppbmcxDzANBgNVBAoMBm1h</span><br><span class="line">Z2VkdTEPMA0GA1UECwwGZGV2b3BzMRYwFAYDVQQDDA1jYS5tYWdlZHUub3JnMR8w</span><br><span class="line">HQYJKoZIhvcNAQkBFhBhZG1pbkBtYWdlZHUub3JnMB4XDTIwMDUyMDA2MjEwMVoX</span><br><span class="line">DTIzMDIxNDA2MjEwMVowdzELMAkGA1UEBhMCQ04xEDAOBgNVBAgMB2JlaWppbmcx</span><br><span class="line">DzANBgNVBAoMBm1hZ2VkdTELMAkGA1UECwwCaXQxGDAWBgNVBAMMD2FwcDEubWFn</span><br><span class="line">ZWR1Lm9yZzEeMBwGCSqGSIb3DQEJARYPcm9vdEBtYWdlZHUub3JnMIIBIjANBgkq</span><br><span class="line">hkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEAuTpb5UtXhCa4jMN3gMv8a0uHmmTWMqYi</span><br><span class="line">p4WULOnDYK2J7QCIEWIf7HPgZTvL1TiHVqMRaJHxwNH5IdEO6qzrqequI3pD+7M3</span><br><span class="line">iCtRowpD9y9MenndYLzEgIepUboJtn4xG/LP9e89bC00StgDFJsEl19suaSUZCbw</span><br><span class="line">KR9QU/RiWOLZfqLmb5xEaUO37+eCio01wWi2TSxHu+CUVpyf915Ogg4jOoYGGLS8</span><br><span class="line">0YknO6qe8HRwCJg6w0n3s9BkqFgeYsZBZb2J27rzhGpPvE6ECuxaRwqdvkcZlxZn</span><br><span class="line">ibsBP1VeDi4Vno4qbQ+vjxTFLlTcDko8Xe6Nct+Q/Z3vQA+YNoH/XQIDAQABo3sw</span><br><span class="line">eTAJBgNVHRMEAjAAMCwGCWCGSAGG+EIBDQQfFh1PcGVuU1NMIEdlbmVyYXRlZCBD</span><br><span class="line">ZXJ0aWZpY2F0ZTAdBgNVHQ4EFgQUvMDTCK7jLAzbLty5X2XiSWrXyTAwHwYDVR0j</span><br><span class="line">BBgwFoAUEuFxDr2efWyUAsnxLmazXhKz/l8wDQYJKoZIhvcNAQELBQADggEBAChk</span><br><span class="line">fKxYsgdYXpFYU0VkgpJlvXuMOiC3I+1fESLeRMaLKjyD8qdmbGZ3ddk2/gpTfviq</span><br><span class="line">Ja1szAy3bGO8BJ6UBoM2u4ZdtlYLJNnXlz50Qtgzic6nXIM++9qoIWQfZpAAPD7C</span><br><span class="line">/L0BWNQeWlxqqDP4UOs0ZTxPKZjT4k981RV0Ef4EXE+5lbCX+5MX+gMHPVCyZ15u</span><br><span class="line">WgNrf3YV6pg6aY5y2y9H+YL+9iwP/uckq6Ppk3+o7W0ml/dM4FhMscdm/3w88QHz</span><br><span class="line">An9zOIVgjirm+G3QYOARK3hWDXZVkaX3jgaP+kcMlEurnhPYPmkjVbiVOnoKLSz9</span><br><span class="line">a3YjqmJcEO6J0Z88+vY=</span><br><span class="line">-----END CERTIFICATE-----</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@centos8 ~]<span class="comment">#openssl x509 -in /etc/pki/CA/certs/app1.crt -noout -text</span></span><br><span class="line">Certificate:</span><br><span class="line">   Data:</span><br><span class="line">       Version: 3 (0x2)</span><br><span class="line">       Serial Number: 15 (0xf)</span><br><span class="line">       Signature Algorithm: sha256WithRSAEncryption</span><br><span class="line">       Issuer: C = CN, ST = beijing, L = beijing, O = magedu, OU = devops, CN =</span><br><span class="line">ca.magedu.org, emailAddress = admin@magedu.org</span><br><span class="line">       Validity</span><br><span class="line">           Not Before: May 20 06:21:01 2020 GMT</span><br><span class="line">           Not After : Feb 14 06:21:01 2023 GMT</span><br><span class="line">       Subject: C = CN, ST = beijing, O = magedu, OU = it, CN =</span><br><span class="line">app1.magedu.org, emailAddress = root@magedu.org</span><br><span class="line">       Subject Public Key Info:</span><br><span class="line">           Public Key Algorithm: rsaEncryption</span><br><span class="line">               RSA Public-Key: (2048 bit)</span><br><span class="line">               Modulus:</span><br><span class="line">                    00:b9:3a:5b:e5:4b:57:84:26:b8:8c:c3:77:80:cb:</span><br><span class="line">                   <span class="built_in">fc</span>:6b:4b:87:9a:64:d6:32:a6:22:a7:85:94:2c:e9:</span><br><span class="line">                   c3:60:ad:89:ed:00:88:11:62:1f:ec:73:e0:65:3b:</span><br><span class="line">                   cb:d5:38:87:56:a3:11:68:91:f1:c0:d1:f9:21:d1:</span><br><span class="line">                   0e:ea:ac:eb:a9:ea:ae:23:7a:43:fb:b3:37:88:2b:</span><br><span class="line">                    51:a3:0a:43:f7:2f:4c:7a:79:<span class="built_in">dd</span>:60:bc:c4:80:87:</span><br><span class="line">                   a9:51:ba:09:b6:7e:31:1b:f2:cf:f5:ef:3d:6c:2d:</span><br><span class="line">                    34:4a:d8:03:14:9b:04:97:5f:6c:b9:a4:94:64:26:</span><br><span class="line">                   f0:29:1f:50:53:f4:62:58:e2:d9:7e:a2:e6:6f:9c:</span><br><span class="line">                    44:69:43:b7:ef:e7:82:8a:8d:35:c1:68:b6:4d:2c:</span><br><span class="line">                    47:bb:e0:94:56:9c:9f:f7:5e:4e:82:0e:23:3a:86:</span><br><span class="line">                    06:18:b4:bc:d1:89:27:3b:aa:9e:f0:74:70:08:98:</span><br><span class="line">                   3a:c3:49:f7:b3:d0:64:a8:58:1e:62:c6:41:65:bd:</span><br><span class="line">                    89:db:ba:f3:84:6a:4f:bc:4e:84:0a:ec:5a:47:0a:</span><br><span class="line">                   9d:be:47:19:97:16:67:89:bb:01:3f:55:5e:0e:2e:</span><br><span class="line">                    15:9e:8e:2a:6d:0f:af:8f:14:c5:2e:54:dc:0e:4a:</span><br><span class="line">                   3c:5d:ee:8d:72:<span class="built_in">df</span>:90:fd:9d:ef:40:0f:98:36:81:</span><br><span class="line">                   ff:5d</span><br><span class="line">               Exponent: 65537 (0x10001)</span><br><span class="line">       X509v3 extensions:</span><br><span class="line">           X509v3 Basic Constraints: </span><br><span class="line">               CA:FALSE</span><br><span class="line">           Netscape Comment: </span><br><span class="line">               OpenSSL Generated Certificate</span><br><span class="line">           X509v3 Subject Key Identifier: </span><br><span class="line">               BC:C0:D3:08:AE:E3:2C:0C:DB:2E:DC:B9:5F:65:E2:49:6A:D7:C9:30</span><br><span class="line">           X509v3 Authority Key Identifier: </span><br><span class="line">               </span><br><span class="line">keyid:12:E1:71:0E:BD:9E:7D:6C:94:02:C9:F1:2E:66:B3:5E:12:B3:FE:5F</span><br><span class="line">   Signature Algorithm: sha256WithRSAEncryption</span><br><span class="line">         28:64:7c:ac:58:b2:07:58:5e:91:58:53:45:64:82:92:65:bd:</span><br><span class="line">         7b:8c:3a:20:b7:23:ed:5f:11:22:de:44:c6:8b:2a:3c:83:f2:</span><br><span class="line">         a7:66:6c:66:77:75:d9:36:fe:0a:53:7e:f8:aa:25:ad:6c:cc:</span><br><span class="line">         0c:b7:6c:63:bc:04:9e:94:06:83:36:bb:86:5d:b6:56:0b:24:</span><br><span class="line">         d9:d7:97:3e:74:42:d8:33:89:ce:a7:5c:83:3e:fb:da:a8:21:</span><br><span class="line">         64:1f:66:90:00:3c:3e:c2:<span class="built_in">fc</span>:bd:01:58:d4:1e:5a:5c:6a:a8:</span><br><span class="line">         33:f8:50:eb:34:65:3c:4f:29:98:d3:e2:4f:7c:d5:15:74:11:</span><br><span class="line">         fe:04:5c:4f:b9:95:b0:97:fb:93:17:fa:03:07:3d:50:b2:67:</span><br><span class="line">         5e:6e:5a:03:6b:7f:76:15:ea:98:3a:69:8e:72:db:2f:47:f9:</span><br><span class="line">         82:fe:f6:2c:0f:fe:e7:24:ab:a3:e9:93:7f:a8:ed:6d:26:97:</span><br><span class="line">         f7:4c:e0:58:4c:b1:c7:66:ff:7c:3c:f1:01:f3:02:7f:73:38:</span><br><span class="line">         85:60:8e:2a:e6:f8:6d:d0:60:e0:11:2b:78:56:0d:76:55:91:</span><br><span class="line">         a5:f7:8e:06:8f:fa:47:0c:94:4b:ab:9e:13:d8:3e:69:23:55:</span><br><span class="line">         b8:95:3a:7a:0a:2d:2c:fd:6b:76:23:aa:62:5c:10:ee:89:d1:</span><br><span class="line">         9f:3c:fa:f6</span><br><span class="line">         </span><br><span class="line">         </span><br><span class="line">[root@centos8 ~]<span class="comment">#openssl x509 -in /etc/pki/CA/certs/app1.crt -noout -issuer</span></span><br><span class="line">issuer=C = CN, ST = beijing, L = beijing, O = magedu, OU = devops, CN = ca.magedu.org, emailAddress = admin@magedu.org</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@centos8 ~]<span class="comment">#openssl x509 -in /etc/pki/CA/certs/app1.crt -noout -subject</span></span><br><span class="line">subject=C = CN, ST = beijing, O = magedu, OU = it, CN = app1.magedu.org, emailAddress = root@magedu.org</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@centos8 ~]<span class="comment">#openssl x509 -in /etc/pki/CA/certs/app1.crt -noout -dates</span></span><br><span class="line">notBefore=May 20 06:21:01 2020 GMT</span><br><span class="line">notAfter=Feb 14 06:21:01 2023 GMT</span><br><span class="line"></span><br><span class="line">[root@centos8 ~]<span class="comment">#openssl x509 -in /etc/pki/CA/certs/app1.crt -noout -serial</span></span><br><span class="line">serial=0F</span><br><span class="line"></span><br><span class="line"><span class="comment">#验证指定编号对应证书的有效性</span></span><br><span class="line">[root@centos8 ~]<span class="comment">#openssl ca -status 0F</span></span><br><span class="line">Using configuration from /etc/pki/tls/openssl.cnf</span><br><span class="line">0F=Valid (V)</span><br><span class="line"></span><br><span class="line">[root@centos8 ~]<span class="comment">#cat /etc/pki/CA/index.txt</span></span><br><span class="line">V 230214062101Z 0F unknown </span><br><span class="line">/C=CN/ST=beijing/O=magedu/OU=it/CN=app1.magedu.org/emailAddress=root@magedu.org</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@centos8 ~]<span class="comment">#cat /etc/pki/CA/index.txt.old</span></span><br><span class="line">[root@centos8 ~]<span class="comment">#cat /etc/pki/CA/serial</span></span><br><span class="line">10</span><br><span class="line"></span><br><span class="line">[root@centos8 ~]<span class="comment">#cat /etc/pki/CA/serial.old </span></span><br><span class="line">0F</span><br></pre></td></tr></table></figure>

<p><img src="../../../../images/SRE/day15/25.png" alt="25"></p>
<p><img src="../../../../images/SRE/day15/26.png" alt="26"></p>
<p><img src="../../../../images/SRE/day15/27.png" alt="27"></p>
<h4 id="将证书相关文件发送到用户端使用"><a href="#将证书相关文件发送到用户端使用" class="headerlink" title="将证书相关文件发送到用户端使用"></a>将证书相关文件发送到用户端使用</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ~]<span class="comment"># cp /etc/pki/CA/certs/app1.crt /data/app1/</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># tree /data/app1/</span></span><br><span class="line">/data/app1/</span><br><span class="line">├── app1.crt</span><br><span class="line">├── app1.csr</span><br><span class="line">└── app1.key</span><br><span class="line"></span><br><span class="line">0 directories, 3 files</span><br></pre></td></tr></table></figure>

<h4 id="证书的信任"><a href="#证书的信任" class="headerlink" title="证书的信任"></a>证书的信任</h4><p>默认生成的证书，在windows上是不被信任的，可以通过下面的操作实现信任 </p>
<p>打开internet属性</p>
<p><img src="../../../../images/SRE/day15/28.png" alt="28"></p>
<p><img src="../../../../images/SRE/day15/29.png" alt="29"></p>
<p><img src="../../../../images/SRE/day15/30.png" alt="30"></p>
<p><img src="../../../../images/SRE/day15/31.png" alt="31"></p>
<p><img src="../../../../images/SRE/day15/32.png" alt="32"></p>
<p><img src="../../../../images/SRE/day15/33.png" alt="33"></p>
<p><img src="../../../../images/SRE/day15/34.png" alt="34"></p>
<p><img src="../../../../images/SRE/day15/35.png" alt="35"></p>
<p><img src="../../../../images/SRE/day15/36.png" alt="36"></p>
<p><img src="../../../../images/SRE/day15/37.png" alt="37"></p>
<p><img src="../../../../images/SRE/day15/38.png" alt="38"></p>
<p><img src="../../../../images/SRE/day15/39.png" alt="39"></p>
<h4 id="证书的吊销"><a href="#证书的吊销" class="headerlink" title="证书的吊销"></a>证书的吊销</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ~]<span class="comment">#openssl ca -revoke /etc/pki/CA/newcerts/11.pem</span></span><br><span class="line">Using configuration from /etc/pki/tls/openssl.cnf</span><br><span class="line">Revoking Certificate 11.</span><br><span class="line">Data Base Updated</span><br><span class="line"></span><br><span class="line">[root@centos8 ~]<span class="comment">#openssl ca -status 11</span></span><br><span class="line">Using configuration from /etc/pki/tls/openssl.cnf</span><br><span class="line">11=Revoked (R)</span><br><span class="line"></span><br><span class="line">[root@centos8 ~]<span class="comment">#cat /etc/pki/CA/index.txt</span></span><br><span class="line">V 230214062101Z 0F unknown </span><br><span class="line">/C=CN/ST=beijing/O=magedu/OU=it/CN=app1.magedu.org/emailAddress=root@magedu.org</span><br><span class="line">V 210520064452Z 10 unknown </span><br><span class="line">/C=CN/ST=hubei/L=wuhan/O=wangedu/OU=sales/CN=app2.wangedu.org/emailAddress=admin</span><br><span class="line">@wangedu.org</span><br><span class="line">R 210520065000Z 200520065821Z 11 unknown </span><br><span class="line">/C=CN/ST=hubei/L=wuhan/O=wangedu/OU=sales/CN=app2.wangedu.org/emailAddress=admin</span><br><span class="line">@wangedu.org</span><br></pre></td></tr></table></figure>

<h4 id="生成证书吊销列表文件"><a href="#生成证书吊销列表文件" class="headerlink" title="生成证书吊销列表文件"></a>生成证书吊销列表文件</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ~]<span class="comment">#openssl ca -gencrl -out /etc/pki/CA/crl.pem</span></span><br><span class="line">Using configuration from /etc/pki/tls/openssl.cnf</span><br><span class="line">/etc/pki/CA/crlnumber: No such file or directory</span><br><span class="line">error <span class="keyword">while</span> loading CRL number</span><br><span class="line">140511895181120:error:02001002:system library:fopen:No such file or </span><br><span class="line">directory:crypto/bio/bss_file.c:72:fopen(<span class="string">&#x27;/etc/pki/CA/crlnumber&#x27;</span>,<span class="string">&#x27;r&#x27;</span>)</span><br><span class="line">140511895181120:error:2006D080:BIO routines:BIO_new_file:no such </span><br><span class="line">file:crypto/bio/bss_file.c:79:</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@centos8 ~]<span class="comment"># echo 01 &gt; /etc/pki/CA/crlnumber</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># openssl ca -gencrl -out /etc/pki/CA/crl.pem</span></span><br><span class="line">Using configuration from /etc/pki/tls/openssl.cnf</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@centos8 ~]<span class="comment">#cat /etc/pki/CA/crlnumber</span></span><br><span class="line">02</span><br><span class="line">[root@centos8 ~]<span class="comment">#cat /etc/pki/CA/crl.pem</span></span><br><span class="line">-----BEGIN X509 CRL-----</span><br><span class="line">MIIB/DCB5QIBATANBgkqhkiG9w0BAQsFADCBjDELMAkGA1UEBhMCQ04xEDAOBgNV</span><br><span class="line">BAgMB2JlaWppbmcxEDAOBgNVBAcMB2JlaWppbmcxDzANBgNVBAoMBm1hZ2VkdTEP</span><br><span class="line">MA0GA1UECwwGZGV2b3BzMRYwFAYDVQQDDA1jYS5tYWdlZHUub3JnMR8wHQYJKoZI</span><br><span class="line">hvcNAQkBFhBhZG1pbkBtYWdlZHUub3JnFw0yMDA1MjAwNzAzNTdaFw0yMDA2MTkw</span><br><span class="line">NzAzNTdaMBQwEgIBERcNMjAwNTIwMDY1ODIxWqAOMAwwCgYDVR0UBAMCAQEwDQYJ</span><br><span class="line">KoZIhvcNAQELBQADggEBAJURX2tzn05nPkxynNwYLimWUIdgQn9UZxZaDmbQg9j5</span><br><span class="line">5xmhXV+5Tz6qV8gI4+sPwyUGXRcURDHDEW2SCIK6s/Cmx9sYNZRsNpp3sQKYBM6e</span><br><span class="line">NbtIh1fIGx3927bxPwNc7Lbq6fHYL349RUOgcjI9oKS8TU/LdIzlofVVQdzFqEda</span><br><span class="line">Fb/HLHOp3/nhuuH2WHR9nb6jNCX6a8qLUA+M0eEGMSqsLv+3lqmyZ9F7GE97I1lG</span><br><span class="line">KW/iyJWlu5Ogjummp241J+bmuxyZLVqsd5dOywIP8kZpGQJq+Ga4uUMGY9CvR15M</span><br><span class="line">y7JW6tZnJVQnw/29jNWhIEsrcn3NErWvg1R7ljjW5g0=</span><br><span class="line">-----END X509 CRL-----</span><br><span class="line"></span><br><span class="line">[root@centos8 ~]<span class="comment"># openssl crl -in /etc/pki/CA/crl.pem -noout -text</span></span><br><span class="line">Certificate Revocation List (CRL):</span><br><span class="line">       Version 2 (0x1)</span><br><span class="line">       Signature Algorithm: sha256WithRSAEncryption</span><br><span class="line">       Issuer: C = CN, ST = beijing, L = beijing, O = magedu, OU = devops, CN =</span><br><span class="line">ca.magedu.org, emailAddress = admin@magedu.org</span><br><span class="line">       Last Update: May 20 07:03:57 2020 GMT</span><br><span class="line">       Next Update: Jun 19 07:03:57 2020 GMT</span><br><span class="line">       CRL extensions:</span><br><span class="line">           X509v3 CRL Number: </span><br><span class="line">                1</span><br><span class="line">Revoked Certificates:</span><br><span class="line">   Serial Number: 11</span><br><span class="line">       Revocation Date: May 20 06:58:21 2020 GMT</span><br><span class="line">   Signature Algorithm: sha256WithRSAEncryption</span><br><span class="line">         95:11:5f:6b:73:9f:4e:67:3e:4c:72:9c:dc:18:2e:29:96:50:</span><br><span class="line">         87:60:42:7f:54:67:16:5a:0e:66:d0:83:d8:f9:e7:19:a1:5d:</span><br><span class="line">         5f:b9:4f:3e:aa:57:c8:08:e3:eb:0f:c3:25:06:5d:17:14:44:</span><br><span class="line">         31:c3:11:6d:92:08:82:ba:b3:f0:a6:c7:db:18:35:94:6c:36:</span><br><span class="line">         9a:77:b1:02:98:04:ce:9e:35:bb:48:87:57:c8:1b:1d:fd:db:</span><br><span class="line">         b6:f1:3f:03:5c:ec:b6:ea:e9:f1:d8:2f:7e:3d:45:43:a0:72:</span><br><span class="line">         32:3d:a0:a4:bc:4d:4f:cb:74:8c:e5:a1:f5:55:41:dc:c5:a8:</span><br><span class="line">         47:5a:15:bf:c7:2c:73:a9:<span class="built_in">df</span>:f9:e1:ba:e1:f6:58:74:7d:9d:</span><br><span class="line">         be:a3:34:25:fa:6b:ca:8b:50:0f:8c:d1:e1:06:31:2a:ac:2e:</span><br><span class="line">         ff:b7:96:a9:b2:67:d1:7b:18:4f:7b:23:59:46:29:6f:e2:c8:</span><br><span class="line">         95:a5:bb:93:a0:8e:e9:a6:a7:6e:35:27:e6:e6:bb:1c:99:2d:</span><br><span class="line">         5a:ac:77:97:4e:cb:02:0f:f2:46:69:19:02:6a:f8:66:b8:b9:</span><br><span class="line">         43:06:63:d0:af:47:5e:4c:cb:b2:56:ea:d6:67:25:54:27:c3:</span><br><span class="line">         fd:bd:8c:d5:a1:20:4b:2b:72:7d:<span class="built_in">cd</span>:12:b5:af:83:54:7b:96:</span><br><span class="line">         38:d6:e6:0d</span><br><span class="line">         </span><br><span class="line">[root@centos8 ~]<span class="comment">#sz /etc/pki/CA/crl.pem</span></span><br><span class="line"><span class="comment">#将此文件crl.pem传到windows上并改后缀为crl.pem.crl，双击可以查看</span></span><br></pre></td></tr></table></figure>

<h1 id="ssh服务"><a href="#ssh服务" class="headerlink" title="ssh服务"></a>ssh服务</h1><h2 id="ssh服务介绍"><a href="#ssh服务介绍" class="headerlink" title="ssh服务介绍"></a>ssh服务介绍</h2><p>ssh: secure shell protocol, 22/tcp, 安全的远程登录，实现加密通信，代替传统的 telnet 协议</p>
<p>具体的软件实现： </p>
<ul>
<li>OpenSSH：ssh协议的开源实现，CentOS 默认安装 </li>
<li>dropbear：另一个ssh协议的开源项目的实现 </li>
</ul>
<p>SSH 协议版本 </p>
<ul>
<li>v1：基于CRC-32做MAC，不安全；man-in-middle </li>
<li>v2：双方主机协议选择安全的MAC方式，基于DH算法做密钥交换，基于RSA或DSA实现身份认证</li>
</ul>
<h3 id="公钥交换原理"><a href="#公钥交换原理" class="headerlink" title="公钥交换原理"></a>公钥交换原理</h3><p><img src="../../../../images/SRE/day15/40.png" alt="40"></p>
<ul>
<li>客户端发起链接请求</li>
<li>服务端返回自己的公钥，以及一个会话ID（这一步客户端得到服务端公钥）</li>
<li>客户端生成密钥对</li>
<li>客户端用自己的公钥异或会话ID，计算出一个值Res，并用服务端的公钥加密</li>
<li>客户端发送加密后的值到服务端，服务端用私钥解密，得到Res</li>
<li>服务端用解密后的值Res异或会话ID，计算出客户端的公钥（这一步服务端得到客户端公钥） </li>
<li>最终：双方各自持有三个秘钥，分别为自己的一对公、私钥，以及对方的公钥，之后的所有通讯都会被加密</li>
</ul>
<h3 id="ssh加密通讯原理"><a href="#ssh加密通讯原理" class="headerlink" title="ssh加密通讯原理"></a>ssh加密通讯原理</h3><p><img src="../../../../images/SRE/day15/41.png" alt="41"></p>
<h2 id="openssh-服务"><a href="#openssh-服务" class="headerlink" title="openssh 服务"></a>openssh 服务</h2><p>OpenSSH是SSH （Secure SHell） 协议的免费开源实现，一般在各种Linux版本中会默认安装，基于C/S 结构 </p>
<p>Openssh软件相关包：</p>
<ul>
<li>openssh</li>
<li>openssh-clients</li>
<li>openssh-server </li>
</ul>
<p>范例：openssh 相关包</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ~]<span class="comment">#rpm -qa openssh*</span></span><br><span class="line">openssh-8.0p1-3.el8.x86_64</span><br><span class="line">openssh-server-8.0p1-3.el8.x86_64</span><br><span class="line">openssh-clients-8.0p1-3.el8.x86_64</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@centos8 ~]<span class="comment">#rpm -ql openssh-server</span></span><br><span class="line">/etc/pam.d/sshd</span><br><span class="line">/etc/ssh/sshd_config</span><br><span class="line">/etc/sysconfig/sshd</span><br><span class="line">/usr/lib/.build-id</span><br><span class="line">/usr/lib/.build-id/19</span><br><span class="line">/usr/lib/.build-id/19/f94eb99dad442636475226c458fcc3f38a502a</span><br><span class="line">/usr/lib/.build-id/3b</span><br><span class="line">/usr/lib/.build-id/3b/ede10e34358c9dbff9c6ffda41a835b95302bb</span><br><span class="line">/usr/lib/systemd/system/sshd-keygen.target</span><br><span class="line">/usr/lib/systemd/system/sshd-keygen@.service</span><br><span class="line">/usr/lib/systemd/system/sshd.service</span><br><span class="line">/usr/lib/systemd/system/sshd.socket</span><br><span class="line">/usr/lib/systemd/system/sshd@.service</span><br><span class="line">/usr/lib/tmpfiles.d/openssh.conf</span><br><span class="line">/usr/lib64/fipscheck/sshd.hmac</span><br><span class="line">/usr/libexec/openssh/sftp-server</span><br><span class="line">/usr/libexec/openssh/sshd-keygen</span><br><span class="line">/usr/sbin/sshd</span><br><span class="line">/usr/share/man/man5/moduli.5.gz</span><br><span class="line">/usr/share/man/man5/sshd_config.5.gz</span><br><span class="line">/usr/share/man/man8/sftp-server.8.gz</span><br><span class="line">/usr/share/man/man8/sshd.8.gz</span><br><span class="line">/var/empty/sshd</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">root@centos8 ~]<span class="comment">#rpm -ql openssh-clients</span></span><br><span class="line">/etc/ssh/ssh_config</span><br><span class="line">/etc/ssh/ssh_config.d</span><br><span class="line">/etc/ssh/ssh_config.d/05-redhat.conf</span><br><span class="line">/usr/bin/scp</span><br><span class="line">/usr/bin/sftp</span><br><span class="line">/usr/bin/ssh</span><br><span class="line">/usr/bin/ssh-add</span><br><span class="line">/usr/bin/ssh-agent</span><br><span class="line">/usr/bin/ssh-copy-id</span><br><span class="line">/usr/bin/ssh-keyscan</span><br><span class="line">/usr/lib/.build-id</span><br><span class="line">/usr/lib/.build-id/3c</span><br><span class="line">/usr/lib/.build-id/3c/88e491c910bc9079723a9184cbdf8bc4028624</span><br><span class="line">/usr/lib/.build-id/53</span><br><span class="line">/usr/lib/.build-id/53/8a62712c0e39ace0bc551706c885fa581fbaa3</span><br><span class="line">/usr/lib/.build-id/92</span><br><span class="line">/usr/lib/.build-id/92/bc7c07428eff615cf3b8c2a641439b1d698cda</span><br><span class="line">/usr/lib/.build-id/ab</span><br><span class="line">/usr/lib/.build-id/ab/a40d567f2828ad156be12ad64b50d4c000d6d1</span><br><span class="line">/usr/lib/.build-id/b3</span><br><span class="line">/usr/lib/.build-id/b3/a9d47e23c41b6f51d877d44ca3a2ffdc6e65f1</span><br><span class="line">/usr/lib/.build-id/bb</span><br><span class="line">/usr/lib/.build-id/bb/6bb2e70b69036d05be006ceaeafce21442f4ed</span><br><span class="line">/usr/lib/.build-id/e6</span><br><span class="line">/usr/lib/.build-id/e6/c028d0606c0fecced8250d7ff5dec5f60c9702</span><br><span class="line">/usr/lib64/fipscheck/ssh.hmac</span><br><span class="line">/usr/libexec/openssh/ssh-pkcs11-helper</span><br><span class="line">/usr/share/man/man1/scp.1.gz</span><br><span class="line">/usr/share/man/man1/sftp.1.gz</span><br><span class="line">/usr/share/man/man1/ssh-add.1.gz</span><br><span class="line">/usr/share/man/man1/ssh-agent.1.gz</span><br><span class="line">/usr/share/man/man1/ssh-copy-id.1.gz</span><br><span class="line">/usr/share/man/man1/ssh-keyscan.1.gz</span><br><span class="line">/usr/share/man/man1/ssh.1.gz</span><br><span class="line">/usr/share/man/man5/ssh_config.5.gz</span><br><span class="line">/usr/share/man/man8/ssh-pkcs11-helper.8.gz</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@centos8 ~]<span class="comment">#rpm -ql openssh</span></span><br><span class="line">/etc/ssh</span><br><span class="line">/etc/ssh/moduli</span><br><span class="line">/usr/bin/ssh-keygen</span><br><span class="line">/usr/lib/.build-id</span><br><span class="line">/usr/lib/.build-id/27</span><br><span class="line">/usr/lib/.build-id/27/31b9e5af80b6b09382aaca926840eecb95b4c1</span><br><span class="line">/usr/lib/.build-id/7f</span><br><span class="line">/usr/lib/.build-id/7f/34cc076efad8d4e0babfd0bfe951ba140f2877</span><br><span class="line">/usr/libexec/openssh</span><br><span class="line">/usr/libexec/openssh/ssh-keysign</span><br><span class="line">/usr/share/doc/openssh</span><br><span class="line">/usr/share/doc/openssh/CREDITS</span><br><span class="line">/usr/share/doc/openssh/ChangeLog</span><br><span class="line">/usr/share/doc/openssh/INSTALL</span><br><span class="line">/usr/share/doc/openssh/OVERVIEW</span><br><span class="line">/usr/share/doc/openssh/PROTOCOL</span><br><span class="line">/usr/share/doc/openssh/PROTOCOL.agent</span><br><span class="line">/usr/share/doc/openssh/PROTOCOL.certkeys</span><br><span class="line">/usr/share/doc/openssh/PROTOCOL.chacha20poly1305</span><br><span class="line">/usr/share/doc/openssh/PROTOCOL.key</span><br><span class="line">/usr/share/doc/openssh/PROTOCOL.krl</span><br><span class="line">/usr/share/doc/openssh/PROTOCOL.mux</span><br><span class="line">/usr/share/doc/openssh/README</span><br><span class="line">/usr/share/doc/openssh/README.dns</span><br><span class="line">/usr/share/doc/openssh/README.platform</span><br><span class="line">/usr/share/doc/openssh/README.privsep</span><br><span class="line">/usr/share/doc/openssh/README.tun</span><br><span class="line">/usr/share/doc/openssh/TODO</span><br><span class="line">/usr/share/licenses/openssh</span><br><span class="line">/usr/share/licenses/openssh/LICENCE</span><br><span class="line">/usr/share/man/man1/ssh-keygen.1.gz</span><br><span class="line">/usr/share/man/man8/ssh-keysign.8.gz</span><br></pre></td></tr></table></figure>

<p>服务器端程序：/usr/sbin/sshd</p>
<p>Unit 文件：/usr/lib/systemd/system/sshd.service</p>
<p>客户端：</p>
<ul>
<li>Linux Client: ssh, scp, sftp，slogin </li>
<li>Windows Client：xshell, MobaXterm,putty, securecrt, sshsecureshellclient</li>
</ul>
<h3 id="客户端-ssh命令"><a href="#客户端-ssh命令" class="headerlink" title="客户端 ssh命令"></a>客户端 ssh命令</h3><p>ssh命令是ssh客户端，允许实现对远程系统经验证地加密安全访问</p>
<p>当用户远程连接ssh服务器时，会复制ssh服务器/etc/ssh/ssh_host*key.pub文件中的公钥到客户机的 ~/.ssh/know_hosts中。下次连接时，会自动匹配相对应的私钥，不能匹配，将拒绝连接 </p>
<p>ssh客户端配置文件： /etc/ssh/ssh_config</p>
<p>主要配置</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#StrictHostKeyChecking ask</span></span><br><span class="line"><span class="comment">#首次登录不显示检查提示</span></span><br><span class="line">StrictHostKeyChecking no </span><br><span class="line"><span class="comment">#   IdentityFile ~/.ssh/id_rsa</span></span><br><span class="line"><span class="comment">#   IdentityFile ~/.ssh/id_dsa</span></span><br><span class="line"><span class="comment">#   IdentityFile ~/.ssh/id_ecdsa</span></span><br><span class="line"><span class="comment">#   IdentityFile ~/.ssh/id_ed25519</span></span><br><span class="line"><span class="comment">#   Port 22</span></span><br></pre></td></tr></table></figure>

<p>范例：禁止首次连接的询问过程</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@centos7 ~]<span class="comment">#sed -i.bak &#x27;/StrictHostKeyChecking/s/.*/StrictHostKeyChecking no/&#x27; /etc/ssh/ssh_config</span></span><br></pre></td></tr></table></figure>

<p>格式：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ssh [user@]host [COMMAND]</span><br><span class="line">ssh [-l user] host [COMMAND]</span><br></pre></td></tr></table></figure>

<p>常见选项</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">-p port                 <span class="comment">#远程服务器监听的端口</span></span><br><span class="line">-b                      <span class="comment">#指定连接的源IP</span></span><br><span class="line">-v                      <span class="comment">#调试模式</span></span><br><span class="line">-C                      <span class="comment">#压缩方式</span></span><br><span class="line">-X                      <span class="comment">#支持x11转发</span></span><br><span class="line">-t                      <span class="comment">#强制伪tty分配，如：ssh -t remoteserver1 ssh -t remoteserver2   ssh  remoteserver3</span></span><br><span class="line">-o option               <span class="comment">#如：-o StrictHostKeyChecking=no </span></span><br><span class="line">-i &lt;file&gt;               <span class="comment">#指定私钥文件路径，实现基于key验证，默认使用文件： ~/.ssh/id_dsa, ~/.ssh/id_ecdsa, ~/.ssh/id_ed25519，~/.ssh/id_rsa等</span></span><br></pre></td></tr></table></figure>

<p>范例：通过多个跳板登录远程主机10.0.0.6</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ~]<span class="comment">#ssh -t 10.0.0.8 ssh -t 10.0.0.7 ssh 10.0.0.6 </span></span><br><span class="line">root@10.0.0.8<span class="string">&#x27;s password: </span></span><br><span class="line"><span class="string">root@10.0.0.7&#x27;</span>s password: </span><br><span class="line">root@10.0.0.6<span class="string">&#x27;s password: </span></span><br><span class="line"><span class="string">Last login: Fri May 22 09:10:28 2020 from 10.0.0.7</span></span><br><span class="line"><span class="string">[root@centos6 ~]#</span></span><br></pre></td></tr></table></figure>

<p>范例：远程执行命令</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@centos6 ~]<span class="comment">#ssh 10.0.0.8 &quot;sed -i.bak </span></span><br><span class="line"><span class="string">&#x27;/StrictHostKeyChecking/s/.*/StrictHostKeyChecking no/&#x27;</span> /etc/ssh/ssh_config<span class="string">&quot; root@10.0.0.8&#x27;s password: </span></span><br><span class="line"><span class="string">[root@centos6 ~]#</span></span><br></pre></td></tr></table></figure>

<p><strong>范例：在远程主机运行本地shell脚本</strong></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ~]<span class="comment">#hostname -I</span></span><br><span class="line">10.0.0.8</span><br><span class="line"></span><br><span class="line">[root@centos8 ~]<span class="comment">#cat test.sh </span></span><br><span class="line"><span class="comment">#!/bin/bash</span></span><br><span class="line">hostname -I</span><br><span class="line"></span><br><span class="line">[root@centos8 ~]<span class="comment">#ssh 10.0.0.18 /bin/bash &lt; test.sh </span></span><br><span class="line">root@10.0.0.18<span class="string">&#x27;s password: </span></span><br><span class="line"><span class="string">10.0.0.18 </span></span><br></pre></td></tr></table></figure>

<p>范例：统计ssh登录失败次数最多的前十个远程IP</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ~]<span class="comment"># lastb -f btmp-test | awk &#x27;&#123;print $3&#125;&#x27;|sort |uniq -c|sort -nr|head </span></span><br><span class="line">  86294 58.218.92.37</span><br><span class="line">  43148 58.218.92.26</span><br><span class="line">  18036 112.85.42.201</span><br><span class="line">  10501 111.26.195.101</span><br><span class="line">  10501 111.231.235.49</span><br><span class="line">  10501 111.204.186.207</span><br><span class="line">  10501 111.11.29.199</span><br><span class="line">  10499 118.26.23.225</span><br><span class="line">   6288 42.7.26.142</span><br><span class="line">   4236 58.218.92.30</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@centos8 ~]<span class="comment"># lastb -f btmp-test | awk &#x27;&#123;ip[$3]++&#125;END&#123;for(i in ip)&#123;print ip[i],i&#125;&#125;&#x27;|sort -nr|head </span></span><br><span class="line">  86294 58.218.92.37</span><br><span class="line">  43148 58.218.92.26</span><br><span class="line">  18036 112.85.42.201</span><br><span class="line">  10501 111.26.195.101</span><br><span class="line">  10501 111.231.235.49</span><br><span class="line">  10501 111.204.186.207</span><br><span class="line">  10501 111.11.29.199</span><br><span class="line">  10499 118.26.23.225</span><br><span class="line">  6288 42.7.26.142</span><br><span class="line">  4236 58.218.92.30</span><br></pre></td></tr></table></figure>

<p>范例: 利用windows 显示 Linux 的图形工具</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#在windows 开启X Server的软件,如:Xmanager,观察的窗口的编号,如:0.0</span></span><br><span class="line"></span><br><span class="line">[root@centos8 ~]<span class="comment"># yum -y install firefox</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># export DISPLAY=10.0.0.1:0.0</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># firefox</span></span><br><span class="line"></span><br><span class="line">C:\Users\Administrator&gt;netstat -no | findstr 13520</span><br><span class="line"> TCP    10.0.0.1:6000          10.0.0.8:42806         ESTABLISHED     13520</span><br><span class="line"> TCP    10.0.0.1:6000          10.0.0.8:42812         ESTABLISHED     13520</span><br><span class="line"> TCP    10.0.0.1:6000          10.0.0.8:42814         ESTABLISHED     13520</span><br><span class="line"> TCP    10.0.0.1:6000          10.0.0.8:42846         ESTABLISHED     13520</span><br><span class="line"> TCP    10.0.0.1:6000          10.0.0.8:42878         ESTABLISHED     13520</span><br></pre></td></tr></table></figure>

<h3 id="其它ssh客户端工具"><a href="#其它ssh客户端工具" class="headerlink" title="其它ssh客户端工具"></a>其它ssh客户端工具</h3><h4 id="3-2-2-1-scp命令"><a href="#3-2-2-1-scp命令" class="headerlink" title="3.2.2.1 scp命令"></a>3.2.2.1 scp命令</h4><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">scp [options] SRC... DEST/</span><br></pre></td></tr></table></figure>

<p>方式：</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">scp [options] [user@]host:/sourcefile /destpath</span><br><span class="line">scp [options] /sourcefile [user@]host:/destpath</span><br><span class="line">scp [options] [user@]host1:/sourcetpath [user@]host2:/destpath</span><br></pre></td></tr></table></figure>

<p>常用选项：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">-C                    <span class="comment">#压缩数据流</span></span><br><span class="line">-r                    <span class="comment">#递归复制</span></span><br><span class="line">-p                    <span class="comment">#保持原文件的属性信息</span></span><br><span class="line">-q                    <span class="comment">#静默模式</span></span><br><span class="line">-P PORT               <span class="comment">#指明remote host的监听的端口</span></span><br></pre></td></tr></table></figure>

<h4 id="rsync-命令"><a href="#rsync-命令" class="headerlink" title="rsync 命令"></a>rsync 命令</h4><p>rsync工具可以基于ssh和rsync协议实现高效率的远程系统之间复制文件，使用安全的shell连接做为传输方式，比scp更快，基于增量数据同步，即只复制两方不同的文件，此工具来自于rsync包 </p>
<p>注意：通信两端主机都需要安装 rsync 软件</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">rsync  -av /etc   server1:/tmp/     <span class="comment">#复制目录和目录下文件</span></span><br><span class="line">rsync  -av /etc/  server1:/tmp/     <span class="comment">#只复制目录下文件</span></span><br></pre></td></tr></table></figure>

<p>常用选项：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">-n                              <span class="comment">#模拟复制过程</span></span><br><span class="line">-v                              <span class="comment">#显示详细过程</span></span><br><span class="line">-r                              <span class="comment">#递归复制目录树</span></span><br><span class="line">-p                              <span class="comment">#保留权限</span></span><br><span class="line">-t                              <span class="comment">#保留修改时间戳</span></span><br><span class="line">-g                              <span class="comment">#保留组信息</span></span><br><span class="line">-o                              <span class="comment">#保留所有者信息</span></span><br><span class="line">-l                              <span class="comment">#将软链接文件本身进行复制（默认）</span></span><br><span class="line">-L                              <span class="comment">#将软链接文件指向的文件复制</span></span><br><span class="line">-u                              <span class="comment">#如果接收者的文件比发送者的文件较新，将忽略同步</span></span><br><span class="line">-z                              <span class="comment">#压缩，节约网络带宽</span></span><br><span class="line">-a                              <span class="comment">#存档，相当于-rlptgoD，但不保留ACL（-A）和SELinux属性（-X）</span></span><br><span class="line">--delete                        <span class="comment">#源数据删除，目标数据也自动同步删除</span></span><br><span class="line">--progress                      <span class="comment">#显示进度</span></span><br><span class="line">--bwlimit=5120                  <span class="comment">#限速以KB为单位,5120表示5MB</span></span><br></pre></td></tr></table></figure>

<p>范例：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ~]<span class="comment">#rsync -auv --delete /data/test 10.0.0.7:/data</span></span><br></pre></td></tr></table></figure>

<p>范例：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ~]<span class="comment">#rsync -auv --progress --bwlimit=5120 --delete /data/test 10.0.0.7:/data</span></span><br><span class="line">sending incremental file list</span><br><span class="line"><span class="built_in">test</span>/</span><br><span class="line"><span class="built_in">test</span>/a.img</span><br><span class="line">    104,857,600 100%    5.01MB/s    0:00:19 (xfr<span class="comment">#1, to-chk=0/2)</span></span><br><span class="line">sent 104,883,319 bytes received 39 bytes  4,463,121.62 bytes/sec</span><br><span class="line">total size is 104,857,600 speedup is 1.00</span><br></pre></td></tr></table></figure>

<h4 id="sftp命令"><a href="#sftp命令" class="headerlink" title="sftp命令"></a>sftp命令</h4><p>交互式文件传输工具，用法和传统的ftp工具相似，利用ssh服务实现安全的文件上传和下载使用ls cd mkdir rmdir pwd get put等指令，可用？或help获取帮助信息</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sftp [user@]host</span><br><span class="line">sftp&gt; <span class="built_in">help</span></span><br></pre></td></tr></table></figure>

<h4 id="自动登录-ssh工具-sshpass"><a href="#自动登录-ssh工具-sshpass" class="headerlink" title="自动登录 ssh工具 sshpass"></a>自动登录 ssh工具 sshpass</h4><p>由EPEL源提供，ssh登陆不能在命令行中指定密码。sshpass的出现，解决了这一问题。sshpass用于非交互SSH的密码验证，一般用在sh脚本中，无须再次输入密码（本机known_hosts文件中有的主机才能生效）。它允许你用 -p 参数指定明文密码，然后直接登录远程服务器，它支持密码从命令行、文件、环境变量中读取。</p>
<p>格式：</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sshpass [option] command parameters</span><br></pre></td></tr></table></figure>

<p>常见选项</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">-p password    <span class="comment">#后跟密码它允许你用 -p 参数指定明文密码，然后直接登录远程服务器</span></span><br><span class="line">-f filename    <span class="comment">#后跟保存密码的文件名，密码是文件内容的第一行</span></span><br><span class="line">-e             <span class="comment">#将环境变量SSHPASS作为密码</span></span><br></pre></td></tr></table></figure>

<p>范例：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ~]<span class="comment">#yum -y install sshpass</span></span><br><span class="line"></span><br><span class="line">[root@centos8 ~]<span class="comment">#rpm -ql sshpass</span></span><br><span class="line">/usr/bin/sshpass</span><br><span class="line">/usr/lib/.build-id</span><br><span class="line">/usr/lib/.build-id/1f</span><br><span class="line">/usr/lib/.build-id/1f/c5d6cf03500df846a1a801aab749f478845a4d</span><br><span class="line">/usr/share/doc/sshpass</span><br><span class="line">/usr/share/doc/sshpass/AUTHORS</span><br><span class="line">/usr/share/doc/sshpass/COPYING</span><br><span class="line">/usr/share/doc/sshpass/ChangeLog</span><br><span class="line">/usr/share/doc/sshpass/NEWS</span><br><span class="line">/usr/share/man/man1/sshpass.1.gz</span><br><span class="line"></span><br><span class="line">[root@centos8 ~]<span class="comment"># sshpass -p 123456 ssh -o StrictHostKeyChecking=no 10.0.0.7 hostname -I</span></span><br><span class="line">Warning: Permanently added <span class="string">&#x27;10.0.0.7&#x27;</span> (ECDSA) to the list of known hosts.</span><br><span class="line">10.0.0.7 </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@centos8 ~]<span class="comment"># sshpass -p 123456 scp -o StrictHostKeyChecking=no /data/* 10.0.0.8:/data</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># cat pass.txt</span></span><br><span class="line">123456</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@centos8 ~]<span class="comment"># sshpass -f pass.txt ssh root@10.0.0.8</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># export SSHPASS=123456</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># sshpass -e ssh root@10.0.0.8</span></span><br></pre></td></tr></table></figure>

<p>范例：批量修改多台主机的root密码为随机密码</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> change_root_password.sh</span><br><span class="line"><span class="comment">#!/bin/bash</span></span><br><span class="line">rpm -q sshpass &amp;&gt; /dev/null || yum -y install sshpass</span><br><span class="line"><span class="built_in">export</span> SSHPASS=123456</span><br><span class="line">NET=10.0.0</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> &#123;1..254&#125;;<span class="keyword">do</span></span><br><span class="line">   &#123;</span><br><span class="line">   PASS=`openssl rand -<span class="built_in">base64</span> 9`</span><br><span class="line">   sshpass -e ssh  -o  StrictHostKeyChecking=no <span class="variable">$NET</span>.<span class="variable">$i</span> <span class="string">&quot;echo <span class="variable">$PASS</span>|passwd --stdin root &amp;&gt; /dev/null&quot;</span></span><br><span class="line">   <span class="built_in">echo</span> <span class="variable">$NET</span>.<span class="variable">$i</span>:<span class="variable">$PASS</span> &gt;&gt; host.txt</span><br><span class="line">   &#125;&amp;</span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"><span class="built_in">wait</span> </span><br></pre></td></tr></table></figure>

<p>范例：批量部署多台主机基于key验证脚本1</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line">NET=10.0.0</span><br><span class="line">PASS=magedu</span><br><span class="line">ssh-keygen  -P <span class="string">&quot;&quot;</span>  -f /root/.ssh/id_rsa &amp;&gt; /dev/null</span><br><span class="line">rpm -q sshpass &amp;&gt; /dev/null || yum -y install sshpass &amp;&gt; /dev/null</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> &#123;1..100&#125;;<span class="keyword">do</span></span><br><span class="line">&#123;</span><br><span class="line">  sshpass  -p <span class="variable">$PASS</span> ssh-copy-id -o  StrictHostKeyChecking=no -i /root/.ssh/id_rsa.pub <span class="variable">$NET</span>.<span class="variable">$i</span> &amp;&gt; /dev/null</span><br><span class="line">&#125;&amp;</span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"><span class="built_in">wait</span></span><br></pre></td></tr></table></figure>

<p>范例：批量部署多台主机基于key验证脚本2</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ~]<span class="comment">#cat sshpass.sh</span></span><br><span class="line"><span class="comment">#!/bin/bash</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"></span><br><span class="line">HOSTS=<span class="string">&quot;</span></span><br><span class="line"><span class="string">10.0.0.6</span></span><br><span class="line"><span class="string">10.0.0.7</span></span><br><span class="line"><span class="string">10.0.0.18</span></span><br><span class="line"><span class="string">10.0.0.28</span></span><br><span class="line"><span class="string">&quot;</span></span><br><span class="line">PASS=magedu</span><br><span class="line">ssh-keygen  -P <span class="string">&quot;&quot;</span>  -f /root/.ssh/id_rsa &amp;&gt; /dev/null</span><br><span class="line">rpm -q sshpass &amp;&gt; /dev/null || yum -y install sshpass &amp;&gt; /dev/null</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="variable">$HOSTS</span>;<span class="keyword">do</span></span><br><span class="line">&#123;</span><br><span class="line">    sshpass  -p <span class="variable">$PASS</span> ssh-copy-id -o  StrictHostKeyChecking=no -i /root/.ssh/id_rsa.pub <span class="variable">$i</span> &amp;&gt; /dev/null</span><br><span class="line">&#125;&amp;</span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"><span class="built_in">wait</span></span><br></pre></td></tr></table></figure>

<h3 id="ssh登录验证方式介绍"><a href="#ssh登录验证方式介绍" class="headerlink" title="ssh登录验证方式介绍"></a>ssh登录验证方式介绍</h3><p>ssh服务登录的常用验证方式</p>
<ul>
<li>用户/口令 </li>
<li>基于密钥</li>
</ul>
<p><strong>基于用户和口令登录验证</strong></p>
<p><img src="../../../../images/SRE/day15/42.png" alt="42"></p>
<ol>
<li>客户端发起ssh请求，服务器会把自己的公钥发送给用户</li>
<li>用户会根据服务器发来的公钥对密码进行加密 </li>
<li>加密后的信息回传给服务器，服务器用自己的私钥解密，如果密码正确，则用户登录成功 </li>
</ol>
<p><strong>基于密钥的登录方式</strong></p>
<p><img src="../../../../images/SRE/day15/43.png" alt="43"></p>
<ol>
<li>首先在客户端生成一对密钥（ssh-keygen）</li>
<li>并将客户端的公钥ssh-copy-id 拷贝到服务端</li>
<li>当客户端再次发送一个连接请求，包括ip、用户名</li>
<li>服务端得到客户端的请求后，会到authorized_keys中查找，如果有响应的IP和用户，就会随机生成一个字符串，例如：magedu</li>
<li>服务端将使用客户端拷贝过来的公钥进行加密，然后发送给客户端</li>
<li>得到服务端发来的消息后，客户端会使用私钥进行解密，然后将解密后的字符串发送给服务端</li>
<li>服务端接受到客户端发来的字符串后，跟之前的字符串进行对比，如果一致，就允许免密码登录</li>
</ol>
<h3 id="实现基于密钥的登录方式"><a href="#实现基于密钥的登录方式" class="headerlink" title="实现基于密钥的登录方式"></a>实现基于密钥的登录方式</h3><p>在客户端生成密钥对</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ssh-keygen -t rsa [-P <span class="string">&#x27;password&#x27;</span>] [-f “~/.ssh/id_rsa<span class="string">&quot;]</span></span><br></pre></td></tr></table></figure>

<p>把公钥文件传输至远程服务器对应用户的家目录</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ssh-copy-id [-i [identity_file]] [user@]host</span><br></pre></td></tr></table></figure>

<p>重设私钥口令：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ssh-keygen -p</span><br></pre></td></tr></table></figure>

<p>验证代理（authentication agent）保密解密后的密钥，口令就只需要输入一次，在GNOME中，代理被自动提供给root用户</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#启用代理</span></span><br><span class="line">ssh-agent bash</span><br><span class="line"></span><br><span class="line"><span class="comment">#钥匙通过命令添加给代理</span></span><br><span class="line">ssh-add</span><br></pre></td></tr></table></figure>

<p>在SecureCRT或Xshell实现基于key验证</p>
<p>在SecureCRT工具—&gt;创建公钥—&gt;生成Identity.pub文件</p>
<p>转化为openssh兼容格式（适合SecureCRT，Xshell不需要转化格式），并复制到需登录主机上相应文件authorized_keys中,注意权限必须为600，在需登录的ssh主机上执行：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ssh-keygen  -i -f Identity.pub &gt;&gt; .ssh/authorized_keys</span><br></pre></td></tr></table></figure>

<p>范例：实现基于 key 验证</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ~]<span class="comment">#ssh-keygen</span></span><br><span class="line">Generating public/private rsa key pair.</span><br><span class="line">Enter file <span class="keyword">in</span> <span class="built_in">which</span> to save the key (/root/.ssh/id_rsa): <span class="comment">#回车，接受默认值</span></span><br><span class="line">Enter passphrase (empty <span class="keyword">for</span> no passphrase): <span class="comment">#回车，接受默认值，空密码</span></span><br><span class="line">Enter same passphrase again: <span class="comment">#回车，接受默认值</span></span><br><span class="line">Your identification has been saved <span class="keyword">in</span> /root/.ssh/id_rsa.</span><br><span class="line">Your public key has been saved <span class="keyword">in</span> /root/.ssh/id_rsa.pub.</span><br><span class="line">The key fingerprint is:</span><br><span class="line">SHA256:vpPtmqRv1llmoSvqT2Lx5C0LPGTE0pvdAqhDqlR5jLY root@centos8.wangxiaochun.com</span><br><span class="line">The key<span class="string">&#x27;s randomart image is:</span></span><br><span class="line"><span class="string">+---[RSA 3072]----+</span></span><br><span class="line"><span class="string">|                 |</span></span><br><span class="line"><span class="string">|    ++           |</span></span><br><span class="line"><span class="string">| .=oo=           |</span></span><br><span class="line"><span class="string">| oo.oo = . .     |</span></span><br><span class="line"><span class="string">|..oE * S .. .    |</span></span><br><span class="line"><span class="string">|o . + * o. +     |</span></span><br><span class="line"><span class="string">|.     * B+.*     |</span></span><br><span class="line"><span class="string">|     . B*==      |</span></span><br><span class="line"><span class="string">|     .+*B=.      |</span></span><br><span class="line"><span class="string">+----[SHA256]-----+</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">[root@centos8 ~]#ll .ssh/ </span></span><br><span class="line"><span class="string">total 8</span></span><br><span class="line"><span class="string">-rw------- 1 root root 2622 May 22 09:51 id_rsa</span></span><br><span class="line"><span class="string">-rw-r--r-- 1 root root  583 May 22 09:51 id_rsa.pub</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">[root@centos8 ~]#cat .ssh/id_rsa.pub </span></span><br><span class="line"><span class="string">ssh-rsa </span></span><br><span class="line"><span class="string">AAAAB3NzaC1yc2EAAAADAQABAAABgQDEIP+dPPpgsvL+RdPbHvv5w88jOiRTO8Jz2aMcnRDE5UCbBjjg</span></span><br><span class="line"><span class="string">b/qqOuNEaQDk+RFfCRtxdm4o+B1NqBmFBCXVDJIy/dNzF/XyoQC1JzyBo9/sfggpeE5w3tQpJKQAIeQK</span></span><br><span class="line"><span class="string">rBZ6VD/otAHB/MO9NfQP21yZsgB1qXyY+3vvM8Hrk6mJf+J4+shyLnLYfDH6m93f7fMXcgiz2h0IuG5W</span></span><br><span class="line"><span class="string">85vuMUK5XQKQNnB1Ev9QSkQWtRbhzJ2LRgyBPLeifGzeO9fsiNz9k9TWVPgx6WxaW3xZe/byipEBBs49</span></span><br><span class="line"><span class="string">tMRFw/5E73H90g0lzBBzw5hUmDK1uieG6wU4/b/alJzqRsXSvm7s8ompfv9Cqigvy14H4ev79Ywi2aSe</span></span><br><span class="line"><span class="string">YacJ25MCmAHtwYMS5/Q25aTobpQF2DM57nlRxHF+biVjYgaJzZ+6eOIUjLzobFLqBzPsMC7DggJWjzRY</span></span><br><span class="line"><span class="string">y2MY1NJX97xjrkTP6zNPdWTnRieTo6d+BaHzj92uVJp3FfbkTg5pNqlguXdEMYU=</span></span><br><span class="line"><span class="string">root@centos8.wangxiaochun.com</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">[root@centos8 ~]#cat .ssh/id_rsa</span></span><br><span class="line"><span class="string">-----BEGIN OPENSSH PRIVATE KEY-----</span></span><br><span class="line"><span class="string">b3BlbnNzaC1rZXktdjEAAAAABG5vbmUAAAAEbm9uZQAAAAAAAAABAAABlwAAAAdzc2gtcn</span></span><br><span class="line"><span class="string">NhAAAAAwEAAQAAAYEAxCD/nTz6YLLy/kXT2x77+cPPIzokUzvCc9mjHJ0QxOVAmwY44G/6</span></span><br><span class="line"><span class="string">qjrjRGkA5PkRXwkbcXZuKPgdTagZhQQl1QySMv3Tcxf18qEAtSc8gaPf7H4IKXhOcN7UKS</span></span><br><span class="line"><span class="string">SkACHkCqwWelQ/6LQBwfzDvTX0D9tcmbIAdal8mPt77zPB65OpiX/iePrIci5y2Hwx+pvd</span></span><br><span class="line"><span class="string">3+3zF3IIs9odCLhuVvOb7jFCuV0CkDZwdRL/UEpEFrUW4cydi0YMgTy3onxs3jvX7Ijc/Z</span></span><br><span class="line"><span class="string">PU1lT4MelsWlt8WXv28oqRAQbOPbTERcP+RO9x/dINJcwQc8OYVJgytbonhusFOP2/2pSc</span></span><br><span class="line"><span class="string">6kbF0r5u7PKJqX7/QqooL8teB+Hr+/WMItmknmGnCduTApgB7cGDEuf0NuWk6G6UBdgzOe</span></span><br><span class="line"><span class="string">55UcRxfm4lY2IGic2funjiFIy86GxS6gcz7DAuw4ICVo80WMtjGNTSV/e8Y65Ez+szT3Vk</span></span><br><span class="line"><span class="string">50Ynk6OnfgWh84/drlSadxX25E4OaTapYLl3RDGFAAAFmGG46gFhuOoBAAAAB3NzaC1yc2</span></span><br><span class="line"><span class="string">EAAAGBAMQg/508+mCy8v5F09se+/nDzyM6JFM7wnPZoxydEMTlQJsGOOBv+qo640RpAOT5</span></span><br><span class="line"><span class="string">EV8JG3F2bij4HU2oGYUEJdUMkjL903MX9fKhALUnPIGj3+x+CCl4TnDe1CkkpAAh5AqsFn</span></span><br><span class="line"><span class="string">pUP+i0AcH8w7019A/bXJmyAHWpfJj7e+8zweuTqYl/4nj6yHIucth8Mfqb3d/t8xdyCLPa</span></span><br><span class="line"><span class="string">HQi4blbzm+4xQrldApA2cHUS/1BKRBa1FuHMnYtGDIE8t6J8bN471+yI3P2T1NZU+DHpbF</span></span><br><span class="line"><span class="string">pbfFl79vKKkQEGzj20xEXD/kTvcf3SDSXMEHPDmFSYMrW6J4brBTj9v9qUnOpGxdK+buzy</span></span><br><span class="line"><span class="string">ial+/0KqKC/LXgfh6/v1jCLZpJ5hpwnbkwKYAe3BgxLn9DblpOhulAXYMznueVHEcX5uJW</span></span><br><span class="line"><span class="string">NiBonNn7p44hSMvOhsUuoHM+wwLsOCAlaPNFjLYxjU0lf3vGOuRM/rM091ZOdGJ5Ojp34F</span></span><br><span class="line"><span class="string">ofOP3a5UmncV9uRODmk2qWC5d0QxhQAAAAMBAAEAAAGAYMFSuPRbJJdDbxNtp3zKm/XwWx</span></span><br><span class="line"><span class="string">WU1Ab4MATfBf+qRSg/zfqs1nQHujEg6x/OFCeXXUX15uyg/c8hTa0vIcLhExCHk2ZLCU15</span></span><br><span class="line"><span class="string">xP+OhM/ddqssjdPDHQo/0Ejta3qq+XG+uVEaKbEkch1TfKrAubhDNgtmzF/XADTjxejSxD</span></span><br><span class="line"><span class="string">fJY/lNuwp+5GX7uvCVMZ1bXqHEPHN76EYWavugNSwfKwA1HbXpj96FpDVnFyqPD8IDgxxF</span></span><br><span class="line"><span class="string">NJGn6wxcoOkeQqeVYbEtQCPF1htWwLBl1v4WauR8FW47FDkV8kff3INGevbfiNe403DGnp</span></span><br><span class="line"><span class="string">VtYKesuNA6eJ3u4i+ZugBFHq0w0exLolF4ViTlLlErLwa2D6LYozuPS3mwnEGt+eg1Md8p</span></span><br><span class="line"><span class="string">aWJh0ebElnZMF3xx1zLJ6/RdeKU6/9Cb23zW4PFaDiEK//do9MC8gtN6Rdube0Ze+tfSGl</span></span><br><span class="line"><span class="string">flXwDpcbcOvHN8paCMVHoW7hOm6mwlg0DKyW3ot1HKiYij0Fy5lKkN2iROeE4IxfGlAAAA</span></span><br><span class="line"><span class="string">wBkFn8GcN01jNrwev6HtRd4Cv9XJow0VpXW8JdqN11xtq90h4Hm3SSOk2HuChzgCrah+Om</span></span><br><span class="line"><span class="string">tofhG89QvyL6IyNU+AA4wb0EfBgc/xtFoyFNQN/WevQwIiJsEiHrCMick+Yk0gElVYxbD5</span></span><br><span class="line"><span class="string">vX4tqGkNoq5ZUEI+Q8u4LbATFpCm8CGPzrTVLEXyTWC1hMwi2EK6ZH0tWLKr+WdDGnVP2g</span></span><br><span class="line"><span class="string">nBxrbtJ8Thc1s9RK8tsnqHano6nZExJXspAFcvWgJjdO2wUgAAAMEA65BjaYXw1HKYdlqF</span></span><br><span class="line"><span class="string">mR5b5S+NfRahOBJv3fP80XdxTtdBQ5kdFJHlu1XW5Jh8DbySjSi6nKgsd9IVHoDIw4eVnS</span></span><br><span class="line"><span class="string">Z7umx1vTu03TdK9ZX98IDpeP75QkYB3xz9TjReY3H8WA9piBQVDdqcIIApUmvKhyxLNQOc</span></span><br><span class="line"><span class="string">weHZ0Nj8ZiaY9wfMz34kWYhv5ngSuMBG9ThE6XyvB8GGHUXU2wIwv/DlNllRYWO6CO0C7Z</span></span><br><span class="line"><span class="string">Q0vOUI3fcWb4oAunlrKOZDKMJhhQEHAAAAwQDVJMz09F0jYGr/PBk9pAnZSpQuZwlnsKjt</span></span><br><span class="line"><span class="string">gni/Gz2dxiVI1JtpfWhctoch92e40DUQEX0rvzPCZGdzHRE84IlTfjWDx4hzYw4+zLv2v3</span></span><br><span class="line"><span class="string">t+TMBTOleGuMNftrZCcQbWwVZPEtSTh1G7M5abthQcVZ+q3p+LM7zSHbB93LFSEccJF9EF</span></span><br><span class="line"><span class="string">tpiXz/yjPjNT05h52Jq0O3NxMG7LsHp4FxNx0X/5DXepnk0VGHqAZT9XmkKGRjXEWXfj9N</span></span><br><span class="line"><span class="string">AS8zTUHzSQchMAAAAdcm9vdEBjZW50b3M4Lndhbmd4aWFvY2h1bi5jb20BAgMEBQY=</span></span><br><span class="line"><span class="string">-----END OPENSSH PRIVATE KEY-----</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">[root@centos8 ~]#ssh-copy-id root@10.0.0.7</span></span><br><span class="line"><span class="string">/usr/bin/ssh-copy-id: INFO: Source of key(s) to be installed: </span></span><br><span class="line"><span class="string">&quot;/root/.ssh/id_rsa.pub&quot;</span></span><br><span class="line"><span class="string">The authenticity of host &#x27;</span>10.0.0.7 (10.0.0.7)<span class="string">&#x27; can&#x27;</span>t be established.</span><br><span class="line">ECDSA key fingerprint is SHA256:s//WMgPVXmOjqfOg3f3X0nmaPZF+Fj5vPdWCnAzDcpU.</span><br><span class="line">Are you sure you want to <span class="built_in">continue</span> connecting (<span class="built_in">yes</span>/no/[fingerprint])? <span class="built_in">yes</span></span><br><span class="line">/usr/bin/ssh-copy-id: INFO: attempting to <span class="built_in">log</span> <span class="keyword">in</span> with the new key(s), to filter </span><br><span class="line">out any that are already installed</span><br><span class="line">/usr/bin/ssh-copy-id: INFO: 1 key(s) remain to be installed -- <span class="keyword">if</span> you are </span><br><span class="line">prompted now it is to install the new keys</span><br><span class="line">root@10.0.0.7<span class="string">&#x27;s password: #输入远程用户的密码</span></span><br><span class="line"><span class="string">Number of key(s) added: 1</span></span><br><span class="line"><span class="string">Now try logging into the machine, with:   &quot;ssh &#x27;</span>10.0.0.7<span class="string">&#x27;&quot;</span></span><br><span class="line"><span class="string">and check to make sure that only the key(s) you wanted were added.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">[root@centos7 ~]#ll .ssh</span></span><br><span class="line"><span class="string">total 4</span></span><br><span class="line"><span class="string">-rw------- 1 root root 583 May 22 09:52 authorized_keys</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">[root@centos7 ~]#cat .ssh/authorized_keys </span></span><br><span class="line"><span class="string">ssh-rsa </span></span><br><span class="line"><span class="string">AAAAB3NzaC1yc2EAAAADAQABAAABgQDEIP+dPPpgsvL+RdPbHvv5w88jOiRTO8Jz2aMcnRDE5UCbBjjg</span></span><br><span class="line"><span class="string">b/qqOuNEaQDk+RFfCRtxdm4o+B1NqBmFBCXVDJIy/dNzF/XyoQC1JzyBo9/sfggpeE5w3tQpJKQAIeQK</span></span><br><span class="line"><span class="string">rBZ6VD/otAHB/MO9NfQP21yZsgB1qXyY+3vvM8Hrk6mJf+J4+shyLnLYfDH6m93f7fMXcgiz2h0IuG5W</span></span><br><span class="line"><span class="string">85vuMUK5XQKQNnB1Ev9QSkQWtRbhzJ2LRgyBPLeifGzeO9fsiNz9k9TWVPgx6WxaW3xZe/byipEBBs49</span></span><br><span class="line"><span class="string">tMRFw/5E73H90g0lzBBzw5hUmDK1uieG6wU4/b/alJzqRsXSvm7s8ompfv9Cqigvy14H4ev79Ywi2aSe</span></span><br><span class="line"><span class="string">YacJ25MCmAHtwYMS5/Q25aTobpQF2DM57nlRxHF+biVjYgaJzZ+6eOIUjLzobFLqBzPsMC7DggJWjzRY</span></span><br><span class="line"><span class="string">y2MY1NJX97xjrkTP6zNPdWTnRieTo6d+BaHzj92uVJp3FfbkTg5pNqlguXdEMYU=</span></span><br><span class="line"><span class="string">root@centos8.wangxiaochun.com</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">[root@centos8 ~]#ssh 10.0.0.7</span></span><br><span class="line"><span class="string">Last login: Fri May 22 08:43:50 2020 from 10.0.0.1</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">[root@centos7 ~]#exit</span></span><br><span class="line"><span class="string">logout</span></span><br><span class="line"><span class="string">Connection to 10.0.0.7 closed.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">[root@centos8 ~]#scp /etc/fstab 10.0.0.7:/data</span></span><br><span class="line"><span class="string">fstab </span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">#对私钥加密</span></span><br><span class="line"><span class="string">[root@centos8 ~]#ssh-keygen -p</span></span><br><span class="line"><span class="string">Enter file in which the key is (/root/.ssh/id_rsa): </span></span><br><span class="line"><span class="string">Key has comment &#x27;</span>root@centos8.wangxiaochun.com<span class="string">&#x27;</span></span><br><span class="line"><span class="string">Enter new passphrase (empty for no passphrase): </span></span><br><span class="line"><span class="string">Enter same passphrase again: </span></span><br><span class="line"><span class="string">Your identification has been saved with the new passphrase.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">[root@centos8 ~]#ssh 10.0.0.7</span></span><br><span class="line"><span class="string">Enter passphrase for key &#x27;</span>/root/.ssh/id_rsa<span class="string">&#x27;: #输入私钥的密码</span></span><br><span class="line"><span class="string">Last login: Fri May 22 08:47:50 2020 from 10.0.0.8</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">[root@centos7 ~]#exit</span></span><br><span class="line"><span class="string">logout</span></span><br><span class="line"><span class="string">Connection to 10.0.0.7 closed.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">#启用ssh代理</span></span><br><span class="line"><span class="string">[root@centos8 ~]#ssh-agent bash</span></span><br><span class="line"><span class="string">[root@centos8 ~]#ps aux|grep agent</span></span><br><span class="line"><span class="string">root       1972  0.0  0.0  29440   548 ?       Ss   10:18   0:00 ssh-agent bash</span></span><br><span class="line"><span class="string">root       1992  0.0  0.1  12108   964 pts/0   S+   10:18   0:00 grep --</span></span><br><span class="line"><span class="string">color=auto agent</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">[root@centos8 ~]#ssh-add</span></span><br><span class="line"><span class="string">Enter passphrase for /root/.ssh/id_rsa: </span></span><br><span class="line"><span class="string">Identity added: /root/.ssh/id_rsa (root@centos8.wangxiaochun.com)</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">[root@centos8 ~]#ssh 10.0.0.7</span></span><br><span class="line"><span class="string">Last login: Fri May 22 08:48:55 2020 from 10.0.0.8</span></span><br></pre></td></tr></table></figure>

<p>范例: 利用expect实现ssh key的批量部署</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">COLOR=<span class="string">&quot;echo -e \E[1;32m&quot;</span></span><br><span class="line">END=<span class="string">&quot;\E[0m&quot;</span></span><br><span class="line">PASSWORD=123456</span><br><span class="line">IPLIST=<span class="string">&quot;</span></span><br><span class="line"><span class="string">10.0.0.7</span></span><br><span class="line"><span class="string">10.0.0.17</span></span><br><span class="line"><span class="string">&quot;</span></span><br><span class="line"></span><br><span class="line">[ ! -f ~/.ssh/id_rsa ] &amp;&amp; ssh-keygen -P <span class="string">&quot;&quot;</span> -f ~/.ssh/id_rsa &amp;&gt;/dev/null</span><br><span class="line">rpm -q expect &amp;&gt; /dev/null || yum -y -q install expect &amp;&gt;/dev/null</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> ip <span class="keyword">in</span> <span class="variable">$IPLIST</span> ;<span class="keyword">do</span></span><br><span class="line">&#123;    </span><br><span class="line">expect &lt;&lt;<span class="string">EOF</span></span><br><span class="line"><span class="string">set timeout 60</span></span><br><span class="line"><span class="string">spawn ssh-copy-id $ip</span></span><br><span class="line"><span class="string">expect &#123;</span></span><br><span class="line"><span class="string">        &quot;yes/no&quot; &#123; send &quot;yes\r&quot;;exp_continue &#125;</span></span><br><span class="line"><span class="string">        &quot;password:&quot; &#123; send &quot;$PASSWORD\r&quot; &#125;</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">expect eof</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"><span class="variable">$COLOR</span><span class="string">&quot;<span class="variable">$ip</span> is ready&quot;</span><span class="variable">$END</span></span><br><span class="line">&#125;&amp;</span><br><span class="line"></span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"><span class="built_in">wait</span></span><br><span class="line"><span class="variable">$COLOR</span><span class="string">&quot;Push ssh key is finished!&quot;</span><span class="variable">$END</span></span><br></pre></td></tr></table></figure>

<p>范例：expect实现批量基于ssh的key部署</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ~]<span class="comment">#cat push_ssh_key.sh </span></span><br><span class="line"><span class="comment">#!/bin/bash</span></span><br><span class="line">PASS=magedu</span><br><span class="line">rpm -q expect &amp;&gt; /dev/null || yum -y install expect &amp;&gt; /dev/null</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [ ! -e /root/.ssh/id_rsa ];<span class="keyword">then</span></span><br><span class="line">   ssh-keygen  -t rsa -P <span class="string">&quot;&quot;</span> -f /root/.ssh/id_rsa &amp;&gt; /dev/null</span><br><span class="line">   <span class="built_in">echo</span> <span class="string">&quot;ssh key is created&quot;</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> <span class="built_in">read</span> IP ;<span class="keyword">do</span></span><br><span class="line">expect &amp;&gt; /dev/null &lt;&lt;<span class="string">EOF  #或者expect &lt;&lt;EOF</span>   &amp;&gt; /dev/null</span><br><span class="line"><span class="built_in">set</span> <span class="built_in">timeout</span> 20</span><br><span class="line">spawn ssh-copy-id -i /root/.ssh/id_rsa.pub root@<span class="variable">$IP</span></span><br><span class="line">expect &#123;</span><br><span class="line"><span class="string">&quot;yes/no&quot;</span> &#123; send <span class="string">&quot;yes\n&quot;</span>;exp_continue &#125;</span><br><span class="line"><span class="string">&quot;password&quot;</span> &#123; send <span class="string">&quot;<span class="variable">$PASS</span>\n&quot;</span> &#125;</span><br><span class="line">&#125;</span><br><span class="line">expect eof</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="variable">$IP</span> is ready</span><br><span class="line"><span class="keyword">done</span> &lt; hosts.txt</span><br><span class="line"></span><br><span class="line">[root@centos8 ~]<span class="comment">#cat hosts.txt </span></span><br><span class="line">10.0.0.7</span><br><span class="line">10.0.0.6</span><br><span class="line"></span><br><span class="line">[root@centos8 ~]<span class="comment">#bash push_ssh_key.sh </span></span><br><span class="line">ssh key is created</span><br><span class="line">10.0.0.7 is ready</span><br><span class="line">10.0.0.6 is ready</span><br><span class="line"></span><br><span class="line">[root@centos8 ~]<span class="comment">#ssh 10.0.0.7</span></span><br><span class="line">Last login: Fri May 22 10:19:35 2020 from 10.0.0.8</span><br><span class="line"></span><br><span class="line">[root@centos7 ~]<span class="comment">#exit</span></span><br><span class="line"><span class="built_in">logout</span></span><br><span class="line">Connection to 10.0.0.7 closed.</span><br><span class="line"></span><br><span class="line">[root@centos8 ~]<span class="comment">#ssh 10.0.0.6</span></span><br><span class="line">Last login: Fri May 22 10:19:39 2020 from 10.0.0.8</span><br><span class="line"></span><br><span class="line">[root@centos6 ~]<span class="comment">#exit</span></span><br><span class="line"><span class="built_in">logout</span></span><br><span class="line">Connection to 10.0.0.6 closed.</span><br></pre></td></tr></table></figure>

<p>范例：基于key验证实现批量主机管理</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ~]<span class="comment">#cat hosts.txt</span></span><br><span class="line">10.0.0.7</span><br><span class="line">10.0.0.6</span><br><span class="line"></span><br><span class="line">[root@centos8 ~]<span class="comment"># for i in `cat hosts.txt`;do ssh $i hostname -I ;done</span></span><br><span class="line">10.0.0.7</span><br><span class="line">10.0.0.6</span><br></pre></td></tr></table></figure>

<p><strong>范例：如何实现三个主机之间互相的key验证?</strong></p>
<h3 id="ssh服务器配置"><a href="#ssh服务器配置" class="headerlink" title="ssh服务器配置"></a>ssh服务器配置</h3><p>服务器端：sshd </p>
<p>服务器端的配置文件: /etc/ssh/sshd_config </p>
<p>服务器端的配置文件帮助：man 5 sshd_config </p>
<p>常用参数：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">Port  22                     <span class="comment">#生产建议修改</span></span><br><span class="line">ListenAddress ip</span><br><span class="line">LoginGraceTime 2m</span><br><span class="line">PermitRootLogin <span class="built_in">yes</span>          <span class="comment">#默认ubuntu不允许root远程ssh登录</span></span><br><span class="line">StrictModes <span class="built_in">yes</span>              <span class="comment">#检查.ssh/文件的所有者，权限等</span></span><br><span class="line">MaxAuthTries   6             <span class="comment">#pecifies the maximum number of authentication attempts permitted per connection. Once the number of failures reaches half this value, additional failures are logged. The default is 6.</span></span><br><span class="line">MaxSessions  10              <span class="comment">#同一个连接最大会话</span></span><br><span class="line">PubkeyAuthentication <span class="built_in">yes</span>     <span class="comment">#基于key验证</span></span><br><span class="line">PermitEmptyPasswords no      <span class="comment">#空密码连接</span></span><br><span class="line">PasswordAuthentication <span class="built_in">yes</span>   <span class="comment">#基于用户名和密码连接</span></span><br><span class="line">GatewayPorts no</span><br><span class="line">ClientAliveInterval 10       <span class="comment">#单位:秒</span></span><br><span class="line">ClientAliveCountMax 3        <span class="comment">#默认3</span></span><br><span class="line">UseDNS <span class="built_in">yes</span>                   <span class="comment">#提高速度可改为no</span></span><br><span class="line">GSSAPIAuthentication <span class="built_in">yes</span>     <span class="comment">#提高速度可改为no</span></span><br><span class="line">MaxStartups                  <span class="comment">#未认证连接最大值，默认值10</span></span><br><span class="line">Banner /path/file</span><br><span class="line"></span><br><span class="line"><span class="comment">#以下可以限制可登录用户的办法：</span></span><br><span class="line">AllowUsers user1 user2 user3</span><br><span class="line">DenyUsers user1 user2 user3</span><br><span class="line">AllowGroups g1 g2</span><br><span class="line">DenyGroups g1 g2</span><br></pre></td></tr></table></figure>

<p>范例：设置 ssh 空闲 60s 自动注销</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Vim /etc/ssh/sshd_config</span><br><span class="line">ClientAliveInterval   60</span><br><span class="line">ClientAliveCountMax   0</span><br><span class="line"></span><br><span class="line">Service sshd restart</span><br><span class="line"><span class="comment">#注意：新开一个连接才有效</span></span><br></pre></td></tr></table></figure>

<p>范例：解决ssh登录缓慢的问题</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/ssh/sshd_config</span><br><span class="line">UseDNS no</span><br><span class="line">GSSAPIAuthentication no</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">systemctl restart sshd</span><br></pre></td></tr></table></figure>

<p>范例：在 ubuntu 上启用 root 远程ssh登录</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#修改sshd服务配置文件</span></span><br><span class="line">vim /etc/ssh/sshd_config </span><br><span class="line"><span class="comment">#PermitRootLogin prohibit-password 注释掉此行</span></span><br><span class="line">PermitRootLogin <span class="built_in">yes</span> 修改为下面形式</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">systemctl restart sshd</span><br></pre></td></tr></table></figure>

<p><strong>ssh 服务的最佳实践</strong></p>
<ul>
<li>建议使用非默认端口</li>
<li>禁止使用protocol version 1</li>
<li>限制可登录用户</li>
<li>设定空闲会话超时时长</li>
<li>利用防火墙设置ssh访问策略</li>
<li>仅监听特定的IP地址</li>
<li>基于口令认证时，使用强密码策略，比如：<code>tr -dc A-Za-z0-9_ &lt; /dev/urandom | head -c 12| xargs</code></li>
<li>使用基于密钥的认证</li>
<li>禁止使用空密码</li>
<li>禁止root用户直接登录</li>
<li>限制ssh的访问频度和并发在线数</li>
<li>经常分析日志</li>
</ul>
<h1 id="利用-sudo-实现授权"><a href="#利用-sudo-实现授权" class="headerlink" title="利用 sudo 实现授权"></a>利用 sudo 实现授权</h1><h2 id="sudo-介绍"><a href="#sudo-介绍" class="headerlink" title="sudo 介绍"></a>sudo 介绍</h2><p><img src="../../../../images/SRE/day15/44.png" alt="44"></p>
<p>sudo 即superuser do，允许系统管理员让普通用户执行一些或者全部的root命令的一个工具，如halt，reboot，su等等。这样不仅减少了root用户的登录和管理时间，同样也提高了安全性</p>
<p>在最早之前，一般用户管理系统的方式是利用su切换为超级用户。但是使用su的缺点之一在于必须要先告知超级用户的密码。sudo于1980年前后推出，sudo使一般用户不需要知道超级用户的密码即可获得权限。首先超级用户将普通用户的名字、可以执行的特定命令、按照哪种用户或用户组的身份执行等信息，登记在特殊的文件中（通常是/etc/sudoers），即完成对该用户的授权（此时该用户称为 “sudoer”）；在一般用户需要取得特殊权限时，其可在命令前加上“sudo”，此时sudo将会询问该用户自己的密码（以确认终端机前的是该用户本人），回答后系统即会将该命令的进程以超级用户的权限运行。之后的一段时间内（默认为5分钟，可在/etc/sudoers自定义），使用sudo不需要再次输入密码。</p>
<p>由于不需要超级用户的密码，部分Unix系统甚至利用sudo使一般用户取代超级用户作为管理帐号，例如 Ubuntu、Mac OS X等。</p>
<p>sudo特性：</p>
<ul>
<li>sudo能够授权指定用户在指定主机上运行某些命令。如果未授权用户尝试使用 sudo，会提示联系管理员</li>
<li>sudo提供了丰富的日志，详细地记录了每个用户干了什么。它能够将日志传到中心主机或者日志服务器</li>
<li>sudo使用时间戳文件来执行类似的“检票”系统。当用户调用sudo并且输入它的密码时，用户获得了一张存活期为5分钟的票</li>
<li>sudo的配置文件是sudoers文件，它允许系统管理员集中的管理用户的使用权限和使用的主机。它所存放的位置默认是在/etc/sudoers，属性必须为0440</li>
</ul>
<h2 id="sudo-组成"><a href="#sudo-组成" class="headerlink" title="sudo 组成"></a>sudo 组成</h2><p>包：sudo </p>
<p>配置文件：/etc/sudo.conf</p>
<p>授权规则配置文件：</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">/etc/sudoers</span><br><span class="line">/etc/sudoers.d</span><br></pre></td></tr></table></figure>

<p>安全编辑授权规则文件和语法检查工具</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/usr/sbin/visudo</span><br></pre></td></tr></table></figure>

<p>范例：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#检查语法</span></span><br><span class="line">visudo -c</span><br><span class="line"></span><br><span class="line"><span class="comment">#检查指定配置文件语法</span></span><br><span class="line">visudo -f /etc/sudoers.d/test</span><br></pre></td></tr></table></figure>

<p>授权编辑规则文件的工具：/usr/bin/sudoedit</p>
<p>执行授权命令：/usr/bin/sudo</p>
<p>时间戳文件：/var/db/sudo</p>
<p>日志文件：/var/log/secure</p>
<h2 id="sudo-命令"><a href="#sudo-命令" class="headerlink" title="sudo 命令"></a>sudo 命令</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">sudo命令</span><br><span class="line"><span class="built_in">ls</span> -l /usr/bin/sudo</span><br><span class="line">sudo -i -u wang 切换身份功能和 su 相似,但不一样,sudo必须提前授权,而且要输入自已的密码</span><br><span class="line">sudo [-u user] COMMAND </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">-V                    显示版本信息等配置信息</span><br><span class="line">-u user               指定代表的用户，默认为root</span><br><span class="line">-l,ll                 列出用户在主机上可用的和被禁止的命令</span><br><span class="line">-v                    再延长密码有效期限5分钟,更新时间戳</span><br><span class="line">-k                    清除时间戳（1970-01-01），下次需要重新输密码</span><br><span class="line">-K                    与-k类似，还要删除时间戳文件</span><br><span class="line">-b                    在后台执行指令</span><br><span class="line">-p                    改变询问密码的提示符号</span><br><span class="line"></span><br><span class="line">示例：-p <span class="string">&quot;password on %h for user %p: &quot;</span></span><br></pre></td></tr></table></figure>

<h2 id="sudo-授权规则配置"><a href="#sudo-授权规则配置" class="headerlink" title="sudo 授权规则配置"></a>sudo 授权规则配置</h2><p>配置文件格式说明：/etc/sudoers, /etc/sudoers.d/ </p>
<p>配置文件中支持使用通配符 glob</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">?                 任意单一字符</span><br><span class="line">*                 匹配任意长度字符</span><br><span class="line">[wxc]             匹配其中一个字符</span><br><span class="line">[!wxc]            除了这三个字符的其它字符</span><br><span class="line">\x                转义 </span><br><span class="line">[[alpha]]         字母  </span><br></pre></td></tr></table></figure>

<p>范例：</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/bin/ls [[alpha]]*</span><br></pre></td></tr></table></figure>

<p>配置文件规则有两类</p>
<p>1、别名定义：不是必须的 </p>
<p>2、授权规则：必须的 </p>
<p>sudoers 授权规则格式：</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">用户 登入主机=(代表用户) 命令</span><br><span class="line">user host=(runas) command</span><br></pre></td></tr></table></figure>

<p>范例：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">root ALL=(ALL) ALL</span><br></pre></td></tr></table></figure>

<p>格式说明：</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">user</span><span class="punctuation">: </span>         运行命令者的身份</span><br><span class="line"><span class="attribute">host</span><span class="punctuation">: </span>         通过哪些主机</span><br><span class="line">(runas)：      以哪个用户的身份</span><br><span class="line"><span class="attribute">command</span><span class="punctuation">: </span>      运行哪些命令</span><br></pre></td></tr></table></figure>

<p>sudoers的别名</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">User和runas: </span><br><span class="line">    username</span><br><span class="line">    <span class="comment">#uid</span></span><br><span class="line">    %group_name</span><br><span class="line">    %<span class="comment">#gid</span></span><br><span class="line">    user_alias|runas_alias</span><br><span class="line">host:</span><br><span class="line">    ip或hostname</span><br><span class="line">    network(/netmask) </span><br><span class="line">    host_alias</span><br><span class="line"><span class="built_in">command</span>:</span><br><span class="line">    <span class="built_in">command</span> name</span><br><span class="line">    directory /sbin/</span><br><span class="line">    sudoedit</span><br><span class="line">    Cmnd_Alias</span><br></pre></td></tr></table></figure>

<p>sudo别名有四种类型：</p>
<ul>
<li>User_Alias </li>
<li>Runas_Alias</li>
<li>Host_Alias </li>
<li>Cmnd_Alias</li>
</ul>
<p>别名格式：</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[A-Z]([A-Z][0-9]_)*</span><br></pre></td></tr></table></figure>

<p>别名定义：</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Alias_Type NAME1 = item1,item2,item3 : NAME2 = item4, item5</span><br></pre></td></tr></table></figure>

<h2 id="实战案例"><a href="#实战案例" class="headerlink" title="实战案例"></a>实战案例</h2><p>案例：</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Student  ALL=(ALL)   ALL</span><br><span class="line">%wheel   ALL=(ALL)   ALL</span><br></pre></td></tr></table></figure>

<p>案例：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">student ALL=(root)   /sbin/pidof,/sbin/ifconfig</span><br><span class="line">%wheel ALL=(ALL) NOPASSWD: ALL</span><br></pre></td></tr></table></figure>

<p>案例</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">[root@centos7 ~]<span class="comment"># groupmems -a wang -g wheel</span></span><br><span class="line">[root@centos7 ~]<span class="comment"># id wang</span></span><br><span class="line">uid=1000(wang) gid=1000(wang) <span class="built_in">groups</span>=1000(wang),10(wheel)</span><br><span class="line"></span><br><span class="line">[root@centos7 ~]<span class="comment"># su - wang</span></span><br><span class="line">Last login: Fri Jan 29 19:32:37 CST 2021 on pts/0</span><br><span class="line"></span><br><span class="line"><span class="comment">#下面方式失败</span></span><br><span class="line">[wang@centos7 ~]<span class="variable">$sudo</span> <span class="built_in">echo</span> 1.2.3.4 www.test.com &gt;&gt; /etc/hosts</span><br><span class="line">-bash: /etc/hosts: Permission denied</span><br><span class="line"></span><br><span class="line"><span class="comment">#用下面方式可以实现</span></span><br><span class="line"><span class="comment">#bash -c 将后面所有信字符串作为整体进行sudo</span></span><br><span class="line"><span class="comment">#注意&quot;&quot;必须加,否则只授权 &gt;&gt; 前面的命令sudo </span></span><br><span class="line">[wang@centos7 ~]<span class="variable">$sudo</span> bash  -c <span class="string">&quot;echo 1.2.3.4 www.test.com &gt;&gt; /etc/hosts&quot;</span></span><br><span class="line">[wang@centos7 ~]<span class="variable">$cat</span> /etc/hosts</span><br><span class="line">127.0.0.1   localhost localhost.localdomain localhost4 localhost4.localdomain4 centos7.wangxiaochun.com</span><br><span class="line">::1         localhost localhost.localdomain localhost6 localhost6.localdomain6 1.2.3.4 www.test.com</span><br></pre></td></tr></table></figure>

<p>案例：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">User_Alias  NETADMIN= netuser1,netuser2</span><br><span class="line">Cmnd_Alias NETCMD = /usr/sbin/ip,/usr/sbin/ifconfig</span><br><span class="line">NETADMIN ALL=（root） NETCMD</span><br></pre></td></tr></table></figure>

<p>案例：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">User_Alias SYSADER=wang,mage,%admins </span><br><span class="line">User_Alias DISKADER=tom</span><br><span class="line">Host_Alias SERS=www.magedu.com,172.16.0.0/24</span><br><span class="line">Runas_Alias OP=root </span><br><span class="line">Cmnd_Alias SYDCMD=/bin/chown,/bin/chmod </span><br><span class="line">Cmnd_Alias DSKCMD=/sbin/parted,/sbin/fdisk  </span><br><span class="line">SYSADER SERS=SYDCMD,DSKCMD </span><br><span class="line">DISKADER ALL=(OP) DSKCMD </span><br></pre></td></tr></table></figure>

<p>案例：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">User_Alias ADMINUSER = adminuser1,adminuser2</span><br><span class="line">Cmnd_Alias ADMINCMD = /usr/sbin/useradd，/usr/sbin/usermod, /usr/bin/passwd [a-zA-Z]*, !/usr/bin/passwd root</span><br><span class="line">ADMINUSER ALL=(root) NOPASSWD:ADMINCMD，PASSWD:/usr/sbin/userdel</span><br></pre></td></tr></table></figure>

<p>案例：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Defaults:wang runas_default=tom</span><br><span class="line">wang ALL=(tom,jerry) ALL</span><br><span class="line"></span><br><span class="line">wang$ sudo cmd  <span class="comment">#默认代表tom执行cmd</span></span><br><span class="line">wang$ sudo -u jerry cmd</span><br></pre></td></tr></table></figure>

<p>案例：</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wang 192.168.1.6,192.168.1.8=(root) /usr/sbin/,!/usr/sbin/useradd</span><br></pre></td></tr></table></figure>

<p>案例8：如何解决?</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">wang   ALL=(ALL) /bin/cat /var/log/messages* </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@centos8 ~]<span class="comment"># man sudoers</span></span><br><span class="line">will allow <span class="built_in">command</span> like:</span><br><span class="line">   $ sudo <span class="built_in">cat</span> /var/log/messages.1</span><br><span class="line">It will also allow:</span><br><span class="line">   $ sudo <span class="built_in">cat</span> /var/log/messages /etc/shadow</span><br></pre></td></tr></table></figure>

<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wang   ALL=(ALL) /bin/cat -- /var/log/messages*</span><br></pre></td></tr></table></figure>

<p>案例：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ~]<span class="comment"># vim /etc/sudoers.d/test</span></span><br><span class="line">Wang ALL=(ALL) sudoedit</span><br><span class="line"></span><br><span class="line"><span class="comment">#wang 可以执行下面命令</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># sudoedit /etc/sudoers</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># sudoedit /etc/sudoers.d/test</span></span><br></pre></td></tr></table></figure>

<p>案例：修改验证密码间隔为2分钟</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ~]<span class="comment"># vim /etc/sudoers</span></span><br><span class="line">Defaults   env_reset , timestamp_timeout=2</span><br><span class="line"></span><br><span class="line">[root@centos8 ~]<span class="comment"># sudo -V</span></span><br><span class="line">......</span><br><span class="line">Authentication timestamp <span class="built_in">timeout</span>: 2.0 minutes......</span><br></pre></td></tr></table></figure>

<p>范例：ubuntu 默认用户具有sudo权限</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">root@ubuntu1804:~<span class="comment"># grep %sudo /etc/sudoers</span></span><br><span class="line">%sudo ALL=(ALL:ALL) ALL</span><br><span class="line"></span><br><span class="line">root@ubuntu1804:~<span class="comment"># id wang</span></span><br><span class="line">uid=1000(wang) gid=1000(wang) </span><br><span class="line"><span class="built_in">groups</span>=1000(wang),4(adm),24(cdrom),27(sudo),30(dip),46(plugdev),108(lxd),113(lpadmin),114(sambashare)</span><br><span class="line"></span><br><span class="line"><span class="comment">#默认的用户wang 属于此sudo组，所以wang有所有权限</span></span><br></pre></td></tr></table></figure>

<p>范例: 修改ubuntu的visudo的默认编辑器</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">root@ubuntu1804:~<span class="comment"># export EDITOR=vim </span></span><br><span class="line">root@ubuntu1804:~<span class="comment"># visudo </span></span><br></pre></td></tr></table></figure>

<p>范例：删除时间戳文件</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ~]<span class="comment">#su - wang</span></span><br><span class="line">Last login: Mon May 25 10:28:14 CST 2020 on pts/1</span><br><span class="line">[wang@centos8 ~]<span class="variable">$sudo</span> -K</span><br><span class="line">[wang@centos8 ~]<span class="variable">$exit</span></span><br><span class="line"><span class="built_in">logout</span></span><br><span class="line"></span><br><span class="line">[root@centos8 ~]<span class="comment">#ll /run/sudo/ts</span></span><br><span class="line">total 4</span><br><span class="line">-rw------- 1 root mage 112 May 25 10:11 mage</span><br><span class="line"></span><br><span class="line">[root@centos8 ~]<span class="comment">#file /run/sudo/ts/mage</span></span><br><span class="line">/run/sudo/ts/mage: data</span><br></pre></td></tr></table></figure>

<p>范例：修改sudo 提示符格式</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[wang@centos8 ~]$ sudo  <span class="built_in">cat</span> /var/log/messages</span><br><span class="line">[sudo] password <span class="keyword">for</span> wang: </span><br><span class="line"></span><br><span class="line">[wang@centos8 ~]$ sudo -p <span class="string">&quot;password on %h for user %p: &quot;</span> <span class="built_in">cat</span> /var/log/messages</span><br><span class="line">password on centos8 <span class="keyword">for</span> user wang:</span><br></pre></td></tr></table></figure>

<h1 id="PAM认证机制"><a href="#PAM认证机制" class="headerlink" title="PAM认证机制"></a>PAM认证机制</h1><h2 id="PAM-介绍"><a href="#PAM-介绍" class="headerlink" title="PAM 介绍"></a>PAM 介绍</h2><p>认证库：文本文件，MySQL，NIS，LDAP等</p>
<p>PAM：Pluggable Authentication Modules，插件式的验证模块，Sun公司于1995 年开发的一种与认证相关的通用框架机制。PAM 只关注如何为服务验证用户的 API，通过提供一些动态链接库和一套统一的 API，将系统提供的服务和该服务的认证方式分开，使得系统管理员可以灵活地根据需要给不同的服务配置不同的认证方式而无需更改服务程序一种认证框架，自身不做认证</p>
<p>官网:</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://www.linux-pam.org/</span><br></pre></td></tr></table></figure>

<h2 id="PAM架构"><a href="#PAM架构" class="headerlink" title="PAM架构"></a>PAM架构</h2><p><img src="../../../../images/SRE/day15/45.png" alt="45"></p>
<p>PAM提供了对所有服务进行认证的中央机制，适用于本地登录，远程登录，如：telnet,rlogin,fsh,ftp,点对点协议PPP，su等应用程序中，系统管理员通过PAM配置文件来制定不同应用程序的不同认证策略；应用程序开发者通过在服务程序中使用PAM API(pam_xxxx( ))来实现对认证方法的调用；而PAM服务模块的开发者则利用PAM SPI来编写模块（主要调用函数pam_sm_xxxx( )供PAM接口库调用，将不同的认证机制加入到系统中；PAM接口库（libpam）则读取配置文件，将应用程序和相应的PAM服务模块联系起来</p>
<h2 id="PAM相关文件"><a href="#PAM相关文件" class="headerlink" title="PAM相关文件"></a>PAM相关文件</h2><ul>
<li>包名: pam</li>
<li>模块文件目录：/lib64/security/*.so</li>
<li>特定模块相关的设置文件：/etc/security/</li>
<li>应用程序调用PAM模块的配置文件 <ul>
<li>主配置文件：/etc/pam.conf，默认不存在，一般不使用主配置 </li>
<li>为每种应用模块提供一个专用的配置文件：/etc/pam.d/APP_NAME</li>
<li>注意：如/etc/pam.d存在，/etc/pam.conf将失效</li>
</ul>
</li>
</ul>
<p>范例：查看程序是否支持PAM</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ~]<span class="comment">#ldd `which sshd` |grep libpam</span></span><br><span class="line"> libpam.so.0 =&gt; /lib64/libpam.so.0 (0x00007fea8e70d000)</span><br><span class="line"> </span><br><span class="line">[root@centos8 ~]<span class="comment">#ldd `which passwd` |grep pam</span></span><br><span class="line"> libpam.so.0 =&gt; /lib64/libpam.so.0 (0x00007f045b805000)</span><br><span class="line"> libpam_misc.so.0 =&gt; /lib64/libpam_misc.so.0 (0x00007f045b601000)</span><br><span class="line"> </span><br><span class="line"><span class="comment">#不支持PAM</span></span><br><span class="line">[root@centos6 ~]<span class="comment">#ldd /usr/sbin/httpd |grep pam</span></span><br></pre></td></tr></table></figure>

<h2 id="PAM工作原理"><a href="#PAM工作原理" class="headerlink" title="PAM工作原理"></a>PAM工作原理</h2><p>PAM认证一般遵循这样的顺序：Service(服务)→PAM(配置文件)→pam_*.so</p>
<p>PAM认证首先要确定那一项服务，然后加载相应的PAM的配置文件(位于/etc/pam.d下)，最后调用认证文件(位于/lib64/security下)进行安全认证</p>
<p><img src="../../../../images/SRE/day15/46.png" alt="46"></p>
<p>PAM认证过程示例：</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">1.使用者执行/usr/bin/passwd 程序，并输入密码</span><br><span class="line">2.passwd开始调用PAM模块，PAM模块会搜寻passwd程序的PAM相关设置文件，这个设置文件一般是</span><br><span class="line">在/etc/pam.d/里边的与程序同名的文件，即PAM会搜寻/etc/pam.d/passwd此设置文件</span><br><span class="line">3.经由/etc/pam.d/passwd设定文件的数据，取用PAM所提供的相关模块来进行验证</span><br><span class="line">4.将验证结果回传给passwd这个程序，而passwd这个程序会根据PAM回传的结果决定下一个动作（重新输入密码或者通过验证）</span><br></pre></td></tr></table></figure>

<h2 id="PAM-配置文件格式说明"><a href="#PAM-配置文件格式说明" class="headerlink" title="PAM 配置文件格式说明"></a>PAM 配置文件格式说明</h2><p>通用配置文件/etc/pam.conf格式,此格式不使用</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">application type control module-path arguments</span><br></pre></td></tr></table></figure>

<p>专用配置文件/etc/pam.d/ 格式</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">type control module-path arguments</span><br></pre></td></tr></table></figure>

<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">application：指服务名，如：telnet、login、ftp等，服务名字“OTHER”代表所有没有在该文件中明确配置的其它服务</span><br><span class="line">type：指模块类型，即功能</span><br><span class="line">control ：PAM库该如何处理与该服务相关的PAM模块的成功或失败情况，一个关健词实现</span><br><span class="line">module-path： 用来指明本模块对应的程序文件的路径名</span><br><span class="line">Arguments： 用来传递给该模块的参数</span><br></pre></td></tr></table></figure>

<p><strong>模块类型（module-type）</strong></p>
<ul>
<li>Auth 账号的认证和授权</li>
<li>Account 帐户的有效性，与账号管理相关的非认证类的功能，如：用来限制/允许用户对某个服务的访问时间，限制用户的位置(例如：root用户只能从控制台登录) </li>
<li>Password 用户修改密码时密码复杂度检查机制等功能</li>
<li>Session 用户会话期间的控制，如：最多打开的文件数，最多的进程数等 </li>
<li>-type 表示因为缺失而不能加载的模块将不记录到系统日志,对于那些不总是安装在系统上的模块有用 </li>
</ul>
<p><strong>Control:</strong> </p>
<ul>
<li>required ：一票否决，表示本模块必须返回成功才能通过认证，但是如果该模块返回失败，失败结果也不会立即通知用户，而是要等到同一type中的所有模块全部执行完毕，再将失败结果返回给应用程序，即为必要条件</li>
<li>requisite ：一票否决，该模块必须返回成功才能通过认证，但是一旦该模块返回失败，将不再执行同一type内的任何模块，而是直接将控制权返回给应用程序。是一个必要条件</li>
<li>sufficient ：一票通过，表明本模块返回成功则通过身份认证的要求，不必再执行同一type内的其它模块，但如果本模块返回失败可忽略，即为充分条件，优先于前面的required和requisite</li>
<li>optional ：表明本模块是可选的，它的成功与否不会对身份认证起关键作用，其返回值一般被忽略</li>
<li>include： 调用其他的配置文件中定义的配置信息 </li>
</ul>
<p><strong>module-path:</strong> </p>
<ul>
<li>模块文件所在绝对路径： </li>
<li>模块文件所在相对路径：/lib64/security目录下的模块可使用相对路径，如：pam_shells.so、 pam_limits.so</li>
<li>有些模块有自已的专有配置文件，在/etc/security/*.conf目录下</li>
</ul>
<p>**Arguments  **</p>
<ul>
<li>debug ：该模块应当用syslog( )将调试信息写入到系统日志文件中 </li>
<li>no_warn ：表明该模块不应把警告信息发送给应用程序 </li>
<li>use_first_pass ：该模块不能提示用户输入密码，只能从前一个模块得到输入密码 </li>
<li>try_first_pass ：该模块首先用前一个模块从用户得到密码，如果该密码验证不通过，再提示用户输入新密码 </li>
<li>use_mapped_pass 该模块不能提示用户输入密码，而是使用映射过的密码 </li>
<li>expose_account 允许该模块显示用户的帐号名等信息，一般只能在安全的环境下使用，因为泄漏用户名会对安全造成一定程度的威胁 </li>
</ul>
<p>注意：修改PAM配置文件将马上生效 </p>
<p>建议：编辑pam规则时，保持至少打开一个root会话，以防止root身份验证错误</p>
<h2 id="PAM模块帮助"><a href="#PAM模块帮助" class="headerlink" title="PAM模块帮助"></a>PAM模块帮助</h2><p>官方在线文档：<a target="_blank" rel="noopener" href="http://www.linux-pam.org/Linux-PAM-html/">http://www.linux-pam.org/Linux-PAM-html/</a> </p>
<p>官方离线文档：<a target="_blank" rel="noopener" href="http://www.linux-pam.org/documentation/">http://www.linux-pam.org/documentation/</a></p>
<p>pam模块文档说明：/user/share/doc/pam-* </p>
<p>rpm -qd pam </p>
<p>man -k pam_ </p>
<p>man 模块名 如：man 8 rootok</p>
<h2 id="常用PAM模块"><a href="#常用PAM模块" class="headerlink" title="常用PAM模块"></a>常用PAM模块</h2><h3 id="pam-nologin-so-模块"><a href="#pam-nologin-so-模块" class="headerlink" title="pam_nologin.so 模块"></a>pam_nologin.so 模块</h3><p>功能：如果/etc/nologin文件存在,将导致非root用户不能登陆,当该用户登陆时，会显示/etc/nologin文件内容，并拒绝登陆 </p>
<p>范例: 默认此模块可以对ssh等登录有效,但不影响su登录</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 pam.d]<span class="comment">#grep pam_nologin *</span></span><br><span class="line">login:account    required     pam_nologin.so</span><br><span class="line">remote:account   required     pam_nologin.so</span><br><span class="line">sshd:account     required     pam_nologin.so</span><br></pre></td></tr></table></figure>

<h3 id="pam-limits-so-模块"><a href="#pam-limits-so-模块" class="headerlink" title="pam_limits.so 模块"></a>pam_limits.so 模块</h3><p>功能：在用户级别实现对其可使用的资源的限制，例如：可打开的文件数量，可运行的进程数量，可用内存空间</p>
<p><img src="../../../../images/SRE/day15/47.png" alt="47"></p>
<p>修改限制的实现方式：</p>
<p>(1) ulimit命令</p>
<p>ulimit是linux shell的内置命令，它具有一套参数集，用于对shell进程及其子进程进行资源限制。 </p>
<p>ulimit的设定值是 per-process 的，也就是说，每个进程有自己的limits值。 </p>
<p>使用ulimit进行修改，立即生效。 </p>
<p>ulimit只影响shell进程及其子进程，用户登出后失效。 </p>
<p>可以在profile中加入ulimit的设置，变相的做到永久生效。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">-H               设置硬件资源限制.</span><br><span class="line">-S               设置软件资源限制.</span><br><span class="line">-a               显示当前所有的资源限制.</span><br><span class="line">-c size:         设置core文件的最大值.单位:blocks</span><br><span class="line">-d size:         设置数据段的最大值.单位:kbytes</span><br><span class="line">-f size:         设置创建文件的最大值.单位:blocks</span><br><span class="line">-l size:         设置在内存中锁定进程的最大值.单位:kbytes</span><br><span class="line">-m size:         设置可以使用的常驻内存的最大值.单位:kbytes</span><br><span class="line">-n size:         设置内核可以同时打开的文件描述符的最大值.单位:n</span><br><span class="line">-p size:         设置管道缓冲区的最大值.单位:kbytes</span><br><span class="line">-s size:         设置堆栈的最大值.单位:kbytes</span><br><span class="line">-t size:         设置CPU使用时间的最大上限.单位:seconds</span><br><span class="line">-u size:         最大用户进程数</span><br><span class="line">-v size:         设置虚拟内存的最大值.单位:kbytes</span><br><span class="line">unlimited        是一个特殊值，用于表示不限制</span><br><span class="line"></span><br><span class="line"><span class="comment">#说明</span></span><br><span class="line">查询时，若不加H或S参数，默认显示的是软限制</span><br><span class="line">修改时，若不加H或S参数，两个参数一起改变</span><br></pre></td></tr></table></figure>

<p>(2) 配置文件： </p>
<p>pam_limits的设定值是基于 per-process 的</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">/etc/security/limits.conf</span><br><span class="line">/etc/security/limits.d/*.conf</span><br></pre></td></tr></table></figure>

<p>配置文件格式：</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">#每行一个定义</span><br><span class="line">&lt;domain&gt;       &lt;type&gt; &lt;item&gt; &lt;value&gt;</span><br></pre></td></tr></table></figure>

<p>格式说明： </p>
<p>应用于哪些对象</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Username 单个用户</span><br><span class="line">@group 组内所有用户</span><br><span class="line">* 所有用户</span><br><span class="line">% 仅用于限制 maxlogins limit , 可以使用 %group 语法. 只用 % 相当于 * 对所有用户</span><br><span class="line">maxsyslogins limit限制. %group 表示限制此组中的所有用户总的最大登录数</span><br></pre></td></tr></table></figure>

<p>限制的类型</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Soft 软限制,普通用户自己可以修改</span><br><span class="line">Hard 硬限制,由root用户设定，且通过kernel强制生效</span><br><span class="line">-    二者同时限定</span><br></pre></td></tr></table></figure>

<p>限制的资源</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">nofile 所能够同时打开的最大文件数量,默认为1024</span><br><span class="line">nproc 所能够同时运行的进程的最大数量,默认为1024</span><br></pre></td></tr></table></figure>

<p>指定具体值 </p>
<p>注意：systemd 的service 资源设置需要单独配置</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"># /etc/security/limits.conf</span><br><span class="line">#</span><br><span class="line">#This file sets the resource limits for the users logged in via PAM.</span><br><span class="line">#It does not affect resource limits of the system services.</span><br><span class="line">在Centos7以上版本中，使用Systemd替代了之前的SysV。/etc/security/limits.conf文件的配置作</span><br><span class="line">用域缩小了。/etc/security/limits.conf的配置，只适用于通过PAM认证登录用户的资源限制，它对</span><br><span class="line">systemd的service的资源限制不生效。因此登录用户的限制，通过/etc/security/limits.conf</span><br><span class="line">与/etc/security/limits.d下的文件设置即可。</span><br><span class="line"></span><br><span class="line">对于systemd service的资源设置，则需修改全局配置，全局配置文件放在/etc/systemd/system.conf</span><br><span class="line">和/etc/systemd/user.conf，同时也会加载两个对应目录中的所有.conf文</span><br><span class="line">件/etc/systemd/system.conf.d/*.conf和/etc/systemd/user.conf.d/*.conf。system.conf</span><br><span class="line">是系统实例使用的，user.conf是用户实例使用的。</span><br><span class="line"></span><br><span class="line">vim /etc/systemd/system.conf</span><br><span class="line">DefaultLimitNOFILE=100000</span><br><span class="line">DefaultLimitNPROC=65535</span><br><span class="line">或者针对指定的service添加下面行</span><br><span class="line">[Service]</span><br><span class="line">LimitNOFILE=100000</span><br><span class="line">LimitNPROC=65535</span><br></pre></td></tr></table></figure>

<p>案例：系统的各种资源的默认值</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ~]<span class="comment">#ulimit -a</span></span><br><span class="line">core file size          (blocks, -c) unlimited</span><br><span class="line">data seg size           (kbytes, -d) unlimited</span><br><span class="line">scheduling priority             (-e) 0</span><br><span class="line">file size               (blocks, -f) unlimited</span><br><span class="line">pending signals                 (-i) 3059</span><br><span class="line">max locked memory       (kbytes, -l) 16384</span><br><span class="line">max memory size         (kbytes, -m) unlimited</span><br><span class="line">open files                      (-n) 1024</span><br><span class="line">pipe size            (512 bytes, -p) 8</span><br><span class="line">POSIX message queues     (bytes, -q) 819200</span><br><span class="line">real-time priority              (-r) 0</span><br><span class="line">stack size              (kbytes, -s) 8192</span><br><span class="line">cpu time               (seconds, -t) unlimited</span><br><span class="line">max user processes              (-u) 3059</span><br><span class="line">virtual memory          (kbytes, -v) unlimited</span><br><span class="line">file locks                      (-x) unlimited</span><br></pre></td></tr></table></figure>

<p>案例： 查看指定进程的资源限制</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#cat /proc/PID/limits</span></span><br><span class="line">[root@wang-liyun-pc ~]<span class="comment"># cat /proc/`pidof nginx | xargs -n1 | sort -n|head -1`/limits</span></span><br><span class="line">Limit                     Soft Limit           Hard Limit           Units     </span><br><span class="line">Max cpu time             unlimited           unlimited           seconds   </span><br><span class="line">Max file size             unlimited           unlimited           bytes     </span><br><span class="line">Max data size             unlimited           unlimited           bytes     </span><br><span class="line">Max stack size            8388608             unlimited           bytes     </span><br><span class="line">Max core file size        0                   unlimited           bytes     </span><br><span class="line">Max resident <span class="built_in">set</span>         unlimited           unlimited           bytes     </span><br><span class="line">Max processes             7270                 7270                 processes </span><br><span class="line">Max open files            65535                65535               files     </span><br><span class="line">Max locked memory         65536                65536               bytes     </span><br><span class="line">Max address space         unlimited           unlimited           bytes     </span><br><span class="line">Max file locks           unlimited           unlimited           locks     </span><br><span class="line">Max pending signals       7270                 7270                 signals   </span><br><span class="line">Max msgqueue size         819200               819200               bytes     </span><br><span class="line">Max <span class="built_in">nice</span> priority         0                    0                    </span><br><span class="line">Max realtime priority     0                    0                    </span><br><span class="line">Max realtime <span class="built_in">timeout</span>     unlimited           unlimited           us  </span><br></pre></td></tr></table></figure>

<p>案例：ulimit 命令修改用户打开的文件个数</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ~]<span class="comment">#ulimit -n</span></span><br><span class="line">1024</span><br><span class="line"></span><br><span class="line">[root@centos8 ~]<span class="comment">#ulimit -n 1048577</span></span><br><span class="line">-bash: <span class="built_in">ulimit</span>: open files: cannot modify <span class="built_in">limit</span>: Operation not permitted</span><br><span class="line"></span><br><span class="line">[root@centos8 ~]<span class="comment">#ulimit -n 1048576</span></span><br><span class="line">[root@centos8 ~]<span class="comment">#ulimit -a</span></span><br><span class="line">core file size         (blocks, -c) unlimited</span><br><span class="line">data seg size           (kbytes, -d) unlimited</span><br><span class="line">scheduling priority             (-e) 0</span><br><span class="line">file size               (blocks, -f) unlimited</span><br><span class="line">pending signals                 (-i) 7111</span><br><span class="line">max locked memory       (kbytes, -l) 16384</span><br><span class="line">max memory size         (kbytes, -m) unlimited</span><br><span class="line">open files                     (-n) 1048576</span><br><span class="line">pipe size           (512 bytes, -p) 8</span><br><span class="line">POSIX message queues     (bytes, -q) 819200</span><br><span class="line">real-time priority             (-r) 0</span><br><span class="line">stack size             (kbytes, -s) 8192</span><br><span class="line">cpu time               (seconds, -t) unlimited</span><br><span class="line">max user processes             (-u) 7111</span><br><span class="line">virtual memory         (kbytes, -v) unlimited</span><br><span class="line">file locks                     (-x) unlimited</span><br><span class="line"></span><br><span class="line">[root@centos8 ~]<span class="comment">#echo 2^20|bc</span></span><br><span class="line">1048576</span><br></pre></td></tr></table></figure>

<p>案例：限制用户最多打开的文件数和运行进程数，并持久保存</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> /etc/pam.d/system-auth</span><br><span class="line">session     required     pam_limits.so</span><br><span class="line"></span><br><span class="line">vim /etc/security/limits.conf  </span><br><span class="line"><span class="comment">#用户apache可打开10240个文件</span></span><br><span class="line">apache  - nofile 10240</span><br><span class="line"></span><br><span class="line"><span class="comment">#用户student不能运行超过20个进程</span></span><br><span class="line">student hard <span class="built_in">nproc</span> 10</span><br><span class="line"></span><br><span class="line"><span class="comment">#用student登录多次运行bash，观察结果</span></span><br><span class="line">[root@centos8 ~]<span class="comment">#vim /etc/security/limits.conf </span></span><br><span class="line">wang          -     nofile 66666</span><br><span class="line">wang          -     <span class="built_in">nproc</span>  5</span><br><span class="line">mage          -     nofile 88888</span><br><span class="line"></span><br><span class="line">[root@centos8 ~]<span class="comment">#su - wang</span></span><br><span class="line">Last login: Mon May 25 14:40:38 CST 2020 on pts/0</span><br><span class="line">[wang@centos8 ~]<span class="variable">$ulimit</span>  -n</span><br><span class="line">66666</span><br></pre></td></tr></table></figure>

<p>案例：限制mage用户最大的同时登录次数</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ~]<span class="comment">#tail -n1 /etc/security/limits.conf </span></span><br><span class="line">mage          -     maxlogins    2</span><br><span class="line"></span><br><span class="line">[root@centos8 ~]<span class="comment">#who</span></span><br><span class="line">mage     tty1         2021-04-28 09:27</span><br><span class="line">root     pts/0        2021-04-28 08:50 (10.0.0.1)</span><br><span class="line">root     pts/1        2021-04-28 09:09 (10.0.0.1)</span><br><span class="line">root     pts/2        2021-04-28 09:19 (10.0.0.1)</span><br><span class="line">mage     tty3         2021-04-28 09:27</span><br><span class="line"></span><br><span class="line">[root@centos8 ~]<span class="comment">#tail /var/log/secure -f</span></span><br><span class="line">Apr 28 09:28:06 centos8 login[23278]: pam_limits(login:session): Too many logins </span><br><span class="line">(max 2) <span class="keyword">for</span> mage</span><br><span class="line">Apr 28 09:28:06 centos8 login[23278]: pam_unix(login:session): session opened </span><br><span class="line"><span class="keyword">for</span> user mage by LOGIN(uid=0)</span><br><span class="line">Apr 28 09:28:06 centos8 login[23278]: Permission denied</span><br></pre></td></tr></table></figure>

<p><img src="../../../../images/SRE/day15/48.png" alt="48"></p>
<p><strong>生产案例</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/security/limits.conf  </span><br><span class="line">*    -   core       unlimited</span><br><span class="line">*    -   nproc       1000000</span><br><span class="line">*    -   nofile      1000000</span><br><span class="line">*    -   memlock     32000</span><br><span class="line">*    -   msgqueue    8192000</span><br></pre></td></tr></table></figure>

<h3 id="pam-google-authenticator-模块"><a href="#pam-google-authenticator-模块" class="headerlink" title="pam_google_authenticator 模块"></a>pam_google_authenticator 模块</h3><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">什么是 MFA ?</span><br><span class="line">Multi-Factor Authentication (MFA) 多因子验证，是一种简单有效的最佳安全实践方法，它能够在用户名和密码之外再额外增加一层安全保护。</span><br></pre></td></tr></table></figure>

<p>功能：实现SSH登录的两次身份验证，先验证APP的数字码，再验证root用户的密码，都通过才可以登录。</p>
<p>官方网站：<a target="_blank" rel="noopener" href="https://github.com/google/google-authenticator-android">https://github.com/google/google-authenticator-android</a></p>
<p><img src="../../../../images/SRE/day15/49.png" alt="49"></p>
<p>范例： </p>
<ol>
<li>在手机应用市场搜索：身份验证器或authenticator，并安装APP或者也可以使用微信小程序 MinaOTP</li>
<li>运行脚本(需要联网EPEL源),本质是修改了/etc/pam.d/sshd文件，将google的PAM模块加入进去实现</li>
</ol>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ~]<span class="comment">#dnf info google-authenticator</span></span><br><span class="line">BaseOS                                                                       </span><br><span class="line">3.3 MB/s | 3.9 kB     00:00    </span><br><span class="line">AppStream                                                                   </span><br><span class="line">  2.9 MB/s | 4.3 kB     00:00    </span><br><span class="line">EPEL                                                                         </span><br><span class="line">  34 kB/s | 4.7 kB     00:00    </span><br><span class="line">extras                                                                       </span><br><span class="line">7.3 kB/s | 1.5 kB     00:00    </span><br><span class="line">Available Packages</span><br><span class="line">Name         : google-authenticator</span><br><span class="line">Version     : 1.07</span><br><span class="line">Release     : 1.el8</span><br><span class="line">Architecture : x86_64</span><br><span class="line">Size         : 57 k</span><br><span class="line">Source       : google-authenticator-1.07-1.el8.src.rpm</span><br><span class="line">Repository   : epel</span><br><span class="line">Summary     : One-time pass-code support using open standards</span><br><span class="line">URL         : https://github.com/google/google-authenticator-libpam/</span><br><span class="line">License     : ASL 2.0</span><br><span class="line">Description : The Google Authenticator package contains a plug-able </span><br><span class="line">authentication</span><br><span class="line">             : module (PAM) <span class="built_in">which</span> allows login using one-time pass-codes </span><br><span class="line">conforming to</span><br><span class="line">             : the open standards developed by the Initiative <span class="keyword">for</span> Open </span><br><span class="line">Authentication</span><br><span class="line">             : (OATH) (<span class="built_in">which</span> is unrelated to OAuth).</span><br><span class="line">             : </span><br><span class="line">             : Pass-code generators are available (separately) <span class="keyword">for</span> several </span><br><span class="line">mobile</span><br><span class="line">             : platforms.</span><br><span class="line">             : </span><br><span class="line">             : These implementations support the HMAC-Based One-time </span><br><span class="line">Password (HOTP)</span><br><span class="line">             : algorithm specified <span class="keyword">in</span> RFC 4226 and the Time-based One-time </span><br><span class="line">Password</span><br><span class="line">             : (TOTP) algorithm currently <span class="keyword">in</span> draft.</span><br><span class="line">             </span><br><span class="line">             </span><br><span class="line">[root@centos8 ~]<span class="comment">#bash google-authenticator.sh</span></span><br><span class="line">Installed:</span><br><span class="line"> google-authenticator-1.07-1.el8.x86_64 </span><br><span class="line"> </span><br><span class="line"> Complete!</span><br><span class="line">Do you want me to update your /root/.google_authenticator file? (y/n) y</span><br><span class="line">你希望我更新你的“/root/.google_authenticator”文件吗(y/n)？</span><br><span class="line">Do you want to disallow multiple uses of the same authentication</span><br><span class="line">token? This restricts you to one login about every 30s, but it increases</span><br><span class="line">your chances to notice or even prevent man-in-the-middle attacks (y/n) y</span><br><span class="line">你希望禁止多次使用同一个验证令牌吗?这限制你每次登录的时间大约是30秒， 但是这加大了发现或甚</span><br><span class="line">至防止中间人攻击的可能性(y/n)?</span><br><span class="line">By default, a new token is generated every 30 seconds by the mobile app.</span><br><span class="line">In order to compensate <span class="keyword">for</span> possible time-skew between the client and the </span><br><span class="line">server,</span><br><span class="line">we allow an extra token before and after the current time. This allows <span class="keyword">for</span> a</span><br><span class="line">time skew of up to 30 seconds between authentication server and client. If </span><br><span class="line">you</span><br><span class="line">experience problems with poor time synchronization, you can increase the </span><br><span class="line">window</span><br><span class="line">from its default size of 3 permitted codes (one previous code, the current</span><br><span class="line">code, the next code) to 17 permitted codes (the 8 previous codes, the </span><br><span class="line">current</span><br><span class="line">code, and the 8 next codes). This will permit <span class="keyword">for</span> a time skew of up to 4</span><br><span class="line">minutes</span><br><span class="line">between client and server.</span><br><span class="line">Do you want to <span class="keyword">do</span> so? (y/n) y</span><br><span class="line">默认情况下，令牌保持30秒有效;为了补偿客户机与服务器之间可能存在的时滞，</span><br><span class="line">我们允许在当前时间前后有一个额外令牌。如果你在时间同步方面遇到了问题， 可以增加窗口从默认的3</span><br><span class="line">个可通过验证码增加到17个可通过验证码，</span><br><span class="line">这将允许客户机与服务器之间的时差增加到4分钟。你希望这么做吗(y/n)?</span><br><span class="line">If the computer that you are logging into isn<span class="string">&#x27;t hardened against brute-force</span></span><br><span class="line"><span class="string">login attempts, you can enable rate-limiting for the authentication module.</span></span><br><span class="line"><span class="string">By default, this limits attackers to no more than 3 login attempts every </span></span><br><span class="line"><span class="string">30s.</span></span><br><span class="line"><span class="string">Do you want to enable rate-limiting? (y/n) y</span></span><br><span class="line"><span class="string">如果你登录的那台计算机没有经过固化，以防范运用蛮力的登录企图，可以对验证模块</span></span><br><span class="line"><span class="string">启用尝试次数限制。默认情况下，这限制攻击者每30秒试图登录的次数只有3次。 你希望启用尝试次数</span></span><br><span class="line"><span class="string">限制吗(y/n)?</span></span><br><span class="line"><span class="string">在App Store 搜索Google Authenticator 进行App安装</span></span><br><span class="line"><span class="string">Do you want authentication tokens to be time-based (y/n) y</span></span><br><span class="line"><span class="string">Warning: pasting the following URL into your browser exposes the OTP secret </span></span><br><span class="line"><span class="string">to Google:</span></span><br><span class="line"><span class="string"> https://www.google.com/chart?</span></span><br><span class="line"><span class="string">chs=200x200&amp;chld=M|0&amp;cht=qr&amp;chl=otpauth://totp/root@centos8.localdomain%3Fsecret%3D7YTAL4GW3TND7BICUMJGJLIFVE%26issuer%3Dcentos8.localdomain  #浏览器打开此地址</span></span><br><span class="line"><span class="string">Failed to use libqrencode to show QR code visually for scanning.</span></span><br><span class="line"><span class="string">Consider typing the OTP secret into your app manually.</span></span><br><span class="line"><span class="string">Your new secret key is: 7YTAL4GW3TND7BICUMJGJLIFVE</span></span><br><span class="line"><span class="string">Enter code from app (-1 to skip):</span></span><br></pre></td></tr></table></figure>

<ol start="3">
<li>访问生成的url(需要科学上网):</li>
</ol>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://www.google.com/chart?chs=200x200&amp;chld=M|0&amp;cht=qr&amp;chl=otpauth://totp/root@centos8.localdomain%3Fsecret%3D7YTAL4GW3TND7BICUMJGJLIFVE%26issuer%3Dcentos8.localdomain</span><br></pre></td></tr></table></figure>

<p><img src="../../../../images/SRE/day15/50.png" alt="50"></p>
<ol start="4">
<li>打开用身份验证器APP，扫网页上的二维码，进行绑定手机</li>
</ol>
<p><img src="../../../../images/SRE/day15/51.png" alt="51"></p>
<ol start="5">
<li>继续上面的安装配置向导，输入手机APP上的数字，后续都回答 y 即可</li>
</ol>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">Failed to use libqrencode to show QR code visually <span class="keyword">for</span> scanning.</span><br><span class="line">Consider typing the OTP secret into your app manually.</span><br><span class="line">Your new secret key is: 7YTAL4GW3TND7BICUMJGJLIFVE</span><br><span class="line">Enter code from app (-1 to skip): 224421  <span class="comment">#手机APP上的数字</span></span><br><span class="line">Code confirmed</span><br><span class="line">Your emergency scratch codes are:</span><br><span class="line">  68820657</span><br><span class="line">  77385307</span><br><span class="line">  50928320</span><br><span class="line">  41000243</span><br><span class="line">  54628309</span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line">Do you want me to update your <span class="string">&quot;/root/.google_authenticator&quot;</span> file? (y/n) y</span><br><span class="line">Do you want to disallow multiple uses of the same authentication</span><br><span class="line">token? This restricts you to one login about every 30s, but it increases</span><br><span class="line">your chances to notice or even prevent man-in-the-middle attacks (y/n) y</span><br><span class="line">By default, a new token is generated every 30 seconds by the mobile app.</span><br><span class="line">In order to compensate <span class="keyword">for</span> possible time-skew between the client and the </span><br><span class="line">server,</span><br><span class="line">we allow an extra token before and after the current time. This allows <span class="keyword">for</span> a</span><br><span class="line">time skew of up to 30 seconds between authentication server and client. If </span><br><span class="line">you</span><br><span class="line">experience problems with poor time synchronization, you can increase the </span><br><span class="line">window</span><br><span class="line">from its default size of 3 permitted codes (one previous code, the current</span><br><span class="line">code, the next code) to 17 permitted codes (the 8 previous codes, the </span><br><span class="line">current</span><br><span class="line">code, and the 8 next codes). This will permit <span class="keyword">for</span> a time skew of up to 4</span><br><span class="line">minutes</span><br><span class="line">between client and server.</span><br><span class="line">Do you want to <span class="keyword">do</span> so? (y/n) y</span><br><span class="line">If the computer that you are logging into isn<span class="string">&#x27;t hardened against brute-force</span></span><br><span class="line"><span class="string">login attempts, you can enable rate-limiting for the authentication module.</span></span><br><span class="line"><span class="string">By default, this limits attackers to no more than 3 login attempts every </span></span><br><span class="line"><span class="string">30s.</span></span><br><span class="line"><span class="string">Do you want to enable rate-limiting? (y/n) y</span></span><br><span class="line"><span class="string">Redirecting to /bin/systemctl restart sshd.service</span></span><br></pre></td></tr></table></figure>

<ol start="6">
<li>ssh 当前主机，可看到提示，输入手机APP上显示的数字码和root密码，可以登录，否则失败</li>
</ol>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@centos7 ~]<span class="comment">#ssh 10.0.0.8</span></span><br><span class="line">Verification code: </span><br><span class="line">Password: </span><br><span class="line">Last failed login: Fri Feb  7 12:11:12 CST 2020 from 10.0.0.7 on ssh:notty</span><br><span class="line">There were 6 failed login attempts since the last successful login.</span><br><span class="line">Last login: Fri Feb  7 12:09:47 2020 from 10.0.0.7</span><br><span class="line">[root@centos8 ~]<span class="comment">#</span></span><br></pre></td></tr></table></figure>

<ol start="7">
<li>临时口令存放在/root/.google_authenticator中，用一次删除一个，可手动加入使用</li>
</ol>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ~]<span class="comment">#cat .google_authenticator </span></span><br><span class="line">7YTAL4GW3TND7BICUMJGJLIFVE</span><br><span class="line"><span class="string">&quot; RATE_LIMIT 3 30</span></span><br><span class="line"><span class="string">&quot;</span> WINDOW_SIZE 17</span><br><span class="line"><span class="string">&quot; DISALLOW_REUSE</span></span><br><span class="line"><span class="string">&quot;</span> TOTP_AUTH</span><br><span class="line">68820657</span><br><span class="line">77385307</span><br><span class="line">50928320</span><br><span class="line">41000243</span><br><span class="line">54628309</span><br><span class="line">[root@centos8 ~]<span class="comment">#</span></span><br></pre></td></tr></table></figure>

<ol start="8">
<li>支持 ssh key 验证</li>
</ol>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ~]<span class="comment">#vim /etc/ssh/sshd_config </span></span><br><span class="line"><span class="comment">#在最后一行加下面内容</span></span><br><span class="line">AuthenticationMethods publickey,keyboard-interactive</span><br><span class="line"></span><br><span class="line">[root@centos8 ~]<span class="comment">#vim /etc/pam.d/sshd</span></span><br><span class="line"><span class="comment">#注释此行</span></span><br><span class="line"><span class="comment">#auth       substack     password-auth</span></span><br><span class="line"></span><br><span class="line">[root@centos8 ~]<span class="comment">#systemctl restart sshd</span></span><br></pre></td></tr></table></figure>

<p>范例：安装配置脚本</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> google-authenticator.sh</span><br><span class="line"><span class="comment">#安装epel</span></span><br><span class="line">yum install -y epel-release.noarch </span><br><span class="line">yum makecache </span><br><span class="line"><span class="comment">#安装google authenticator</span></span><br><span class="line">yum install -y google-authenticator.x86_64</span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> -e <span class="string">&quot;\033[31mDo you want me to update your &quot;</span>/root/.google_authenticator<span class="string">&quot; file? (y/n) y&quot;</span></span><br><span class="line"><span class="built_in">echo</span> -e <span class="string">&quot;\033[31m你希望我更新你的“/root/.google_authenticator”文件吗(y/n)？\033[0m&quot;</span></span><br><span class="line"><span class="built_in">echo</span> -e <span class="string">&quot;\033[31mDo you want to disallow multiple uses of the same authentication&quot;</span></span><br><span class="line"><span class="built_in">echo</span> -e <span class="string">&quot;\033[31mtoken? This restricts you to one login about every 30s, but it increases&quot;</span></span><br><span class="line"><span class="built_in">echo</span> -e <span class="string">&quot;\033[31myour chances to notice or even prevent man-in-the-middle attacks (y/n) y&quot;</span></span><br><span class="line"><span class="built_in">echo</span> -e <span class="string">&quot;\033[31m你希望禁止多次使用同一个验证令牌吗?这限制你每次登录的时间大约是30秒， 但是这加大了发现或甚至防止中间人攻击的可能性(y/n)?\033[0m&quot;</span></span><br><span class="line"><span class="built_in">echo</span> -e <span class="string">&quot;\033[31mBy default, a new token is generated every 30 seconds by the mobile app.&quot;</span></span><br><span class="line"><span class="built_in">echo</span> -e <span class="string">&quot;\033[31mIn order to compensate for possible time-skew between the client and the server,&quot;</span></span><br><span class="line"><span class="built_in">echo</span> -e <span class="string">&quot;\033[31mwe allow an extra token before and after the current time. This allows for a&quot;</span></span><br><span class="line"><span class="built_in">echo</span> -e <span class="string">&quot;\033[31mtime skew of up to 30 seconds between authentication server and client. If you&quot;</span></span><br><span class="line"><span class="built_in">echo</span> -e <span class="string">&quot;\033[31mexperience problems with poor time synchronization, you can increase the window&quot;</span></span><br><span class="line"><span class="built_in">echo</span> -e <span class="string">&quot;\033[31mfrom its default size of 3 permitted codes (one previous code, the current&quot;</span></span><br><span class="line"><span class="built_in">echo</span> -e <span class="string">&quot;\033[31mcode, the next code) to 17 permitted codes (the 8 previous codes, the current&quot;</span></span><br><span class="line"><span class="built_in">echo</span> -e <span class="string">&quot;\033[31mcode, and the 8 next codes). This will permit for a time skew of up to 4 minutes&quot;</span></span><br><span class="line"><span class="built_in">echo</span> -e <span class="string">&quot;\033[31mbetween client and server.&quot;</span></span><br><span class="line"><span class="built_in">echo</span> -e <span class="string">&quot;\033[31mDo you want to do so? (y/n) y&quot;</span></span><br><span class="line"><span class="built_in">echo</span> -e <span class="string">&quot;\033[31m默认情况下，令牌保持30秒有效;为了补偿客户机与服务器之间可能存在的时滞，\033[0m&quot;</span></span><br><span class="line"><span class="built_in">echo</span> -e <span class="string">&quot;\033[31m我们允许在当前时间前后有一个额外令牌。如果你在时间同步方面遇到了问题， 可以增加窗口从默认的3个可通过验证码增加到17个可通过验证码，\033[0m&quot;</span></span><br><span class="line"><span class="built_in">echo</span> -e <span class="string">&quot;\033[31m这将允许客户机与服务器之间的时差增加到4分钟。你希望这么做吗(y/n)?\033[0m&quot;</span></span><br><span class="line"><span class="built_in">echo</span> -e <span class="string">&quot;\033[31mIf the computer that you are logging into isn&#x27;t hardened against brute-force&quot;</span></span><br><span class="line"><span class="built_in">echo</span> -e <span class="string">&quot;\033[31mlogin attempts, you can enable rate-limiting for the authentication module.&quot;</span></span><br><span class="line"><span class="built_in">echo</span> -e <span class="string">&quot;\033[31mBy default, this limits attackers to no more than 3 login attempts every 30s.&quot;</span></span><br><span class="line"><span class="built_in">echo</span> -e <span class="string">&quot;\033[31mDo you want to enable rate-limiting? (y/n) y&quot;</span></span><br><span class="line"><span class="built_in">echo</span> -e <span class="string">&quot;\033[31m如果你登录的那台计算机没有经过固化，以防范运用蛮力的登录企图，可以对验证模块\033[0m&quot;</span></span><br><span class="line"><span class="built_in">echo</span> -e <span class="string">&quot;\033[31m启用尝试次数限制。默认情况下，这限制攻击者每30秒试图登录的次数只有3次。 你希望启用尝试次数限制吗(y/n)?\033[0m&quot;</span></span><br><span class="line"><span class="built_in">echo</span> -e <span class="string">&quot;\033[32m 在App Store 搜索Google Authenticator 进行App安装 \033[0m&quot;</span></span><br><span class="line"></span><br><span class="line">google-authenticator</span><br><span class="line"></span><br><span class="line"><span class="comment">#/etc/pam.d/sshd文件，修改或添加下行保存</span></span><br><span class="line"><span class="comment">#auth required pam_google_authenticator.so</span></span><br><span class="line">sed -i <span class="string">&#x27;1a\auth       required     pam_google_authenticator.so&#x27;</span> /etc/pam.d/sshd</span><br><span class="line"></span><br><span class="line"><span class="comment">#编辑/etc/ssh/sshd_config找到下行</span></span><br><span class="line"><span class="comment">#ChallengeResponseAuthentication no</span></span><br><span class="line"><span class="comment">#更改为</span></span><br><span class="line"><span class="comment">#ChallengeResponseAuthentication yes</span></span><br><span class="line">sed -i <span class="string">&#x27;s/.*ChallengeResponseAuthentication.*/ChallengeResponseAuthentication yes/&#x27;</span> /etc/ssh/sshd_config</span><br><span class="line"></span><br><span class="line"><span class="comment">#重启SSH服务</span></span><br><span class="line">service sshd restart</span><br></pre></td></tr></table></figure>

<h1 id="时间同步服务"><a href="#时间同步服务" class="headerlink" title="时间同步服务"></a>时间同步服务</h1><p>加密和安全当前都离不开时间的同步，否则各种网络服务可能不能正常运行 </p>
<p>范例: 时间错误导致证书应用出错</p>
<p><img src="../../../../images/SRE/day15/52.png" alt="52"></p>
<p><img src="../../../../images/SRE/day15/53.png" alt="53"></p>
<h2 id="计时方式"><a href="#计时方式" class="headerlink" title="计时方式"></a>计时方式</h2><h3 id="古代计时方式"><a href="#古代计时方式" class="headerlink" title="古代计时方式"></a>古代计时方式</h3><p>在远古时期，人类用来确定时间的方式是一些自然界“相对”亘古不变的周期。如：地球的公转是为一年，月球的公转是为一月，地球的自转是为一天等，最早的计时可以追溯到公元前大约2000年，古埃及人利用光线留下的影子用作计时的工具。影子拉得越长，计时越精确。古埃及人修建高耸入云的大型方尖碑，来追踪太阳的移动，随后人们又利用了沙漏、日晷、钟摆等工具，巧妙地利用一些相对固定而准确的周期来计时</p>
<p>商朝人开发并使用了一种泄水型水钟——漏壶。后来又有用蜡烛和线香计时的</p>
<p>北宋元祐元年（1086年），天文学家苏颂将浑仪、浑象和报时装置结合，建造一个划时代的计时工具 ——“水运仪象台”</p>
<p>14世纪时，西方国家广泛使用机械钟。在十六世纪，奥斯曼帝国的科学家达兹·艾-丁（Taqi al-Din）发明出了机械闹钟</p>
<p>1583年，伽利略提出了著名的等时性理论，即不论摆动幅度的大小，完成一次摆动的时间是相同的。</p>
<p>1656年，荷兰科学家克里斯蒂安·惠更斯（Christiaan Huygens）应用他的理论，设计出了世界第一只钟摆</p>
<p>1868年，百达翡丽（Patek Philippe）发明了手表</p>
<h3 id="现代计时方式"><a href="#现代计时方式" class="headerlink" title="现代计时方式"></a>现代计时方式</h3><p>石英晶体受到电池的电力影响时，会产生规律的振动。每秒的振动次数是32768次，可以设计电路来计算振动次数，当计数到32768次时，即计时1秒。</p>
<p>1967年，瑞士人发布了世界上首款石英表当原子从一个相对高的“能量态”迁至低的“能量态”时，会释放出电磁波，产生共振频率。依据此原理，拉比构想出了一种全新的计时仪器——原子钟（Atomic clock） 因为原子的共振频率是固定的。如：铯原子（Caesium133）的固有频率是9192631770赫兹，约合92亿赫兹，对铯原子钟计数9192631770次，即可测量出一秒钟。很多国家（包括我国和美国NIST）的标准局，就是用铯原子钟来作为时间精度标准的。GPS系统也是用铯原子钟来计时 </p>
<p>2008年诞生的锶（Strontium87）原子钟，固有频率为429228004229873，约合430万亿赫兹，将精度提高到了10的17次方 </p>
<p>2013年镱元素（ytterbium）制成的原子钟问世，镱原子钟的固有频率约合518万亿赫兹，精度高达10的18次方。宇宙的年龄为138亿年。如果这台镱原子钟从宇宙诞生之初就开始计时，直到今天也不会发生1秒的误差</p>
<p>范例： ntpdate 一次性同步时间</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">[root@centos7 ~]<span class="comment">#date -s &#x27;-1 year&#x27;</span></span><br><span class="line">Sat May 25 16:26:13 CST 2019</span><br><span class="line"></span><br><span class="line">[root@centos7 ~]<span class="comment">#date</span></span><br><span class="line">Sat May 25 16:26:14 CST 2019</span><br><span class="line"></span><br><span class="line">[root@centos7 ~]<span class="comment">#ping ntp.aliyun.com</span></span><br><span class="line">PING ntp.aliyun.com (203.107.6.88) 56(84) bytes of data.</span><br><span class="line">64 bytes from 203.107.6.88 (203.107.6.88): icmp_seq=1 ttl=128 time=16.6 ms</span><br><span class="line">64 bytes from 203.107.6.88 (203.107.6.88): icmp_seq=2 ttl=128 time=16.8 ms</span><br><span class="line">^C</span><br><span class="line">--- ntp.aliyun.com ping statistics ---</span><br><span class="line">2 packets transmitted, 2 received, 0% packet loss, time 1001ms</span><br><span class="line">rtt min/avg/max/mdev = 16.607/16.706/16.806/0.163 ms</span><br><span class="line"></span><br><span class="line">[root@centos7 ~]<span class="comment">#ntpdate ntp.aliyun.com</span></span><br><span class="line">25 May 16:26:30 ntpdate[24545]: step time server 203.107.6.88 offset </span><br><span class="line">31622399.992886 sec</span><br><span class="line"></span><br><span class="line">[root@centos7 ~]<span class="comment">#date</span></span><br><span class="line">Mon May 25 16:26:34 CST 2020</span><br><span class="line"></span><br><span class="line">[root@centos7 ~]<span class="comment">#ntpdate time.windows.com</span></span><br><span class="line">25 May 16:32:34 ntpdate[24565]: step time server 52.231.114.183 offset </span><br><span class="line">31622399.981666 sec</span><br><span class="line"></span><br><span class="line">[root@centos7 ~]<span class="comment">#date</span></span><br><span class="line">Mon May 25 16:32:39 CST 2020</span><br></pre></td></tr></table></figure>

<p>范例： rdate 一次性同步时间</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@centos7 ~]<span class="comment">#yum -y install rdate</span></span><br><span class="line">[root@centos7 ~]<span class="comment">#date -s &#x27;1 year&#x27;</span></span><br><span class="line">Tue Jan 18 21:33:13 CST 2022</span><br><span class="line"></span><br><span class="line">[root@centos7 ~]<span class="comment">#rdate -s -u time.nist.gov</span></span><br><span class="line">[root@centos7 ~]<span class="comment">#date</span></span><br><span class="line">Mon Jan 18 21:33:22 CST 2021</span><br></pre></td></tr></table></figure>

<p>范例: Ubuntu 时间同步</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">[root@ubuntu2004 ~]<span class="comment">#timedatectl </span></span><br><span class="line">               Local time: Tue 2022-01-18 15:36:09 CST</span><br><span class="line">           Universal time: Tue 2022-01-18 07:36:09 UTC</span><br><span class="line">                 RTC time: Tue 2022-01-18 07:36:09    </span><br><span class="line">               Time zone: Asia/Shanghai (CST, +0800) </span><br><span class="line">System clock synchronized: <span class="built_in">yes</span>                        </span><br><span class="line">             NTP service: active                     </span><br><span class="line">         RTC <span class="keyword">in</span> <span class="built_in">local</span> TZ: no </span><br><span class="line">         </span><br><span class="line">[root@ubuntu2004 ~]<span class="comment">#systemctl status time-set.target</span></span><br><span class="line">● time-set.target - System Time Set</span><br><span class="line">     Loaded: loaded (/lib/systemd/system/time-set.target; static; vendor preset: </span><br><span class="line">disabled)</span><br><span class="line">     Active: active since Fri 2022-01-07 06:23:27 UTC; 1 weeks 5 days ago</span><br><span class="line">       Docs: man:systemd.special(7)</span><br><span class="line">Jan 07 06:23:27 ubuntu2004.magedu.org systemd[1]: Reached target System Time </span><br><span class="line">Set.</span><br><span class="line"></span><br><span class="line">[root@ubuntu2004 ~]<span class="comment">#systemctl status time-sync.target</span></span><br><span class="line">● time-sync.target - System Time Synchronized</span><br><span class="line">     Loaded: loaded (/lib/systemd/system/time-sync.target; static; vendor preset: </span><br><span class="line">disabled)</span><br><span class="line">     Active: active since Fri 2022-01-07 06:23:27 UTC; 1 weeks 5 days ago</span><br><span class="line">       Docs: man:systemd.special(7)</span><br><span class="line">Jan 07 06:23:27 ubuntu2004.magedu.org systemd[1]: Reached target System Time </span><br><span class="line">Synchronized.</span><br><span class="line"></span><br><span class="line">[root@ubuntu2004 ~]<span class="comment">#man 7 systemd.special</span></span><br></pre></td></tr></table></figure>

<h2 id="时间同步服务-1"><a href="#时间同步服务-1" class="headerlink" title="时间同步服务"></a>时间同步服务</h2><p>时间同步服务</p>
<p>多主机协作工作时，各个主机的时间同步很重要，时间不一致会造成很多重要应用的故障，如：加密协议，日志，集群等， 利用NTP（Network Time Protocol） 协议使网络中的各个计算机时间达到同步。目前NTP协议属于运维基础架构中必备的基本服务之一 </p>
<p>时间同步软件实现：</p>
<ul>
<li>ntp </li>
<li>chrony </li>
</ul>
<p><strong>ntp：</strong> </p>
<p>将系统时钟和世界协调时UTC同步，精度在局域网内可达0.1ms，在互联网上绝大多数的地方精度可以达到1-50ms</p>
<p>项目官网：<a target="_blank" rel="noopener" href="http://www.ntp.org/">http://www.ntp.org</a></p>
<p><strong>chrony：</strong></p>
<p>实现NTP协议的的自由软件。可使系统时钟与NTP服务器，参考时钟（例如GPS接收器）以及使用手表和键盘的手动输入进行同步。还可以作为NTPv4（RFC 5905）服务器和对等体运行，为网络中的计算机提供时间服务。设计用于在各种条件下良好运行，包括间歇性和高度拥挤的网络连接，温度变化（计算机时钟对温度敏感），以及不能连续运行或在虚拟机上运行的系统。 </p>
<p>通过Internet同步的两台机器之间的典型精度在几毫秒之内，在LAN上，精度通常为几十微秒。利用硬件时间戳或硬件参考时钟，可实现亚微秒的精度</p>
<h2 id="chrony"><a href="#chrony" class="headerlink" title="chrony"></a>chrony</h2><h3 id="chrony介绍"><a href="#chrony介绍" class="headerlink" title="chrony介绍"></a>chrony介绍</h3><p>chrony 的优势：</p>
<ul>
<li>更快的同步只需要数分钟而非数小时时间，从而最大程度减少了时间和频率误差，对于并非全天 24 小时运行的虚拟计算机而言非常有用 </li>
<li>能够更好地响应时钟频率的快速变化，对于具备不稳定时钟的虚拟机或导致时钟频率发生变化的节能技术而言非常有用 </li>
<li>在初始同步后，它不会停止时钟，以防对需要系统时间保持单调的应用程序造成影响 </li>
<li>在应对临时非对称延迟时（例如，在大规模下载造成链接饱和时）提供了更好的稳定性 </li>
<li>无需对服务器进行定期轮询，因此具备间歇性网络连接的系统仍然可以快速同步时钟 </li>
</ul>
<p>chrony官网：<a target="_blank" rel="noopener" href="https://chrony.tuxfamily.org/">https://chrony.tuxfamily.org</a> </p>
<p>chrony官方文档：<a target="_blank" rel="noopener" href="https://chrony.tuxfamily.org/documentation.html">https://chrony.tuxfamily.org/documentation.html</a></p>
<h3 id="chrony-文件组成"><a href="#chrony-文件组成" class="headerlink" title="chrony 文件组成"></a>chrony 文件组成</h3><p>包：chrony</p>
<p>两个主要程序：chronyd和chronyc</p>
<ul>
<li>chronyd：后台运行的守护进程，用于调整内核中运行的系统时钟和时钟服务器同步。它确定计算机增减时间的比率，并对此进行补偿</li>
<li>chronyc：命令行用户工具，用于监控性能并进行多样化的配置。它可以在chronyd实例控制的计算机上工作，也可在一台不同的远程计算机上工作 </li>
</ul>
<p>服务unit 文件： /usr/lib/systemd/system/chronyd.service </p>
<p>监听端口： 服务端: 123/udp,客户端: 323/udp </p>
<p>配置文件： /etc/chrony.conf</p>
<h3 id="配置文件chrony-conf"><a href="#配置文件chrony-conf" class="headerlink" title="配置文件chrony.conf"></a>配置文件chrony.conf</h3><p>官方文档: <a target="_blank" rel="noopener" href="https://chrony.tuxfamily.org/doc/3.5/chrony.conf.html">https://chrony.tuxfamily.org/doc/3.5/chrony.conf.html</a></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">server          <span class="comment">#可用于时钟服务器，iburst 选项当服务器可达时，发送一个八个数据包而不是通常的一个数据包。 包间隔通常为2秒,可加快初始同步速度</span></span><br><span class="line">pool            <span class="comment">#该指令的语法与server 指令的语法相似，不同之处在于它用于指定NTP服务器池而不是单个NTP服务器。池名称应解析为随时间可能会变化的多个地址</span></span><br><span class="line">driftfile       <span class="comment">#根据实际时间计算出计算机增减时间的比率，将它记录到一个文件中，会在重启后为系统时钟作出补偿</span></span><br><span class="line">rtcsync         <span class="comment">#启用内核模式，系统时间每11分钟会拷贝到实时时钟（RTC）</span></span><br><span class="line">allow / deny    <span class="comment">#指定一台主机、子网，或者网络以允许或拒绝访问本服务器</span></span><br><span class="line">cmdallow / cmddeny <span class="comment">#可以指定哪台主机可以通过chronyd使用控制命令</span></span><br><span class="line">bindcmdaddress  <span class="comment">#允许chronyd监听哪个接口来接收由chronyc执行的命令</span></span><br><span class="line">makestep        <span class="comment">#通常chronyd将根据需求通过减慢或加速时钟，使得系统逐步纠正所有时间偏差。在某些特定情况下，系统时钟可能会漂移过快，导致该调整过程消耗很长的时间来纠正系统时钟。该指令强制chronyd在调整期大于某个阀值时调整系统时钟</span></span><br><span class="line"><span class="built_in">local</span> stratum 10  <span class="comment">#即使server指令中时间服务器不可用，也允许将本地时间作为标准时间授时给其它客户端</span></span><br></pre></td></tr></table></figure>

<h3 id="NTP-客户端工具"><a href="#NTP-客户端工具" class="headerlink" title="NTP 客户端工具"></a>NTP 客户端工具</h3><p>chronyc 可以运行在交互式和非交互式两种方式，支持以下子命令</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">help</span>             <span class="comment">#命令可以查看更多chronyc的交互命令</span></span><br><span class="line">accheck          <span class="comment">#检查是否对特定主机可访问当前服务器</span></span><br><span class="line">activity         <span class="comment">#显示有多少NTP源在线/离线</span></span><br><span class="line">sources [-v]     <span class="comment">#显示当前时间源的同步信息</span></span><br><span class="line">sourcestats [-v] <span class="comment">#显示当前时间源的同步统计信息</span></span><br><span class="line">add server       <span class="comment">#手动添加一台新的NTP服务器</span></span><br><span class="line">clients          <span class="comment">#报告已访问本服务器的客户端列表</span></span><br><span class="line">delete           <span class="comment">#手动移除NTP服务器或对等服务器</span></span><br><span class="line">settime          <span class="comment">#手动设置守护进程时间</span></span><br><span class="line">tracking         <span class="comment">#显示系统时间信息</span></span><br></pre></td></tr></table></figure>

<p>范例：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">[root@centos7 ~]<span class="comment">#chronyc</span></span><br><span class="line">chrony version 3.2</span><br><span class="line">Copyright (C) 1997-2003, 2007, 2009-2017 Richard P. Curnow and others</span><br><span class="line">chrony comes with ABSOLUTELY NO WARRANTY. This is free software, and</span><br><span class="line">you are welcome to redistribute it under certain conditions. See the</span><br><span class="line">GNU General Public License version 2 <span class="keyword">for</span> details.</span><br><span class="line">chronyc&gt; clients</span><br><span class="line">Hostname                     NTP   Drop Int IntL Last     Cmd   Drop Int Last</span><br><span class="line">===============================================================================</span><br><span class="line">192.168.8.7                    18      0   6   -    17       0      0   -     -</span><br><span class="line">192.168.8.6                    14      0   6   -    56       0      0   -     -</span><br><span class="line">chronyc&gt; activity </span><br><span class="line">200 OK</span><br><span class="line">1 sources online</span><br><span class="line">0 sources offline</span><br><span class="line">0 sources doing burst (<span class="built_in">return</span> to online)</span><br><span class="line">0 sources doing burst (<span class="built_in">return</span> to offline)</span><br><span class="line">0 sources with unknown address</span><br><span class="line">chronyc&gt; sources -v  </span><br><span class="line">210 Number of sources = 1</span><br><span class="line"> .-- Source mode  <span class="string">&#x27;^&#x27;</span> = server, <span class="string">&#x27;=&#x27;</span> = peer, <span class="string">&#x27;#&#x27;</span> = <span class="built_in">local</span> clock.</span><br><span class="line"> / .- Source state <span class="string">&#x27;*&#x27;</span> = current synced, <span class="string">&#x27;+&#x27;</span> = combined , <span class="string">&#x27;-&#x27;</span> = not combined,</span><br><span class="line">| /   <span class="string">&#x27;?&#x27;</span> = unreachable, <span class="string">&#x27;x&#x27;</span> = time may be <span class="keyword">in</span> error, <span class="string">&#x27;~&#x27;</span> = time too variable.</span><br><span class="line">||                                                 .- xxxx [ yyyy ] +/- zzzz</span><br><span class="line">||     Reachability register (octal) -.           | xxxx = adjusted offset,</span><br><span class="line">||     Log2(Polling interval) --.     |         | yyyy = measured offset,</span><br><span class="line">||                               \     |         | zzzz = estimated error.</span><br><span class="line">||                                 |   |           \</span><br><span class="line">MS Name/IP address         Stratum Poll Reach LastRx Last sample               </span><br><span class="line">===============================================================================</span><br><span class="line">^? 192.168.8.100                    3   8     1   338    -40ms[  -40ms] </span><br><span class="line">+/- 237ms</span><br></pre></td></tr></table></figure>

<p>范例: CentOS6 ntp客户端同步检查</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@centos6 ~]<span class="comment">#ntpq -p</span></span><br><span class="line">     remote           refid     st t when poll reach   delay   offset jitter</span><br><span class="line">==============================================================================</span><br><span class="line">*10.0.0.8        202.112.29.82    3 u   16   64    1    0.424    1.956   1.771</span><br></pre></td></tr></table></figure>

<h3 id="公共NTP服务"><a href="#公共NTP服务" class="headerlink" title="公共NTP服务"></a>公共NTP服务</h3><ul>
<li><p>pool.ntp.org：项目是一个提供可靠易用的NTP服务的虚拟集群cn.pool.ntp.org，0-3.cn.pool.ntp.org</p>
</li>
<li><p>阿里云公共NTP服务器 </p>
<p>Unix/linux类：ntp.aliyun.com，ntp1-7.aliyun.com </p>
<p>windows类： time.pool.aliyun.com </p>
</li>
<li><p>腾讯公共NTP </p>
<p>time1-5.cloud.tencent.com </p>
</li>
<li><p>大学ntp服务 </p>
<p>s1a.time.edu.cn 北京邮电大学 </p>
<p>s1b.time.edu.cn 清华大学 </p>
<p>s1c.time.edu.cn 北京大学 </p>
</li>
<li><p>国家授时中心服务器：210.72.145.44  </p>
</li>
<li><p>美国标准技术院: time.nist.gov</p>
</li>
</ul>
<h3 id="时间工具"><a href="#时间工具" class="headerlink" title="时间工具"></a>时间工具</h3><ul>
<li>timedatectl 时间和时区管理</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#查看日期时间、时区及NTP状态：</span></span><br><span class="line">timedatectl</span><br><span class="line"></span><br><span class="line"><span class="comment">#查看时区列表：</span></span><br><span class="line">timedatectl list-timezones</span><br><span class="line"></span><br><span class="line"><span class="comment">#修改时区：</span></span><br><span class="line">timedatectl set-timezone Asia/Shanghai</span><br><span class="line"></span><br><span class="line"><span class="comment">#修改时区</span></span><br><span class="line">root@ubuntu2004:~<span class="comment"># rm -f /etc/localtime</span></span><br><span class="line">root@ubuntu2004:~<span class="comment"># ln -s /usr/share/zoneinfo/Asia/Shanghai /etc/localtime</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#修改日期时间：</span></span><br><span class="line">timedatectl set-time <span class="string">&quot;2017-01-23 10:30:00&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#开启NTP：</span></span><br><span class="line">timedatectl set-ntp <span class="literal">true</span>/false</span><br></pre></td></tr></table></figure>

<ul>
<li>ntpdate 时间同步命令,CentOS8版本此命令已淘汰 </li>
<li>system-config-date：图形化配置chrony服务的工具</li>
</ul>
<h3 id="实战案例-实现私有的时间服务器"><a href="#实战案例-实现私有的时间服务器" class="headerlink" title="实战案例: 实现私有的时间服务器"></a>实战案例: 实现私有的时间服务器</h3><p><img src="../../../../images/SRE/day15/image-20241203230602310.png" alt="54"></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#服务器端配置</span></span><br><span class="line">[root@centos8 ~]<span class="comment">#hostname -I</span></span><br><span class="line">10.0.0.8 </span><br><span class="line"></span><br><span class="line">[root@centos8 ~]<span class="comment">#yum -y install chrony</span></span><br><span class="line">[root@ubuntu2004 ~]<span class="comment">#apt install chrony -y</span></span><br><span class="line">[root@centos8 ~]<span class="comment">#vim /etc/chrony.conf</span></span><br><span class="line">server ntp.aliyun.com iburst</span><br><span class="line">server ntp1.aliyun.com iburst</span><br><span class="line">server ntp2.aliyun.com iburst</span><br><span class="line"><span class="comment">#allow 192.168.0.0/16</span></span><br><span class="line">allow 0.0.0.0/0  <span class="comment">#加此行,指定允许同步的网段</span></span><br><span class="line"><span class="comment"># Serve time even if not synchronized to a time source.</span></span><br><span class="line"><span class="built_in">local</span> stratum 10 <span class="comment">#删除此行注释,当互联网无法连接,仍然可以为客户端提供时间同步服务</span></span><br><span class="line"></span><br><span class="line">[root@centos8 ~]<span class="comment">#systemctl restart chronyd</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#服务启动后会打开端口123/udp</span></span><br><span class="line">[root@centos8 ~]<span class="comment">#ss -ntlu</span></span><br><span class="line">Netid             State               Recv-Q             Send-Q                 </span><br><span class="line">            Local Address:Port                             Peer Address:Port     </span><br><span class="line">         </span><br><span class="line">udp               UNCONN              0                   0                     </span><br><span class="line">                   0.0.0.0:123                                   0.0.0.0:*       </span><br><span class="line">          </span><br><span class="line">udp               UNCONN              0                   0                     </span><br><span class="line">                 127.0.0.1:323                                   0.0.0.0:*       </span><br><span class="line">          </span><br><span class="line">udp               UNCONN              0                   0                     </span><br><span class="line">                    [::1]:323                                     [::]:*       </span><br><span class="line">          </span><br><span class="line">tcp               LISTEN              0                   128                   </span><br><span class="line">                   0.0.0.0:22                                    0.0.0.0:*       </span><br><span class="line">tcp               LISTEN              0                   100                   </span><br><span class="line">                 127.0.0.1:25                                    0.0.0.0:*       </span><br><span class="line">          </span><br><span class="line">tcp               LISTEN              0                   128                   </span><br><span class="line">                      [::]:22                                       [::]:*       </span><br><span class="line">          </span><br><span class="line">tcp               LISTEN              0                   100                   </span><br><span class="line">                    [::1]:25                                       [::]:*  </span><br><span class="line">                    </span><br><span class="line"><span class="comment">#客户端配置</span></span><br><span class="line">[root@centos7 ~]<span class="comment">#vim /etc/chrony.conf</span></span><br><span class="line">server 10.0.0.8 iburst</span><br><span class="line"></span><br><span class="line">[root@centos7 ~]<span class="comment">#systemctl restart chronyd.service </span></span><br><span class="line"></span><br><span class="line"><span class="comment">#确认同步成功</span></span><br><span class="line">[root@centos7 ~]<span class="comment">#chronyc sources -v</span></span><br><span class="line">210 Number of sources = 1</span><br><span class="line"> .-- Source mode  <span class="string">&#x27;^&#x27;</span> = server, <span class="string">&#x27;=&#x27;</span> = peer, <span class="string">&#x27;#&#x27;</span> = <span class="built_in">local</span> clock.</span><br><span class="line"> / .- Source state <span class="string">&#x27;*&#x27;</span> = current synced, <span class="string">&#x27;+&#x27;</span> = combined , <span class="string">&#x27;-&#x27;</span> = not combined,</span><br><span class="line">| /   <span class="string">&#x27;?&#x27;</span> = unreachable, <span class="string">&#x27;x&#x27;</span> = time may be <span class="keyword">in</span> error, <span class="string">&#x27;~&#x27;</span> = time too variable.</span><br><span class="line">||                                                 .- xxxx [ yyyy ] +/- zzzz</span><br><span class="line">||     Reachability register (octal) -.           | xxxx = adjusted offset,</span><br><span class="line">||     Log2(Polling interval) --.     |         | yyyy = measured offset,</span><br><span class="line">||                               \     |         | zzzz = estimated error.</span><br><span class="line">||                                 |   |           \</span><br><span class="line">MS Name/IP address         Stratum Poll Reach LastRx Last sample               </span><br><span class="line">===============================================================================</span><br><span class="line">^* 10.0.0.8                      3   6    77    29   -229us[-1154us] +/-   17ms</span><br></pre></td></tr></table></figure>

</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="http://example.com">૮(˶ᵔ ᵕ ᵔ˶)ა</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="http://example.com/2024/12/04/SRE-%E5%8A%A0%E5%AF%86%E5%92%8C%E5%AE%89%E5%85%A8/">http://example.com/2024/12/04/SRE-加密和安全/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="http://example.com" target="_blank">૮(˶ᵔ ᵕ ᵔ˶)ა</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/SRE/">SRE</a><a class="post-meta__tags" href="/tags/Linux/">Linux</a></div><div class="post_share"><div class="social-share" data-image="/../images/SRE/day15/13.png" data-sites="wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2024/12/01/SRE-%E7%B3%BB%E7%BB%9F%E5%90%AF%E5%8A%A8%E5%92%8C%E5%86%85%E6%A0%B8%E7%AE%A1%E7%90%86/" title="系统启动和内核管理"><img class="cover" src="/../images/TITLE/linux4.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">系统启动和内核管理</div></div></a></div><div class="next-post pull-right"><a href="/2024/12/06/SRE-%E5%9F%9F%E5%90%8D%E7%B3%BB%E7%BB%9FDNS%E6%9C%8D%E5%8A%A1/" title="域名系统DNS服务"><img class="cover" src="/../images/SRE/day16/15.png" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">域名系统DNS服务</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><div><a href="/2024/08/27/SRE-Linux%E6%96%87%E4%BB%B6%E7%AE%A1%E7%90%86%E5%92%8CIO%E9%87%8D%E5%AE%9A%E5%90%91/" title="Linux文件管理和IO重定向"><img class="cover" src="/../images/TITLE/linux3.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-08-27</div><div class="title">Linux文件管理和IO重定向</div></div></a></div><div><a href="/2024/04/24/SRE-Linux%E5%9F%BA%E6%9C%AC%E6%93%8D%E4%BD%9C%E5%92%8C%E5%B8%AE%E5%8A%A9/" title="Linux基本操作和帮助"><img class="cover" src="/../images/TITLE/linux2.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-04-24</div><div class="title">Linux基本操作和帮助</div></div></a></div><div><a href="/2024/12/08/SRE-Linux%E9%98%B2%E7%81%AB%E5%A2%99/" title="Linux防火墙"><img class="cover" src="/../images/SRE/day17/12.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-12-08</div><div class="title">Linux防火墙</div></div></a></div><div><a href="/2024/11/05/SRE-Shell%E8%84%9A%E6%9C%AC%E7%BC%96%E7%A8%8B/" title="shell脚本编程"><img class="cover" src="/../images/TITLE/linux2.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-11-05</div><div class="title">shell脚本编程</div></div></a></div><div><a href="/2024/12/08/SRE-linux%E5%91%BD%E4%BB%A4%E7%B4%A2%E5%BC%95/" title="linux命令索引"><img class="cover" src="/../images/TITLE/linux3.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-12-08</div><div class="title">linux命令索引</div></div></a></div><div><a href="/2024/09/23/SRE-%E5%B8%B8%E8%A7%81%E6%96%87%E6%9C%AC%E5%A4%84%E7%90%86%E5%B7%A5%E5%85%B7%E5%92%8C%E6%AD%A3%E5%88%99%E8%A1%A8%E8%BE%BE%E5%BC%8F/" title="常见文本处理工具和正则表达式"><img class="cover" src="/../images/TITLE/linux5.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-09-23</div><div class="title">常见文本处理工具和正则表达式</div></div></a></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="/../images/TITLE/user.webp" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">૮(˶ᵔ ᵕ ᵔ˶)ა</div><div class="author-info__description">这家伙很勤奋，什么都留下了</div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">97</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">37</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">30</div></a></div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content is-expand"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%AE%89%E5%85%A8%E6%9C%BA%E5%88%B6"><span class="toc-number">1.</span> <span class="toc-text">安全机制</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%A2%A8%E8%8F%B2%E5%AE%9A%E5%BE%8B"><span class="toc-number">1.1.</span> <span class="toc-text">墨菲定律</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BF%A1%E6%81%AF%E5%AE%89%E5%85%A8%E9%98%B2%E6%8A%A4%E7%9A%84%E7%9B%AE%E6%A0%87"><span class="toc-number">1.2.</span> <span class="toc-text">信息安全防护的目标</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%89%E5%85%A8%E9%98%B2%E6%8A%A4%E7%8E%AF%E8%8A%82"><span class="toc-number">1.3.</span> <span class="toc-text">安全防护环节</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%B8%B8%E8%A7%81%E7%9A%84%E5%AE%89%E5%85%A8%E6%94%BB%E5%87%BB-STRIDE"><span class="toc-number">1.4.</span> <span class="toc-text">常见的安全攻击 STRIDE</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%89%E5%85%A8%E8%AE%BE%E8%AE%A1%E5%9F%BA%E6%9C%AC%E5%8E%9F%E5%88%99"><span class="toc-number">1.5.</span> <span class="toc-text">安全设计基本原则</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%B8%B8%E7%94%A8%E5%AE%89%E5%85%A8%E6%8A%80%E6%9C%AF"><span class="toc-number">1.6.</span> <span class="toc-text">常用安全技术</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8A%A0%E5%AF%86%E7%AE%97%E6%B3%95%E5%92%8C%E5%8D%8F%E8%AE%AE"><span class="toc-number">1.7.</span> <span class="toc-text">加密算法和协议</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AF%B9%E7%A7%B0%E5%8A%A0%E5%AF%86%E7%AE%97%E6%B3%95"><span class="toc-number">1.7.1.</span> <span class="toc-text">对称加密算法</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%9D%9E%E5%AF%B9%E7%A7%B0%E5%8A%A0%E5%AF%86%E7%AE%97%E6%B3%95"><span class="toc-number">1.7.2.</span> <span class="toc-text">非对称加密算法</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%9D%9E%E5%AF%B9%E7%A7%B0%E5%8A%A0%E5%AF%86%E7%AE%97%E6%B3%95%E4%BB%8B%E7%BB%8D"><span class="toc-number">1.7.2.1.</span> <span class="toc-text">非对称加密算法介绍</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%9D%9E%E5%AF%B9%E7%A7%B0%E5%8A%A0%E5%AF%86%E5%AE%9E%E7%8E%B0%E5%8A%A0%E5%AF%86"><span class="toc-number">1.7.2.2.</span> <span class="toc-text">非对称加密实现加密</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%9D%9E%E5%AF%B9%E7%A7%B0%E5%8A%A0%E5%AF%86%E5%AE%9E%E7%8E%B0%E6%95%B0%E5%AD%97%E7%AD%BE%E5%90%8D"><span class="toc-number">1.7.2.3.</span> <span class="toc-text">非对称加密实现数字签名</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#RSA%E5%92%8CDSA"><span class="toc-number">1.7.2.4.</span> <span class="toc-text">RSA和DSA</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8D%95%E5%90%91%E5%93%88%E5%B8%8C%E7%AE%97%E6%B3%95"><span class="toc-number">1.7.3.</span> <span class="toc-text">单向哈希算法</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BB%BC%E5%90%88%E5%BA%94%E7%94%A8%E5%A4%9A%E7%A7%8D%E5%8A%A0%E5%AF%86%E7%AE%97%E6%B3%95"><span class="toc-number">1.7.4.</span> <span class="toc-text">综合应用多种加密算法</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0%E6%95%B0%E6%8D%AE%E5%8A%A0%E5%AF%86"><span class="toc-number">1.7.4.1.</span> <span class="toc-text">实现数据加密</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0%E6%95%B0%E5%AD%97%E7%AD%BE%E5%90%8D"><span class="toc-number">1.7.4.2.</span> <span class="toc-text">实现数字签名</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%BB%BC%E5%90%88%E5%8A%A0%E5%AF%86%E5%92%8C%E7%AD%BE%E5%90%8D"><span class="toc-number">1.7.4.3.</span> <span class="toc-text">综合加密和签名</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AF%86%E7%A0%81%E4%BA%A4%E6%8D%A2"><span class="toc-number">1.7.5.</span> <span class="toc-text">密码交换</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#CA%E5%92%8C%E8%AF%81%E4%B9%A6"><span class="toc-number">1.8.</span> <span class="toc-text">CA和证书</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%AD%E9%97%B4%E4%BA%BA%E6%94%BB%E5%87%BB"><span class="toc-number">1.8.1.</span> <span class="toc-text">中间人攻击</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#CA%E5%92%8C%E8%AF%81%E4%B9%A6-1"><span class="toc-number">1.8.2.</span> <span class="toc-text">CA和证书</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%89%E5%85%A8%E5%8D%8F%E8%AE%AE-SSL-TLS"><span class="toc-number">1.8.3.</span> <span class="toc-text">安全协议 SSL&#x2F;TLS</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#TLS-%E4%BB%8B%E7%BB%8D"><span class="toc-number">1.8.3.1.</span> <span class="toc-text">TLS 介绍</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#SSL-TLS%E7%BB%84%E6%88%90"><span class="toc-number">1.8.3.2.</span> <span class="toc-text">SSL&#x2F;TLS组成</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#HTTPS"><span class="toc-number">1.8.4.</span> <span class="toc-text">HTTPS</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#HTTPS-%E7%BB%93%E6%9E%84"><span class="toc-number">1.8.4.1.</span> <span class="toc-text">HTTPS 结构</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#HTTPS-%E5%B7%A5%E4%BD%9C%E7%9A%84%E7%AE%80%E5%8C%96%E8%BF%87%E7%A8%8B"><span class="toc-number">1.8.4.2.</span> <span class="toc-text">HTTPS 工作的简化过程</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#OpenSSL"><span class="toc-number">2.</span> <span class="toc-text">OpenSSL</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#OpenSSL-%E4%BB%8B%E7%BB%8D"><span class="toc-number">2.1.</span> <span class="toc-text">OpenSSL 介绍</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Base64-%E7%BC%96%E7%A0%81"><span class="toc-number">2.2.</span> <span class="toc-text">Base64 编码</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#openssl-%E5%91%BD%E4%BB%A4"><span class="toc-number">2.3.</span> <span class="toc-text">openssl 命令</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#openssl%E5%91%BD%E4%BB%A4%E5%8D%95%E5%90%91%E5%93%88%E5%B8%8C%E5%8A%A0%E5%AF%86"><span class="toc-number">2.3.1.</span> <span class="toc-text">openssl命令单向哈希加密</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#openssl-%E5%91%BD%E4%BB%A4%E7%94%9F%E6%88%90%E7%94%A8%E6%88%B7%E5%AF%86%E7%A0%81"><span class="toc-number">2.3.2.</span> <span class="toc-text">openssl 命令生成用户密码</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#openssl%E5%91%BD%E4%BB%A4%E7%94%9F%E6%88%90%E9%9A%8F%E6%9C%BA%E6%95%B0"><span class="toc-number">2.3.3.</span> <span class="toc-text">openssl命令生成随机数</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#openssl%E5%91%BD%E4%BB%A4%E5%AE%9E%E7%8E%B0-PKI"><span class="toc-number">2.3.4.</span> <span class="toc-text">openssl命令实现 PKI</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%BB%BA%E7%AB%8B%E7%A7%81%E6%9C%89CA%E5%AE%9E%E7%8E%B0%E8%AF%81%E4%B9%A6%E7%94%B3%E8%AF%B7%E9%A2%81%E5%8F%91"><span class="toc-number">2.4.</span> <span class="toc-text">建立私有CA实现证书申请颁发</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E7%A7%81%E6%9C%89CA"><span class="toc-number">2.4.1.</span> <span class="toc-text">创建私有CA</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%94%B3%E8%AF%B7%E8%AF%81%E4%B9%A6%E5%B9%B6%E9%A2%81%E5%8F%91%E8%AF%81%E4%B9%A6"><span class="toc-number">2.4.2.</span> <span class="toc-text">申请证书并颁发证书</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%90%8A%E9%94%80%E8%AF%81%E4%B9%A6"><span class="toc-number">2.4.3.</span> <span class="toc-text">吊销证书</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#CentOS-7-%E5%88%9B%E5%BB%BA%E8%87%AA%E7%AD%BE%E5%90%8D%E8%AF%81%E4%B9%A6"><span class="toc-number">2.4.4.</span> <span class="toc-text">CentOS 7 创建自签名证书</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9E%E6%88%98%E6%A1%88%E4%BE%8B%EF%BC%9A%E5%9C%A8CentOS8%E4%B8%8A%E5%AE%9E%E7%8E%B0%E7%A7%81%E6%9C%89CA%E5%92%8C%E8%AF%81%E4%B9%A6%E7%94%B3%E8%AF%B7"><span class="toc-number">2.4.5.</span> <span class="toc-text">实战案例：在CentOS8上实现私有CA和证书申请</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%9B%E5%BB%BACA%E7%9B%B8%E5%85%B3%E7%9B%AE%E5%BD%95%E5%92%8C%E6%96%87%E4%BB%B6"><span class="toc-number">2.4.5.1.</span> <span class="toc-text">创建CA相关目录和文件</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%9B%E5%BB%BACA%E7%9A%84%E7%A7%81%E9%92%A5"><span class="toc-number">2.4.5.2.</span> <span class="toc-text">创建CA的私钥</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%BB%99CA%E9%A2%81%E5%8F%91%E8%87%AA%E7%AD%BE%E5%90%8D%E8%AF%81%E4%B9%A6"><span class="toc-number">2.4.5.3.</span> <span class="toc-text">给CA颁发自签名证书</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%94%A8%E6%88%B7%E7%94%9F%E6%88%90%E7%A7%81%E9%92%A5%E5%92%8C%E8%AF%81%E4%B9%A6%E7%94%B3%E8%AF%B7"><span class="toc-number">2.4.5.4.</span> <span class="toc-text">用户生成私钥和证书申请</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#CA%E9%A2%81%E5%8F%91%E8%AF%81%E4%B9%A6"><span class="toc-number">2.4.5.5.</span> <span class="toc-text">CA颁发证书</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%9F%A5%E7%9C%8B%E8%AF%81%E4%B9%A6"><span class="toc-number">2.4.5.6.</span> <span class="toc-text">查看证书</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%B0%86%E8%AF%81%E4%B9%A6%E7%9B%B8%E5%85%B3%E6%96%87%E4%BB%B6%E5%8F%91%E9%80%81%E5%88%B0%E7%94%A8%E6%88%B7%E7%AB%AF%E4%BD%BF%E7%94%A8"><span class="toc-number">2.4.5.7.</span> <span class="toc-text">将证书相关文件发送到用户端使用</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%AF%81%E4%B9%A6%E7%9A%84%E4%BF%A1%E4%BB%BB"><span class="toc-number">2.4.5.8.</span> <span class="toc-text">证书的信任</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%AF%81%E4%B9%A6%E7%9A%84%E5%90%8A%E9%94%80"><span class="toc-number">2.4.5.9.</span> <span class="toc-text">证书的吊销</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%94%9F%E6%88%90%E8%AF%81%E4%B9%A6%E5%90%8A%E9%94%80%E5%88%97%E8%A1%A8%E6%96%87%E4%BB%B6"><span class="toc-number">2.4.5.10.</span> <span class="toc-text">生成证书吊销列表文件</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#ssh%E6%9C%8D%E5%8A%A1"><span class="toc-number">3.</span> <span class="toc-text">ssh服务</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#ssh%E6%9C%8D%E5%8A%A1%E4%BB%8B%E7%BB%8D"><span class="toc-number">3.1.</span> <span class="toc-text">ssh服务介绍</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%85%AC%E9%92%A5%E4%BA%A4%E6%8D%A2%E5%8E%9F%E7%90%86"><span class="toc-number">3.1.1.</span> <span class="toc-text">公钥交换原理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ssh%E5%8A%A0%E5%AF%86%E9%80%9A%E8%AE%AF%E5%8E%9F%E7%90%86"><span class="toc-number">3.1.2.</span> <span class="toc-text">ssh加密通讯原理</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#openssh-%E6%9C%8D%E5%8A%A1"><span class="toc-number">3.2.</span> <span class="toc-text">openssh 服务</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%A2%E6%88%B7%E7%AB%AF-ssh%E5%91%BD%E4%BB%A4"><span class="toc-number">3.2.1.</span> <span class="toc-text">客户端 ssh命令</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%85%B6%E5%AE%83ssh%E5%AE%A2%E6%88%B7%E7%AB%AF%E5%B7%A5%E5%85%B7"><span class="toc-number">3.2.2.</span> <span class="toc-text">其它ssh客户端工具</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#3-2-2-1-scp%E5%91%BD%E4%BB%A4"><span class="toc-number">3.2.2.1.</span> <span class="toc-text">3.2.2.1 scp命令</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#rsync-%E5%91%BD%E4%BB%A4"><span class="toc-number">3.2.2.2.</span> <span class="toc-text">rsync 命令</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#sftp%E5%91%BD%E4%BB%A4"><span class="toc-number">3.2.2.3.</span> <span class="toc-text">sftp命令</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%87%AA%E5%8A%A8%E7%99%BB%E5%BD%95-ssh%E5%B7%A5%E5%85%B7-sshpass"><span class="toc-number">3.2.2.4.</span> <span class="toc-text">自动登录 ssh工具 sshpass</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ssh%E7%99%BB%E5%BD%95%E9%AA%8C%E8%AF%81%E6%96%B9%E5%BC%8F%E4%BB%8B%E7%BB%8D"><span class="toc-number">3.2.3.</span> <span class="toc-text">ssh登录验证方式介绍</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0%E5%9F%BA%E4%BA%8E%E5%AF%86%E9%92%A5%E7%9A%84%E7%99%BB%E5%BD%95%E6%96%B9%E5%BC%8F"><span class="toc-number">3.2.4.</span> <span class="toc-text">实现基于密钥的登录方式</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ssh%E6%9C%8D%E5%8A%A1%E5%99%A8%E9%85%8D%E7%BD%AE"><span class="toc-number">3.2.5.</span> <span class="toc-text">ssh服务器配置</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%88%A9%E7%94%A8-sudo-%E5%AE%9E%E7%8E%B0%E6%8E%88%E6%9D%83"><span class="toc-number">4.</span> <span class="toc-text">利用 sudo 实现授权</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#sudo-%E4%BB%8B%E7%BB%8D"><span class="toc-number">4.1.</span> <span class="toc-text">sudo 介绍</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#sudo-%E7%BB%84%E6%88%90"><span class="toc-number">4.2.</span> <span class="toc-text">sudo 组成</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#sudo-%E5%91%BD%E4%BB%A4"><span class="toc-number">4.3.</span> <span class="toc-text">sudo 命令</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#sudo-%E6%8E%88%E6%9D%83%E8%A7%84%E5%88%99%E9%85%8D%E7%BD%AE"><span class="toc-number">4.4.</span> <span class="toc-text">sudo 授权规则配置</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%9E%E6%88%98%E6%A1%88%E4%BE%8B"><span class="toc-number">4.5.</span> <span class="toc-text">实战案例</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#PAM%E8%AE%A4%E8%AF%81%E6%9C%BA%E5%88%B6"><span class="toc-number">5.</span> <span class="toc-text">PAM认证机制</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#PAM-%E4%BB%8B%E7%BB%8D"><span class="toc-number">5.1.</span> <span class="toc-text">PAM 介绍</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#PAM%E6%9E%B6%E6%9E%84"><span class="toc-number">5.2.</span> <span class="toc-text">PAM架构</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#PAM%E7%9B%B8%E5%85%B3%E6%96%87%E4%BB%B6"><span class="toc-number">5.3.</span> <span class="toc-text">PAM相关文件</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#PAM%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86"><span class="toc-number">5.4.</span> <span class="toc-text">PAM工作原理</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#PAM-%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%E6%A0%BC%E5%BC%8F%E8%AF%B4%E6%98%8E"><span class="toc-number">5.5.</span> <span class="toc-text">PAM 配置文件格式说明</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#PAM%E6%A8%A1%E5%9D%97%E5%B8%AE%E5%8A%A9"><span class="toc-number">5.6.</span> <span class="toc-text">PAM模块帮助</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%B8%B8%E7%94%A8PAM%E6%A8%A1%E5%9D%97"><span class="toc-number">5.7.</span> <span class="toc-text">常用PAM模块</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#pam-nologin-so-%E6%A8%A1%E5%9D%97"><span class="toc-number">5.7.1.</span> <span class="toc-text">pam_nologin.so 模块</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#pam-limits-so-%E6%A8%A1%E5%9D%97"><span class="toc-number">5.7.2.</span> <span class="toc-text">pam_limits.so 模块</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#pam-google-authenticator-%E6%A8%A1%E5%9D%97"><span class="toc-number">5.7.3.</span> <span class="toc-text">pam_google_authenticator 模块</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%97%B6%E9%97%B4%E5%90%8C%E6%AD%A5%E6%9C%8D%E5%8A%A1"><span class="toc-number">6.</span> <span class="toc-text">时间同步服务</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%AE%A1%E6%97%B6%E6%96%B9%E5%BC%8F"><span class="toc-number">6.1.</span> <span class="toc-text">计时方式</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8F%A4%E4%BB%A3%E8%AE%A1%E6%97%B6%E6%96%B9%E5%BC%8F"><span class="toc-number">6.1.1.</span> <span class="toc-text">古代计时方式</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%8E%B0%E4%BB%A3%E8%AE%A1%E6%97%B6%E6%96%B9%E5%BC%8F"><span class="toc-number">6.1.2.</span> <span class="toc-text">现代计时方式</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%97%B6%E9%97%B4%E5%90%8C%E6%AD%A5%E6%9C%8D%E5%8A%A1-1"><span class="toc-number">6.2.</span> <span class="toc-text">时间同步服务</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#chrony"><span class="toc-number">6.3.</span> <span class="toc-text">chrony</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#chrony%E4%BB%8B%E7%BB%8D"><span class="toc-number">6.3.1.</span> <span class="toc-text">chrony介绍</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#chrony-%E6%96%87%E4%BB%B6%E7%BB%84%E6%88%90"><span class="toc-number">6.3.2.</span> <span class="toc-text">chrony 文件组成</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6chrony-conf"><span class="toc-number">6.3.3.</span> <span class="toc-text">配置文件chrony.conf</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#NTP-%E5%AE%A2%E6%88%B7%E7%AB%AF%E5%B7%A5%E5%85%B7"><span class="toc-number">6.3.4.</span> <span class="toc-text">NTP 客户端工具</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%85%AC%E5%85%B1NTP%E6%9C%8D%E5%8A%A1"><span class="toc-number">6.3.5.</span> <span class="toc-text">公共NTP服务</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%97%B6%E9%97%B4%E5%B7%A5%E5%85%B7"><span class="toc-number">6.3.6.</span> <span class="toc-text">时间工具</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9E%E6%88%98%E6%A1%88%E4%BE%8B-%E5%AE%9E%E7%8E%B0%E7%A7%81%E6%9C%89%E7%9A%84%E6%97%B6%E9%97%B4%E6%9C%8D%E5%8A%A1%E5%99%A8"><span class="toc-number">6.3.7.</span> <span class="toc-text">实战案例: 实现私有的时间服务器</span></a></li></ol></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2025/04/16/SRE-Keepalived/" title="高可用性集群Keepalived"><img src="/../images/SRE/day48/1.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="高可用性集群Keepalived"/></a><div class="content"><a class="title" href="/2025/04/16/SRE-Keepalived/" title="高可用性集群Keepalived">高可用性集群Keepalived</a><time datetime="2025-04-16T09:15:13.000Z" title="发表于 2025-04-16 17:15:13">2025-04-16</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2025/04/15/SRE-HAProxy/" title="高可用性集群HAProxy"><img src="/../images/SRE/day47/1.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="高可用性集群HAProxy"/></a><div class="content"><a class="title" href="/2025/04/15/SRE-HAProxy/" title="高可用性集群HAProxy">高可用性集群HAProxy</a><time datetime="2025-04-15T15:51:45.000Z" title="发表于 2025-04-15 23:51:45">2025-04-15</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2025/04/13/SRE-docker/" title="企业级容器技术Docker"><img src="/../images/SRE/day46/1.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="企业级容器技术Docker"/></a><div class="content"><a class="title" href="/2025/04/13/SRE-docker/" title="企业级容器技术Docker">企业级容器技术Docker</a><time datetime="2025-04-13T09:39:38.000Z" title="发表于 2025-04-13 17:39:38">2025-04-13</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2025/04/01/SRE-kvm/" title="企业级Linux虚拟化KVM"><img src="/../images/SRE/day41/21.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="企业级Linux虚拟化KVM"/></a><div class="content"><a class="title" href="/2025/04/01/SRE-kvm/" title="企业级Linux虚拟化KVM">企业级Linux虚拟化KVM</a><time datetime="2025-04-01T09:21:21.000Z" title="发表于 2025-04-01 17:21:21">2025-04-01</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2023 - 2025 By ૮(˶ᵔ ᵕ ᵔ˶)ა</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div><div class="footer_custom_text"><a target="_blank" rel="noopener" href="https://beian.miit.gov.cn/#/Integrated/index"><img src="../images/BEIAN/icp.png" width="15" height="15">豫ICP备2023009931号</a></br><a href="http://www.beian.gov.cn/portal/registerSystemInfo?recordcode=41162702000178" target="_blank"><img src="../images/BEIAN/beian.png" width="15" height="15">豫公网安备 41162702000178号</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.umd.min.js"></script><script src="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.js"></script><script>function panguFn () {
  if (typeof pangu === 'object') pangu.autoSpacingPage()
  else {
    getScript('https://cdn.jsdelivr.net/npm/pangu/dist/browser/pangu.min.js')
      .then(() => {
        pangu.autoSpacingPage()
      })
  }
}

function panguInit () {
  if (true){
    GLOBAL_CONFIG_SITE.isPost && panguFn()
  } else {
    panguFn()
  }
}

document.addEventListener('DOMContentLoaded', panguInit)</script><div class="js-pjax"></div><canvas id="universe"></canvas><script src="/js/universe.js"></script><canvas class="fireworks" mobile="true"></canvas><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/fireworks.min.js"></script><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/activate-power-mode.min.js"></script><script>POWERMODE.colorful = true;
POWERMODE.shake = false;
POWERMODE.mobile = false;
document.body.addEventListener('input', POWERMODE);
</script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>