<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>进程，系统性能和计划任务 | ૮(˶ᵔ ᵕ ᵔ˶)ა</title><meta name="author" content="૮(˶ᵔ ᵕ ᵔ˶)ა"><meta name="copyright" content="૮(˶ᵔ ᵕ ᵔ˶)ა"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="ffffff"><meta name="description" content="老马 2023 SRE">
<meta property="og:type" content="article">
<meta property="og:title" content="进程，系统性能和计划任务">
<meta property="og:url" content="http://example.com/2024/11/29/SRE-%E8%BF%9B%E7%A8%8B%EF%BC%8C%E7%B3%BB%E7%BB%9F%E6%80%A7%E8%83%BD%E5%92%8C%E8%AE%A1%E5%88%92%E4%BB%BB%E5%8A%A1/index.html">
<meta property="og:site_name" content="૮(˶ᵔ ᵕ ᵔ˶)ა">
<meta property="og:description" content="老马 2023 SRE">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://example.com/images/image/SRE/day13/22.png">
<meta property="article:published_time" content="2024-11-28T16:00:00.000Z">
<meta property="article:modified_time" content="2024-11-29T10:49:42.255Z">
<meta property="article:author" content="૮(˶ᵔ ᵕ ᵔ˶)ა">
<meta property="article:tag" content="SRE">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://example.com/images/image/SRE/day13/22.png"><link rel="shortcut icon" href="/../images/title/user.webp"><link rel="canonical" href="http://example.com/2024/11/29/SRE-%E8%BF%9B%E7%A8%8B%EF%BC%8C%E7%B3%BB%E7%BB%9F%E6%80%A7%E8%83%BD%E5%92%8C%E8%AE%A1%E5%88%92%E4%BB%BB%E5%8A%A1/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//fonts.googleapis.com" crossorigin=""/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Titillium+Web&amp;display=swap" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":false,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: true,
    post: true
  },
  runtime: '天',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: {"chs_to_cht":"你已切换为繁体","cht_to_chs":"你已切换为简体","day_to_night":"你已切换为深色模式","night_to_day":"你已切换为浅色模式","bgLight":"#49b1f5","bgDark":"#1f1f1f","position":"top-center"},
  source: {
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: true,
  }
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: '进程，系统性能和计划任务',
  isPost: true,
  isHome: false,
  isHighlightShrink: undefined,
  isToc: true,
  postUpdate: '2024-11-29 18:49:42'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
    win.getCSS = (url,id = false) => new Promise((resolve, reject) => {
      const link = document.createElement('link')
      link.rel = 'stylesheet'
      link.href = url
      if (id) link.id = id
      link.onerror = reject
      link.onload = link.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        link.onload = link.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(link)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', 'ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><link rel="stylesheet" href="/css/custom.css"  media="defer" onload="this.media='all'"><meta name="generator" content="Hexo 5.4.2"></head><body><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="/../images/title/user.webp" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">87</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">29</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">4</div></a></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间线</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('/../images/image/SRE/day13/22.png')"><nav id="nav"><span id="blog-info"><a href="/" title="૮(˶ᵔ ᵕ ᵔ˶)ა"><span class="site-name">૮(˶ᵔ ᵕ ᵔ˶)ა</span></a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间线</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">进程，系统性能和计划任务</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2024-11-28T16:00:00.000Z" title="发表于 2024-11-29 00:00:00">2024-11-29</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2024-11-29T10:49:42.255Z" title="更新于 2024-11-29 18:49:42">2024-11-29</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E5%AE%9D%E5%89%91%E9%94%8B%E4%BB%8E%E7%A3%A8%E7%A0%BA%E5%87%BA/">宝剑锋从磨砺出</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">字数总计:</span><span class="word-count">19.8k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>83分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="进程，系统性能和计划任务"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="进程和内存管理"><a href="#进程和内存管理" class="headerlink" title="进程和内存管理"></a>进程和内存管理</h1><p>内核功能：进程管理、内存管理、文件系统、网络功能、驱动程序、安全功能等。</p>
<p><img src="../../../../images/image/SRE/day13/1.png" alt="1"></p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cpu 没有空闲的概念，只有空转</span><br></pre></td></tr></table></figure>

<h2 id="什么是进程"><a href="#什么是进程" class="headerlink" title="什么是进程"></a>什么是进程</h2><p>进程是运行中的程序</p>
<p>Process: 运行中的程序的一个副本，是被载入内存的一个指令集合，是资源分配的单位</p>
<ul>
<li>进程 ID (Process ID, PID) 号码被用来标记各个进程</li>
<li>UID, GID, 和 SELinux 上下决定对文件系统的存取和访问权限</li>
<li>通常从执行进程的用户来继承</li>
<li>存在生命周期</li>
</ul>
<p>进程创建:</p>
<ul>
<li>init: 第一个进程，从 CentOS7 以后为 systemd</li>
<li>进程都由其父进程创建，fork(), 父子关系，CoW: Copy On Write</li>
</ul>
<p>每个进程都有自己的资源，由操作系统分配，内存，栈，文件描述符</p>
<p><strong>进程，线程</strong></p>
<p><img src="../../../../images/image/SRE/day13/2.png" alt="2"></p>
<p><strong>进程</strong></p>
<p>进程是一个具有一定独立功能的程序在一个数据集上的一次动态执行的过程，是操作系统进行资源分配和调度的一个独立单位，是应用程序运行的载体。进程是一种抽象的概念，从来没有统一的标准定义。</p>
<p><strong>进程的组成</strong></p>
<p>进程一般由程序、数据集合和进程控制块三部分组成。</p>
<p>程序用于描述进程要完成的功能，是控制进程执行的指令集；<br>数据集合是程序在执行时所需要的数据和工作区；<br>程序控制块（Program Control Block，简称PCB），包含进程的描述信息和控制信息，是进程存在的唯一标志。</p>
<p><strong>进程具有的特征：</strong></p>
<ul>
<li>动态性：进程是程序的一次执行过程，是临时的，有生命期的，是动态产生，动态消亡的；</li>
<li>并发性：任何进程都可以同其他进程一起并发执行；</li>
<li>独立性：进程是系统进行资源分配和调度的一个独立单位；</li>
<li>结构性：进程由程序、数据和进程控制块三部分组成。</li>
</ul>
<p><strong>线程</strong></p>
<p>在早期的操作系统中并没有线程的概念，<code>进程是能拥有资源和独立运行的最小单位，也是程序执行的最小单位</code>。任务调度采用的是时间片轮转的抢占式调度方式，而进程是任务调度的最小单位，每个进程有各自独立的一块内存，使得各个进程之间内存地址相互隔离。</p>
<p>后来，随着计算机的发展，对CPU的要求越来越高，进程之间的切换开销较大，已经无法满足越来越复杂的程序的要求了。于是就发明了线程。</p>
<p>线程是程序执行中一个单一的顺序控制流程，是程序执行流的最小单元，是处理器调度和分派的基本单位。一个进程可以有一个或多个线程，各个线程之间共享程序的内存空间（也就是所在进程的内存空间）。一个标准的线程由线程ID、当前指令指针（PC）、寄存器和堆栈组成。而进程由内存空间（代码、数据、进程空间、打开的文件）和一个或多个线程组成。</p>
<p><strong>进程与线程的区别</strong></p>
<p>进程是操作系统分配资源的最小单位 </p>
<p>进程是程序执行的CPU调用的最小单位 </p>
<p>线程是程序执行的CPU调度的最小单位 </p>
<p>一个进程由一个或多个线程组成，线程是一个进程中代码的不同执行路线； </p>
<p>进程之间相互独立，但同一进程下的各个线程之间共享程序的内存储空间（包括代码段、数据集、堆等）及一些进程级的资源（如打开文件和信号），某进程内的线程在其它进程不可见； 调度和切换：线程上下文切换比进程上下文切换要快得多。</p>
<p><strong>面试题：查看进程中的线程</strong> </p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">grep -i threads /proc/PID/status</span><br></pre></td></tr></table></figure>

<p>查看进程的二进制文件</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ll /proc/PID/exe</span><br></pre></td></tr></table></figure>

<p>查看进程打开的文件</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ll /proc/PID/fd/</span><br></pre></td></tr></table></figure>

<p><strong>并行和并发</strong></p>
<p><img src="../../../../images/image/SRE/day13/3.png" alt="3"></p>
<h2 id="进程结构"><a href="#进程结构" class="headerlink" title="进程结构"></a>进程结构</h2><p><img src="../../../../images/image/SRE/day13/4.png" alt="4"></p>
<p>内核把进程存放在叫做任务队列(task list)的双向循环链表中。</p>
<p>链表中的每一项都是类型为task_struct，称为进程控制块(Processing Control Control Block)，PCB中包含一个具体进程的所有信息。</p>
<p><img src="../../../../images/image/SRE/day13/5.png" alt="5"></p>
<p><img src="../../../../images/image/SRE/day13/6.png" alt="6"></p>
<p><strong>进程控制块 PCB 包含信息：</strong></p>
<ul>
<li>进程 id、用户 id 和组 id</li>
<li>程序计数器</li>
<li>进程的状态（有就绪、运行、阻塞）</li>
<li>进程切换时需要保存和恢复的 CPU 寄存器的值</li>
<li>描述虚拟地址空间的信息</li>
<li>描述控制终端的信息</li>
<li>当前工作目录</li>
<li>当前文件描述符表，包含很多指向 file 结构体的指针</li>
<li>文件描述符表，包含很多 ulimit -a 的指针</li>
<li>进程可以使用的资源上限（ulimit -a 命令可以查看）</li>
<li>输入输出状态：配置进程使用 I/O 设备</li>
</ul>
<h2 id="进程相关概念"><a href="#进程相关概念" class="headerlink" title="进程相关概念"></a>进程相关概念</h2><p>Page Frame: 页框，用于存储页面数据，存储Page 4k</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">[root@rocky8 ~]<span class="comment"># getconf -a | grep -i size</span></span><br><span class="line">PAGESIZE                           4096</span><br><span class="line">PAGE_SIZE                          4096</span><br><span class="line">SSIZE_MAX                          32767</span><br><span class="line">_POSIX_SSIZE_MAX                   32767</span><br><span class="line">_POSIX_THREAD_ATTR_STACKSIZE       200809</span><br><span class="line">FILESIZEBITS                       64</span><br><span class="line">POSIX_ALLOC_SIZE_MIN               4096</span><br><span class="line">POSIX_REC_INCR_XFER_SIZE           </span><br><span class="line">POSIX_REC_MAX_XFER_SIZE            </span><br><span class="line">POSIX_REC_MIN_XFER_SIZE            4096</span><br><span class="line">LEVEL1_ICACHE_SIZE                 32768</span><br><span class="line">LEVEL1_ICACHE_LINESIZE             64</span><br><span class="line">LEVEL1_DCACHE_SIZE                 32768</span><br><span class="line">LEVEL1_DCACHE_LINESIZE             64</span><br><span class="line">LEVEL2_CACHE_SIZE                  524288</span><br><span class="line">LEVEL2_CACHE_LINESIZE              64</span><br><span class="line">LEVEL3_CACHE_SIZE                  4194304</span><br><span class="line">LEVEL3_CACHE_LINESIZE              64</span><br><span class="line">LEVEL4_CACHE_SIZE                  0</span><br><span class="line">LEVEL4_CACHE_LINESIZE              0</span><br></pre></td></tr></table></figure>

<h3 id="物理地址空间和虚拟地址空间"><a href="#物理地址空间和虚拟地址空间" class="headerlink" title="物理地址空间和虚拟地址空间"></a>物理地址空间和虚拟地址空间</h3><p>MMU：Memory Management Unit 负责虚拟地址转换为物理地址</p>
<p>程序在访问一个内存地址指向的内存时，CPU 不是直接把这个地址送到内存总线上，而是被送到 MMU （Memory Management Unit），然后把内存地址映射到实际的物理内存地址上，然后通过总线再去访问内存，程序操作的地址称为虚拟内存地址。</p>
<p>TLB：Translation Lookaside Buffer 翻译后备缓冲区，用于保存虚拟地址和物理地址映射关系的缓存。</p>
<p><img src="../../../../images/image/SRE/day13/7.png" alt="7"></p>
<h3 id="用户和内核空间"><a href="#用户和内核空间" class="headerlink" title="用户和内核空间"></a>用户和内核空间</h3><p>内存有一部份分配给内核使用，一部份分配给应用程序使用，分别称为内核空间和用户空间；</p>
<p><img src="../../../../images/image/SRE/day13/8.png" alt="8"></p>
<h3 id="c代码和内存布局之间的对应关系"><a href="#c代码和内存布局之间的对应关系" class="headerlink" title="c代码和内存布局之间的对应关系"></a>c代码和内存布局之间的对应关系</h3><p><img src="../../../../images/image/SRE/day13/9.png" alt="9"></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> x;</span><br><span class="line"><span class="type">int</span> y=<span class="number">15</span>;</span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc,<span class="type">char</span> *argv[])</span>&#123;</span><br><span class="line">  </span><br><span class="line">  <span class="type">int</span> *values;</span><br><span class="line">  <span class="type">int</span> i;</span><br><span class="line">  </span><br><span class="line">  values=(<span class="type">int</span> *)<span class="built_in">malloc</span>(<span class="keyword">sizeof</span>(<span class="type">int</span>)*<span class="number">5</span>);</span><br><span class="line">  <span class="keyword">for</span>(i=<span class="number">0</span>;i&lt;<span class="number">5</span>;i++)&#123;</span><br><span class="line">    values[i]=i;</span><br><span class="line"> &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>每个进程都包括5种不同的数据段：</p>
<ul>
<li>代码段：用来存放可执行文件的操作指令，即它是可执行程序在内存中的镜像。代码段需要防止在运行时被非法修改，所以只准许读取操作，而不允许写入（修改）操作——它是不可写的。</li>
<li>数据段：用来存放可执行文件中已初始化全局变量，换句话说就是存放程序静态分配的变量和全局变量。</li>
<li>BSS段：Block Started by Symbol”的缩写，意为“以符号开始的块”。BSS包含了程序中未初始化的全局变量，在内存中bss段全部置零。</li>
<li>堆（heap）：存放数组和对象，堆是用于存放进程运行中被动态分配的内存段，它的大小并不固定，可动态扩张或缩减。当进程用malloc等函数分配内存时，新分配的内存就被自动添加到堆上（堆被扩张）；当利用free等函数释放内存时，被释放的内存从堆中被剔除（堆被缩减）。</li>
<li>栈（stack）：栈是用来存放程序临时创建的局部变量，也就是说我们函数括号“()”中定义的变量（但不包括static声明的变量，static意味着在数据段中存放变量）。此外以外，在函数被调用时，其参数也会被压入发起调用的进程栈中，并且等到调用结束后，函数的返回值也会被存放回栈中。由于栈的先进先出特点，所以栈特别方便用来保存/恢复调用现场。可以把栈看成一个暂存、交换临时数据的内存区。</li>
</ul>
<p><del>喝多了吐就是栈，吃多了拉就是队列</del></p>
<p><img src="../../../../images/image/SRE/day13/10.png" alt="10"></p>
<h3 id="进程使用内存问题"><a href="#进程使用内存问题" class="headerlink" title="进程使用内存问题"></a>进程使用内存问题</h3><h4 id="内存泄漏-Memory-Leak"><a href="#内存泄漏-Memory-Leak" class="headerlink" title="内存泄漏: Memory Leak"></a>内存泄漏: Memory Leak</h4><p>指程序中用 malloc 或 new 申请了一块内存，但是没有用 free 或 delete 将内存释放，导致这块内存一直处于占用状态。</p>
<h4 id="内存溢出-Memory-Over-Overflow"><a href="#内存溢出-Memory-Over-Overflow" class="headerlink" title="内存溢出: Memory Over Overflow"></a>内存溢出: Memory Over Overflow</h4><p>指程序申请了 10M 的空间，但是在这个空间写入 10M 以上字节的数据，就是溢出。</p>
<h4 id="内存不足-OOM"><a href="#内存不足-OOM" class="headerlink" title="内存不足: OOM"></a>内存不足: OOM</h4><p><img src="../../../../images/image/SRE/day13/11.png" alt="11"></p>
<p>OOM 即 Out Of Memory，“内存用完了”，在情况在 Java 程序中比较常见。系统会选择一个进程将之杀死，在日志 messages 中看到类似下面的提示：</p>
<p><strong>Jul 10 10:20:30 kernel: Out of memory: Kill process 9527 (java) score 88 or sacrifice child</strong></p>
<p>当 JVM 因为没有足够的内存来为对象分配空间并且垃圾回收器也已经没有空间可回收时，就会抛出这个 error，因为这个问题已经严重到不足以被应用处理。</p>
<p>原因：</p>
<ul>
<li>给应用分配内存太少：比如虚拟机本身可使用的内存（一般通过启动时的 VM 参数指定）太小。</li>
<li>应用用的太多，并且用完没释放，浪费了。此时就会造成内存泄露或者内存溢出。</li>
</ul>
<p>使用的解决办法：</p>
<ol>
<li>限制 Java 进程的max heap，并降低 Java 程序的 worker 数量，从而降低内存使用。</li>
<li>给系统增加 swap 空间。</li>
</ol>
<p>设置内核参数（不推荐），不允许内存申请过量：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> 2 &gt; /proc/sys/vm/overcommit_memory</span><br><span class="line"><span class="built_in">echo</span> 80 &gt; /proc/sys/vm/overcommit_ratio</span><br><span class="line"><span class="built_in">echo</span> 2 &gt; /proc/sys/vm/panic_on_oom</span><br></pre></td></tr></table></figure>

<p>说明：</p>
<p>Linux 默认是允许 memory overcommit 的，只要你来申请内存我就给你，寄希望于进程实际上用不到那么多内存，万一用到那么多了呢？</p>
<p>Linux 设计了一个 OOM killer 机制挑选一个进程出来杀死，以腾出部分内存，如果还不够就继续。也可通过设置内核参数 vm.panic_on_oom 使得发生 OOM 时自动重启系统。这都是有风险的机制，重启有可能造成业务中断，杀死进程也有可能导致业务中断。</p>
<p>所以 Linux 2.6之后允许通过内核参数 vm.overcommit_memory 禁止 memory overcommit。</p>
<p>vm.overcommit_memory 接受三种取值：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">0 - Heuristic overcommit handling. 这是缺省值，它允许 overcommit，但对于过于目张胆的 overcommit 会被拒绝，比如 malloc一次性申请的内存大小超过了系统总内存。Heuristic的意思是“试探式的”，内核利用某种算法猜测你的内存请求是否合理，它认为不合理就会拒绝 overcommit。</span><br><span class="line"></span><br><span class="line">1 - Always overcommit. 允许 overcommit，对内存申请者来者不拒。内核执行无内存过量使用处理。使用这个设置会增大内存超载的可能性，但也可以增强大量使用内存任务的性能。</span><br><span class="line"></span><br><span class="line">2 - Don’t overcommit. 禁止 overcommit。内存拒绝等于或者大于可用 swap 大小以及 overcommit_ratio 指定的物理 RAM 比例的内存请求。如果希望减小内存过度使用的风险，这个设置是最好的。</span><br></pre></td></tr></table></figure>

<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#查看当前系统超分设置</span></span><br><span class="line">[root@localhost ~]<span class="comment"># sysctl -a | grep overcommit_memory</span></span><br><span class="line">vm.overcommit_memory = 0</span><br></pre></td></tr></table></figure>

<h2 id="进程状态"><a href="#进程状态" class="headerlink" title="进程状态"></a>进程状态</h2><p><img src="../../../../images/image/SRE/day13/12.png" alt="12"></p>
<p><strong>进程的基本状态</strong></p>
<ul>
<li>创建状态：进程在创建时需要申请一个空白 PCB(process control block 进程控制块), 向其中填写控制和管理进程的信息, 完成资源分配。如果创建工作无法完成, 比如资源无法满足, 就无法被调度运行, 把此时进程所处状态称为创建状态</li>
<li>就绪状态：进程已准备好, 分配到所需资源, 只要分配到 CPU 就能够立即运行</li>
<li>执行状态：进程处于就绪状态被调度后, 进程进入执行状态</li>
<li>阻塞状态：正在执行的进程由于某些事件(I/O 请求, 申请缓存区失败)而暂时无法运行, 进程阻塞。在满足请求时进入就绪状态等待系统调用</li>
<li>终止状态：进程结束, 或出现错误事件或被系统终止, 进入终止状态。无法再执行</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#STAT 列就是进程状态</span></span><br><span class="line">[root@localhost ~]<span class="comment"># ps aux</span></span><br><span class="line">USER         PID %CPU %MEM   VSZ   RSS TTY     STAT START   TIME COMMAND</span><br><span class="line">root           1  0.0  1.3 183880 10688 ?       Ss   May26   0:07 </span><br><span class="line">/usr/lib/systemd/systemd --switched-root</span><br><span class="line">root           2  0.0  0.0      0     0 ?       S   May26   0:00 [kthreadd]</span><br><span class="line">root           3  0.0  0.0      0     0 ?       I&lt;   May26   0:00 [rcu_gp]</span><br><span class="line">root           4  0.0  0.0      0     0 ?       I&lt;   May26   0:00 [rcu_par_gp]</span><br></pre></td></tr></table></figure>

<p><strong>状态之间转换六种情况</strong></p>
<p>运行——&gt;就绪：1，主要是进程占用CPU的时间过长，而系统分配给该进程占用CPU的时间是有限的；2，在采用抢占式优先级调度算法的系统中，当有更高优先级的进程要运行时，该进程被迫让出CPU，该进程便由执行状态转变为就绪状态</p>
<p>就绪——&gt;运行：运行的进程的时间片用完，调度转到就绪队列中选择合适的进程分配CPU</p>
<p>运行——&gt;阻塞：正在执行的进程因发生某等待事件而无法执行，则进由执行状态变为阻塞状态，如发生了I/O请求</p>
<p>阻塞——&gt;就绪：进程所等待的事件已经发生，就进入就绪队列</p>
<p>以下两种状态是不可能发生的：</p>
<p>阻塞——&gt;运行：即使给阻塞进程分配CPU，也无法执行，操作系统在进行调度时不会从阻塞队列进行挑选，而是从就绪队列选取</p>
<p>就绪——&gt;阻塞：就绪态根本就没有执行，谈不上进入阻塞态</p>
<p>进程更多的状态：</p>
<ul>
<li>运行态：running</li>
<li>就绪态：ready</li>
<li>睡眠态：分为两种，可中断：interruptable，不可中断：uninterruptable</li>
<li>停止态：stopped，暂停于内存，但不会被调度，除非手动启动</li>
<li>僵死态：zombie，僵尸态，结束进程，父进程结束前，子进程不关闭，杀死父进程可以关闭僵死态的子进程</li>
</ul>
<p><img src="../../../../images/image/SRE/day13/13.png" alt="13"></p>
<p><strong>僵尸进程</strong></p>
<p>进程终止，父进程尚未回收，子进程残留资源(PCB)存放于内核中，变成僵尸(zombie)进程。</p>
<p>这样就会导致 如果进程不调用wait()或waitpid()的话，那么保留的那段信息就不会释放，其进程号就会一直被占用，但系统所能使用的进程号是有限的，如果大量产生僵尸进程，将因为没有可用进程号而导致系统不能产生新的进程，此即为僵尸进程的危害。</p>
<p>制造僵尸进程</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">[root@rocky8 ~]<span class="comment"># bash</span></span><br><span class="line">[root@rocky8 ~]<span class="comment"># echo $BASHPID</span></span><br><span class="line">15946</span><br><span class="line">[root@rocky8 ~]<span class="comment"># echo $PPID</span></span><br><span class="line">2830</span><br><span class="line"></span><br><span class="line"><span class="comment"># 将父进程设为停止态</span></span><br><span class="line">[root@rocky8 ~]<span class="comment"># kill -19 2830</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 杀死子进程，使其进入僵尸态</span></span><br><span class="line">[root@rocky8 ~]<span class="comment"># kill -9 15946</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 另开一个终端，可以开到上面图示结果，STAT为Z，表示为僵尸态</span></span><br><span class="line">[root@rocky8 ~]<span class="comment"># ps aux</span></span><br><span class="line">root       15946  0.0  0.0      0     0 pts/0    Z+   15:18   0:00 [bash] &lt;defunct&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 方法1：恢复父进程</span></span><br><span class="line">[root@rocky8 ~]<span class="comment"># kill -18 2830</span></span><br><span class="line"><span class="comment"># 方法2：杀死父进程</span></span><br><span class="line">[root@rocky8 ~]<span class="comment"># kill -9 2830</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 再次观察，可以发现僵尸态的进程不存在</span></span><br><span class="line">[root@rocky8 ~]<span class="comment"># ps aux</span></span><br></pre></td></tr></table></figure>

<p><strong>孤儿进程</strong></p>
<p>如果在子进程退出前，父进程先退出，这时子进程将成为孤儿进程，因为它的父进程已经死了。孤儿进程会被PID=1的systemd进程收养，成为systemd的子进程。注意，孤儿进程还会继续运行，而不会随父进程退出而终，只不过其父进程发生了改变。</p>
<p>范例：孤儿进程</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">[root@rocky8 ~]<span class="comment"># (sleep 100)&amp;</span></span><br><span class="line">[1] 1388</span><br><span class="line">[root@rocky8 ~]<span class="comment"># pstree -s `pidof sleep`</span></span><br><span class="line">systemd---sshd---sshd---sshd---bash---sleep</span><br><span class="line"></span><br><span class="line"><span class="comment"># 利用()实现当前shell的子进程,&amp;后台执行,子进程结束后</span></span><br><span class="line">[root@rocky8 ~]<span class="comment"># (sleep 100 &amp;)</span></span><br><span class="line">[root@rocky8 ~]<span class="comment"># sleep 100 &amp;</span></span><br><span class="line">[root@rocky8 ~]<span class="comment"># pstree -s `pidof sleep`</span></span><br><span class="line">systemd---sleep</span><br><span class="line"></span><br><span class="line">[root@rocky8 ~]<span class="comment"># cat orphan.sh</span></span><br><span class="line"><span class="comment">#!/bin/bash</span></span><br><span class="line">ping 127.0.0.1 &amp;</span><br><span class="line"><span class="built_in">echo</span> game over &amp;</span><br><span class="line"><span class="built_in">echo</span></span><br><span class="line"></span><br><span class="line">[root@rocky8 ~]<span class="comment"># bash orphan.sh</span></span><br><span class="line">game over</span><br><span class="line"></span><br><span class="line">[root@rocky8 ~]<span class="comment"># bash s `pid ping`</span></span><br><span class="line">systemd---ping</span><br></pre></td></tr></table></figure>

<h2 id="LRU-算法"><a href="#LRU-算法" class="headerlink" title="LRU 算法"></a>LRU 算法</h2><p>LRU：Least Recently Used 近期最少使用算法（喜新厌旧），释放内存</p>
<p><img src="../../../../images/image/SRE/day13/14.png" alt="14"></p>
<p>内存淘汰策略，让进程自己能依据某种规则来管理内存空间，保证程序不会因为内存耗尽而无法工作</p>
<p>范例：假设序列为4 3 4 2 3 1 4 2，物理块有3个，则</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">第1轮 4调入内存 4  </span><br><span class="line">第2轮 3调入内存 3 4  </span><br><span class="line">第3轮 4调入内存 4 3 </span><br><span class="line">第4轮 2调入内存 2 4 3  </span><br><span class="line">第5轮 3调入内存 3 2 4  </span><br><span class="line">第6轮 1调入内存 1 3 2  </span><br><span class="line">第7轮 4调入内存 4 1 3  </span><br><span class="line">第8轮 2调入内存 2 4 1</span><br></pre></td></tr></table></figure>

<h2 id="IPC进程间通信"><a href="#IPC进程间通信" class="headerlink" title="IPC进程间通信"></a>IPC进程间通信</h2><p>IPC：Inter Process Communication</p>
<ul>
<li>同一主机：</li>
</ul>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">pipe                   管道,单向传输</span><br><span class="line">socket                 套接字文件,双工通信</span><br><span class="line">Memory-mapped file     文件映射,将文件中的一段数据映射到物理内存,多个进程共享这片内存</span><br><span class="line">shm shared memory      共享内存</span><br><span class="line">signal                 信号</span><br><span class="line">Lock                   对资源上锁,如果资源已被某进程住,则其它进程想修改甚至读取这些资源,都将被阳塞,直到锁被打开</span><br><span class="line">semaphore              信号量,一种计数器，停车位</span><br></pre></td></tr></table></figure>

<ul>
<li>不同主机：socket=IP和端口号</li>
</ul>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">RPC remote procedure call</span><br><span class="line">MQ  消息队列，生产者和消费者，如：Kafka，RabbitMQ，ActiveMQ</span><br></pre></td></tr></table></figure>

<p>范例：利用管道文件实现IPC</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[root@centos ~]<span class="comment"># mkfifo /data/test.fifo</span></span><br><span class="line">[root@centos ~]<span class="comment"># ll /data/test.fifo</span></span><br><span class="line">prw-r--r-- 1 root root 0 May 6 14:22 /data/test.fifo</span><br><span class="line"></span><br><span class="line">[root@centos ~]<span class="comment"># cat &gt; /data/test.fifo</span></span><br><span class="line">magedu</span><br><span class="line"></span><br><span class="line"><span class="comment"># 在另一个终端可以读取文件中的数据</span></span><br><span class="line">[root@centos ~]<span class="comment"># cat /data/test.fifo</span></span><br><span class="line">magedu</span><br></pre></td></tr></table></figure>

<p>范例：查找socket文件</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@centos ~]<span class="comment"># find / -type s -ls</span></span><br></pre></td></tr></table></figure>

<h2 id="进程优先级"><a href="#进程优先级" class="headerlink" title="进程优先级"></a>进程优先级</h2><blockquote>
<p>linux2.6内核将任务优先级进行了一个划分，实时优先级范围是0到MAX_RT_PRIO-1（即99），而普通进程的静态优先级范围从MAX_RT_PRIO到MAX_PRIO-1（即100到139）、</p>
</blockquote>
<table>
<thead>
<tr>
<th>优先级范围</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>0–99</td>
<td>实时进程</td>
</tr>
<tr>
<td>100–139</td>
<td>非实时进程</td>
</tr>
</tbody></table>
<p><img src="../../../../images/image/SRE/day13/15.png" alt="15"></p>
<p>CentOS 优先级</p>
<p><img src="../../../../images/image/SRE/day13/16.png" alt="16"></p>
<p>进程优先级</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">系统优先级：0—139，数字越小，优先级越高，各有140个运行队列和过期队列</span><br><span class="line">实时优先级：99—0，值越大优先级越高</span><br><span class="line">nice值：-20到19，对应系统优先级100—139或</span><br></pre></td></tr></table></figure>

<p>查看nice值</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]<span class="comment"># ps axo pid,cmd,nice</span></span><br><span class="line">    PID CMD                          NI</span><br><span class="line">      1 /usr/lib/systemd/systemd --   0</span><br><span class="line">      2 [kthreadd]                    0</span><br><span class="line">      3 [rcu_gp]                    -20</span><br><span class="line">      4 [rcu_par_gp]                -20</span><br><span class="line">     13 [rcu_sched]                   0</span><br><span class="line">     14 [migration/0]                 -</span><br><span class="line">     15 [watchdog/0]                  - <span class="comment">#这里表示是内核进程，因为nice值最小是-20，所以此处无法显示</span></span><br></pre></td></tr></table></figure>

<p>用top 查看</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]<span class="comment"># top    </span></span><br><span class="line">    PID USER      PR  NI    VIRT    RES    SHR S  %CPU  %MEM     TIME+ COMMAND   </span><br><span class="line">    998 root      20   0  704224  30340  15968 S   0.7   1.7   1:18.01 tuned     </span><br><span class="line">    955 root      20   0  651820  12036  10016 S   0.3   0.7   0:50.21 vmtoolsd </span><br><span class="line">  18086 root      20   0  275324   5092   4184 R   0.3   0.3   0:00.06 top       </span><br><span class="line">      1 root      20   0  189364  11108   8180 S   0.0   0.6   0:02.83 systemd   </span><br><span class="line">      2 root      20   0       0      0      0 S   0.0   0.0   0:00.02 kthreadd </span><br><span class="line">      3 root       0 -20       0      0      0 I   0.0   0.0   0:00.00 rcu_gp   </span><br><span class="line">      4 root       0 -20       0      0      0 I   0.0   0.0   0:00.00 rcu_par_gp</span><br></pre></td></tr></table></figure>

<p>优先级越高，并不代表程序执行会更快，而是说在cpu调度时，给予更高的权重，最先执行</p>
<p>优先级决定的是执行顺序靠前，而不决定其程序本身要执行多久</p>
<p>修改进程优先级</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]<span class="comment"># renice -n -10 3734</span></span><br><span class="line">3734 (process ID) old priority 0, new priority -10</span><br><span class="line"></span><br><span class="line">[root@localhost ~]<span class="comment"># ps axo pid,cmd,nice | grep 3734</span></span><br><span class="line">   3734 ping www.baidu.com          -10</span><br><span class="line">   </span><br><span class="line"><span class="comment">#越界不会报错</span></span><br><span class="line">[root@localhost ~]<span class="comment"># renice -n -30 3734</span></span><br><span class="line">3734 (process ID) old priority 0, new priority -20</span><br></pre></td></tr></table></figure>

<p>发起进程时直接指定优先级</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]<span class="comment"># nice -n 11 ping www.baidu.com</span></span><br><span class="line"></span><br><span class="line">[root@localhost ~]<span class="comment"># ps axo pid,cmd,nice | grep ping</span></span><br><span class="line">   3887 ping www.baidu.com           11</span><br></pre></td></tr></table></figure>

<p>如果要设定某个程序的优先级，在启动时就直接指定，因为每次启动之后，PID的值都是不一样的</p>
<h2 id="进程分类"><a href="#进程分类" class="headerlink" title="进程分类"></a>进程分类</h2><p><strong>操作系统分类：</strong></p>
<ul>
<li><p>协作式多任务：早期 windows 系统使用，即一个任务得到了 CPU 时间，除非它自己放弃使用 CPU ，否则将完全霸占 CPU ，所以任务之间需要协作——使用一段时间的 CPU 主动放弃使用</p>
</li>
<li><p>抢占式多任务：Linux 内核，CPU 的总控制权在操作系统手中，操作系统会轮流询问每一个任务是否需要使用 CPU ，需要使用的话就让它用，不过在一定时间后，操作系统会剥夺当前任务的 CPU 使用权，把它排在询问队列的最后，再去询问下一个任务</p>
</li>
</ul>
<p><strong>进程类型</strong></p>
<ul>
<li><p>守护进程：daemon，在系统引导过程中启动的进程，和终端无关进程</p>
</li>
<li><p>前台进程：跟终端相关，通过终端启动的进程</p>
</li>
</ul>
<p>注意：两者可相互转化</p>
<p><strong>按进程资源使用的分类：</strong></p>
<ul>
<li><p>CPU-Bound：CPU 密集型，非交互</p>
</li>
<li><p>IO-Bound：IO 密集型，交互</p>
</li>
</ul>
<h1 id="进程管理和性能相关的工具"><a href="#进程管理和性能相关的工具" class="headerlink" title="进程管理和性能相关的工具"></a>进程管理和性能相关的工具</h1><p>参考链接：<a target="_blank" rel="noopener" href="http://www.brendangregg.com/linuxperf.html">http://www.brendangregg.com/linuxperf.html</a></p>
<p><img src="../../../../images/image/SRE/day13/17.png" alt="17"></p>
<p>Linux系统状态的查看及管理工具：</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pstree, ps, pidof, pgrep, top, htop, glance, pmap, vmstat, dstat, kill, pkill, job, bg, fg, nohup</span><br></pre></td></tr></table></figure>



<h2 id="进程树pstree"><a href="#进程树pstree" class="headerlink" title="进程树pstree"></a>进程树pstree</h2><p>pstree 可以用来显示进程的父子关系，以树结构显示</p>
<p>常用选项：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">pstree [-acglpsStuZ] [ -h | -H PID ] [ -n | -N <span class="built_in">type</span> ] [ -A | -G | -U ] [ PID | USER ]</span><br><span class="line">              </span><br><span class="line"><span class="comment">#常用选项</span></span><br><span class="line">-a|--arguments               <span class="comment">#显示该进程的完整指令及参数</span></span><br><span class="line">-A|--ascii                   <span class="comment">#使用 ASCII 字符绘制线条</span></span><br><span class="line">-c|--compact                 <span class="comment">#不压缩相同的子树</span></span><br><span class="line">-h|--highlight-al            <span class="comment">#高亮显示当前进程及父进程</span></span><br><span class="line">-H PID|--highlight-pid=PID   <span class="comment">#高亮显示指定进程及父进程</span></span><br><span class="line">-g|--show-pgids              <span class="comment">#显示进程组ID,包含 -c 选项</span></span><br><span class="line">-G|--vt100                   <span class="comment">#使用VT100线条绘制字符</span></span><br><span class="line">-l|--long                    <span class="comment">#不要截断长线</span></span><br><span class="line">-n|--numeric-sort            <span class="comment">#根据PID排序显示</span></span><br><span class="line">-N <span class="built_in">type</span>|--ns-sort=<span class="built_in">type</span>       <span class="comment">#根据指定规则排序(cgroup|ipc|mnt|net|pid|user|uts)</span></span><br><span class="line">-p|--show-pids               <span class="comment">#显示PID，包含 -c 选项</span></span><br><span class="line">-s|--show-parents            <span class="comment">#显示父进程</span></span><br><span class="line">-S|--ns-changes              <span class="comment">#显示命名空间</span></span><br><span class="line">-t|--thread-names            <span class="comment">#显示完整线程名称</span></span><br><span class="line">-T|--hide-threads            <span class="comment">#不显示线程</span></span><br><span class="line">-u|--uid-changes             <span class="comment">#显示进程切换</span></span><br><span class="line">-Z|--security-context        <span class="comment">#显示selinux相关信息</span></span><br></pre></td></tr></table></figure>

<p>范例：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#显示进程切换</span></span><br><span class="line">[root@localhost ~]<span class="comment"># pstree -u | grep jose</span></span><br><span class="line">       |      `-sshd---sshd---bash---su---bash(jose)---passwd(root)</span><br><span class="line"></span><br><span class="line"><span class="comment">#显示指定用户的进程        </span></span><br><span class="line">[root@localhost ~]<span class="comment"># pstree jose</span></span><br><span class="line">bash───passwd</span><br><span class="line"></span><br><span class="line"><span class="comment">#显示父进程</span></span><br><span class="line">[root@localhost ~]<span class="comment"># pstree 11916</span></span><br><span class="line">passwd</span><br><span class="line"></span><br><span class="line">[root@localhost ~]<span class="comment"># pstree -p 11916</span></span><br><span class="line">passwd(11916)</span><br><span class="line"></span><br><span class="line">[root@localhost ~]<span class="comment"># pstree -sp 11916</span></span><br><span class="line">systemd(1)───sshd(1146)───sshd(11860)───sshd(11864)───bash(11867)───passwd(11916)</span><br><span class="line"></span><br><span class="line"><span class="comment">#不显示线程</span></span><br><span class="line">[root@localhost ~]<span class="comment"># pstree -pT | grep httpd</span></span><br><span class="line">           |-httpd(1331)-+-httpd(1428)</span><br><span class="line">           |             |-httpd(1435)</span><br><span class="line">           |             |-httpd(1436)</span><br><span class="line">           |             `-httpd(1444)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#高亮显示当前进程</span></span><br><span class="line">[root@localhost ~]<span class="comment"># pstree -h</span></span><br><span class="line">systemd─┬─ModemManager───2*[&#123;ModemManager&#125;]</span><br><span class="line">       ├─sshd─┬─sshd───sshd───bash</span><br><span class="line">       │     ├─sshd───sshd───bash───pstree</span><br><span class="line">       │     └─sshd───sshd───bash───su───bash───passwd</span><br></pre></td></tr></table></figure>

<h2 id="进程信息-ps"><a href="#进程信息-ps" class="headerlink" title="进程信息 ps"></a>进程信息 ps</h2><p>ps 即 process state，可以进程当前状态的快照，默认显示当前终端的进程，Linux系统各进程的相关信息均保存在/proc/PID目录下的各文件中</p>
<p>ps格式</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ps [OPTION]...</span><br></pre></td></tr></table></figure>

<p>支持三种选项：</p>
<ul>
<li>UNIX选项  如： -A     -e</li>
<li>GNU选项   如： –help</li>
<li>BSD选项    如： a</li>
</ul>
<p>常用选项：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">a                    <span class="comment">#选项包括所有终端中的进程</span></span><br><span class="line">x                    <span class="comment">#选项包括不链接终端的进程</span></span><br><span class="line">u                    <span class="comment">#选项显示进程所有者的相关信息</span></span><br><span class="line">f                    <span class="comment">#选项显示进程树，相当于 --forest</span></span><br><span class="line">k|--show             <span class="comment">#属性对属性排序，属性前加 - 表示倒序</span></span><br><span class="line">o                    <span class="comment">#属性... 选项显示定制的信息 pid,cmd,%cpu,%mem</span></span><br><span class="line">L                    <span class="comment">#显示支持的属性列表</span></span><br><span class="line">-C cmdlist           <span class="comment">#指定命令，多个命令用 , 分割</span></span><br><span class="line">-L                   <span class="comment">#显示线程</span></span><br><span class="line">-e                   <span class="comment">#显示完整格式的进程，相当于-A</span></span><br><span class="line">-f                   <span class="comment">#显示完整格式程序信息</span></span><br><span class="line">-F                   <span class="comment">#显示更完整格式的进程信息</span></span><br><span class="line">-H                   <span class="comment">#以层级格式显示进程相关信息</span></span><br><span class="line">-u userlist          <span class="comment">#指定有效的用户ID或名称</span></span><br><span class="line">-U userlist          <span class="comment">#指定真正的用户ID或名称</span></span><br><span class="line">-g gid或groupname    <span class="comment">#指定有效的gid或组名称</span></span><br><span class="line">-G gid或groupname    <span class="comment">#指定真正的gid或组名称</span></span><br><span class="line">-p pid               <span class="comment">#显示pid的进程</span></span><br><span class="line">-ppid pid            <span class="comment">#指定的pid的子进程</span></span><br><span class="line">-t ttylist           <span class="comment">#指定tty，相当于 t</span></span><br><span class="line">-M                   <span class="comment">#显示SELinux信息，相当于Z</span></span><br></pre></td></tr></table></figure>

<p><strong>ps 输出信息</strong></p>
<table>
<thead>
<tr>
<th>字段</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>USER</td>
<td>进程属主</td>
</tr>
<tr>
<td>PID</td>
<td>进程ID</td>
</tr>
<tr>
<td>PPID</td>
<td>父进程ID</td>
</tr>
<tr>
<td>%CPU</td>
<td>CPU使用率</td>
</tr>
<tr>
<td>%MEM</td>
<td>内存占用率</td>
</tr>
<tr>
<td>VSZ</td>
<td>Virtual memory Size，虚拟内存集，线性内存，虚拟内存</td>
</tr>
<tr>
<td>RSS</td>
<td>ReSident Size，常驻内存集，实际占用物理内存</td>
</tr>
<tr>
<td>TTY</td>
<td>终端</td>
</tr>
<tr>
<td>STAT</td>
<td>进程状态</td>
</tr>
<tr>
<td>START</td>
<td>进程开始时间</td>
</tr>
<tr>
<td>TIME</td>
<td>累计分配给进程的cpu时长</td>
</tr>
<tr>
<td>COMMAND</td>
<td>对应的程序及参数</td>
</tr>
<tr>
<td>UID</td>
<td>进程属主</td>
</tr>
<tr>
<td>C</td>
<td>cpu利用率，取整</td>
</tr>
<tr>
<td>STIME</td>
<td>进程开始时间</td>
</tr>
<tr>
<td>CMD</td>
<td>对应程序及参数</td>
</tr>
<tr>
<td>ni</td>
<td>nice值</td>
</tr>
<tr>
<td>pri</td>
<td>priority优先级</td>
</tr>
<tr>
<td>rtprio</td>
<td>实时优先级</td>
</tr>
<tr>
<td>psr</td>
<td>processor CPU编号</td>
</tr>
</tbody></table>
<p><strong>进程状态字段说明</strong></p>
<p><img src="../../../../images/image/SRE/day13/18.png" alt="18"></p>
<p><strong>可中断睡眠和不可中断睡眠</strong></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">可中断睡眠态的进程在睡眠状态下等待特定事件发生，即使特定事件没有产生，也可以通过其它手段唤醒该进程，比如，发信号，释放某些资源等。</span><br><span class="line"></span><br><span class="line">不可中断睡眠态的进程在也是在睡眠状态下等待特定事件发生，但其只能被特定事件唤醒，发信号或其它方法都无效</span><br><span class="line"></span><br><span class="line">发送给不可中断睡眠状态的进程的信号会被丢弃</span><br><span class="line"></span><br><span class="line">打个比方</span><br><span class="line"></span><br><span class="line">可中断睡眠态的进程和不可中断睡眠态的进程是两位睡美人</span><br><span class="line"></span><br><span class="line">不可中断睡眠态的进程只能被王子吻醒</span><br><span class="line"></span><br><span class="line">可中断睡眠态的进程可以被王子吻醒，也可以被青蛙吻醒</span><br></pre></td></tr></table></figure>

<p><strong>常用组合：</strong></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#显示所有所有进程，并列出属主</span></span><br><span class="line">ps aux</span><br><span class="line"></span><br><span class="line"><span class="comment">#显示所有所有进程，并列出属主</span></span><br><span class="line">ps -ef</span><br><span class="line"></span><br><span class="line"><span class="comment">#详细格式显示所有进程</span></span><br><span class="line">ps -eFH</span><br><span class="line"></span><br><span class="line"><span class="comment">#显示指定列</span></span><br><span class="line">ps -eo pid,tid,class,rtprio,ni,pri,psr,pcpu,<span class="built_in">stat</span>,<span class="built_in">comm</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#显示指定列</span></span><br><span class="line">ps -axo <span class="built_in">stat</span>,euid,ruid,<span class="built_in">tty</span>,tpgid,sess,pgrp,ppid,pid,pcpu,<span class="built_in">comm</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#查询你拥有的所有进程</span></span><br><span class="line">ps -x</span><br><span class="line"></span><br><span class="line"><span class="comment">#显示指定用户名(RUID)或用户ID的进程</span></span><br><span class="line">ps -fU apache</span><br><span class="line">ps -fU 48</span><br><span class="line"></span><br><span class="line"><span class="comment">#显示指定用户名(EUID)或用户ID的进程</span></span><br><span class="line">ps -fu wang</span><br><span class="line">ps -fu 1000</span><br><span class="line"></span><br><span class="line"><span class="comment">#查看以root用户权限（实际和有效ID）运行的每个进程</span></span><br><span class="line">ps -U root -u root</span><br><span class="line"></span><br><span class="line"><span class="comment">#列出某个组拥有的所有进程（实际组ID：RGID或名称）</span></span><br><span class="line">ps -fG nginx</span><br><span class="line"></span><br><span class="line"><span class="comment">#列出有效组名称（或会话）所拥有的所有进程</span></span><br><span class="line">ps -<span class="built_in">fg</span> mysql</span><br><span class="line">ps -<span class="built_in">fg</span> 27</span><br><span class="line"></span><br><span class="line"><span class="comment">#显示指定的进程ID对应的进程</span></span><br><span class="line">ps -fp 1234</span><br><span class="line"></span><br><span class="line"><span class="comment">#以父进程ID来显示其下所有的进程，如显示父进程为1234的所有进程</span></span><br><span class="line">ps -f --ppid 1234</span><br><span class="line"></span><br><span class="line"><span class="comment">#显示指定PID的多个进程</span></span><br><span class="line">ps -fp 1204,1239,1263</span><br><span class="line"></span><br><span class="line"><span class="comment">#要按tty显示所属进程</span></span><br><span class="line">ps -ft pts/0</span><br><span class="line"></span><br><span class="line"><span class="comment">#以进程树显示系统中的进程如何相互链接</span></span><br><span class="line">ps -e --forest</span><br><span class="line"></span><br><span class="line"><span class="comment">#以进程树显示指定的进程</span></span><br><span class="line">ps -f --forest -C sshd</span><br><span class="line">ps -ef --forest | grep -v grep | grep sshd</span><br><span class="line"></span><br><span class="line"><span class="comment">#要显示一个进程的所有线程,将显示LWP（轻量级进程）以及NLWP（轻量级进程数）列</span></span><br><span class="line">ps -fL -C nginx</span><br><span class="line"></span><br><span class="line"><span class="comment">#要列出所有格式说明符</span></span><br><span class="line">ps L</span><br><span class="line"></span><br><span class="line"><span class="comment">#查看进程的PID，PPID，用户名和命令</span></span><br><span class="line">ps -eo pid,ppid,user,cmd</span><br><span class="line"></span><br><span class="line"><span class="comment">#自定义格式显示文件系统组,ni值开始时间和进程的时间</span></span><br><span class="line">ps -p 1234 -o pid,ppid,fgroup,ni,lstart,etime</span><br><span class="line"></span><br><span class="line"><span class="comment">#使用其PID查找进程名称：</span></span><br><span class="line">ps -p 1244 -o <span class="built_in">comm</span>= <span class="comment">#要以其名称选择特定进程，显示其所有子进程</span></span><br><span class="line">ps -C sshd,bash</span><br><span class="line"></span><br><span class="line"><span class="comment">#查找指定进程名所有的所属PID，在编写需要从std输出或文件读取PID的脚本时这个参数很有用</span></span><br><span class="line">ps -C httpd,sshd -o pid= <span class="comment">#检查一个进程的执行时间</span></span><br><span class="line">ps -eo <span class="built_in">comm</span>,etime,user | grep nginx</span><br><span class="line"></span><br><span class="line"><span class="comment">#排序，查找占用最多内存和CPU的进程</span></span><br><span class="line">ps -eo pid,ppid,cmd,%mem,%cpu --<span class="built_in">sort</span>=-%mem | <span class="built_in">head</span></span><br><span class="line">ps -eo pid,ppid,cmd,%mem,%cpu --<span class="built_in">sort</span>=-%cpu | <span class="built_in">head</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#显示安全信息</span></span><br><span class="line">ps -eM</span><br><span class="line">ps --context</span><br><span class="line"></span><br><span class="line"><span class="comment">#使用以下命令以用户定义的格式显示安全信息</span></span><br><span class="line">ps -eo euser,ruser,suser,fuser,f,<span class="built_in">comm</span>,label</span><br><span class="line"></span><br><span class="line"><span class="comment">#使用watch实用程序执行重复的输出以实现对就程进行实时的监视，如下面的命令显示每秒钟的监视</span></span><br><span class="line">watch -n 1 <span class="string">&#x27;ps -eo pid,ppid,cmd,%mem,%cpu --sort=-%mem | head&#x27;</span></span><br></pre></td></tr></table></figure>

<p>范例：默认只显示当前终端进程</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]<span class="comment"># ps</span></span><br><span class="line">    PID TTY          TIME CMD</span><br><span class="line">   5596 pts/0    00:00:00 bash</span><br><span class="line">   6631 pts/0    00:00:00 ps</span><br></pre></td></tr></table></figure>

<p>范例：查看进程详细信息</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 列 C 表示 CPU 利用率</span></span><br><span class="line">[root@rocky8 ~]<span class="comment"># ps -ef</span></span><br><span class="line">UID          PID    PPID  C STIME TTY          TIME CMD</span><br><span class="line">root           1       0  6 15:06 ?        00:00:01 /usr/lib/systemd/systemd --s</span><br><span class="line">root           2       0  0 15:06 ?        00:00:00 [kthreadd]</span><br><span class="line">root           3       2  0 15:06 ?        00:00:00 [rcu_gp]</span><br><span class="line">root           4       2  0 15:06 ?        00:00:00 [rcu_par_gp]</span><br><span class="line"></span><br><span class="line"><span class="comment">#查看进程详细信息</span></span><br><span class="line">[root@rocky8 ~]<span class="comment"># ps aux</span></span><br><span class="line">USER         PID %CPU %MEM    VSZ   RSS TTY      STAT START   TIME COMMAND</span><br><span class="line">root           1  4.0  0.7 175064 13504 ?        Ss   15:06   0:01 /usr/lib/syst</span><br><span class="line">root           2  0.0  0.0      0     0 ?        S    15:06   0:00 [kthreadd]</span><br><span class="line">root           3  0.0  0.0      0     0 ?        I&lt;   15:06   0:00 [rcu_gp]</span><br></pre></td></tr></table></figure>

<p>范例：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看进程的父子关系</span></span><br><span class="line">[root@rocky8 ~]<span class="comment"># ps auxf</span></span><br><span class="line">USER         PID %CPU %MEM    VSZ   RSS TTY      STAT START   TIME COMMAND</span><br><span class="line">root           2  0.0  0.0      0     0 ?        S    15:06   0:00 [kthreadd]</span><br><span class="line">root           3  0.0  0.0      0     0 ?        I&lt;   15:06   0:00  \_ [rcu_gp]</span><br><span class="line">root           4  0.0  0.0      0     0 ?        I&lt;   15:06   0:00  \_ [rcu_par_gp]</span><br><span class="line">root           5  0.0  0.0      0     0 ?        I&lt;   15:06   0:00  \_ [slub_flushwq]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看进程的特定属性</span></span><br><span class="line">[root@rocky8 ~]<span class="comment"># ps axo pid,cmd,%mem,%cpu</span></span><br><span class="line">    PID CMD                         %MEM %CPU</span><br><span class="line">      1 /usr/lib/systemd/systemd --  0.7  1.2</span><br><span class="line">      2 [kthreadd]                   0.0  0.0</span><br><span class="line">      3 [rcu_gp]                     0.0  0.0</span><br><span class="line">      4 [rcu_par_gp]                 0.0  0.0</span><br><span class="line">      5 [slub_flushwq]               0.0  0.0</span><br></pre></td></tr></table></figure>

<p>范例：排序</p>
<p>针对属性排序，CentOS6 以下版本不支持</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 按cpu利用率排序</span></span><br><span class="line">root@rocky8 ~]<span class="comment"># ps aux k -%cpu</span></span><br><span class="line">USER         PID %CPU %MEM    VSZ   RSS TTY      STAT START   TIME COMMAND</span><br><span class="line">root           1  0.8  0.7 175064 13504 ?        Ss   15:06   0:02 /usr/lib/syst</span><br><span class="line">root         864  0.3  1.6 408592 29208 ?        Ssl  15:06   0:00 /usr/libexec/</span><br><span class="line">root         835  0.1  0.6 353020 10840 ?        Ssl  15:06   0:00 /usr/bin/vmto</span><br><span class="line">root           2  0.0  0.0      0     0 ?        S    15:06   0:00 [kthreadd]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@rocky8 ~]<span class="comment"># ps axo pid,cmd,%cpu,%mem k -%cpu</span></span><br><span class="line">    PID CMD                         %CPU %MEM</span><br><span class="line">      1 /usr/lib/systemd/systemd --  0.5  0.7</span><br><span class="line">    864 /usr/libexec/platform-pytho  0.3  1.6</span><br><span class="line">      2 [kthreadd]                   0.0  0.0</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 按内存倒序排序</span></span><br><span class="line">[root@rocky8 ~]<span class="comment"># ps axo pid,cmd,%cpu,%mem --sort -%mem</span></span><br><span class="line">    PID CMD                         %CPU %MEM</span><br><span class="line">    864 /usr/libexec/platform-pytho  0.2  1.6</span><br><span class="line">   1809 /usr/lib/polkit-1/polkitd -  0.0  1.2</span><br><span class="line">    830 /usr/sbin/NetworkManager --  0.0  1.0</span><br><span class="line">    942 /usr/sbin/httpd -DFOREGROUN  0.0  1.0</span><br><span class="line">    943 /usr/sbin/httpd -DFOREGROUN  0.0  0.9</span><br><span class="line">    945 /usr/sbin/httpd -DFOREGROUN  0.0  0.9</span><br><span class="line">      1 /usr/lib/systemd/systemd --  0.4  0.7</span><br></pre></td></tr></table></figure>

<p>范例：有效用户和实际用户</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[jose@localhost ~]$ passwd</span><br><span class="line">Changing password <span class="keyword">for</span> user jose.</span><br><span class="line">Current password: </span><br><span class="line">[root@localhost ~]<span class="comment"># ps axo pid,cmd,%cpu,%mem,user,euser,ruser | grep passwd</span></span><br><span class="line">   6512 passwd                       0.0  1.0 root     root     jose</span><br><span class="line">   6515 grep --color=auto passwd     0.0  0.1 root     root     root</span><br></pre></td></tr></table></figure>





<h2 id="查看进程信息-prtstat"><a href="#查看进程信息-prtstat" class="headerlink" title="查看进程信息 prtstat"></a>查看进程信息 prtstat</h2><p>可以显示进程信息，来自于 psmisc 包</p>
<p>此命令显的数据，都来自于 /proc/PID/ 目录，此命令加以整理，以格式化形式显示</p>
<p>格式：</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">prtstat [OPTIONS] PID ...</span><br><span class="line">#选项</span><br><span class="line">-r|--raw   #信息的原始显示</span><br></pre></td></tr></table></figure>

<p>范例：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#或取ping命令进程编号</span></span><br><span class="line">[jose@localhost ~]$ pidof ping</span><br><span class="line">7260</span><br><span class="line"></span><br><span class="line"><span class="comment">#显示进程信息</span></span><br><span class="line">[jose@localhost ~]$ prtstat 7260</span><br><span class="line">Process: ping                   State: S (sleeping)</span><br><span class="line"> CPU<span class="comment">#: 0             TTY: 136:0     Threads: 1</span></span><br><span class="line">Process, Group and Session IDs</span><br><span class="line"> Process ID: 7260               Parent ID: 6925</span><br><span class="line">   Group ID: 7260               Session ID: 6925</span><br><span class="line"> T Group ID: 7260</span><br><span class="line">Page Faults</span><br><span class="line"> This Process   (minor major):      288         0</span><br><span class="line"> Child Processes (minor major):        0         0</span><br><span class="line">CPU Times</span><br><span class="line"> This Process   (user system guest blkio):   0.00   0.01   0.00   0.00</span><br><span class="line"> Child processes (user system guest):         0.00   0.00   0.00</span><br><span class="line"></span><br><span class="line">Memory</span><br><span class="line"> Vsize:       271 MB    </span><br><span class="line"> RSS:         5218 kB                   RSS Limit: 18446744073709 MB</span><br><span class="line"> Code Start: 0x1                       Code Stop: 0x1       </span><br><span class="line"> Stack Start: 0         </span><br><span class="line"> Stack Pointer (ESP):          0       Inst Pointer (EIP):          0</span><br><span class="line">Scheduling</span><br><span class="line"> Policy: normal</span><br><span class="line"> Nice:   0             RT Priority: 0 (non RT)</span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line"><span class="comment">#按原始内容显示  </span></span><br><span class="line">[jose@localhost ~]$ prtstat -r 7260</span><br><span class="line">         pid: 7260                                <span class="built_in">comm</span>: ping</span><br><span class="line">       state: S                                   ppid: 6925</span><br><span class="line">        pgrp: 7260                             session: 6925</span><br><span class="line">      tty_nr: 34816                              tpgid: 7260</span><br><span class="line">       flags: 404000                            minflt: 288</span><br><span class="line">     cminflt: 0                                 majflt: 0</span><br><span class="line">     cmajflt: 0                                  utime: 0</span><br><span class="line">       stime: 1                                 cutime: 0</span><br><span class="line">      cstime: 0                               priority: 20</span><br><span class="line">        <span class="built_in">nice</span>: 0                            num_threads: 1</span><br><span class="line"> itrealvalue: 0                              starttime: 2412053</span><br><span class="line">       vsize: 271425536                            rss: 1274</span><br><span class="line">      rsslim: 18446744073709551615           startcode: 1</span><br><span class="line">     endcode: 1                             startstack: 0</span><br><span class="line">     kstkesp: 0                                kstkeip: 0</span><br><span class="line">       wchan: 0                                  nswap: 0</span><br><span class="line">      cnswap: 0                            exit_signal: 17</span><br><span class="line">   processor: 0                            rt_priority: 0</span><br><span class="line">      policy: 0                  delayaccr_blkio_ticks: 0</span><br><span class="line">  guest_time: 0                            cguest_time: 0</span><br></pre></td></tr></table></figure>

<h2 id="设置和调整进程优先级"><a href="#设置和调整进程优先级" class="headerlink" title="设置和调整进程优先级"></a>设置和调整进程优先级</h2><p>进程优先级调整</p>
<ul>
<li>静态优先级：100-139</li>
<li>进程默认启动时 nice 值为0，优先级120</li>
<li>只有跟用户才能降低 nice 值（提高优先性）</li>
</ul>
<p>nice 命令</p>
<p>以指定的优先级来启动进程</p>
<p>格式：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">nice</span> [OPTION] [COMMAND [ARG]...]</span><br><span class="line"></span><br><span class="line"><span class="comment">#选项</span></span><br><span class="line">-n|--adjustment=N            <span class="comment">#以指定优先级运行程序</span></span><br></pre></td></tr></table></figure>

<p>范例：设定进程优先级</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]<span class="comment"># nice -n -10 ping 127.0.0.1</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#查看</span></span><br><span class="line">[root@localhost ~]$ ps axo pid,cmd,<span class="built_in">nice</span> |grep ping</span><br><span class="line">   7981 ping 127.0.0.1              -10</span><br><span class="line">   7992 grep --color=auto ping        0</span><br></pre></td></tr></table></figure>



<p><strong>renice 命令</strong></p>
<p>可以调整正在执行中的进程的优先级</p>
<p>格式：</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">renice [-n] priority pid ...</span><br></pre></td></tr></table></figure>

<p>查看</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ps axo pid,<span class="built_in">comm</span>,ni</span><br></pre></td></tr></table></figure>

<p>范例：修改进程优先级</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]<span class="comment"># renice -n -20 7981</span></span><br><span class="line">7981 (process ID) old priority -10, new priority -20</span><br><span class="line"></span><br><span class="line"><span class="comment">#查看</span></span><br><span class="line">[root@localhost ~]<span class="comment"># ps axo pid,cmd,nice |grep ping</span></span><br><span class="line">   7981 ping 127.0.0.1              -20</span><br><span class="line">   8082 grep --color=auto ping        0</span><br></pre></td></tr></table></figure>

<h2 id="搜索进程"><a href="#搜索进程" class="headerlink" title="搜索进程"></a>搜索进程</h2><p>进程搜索的常用命令：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">ps options | grep <span class="string">&#x27;pattern&#x27;</span></span><br><span class="line"></span><br><span class="line">pgrep [options] pattern</span><br><span class="line"></span><br><span class="line">/sbin/pidof PID</span><br></pre></td></tr></table></figure>



<h3 id="pgrep"><a href="#pgrep" class="headerlink" title="pgrep"></a>pgrep</h3><p>格式</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">pgrep [options] pattern</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#常用选项</span></span><br><span class="line">-d|--delimiter &lt;string&gt; specify output delimiter</span><br><span class="line">-l|--list-name               <span class="comment">#列出进程ID和进程名</span></span><br><span class="line">-a|--list-full               <span class="comment">#显示详细完整的进程信息</span></span><br><span class="line">-v|--inverse                 <span class="comment">#取反</span></span><br><span class="line">-w|--lightweight             <span class="comment">#显示线程ID</span></span><br><span class="line">-c|--count                   <span class="comment">#统计匹配到的进程数量</span></span><br><span class="line">-f|--full                    <span class="comment">#使用完整的进程名匹配</span></span><br><span class="line">-g|--pgroup &lt;PGID,...&gt;       <span class="comment">#指定进程的属组作为条件</span></span><br><span class="line">-G|--group &lt;GID,...&gt;         <span class="comment">#指定 real group IDs 作为条件</span></span><br><span class="line">-P|--parent &lt;PPID,...&gt;       <span class="comment">#显示指定进程的子进程</span></span><br><span class="line">-s|--session &lt;SID,...&gt;       <span class="comment">#根据会话ID显示</span></span><br><span class="line">-t|--terminal &lt;<span class="built_in">tty</span>,...&gt;      <span class="comment">#显示指定终端的进程</span></span><br><span class="line">-u|--euid &lt;ID,...&gt;           <span class="comment">#指定 effective UIDs</span></span><br><span class="line">-U|--uid &lt;ID,...&gt;            <span class="comment">#指定 real IDs，真实用户</span></span><br><span class="line">-x|--exact                   <span class="comment">#根据指定的命令匹配</span></span><br><span class="line">-F|--pidfile &lt;file&gt;          <span class="comment">#从文件中读取PID作为条件</span></span><br></pre></td></tr></table></figure>

<p>范例：查找指定终端的进程</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@rocky86 ~]<span class="comment"># pgrep -at pts/1</span></span><br><span class="line">2785 -bash</span><br><span class="line">2842 su - jose</span><br><span class="line">2843 -bash</span><br></pre></td></tr></table></figure>

<p>范例：发起用户和生效用户</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#普通用户发起passwd 进程</span></span><br><span class="line">[jose@rocky86 ~]$ passwd</span><br><span class="line">Changing password <span class="keyword">for</span> user jose.</span><br><span class="line">Current password: </span><br><span class="line"></span><br><span class="line"><span class="comment">#实际进程属主是root</span></span><br><span class="line">[root@rocky86 ~]<span class="comment"># ps aux | grep passwd</span></span><br><span class="line">root       15440  0.0  0.4 331172  8564 pts/1   S+   22:24   0:00 passwd</span><br><span class="line"></span><br><span class="line"><span class="comment">#查看user 和 ruser</span></span><br><span class="line">[root@localhost ~]<span class="comment"># ps axo pid,cmd,user,ruser</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#根据 real user查找</span></span><br><span class="line">[root@rocky86 ~]<span class="comment"># pgrep -aU jose</span></span><br><span class="line">2843 -bash</span><br><span class="line">15440 passwd</span><br></pre></td></tr></table></figure>

<h3 id="pidof"><a href="#pidof" class="headerlink" title="pidof"></a>pidof</h3><p>查看相关命令的进程</p>
<p>格式</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">pidof [options] [program [...]]</span><br><span class="line"></span><br><span class="line"><span class="comment">#常用选项</span></span><br><span class="line">-s|--single-shot             <span class="comment">#多个结果时只显示一条</span></span><br><span class="line">-x                           <span class="comment">#按照脚本名称查找</span></span><br><span class="line">-o|--omit-pid &lt;PID,...&gt;      <span class="comment">#不显示指定的pid</span></span><br></pre></td></tr></table></figure>

<p>范例：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]<span class="comment"># pidof bash</span></span><br><span class="line">8274 8023 6925 994</span><br><span class="line"></span><br><span class="line"><span class="comment">#只显示一个进程号</span></span><br><span class="line">[root@localhost ~]<span class="comment"># pidof -s bash</span></span><br><span class="line">8274</span><br><span class="line"></span><br><span class="line"><span class="comment">#按文件名查找</span></span><br><span class="line">[root@localhost ~]<span class="comment"># ./0528/ping.sh </span></span><br><span class="line">[root@localhost ~]<span class="comment"># pidof -x ping.sh</span></span><br><span class="line">8629</span><br><span class="line"></span><br><span class="line">[root@localhost ~]<span class="comment"># ps aux | grep 8629</span></span><br><span class="line">root        8629  0.0  0.4 222528  3200 pts/1   S+   08:53   0:00 /bin/bash ./0528/ping.sh</span><br><span class="line"></span><br><span class="line"><span class="comment">#如果将文件名当bash的参数，则无法用-x 查找</span></span><br><span class="line">[root@localhost ~]<span class="comment"># bash ./0528/ping.sh </span></span><br><span class="line"></span><br><span class="line">[root@localhost ~]<span class="comment"># pidof -x ping.sh</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#忽略某些pid</span></span><br><span class="line">[jose@localhost ~]$ pidof httpd</span><br><span class="line">1444 1436 1435 1428 1331</span><br><span class="line"></span><br><span class="line">[jose@localhost ~]$ pidof -o 1444,1435 httpd</span><br><span class="line">1436 1428 1331</span><br></pre></td></tr></table></figure>

<h2 id="负载查询-uptime"><a href="#负载查询-uptime" class="headerlink" title="负载查询 uptime"></a>负载查询 uptime</h2><p>范例：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[root@rocky86 ~]<span class="comment"># uptime</span></span><br><span class="line">08:55:54 up 11:03,  3 <span class="built_in">users</span>, load average: 0.00, 0.01, 0.00</span><br><span class="line"></span><br><span class="line">08:55:54                            <span class="comment">#系统当前时间</span></span><br><span class="line">up 11:03                            <span class="comment">#系统己开机运行时长，10小时50分钟</span></span><br><span class="line">3 <span class="built_in">users</span>                             <span class="comment">#当前有三个用户登录</span></span><br><span class="line">load average: 0.00, 0.01, 0.00      <span class="comment">#系统的平均负载，1分钟，5分钟，15分钟</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#查看变化</span></span><br><span class="line">[root@rocky86 ~]<span class="comment"># ping -f 127.1</span></span><br><span class="line"></span><br><span class="line">[root@rocky86 ~]<span class="comment"># uptime</span></span><br></pre></td></tr></table></figure>

<p>w命令</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@rocky86 ~]<span class="comment"># w</span></span><br><span class="line">08:55:55 up 11:03,  3 <span class="built_in">users</span>, load average: 0.00, 0.01, 0.00</span><br><span class="line">USER      TTY     FROM             LOGIN@   IDLE   JCPU   PCPU WHAT</span><br><span class="line">root     pts/0    10.0.0.1         Tue19   10:05m  0.33s  0.33s -bash</span><br><span class="line">root     pts/1    10.0.0.1         Tue20   10:31m  0.16s  0.12s -bash</span><br><span class="line">root     pts/2    10.0.0.1         08:40    3.00s  0.03s  0.00s w</span><br></pre></td></tr></table></figure>

<p>系统平均负载：指在特定时间间隔内运行队列中的平均进程数,通常每个CPU内核的当前活动进程数不大于3，那么系统的性能良好。如果每个CPU内核的任务数大于5，那么此主机的性能有严重问题。 </p>
<p>如：linux主机是1个双核CPU，当Load Average 为6的时候说明机器已经被充分使用</p>
<h2 id="显示CPU相关统计-mpstat"><a href="#显示CPU相关统计-mpstat" class="headerlink" title="显示CPU相关统计 mpstat"></a>显示CPU相关统计 mpstat</h2><p>来自于 sysstat 包</p>
<p>安装：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@rocky ~]<span class="comment"># yum install sysstat -y</span></span><br></pre></td></tr></table></figure>

<p>格式：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">mpstat [ options ] [ &lt;interval&gt; [ &lt;count&gt; ] ]</span><br><span class="line"></span><br><span class="line"><span class="comment">#常用选项</span></span><br><span class="line">-P &#123;cpu_list|ALL&#125;              <span class="comment">#查看指定CPU，可以写成 0,1,2 0-2   2-</span></span><br><span class="line">-I &#123;SUM|CPU|SCPU|ALL&#125;          <span class="comment">#显示指定中断数</span></span><br><span class="line">-o JSON                        <span class="comment">#以JSON格式输出</span></span><br></pre></td></tr></table></figure>

<p>范例：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#查看当前主机所有cpu运行情况</span></span><br><span class="line">[root@rocky86 ~]<span class="comment"># mpstat</span></span><br><span class="line">Linux 4.18.0-372.9.1.el8.x86_64 (rocky86.m51.magedu.com) 08/24/2022 _x86_64_ </span><br><span class="line">(2 CPU)</span><br><span class="line">09:13:00 AM CPU   %usr   %<span class="built_in">nice</span>   %sys %iowait   %irq   %soft %steal %guest </span><br><span class="line">%gnice   %idle</span><br><span class="line">09:13:00 AM all    0.73    0.01    0.49    0.35    0.92    0.30    0.00    0.00 </span><br><span class="line">   0.00   97.19</span><br><span class="line">   </span><br><span class="line"><span class="comment">#查看第一颗cpu运行情况</span></span><br><span class="line">[root@rocky86 ~]<span class="comment"># mpstat -P 0</span></span><br><span class="line">Linux 4.18.0-372.9.1.el8.x86_64 (rocky86.m51.magedu.com) 08/24/2022 _x86_64_ </span><br><span class="line">(2 CPU)</span><br><span class="line">09:13:37 AM CPU   %usr   %<span class="built_in">nice</span>   %sys %iowait   %irq   %soft %steal %guest </span><br><span class="line">%gnice   %idle</span><br><span class="line">09:13:37 AM    0    0.75    0.01    0.48    0.00    0.89    0.26    0.00    0.00 </span><br><span class="line">   0.00   97.61</span><br><span class="line">   </span><br><span class="line"><span class="comment">#查看所有</span></span><br><span class="line">[root@rocky86 ~]<span class="comment"># mpstat -P ALL</span></span><br><span class="line">Linux 4.18.0-372.9.1.el8.x86_64 (rocky86.m51.magedu.com) 08/24/2022 _x86_64_ </span><br><span class="line">(2 CPU)</span><br><span class="line">05:11:23 PM CPU   %usr   %<span class="built_in">nice</span>   %sys %iowait   %irq   %soft %steal %guest </span><br><span class="line">%gnice   %idle</span><br><span class="line">05:11:23 PM all    0.16    0.00    0.23    0.68    0.22    0.10    0.00    0.00 </span><br><span class="line">   0.00   98.61</span><br><span class="line">05:11:23 PM    0    0.17    0.00    0.25    0.00    0.22    0.11    0.00    0.00 </span><br><span class="line">   0.00   99.25</span><br><span class="line">05:11:23 PM    1    0.15    0.01    0.21    1.35    0.23    0.09    0.00    0.00 </span><br><span class="line">   0.00   97.97</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>输出字段说明</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">%user                       <span class="comment">#用户空间，应用程序占比</span></span><br><span class="line">%<span class="built_in">nice</span>                       <span class="comment">#以nice优先级运行的进程用户态时间</span></span><br><span class="line">%sys                        <span class="comment">#内核空间，内核占比</span></span><br><span class="line">%iowait                     <span class="comment">#io等待占比</span></span><br><span class="line">%irq                        <span class="comment">#硬中断占比</span></span><br><span class="line">%soft                       <span class="comment">#软中断占比</span></span><br><span class="line">%steal                      <span class="comment">#虚拟化消耗占比</span></span><br><span class="line">%guest                      <span class="comment">#运行虚拟化主机cpu自身时间的占比</span></span><br><span class="line">%gnice                      <span class="comment">#运行虚拟cpu上的nice 进程的占比</span></span><br><span class="line">%idle                       <span class="comment">#空闲时间占比</span></span><br></pre></td></tr></table></figure>



<h2 id="查看进程实时状态-top-和-htop"><a href="#查看进程实时状态-top-和-htop" class="headerlink" title="查看进程实时状态 top 和 htop"></a>查看进程实时状态 top 和 htop</h2><h3 id="top"><a href="#top" class="headerlink" title="top"></a>top</h3><p><img src="../../../../images/image/SRE/day13/19.png" alt="19"></p>
<p><img src="../../../../images/image/SRE/day13/20.png" alt="20"></p>
<p>top 提供动态的实时进程状态</p>
<p>有许多内置命令</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">帮助：h 或 ？ ，按 q 或esc 退出帮助</span><br><span class="line"></span><br><span class="line">排序：</span><br><span class="line">P：以占据的CPU百分比,%CPU</span><br><span class="line">M：占据内存百分比,%MEM</span><br><span class="line">T：累积占据CPU时长,TIME+</span><br><span class="line"></span><br><span class="line">首部信息显示：</span><br><span class="line"><span class="built_in">uptime</span>信息：l命令</span><br><span class="line">tasks及cpu信息：t命令</span><br><span class="line">cpu分别显示：1 (数字)</span><br><span class="line">memory信息：m命令</span><br><span class="line"></span><br><span class="line">退出命令：q</span><br><span class="line">修改刷新时间间隔：s</span><br><span class="line">终止指定进程：k</span><br><span class="line">保存文件：W</span><br></pre></td></tr></table></figure>

<p>top命令栏位信息简介</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">us：用户空间</span><br><span class="line">sy：内核空间</span><br><span class="line">ni：调整nice时间</span><br><span class="line">id：空闲</span><br><span class="line">wa：等待IO时间</span><br><span class="line">hi：硬中断</span><br><span class="line">si：软中断（模式切换）</span><br><span class="line">st：虚拟机偷走的时间</span><br></pre></td></tr></table></figure>

<p>top选项：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">-c             <span class="comment">#显示命令信息</span></span><br><span class="line">-d <span class="comment">#           #指定刷新时间间隔，默认为3秒</span></span><br><span class="line">-b             <span class="comment">#全部显示所有进程</span></span><br><span class="line">-n <span class="comment">#           #刷新多少次后退出</span></span><br><span class="line">-H             <span class="comment">#线程模式</span></span><br><span class="line">-u user        <span class="comment">#查看指定用户的进程</span></span><br></pre></td></tr></table></figure>

<p>示例：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">top -H -p `pidof mysqld`</span><br></pre></td></tr></table></figure>

<p>范例:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@ubuntu2004 ~]<span class="comment"># top -u postgres -c</span></span><br></pre></td></tr></table></figure>

<p><img src="../../../../images/image/SRE/day13/21.png" alt="21"></p>
<h3 id="htop"><a href="#htop" class="headerlink" title="htop"></a>htop</h3><p><img src="../../../../images/image/SRE/day13/22.png" alt="22"></p>
<p>选项：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">-d <span class="comment">#: 指定延迟时间；</span></span><br><span class="line">-u UserName: 仅显示指定用户的进程</span><br><span class="line">-s COLUME: 以指定字段进行排序</span><br></pre></td></tr></table></figure>

<p>子命令：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">s：跟踪选定进程的系统调用</span><br><span class="line">l：显示选定进程打开的文件列表</span><br><span class="line">a：将选定的进程绑定至某指定CPU核心</span><br><span class="line">t：显示进程树</span><br></pre></td></tr></table></figure>

<h2 id="内存空间-free"><a href="#内存空间-free" class="headerlink" title="内存空间 free"></a>内存空间 free</h2><p><img src="../../../../images/image/SRE/day13/23.png" alt="23"></p>
<p>free 可以显示内存空间使用状态</p>
<p>格式：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">free [OPTION]</span><br></pre></td></tr></table></figure>

<p>常用选项：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">-b               <span class="comment">#以字节为单位</span></span><br><span class="line">-m               <span class="comment">#以MB为单位</span></span><br><span class="line">-g               <span class="comment">#以GB为单位</span></span><br><span class="line">-h               <span class="comment">#易读格式</span></span><br><span class="line">-o               <span class="comment">#不显示-/+buffers/cache行</span></span><br><span class="line">-t               <span class="comment">#显示RAM + swap的总和</span></span><br><span class="line">-s n             <span class="comment">#刷新间隔为n秒</span></span><br><span class="line">-c n             <span class="comment">#刷新n次后即退出</span></span><br></pre></td></tr></table></figure>

<p>向/proc/sys/vm/drop_caches中写入相应的修改值，会清理缓存。建议先执行sync（sync 命令将所有未写的系统缓冲区写到磁盘中，包含已修改的 i-node、已延迟的块 I/O 和读写映射文件）。执行echo  1、2、3 至/proc/sys/vm/drop_caches, 达到不同的清理目的</p>
<p>如果因为是应用有像内存泄露、溢出的问题时，从swap的使用情况是可以比较快速可以判断的，但通过执行free 反而比较难查看。但核心并不会因为内存泄露等问题并没有快速清空buffer或cache（默认值是0），生产也不应该随便去改变此值。</p>
<p>一般情况下，应用在系统上稳定运行了，free值也会保持在一个稳定值的。当发生内存不足、应用获取不到可用内存、OOM错误等问题时，还是更应该去分析应用方面的原因，否则，清空buffer，强制腾出free的大小，可能只是把问题给暂时屏蔽了。 </p>
<p>排除内存不足的情况外，除非是在软件开发阶段，需要临时清掉buffer，以判断应用的内存使用情况；或应用已经不再提供支持，即使应用对内存的时候确实有问题，而且无法避免的情况下，才考虑定时清空buffer。 </p>
<p>范例: </p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[root@centos6 ~]<span class="comment">#free </span></span><br><span class="line">             total       used       free     shared   buffers     cached</span><br><span class="line">Mem:       1003020     177964     825056        240      16604      59932</span><br><span class="line">-/+ buffers/cache:     101428     901592</span><br><span class="line">Swap:      2097148          0    2097148</span><br><span class="line"></span><br><span class="line">root@ubuntu2004:~<span class="comment"># free -h</span></span><br><span class="line">             total       used       free     shared buff/cache   available</span><br><span class="line">Mem:          1.9Gi       338Mi       167Mi       1.0Mi       1.4Gi       1.4Gi</span><br><span class="line">Swap:         2.0Gi         0B       2.0Gi</span><br></pre></td></tr></table></figure>

<p>说明: man 5 proc</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ~]<span class="comment">#man proc</span></span><br><span class="line">......</span><br><span class="line">/proc/sys/vm/drop_caches (since Linux 2.6.16)</span><br><span class="line">Writing to this file causes the kernel to drop clean caches, dentries, and </span><br><span class="line">inodes from memory, causing that memory to become free. This can be useful <span class="keyword">for</span></span><br><span class="line">memory management testing and performing reproducible filesystem </span><br><span class="line">benchmarks.Because writing to this file causes the benefits of caching to be lost, it can degrade overall system performance.</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">To free pagecache, use:</span><br><span class="line"><span class="built_in">echo</span> 1 &gt; /proc/sys/vm/drop_caches</span><br><span class="line"></span><br><span class="line">To free dentries and inodes, use:</span><br><span class="line"><span class="built_in">echo</span> 2 &gt; /proc/sys/vm/drop_caches</span><br><span class="line"></span><br><span class="line">To free pagecache, dentries and inodes, use:</span><br><span class="line"><span class="built_in">echo</span> 3 &gt; /proc/sys/vm/drop_caches</span><br><span class="line"></span><br><span class="line">Because writing to this file is a nondestructive operation and dirty objects are not freeable, the user should run <span class="built_in">sync</span>(1) first</span><br></pre></td></tr></table></figure>

<p>范例: 清理缓存</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ~]<span class="comment"># cat /proc/sys/vm/drop_caches</span></span><br><span class="line">0</span><br><span class="line"></span><br><span class="line">[root@centos8 ~]<span class="comment"># dd if=/dev/zero of=/f1.img bs=1M count=1024</span></span><br><span class="line"></span><br><span class="line">[root@centos8 ~]<span class="comment"># free -h</span></span><br><span class="line">             total       used       free     shared buff/cache   available</span><br><span class="line">Mem:          1.8Gi       355Mi       724Mi       9.0Mi       726Mi       1.2Gi</span><br><span class="line">Swap:         2.0Gi         0B       2.0Gi</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@centos8 ~]<span class="comment">#echo 3 &gt; /proc/sys/vm/drop_caches</span></span><br><span class="line">[root@centos8 ~]<span class="comment">#free -h</span></span><br><span class="line">             total       used       free     shared buff/cache   available</span><br><span class="line">Mem:          1.8Gi       320Mi       1.3Gi       9.0Mi       152Mi       1.3Gi</span><br><span class="line">Swap:         2.0Gi         0B       2.0Gi</span><br></pre></td></tr></table></figure>

<h2 id="进程对应的内存映射-pmap"><a href="#进程对应的内存映射-pmap" class="headerlink" title="进程对应的内存映射 pmap"></a>进程对应的内存映射 pmap</h2><p>格式：</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pmap [options] pid [...]</span><br></pre></td></tr></table></figure>

<p>常用选项</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-x: 显示详细格式的信息</span><br></pre></td></tr></table></figure>

<p>范例：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pmap 1</span><br></pre></td></tr></table></figure>

<p>另外一种实现</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> /proc/PID/maps</span><br></pre></td></tr></table></figure>

<p>范例:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ~]<span class="comment">#pmap 33477</span></span><br><span class="line">33477:   ping 127.0.0.1</span><br><span class="line">000055f708aa7000     56K r-x-- ping</span><br><span class="line">000055f708cb5000      4K r---- ping</span><br><span class="line">000055f708cb6000      4K rw--- ping</span><br><span class="line">000055f708cb7000    140K rw---   [ anon ]</span><br><span class="line">000055f70a7cc000    132K rw---   [ anon ]</span><br><span class="line">00007fe73fb13000   2528K r---- LC_COLLATE</span><br><span class="line">00007fe73fd8b000    108K r-x-- libpthread-2.28.so</span><br><span class="line">00007fe73fda6000   2044K ----- libpthread-2.28.so</span><br><span class="line">00007fe73ffa5000      4K r---- libpthread-2.28.so</span><br><span class="line">00007fe73ffa6000      4K rw--- libpthread-2.28.so</span><br><span class="line">00007fe73ffa7000     16K rw---   [ anon ]</span><br><span class="line">00007fe73ffab000     12K r-x-- libdl-2.28.so</span><br><span class="line">00007fe73ffae000   2044K ----- libdl-2.28.so</span><br><span class="line">00007fe7401ad000      4K r---- libdl-2.28.so</span><br><span class="line">00007fe7401ae000      4K rw--- libdl-2.28.so</span><br><span class="line">00007fe7401af000     88K r-x-- libz.so.1.2.11</span><br><span class="line">00007fe7401c5000   2044K ----- libz.so.1.2.11 </span><br></pre></td></tr></table></figure>

<p>范例：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#查看系统调用</span></span><br><span class="line">[root@centos7 ~]<span class="comment">#dnf -y install strace</span></span><br><span class="line">[root@centos7 ~]<span class="comment">#strace ls</span></span><br><span class="line">execve(<span class="string">&quot;/usr/bin/ls&quot;</span>, [<span class="string">&quot;ls&quot;</span>], 0x7ffd4b9dad50 /* 25 vars */) = 0</span><br><span class="line">brk(NULL)                               = 0x55ed4c7d7000</span><br><span class="line">arch_prctl(0x3001 /* ARCH_??? */, 0x7ffd500ae390) = -1 EINVAL (Invalid argument)</span><br><span class="line">access(<span class="string">&quot;/etc/ld.so.preload&quot;</span>, R_OK)      = -1 ENOENT (No such file or directory)</span><br><span class="line">openat(AT_FDCWD, <span class="string">&quot;/etc/ld.so.cache&quot;</span>, O_RDONLY|O_CLOEXEC) = 3</span><br><span class="line">fstat(3, &#123;st_mode=S_IFREG|0644, st_size=73944, ...&#125;) = 0</span><br><span class="line">mmap(NULL, 73944, PROT_READ, MAP_PRIVATE, 3, 0) = 0x7fce5dfa7000</span><br><span class="line">close(3)                                = 0</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#查看库调用</span></span><br><span class="line">[root@centos7 ~]<span class="comment">#yum -y install ltrace</span></span><br><span class="line">[root@centos7 ~]<span class="comment"># ltrace ls</span></span><br><span class="line">__libc_start_main(0x402910, 1, 0x7ffcca28b1b8, 0x4129a0 &lt;unfinished ...&gt;</span><br><span class="line">strrchr(<span class="string">&quot;ls&quot;</span>, <span class="string">&#x27;/&#x27;</span>)                                                               </span><br><span class="line">                         = nil</span><br><span class="line">setlocale(LC_ALL, <span class="string">&quot;&quot;</span>)                                                           </span><br><span class="line">                          = <span class="string">&quot;en_US.utf8&quot;</span></span><br><span class="line">bindtextdomain(<span class="string">&quot;coreutils&quot;</span>, <span class="string">&quot;/usr/share/locale&quot;</span>)                                 </span><br><span class="line">                         = <span class="string">&quot;/usr/share/locale&quot;</span></span><br><span class="line">textdomain(<span class="string">&quot;coreutils&quot;</span>)</span><br></pre></td></tr></table></figure>

<h2 id="虚拟内存信息-vmstat"><a href="#虚拟内存信息-vmstat" class="headerlink" title="虚拟内存信息 vmstat"></a>虚拟内存信息 vmstat</h2><p>格式：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vmstat [options] [delay [count]] </span><br></pre></td></tr></table></figure>

<p>显示项说明：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">procs:</span><br><span class="line">    r：可运行（正运行或等待运行）进程的个数，和核心数有关</span><br><span class="line">    b：处于不可中断睡眠态的进程个数(被阻塞的队列的长度)</span><br><span class="line">memory：</span><br><span class="line">    swpd:   交换内存的使用总量</span><br><span class="line">    free：  空闲物理内存总量</span><br><span class="line">    buffer：用于buffer的内存总量</span><br><span class="line">    cache： 用于cache的内存总量</span><br><span class="line">swap:</span><br><span class="line">    si：从磁盘交换进内存的数据速率(kb/s)</span><br><span class="line">    so：从内存交换至磁盘的数据速率(kb/s)</span><br><span class="line">io：</span><br><span class="line">    bi：从块设备读入数据到系统的速率(kb/s)</span><br><span class="line">    bo: 保存数据至块设备的速率</span><br><span class="line">system：</span><br><span class="line">    <span class="keyword">in</span>: interrupts         中断速率，包括时钟</span><br><span class="line">    cs: context switch     进程切换速率</span><br><span class="line">cpu：</span><br><span class="line">    us:Time spent running non-kernel code</span><br><span class="line">    sy: Time spent running kernel code</span><br><span class="line">    <span class="built_in">id</span>: Time spent idle. Linux 2.5.41前,包括IO-<span class="built_in">wait</span> time.</span><br><span class="line">    wa: Time spent waiting <span class="keyword">for</span> IO.  2.5.41前，包括<span class="keyword">in</span> idle.</span><br><span class="line">    st: Time stolen from a virtual machine.  2.6.11前, unknown.</span><br></pre></td></tr></table></figure>

<p>选项：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-s 显示内存的统计数据</span><br></pre></td></tr></table></figure>

<p>范例：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ~]<span class="comment">#vmstat  </span></span><br><span class="line">procs -----------memory---------- ---swap-- -----io---- -system-- ------cpu-----</span><br><span class="line"> r b   swpd   free   buff cache   si   so   bi   bo   <span class="keyword">in</span>   cs us sy <span class="built_in">id</span> wa st</span><br><span class="line">1  0      0 1125284   5308 404636    0    0     1     1   25   33  0  0 100  0</span><br><span class="line">0</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@centos8 ~]<span class="comment">#vmstat 1 3</span></span><br><span class="line">procs -----------memory---------- ---swap-- -----io---- -system-- ------cpu-----</span><br><span class="line"> r b   swpd   free   buff cache   si   so   bi   bo   <span class="keyword">in</span>   cs us sy <span class="built_in">id</span> wa st</span><br><span class="line">0  0      0 1125408   5308 404676    0    0     1     1   25   33  0  0 100  0</span><br><span class="line">0</span><br><span class="line">0  0      0 1125248   5308 404676    0    0     0     0  165  236  0  0 100  0</span><br><span class="line">0</span><br><span class="line">0  0      0 1125188   5308 404676    0    0     0     0  146  216  0  0 100  0</span><br><span class="line">0</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@centos8 ~]<span class="comment">#vmstat -s</span></span><br><span class="line">      1849460 K total memory</span><br><span class="line">       314348 K used memory</span><br><span class="line">       264424 K active memory</span><br><span class="line">       192500 K inactive memory</span><br><span class="line">      1125128 K free memory</span><br><span class="line">         5308 K buffer memory</span><br><span class="line">       404676 K swap cache</span><br><span class="line">      2097148 K total swap</span><br><span class="line">            0 K used swap</span><br><span class="line">      2097148 K free swap</span><br><span class="line">         2519 non-nice user cpu ticks</span><br><span class="line">         1027 <span class="built_in">nice</span> user cpu ticks</span><br><span class="line">        10178 system cpu ticks</span><br><span class="line">     36616214 idle cpu ticks</span><br><span class="line">          294 IO-<span class="built_in">wait</span> cpu ticks</span><br><span class="line">         5043 IRQ cpu ticks</span><br><span class="line">         5150 softirq cpu ticks</span><br><span class="line">            0 stolen cpu ticks</span><br><span class="line">       249439 pages paged <span class="keyword">in</span></span><br><span class="line">       301109 pages paged out</span><br><span class="line">            0 pages swapped <span class="keyword">in</span></span><br><span class="line">            0 pages swapped out</span><br><span class="line">      9338473 interrupts</span><br><span class="line">     12059933 CPU context switches</span><br><span class="line">   1578443646 boot time</span><br><span class="line">        19386 forks</span><br></pre></td></tr></table></figure>

<h2 id="统计CPU和设备IO信息-iostat"><a href="#统计CPU和设备IO信息-iostat" class="headerlink" title="统计CPU和设备IO信息 iostat"></a>统计CPU和设备IO信息 iostat</h2><p>iostat 可以提供更丰富的IO性能状态数据</p>
<p>此工具由sysstat包提供</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#常用选项:</span></span><br><span class="line">-c                 <span class="comment">#只显示CPU行</span></span><br><span class="line">-d                 <span class="comment">#显示设备〈磁盘)使用状态</span></span><br><span class="line">-k                 <span class="comment">#以千字节为为单位显示输出</span></span><br><span class="line">-t                 <span class="comment">#在输出中包括时间戳</span></span><br><span class="line">-x                 <span class="comment">#在输出中包括扩展的磁盘指标</span></span><br></pre></td></tr></table></figure>

<p>范例：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ~]<span class="comment">#iostat </span></span><br><span class="line">Linux 4.18.0-80.el8.x86_64 (centos8.localdomain) 01/09/2020 _x86_64_ (4 CPU)</span><br><span class="line">avg-cpu: %user   %<span class="built_in">nice</span> %system %iowait %steal   %idle</span><br><span class="line">          0.01    0.00    0.06    0.00   0.00   99.93</span><br><span class="line">           </span><br><span class="line">           </span><br><span class="line">Device             tps    kB_read/s    kB_wrtn/s    kB_read    kB_wrtn</span><br><span class="line">sda               0.31         2.57         3.52     238227     326708</span><br><span class="line">scd0              0.01         0.14         0.00      13140          0</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@centos8 ~]<span class="comment">#iostat 1 3</span></span><br><span class="line">Linux 4.18.0-80.el8.x86_64 (centos8.localdomain) 01/09/2020 _x86_64_ (4 CPU)</span><br><span class="line">avg-cpu:  %user   %<span class="built_in">nice</span> %system %iowait  %steal   %idle</span><br><span class="line">           0.01    0.00    0.06    0.00    0.00   99.93</span><br><span class="line">           </span><br><span class="line">           </span><br><span class="line">Device             tps   kB_read/s   kB_wrtn/s   kB_read   kB_wrtn</span><br><span class="line">sda               0.31         2.57         3.52     238227     326708</span><br><span class="line">scd0              0.01         0.14         0.00      13140          0</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">avg-cpu:  %user   %<span class="built_in">nice</span> %system %iowait  %steal   %idle</span><br><span class="line">           0.00    0.00    0.25    0.00    0.00   99.75</span><br><span class="line">           </span><br><span class="line">Device             tps    kB_read/s    kB_wrtn/s    kB_read    kB_wrtn</span><br><span class="line">sda               0.00         0.00         0.00          0          0</span><br><span class="line">scd0              0.00         0.00         0.00          0          0</span><br><span class="line"></span><br><span class="line">avg-cpu:  %user   %<span class="built_in">nice</span> %system %iowait  %steal   %idle</span><br><span class="line">           0.00    0.00    0.00    0.00    0.00  100.00</span><br><span class="line">           </span><br><span class="line">Device             tps    kB_read/s    kB_wrtn/s    kB_read    kB_wrtn</span><br><span class="line">sda               0.00         0.00         0.00          0          0</span><br><span class="line">scd0              0.00         0.00         0.00          0          0</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">tps：该设备每秒的传输次数（Indicate the number of transfers per second that were </span><br><span class="line">issued to the device.）。<span class="string">&quot;一次传输&quot;</span>意思是<span class="string">&quot;一次I/O请求&quot;</span>。多个逻辑请求可能会被合并为<span class="string">&quot;一次I/O请求&quot;</span>。<span class="string">&quot;一次传输&quot;</span>请求的大小是未知的。</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">kB_read/s：每秒从设备（drive expressed）读取的数据量；</span><br><span class="line">kB_wrtn/s：每秒向设备（drive expressed）写入的数据量；</span><br><span class="line">kB_read：读取的总数据量；</span><br><span class="line">kB_wrtn：写入的总数量数据量；这些单位都为Kilobytes。</span><br></pre></td></tr></table></figure>

<p>范例:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ~]<span class="comment"># iostat -d sda -t -k 1 3</span></span><br><span class="line">Linux 4.18.0-193.el8.x86_64 (centos8.wangxiaochun.com) 11/24/2020 _x86_64_ (2 CPU)</span><br><span class="line">11/24/2020 03:08:50 PM</span><br><span class="line">Device            tps    kB_read/s    kB_wrtn/s    kB_read   kB_wrtn</span><br><span class="line">sda             26.51       893.96       310.78     219458     76293</span><br><span class="line"></span><br><span class="line">11/24/2020 03:08:51 PM</span><br><span class="line">Device             tps    kB_read/s    kB_wrtn/s   kB_read   kB_wrtn</span><br><span class="line">sda               0.00         0.00         0.00         0         0</span><br><span class="line"></span><br><span class="line">11/24/2020 03:08:52 PM</span><br><span class="line">Device             tps   kB_read/s   kB_wrtn/s   kB_read   kB_wrtn</span><br><span class="line">sda               0.00         0.00         0.00         0         0</span><br></pre></td></tr></table></figure>

<p>范例:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">[root@rocky ~]<span class="comment"># iostat -d nvme0n1  1 3 -x</span></span><br><span class="line">Linux 5.14.0-427.13.1.el9_4.x86_64 (rocky) 	11/28/24 	_x86_64_	(2 CPU)</span><br><span class="line"></span><br><span class="line">Device            r/s     rkB/s   rrqm/s  %rrqm r_await rareq-sz     w/s     wkB/s   wrqm/s  %wrqm w_await wareq-sz     d/s     dkB/s   drqm/s  %drqm d_await dareq-sz     f/s f_await  aqu-sz  %util</span><br><span class="line">nvme0n1          0.14      5.57     0.00   0.09    0.24    38.63    0.06      3.45     0.01  15.03    1.36    53.24    0.00      0.00     0.00   0.00    0.00     0.00    0.00    0.00    0.00   0.01</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Device            r/s     rkB/s   rrqm/s  %rrqm r_await rareq-sz     w/s     wkB/s   wrqm/s  %wrqm w_await wareq-sz     d/s     dkB/s   drqm/s  %drqm d_await dareq-sz     f/s f_await  aqu-sz  %util</span><br><span class="line">nvme0n1          0.00      0.00     0.00   0.00    0.00     0.00    0.00      0.00     0.00   0.00    0.00     0.00    0.00      0.00     0.00   0.00    0.00     0.00    0.00    0.00    0.00   0.00</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Device            r/s     rkB/s   rrqm/s  %rrqm r_await rareq-sz     w/s     wkB/s   wrqm/s  %wrqm w_await wareq-sz     d/s     dkB/s   drqm/s  %drqm d_await dareq-sz     f/s f_await  aqu-sz  %util</span><br><span class="line">nvme0n1          0.00      0.00     0.00   0.00    0.00     0.00    0.00      0.00     0.00   0.00    0.00     0.00    0.00      0.00     0.00   0.00    0.00     0.00    0.00    0.00    0.00   0.00</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#输出说明</span></span><br><span class="line">r/s:             <span class="comment">#每秒合并后读的请求数</span></span><br><span class="line">w/s:             <span class="comment">#每秒合并后写的请求数</span></span><br><span class="line">rsec/s：         <span class="comment">#每秒读取的扇区数；</span></span><br><span class="line">wsec/：          <span class="comment">#每秒写入的扇区数。</span></span><br><span class="line">rKB/s：          <span class="comment">#The number of read requests that were issued to the device per second；</span></span><br><span class="line">wKB/s：          <span class="comment">#The number of write requests that were issued to the device per second；</span></span><br><span class="line">rrqm/s：          <span class="comment">#每秒这个设备相关的读取请求有多少被Merge了（当系统调用需要读取数据的时候，VFS将请求发到各个FS，如果FS发现不同的读取请求读取的是相同Block的数据，FS会将这个请求合并Merge）；</span></span><br><span class="line">wrqm/s：          <span class="comment">#每秒这个设备相关的写入请求有多少被Merge了。</span></span><br><span class="line">%rrqm:            <span class="comment">#The percentage of read requests merged together before being sent to the device.</span></span><br><span class="line">%wrqm:            <span class="comment">#The percentage of write requests merged together before being sent to the device.</span></span><br><span class="line">avgrq-sz          <span class="comment">#平均请求扇区的大小</span></span><br><span class="line">avgqu-sz          <span class="comment">#是平均请求队列的长度。毫无疑问，队列长度越短越好。 </span></span><br><span class="line">await：           <span class="comment">#每一个IO请求的处理的平均时间（单位是微秒毫秒）。这里可以理解为IO的响应时间，一般地系统IO响应时间应该低于5ms，如果大于10ms就比较大了。这个时间包括了队列时间和服务时间，也就是说，一般情况下，await大于svctm，它们的差值越小，则说明队列时间越短，反之差值越大，队列时间越长，说明系统出了问题。</span></span><br><span class="line">svctm             <span class="comment">#表示平均每次设备I/O操作的服务时间（以毫秒为单位）。如果svctm的值与await很接近，表示几乎没有I/O等待，磁盘性能很好，如果await的值远高于svctm的值，则表示I/O队列等待太长，系统上运行的应用程序将变慢。</span></span><br><span class="line">%util：            <span class="comment">#在统计时间内所有处理IO时间，除以总共统计时间。例如，如果统计间隔1秒，该设备有0.8秒在处理IO，而0.2秒闲置，那么该设备的%util = 0.8/1 = 80%，所以该参数暗示了设备的繁忙程度。一般地，如果该参数是100%表示设备已经接近满负荷运行了（当然如果是多磁盘，即使%util是100%，因为磁盘的并发能力，所以磁盘使用未必就到了瓶颈）。</span></span><br></pre></td></tr></table></figure>

<h2 id="监视磁盘I-O-iotop"><a href="#监视磁盘I-O-iotop" class="headerlink" title="监视磁盘I/O iotop"></a>监视磁盘I/O iotop</h2><p>来自于iotop包</p>
<p><img src="../../../../images/image/SRE/day13/24.png" alt="24"></p>
<p>iotop命令是一个用来监视磁盘I/O使用状况的top类工具iotop具有与top相似的UI，其中包括PID、用户、I/O、进程等相关信息，可查看每个进程是如何使用IO </p>
<p>iotop输出</p>
<ul>
<li><p>第一行：Read和Write速率总计</p>
</li>
<li><p>第二行：实际的Read和Write速率</p>
</li>
<li><p>第三行：参数如下： </p>
<blockquote>
<p>线程ID（按p切换为进程ID） </p>
<p>优先级 </p>
<p>用户 </p>
<p>磁盘读速率</p>
<p>磁盘写速率 </p>
<p>swap交换百分比 </p>
<p>IO等待所占的百分比 </p>
</blockquote>
</li>
</ul>
<p>iotop常用参数</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">-o, --only           <span class="comment">#只显示正在产生I/O的进程或线程，除了传参，可以在运行过程中按o生效</span></span><br><span class="line">-b, --batch          <span class="comment">#非交互模式，一般用来记录日志</span></span><br><span class="line">-n NUM, --iter=NUM   <span class="comment">#设置监测的次数，默认无限。在非交互模式下很有用</span></span><br><span class="line">-d SEC, --delay=SEC  <span class="comment">#设置每次监测的间隔，默认1秒，接受非整形数据例如1.1</span></span><br><span class="line">-p PID, --pid=PID    <span class="comment">#指定监测的进程/线程</span></span><br><span class="line">-u USER, --user=USER <span class="comment">#指定监测某个用户产生的I/O</span></span><br><span class="line">-P, --processes      <span class="comment">#仅显示进程，默认iotop显示所有线程</span></span><br><span class="line">-a, --accumulated    <span class="comment">#显示累积的I/O，而不是带宽</span></span><br><span class="line">-k, --kilobytes      <span class="comment">#使用kB单位，而不是对人友好的单位。在非交互模式下，脚本编程有用</span></span><br><span class="line">-t, --time           <span class="comment">#加上时间戳，非交互非模式</span></span><br><span class="line">-q, --quiet          <span class="comment">#禁止头几行，非交互模式，有三种指定方式</span></span><br><span class="line">-q                   <span class="comment">#只在第一次监测时显示列名</span></span><br><span class="line">-qq                  <span class="comment">#永远不显示列名</span></span><br><span class="line">-qqq                 <span class="comment">#永远不显示I/O汇总</span></span><br></pre></td></tr></table></figure>

<p>交互按键</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">left和right方向键：改变排序</span><br><span class="line">r：反向排序</span><br><span class="line">o：切换至选项--only</span><br><span class="line">p：切换至--processes选项</span><br><span class="line">a：切换至--accumulated选项</span><br><span class="line">q：退出</span><br><span class="line">i：改变线程的优先级</span><br></pre></td></tr></table></figure>

<h2 id="显示网络带宽使用情况-iftop"><a href="#显示网络带宽使用情况-iftop" class="headerlink" title="显示网络带宽使用情况 iftop"></a>显示网络带宽使用情况 iftop</h2><p>通过EPEL源的 iftop 包</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ~]<span class="comment"># iftop -ni eth0</span></span><br></pre></td></tr></table></figure>

<p><img src="../../../../images/image/SRE/day13/25.png" alt="25"></p>
<h2 id="查看网络实时吞吐量-nload"><a href="#查看网络实时吞吐量-nload" class="headerlink" title="查看网络实时吞吐量 nload"></a>查看网络实时吞吐量 nload</h2><p><img src="../../../../images/image/SRE/day13/26.png" alt="26"></p>
<p>nload 是一个实时监控网络流量和带宽使用情况，以数值和动态图展示进出的流量情况,通过EPEL源安装</p>
<p>界面操作</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">上下方向键、左右方向键、enter键或者tab键都就可以切换查看多个网卡的流量情况</span><br><span class="line">按 F2 显示选项窗口</span><br><span class="line">按 q 或者 Ctrl+C 退出 nload</span><br></pre></td></tr></table></figure>

<p>范例：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#默认只查看第一个网络的流量进出情况</span></span><br><span class="line">nload</span><br><span class="line"></span><br><span class="line"><span class="comment">#在nload后面指定网卡，可以指定多个,按左右键分别显示网卡状态</span></span><br><span class="line">nload eth0 eth1</span><br><span class="line"></span><br><span class="line"><span class="comment">#设置刷新间隔：默认刷新间隔是100毫秒，可通过 -t 命令设置刷新时间（单位是毫秒）</span></span><br><span class="line">nload -t 500 eth0</span><br><span class="line"></span><br><span class="line"><span class="comment">#设置单位：显示两种单位一种是显示Bit/s、一种是显示Byte/s，默认是以Bit/s，也可不显示/s</span></span><br><span class="line"><span class="comment">#-u h|b|k|m|g|H|B|K|M|G 表示的含义： h: auto, b: Bit/s, k: kBit/s, m: MBit/s, H: auto, B: Byte/s, K: kByte/s, M: MByte/s</span></span><br><span class="line">nload -u M eth0</span><br></pre></td></tr></table></figure>

<h2 id="查看进程网络带宽的使用情况-nethogs"><a href="#查看进程网络带宽的使用情况-nethogs" class="headerlink" title="查看进程网络带宽的使用情况 nethogs"></a>查看进程网络带宽的使用情况 nethogs</h2><p>NetHogs是一个开源的命令行工具（类似于Linux的top命令），用来按进程或程序实时统计网络带宽使用率。</p>
<p>github网站: <a target="_blank" rel="noopener" href="https://github.com/raboof/nethogs/">https://github.com/raboof/nethogs/</a></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#红帽系统的nethogs包来自于EPEL源</span></span><br><span class="line">[root@rocky8 ~]<span class="comment"># yum -y install nethogs</span></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment"># apt -y install nethogs</span></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment"># nethogs</span></span><br></pre></td></tr></table></figure>

<p><img src="../../../../images/image/SRE/day13/27.png" alt="27"></p>
<h2 id="网络监视工具iptraf-ng"><a href="#网络监视工具iptraf-ng" class="headerlink" title="网络监视工具iptraf-ng"></a>网络监视工具iptraf-ng</h2><p>来自于iptraf-ng包,可以进网络进行监控,对终端窗口大小有要求.</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ~]<span class="comment"># yum info iptraf-ng</span></span><br><span class="line">Last metadata expiration check: 0:20:24 ago on Sat 04 Jul 2020 12:17:23 PM CST.</span><br><span class="line">Installed Packages</span><br><span class="line">Name         : iptraf-ng</span><br><span class="line">Version     : 1.1.4</span><br><span class="line">Release     : 18.el8</span><br><span class="line">Architecture : x86_64</span><br><span class="line">Size         : 676 k</span><br><span class="line">Source       : iptraf-ng-1.1.4-18.el8.src.rpm</span><br><span class="line">Repository   : @System</span><br><span class="line">From repo   : BaseOS</span><br><span class="line">Summary     : A console-based network monitoring utility</span><br><span class="line">URL         : https://github.com/iptraf-ng/iptraf-ng/</span><br><span class="line">License     : GPLv2+</span><br><span class="line">Description : IPTraf-ng is a console-based network monitoring utility. IPTraf </span><br><span class="line">gathers</span><br><span class="line">             : data like TCP connection packet and byte counts, interface </span><br><span class="line">statistics</span><br><span class="line">             : and activity indicators, TCP/UDP traffic breakdowns, and LAN </span><br><span class="line">station</span><br><span class="line">             : packet and byte counts. IPTraf-ng features include an IP traffic </span><br><span class="line">monitor</span><br><span class="line">             : <span class="built_in">which</span> shows TCP flag information, packet and byte counts, ICMP</span><br><span class="line">             : details, OSPF packet types, and oversized IP packet warnings;</span><br><span class="line">             : interface statistics showing IP, TCP, UDP, ICMP, non-IP and other </span><br><span class="line">IP</span><br><span class="line">             : packet counts, IP checksum errors, interface activity and packet </span><br><span class="line">size</span><br><span class="line">             : counts; a TCP and UDP service monitor showing counts of incoming </span><br><span class="line">and</span><br><span class="line">             : outgoing packets <span class="keyword">for</span> common TCP and UDP application ports, a LAN</span><br><span class="line">             : statistics module that discovers active hosts and displays </span><br><span class="line">statistics</span><br><span class="line">             : about their activity; TCP, UDP and other protocol display filters </span><br><span class="line">so</span><br><span class="line">             : you can view just the traffic you want; logging; support <span class="keyword">for</span></span><br><span class="line">Ethernet,</span><br><span class="line">             : FDDI, ISDN, SLIP, PPP, and loopback interfaces; and utilization of </span><br><span class="line">the</span><br><span class="line">             : built-in raw socket interface of the Linux kernel, so it can be </span><br><span class="line">used</span><br><span class="line">             : on a wide variety of supported network cards.</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@centos8 ~]<span class="comment"># yum -y install iptraf-ng</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#对终端窗口大小有要求,如果太小否则无法显示</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># iptraf-ng</span></span><br><span class="line">fatal: This program requires a screen size of at least 80 columns by 24 lines</span><br><span class="line">Please resize your window</span><br></pre></td></tr></table></figure>

<p><img src="../../../../images/image/SRE/day13/28.png" alt="28"></p>
<h2 id="系统资源统计-dstat"><a href="#系统资源统计-dstat" class="headerlink" title="系统资源统计 dstat"></a>系统资源统计 dstat</h2><p>dstat由pcp-system-tools包提供，但安装dstat包即可, 可用于代替 vmstat,iostat功能</p>
<p>格式：</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dstat [-afv] [options..] [delay [count]]</span><br></pre></td></tr></table></figure>

<p>常用选项</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">-c                       <span class="comment">#显示cpu相关信息</span></span><br><span class="line">-C <span class="comment">#,#,...,total</span></span><br><span class="line">-d                       <span class="comment">#显示disk相关信息</span></span><br><span class="line">-D total,sda,sdb,...</span><br><span class="line">-g                       <span class="comment">#显示page相关统计数据</span></span><br><span class="line">-m                       <span class="comment">#显示memory相关统计数据</span></span><br><span class="line">-n                       <span class="comment">#显示network相关统计数据</span></span><br><span class="line">-p                       <span class="comment">#显示process相关统计数据</span></span><br><span class="line">-r                       <span class="comment">#显示io请求相关的统计数据</span></span><br><span class="line">-s                       <span class="comment">#显示swapped相关的统计数据</span></span><br><span class="line">--tcp</span><br><span class="line">--udp</span><br><span class="line">--unix</span><br><span class="line">--raw</span><br><span class="line">--socket</span><br><span class="line">--ipc</span><br><span class="line">--top-cpu:                <span class="comment">#显示最占用CPU的进程</span></span><br><span class="line">--top-io:                 <span class="comment">#显示最占用io的进程</span></span><br><span class="line">--top-mem:                <span class="comment">#显示最占用内存的进程</span></span><br><span class="line">--top-latency:            <span class="comment">#显示延迟最大的进程</span></span><br></pre></td></tr></table></figure>

<p>范例：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ~]<span class="comment"># yum -y install dstat</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># dstat 1 6</span></span><br><span class="line">You did not select any stats, using -cdngy by default.</span><br><span class="line">----total-usage---- -dsk/total- -net/total- ---paging-- ---system--</span><br><span class="line">usr sys idl wai stl| <span class="built_in">read</span> writ| recv send|  <span class="keyword">in</span>   out | int   csw </span><br><span class="line">  0   0  99   0   0|   0 2687k|  64   601 |   0     0 | 256   164</span><br><span class="line">  0   0 100   0   0|   0     0 |  64   330 |   0     0 | 121   155</span><br><span class="line">  0   0 100   0   0|   0     0 |  64   330 |   0     0 | 104   144</span><br><span class="line">  0   0 100   0   0|   0     0 |  64   330 |   0     0 | 110   145</span><br><span class="line">  0   0  99   0   0|   0     0 |  64   330 |   0     0 | 100   130</span><br></pre></td></tr></table></figure>

<h2 id="综合监控工具-glances"><a href="#综合监控工具-glances" class="headerlink" title="综合监控工具 glances"></a>综合监控工具 glances</h2><p><img src="../../../../images/image/SRE/day13/29.png" alt="29"></p>
<p>此工具可以通过EPEL源安装,CentOS 8 目前已提供,但测试有问题</p>
<p>格式：</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">glances [-bdehmnrsvyz1] [-B bind] [-c server] [-C conffile] [-p port] [-P password] [--password] [-t refresh] [-f file] [-o output]</span><br></pre></td></tr></table></figure>

<p>内建命令：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">a Sort processes automatically     l Show/hide logs</span><br><span class="line">c Sort processes by CPU%           b Bytes or bits <span class="keyword">for</span> network I/O</span><br><span class="line">m Sort processes by MEM%           w Delete warning logs</span><br><span class="line">p Sort processes by name           x Delete warning and critical logs</span><br><span class="line">i Sort processes by I/O rate       1 Global CPU or per-CPU stats</span><br><span class="line">d Show/hide disk I/O stats         h Show/hide this <span class="built_in">help</span> screen</span><br><span class="line">f Show/hide file system stats      t View network I/O as combination</span><br><span class="line">n Show/hide network stats          u View cumulative network I/O</span><br><span class="line">s Show/hide sensors stats          q Quit (Esc and Ctrl-C also work)</span><br><span class="line">y Show/hide hddtemp stats</span><br></pre></td></tr></table></figure>

<p>常用选项：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">-b:                     以Byte为单位显示网卡数据速率</span><br><span class="line">-d:                     关闭磁盘I/O模块</span><br><span class="line">-f /path/to/somefile:   设定输入文件位置</span><br><span class="line">-o  &#123;HTML|CSV&#125;:         输出格式</span><br><span class="line">-m:                     禁用mount模块</span><br><span class="line">-n:                     禁用网络模块</span><br><span class="line">-t <span class="comment">#:                   延迟时间间隔</span></span><br><span class="line">-1:                     每个CPU的相关数据单独显示</span><br></pre></td></tr></table></figure>

<p><strong>C/S模式下运行glances命令</strong></p>
<ul>
<li><p>服务器模式： </p>
<p>glances -s -B IPADDR</p>
<p>IPADDR: 指明监听的本机哪个地址,端口默认为61209/tcp </p>
</li>
<li><p>客户端模式： </p>
<p>glances -c IPADDR </p>
<p>IPADDR：要连入的服务器端地址 </p>
</li>
</ul>
<p>注意: 不同版本不兼容</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@centos7 ~]<span class="comment"># glances -c 10.0.0.8</span></span><br><span class="line">Client and server not compatible:       Client version: 2.5.1 / Server version: 3.1.4.1</span><br></pre></td></tr></table></figure>

<h2 id="查看进程打开文件-lsof"><a href="#查看进程打开文件-lsof" class="headerlink" title="查看进程打开文件 lsof"></a>查看进程打开文件 lsof</h2><p>lsof：list open files，查看当前系统文件的工具。在linux环境下，一切皆文件，用户通过文件不仅可以 访问常规数据，还可以访问网络连接和硬件如传输控制协议 (TCP) 和用户数据报协议 (UDP)套接字等， 系统在后台都为该应用程序分配了一个文件描述符</p>
<p>命令选项：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">-a:                   列出打开文件存在的进程</span><br><span class="line">-c&lt;进程名&gt;:            列出指定进程所打开的文件</span><br><span class="line">-g:                   列出GID号进程详情</span><br><span class="line">-d&lt;文件号&gt;:            列出占用该文件号的进程</span><br><span class="line">+d&lt;目录&gt;:              列出目录下被打开的文件</span><br><span class="line">+D&lt;目录&gt;:              递归列出目录下被打开的文件</span><br><span class="line">-n&lt;目录&gt;:              列出使用NFS的文件</span><br><span class="line">-i&lt;条件&gt;:              列出符合条件的进程(4、6、协议、:端口、 @ip )</span><br><span class="line">-p&lt;进程号&gt;:            列出指定进程号所打开的文件</span><br><span class="line">-u:                   列出UID号进程详情</span><br><span class="line">-h:                   显示帮助信息</span><br><span class="line">-v:                   显示版本信息。</span><br><span class="line">-n:                   不反向解析网络名字</span><br></pre></td></tr></table></figure>

<p>范例：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#lsof 列出当前所有打开的文件</span></span><br><span class="line">[root@rocky ~]<span class="comment"># lsof | head</span></span><br><span class="line">COMMAND    PID TID TASKCMD     USER   FD      TYPE             DEVICE SIZE/OFF       NODE NAME</span><br><span class="line">systemd      1                 root  cwd       DIR              253,0      270        128 /</span><br><span class="line">systemd      1                 root  rtd       DIR              253,0      270        128 /</span><br><span class="line">systemd      1                 root  txt       REG              253,0    98160  134759361 /usr/lib/systemd/systemd</span><br><span class="line">systemd      1                 root  mem       REG              253,0   582178   67444125 /etc/selinux/targeted/contexts/files/file_contexts.bin</span><br><span class="line">systemd      1                 root  mem       REG              253,0   153600     235792 /usr/lib64/libgpg-error.so.0.32.0</span><br><span class="line">systemd      1                 root  mem       REG              253,0   636848     235837 /usr/lib64/libpcre2-8.so.0.11.0</span><br><span class="line">systemd      1                 root  mem       REG              253,0   102552     235374 /usr/lib64/libz.so.1.2.11</span><br><span class="line">systemd      1                 root  mem       REG              253,0   904712     235571 /usr/lib64/libm.so.6</span><br><span class="line">systemd      1                 root  mem       REG              253,0  1714256     275093 /usr/lib64/libp11-kit.so.0.3.1</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#查看当前哪个进程正在使用此文件</span></span><br><span class="line">[root@rocky ~]<span class="comment"># lsof /var/log/messages</span></span><br><span class="line">COMMAND  PID USER   FD   TYPE DEVICE SIZE/OFF      NODE NAME</span><br><span class="line">rsyslogd 922 root    5w   REG  253,0  1498617 201447914 /var/log/messages</span><br><span class="line"></span><br><span class="line"><span class="comment">#查看由登陆用户启动而非系统启动的进程</span></span><br><span class="line">lsof `<span class="built_in">tty</span>`</span><br><span class="line">[root@rocky ~]<span class="comment"># lsof /dev/pts/3 </span></span><br><span class="line">COMMAND  PID USER   FD   TYPE DEVICE SIZE/OFF NODE NAME</span><br><span class="line">bash    1326 root    0u   CHR  136,3      0t0    6 /dev/pts/3</span><br><span class="line">bash    1326 root    1u   CHR  136,3      0t0    6 /dev/pts/3</span><br><span class="line">bash    1326 root    2u   CHR  136,3      0t0    6 /dev/pts/3</span><br><span class="line">bash    1326 root  255u   CHR  136,3      0t0    6 /dev/pts/3</span><br><span class="line">lsof    3652 root    0u   CHR  136,3      0t0    6 /dev/pts/3</span><br><span class="line">lsof    3652 root    1u   CHR  136,3      0t0    6 /dev/pts/3</span><br><span class="line">lsof    3652 root    2u   CHR  136,3      0t0    6 /dev/pts/3</span><br><span class="line"></span><br><span class="line"><span class="comment">#指定进程号，可以查看该进程打开的文件</span></span><br><span class="line">lsof -p 9527</span><br><span class="line"></span><br><span class="line">[root@rocky ~]<span class="comment"># lsof -p `pidof bc`</span></span><br><span class="line">COMMAND  PID USER   FD   TYPE DEVICE SIZE/OFF      NODE NAME</span><br><span class="line">bc      3762 root  cwd    DIR  253,0     4096 201326726 /root</span><br><span class="line">bc      3762 root  rtd    DIR  253,0      270       128 /</span><br><span class="line">bc      3762 root  txt    REG  253,0    91384 201329604 /usr/bin/bc</span><br><span class="line">bc      3762 root  mem    REG  253,0  2387008    235568 /usr/lib64/libc.so.6</span><br><span class="line">bc      3762 root  mem    REG  253,0    26988  67237467 /usr/lib64/gconv/gconv-modules.cache</span><br><span class="line">bc      3762 root  mem    REG  253,0   346132  67237371 /usr/lib/locale/C.utf8/LC_CTYPE</span><br><span class="line">bc      3762 root  mem    REG  253,0   195080    235366 /usr/lib64/libtinfo.so.6.2</span><br><span class="line">bc      3762 root  mem    REG  253,0   358168    235756 /usr/lib64/libreadline.so.8.1</span><br><span class="line">bc      3762 root  mem    REG  253,0   844720    235564 /usr/lib64/ld-linux-x86-64.so.2</span><br><span class="line">bc      3762 root    0u   CHR  136,2      0t0         5 /dev/pts/2</span><br><span class="line">bc      3762 root    1u   CHR  136,2      0t0         5 /dev/pts/2</span><br><span class="line">bc      3762 root    2u   CHR  136,2      0t0         5 /dev/pts/2</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#查看指定程序打开的文件</span></span><br><span class="line">lsof -c httpd</span><br><span class="line"></span><br><span class="line">[root@rocky ~]<span class="comment"># lsof -c bc</span></span><br><span class="line">COMMAND  PID USER   FD   TYPE DEVICE SIZE/OFF      NODE NAME</span><br><span class="line">bc      3762 root  cwd    DIR  253,0     4096 201326726 /root</span><br><span class="line">bc      3762 root  rtd    DIR  253,0      270       128 /</span><br><span class="line">bc      3762 root  txt    REG  253,0    91384 201329604 /usr/bin/bc</span><br><span class="line">bc      3762 root  mem    REG  253,0  2387008    235568 /usr/lib64/libc.so.6</span><br><span class="line">bc      3762 root  mem    REG  253,0    26988  67237467 /usr/lib64/gconv/gconv-modules.cache</span><br><span class="line">bc      3762 root  mem    REG  253,0   346132  67237371 /usr/lib/locale/C.utf8/LC_CTYPE</span><br><span class="line">bc      3762 root  mem    REG  253,0   195080    235366 /usr/lib64/libtinfo.so.6.2</span><br><span class="line">bc      3762 root  mem    REG  253,0   358168    235756 /usr/lib64/libreadline.so.8.1</span><br><span class="line">bc      3762 root  mem    REG  253,0   844720    235564 /usr/lib64/ld-linux-x86-64.so.2</span><br><span class="line">bc      3762 root    0u   CHR  136,2      0t0         5 /dev/pts/2</span><br><span class="line">bc      3762 root    1u   CHR  136,2      0t0         5 /dev/pts/2</span><br><span class="line">bc      3762 root    2u   CHR  136,2      0t0         5 /dev/pts/2</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#查看指定用户打开的文件</span></span><br><span class="line">lsof -u root | more　　</span><br><span class="line"></span><br><span class="line"><span class="comment">#查看指定目录下被打开的文件，参数+D为递归列出目录下被打开的文件，参数+d为列出目录下被打开的文件</span></span><br><span class="line">lsof +D /var/log/ </span><br><span class="line">lsof +d /var/log/　　</span><br><span class="line"> </span><br><span class="line"><span class="comment">#查看所有网络连接，通过参数-i查看网络连接的情况，包括连接的ip、端口等以及一些服务的连接情况，例如：sshd等。也可以通过指定ip查看该ip的网络连接情况</span></span><br><span class="line">lsof -i –n      </span><br><span class="line">lsof -i@127.0.0.1</span><br><span class="line"> </span><br><span class="line"><span class="comment">#查看端口连接情况，通过参数-i:端口可以查看端口的占用情况，-i参数还有查看协议，ip的连接情况等</span></span><br><span class="line">lsof -i :80 -n</span><br><span class="line"> </span><br><span class="line"><span class="comment">#查看指定进程打开的网络连接，参数-i、-a、-p等，-i查看网络连接情况，-a查看存在的进程，-p指定进程</span></span><br><span class="line">lsof -i –n -a -p 9527</span><br><span class="line"> </span><br><span class="line"><span class="comment">#查看指定状态的网络连接，-n:no host names, -P:no port names,-i TCP指定协议，-s指定协议状态通过多个参数可以清晰的查看网络连接情况、协议连接情况等</span></span><br><span class="line">lsof -n -P -i TCP -s TCP:ESTABLISHED</span><br></pre></td></tr></table></figure>

<p>范例：利用 lsof 恢复正在使用中的误删除的文件</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">lsof |grep /var/log/messages</span><br><span class="line"><span class="built_in">rm</span> -f /var/log/messages</span><br><span class="line">lsof |grep /var/log/messages</span><br><span class="line"><span class="built_in">cat</span> /proc/653/fd/6</span><br><span class="line"><span class="built_in">cat</span> /proc/653/fd/6 &gt; /var/log/messages</span><br></pre></td></tr></table></figure>

<h2 id="CentOS-8-新特性-cockpit"><a href="#CentOS-8-新特性-cockpit" class="headerlink" title="CentOS 8 新特性 cockpit"></a>CentOS 8 新特性 cockpit</h2><p>由cockpit包提供,当前Ubuntu和CentOS7也支持此工具</p>
<p>Cockpit 是CentOS 8 取入的新特性，是一个基于 Web 界面的应用，它提供了对系统的图形化管理</p>
<ul>
<li>监控系统活动（CPU、内存、磁盘 IO 和网络流量）</li>
<li>查看系统日志条目</li>
<li>查看磁盘分区的容量</li>
<li>查看网络活动（发送和接收）</li>
<li>查看用户帐户</li>
<li>检查系统服务的状态</li>
<li>提取已安装应用的信息</li>
<li>查看和安装可用更新（如果以 root 身份登录）并在需要时重新启动系统 </li>
<li>打开并使用终端窗口</li>
</ul>
<p>范例：安装 cockpit</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ~]<span class="comment"># dnf -y install cockpit</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># systemctl enable --now cockpit.socket</span></span><br><span class="line">Created symlink /etc/systemd/system/sockets.target.wants/cockpit.socket → </span><br><span class="line">/usr/lib/systemd/system/cockpit.socket.</span><br></pre></td></tr></table></figure>

<p>打开浏览器，访问以下地址：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://&lt;cockpit主机&gt;:9090</span><br></pre></td></tr></table></figure>

<h2 id="信号发送-kill"><a href="#信号发送-kill" class="headerlink" title="信号发送 kill"></a>信号发送 kill</h2><p>kill：内部命令，可用来向进程发送控制信号，以实现对进程管理,每个信号对应一个数字，信号名称以 SIG开头（可省略），不区分大小写</p>
<p>显示当前系统可用信号：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">kill</span> -l   </span><br><span class="line"><span class="built_in">trap</span> -l</span><br></pre></td></tr></table></figure>

<p>查看帮助：man 7 signal </p>
<p>常用信号：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">1) SIGHUP   无须关闭进程而让其重读配置文件</span><br><span class="line">2) SIGINT   中止正在运行的进程；相当于Ctrl+c</span><br><span class="line">3) SIGQUIT  相当于ctrl+\</span><br><span class="line">9) SIGKILL  强制杀死正在运行的进程,可能会导致数据丢失,慎用!</span><br><span class="line">15) SIGTERM 终止正在运行的进程，默认信号</span><br><span class="line">18) SIGCONT 继续运行</span><br><span class="line">19) SIGSTOP 后台休眠</span><br></pre></td></tr></table></figure>

<p>指定信号的方法 :  </p>
<ul>
<li>信号的数字标识：1, 2, 9</li>
<li>信号完整名称：SIGHUP，sighup</li>
<li>信号的简写名称：HUP，hup</li>
</ul>
<p>向进程发送信号： </p>
<p>按PID：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">kill</span> [-s sigspec | -n signum | -sigspec] pid | jobspec ... or <span class="built_in">kill</span> -l [sigspec]</span><br></pre></td></tr></table></figure>

<p>范例：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">kill</span>  -1   pid</span><br><span class="line"><span class="built_in">kill</span>  -n 9 pid</span><br><span class="line"><span class="built_in">kill</span>  -s SIGINT pid</span><br><span class="line"></span><br><span class="line">[root@centos8 ~]<span class="comment"># kill -int `pidof ping`</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># kill -sigint `pidof ping`</span></span><br></pre></td></tr></table></figure>

<p>按名称：killall 来自于psmisc包</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">killall [-SIGNAL] comm…</span><br></pre></td></tr></table></figure>

<p>按模式：</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pkill [options] pattern</span><br></pre></td></tr></table></figure>

<p>常用选项</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">-SIGNAL</span><br><span class="line">-u uid: effective user，生效者</span><br><span class="line">-U uid: real user，真正发起运行命令者</span><br><span class="line">-t terminal: 与指定终端相关的进程</span><br><span class="line">-l: 显示进程名（pgrep可用）</span><br><span class="line">-a: 显示完整格式的进程名（pgrep可用）</span><br><span class="line">-P pid: 显示指定进程的子进程</span><br></pre></td></tr></table></figure>

<p>范例：查看HUP信号</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#许多服务的支持的reload操作，实际就是发送了HUP信号</span></span><br><span class="line"><span class="comment">#service httpd reload 即相当于 killall -1 httpd</span></span><br><span class="line">[root@centos6 ~]<span class="comment">#grep -A 10 -w reload -m 1 /etc/init.d/httpd </span></span><br><span class="line"><span class="function"><span class="title">reload</span></span>() &#123;</span><br><span class="line">    <span class="built_in">echo</span> -n $<span class="string">&quot;Reloading <span class="variable">$prog</span>: &quot;</span></span><br><span class="line">    <span class="keyword">if</span> ! LANG=<span class="variable">$HTTPD_LANG</span> <span class="variable">$httpd</span> <span class="variable">$OPTIONS</span> -t &gt;&amp;/dev/null; <span class="keyword">then</span></span><br><span class="line">        RETVAL=6</span><br><span class="line">        <span class="built_in">echo</span> $<span class="string">&quot;not reloading due to configuration syntax error&quot;</span></span><br><span class="line">        failure $<span class="string">&quot;not reloading <span class="variable">$httpd</span> due to configuration syntax error&quot;</span></span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="comment"># Force LSB behaviour from killproc</span></span><br><span class="line">        LSB=1 killproc -p <span class="variable">$&#123;pidfile&#125;</span> <span class="variable">$httpd</span> -HUP</span><br><span class="line">        RETVAL=$?</span><br><span class="line">        <span class="keyword">if</span> [ <span class="variable">$RETVAL</span> -eq 7 ]; <span class="keyword">then</span></span><br></pre></td></tr></table></figure>

<p>范例：利用 0 信号实现进程的健康性检查</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ~]<span class="comment">#man kill</span></span><br><span class="line">If signal is 0, <span class="keyword">then</span> no actual signal is sent, but error checking is still </span><br><span class="line">performed.</span><br><span class="line"></span><br><span class="line">[root@centos8 ~]<span class="comment">#killall -0 ping</span></span><br><span class="line">[root@centos8 ~]<span class="comment">#echo $?</span></span><br><span class="line">0</span><br><span class="line"></span><br><span class="line">[root@centos8 ~]<span class="comment">#killall -0 ping</span></span><br><span class="line">ping: no process found</span><br><span class="line"></span><br><span class="line">[root@centos8 ~]<span class="comment">#echo $?</span></span><br><span class="line">1</span><br><span class="line"></span><br><span class="line"><span class="comment">#此方式有局限性，即使进程处于停止或僵尸状态，此方式仍然认为是进程是健康的</span></span><br></pre></td></tr></table></figure>

<p>范例: pkill和pgrep支持正则表达式</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ~]<span class="comment"># pkill &#x27;^p&#x27;</span></span><br><span class="line"></span><br><span class="line">[root@centos8 ~]<span class="comment"># pgrep -a &#x27;^p&#x27;</span></span><br><span class="line">9278 pickup -l -t unix -u</span><br><span class="line">9281 ping 1.1.1.1</span><br><span class="line">9311 ping 2.2.2.2</span><br></pre></td></tr></table></figure>

<p>范例: 关掉指定端口的进程</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@rocky8 ~]<span class="comment"># fuser -k -9 80/tcp</span></span><br></pre></td></tr></table></figure>

<p>范例: nginx服务的信号</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ~]<span class="comment">#man nginx</span></span><br><span class="line">     SIGUSR1         Reopen <span class="built_in">log</span> files.</span><br><span class="line">     SIGUSR2         Upgrade the nginx executable on the fly.</span><br><span class="line">     SIGWINCH         Shut down worker processes gracefully.</span><br><span class="line">     </span><br><span class="line">     </span><br><span class="line">[root@wang-liyun-pc ~]<span class="comment"># cat /etc/logrotate.d/nginx </span></span><br><span class="line">/apps/nginx/logs/*.<span class="built_in">log</span> &#123;</span><br><span class="line">   daily</span><br><span class="line">   rotate 100</span><br><span class="line">   missingok</span><br><span class="line">   notifempty</span><br><span class="line">   nocompress</span><br><span class="line">   delaycompress</span><br><span class="line">   create 644 nginx nginx</span><br><span class="line">   postrotate</span><br><span class="line">      <span class="keyword">if</span> [ -f /apps/nginx/logs/nginx.pid ]; <span class="keyword">then</span></span><br><span class="line">          <span class="built_in">kill</span> -USR1 `<span class="built_in">cat</span> /apps/nginx/logs/nginx.pid`  <span class="comment">#发送USR1信号,重新打开日志文件</span></span><br><span class="line">      <span class="keyword">fi</span></span><br><span class="line">   endscript</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="作业管理"><a href="#作业管理" class="headerlink" title="作业管理"></a>作业管理</h2><p>Linux的作业控制</p>
<ul>
<li>前台作业：通过终端启动，且启动后一直占据终端</li>
<li>后台作业：可通过终端启动，但启动后即转入后台运行（释放终端）</li>
</ul>
<p><img src="../../../../images/image/SRE/day13/30.png" alt="30"></p>
<p>让作业运行于后台</p>
<ul>
<li>运行中的作业： Ctrl+z </li>
<li>尚未启动的作业： COMMAND &amp; </li>
</ul>
<p>后台作业虽然被送往后台运行，但其依然与终端相关；退出终端，将关闭后台作业。如果希望送往后台后，剥离与终端的关系</p>
<ul>
<li>nohup COMMAND &amp;&gt;/dev/null &amp;</li>
<li>screen;COMMAND</li>
<li>tmux；COMMAND </li>
</ul>
<p>查看当前终端所有作业：</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">jobs</span><br></pre></td></tr></table></figure>

<p>作业控制：</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">fg [[%]JOB_NUM]：把指定的后台作业调回前台</span><br><span class="line">bg [[%]JOB_NUM]：让送往后台的作业在后台继续运行</span><br><span class="line">kill [%JOB_NUM]： 终止指定的作业</span><br></pre></td></tr></table></figure>

<p>范例: 后台运行的进程和终端关系</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#终端1运行后台进程</span></span><br><span class="line">[root@centos8 ~]<span class="comment">#ping 127.0.0.1 &amp;</span></span><br><span class="line">[1] 30545</span><br><span class="line"></span><br><span class="line"><span class="comment">#终端2 可以查看到进程</span></span><br><span class="line">[root@centos8 ~]<span class="comment">#ps aux|grep ping</span></span><br><span class="line">root       30545  0.0  0.2  32408  2416 pts/0   S    12:25   0:00 ping127.0.0.1</span><br><span class="line">root       30547  0.0  0.1  12108   988 pts/2   S+   12:25   0:00 grep --color=auto ping</span><br><span class="line"></span><br><span class="line"><span class="comment">#关闭终端1后,在终端2查看不到进程</span></span><br><span class="line">[root@centos8 ~]<span class="comment">#ps aux|grep ping</span></span><br><span class="line">root       30552  0.0  0.1  12108  1084 pts/2   S+   12:25   0:00 grep --color=auto ping</span><br></pre></td></tr></table></figure>

<p>范例: nohup</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ~]<span class="comment"># rpm -qf `which nohup`</span></span><br><span class="line">coreutils-8.30-6.el8_1.1.x86_64</span><br><span class="line"></span><br><span class="line">[root@centos8 ~]<span class="comment"># nohup ping 127.0.0.1</span></span><br><span class="line"><span class="built_in">nohup</span>: ignoring input and appending output to <span class="string">&#x27;nohup.out&#x27;</span></span><br><span class="line"></span><br><span class="line">[root@centos8 ~]<span class="comment"># tail -f nohup.out</span></span><br><span class="line">64 bytes from 127.0.0.1: icmp_seq=16 ttl=64 time=0.037 ms</span><br><span class="line">64 bytes from 127.0.0.1: icmp_seq=17 ttl=64 time=0.040 ms</span><br><span class="line">64 bytes from 127.0.0.1: icmp_seq=18 ttl=64 time=0.042 ms</span><br><span class="line">64 bytes from 127.0.0.1: icmp_seq=19 ttl=64 time=0.047 ms</span><br><span class="line"></span><br><span class="line">[root@centos8 ~]<span class="comment"># nohup ping 127.0.0.1 &amp;&gt; /dev/null &amp;</span></span><br><span class="line">[1] 9640</span><br><span class="line"></span><br><span class="line">[root@centos8 ~]<span class="comment"># ps aux| grep nohup</span></span><br><span class="line">root        9642  0.0  0.1  12108   992 pts/0   S+   10:28   0:00 grep --color=auto <span class="built_in">nohup</span></span><br><span class="line"></span><br><span class="line">[root@centos8 ~]<span class="comment"># pstree -p |grep ping</span></span><br><span class="line">           |-sshd(753)-+-sshd(9415)---sshd(9417)---bash(9446)---ping(9640)</span><br><span class="line">           </span><br><span class="line"><span class="comment">#关闭对应的终端,再观察进程的父进程</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># pstree -p |grep ping</span></span><br><span class="line">           |-ping(9640)</span><br></pre></td></tr></table></figure>

<h2 id="并行运行"><a href="#并行运行" class="headerlink" title="并行运行"></a>并行运行</h2><p>利用后台执行，实现并行功能，即同时运行多个进程，提高效率</p>
<p>方法1</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">cat all.sh</span><br><span class="line">f1.sh&amp;</span><br><span class="line">f2.sh&amp;</span><br><span class="line">f3.sh&amp;</span><br></pre></td></tr></table></figure>

<p>方法2</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(f1.sh&amp;);(f2.sh&amp;);(f3.sh&amp;)</span><br></pre></td></tr></table></figure>

<p>方法3</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">f1.sh&amp;f2.sh&amp;f3.sh&amp; </span><br></pre></td></tr></table></figure>

<p>范例：多组命令实现并行</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ~]<span class="comment"># &#123; ping -c3 127.1; ping 127.2; &#125;&amp; &#123; ping -c3 127.3 ;ping 127.4; &#125;&amp;</span></span><br></pre></td></tr></table></figure>

<p>范例:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ~]<span class="comment">#cat scanhost.sh</span></span><br><span class="line"><span class="comment">#!/bin/bash</span></span><br><span class="line">NET=10.0.0</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> &#123;1..254&#125;;<span class="keyword">do</span></span><br><span class="line">   &#123; ping -c1 -W1 <span class="variable">$&#123;NET&#125;</span>.<span class="variable">$&#123;i&#125;</span> &amp;&gt; /dev/null &amp;&amp; <span class="built_in">echo</span> <span class="variable">$&#123;NET&#125;</span>.<span class="variable">$&#123;i&#125;</span> is up || <span class="built_in">echo</span> <span class="variable">$&#123;NET&#125;</span>.<span class="variable">$&#123;i&#125;</span> is down; &#125;&amp;</span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"><span class="built_in">wait</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@centos8 ~]<span class="comment">#cat scan_host.sh</span></span><br><span class="line"><span class="comment">#!/bin/bash</span></span><br><span class="line">net=10.0.0</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> &#123;1..254&#125;;<span class="keyword">do</span></span><br><span class="line">   &#123; </span><br><span class="line">    <span class="keyword">if</span> ping -c1 -W1 <span class="variable">$net</span>.<span class="variable">$i</span> &amp;&gt; /dev/null;<span class="keyword">then</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="variable">$net</span>.<span class="variable">$i</span> is up</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="variable">$net</span>.<span class="variable">$i</span> is down</span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line">   &#125;&amp;</span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"><span class="built_in">wait</span></span><br></pre></td></tr></table></figure>

<h1 id="任务计划"><a href="#任务计划" class="headerlink" title="任务计划"></a>任务计划</h1><p>通过任务计划，可以让系统自动的按时间或周期性任务执行任务 </p>
<p>注意: 学习本节需要实现邮件通知,学习内容前必须安装并启动邮件服务</p>
<p>范例: 环境准备</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ~]<span class="comment"># yum -y install postfix</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># systemctl enable --now postfix</span></span><br></pre></td></tr></table></figure>

<p>未来的某时间点执行一次任务</p>
<ul>
<li>at 指定时间点，执行一次性任务</li>
<li>batch 系统自行选择空闲时间去执行此处指定的任务</li>
</ul>
<p>周期性运行某任务</p>
<ul>
<li>cron</li>
</ul>
<h2 id="一次性任务"><a href="#一次性任务" class="headerlink" title="一次性任务"></a>一次性任务</h2><p>at 工具</p>
<ul>
<li>由包 at 提供</li>
<li>依赖与atd服务,需要启动才能实现at任务</li>
<li>at队列存放在/var/spool/at目录中,ubuntu存放在/var/spool/cron/atjobs目录下</li>
<li>执行任务时PATH变量的值和当前定义任务的用户身份一致</li>
</ul>
<p>at 命令：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">at [option] TIME</span><br></pre></td></tr></table></figure>

<p>常用选项：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">-V                  <span class="comment">#显示版本信息</span></span><br><span class="line">-t time             <span class="comment">#时间格式 [[CC]YY]MMDDhhmm[.ss] </span></span><br><span class="line">-l                  <span class="comment">#列出指定队列中等待运行的作业；相当于atq</span></span><br><span class="line">-d N                <span class="comment">#删除指定的N号作业；相当于atrm</span></span><br><span class="line">-c N                <span class="comment">#查看具体作业N号任务</span></span><br><span class="line">-f file             <span class="comment">#指定的文件中读取任务</span></span><br><span class="line">-m                  <span class="comment">#当任务被完成之后，将给用户发送邮件，即使没有标准输出</span></span><br></pre></td></tr></table></figure>

<p>注意： </p>
<ul>
<li>作业执行命令的结果中的标准输出和错误以执行任务的用户身份发邮件通知给 root</li>
<li>默认CentOS 8 最小化安装没有安装邮件服务,需要自行安装</li>
</ul>
<p>TIME：定义出什么时候进行 at 这项任务的时间</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">HH:MM [YYYY-mm-dd]</span><br><span class="line">noon, midnight, teatime（4pm）,tomorrow</span><br><span class="line">now+<span class="comment">#&#123;minutes,hours,days, OR weeks&#125;</span></span><br></pre></td></tr></table></figure>

<p>范例：at 时间格式</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">HH:MM 在今日的 HH:MM 进行，若该时刻已过，则明天此时执行任务</span><br><span class="line">02:00    </span><br><span class="line"></span><br><span class="line">HH:MM YYYY-MM-DD   规定在某年某月的某一天的特殊时刻进行该项任务</span><br><span class="line">02:00 2016-09-20   </span><br><span class="line"></span><br><span class="line">HH:MM[am|pm] [Month] [Date]</span><br><span class="line">06pm March 17</span><br><span class="line">17:20 tomorrow</span><br><span class="line"></span><br><span class="line">HH:MM[am|pm] + number [minutes|hours|days|weeks]， 在某个时间点再加几个时间后才进行该项任务</span><br><span class="line">now + 5 min </span><br><span class="line">02pm + 3 days</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>at 任务执行方式： </p>
<ul>
<li>交互式</li>
<li>输入重定向</li>
<li>at -f file </li>
</ul>
<p>/etc/at.{allow,deny} 控制用户是否能执行at任务</p>
<ul>
<li>白名单：/etc/at.allow 默认不存在，只有该文件中的用户才能执行at命令 </li>
<li>黑名单：/etc/at.deny 默认存在，拒绝该文件中用户执行at命令，而没有在at.deny 文件中的使用者则可执行</li>
<li>如果两个文件都不存在，只有 root 可以执行 at 命令 </li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@rocky ~]<span class="comment"># at 03:55</span></span><br><span class="line">warning: commands will be executed using /bin/sh</span><br><span class="line">at&gt; <span class="built_in">touch</span> 123</span><br><span class="line">at&gt; &lt;EOT&gt;   <span class="comment"># Ctrl+d</span></span><br></pre></td></tr></table></figure>

<p>范例: ubuntu at任务存放路径</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[root@ubuntu2004 ~]<span class="comment">#ll /var/spool/cron/</span></span><br><span class="line">total 20</span><br><span class="line">drwxr-xr-x 5 root   root    4096 Apr 23  2020 ./</span><br><span class="line">drwxr-xr-x 5 root   root    4096 Dec 12 17:42 ../</span><br><span class="line">drwxrwx--T 2 daemon daemon  4096 Dec 12 17:47 atjobs/</span><br><span class="line">drwxrwx--T 2 daemon daemon  4096 Dec 12 17:47 atspool/</span><br><span class="line">drwx-wx--T 2 root   crontab 4096 Feb 14  2020 crontabs/</span><br><span class="line"></span><br><span class="line">[root@ubuntu2004 ~]<span class="comment">#ll /var/spool/cron/atjobs/</span></span><br><span class="line">total 16</span><br><span class="line">drwxrwx--T 2 daemon daemon 4096 Dec 12 17:47 ./</span><br><span class="line">drwxr-xr-x 5 root   root   4096 Apr 23  2020 ../</span><br><span class="line">-rwx------ 1 root   daemon 2875 Dec 12 17:36 a000010198e058*</span><br><span class="line">-rw------- 1 daemon daemon    6 Dec 12 17:46 .SEQ</span><br></pre></td></tr></table></figure>

<h2 id="周期性任务计划-cron"><a href="#周期性任务计划-cron" class="headerlink" title="周期性任务计划 cron"></a>周期性任务计划 cron</h2><p>周期性任务计划cron相关的程序包： </p>
<ul>
<li>cronie：主程序包，提供crond守护进程及相关辅助工具</li>
<li>crontabs：包含CentOS提供系统维护任务</li>
<li>cronie-anacron：cronie的补充程序，用于监控cronie任务执行状况，如:cronie中的任务在过去该运行的时间点未能正常运行，则anacron会随后启动一次此任务 </li>
</ul>
<p>cron 依赖于crond服务，确保crond守护处于运行状态：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#CentOS 7 以后版本:</span></span><br><span class="line">systemctl status crond</span><br><span class="line"></span><br><span class="line"><span class="comment">#CentOS 6:</span></span><br><span class="line">service crond status</span><br></pre></td></tr></table></figure>

<p>cron任务分为</p>
<ul>
<li>系统cron任务：系统维护作业，/etc/crontab 主配置文件， /etc/cron.d/ 子配置文件 </li>
<li>用户cron任务：红帽系统保存在 /var/spool/cron/USERNAME,Ubuntu 系统存放在/var/spool/cron/crontabs/USERNAME，利用 crontab 命令管理</li>
</ul>
<p>计划任务日志：/var/log/cron</p>
<h3 id="系统cron计划任务"><a href="#系统cron计划任务" class="headerlink" title="系统cron计划任务"></a>系统cron计划任务</h3><p>/etc/crontab 格式说明，详情参见 man 5 crontab  </p>
<p>注释行以 # 开头</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ~]<span class="comment">#cat /etc/crontab </span></span><br><span class="line">SHELL=/bin/bash   <span class="comment">#默认的SHELL类型</span></span><br><span class="line">PATH=/sbin:/bin:/usr/sbin:/usr/bin  <span class="comment">#默认的PATH变量值,可修改为其它路径</span></span><br><span class="line">MAILTO=root                         <span class="comment">#默认标准输出和错误发邮件给root,可以指向其它用户</span></span><br><span class="line"><span class="comment"># For details see man 4 crontabs</span></span><br><span class="line"><span class="comment"># Example of job definition:</span></span><br><span class="line"><span class="comment"># .---------------- minute (0 - 59)</span></span><br><span class="line"><span class="comment"># | .------------- hour (0 - 23)</span></span><br><span class="line"><span class="comment"># | | .---------- day of month (1 - 31)</span></span><br><span class="line"><span class="comment"># | | | .------- month (1 - 12) OR jan,feb,mar,apr ...</span></span><br><span class="line"><span class="comment"># | | | | .---- day of week (0 - 6) (Sunday=0 or 7) OR sun,mon,tue,wed,thu,fri,sat</span></span><br><span class="line"><span class="comment"># | | | | |</span></span><br><span class="line"><span class="comment"># * * * * * user-name command to be executed</span></span><br></pre></td></tr></table></figure>

<p><strong>计划任务时间表示法：</strong></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">(1) 特定值</span><br><span class="line">     给定时间点有效取值范围内的值</span><br><span class="line">(2) *</span><br><span class="line">     给定时间点上有效取值范围内的所有值,表示“每...”,放在星期的位置表示不确定</span><br><span class="line">(3) 离散取值</span><br><span class="line">     <span class="comment">#,#,#</span></span><br><span class="line">(4) 连续取值</span><br><span class="line">     <span class="comment">#-#</span></span><br><span class="line">(5) 在指定时间范围上，定义步长</span><br><span class="line">     /<span class="comment">#: #即为步长</span></span><br><span class="line"> </span><br><span class="line">(6) 特定关健字</span><br><span class="line">@yearly   0 0 1 1 *</span><br><span class="line">@annually 0 0 1 1 *</span><br><span class="line">@monthly  0 0 1 * *</span><br><span class="line">@weekly   0 0 * * 0</span><br><span class="line">@daily    0 0 * * *</span><br><span class="line">@hourly   0 * * * *</span><br><span class="line">@reboot Run once after reboot</span><br></pre></td></tr></table></figure>

<p>范例:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ~]<span class="comment"># man 5 crontab</span></span><br><span class="line">For example, <span class="string">&quot;0-23/2&quot;</span> can be used <span class="keyword">in</span> the <span class="string">&#x27;hours&#x27;</span> field to specify <span class="built_in">command</span> execution <span class="keyword">for</span> every other hour (the alternative <span class="keyword">in</span> the V7 standard is <span class="string">&quot;0,2,4,6,8,10,12,14,16,18,20,22&quot;</span>)</span><br></pre></td></tr></table></figure>

<p>范例：每个月日期和星期几字段的关系</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ~]#man 5 crontab</span><br><span class="line"><span class="attribute">Note</span><span class="punctuation">: </span>The day of a command&#x27;s execution can be specified in the following two fields — &#x27;day of   month&#x27;, and &#x27;day of week&#x27;. If both fields are restricted </span><br><span class="line">(i.e., do not contain the &quot;*&quot; character), the command will be run when either field matches the current time. For example, &quot;30 4 1,15 * 5&quot; would cause a command to be run at 4:30 am on the 1st and 15th of each month, plus every Friday.</span><br></pre></td></tr></table></figure>

<p>范例：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#晚上9点10分运行echo命令,输出信息仍会发送到root 邮箱</span></span><br><span class="line">10 21 * * * wang /bin/echo <span class="string">&quot;Howdy!&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#每3小时echo和wall命令</span></span><br><span class="line">0 */3 * * * wang /bin/echo <span class="string">&quot;howdy&quot;</span>;  wall <span class="string">&quot;welcome to Magedu!&quot;</span></span><br></pre></td></tr></table></figure>

<p>crond任务相关文件:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">/etc/crontab         配置文件</span><br><span class="line">/etc/cron.d/         配置文件</span><br><span class="line">/etc/cron.hourly/    脚本</span><br><span class="line">/etc/cron.daily/     脚本</span><br><span class="line">/etc/cron.weekly/    脚本</span><br><span class="line">/etc/cron.monthly/   脚本</span><br></pre></td></tr></table></figure>

<h3 id="用户计划任务"><a href="#用户计划任务" class="headerlink" title="用户计划任务"></a>用户计划任务</h3><p><img src="../../../../images/image/SRE/day13/31.png" alt="31"></p>
<p>crontab命令:  </p>
<ul>
<li>每个用户都有专用的cron任务文件：/var/spool/cron/USERNAME </li>
<li>默认标准输出和错误会被发邮件给对应的用户,如：wang创建的任务就发送至wang的邮箱 </li>
<li>root能够修改其它用户的作业 </li>
<li>用户的cron 中默认 PATH=/usr/bin:/bin,如果使用其它路径,在任务文件的第一行加PATH=/path或者加入到计划任务执行的脚本中 </li>
<li>第六个字段指定要运行的命令。 该行的整个命令部分，直至换行符或“％”字符，指定的shell执行.  除非使用反斜杠（\）进行转义，否则该命令中的“％”字符将变为换行符，并且第一个％之后的所有数据将作为标准输入发送到该命令。 </li>
</ul>
<p>crontab命令格式：</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">crontab [-u user] [-l | -r | -e] [-i]</span><br></pre></td></tr></table></figure>

<p>常用选项：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">-l               <span class="comment">#列出所有任务</span></span><br><span class="line">-e               <span class="comment">#编辑任务</span></span><br><span class="line">-r               <span class="comment">#移除所有任务</span></span><br><span class="line">-i               <span class="comment">#同-r一同使用，以交互式模式移除指定任务</span></span><br><span class="line">-u user          <span class="comment">#指定用户管理cron任务,仅root可运行</span></span><br></pre></td></tr></table></figure>

<p>控制用户执行计划任务：</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/etc/cron.&#123;allow,deny&#125;</span><br></pre></td></tr></table></figure>

<p>范例：修改默认的cron的文本编辑工具</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#Ubuntu默认的cron文本编辑器是nano可以修改为vim</span></span><br><span class="line">root@ubuntu1804:~<span class="comment"># crontab -e</span></span><br><span class="line">no crontab <span class="keyword">for</span> root - using an empty one</span><br><span class="line"></span><br><span class="line">Select an editor. To change later, run <span class="string">&#x27;select-editor&#x27;</span>.</span><br><span class="line">  1. /bin/nano       &lt;---- easiest</span><br><span class="line">  2. /usr/bin/vim.basic</span><br><span class="line">  3. /usr/bin/vim.tiny</span><br><span class="line">  4. /bin/ed</span><br><span class="line">  </span><br><span class="line">Choose 1-4 [1]:</span><br><span class="line">root@ubuntu1804:~<span class="comment"># cat /etc/profile.d/env.sh</span></span><br><span class="line"><span class="built_in">export</span> EDITOR=vim</span><br></pre></td></tr></table></figure>

<p>范例：PATH变量</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#方法1,在计划任务配置中指定PATH</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># crontab -l</span></span><br><span class="line">PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/root/bin</span><br><span class="line">* * * * * useradd hehe;<span class="built_in">echo</span> <span class="variable">$PATH</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#方法2,在脚本中指定PATH变量</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># crontab -l</span></span><br><span class="line">* * * * * /data/test.sh</span><br><span class="line"></span><br><span class="line">[root@centos8 ~]<span class="comment"># cat /data/test.sh</span></span><br><span class="line"><span class="comment">#!/bin/bash</span></span><br><span class="line">PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/root/bin</span><br><span class="line">useradd hehe</span><br><span class="line"><span class="built_in">echo</span> <span class="variable">$PATH</span></span><br></pre></td></tr></table></figure>

<p>范例: </p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@rocky8 ~]<span class="comment"># echo @reboot echo reboot | crontab </span></span><br><span class="line">[root@rocky8 ~]<span class="comment"># crontab -l</span></span><br><span class="line">@reboot <span class="built_in">echo</span> reboot</span><br></pre></td></tr></table></figure>

<p>范例：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ~]<span class="comment"># cat /usr/bin/disk_check.sh </span></span><br><span class="line"><span class="comment">#!/bin/bash</span></span><br><span class="line">WARNING=10</span><br><span class="line"><span class="built_in">df</span> | sed -En <span class="string">&#x27;/^\/dev\/sd/s@^([^ ]+).* ([0-9]+)%.*@\1 \2@p&#x27;</span>| <span class="keyword">while</span> <span class="built_in">read</span> DEVICE USE;<span class="keyword">do</span></span><br><span class="line">   [ <span class="variable">$USE</span> -gt <span class="variable">$WARNING</span> ] &amp;&amp; <span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$DEVICE</span> will be full,USE:<span class="variable">$USE</span>&quot;</span> | mail -s diskfull root</span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"></span><br><span class="line">[root@centos8 ~]<span class="comment"># crontab -l</span></span><br><span class="line">*/10 * * * * check_disk.sh</span><br></pre></td></tr></table></figure>

<p>范例:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ~]<span class="comment"># cat check_disk.sh </span></span><br><span class="line"><span class="comment">#!/bin/bash</span></span><br><span class="line"><span class="built_in">df</span> | awk  -F <span class="string">&#x27; +|%&#x27;</span>  <span class="string">&#x27;/^\/dev\/sd/&#123;if($5 &gt; 10)&#123;system(&quot;echo &quot;$1&quot; will be full,use:&quot; $5 &quot;| mail -s warning root@wangxiaochun.com&quot;)&#125; &#125;&#x27;</span></span><br><span class="line"></span><br><span class="line">[root@centos8 ~]<span class="comment"># crontab -l</span></span><br><span class="line">*/10 * * * * /root/check_disk.sh</span><br></pre></td></tr></table></figure>

<p>范例:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ~]<span class="comment"># cat check_disk2.sh </span></span><br><span class="line"><span class="comment">#!/bin/bash</span></span><br><span class="line">WARNING=2</span><br><span class="line"><span class="built_in">df</span> | awk  -F <span class="string">&#x27; +|%&#x27;</span>  <span class="string">&#x27;/^\/dev\/sd/&#123;print $1,$5&#125;&#x27;</span>|<span class="keyword">while</span> <span class="built_in">read</span> DISK USE;<span class="keyword">do</span> </span><br><span class="line"><span class="keyword">if</span> [ <span class="variable">$USE</span> -gt <span class="variable">$WARNING</span> ];<span class="keyword">then</span></span><br><span class="line">   <span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$DISK</span> will be full,use:<span class="variable">$USE</span>&quot;</span> | mail -s diskwarning root@wangxiaochun.com</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@centos8 ~]<span class="comment">#crontab -l</span></span><br><span class="line">*/10 * * * * /root/check_disk2.sh</span><br></pre></td></tr></table></figure>

<p>面试题：11月每天的6-12点之间每隔2小时执行/app/bin/test.sh</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#在6,8,10,12点整共4次分别执行test.sh</span></span><br><span class="line">[root@centos8 ~]<span class="comment">#crontab -l</span></span><br><span class="line">0 6-12/2 * 11 * /app/bin/test.sh</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#以下配置只会在5,7,9,11点整执行</span></span><br><span class="line">0 5-12/2 * 11 * /app/bin/test.sh</span><br></pre></td></tr></table></figure>

<p>注意：运行结果的标准输出和错误以邮件通知给相关用户</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">(1) COMMAND &gt; /dev/null </span><br><span class="line">(2) COMMAND &amp;&gt; /dev/null</span><br></pre></td></tr></table></figure>

<p>cron任务中不建议使用%，它有特殊用途，它表示换行的特殊意义，且第一个%后的所有字符串会被将成当作命令的标准输入,如果在命令中要使用%，则需要用 \ 转义 </p>
<p>注意：将%放置于单引号中是不支持的</p>
<p>范例： 在crontab中%的用法</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">30 2 * * * /bin/cp -a /etc/ /data/etc`date +\%F_\%T`</span><br><span class="line">30 2 * * * /bin/cp -a /etc/ /data/etc`date +‘%F_%T’`   有问题</span><br></pre></td></tr></table></figure>

<p>范例: 在crontab中%的用法</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ~]<span class="comment">#crontab -l</span></span><br><span class="line">* * * * *   mail -s <span class="string">&quot;test&quot;</span> wang%wang,%%how are you?%</span><br><span class="line"></span><br><span class="line">[root@centos8 ~]<span class="comment"># cat /var/spool/mail/wang</span></span><br><span class="line">From root@centos8.localdomain Sat Jul  4 23:58:01 2020</span><br><span class="line">Return-Path: &lt;root@centos8.localdomain&gt;</span><br><span class="line">X-Original-To: wang</span><br><span class="line">Delivered-To: wang@centos8.localdomain</span><br><span class="line">Received: by centos8.localdomain (Postfix, from userid 0)</span><br><span class="line">     <span class="built_in">id</span> 0B03860272; Sat,  4 Jul 2020 23:58:01 +0800 (CST)</span><br><span class="line">Date: Sat, 04 Jul 2020 23:58:01 +0800</span><br><span class="line">To: wang@centos8.localdomain</span><br><span class="line">Subject: <span class="built_in">test</span></span><br><span class="line">User-Agent: Heirloom mailx 12.5 7/5/10</span><br><span class="line">MIME-Version: 1.0</span><br><span class="line">Content-Type: text/plain; charset=us-ascii</span><br><span class="line">Content-Transfer-Encoding: 7bit</span><br><span class="line">Message-Id: &lt;20200704155801.0B03860272@centos8.localdomain&gt;</span><br><span class="line">From: root@centos8.localdomain (root)</span><br><span class="line"></span><br><span class="line">wang,</span><br><span class="line"></span><br><span class="line">how are you?</span><br><span class="line"></span><br><span class="line">[root@centos8 ~]<span class="comment">#</span></span><br></pre></td></tr></table></figure>

<p>思考： </p>
<p>(1) 如何在秒级别运行任务？</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> min <span class="keyword">in</span> 0 1 2; <span class="keyword">do</span> <span class="built_in">echo</span> <span class="string">&quot;hi&quot;</span>; <span class="built_in">sleep</span> 20; <span class="keyword">done</span></span><br></pre></td></tr></table></figure>

<p>(2) 如何实现每7分钟运行一次任务? </p>
<p>sleep命令：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sleep</span> NUMBER[SUFFIX]...</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">SUFFIX: </span><br><span class="line">s:  秒, 默认</span><br><span class="line">m:  分 </span><br><span class="line">h:  小时</span><br><span class="line">d:  天</span><br></pre></td></tr></table></figure>

<p>范例:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ~]<span class="comment"># usleep </span></span><br><span class="line">warning: usleep is deprecated, and will be removed <span class="keyword">in</span> near future!</span><br><span class="line">warning: use <span class="string">&quot;sleep 1e-06&quot;</span> instead...</span><br></pre></td></tr></table></figure>

<p>范例：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ~]<span class="comment"># time usleep 1000000</span></span><br><span class="line">warning: usleep is deprecated, and will be removed <span class="keyword">in</span> near future!</span><br><span class="line">warning: use <span class="string">&quot;sleep 1&quot;</span> instead...</span><br><span class="line">real 0m1.001s</span><br><span class="line">user 0m0.001s</span><br><span class="line">sys 0m0.000s</span><br><span class="line">You have new mail <span class="keyword">in</span> /var/spool/mail/root</span><br><span class="line"></span><br><span class="line">[root@centos8 ~]<span class="comment"># time ls</span></span><br><span class="line">all.sh anaconda-ks2.cfg at.txt scanhost.sh</span><br><span class="line">real 0m0.004s</span><br><span class="line">user 0m0.001s</span><br><span class="line">sys 0m0.003s</span><br><span class="line"></span><br><span class="line">[root@centos8 ~]<span class="comment"># time sleep 0.2</span></span><br><span class="line">real 0m0.202s</span><br><span class="line">user 0m0.001s</span><br><span class="line">sys 0m0.000s</span><br></pre></td></tr></table></figure>

</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="http://example.com">૮(˶ᵔ ᵕ ᵔ˶)ა</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="http://example.com/2024/11/29/SRE-%E8%BF%9B%E7%A8%8B%EF%BC%8C%E7%B3%BB%E7%BB%9F%E6%80%A7%E8%83%BD%E5%92%8C%E8%AE%A1%E5%88%92%E4%BB%BB%E5%8A%A1/">http://example.com/2024/11/29/SRE-进程，系统性能和计划任务/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="http://example.com" target="_blank">૮(˶ᵔ ᵕ ᵔ˶)ა</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/SRE/">SRE</a></div><div class="post_share"><div class="social-share" data-image="/../images/image/SRE/day13/22.png" data-sites="wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2024/11/26/SRE-%E7%BD%91%E7%BB%9C%E9%85%8D%E7%BD%AE%E5%92%8C%E9%AB%98%E7%BA%A7%E5%8A%9F%E8%83%BD/" title="网络配置和高级功能"><img class="cover" src="/../images/title/network.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">网络配置和高级功能</div></div></a></div><div class="next-post pull-right"><a href="/2024/12/01/SRE-%E7%B3%BB%E7%BB%9F%E5%90%AF%E5%8A%A8%E5%92%8C%E5%86%85%E6%A0%B8%E7%AE%A1%E7%90%86/" title="系统启动和内核管理"><img class="cover" src="/../images/title/linux4.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">系统启动和内核管理</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><div><a href="/2024/04/24/SRE-Linux%E5%9F%BA%E6%9C%AC%E6%93%8D%E4%BD%9C%E5%92%8C%E5%B8%AE%E5%8A%A9/" title="Linux基本操作和帮助"><img class="cover" src="/../images/title/linux2.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-04-24</div><div class="title">Linux基本操作和帮助</div></div></a></div><div><a href="/2024/08/27/SRE-Linux%E6%96%87%E4%BB%B6%E7%AE%A1%E7%90%86%E5%92%8CIO%E9%87%8D%E5%AE%9A%E5%90%91/" title="Linux文件管理和IO重定向"><img class="cover" src="/../images/title/linux3.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-08-27</div><div class="title">Linux文件管理和IO重定向</div></div></a></div><div><a href="/2024/12/08/SRE-Linux%E9%98%B2%E7%81%AB%E5%A2%99/" title="Linux防火墙"><img class="cover" src="/../images/image/SRE/day17/12.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-12-08</div><div class="title">Linux防火墙</div></div></a></div><div><a href="/2025/02/18/SRE-OpenVPN/" title="OpenVPN"><img class="cover" src="/../images/image/SRE/day25/5.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2025-02-18</div><div class="title">OpenVPN</div></div></a></div><div><a href="/2024/11/05/SRE-Shell%E8%84%9A%E6%9C%AC%E7%BC%96%E7%A8%8B/" title="shell脚本编程"><img class="cover" src="/../images/title/linux2.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-11-05</div><div class="title">shell脚本编程</div></div></a></div><div><a href="/2024/12/08/SRE-linux%E5%91%BD%E4%BB%A4%E7%B4%A2%E5%BC%95/" title="linux命令索引"><img class="cover" src="/../images/title/linux3.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-12-08</div><div class="title">linux命令索引</div></div></a></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="/../images/title/user.webp" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">૮(˶ᵔ ᵕ ᵔ˶)ა</div><div class="author-info__description">这家伙很勤奋，什么都留下了</div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">87</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">29</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">4</div></a></div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content is-expand"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E8%BF%9B%E7%A8%8B%E5%92%8C%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86"><span class="toc-number">1.</span> <span class="toc-text">进程和内存管理</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BB%80%E4%B9%88%E6%98%AF%E8%BF%9B%E7%A8%8B"><span class="toc-number">1.1.</span> <span class="toc-text">什么是进程</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%BF%9B%E7%A8%8B%E7%BB%93%E6%9E%84"><span class="toc-number">1.2.</span> <span class="toc-text">进程结构</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%BF%9B%E7%A8%8B%E7%9B%B8%E5%85%B3%E6%A6%82%E5%BF%B5"><span class="toc-number">1.3.</span> <span class="toc-text">进程相关概念</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%89%A9%E7%90%86%E5%9C%B0%E5%9D%80%E7%A9%BA%E9%97%B4%E5%92%8C%E8%99%9A%E6%8B%9F%E5%9C%B0%E5%9D%80%E7%A9%BA%E9%97%B4"><span class="toc-number">1.3.1.</span> <span class="toc-text">物理地址空间和虚拟地址空间</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%94%A8%E6%88%B7%E5%92%8C%E5%86%85%E6%A0%B8%E7%A9%BA%E9%97%B4"><span class="toc-number">1.3.2.</span> <span class="toc-text">用户和内核空间</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#c%E4%BB%A3%E7%A0%81%E5%92%8C%E5%86%85%E5%AD%98%E5%B8%83%E5%B1%80%E4%B9%8B%E9%97%B4%E7%9A%84%E5%AF%B9%E5%BA%94%E5%85%B3%E7%B3%BB"><span class="toc-number">1.3.3.</span> <span class="toc-text">c代码和内存布局之间的对应关系</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%BF%9B%E7%A8%8B%E4%BD%BF%E7%94%A8%E5%86%85%E5%AD%98%E9%97%AE%E9%A2%98"><span class="toc-number">1.3.4.</span> <span class="toc-text">进程使用内存问题</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%86%85%E5%AD%98%E6%B3%84%E6%BC%8F-Memory-Leak"><span class="toc-number">1.3.4.1.</span> <span class="toc-text">内存泄漏: Memory Leak</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%86%85%E5%AD%98%E6%BA%A2%E5%87%BA-Memory-Over-Overflow"><span class="toc-number">1.3.4.2.</span> <span class="toc-text">内存溢出: Memory Over Overflow</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%86%85%E5%AD%98%E4%B8%8D%E8%B6%B3-OOM"><span class="toc-number">1.3.4.3.</span> <span class="toc-text">内存不足: OOM</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%BF%9B%E7%A8%8B%E7%8A%B6%E6%80%81"><span class="toc-number">1.4.</span> <span class="toc-text">进程状态</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#LRU-%E7%AE%97%E6%B3%95"><span class="toc-number">1.5.</span> <span class="toc-text">LRU 算法</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#IPC%E8%BF%9B%E7%A8%8B%E9%97%B4%E9%80%9A%E4%BF%A1"><span class="toc-number">1.6.</span> <span class="toc-text">IPC进程间通信</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%BF%9B%E7%A8%8B%E4%BC%98%E5%85%88%E7%BA%A7"><span class="toc-number">1.7.</span> <span class="toc-text">进程优先级</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%BF%9B%E7%A8%8B%E5%88%86%E7%B1%BB"><span class="toc-number">1.8.</span> <span class="toc-text">进程分类</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E8%BF%9B%E7%A8%8B%E7%AE%A1%E7%90%86%E5%92%8C%E6%80%A7%E8%83%BD%E7%9B%B8%E5%85%B3%E7%9A%84%E5%B7%A5%E5%85%B7"><span class="toc-number">2.</span> <span class="toc-text">进程管理和性能相关的工具</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%BF%9B%E7%A8%8B%E6%A0%91pstree"><span class="toc-number">2.1.</span> <span class="toc-text">进程树pstree</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%BF%9B%E7%A8%8B%E4%BF%A1%E6%81%AF-ps"><span class="toc-number">2.2.</span> <span class="toc-text">进程信息 ps</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9F%A5%E7%9C%8B%E8%BF%9B%E7%A8%8B%E4%BF%A1%E6%81%AF-prtstat"><span class="toc-number">2.3.</span> <span class="toc-text">查看进程信息 prtstat</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%AE%BE%E7%BD%AE%E5%92%8C%E8%B0%83%E6%95%B4%E8%BF%9B%E7%A8%8B%E4%BC%98%E5%85%88%E7%BA%A7"><span class="toc-number">2.4.</span> <span class="toc-text">设置和调整进程优先级</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%90%9C%E7%B4%A2%E8%BF%9B%E7%A8%8B"><span class="toc-number">2.5.</span> <span class="toc-text">搜索进程</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#pgrep"><span class="toc-number">2.5.1.</span> <span class="toc-text">pgrep</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#pidof"><span class="toc-number">2.5.2.</span> <span class="toc-text">pidof</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%B4%9F%E8%BD%BD%E6%9F%A5%E8%AF%A2-uptime"><span class="toc-number">2.6.</span> <span class="toc-text">负载查询 uptime</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%98%BE%E7%A4%BACPU%E7%9B%B8%E5%85%B3%E7%BB%9F%E8%AE%A1-mpstat"><span class="toc-number">2.7.</span> <span class="toc-text">显示CPU相关统计 mpstat</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9F%A5%E7%9C%8B%E8%BF%9B%E7%A8%8B%E5%AE%9E%E6%97%B6%E7%8A%B6%E6%80%81-top-%E5%92%8C-htop"><span class="toc-number">2.8.</span> <span class="toc-text">查看进程实时状态 top 和 htop</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#top"><span class="toc-number">2.8.1.</span> <span class="toc-text">top</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#htop"><span class="toc-number">2.8.2.</span> <span class="toc-text">htop</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%86%85%E5%AD%98%E7%A9%BA%E9%97%B4-free"><span class="toc-number">2.9.</span> <span class="toc-text">内存空间 free</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%BF%9B%E7%A8%8B%E5%AF%B9%E5%BA%94%E7%9A%84%E5%86%85%E5%AD%98%E6%98%A0%E5%B0%84-pmap"><span class="toc-number">2.10.</span> <span class="toc-text">进程对应的内存映射 pmap</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%99%9A%E6%8B%9F%E5%86%85%E5%AD%98%E4%BF%A1%E6%81%AF-vmstat"><span class="toc-number">2.11.</span> <span class="toc-text">虚拟内存信息 vmstat</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BB%9F%E8%AE%A1CPU%E5%92%8C%E8%AE%BE%E5%A4%87IO%E4%BF%A1%E6%81%AF-iostat"><span class="toc-number">2.12.</span> <span class="toc-text">统计CPU和设备IO信息 iostat</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%9B%91%E8%A7%86%E7%A3%81%E7%9B%98I-O-iotop"><span class="toc-number">2.13.</span> <span class="toc-text">监视磁盘I&#x2F;O iotop</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%98%BE%E7%A4%BA%E7%BD%91%E7%BB%9C%E5%B8%A6%E5%AE%BD%E4%BD%BF%E7%94%A8%E6%83%85%E5%86%B5-iftop"><span class="toc-number">2.14.</span> <span class="toc-text">显示网络带宽使用情况 iftop</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9F%A5%E7%9C%8B%E7%BD%91%E7%BB%9C%E5%AE%9E%E6%97%B6%E5%90%9E%E5%90%90%E9%87%8F-nload"><span class="toc-number">2.15.</span> <span class="toc-text">查看网络实时吞吐量 nload</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9F%A5%E7%9C%8B%E8%BF%9B%E7%A8%8B%E7%BD%91%E7%BB%9C%E5%B8%A6%E5%AE%BD%E7%9A%84%E4%BD%BF%E7%94%A8%E6%83%85%E5%86%B5-nethogs"><span class="toc-number">2.16.</span> <span class="toc-text">查看进程网络带宽的使用情况 nethogs</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BD%91%E7%BB%9C%E7%9B%91%E8%A7%86%E5%B7%A5%E5%85%B7iptraf-ng"><span class="toc-number">2.17.</span> <span class="toc-text">网络监视工具iptraf-ng</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%B3%BB%E7%BB%9F%E8%B5%84%E6%BA%90%E7%BB%9F%E8%AE%A1-dstat"><span class="toc-number">2.18.</span> <span class="toc-text">系统资源统计 dstat</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BB%BC%E5%90%88%E7%9B%91%E6%8E%A7%E5%B7%A5%E5%85%B7-glances"><span class="toc-number">2.19.</span> <span class="toc-text">综合监控工具 glances</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9F%A5%E7%9C%8B%E8%BF%9B%E7%A8%8B%E6%89%93%E5%BC%80%E6%96%87%E4%BB%B6-lsof"><span class="toc-number">2.20.</span> <span class="toc-text">查看进程打开文件 lsof</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#CentOS-8-%E6%96%B0%E7%89%B9%E6%80%A7-cockpit"><span class="toc-number">2.21.</span> <span class="toc-text">CentOS 8 新特性 cockpit</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BF%A1%E5%8F%B7%E5%8F%91%E9%80%81-kill"><span class="toc-number">2.22.</span> <span class="toc-text">信号发送 kill</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BD%9C%E4%B8%9A%E7%AE%A1%E7%90%86"><span class="toc-number">2.23.</span> <span class="toc-text">作业管理</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%B9%B6%E8%A1%8C%E8%BF%90%E8%A1%8C"><span class="toc-number">2.24.</span> <span class="toc-text">并行运行</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%BB%BB%E5%8A%A1%E8%AE%A1%E5%88%92"><span class="toc-number">3.</span> <span class="toc-text">任务计划</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%80%E6%AC%A1%E6%80%A7%E4%BB%BB%E5%8A%A1"><span class="toc-number">3.1.</span> <span class="toc-text">一次性任务</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%91%A8%E6%9C%9F%E6%80%A7%E4%BB%BB%E5%8A%A1%E8%AE%A1%E5%88%92-cron"><span class="toc-number">3.2.</span> <span class="toc-text">周期性任务计划 cron</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%B3%BB%E7%BB%9Fcron%E8%AE%A1%E5%88%92%E4%BB%BB%E5%8A%A1"><span class="toc-number">3.2.1.</span> <span class="toc-text">系统cron计划任务</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%94%A8%E6%88%B7%E8%AE%A1%E5%88%92%E4%BB%BB%E5%8A%A1"><span class="toc-number">3.2.2.</span> <span class="toc-text">用户计划任务</span></a></li></ol></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2025/02/18/SRE-OpenVPN/" title="OpenVPN"><img src="/../images/image/SRE/day25/5.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="OpenVPN"/></a><div class="content"><a class="title" href="/2025/02/18/SRE-OpenVPN/" title="OpenVPN">OpenVPN</a><time datetime="2025-02-18T09:33:52.000Z" title="发表于 2025-02-18 17:33:52">2025-02-18</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2025/02/17/SRE-MySQL/" title="MySQL"><img src="/../images/title/mysql.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="MySQL"/></a><div class="content"><a class="title" href="/2025/02/17/SRE-MySQL/" title="MySQL">MySQL</a><time datetime="2025-02-17T04:27:15.000Z" title="发表于 2025-02-17 12:27:15">2025-02-17</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2024/12/08/SRE-linux%E5%91%BD%E4%BB%A4%E7%B4%A2%E5%BC%95/" title="linux命令索引"><img src="/../images/title/linux3.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="linux命令索引"/></a><div class="content"><a class="title" href="/2024/12/08/SRE-linux%E5%91%BD%E4%BB%A4%E7%B4%A2%E5%BC%95/" title="linux命令索引">linux命令索引</a><time datetime="2024-12-08T12:10:30.000Z" title="发表于 2024-12-08 20:10:30">2024-12-08</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2024/12/08/SRE-Linux%E9%98%B2%E7%81%AB%E5%A2%99/" title="Linux防火墙"><img src="/../images/image/SRE/day17/12.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Linux防火墙"/></a><div class="content"><a class="title" href="/2024/12/08/SRE-Linux%E9%98%B2%E7%81%AB%E5%A2%99/" title="Linux防火墙">Linux防火墙</a><time datetime="2024-12-08T08:10:35.000Z" title="发表于 2024-12-08 16:10:35">2024-12-08</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2023 - 2025 By ૮(˶ᵔ ᵕ ᵔ˶)ა</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div><div class="footer_custom_text"><a target="_blank" rel="noopener" href="https://beian.miit.gov.cn/#/Integrated/index"><img src="https://jihulab.com/wsq1203/images/-/raw/main/gonganbeian/icp.png" width="15" height="15">豫ICP备2023009931号</a></br><a href="http://www.beian.gov.cn/portal/registerSystemInfo?recordcode=41162702000178" target="_blank"><img src="https://jihulab.com/wsq1203/images/-/raw/main/gonganbeian/beian.png" width="15" height="15">豫公网安备 41162702000178号</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.umd.min.js"></script><script src="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.js"></script><script>function panguFn () {
  if (typeof pangu === 'object') pangu.autoSpacingPage()
  else {
    getScript('https://cdn.jsdelivr.net/npm/pangu/dist/browser/pangu.min.js')
      .then(() => {
        pangu.autoSpacingPage()
      })
  }
}

function panguInit () {
  if (true){
    GLOBAL_CONFIG_SITE.isPost && panguFn()
  } else {
    panguFn()
  }
}

document.addEventListener('DOMContentLoaded', panguInit)</script><div class="js-pjax"></div><canvas id="universe"></canvas><script src="/js/universe.js"></script><canvas class="fireworks" mobile="true"></canvas><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/fireworks.min.js"></script><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/activate-power-mode.min.js"></script><script>POWERMODE.colorful = true;
POWERMODE.shake = false;
POWERMODE.mobile = false;
document.body.addEventListener('input', POWERMODE);
</script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>