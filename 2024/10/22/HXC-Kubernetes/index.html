<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>Kubernetes | ૮(˶ᵔ ᵕ ᵔ˶)ა</title><meta name="author" content="૮(˶ᵔ ᵕ ᵔ˶)ა"><meta name="copyright" content="૮(˶ᵔ ᵕ ᵔ˶)ა"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="ffffff"><meta name="description" content="51cto 韩先超 k8s">
<meta property="og:type" content="article">
<meta property="og:title" content="Kubernetes">
<meta property="og:url" content="http://example.com/2024/10/22/HXC-Kubernetes/index.html">
<meta property="og:site_name" content="૮(˶ᵔ ᵕ ᵔ˶)ა">
<meta property="og:description" content="51cto 韩先超 k8s">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://example.com/images/title/k8s1.png">
<meta property="article:published_time" content="2024-10-21T16:00:00.000Z">
<meta property="article:modified_time" content="2024-11-08T11:57:09.692Z">
<meta property="article:author" content="૮(˶ᵔ ᵕ ᵔ˶)ა">
<meta property="article:tag" content="Kubernetes">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://example.com/images/title/k8s1.png"><link rel="shortcut icon" href="/../images/title/user.webp"><link rel="canonical" href="http://example.com/2024/10/22/HXC-Kubernetes/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//fonts.googleapis.com" crossorigin=""/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Titillium+Web&amp;display=swap" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":false,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: true,
    post: true
  },
  runtime: '天',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: {"chs_to_cht":"你已切换为繁体","cht_to_chs":"你已切换为简体","day_to_night":"你已切换为深色模式","night_to_day":"你已切换为浅色模式","bgLight":"#49b1f5","bgDark":"#1f1f1f","position":"top-center"},
  source: {
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: true,
  }
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'Kubernetes',
  isPost: true,
  isHome: false,
  isHighlightShrink: undefined,
  isToc: true,
  postUpdate: '2024-11-08 19:57:09'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
    win.getCSS = (url,id = false) => new Promise((resolve, reject) => {
      const link = document.createElement('link')
      link.rel = 'stylesheet'
      link.href = url
      if (id) link.id = id
      link.onerror = reject
      link.onload = link.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        link.onload = link.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(link)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', 'ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><link rel="stylesheet" href="/css/custom.css"  media="defer" onload="this.media='all'"><meta name="generator" content="Hexo 5.4.2"></head><body><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="/../images/title/user.webp" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">87</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">29</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">4</div></a></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间线</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('/../images/title/k8s1.png')"><nav id="nav"><span id="blog-info"><a href="/" title="૮(˶ᵔ ᵕ ᵔ˶)ა"><span class="site-name">૮(˶ᵔ ᵕ ᵔ˶)ა</span></a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间线</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">Kubernetes</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2024-10-21T16:00:00.000Z" title="发表于 2024-10-22 00:00:00">2024-10-22</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2024-11-08T11:57:09.692Z" title="更新于 2024-11-08 19:57:09">2024-11-08</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E5%AE%9D%E5%89%91%E9%94%8B%E4%BB%8E%E7%A3%A8%E7%A0%BA%E5%87%BA/">宝剑锋从磨砺出</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">字数总计:</span><span class="word-count">69.2k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>305分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="Kubernetes"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="Kubernetes简介"><a href="#Kubernetes简介" class="headerlink" title="Kubernetes简介"></a>Kubernetes简介</h1><blockquote>
<p>kubernetes是可移植、可扩展、开源的容器管理平台，是谷歌Borg的开源版本，简称k8s，它可以创建应用、更新应用、回滚应用，也可实现应用的扩容缩容，做到<code>故障自恢复</code>。</p>
</blockquote>
<ul>
<li>可移植：基于镜像可从一个环境迁移到另一个环境</li>
<li>可扩展：k8s集群可以横向扩展、根据流量实现自动扩缩容</li>
<li>开源的：源代码已经公开了，可以被用户免费使用，可以二次开发</li>
<li>可以对容器自动化部署、自动化扩缩容、跨主机管理等；</li>
<li>可以对代码进行灰度发布、金丝雀发布、蓝绿发布、滚动更新等；</li>
<li>具有完整的监控系统和日志收集平台，具有故障自恢复的能力。</li>
</ul>
<h2 id="kubernetes起源"><a href="#kubernetes起源" class="headerlink" title="kubernetes起源"></a>kubernetes起源</h2><ul>
<li><p>Kubernetes单词起源于希腊语，是“舵手”或者“领航员、飞行员”的意思。</p>
</li>
<li><p>来源于Google的 Borg项目</p>
</li>
</ul>
<blockquote>
<p>Borg是谷歌内部的一个容器编排工具，谷歌业务90%以上都在Borg上运行，Borg在谷歌内部已经使用了大概15年。 K8S是在Borg的基础上开发出来的轻量级容器编排工具。K8S的根基非常牢固，得益于Borg过去十数年间积累的经验和教训，是站在巨人的肩膀上发展起来的项目。开源之后，迅速称霸容器编排技术领域。</p>
</blockquote>
<p><strong>Google Borg架构</strong></p>
<ul>
<li><p>Borg是谷歌内部的容器管理平台，谷歌90%以上的业务都在Borg上运行，目前Borg在谷歌内部已经运行了10年之久。</p>
</li>
<li><p>Borg是谷歌内部使用的，k8s是在Borg基础上开发的，开源的，用户可以免费使用的</p>
</li>
</ul>
<p><img src="../../../../images/image/k8s-han/1.png" alt="1"></p>
<h2 id="Kubernetes架构"><a href="#Kubernetes架构" class="headerlink" title="Kubernetes架构"></a>Kubernetes架构</h2><ul>
<li>k8s的物理架构是master/node模式：</li>
<li>K8S集群至少需要一个主节点(Master)和多个工作节点(Worker)，Master节点是集群的控制节点，负责整个集群的管理和控制，主要用于暴露API、调度部署和对节点进行管理。工作节点主要是运行容器的。</li>
</ul>
<blockquote>
<p>单master节点架构图</p>
</blockquote>
<p><img src="../../../../images/image/k8s-han/2.png" alt="2"></p>
<blockquote>
<p>多master节点架构图</p>
</blockquote>
<p><img src="../../../../images/image/k8s-han/3.png" alt="3"></p>
<h2 id="Kubernetes组件"><a href="#Kubernetes组件" class="headerlink" title="Kubernetes组件"></a>Kubernetes组件</h2><h3 id="Master-node"><a href="#Master-node" class="headerlink" title="Master node"></a>Master node</h3><ul>
<li>apiserver</li>
<li>scheduler</li>
<li>controller-manager</li>
<li>Etcd</li>
<li>calico</li>
<li>docker</li>
</ul>
<h3 id="Work-node"><a href="#Work-node" class="headerlink" title="Work node"></a>Work node</h3><ul>
<li>kubelet</li>
<li>kube-proxy</li>
<li>Calico</li>
<li>Coredns</li>
<li>docker</li>
</ul>
<p><img src="../../../../images/image/k8s-han/4.png" alt="4"></p>
<h3 id="各组件解析"><a href="#各组件解析" class="headerlink" title="各组件解析"></a>各组件解析</h3><blockquote>
<p>kubectl</p>
</blockquote>
<ul>
<li>管理k8s的命令行工具，可以操作k8s中的资源对象，如增删改查等。</li>
</ul>
<blockquote>
<p>etcd</p>
</blockquote>
<ul>
<li> 是一个高可用的键值数据库，存储k8s的资源状态信息和网络信息的，etcd中的数据变更是通过api server进行的。</li>
</ul>
<blockquote>
<p>apiserver</p>
</blockquote>
<ul>
<li>提供k8s api，是整个系统的对外接口，提供资源操作的唯一入口，供客户端和其它组件调用，提供了k8s各类资源对象（pod，deployment，Service等）的增删改查，是整个系统的数据总线和数据中心，并提供认证、授权、访问控制、API注册和发现等机制，并将操作对象持久化到etcd中。</li>
</ul>
<blockquote>
<p>scheduler</p>
</blockquote>
<ul>
<li>负责k8s集群中pod的调度的 ， scheduler通过与apiserver交互监听到创建Pod副本的信息后，它会检索所有符合该Pod要求的工作节点列表，开始执行Pod调度逻辑。调度成功后将Pod绑定到目标节点上，相当于“调度室”。</li>
</ul>
<blockquote>
<p>Controller-Manager</p>
</blockquote>
<ul>
<li>作为集群内部的管理控制中心，负责集群内的Node、Pod副本、服务端点（Endpoint）、命名空间（Namespace）、服务账号（ServiceAccount）、资源定额（ResourceQuota）的管理，当某个Node意外宕机时，Controller Manager会及时发现并执行自动化修复流程，确保集群始终处于预期的工作状态。</li>
</ul>
<p><img src="../../../../images/image/k8s-han/5.png" alt="5"></p>
<ul>
<li>每个Controller通过API Server提供的接口实时监控整个集群的每个资源对象的当前状态，当发生各种故障导致系统状态发生变化时，会尝试将系统状态修复到“期望状态”。</li>
</ul>
<blockquote>
<p>kubelet</p>
</blockquote>
<ul>
<li>每个Node节点上的kubelet定期就会调用API Server的REST接口报告自身状态，API Server接收这些信息后，将节点状态信息更新到etcd中。kubelet也通过API Server监听Pod信息，从而对Node机器上的POD进行管理，如创建、删除、更新Pod</li>
</ul>
<blockquote>
<p>kube-proxy</p>
</blockquote>
<ul>
<li>提供网络代理和负载均衡，是实现service的通信与负载均衡机制的重要组件，kube-proxy负责为Pod创建代理服务，从apiserver获取所有service信息，并根据service信息创建代理服务，实现service到Pod的请求路由和转发，从而实现K8s层级的虚拟转发网络，将到service的请求转发到后端的pod上。 </li>
</ul>
<blockquote>
<p>Cordns</p>
</blockquote>
<ul>
<li>CoreDNS 其实就是一个 DNS 服务，而 DNS 作为一种常见的服务发现手段，很多开源项目以及工程师都会使用 CoreDNS 为集群提供服务发现的功能，Kubernetes 就在集群中使用 CoreDNS 解决服务发现的问题。</li>
</ul>
<blockquote>
<p>Calico</p>
</blockquote>
<ul>
<li>是一套开源的网络和网络安全方案，用于容器、虚拟机、宿主机之前的网络连接，可以用在kubernetes、OpenShift、DockerEE、OpenStrack等PaaS或IaaS平台上。 </li>
</ul>
<blockquote>
<p>Docker</p>
</blockquote>
<ul>
<li>容器运行时，负责启动容器的，在k8s1.20版本之后建议废弃docker，使用container作为容器运行时</li>
</ul>
<h2 id="Kubernetes核心资源解读"><a href="#Kubernetes核心资源解读" class="headerlink" title="Kubernetes核心资源解读"></a>Kubernetes核心资源解读</h2><h3 id="Pod"><a href="#Pod" class="headerlink" title="Pod"></a>Pod</h3><ul>
<li>Pod是Kubernetes中的最小调度单元，k8s是通过定义一个Pod的资源，然后在Pod里面运行容器，容器需要指定镜像，用来运行具体的服务。</li>
<li>Pod代表集群上正在运行的一个进程，一个Pod封装一个容器（也可以封装多个容器），Pod里的容器共享存储、网络等。</li>
<li>也就是说，应该把整个pod看作虚拟机，然后每个容器相当于运行在虚拟机的进程。</li>
</ul>
<blockquote>
<p>可以把pod看成是一个“豌豆荚”，里面有很多“豆子”（容器）。一个豌豆荚里的豆子，它们吸收着共同的营养成分、肥料、水分等，Pod和容器的关系也是一样，Pod里面的容器共享pod的网络、存储等。</p>
</blockquote>
<ul>
<li>在K8s中，所有的资源都可以使用一个yaml配置文件来创建，创建Pod也可以使用yaml配置文件</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">~]#</span> <span class="string">cat</span> <span class="string">pod.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">tomcat-pod</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">tomcat:</span>  <span class="string">tomcat-pod</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span>  <span class="string">tomcat-pod-java</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">8080</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">tomcat:8.5-jre8-alpine</span></span><br><span class="line">  <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="string">~]#</span> <span class="string">kubectl</span> <span class="string">apply</span> <span class="string">-f</span> <span class="string">pod.yaml</span></span><br><span class="line"></span><br><span class="line"><span class="string">~]#</span> <span class="string">kubectl</span> <span class="string">get</span> <span class="string">pods</span> <span class="string">-l</span> <span class="string">tomcat=tomcat-pod</span></span><br><span class="line"><span class="string">NAME</span>		<span class="string">READY</span>		<span class="string">STATUS</span>		<span class="string">RESTARTS</span>	<span class="string">AGE</span></span><br><span class="line"><span class="string">tomcat-pod</span>	<span class="number">1</span><span class="string">/1</span>			<span class="string">Running</span>		<span class="number">0</span>			<span class="string">9s</span></span><br></pre></td></tr></table></figure>

<h3 id="label"><a href="#label" class="headerlink" title="label"></a>label</h3><ul>
<li>label是标签的意思，k8s中的资源对象大都可以打上标签，如Node、Pod、Service 等，一个资源可以绑定任意多个label，k8s 通过 Label 可实现多维度的资源分组管理，后续可通过 Label Selector 查询和筛选拥有某些 Label 的资源对象</li>
<li>例如创建一个 Pod，给定一个 Label是app=tomcat，那么service可以通过label selector选择拥有app=tomcat的pod，和其相关联，也可通过 app=tomcat 删除拥有该标签的 Pod 资源</li>
</ul>
<p><img src="../../../../images/image/k8s-han/6.png" alt="6"></p>
<h3 id="Deployment"><a href="#Deployment" class="headerlink" title="Deployment"></a>Deployment</h3><ul>
<li>Replicaset是Kubernetes中的副本控制器，管理Pod，使pod副本的数量始终维持在预设的个数。</li>
<li>Deployment是管理Replicaset和Pod的副本控制器，Deployment可以管理多个Replicaset，是比Replicaset更高级的控制器</li>
<li>也即是说在创建Deployment的时候，会自动创建Replicaset，由Replicaset再创建Pod，Deployment能对Pod扩容、缩容、滚动更新和回滚、维持Pod数量。</li>
</ul>
<p><img src="../../../../images/image/k8s-han/7.png" alt="7"></p>
<ul>
<li>创建Deployment也可以使用yaml配置文件</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">~]#</span> <span class="string">cat</span> <span class="string">deployment.yaml</span></span><br><span class="line"></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">my-nginx</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">run:</span> <span class="string">my-nginx</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">2</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">run:</span> <span class="string">my-nginx</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">my-nginx</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">nginx</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">80</span></span><br><span class="line"></span><br><span class="line"><span class="string">~]#</span> <span class="string">kubectl</span> <span class="string">apply</span> <span class="string">-f</span> <span class="string">deployment.yaml</span></span><br><span class="line"></span><br><span class="line"><span class="string">~]#</span> <span class="string">kubectl</span> <span class="string">get</span> <span class="string">deploy</span> <span class="string">|</span> <span class="string">grep</span> <span class="string">my-nginx</span></span><br><span class="line"><span class="string">my-nginx</span>         <span class="number">2</span><span class="string">/2</span>     <span class="number">2</span>            <span class="number">2</span>           <span class="string">2m52s</span></span><br><span class="line"></span><br><span class="line"><span class="string">~]#</span> <span class="string">kubectl</span> <span class="string">get</span> <span class="string">rs</span> <span class="string">|</span> <span class="string">grep</span> <span class="string">my-nginx</span></span><br><span class="line"><span class="string">my-nginx-5b56ccd65f</span>         <span class="number">2</span>         <span class="number">2</span>         <span class="number">2</span>       <span class="string">3m26s</span></span><br><span class="line"></span><br><span class="line"><span class="string">~]#</span> <span class="string">kubectl</span> <span class="string">get</span> <span class="string">pods</span> <span class="string">-l</span> <span class="string">run=my-nginx</span></span><br><span class="line"><span class="string">NAME</span>						<span class="string">READY</span>	<span class="string">STATUS</span>		<span class="string">RESTARTS</span>	<span class="string">AGE</span></span><br><span class="line"><span class="string">my-nginx-5b56ccd65f-29w6d</span>	<span class="number">1</span><span class="string">/1</span>		<span class="string">Running</span>		<span class="number">0</span>			<span class="string">102s</span></span><br><span class="line"><span class="string">my-nginx-5b56ccd65f-8dblk</span>	<span class="number">1</span><span class="string">/1</span>		<span class="string">Running</span>		<span class="number">0</span>			<span class="string">102s</span></span><br></pre></td></tr></table></figure>

<h3 id="Service"><a href="#Service" class="headerlink" title="Service"></a>Service</h3><ul>
<li>在kubernetes中，Pod是有生命周期的，如果Pod重启IP很有可能会发生变化。如果我们的服务都是将Pod的IP地址写死，Pod的挂掉或者重启，和刚才重启的pod相关联的其他服务将会找不到它所关联的Pod</li>
<li>为了解决这个问题，在kubernetes中定义了service资源对象，Service 定义了一个服务访问的入口，客户端通过这个入口即可访问服务背后的应用集群实例，service是一组Pod的逻辑集合，这一组 Pod 能够被 Service 访问到，通常是通过 Label Selector实现的。</li>
</ul>
<p><img src="../../../../images/image/k8s-han/8.png" alt="8"></p>
<ul>
<li>创建service资源</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建一个pod</span></span><br><span class="line"><span class="string">~]#</span> <span class="string">cat</span> <span class="string">pod_test.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">my-nginx</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">run:</span> <span class="string">my-nginx</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">2</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">run:</span> <span class="string">my-nginx</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">my-nginx</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">nginx</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">80</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建一个service</span></span><br><span class="line"><span class="string">~]#</span> <span class="string">cat</span> <span class="string">service.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">my-nginx</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">run:</span> <span class="string">my-nginx</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">    <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line"><span class="attr">run:</span> <span class="string">my-nginx</span></span><br><span class="line"></span><br><span class="line"><span class="string">~]#</span> <span class="string">kubectl</span> <span class="string">apply</span> <span class="string">-f</span> <span class="string">service.yaml</span></span><br><span class="line"></span><br><span class="line"><span class="string">~]#</span> <span class="string">kubectl</span> <span class="string">get</span> <span class="string">svc</span> <span class="string">-l</span> <span class="string">run=my-nginx</span></span><br><span class="line"><span class="string">NAME</span>		<span class="string">TYPE</span>		<span class="string">CLUSTER-IP</span>		<span class="string">EXTERNAL-IP</span>	<span class="string">PORT(S)</span>	<span class="string">AGE</span></span><br><span class="line"><span class="string">my-nginx</span>	<span class="string">ClusterIP</span>	<span class="number">10.105</span><span class="number">.104</span><span class="number">.137</span>	<span class="string">&lt;none&gt;</span>		<span class="number">80</span><span class="string">/TCP</span>	<span class="string">12s</span></span><br><span class="line"></span><br><span class="line"><span class="string">~]#</span> <span class="string">curl</span> <span class="number">10.105</span><span class="number">.104</span><span class="number">.137</span></span><br></pre></td></tr></table></figure>

<h1 id="kubeadm安装高可用的k8s集群"><a href="#kubeadm安装高可用的k8s集群" class="headerlink" title="kubeadm安装高可用的k8s集群"></a>kubeadm安装高可用的k8s集群</h1><h2 id="k8s环境规划"><a href="#k8s环境规划" class="headerlink" title="k8s环境规划"></a>k8s环境规划</h2><blockquote>
<p>centos7.6操作系统，4G/6CPU/100G，网络NAT，开启虚拟化</p>
<p>podSubnet(pod网段)10.244.0.0/16<br>serviceSubnet(service网段)10.10.0.0/16</p>
</blockquote>
<table>
<thead>
<tr>
<th>k8s集群角色</th>
<th>ip</th>
<th>主机名</th>
<th>安装的组件</th>
</tr>
</thead>
<tbody><tr>
<td>控制节点</td>
<td>192.168.1.180</td>
<td>master1</td>
<td>apiserver、controller-manager、scheduler、kubelet、etcd、docker、kube-proxy、keepalived、nginx、calico</td>
</tr>
<tr>
<td>控制节点</td>
<td>192.168.1.181</td>
<td>master2</td>
<td>apiserver、controller-manager、scheduler、kubelet、etcd、docker、kube-proxy、keepalived、nginx、calico</td>
</tr>
<tr>
<td>工作节点</td>
<td>192.168.1.182</td>
<td>node1</td>
<td>kubelet、kube-proxy、docker、calico、coredns</td>
</tr>
<tr>
<td>VIP</td>
<td>192.168.1.199</td>
<td></td>
<td></td>
</tr>
</tbody></table>
<blockquote>
<p>kubeadm 和二进制安装 k8s 适用场景分析</p>
<p> Kubeadm 和二进制都适合生产环境，在生产环境运行都很稳定，具体如何选择，可以根据实际项目进行评估。</p>
</blockquote>
<ul>
<li><p>kubeadm 是官方提供的开源工具，是一个开源项目，用于快速搭建 kubernetes 集群，目前是比较方便和推荐使用的。</p>
</li>
<li><p>kubeadm init 以及 kubeadm join 这两个命令可以快速创建 kubernetes 集群。</p>
</li>
<li><p>Kubeadm 初始化 k8s，所有的组件都是以 pod 形式运行的，具备故障自恢复能力</p>
</li>
<li><p>kubeadm 是工具，可以快速搭建集群，也就是相当于用程序脚本帮我们装好了集群，属于自动部署，简化部署操作，自动部署屏蔽了很多细节，使得对各个模块感知很少，如果对 k8s 架构组件理解不深的话，遇到问题比较难排查</p>
</li>
<li><p>kubeadm 适合需要经常部署 k8s，或者对自动化要求比较高的场景下使用。</p>
</li>
</ul>
<ul>
<li>二进制：在官网下载相关组件的二进制包，如果手动安装，对 kubernetes 理解也会更全面。</li>
</ul>
<h2 id="初始化实验环境"><a href="#初始化实验环境" class="headerlink" title="初始化实验环境"></a>初始化实验环境</h2><blockquote>
<p>所有节点做相同操作</p>
</blockquote>
<ul>
<li>修改主机IP</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/sysconfig/network-scripts/ifcfg-ens33 </span><br><span class="line">TYPE=Ethernet  </span><br><span class="line">BOOTPROTO=static # static 表示静态 ip 地址</span><br><span class="line">IPADDR=192.168.1.180 # ip 地址，需要跟自己电脑所在网段一致</span><br><span class="line">NETMASK=255.255.255.0 # 子网掩码，需要跟自己电脑所在网段一致</span><br><span class="line">GATEWAY=192.168.1.2 # 网关，在自己电脑打开 cmd，输入 ipconfig /all 可看到</span><br><span class="line">DNS1=223.5.5.5	# DNS，在自己电脑打开 cmd，输入 ipconfig /all 可看到</span><br><span class="line">NAME=ens33 # 网卡名字，跟 DEVICE 名字保持一致即可</span><br><span class="line">DEVICE=ens33 # 网卡设备名，ip addr 可看到自己的这个网卡设备名</span><br><span class="line">ONBOOT=yes	# 开机自启动网络，必须是 yes</span><br><span class="line"></span><br><span class="line">service network restart</span><br></pre></td></tr></table></figure>

<ul>
<li>配置主机名，配置hosts解析</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">在 192.168.1.180 上执行</span></span><br><span class="line">hostnamectl set-hostname master1 &amp;&amp; bash </span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">在 192.168.40.181 上执行</span> </span><br><span class="line">hostnamectl set-hostname master2 &amp;&amp; bash </span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">在 192.168.40.182 上执行</span></span><br><span class="line">hostnamectl set-hostname node1 &amp;&amp; bash </span><br><span class="line"><span class="meta prompt_"> </span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">配置主机 hosts 文件</span></span><br><span class="line">192.168.1.180 master1 </span><br><span class="line">192.168.1.181 master2 </span><br><span class="line">192.168.1.182 node1</span><br></pre></td></tr></table></figure>

<ul>
<li>配置主机间无密码登录</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">ssh-keygen</span><br><span class="line"></span><br><span class="line">for i in master1 master2 node1</span><br><span class="line">do</span><br><span class="line">    ssh-copy-id root@$i</span><br><span class="line">done</span><br></pre></td></tr></table></figure>

<ul>
<li>关闭交换分区，提升性能</li>
</ul>
<blockquote>
<p>为什么要关闭 swap 交换分区？</p>
</blockquote>
<blockquote>
<p>Swap 是交换分区，如果机器内存不够，会使用 swap 分区，但是 swap 分区的性能较低，k8s 设计的时候为了能提升性能，默认是不允许使用交换分区的。Kubeadm 初始化的时候会检测 swap 是否关闭，如果没关闭，那就初始化失败。如果不想要关闭交换分区，安装 k8s 的时候可以指定–ignore-preflight-errors=Swap 来解决。</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">临时关闭</span></span><br><span class="line">swapoff -a </span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">永久关闭：注释 swap 挂载，给 swap 这行开头加一下注释</span></span><br><span class="line">vim /etc/fstab </span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">/dev/mapper/centos-swap swap swap defaults 0 0</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">如果是克隆的虚拟机，需要删除 UUID</span></span><br></pre></td></tr></table></figure>

<ul>
<li>修改机器内核参数</li>
</ul>
<blockquote>
<p>问题 1：sysctl 是做什么的？</p>
</blockquote>
<blockquote>
<p>在运行时配置内核参数<br> -p 从指定的文件加载系统参数，如不指定即从/etc/sysctl.conf 中加载</p>
</blockquote>
<hr>
<blockquote>
<p>问题 2：为什么要执行 modprobe br_netfilter？</p>
</blockquote>
<blockquote>
<p>修改/etc/sysctl.d/k8s.conf 文件，增加如下三行参数：<br>net.bridge.bridge-nf-call-ip6tables = 1<br>net.bridge.bridge-nf-call-iptables = 1<br>net.ipv4.ip_forward = 1<br>sysctl -p /etc/sysctl.d/k8s.conf 出现报错：<br>sysctl: cannot stat /proc/sys/net/bridge/bridge-nf-call-ip6tables: No such file or directory<br>sysctl: cannot stat /proc/sys/net/bridge/bridge-nf-call-iptables: No such file or directory</p>
<p>解决方法：<br>modprobe br_netfilter</p>
</blockquote>
<hr>
<blockquote>
<p>问题 3：为什么开启 net.bridge.bridge-nf-call-iptables 内核参数？</p>
</blockquote>
<blockquote>
<p>在 centos 下安装 docker，执行 docker info 出现如下警告：<br>WARNING: bridge-nf-call-iptables is disabled<br>WARNING: bridge-nf-call-ip6tables is disabled</p>
<p>解决办法：<br>vim /etc/sysctl.d/k8s.conf<br>net.bridge.bridge-nf-call-ip6tables = 1<br>net.bridge.bridge-nf-call-iptables = 1</p>
</blockquote>
<hr>
<blockquote>
<p>问题 4：为什么要开启 net.ipv4.ip_forward = 1 参数？</p>
</blockquote>
<blockquote>
<p>kubeadm 初始化 k8s 如果报错：<br>[ERROR FileContent–proc-sys-net-ipv4-ip_forward]: /proc/sys/net/ipv4/ip_forward contents are not set to 1<br>就表示没有开启 ip_forward，需要开启。</p>
</blockquote>
<blockquote>
<p>net.ipv4.ip_forward 是数据包转发：<br>出于安全考虑，Linux 系统默认是禁止数据包转发的。所谓转发即当主机拥有多于一块的网卡时，其中一块收到数据包，根据数据包的目的 ip 地址将数据包发往本机另一块网卡，该网卡根据路由表继续发送数据包。这通常是路由器所要实现的功能。<br>要让 Linux 系统具有路由转发功能，需要配置一个 Linux 的内核参数 net.ipv4.ip_forward。这个参数指定了 Linux 系统当前对路由转发功能的支持情况；其值为 0 时表示禁止进行 IP 转发；如果是 1，则说明 IP 转发功能已经打开。</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">modprobe br_netfilter </span><br><span class="line">echo &quot;modprobe br_netfilter&quot; &gt;&gt; /etc/profile </span><br><span class="line"></span><br><span class="line">cat &gt; /etc/sysctl.d/k8s.conf &lt;&lt;EOF </span><br><span class="line">net.bridge.bridge-nf-call-ip6tables = 1 </span><br><span class="line">net.bridge.bridge-nf-call-iptables = 1 </span><br><span class="line">net.ipv4.ip_forward = 1 </span><br><span class="line">EOF </span><br><span class="line"></span><br><span class="line">sysctl -p /etc/sysctl.d/k8s.conf</span><br></pre></td></tr></table></figure>

<ul>
<li>关闭firewalld防火墙</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">systemctl stop firewalld</span><br><span class="line">systemctl disable firewalld</span><br><span class="line">systemctl status firewalld</span><br></pre></td></tr></table></figure>

<ul>
<li>关闭selinux</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">修改 selinux 配置文件之后，重启机器，selinux 配置才能永久生效</span></span><br><span class="line">sed -i &#x27;s/SELINUX=enforcing/SELINUX=disabled/g&#x27; /etc/selinux/config</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">重启</span></span><br><span class="line">reboot</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">临时关闭</span></span><br><span class="line">setenforce 0</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">显示 Disabled 说明 selinux 已经关闭</span></span><br><span class="line">getenforce </span><br><span class="line">Disabled </span><br></pre></td></tr></table></figure>

<ul>
<li>配置阿里云repo源</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">备份基础repo源</span></span><br><span class="line">mkdir /root/repo.bak </span><br><span class="line">cd /etc/yum.repos.d/ </span><br><span class="line">mv * /root/repo.bak/</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">拉取阿里云repo源</span></span><br><span class="line">curl -o /etc/yum.repos.d/CentOS-Base.repo https://mirrors.aliyun.com/repo/Centos-7.repo</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">配置国内阿里云 docker 的 repo 源</span> </span><br><span class="line">yum install yum-utils -y</span><br><span class="line"></span><br><span class="line">yum-config-manager --add-repo http://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">配置安装 k8s 组件需要的阿里云的 repo 源</span></span><br><span class="line">vim /etc/yum.repos.d/kubernetes.repo </span><br><span class="line">[kubernetes] </span><br><span class="line">name=Kubernetes </span><br><span class="line">baseurl=https://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64/ </span><br><span class="line">enabled=1 </span><br><span class="line">gpgcheck=0</span><br></pre></td></tr></table></figure>

<ul>
<li>配置时间同步</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">安装 ntpdate 命令</span></span><br><span class="line">yum install ntpdate -y</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">跟网络时间做同步</span></span><br><span class="line">ntpdate cn.pool.ntp.org </span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">把时间同步做成计划任务</span></span><br><span class="line">crontab -e </span><br><span class="line">* */1 * * * /usr/sbin/ntpdate cn.pool.ntp.org</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">重启 crond 服务</span></span><br><span class="line">service crond restart</span><br></pre></td></tr></table></figure>

<ul>
<li>开启 ipvs</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">编写脚本开启模块</span></span><br><span class="line">vim /etc/sysconfig/modules/ipvs.modules</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/bash</span></span><br><span class="line">ipvs_modules=&quot;ip_vs ip_vs_lc ip_vs_wlc ip_vs_rr ip_vs_wrr ip_vs_lblc ip_vs_lblcr ip_vs_dh ip_vs_sh ip_vs_nq ip_vs_sed ip_vs_ftp nf_conntrack&quot;</span><br><span class="line">for kernel_module in $&#123;ipvs_modules&#125;; do</span><br><span class="line"> /sbin/modinfo -F filename $&#123;kernel_module&#125; &gt; /dev/null 2&gt;&amp;1</span><br><span class="line"> if [ 0 -eq 0 ]; then</span><br><span class="line"> /sbin/modprobe $&#123;kernel_module&#125;</span><br><span class="line"> fi</span><br><span class="line">done</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">执行脚本，查看模块是否开启</span></span><br><span class="line">chmod 755 /etc/sysconfig/modules/ipvs.modules &amp;&amp; bash /etc/sysconfig/modules/ipvs.modules &amp;&amp; lsmod | grep ip_vs</span><br><span class="line"></span><br><span class="line">ip_vs_ftp 13079 0 </span><br><span class="line">nf_nat 26583 1 ip_vs_ftp </span><br><span class="line">ip_vs_sed 12519 0 </span><br><span class="line">ip_vs_nq 12516 0 </span><br><span class="line">ip_vs_sh 12688 0 </span><br><span class="line">ip_vs_dh 12688 0</span><br></pre></td></tr></table></figure>

<blockquote>
<p>问题 1：ipvs 是什么？</p>
</blockquote>
<blockquote>
<p>ipvs (IP Virtual Server) 实现了传输层负载均衡，也就是我们常说的 4 层 LAN 交换，作为 Linux内核的一部分。ipvs 运行在主机上，在真实服务器集群前充当负载均衡器。ipvs 可以将基于 TCP 和 UDP的服务请求转发到真实服务器上，并使真实服务器的服务在单个 IP 地址上显示为虚拟服务。</p>
</blockquote>
<hr>
<blockquote>
<p>问题 2：ipvs 和 iptable 对比分析</p>
</blockquote>
<blockquote>
<p>kube-proxy 支持 iptables 和 ipvs 两种模式， 在 kubernetes v1.8 中引入了 ipvs 模式，在v1.9 中处于 beta 阶段，在 v1.11 中已经正式可用了。iptables 模式在 v1.1 中就添加支持了，从v1.2 版本开始 iptables 就是 kube-proxy 默认的操作模式，ipvs 和 iptables 都是基于 netfilter的，但是 ipvs 采用的是 hash 表，因此当 service 数量达到一定规模时，hash 查表的速度优势就会显现出来，从而提高 service 的服务性能。那么 ipvs 模式和 iptables 模式之间有哪些差异呢？</p>
<p>1、ipvs 为大型集群提供了更好的可扩展性和性能<br>2、ipvs 支持比 iptables 更复杂的复制均衡算法（最小负载、最少连接、加权等等）<br>3、ipvs 支持服务器健康检查和连接重试等功能</p>
</blockquote>
<hr>
<ul>
<li>安装基础软件包</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install -y yum-utils device-mapper-persistent-data lvm2 wget net-tools nfs-utils lrzsz gcc gcc-c++ make cmake libxml2-devel openssl-devel curl curl-devel unzip sudo ntp libaio-devel wget vim ncurses-devel autoconf automake zlib-devel python-devel epel-release openssh-server socat ipvsadm conntrack ntpdate telnet</span><br></pre></td></tr></table></figure>

<ul>
<li>安装 iptables</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">如果用 firewalld 不习惯，可以安装 iptables</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">安装 iptables</span></span><br><span class="line">yum install iptables-services -y</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">禁用 iptables</span></span><br><span class="line">service iptables stop &amp;&amp; systemctl disable iptables</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">清空防火墙规则</span></span><br><span class="line">iptables -F</span><br></pre></td></tr></table></figure>

<h2 id="安装docker"><a href="#安装docker" class="headerlink" title="安装docker"></a>安装docker</h2><blockquote>
<p>所有节点做相同操作</p>
</blockquote>
<ul>
<li>安装docker-ce</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">yum install docker-ce-20.10.6 docker-ce-cli-20.10.6 containerd.io -y</span><br><span class="line"> </span><br><span class="line">systemctl start docker &amp;&amp; systemctl enable docker &amp;&amp; systemctl status docker</span><br></pre></td></tr></table></figure>

<ul>
<li>配置 docker 镜像加速器和驱动</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/docker/daemon.json </span><br><span class="line">&#123; </span><br><span class="line"> &quot;registry-mirrors&quot;:[&quot;https://rsbud4vc.mirror.aliyuncs.com&quot;,&quot;https://registry.docker-cn.com&quot;,&quot;https://docker.mirrors.ustc.edu.cn&quot;,&quot;https://dockerhub.azk8s.cn&quot;,&quot;http://hub-mirror.c.163.com&quot;,&quot;http://qtid6917.mirror.aliyuncs.com&quot;,&quot;https://rncxm540.mirror.aliyuncs.com&quot;], </span><br><span class="line"> &quot;exec-opts&quot;: [&quot;native.cgroupdriver=systemd&quot;] </span><br><span class="line"><span class="meta prompt_">  # </span><span class="language-bash"><span class="string">&quot;insecure-registries&quot;</span>: [<span class="string">&quot;192.168.1.100&quot;</span>]</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">修改 docker 文件驱动为 systemd，默认为 cgroupfs，kubelet 默认使用 systemd，两者必须一致才可以。</span></span><br><span class="line"></span><br><span class="line">systemctl daemon-reload &amp;&amp; systemctl restart docker </span><br><span class="line">systemctl status docker</span><br></pre></td></tr></table></figure>

<h2 id="安装初始化-k8s-需要的软件包"><a href="#安装初始化-k8s-需要的软件包" class="headerlink" title="安装初始化 k8s 需要的软件包"></a>安装初始化 k8s 需要的软件包</h2><blockquote>
<p>所有节点做相同操作</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">yum install -y kubelet-1.20.6 kubeadm-1.20.6 kubectl-1.20.6</span><br><span class="line"></span><br><span class="line">systemctl enable kubelet &amp;&amp; systemctl start kubelet</span><br><span class="line"><span class="meta prompt_"> </span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">可以看到 kubelet 状态不是 running 状态，这个是正常的，不用管，等 k8s 组件起来这个kubelet 就正常了。</span></span><br><span class="line">systemctl status kubelet</span><br><span class="line"></span><br><span class="line">● kubelet.service - kubelet: The Kubernetes Node Agent</span><br><span class="line">   Loaded: loaded (/usr/lib/systemd/system/kubelet.service; enabled; vendor preset: disabled)</span><br><span class="line">  Drop-In: /usr/lib/systemd/system/kubelet.service.d</span><br><span class="line">           └─10-kubeadm.conf</span><br><span class="line">   Active: activating (auto-restart) (Result: exit-code) since 日 2023-07-16 12:16:23 CST; 9s ago</span><br><span class="line">     Docs: https://kubernetes.io/docs/</span><br><span class="line">  Process: 13693 ExecStart=/usr/bin/kubelet $KUBELET_KUBECONFIG_ARGS $KUBELET_CONFIG_ARGS $KUBELET_KUBEADM_ARGS $KUBELET_EXTRA_ARGS (code=exited, status=255)</span><br><span class="line"> Main PID: 13693 (code=exited, status=255)</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">注：每个软件包的作用</span> </span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Kubeadm: kubeadm 是一个工具，用来初始化 k8s 集群的</span> </span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">kubelet: 安装在集群所有节点上，用于启动 Pod 的</span> </span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">kubectl: 通过 kubectl 可以部署和管理应用，查看各种资源，创建、删除和更新各种组件</span></span><br></pre></td></tr></table></figure>

<h2 id="通过-keepalive-nginx-实现-k8s-apiserver-节点高可用"><a href="#通过-keepalive-nginx-实现-k8s-apiserver-节点高可用" class="headerlink" title="通过 keepalive+nginx 实现 k8s apiserver 节点高可用"></a>通过 keepalive+nginx 实现 k8s apiserver 节点高可用</h2><blockquote>
<p>在master1和master2上操作</p>
</blockquote>
<ul>
<li>安装 nginx主备</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">在 master1 和 master2 上做 nginx 主备安装</span></span><br><span class="line">yum install nginx keepalived nginx-mod-stream -y</span><br></pre></td></tr></table></figure>

<ul>
<li>修改 nginx 配置文件。主备一样</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/nginx/nginx.conf </span><br><span class="line"></span><br><span class="line">user nginx; </span><br><span class="line">worker_processes auto; </span><br><span class="line">error_log /var/log/nginx/error.log; </span><br><span class="line">pid /run/nginx.pid; </span><br><span class="line"> </span><br><span class="line">include /usr/share/nginx/modules/*.conf; </span><br><span class="line"> </span><br><span class="line">events &#123; </span><br><span class="line">    worker_connections 1024; </span><br><span class="line">&#125; </span><br><span class="line"><span class="meta prompt_"> </span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">四层负载均衡，为两台 Master apiserver 组件提供负载均衡</span> </span><br><span class="line">stream &#123; </span><br><span class="line"> </span><br><span class="line">   log_format main &#x27;$remote_addr $upstream_addr - [$time_local] $status $upstream_bytes_sent&#x27;; </span><br><span class="line"> </span><br><span class="line">    access_log /var/log/nginx/k8s-access.log main; </span><br><span class="line"> </span><br><span class="line">    upstream k8s-apiserver &#123; </span><br><span class="line">       server 192.168.1.180:6443; # Master1 APISERVER IP:PORT </span><br><span class="line">       server 192.168.1.181:6443; # Master2 APISERVER IP:PORT </span><br><span class="line"> &#125; </span><br><span class="line"> </span><br><span class="line">    server &#123; </span><br><span class="line">        listen 16443; # 由于 nginx 与 master 节点复用，这个监听端口不能是 6443，否则会冲突 </span><br><span class="line">        proxy_pass k8s-apiserver; </span><br><span class="line"> &#125; </span><br><span class="line">&#125; </span><br><span class="line"> </span><br><span class="line">http &#123; </span><br><span class="line">    log_format main &#x27;$remote_addr - $remote_user [$time_local] &quot;$request&quot; &#x27; </span><br><span class="line">                    &#x27;$status $body_bytes_sent &quot;$http_referer&quot; &#x27; </span><br><span class="line">                    &#x27;&quot;$http_user_agent&quot; &quot;$http_x_forwarded_for&quot;&#x27;; </span><br><span class="line"> </span><br><span class="line">    access_log /var/log/nginx/access.log main; </span><br><span class="line"> </span><br><span class="line">    sendfile on; </span><br><span class="line">    tcp_nopush on; </span><br><span class="line">    tcp_nodelay on; </span><br><span class="line">    keepalive_timeout 65; </span><br><span class="line">    types_hash_max_size 2048; </span><br><span class="line"> </span><br><span class="line">    include /etc/nginx/mime.types; </span><br><span class="line">    default_type application/octet-stream; </span><br><span class="line"> </span><br><span class="line">    server &#123; </span><br><span class="line">        listen 80 default_server; </span><br><span class="line">        server_name _; </span><br><span class="line"> </span><br><span class="line">        location / &#123; </span><br><span class="line">        &#125; </span><br><span class="line">    &#125; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><p>keepalive 配置</p>
</li>
<li><p>主keepalived</p>
</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/keepalived/keepalived.conf</span><br><span class="line"></span><br><span class="line">global_defs &#123; </span><br><span class="line">    notification_email &#123; </span><br><span class="line">        acassen@firewall.loc </span><br><span class="line">        failover@firewall.loc </span><br><span class="line">        sysadmin@firewall.loc </span><br><span class="line">    &#125; </span><br><span class="line">    notification_email_from Alexandre.Cassen@firewall.loc </span><br><span class="line">    smtp_server 127.0.0.1 </span><br><span class="line">    smtp_connect_timeout 30 </span><br><span class="line">    router_id NGINX_MASTER </span><br><span class="line">&#125; </span><br><span class="line"> </span><br><span class="line">vrrp_script check_nginx &#123; </span><br><span class="line">    script &quot;/etc/keepalived/check_nginx.sh&quot; </span><br><span class="line">&#125; </span><br><span class="line"> </span><br><span class="line">vrrp_instance VI_1 &#123; </span><br><span class="line">    state MASTER </span><br><span class="line">    interface ens32 # 修改为实际网卡名 </span><br><span class="line">    virtual_router_id 51 # VRRP 路由 ID 实例，每个实例是唯一的 </span><br><span class="line">    priority 100 # 优先级，备服务器设置 90 </span><br><span class="line">    advert_int 1 # 指定 VRRP 心跳包通告间隔时间，默认 1 秒 </span><br><span class="line">    authentication &#123; </span><br><span class="line">        auth_type PASS </span><br><span class="line">        auth_pass 1111 </span><br><span class="line">    &#125; </span><br><span class="line"><span class="meta prompt_"> # </span><span class="language-bash">虚拟 IP</span> </span><br><span class="line">    virtual_ipaddress &#123; </span><br><span class="line">        192.168.1.199/24 </span><br><span class="line">    &#125; </span><br><span class="line">    track_script &#123;</span><br><span class="line">        check_nginx </span><br><span class="line">    &#125; </span><br><span class="line">&#125;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">vrrp_script：指定检查 nginx 工作状态脚本（根据 nginx 状态判断是否故障转移）</span> </span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">virtual_ipaddress：虚拟 IP（VIP）</span></span><br></pre></td></tr></table></figure>

<ul>
<li>监控nginx脚本</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/keepalived/check_nginx.sh</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/bash</span> </span><br><span class="line">count=$(ps -ef |grep nginx | grep sbin | egrep -cv &quot;grep|$$&quot;) </span><br><span class="line">if [ &quot;$count&quot; -eq 0 ];then </span><br><span class="line"> systemctl stop keepalived </span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line">chmod +x /etc/keepalived/check_nginx.sh</span><br></pre></td></tr></table></figure>

<ul>
<li>备keepalived</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/keepalived/keepalived.conf</span><br><span class="line"></span><br><span class="line">global_defs &#123; </span><br><span class="line">    notification_email &#123; </span><br><span class="line">        acassen@firewall.loc </span><br><span class="line">        failover@firewall.loc </span><br><span class="line">        sysadmin@firewall.loc </span><br><span class="line">    &#125; </span><br><span class="line">    notification_email_from Alexandre.Cassen@firewall.loc </span><br><span class="line">    smtp_server 127.0.0.1 </span><br><span class="line">    smtp_connect_timeout 30 </span><br><span class="line">    router_id NGINX_MASTER </span><br><span class="line">&#125; </span><br><span class="line"> </span><br><span class="line">vrrp_script check_nginx &#123; </span><br><span class="line">    script &quot;/etc/keepalived/check_nginx.sh&quot; </span><br><span class="line">&#125; </span><br><span class="line"> </span><br><span class="line">vrrp_instance VI_1 &#123; </span><br><span class="line">    state BACKUP</span><br><span class="line">    interface ens32 </span><br><span class="line">    virtual_router_id 51 </span><br><span class="line">    priority 90</span><br><span class="line">    advert_int 1 </span><br><span class="line">    authentication &#123; </span><br><span class="line">        auth_type PASS </span><br><span class="line">        auth_pass 1111 </span><br><span class="line">    &#125; </span><br><span class="line"><span class="meta prompt_"> # </span><span class="language-bash">虚拟 IP</span> </span><br><span class="line">    virtual_ipaddress &#123; </span><br><span class="line">        192.168.1.199/24 </span><br><span class="line">    &#125; </span><br><span class="line">    track_script &#123;</span><br><span class="line">        check_nginx </span><br><span class="line">    &#125; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>监控nginx脚本</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/keepalived/check_nginx.sh</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/bash</span> </span><br><span class="line">count=$(ps -ef |grep nginx | grep sbin | egrep -cv &quot;grep|$$&quot;) </span><br><span class="line">if [ &quot;$count&quot; -eq 0 ];then </span><br><span class="line"> systemctl stop keepalived </span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line">chmod +x /etc/keepalived/check_nginx.sh</span><br></pre></td></tr></table></figure>

<ul>
<li>启动服务</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">systemctl daemon-reload </span><br><span class="line"></span><br><span class="line">systemctl start nginx &amp;&amp; systemctl enable nginx</span><br><span class="line"></span><br><span class="line">systemctl start keepalived &amp;&amp; systemctl enable keepalived</span><br><span class="line"> </span><br><span class="line">systemctl status keepalived</span><br></pre></td></tr></table></figure>

<ul>
<li>测试 vip 是否绑定成功</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">[root@master1 ~]# ip addr</span><br><span class="line">1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000</span><br><span class="line">    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00</span><br><span class="line">    inet 127.0.0.1/8 scope host lo</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    inet6 ::1/128 scope host </span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">2: ens32: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc pfifo_fast state UP group default qlen 1000</span><br><span class="line">    link/ether 00:0c:29:3c:ad:b7 brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    inet 192.168.1.180/24 brd 192.168.1.255 scope global noprefixroute ens32</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    inet 192.168.1.199/24 scope global secondary ens32</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    inet6 fe80::f505:3807:9755:3839/64 scope link tentative noprefixroute dadfailed </span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    inet6 fe80::559d:3360:2944:a1b1/64 scope link tentative noprefixroute dadfailed </span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    inet6 fe80::a15a:e07:fa1e:4a60/64 scope link noprefixroute </span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">3: docker0: &lt;NO-CARRIER,BROADCAST,MULTICAST,UP&gt; mtu 1500 qdisc noqueue state DOWN group default </span><br><span class="line">    link/ether 02:42:25:a7:a3:4c brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    inet 172.17.0.1/16 brd 172.17.255.255 scope global docker0</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br></pre></td></tr></table></figure>

<ul>
<li>测试 keepalived</li>
</ul>
<blockquote>
<p>停掉 master1 上的 nginx。Vip 会漂移到 master2</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">[root@master1 ~]# systemctl stop nginx.service</span><br><span class="line"></span><br><span class="line">[root@master2 ~]# ip addr</span><br><span class="line">1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000</span><br><span class="line">    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00</span><br><span class="line">    inet 127.0.0.1/8 scope host lo</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    inet6 ::1/128 scope host </span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">2: ens32: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc pfifo_fast state UP group default qlen 1000</span><br><span class="line">    link/ether 00:0c:29:e0:93:9e brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    inet 192.168.1.181/24 brd 192.168.1.255 scope global noprefixroute ens32</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    inet 192.168.1.199/24 scope global secondary ens32</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    inet6 fe80::f505:3807:9755:3839/64 scope link tentative noprefixroute dadfailed </span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    inet6 fe80::559d:3360:2944:a1b1/64 scope link noprefixroute </span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">3: docker0: &lt;NO-CARRIER,BROADCAST,MULTICAST,UP&gt; mtu 1500 qdisc noqueue state DOWN group default </span><br><span class="line">    link/ether 02:42:69:d1:a0:c5 brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    inet 172.17.0.1/16 brd 172.17.255.255 scope global docker0</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br></pre></td></tr></table></figure>

<blockquote>
<p>启动 xianchaomaster1 上的 nginx 和 keepalived，vip 又会漂移回来</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">[root@master1 ~]# systemctl daemon-reload </span><br><span class="line"></span><br><span class="line">[root@master1 ~]# systemctl start nginx.service </span><br><span class="line"></span><br><span class="line">[root@master1 ~]# systemctl start keepalived.service </span><br><span class="line"></span><br><span class="line">[root@master1 ~]# ip addr</span><br><span class="line">1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000</span><br><span class="line">    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00</span><br><span class="line">    inet 127.0.0.1/8 scope host lo</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    inet6 ::1/128 scope host </span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">2: ens32: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc pfifo_fast state UP group default qlen 1000</span><br><span class="line">    link/ether 00:0c:29:3c:ad:b7 brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    inet 192.168.1.180/24 brd 192.168.1.255 scope global noprefixroute ens32</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    inet 192.168.1.199/24 scope global secondary ens32</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    inet6 fe80::f505:3807:9755:3839/64 scope link tentative noprefixroute dadfailed </span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    inet6 fe80::559d:3360:2944:a1b1/64 scope link tentative noprefixroute dadfailed </span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    inet6 fe80::a15a:e07:fa1e:4a60/64 scope link noprefixroute </span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">3: docker0: &lt;NO-CARRIER,BROADCAST,MULTICAST,UP&gt; mtu 1500 qdisc noqueue state DOWN group default </span><br><span class="line">    link/ether 02:42:25:a7:a3:4c brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    inet 172.17.0.1/16 brd 172.17.255.255 scope global docker0</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br></pre></td></tr></table></figure>

<h2 id="kubeadm-初始化-k8s-集群"><a href="#kubeadm-初始化-k8s-集群" class="headerlink" title="kubeadm 初始化 k8s 集群"></a>kubeadm 初始化 k8s 集群</h2><ul>
<li>在master1上创建 kubeadm-config.yaml 文件</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">vim</span> <span class="string">kubeadm-config.yaml</span></span><br><span class="line"></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">kubeadm.k8s.io/v1beta2</span> </span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterConfiguration</span> </span><br><span class="line"><span class="attr">kubernetesVersion:</span> <span class="string">v1.20.6</span> </span><br><span class="line"><span class="attr">controlPlaneEndpoint:</span> <span class="number">192.168</span><span class="number">.1</span><span class="number">.199</span><span class="string">:16443</span> </span><br><span class="line"><span class="attr">imageRepository:</span> <span class="string">registry.aliyuncs.com/google_containers</span> </span><br><span class="line"><span class="attr">apiServer:</span> </span><br><span class="line"> <span class="attr">certSANs:</span> </span><br><span class="line"> <span class="bullet">-</span> <span class="number">192.168</span><span class="number">.1</span><span class="number">.180</span> </span><br><span class="line"> <span class="bullet">-</span> <span class="number">192.168</span><span class="number">.1</span><span class="number">.181</span> </span><br><span class="line"> <span class="bullet">-</span> <span class="number">192.168</span><span class="number">.1</span><span class="number">.182</span> </span><br><span class="line"> <span class="bullet">-</span> <span class="number">192.168</span><span class="number">.1</span><span class="number">.199</span> </span><br><span class="line"><span class="attr">networking:</span> </span><br><span class="line"> <span class="attr">podSubnet:</span> <span class="number">10.244</span><span class="number">.0</span><span class="number">.0</span><span class="string">/16</span> </span><br><span class="line"> <span class="attr">serviceSubnet:</span> <span class="number">10.10</span><span class="number">.0</span><span class="number">.0</span><span class="string">/16</span> </span><br><span class="line"><span class="meta">--- </span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">kubeproxy.config.k8s.io/v1alpha1</span> </span><br><span class="line"><span class="attr">kind:</span> <span class="string">KubeProxyConfiguration</span> </span><br><span class="line"><span class="attr">mode:</span> <span class="string">ipvs</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 注：--image-repository registry.aliyuncs.com/google_containers：手动指定仓库地址为registry.aliyuncs.com/google_containers。</span></span><br><span class="line"><span class="comment"># kubeadm 默认从 k8s.grc.io 拉取镜像，但是 k8s.gcr.io访问不到，所以需要指定从 registry.aliyuncs.com/google_containers 仓库拉取镜像。</span></span><br></pre></td></tr></table></figure>

<ul>
<li>把初始化 k8s 集群需要的离线镜像包上传到 master1、master2、node1机器上，手动解压：</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">docker load -i k8simage-1-20-6.tar.gz</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">没有离线镜像包，会从阿里云拉取镜像</span></span><br></pre></td></tr></table></figure>

<ul>
<li>初始化 k8s 集群</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">kubeadm init --config kubeadm-config.yaml --ignore-preflight-errors=SystemVerification</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">显示如下，说明安装完成</span></span><br><span class="line"></span><br><span class="line">Your Kubernetes control-plane has initialized successfully!</span><br><span class="line"></span><br><span class="line">To start using your cluster, you need to run the following as a regular user:</span><br><span class="line"></span><br><span class="line">  mkdir -p $HOME/.kube</span><br><span class="line">  sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config</span><br><span class="line">  sudo chown $(id -u):$(id -g) $HOME/.kube/config</span><br><span class="line"></span><br><span class="line">Alternatively, if you are the root user, you can run:</span><br><span class="line"></span><br><span class="line">  export KUBECONFIG=/etc/kubernetes/admin.conf</span><br><span class="line"></span><br><span class="line">You should now deploy a pod network to the cluster.</span><br><span class="line">Run &quot;kubectl apply -f [podnetwork].yaml&quot; with one of the options listed at:</span><br><span class="line">  https://kubernetes.io/docs/concepts/cluster-administration/addons/</span><br><span class="line"></span><br><span class="line">You can now join any number of control-plane nodes by copying certificate authorities</span><br><span class="line">and service account keys on each node and then running the following as root:</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">这里是把 master 节点加入集群的命令</span></span><br><span class="line">  kubeadm join 192.168.1.199:16443 --token 3yano8.s4yo3bdw8r71y2cw \</span><br><span class="line">    --discovery-token-ca-cert-hash sha256:4ba3577abc437bd0aa2a93072085ec94c7471824a3690328f03cb501e6e92830 \</span><br><span class="line">    --control-plane </span><br><span class="line"></span><br><span class="line">Then you can join any number of worker nodes by running the following on each as root:</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">这里是把 node 节点加入集群的命令</span></span><br><span class="line">kubeadm join 192.168.1.199:16443 --token 3yano8.s4yo3bdw8r71y2cw \</span><br><span class="line">    --discovery-token-ca-cert-hash sha256:4ba3577abc437bd0aa2a93072085ec94c7471824a3690328f03cb501e6e92830 </span><br></pre></td></tr></table></figure>

<ul>
<li>配置 kubectl 的配置文件 config</li>
</ul>
<blockquote>
<p>相当于对 kubectl 进行授权，这样 kubectl 命令可以使用这个证书对 k8s 集群进行管理</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p $HOME/.kube</span><br><span class="line"></span><br><span class="line">sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config</span><br><span class="line"></span><br><span class="line">sudo chown $(id -u):$(id -g) $HOME/.kube/config</span><br></pre></td></tr></table></figure>

<h2 id="扩容-k8s-集群-添加-master-节点"><a href="#扩容-k8s-集群-添加-master-节点" class="headerlink" title="扩容 k8s 集群-添加 master 节点"></a>扩容 k8s 集群-添加 master 节点</h2><ul>
<li>在 master2 创建证书存放目录</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cd /root &amp;&amp; mkdir -p /etc/kubernetes/pki/etcd &amp;&amp;mkdir -p ~/.kube/</span><br></pre></td></tr></table></figure>

<ul>
<li>把 master1 节点的证书拷贝到 master2 上</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">scp /etc/kubernetes/pki/ca.crt master2:/etc/kubernetes/pki/</span><br><span class="line"></span><br><span class="line">scp /etc/kubernetes/pki/ca.key master2:/etc/kubernetes/pki/</span><br><span class="line"></span><br><span class="line">scp /etc/kubernetes/pki/sa.key master2:/etc/kubernetes/pki/</span><br><span class="line"></span><br><span class="line">scp /etc/kubernetes/pki/sa.pub master2:/etc/kubernetes/pki/ </span><br><span class="line"></span><br><span class="line">scp /etc/kubernetes/pki/front-proxy-ca.crt master2:/etc/kubernetes/pki/ </span><br><span class="line"></span><br><span class="line">scp /etc/kubernetes/pki/front-proxy-ca.key master2:/etc/kubernetes/pki/ </span><br><span class="line"></span><br><span class="line">scp /etc/kubernetes/pki/etcd/ca.crt master2:/etc/kubernetes/pki/etcd/ </span><br><span class="line"></span><br><span class="line">scp /etc/kubernetes/pki/etcd/ca.key master2:/etc/kubernetes/pki/etcd/</span><br></pre></td></tr></table></figure>

<ul>
<li>执行加入命令</li>
</ul>
<blockquote>
<p>在master1上查看加入命令</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">kubeadm token create --print-join-command</span><br><span class="line"></span><br><span class="line">kubeadm join 192.168.1.199:16443 --token b6s893.vo2d43b2488tif6c  \</span><br><span class="line">--discovery-token-ca-cert-hash sha256:4ba3577abc437bd0aa2a93072085ec94c7471824a3690328f03cb501e6e92830</span><br></pre></td></tr></table></figure>

<blockquote>
<p>master2执行命令</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">kubeadm join 192.168.1.199:16443 --token b6s893.vo2d43b2488tif6c  \</span><br><span class="line">--discovery-token-ca-cert-hash sha256:4ba3577abc437bd0aa2a93072085ec94c7471824a3690328f03cb501e6e92830 \</span><br><span class="line">--control-plane --ignore-preflight-errors=SystemVerification</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">mkdir -p $HOME/.kube</span><br><span class="line">sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config</span><br><span class="line">sudo chown $(id -u):$(id -g) $HOME/.kube/config</span><br></pre></td></tr></table></figure>

<ul>
<li>查看集群状况</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">可以看到 master2 已经加入到集群了</span></span><br><span class="line">kubectl get nodes</span><br><span class="line"></span><br><span class="line">NAME      STATUS     ROLES                  AGE   VERSION</span><br><span class="line">master1   NotReady   control-plane,master   33m   v1.20.6</span><br><span class="line">master2   NotReady   control-plane,master   80s   v1.20.6</span><br></pre></td></tr></table></figure>

<h2 id="扩容-k8s-集群-添加-node-节点"><a href="#扩容-k8s-集群-添加-node-节点" class="headerlink" title="扩容 k8s 集群-添加 node 节点"></a>扩容 k8s 集群-添加 node 节点</h2><ul>
<li>在 master1 上查看加入节点的命令</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">kubeadm token create --print-join-command</span><br><span class="line"></span><br><span class="line">kubeadm join 192.168.1.199:16443 --token flsons.7c66kxcihkjpgnly     \</span><br><span class="line">--discovery-token-ca-cert-hash sha256:4ba3577abc437bd0aa2a93072085ec94c7471824a3690328f03cb501e6e92830 </span><br></pre></td></tr></table></figure>

<ul>
<li>把 node1 加入 k8s 集群</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">kubeadm join 192.168.1.199:16443 --token flsons.7c66kxcihkjpgnly     \</span><br><span class="line">--discovery-token-ca-cert-hash sha256:4ba3577abc437bd0aa2a93072085ec94c7471824a3690328f03cb501e6e92830 \</span><br><span class="line">--ignore-preflight-errors=SystemVerification</span><br></pre></td></tr></table></figure>

<ul>
<li>在 master1 上查看集群节点状况</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">kubectl get nodes</span><br><span class="line"></span><br><span class="line">NAME      STATUS     ROLES                  AGE   VERSION</span><br><span class="line">master1   NotReady   control-plane,master   64m   v1.20.6</span><br><span class="line">master2   NotReady   control-plane,master   31m   v1.20.6</span><br><span class="line">node1     NotReady   &lt;none&gt;                 42s   v1.20.6</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">可以看到 node1 的 ROLES 角色为空，&lt;none&gt;就表示这个节点是工作节点。</span> </span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">可以把 node1 的 ROLES 变成 work</span></span><br><span class="line">kubectl label node node1 node-role.kubernetes.io/worker=worker</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">kubectl get nodes</span><br><span class="line"></span><br><span class="line">NAME      STATUS     ROLES                  AGE     VERSION</span><br><span class="line">master1   NotReady   control-plane,master   65m     v1.20.6</span><br><span class="line">master2   NotReady   control-plane,master   33m     v1.20.6</span><br><span class="line">node1     NotReady   worker                 2m18s   v1.20.6</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">kubectl get pods -n kube-system</span><br><span class="line"></span><br><span class="line">NAME                              READY   STATUS    RESTARTS   AGE</span><br><span class="line">coredns-7f89b7bc75-2ht5z          0/1     Pending   0          66m</span><br><span class="line">coredns-7f89b7bc75-xv9mv          0/1     Pending   0          66m</span><br><span class="line">etcd-master1                      1/1     Running   0          66m</span><br><span class="line">etcd-master2                      1/1     Running   0          33m</span><br><span class="line">kube-apiserver-master1            1/1     Running   1          66m</span><br><span class="line">kube-apiserver-master2            1/1     Running   0          33m</span><br><span class="line">kube-controller-manager-master1   1/1     Running   1          66m</span><br><span class="line">kube-controller-manager-master2   1/1     Running   0          33m</span><br><span class="line">kube-proxy-q9dq7                  1/1     Running   0          2m48s</span><br><span class="line">kube-proxy-w664w                  1/1     Running   0          66m</span><br><span class="line">kube-proxy-wkqdv                  1/1     Running   0          33m</span><br><span class="line">kube-scheduler-master1            1/1     Running   1          66m</span><br><span class="line">kube-scheduler-master2            1/1     Running   0          33m</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">coredns-7f89b7bc75-2ht5z 是 pending 状态，这是因为还没有安装网络插件，等到下面安装好网络插件之后这个 cordns 就会变成 running 了</span></span><br></pre></td></tr></table></figure>

<h2 id="安装-kubernetes-网络组件-Calico"><a href="#安装-kubernetes-网络组件-Calico" class="headerlink" title="安装 kubernetes 网络组件-Calico"></a>安装 kubernetes 网络组件-Calico</h2><ul>
<li>在线下载配置文件地址是： <a target="_blank" rel="noopener" href="https://docs.projectcalico.org/manifests/calico.yaml">https://docs.projectcalico.org/manifests/calico.yaml</a></li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">在master1上安装</span></span><br><span class="line">wget https://docs.projectcalico.org/manifests/calico.yaml</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">版本可能不同会有报错</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">apiVersion: policy/v1  &gt;改&gt;为&gt; policy/v1beta1</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">kind: PodDisruptionBudget</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">有镜像包的话，三台虚拟机上都需要docker load</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">有自己的镜像站让其他节点加入就行</span></span><br><span class="line"></span><br><span class="line">kubectl apply -f calico.yaml</span><br><span class="line"></span><br><span class="line">kubectl get pods -n kube-system</span><br><span class="line"></span><br><span class="line">NAME                                       READY   STATUS    RESTARTS   AGE</span><br><span class="line">calico-kube-controllers-6949477b58-tf9dm   1/1     Running   0          27s</span><br><span class="line">calico-node-bmr42                          1/1     Running   0          27s</span><br><span class="line">calico-node-qfkwj                          1/1     Running   0          27s</span><br><span class="line">calico-node-tqb7c                          1/1     Running   0          27s</span><br><span class="line">coredns-7f89b7bc75-2ht5z                   1/1     Running   0          151m</span><br><span class="line">coredns-7f89b7bc75-xv9mv                   1/1     Running   0          151m</span><br><span class="line">etcd-master1                               1/1     Running   0          151m</span><br><span class="line">etcd-master2                               1/1     Running   0          119m</span><br><span class="line">kube-apiserver-master1                     1/1     Running   1          151m</span><br><span class="line">kube-apiserver-master2                     1/1     Running   0          119m</span><br><span class="line">kube-controller-manager-master1            1/1     Running   1          151m</span><br><span class="line">kube-controller-manager-master2            1/1     Running   0          119m</span><br><span class="line">kube-proxy-q9dq7                           1/1     Running   0          88m</span><br><span class="line">kube-proxy-w664w                           1/1     Running   0          151m</span><br><span class="line">kube-proxy-wkqdv                           1/1     Running   0          119m</span><br><span class="line">kube-scheduler-master1                     1/1     Running   1          151m</span><br><span class="line">kube-scheduler-master2                     1/1     Running   0          119m</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">coredns-这个 pod 现在是 running 状态，运行正常</span></span><br></pre></td></tr></table></figure>

<ul>
<li>查看集群状态</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">STATUS 状态是 Ready，说明 k8s 集群正常运行了</span></span><br><span class="line">kubectl get nodes</span><br><span class="line"></span><br><span class="line">NAME      STATUS   ROLES                  AGE    VERSION</span><br><span class="line">master1   Ready    control-plane,master   153m   v1.20.6</span><br><span class="line">master2   Ready    control-plane,master   120m   v1.20.6</span><br><span class="line">node1     Ready    worker                 89m    v1.20.6</span><br></pre></td></tr></table></figure>

<ul>
<li>测试在 k8s 创建 pod 是否可以正常访问网络</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">kubectl run busybox --image busybox:1.28 --restart=Never --rm -it -- sh</span><br><span class="line"></span><br><span class="line">/ # ping baidu.com</span><br><span class="line">PING baidu.com (39.156.66.10): 56 data bytes</span><br><span class="line">64 bytes from 39.156.66.10: seq=0 ttl=127 time=18.707 ms</span><br><span class="line">64 bytes from 39.156.66.10: seq=1 ttl=127 time=18.246 ms</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">通过上面可以看到能访问网络，说明 calico 网络插件已经被正常安装了</span></span><br></pre></td></tr></table></figure>

<ul>
<li>测试 k8s 集群中部署 tomcat 服务</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line">[root@master1 ~]# cat tomcat.yaml</span><br><span class="line"></span><br><span class="line">apiVersion: v1  #pod属于k8s核心组v1</span><br><span class="line">kind: Pod  #创建的是一个Pod资源</span><br><span class="line">metadata:  #元数据</span><br><span class="line">  name: demo-pod  #pod名字</span><br><span class="line">  namespace: default  #pod所属的名称空间</span><br><span class="line">  labels:</span><br><span class="line">    app: myapp  #pod具有的标签</span><br><span class="line">    env: dev      #pod具有的标签</span><br><span class="line">spec:</span><br><span class="line">  containers:      #定义一个容器，容器是对象列表，下面可以有多个name</span><br><span class="line">  - name:  tomcat-pod-java  #容器的名字</span><br><span class="line">    ports:</span><br><span class="line">    - containerPort: 8080</span><br><span class="line">    image: tomcat:8.5-jre8-alpine   #容器使用的镜像</span><br><span class="line">    imagePullPolicy: IfNotPresent</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@master1 ~]# cat tomcat-service.yaml</span><br><span class="line"></span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  name: tomcat</span><br><span class="line">spec:</span><br><span class="line">  type: NodePort</span><br><span class="line">  ports:</span><br><span class="line">    - port: 8080</span><br><span class="line">      nodePort: 30080</span><br><span class="line">  selector:</span><br><span class="line">    app: myapp</span><br><span class="line">    env: dev</span><br><span class="line"></span><br><span class="line">[root@master1 ~]# kubectl apply -f tomcat.yaml </span><br><span class="line"></span><br><span class="line">[root@master1 ~]# kubectl get pods -o wide</span><br><span class="line">NAME       READY   STATUS    RESTARTS   AGE     IP               NODE    NOMINATED NODE   READINESS GATES</span><br><span class="line">demo-pod   1/1     Running   0          7m44s   10.244.166.133   node1   &lt;none&gt;           &lt;none&gt;</span><br><span class="line"></span><br><span class="line">[root@master1 ~]# curl http://10.244.166.133:8080 -I</span><br><span class="line">HTTP/1.1 200	# 状态码 200 为正常</span><br><span class="line">Content-Type: text/html;charset=UTF-8</span><br><span class="line">Transfer-Encoding: chunked</span><br><span class="line">Date: Sun, 16 Jul 2023 10:32:55 GMT</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@master1 ~]# kubectl apply -f tomcat-service.yaml</span><br><span class="line"></span><br><span class="line">[root@master1 ~]# kubectl get svc</span><br><span class="line">NAME         TYPE        CLUSTER-IP     EXTERNAL-IP   PORT(S)          AGE</span><br><span class="line">kubernetes   ClusterIP   10.10.0.1      &lt;none&gt;        443/TCP          160m</span><br><span class="line">tomcat       NodePort    10.10.24.186   &lt;none&gt;        8080:30080/TCP   34s</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">浏览器访问master节点的IP:30080,即可打开tomcat</span></span><br></pre></td></tr></table></figure>

<ul>
<li>测试 coredns 是否正常</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">kubectl run busybox --image busybox:1.28 --restart=Never --rm -it busybox -- sh</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">/ # nslookup kubernetes.default.svc.cluster.local</span><br><span class="line">Server:    10.10.0.10</span><br><span class="line">Address 1: 10.10.0.10 kube-dns.kube-system.svc.cluster.local</span><br><span class="line"></span><br><span class="line">Name:      kubernetes.default.svc.cluster.local</span><br><span class="line">Address 1: 10.10.0.1 kubernetes.default.svc.cluster.local</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">/ # nslookup tomcat.default.svc.cluster.local</span><br><span class="line">Server:    10.10.0.10</span><br><span class="line">Address 1: 10.10.0.10 kube-dns.kube-system.svc.cluster.local</span><br><span class="line"></span><br><span class="line">Name:      tomcat.default.svc.cluster.local</span><br><span class="line">Address 1: 10.10.24.186 tomcat.default.svc.cluster.local</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">10.10.0.10 就是我们 coreDNS 的 clusterIP，说明 coreDNS 配置好了。</span></span><br><span class="line">[root@master1 ~]# kubectl  get svc -n kube-system</span><br><span class="line">NAME       TYPE        CLUSTER-IP   EXTERNAL-IP   PORT(S)                  AGE</span><br><span class="line">kube-dns   ClusterIP   10.10.0.10   &lt;none&gt;        53/UDP,53/TCP,9153/TCP   3h2m</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">解析内部 Service 的名称，是通过 coreDNS 去解析的。</span> </span><br><span class="line"><span class="meta prompt_"> </span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">10.10.24.186 是创建的 tomcat 的 service ip</span></span><br><span class="line">[root@master1 ~]# kubectl  get svc </span><br><span class="line">NAME         TYPE        CLUSTER-IP     EXTERNAL-IP   PORT(S)          AGE</span><br><span class="line">kubernetes   ClusterIP   10.10.0.1      &lt;none&gt;        443/TCP          3h3m</span><br><span class="line">tomcat       NodePort    10.10.24.186   &lt;none&gt;        8080:30080/TCP   22m</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">注意：busybox 要用指定的 1.28 版本，不能用最新版本，最新版本，nslookup 会解析不到 dns 和 ip</span></span><br></pre></td></tr></table></figure>

<h1 id="二进制安装多master的k8s集群"><a href="#二进制安装多master的k8s集群" class="headerlink" title="二进制安装多master的k8s集群"></a>二进制安装多master的k8s集群</h1><h2 id="k8s环境规划-1"><a href="#k8s环境规划-1" class="headerlink" title="k8s环境规划"></a>k8s环境规划</h2><blockquote>
<p>centos7.6操作系统，4G/4CPU/100G，网络NAT，开启虚拟化</p>
<p>podSubnet(pod网段)10.0.0.0/16<br>serviceSubnet(service网段)10.255.0.0/16</p>
</blockquote>
<table>
<thead>
<tr>
<th>k8s集群角色</th>
<th>ip</th>
<th>主机名</th>
<th>安装的组件</th>
</tr>
</thead>
<tbody><tr>
<td>控制节点</td>
<td>192.168.1.180</td>
<td>master1</td>
<td>apiserver、controller-manager、scheduler、etcd、docker、keepalived、nginx</td>
</tr>
<tr>
<td>控制节点</td>
<td>192.168.1.181</td>
<td>master2</td>
<td>apiserver、controller-manager、scheduler、etcd、docker、keepalived、nginx</td>
</tr>
<tr>
<td>控制节点</td>
<td>192.168.1.182</td>
<td>master3</td>
<td>apiserver、controller-manager、scheduler、etcd、docker</td>
</tr>
<tr>
<td>工作节点</td>
<td>192.168.1.183</td>
<td>node1</td>
<td>kubelet、kube-proxy、docker、calico、coredns</td>
</tr>
<tr>
<td>VIP</td>
<td>192.168.1.199</td>
<td></td>
<td></td>
</tr>
</tbody></table>
<h2 id="初始化"><a href="#初始化" class="headerlink" title="初始化"></a>初始化</h2><blockquote>
<p>所有主机做以下操作</p>
</blockquote>
<ul>
<li>配置hosts解析</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">echo &quot;192.168.1.180 master1</span><br><span class="line">192.168.1.181 master2</span><br><span class="line">192.168.1.182 master3</span><br><span class="line">192.168.1.183 node1&quot; &gt;&gt; /etc/hosts</span><br></pre></td></tr></table></figure>

<ul>
<li>配置主机间无密码登录</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ssh-keygen</span><br><span class="line"></span><br><span class="line">for i in master1 master2 master3 node1;do ssh-copy-id root@$i;done</span><br></pre></td></tr></table></figure>

<ul>
<li>关闭防火墙</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl disable --now firewalld</span><br></pre></td></tr></table></figure>

<ul>
<li>关闭selinux</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">sed -i &#x27;s/SELINUX=enforcing/SELINUX=disabled/g&#x27; /etc/selinux/config</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">重启生效</span></span><br><span class="line">reboot</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">显示 Disabled 说明 selinux 已经关闭</span></span><br><span class="line">getenforce</span><br></pre></td></tr></table></figure>

<ul>
<li>关闭交换分区swap</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">临时关闭</span></span><br><span class="line">swapoff -a</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">永久关闭：注释 swap 挂载，给 swap 这行开头加一下注释</span></span><br><span class="line">vim /etc/fstab</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">/dev/mapper/centos-swap swap swap defaults 0 0</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">如果是克隆的虚拟机，需要删除 UUID</span></span><br></pre></td></tr></table></figure>

<ul>
<li>修改内核参数</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">加载 br_netfilter 模块</span></span><br><span class="line">modprobe br_netfilter</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">验证模块是否加载成功：</span></span><br><span class="line">lsmod |grep br_netfilter</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">修改内核参数</span></span><br><span class="line">cat &gt; /etc/sysctl.d/k8s.conf &lt;&lt;EOF</span><br><span class="line">net.bridge.bridge-nf-call-ip6tables = 1</span><br><span class="line">net.bridge.bridge-nf-call-iptables = 1</span><br><span class="line">net.ipv4.ip_forward = 1</span><br><span class="line">EOF</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">使刚才修改的内核参数生效</span></span><br><span class="line">sysctl -p /etc/sysctl.d/k8s.conf</span><br></pre></td></tr></table></figure>

<ul>
<li>配置阿里云repo源</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">备份基础repo源</span></span><br><span class="line">mkdir /root/repo.bak </span><br><span class="line">cd /etc/yum.repos.d/ </span><br><span class="line">mv * /root/repo.bak/</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">拉取阿里云repo源</span></span><br><span class="line">curl -o /etc/yum.repos.d/CentOS-Base.repo https://mirrors.aliyun.com/repo/Centos-7.repo</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">配置国内阿里云 docker 的 repo 源</span> </span><br><span class="line">yum install yum-utils -y</span><br><span class="line"></span><br><span class="line">yum-config-manager --add-repo http://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo</span><br></pre></td></tr></table></figure>

<ul>
<li>配置时间同步</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">安装 ntpdate 命令，</span></span><br><span class="line">yum install ntpdate -y</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">跟网络源做同步</span></span><br><span class="line">ntpdate cn.pool.ntp.org</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">把时间同步做成计划任务</span></span><br><span class="line">crontab -e</span><br><span class="line">* */1 * * * /usr/sbin/ntpdate cn.pool.ntp.org</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">重启 crond 服务</span></span><br><span class="line">service crond restart</span><br></pre></td></tr></table></figure>

<ul>
<li>安装iptables</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">安装 iptables</span></span><br><span class="line">yum install iptables-services -y</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">禁用 iptables</span></span><br><span class="line">service iptables stop &amp;&amp; systemctl disable iptables</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">清空防火墙规则</span></span><br><span class="line">iptables -F</span><br></pre></td></tr></table></figure>

<ul>
<li>开启 ipvs</li>
</ul>
<blockquote>
<p>不开启 ipvs 将会使用 iptables 进行数据包转发，但是效率低，所以官网推荐需要开通 ipvs。</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">编写脚本开启模块</span></span><br><span class="line">vim /etc/sysconfig/modules/ipvs.modules</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/bash</span></span><br><span class="line">ipvs_modules=&quot;ip_vs ip_vs_lc ip_vs_wlc ip_vs_rr ip_vs_wrr ip_vs_lblc ip_vs_lblcr ip_vs_dh ip_vs_sh ip_vs_nq ip_vs_sed ip_vs_ftp nf_conntrack&quot;</span><br><span class="line">for kernel_module in $&#123;ipvs_modules&#125;; do</span><br><span class="line"> /sbin/modinfo -F filename $&#123;kernel_module&#125; &gt; /dev/null 2&gt;&amp;1</span><br><span class="line"> if [ 0 -eq 0 ]; then</span><br><span class="line"> /sbin/modprobe $&#123;kernel_module&#125;</span><br><span class="line"> fi</span><br><span class="line">done</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">执行脚本，查看模块是否开启</span></span><br><span class="line">chmod 755 /etc/sysconfig/modules/ipvs.modules &amp;&amp; bash /etc/sysconfig/modules/ipvs.modules &amp;&amp; lsmod | grep ip_vs </span><br><span class="line">ip_vs_ftp 13079 0 </span><br><span class="line">nf_nat 26583 1 ip_vs_ftp </span><br><span class="line">ip_vs_sed 12519 0 </span><br><span class="line">ip_vs_nq 12516 0 </span><br><span class="line">ip_vs_sh 12688 0 </span><br><span class="line">ip_vs_dh 12688 0</span><br></pre></td></tr></table></figure>

<ul>
<li>安装基础软件包</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install -y yum-utils device-mapper-persistent-data lvm2 wget net-tools nfs-utils lrzsz gcc gcc-c++ make cmake libxml2-devel openssl-devel curl curl-devel unzip sudo ntp libaio-devel wget vim ncurses-devel autoconf automake zlib-devel python-devel epel-release openssh-server socat ipvsadm conntrack ntpdate telnet rsync</span><br></pre></td></tr></table></figure>

<ul>
<li>安装docker-ce</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">yum install docker-ce docker-ce-cli containerd.io -y</span><br><span class="line"></span><br><span class="line">systemctl start docker &amp;&amp; systemctl enable docker.service &amp;&amp; systemctl status docker</span><br></pre></td></tr></table></figure>

<ul>
<li>配置docker加速器</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">tee /etc/docker/daemon.json &lt;&lt; &#x27;EOF&#x27;</span><br><span class="line">&#123;</span><br><span class="line">&quot;registry-mirrors&quot;:[&quot;https://rsbud4vc.mirror.aliyuncs.com&quot;,&quot;https://registry.docker-cn.com&quot;,&quot;https://docker.mirrors.ustc.edu.cn&quot;,&quot;https://dockerhub.azk8s.cn&quot;,&quot;http://hub-mirror.c.163.com&quot;,&quot;http://qtid6917.mirror.aliyuncs.com&quot;,&quot;https://rncxm540.mirror.aliyuncs.com&quot;],</span><br><span class="line">&quot;exec-opts&quot;: [&quot;native.cgroupdriver=systemd&quot;]</span><br><span class="line"><span class="meta prompt_"> # </span><span class="language-bash"><span class="string">&quot;insecure-registries&quot;</span>: [<span class="string">&quot;192.168.1.100&quot;</span>]</span></span><br><span class="line">&#125; </span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">systemctl daemon-reload</span><br><span class="line">systemctl restart docker</span><br><span class="line">systemctl status docker</span><br></pre></td></tr></table></figure>

<h2 id="搭建etcd集群"><a href="#搭建etcd集群" class="headerlink" title="搭建etcd集群"></a>搭建etcd集群</h2><ul>
<li>配置 etcd 工作目录</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@master1 ~]# mkdir -p /etc/etcd/ssl</span><br><span class="line"></span><br><span class="line">[root@master2 ~]# mkdir -p /etc/etcd/ssl</span><br><span class="line"></span><br><span class="line">[root@master3 ~]# mkdir -p /etc/etcd/ssl</span><br></pre></td></tr></table></figure>

<ul>
<li>安装签发证书工具cfssl</li>
</ul>
<blockquote>
<p>先在master1上操作，后面会拷贝给其他master主机</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[root@master1 ~]# mkdir /data/work -p</span><br><span class="line"></span><br><span class="line">[root@master1 ~]# cd /data/work/</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">cfssl-certinfo_linux-amd64 、cfssljson_linux-amd64 、cfssl_linux-amd64 上传到/data/work/目录下</span></span><br><span class="line"></span><br><span class="line">[root@master1 work]# ls</span><br><span class="line">cfssl-certinfo_linux-amd64  cfssljson_linux-amd64  cfssl_linux-amd64</span><br><span class="line"></span><br><span class="line">[root@master1 work]# chmod +x *</span><br><span class="line"></span><br><span class="line">[root@master1 work]# mv cfssl_linux-amd64 /usr/local/bin/cfssl</span><br><span class="line">[root@master1 work]# mv cfssljson_linux-amd64 /usr/local/bin/cfssljson</span><br><span class="line">[root@master1 work]# mv cfssl-certinfo_linux-amd64 /usr/local/bin/cfssl-certinfo</span><br></pre></td></tr></table></figure>

<ul>
<li>配置ca证书</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">生成ca证书请求文件</span></span><br><span class="line"></span><br><span class="line">[root@master1 work]# cat ca-csr.json</span><br><span class="line">&#123;</span><br><span class="line">  &quot;CN&quot;: &quot;kubernetes&quot;,</span><br><span class="line">  &quot;key&quot;: &#123;</span><br><span class="line">      &quot;algo&quot;: &quot;rsa&quot;,</span><br><span class="line">      &quot;size&quot;: 2048</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;names&quot;: [</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;C&quot;: &quot;CN&quot;,</span><br><span class="line">      &quot;ST&quot;: &quot;Hubei&quot;,</span><br><span class="line">      &quot;L&quot;: &quot;Wuhan&quot;,</span><br><span class="line">      &quot;O&quot;: &quot;k8s&quot;,</span><br><span class="line">      &quot;OU&quot;: &quot;system&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  ],</span><br><span class="line">  &quot;ca&quot;: &#123;</span><br><span class="line">          &quot;expiry&quot;: &quot;87600h&quot;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">CN：Common Name（公用名称），kube-apiserver 从证书中提取该字段作为请求的用户名 (User Name)；浏览器使用该字段验证网站是否合法；对于 SSL 证书，一般为网站域名；而对于代码签名证书则为申请单位名称；而对于客户端证书则为证书申请者的姓名。</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">O：Organization（单位名称），kube-apiserver 从证书中提取该字段作为请求用户所属的组 (Group)；对于 SSL 证书，一般为网站域名；而对于代码签名证书则为申请单位名称；而对于客户端单位证书则为证书申请者所在单位名称。</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">L 字段：所在城市</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">S 字段：所在省份</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">C 字段：只能是国家字母缩写，如中国：CN</span></span><br><span class="line"></span><br><span class="line">[root@master1 work]# cfssl gencert -initca ca-csr.json | cfssljson -bare ca</span><br><span class="line">2023/07/17 18:24:49 [INFO] generating a new CA key and certificate from CSR</span><br><span class="line">2023/07/17 18:24:49 [INFO] generate received request</span><br><span class="line">2023/07/17 18:24:49 [INFO] received CSR</span><br><span class="line">2023/07/17 18:24:49 [INFO] generating key: rsa-2048</span><br><span class="line">2023/07/17 18:24:49 [INFO] encoded CSR</span><br><span class="line">2023/07/17 18:24:49 [INFO] signed certificate with serial number 217844315801648044942786609438022401383793351285</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">生成ca证书文件</span></span><br><span class="line">[root@master1 work]# cat ca-config.json </span><br><span class="line">&#123;</span><br><span class="line">  &quot;signing&quot;: &#123;</span><br><span class="line">      &quot;default&quot;: &#123;</span><br><span class="line">          &quot;expiry&quot;: &quot;87600h&quot;</span><br><span class="line">        &#125;,</span><br><span class="line">      &quot;profiles&quot;: &#123;</span><br><span class="line">          &quot;kubernetes&quot;: &#123;</span><br><span class="line">              &quot;usages&quot;: [</span><br><span class="line">                  &quot;signing&quot;,</span><br><span class="line">                  &quot;key encipherment&quot;,</span><br><span class="line">                  &quot;server auth&quot;,</span><br><span class="line">                  &quot;client auth&quot;</span><br><span class="line">              ],</span><br><span class="line">              &quot;expiry&quot;: &quot;87600h&quot;</span><br><span class="line">          &#125;</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>生成etcd证书</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">[root@master1 work]# cat etcd-csr.json</span><br><span class="line">&#123;</span><br><span class="line">  &quot;CN&quot;: &quot;etcd&quot;,</span><br><span class="line">  &quot;hosts&quot;: [</span><br><span class="line">    &quot;127.0.0.1&quot;,</span><br><span class="line">    &quot;192.168.1.180&quot;,</span><br><span class="line">    &quot;192.168.1.181&quot;,</span><br><span class="line">    &quot;192.168.1.182&quot;,</span><br><span class="line">    &quot;192.168.1.199&quot;</span><br><span class="line">  ],</span><br><span class="line">  &quot;key&quot;: &#123;</span><br><span class="line">    &quot;algo&quot;: &quot;rsa&quot;,</span><br><span class="line">    &quot;size&quot;: 2048</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;names&quot;: [&#123;</span><br><span class="line">    &quot;C&quot;: &quot;CN&quot;,</span><br><span class="line">    &quot;ST&quot;: &quot;Hubei&quot;,</span><br><span class="line">    &quot;L&quot;: &quot;Wuhan&quot;,</span><br><span class="line">    &quot;O&quot;: &quot;k8s&quot;,</span><br><span class="line">    &quot;OU&quot;: &quot;system&quot;</span><br><span class="line">  &#125;]</span><br><span class="line">&#125; </span><br><span class="line"></span><br><span class="line">[root@master1 work]# cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=kubernetes etcd-csr.json | cfssljson -bare etcd</span><br><span class="line">2023/07/17 18:28:48 [INFO] generate received request</span><br><span class="line">2023/07/17 18:28:48 [INFO] received CSR</span><br><span class="line">2023/07/17 18:28:48 [INFO] generating key: rsa-2048</span><br><span class="line">2023/07/17 18:28:48 [INFO] encoded CSR</span><br><span class="line">2023/07/17 18:28:48 [INFO] signed certificate with serial number 454088009324202770940629185352283532986074407108</span><br><span class="line">2023/07/17 18:28:48 [WARNING] This certificate lacks a &quot;hosts&quot; field. This makes it unsuitable for</span><br><span class="line">websites. For more information see the Baseline Requirements for the Issuance and Management</span><br><span class="line">of Publicly-Trusted Certificates, v.1.1.6, from the CA/Browser Forum (https://cabforum.org);</span><br><span class="line">specifically, section 10.2.3 (&quot;Information Requirements&quot;).</span><br><span class="line"></span><br><span class="line">[root@master1 work]# ls etcd*.pem</span><br><span class="line">etcd-key.pem  etcd.pem</span><br></pre></td></tr></table></figure>

<ul>
<li>部署etcd集群</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">把 etcd-v3.4.13-linux-amd64.tar.gz 上传到/data/work 目录下</span></span><br><span class="line">[root@master1 work]# tar xf etcd-v3.4.13-linux-amd64.tar.gz </span><br><span class="line"></span><br><span class="line">[root@master1 work]# cp -p etcd-v3.4.13-linux-amd64/etcd* /usr/local/bin/</span><br><span class="line"></span><br><span class="line">[root@master1 work]# scp -r etcd-v3.4.13-linux-amd64/etcd* master2:/usr/local/bin/</span><br><span class="line">   </span><br><span class="line">[root@master1 work]# scp -r etcd-v3.4.13-linux-amd64/etcd* master3:/usr/local/bin/</span><br><span class="line">               </span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">创建配置文件</span></span><br><span class="line">[root@master1 work]# cat etcd.conf </span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">[Member]</span></span><br><span class="line">ETCD_NAME=&quot;etcd1&quot;</span><br><span class="line">ETCD_DATA_DIR=&quot;/var/lib/etcd/default.etcd&quot;</span><br><span class="line">ETCD_LISTEN_PEER_URLS=&quot;https://192.168.1.180:2380&quot;</span><br><span class="line">ETCD_LISTEN_CLIENT_URLS=&quot;https://192.168.1.180:2379,http://127.0.0.1:2379&quot;</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">[Clustering]</span></span><br><span class="line">ETCD_INITIAL_ADVERTISE_PEER_URLS=&quot;https://192.168.1.180:2380&quot;</span><br><span class="line">ETCD_ADVERTISE_CLIENT_URLS=&quot;https://192.168.1.180:2379&quot;</span><br><span class="line">ETCD_INITIAL_CLUSTER=&quot;etcd1=https://192.168.1.180:2380,etcd2=https://192.168.1.181:2380,etcd3=https://192.168.1.182:2380&quot;</span><br><span class="line">ETCD_INITIAL_CLUSTER_TOKEN=&quot;etcd-cluster&quot;</span><br><span class="line">ETCD_INITIAL_CLUSTER_STATE=&quot;new&quot;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">ETCD_NAME：节点名称，集群中唯一</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">ETCD_DATA_DIR：数据目录</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">ETCD_LISTEN_PEER_URLS：集群通信监听地址</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">ETCD_LISTEN_CLIENT_URLS：客户端访问监听地址</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">ETCD_INITIAL_ADVERTISE_PEER_URLS：集群通告地址</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">ETCD_ADVERTISE_CLIENT_URLS：客户端通告地址</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">ETCD_INITIAL_CLUSTER：集群节点地址</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">ETCD_INITIAL_CLUSTER_TOKEN：集群 Token</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">ETCD_INITIAL_CLUSTER_STATE：加入集群的当前状态，new 是新集群，existing 表示加入已有集群</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">创建启动服务文件</span></span><br><span class="line">[root@master1 work]# cat etcd.service </span><br><span class="line">[Unit]</span><br><span class="line">Description=Etcd Server</span><br><span class="line">After=network.target</span><br><span class="line">After=network-online.target</span><br><span class="line">Wants=network-online.target</span><br><span class="line"> </span><br><span class="line">[Service]</span><br><span class="line">Type=notify</span><br><span class="line">EnvironmentFile=-/etc/etcd/etcd.conf</span><br><span class="line">WorkingDirectory=/var/lib/etcd/</span><br><span class="line">ExecStart=/usr/local/bin/etcd \</span><br><span class="line">  --cert-file=/etc/etcd/ssl/etcd.pem \</span><br><span class="line">  --key-file=/etc/etcd/ssl/etcd-key.pem \</span><br><span class="line">  --trusted-ca-file=/etc/etcd/ssl/ca.pem \</span><br><span class="line">  --peer-cert-file=/etc/etcd/ssl/etcd.pem \</span><br><span class="line">  --peer-key-file=/etc/etcd/ssl/etcd-key.pem \</span><br><span class="line">  --peer-trusted-ca-file=/etc/etcd/ssl/ca.pem \</span><br><span class="line">  --peer-client-cert-auth \</span><br><span class="line">  --client-cert-auth</span><br><span class="line">Restart=on-failure</span><br><span class="line">RestartSec=5</span><br><span class="line">LimitNOFILE=65536</span><br><span class="line"> </span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@master1 work]# cp ca*.pem /etc/etcd/ssl/</span><br><span class="line">[root@master1 work]# cp etcd*.pem /etc/etcd/ssl/</span><br><span class="line">[root@master1 work]# cp etcd.conf /etc/etcd/</span><br><span class="line">[root@master1 work]# cp etcd.service /usr/lib/systemd/system/</span><br><span class="line"></span><br><span class="line">[root@master1 work]# for i in master2 master3;do rsync -vaz etcd.conf $i:/etc/etcd/;done</span><br><span class="line"></span><br><span class="line">[root@master1 work]# for i in master2 master3;do rsync -vaz ca*.pem $i:/etc/etcd/ssl/;done</span><br><span class="line"></span><br><span class="line">[root@master1 work]# for i in master2 master3;do rsync -vaz etcd*.pem $i:/etc/etcd/ssl/;done</span><br><span class="line"></span><br><span class="line">[root@master1 work]# for i in master2 master3;do rsync -vaz etcd.service $i:/usr/lib/systemd/system/;done</span><br></pre></td></tr></table></figure>

<ul>
<li>启动etcd集群</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">[root@master1 work]# mkdir -p /var/lib/etcd/default.etcd</span><br><span class="line"></span><br><span class="line">[root@master2 ~]# mkdir -p /var/lib/etcd/default.etcd</span><br><span class="line"></span><br><span class="line">[root@master3 ~]# mkdir -p /var/lib/etcd/default.etcd</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@master2 ~]# vim /etc/etcd/etcd.conf </span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">[Member]</span></span><br><span class="line">ETCD_NAME=&quot;etcd2&quot;</span><br><span class="line">ETCD_DATA_DIR=&quot;/var/lib/etcd/default.etcd&quot;</span><br><span class="line">ETCD_LISTEN_PEER_URLS=&quot;https://192.168.1.181:2380&quot;</span><br><span class="line">ETCD_LISTEN_CLIENT_URLS=&quot;https://192.168.1.181:2379,http://127.0.0.1:2379&quot;</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">[Clustering]</span></span><br><span class="line">ETCD_INITIAL_ADVERTISE_PEER_URLS=&quot;https://192.168.1.181:2380&quot;</span><br><span class="line">ETCD_ADVERTISE_CLIENT_URLS=&quot;https://192.168.1.181:2379&quot;</span><br><span class="line">ETCD_INITIAL_CLUSTER=&quot;etcd1=https://192.168.1.180:2380,etcd2=https://192.168.1.181:2380,etcd3=https://192.168.1.182:2380&quot;</span><br><span class="line">ETCD_INITIAL_CLUSTER_TOKEN=&quot;etcd-cluster&quot;</span><br><span class="line">ETCD_INITIAL_CLUSTER_STATE=&quot;new&quot;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@master3 ~]# vim /etc/etcd/etcd.conf </span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">[Member]</span></span><br><span class="line">ETCD_NAME=&quot;etcd3&quot;</span><br><span class="line">ETCD_DATA_DIR=&quot;/var/lib/etcd/default.etcd&quot;</span><br><span class="line">ETCD_LISTEN_PEER_URLS=&quot;https://192.168.1.182:2380&quot;</span><br><span class="line">ETCD_LISTEN_CLIENT_URLS=&quot;https://192.168.1.182:2379,http://127.0.0.1:2379&quot;</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">[Clustering]</span></span><br><span class="line">ETCD_INITIAL_ADVERTISE_PEER_URLS=&quot;https://192.168.1.182:2380&quot;</span><br><span class="line">ETCD_ADVERTISE_CLIENT_URLS=&quot;https://192.168.1.182:2379&quot;</span><br><span class="line">ETCD_INITIAL_CLUSTER=&quot;etcd1=https://192.168.1.180:2380,etcd2=https://192.168.1.181:2380,etcd3=https://192.168.1.182:2380&quot;</span><br><span class="line">ETCD_INITIAL_CLUSTER_TOKEN=&quot;etcd-cluster&quot;</span><br><span class="line">ETCD_INITIAL_CLUSTER_STATE=&quot;new&quot;</span><br><span class="line"></span><br><span class="line">[root@master1 ~]# systemctl daemon-reload &amp;&amp; systemctl enable etcd.service &amp;&amp; systemctl start etcd.service</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">启动 etcd 的时候，先启动 master1 的 etcd 服务，会一直卡住在启动的状态，然后接着再启动 master2 的 etcd，这样 master1 这个节点 etcd 才会正常起来</span></span><br><span class="line"></span><br><span class="line">[root@master2 ~]# systemctl daemon-reload &amp;&amp; systemctl enable etcd.service &amp;&amp; systemctl start etcd.service</span><br><span class="line"></span><br><span class="line">[root@master3 ~]# systemctl daemon-reload &amp;&amp; systemctl enable etcd.service &amp;&amp; systemctl start etcd.service</span><br></pre></td></tr></table></figure>

<ul>
<li>查看etcd集群</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[root@master1 ~]# ETCDCTL_API=3</span><br><span class="line"></span><br><span class="line">[root@master1 ~]# /usr/local/bin/etcdctl --write-out=table --cacert=/etc/etcd/ssl/ca.pem --cert=/etc/etcd/ssl/etcd.pem --key=/etc/etcd/ssl/etcd-key.pem --endpoints=https://192.168.1.180:2379,https://192.168.1.181:2379,https://192.168.1.182:2379 endpoint health</span><br><span class="line">+----------------------------+--------+-------------+-------+</span><br><span class="line">|          ENDPOINT          | HEALTH |    TOOK     | ERROR |</span><br><span class="line">+----------------------------+--------+-------------+-------+</span><br><span class="line">| https://192.168.1.180:2379 |   true | 10.004032ms |       |</span><br><span class="line">| https://192.168.1.181:2379 |   true | 14.682589ms |       |</span><br><span class="line">| https://192.168.1.182:2379 |   true | 14.800295ms |       |</span><br><span class="line">+----------------------------+--------+-------------+-------+</span><br></pre></td></tr></table></figure>

<h2 id="安装kubernetes组件"><a href="#安装kubernetes组件" class="headerlink" title="安装kubernetes组件"></a>安装kubernetes组件</h2><h3 id="下载安装包"><a href="#下载安装包" class="headerlink" title="下载安装包"></a>下载安装包</h3><ul>
<li><p>二进制包所在的 github 地址如下：</p>
<p> <a target="_blank" rel="noopener" href="https://github.com/kubernetes/kubernetes/blob/master/CHANGELOG/">https://github.com/kubernetes/kubernetes/blob/master/CHANGELOG/</a></p>
</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">把 kubernetes-server-linux-amd64.tar.gz 上传到 xianchaomaster1 上的/data/work 目录下</span></span><br><span class="line">[root@master1 work]# tar xf kubernetes-server-linux-amd64.tar.gz </span><br><span class="line">[root@master1 work]# cd kubernetes/server/bin/</span><br><span class="line"></span><br><span class="line">[root@master1 bin]# cp kube-apiserver kube-controller-manager kube-scheduler kubectl /usr/local/bin/</span><br><span class="line"></span><br><span class="line">[root@master1 bin]# rsync -vaz kube-apiserver kube-controller-manager kube-scheduler kubectl master2:/usr/local/bin/</span><br><span class="line"></span><br><span class="line">[root@master1 bin]# rsync -vaz kube-apiserver kube-controller-manager kube-scheduler kubectl master3:/usr/local/bin/</span><br><span class="line"></span><br><span class="line">[root@master1 bin]#  scp kubelet kube-proxy node1:/usr/local/bin/</span><br><span class="line"></span><br><span class="line">[root@master1 bin]# cd /data/work/</span><br><span class="line"></span><br><span class="line">[root@master1 work]# mkdir -p /etc/kubernetes/ssl</span><br><span class="line">[root@master1 work]# mkdir /var/log/kubernetes</span><br></pre></td></tr></table></figure>

<h3 id="部署apiserver组件"><a href="#部署apiserver组件" class="headerlink" title="部署apiserver组件"></a>部署apiserver组件</h3><blockquote>
<p>启动 TLS Bootstrapping 机制</p>
<p>Master apiserver 启用 TLS 认证后，每个节点的 kubelet 组件都要使用由 apiserver 使用的 CA 签发的有效证书才能与 apiserver 通讯，当 Node 节点很多时，这种客户端证书颁发需要大量工作，同样也会增加集群扩展复杂度。</p>
<p>为了简化流程，Kubernetes 引入了 TLS bootstraping 机制来自动颁发客户端证书，kubelet 会以一个低权限用户自动向 apiserver 申请证书，kubelet 的证书由 apiserver 动态签署。</p>
<p>Bootstrap 是很多系统中都存在的程序，比如 Linux 的 bootstrap，bootstrap 一般都是作为预先配置在开启或者系统启动的时候加载，这可以用来生成一个指定环境。Kubernetes 的 kubelet 在启动时同样可以加载一个这样的配置文件，这个文件的内容类似如下形式：</p>
</blockquote>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">clusters:</span> <span class="literal">null</span></span><br><span class="line"><span class="attr">contexts:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">context:</span></span><br><span class="line">    <span class="attr">cluster:</span> <span class="string">kubernetes</span></span><br><span class="line">    <span class="attr">user:</span> <span class="string">kubelet-bootstra</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">current-context:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Config</span></span><br><span class="line"><span class="attr">preferences:</span> &#123;&#125;</span><br><span class="line"><span class="attr">users:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">kubelet-bootstrap</span></span><br><span class="line">  <span class="attr">user:</span> &#123;&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>TLS bootstrapping 具体引导过程</p>
<p>1.TLS 作用<br>TLS 的作用就是对通讯加密，防止中间人窃听；同时如果证书不信任的话根本就无法与 apiserver 建立连接，更不用提有没有权限向 apiserver 请求指定内容。</p>
<p>2.RBAC 作用<br>当 TLS 解决了通讯问题后，那么权限问题就应由 RBAC 解决(可以使用其他权限模型，如 ABAC)；RBAC 中规定了一个用户或者用户组(subject)具有请求哪些 api 的权限；在配合 TLS 加密的时候，实际上 apiserver 读取客户端证书的 CN 字段作为用户名，读取 O 字段作为用户组.</p>
<p>以上说明：第一，想要与 apiserver 通讯就必须采用由 apiserver CA 签发的证书，这样才能形成信任关系，建立 TLS 连接；第二，可以通过证书的 CN、O 字段来提供 RBAC 所需的用户与用户组。</p>
</blockquote>
<blockquote>
<p>kubelet 首次启动流程</p>
<p>TLS bootstrapping 功能是让 kubelet 组件去 apiserver 申请证书，然后用于连接 apiserver；那么第一次启动时没有证书如何连接 apiserver ?</p>
<p>在 apiserver 配置中指定了一个 token.csv 文件，该文件中是一个预设的用户配置；同时该用户的 Token 和 由 apiserver 的 CA 签发的用户被写入了 kubelet 所使用的 bootstrap.kubeconfig 配置文件中；这样在首次请求时，kubelet 使用 bootstrap.kubeconfig 中被 apiserver CA 签发证书时信任的用户来与 apiserver 建立TLS 通讯，使用 bootstrap.kubeconfig 中的用户 Token 来向 apiserver 声明自己的 RBAC 授权身份.</p>
<p>token.csv 格式:</p>
<p>3940fd7fbb391d1b4d861ad17a1f0613,kubelet-bootstrap,10001,”system:kubelet-bootstrap”</p>
<p>首次启动时，可能与遇到 kubelet 报 401 无权访问 apiserver 的错误；这是因为在默认情况下，kubelet 通过 bootstrap.kubeconfig 中的预设用户 Token 声明了自己的身份，然后创建CSR 请求；但是不要忘记这个用户在我们不处理的情况下他没任何权限的，包括创建 CSR 请求；所以需要创建一个 ClusterRoleBinding，将预设用户 kubelet-bootstrap 与内置的ClusterRole system:node-bootstrapper 绑定到一起，使其能够发起 CSR 请求。</p>
</blockquote>
<ul>
<li>创建token.csv文件</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@master1 work]# cat &gt; token.csv &lt;&lt; EOF</span><br><span class="line"><span class="meta prompt_">$</span><span class="language-bash">(<span class="built_in">head</span> -c 16 /dev/urandom | <span class="built_in">od</span> -An -t x | <span class="built_in">tr</span> -d <span class="string">&#x27; &#x27;</span>),kubelet-bootstrap,10001,<span class="string">&quot;system:kubelet-bootstrap&quot;</span></span></span><br><span class="line">EOF</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">格式：token，用户名，UID，用户组</span></span><br><span class="line">[root@master1 work]# cat token.csv </span><br><span class="line">c13d0ed83fbeb79f18ef50a60f3646e9,kubelet-bootstrap,10001,&quot;system:kubelet-bootstrap&quot;</span><br></pre></td></tr></table></figure>

<ul>
<li>创建csr请求文件</li>
</ul>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">[</span>root@master1 work<span class="punctuation">]</span># cat kube-apiserver-csr.json</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;CN&quot;</span><span class="punctuation">:</span> <span class="string">&quot;kubernetes&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;hosts&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">    <span class="string">&quot;127.0.0.1&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="string">&quot;192.168.1.180&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="string">&quot;192.168.1.181&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="string">&quot;192.168.1.182&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="string">&quot;192.168.1.183&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="string">&quot;192.168.1.199&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="string">&quot;10.255.0.1&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="string">&quot;kubernetes&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="string">&quot;kubernetes.default&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="string">&quot;kubernetes.default.svc&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="string">&quot;kubernetes.default.svc.cluster&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="string">&quot;kubernetes.default.svc.cluster.local&quot;</span></span><br><span class="line">  <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;key&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;algo&quot;</span><span class="punctuation">:</span> <span class="string">&quot;rsa&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;size&quot;</span><span class="punctuation">:</span> <span class="number">2048</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;names&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;C&quot;</span><span class="punctuation">:</span> <span class="string">&quot;CN&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;ST&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Hubei&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;L&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Wuhan&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;O&quot;</span><span class="punctuation">:</span> <span class="string">&quot;k8s&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;OU&quot;</span><span class="punctuation">:</span> <span class="string">&quot;system&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"># 注： 如果 hosts 字段不为空则需要指定授权使用该证书的 IP 或域名列表。 由于该证书后续被kubernetes master 集群使用，需要将 master 节点的 IP 都填上，同时还需要填写 service 网络的首个IP。(一般是 kube-apiserver 指定的 service-cluster-ip-range 网段的第一个 IP，如 <span class="number">10.255</span><span class="number">.0</span><span class="number">.1</span>)</span><br></pre></td></tr></table></figure>

<ul>
<li>生成证书</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[root@master1 work]# cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=kubernetes kube-apiserver-csr.json | cfssljson -bare kube-apiserver</span><br><span class="line">2023/07/17 21:14:49 [INFO] generate received request</span><br><span class="line">2023/07/17 21:14:49 [INFO] received CSR</span><br><span class="line">2023/07/17 21:14:49 [INFO] generating key: rsa-2048</span><br><span class="line">2023/07/17 21:14:49 [INFO] encoded CSR</span><br><span class="line">2023/07/17 21:14:49 [INFO] signed certificate with serial number 60558345437536204224759334781081714276751605494</span><br><span class="line">2023/07/17 21:14:49 [WARNING] This certificate lacks a &quot;hosts&quot; field. This makes it unsuitable for</span><br><span class="line">websites. For more information see the Baseline Requirements for the Issuance and Management</span><br><span class="line">of Publicly-Trusted Certificates, v.1.1.6, from the CA/Browser Forum (https://cabforum.org);</span><br><span class="line">specifically, section 10.2.3 (&quot;Information Requirements&quot;).</span><br></pre></td></tr></table></figure>

<ul>
<li>创建api-server的配置文件</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line">[root@master1 work]<span class="comment"># cat kube-apiserver.conf</span></span><br><span class="line">KUBE_APISERVER_OPTS=<span class="string">&quot;--enable-admission-plugins=NamespaceLifecycle,NodeRestriction,LimitRanger,ServiceAccount,DefaultStorageClass,ResourceQuota \</span></span><br><span class="line"><span class="string">  --anonymous-auth=false \</span></span><br><span class="line"><span class="string">  --bind-address=192.168.1.180 \</span></span><br><span class="line"><span class="string">  --secure-port=6443 \</span></span><br><span class="line"><span class="string">  --advertise-address=192.168.1.180 \</span></span><br><span class="line"><span class="string">  --insecure-port=0 \</span></span><br><span class="line"><span class="string">  --authorization-mode=Node,RBAC \</span></span><br><span class="line"><span class="string">  --runtime-config=api/all=true \</span></span><br><span class="line"><span class="string">  --enable-bootstrap-token-auth \</span></span><br><span class="line"><span class="string">  --service-cluster-ip-range=10.255.0.0/16 \</span></span><br><span class="line"><span class="string">  --token-auth-file=/etc/kubernetes/token.csv \</span></span><br><span class="line"><span class="string">  --service-node-port-range=30000-50000 \</span></span><br><span class="line"><span class="string">  --tls-cert-file=/etc/kubernetes/ssl/kube-apiserver.pem  \</span></span><br><span class="line"><span class="string">  --tls-private-key-file=/etc/kubernetes/ssl/kube-apiserver-key.pem \</span></span><br><span class="line"><span class="string">  --client-ca-file=/etc/kubernetes/ssl/ca.pem \</span></span><br><span class="line"><span class="string">  --kubelet-client-certificate=/etc/kubernetes/ssl/kube-apiserver.pem \</span></span><br><span class="line"><span class="string">  --kubelet-client-key=/etc/kubernetes/ssl/kube-apiserver-key.pem \</span></span><br><span class="line"><span class="string">  --service-account-key-file=/etc/kubernetes/ssl/ca-key.pem \</span></span><br><span class="line"><span class="string">  --service-account-signing-key-file=/etc/kubernetes/ssl/ca-key.pem  \</span></span><br><span class="line"><span class="string">  --service-account-issuer=https://kubernetes.default.svc.cluster.local \</span></span><br><span class="line"><span class="string">  --etcd-cafile=/etc/etcd/ssl/ca.pem \</span></span><br><span class="line"><span class="string">  --etcd-certfile=/etc/etcd/ssl/etcd.pem \</span></span><br><span class="line"><span class="string">  --etcd-keyfile=/etc/etcd/ssl/etcd-key.pem \</span></span><br><span class="line"><span class="string">  --etcd-servers=https://192.168.1.180:2379,https://192.168.1.181:2379,https://192.168.1.182:2379 \</span></span><br><span class="line"><span class="string">  --enable-swagger-ui=true \</span></span><br><span class="line"><span class="string">  --allow-privileged=true \</span></span><br><span class="line"><span class="string">  --apiserver-count=3 \</span></span><br><span class="line"><span class="string">  --audit-log-maxage=30 \</span></span><br><span class="line"><span class="string">  --audit-log-maxbackup=3 \</span></span><br><span class="line"><span class="string">  --audit-log-maxsize=100 \</span></span><br><span class="line"><span class="string">  --audit-log-path=/var/log/kube-apiserver-audit.log \</span></span><br><span class="line"><span class="string">  --event-ttl=1h \</span></span><br><span class="line"><span class="string">  --alsologtostderr=true \</span></span><br><span class="line"><span class="string">  --logtostderr=false \</span></span><br><span class="line"><span class="string">  --log-dir=/var/log/kubernetes \</span></span><br><span class="line"><span class="string">  --v=4&quot;</span></span><br><span class="line">  </span><br><span class="line"><span class="comment"># 注：</span></span><br><span class="line">--logtostderr：启用日志</span><br><span class="line">--v：日志等级</span><br><span class="line">--log-dir：日志目录</span><br><span class="line">--etcd-servers：etcd 集群地址</span><br><span class="line">--bind-address：监听地址</span><br><span class="line">--secure-port：https 安全端口</span><br><span class="line">--advertise-address：集群通告地址</span><br><span class="line">--allow-privileged：启用授权</span><br><span class="line">--service-cluster-ip-range：Service 虚拟 IP 地址段</span><br><span class="line">--enable-admission-plugins：准入控制模块</span><br><span class="line">--authorization-mode：认证授权，启用 RBAC 授权和节点自管理</span><br><span class="line">--enable-bootstrap-token-auth：启用 TLS bootstrap 机制</span><br><span class="line">--token-auth-file：bootstrap token 文件</span><br><span class="line">--service-node-port-range：Service nodeport 类型默认分配端口范围</span><br><span class="line">--kubelet-client-xxx：apiserver 访问 kubelet 客户端证书</span><br><span class="line">--tls-xxx-file：apiserver https 证书</span><br><span class="line">--etcd-xxxfile：连接 Etcd 集群证书 –</span><br><span class="line">-audit-log-xxx：审计日志</span><br></pre></td></tr></table></figure>

<ul>
<li>创建服务启动文件</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">[root@master1 work]# cat kube-apiserver.service </span><br><span class="line">[Unit]</span><br><span class="line">Description=Kubernetes API Server</span><br><span class="line">Documentation=https://github.com/kubernetes/kubernetes</span><br><span class="line">After=etcd.service</span><br><span class="line">Wants=etcd.service</span><br><span class="line"> </span><br><span class="line">[Service]</span><br><span class="line">EnvironmentFile=-/etc/kubernetes/kube-apiserver.conf</span><br><span class="line">ExecStart=/usr/local/bin/kube-apiserver $KUBE_APISERVER_OPTS</span><br><span class="line">Restart=on-failure</span><br><span class="line">RestartSec=5</span><br><span class="line">Type=notify</span><br><span class="line">LimitNOFILE=65536</span><br><span class="line"> </span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br></pre></td></tr></table></figure>

<ul>
<li>将相关文件给master2和master3</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br></pre></td><td class="code"><pre><span class="line">[root@master1 work]# cp ca*.pem /etc/kubernetes/ssl</span><br><span class="line">[root@master1 work]# cp kube-apiserver*.pem /etc/kubernetes/ssl/</span><br><span class="line">[root@master1 work]# cp token.csv /etc/kubernetes/</span><br><span class="line">[root@master1 work]# cp kube-apiserver.conf /etc/kubernetes/</span><br><span class="line">[root@master1 work]# cp kube-apiserver.service /usr/lib/systemd/system/</span><br><span class="line"></span><br><span class="line">[root@master1 work]# rsync -vaz token.csv master2:/etc/kubernetes/</span><br><span class="line"></span><br><span class="line">[root@master1 work]# rsync -vaz token.csv master3:/etc/kubernetes/</span><br><span class="line"></span><br><span class="line">[root@master1 work]# rsync -vaz kube-apiserver*.pem master2:/etc/kubernetes/ssl/</span><br><span class="line"></span><br><span class="line">[root@master1 work]# rsync -vaz kube-apiserver*.pem master3:/etc/kubernetes/ssl/</span><br><span class="line"></span><br><span class="line">[root@master1 work]# rsync -vaz ca*.pem master2:/etc/kubernetes/ssl/</span><br><span class="line"></span><br><span class="line">[root@master1 work]# rsync -vaz ca*.pem master3:/etc/kubernetes/ssl/</span><br><span class="line"></span><br><span class="line">[root@master1 work]# rsync -vaz kube-apiserver.conf master2:/etc/kubernetes/</span><br><span class="line"></span><br><span class="line">[root@master1 work]# rsync -vaz kube-apiserver.conf master3:/etc/kubernetes/</span><br><span class="line"></span><br><span class="line">[root@master1 work]# rsync -vaz kube-apiserver.service master2:/usr/lib/systemd/system/</span><br><span class="line"></span><br><span class="line">[root@master1 work]# rsync -vaz kube-apiserver.service master3:/usr/lib/systemd/system/</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">注：master2 和 master3 配置文件 kube-apiserver.conf 的 IP 地址修改为实际的本机 IP</span></span><br><span class="line">[root@master2 ~]# cat /etc/kubernetes/kube-apiserver.conf</span><br><span class="line">KUBE_APISERVER_OPTS=&quot;--enable-admission-plugins=NamespaceLifecycle,NodeRestriction,LimitRanger,ServiceAccount,DefaultStorageClass,ResourceQuota \</span><br><span class="line">  --anonymous-auth=false \</span><br><span class="line">  --bind-address=192.168.1.181 \</span><br><span class="line">  --secure-port=6443 \</span><br><span class="line">  --advertise-address=192.168.1.181 \</span><br><span class="line">  --insecure-port=0 \</span><br><span class="line">  --authorization-mode=Node,RBAC \</span><br><span class="line">  --runtime-config=api/all=true \</span><br><span class="line">  --enable-bootstrap-token-auth \</span><br><span class="line">  --service-cluster-ip-range=10.255.0.0/16 \</span><br><span class="line">  --token-auth-file=/etc/kubernetes/token.csv \</span><br><span class="line">  --service-node-port-range=30000-50000 \</span><br><span class="line">  --tls-cert-file=/etc/kubernetes/ssl/kube-apiserver.pem  \</span><br><span class="line">  --tls-private-key-file=/etc/kubernetes/ssl/kube-apiserver-key.pem \</span><br><span class="line">  --client-ca-file=/etc/kubernetes/ssl/ca.pem \</span><br><span class="line">  --kubelet-client-certificate=/etc/kubernetes/ssl/kube-apiserver.pem \</span><br><span class="line">  --kubelet-client-key=/etc/kubernetes/ssl/kube-apiserver-key.pem \</span><br><span class="line">  --service-account-key-file=/etc/kubernetes/ssl/ca-key.pem \</span><br><span class="line">  --service-account-signing-key-file=/etc/kubernetes/ssl/ca-key.pem  \</span><br><span class="line">  --service-account-issuer=https://kubernetes.default.svc.cluster.local \</span><br><span class="line">  --etcd-cafile=/etc/etcd/ssl/ca.pem \</span><br><span class="line">  --etcd-certfile=/etc/etcd/ssl/etcd.pem \</span><br><span class="line">  --etcd-keyfile=/etc/etcd/ssl/etcd-key.pem \</span><br><span class="line">  --etcd-servers=https://192.168.1.180:2379,https://192.168.1.181:2379,https://192.168.1.182:2379 \</span><br><span class="line">  --enable-swagger-ui=true \</span><br><span class="line">  --allow-privileged=true \</span><br><span class="line">  --apiserver-count=3 \</span><br><span class="line">  --audit-log-maxage=30 \</span><br><span class="line">  --audit-log-maxbackup=3 \</span><br><span class="line">  --audit-log-maxsize=100 \</span><br><span class="line">  --audit-log-path=/var/log/kube-apiserver-audit.log \</span><br><span class="line">  --event-ttl=1h \</span><br><span class="line">  --alsologtostderr=true \</span><br><span class="line">  --logtostderr=false \</span><br><span class="line">  --log-dir=/var/log/kubernetes \</span><br><span class="line">  --v=4&quot;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@master3 ~]# cat /etc/kubernetes/kube-apiserver.conf</span><br><span class="line">KUBE_APISERVER_OPTS=&quot;--enable-admission-plugins=NamespaceLifecycle,NodeRestriction,LimitRanger,ServiceAccount,DefaultStorageClass,ResourceQuota \</span><br><span class="line">  --anonymous-auth=false \</span><br><span class="line">  --bind-address=192.168.1.182 \</span><br><span class="line">  --secure-port=6443 \</span><br><span class="line">  --advertise-address=192.168.1.182 \</span><br><span class="line">  --insecure-port=0 \</span><br><span class="line">  --authorization-mode=Node,RBAC \</span><br><span class="line">  --runtime-config=api/all=true \</span><br><span class="line">  --enable-bootstrap-token-auth \</span><br><span class="line">  --service-cluster-ip-range=10.255.0.0/16 \</span><br><span class="line">  --token-auth-file=/etc/kubernetes/token.csv \</span><br><span class="line">  --service-node-port-range=30000-50000 \</span><br><span class="line">  --tls-cert-file=/etc/kubernetes/ssl/kube-apiserver.pem  \</span><br><span class="line">  --tls-private-key-file=/etc/kubernetes/ssl/kube-apiserver-key.pem \</span><br><span class="line">  --client-ca-file=/etc/kubernetes/ssl/ca.pem \</span><br><span class="line">  --kubelet-client-certificate=/etc/kubernetes/ssl/kube-apiserver.pem \</span><br><span class="line">  --kubelet-client-key=/etc/kubernetes/ssl/kube-apiserver-key.pem \</span><br><span class="line">  --service-account-key-file=/etc/kubernetes/ssl/ca-key.pem \</span><br><span class="line">  --service-account-signing-key-file=/etc/kubernetes/ssl/ca-key.pem  \</span><br><span class="line">  --service-account-issuer=https://kubernetes.default.svc.cluster.local \</span><br><span class="line">  --etcd-cafile=/etc/etcd/ssl/ca.pem \</span><br><span class="line">  --etcd-certfile=/etc/etcd/ssl/etcd.pem \</span><br><span class="line">  --etcd-keyfile=/etc/etcd/ssl/etcd-key.pem \</span><br><span class="line">  --etcd-servers=https://192.168.1.180:2379,https://192.168.1.181:2379,https://192.168.1.182:2379 \</span><br><span class="line">  --enable-swagger-ui=true \</span><br><span class="line">  --allow-privileged=true \</span><br><span class="line">  --apiserver-count=3 \</span><br><span class="line">  --audit-log-maxage=30 \</span><br><span class="line">  --audit-log-maxbackup=3 \</span><br><span class="line">  --audit-log-maxsize=100 \</span><br><span class="line">  --audit-log-path=/var/log/kube-apiserver-audit.log \</span><br><span class="line">  --event-ttl=1h \</span><br><span class="line">  --alsologtostderr=true \</span><br><span class="line">  --logtostderr=false \</span><br><span class="line">  --log-dir=/var/log/kubernetes \</span><br><span class="line">  --v=4&quot;</span><br></pre></td></tr></table></figure>

<ul>
<li>启动apiserver服务</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">[root@master1 ~]# systemctl daemon-reload &amp;&amp; systemctl enable --now kube-apiserver.service</span><br><span class="line"></span><br><span class="line">[root@master2 ~]# systemctl daemon-reload &amp;&amp; systemctl enable --now kube-apiserver.service</span><br><span class="line"></span><br><span class="line">[root@master3 ~]# systemctl daemon-reload &amp;&amp; systemctl enable --now kube-apiserver.service</span><br><span class="line"></span><br><span class="line">[root@master1 work]# curl --insecure https://192.168.1.180:6443/</span><br><span class="line">&#123;</span><br><span class="line">  &quot;kind&quot;: &quot;Status&quot;,</span><br><span class="line">  &quot;apiVersion&quot;: &quot;v1&quot;,</span><br><span class="line">  &quot;metadata&quot;: &#123;</span><br><span class="line">    </span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;status&quot;: &quot;Failure&quot;,</span><br><span class="line">  &quot;message&quot;: &quot;Unauthorized&quot;,</span><br><span class="line">  &quot;reason&quot;: &quot;Unauthorized&quot;,</span><br><span class="line">  &quot;code&quot;: 401</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">上面看到 401，这个是正常的的状态，还没认证</span></span><br></pre></td></tr></table></figure>

<h3 id="部署kubectl组件"><a href="#部署kubectl组件" class="headerlink" title="部署kubectl组件"></a>部署kubectl组件</h3><blockquote>
<p>Kubectl 是客户端工具，操作 k8s 资源的，如增删改查等。</p>
<p>Kubectl 操作资源的时候，怎么知道连接到哪个集群，需要一个文件/etc/kubernetes/admin.conf，kubectl会根据这个文件的配置，去访问 k8s 资源。/etc/kubernetes/admin.con 文件记录了访问的 k8s 集群，和用到的证书。</p>
<p>可以设置一个环境变量 KUBECONFIG<br>export KUBECONFIG =/etc/kubernetes/admin.conf<br>这样在操作 kubectl，就会自动加载 KUBECONFIG 来操作要管理哪个集群的 k8s 资源了</p>
<p>也可以按照下面方法，这个是在 kubeadm 初始化 k8s 的时候会告诉我们要用的一个方法<br> cp /etc/kubernetes/admin.conf /root/.kube/config<br>这样我们在执行 kubectl，就会加载/root/.kube/config 文件，去操作 k8s 资源了</p>
<p>如果设置了 KUBECONFIG，那就会先找到 KUBECONFIG 去操作 k8s，如果没有 KUBECONFIG 变量，那就会使用/root/.kube/config 文件决定管理哪个 k8s 集群的资源</p>
</blockquote>
<ul>
<li>创建csr请求文件</li>
</ul>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">[</span>root@master1 work<span class="punctuation">]</span># cat admin-csr.json </span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;CN&quot;</span><span class="punctuation">:</span> <span class="string">&quot;admin&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;hosts&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;key&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;algo&quot;</span><span class="punctuation">:</span> <span class="string">&quot;rsa&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;size&quot;</span><span class="punctuation">:</span> <span class="number">2048</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;names&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;C&quot;</span><span class="punctuation">:</span> <span class="string">&quot;CN&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;ST&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Hubei&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;L&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Wuhan&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;O&quot;</span><span class="punctuation">:</span> <span class="string">&quot;system:masters&quot;</span><span class="punctuation">,</span>             </span><br><span class="line">      <span class="attr">&quot;OU&quot;</span><span class="punctuation">:</span> <span class="string">&quot;system&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>说明： 后续 kube-apiserver 使用 RBAC 对客户端(如 kubelet、kube-proxy、Pod)请求进行授权；kube-apiserver 预 定 义 了 一 些 RBAC 使 用 的 RoleBindings ， 如 cluster-admin 将 Group system:masters 与 Role cluster-admin 绑定，该 Role 授予了调用 kube-apiserver 的所有 API 的权限； O 指定该证书的 Group 为 system:masters，kubelet 使用该证书访问 kube-apiserver 时 ，由于证书被 CA 签名，所以认证通过，同时由于证书用户组为经过预授权的 system:masters，所以被授予访问所有 API 的权限；</p>
<p>注： 这个 admin 证书，是将来生成管理员用的 kube config 配置文件用的，现在我们一般建议使用 RBAC 来对 kubernetes 进行角色权限控制，kubernetes 将证书中的 CN 字段 作为 User，O 字段作为 Group；”O”: “system:masters”, 必须是 system:masters，否则后面 kubectl create clusterrolebinding 报错。</p>
<p>证书 O 配置为 system:masters 在集群内部 cluster-admin 的 clusterrolebinding 将system:masters 组和 cluster-admin clusterrole 绑定在一起</p>
</blockquote>
<ul>
<li>生成证书</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[root@master1 work]# cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=kubernetes admin-csr.json | cfssljson -bare admin</span><br><span class="line">2023/07/18 09:36:33 [INFO] generate received request</span><br><span class="line">2023/07/18 09:36:33 [INFO] received CSR</span><br><span class="line">2023/07/18 09:36:33 [INFO] generating key: rsa-2048</span><br><span class="line">2023/07/18 09:36:33 [INFO] encoded CSR</span><br><span class="line">2023/07/18 09:36:33 [INFO] signed certificate with serial number 590504316254400223853731101622257961862372429191</span><br><span class="line">2023/07/18 09:36:33 [WARNING] This certificate lacks a &quot;hosts&quot; field. This makes it unsuitable for</span><br><span class="line">websites. For more information see the Baseline Requirements for the Issuance and Management</span><br><span class="line">of Publicly-Trusted Certificates, v.1.1.6, from the CA/Browser Forum (https://cabforum.org);</span><br><span class="line">specifically, section 10.2.3 (&quot;Information Requirements&quot;).</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@master1 work]# cp admin*.pem /etc/kubernetes/ssl/</span><br></pre></td></tr></table></figure>

<ul>
<li>配置安全上下文</li>
</ul>
<blockquote>
<p>创建 kubeconfig 配置文件，比较重要</p>
<p>kubeconfig 为 kubectl 的配置文件，包含访问 apiserver 的所有信息，如 apiserver 地址、CA 证书和自身使用的证书（这里如果报错找不到 kubeconfig 路径，请手动复制到相应路径下，没有则忽略）</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">设置集群参数</span></span><br><span class="line">[root@master1 work]# kubectl config set-cluster kubernetes --certificate-authority=ca.pem --embed-certs=true --server=https://192.168.1.180:6443 --kubeconfig=kube.config</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">设置客户端认证参数</span></span><br><span class="line">[root@master1 work]# kubectl config set-credentials admin --client-certificate=admin.pem --client-key=admin-key.pem --embed-certs=true --kubeconfig=kube.config</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">设置上下文</span></span><br><span class="line">[root@master1 work]# kubectl config set-context kubernetes --cluster=kubernetes --user=admin --kubeconfig=kube.config</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">设置当前上下文</span></span><br><span class="line">[root@master1 work]# kubectl config use-context kubernetes --kubeconfig=kube.config</span><br><span class="line"></span><br><span class="line">[root@master1 work]# mkdir ~/.kube -p</span><br><span class="line"></span><br><span class="line">[root@master1 work]# cp kube.config ~/.kube/config</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">授权kubernetes证书访问kubelet api权限</span></span><br><span class="line">[root@master1 work]# kubectl create clusterrolebinding kube-apiserver:kubelet-apis --clusterrole=system:kubelet-api-admin --user kubernetes</span><br></pre></td></tr></table></figure>

<ul>
<li>查看集群组件状态</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">[root@master1 work]# kubectl cluster-info</span><br><span class="line">Kubernetes control plane is running at https://192.168.1.180:6443</span><br><span class="line"></span><br><span class="line">To further debug and diagnose cluster problems, use &#x27;kubectl cluster-info dump&#x27;.</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@master1 work]# kubectl get componentstatuses</span><br><span class="line">Warning: v1 ComponentStatus is deprecated in v1.19+</span><br><span class="line">NAME                 STATUS      MESSAGE                                                                                       ERROR</span><br><span class="line">scheduler            Unhealthy   Get &quot;http://127.0.0.1:10251/healthz&quot;: dial tcp 127.0.0.1:10251: connect: connection refused   </span><br><span class="line">controller-manager   Unhealthy   Get &quot;http://127.0.0.1:10252/healthz&quot;: dial tcp 127.0.0.1:10252: connect: connection refused   </span><br><span class="line">etcd-2               Healthy     &#123;&quot;health&quot;:&quot;true&quot;&#125;                                                                             </span><br><span class="line">etcd-1               Healthy     &#123;&quot;health&quot;:&quot;true&quot;&#125;                                                                             </span><br><span class="line">etcd-0               Healthy     &#123;&quot;health&quot;:&quot;true&quot;&#125;                                                                       </span><br><span class="line"></span><br><span class="line">[root@master1 work]# kubectl get all --all-namespaces</span><br><span class="line">NAMESPACE   NAME                 TYPE        CLUSTER-IP   EXTERNAL-IP   PORT(S)   AGE</span><br><span class="line">default     service/kubernetes   ClusterIP   10.255.0.1   &lt;none&gt;        443/TCP   12h</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ul>
<li>同步kubectl文件到其他节点</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@master2 ~]# mkdir /root/.kube/</span><br><span class="line">[root@master3 ~]# mkdir /root/.kube/</span><br><span class="line"></span><br><span class="line">[root@master1 work]# rsync -vaz /root/.kube/config master2:/root/.kube/</span><br><span class="line"></span><br><span class="line">[root@master1 work]# rsync -vaz /root/.kube/config master3:/root/.kube/</span><br></pre></td></tr></table></figure>

<ul>
<li>配置kubectl子命令补全</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">yum install -y bash-completion</span><br><span class="line"></span><br><span class="line">source /usr/share/bash-completion/bash_completion</span><br><span class="line"></span><br><span class="line">source &lt;(kubectl completion bash)</span><br><span class="line"></span><br><span class="line">kubectl completion bash &gt; ~/.kube/completion.bash.inc</span><br><span class="line"></span><br><span class="line">source &#x27;/root/.kube/completion.bash.inc&#x27;</span><br><span class="line"></span><br><span class="line">source $HOME/.bash_profile</span><br></pre></td></tr></table></figure>

<ul>
<li><p>kuberctl官方备忘单</p>
<p><a target="_blank" rel="noopener" href="https://kubernetes.io/zh/docs/reference/kubectl/cheatsheet/">https://kubernetes.io/zh/docs/reference/kubectl/cheatsheet/</a></p>
</li>
</ul>
<h3 id="部署-kube-controller-manager-组件"><a href="#部署-kube-controller-manager-组件" class="headerlink" title="部署 kube-controller-manager 组件"></a>部署 kube-controller-manager 组件</h3><ul>
<li>创建csr请求文件</li>
</ul>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">[</span>root@master1 work<span class="punctuation">]</span># cat kube-controller-manager-csr.json</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;CN&quot;</span><span class="punctuation">:</span> <span class="string">&quot;system:kube-controller-manager&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;key&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;algo&quot;</span><span class="punctuation">:</span> <span class="string">&quot;rsa&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;size&quot;</span><span class="punctuation">:</span> <span class="number">2048</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;hosts&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">      <span class="string">&quot;127.0.0.1&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="string">&quot;192.168.1.180&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="string">&quot;192.168.1.181&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="string">&quot;192.168.1.182&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="string">&quot;192.168.1.199&quot;</span></span><br><span class="line">    <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;names&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">      <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;C&quot;</span><span class="punctuation">:</span> <span class="string">&quot;CN&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;ST&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Hubei&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;L&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Wuhan&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;O&quot;</span><span class="punctuation">:</span> <span class="string">&quot;system:kube-controller-manager&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;OU&quot;</span><span class="punctuation">:</span> <span class="string">&quot;system&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>注： hosts 列表包含所有 kube-controller-manager 节点 IP； CN 为 system:kube-controller-manager、O 为 system:kube-controller-manager，kubernetes 内置的 ClusterRoleBindings system:kube-controller-manager 赋予 kube-controller-manager 工作所需的权限</p>
</blockquote>
<ul>
<li>生成证书</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[root@master1 work]# cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=kubernetes kube-controller-manager-csr.json | cfssljson -bare kube-controller-manager</span><br><span class="line">2023/07/18 09:55:46 [INFO] generate received request</span><br><span class="line">2023/07/18 09:55:46 [INFO] received CSR</span><br><span class="line">2023/07/18 09:55:46 [INFO] generating key: rsa-2048</span><br><span class="line">2023/07/18 09:55:47 [INFO] encoded CSR</span><br><span class="line">2023/07/18 09:55:47 [INFO] signed certificate with serial number 28384387730590989137248799757595047228060784622</span><br><span class="line">2023/07/18 09:55:47 [WARNING] This certificate lacks a &quot;hosts&quot; field. This makes it unsuitable for</span><br><span class="line">websites. For more information see the Baseline Requirements for the Issuance and Management</span><br><span class="line">of Publicly-Trusted Certificates, v.1.1.6, from the CA/Browser Forum (https://cabforum.org);</span><br><span class="line">specifically, section 10.2.3 (&quot;Information Requirements&quot;).</span><br></pre></td></tr></table></figure>

<ul>
<li>创建kube-controller-manager的kubeconfig</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">设置集群参数</span></span><br><span class="line">[root@master1 work]# kubectl config set-cluster kubernetes --certificate-authority=ca.pem --embed-certs=true --server=https://192.168.1.180:6443 --kubeconfig=kube-controller-manager.kubeconfig</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">设置客户端认证参数</span></span><br><span class="line">[root@master1 work]# kubectl config set-credentials system:kube-controller-manager --client-certificate=kube-controller-manager.pem --client-key=kube-controller-manager-key.pem --embed-certs=true --kubeconfig=kube-controller-manager.kubeconfig</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">设置上下文参数</span></span><br><span class="line">[root@master1 work]# kubectl config set-context system:kube-controller-manager --cluster=kubernetes --user=system:kube-controller-manager --kubeconfig=kube-controller-manager.kubeconfig</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">设置当前上下文</span></span><br><span class="line">[root@master1 work]# kubectl config use-context system:kube-controller-manager --kubeconfig=kube-controller-manager.kubeconfig</span><br></pre></td></tr></table></figure>

<ul>
<li>创建配置文件kube-controller-manager.conf</li>
</ul>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">[</span>root@master1 work<span class="punctuation">]</span># cat kube-controller-manager.conf</span><br><span class="line">KUBE_CONTROLLER_MANAGER_OPTS=<span class="string">&quot;--port=0 \</span></span><br><span class="line"><span class="string">  --secure-port=10252 \</span></span><br><span class="line"><span class="string">  --bind-address=127.0.0.1 \</span></span><br><span class="line"><span class="string">  --kubeconfig=/etc/kubernetes/kube-controller-manager.kubeconfig \</span></span><br><span class="line"><span class="string">  --service-cluster-ip-range=10.255.0.0/16 \</span></span><br><span class="line"><span class="string">  --cluster-name=kubernetes \</span></span><br><span class="line"><span class="string">  --cluster-signing-cert-file=/etc/kubernetes/ssl/ca.pem \</span></span><br><span class="line"><span class="string">  --cluster-signing-key-file=/etc/kubernetes/ssl/ca-key.pem \</span></span><br><span class="line"><span class="string">  --allocate-node-cidrs=true \</span></span><br><span class="line"><span class="string">  --cluster-cidr=10.0.0.0/16 \</span></span><br><span class="line"><span class="string">  --experimental-cluster-signing-duration=87600h \</span></span><br><span class="line"><span class="string">  --root-ca-file=/etc/kubernetes/ssl/ca.pem \</span></span><br><span class="line"><span class="string">  --service-account-private-key-file=/etc/kubernetes/ssl/ca-key.pem \</span></span><br><span class="line"><span class="string">  --leader-elect=true \</span></span><br><span class="line"><span class="string">  --feature-gates=RotateKubeletServerCertificate=true \</span></span><br><span class="line"><span class="string">  --controllers=*,bootstrapsigner,tokencleaner \</span></span><br><span class="line"><span class="string">  --horizontal-pod-autoscaler-use-rest-clients=true \</span></span><br><span class="line"><span class="string">  --horizontal-pod-autoscaler-sync-period=10s \</span></span><br><span class="line"><span class="string">  --tls-cert-file=/etc/kubernetes/ssl/kube-controller-manager.pem \</span></span><br><span class="line"><span class="string">  --tls-private-key-file=/etc/kubernetes/ssl/kube-controller-manager-key.pem \</span></span><br><span class="line"><span class="string">  --use-service-account-credentials=true \</span></span><br><span class="line"><span class="string">  --alsologtostderr=true \</span></span><br><span class="line"><span class="string">  --logtostderr=false \</span></span><br><span class="line"><span class="string">  --log-dir=/var/log/kubernetes \</span></span><br><span class="line"><span class="string">  --v=2&quot;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ul>
<li>创建启动文件</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root@master1 work]# cat kube-controller-manager.service </span><br><span class="line">[Unit]</span><br><span class="line">Description=Kubernetes Controller Manager</span><br><span class="line">Documentation=https://github.com/kubernetes/kubernetes</span><br><span class="line">[Service]</span><br><span class="line">EnvironmentFile=-/etc/kubernetes/kube-controller-manager.conf</span><br><span class="line">ExecStart=/usr/local/bin/kube-controller-manager $KUBE_CONTROLLER_MANAGER_OPTS</span><br><span class="line">Restart=on-failure</span><br><span class="line">RestartSec=5</span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br></pre></td></tr></table></figure>

<ul>
<li>启动服务</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">[root@master1 work]# cp kube-controller-manager*.pem /etc/kubernetes/ssl/</span><br><span class="line">[root@master1 work]# cp kube-controller-manager.kubeconfig /etc/kubernetes/</span><br><span class="line">[root@master1 work]# cp kube-controller-manager.conf /etc/kubernetes/</span><br><span class="line">[root@master1 work]# cp kube-controller-manager.service /usr/lib/systemd/system/</span><br><span class="line"></span><br><span class="line">[root@master1 work]# rsync -vaz kube-controller-manager*.pem master2:/etc/kubernetes/ssl/</span><br><span class="line"></span><br><span class="line">[root@master1 work]# rsync -vaz kube-controller-manager*.pem master3:/etc/kubernetes/ssl/</span><br><span class="line"></span><br><span class="line">[root@master1 work]# rsync -vaz kube-controller-manager.kubeconfig kube-controller-manager.conf master2:/etc/kubernetes/</span><br><span class="line"></span><br><span class="line">[root@master1 work]# rsync -vaz kube-controller-manager.kubeconfig kube-controller-manager.conf master3:/etc/kubernetes/</span><br><span class="line"></span><br><span class="line">[root@master1 work]# rsync -vaz kube-controller-manager.service master2:/usr/lib/systemd/system/</span><br><span class="line"></span><br><span class="line">[root@master1 work]# rsync -vaz kube-controller-manager.service master3:/usr/lib/systemd/system/</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@master1 work]# systemctl daemon-reload &amp;&amp; systemctl enable --now kube-controller-manager.service &amp;&amp; systemctl status kube-controller-manager.service </span><br><span class="line"></span><br><span class="line">Active: active (running) since</span><br><span class="line"></span><br><span class="line">[root@master2 ~]# systemctl daemon-reload &amp;&amp; systemctl enable --now kube-controller-manager.service &amp;&amp; systemctl status kube-controller-manager.service</span><br><span class="line"></span><br><span class="line">Active: active (running) since</span><br><span class="line"></span><br><span class="line">[root@master3 ~]# systemctl daemon-reload &amp;&amp; systemctl enable --now kube-controller-manager.service &amp;&amp; systemctl status kube-controller-manager.service</span><br><span class="line"></span><br><span class="line">Active: active (running) since</span><br></pre></td></tr></table></figure>

<h3 id="部署kube-scheduler组件"><a href="#部署kube-scheduler组件" class="headerlink" title="部署kube-scheduler组件"></a>部署kube-scheduler组件</h3><ul>
<li>创建csr请求</li>
</ul>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">[</span>root@master1 work<span class="punctuation">]</span># cat kube-scheduler-csr.json</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;CN&quot;</span><span class="punctuation">:</span> <span class="string">&quot;system:kube-scheduler&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;hosts&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">      <span class="string">&quot;127.0.0.1&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="string">&quot;192.168.1.180&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="string">&quot;192.168.1.181&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="string">&quot;192.168.1.182&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="string">&quot;192.168.1.199&quot;</span></span><br><span class="line">    <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;key&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;algo&quot;</span><span class="punctuation">:</span> <span class="string">&quot;rsa&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;size&quot;</span><span class="punctuation">:</span> <span class="number">2048</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;names&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">      <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;C&quot;</span><span class="punctuation">:</span> <span class="string">&quot;CN&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;ST&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Hubei&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;L&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Wuhan&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;O&quot;</span><span class="punctuation">:</span> <span class="string">&quot;system:kube-scheduler&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;OU&quot;</span><span class="punctuation">:</span> <span class="string">&quot;system&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<ul>
<li>生成证书</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[root@master1 work]# cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=kubernetes kube-scheduler-csr.json | cfssljson -bare kube-scheduler</span><br><span class="line">2023/07/18 10:11:29 [INFO] generate received request</span><br><span class="line">2023/07/18 10:11:29 [INFO] received CSR</span><br><span class="line">2023/07/18 10:11:29 [INFO] generating key: rsa-2048</span><br><span class="line">2023/07/18 10:11:30 [INFO] encoded CSR</span><br><span class="line">2023/07/18 10:11:30 [INFO] signed certificate with serial number 555324633751814240953910934040569183966634377630</span><br><span class="line">2023/07/18 10:11:30 [WARNING] This certificate lacks a &quot;hosts&quot; field. This makes it unsuitable for</span><br><span class="line">websites. For more information see the Baseline Requirements for the Issuance and Management</span><br><span class="line">of Publicly-Trusted Certificates, v.1.1.6, from the CA/Browser Forum (https://cabforum.org);</span><br><span class="line">specifically, section 10.2.3 (&quot;Information Requirements&quot;).</span><br></pre></td></tr></table></figure>

<ul>
<li>创建kube-scheduler的kubeconfig</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">设置集群参数</span></span><br><span class="line">[root@master1 work]# kubectl config set-cluster kubernetes --certificate-authority=ca.pem --embed-certs=true --server=https://192.168.1.180:6443 --kubeconfig=kube-scheduler.kubeconfig</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">设置客户端认证参数</span></span><br><span class="line">[root@master1 work]# kubectl config set-credentials system:kube-scheduler --client-certificate=kube-scheduler.pem --client-key=kube-scheduler-key.pem --embed-certs=true --kubeconfig=kube-scheduler.kubeconfig</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">设置上下文参数</span></span><br><span class="line">[root@master1 work]# kubectl config set-context system:kube-scheduler --cluster=kubernetes --user=system:kube-scheduler --kubeconfig=kube-scheduler.kubeconfig</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">设置当前上下文</span></span><br><span class="line">[root@master1 work]# kubectl config use-context system:kube-scheduler --kubeconfig=kube-scheduler.kubeconfig</span><br></pre></td></tr></table></figure>

<ul>
<li>创建配置文件kube-scheduler.conf</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@master1 work]# cat kube-scheduler.conf </span><br><span class="line">KUBE_SCHEDULER_OPTS=&quot;--address=127.0.0.1 \</span><br><span class="line">--kubeconfig=/etc/kubernetes/kube-scheduler.kubeconfig \</span><br><span class="line">--leader-elect=true \</span><br><span class="line">--alsologtostderr=true \</span><br><span class="line">--logtostderr=false \</span><br><span class="line">--log-dir=/var/log/kubernetes \</span><br><span class="line">--v=2&quot;</span><br></pre></td></tr></table></figure>

<ul>
<li>创建服务启动文件</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[root@master1 work]# cat kube-scheduler.service </span><br><span class="line">[Unit]</span><br><span class="line">Description=Kubernetes Scheduler</span><br><span class="line">Documentation=https://github.com/kubernetes/kubernetes</span><br><span class="line"> </span><br><span class="line">[Service]</span><br><span class="line">EnvironmentFile=-/etc/kubernetes/kube-scheduler.conf</span><br><span class="line">ExecStart=/usr/local/bin/kube-scheduler $KUBE_SCHEDULER_OPTS</span><br><span class="line">Restart=on-failure</span><br><span class="line">RestartSec=5</span><br><span class="line"> </span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br></pre></td></tr></table></figure>

<ul>
<li>启动服务</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">[root@master1 work]# cp kube-scheduler*.pem /etc/kubernetes/ssl/</span><br><span class="line">[root@master1 work]# cp kube-scheduler.kubeconfig /etc/kubernetes/</span><br><span class="line">[root@master1 work]# cp kube-scheduler.conf /etc/kubernetes/</span><br><span class="line">[root@master1 work]# cp kube-scheduler.service /usr/lib/systemd/system/</span><br><span class="line"></span><br><span class="line">[root@master1 work]# rsync -vaz kube-scheduler*.pem master2:/etc/kubernetes/ssl/</span><br><span class="line"></span><br><span class="line">[root@master1 work]# rsync -vaz kube-scheduler*.pem master3:/etc/kubernetes/ssl/</span><br><span class="line"></span><br><span class="line">[root@master1 work]# rsync -vaz kube-scheduler.kubeconfig kube-scheduler.conf master2:/etc/kubernetes/</span><br><span class="line"></span><br><span class="line">[root@master1 work]# rsync -vaz kube-scheduler.kubeconfig kube-scheduler.conf master3:/etc/kubernetes/</span><br><span class="line"></span><br><span class="line">[root@master1 work]# rsync -vaz kube-scheduler.service master2:/usr/lib/systemd/system/</span><br><span class="line"></span><br><span class="line">[root@master1 work]# rsync -vaz kube-scheduler.service master3:/usr/lib/systemd/system/</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@master1 work]# systemctl daemon-reload &amp;&amp; systemctl enable --now kube-scheduler.service &amp;&amp; systemctl status kube-scheduler.service </span><br><span class="line"></span><br><span class="line">[root@master2 ~]# systemctl daemon-reload &amp;&amp; systemctl enable --now kube-scheduler.service &amp;&amp; systemctl status kube-scheduler.service</span><br><span class="line"></span><br><span class="line">[root@master3 ~]# systemctl daemon-reload &amp;&amp; systemctl enable --now kube-scheduler.service &amp;&amp; systemctl status kube-scheduler.service</span><br></pre></td></tr></table></figure>

<h3 id="导入离线镜像压缩包"><a href="#导入离线镜像压缩包" class="headerlink" title="导入离线镜像压缩包"></a>导入离线镜像压缩包</h3><blockquote>
<p>把 pause-cordns.tar.gz 上传到 node1 节点，手动解压</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@node1 ~]# docker load -i pause-cordns.tar.gz</span><br></pre></td></tr></table></figure>

<h3 id="部署kubelet组件"><a href="#部署kubelet组件" class="headerlink" title="部署kubelet组件"></a>部署kubelet组件</h3><blockquote>
<p>kubelet： 每个 Node 节点上的 kubelet 定期就会调用 API Server 的 REST 接口报告自身状态，API Server接收这些信息后，将节点状态信息更新到 etcd 中。kubelet 也通过 API Server 监听 Pod 信息，从而对 Node机器上的 POD 进行管理，如创建、删除、更新 Pod</p>
</blockquote>
<ul>
<li>创建 kubelet-bootstrap.kubeconfig</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[root@master1 work]# BOOTSTRAP_TOKEN=$(awk -F &quot;,&quot; &#x27;&#123;print $1&#125;&#x27; /etc/kubernetes/token.csv)</span><br><span class="line">[root@master1 work]# echo $BOOTSTRAP_TOKEN</span><br><span class="line">c13d0ed83fbeb79f18ef50a60f3646e9</span><br><span class="line"></span><br><span class="line">[root@master1 work]# rm -r kubelet-bootstrap.kubeconfig</span><br><span class="line"></span><br><span class="line">[root@master1 work]# kubectl config set-cluster kubernetes --certificate-authority=ca.pem --embed-certs=true --server=https://192.168.1.180:6443 --kubeconfig=kubelet-bootstrap.kubeconfig</span><br><span class="line"></span><br><span class="line">[root@master1 work]# kubectl config set-credentials kubelet-bootstrap --token=$&#123;BOOTSTRAP_TOKEN&#125; --kubeconfig=kubelet-bootstrap.kubeconfig</span><br><span class="line"></span><br><span class="line">[root@master1 work]# kubectl config set-context default --cluster=kubernetes --user=kubelet-bootstrap --kubeconfig=kubelet-bootstrap.kubeconfig</span><br><span class="line"></span><br><span class="line">[root@master1 work]# kubectl config use-context default --kubeconfig=kubelet-bootstrap.kubeconfig</span><br><span class="line"></span><br><span class="line">[root@master1 work]# kubectl create clusterrolebinding kubelet-bootstrap --clusterrole=system:node-bootstrapper --user=kubelet-bootstrap</span><br></pre></td></tr></table></figure>

<ul>
<li>创建配置文件kubelet.json</li>
</ul>
<blockquote>
<p>“cgroupDriver”: “systemd”要和 docker 的驱动一致</p>
</blockquote>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">[</span>root@master1 work<span class="punctuation">]</span># cat kubelet.json</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;kind&quot;</span><span class="punctuation">:</span> <span class="string">&quot;KubeletConfiguration&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;apiVersion&quot;</span><span class="punctuation">:</span> <span class="string">&quot;kubelet.config.k8s.io/v1beta1&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;authentication&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;x509&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;clientCAFile&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/etc/kubernetes/ssl/ca.pem&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;webhook&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;enabled&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;cacheTTL&quot;</span><span class="punctuation">:</span> <span class="string">&quot;2m0s&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;anonymous&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;enabled&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;authorization&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;mode&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Webhook&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;webhook&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;cacheAuthorizedTTL&quot;</span><span class="punctuation">:</span> <span class="string">&quot;5m0s&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;cacheUnauthorizedTTL&quot;</span><span class="punctuation">:</span> <span class="string">&quot;30s&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;address&quot;</span><span class="punctuation">:</span> <span class="string">&quot;192.168.1.183&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;port&quot;</span><span class="punctuation">:</span> <span class="number">10250</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;readOnlyPort&quot;</span><span class="punctuation">:</span> <span class="number">10255</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;cgroupDriver&quot;</span><span class="punctuation">:</span> <span class="string">&quot;systemd&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;hairpinMode&quot;</span><span class="punctuation">:</span> <span class="string">&quot;promiscuous-bridge&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;serializeImagePulls&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;featureGates&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;RotateKubeletClientCertificate&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;RotateKubeletServerCertificate&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;clusterDomain&quot;</span><span class="punctuation">:</span> <span class="string">&quot;cluster.local.&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;clusterDNS&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;10.255.0.2&quot;</span><span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"></span><br><span class="line"># 注：kubelete.json 配置文件 address 改为各个节点的 ip 地址，在各个 work 节点上启动服务</span><br></pre></td></tr></table></figure>

<ul>
<li>创建服务启动文件</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">[root@master1 work]# cat kubelet.service </span><br><span class="line">[Unit]</span><br><span class="line">Description=Kubernetes Kubelet</span><br><span class="line">Documentation=https://github.com/kubernetes/kubernetes</span><br><span class="line">After=docker.service</span><br><span class="line">Requires=docker.service</span><br><span class="line">[Service]</span><br><span class="line">WorkingDirectory=/var/lib/kubelet</span><br><span class="line">ExecStart=/usr/local/bin/kubelet \</span><br><span class="line">  --bootstrap-kubeconfig=/etc/kubernetes/kubelet-bootstrap.kubeconfig \</span><br><span class="line">  --cert-dir=/etc/kubernetes/ssl \</span><br><span class="line">  --kubeconfig=/etc/kubernetes/kubelet.kubeconfig \</span><br><span class="line">  --config=/etc/kubernetes/kubelet.json \</span><br><span class="line">  --network-plugin=cni \</span><br><span class="line">  --pod-infra-container-image=k8s.gcr.io/pause:3.2 \</span><br><span class="line">  --alsologtostderr=true \</span><br><span class="line">  --logtostderr=false \</span><br><span class="line">  --log-dir=/var/log/kubernetes \</span><br><span class="line">  --v=2</span><br><span class="line">Restart=on-failure</span><br><span class="line">RestartSec=5</span><br><span class="line"> </span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">注：</span> </span><br><span class="line">-hostname-override：显示名称，集群中唯一</span><br><span class="line">-network-plugin：启用 CNI </span><br><span class="line">-kubeconfig：空路径，会自动生成，后面用于连接 apiserver </span><br><span class="line">-bootstrap-kubeconfig：首次启动向 apiserver 申请证书</span><br><span class="line">-config：配置参数文件</span><br><span class="line">-cert-dir：kubelet 证书生成目录</span><br><span class="line">-pod-infra-container-image：管理 Pod 网络容器的镜像</span><br></pre></td></tr></table></figure>

<ul>
<li>启动服务</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">[root@node1 ~]# mkdir /etc/kubernetes/ssl -p</span><br><span class="line"></span><br><span class="line">[root@master1 work]# scp kubelet-bootstrap.kubeconfig kubelet.json node1:/etc/kubernetes/</span><br><span class="line">[root@master1 work]# scp ca.pem node1:/etc/kubernetes/ssl/</span><br><span class="line">[root@master1 work]# scp kubelet.service node1:/usr/lib/systemd/system/</span><br><span class="line"></span><br><span class="line">[root@node1 ~]# mkdir /var/lib/kubelet</span><br><span class="line">[root@node1 ~]# mkdir /var/log/kubernetes</span><br><span class="line"></span><br><span class="line">[root@node1 ~]# systemctl daemon-reload &amp;&amp; systemctl enable --now kubelet.service &amp;&amp; systemctl status kubelet.service</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">确认 kubelet 服务启动成功后，接着到 master1 节点上 Approve 一下 bootstrap 请求。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">执行如下命令可以看到一个 worker 节点发送了一个 CSR 请求</span></span><br><span class="line"></span><br><span class="line">[root@master1 work]# kubectl get csr</span><br><span class="line">NAME                                                   AGE   SIGNERNAME                                    REQUESTOR           CONDITION</span><br><span class="line">node-csr-QRwNdc_yv-IPt19eqKmAcyrLnDv86x31pubdK3vLTGI   46s   kubernetes.io/kube-apiserver-client-kubelet   kubelet-bootstrap   Pending</span><br><span class="line"></span><br><span class="line">[root@master1 work]# kubectl certificate approve node-csr-QRwNdc_yv-IPt19eqKmAcyrLnDv86x31pubdK3vLTGI</span><br><span class="line"></span><br><span class="line">certificatesigningrequest.certificates.k8s.io/node-csr-QRwNdc_yv-IPt19eqKmAcyrLnDv86x31pubdK3vLTGI approved</span><br><span class="line">[root@master1 work]# kubectl get csr</span><br><span class="line">NAME                                                   AGE   SIGNERNAME                                    REQUESTOR           CONDITION</span><br><span class="line">node-csr-QRwNdc_yv-IPt19eqKmAcyrLnDv86x31pubdK3vLTGI   87s   kubernetes.io/kube-apiserver-client-kubelet   kubelet-bootstrap   Approved,Issued</span><br><span class="line"></span><br><span class="line">[root@master1 work]# kubectl get nodes </span><br><span class="line">NAME    STATUS     ROLES    AGE   VERSION</span><br><span class="line">node1   NotReady   &lt;none&gt;   37s   v1.20.7</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">注意：STATUS 是 NotReady 表示还没有安装网络插件</span></span><br></pre></td></tr></table></figure>

<h3 id="部署kube-proxy组件"><a href="#部署kube-proxy组件" class="headerlink" title="部署kube-proxy组件"></a>部署kube-proxy组件</h3><ul>
<li>创建 csr 请求</li>
</ul>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">[</span>root@master1 work<span class="punctuation">]</span># cat kube-proxy-csr.json </span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;CN&quot;</span><span class="punctuation">:</span> <span class="string">&quot;system:kube-proxy&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;key&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;algo&quot;</span><span class="punctuation">:</span> <span class="string">&quot;rsa&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;size&quot;</span><span class="punctuation">:</span> <span class="number">2048</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;names&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;C&quot;</span><span class="punctuation">:</span> <span class="string">&quot;CN&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;ST&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Hubei&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;L&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Wuhan&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;O&quot;</span><span class="punctuation">:</span> <span class="string">&quot;k8s&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;OU&quot;</span><span class="punctuation">:</span> <span class="string">&quot;system&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<ul>
<li>生成证书</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[root@master1 work]# cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=kubernetes kube-proxy-csr.json | cfssljson -bare kube-proxy</span><br><span class="line">2023/07/20 10:29:10 [INFO] generate received request</span><br><span class="line">2023/07/20 10:29:10 [INFO] received CSR</span><br><span class="line">2023/07/20 10:29:10 [INFO] generating key: rsa-2048</span><br><span class="line">2023/07/20 10:29:10 [INFO] encoded CSR</span><br><span class="line">2023/07/20 10:29:10 [INFO] signed certificate with serial number 441768971858777701284603976425459769356591871306</span><br><span class="line">2023/07/20 10:29:10 [WARNING] This certificate lacks a &quot;hosts&quot; field. This makes it unsuitable for</span><br><span class="line">websites. For more information see the Baseline Requirements for the Issuance and Management</span><br><span class="line">of Publicly-Trusted Certificates, v.1.1.6, from the CA/Browser Forum (https://cabforum.org);</span><br><span class="line">specifically, section 10.2.3 (&quot;Information Requirements&quot;).</span><br></pre></td></tr></table></figure>

<ul>
<li>创建kubeconfig文件</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@master1 work]# kubectl config set-cluster kubernetes --certificate-authority=ca.pem --embed-certs=true --server=https://192.168.1.180:6443 --kubeconfig=kube-proxy.kubeconfig</span><br><span class="line"></span><br><span class="line">[root@master1 work]# kubectl config set-credentials kube-proxy --client-certificate=kube-proxy.pem --client-key=kube-proxy-key.pem --embed-certs=true --kubeconfig=kube-proxy.kubeconfig</span><br><span class="line"></span><br><span class="line">[root@master1 work]# kubectl config set-context default --cluster=kubernetes --user=kube-proxy --kubeconfig=kube-proxy.kubeconfig</span><br><span class="line"></span><br><span class="line">[root@master1 work]# kubectl config use-context default --kubeconfig=kube-proxy.kubeconfig</span><br></pre></td></tr></table></figure>

<ul>
<li>创建kube-proxy配置文件</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[root@master1 work]# cat kube-proxy.yaml</span><br><span class="line">apiVersion: kubeproxy.config.k8s.io/v1alpha1</span><br><span class="line">bindAddress: 192.168.1.183</span><br><span class="line">clientConnection:</span><br><span class="line">  kubeconfig: /etc/kubernetes/kube-proxy.kubeconfig</span><br><span class="line">clusterCIDR: 192.168.1.0/24</span><br><span class="line">healthzBindAddress: 192.168.1.183:10256</span><br><span class="line">kind: KubeProxyConfiguration</span><br><span class="line">metricsBindAddress: 192.168.1.183:10249</span><br><span class="line">mode: &quot;ipvs&quot;</span><br></pre></td></tr></table></figure>

<ul>
<li>创建服务启动文件</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">[root@master1 work]# cat kube-proxy.service </span><br><span class="line">[Unit]</span><br><span class="line">Description=Kubernetes Kube-Proxy Server</span><br><span class="line">Documentation=https://github.com/kubernetes/kubernetes</span><br><span class="line">After=network.target</span><br><span class="line"> </span><br><span class="line">[Service]</span><br><span class="line">WorkingDirectory=/var/lib/kube-proxy</span><br><span class="line">ExecStart=/usr/local/bin/kube-proxy \</span><br><span class="line">  --config=/etc/kubernetes/kube-proxy.yaml \</span><br><span class="line">  --alsologtostderr=true \</span><br><span class="line">  --logtostderr=false \</span><br><span class="line">  --log-dir=/var/log/kubernetes \</span><br><span class="line">  --v=2</span><br><span class="line">Restart=on-failure</span><br><span class="line">RestartSec=5</span><br><span class="line">LimitNOFILE=65536</span><br><span class="line"> </span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br></pre></td></tr></table></figure>

<ul>
<li>启动服务</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@master1 work]# scp kube-proxy.kubeconfig kube-proxy.yaml node1:/etc/kubernetes/</span><br><span class="line"></span><br><span class="line">[root@master1 work]# scp kube-proxy.service node1:/usr/lib/systemd/system/</span><br><span class="line"></span><br><span class="line">[root@node1 ~]# mkdir -p /var/lib/kube-proxy</span><br><span class="line"></span><br><span class="line">[root@node1 ~]# systemctl daemon-reload &amp;&amp; systemctl enable --now kube-proxy &amp;&amp; systemctl status kube-proxy</span><br></pre></td></tr></table></figure>

<h3 id="部署calico组件"><a href="#部署calico组件" class="headerlink" title="部署calico组件"></a>部署calico组件</h3><blockquote>
<p>把 calico.tar.gz 上传到 node1 节点</p>
<p>把 caliso.yaml 上传到 master1 节点</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[root@node1 ~]# docker load -i calico.tar.gz</span><br><span class="line"></span><br><span class="line">[root@master1 work]# kubectl apply -f calico.yaml</span><br><span class="line"></span><br><span class="line">[root@master1 work]# kubectl get pods -n kube-system </span><br><span class="line">NAME                                       READY   STATUS    RESTARTS   AGE</span><br><span class="line">calico-kube-controllers-6949477b58-s5mxf   1/1     Running   0          32s</span><br><span class="line">calico-node-hcghf                          1/1     Running   0          31s</span><br><span class="line"></span><br><span class="line">[root@master1 work]# kubectl get nodes</span><br><span class="line">NAME    STATUS   ROLES    AGE   VERSION</span><br><span class="line">node1   Ready    &lt;none&gt;   43m   v1.20.7</span><br></pre></td></tr></table></figure>

<h3 id="部署coredns组件"><a href="#部署coredns组件" class="headerlink" title="部署coredns组件"></a>部署coredns组件</h3><blockquote>
<p>把 coredns.yaml 上次到 master1 节点</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root@master1 work]# kubectl apply -f coredns.yaml</span><br><span class="line"></span><br><span class="line">[root@master1 work]# kubectl get pods -n kube-system </span><br><span class="line">NAME                                       READY   STATUS    RESTARTS   AGE</span><br><span class="line">calico-kube-controllers-6949477b58-s5mxf   1/1     Running   0          2m41s</span><br><span class="line">calico-node-hcghf                          1/1     Running   0          2m40s</span><br><span class="line">coredns-7bf4bd64bd-jxxfk                   1/1     Running   0          24s</span><br><span class="line"></span><br><span class="line">[root@master1 work]# kubectl get svc -n kube-system</span><br><span class="line">NAME       TYPE        CLUSTER-IP   EXTERNAL-IP   PORT(S)                  AGE</span><br><span class="line">kube-dns   ClusterIP   10.255.0.2   &lt;none&gt;        53/UDP,53/TCP,9153/TCP   40s</span><br></pre></td></tr></table></figure>

<blockquote>
<p>查看集群状态</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@master1 work]# kubectl get nodes</span><br><span class="line">NAME    STATUS   ROLES    AGE   VERSION</span><br><span class="line">node1   Ready    &lt;none&gt;   46m   v1.20.7</span><br></pre></td></tr></table></figure>

<h2 id="测试k8s集群部署tomcat"><a href="#测试k8s集群部署tomcat" class="headerlink" title="测试k8s集群部署tomcat"></a>测试k8s集群部署tomcat</h2><blockquote>
<p>把 tomcat.tar.gz 和 busybox-1-28.tar.gz 上传到  node1</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">[root@node1 ~]# docker load -i busybox-1-28.tar.gz </span><br><span class="line"></span><br><span class="line">[root@node1 ~]# docker load -i tomcat.tar.gz </span><br><span class="line"></span><br><span class="line">[root@master1 ~]# cat tomcat.yaml </span><br><span class="line">apiVersion: v1  #pod属于k8s核心组v1</span><br><span class="line">kind: Pod  #创建的是一个Pod资源</span><br><span class="line">metadata:  #元数据</span><br><span class="line">  name: demo-pod  #pod名字</span><br><span class="line">  namespace: default  #pod所属的名称空间</span><br><span class="line">  labels:</span><br><span class="line">    app: myapp  #pod具有的标签</span><br><span class="line">    env: dev      #pod具有的标签</span><br><span class="line">spec:</span><br><span class="line">  containers:      #定义一个容器，容器是对象列表，下面可以有多个name</span><br><span class="line">  - name:  tomcat-pod-java  #容器的名字</span><br><span class="line">    ports:</span><br><span class="line">    - containerPort: 8080</span><br><span class="line">    image: tomcat:8.5-jre8-alpine   #容器使用的镜像</span><br><span class="line">    imagePullPolicy: IfNotPresent</span><br><span class="line">  - name: busybox</span><br><span class="line">    image: busybox:latest</span><br><span class="line">    command:  #command是一个列表，定义的时候下面的参数加横线</span><br><span class="line">    - &quot;/bin/sh&quot;</span><br><span class="line">    - &quot;-c&quot;</span><br><span class="line">    - &quot;sleep 3600&quot;</span><br><span class="line">    </span><br><span class="line">[root@master1 ~]# cat tomcat-service.yaml </span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  name: tomcat</span><br><span class="line">spec:</span><br><span class="line">  type: NodePort</span><br><span class="line">  ports:</span><br><span class="line">    - port: 8080</span><br><span class="line">      nodePort: 30080</span><br><span class="line">  selector:</span><br><span class="line">    app: myapp</span><br><span class="line">    env: dev</span><br><span class="line"></span><br><span class="line">[root@master1 work]# kubectl apply -f tomcat.yaml </span><br><span class="line"></span><br><span class="line">[root@master1 work]# kubectl apply -f tomcat-service.yaml</span><br><span class="line"></span><br><span class="line">[root@master1 work]# kubectl get svc</span><br><span class="line">NAME         TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)          AGE</span><br><span class="line">kubernetes   ClusterIP   10.255.0.1      &lt;none&gt;        443/TCP          82m</span><br><span class="line">tomcat       NodePort    10.255.27.116   &lt;none&gt;        8080:30080/TCP   18s</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">浏览器访问 node1:30080</span></span><br></pre></td></tr></table></figure>

<h2 id="验证cordns"><a href="#验证cordns" class="headerlink" title="验证cordns"></a>验证cordns</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">[root@master1 ~]#  kubectl run busybox --image busybox:1.28 --restart=Never --rm -it busybox -- sh</span><br><span class="line"></span><br><span class="line">/ # ping www.baidu.com</span><br><span class="line">PING www.baidu.com (110.242.68.3): 56 data bytes</span><br><span class="line">64 bytes from 110.242.68.3: seq=0 ttl=127 time=21.006 ms</span><br><span class="line">64 bytes from 110.242.68.3: seq=1 ttl=127 time=20.862 ms</span><br><span class="line">64 bytes from 110.242.68.3: seq=2 ttl=127 time=20.976 ms</span><br><span class="line">64 bytes from 110.242.68.3: seq=3 ttl=127 time=20.865 ms</span><br><span class="line"></span><br><span class="line">/ # nslookup kubernetes.default.svc.cluster.local</span><br><span class="line">Server:    10.255.0.2</span><br><span class="line">Address 1: 10.255.0.2 kube-dns.kube-system.svc.cluster.local</span><br><span class="line"></span><br><span class="line">Name:      kubernetes.default.svc.cluster.local</span><br><span class="line">Address 1: 10.255.0.1 kubernetes.default.svc.cluster.local</span><br><span class="line"></span><br><span class="line">/ # nslookup tomcat.default.svc.cluster.local</span><br><span class="line">Server:    10.255.0.2</span><br><span class="line">Address 1: 10.255.0.2 kube-dns.kube-system.svc.cluster.local</span><br><span class="line"></span><br><span class="line">Name:      tomcat.default.svc.cluster.local</span><br><span class="line">Address 1: 10.255.27.116 tomcat.default.svc.cluster.local</span><br></pre></td></tr></table></figure>

<h2 id="安装keepalived-nginx实现k8s高可用"><a href="#安装keepalived-nginx实现k8s高可用" class="headerlink" title="安装keepalived+nginx实现k8s高可用"></a>安装keepalived+nginx实现k8s高可用</h2><ul>
<li>安装nginx主备</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line">[root@master1 ~]# yum install nginx keepalived nginx-mod-stream -y</span><br><span class="line"></span><br><span class="line">[root@master2 ~]# yum install nginx keepalived nginx-mod-stream -y</span><br><span class="line"></span><br><span class="line">[root@master1 ~]# cat /etc/nginx/nginx.conf</span><br><span class="line">user nginx;</span><br><span class="line">worker_processes auto;</span><br><span class="line">error_log /var/log/nginx/error.log;</span><br><span class="line">pid /run/nginx.pid;</span><br><span class="line"></span><br><span class="line">include /usr/share/nginx/modules/*.conf;</span><br><span class="line"></span><br><span class="line">events &#123;</span><br><span class="line">    worker_connections 1024;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">四层负载均衡，为两台Master apiserver组件提供负载均衡</span></span><br><span class="line">stream &#123;</span><br><span class="line"></span><br><span class="line">    log_format  main  &#x27;$remote_addr $upstream_addr - [$time_local] $status $upstream_bytes_sent&#x27;;</span><br><span class="line"></span><br><span class="line">    access_log  /var/log/nginx/k8s-access.log  main;</span><br><span class="line"></span><br><span class="line">    upstream k8s-apiserver &#123;</span><br><span class="line">       server 192.168.1.180:6443;   # Master1 APISERVER IP:PORT</span><br><span class="line">       server 192.168.1.181:6443;   # Master2 APISERVER IP:PORT</span><br><span class="line">       server 192.168.1.182:6443;   # Master3 APISERVER IP:PORT</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    server &#123;</span><br><span class="line">       listen 16443; # 由于nginx与master节点复用，这个监听端口不能是6443，否则会冲突</span><br><span class="line">       proxy_pass k8s-apiserver;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">http &#123;</span><br><span class="line">    log_format  main  &#x27;$remote_addr - $remote_user [$time_local] &quot;$request&quot; &#x27;</span><br><span class="line">                      &#x27;$status $body_bytes_sent &quot;$http_referer&quot; &#x27;</span><br><span class="line">                      &#x27;&quot;$http_user_agent&quot; &quot;$http_x_forwarded_for&quot;&#x27;;</span><br><span class="line"></span><br><span class="line">    access_log  /var/log/nginx/access.log  main;</span><br><span class="line"></span><br><span class="line">    sendfile            on;</span><br><span class="line">    tcp_nopush          on;</span><br><span class="line">    tcp_nodelay         on;</span><br><span class="line">    keepalive_timeout   65;</span><br><span class="line">    types_hash_max_size 2048;</span><br><span class="line"></span><br><span class="line">    include             /etc/nginx/mime.types;</span><br><span class="line">    default_type        application/octet-stream;</span><br><span class="line"></span><br><span class="line">    server &#123;</span><br><span class="line">        listen       80 default_server;</span><br><span class="line">        server_name  _;</span><br><span class="line"></span><br><span class="line">        location / &#123;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">[root@master1 ~]# scp /etc/nginx/nginx.conf master2:/etc/nginx/nginx.conf</span><br></pre></td></tr></table></figure>

<ul>
<li>keepalived配置</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">主 master1</span></span><br><span class="line">[root@master1 ~]# cat /etc/keepalived/keepalived.conf</span><br><span class="line">global_defs &#123; </span><br><span class="line">   notification_email &#123; </span><br><span class="line">     acassen@firewall.loc </span><br><span class="line">     failover@firewall.loc </span><br><span class="line">     sysadmin@firewall.loc </span><br><span class="line">   &#125; </span><br><span class="line">   notification_email_from Alexandre.Cassen@firewall.loc  </span><br><span class="line">   smtp_server 127.0.0.1 </span><br><span class="line">   smtp_connect_timeout 30 </span><br><span class="line">   router_id NGINX_MASTER</span><br><span class="line">&#125; </span><br><span class="line"></span><br><span class="line">vrrp_script check_nginx &#123;</span><br><span class="line">    script &quot;/etc/keepalived/check_nginx.sh&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">vrrp_instance VI_1 &#123; </span><br><span class="line">    state MASTER </span><br><span class="line">    interface ens32  # 修改为实际网卡名</span><br><span class="line">    virtual_router_id 51 # VRRP 路由 ID实例，每个实例是唯一的 </span><br><span class="line">    priority 100    # 优先级，备服务器设置 90 </span><br><span class="line">    advert_int 1    # 指定VRRP 心跳包通告间隔时间，默认1秒 </span><br><span class="line">    authentication &#123; </span><br><span class="line">        auth_type PASS      </span><br><span class="line">        auth_pass 1111 </span><br><span class="line">    &#125;  </span><br><span class="line">    # 虚拟IP</span><br><span class="line">    virtual_ipaddress &#123; </span><br><span class="line">        192.168.1.199/24</span><br><span class="line">    &#125; </span><br><span class="line">    track_script &#123;</span><br><span class="line">        check_nginx</span><br><span class="line">    &#125; </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@master1 ~]# cat /etc/keepalived/check_nginx.sh </span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/bash</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">1、判断Nginx是否存活</span></span><br><span class="line">counter=`ps -C nginx --no-header | wc -l`</span><br><span class="line">if [ $counter -eq 0 ]; then</span><br><span class="line">    #2、如果不存活则尝试启动Nginx</span><br><span class="line">    service nginx start</span><br><span class="line">    sleep 2</span><br><span class="line">    #3、等待2秒后再次获取一次Nginx状态</span><br><span class="line">    counter=`ps -C nginx --no-header | wc -l`</span><br><span class="line">    #4、再次进行判断，如Nginx还不存活则停止Keepalived，让地址进行漂移</span><br><span class="line">    if [ $counter -eq 0 ]; then</span><br><span class="line">        service  keepalived stop</span><br><span class="line">    fi</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line">[root@master1 ~]#  chmod +x /etc/keepalived/check_nginx.sh</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">备 master2</span></span><br><span class="line">[root@master2 ~]# cat /etc/keepalived/keepalived.conf</span><br><span class="line">global_defs &#123; </span><br><span class="line">   notification_email &#123; </span><br><span class="line">     acassen@firewall.loc </span><br><span class="line">     failover@firewall.loc </span><br><span class="line">     sysadmin@firewall.loc </span><br><span class="line">   &#125; </span><br><span class="line">   notification_email_from Alexandre.Cassen@firewall.loc  </span><br><span class="line">   smtp_server 127.0.0.1 </span><br><span class="line">   smtp_connect_timeout 30 </span><br><span class="line">   router_id NGINX_MASTER</span><br><span class="line">&#125; </span><br><span class="line"></span><br><span class="line">vrrp_script check_nginx &#123;</span><br><span class="line">    script &quot;/etc/keepalived/check_nginx.sh&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">vrrp_instance VI_1 &#123; </span><br><span class="line">    state BACKUP </span><br><span class="line">    interface ens32  # 修改为实际网卡名</span><br><span class="line">    virtual_router_id 51 # VRRP 路由 ID实例，每个实例是唯一的 </span><br><span class="line">    priority 90    # 优先级，备服务器设置 90 </span><br><span class="line">    advert_int 1    # 指定VRRP 心跳包通告间隔时间，默认1秒 </span><br><span class="line">    authentication &#123; </span><br><span class="line">        auth_type PASS      </span><br><span class="line">        auth_pass 1111 </span><br><span class="line">    &#125;  </span><br><span class="line">    # 虚拟IP</span><br><span class="line">    virtual_ipaddress &#123; </span><br><span class="line">        192.168.1.199/24</span><br><span class="line">    &#125; </span><br><span class="line">    track_script &#123;</span><br><span class="line">        check_nginx</span><br><span class="line">    &#125; </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@master2 ~]# cat /etc/keepalived/check_nginx.sh </span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/bash</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">1、判断Nginx是否存活</span></span><br><span class="line">counter=`ps -C nginx --no-header | wc -l`</span><br><span class="line">if [ $counter -eq 0 ]; then</span><br><span class="line">    #2、如果不存活则尝试启动Nginx</span><br><span class="line">    service nginx start</span><br><span class="line">    sleep 2</span><br><span class="line">    #3、等待2秒后再次获取一次Nginx状态</span><br><span class="line">    counter=`ps -C nginx --no-header | wc -l`</span><br><span class="line">    #4、再次进行判断，如Nginx还不存活则停止Keepalived，让地址进行漂移</span><br><span class="line">    if [ $counter -eq 0 ]; then</span><br><span class="line">        service  keepalived stop</span><br><span class="line">    fi</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line">[root@master2 ~]# chmod +x /etc/keepalived/check_nginx.sh</span><br></pre></td></tr></table></figure>

<ul>
<li>启动服务</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">[root@master1 ~]# systemctl daemon-reload &amp;&amp; systemctl enable --now nginx.service &amp;&amp; systemctl enable --now keepalived.service </span><br><span class="line"></span><br><span class="line">[root@master2 ~]# systemctl daemon-reload &amp;&amp; systemctl enable --now nginx.service &amp;&amp; systemctl enable --now keepalived.service </span><br><span class="line"></span><br><span class="line">[root@master1 ~]# ip addr</span><br><span class="line">1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000</span><br><span class="line">    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00</span><br><span class="line">    inet 127.0.0.1/8 scope host lo</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    inet6 ::1/128 scope host </span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">2: ens32: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc pfifo_fast state UP group default qlen 1000</span><br><span class="line">    link/ether 00:0c:29:42:09:5b brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    inet 192.168.1.180/24 brd 192.168.1.255 scope global noprefixroute ens32</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    inet 192.168.1.199/24 scope global secondary ens32</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    inet6 fe80::f505:3807:9755:3839/64 scope link noprefixroute </span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">3: docker0: &lt;NO-CARRIER,BROADCAST,MULTICAST,UP&gt; mtu 1500 qdisc noqueue state DOWN group default </span><br><span class="line">    link/ether 02:42:a8:d0:04:85 brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    inet 172.17.0.1/16 brd 172.17.255.255 scope global docker0</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br></pre></td></tr></table></figure>

<blockquote>
<p>目前所有的 Worker Node 组件连接都还是 master1 Node，如果不改为连接 VIP 走负载均衡器，那么 Master 还是单点故障。</p>
<p>因此接下来就是要改所有 Worker Node（kubectl get node 命令查看到的节点）组件配置文件，由原来 192.168.1.180 修改为 192.168.1.199（VIP）。</p>
<p>在所有 Worker Node 执行</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">sed -i &#x27;s#192.168.1.180:6443#192.168.1.199:16443#&#x27; /etc/kubernetes/kubelet-bootstrap.kubeconfig</span><br><span class="line"></span><br><span class="line">sed -i &#x27;s#192.168.1.180:6443#192.168.1.199:16443#&#x27; /etc/kubernetes/kubelet.json</span><br><span class="line"></span><br><span class="line">sed -i &#x27;s#192.168.1.180:6443#192.168.1.199:16443#&#x27; /etc/kubernetes/kubelet.kubeconfig</span><br><span class="line"></span><br><span class="line">sed -i &#x27;s#192.168.1.180:6443#192.168.1.199:16443#&#x27; /etc/kubernetes/kube-proxy.yaml</span><br><span class="line"></span><br><span class="line">sed -i &#x27;s#192.168.1.180:6443#192.168.1.199:16443#&#x27; /etc/kubernetes/kube-proxy.kubeconfig</span><br><span class="line"></span><br><span class="line">systemctl restart kubelet kube-proxy</span><br></pre></td></tr></table></figure>

<blockquote>
<p>这样高可用集群就安装好了</p>
</blockquote>
<h1 id="基于containerd安装k8s1-26集群"><a href="#基于containerd安装k8s1-26集群" class="headerlink" title="基于containerd安装k8s1.26集群"></a>基于containerd安装k8s1.26集群</h1><h2 id="k8s环境规划-2"><a href="#k8s环境规划-2" class="headerlink" title="k8s环境规划"></a>k8s环境规划</h2><blockquote>
<p>centos7.9操作系统，4G/4CPU/100G，网络NAT，开启虚拟化</p>
<p>podSubnet(pod网段)10.244.0.0/16<br>serviceSubnet(service网段)10.96.0.0/16</p>
</blockquote>
<table>
<thead>
<tr>
<th>k8s集群角色</th>
<th>ip</th>
<th>主机名</th>
<th>安装的组件</th>
</tr>
</thead>
<tbody><tr>
<td>控制节点</td>
<td>192.168.1.180</td>
<td>master1</td>
<td>apiserver、controller-manager、scheduler、kubelet、etcd、kube-proxy、容器运行时、calico</td>
</tr>
<tr>
<td>工作节点</td>
<td>192.168.1.181</td>
<td>node1</td>
<td>kube-prox、calico、coredns、容器运行时、kubelet</td>
</tr>
<tr>
<td>工作节点</td>
<td>192.168.1.182</td>
<td>node2</td>
<td>kube-prox、calico、coredns、容器运行时、kubelet</td>
</tr>
</tbody></table>
<h2 id="初始化-1"><a href="#初始化-1" class="headerlink" title="初始化"></a>初始化</h2><blockquote>
<p>所有主机做以下操作</p>
</blockquote>
<ul>
<li>配置hosts解析</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">echo &quot;192.168.1.180 master1</span><br><span class="line">192.168.1.181 node1</span><br><span class="line">192.168.1.182 node2&quot; &gt;&gt; /etc/hosts</span><br></pre></td></tr></table></figure>

<ul>
<li>配置主机间无密码登录</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ssh-keygen</span><br><span class="line"></span><br><span class="line">for i in master1 node1 node2;do ssh-copy-id root@$i;done</span><br></pre></td></tr></table></figure>

<ul>
<li>关闭防火墙</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl disable --now firewalld</span><br></pre></td></tr></table></figure>

<ul>
<li>关闭selinux</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">sed -i &#x27;s/SELINUX=enforcing/SELINUX=disabled/g&#x27; /etc/selinux/config</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">重启生效</span></span><br><span class="line">reboot</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">显示 Disabled 说明 selinux 已经关闭</span></span><br><span class="line">getenforce</span><br></pre></td></tr></table></figure>

<ul>
<li>关闭交换分区swap</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">临时关闭</span></span><br><span class="line">swapoff -a</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">永久关闭：注释 swap 挂载，给 swap 这行开头加一下注释</span></span><br><span class="line">vim /etc/fstab</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">/dev/mapper/centos-swap swap swap defaults 0 0</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">如果是克隆的虚拟机，需要删除 UUID</span></span><br></pre></td></tr></table></figure>

<ul>
<li>修改内核参数</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">加载 br_netfilter 模块</span></span><br><span class="line">modprobe br_netfilter</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">验证模块是否加载成功：</span></span><br><span class="line">lsmod |grep br_netfilter</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">修改内核参数</span></span><br><span class="line">cat &gt; /etc/sysctl.d/k8s.conf &lt;&lt;EOF</span><br><span class="line">net.bridge.bridge-nf-call-ip6tables = 1</span><br><span class="line">net.bridge.bridge-nf-call-iptables = 1</span><br><span class="line">net.ipv4.ip_forward = 1</span><br><span class="line">EOF</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">使刚才修改的内核参数生效</span></span><br><span class="line">sysctl -p /etc/sysctl.d/k8s.conf</span><br></pre></td></tr></table></figure>

<ul>
<li>配置阿里云repo源</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">备份基础repo源</span></span><br><span class="line">mkdir /root/repo.bak </span><br><span class="line">cd /etc/yum.repos.d/ </span><br><span class="line">mv * /root/repo.bak/</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">拉取阿里云repo源</span></span><br><span class="line">curl -o /etc/yum.repos.d/CentOS-Base.repo https://mirrors.aliyun.com/repo/Centos-7.repo</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">配置国内阿里云 docker 和 containerd 的 repo 源</span> </span><br><span class="line">yum install yum-utils -y</span><br><span class="line"></span><br><span class="line">yum-config-manager --add-repo http://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"> 配置安装 k8s 组件需要的阿里云的 repo 源</span></span><br><span class="line">cat &gt; /etc/yum.repos.d/kubernetes.repo &lt;&lt;EOF</span><br><span class="line">[kubernetes]</span><br><span class="line">name=Kubernetes</span><br><span class="line">baseurl=https://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64/</span><br><span class="line">enabled=1</span><br><span class="line">gpgcheck=0</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<ul>
<li>配置时间同步</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">安装 ntpdate 命令，</span></span><br><span class="line">yum install ntpdate -y</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">跟网络源做同步</span></span><br><span class="line">ntpdate cn.pool.ntp.org</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">把时间同步做成计划任务</span></span><br><span class="line">crontab -e</span><br><span class="line">* */1 * * * /usr/sbin/ntpdate cn.pool.ntp.org</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">重启 crond 服务</span></span><br><span class="line">service crond restart</span><br></pre></td></tr></table></figure>

<ul>
<li>安装iptables</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">安装 iptables</span></span><br><span class="line">yum install iptables-services -y</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">禁用 iptables</span></span><br><span class="line">service iptables stop &amp;&amp; systemctl disable iptables</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">清空防火墙规则</span></span><br><span class="line">iptables -F</span><br></pre></td></tr></table></figure>

<ul>
<li>开启 ipvs</li>
</ul>
<blockquote>
<p>不开启 ipvs 将会使用 iptables 进行数据包转发，但是效率低，所以官网推荐需要开通 ipvs。</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">编写脚本开启模块</span></span><br><span class="line">vim /etc/sysconfig/modules/ipvs.modules</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/bash</span></span><br><span class="line">ipvs_modules=&quot;ip_vs ip_vs_lc ip_vs_wlc ip_vs_rr ip_vs_wrr ip_vs_lblc ip_vs_lblcr ip_vs_dh ip_vs_sh ip_vs_nq ip_vs_sed ip_vs_ftp nf_conntrack&quot;</span><br><span class="line">for kernel_module in $&#123;ipvs_modules&#125;; do</span><br><span class="line"> /sbin/modinfo -F filename $&#123;kernel_module&#125; &gt; /dev/null 2&gt;&amp;1</span><br><span class="line"> if [ 0 -eq 0 ]; then</span><br><span class="line"> /sbin/modprobe $&#123;kernel_module&#125;</span><br><span class="line"> fi</span><br><span class="line">done</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">执行脚本，查看模块是否开启</span></span><br><span class="line">chmod 755 /etc/sysconfig/modules/ipvs.modules &amp;&amp; bash /etc/sysconfig/modules/ipvs.modules &amp;&amp; lsmod | grep ip_vs </span><br><span class="line">ip_vs_ftp 13079 0 </span><br><span class="line">nf_nat 26583 1 ip_vs_ftp </span><br><span class="line">ip_vs_sed 12519 0 </span><br><span class="line">ip_vs_nq 12516 0 </span><br><span class="line">ip_vs_sh 12688 0 </span><br><span class="line">ip_vs_dh 12688 0</span><br></pre></td></tr></table></figure>

<ul>
<li>安装基础软件包</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install -y yum-utils device-mapper-persistent-data lvm2 wget net-tools nfs-utils lrzsz gcc gcc-c++ make cmake libxml2-devel openssl-devel curl curl-devel unzip sudo ntp libaio-devel wget vim ncurses-devel autoconf automake zlib-devel python-devel epel-release openssh-server socat ipvsadm conntrack ntpdate telnet rsync bash-completion</span><br></pre></td></tr></table></figure>

<h2 id="安装containerd服务"><a href="#安装containerd服务" class="headerlink" title="安装containerd服务"></a>安装containerd服务</h2><blockquote>
<p>所有节点做相同操作</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install containerd.io-1.6.6 -y</span><br></pre></td></tr></table></figure>

<ul>
<li>生成contaierd配置文件</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p /etc/containerd</span><br><span class="line"></span><br><span class="line">containerd config default &gt; /etc/containerd/config.toml</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">修改配置文件</span></span><br><span class="line">vim /etc/containerd/config.toml</span><br><span class="line">SystemdCgroup = true		# false改为true</span><br><span class="line">sandbox_image=&quot;registry.aliyuncs.com/google_containers/pause:3.7&quot; #  k8s.gcr.io/pause:3.6修改为registry.aliyuncs.com/google_containers/pause:3.7</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">配置 containerd 开机启动，并启动 containerd</span></span><br><span class="line">systemctl enable containerd --now</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">修改/etc/cictl.yaml文件</span></span><br><span class="line">cat &gt; /etc/crictl.yaml &lt;&lt;EOF</span><br><span class="line">runtime-endpoint: unix:///run/containerd/containerd.sock</span><br><span class="line">image-endpoint: unix:///run/containerd/containerd.sock</span><br><span class="line">timeout: 10</span><br><span class="line">debug: false</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">systemctl restart containerd</span><br></pre></td></tr></table></figure>

<ul>
<li>配置containerd镜像加速器</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/containerd/config.toml</span><br><span class="line">config_path = &quot;/etc/containerd/certs.d&quot;</span><br><span class="line"></span><br><span class="line">mkdir /etc/containerd/certs.d/docker.io/ -p</span><br><span class="line"></span><br><span class="line">vim /etc/containerd/certs.d/docker.io/hosts.toml</span><br><span class="line">[host.&quot;https://vh3bm52y.mirror.aliyuncs.com&quot;,host.&quot;https://registry.docker-cn.com&quot;]</span><br><span class="line"> capabilities = [&quot;pull&quot;]</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">重启 containerd：</span></span><br><span class="line">systemctl restart containerd</span><br></pre></td></tr></table></figure>

<h2 id="安装docker-ce"><a href="#安装docker-ce" class="headerlink" title="安装docker-ce"></a>安装docker-ce</h2><blockquote>
<p>docker 也要安装，docker 跟 containerd 不冲突，安装 docker 是为了能基于 dockerfile 构建镜像</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">yum install docker-ce -y</span><br><span class="line"></span><br><span class="line">systemctl start docker &amp;&amp; systemctl enable docker.service &amp;&amp; systemctl status docker</span><br></pre></td></tr></table></figure>

<ul>
<li>配置docker加速器</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">tee /etc/docker/daemon.json &lt;&lt; &#x27;EOF&#x27;</span><br><span class="line">&#123;</span><br><span class="line">&quot;registry-mirrors&quot;:[&quot;https://rsbud4vc.mirror.aliyuncs.com&quot;,&quot;https://registry.docker-cn.com&quot;,&quot;https://docker.mirrors.ustc.edu.cn&quot;,&quot;https://dockerhub.azk8s.cn&quot;,&quot;http://hub-mirror.c.163.com&quot;,&quot;http://qtid6917.mirror.aliyuncs.com&quot;,&quot;https://rncxm540.mirror.aliyuncs.com&quot;]</span><br><span class="line">&#125; </span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">systemctl daemon-reload</span><br><span class="line">systemctl restart docker</span><br><span class="line">systemctl status docker</span><br></pre></td></tr></table></figure>

<h2 id="安装初始化k8s需要的软件包"><a href="#安装初始化k8s需要的软件包" class="headerlink" title="安装初始化k8s需要的软件包"></a>安装初始化k8s需要的软件包</h2><blockquote>
<p>kubeadm:kubeadm是一个工具，用来初始化k8s集群的<br>kubelet:安装在集群所有节点上，用于启动Pod的，kubeadm安装k8s，k8s控制节点和工作节点的组件，都是基于pod运行的，只要pod启动，就需要kubelet<br>kubectl:通过kubectl可以部署和管理应用，查看各种资源，创建、删除和更新各种组件</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">yum install -y kubelet-1.26.0 kubeadm-1.26.0 kubectl-1.26.0</span><br><span class="line"></span><br><span class="line">systemctl enable kubelet</span><br></pre></td></tr></table></figure>

<h2 id="kubeadm初始化k8s集群"><a href="#kubeadm初始化k8s集群" class="headerlink" title="kubeadm初始化k8s集群"></a>kubeadm初始化k8s集群</h2><ul>
<li>设置容器运行时</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@master1 ~]# crictl config runtime-endpoint unix:///run/containerd/containerd.sock</span><br><span class="line"></span><br><span class="line">[root@node1 ~]# crictl config runtime-endpoint unix:///run/containerd/containerd.sock</span><br><span class="line"></span><br><span class="line">[root@node2 ~]# crictl config runtime-endpoint unix:///run/containerd/containerd.sock</span><br></pre></td></tr></table></figure>

<ul>
<li>使用kubeadm初始化k8s集群</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@master1 ~]# kubeadm config print init-defaults &gt; kubeadm.yaml</span><br></pre></td></tr></table></figure>

<blockquote>
<p>根据我们自己的需求修改配置，比如修改 imageRepository 的值<br>kube-proxy 的模式为 ipvs<br>需要注意的是由于我们使用的containerd作为运行时，所以在初始化节点的时候需要指定cgroupDriver为systemd</p>
</blockquote>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">kubeadm.k8s.io/v1beta3</span></span><br><span class="line"><span class="attr">bootstrapTokens:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">groups:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">system:bootstrappers:kubeadm:default-node-token</span></span><br><span class="line">  <span class="attr">token:</span> <span class="string">abcdef.0123456789abcdef</span></span><br><span class="line">  <span class="attr">ttl:</span> <span class="string">24h0m0s</span></span><br><span class="line">  <span class="attr">usages:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">signing</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">authentication</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">InitConfiguration</span></span><br><span class="line"><span class="attr">localAPIEndpoint:</span></span><br><span class="line">  <span class="attr">advertiseAddress:</span> <span class="number">192.168</span><span class="number">.1</span><span class="number">.180</span>	<span class="comment"># 控制节点ip</span></span><br><span class="line">  <span class="attr">bindPort:</span> <span class="number">6443</span></span><br><span class="line"><span class="attr">nodeRegistration:</span></span><br><span class="line">  <span class="attr">criSocket:</span> <span class="string">unix:///run/containerd/containerd.sock</span>	<span class="comment"># 指定容器运行时</span></span><br><span class="line">  <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">master1</span></span><br><span class="line">  <span class="attr">taints:</span> <span class="literal">null</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiServer:</span></span><br><span class="line">  <span class="attr">timeoutForControlPlane:</span> <span class="string">4m0s</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">kubeadm.k8s.io/v1beta3</span></span><br><span class="line"><span class="attr">certificatesDir:</span> <span class="string">/etc/kubernetes/pki</span></span><br><span class="line"><span class="attr">clusterName:</span> <span class="string">kubernetes</span></span><br><span class="line"><span class="attr">controllerManager:</span> &#123;&#125;</span><br><span class="line"><span class="attr">dns:</span> &#123;&#125;</span><br><span class="line"><span class="attr">etcd:</span></span><br><span class="line">  <span class="attr">local:</span></span><br><span class="line">    <span class="attr">dataDir:</span> <span class="string">/var/lib/etcd</span></span><br><span class="line"><span class="attr">imageRepository:</span> <span class="string">registry.cn-hangzhou.aliyuncs.com/google_containers</span>	<span class="comment"># 指定阿里云镜像仓库</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterConfiguration</span></span><br><span class="line"><span class="attr">kubernetesVersion:</span> <span class="number">1.26</span><span class="number">.0</span>	<span class="comment"># k8s版本</span></span><br><span class="line"><span class="attr">networking:</span></span><br><span class="line">  <span class="attr">dnsDomain:</span> <span class="string">cluster.local</span></span><br><span class="line">  <span class="attr">podSubnet:</span> <span class="number">10.244</span><span class="number">.0</span><span class="number">.0</span><span class="string">/16</span>	<span class="comment"># 指定pod网段 新增</span></span><br><span class="line">  <span class="attr">serviceSubnet:</span> <span class="number">10.96</span><span class="number">.0</span><span class="number">.0</span><span class="string">/12</span> <span class="comment"># 指定service网段</span></span><br><span class="line"><span class="attr">scheduler:</span> &#123;&#125;</span><br><span class="line"><span class="string">---</span>		<span class="comment"># 文件最后插入</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">kubeproxy.config.k8s.io/v1alpha1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">KubeProxyConfiguration</span></span><br><span class="line"><span class="attr">mode:</span> <span class="string">ipvs</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">kubelet.config.k8s.io/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">KubeletConfiguration</span></span><br><span class="line"><span class="attr">cgroupDriver:</span> <span class="string">systemd</span></span><br></pre></td></tr></table></figure>

<ul>
<li>解压镜像</li>
</ul>
<blockquote>
<p>没有本地镜像，会默认从阿里云拉取镜像</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">ctr是containerd自带的工具，有命名空间的概念，若是k8s相关的镜像，都默认在k8s.io这个命名空间，所以导入镜像时需要指定命令空间为k8s.io</span></span><br><span class="line"></span><br><span class="line">[root@master1 ~]# ctr -n=k8s.io images import k8s_1.26.0.tar.gz</span><br><span class="line"></span><br><span class="line">[root@node1 ~]# ctr -n=k8s.io images import k8s_1.26.0.tar.gz</span><br><span class="line"></span><br><span class="line">[root@node2 ~]# ctr -n=k8s.io images import k8s_1.26.0.tar.gz</span><br></pre></td></tr></table></figure>

<ul>
<li>初始化</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[root@master1 ~]# kubeadm init --config=kubeadm.yaml --ignore-preflight-errors=SystemVerification</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@master1 ~]# mkdir -p $HOME/.kube</span><br><span class="line"></span><br><span class="line">[root@master1 ~]# sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config</span><br><span class="line"></span><br><span class="line">[root@master1 ~]# sudo chown $(id -u):$(id -g) $HOME/.kube/config</span><br><span class="line"></span><br><span class="line">[root@master1 ~]# kubectl get nodes</span><br><span class="line">NAME      STATUS     ROLES           AGE     VERSION</span><br><span class="line">master1   NotReady   control-plane   4m48s   v1.26.0</span><br></pre></td></tr></table></figure>

<h2 id="扩容k8s集群"><a href="#扩容k8s集群" class="headerlink" title="扩容k8s集群"></a>扩容k8s集群</h2><ul>
<li>在master1上查看节点的命令</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@master1 ~]# kubeadm token create --print-join-command</span><br><span class="line">kubeadm join 192.168.1.180:6443 --token cc5gcg.xt918axsgznlogjb --discovery-token-ca-cert-hash sha256:7e24f2544d8ac7ab11df4b0ebab8323853ed43f59210e4d0d8b09dce8ef79fcb </span><br></pre></td></tr></table></figure>

<ul>
<li>工作节点加入集群</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@node1 ~]# kubeadm join 192.168.1.180:6443 --token cc5gcg.xt918axsgznlogjb --discovery-token-ca-cert-hash sha256:7e24f2544d8ac7ab11df4b0ebab8323853ed43f59210e4d0d8b09dce8ef79fcb --ignore-preflight-errors=SystemVerification</span><br><span class="line"></span><br><span class="line">[root@node2 ~]# kubeadm join 192.168.1.180:6443 --token cc5gcg.xt918axsgznlogjb --discovery-token-ca-cert-hash sha256:7e24f2544d8ac7ab11df4b0ebab8323853ed43f59210e4d0d8b09dce8ef79fcb --ignore-preflight-errors=SystemVerification</span><br></pre></td></tr></table></figure>

<ul>
<li>给工作节点打上标签</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@master1 ~]# kubectl label nodes node1 node-role.kubernetes.io/work=work</span><br><span class="line"></span><br><span class="line">[root@master1 ~]# kubectl label nodes node2 node-role.kubernetes.io/work=work</span><br><span class="line"></span><br><span class="line">[root@master1 ~]# kubectl get nodes</span><br><span class="line">NAME      STATUS     ROLES           AGE   VERSION</span><br><span class="line">master1   NotReady   control-plane   15m   v1.26.0</span><br><span class="line">node1     NotReady   work            96s   v1.26.0</span><br><span class="line">node2     NotReady   work            86s   v1.26.0</span><br></pre></td></tr></table></figure>

<h2 id="安装网络组件calico"><a href="#安装网络组件calico" class="headerlink" title="安装网络组件calico"></a>安装网络组件calico</h2><blockquote>
<p>把calico镜像上传到所有节点解压</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@master1 ~]# ctr -n=k8s.io images import calico.tar.gz</span><br><span class="line"></span><br><span class="line">[root@node1 ~]# ctr -n=k8s.io images import calico.tar.gz</span><br><span class="line"></span><br><span class="line">[root@node2 ~]# ctr -n=k8s.io images import calico.tar.gz</span><br></pre></td></tr></table></figure>

<blockquote>
<p>上传配置文件</p>
</blockquote>
<ul>
<li><a target="_blank" rel="noopener" href="https://docs.projectcalico.org/manifests/calico.yaml">https://docs.projectcalico.org/manifests/calico.yaml</a></li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@master1 ~]# kubectl apply -f calico.yaml </span><br><span class="line"></span><br><span class="line">[root@master1 ~]# kubectl get nodes</span><br><span class="line">NAME      STATUS   ROLES           AGE   VERSION</span><br><span class="line">master1   Ready    control-plane   26m   v1.26.0</span><br><span class="line">node1     Ready    work            13m   v1.26.0</span><br><span class="line">node2     Ready    work            13m   v1.26.0</span><br></pre></td></tr></table></figure>

<ul>
<li>calico文件说明</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">containers:</span></span><br><span class="line">  <span class="comment"># Runs calico-node container on each Kubernetes node. This</span></span><br><span class="line">  <span class="comment"># container programs network policy and routes on each</span></span><br><span class="line">  <span class="comment"># host.</span></span><br><span class="line">   <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">calico-node</span></span><br><span class="line">     <span class="attr">image:</span> <span class="string">docker.io/calico/node:v3.18.0</span></span><br><span class="line"><span class="string">……</span></span><br><span class="line">     <span class="attr">env:</span></span><br><span class="line">        <span class="comment"># Use Kubernetes API as the backing datastore.</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">DATASTORE_TYPE</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">&quot;kubernetes&quot;</span></span><br><span class="line">        <span class="comment"># Cluster type to identify the deployment type</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">CLUSTER_TYPE</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">&quot;k8s,bgp&quot;</span></span><br><span class="line">        <span class="comment"># Auto-detect the BGP IP address.</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">IP</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">&quot;autodetect&quot;</span></span><br><span class="line">        <span class="comment"># pod网段</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">CALICO_IPV4POOL_CIDR</span> </span><br><span class="line">          <span class="attr">value:</span> <span class="string">&quot;10.244.0.0/16&quot;</span></span><br><span class="line">        <span class="comment"># Enable IPIP</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">CALICO_IPV4POOL_IPIP</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">&quot;Always&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># IP_AUTODETECTION_METHOD：获取Node IP地址的方式，默认使用第1个网络接口的IP地址</span></span><br><span class="line"><span class="comment"># 对于安装了多块网卡的Node，可以使用正则表达式选择正确的网卡，例如&quot;interface=eth.*&quot;表示选择名称以eth开头的网卡的IP地址。</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">IP_AUTODETECTION_METHOD</span></span><br><span class="line">  <span class="attr">value:</span> <span class="string">&quot;interface=ens33&quot;</span></span><br></pre></td></tr></table></figure>

<ul>
<li>测试k8s创建pod是否可以访问网络</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[root@master1 ~]# kubectl run busybox --image docker.io/library/busybox:1.28 --image-pull-policy=IfNotPresent --restart=Never --rm -it busybox -- sh</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">/ # ping baidu.com</span><br><span class="line">PING baidu.com (39.156.66.10): 56 data bytes</span><br><span class="line">64 bytes from 39.156.66.10: seq=0 ttl=127 time=21.761 ms</span><br><span class="line">64 bytes from 39.156.66.10: seq=1 ttl=127 time=21.570 ms</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">/ # nslookup kubernetes.default.svc.cluster.local</span><br><span class="line">Server:    10.96.0.10</span><br><span class="line">Address 1: 10.96.0.10 kube-dns.kube-system.svc.cluster.local</span><br><span class="line"></span><br><span class="line">Name:      kubernetes.default.svc.cluster.local</span><br><span class="line">Address 1: 10.96.0.1 kubernetes.default.svc.cluster.local</span><br></pre></td></tr></table></figure>

<h2 id="ctr和crictl区别"><a href="#ctr和crictl区别" class="headerlink" title="ctr和crictl区别"></a>ctr和crictl区别</h2><blockquote>
<p>ctr是containerd自带的CLI命令行工具，crictl是k8s中CRI（容器运行时接口）的客户端，k8s使用该客户端和containerd进行交互；</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@master1 ~]# cat /etc/crictl.yaml </span><br><span class="line">runtime-endpoint: unix:///run/containerd/containerd.sock</span><br><span class="line">image-endpoint: unix:///run/containerd/containerd.sock</span><br><span class="line">timeout: 10</span><br><span class="line">debug: false</span><br><span class="line">pull-image-on-create: false</span><br><span class="line">disable-pull-on-run: false</span><br></pre></td></tr></table></figure>

<blockquote>
<p>ctr和crictl命令具体区别如下，也可以–help查看。crictl缺少对具体镜像的管理能力，可能是k8s层面镜像管理可以由用户自行控制，能配置pod里面容器的统一镜像仓库，镜像的管理可以有harbor等插件进行处理</p>
</blockquote>
<table>
<thead>
<tr>
<th>命令</th>
<th>ctr</th>
<th>crictl</th>
</tr>
</thead>
<tbody><tr>
<td>查看运行的容器</td>
<td>ctr task ls/ctr container ls</td>
<td>crictl ps</td>
</tr>
<tr>
<td>查看镜像</td>
<td>ctr image ls</td>
<td>crictl images</td>
</tr>
<tr>
<td>查看容器日志</td>
<td>无</td>
<td>crictl logs</td>
</tr>
<tr>
<td>查看容器数据信息</td>
<td>ctr container info</td>
<td>crictl inspect</td>
</tr>
<tr>
<td>查看容器资源</td>
<td>无</td>
<td>crictl stats</td>
</tr>
<tr>
<td>启动/关闭已有容器</td>
<td>ctr task start/kill</td>
<td>crictl start/stop</td>
</tr>
<tr>
<td>运行一个新的容器</td>
<td>crt run</td>
<td>无（最小单元为pod）</td>
</tr>
<tr>
<td>修改镜像标签</td>
<td>ctr image tag</td>
<td>无</td>
</tr>
<tr>
<td>创建一个新的容器</td>
<td>ctr container create</td>
<td>crictl create</td>
</tr>
<tr>
<td>导入镜像</td>
<td>ctr image import</td>
<td>无</td>
</tr>
<tr>
<td>导出镜像</td>
<td>ctr image export</td>
<td>无</td>
</tr>
<tr>
<td>删除容器</td>
<td>ctr container rm</td>
<td>crictl rm</td>
</tr>
<tr>
<td>删除镜像</td>
<td>ctr image rm</td>
<td>crictl rmi</td>
</tr>
<tr>
<td>拉取镜像</td>
<td>ctr image pull</td>
<td>crictl pull</td>
</tr>
<tr>
<td>推送镜像</td>
<td>ctr image push</td>
<td>无</td>
</tr>
</tbody></table>
<h1 id="kubeadm安装单master多node测试环境k8s集群"><a href="#kubeadm安装单master多node测试环境k8s集群" class="headerlink" title="kubeadm安装单master多node测试环境k8s集群"></a>kubeadm安装单master多node测试环境k8s集群</h1><h2 id="k8s环境规划-3"><a href="#k8s环境规划-3" class="headerlink" title="k8s环境规划"></a>k8s环境规划</h2><blockquote>
<p>centos7.6~centos7.9操作系统，4G/4CPU/100G，网络NAT，开启虚拟化</p>
<p>podSubnet(pod网段)10.244.0.0/16<br>serviceSubnet(service网段)10.10.0.0/16</p>
</blockquote>
<table>
<thead>
<tr>
<th>k8s集群角色</th>
<th>ip</th>
<th>主机名</th>
<th>安装的组件</th>
</tr>
</thead>
<tbody><tr>
<td>控制节点</td>
<td>192.168.1.180</td>
<td>master1</td>
<td>apiserver、controller-manager、scheduler、etcd、docker、kube-proxy、calico</td>
</tr>
<tr>
<td>工作节点</td>
<td>192.168.1.181</td>
<td>node1</td>
<td>kubelet、kube-proxy、docker、calico、coredns</td>
</tr>
<tr>
<td>工作节点</td>
<td>192.168.1.182</td>
<td>node2</td>
<td>kubelet、kube-proxy、docker、calico、coredns</td>
</tr>
</tbody></table>
<h2 id="初始化实验环境-1"><a href="#初始化实验环境-1" class="headerlink" title="初始化实验环境"></a>初始化实验环境</h2><blockquote>
<p>所有节点做相同操作</p>
</blockquote>
<ul>
<li>修改主机IP</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/sysconfig/network-scripts/ifcfg-ens33 </span><br><span class="line">TYPE=Ethernet  </span><br><span class="line">BOOTPROTO=static # static 表示静态 ip 地址</span><br><span class="line">IPADDR=192.168.1.180 # ip 地址，需要跟自己电脑所在网段一致</span><br><span class="line">NETMASK=255.255.255.0 # 子网掩码，需要跟自己电脑所在网段一致</span><br><span class="line">GATEWAY=192.168.1.2 # 网关，在自己电脑打开 cmd，输入 ipconfig /all 可看到</span><br><span class="line">DNS1=223.5.5.5	# DNS，在自己电脑打开 cmd，输入 ipconfig /all 可看到</span><br><span class="line">NAME=ens33 # 网卡名字，跟 DEVICE 名字保持一致即可</span><br><span class="line">DEVICE=ens33 # 网卡设备名，ip addr 可看到自己的这个网卡设备名</span><br><span class="line">ONBOOT=yes	# 开机自启动网络，必须是 yes</span><br><span class="line"></span><br><span class="line">service network restart</span><br></pre></td></tr></table></figure>

<ul>
<li>配置主机名，配置hosts解析</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">在 192.168.1.180 上执行</span></span><br><span class="line">hostnamectl set-hostname master1 &amp;&amp; bash </span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">在 192.168.40.181 上执行</span> </span><br><span class="line">hostnamectl set-hostname node1 &amp;&amp; bash </span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">在 192.168.40.182 上执行</span></span><br><span class="line">hostnamectl set-hostname node2 &amp;&amp; bash </span><br><span class="line"><span class="meta prompt_"> </span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">配置主机 hosts 文件</span></span><br><span class="line">192.168.1.180 master1 </span><br><span class="line">192.168.1.181 node1</span><br><span class="line">192.168.1.182 node2</span><br></pre></td></tr></table></figure>

<ul>
<li>配置主机间无密码登录</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">ssh-keygen</span><br><span class="line"></span><br><span class="line">for i in master1 node1 node2</span><br><span class="line">do</span><br><span class="line">    ssh-copy-id root@$i</span><br><span class="line">done</span><br></pre></td></tr></table></figure>

<ul>
<li>关闭交换分区，提升性能</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">临时关闭</span></span><br><span class="line">swapoff -a </span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">永久关闭：注释 swap 挂载，给 swap 这行开头加一下注释</span></span><br><span class="line">vim /etc/fstab </span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">/dev/mapper/centos-swap swap swap defaults 0 0</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">如果是克隆的虚拟机，需要删除 UUID</span></span><br></pre></td></tr></table></figure>

<ul>
<li>修改机器内核参数</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">modprobe br_netfilter </span><br><span class="line">echo &quot;modprobe br_netfilter&quot; &gt;&gt; /etc/profile </span><br><span class="line"></span><br><span class="line">cat &gt; /etc/sysctl.d/k8s.conf &lt;&lt;EOF </span><br><span class="line">net.bridge.bridge-nf-call-ip6tables = 1 </span><br><span class="line">net.bridge.bridge-nf-call-iptables = 1 </span><br><span class="line">net.ipv4.ip_forward = 1 </span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">sysctl -p /etc/sysctl.d/k8s.conf</span><br></pre></td></tr></table></figure>

<ul>
<li>关闭firewalld防火墙</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">systemctl stop firewalld</span><br><span class="line">systemctl disable firewalld</span><br><span class="line">systemctl status firewalld</span><br></pre></td></tr></table></figure>

<ul>
<li>关闭selinux</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">修改 selinux 配置文件之后，重启机器，selinux 配置才能永久生效</span></span><br><span class="line">sed -i &#x27;s/SELINUX=enforcing/SELINUX=disabled/g&#x27; /etc/selinux/config</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">重启</span></span><br><span class="line">reboot</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">显示 Disabled 说明 selinux 已经关闭</span></span><br><span class="line">getenforce </span><br><span class="line">Disabled </span><br></pre></td></tr></table></figure>

<ul>
<li>配置阿里云repo源</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">备份基础repo源</span></span><br><span class="line">mkdir /root/repo.bak </span><br><span class="line">cd /etc/yum.repos.d/ </span><br><span class="line">mv * /root/repo.bak/</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">拉取阿里云repo源</span></span><br><span class="line">curl -o /etc/yum.repos.d/CentOS-Base.repo https://mirrors.aliyun.com/repo/Centos-7.repo</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">配置国内阿里云 docker 的 repo 源</span></span><br><span class="line">yum install yum-utils -y</span><br><span class="line"></span><br><span class="line">yum-config-manager --add-repo http://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">配置安装 k8s 组件需要的阿里云的 repo 源</span></span><br><span class="line">cat &gt; /etc/yum.repos.d/kubernetes.repo &lt;&lt; EOF</span><br><span class="line">[kubernetes] </span><br><span class="line">name=Kubernetes </span><br><span class="line">baseurl=https://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64/ </span><br><span class="line">enabled=1 </span><br><span class="line">gpgcheck=0</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<ul>
<li>配置时间同步</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">安装 ntpdate 命令</span></span><br><span class="line">yum install ntpdate -y</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">跟网络时间做同步</span></span><br><span class="line">ntpdate cn.pool.ntp.org</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">把时间同步做成计划任务</span></span><br><span class="line">crontab -e </span><br><span class="line">* */1 * * * /usr/sbin/ntpdate cn.pool.ntp.org</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">重启 crond 服务</span></span><br><span class="line">service crond restart</span><br></pre></td></tr></table></figure>

<ul>
<li>开启 ipvs</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">编写脚本开启模块</span></span><br><span class="line">vim /etc/sysconfig/modules/ipvs.modules</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/bash</span></span><br><span class="line">ipvs_modules=&quot;ip_vs ip_vs_lc ip_vs_wlc ip_vs_rr ip_vs_wrr ip_vs_lblc ip_vs_lblcr ip_vs_dh ip_vs_sh ip_vs_nq ip_vs_sed ip_vs_ftp nf_conntrack&quot;</span><br><span class="line">for kernel_module in $&#123;ipvs_modules&#125;; do</span><br><span class="line"> /sbin/modinfo -F filename $&#123;kernel_module&#125; &gt; /dev/null 2&gt;&amp;1</span><br><span class="line"> if [ 0 -eq 0 ]; then</span><br><span class="line"> /sbin/modprobe $&#123;kernel_module&#125;</span><br><span class="line"> fi</span><br><span class="line">done</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">执行脚本，查看模块是否开启</span></span><br><span class="line">chmod 755 /etc/sysconfig/modules/ipvs.modules &amp;&amp; bash /etc/sysconfig/modules/ipvs.modules &amp;&amp; lsmod | grep ip_vs</span><br><span class="line"></span><br><span class="line">ip_vs_ftp 13079 0 </span><br><span class="line">nf_nat 26583 1 ip_vs_ftp </span><br><span class="line">ip_vs_sed 12519 0 </span><br><span class="line">ip_vs_nq 12516 0 </span><br><span class="line">ip_vs_sh 12688 0 </span><br><span class="line">ip_vs_dh 12688 0</span><br></pre></td></tr></table></figure>

<ul>
<li>安装基础软件包</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install -y yum-utils device-mapper-persistent-data lvm2 wget net-tools nfs-utils lrzsz gcc gcc-c++ make cmake libxml2-devel openssl-devel curl curl-devel unzip sudo ntp libaio-devel wget vim ncurses-devel autoconf automake zlib-devel python-devel epel-release openssh-server socat ipvsadm conntrack ntpdate telnet bash-completion</span><br></pre></td></tr></table></figure>

<ul>
<li>安装 iptables</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">如果用 firewalld 不习惯，可以安装 iptables</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">安装 iptables</span></span><br><span class="line">yum install iptables-services -y</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">禁用 iptables</span></span><br><span class="line">service iptables stop &amp;&amp; systemctl disable iptables</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">清空防火墙规则</span></span><br><span class="line">iptables -F</span><br></pre></td></tr></table></figure>

<h2 id="安装docker-1"><a href="#安装docker-1" class="headerlink" title="安装docker"></a>安装docker</h2><blockquote>
<p>所有节点做相同操作</p>
</blockquote>
<ul>
<li>安装docker-ce</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">yum install docker-ce-20.10.6 docker-ce-cli-20.10.6 containerd.io -y</span><br><span class="line"> </span><br><span class="line">systemctl start docker &amp;&amp; systemctl enable docker</span><br><span class="line">systemctl status docker</span><br></pre></td></tr></table></figure>

<ul>
<li>配置 docker 镜像加速器和驱动</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/docker/daemon.json </span><br><span class="line">&#123; </span><br><span class="line"> &quot;registry-mirrors&quot;:[&quot;https://rsbud4vc.mirror.aliyuncs.com&quot;,&quot;https://registry.docker-cn.com&quot;,&quot;https://docker.mirrors.ustc.edu.cn&quot;,&quot;https://dockerhub.azk8s.cn&quot;,&quot;http://hub-mirror.c.163.com&quot;,&quot;http://qtid6917.mirror.aliyuncs.com&quot;,&quot;https://rncxm540.mirror.aliyuncs.com&quot;], </span><br><span class="line"> &quot;exec-opts&quot;: [&quot;native.cgroupdriver=systemd&quot;] </span><br><span class="line">&#125;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">修改 docker 文件驱动为 systemd，默认为 cgroupfs，kubelet 默认使用 systemd，两者必须一致才可以。</span></span><br><span class="line"></span><br><span class="line">systemctl daemon-reload &amp;&amp; systemctl restart docker </span><br><span class="line">systemctl status docker</span><br></pre></td></tr></table></figure>

<h2 id="安装初始化-k8s-需要的软件包-1"><a href="#安装初始化-k8s-需要的软件包-1" class="headerlink" title="安装初始化 k8s 需要的软件包"></a>安装初始化 k8s 需要的软件包</h2><blockquote>
<p>所有节点做相同操作</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">yum install -y kubelet-1.20.6 kubeadm-1.20.6 kubectl-1.20.6</span><br><span class="line"></span><br><span class="line">systemctl enable kubelet &amp;&amp; systemctl start kubelet</span><br><span class="line"><span class="meta prompt_"> </span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">可以看到 kubelet 状态不是 running 状态，这个是正常的，不用管，等 k8s 组件起来这个kubelet 就正常了。</span></span><br><span class="line">systemctl status kubelet</span><br><span class="line"></span><br><span class="line">● kubelet.service - kubelet: The Kubernetes Node Agent</span><br><span class="line">   Loaded: loaded (/usr/lib/systemd/system/kubelet.service; enabled; vendor preset: disabled)</span><br><span class="line">  Drop-In: /usr/lib/systemd/system/kubelet.service.d</span><br><span class="line">           └─10-kubeadm.conf</span><br><span class="line">   Active: activating (auto-restart) (Result: exit-code) since 日 2023-07-16 12:16:23 CST; 9s ago</span><br><span class="line">     Docs: https://kubernetes.io/docs/</span><br><span class="line">  Process: 13693 ExecStart=/usr/bin/kubelet $KUBELET_KUBECONFIG_ARGS $KUBELET_CONFIG_ARGS $KUBELET_KUBEADM_ARGS $KUBELET_EXTRA_ARGS (code=exited, status=255)</span><br><span class="line"> Main PID: 13693 (code=exited, status=255)</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">注：每个软件包的作用</span> </span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Kubeadm: kubeadm 是一个工具，用来初始化 k8s 集群的</span> </span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">kubelet: 安装在集群所有节点上，用于启动 Pod 的</span> </span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">kubectl: 通过 kubectl 可以部署和管理应用，查看各种资源，创建、删除和更新各种组件</span></span><br></pre></td></tr></table></figure>

<h2 id="kubeadm-初始化-k8s-集群-1"><a href="#kubeadm-初始化-k8s-集群-1" class="headerlink" title="kubeadm 初始化 k8s 集群"></a>kubeadm 初始化 k8s 集群</h2><blockquote>
<p>把初始化k8s集群需要的离线镜像包上传到master1、node1、node2机器上，手动解压</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[root@master1 ~]# docker load -i k8simage-1-20-6.tar.gz</span><br><span class="line"></span><br><span class="line">[root@node1 ~]# docker load -i k8simage-1-20-6.tar.gz</span><br><span class="line"></span><br><span class="line">[root@node2 ~]# docker load -i k8simage-1-20-6.tar.gz</span><br><span class="line"></span><br><span class="line">[root@master1 ~]# kubeadm init --kubernetes-version=1.20.6 --apiserver-advertise-address=192.168.1.180 --image-repository registry.aliyuncs.com/google_containers --pod-network-cidr=10.244.0.0/16 --ignore-preflight-errors=SystemVerification</span><br><span class="line"></span><br><span class="line">[root@master1 ~]# mkdir -p $HOME/.kube </span><br><span class="line">[root@master1 ~]# sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config </span><br><span class="line">[root@master1 ~]# sudo chown $(id -u):$(id -g) $HOME/.kube/config</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@master1 ~]# kubectl get nodes</span><br><span class="line">NAME      STATUS     ROLES                  AGE   VERSION</span><br><span class="line">master1   NotReady   control-plane,master   58s   v1.20.6</span><br></pre></td></tr></table></figure>

<h2 id="扩容k8s集群-添加node节点"><a href="#扩容k8s集群-添加node节点" class="headerlink" title="扩容k8s集群-添加node节点"></a>扩容k8s集群-添加node节点</h2><blockquote>
<p>在master1上查看加入节点的命令</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@master1 ~]# kubeadm token create --print-join-command</span><br><span class="line"></span><br><span class="line">kubeadm join 192.168.1.180:6443 --token h332xz.35p2obvl5vzmd3tc     --discovery-token-ca-cert-hash sha256:89587e415db91f3f23eb029d3d7871f1dd1fa3562240277d2f49eed4f9d86f7c</span><br></pre></td></tr></table></figure>

<blockquote>
<p>在两个node节点上执行</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@node1 ~]# kubeadm join 192.168.1.180:6443 --token h332xz.35p2obvl5vzmd3tc     --discovery-token-ca-cert-hash sha256:89587e415db91f3f23eb029d3d7871f1dd1fa3562240277d2f49eed4f9d86f7c --ignore-preflight-errors=SystemVerification</span><br><span class="line"></span><br><span class="line">[root@node2 ~]# kubeadm join 192.168.1.180:6443 --token h332xz.35p2obvl5vzmd3tc     --discovery-token-ca-cert-hash sha256:89587e415db91f3f23eb029d3d7871f1dd1fa3562240277d2f49eed4f9d86f7c --ignore-preflight-errors=SystemVerification</span><br></pre></td></tr></table></figure>

<ul>
<li>查看</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@master1 ~]# kubectl get nodes</span><br><span class="line">NAME      STATUS     ROLES                  AGE     VERSION</span><br><span class="line">master1   NotReady   control-plane,master   3m31s   v1.20.6</span><br><span class="line">node1     NotReady   &lt;none&gt;                 110s    v1.20.6</span><br><span class="line">node2     NotReady   &lt;none&gt;                 81s     v1.20.6</span><br></pre></td></tr></table></figure>

<ul>
<li>给node节点打标签</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@master1 ~]# kubectl label node node1 node-role.kubernetes.io/worker=worker</span><br><span class="line"></span><br><span class="line">[root@master1 ~]# kubectl label node node2 node-role.kubernetes.io/worker=worker</span><br><span class="line"></span><br><span class="line">[root@master1 ~]# kubectl get nodes</span><br><span class="line">NAME      STATUS     ROLES                  AGE     VERSION</span><br><span class="line">master1   NotReady   control-plane,master   3m57s   v1.20.6</span><br><span class="line">node1     NotReady   worker                 2m16s   v1.20.6</span><br><span class="line">node2     NotReady   worker                 107s    v1.20.6</span><br></pre></td></tr></table></figure>

<h2 id="安装kubernetes网络组件calico"><a href="#安装kubernetes网络组件calico" class="headerlink" title="安装kubernetes网络组件calico"></a>安装kubernetes网络组件calico</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">[root@master1 ~]# kubectl apply -f calico.yaml</span><br><span class="line"></span><br><span class="line">[root@master1 ~]# kubectl get pod -n kube-system</span><br><span class="line">NAME                                       READY   STATUS    RESTARTS   AGE</span><br><span class="line">calico-kube-controllers-6949477b58-62b8l   1/1     Running   0          80s</span><br><span class="line">calico-node-4s4xl                          1/1     Running   0          80s</span><br><span class="line">calico-node-lpml4                          1/1     Running   0          80s</span><br><span class="line">calico-node-qbs7m                          1/1     Running   0          80s</span><br><span class="line">coredns-7f89b7bc75-qmmp6                   1/1     Running   0          6m1s</span><br><span class="line">coredns-7f89b7bc75-rpkgn                   1/1     Running   0          6m1s</span><br><span class="line">etcd-master1                               1/1     Running   0          6m16s</span><br><span class="line">kube-apiserver-master1                     1/1     Running   1          6m16s</span><br><span class="line">kube-controller-manager-master1            1/1     Running   0          6m15s</span><br><span class="line">kube-proxy-4c7zm                           1/1     Running   0          4m38s</span><br><span class="line">kube-proxy-lr4vd                           1/1     Running   0          6m1s</span><br><span class="line">kube-proxy-vm6m4                           1/1     Running   0          4m9s</span><br><span class="line">kube-scheduler-master1                     1/1     Running   0          6m16s</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@master1 ~]# kubectl get nodes</span><br><span class="line">NAME      STATUS   ROLES                  AGE     VERSION</span><br><span class="line">master1   Ready    control-plane,master   6m35s   v1.20.6</span><br><span class="line">node1     Ready    worker                 4m54s   v1.20.6</span><br><span class="line">node2     Ready    worker                 4m25s   v1.20.6</span><br></pre></td></tr></table></figure>

<ul>
<li>测试在 k8s 创建 pod 是否可以正常访问网络</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@master1 ~]# kubectl run busybox --image busybox:1.28 --restart=Never --rm -it busybox -- sh</span><br><span class="line"></span><br><span class="line">/ # ping www.baidu.com</span><br><span class="line">PING www.baidu.com (39.156.66.18): 56 data bytes</span><br><span class="line">64 bytes from 39.156.66.18: seq=0 ttl=127 time=39.3 ms</span><br></pre></td></tr></table></figure>

<h2 id="安装k8s可视化UI界面dashboard"><a href="#安装k8s可视化UI界面dashboard" class="headerlink" title="安装k8s可视化UI界面dashboard"></a>安装k8s可视化UI界面dashboard</h2><blockquote>
<p>把kubernetes-dashboard需要的镜像上传到工作阶段node1、node2</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@node1 ~]# docker load -i dashboard_2_0_0.tar.gz </span><br><span class="line"></span><br><span class="line">[root@node1 ~]# docker load -i metrics-scrapter-1-0-1.tar.gz</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@node2 ~]# docker load -i dashboard_2_0_0.tar.gz </span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">[root@node2~]# </span><span class="language-bash">docker load -i metrics-scrapter-1-0-1.tar.gz</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>上传dashboard的yaml文件到master1</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">[root@master1 ~]# kubectl apply -f kubernetes-dashboard.yaml </span><br><span class="line"></span><br><span class="line">[root@master1 ~]# kubectl get pods -n kubernetes-dashboard</span><br><span class="line">NAME                                         READY   STATUS    RESTARTS   AGE</span><br><span class="line">dashboard-metrics-scraper-7445d59dfd-kpqmf   1/1     Running   0          53s</span><br><span class="line">kubernetes-dashboard-54f5b6dc4b-h6v64        1/1     Running   0          53s</span><br><span class="line"></span><br><span class="line">[root@master1 ~]# kubectl get svc -n kubernetes-dashboard</span><br><span class="line">NAME                        TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)    AGE</span><br><span class="line">dashboard-metrics-scraper   ClusterIP   10.100.210.13   &lt;none&gt;        8000/TCP   80s</span><br><span class="line">kubernetes-dashboard        ClusterIP   10.109.67.144   &lt;none&gt;        443/TCP    80s</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">修改service <span class="built_in">type</span>类型为NodePort</span></span><br><span class="line">[root@master1 ~]# kubectl edit svc kubernetes-dashboard -n kubernetes-dashboard</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">把 <span class="built_in">type</span>: ClusterIP 变成 <span class="built_in">type</span>: NodePort，保存退出即可</span></span><br><span class="line"></span><br><span class="line">[root@master1 ~]# kubectl get svc -n kubernetes-dashboard</span><br><span class="line">NAME                        TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)         AGE</span><br><span class="line">dashboard-metrics-scraper   ClusterIP   10.100.210.13   &lt;none&gt;        8000/TCP        3m3s</span><br><span class="line">kubernetes-dashboard        NodePort    10.109.67.144   &lt;none&gt;        443:32240/TCP   3m3s</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">浏览器访问https://任意节点IP:32240访问kubernetes-dashboard</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>通过token令牌访问dashboard</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">创建管理员 token，具有查看任何空间的权限，可以管理所有资源对象</span></span><br><span class="line">[root@master1 ~]# kubectl create clusterrolebinding dashboard-cluster-admin --clusterrole=cluster-admin --serviceaccount=kubernetes-dashboard:kubernetes-dashboard</span><br><span class="line"></span><br><span class="line">[root@master1 ~]# kubectl get secret -n kubernetes-dashboard</span><br><span class="line">NAME                               TYPE                                  DATA   AGE</span><br><span class="line">default-token-hwqss                kubernetes.io/service-account-token   3      5m42s</span><br><span class="line">kubernetes-dashboard-certs         Opaque                                0      5m42s</span><br><span class="line">kubernetes-dashboard-csrf          Opaque                                1      5m42s</span><br><span class="line">kubernetes-dashboard-key-holder    Opaque                                2      5m42s</span><br><span class="line">kubernetes-dashboard-token-rtrkj   kubernetes.io/service-account-token   3      5m42s</span><br><span class="line"></span><br><span class="line">[root@master1 ~]# kubectl describe secret kubernetes-dashboard-token-rtrkj -n kubernetes-dashboard</span><br><span class="line">Name:         kubernetes-dashboard-token-rtrkj</span><br><span class="line">Namespace:    kubernetes-dashboard</span><br><span class="line">Labels:       &lt;none&gt;</span><br><span class="line">Annotations:  kubernetes.io/service-account.name: kubernetes-dashboard</span><br><span class="line">              kubernetes.io/service-account.uid: 62c6073e-c3ee-456f-8107-0afe0198a205</span><br><span class="line"></span><br><span class="line">Type:  kubernetes.io/service-account-token</span><br><span class="line"></span><br><span class="line">Data</span><br><span class="line">====</span><br><span class="line">ca.crt:     1066 bytes</span><br><span class="line">namespace:  20 bytes</span><br><span class="line">token:      eyJhbGciOiJSUzI1NiIsImtpZCI6IjBCaXlVcWRjT29MSUhNVDdCOXN0TmpfUXNBdEhSdnBVazZqRWNKNENSRFEifQ.eyJpc3MiOiJrdWJlcm5ldGVzL3NlcnZpY2VhY2NvdW50Iiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9uYW1lc3BhY2UiOiJrdWJlcm5ldGVzLWRhc2hib2FyZCIsImt1YmVybmV0ZXMuaW8vc2VydmljZWFjY291bnQvc2VjcmV0Lm5hbWUiOiJrdWJlcm5ldGVzLWRhc2hib2FyZC10b2tlbi1ydHJraiIsImt1YmVybmV0ZXMuaW8vc2VydmljZWFjY291bnQvc2VydmljZS1hY2NvdW50Lm5hbWUiOiJrdWJlcm5ldGVzLWRhc2hib2FyZCIsImt1YmVybmV0ZXMuaW8vc2VydmljZWFjY291bnQvc2VydmljZS1hY2NvdW50LnVpZCI6IjYyYzYwNzNlLWMzZWUtNDU2Zi04MTA3LTBhZmUwMTk4YTIwNSIsInN1YiI6InN5c3RlbTpzZXJ2aWNlYWNjb3VudDprdWJlcm5ldGVzLWRhc2hib2FyZDprdWJlcm5ldGVzLWRhc2hib2FyZCJ9.Vy6P6WIyZW_CoKe0I3o3hUE7lnTdic8_C7vKS1iIXsqmwV7HruQbzW-Lt53HpnI5LixgXZWLFWnOHo9mpxAOdPRklucXGEi2s_fCbPp-_vx5hBC6HJvDrtM1iwyx0Hrcbi0auB6zNB_hS0qxMq7pFVEAc0oCeooI_EwH6Zm7xl5keZh4uixIhuMJKTtfOLLoolu6QGpS_W769PNeLvHmsogTgu53COrVP4m0s6P9_tVE5peYj3WeKfh7WO78dcmApxlclRJ4vjyyQe_XnldGNZ0pX60kgUMrufIxjKGx0pIouPJLlSOVJ8po5KUIaEKvQePm8CxpnCY531k6JukUnw</span><br></pre></td></tr></table></figure>

<blockquote>
<p>通过 kubeconfig 文件访问 dashboard</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">创建 cluster 集群</span></span><br><span class="line">[root@master1 ~]# cd /etc/kubernetes/pki</span><br><span class="line"></span><br><span class="line">[root@master1 pki]# kubectl config set-cluster kubernetes --certificate-authority=./ca.crt --server=&quot;https://192.168.1.180:6443&quot; --embed-certs=true --kubeconfig=/root/dashboard-admin.conf</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">创建credentials</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">创建 credentials 需要使用上面的 kubernetes-dashboard-token-rtrkj 对应的 token 信息</span></span><br><span class="line">[root@master1 pki]# DEF_NS_ADMIN_TOKEN=$(kubectl get secret kubernetes-dashboard-token-rtrkj -n kubernetes-dashboard -o jsonpath=&#123;.data.token&#125;|base64 -d)</span><br><span class="line"></span><br><span class="line">[root@master1 pki]# kubectl config set-credentials dashboard-admin --token=$DEF_NS_ADMIN_TOKEN --kubeconfig=/root/dashboard-admin.conf</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">创建context</span></span><br><span class="line">[root@master1 pki]# kubectl config set-context dashboard-admin@kubernetes --cluster=kubernetes --user=dashboard-admin --kubeconfig=/root/dashboard-admin.conf</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">切换 context 的 current-context 是 dashboard-admin@kubernetes</span></span><br><span class="line">[root@master1 pki]# kubectl config use-context dashboard-admin@kubernetes --kubeconfig=/root/dashboard-admin.conf</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">把刚才的 kubeconfig 文件 dashboard-admin.conf 复制到桌面</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">浏览器访问时使用 kubeconfig 认证，把刚才的 dashboard-admin.conf 导入到 web 界面，那么就可以登陆了</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>通过kubernetes-dashboard创建容器</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">把 nginx.tar.gz 镜像压缩包上传到 node1 和 node2 上，手动解压</span></span><br><span class="line"></span><br><span class="line">docker load -i nginx.tar.gz</span><br></pre></td></tr></table></figure>

<p><img src="../../../../images/image/k8s-han/9.png" alt="9"></p>
<p><img src="../../../../images/image/k8s-han/10.png" alt="10"></p>
<p><img src="../../../../images/image/k8s-han/11.png" alt="11"></p>
<p><img src="../../../../images/image/k8s-han/12.png" alt="12"></p>
<p><img src="../../../../images/image/k8s-han/13.png" alt="13"></p>
<ul>
<li>访问192.168.1.180:31362</li>
</ul>
<p><img src="../../../../images/image/k8s-han/14.png" alt="14"></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">应用名称：nginx</span><br><span class="line">容器镜像：nginx</span><br><span class="line">pod数量：2</span><br><span class="line">service：external外部网络</span><br><span class="line">port：80</span><br><span class="line">targetport：80</span><br><span class="line"></span><br><span class="line">注：表单中创建 pod 时没有创建 nodeport 的选项，会自动创建在 30000+以上的端口。 </span><br><span class="line"> </span><br><span class="line">关于 port、targetport、nodeport 的说明： </span><br><span class="line">nodeport 是集群外流量访问集群内服务的端口，比如客户访问 nginx，apache</span><br><span class="line">port 是集群内的 pod 互相通信用的端口类型，比如 nginx 访问 mysql，而 mysql 是不需要让客户访问到的，port 是 service 的的端口 </span><br><span class="line">targetport 目标端口，也就是最终端口，也就是 pod 的端口</span><br></pre></td></tr></table></figure>

<h2 id="安装-metrics-server-组件"><a href="#安装-metrics-server-组件" class="headerlink" title="安装 metrics-server 组件"></a>安装 metrics-server 组件</h2><blockquote>
<p>metrics-server 是一个集群范围内的资源数据集和工具，同样的，metrics-server 也只是显示数据，并不提供数据存储服务，主要关注的是资源度量 API 的实现，比如 CPU、文件描述符、内存、请求延时等指标，metric-server 收集数据给 k8s 集群内使用，如 kubectl,hpa,scheduler 等</p>
</blockquote>
<ul>
<li>部署metrics-server组件</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">把离线镜像压缩包上传到 k8s 的各个节点，按如下方法手动解压</span></span><br><span class="line">[root@master1 ~]# docker load -i metrics-server-amd64-0-3-6.tar.gz </span><br><span class="line"></span><br><span class="line">[root@master1 ~]# docker load -i addon.tar.gz</span><br><span class="line"></span><br><span class="line">[root@node1 ~]# docker load -i metrics-server-amd64-0-3-6.tar.gz </span><br><span class="line"></span><br><span class="line">[root@node1 ~]# docker load -i addon.tar.gz</span><br><span class="line"></span><br><span class="line">[root@node2 ~]# docker load -i metrics-server-amd64-0-3-6.tar.gz </span><br><span class="line"></span><br><span class="line">[root@node2 ~]# docker load -i addon.tar.gz</span><br></pre></td></tr></table></figure>

<ul>
<li>部署metrics-server服务</li>
</ul>
<blockquote>
<p>在/etc/kubernetes/manifests 里面改一下 apiserver 的配置</p>
<p>注意：这个是 k8s 在 1.17 的新特性，如果是 1.16 版本的可以不用添加，1.17 以后要添加。这个参数的作用是 Aggregation 允许在不修改 Kubernetes 核心代码的同时扩展 Kubernetes API。</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">[root@master1 ~]# vim /etc/kubernetes/manifests/kube-apiserver.yaml</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">增加如下内容：</span> </span><br><span class="line">- --enable-aggregator-routing=true</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">重新更新apiserver配置</span></span><br><span class="line">[root@master1 ~]# kubectl apply -f /etc/kubernetes/manifests/kube-apiserver.yaml</span><br><span class="line"></span><br><span class="line">[root@master1 ~]# kubectl get pods -n kube-system</span><br><span class="line">NAME                                       READY   STATUS             RESTARTS   AGE</span><br><span class="line">calico-kube-controllers-6949477b58-62b8l   1/1     Running            0          11h</span><br><span class="line">calico-node-4s4xl                          1/1     Running            0          11h</span><br><span class="line">calico-node-lpml4                          1/1     Running            0          11h</span><br><span class="line">calico-node-qbs7m                          1/1     Running            0          11h</span><br><span class="line">coredns-7f89b7bc75-qmmp6                   1/1     Running            0          11h</span><br><span class="line">coredns-7f89b7bc75-rpkgn                   1/1     Running            0          11h</span><br><span class="line">etcd-master1                               1/1     Running            0          11h</span><br><span class="line">kube-apiserver                             0/1     CrashLoopBackOff   1          16s</span><br><span class="line">kube-apiserver-master1                     1/1     Running            0          52s</span><br><span class="line">kube-controller-manager-master1            1/1     Running            1          11h</span><br><span class="line">kube-proxy-4c7zm                           1/1     Running            0          11h</span><br><span class="line">kube-proxy-lr4vd                           1/1     Running            0          11h</span><br><span class="line">kube-proxy-vm6m4                           1/1     Running            0          11h</span><br><span class="line">kube-scheduler-master1                     1/1     Running            1          11h</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">CrashLoopBackOff 状态的 pod 删除</span></span><br><span class="line">[root@master1 ~]# kubectl delete pods kube-apiserver -n kube-system</span><br><span class="line"></span><br><span class="line">[root@master1 ~]# kubectl apply -f metrics.yaml</span><br><span class="line"></span><br><span class="line">[root@master1 ~]# kubectl get pods -n kube-system | grep metrics</span><br><span class="line">metrics-server-6595f875d6-hfgbk            2/2     Running   0          28s</span><br></pre></td></tr></table></figure>

<ul>
<li>测试kubectl top命令</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">[root@master1 ~]# kubectl top pods -n kube-system</span><br><span class="line">NAME                                       CPU(cores)   MEMORY(bytes)   </span><br><span class="line">calico-kube-controllers-6949477b58-62b8l   1m           25Mi            </span><br><span class="line">calico-node-4s4xl                          31m          77Mi            </span><br><span class="line">calico-node-lpml4                          37m          85Mi            </span><br><span class="line">calico-node-qbs7m                          36m          80Mi            </span><br><span class="line">coredns-7f89b7bc75-qmmp6                   4m           25Mi            </span><br><span class="line">coredns-7f89b7bc75-rpkgn                   4m           21Mi            </span><br><span class="line">etcd-master1                               21m          82Mi            </span><br><span class="line">kube-apiserver-master1                     59m          399Mi           </span><br><span class="line">kube-controller-manager-master1            18m          49Mi            </span><br><span class="line">kube-proxy-4c7zm                           1m           10Mi            </span><br><span class="line">kube-proxy-lr4vd                           1m           10Mi            </span><br><span class="line">kube-proxy-vm6m4                           1m           10Mi            </span><br><span class="line">kube-scheduler-master1                     4m           25Mi            </span><br><span class="line">metrics-server-6595f875d6-hfgbk            1m           16Mi</span><br><span class="line"></span><br><span class="line">[root@master1 ~]# kubectl top nodes</span><br><span class="line">NAME      CPU(cores)   CPU%   MEMORY(bytes)   MEMORY%   </span><br><span class="line">master1   181m         4%     2157Mi          56%       </span><br><span class="line">node1     92m          2%     1686Mi          44%       </span><br><span class="line">node2     100m         2%     1698Mi          44% </span><br></pre></td></tr></table></figure>

<h2 id="把-scheduler、controller-manager-端口变成物理机可以监听的端口"><a href="#把-scheduler、controller-manager-端口变成物理机可以监听的端口" class="headerlink" title="把 scheduler、controller-manager 端口变成物理机可以监听的端口"></a>把 scheduler、controller-manager 端口变成物理机可以监听的端口</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@master1 ~]# kubectl get cs</span><br><span class="line">Warning: v1 ComponentStatus is deprecated in v1.19+</span><br><span class="line">NAME                 STATUS      MESSAGE                                                                                       ERROR</span><br><span class="line">scheduler            Unhealthy   Get &quot;http://127.0.0.1:10251/healthz&quot;: dial tcp 127.0.0.1:10251: connect: connection refused   </span><br><span class="line">controller-manager   Unhealthy   Get &quot;http://127.0.0.1:10252/healthz&quot;: dial tcp 127.0.0.1:10252: connect: connection refused   </span><br><span class="line">etcd-0               Healthy     &#123;&quot;health&quot;:&quot;true&quot;&#125; </span><br></pre></td></tr></table></figure>

<blockquote>
<p>默认在 1.19 之后 10252 和 10251 都是绑定在 127 的，如果想要通过 prometheus 监控，会采集不到数据，所以可以把端口绑定到物理机</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">可按如下方法处理：</span></span><br><span class="line">vim /etc/kubernetes/manifests/kube-scheduler.yaml</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">修改如下内容：</span></span><br><span class="line">把--bind-address=127.0.0.1 变成--bind-address=192.168.1.180</span><br><span class="line">把 httpGet:字段下的 hosts 由 127.0.0.1 变成 192.168.1.180</span><br><span class="line">把—port=0 删除</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">注意：192.168.1.180 是 k8s 的控制节点 master1 的 ip</span></span><br><span class="line"></span><br><span class="line">vim /etc/kubernetes/manifests/kube-controller-manager.yaml</span><br><span class="line">把--bind-address=127.0.0.1 变成--bind-address=192.168.1.180</span><br><span class="line">把 httpGet:字段下的 hosts 由 127.0.0.1 变成 192.168.1.180</span><br><span class="line">把—port=0 删除</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">修改之后在 k8s 各个节点重启下 kubelet</span></span><br><span class="line"></span><br><span class="line">systemctl restart kubelet</span><br><span class="line"></span><br><span class="line">[root@master1 ~]# kubectl get cs</span><br><span class="line">Warning: v1 ComponentStatus is deprecated in v1.19+</span><br><span class="line">NAME                 STATUS    MESSAGE             ERROR</span><br><span class="line">scheduler            Healthy   ok                  </span><br><span class="line">controller-manager   Healthy   ok                  </span><br><span class="line">etcd-0               Healthy   &#123;&quot;health&quot;:&quot;true&quot;&#125;</span><br><span class="line"></span><br><span class="line">[root@master1 ~]# ss -antulp | grep 10251</span><br><span class="line">tcp    LISTEN     0      128      :::10251                :::*                   users:((&quot;kube-scheduler&quot;,pid=16849,fd=7))</span><br><span class="line"></span><br><span class="line">[root@master1 ~]# ss -antulp | grep 10252</span><br><span class="line">tcp    LISTEN     0      128      :::10252                :::*                   users:((&quot;kube-controller&quot;,pid=17730,fd=7)) </span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">可以看到相应的端口已经被物理机监听了</span></span><br></pre></td></tr></table></figure>

<h1 id="Pod基础"><a href="#Pod基础" class="headerlink" title="Pod基础"></a>Pod基础</h1><h2 id="k8s核心资源Pod介绍"><a href="#k8s核心资源Pod介绍" class="headerlink" title="k8s核心资源Pod介绍"></a>k8s核心资源Pod介绍</h2><blockquote>
<p>K8s 官方文档：<a target="_blank" rel="noopener" href="https://kubernetes.io/">https://kubernetes.io/</a></p>
<p>K8s 中文官方文档：<a target="_blank" rel="noopener" href="https://kubernetes.io/zh/">https://kubernetes.io/zh/</a></p>
<p>K8s Github 地址：<a target="_blank" rel="noopener" href="https://github.com/kubernetes/">https://github.com/kubernetes/</a></p>
</blockquote>
<h3 id="Pod是什么"><a href="#Pod是什么" class="headerlink" title="Pod是什么"></a>Pod是什么</h3><ul>
<li>官方文档：<a target="_blank" rel="noopener" href="https://kubernetes.io/docs/concepts/workloads/pods/">https://kubernetes.io/docs/concepts/workloads/pods/</a></li>
</ul>
<p>Pod 是 Kubernetes 中的最小调度单元，k8s 是通过定义一个 Pod 的资源，然后在 Pod 里面运行容器，容器需要指定一个镜像，这样就可以用来运行具体的服务。一个 Pod 封装一个容器（也可以封装多个容器），Pod 里的容器共享存储、网络等。也就是说，应该把整个 pod 看作虚拟机，然后每个容器相当于运行在虚拟机的进程。</p>
<p><img src="../../../../images/image/k8s-han/15.png" alt="15"></p>
<blockquote>
<p>Pod 是需要调度到 k8s 集群的工作节点来运行的，具体调度到哪个节点，是根据 scheduler 调度器实现的。</p>
</blockquote>
<h4 id="Pod-如何管理多个容器"><a href="#Pod-如何管理多个容器" class="headerlink" title="Pod 如何管理多个容器"></a>Pod 如何管理多个容器</h4><p><img src="../../../../images/image/k8s-han/16.png" alt="16"></p>
<ul>
<li>Pod 中可以同时运行多个容器。同一个 Pod 中的容器会自动的分配到同一个 node 上。</li>
<li>同一个 Pod 中的容器共享资源、网络环境，它们总是被同时调度，在一个 Pod 中同时运行多个容器是一种比较高级的用法，只有当你的容器需要紧密配合协作的时候才考虑用这种模式。</li>
<li>例如，你有一个容器作为 web 服务器运行，需要用到共享的 volume，有另一个“sidecar”容器来从远端获取资源更新这些文件。</li>
</ul>
<blockquote>
<p>一些 Pod 有 init 容器和应用容器。 在应用程序容器启动之前，运行初始化容器。</p>
</blockquote>
<h4 id="Pod网络"><a href="#Pod网络" class="headerlink" title="Pod网络"></a>Pod网络</h4><ul>
<li><p>Pod 是有 IP 地址的，每个 pod 都被分配唯一的 IP 地址（IP 地址是靠网络插件 calico、flannel、weave 等分配的），POD 中的容器共享网络名称空间，包括 IP 地址和网络端口。 </p>
</li>
<li><p>Pod 内部的容器可以使用 localhost 相互通信。 Pod 中的容器也可以通过网络插件 calico 与其他节点的 Pod 通信。</p>
</li>
</ul>
<h4 id="Pod存储"><a href="#Pod存储" class="headerlink" title="Pod存储"></a>Pod存储</h4><ul>
<li>创建 Pod 的时候可以指定挂载的存储卷。 POD 中的所有容器都可以访问共享卷，允许这些容器共享数据。 Pod 只要挂载持久化数据卷，Pod 重启之后数据还是会存在的。</li>
</ul>
<h2 id="Pod工作方式"><a href="#Pod工作方式" class="headerlink" title="Pod工作方式"></a>Pod工作方式</h2><blockquote>
<p>在 K8s 中，所有的资源都可以使用一个 yaml 文件来创建，创建 Pod 也可以使用 yaml 配置文件。或者使用 kubectl run 在命令行创建 Pod（不常用）。</p>
</blockquote>
<h3 id="自主式Pod"><a href="#自主式Pod" class="headerlink" title="自主式Pod"></a>自主式Pod</h3><ul>
<li>所谓的自主式 Pod，就是直接定义一个 Pod 资源</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[<span class="string">root@master1</span> <span class="string">~</span>]<span class="comment"># vim pod-tomcat.yaml</span></span><br><span class="line"></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">tomcat-test</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">tomcat</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">tomcat</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">tomcat</span></span><br><span class="line">    <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">8080</span></span><br></pre></td></tr></table></figure>

<ul>
<li>更新资源清单文件</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[root@master1 ~]# kubectl apply -f pod-tomcat.yaml</span><br><span class="line"></span><br><span class="line">[root@master1 ~]# kubectl get pods -o wide -l app=tomcat</span><br><span class="line">NAME          READY   STATUS    RESTARTS   AGE   IP               NODE    NOMINATED NODE   READINESS GATES</span><br><span class="line">tomcat-test   1/1     Running   0          70s   10.244.166.135   node1   &lt;none&gt;           &lt;none&gt;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">但是自主式 Pod 是存在一个问题的，假如我们不小心删除了 pod，pod就会被永久删除</span></span><br><span class="line">[root@master1 ~]# kubectl delete pods tomcat-test</span><br><span class="line"></span><br><span class="line">[root@master1 ~]# kubectl get pods -o wide -l app=tomcat</span><br><span class="line">No resources found in default namespace.</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">通过上面可以看到，如果直接定义一个 Pod 资源，那 Pod 被删除，就彻底被删除了，不会再创建一个新的 Pod</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">这在生产环境还是具有非常大风险的，所以今后我们接触的 Pod，都是控制器管理的。</span></span><br></pre></td></tr></table></figure>

<h3 id="控制器管理Pod"><a href="#控制器管理Pod" class="headerlink" title="控制器管理Pod"></a>控制器管理Pod</h3><blockquote>
<p>常见的管理 Pod 的控制器：Replicaset、Deployment、Job、CronJob、Daemonset、Statefulset。控制器管理的 Pod 可以确保 Pod 始终维持在指定的副本数运行。</p>
</blockquote>
<ul>
<li>通过 Deployment 管理 Pod</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">[<span class="string">root@master1</span> <span class="string">~</span>]<span class="comment"># vim nginx-deploy.yaml</span></span><br><span class="line"></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx-test</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">nginx-deploy</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">nginx-deploy</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">2</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">nginx-deploy</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">nginx</span></span><br><span class="line">        <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">80</span></span><br></pre></td></tr></table></figure>

<ul>
<li>更新资源清单文件</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">[root@master1 ~]# kubectl apply -f nginx-deploy.yaml</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">查看Deployment</span></span><br><span class="line">[root@master1 ~]# kubectl get deploy -l app=nginx-deploy</span><br><span class="line">NAME         READY   UP-TO-DATE   AVAILABLE   AGE</span><br><span class="line">nginx-test   2/2     2            2           77s</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">查看Replicaset</span></span><br><span class="line">[root@master1 ~]# kubectl get rs -l app=nginx-deploy</span><br><span class="line">NAME                    DESIRED   CURRENT   READY   AGE</span><br><span class="line">nginx-test-68b6d698b7   2         2         2       89s</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">查看Pod</span></span><br><span class="line">[root@master1 ~]# kubectl get pod -l app=nginx-deploy</span><br><span class="line">NAME                          READY   STATUS    RESTARTS   AGE</span><br><span class="line">nginx-test-68b6d698b7-qvpfg   1/1     Running   0          11m</span><br><span class="line">nginx-test-68b6d698b7-wxlq2   1/1     Running   0          11m</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">删除nginx-test-68b6d698b7-qvpfg这个pod</span></span><br><span class="line">[root@master1 ~]# kubectl delete pod nginx-test-68b6d698b7-qvpfg</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">会发现重新创建了一个pod nginx-test-68b6d698b7-7qsk8</span></span><br><span class="line">[root@master1 ~]# kubectl get pod -l app=nginx-deploy</span><br><span class="line">NAME                          READY   STATUS    RESTARTS   AGE</span><br><span class="line">nginx-test-68b6d698b7-7qsk8   1/1     Running   0          17s</span><br><span class="line">nginx-test-68b6d698b7-wxlq2   1/1     Running   0          12m</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">通过上面可以发现通过 deployment 管理的 pod，可以确保 pod 始终维持在指定副本数量</span></span><br></pre></td></tr></table></figure>

<h2 id="Pod创建具体流程"><a href="#Pod创建具体流程" class="headerlink" title="Pod创建具体流程"></a>Pod创建具体流程</h2><ul>
<li>k8s创建pod流程</li>
</ul>
<p><img src="../../../../images/image/k8s-han/17.png" alt="17"></p>
<ul>
<li>Pod 是 Kubernetes 中最基本的部署调度单元，可以包含 container，逻辑上表示某种应用的一个实例。</li>
<li>例如一个 web 站点应用由前端、后端及数据库构建而成，这三个组件将运行在各自的容器中，那么我们可以创建包含三个 container 的 pod。</li>
</ul>
<p><img src="../../../../images/image/k8s-han/18.png" alt="18"></p>
<ul>
<li>master 节点：kubectl -&gt; kube-api -&gt; kubelet -&gt; CRI 容器环境初始化</li>
</ul>
<p>第一步</p>
<ul>
<li>客户端提交创建 Pod 的请求，可以通过调用 API Server 的 Rest API 接口，也可以通过 kubectl 命令行工具。如 kubectl apply -f filename.yaml(资源清单文件)</li>
</ul>
<p>第二步</p>
<ul>
<li><code>apiserver</code> 接收到 pod 创建请求后，会将 yaml 中的属性信息(metadata)写入 <code>etcd</code>。</li>
</ul>
<p>第三步</p>
<ul>
<li><code>apiserver</code>触发 watch 机制准备创建 pod，信息转发给调度器 scheduler，调度器使用调度算法选择node，调度器将 node 信息给 apiserver，apiserver 将绑定的 node 信息写入 <code>etcd</code></li>
<li>调度器用一组规则过滤掉不符合要求的主机。比如 Pod 指定了所需要的资源量，那么可用资源比 Pod 需要的资源量少的主机会被过滤掉。</li>
<li>scheduler 查看 k8s api ，类似于通知机制。</li>
<li>首先判断：pod.spec.Node == null?</li>
<li>若为 null，表示这个 Pod 请求是新来的，需要创建；因此先进行调度计算，找到最“闲”的 node。</li>
<li>然后将信息在 etcd 数据库中更新分配结果：pod.spec.Node = nodeA (设置一个具体的节点)</li>
</ul>
<blockquote>
<p>ps:同样上述操作的各种信息也要写到 etcd 数据库中</p>
</blockquote>
<p>第四步</p>
<ul>
<li>apiserver 又通过 watch 机制，调用 kubelet，指定 pod 信息，调用 Docker API 创建并启动 pod 内的容器。</li>
</ul>
<p>第五步</p>
<ul>
<li>创建完成之后反馈给 kubelet, kubelet 又将 pod 的状态信息给 apiserver，apiserver 又将 pod 的状态信息写入 etcd。</li>
</ul>
<h2 id="Pod-资源清单编写技巧"><a href="#Pod-资源清单编写技巧" class="headerlink" title="Pod 资源清单编写技巧"></a>Pod 资源清单编写技巧</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">通过 kubectl explain 查看定义 Pod 资源包含哪些字段</span></span><br><span class="line">[root@master1 ~]# kubectl explain pod</span><br><span class="line">KIND:     Pod</span><br><span class="line">VERSION:  v1</span><br><span class="line"></span><br><span class="line">DESCRIPTION:</span><br><span class="line">     Pod is a collection of containers that can run on a host. This resource is</span><br><span class="line">     created by clients and scheduled onto hosts.</span><br><span class="line">     </span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">[Pod 是可以在主机上运行的容器的集合。此资源是由客户端创建并安排到主机上]</span></span><br><span class="line"></span><br><span class="line">FIELDS:</span><br><span class="line">   apiVersion	&lt;string&gt;</span><br><span class="line">     APIVersion defines the versioned schema of this representation of an</span><br><span class="line">     object. Servers should convert recognized schemas to the latest internal</span><br><span class="line">     value, and may reject unrecognized values. More info:</span><br><span class="line">     https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#resources</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">[APIVersion 定义了对象,代表了一个版本]</span></span><br><span class="line"></span><br><span class="line">   kind	&lt;string&gt;</span><br><span class="line">     Kind is a string value representing the REST resource this object</span><br><span class="line">     represents. Servers may infer this from the endpoint the client submits</span><br><span class="line">     requests to. Cannot be updated. In CamelCase. More info:</span><br><span class="line">     https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#types-kinds</span><br><span class="line">     </span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">[Kind 是字符串类型的值，代表了要创建的资源。服务器可以从客户端提交的请求推断出这个资源]</span></span><br><span class="line"></span><br><span class="line">   metadata	&lt;Object&gt;</span><br><span class="line">     Standard object&#x27;s metadata. More info:</span><br><span class="line">     https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#metadata</span><br><span class="line">     </span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">[metadata 是对象，定义元数据属性信息的]</span></span><br><span class="line"></span><br><span class="line">   spec	&lt;Object&gt;</span><br><span class="line">     Specification of the desired behavior of the pod. More info:</span><br><span class="line">     https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#spec-and-status</span><br><span class="line">     </span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">[spec 制定了定义 Pod 的规格，里面包含容器的信息]</span></span><br><span class="line">Docker 镜像信息等，例如时间戳、release id 号、镜像 hash 值、docker registry 地址等； </span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">日志库、监控库、分析库等资源库的地址信息；</span> </span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">程序调试工具信息，例如工具名称、版本号等；</span> </span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">团队的联系信息，例如电话号码、负责人名称、网址等。</span></span><br><span class="line"></span><br><span class="line">   clusterName	&lt;string&gt;</span><br><span class="line">     The name of the cluster which the object belongs to. This is used to</span><br><span class="line">     distinguish resources with same name and namespace in different clusters.</span><br><span class="line">     This field is not set anywhere right now and apiserver is going to ignore</span><br><span class="line">     it if set in create or update request.</span><br><span class="line">     </span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">对象所属群集的名称。这是用来区分不同集群中具有相同名称和命名空间的资源。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">此字段现在未设置在任何位置，apiserver 将忽略它，如果设置了就使用设置的值</span></span><br><span class="line"></span><br><span class="line">   creationTimestamp	&lt;string&gt;</span><br><span class="line">   deletionTimestamp	&lt;string&gt;</span><br><span class="line">   finalizers	&lt;[]string&gt;</span><br><span class="line">   generateName	&lt;string&gt;</span><br><span class="line">   generation	&lt;integer&gt;</span><br><span class="line">   </span><br><span class="line">   labels	&lt;map[string]string&gt; # 创建的资源具有的标签</span><br><span class="line">     Map of string keys and values that can be used to organize and categorize</span><br><span class="line">     (scope and select) objects. May match selectors of replication controllers</span><br><span class="line">     and services. More info: http://kubernetes.io/docs/user-guide/labels</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">labels 是标签，labels 是 map 类型，map 类型表示对应的值是 key-value 键值对</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">&lt;string,string&gt;表示 key 和 value 都是 String 类型的</span></span><br><span class="line"></span><br><span class="line">   managedFields	&lt;[]Object&gt;</span><br><span class="line">   </span><br><span class="line">   name	&lt;string&gt;	# 创建资源的名字</span><br><span class="line"></span><br><span class="line">   namespace	&lt;string&gt; # 创建资源所属的名称空间</span><br><span class="line">     Namespace defines the space within which each name must be unique. An empty</span><br><span class="line">     namespace is equivalent to the &quot;default&quot; namespace, but &quot;default&quot; is the</span><br><span class="line">     canonical representation. Not all objects are required to be scoped to a</span><br><span class="line">     namespace - the value of this field for those objects will be empty.</span><br><span class="line"></span><br><span class="line">     Must be a DNS_LABEL. Cannot be updated. More info:</span><br><span class="line">     http://kubernetes.io/docs/user-guide/namespaces</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">namespaces 划分了一个空间，在同一个 namesace 下的资源名字是唯一的，默认的名称空间是default。</span></span><br><span class="line"></span><br><span class="line">   ownerReferences	&lt;[]Object&gt;</span><br><span class="line">   resourceVersion	&lt;string&gt;</span><br><span class="line">   selfLink	&lt;string&gt;</span><br><span class="line">   uid	&lt;string&gt;</span><br></pre></td></tr></table></figure>

<h3 id="查看pod-spec字段如何定义"><a href="#查看pod-spec字段如何定义" class="headerlink" title="查看pod.spec字段如何定义"></a>查看<code>pod.spec</code>字段如何定义</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line">[root@master1 ~]# kubectl explain pod.spec</span><br><span class="line">KIND:     Pod</span><br><span class="line">VERSION:  v1</span><br><span class="line"></span><br><span class="line">RESOURCE: spec &lt;Object&gt;</span><br><span class="line"></span><br><span class="line">DESCRIPTION:</span><br><span class="line">     Specification of the desired behavior of the pod. More info:</span><br><span class="line">     https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#spec-and-status</span><br><span class="line"></span><br><span class="line">     PodSpec is a description of a pod.</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Pod 的 spec 字段是用来描述 Pod 的</span></span><br><span class="line"></span><br><span class="line">FIELDS:</span><br><span class="line">   activeDeadlineSeconds	&lt;integer&gt;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">表示 Pod 可以运行的最长时间，达到设置的值后，Pod 会自动停止。</span></span><br><span class="line"></span><br><span class="line">   affinity	&lt;Object&gt;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">定义亲和性的</span></span><br><span class="line"></span><br><span class="line">   containers	&lt;[]Object&gt; -required-</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">containers 是对象列表，用来定义容器的，是必须字段。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">对象列表 表示下面有很多对象，对象列表下面的内容用 - 连接。</span></span><br><span class="line"></span><br><span class="line">   dnsConfig	&lt;Object&gt;</span><br><span class="line">   dnsPolicy	&lt;string&gt;</span><br><span class="line">   enableServiceLinks	&lt;boolean&gt;</span><br><span class="line">   ephemeralContainers	&lt;[]Object&gt;</span><br><span class="line">   hostAliases	&lt;[]Object&gt;</span><br><span class="line">   hostIPC	&lt;boolean&gt;</span><br><span class="line">   hostNetwork	&lt;boolean&gt;</span><br><span class="line">   hostPID	&lt;boolean&gt;</span><br><span class="line">   hostname	&lt;string&gt;</span><br><span class="line">   imagePullSecrets	&lt;[]Object&gt;</span><br><span class="line">   initContainers	&lt;[]Object&gt;</span><br><span class="line">   nodeName	&lt;string&gt;</span><br><span class="line">   nodeSelector	&lt;map[string]string&gt;</span><br><span class="line">   overhead	&lt;map[string]string&gt;</span><br><span class="line">   preemptionPolicy	&lt;string&gt;</span><br><span class="line">   priority	&lt;integer&gt;</span><br><span class="line">   priorityClassName	&lt;string&gt;</span><br><span class="line">   readinessGates	&lt;[]Object&gt;</span><br><span class="line">   restartPolicy	&lt;string&gt;</span><br><span class="line">   runtimeClassName	&lt;string&gt;</span><br><span class="line">   schedulerName	&lt;string&gt;</span><br><span class="line">   securityContext	&lt;Object&gt;</span><br><span class="line">   serviceAccount	&lt;string&gt;</span><br><span class="line">   serviceAccountName	&lt;string&gt;</span><br><span class="line">   setHostnameAsFQDN	&lt;boolean&gt;</span><br><span class="line">   shareProcessNamespace	&lt;boolean&gt;</span><br><span class="line">   subdomain	&lt;string&gt;</span><br><span class="line">   terminationGracePeriodSeconds	&lt;integer&gt;</span><br><span class="line">   tolerations	&lt;[]Object&gt;</span><br><span class="line">   topologySpreadConstraints	&lt;[]Object&gt;</span><br><span class="line">   volumes	&lt;[]Object&gt;</span><br></pre></td></tr></table></figure>

<h3 id="查看pod-spec-containers字段如何定义"><a href="#查看pod-spec-containers字段如何定义" class="headerlink" title="查看pod.spec.containers字段如何定义"></a>查看<code>pod.spec.containers</code>字段如何定义</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line">[root@master1 ~]# kubectl explain pod.spec.containers</span><br><span class="line">KIND:     Pod</span><br><span class="line">VERSION:  v1</span><br><span class="line"></span><br><span class="line">RESOURCE: containers &lt;[]Object&gt;</span><br><span class="line"></span><br><span class="line">DESCRIPTION:</span><br><span class="line">     List of containers belonging to the pod. Containers cannot currently be</span><br><span class="line">     added or removed. There must be at least one container in a Pod. Cannot be</span><br><span class="line">     updated.</span><br><span class="line"></span><br><span class="line">     A single application container that you want to run within a pod.</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">container 是定义在 pod 里面的，一个 pod 至少要有一个容器。</span></span><br><span class="line"></span><br><span class="line">FIELDS:</span><br><span class="line">   args	&lt;[]string&gt;</span><br><span class="line">   command	&lt;[]string&gt;</span><br><span class="line">   env	&lt;[]Object&gt;</span><br><span class="line">   envFrom	&lt;[]Object&gt;</span><br><span class="line">   </span><br><span class="line">   image	&lt;string&gt;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">用来指定容器需要的镜像</span></span><br><span class="line"></span><br><span class="line">   imagePullPolicy	&lt;string&gt;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">镜像拉取策略，pod 是要调度到 node 节点的，那 pod 启动需要镜像，可以根据这个字段设置镜像拉取策略，支持如下三种：</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Always：不管本地是否存在镜像，都要重新拉取镜像</span> </span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Never： 从不拉取镜像</span> </span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">IfNotPresent：如果本地存在，使用本地的镜像，本地不存在，从官方拉取镜像</span></span><br><span class="line"></span><br><span class="line">   lifecycle	&lt;Object&gt;</span><br><span class="line">   livenessProbe	&lt;Object&gt;</span><br><span class="line">   </span><br><span class="line">   name	&lt;string&gt; -required-</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">name 是必须字段，用来指定容器名字的</span></span><br><span class="line"></span><br><span class="line">   ports	&lt;[]Object&gt;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">port是端口，属于对象列表</span></span><br><span class="line"></span><br><span class="line">   readinessProbe	&lt;Object&gt;</span><br><span class="line">   resources	&lt;Object&gt;</span><br><span class="line">   securityContext	&lt;Object&gt;</span><br><span class="line">   startupProbe	&lt;Object&gt;</span><br><span class="line">   stdin	&lt;boolean&gt;</span><br><span class="line">   stdinOnce	&lt;boolean&gt;</span><br><span class="line">   terminationMessagePath	&lt;string&gt;</span><br><span class="line">   terminationMessagePolicy	&lt;string&gt;</span><br><span class="line">   tty	&lt;boolean&gt;</span><br><span class="line">   volumeDevices	&lt;[]Object&gt;</span><br><span class="line">   volumeMounts	&lt;[]Object&gt;</span><br><span class="line">   workingDir	&lt;string&gt;</span><br></pre></td></tr></table></figure>

<h3 id="查看pod-spec-containers-ports字段如何定义"><a href="#查看pod-spec-containers-ports字段如何定义" class="headerlink" title="查看pod.spec.containers.ports字段如何定义"></a>查看<code>pod.spec.containers.ports</code>字段如何定义</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">[root@master1 ~]# kubectl explain pod.spec.containers.ports</span><br><span class="line">KIND:     Pod</span><br><span class="line">VERSION:  v1</span><br><span class="line"></span><br><span class="line">RESOURCE: ports &lt;[]Object&gt;</span><br><span class="line"></span><br><span class="line">DESCRIPTION:</span><br><span class="line">     List of ports to expose from the container. Exposing a port here gives the</span><br><span class="line">     system additional information about the network connections a container</span><br><span class="line">     uses, but is primarily informational. Not specifying a port here DOES NOT</span><br><span class="line">     prevent that port from being exposed. Any port which is listening on the</span><br><span class="line">     default &quot;0.0.0.0&quot; address inside a container will be accessible from the</span><br><span class="line">     network. Cannot be updated.</span><br><span class="line"></span><br><span class="line">     ContainerPort represents a network port in a single container.</span><br><span class="line"></span><br><span class="line">FIELDS:</span><br><span class="line">   containerPort	&lt;integer&gt; -required-</span><br><span class="line">     Number of port to expose on the pod&#x27;s IP address. This must be a valid port</span><br><span class="line">     number, 0 &lt; x &lt; 65536.</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">containerPort 是必须字段， pod 中的容器需要暴露的端口。</span></span><br><span class="line"></span><br><span class="line">   hostIP	&lt;string&gt;</span><br><span class="line">     What host IP to bind the external port to.</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">将容器中的服务暴露到宿主机的端口上时，可以指定绑定的宿主机 IP。</span></span><br><span class="line"></span><br><span class="line">   hostPort	&lt;integer&gt;</span><br><span class="line">     Number of port to expose on the host. If specified, this must be a valid</span><br><span class="line">     port number, 0 &lt; x &lt; 65536. If HostNetwork is specified, this must match</span><br><span class="line">     ContainerPort. Most containers do not need this.</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">容器中的服务在宿主机上映射的端口</span></span><br><span class="line"></span><br><span class="line">   name	&lt;string&gt;</span><br><span class="line">     If specified, this must be an IANA_SVC_NAME and unique within the pod. Each</span><br><span class="line">     named port in a pod must have a unique name. Name for the port that can be</span><br><span class="line">     referred to by services.</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">端口的名字</span></span><br><span class="line"></span><br><span class="line">   protocol	&lt;string&gt;</span><br><span class="line">     Protocol for port. Must be UDP, TCP, or SCTP. Defaults to &quot;TCP&quot;.</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">端口协议</span></span><br></pre></td></tr></table></figure>

<h2 id="通过资源清单文件创建Pod"><a href="#通过资源清单文件创建Pod" class="headerlink" title="通过资源清单文件创建Pod"></a>通过资源清单文件创建Pod</h2><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span>				<span class="comment"># api版本</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span>					<span class="comment"># 创建的资源</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">tomcat-test</span>			<span class="comment"># Pod名字</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span>		<span class="comment"># Pod所在的命名空间</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">pod</span>				<span class="comment"># Pod具有的标签</span></span><br><span class="line"><span class="attr">spec:</span> </span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">pod-container</span>		<span class="comment"># Pod里容器的名字</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">tomcat</span>			<span class="comment"># 容器使用的镜像</span></span><br><span class="line">    <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span>	<span class="comment"># 镜像拉取策略</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">8080</span>	<span class="comment"># 容器暴露的端口</span></span><br></pre></td></tr></table></figure>

<ul>
<li>更新资源文件</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@master1 ~]# kubectl apply -f pod-tomcat.yaml</span><br><span class="line">        </span><br><span class="line">[root@master1 ~]# kubectl get pods -o wide -l app=tomcat</span><br><span class="line">NAME          READY   STATUS    RESTARTS   AGE   IP               NODE    NOMINATED NODE   READINESS GATES</span><br><span class="line">tomcat-test   1/1     Running   0          23s   10.244.166.138   node1   &lt;none&gt;           &lt;none&gt;</span><br></pre></td></tr></table></figure>

<ul>
<li>查看日志</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@master1 ~]# kubectl logs tomcat-test</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">查看pod里指定容器的日志</span></span><br><span class="line">[root@master1 ~]# kubectl logs tomcat-test -c tomcat</span><br></pre></td></tr></table></figure>

<ul>
<li>进入到刚才创建的pod</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@master1 ~]# kubectl exec -it tomcat-test -- /bin/bash</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">假如 pod 里有多个容器，进入到 pod 里的指定容器</span></span><br><span class="line">[root@master1 ~]# kubectl exec -it tomcat-test -c tomcat -- /bin/bash</span><br></pre></td></tr></table></figure>

<blockquote>
<p>我们上面创建的 pod 是一个自主式 pod，也就是通过 pod 创建一个应用程序，如果 pod 出现故障停掉，那么我们通过 pod 部署的应用也就会停掉，不安全， 还有一种控制器管理的 pod，通过控制器创建pod，可以对 pod 的生命周期做管理，可以定义 pod 的副本数，如果有一个 pod 意外停掉，那么会自动起来一个 pod 替代之前的 pod</p>
</blockquote>
<h2 id="通过kubectl-run创建Pod"><a href="#通过kubectl-run创建Pod" class="headerlink" title="通过kubectl run创建Pod"></a>通过kubectl run创建Pod</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@master1 ~]# kubectl run tomcat --image=tomcat --image-pull-policy=&#x27;IfNotPresent&#x27; --port 8080</span><br></pre></td></tr></table></figure>

<h2 id="Pod资源清单详细解读"><a href="#Pod资源清单详细解读" class="headerlink" title="Pod资源清单详细解读"></a>Pod资源清单详细解读</h2><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span>					<span class="comment"># 版本号，例如 v1 </span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span>						<span class="comment"># 资源类型，如 Pod </span></span><br><span class="line"><span class="attr">metadata:</span>						<span class="comment"># 元数据 </span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">string</span> 					<span class="comment"># Pod 名字 </span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">string</span> 			<span class="comment"># Pod 所属的命名空间 </span></span><br><span class="line">  <span class="attr">labels:</span> 						<span class="comment"># 自定义标签 </span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">string</span> 				<span class="comment"># 自定义标签名字 </span></span><br><span class="line">  <span class="attr">annotations:</span> 					<span class="comment"># 自定义注释列表 </span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">string</span> </span><br><span class="line"><span class="attr">spec:</span> 							<span class="comment"># Pod 中容器的详细定义 </span></span><br><span class="line">  <span class="attr">containers:</span>					<span class="comment"># Pod 中容器列表 </span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">string</span> 				<span class="comment"># 容器名称 </span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">string</span> 				<span class="comment"># 容器的镜像名称 </span></span><br><span class="line">    <span class="attr">imagePullPolicy:</span> [<span class="string">Always</span> <span class="string">|</span> <span class="string">Never</span> <span class="string">|</span> <span class="string">IfNotPresent</span>] </span><br><span class="line">								<span class="comment"># 获取镜像的策略 Alawys 表示下载镜像 </span></span><br><span class="line">								<span class="comment"># IfnotPresent 表示优先使用本地镜像，否则下载镜像</span></span><br><span class="line">								<span class="comment"># Nerver 表示仅使用本地镜像 </span></span><br><span class="line">    <span class="attr">command:</span> [<span class="string">string</span>]			<span class="comment"># 容器的启动命令列表，如不指定，使用打包时使用的启动命令 </span></span><br><span class="line"> 	<span class="attr">args:</span> [<span class="string">string</span>] 				<span class="comment"># 容器的启动命令参数列表 </span></span><br><span class="line"> 	<span class="attr">workingDir:</span> <span class="string">string</span>			<span class="comment"># 容器的工作目录 </span></span><br><span class="line"> 	<span class="attr">volumeMounts:</span>				<span class="comment"># 挂载到容器内部的存储卷配置 </span></span><br><span class="line">	<span class="bullet">-</span> <span class="attr">name:</span> <span class="string">string</span>				<span class="comment"># 引用 pod 定义的共享存储卷的名称，需用 volumes[]部分定义的的卷名 </span></span><br><span class="line"> 	  <span class="attr">mountPath:</span> <span class="string">string</span>			<span class="comment"># 存储卷在容器内 mount 的绝对路径，应少于 512 字符 </span></span><br><span class="line">      <span class="attr">readOnly:</span> <span class="string">boolean</span> 		<span class="comment"># 是否为只读模式 </span></span><br><span class="line">    <span class="attr">ports:</span> 						<span class="comment"># 需要暴露的端口号 </span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">string</span> 				<span class="comment"># 端口号名称 </span></span><br><span class="line">      <span class="attr">containerPort:</span> <span class="string">int</span>		<span class="comment"># 容器需要监听的端口号 </span></span><br><span class="line">      <span class="attr">hostPort:</span> <span class="string">int</span>				<span class="comment"># 容器所在主机需要监听的端口号，默认与 Container 相同 </span></span><br><span class="line">      <span class="attr">protocol:</span> <span class="string">string</span>			<span class="comment"># 端口协议，支持 TCP 和 UDP，默认 TCP </span></span><br><span class="line">     <span class="attr">env:</span>						<span class="comment"># 容器运行前需设置的环境变量列表 </span></span><br><span class="line">     <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">string</span>				<span class="comment"># 环境变量名称 </span></span><br><span class="line">       <span class="attr">value:</span> <span class="string">string</span>			<span class="comment"># 环境变量的值 </span></span><br><span class="line">     <span class="attr">resources:</span>					<span class="comment"># 资源限制和请求的设置 </span></span><br><span class="line">       <span class="attr">limits:</span>					<span class="comment"># 资源限制的设置 </span></span><br><span class="line">         <span class="attr">cpu:</span> <span class="string">string</span>			<span class="comment"># cpu 的限制，单位为 core 数 </span></span><br><span class="line">         <span class="attr">memory:</span> <span class="string">string</span>			<span class="comment"># 内存限制，单位可以为 Mib/Gib </span></span><br><span class="line">       <span class="attr">requests:</span>				<span class="comment"># 资源请求的设置 </span></span><br><span class="line">         <span class="attr">cpu:</span> <span class="string">string</span>			<span class="comment"># cpu 请求，容器启动的初始可用数量 </span></span><br><span class="line">         <span class="attr">memory:</span> <span class="string">string</span>			<span class="comment"># 内存请求，容器启动的初始可用内存 </span></span><br><span class="line">     <span class="attr">livenessProbe:</span>				<span class="comment"># 对 Pod 内个容器健康检查的设置，当探测无响应几次后将自动重启该容器，检查方法有 exec、httpGet 和 tcpSocket，对一个容器只需设置其中一种方法即可 </span></span><br><span class="line">       <span class="attr">exec:</span>					<span class="comment"># 对 Pod 容器内检查方式设置为 exec 方式 </span></span><br><span class="line">         <span class="attr">command:</span> [<span class="string">string</span>]		<span class="comment"># exec 方式需要制定的命令或脚本 </span></span><br><span class="line">       <span class="attr">httpGet:</span>					<span class="comment"># 对 Pod 内个容器健康检查方法设置为 HttpGet，需要制定 Path、port </span></span><br><span class="line">         <span class="attr">path:</span> <span class="string">string</span> </span><br><span class="line">         <span class="attr">port:</span> <span class="string">number</span> </span><br><span class="line">         <span class="attr">host:</span> <span class="string">string</span> </span><br><span class="line">         <span class="attr">scheme:</span> <span class="string">string</span> </span><br><span class="line">         <span class="attr">HttpHeaders:</span> </span><br><span class="line">         <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">string</span> </span><br><span class="line">         <span class="attr">value:</span> <span class="string">string</span> </span><br><span class="line">       <span class="attr">tcpSocket:</span>				<span class="comment"># 对 Pod 内个容器健康检查方式设置为 tcpSocket 方式 </span></span><br><span class="line">         <span class="attr">port:</span> <span class="string">number</span> </span><br><span class="line">       <span class="attr">initialDelaySeconds:</span> <span class="number">0</span>	<span class="comment"># 容器启动完成后首次探测的时间，单位为秒 </span></span><br><span class="line">       <span class="attr">timeoutSeconds:</span> <span class="number">0</span>		<span class="comment"># 对容器健康检查探测等待响应的超时时间，单位秒，默认 1 秒 </span></span><br><span class="line">       <span class="attr">periodSeconds:</span> <span class="number">0</span>			<span class="comment"># 对容器监控检查的定期探测时间设置，单位秒，默认 10 秒一次 </span></span><br><span class="line">       <span class="attr">successThreshold:</span> <span class="number">0</span> </span><br><span class="line">       <span class="attr">failureThreshold:</span> <span class="number">0</span> </span><br><span class="line">       <span class="attr">securityContext:</span> </span><br><span class="line">         <span class="attr">privileged:</span> <span class="literal">false</span> </span><br><span class="line">     <span class="attr">restartPolicy:</span> [<span class="string">Always</span> <span class="string">|</span> <span class="string">Never</span> <span class="string">|</span> <span class="string">OnFailure</span>]</span><br><span class="line">								<span class="comment"># Pod 的重启策略</span></span><br><span class="line">								<span class="comment"># Always 表示一旦不管以何种方式终止运行，kubelet 都将重启，</span></span><br><span class="line">								<span class="comment"># OnFailure 表示只有 Pod 以非 0 退出码退出才重启，</span></span><br><span class="line">								<span class="comment"># Nerver 表示不再重启该 Pod </span></span><br><span class="line">     <span class="attr">nodeSelector:</span> <span class="string">obeject</span>		<span class="comment"># 设置 NodeSelector 表示将该 Pod 调度到包含这个 label 的 node上，以 key：value 的格式指定 </span></span><br><span class="line">     <span class="attr">imagePullSecrets:</span>			<span class="comment"># Pull 镜像时使用的 secret 名称，以 key：secretkey 格式指定 </span></span><br><span class="line">     <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">string</span> </span><br><span class="line">     <span class="attr">hostNetwork:</span> <span class="literal">false</span>			<span class="comment"># 是否使用主机网络模式，默认为 false，如果设置为 true，表示使用宿主机网络 </span></span><br><span class="line">     <span class="attr">volumes:</span>					<span class="comment"># 在该 pod 上定义共享存储卷列表 </span></span><br><span class="line">     <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">string</span>				<span class="comment"># 共享存储卷名称 （volumes 类型有很多种） </span></span><br><span class="line">       <span class="attr">emptyDir:</span> &#123;&#125;				<span class="comment"># 类型为 emtyDir 的存储卷，与 Pod 同生命周期的一个临时目录。为空值 </span></span><br><span class="line">       <span class="attr">hostPath:</span> <span class="string">string</span>			<span class="comment"># 类型为 hostPath 的存储卷，表示挂载 Pod 所在宿主机的目录 </span></span><br><span class="line">         <span class="attr">path:</span> <span class="string">string</span>			<span class="comment"># Pod 所在宿主机的目录，将被用于同期中 mount 的目录 </span></span><br><span class="line">       <span class="attr">secret:</span>					<span class="comment"># 类型为 secret 的存储卷，挂载集群与定义的 secre 对象到容器内部 </span></span><br><span class="line">         <span class="attr">scretname:</span> <span class="string">string</span> </span><br><span class="line">         <span class="attr">items:</span> </span><br><span class="line">         <span class="bullet">-</span> <span class="attr">key:</span> <span class="string">string</span> </span><br><span class="line">           <span class="attr">path:</span> <span class="string">string</span> </span><br><span class="line">       <span class="attr">configMap:</span>				<span class="comment"># 类型为 configMap 的存储卷，挂载预定义的 configMap 对象到容器内部 </span></span><br><span class="line">         <span class="attr">name:</span> <span class="string">string</span> </span><br><span class="line">         <span class="attr">items:</span> </span><br><span class="line">         <span class="bullet">-</span> <span class="attr">key:</span> <span class="string">string</span> </span><br><span class="line">           <span class="attr">path:</span> <span class="string">string</span></span><br></pre></td></tr></table></figure>

<h1 id="命名空间"><a href="#命名空间" class="headerlink" title="命名空间"></a>命名空间</h1><h2 id="什么是命名空间"><a href="#什么是命名空间" class="headerlink" title="什么是命名空间"></a>什么是命名空间</h2><ul>
<li>Kubernetes 支持多个虚拟集群，它们底层依赖于同一个物理集群。 这些虚拟集群被称为命名空间。</li>
<li>命名空间 namespace 是 k8s 集群级别的资源，可以给不同的用户、租户、环境或项目创建对应的命名空间</li>
<li>例如，可以为 test、devlopment、production 环境分别创建各自的命名空间。 </li>
</ul>
<h2 id="namespace应用场景"><a href="#namespace应用场景" class="headerlink" title="namespace应用场景"></a>namespace应用场景</h2><blockquote>
<p>命名空间适用于存在很多跨多个团队或项目的用户的场景。对于只有几到几十个用户的集群，根本不需要创建或考虑命名空间。</p>
</blockquote>
<p>1、查看名称空间及其资源对象</p>
<ul>
<li><p>k8s 集群默认提供了几个名称空间用于特定目的，例如，kube-system 主要用于运行系统级资源，存放 k8s 一些组件的。而 default 则为那些未指定名称空间的资源操作提供一个默认值。</p>
</li>
<li><p>使用 kubectl get namespace 可以查看 namespace 资源，使用 kubectl describe namespace $NAME 可以查看特定的名称空间的详细信息。</p>
</li>
</ul>
<p>2、管理 namespace 资源</p>
<ul>
<li>namespace 资源属性较少，通常只需要指定名称即可创建，如“kubectl create namespace qa”。namespace 资源的名称仅能由字母、数字、下划线、连接线等字符组成。删除 namespace 资源会级联删除其包含的所有其他资源对象。</li>
</ul>
<h2 id="namespace使用案例"><a href="#namespace使用案例" class="headerlink" title="namespace使用案例"></a>namespace使用案例</h2><h3 id="创建一个test命名空间"><a href="#创建一个test命名空间" class="headerlink" title="创建一个test命名空间"></a>创建一个test命名空间</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@master1 ~]# kubectl create ns test</span><br></pre></td></tr></table></figure>

<h3 id="切换命名空间"><a href="#切换命名空间" class="headerlink" title="切换命名空间"></a>切换命名空间</h3><blockquote>
<p>切换命名空间后，kubectl get pods 如果不指定-n，查看的就是 kube-system 命名空间的资源了。</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@master1 ~]# kubectl config set-context --current --namespace=kube-system</span><br></pre></td></tr></table></figure>

<h3 id="查看哪些资源属于命名空间级别的"><a href="#查看哪些资源属于命名空间级别的" class="headerlink" title="查看哪些资源属于命名空间级别的"></a>查看哪些资源属于命名空间级别的</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@master1 ~]# kubectl api-resources --namespaced=true</span><br></pre></td></tr></table></figure>

<h3 id="namespace-资源限额"><a href="#namespace-资源限额" class="headerlink" title="namespace 资源限额"></a>namespace 资源限额</h3><blockquote>
<p>namespace 是命名空间，里面有很多资源，可以对命名空间资源做个限制，防止该命名空间部署的资源超过限制</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@master1 ~]# kubectl config set-context --current –namespace=default</span><br></pre></td></tr></table></figure>

<ul>
<li>编写 namespace 限制的yaml文件</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">[<span class="string">root@master1</span> <span class="string">~</span>]<span class="comment"># vim namespace-quota.yaml</span></span><br><span class="line"></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ResourceQuota</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">mem-cpu-quota</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">hard:</span></span><br><span class="line">    <span class="attr">requests.cpu:</span> <span class="string">&quot;2&quot;</span></span><br><span class="line">    <span class="attr">requests.memory:</span> <span class="string">2Gi</span></span><br><span class="line">    <span class="attr">limits.cpu:</span> <span class="string">&quot;4&quot;</span></span><br><span class="line">    <span class="attr">limits.memory:</span> <span class="string">4Gi</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建的 ResourceQuota 对象将在 test 名字空间中添加以下限制： </span></span><br><span class="line"><span class="comment"># 每个容器必须设置内存请求（memory request），内存限额（memory limit），cpu 请求（cpu request）和 cpu 限额（cpu limit）。 </span></span><br><span class="line"><span class="comment"># 所有容器的内存请求总额不得超过 2GiB。 </span></span><br><span class="line"><span class="comment"># 所有容器的内存限额总额不得超过 4 GiB。 </span></span><br><span class="line"><span class="comment"># 所有容器的 CPU 请求总额不得超过 2 CPU。 </span></span><br><span class="line"><span class="comment"># 所有容器的 CPU 限额总额不得超过 4CPU。</span></span><br></pre></td></tr></table></figure>

<ul>
<li>创建 pod 时候必须设置资源限额，否则创建失败</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">[<span class="string">root@master1</span> <span class="string">~</span>]<span class="comment"># vim pod-test.yaml</span></span><br><span class="line"></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">pod-test</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">tomcat-pod-test</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">tomcat-pod-test</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">tomcat</span></span><br><span class="line">    <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">8080</span></span><br><span class="line">    <span class="attr">resources:</span></span><br><span class="line">      <span class="attr">requests:</span></span><br><span class="line">        <span class="attr">memory:</span> <span class="string">&quot;100Mi&quot;</span></span><br><span class="line">        <span class="attr">cpu:</span> <span class="string">&quot;500m&quot;</span></span><br><span class="line">      <span class="attr">limits:</span></span><br><span class="line">        <span class="attr">memory:</span> <span class="string">&quot;2Gi&quot;</span></span><br><span class="line">        <span class="attr">cpu:</span> <span class="string">&quot;2&quot;</span></span><br></pre></td></tr></table></figure>

<h1 id="标签"><a href="#标签" class="headerlink" title="标签"></a>标签</h1><h2 id="什么是标签"><a href="#什么是标签" class="headerlink" title="什么是标签"></a>什么是标签</h2><ul>
<li>标签其实就一对 <code>key/value</code> ，被关联到对象上，比如 Pod</li>
<li>标签的使用我们倾向于能够表示对象的特殊特点，就是一眼就看出了这个 Pod 是干什么的，标签可以用来划分特定的对象（比如版本，服务类型等）</li>
<li>标签可以在创建一个对象的时候直接定义，也可以在后期随时修改，每一个对象可以拥有多个标签</li>
<li>但是，key 值必须是唯一的。创建标签之后也可以方便我们对资源进行分组管理。</li>
<li>如果对 pod 打标签，之后就可以使用标签来查看、删除指定的 pod。</li>
<li>在 k8s 中，大部分资源都可以打标签。</li>
</ul>
<h2 id="给pod资源打标签"><a href="#给pod资源打标签" class="headerlink" title="给pod资源打标签"></a>给pod资源打标签</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">对已经存在的pod打标签</span></span><br><span class="line">[root@master1 ~]# kubectl label pods tomcat release=v1</span><br><span class="line"></span><br><span class="line">[root@master1 ~]# kubectl get pods tomcat --show-labels </span><br><span class="line">NAME     READY   STATUS    RESTARTS   AGE     LABELS</span><br><span class="line">tomcat   1/1     Running   0          3h48m   release=v1,run=tomcat</span><br></pre></td></tr></table></figure>

<h2 id="查看资源标签"><a href="#查看资源标签" class="headerlink" title="查看资源标签"></a>查看资源标签</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">查看默认名称空间下所有pod资源的标签</span></span><br><span class="line">kubectl get pods --show-labels</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">查看默认名称空间下指定pod具有的所有标签</span></span><br><span class="line">kubectl get pods tomcat --show-labels</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">列出默认名称空间下标签key是release的pod，不显示标签</span></span><br><span class="line">kubectl get pods -l release</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">列出默认名称空间下标签key是release、值是v1的pod，不显示标签</span></span><br><span class="line">kubectl get pods -l release=v1</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">列出默认名称空间下标签 key 是 release 的所有 pod，并打印对应的标签值</span></span><br><span class="line">kubectl get pods -L release</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">查看所有名称空间下的所有 pod 的标签</span> </span><br><span class="line">kubectl get pods --all-namespaces --show-labels</span><br></pre></td></tr></table></figure>

<h1 id="node节点选择器"><a href="#node节点选择器" class="headerlink" title="node节点选择器"></a>node节点选择器</h1><blockquote>
<p>在创建 pod 资源的时候，pod 会根据 <code>schduler</code> 进行调度，那么默认会调度到随机的一个工作节点，如果想要 pod 调度到指定节点或者调度到一些具有相同特点的 node 节点，可以使用 pod 中的 <code>nodeName</code> 或者 <code>nodeSelector</code> 字段指定要调度到的 node 节点</p>
</blockquote>
<h2 id="nodeName"><a href="#nodeName" class="headerlink" title="nodeName"></a>nodeName</h2><ul>
<li>指定pod节点运行在那个具体的node上</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">[<span class="string">root@master1</span> <span class="string">~</span>]<span class="comment"># vim pod-node.yaml</span></span><br><span class="line"></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">demo-pod</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">myapp</span></span><br><span class="line">    <span class="attr">env:</span> <span class="string">dev</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">nodeName:</span> <span class="string">node1</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">tomcat</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">8080</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">tomcat</span></span><br><span class="line">    <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">busybox</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">busybox</span></span><br><span class="line">    <span class="attr">command:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&quot;/bin/sh&quot;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&quot;-c&quot;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&quot;sleep 3600&quot;</span></span><br><span class="line">    </span><br><span class="line">[<span class="string">root@master1</span> <span class="string">~</span>]<span class="comment"># kubectl get pods -o wide</span></span><br><span class="line"><span class="string">NAME</span>       <span class="string">READY</span>   <span class="string">STATUS</span>    <span class="string">RESTARTS</span>   <span class="string">AGE</span>   <span class="string">IP</span>               <span class="string">NODE</span>    <span class="string">NOMINATED</span> <span class="string">NODE</span>   <span class="string">READINESS</span> <span class="string">GATES</span></span><br><span class="line"><span class="string">demo-pod</span>   <span class="number">2</span><span class="string">/2</span>     <span class="string">Running</span>   <span class="number">0</span>          <span class="string">22s</span>   <span class="number">10.244</span><span class="number">.166</span><span class="number">.147</span>   <span class="string">node1</span>   <span class="string">&lt;none&gt;</span>           <span class="string">&lt;none&gt;</span></span><br></pre></td></tr></table></figure>

<h2 id="nodeSelector"><a href="#nodeSelector" class="headerlink" title="nodeSelector"></a>nodeSelector</h2><blockquote>
<p>指定 pod 调度到具有哪些标签的 node 节点上</p>
</blockquote>
<ul>
<li>给 node 节点打标签，打个具有 disk=ceph 的标签</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@master1 ~]# kubectl label nodes node2 disk=ceph</span><br></pre></td></tr></table></figure>

<ul>
<li>定义 pod 的时候指定要调度到具有 disk=ceph 标签的 node 上</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">[<span class="string">root@master1</span> <span class="string">~</span>]<span class="comment"># vim pod-1.yaml</span></span><br><span class="line"></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">demo-pod-1</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">myapp</span></span><br><span class="line">    <span class="attr">env:</span> <span class="string">dev</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">nodeSelector:</span></span><br><span class="line">    <span class="attr">disk:</span> <span class="string">ceph</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">tomcat</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">8080</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">tomcat</span></span><br><span class="line">    <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">    </span><br><span class="line"></span><br><span class="line">[<span class="string">root@master1</span> <span class="string">~</span>]<span class="comment"># kubectl get pods -o wide</span></span><br><span class="line"><span class="string">NAME</span>         <span class="string">READY</span>   <span class="string">STATUS</span>    <span class="string">RESTARTS</span>   <span class="string">AGE</span>   <span class="string">IP</span>              <span class="string">NODE</span>    <span class="string">NOMINATED</span> <span class="string">NODE</span>   <span class="string">READINESS</span> <span class="string">GATES</span></span><br><span class="line"><span class="string">demo-pod-1</span>   <span class="number">1</span><span class="string">/1</span>     <span class="string">Running</span>   <span class="number">0</span>          <span class="string">45s</span>   <span class="number">10.244</span><span class="number">.104</span><span class="number">.19</span>   <span class="string">node2</span>   <span class="string">&lt;none&gt;</span>           <span class="string">&lt;none&gt;</span></span><br></pre></td></tr></table></figure>

<h1 id="亲和、污点和容忍度"><a href="#亲和、污点和容忍度" class="headerlink" title="亲和、污点和容忍度"></a>亲和、污点和容忍度</h1><h2 id="node节点亲和性"><a href="#node节点亲和性" class="headerlink" title="node节点亲和性"></a>node节点亲和性</h2><blockquote>
<p>node 节点亲和性调度：nodeAffinity</p>
</blockquote>
<ul>
<li>查看<code>pods.spec.affinity</code>字段</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[root@master1 ~]# kubectl explain pods.spec.affinity</span><br><span class="line">KIND:     Pod</span><br><span class="line">VERSION:  v1</span><br><span class="line">RESOURCE: affinity &lt;Object&gt;</span><br><span class="line">DESCRIPTION:</span><br><span class="line">     If specified, the pod&#x27;s scheduling constraints</span><br><span class="line">     Affinity is a group of affinity scheduling rules.</span><br><span class="line"></span><br><span class="line">FIELDS:</span><br><span class="line">   nodeAffinity	&lt;Object&gt;</span><br><span class="line">   podAffinity	&lt;Object&gt;</span><br><span class="line">   podAntiAffinity	&lt;Object&gt;</span><br></pre></td></tr></table></figure>

<ul>
<li>查看<code>pods.spec.affinity.nodeAffinity</code>字段</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[root@master1 ~]# kubectl explain pods.spec.affinity.nodeAffinity</span><br><span class="line">KIND:     Pod</span><br><span class="line">VERSION:  v1</span><br><span class="line">RESOURCE: nodeAffinity &lt;Object&gt;</span><br><span class="line">DESCRIPTION:</span><br><span class="line">     Describes node affinity scheduling rules for the pod.</span><br><span class="line">     Node affinity is a group of node affinity scheduling rules.</span><br><span class="line"></span><br><span class="line">FIELDS:</span><br><span class="line">   preferredDuringSchedulingIgnoredDuringExecution	&lt;[]Object&gt;</span><br><span class="line">   requiredDuringSchedulingIgnoredDuringExecution	&lt;Object&gt;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">prefered 表示有节点尽量满足这个位置定义的亲和性，这不是一个必须的条件，软亲和性</span> </span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">require 表示必须有节点满足这个位置定义的亲和性，这是个硬性条件，硬亲和性</span></span><br></pre></td></tr></table></figure>

<ul>
<li>查看<code>pods.spec.affinity.nodeAffinity.requiredDuringSchedulingIgnoredDuringExecution</code>字段</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@master1 ~]# kubectl explain pods.spec.affinity.nodeAffinity.requiredDuringSchedulingIgnoredDuringExecution</span><br><span class="line">KIND:     Pod</span><br><span class="line">VERSION:  v1</span><br><span class="line">RESOURCE: requiredDuringSchedulingIgnoredDuringExecution &lt;Object&gt;</span><br><span class="line">DESCRIPTION:</span><br><span class="line"></span><br><span class="line">FIELDS:</span><br><span class="line">   nodeSelectorTerms	&lt;[]Object&gt; -required-</span><br><span class="line">     Required. A list of node selector terms. The terms are ORed.</span><br></pre></td></tr></table></figure>

<ul>
<li>查看<code>pods.spec.affinity.nodeAffinity.requiredDuringSchedulingIgnoredDuringExecution.nodeSelectorTerms</code>字段</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">[root@master1 ~]# kubectl explain pods.spec.affinity.nodeAffinity.requiredDuringSchedulingIgnoredDuringExecution.nodeSelectorTerms</span><br><span class="line">KIND:     Pod</span><br><span class="line">VERSION:  v1</span><br><span class="line"></span><br><span class="line">RESOURCE: nodeSelectorTerms &lt;[]Object&gt;</span><br><span class="line"></span><br><span class="line">DESCRIPTION:</span><br><span class="line">     Required. A list of node selector terms. The terms are ORed.</span><br><span class="line"></span><br><span class="line">     A null or empty node selector term matches no objects. The requirements of</span><br><span class="line">     them are ANDed. The TopologySelectorTerm type implements a subset of the</span><br><span class="line">     NodeSelectorTerm.</span><br><span class="line"></span><br><span class="line">FIELDS:</span><br><span class="line">   matchExpressions	&lt;[]Object&gt;</span><br><span class="line">     A list of node selector requirements by node&#x27;s labels.</span><br><span class="line"></span><br><span class="line">   matchFields	&lt;[]Object&gt;</span><br><span class="line">     A list of node selector requirements by node&#x27;s fields.</span><br><span class="line">     </span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">matchExpressions：匹配表达式的 （node标签）</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">matchFields： 匹配字段的</span></span><br></pre></td></tr></table></figure>

<ul>
<li>查看<code>pods.spec.affinity.nodeAffinity.requiredDuringSchedulingIgnoredDuringExecution.nodeSelectorTerms.matchFields</code>字段</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@master1 ~]# kubectl explain pods.spec.affinity.nodeAffinity.requiredDuringSchedulingIgnoredDuringExecution.nodeSelectorTerms.matchFields</span><br><span class="line">KIND:     Pod</span><br><span class="line">VERSION:  v1</span><br><span class="line">RESOURCE: matchFields &lt;[]Object&gt;</span><br><span class="line"></span><br><span class="line">FIELDS:</span><br><span class="line">   key	&lt;string&gt; -required-</span><br><span class="line">   operator	&lt;string&gt; -required-</span><br><span class="line">   values	&lt;[]string&gt;</span><br></pre></td></tr></table></figure>

<ul>
<li>查看<code>pods.spec.affinity.nodeAffinity.requiredDuringSchedulingIgnoredDuringExecution.nodeSelectorTerms.matchExpressions</code>字段</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[root@master1 ~]# kubectl explain pods.spec.affinity.nodeAffinity.requiredDuringSchedulingIgnoredDuringExecution.nodeSelectorTerms.matchExpressions</span><br><span class="line">KIND:     Pod</span><br><span class="line">VERSION:  v1</span><br><span class="line">RESOURCE: matchExpressions &lt;[]Object&gt;</span><br><span class="line"></span><br><span class="line">FIELDS:</span><br><span class="line">   key	&lt;string&gt; -required-</span><br><span class="line">   operator	&lt;string&gt; -required-</span><br><span class="line">   values	&lt;[]string&gt;</span><br><span class="line">   </span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">key：检查 label</span> </span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">operator：做等值选则还是不等值选则</span> </span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">values：给定值</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>使用 <code>requiredDuringSchedulingIgnoredDuringExecution</code> 硬亲和性</p>
</blockquote>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">pod-node-affinity</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">myapp</span></span><br><span class="line">    <span class="attr">tier:</span> <span class="string">frontend</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">myapp</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">ikubernetes/myapp:v1</span></span><br><span class="line">  <span class="attr">affinity:</span></span><br><span class="line">    <span class="attr">nodeAffinity:</span></span><br><span class="line">      <span class="attr">requiredDuringSchedulingIgnoredDuringExecution:</span></span><br><span class="line">        <span class="attr">nodeSelectorTerms:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">matchExpressions:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">key:</span> <span class="string">zone</span></span><br><span class="line">            <span class="attr">operator:</span> <span class="string">In</span></span><br><span class="line">            <span class="attr">values:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">foo</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">bar</span></span><br></pre></td></tr></table></figure>

<ul>
<li>检查当前节点中有任意一个节点拥有 zone 标签的值是 foo 或者 bar，就可以把 pod 调度到这个 node 节点的 foo 或者 bar 标签上的节点上</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[root@master1 ~]# kubectl apply -f pod-nodeaffinity.yaml</span><br><span class="line"></span><br><span class="line">[root@master1 ~]# kubectl get pods pod-node-affinity </span><br><span class="line">NAME                READY   STATUS    RESTARTS   AGE</span><br><span class="line">pod-node-affinity   0/1     Pending   0          28s</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">status 的状态是 pending，上面说明没有完成调度，因为没有一个拥有 zone 的标签的值是 foo 或者 bar，而且使用的是硬亲和性，必须满足条件才能完成调度</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">给node1打赏zoo=foo标签</span></span><br><span class="line">[root@master1 ~]# kubectl label nodes node1 zone=foo</span><br><span class="line"></span><br><span class="line">[root@master1 ~]# kubectl get pods pod-node-affinity </span><br><span class="line">NAME                READY   STATUS    RESTARTS   AGE</span><br><span class="line">pod-node-affinity   1/1     Running   6          6m50s</span><br></pre></td></tr></table></figure>

<blockquote>
<p>使用 <code>preferredDuringSchedulingIgnoredDuringExecution</code> 软亲和性</p>
</blockquote>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">pod-node-affinity-2</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">myapp</span></span><br><span class="line">    <span class="attr">tier:</span> <span class="string">frontend</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">myapp</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">ikubernetes/myapp:v1</span></span><br><span class="line">  <span class="attr">affinity:</span></span><br><span class="line">    <span class="attr">nodeAffinity:</span></span><br><span class="line">      <span class="attr">preferredDuringSchedulingIgnoredDuringExecution:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">preference:</span></span><br><span class="line">          <span class="attr">matchExpressions:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">key:</span> <span class="string">zone1</span></span><br><span class="line">            <span class="attr">operator:</span> <span class="string">In</span></span><br><span class="line">            <span class="attr">values:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">foo1</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">bar1</span></span><br><span class="line">        <span class="attr">weight:</span> <span class="number">60</span></span><br></pre></td></tr></table></figure>

<ul>
<li>上面说明软亲和性是可以运行这个 pod 的，尽管没有运行这个 pod 的节点定义的 zone1 标签</li>
<li>Node 节点亲和性针对的是 pod 和 node 的关系，Pod 调度到 node 节点的时候匹配的条件</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@master1 ~]# kubectl apply -f pod-nodeaffinity.yaml</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@master1 ~]# kubectl get pods pod-node-affinity-2 </span><br><span class="line">NAME                  READY   STATUS    RESTARTS   AGE</span><br><span class="line">pod-node-affinity-2   1/1     Running   0          67s</span><br></pre></td></tr></table></figure>

<h2 id="Pod节点亲和性"><a href="#Pod节点亲和性" class="headerlink" title="Pod节点亲和性"></a>Pod节点亲和性</h2><blockquote>
<p>pod 自身的亲和性调度有两种表示形式</p>
</blockquote>
<blockquote>
<p><code>podaffinity</code>：pod 和 pod 更倾向腻在一起，把相近的 pod 结合到相近的位置，如同一区域，同一机架，这样的话 pod 和 pod 之间更好通信，比方说有两个机房，这两个机房部署的集群有 1000 台主机，那么我们希望把 nginx 和 tomcat 都部署同一个地方的 node 节点上，可以提高通信效率；</p>
</blockquote>
<blockquote>
<p><code>podantiaffinity</code>：pod 和 pod 更倾向不腻在一起，如果部署两套程序，那么这两套程序更倾向于反亲和性，这样相互之间不会有影响。</p>
</blockquote>
<blockquote>
<p>第一个 pod 随机选则一个节点，做为评判后续的 pod 能否到达这个 pod 所在的节点上的运行方式，这就称为 pod 亲和性；怎么判定哪些节点是相同位置的，哪些节点是不同位置的；在定义 pod 亲和性时需要有一个前提，哪些 pod 在同一个位置，哪些 pod 不在同一个位置，这个位置是怎么定义的，标准是什么？以节点名称为标准，这个节点名称相同的表示是同一个位置，节点名称不相同的表示不是一个位置。</p>
</blockquote>
<ul>
<li>查看<code>pods.spec.affinity.podAffinity</code>字段</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root@master1 ~]# kubectl explain pods.spec.affinity.podAffinity</span><br><span class="line">KIND:     Pod</span><br><span class="line">VERSION:  v1</span><br><span class="line">RESOURCE: podAffinity &lt;Object&gt;</span><br><span class="line"></span><br><span class="line">FIELDS:</span><br><span class="line">   preferredDuringSchedulingIgnoredDuringExecution	&lt;[]Object&gt;</span><br><span class="line">   requiredDuringSchedulingIgnoredDuringExecution	&lt;[]Object&gt;</span><br><span class="line">   </span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">requiredDuringSchedulingIgnoredDuringExecution： 硬亲和性</span> </span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">preferredDuringSchedulingIgnoredDuringExecution：软亲和性</span></span><br></pre></td></tr></table></figure>

<ul>
<li>查看<code>pods.spec.affinity.podAffinity.requiredDuringSchedulingIgnoredDuringExecution</code>字段</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">[root@master1 ~]# kubectl explain pods.spec.affinity.podAffinity.requiredDuringSchedulingIgnoredDuringExecution</span><br><span class="line">KIND:     Pod</span><br><span class="line">VERSION:  v1</span><br><span class="line">RESOURCE: requiredDuringSchedulingIgnoredDuringExecution &lt;[]Object&gt;</span><br><span class="line">DESCRIPTION:</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">FIELDS:</span><br><span class="line">   labelSelector	&lt;Object&gt;</span><br><span class="line">   namespaces	&lt;[]string&gt;</span><br><span class="line">   topologyKey	&lt;string&gt; -required-</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">topologyKey：</span> </span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">位置拓扑的键，这个是必须字段</span> </span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">怎么判断是不是同一个位置：</span> </span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">rack=rack1</span> </span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">row=row1</span> </span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">使用 rack 的键是同一个位置</span> </span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">使用 row 的键是同一个位置</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">labelSelector：</span> </span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">判断 pod 跟别的 pod 亲和，跟哪个 pod 亲和，需要靠 labelSelector,通过 labelSelector选则一组能作为亲和对象的 pod 资源</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">namespace：</span> </span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">labelSelector 需要选则一组资源，那么这组资源是在哪个名称空间中呢，通过 namespace 指定，如果不指定 namespaces，那么就是当前创建 pod 的名称空间</span></span><br></pre></td></tr></table></figure>

<ul>
<li>查看<code>pods.spec.affinity.podAffinity.requiredDuringSchedulingIgnoredDuringExecution.labelSelector</code>字段</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@master1 ~]# kubectl explain pods.spec.affinity.podAffinity.requiredDuringSchedulingIgnoredDuringExecution.labelSelector</span><br><span class="line">KIND:     Pod</span><br><span class="line">VERSION:  v1</span><br><span class="line">RESOURCE: labelSelector &lt;Object&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">FIELDS:</span><br><span class="line">   matchExpressions	&lt;[]Object&gt;</span><br><span class="line">   matchLabels	&lt;map[string]string&gt;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>pod节点亲和性<br>定义两个pod，第一个pod作为基准，第二个pod跟着它走</p>
</blockquote>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">pod-1</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">myapp</span></span><br><span class="line">    <span class="attr">tier:</span> <span class="string">frontend</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">myapp</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">ikubernetes/myapp:v1</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">pod-2</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">backend</span></span><br><span class="line">    <span class="attr">tier:</span> <span class="string">db</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">busybox</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">busybox</span></span><br><span class="line">    <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">    <span class="attr">command:</span> [<span class="string">&quot;sh&quot;</span>,<span class="string">&quot;-c&quot;</span>,<span class="string">&quot;sleep 3600&quot;</span>]</span><br><span class="line">  <span class="attr">affinity:</span></span><br><span class="line">    <span class="attr">podAffinity:</span></span><br><span class="line">      <span class="attr">requiredDuringSchedulingIgnoredDuringExecution:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">labelSelector:</span></span><br><span class="line">          <span class="attr">matchExpressions:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">key:</span> <span class="string">app</span></span><br><span class="line">            <span class="attr">operator:</span> <span class="string">In</span></span><br><span class="line">            <span class="attr">values:</span> </span><br><span class="line">            <span class="bullet">-</span> <span class="string">myapp</span></span><br><span class="line">        <span class="attr">topologyKey:</span> <span class="string">kubernetes.io/hostname</span>	<span class="comment"># 节点标签，可以通过kubectl get nodes --show-labels 查看</span></span><br><span class="line">        </span><br><span class="line">[<span class="string">root@master1</span> <span class="string">~</span>]<span class="comment"># kubectl get pods -o wide</span></span><br><span class="line"><span class="string">NAME</span>    <span class="string">READY</span>   <span class="string">STATUS</span>    <span class="string">RESTARTS</span>   <span class="string">AGE</span>     <span class="string">IP</span>               <span class="string">NODE</span>    <span class="string">NOMINATED</span> <span class="string">NODE</span>   <span class="string">READINESS</span> <span class="string">GATES</span></span><br><span class="line"><span class="string">pod-1</span>   <span class="number">1</span><span class="string">/1</span>     <span class="string">Running</span>   <span class="number">0</span>          <span class="string">8m52s</span>   <span class="number">10.244</span><span class="number">.166</span><span class="number">.150</span>   <span class="string">node1</span>   <span class="string">&lt;none&gt;</span>           <span class="string">&lt;none&gt;</span></span><br><span class="line"><span class="string">pod-2</span>   <span class="number">1</span><span class="string">/1</span>     <span class="string">Running</span>   <span class="number">0</span>          <span class="string">50s</span>     <span class="number">10.244</span><span class="number">.166</span><span class="number">.151</span>   <span class="string">node1</span>   <span class="string">&lt;none&gt;</span>           <span class="string">&lt;none&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 上面说明第一个 pod 调度到哪，第二个 pod 也调度到哪，这就是 pod 节点亲和性</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>pod节点反亲和性<br>定义两个pod，第一个pod作为基准，第二个pod跟它调度节点相反</p>
<p>不要与已经存在的pod的标签冲突</p>
</blockquote>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">pod-1</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">myapp</span></span><br><span class="line">    <span class="attr">tier:</span> <span class="string">frontend</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">myapp</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">ikubernetes/myapp:v1</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">pod-2</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">bachend</span></span><br><span class="line">    <span class="attr">tier:</span> <span class="string">db</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">busybox</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">busybox</span></span><br><span class="line">    <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">    <span class="attr">command:</span> [<span class="string">&quot;sh&quot;</span>,<span class="string">&quot;-c&quot;</span>,<span class="string">&quot;sleep 3600&quot;</span>]</span><br><span class="line">  <span class="attr">affinity:</span></span><br><span class="line">    <span class="attr">podAntiAffinity:</span></span><br><span class="line">      <span class="attr">requiredDuringSchedulingIgnoredDuringExecution:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">labelSelector:</span></span><br><span class="line">          <span class="attr">matchExpressions:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">key:</span> <span class="string">app</span></span><br><span class="line">            <span class="attr">operator:</span> <span class="string">In</span></span><br><span class="line">            <span class="attr">values:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">myapp</span></span><br><span class="line">        <span class="attr">topologyKey:</span> <span class="string">kubernetes.io/hostname</span></span><br><span class="line">        </span><br><span class="line">[<span class="string">root@master1</span> <span class="string">~</span>]<span class="comment"># kubectl get pods -o wide</span></span><br><span class="line"><span class="string">NAME</span>    <span class="string">READY</span>   <span class="string">STATUS</span>    <span class="string">RESTARTS</span>   <span class="string">AGE</span>    <span class="string">IP</span>               <span class="string">NODE</span>    <span class="string">NOMINATED</span> <span class="string">NODE</span>   <span class="string">READINESS</span> <span class="string">GATES</span></span><br><span class="line"><span class="string">pod-1</span>   <span class="number">1</span><span class="string">/1</span>     <span class="string">Running</span>   <span class="number">0</span>          <span class="string">2m3s</span>   <span class="number">10.244</span><span class="number">.166</span><span class="number">.152</span>   <span class="string">node1</span>   <span class="string">&lt;none&gt;</span>           <span class="string">&lt;none&gt;</span></span><br><span class="line"><span class="string">pod-2</span>   <span class="number">1</span><span class="string">/1</span>     <span class="string">Running</span>   <span class="number">0</span>          <span class="string">89s</span>    <span class="number">10.244</span><span class="number">.104</span><span class="number">.20</span>    <span class="string">node2</span>   <span class="string">&lt;none&gt;</span>           <span class="string">&lt;none&gt;</span></span><br></pre></td></tr></table></figure>

<ul>
<li>换一个<code>topologykey</code></li>
</ul>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">[<span class="string">root@master1</span> <span class="string">~</span>]<span class="comment"># kubectl label nodes node2 zone=foo</span></span><br><span class="line"></span><br><span class="line">[<span class="string">root@master1</span> <span class="string">~</span>]<span class="comment"># kubectl label nodes node1 zone=foo --overwrite</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 若是节点已经有标签zoo=xxxx，可以用 --overwrite 覆盖</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">pod-1</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">myapp</span></span><br><span class="line">    <span class="attr">tier:</span> <span class="string">frontend</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">myapp</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">ikubernetes/myapp:v1</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">pod-2</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">bachend</span></span><br><span class="line">    <span class="attr">tier:</span> <span class="string">db</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">busybox</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">busybox</span></span><br><span class="line">    <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">    <span class="attr">command:</span> [<span class="string">&quot;sh&quot;</span>,<span class="string">&quot;-c&quot;</span>,<span class="string">&quot;sleep 3600&quot;</span>]</span><br><span class="line">  <span class="attr">affinity:</span></span><br><span class="line">    <span class="attr">podAntiAffinity:</span></span><br><span class="line">      <span class="attr">requiredDuringSchedulingIgnoredDuringExecution:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">labelSelector:</span></span><br><span class="line">          <span class="attr">matchExpressions:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">key:</span> <span class="string">app</span></span><br><span class="line">            <span class="attr">operator:</span> <span class="string">In</span></span><br><span class="line">            <span class="attr">values:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">myapp</span></span><br><span class="line">        <span class="attr">topologyKey:</span> <span class="string">zone</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[<span class="string">root@master1</span> <span class="string">~</span>]<span class="comment"># kubectl get pods</span></span><br><span class="line"><span class="string">NAME</span>    <span class="string">READY</span>   <span class="string">STATUS</span>    <span class="string">RESTARTS</span>   <span class="string">AGE</span></span><br><span class="line"><span class="string">pod-1</span>   <span class="number">1</span><span class="string">/1</span>     <span class="string">Running</span>   <span class="number">0</span>          <span class="string">4s</span></span><br><span class="line"><span class="string">pod-2</span>   <span class="number">0</span><span class="string">/1</span>     <span class="string">Pending</span>   <span class="number">0</span>          <span class="string">4s</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>第二个节点现是 pending，因为两个节点是同一个位置，现在没有不是同一个位置的了，而且要求反亲和性，所以就会处于 pending 状态，如果在反亲和性这个位置把 required 改成 preferred，那么也会运行。</p>
<p><code>podaffinity</code>：pod 节点亲和性，pod 倾向于哪个 pod<br><code>nodeaffinity</code>：node 节点亲和性，pod 倾向于哪个 node</p>
</blockquote>
<h2 id="污点，容忍度"><a href="#污点，容忍度" class="headerlink" title="污点，容忍度"></a>污点，容忍度</h2><blockquote>
<p>给了节点选则的主动权，我们给节点打一个污点，不容忍的 pod 就运行不上来，污点就是定义在节点上的键值属性数据，可以定决定拒绝那些 pod</p>
<p><code>taints</code> 是键值数据，用在节点上，定义污点</p>
<p><code>tolerations</code> 是键值数据，用在 pod 上，定义容忍度，能容忍哪些污点</p>
<p>pod 亲和性是 pod 属性；但是污点是节点的属性，污点定义在 nodeSelector 上</p>
</blockquote>
<ul>
<li>查看<code>node.spec.taints</code>字段</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">[root@master1 ~]# kubectl explain node.spec.taints</span><br><span class="line">KIND:     Node</span><br><span class="line">VERSION:  v1</span><br><span class="line">RESOURCE: taints &lt;[]Object&gt;</span><br><span class="line"></span><br><span class="line">FIELDS:</span><br><span class="line">   effect	&lt;string&gt; -required-</span><br><span class="line">   key	&lt;string&gt; -required-</span><br><span class="line">   timeAdded	&lt;string&gt;</span><br><span class="line">   value	&lt;string&gt;</span><br><span class="line">   </span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">taints 的 effect 用来定义对 pod 对象的排斥等级（效果）：</span> </span><br><span class="line"><span class="meta prompt_"> </span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">NoSchedule：</span> </span><br><span class="line">仅影响 pod 调度过程，当 pod 能容忍这个节点污点，就可以调度到当前节点，后来这个节点的污点改了，加了一个新的污点，使得之前调度的 pod 不能容忍了，那这个 pod 会怎么处理，对现存的 pod 对象不产生影响 </span><br><span class="line"><span class="meta prompt_"> </span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">NoExecute：</span> </span><br><span class="line">既影响调度过程，又影响现存的 pod 对象，如果现存的 pod 不能容忍节点后来加的污点，这个 pod 就会被驱逐 </span><br><span class="line"><span class="meta prompt_"> </span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">PreferNoSchedule：</span> </span><br><span class="line">最好不，也可以，是 NoSchedule 的柔性版本</span><br></pre></td></tr></table></figure>

<blockquote>
<p>在 pod 对象定义容忍度的时候支持两种操作</p>
<p>1.等值密钥：key 和 value 上完全匹配</p>
<p>2.存在性判断：key 和 effect 必须同时匹配，value 可以是空</p>
<p>在 pod 上定义的容忍度可能不止一个，在节点上定义的污点可能多个，需要琢个检查容忍度和污点能否匹配，每一个污点都能被容忍，才能完成调度</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[root@master1 ~]# kubectl describe nodes master1 | grep Taints</span><br><span class="line">Taints:             node-role.kubernetes.io/master:NoSchedule</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">可以看到 master 这个节点的污点是 Noschedule</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">所以创建的 pod 都不会调度到 master 上，因为创建的 pod 没有容忍度</span></span><br><span class="line"></span><br><span class="line">[root@master1 ~]# kubectl describe pods kube-apiserver-master1 -n kube-system </span><br><span class="line">Node-Selectors:    &lt;none&gt;</span><br><span class="line">Tolerations:       :NoExecute op=Exists</span><br><span class="line">Events:            &lt;none&gt;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">可以看到这个 pod 的容忍度是 NoExecute，则可以调度到 master1 上</span></span><br></pre></td></tr></table></figure>

<ul>
<li>管理节点污点</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl taint --help</span><br></pre></td></tr></table></figure>

<ul>
<li>给node2打污点，pod如果不能容忍就不会调度过来</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@master1 ~]# kubectl taint node node2 node-type=production:NoSchedule</span><br></pre></td></tr></table></figure>

<ul>
<li>创建测试pod</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">tomcat</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">tomcat</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">tomcat</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">tomcat</span></span><br><span class="line">    <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">8080</span></span><br><span class="line">    </span><br><span class="line">[<span class="string">root@master1</span> <span class="string">~</span>]<span class="comment"># kubectl get pods -o wide</span></span><br><span class="line"><span class="string">NAME</span>     <span class="string">READY</span>   <span class="string">STATUS</span>    <span class="string">RESTARTS</span>   <span class="string">AGE</span>   <span class="string">IP</span>               <span class="string">NODE</span>    <span class="string">NOMINATED</span> <span class="string">NODE</span>   <span class="string">READINESS</span> <span class="string">GATES</span></span><br><span class="line"><span class="string">tomcat</span>   <span class="number">1</span><span class="string">/1</span>     <span class="string">Running</span>   <span class="number">0</span>          <span class="string">6s</span>    <span class="number">10.244</span><span class="number">.166</span><span class="number">.154</span>   <span class="string">node1</span>   <span class="string">&lt;none&gt;</span>           <span class="string">&lt;none&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 可以看到都被调度到 node1 上了，因为 node2 这个节点打了污点</span></span><br><span class="line"><span class="comment"># 在创建 pod 的时候没有容忍度，所以 node2 上不会有 pod 调度上去的</span></span><br></pre></td></tr></table></figure>

<ul>
<li>给node1也打上污点</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@master1 ~]# kubectl taint node node1 node-type=dev:NoExecute</span><br><span class="line"></span><br><span class="line">[root@master1 ~]# kubectl get pods</span><br><span class="line">NAME     READY   STATUS        RESTARTS   AGE</span><br><span class="line">tomcat   0/1     Terminating   0          3m9s</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">上面可以看到已经存在的 pod 节点都被撵走了</span></span><br></pre></td></tr></table></figure>

<ul>
<li>创建容忍pod</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">tomcat</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">tomcat</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">tomcat</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">tomcat</span></span><br><span class="line">    <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">8080</span></span><br><span class="line">  <span class="attr">tolerations:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">key:</span> <span class="string">&quot;node-type&quot;</span></span><br><span class="line">    <span class="attr">operator:</span> <span class="string">&quot;Equal&quot;</span></span><br><span class="line">    <span class="attr">value:</span> <span class="string">&quot;production&quot;</span></span><br><span class="line">    <span class="attr">effect:</span> <span class="string">&quot;NoExecute&quot;</span></span><br><span class="line">    <span class="attr">tolerationSeconds:</span> <span class="number">3600</span></span><br><span class="line">    </span><br><span class="line">[<span class="string">root@master1</span> <span class="string">~</span>]<span class="comment"># kubectl get pods</span></span><br><span class="line"><span class="string">NAME</span>     <span class="string">READY</span>   <span class="string">STATUS</span>    <span class="string">RESTARTS</span>   <span class="string">AGE</span></span><br><span class="line"><span class="string">tomcat</span>   <span class="number">0</span><span class="string">/1</span>     <span class="string">Pending</span>   <span class="number">0</span>          <span class="string">15s</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 还是显示 pending，因为我们使用的是 equal（等值匹配）</span></span><br><span class="line"><span class="comment"># 所以 key 和 value，effect 必须和 node 节点定义的污点完全匹配才可以</span></span><br><span class="line"><span class="comment"># 把上面配置 effect: &quot;NoExecute&quot;变成 effect: &quot;NoSchedule&quot;</span></span><br><span class="line"><span class="comment"># tolerationSeconds: 3600 这行去掉</span></span><br><span class="line"></span><br><span class="line">[<span class="string">root@master1</span> <span class="string">~</span>]<span class="comment"># kubectl get pods -o wide</span></span><br><span class="line"><span class="string">NAME</span>     <span class="string">READY</span>   <span class="string">STATUS</span>    <span class="string">RESTARTS</span>   <span class="string">AGE</span>   <span class="string">IP</span>              <span class="string">NODE</span>    <span class="string">NOMINATED</span> <span class="string">NODE</span>   <span class="string">READINESS</span> <span class="string">GATES</span></span><br><span class="line"><span class="string">tomcat</span>   <span class="number">1</span><span class="string">/1</span>     <span class="string">Running</span>   <span class="number">0</span>          <span class="string">5s</span>    <span class="number">10.244</span><span class="number">.104</span><span class="number">.21</span>   <span class="string">node2</span>   <span class="string">&lt;none&gt;</span>           <span class="string">&lt;none&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 上面就可以调度到 node2 上了，因为在 pod 中定义的容忍度能容忍 node2 节点上的污点</span></span><br></pre></td></tr></table></figure>

<ul>
<li>修改容忍，让pod调度到node1上</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 修改pod.spec.tolerations字段</span></span><br><span class="line">  <span class="attr">tolerations:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">key:</span> <span class="string">&quot;node-type&quot;</span></span><br><span class="line">    <span class="attr">operator:</span> <span class="string">&quot;Exists&quot;</span></span><br><span class="line">    <span class="attr">value:</span> <span class="string">&quot;&quot;</span></span><br><span class="line">    <span class="attr">effect:</span> <span class="string">&quot;NoSchedule&quot;</span></span><br><span class="line">    </span><br><span class="line"><span class="comment"># 只要对应的键是存在的，exists，其值被自动定义成通配符</span></span><br><span class="line"></span><br><span class="line">[<span class="string">root@master1</span> <span class="string">~</span>]<span class="comment"># kubectl get pods -o wide</span></span><br><span class="line"><span class="string">NAME</span>     <span class="string">READY</span>   <span class="string">STATUS</span>    <span class="string">RESTARTS</span>   <span class="string">AGE</span>   <span class="string">IP</span>              <span class="string">NODE</span>    <span class="string">NOMINATED</span> <span class="string">NODE</span>   <span class="string">READINESS</span> <span class="string">GATES</span></span><br><span class="line"><span class="string">tomcat</span>   <span class="number">1</span><span class="string">/1</span>     <span class="string">Running</span>   <span class="number">0</span>          <span class="string">11s</span>   <span class="number">10.244</span><span class="number">.104</span><span class="number">.22</span>   <span class="string">node2</span>   <span class="string">&lt;none&gt;</span>           <span class="string">&lt;none&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 再次修改pod.spec.tolerations字段</span></span><br><span class="line">  <span class="attr">tolerations:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">key:</span> <span class="string">&quot;node-type&quot;</span></span><br><span class="line">    <span class="attr">operator:</span> <span class="string">&quot;Exists&quot;</span></span><br><span class="line">    <span class="attr">value:</span> <span class="string">&quot;&quot;</span></span><br><span class="line">    <span class="attr">effect:</span> <span class="string">&quot;&quot;</span></span><br><span class="line">    </span><br><span class="line"><span class="comment"># 有一个 node-type 的键，不管值是什么，不管是什么效果，都能容忍</span></span><br><span class="line"></span><br><span class="line">[<span class="string">root@master1</span> <span class="string">~</span>]<span class="comment"># kubectl get pods -o wide</span></span><br><span class="line"><span class="string">NAME</span>     <span class="string">READY</span>   <span class="string">STATUS</span>    <span class="string">RESTARTS</span>   <span class="string">AGE</span>   <span class="string">IP</span>               <span class="string">NODE</span>    <span class="string">NOMINATED</span> <span class="string">NODE</span>   <span class="string">READINESS</span> <span class="string">GATES</span></span><br><span class="line"><span class="string">tomcat</span>   <span class="number">1</span><span class="string">/1</span>     <span class="string">Running</span>   <span class="number">0</span>          <span class="string">12s</span>   <span class="number">10.244</span><span class="number">.166</span><span class="number">.155</span>   <span class="string">node1</span>   <span class="string">&lt;none&gt;</span>           <span class="string">&lt;none&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 可以看到 node2 和 node1 节点上都有可能有 pod 被调度</span></span><br></pre></td></tr></table></figure>

<ul>
<li>删除污点</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@master1 ~]# kubectl taint node node1 node-type:NoExecute-</span><br><span class="line"></span><br><span class="line">[root@master1 ~]# kubectl taint node node2 node-type-</span><br></pre></td></tr></table></figure>

<h1 id="Pod常见的状态和重启策略"><a href="#Pod常见的状态和重启策略" class="headerlink" title="Pod常见的状态和重启策略"></a>Pod常见的状态和重启策略</h1><h2 id="常见的Pod状态"><a href="#常见的Pod状态" class="headerlink" title="常见的Pod状态"></a>常见的Pod状态</h2><blockquote>
<p>Pod 的 status 定义在 PodStatus 对象中，其中有一个 phase 字段。它简单描述了 Pod 在其生命周期的阶段。熟悉 Pod 的各种状态对我们理解如何设置 Pod 的调度策略、重启策略是很有必要的。下面是 phase 可能的值，也就是 pod 常见的状态：</p>
</blockquote>
<ul>
<li><p>挂起（<code>Pending</code>）</p>
<p>我们在请求创建 pod 时，条件不满足，调度没有完成，没有任何一个节点能满足调度条件，已经创建了 pod 但是没有适合它运行的节点叫做挂起，调度没有完成，处于 pending的状态会持续一段时间：包括调度 Pod 的时间和通过网络下载镜像的时间。</p>
</li>
<li><p>运行中（<code>Running</code>）</p>
<p>Pod 已经绑定到了一个节点上，Pod 中所有的容器都已被创建。至少有一个容器正在运行，或者正处于启动或重启状态。</p>
</li>
<li><p>成功（<code>Succeeded</code>）</p>
<p>Pod 中的所有容器都被成功终止，并且不会再重启。</p>
</li>
<li><p>失败（<code>Failed</code>）</p>
<p>Pod 中的所有容器都已终止了，并且至少有一个容器是因为失败终止。也就是说，容器以非 0 状态退出或者被系统终止。</p>
</li>
<li><p>未知（<code>Unknown</code>）</p>
<p>未知状态，所谓 pod 是什么状态是 apiserver 和运行在 pod 节点的 kubelet 进行通信获取状态信息的，如果节点之上的 kubelet 本身出故障，那么 apiserver 就连不上kubelet，得不到信息了，就会看 Unknown</p>
</li>
<li><p><code>Evicted</code> 状态</p>
<p>出现这种情况，多见于系统内存或硬盘资源不足，可 df-h 查看 docker 存储所在目录的资源使用情况，如果百分比大于 85%，就要及时清理下资源，尤其是一些大文件、docker 镜像。 </p>
</li>
<li><p><code>CrashLoopBackOff</code></p>
<p>容器曾经启动了，但可能又异常退出了</p>
</li>
<li><p><code>Error</code> 状态</p>
<p>Pod 启动过程中发生了错误</p>
</li>
</ul>
<h2 id="Pod重启策略"><a href="#Pod重启策略" class="headerlink" title="Pod重启策略"></a>Pod重启策略</h2><blockquote>
<p>Pod 的重启策略（RestartPolicy）应用于 Pod 内的所有容器，并且仅在 Pod 所处的 Node 上由kubelet 进行判断和重启操作。当某个容器异常退出或者健康检查失败时，kubelet 将根据RestartPolicy 的设置来进行相应的操作。</p>
</blockquote>
<p>Pod 的重启策略包括 Always、OnFailure 和 Never，默认值为 Always。</p>
<ul>
<li><p><code>Always</code>：当容器失败时，由 kubelet 自动重启该容器。</p>
</li>
<li><p><code>OnFailure</code>：当容器终止运行且退出码不为 0 时，由 kubelet 自动重启该容器。</p>
</li>
<li><p><code>Never</code>：不论容器运行状态如何，kubelet 都不会重启该容器。</p>
</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">tomcat</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">tomcat</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">restartPolicy:</span> <span class="string">Always</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">tomcat</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">tomcat</span></span><br><span class="line">    <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">8080</span></span><br></pre></td></tr></table></figure>

<h1 id="Pod生命周期"><a href="#Pod生命周期" class="headerlink" title="Pod生命周期"></a>Pod生命周期</h1><p><img src="../../../../images/image/k8s-han/19.png" alt="19"></p>
<h2 id="Init容器"><a href="#Init容器" class="headerlink" title="Init容器"></a>Init容器</h2><blockquote>
<p>Pod 里面可以有一个或者多个容器，部署应用的容器可以称为主容器，在创建 Pod 时候，Pod 中可以有一个或多个先于主容器启动的 Init 容器,这个 init 容器就可以成为初始化容器，初始化容器一旦执行完，它从启动开始到初始化代码执行完就退出了，它不会一直存在，所以在主容器启动之前执行初始化，初始化容器可以有多个，多个初始化容器是要串行执行的，先执行初始化容器 1，在执行初始化容器 2 等，等初始化容器执行完初始化就退出了，然后再执行主容器，主容器一退出，pod 就结束了，主容器退出的时间点就是 pod 的结束点，它俩时间轴是一致的；</p>
</blockquote>
<blockquote>
<p>Init 容器就是做初始化工作的容器。可以有一个或多个，如果多个按照定义的顺序依次执行，只有所有的初始化容器执行完后，主容器才启动。由于一个 Pod 里的存储卷是共享的，所以 Init Container 里产生的数据可以被主容器使用到，Init Container 可以在多种 K8S 资源里被使用到，如 Deployment、DaemonSet, StatefulSet、Job 等，但都是在 Pod 启动时，在主容器启动前执行，做初始化工作。</p>
</blockquote>
<blockquote>
<p>Init 容器与普通的容器区别</p>
</blockquote>
<ul>
<li>Init 容器不支持 Readiness，因为它们必须在 Pod 就绪之前运行完成</li>
<li>每个 Init 容器必须运行成功，下一个才能够运行</li>
<li>如果 Pod 的 Init 容器失败，Kubernetes 会不断地重启该 Pod，直到 Init 容器成功为止，然而， 如果 Pod 对应的 restartPolicy 值为 Never，它不会重新启动。</li>
<li>初始化容器的官方地址：<a target="_blank" rel="noopener" href="https://kubernetes.io/docs/concepts/workloads/pods/init-containers/#init-containers-in-use">https://kubernetes.io/docs/concepts/workloads/pods/init-containers/#init-containers-in-use</a></li>
</ul>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line">[<span class="string">root@master1</span> <span class="string">~</span>]<span class="comment"># vim init.yaml</span></span><br><span class="line"></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">myapp-pod</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">myapp</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">myapp-container</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">busybox:1.28</span></span><br><span class="line">    <span class="attr">command:</span> [<span class="string">&quot;sh&quot;</span>,<span class="string">&quot;-c&quot;</span>,<span class="string">&quot;echo The app is running! &amp;&amp; sleep 3600&quot;</span>]</span><br><span class="line">  <span class="attr">initContainers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">init-myservice</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">busybox:1.28</span></span><br><span class="line">    <span class="attr">command:</span> [<span class="string">&quot;sh&quot;</span>,<span class="string">&quot;-c&quot;</span>,<span class="string">&quot;until nslookup myservice.$(cat /var/run/secrets/kubernetes.io/serviceaccount/namespace).svc.cluster.local; do echo waiting for myservice; sleep 2; done&quot;</span>]</span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">init-myweb</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">busybox:1.28</span></span><br><span class="line">    <span class="attr">command:</span> [<span class="string">&#x27;sh&#x27;</span>,<span class="string">&#x27;-c&#x27;</span>,<span class="string">&quot;until nslookup mydb.$(cat /var/run/secrets/kubernetes.io/serviceaccount/namespace).svc.cluster.local; do echo waiting for mydb; sleep 2; done&quot;</span>]</span><br><span class="line">    </span><br><span class="line"></span><br><span class="line">[<span class="string">root@master1</span> <span class="string">~</span>]<span class="comment"># kubectl get pods</span></span><br><span class="line"><span class="string">NAME</span>        <span class="string">READY</span>   <span class="string">STATUS</span>     <span class="string">RESTARTS</span>   <span class="string">AGE</span></span><br><span class="line"><span class="string">myapp-pod</span>   <span class="number">0</span><span class="string">/1</span>     <span class="string">Init:0/2</span>   <span class="number">0</span>          <span class="string">3s</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 因为现在还没有myservice和mydb这两个服务</span></span><br><span class="line"></span><br><span class="line">[<span class="string">root@master1</span> <span class="string">~</span>]<span class="comment"># vim service.yaml</span></span><br><span class="line"></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">myservice</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">    <span class="attr">targetPort:</span> <span class="number">9376</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">mydb</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">    <span class="attr">targetPort:</span> <span class="number">9377</span></span><br><span class="line">    </span><br><span class="line"></span><br><span class="line">[<span class="string">root@master1</span> <span class="string">~</span>]<span class="comment"># kubectl get pods</span></span><br><span class="line"><span class="string">NAME</span>        <span class="string">READY</span>   <span class="string">STATUS</span>    <span class="string">RESTARTS</span>   <span class="string">AGE</span></span><br><span class="line"><span class="string">myapp-pod</span>   <span class="number">1</span><span class="string">/1</span>     <span class="string">Running</span>   <span class="number">0</span>          <span class="string">4s</span></span><br></pre></td></tr></table></figure>

<h2 id="主容器"><a href="#主容器" class="headerlink" title="主容器"></a>主容器</h2><blockquote>
<p>容器钩子</p>
</blockquote>
<blockquote>
<p>初始化容器启动之后，开始启动主容器，在主容器启动之前有一个<code> post start hook</code>（容器启动后钩子）和 <code>pre stop hook</code>（容器结束前钩子），无论启动后还是结束前所做的事我们可以把它放两个钩子，这个钩子就表示用户可以用它来钩住一些命令，来执行它，做开场前的预设，结束前的清理，如 awk 有 begin，end，和这个效果类似； </p>
</blockquote>
<ul>
<li><p><code>postStart</code></p>
<p>该钩子在容器被创建后立刻触发，通知容器它已经被创建。如果该钩子对应的 hook handler 执行失败，则该容器会被杀死，并根据该容器的重启策略决定是否要重启该容器，这个钩子不需要传递任何参数。 </p>
</li>
<li><p><code>preStop</code></p>
<p>该钩子在容器被删除前触发，其所对应的 hook handler 必须在删除该容器的请求发送给 Docker daemon 之前完成。在该钩子对应的 hook handler 完成后不论执行的结果如何，Docker daemon 会发送一个 SGTERN 信号量给 Docker daemon 来删除该容器，这个钩子不需要传递任何参数。</p>
</li>
</ul>
<blockquote>
<p>在 k8s 中支持两类对 pod 的检测</p>
<p>第一类叫做<code> livenessprobe</code>（pod 存活性探测）：存活探针主要作用是，用指定的方式检测 pod 中的容器应用是否正常运行，如果检测失败，则认为容器不健康，那么 Kubelet 将根据 Pod 中设置的 restartPolicy 来判断 Pod 是否要进行重启操作，如果容器配置中没有配置 livenessProbe，Kubelet 将认为存活探针探测一直为成功状态。</p>
<p>第二类是状态检<code> readinessprobe</code>（pod 就绪性探测）：用于判断容器中应用是否启动完成，当探测成功后才使 Pod 对外提供网络访问，设置容器 Ready 状态为 true，如果探测失败，则设置容器的Ready 状态为 false。</p>
</blockquote>
<h2 id="创建-pod-需要经过的阶段"><a href="#创建-pod-需要经过的阶段" class="headerlink" title="创建 pod 需要经过的阶段"></a>创建 pod 需要经过的阶段</h2><blockquote>
<p>当用户创建 pod 时，这个请求给 apiserver，apiserver 把创建请求的状态保存在 etcd 中；</p>
<p>接下来 apiserver 会请求 scheduler 来完成调度，如果调度成功，会把调度的结果（如调度到哪个节点上了，运行在哪个节点上了，把它更新到 etcd 的 pod 资源状态中）保存在 etcd 中</p>
<p>一旦存到 etcd 中并且完成更新以后，如调度到  node1 上，那么 node1 节点上的 kubelet 通过 apiserver 当中的状态变化知道有一些任务被执行了，所以此时此 kubelet 会拿到用户创建时所提交的清单，这个清单会在当前节点上运行或者启动这个 pod</p>
<p>如果创建成功或者失败会有一个当前状态，当前这个状态会发给 apiserver，apiserver 在存到 etcd 中；在这个过程中，etcd 和 apiserver 一直在打交道，不停的交互，scheduler 也参与其中，负责调度 pod 到合适的 node 节点上，这个就是 pod 的创建过程</p>
</blockquote>
<blockquote>
<p>pod 在整个生命周期中有非常多的用户行为</p>
</blockquote>
<ul>
<li>初始化容器完成初始化</li>
<li>主容器启动后可以做启动后钩子</li>
<li>主容器结束前可以做结束前钩子</li>
<li>在主容器运行中可以做一些健康检测，如 liveness probe，readness probe</li>
</ul>
<h1 id="Pod容器探测和钩子"><a href="#Pod容器探测和钩子" class="headerlink" title="Pod容器探测和钩子"></a>Pod容器探测和钩子</h1><h2 id="容器钩子"><a href="#容器钩子" class="headerlink" title="容器钩子"></a>容器钩子</h2><blockquote>
<p><code>postStart</code>：容器创建成功后，运行前的任务，用于资源部署、环境准备等</p>
<p><code>preStop</code>：容器被终止前的任务，用于优雅关闭应用程序、通知其他系统等</p>
</blockquote>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">······</span></span><br><span class="line"><span class="attr">containers:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">image:</span> <span class="string">sample:v2</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">war</span></span><br><span class="line">  <span class="attr">lifecycle:</span></span><br><span class="line">    <span class="attr">postStart:</span></span><br><span class="line">      <span class="attr">exec:</span></span><br><span class="line">        <span class="attr">command:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">&quot;cp&quot;</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">&quot;/sample.war&quot;</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">&quot;/app&quot;</span></span><br><span class="line">    <span class="attr">preStop:</span></span><br><span class="line">      <span class="attr">http:</span></span><br><span class="line">        <span class="attr">host:</span> <span class="string">monitor.com</span></span><br><span class="line">        <span class="attr">path:</span> <span class="string">/waring</span></span><br><span class="line">        <span class="attr">port:</span> <span class="number">8080</span></span><br><span class="line">        <span class="attr">scheme:</span> <span class="string">HTTP</span></span><br><span class="line"><span class="string">······</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 以上示例中，定义了一个 Pod，包含一个 JAVA 的 web 应用容器，其中设置了 PostStart 和PreStop 回调函数。</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 即在容器创建成功后，复制/sample.war 到/app 文件夹中。</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 而在容器终止之前，发送 HTTP 请求到 http://monitor.com:8080/waring，即向监控系统发送警告。</span></span><br></pre></td></tr></table></figure>

<ul>
<li>优雅的删除资源对象</li>
</ul>
<blockquote>
<p>当用户请求删除含有 pod 的资源对象时（如 RC、deployment 等），K8S 为了让应用程序优雅关闭（即让应用程序完成正在处理的请求后，再关闭软件），K8S 提供两种信息通知：</p>
</blockquote>
<blockquote>
<p>1）、默认：K8S 通知 node 执行 docker stop 命令，docker 会先向容器中 PID 为 1 的进程发送系统信号 SIGTERM，然后等待容器中的应用程序终止执行，如果等待时间达到设定的超时时间，或者默认超时时间（30s），会继续发送 SIGKILL 的系统信号强行 kill 掉进程。 </p>
</blockquote>
<blockquote>
<p>2）、使用 pod 生命周期（利用 PreStop 回调函数），它执行在发送终止信号之前。默认情况下，所有的删除操作的优雅退出时间都在 30 秒以内。kubectl delete 命令支持–grace-period=的选项，以运行用户来修改默认值。0 表示删除立即执行，并且立即从 API 中删除 pod。在节点上，被设置了立即结束的的 pod，仍然会给一个很短的优雅退出时间段，才会开始被强制杀死。</p>
</blockquote>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">······</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">centos:nginx</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">http</span></span><br><span class="line">      <span class="attr">containerPort:</span> <span class="number">80</span></span><br><span class="line">    <span class="attr">lifecycle:</span></span><br><span class="line">      <span class="attr">preStop:</span></span><br><span class="line">        <span class="attr">exec:</span></span><br><span class="line">        <span class="comment"># nginx -s quit greacefully terminate while SIGTERM triggers a quick exit</span></span><br><span class="line">          <span class="attr">command:</span> [<span class="string">&quot;/usr/local/nginx/sbin/nginx&quot;</span>,<span class="string">&quot;-s&quot;</span>,<span class="string">&quot;quit&quot;</span>]</span><br><span class="line"><span class="string">······</span></span><br></pre></td></tr></table></figure>

<h2 id="存活性探测和就绪性探测"><a href="#存活性探测和就绪性探测" class="headerlink" title="存活性探测和就绪性探测"></a>存活性探测和就绪性探测</h2><blockquote>
<p><code>livenessProbe</code>：存活性探测 </p>
<p>许多应用程序经过长时间运行，最终过渡到无法运行的状态，除了重启，无法恢复。通常情况下，K8S 会发现应用程序已经终止，然后重启应用程序 pod。有时应用程序可能因为某些原因（后端服务故障等）导致暂时无法对外提供服务，但应用软件没有终止，导致 K8S 无法隔离有故障的pod，调用者可能会访问到有故障的 pod，导致业务不稳定。K8S 提供 livenessProbe 来检测容器是否正常运行，并且对相应状况进行相应的补救措施。 </p>
</blockquote>
<blockquote>
<p><code>readinessProbe</code>：就绪性探测 </p>
<p>在没有配置 readinessProbe 的资源对象中，pod 中的容器启动完成后，就认为 pod 中的应用程序可以对外提供服务，该 pod 就会加入相对应的 service，对外提供服务。但有时一些应用程序启动后，需要较长时间的加载才能对外服务，如果这时对外提供服务，执行结果必然无法达到预期效果，影响用户体验。比如使用 tomcat 的应用程序来说，并不是简单地说 tomcat 启动成功就可以对外提供服务的，还需要等待 spring 容器初始化，数据库连接上等等。</p>
</blockquote>
<blockquote>
<p>LivenessProbe 和 ReadinessProbe 两种探针都支持下面三种探测方法</p>
</blockquote>
<ul>
<li><p><code>ExecAction</code></p>
<p>在容器中执行指定的命令，如果执行成功，退出码为 0 则探测成功。 </p>
</li>
<li><p><code>TCPSocketAction</code></p>
<p>通过容器的 IP 地址和端口号执行 TCP 检查，如果能够建立 TCP 连接，则表明容器健康。 </p>
</li>
<li><p><code>HTTPGetAction</code></p>
<p>通过容器的 IP 地址、端口号及路径调用 HTTP Get 方法，如果响应的状态码大于等于 200 且小于 400，则认为容器健康</p>
</li>
</ul>
<blockquote>
<p>探针探测结果有以下值</p>
</blockquote>
<ul>
<li><code>Success</code>：表示通过检测。</li>
<li><code>Failure</code>：表示未通过检测。</li>
<li><code>Unknown</code>：表示检测没有正常进行。</li>
</ul>
<blockquote>
<p>Pod 探针相关的属性：<br>探针(Probe)有许多可选字段，可以用来更加精确的控制 Liveness 和 Readiness 两种探针的行为</p>
</blockquote>
<ul>
<li><p><code>initialDelaySeconds</code></p>
<p>Pod 启动后首次进行检查的等待时间，单位“秒”。 </p>
</li>
<li><p><code>periodSeconds</code></p>
<p>检查的间隔时间，默认为 10s，单位“秒”。 </p>
</li>
<li><p><code>timeoutSeconds</code></p>
<p>探针执行检测请求后，等待响应的超时时间，默认为 1s，单位“秒”。 </p>
</li>
<li><p><code>successThreshold</code></p>
<p>连续探测几次成功，才认为探测成功，默认为 1，在 Liveness 探针中必须为 1，最小值为 1。 </p>
</li>
<li><p><code>failureThreshold</code></p>
<p> 探测失败的重试次数，重试一定次数后将认为失败，在 readiness 探针中，Pod 会被标记为未就绪，默认为 3，最小值为 1</p>
</li>
</ul>
<h3 id="两种探针区别"><a href="#两种探针区别" class="headerlink" title="两种探针区别"></a>两种探针区别</h3><blockquote>
<p>ReadinessProbe 和 livenessProbe 可以使用相同探测方式，只是对 Pod 的处置方式不同 </p>
</blockquote>
<ul>
<li><p><code>readinessProbe</code> 当检测失败后，将 Pod 的 IP:Port 从对应的 EndPoint 列表中删除。 </p>
</li>
<li><p><code>livenessProbe</code> 当检测失败后，将杀死容器并根据 Pod 的重启策略来决定作出对应的措施。</p>
</li>
<li><p>官网地址：<a target="_blank" rel="noopener" href="https://kubernetes.io/zh-cn/docs/tasks/configure-pod-container/configure-liveness-readiness-startup-probes/">https://kubernetes.io/zh-cn/docs/tasks/configure-pod-container/configure-liveness-readiness-startup-probes/</a></p>
</li>
</ul>
<h3 id="Pod探针使用"><a href="#Pod探针使用" class="headerlink" title="Pod探针使用"></a>Pod探针使用</h3><ul>
<li><code>LivenessProbe</code> 探针使用示例</li>
</ul>
<blockquote>
<p>通过 <code>exec</code> 方式做健康探测</p>
</blockquote>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">liveness-exec</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">liveness</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">liveness</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">busybox</span></span><br><span class="line">    <span class="attr">args:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">/bin/sh</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">-c</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">touch</span> <span class="string">/tmp/healthy;</span> <span class="string">sleep</span> <span class="number">30</span><span class="string">;</span> <span class="string">rm</span> <span class="string">-rf</span> <span class="string">/tmp/healthy;</span> <span class="string">sleep</span> <span class="number">600</span></span><br><span class="line">    <span class="attr">livenessProbe:</span></span><br><span class="line">      <span class="attr">initialDelaySeconds:</span> <span class="number">10</span>	<span class="comment"># 延迟检测时间</span></span><br><span class="line">      <span class="attr">periodSeconds:</span> <span class="number">5</span>			<span class="comment"># 检测时间间隔</span></span><br><span class="line">      <span class="attr">exec:</span></span><br><span class="line">        <span class="attr">command:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">cat</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">/tmp/healthy</span></span><br><span class="line">        </span><br><span class="line">        </span><br><span class="line">        </span><br><span class="line"><span class="comment"># 容器启动设置执行的命令： </span></span><br><span class="line"><span class="string">/bin/sh</span> <span class="string">-c</span> <span class="string">&quot;touch /tmp/healthy; sleep 30; rm -rf /tmp/healthy; sleep 600&quot;</span> </span><br><span class="line"> </span><br><span class="line"><span class="comment"># 容器在初始化后，首先创建一个 /tmp/healthy 文件，然后执行睡眠命令，睡眠 30 秒，到时间后执行删除 /tmp/healthy 文件命令。</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 而设置的存活探针检检测方式为执行 shell 命令，用 cat 命令输出 healthy 文件的内容，如果能成功执行这条命令，存活探针就认为探测成功，否则探测失败。</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 在前 30 秒内，由于文件存在，所以存活探针探测时执行 cat /tmp/healthy 命令成功执行。</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 30 秒后 healthy 文件被删除，所以执行命令失败，Kubernetes 会根据 Pod 设置的重启策略来判断，是否重启 Pod。</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>通过 <code>HTTP</code> 方式做健康检测</p>
</blockquote>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">liveness-http</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">test:</span> <span class="string">liveness</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">liveness</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">mydlqclub/springboot-helloworld:0.0.1</span></span><br><span class="line">    <span class="attr">livenessProbe:</span></span><br><span class="line">      <span class="attr">initialDelaySeconds:</span> <span class="number">20</span></span><br><span class="line">      <span class="attr">periodSeconds:</span> <span class="number">5</span></span><br><span class="line">      <span class="attr">timeoutSeconds:</span> <span class="number">10</span></span><br><span class="line">      <span class="attr">httpGet:</span></span><br><span class="line">        <span class="attr">scheme:</span> <span class="string">HTTP</span></span><br><span class="line">        <span class="attr">port:</span> <span class="number">8081</span></span><br><span class="line">        <span class="attr">path:</span> <span class="string">/actuator/health</span></span><br><span class="line">        </span><br><span class="line"><span class="comment"># 上面 Pod 中启动的容器是一个 SpringBoot 应用，其中引用了 Actuator 组件，提供了 /actuator/health 健康检查地址，存活探针可以使用 HTTPGet 方式向服务发起请求，请求 8081 端口的 /actuator/health 路径来进行存活判断： </span></span><br><span class="line"> </span><br><span class="line"><span class="comment"># 任何大于或等于 200 且小于 400 的代码表示探测成功。 任何其他代码表示失败。 </span></span><br><span class="line"> </span><br><span class="line"><span class="comment"># 如果探测失败，则会杀死 Pod 进行重启操作。</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># httpGet 探测方式有如下可选的控制字段</span></span><br><span class="line"><span class="attr">scheme:</span> <span class="string">用于连接</span> <span class="string">host</span> <span class="string">的协议，默认为</span> <span class="string">HTTP。</span> </span><br><span class="line"><span class="attr">host:</span> <span class="string">要连接的主机名，默认为</span> <span class="string">Pod</span> <span class="string">IP，可以在</span> <span class="string">http</span> <span class="string">request</span> <span class="string">head</span> <span class="string">中设置</span> <span class="string">host</span> <span class="string">头部。</span> </span><br><span class="line"><span class="attr">port:</span> <span class="string">容器上要访问端口号或名称。</span> </span><br><span class="line"><span class="attr">path:</span> <span class="string">http</span> <span class="string">服务器上的访问</span> <span class="string">URI。</span> </span><br><span class="line"><span class="attr">httpHeaders:</span> <span class="string">自定义</span> <span class="string">HTTP</span> <span class="string">请求</span> <span class="string">headers，HTTP</span> <span class="string">允许重复</span> <span class="string">headers。</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>通过TCP方式做健康检测</p>
</blockquote>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">liveness-tcp</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">liveness</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">liveness</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">livenessProbe:</span></span><br><span class="line">      <span class="attr">initialDelaySeconds:</span> <span class="number">15</span></span><br><span class="line">      <span class="attr">periodSeconds:</span> <span class="number">20</span></span><br><span class="line">      <span class="attr">tcpSocket:</span></span><br><span class="line">        <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">        </span><br><span class="line"><span class="comment"># TCP 检查方式和 HTTP 检查方式非常相似</span></span><br><span class="line"><span class="comment"># 在容器启动 initialDelaySeconds 参数设定的时间后，kubelet 将发送第一个 livenessProbe 探针，尝试连接容器的 80 端口</span></span><br><span class="line"><span class="comment"># 如果连接失败则将杀死 Pod 重启容器。</span></span><br></pre></td></tr></table></figure>

<ul>
<li><code>ReadinessProbe</code> 探针使用示例</li>
</ul>
<blockquote>
<p>Pod 的 ReadinessProbe 探针使用方式和 LivenessProbe 探针探测方法一样，也是支持三种。只是一个是用于探测应用的存活，一个是判断是否对外提供流量的条件。</p>
</blockquote>
<blockquote>
<p>这里用一个 Springboot项目，设置 ReadinessProbe 探测 SpringBoot 项目的 8081 端口下的 /actuator/health 接口，如果探测成功则代表内部程序以及启动，就开放对外提供接口访问，否则内部应用没有成功启动，暂不对外提供访问，直到就绪探针探测成功。</p>
</blockquote>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">springboot</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">springboot</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">NodePort</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">server</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">8080</span></span><br><span class="line">    <span class="attr">targetPort:</span> <span class="number">8080</span></span><br><span class="line">    <span class="attr">nodePort:</span> <span class="number">31180</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">management</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">8081</span></span><br><span class="line">    <span class="attr">targetPort:</span> <span class="number">8081</span></span><br><span class="line">    <span class="attr">nodePort:</span> <span class="number">31181</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">springboot</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">springboot</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">springboot</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">springboot</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">mydlqclub/springboot-helloworld:0.0.1</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">server</span></span><br><span class="line">      <span class="attr">containerPort:</span> <span class="number">8080</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">management</span></span><br><span class="line">      <span class="attr">containerPort:</span> <span class="number">8081</span></span><br><span class="line">    <span class="attr">readinessProbe:</span></span><br><span class="line">      <span class="attr">initialDelaySeconds:</span> <span class="number">20</span></span><br><span class="line">      <span class="attr">periodSeconds:</span> <span class="number">5</span></span><br><span class="line">      <span class="attr">timeoutSeconds:</span> <span class="number">10</span></span><br><span class="line">      <span class="attr">httpGet:</span></span><br><span class="line">        <span class="attr">scheme:</span> <span class="string">HTTP</span></span><br><span class="line">        <span class="attr">port:</span> <span class="number">8081</span></span><br><span class="line">        <span class="attr">path:</span> <span class="string">/actuator/health</span></span><br></pre></td></tr></table></figure>

<ul>
<li><code>ReadinessProbe</code> + <code>LivenessProbe</code> 配合使用示例</li>
</ul>
<blockquote>
<p>一般程序中需要设置两种探针结合使用，并且也要结合实际情况，来配置初始化检查时间和检测间隔，下面列一个简单的 SpringBoot 项目的 Deployment 例子。 </p>
</blockquote>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">springboot</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">springboot</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">NodePort</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">springboot</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">server</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">8080</span></span><br><span class="line">    <span class="attr">targetPort:</span> <span class="number">8080</span></span><br><span class="line">    <span class="attr">nodePort:</span> <span class="number">31180</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">management</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">8081</span></span><br><span class="line">    <span class="attr">targetPort:</span> <span class="number">8081</span></span><br><span class="line">    <span class="attr">nodePort:</span> <span class="number">31181</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">springboot</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">springboot</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">springboot</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">springboot</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">springboot</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">readiness</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">mydlqclub/springboot-helloworld:0.0.1</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">server</span></span><br><span class="line">          <span class="attr">containerPort:</span> <span class="number">8080</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">management</span></span><br><span class="line">          <span class="attr">containerPort:</span> <span class="number">8081</span></span><br><span class="line">        <span class="attr">readinessProbe:</span></span><br><span class="line">          <span class="attr">initialDelaySeconds:</span> <span class="number">20</span></span><br><span class="line">          <span class="attr">periodSeconds:</span> <span class="number">5</span></span><br><span class="line">          <span class="attr">timeoutSeconds:</span> <span class="number">10</span></span><br><span class="line">          <span class="attr">httpGet:</span></span><br><span class="line">            <span class="attr">scheme:</span> <span class="string">HTTP</span></span><br><span class="line">            <span class="attr">port:</span> <span class="number">8081</span></span><br><span class="line">            <span class="attr">path:</span> <span class="string">/actuator/health</span></span><br><span class="line">        <span class="attr">livenessProbe:</span></span><br><span class="line">          <span class="attr">initialDelaySeconds:</span> <span class="number">30</span></span><br><span class="line">          <span class="attr">periodSeconds:</span> <span class="number">10</span></span><br><span class="line">          <span class="attr">timeoutSeconds:</span> <span class="number">5</span></span><br><span class="line">          <span class="attr">httpGet:</span></span><br><span class="line">            <span class="attr">scheme:</span> <span class="string">HTTP</span></span><br><span class="line">            <span class="attr">port:</span> <span class="number">8081</span></span><br><span class="line">            <span class="attr">path:</span> <span class="string">/actuator/health</span></span><br></pre></td></tr></table></figure>

<h2 id="启动探测"><a href="#启动探测" class="headerlink" title="启动探测"></a>启动探测</h2><blockquote>
<p><code>livenessProbe</code>：用于探测容器是否运行。如果存活探测失败，则 kubelet 会杀死容器，并且容器将受到其重启策略的影响决定是否重启。如果容器不提供存活探针，则默认状态为 Success。</p>
</blockquote>
<blockquote>
<p><code>readinessProbe</code>：一般用于探测容器内的程序是否健康，容器是否准备好服务请求。如果就绪探测失败，endpoint 将从与 Pod 匹配的所有 Service 的端点中删除该 Pod 的 IP 地址。初始延迟之前的就绪状态默认为 Failure。如果容器不提供就绪探针，则默认状态为 Success。 </p>
</blockquote>
<blockquote>
<p><code>startupProbe</code>： 探测容器中的应用是否已经启动。如果提供了启动探测(startup probe)，则禁用所有其他探测，直到它成功为止。如果启动探测失败，kubelet 将杀死容器，容器服从其重启策略进行重启。如果容器没有提供启动探测，则默认状态为成功 Success。</p>
</blockquote>
<ul>
<li>startupProbe基础介绍</li>
</ul>
<blockquote>
<p>在 k8s 中，通过控制器管理 pod，如果更新 pod 的时候，会创建新的 pod，删除老的 pod，但是如果新的 pod 创建了，pod 里的容器还没完成初始化，老的 pod 就被删除了，会导致访问 service 或者ingress 时候，访问到的 pod 是有问题的，所以 k8s 就加入了一些存活性探针：livenessProbe、就绪性探针 readinessProbe 以及启动探针 startupProbe。</p>
</blockquote>
<ul>
<li>正常情况下，在 pod template 中配置 livenessProbe 来探测容器是否正常运行，如果异常则会触发restartPolicy 重启容器（默认情况下 restartPolicy 设置的是 always）</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">livenessProbe:</span></span><br><span class="line">  <span class="attr">httpGet:</span></span><br><span class="line">    <span class="attr">path:</span> <span class="string">/test</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">  <span class="attr">failureThreshold:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">initialDelay:</span> <span class="number">10</span></span><br><span class="line">  <span class="attr">periodSeconds:</span> <span class="number">10</span></span><br><span class="line">  </span><br><span class="line"><span class="comment"># 上面配置的意思是容器启动 10s 后每 10s 检查一次，允许失败的次数是 1 次。</span></span><br><span class="line"><span class="comment"># 如果失败次数超过 1 则会触发 restartPolicy。 </span></span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"><span class="comment"># 但是有时候会存在特殊情况，比如服务 A 启动时间很慢，需要 60s。这个时候如果还是用上面的探针就会进入死循环</span></span><br><span class="line"><span class="comment"># 因为上面的探针 10s 后就开始探测，这时候我们服务并没有起来，发现探测失败就会触发restartPolicy。</span></span><br><span class="line"><span class="comment"># 这时候有的朋友可能会想到把 initialDelay 调成 60s 不就可以了？</span></span><br><span class="line"><span class="comment"># 但是我们并不能保证这个服务每次起来都是 60s，假如新的版本起来要 70s，甚至更多的时间，我们就不好控制了。</span></span><br><span class="line"><span class="comment"># 有的朋友可能还会想到把失败次数增加，比如下面配置：</span></span><br><span class="line"></span><br><span class="line"><span class="attr">livenessProbe:</span> </span><br><span class="line">  <span class="attr">httpGet:</span> </span><br><span class="line">    <span class="attr">path:</span> <span class="string">/test</span> </span><br><span class="line">    <span class="attr">prot:</span> <span class="number">80</span> </span><br><span class="line">  <span class="attr">failureThreshold:</span> <span class="number">5</span> </span><br><span class="line">  <span class="attr">initialDelay:</span> <span class="number">60</span> </span><br><span class="line">  <span class="attr">periodSeconds:</span> <span class="number">10</span></span><br><span class="line">  </span><br><span class="line"><span class="comment"># 这在启动的时候是可以解决我们目前的问题</span></span><br><span class="line"><span class="comment"># 但是如果这个服务挂了呢？如果 failureThreshold=1 则10s 后就会报警通知服务挂了</span></span><br><span class="line"><span class="comment"># 如果设置了 failureThreshold=5，那么就需要 5*10s=50s 的时间，在现在大家追求快速发现、快速定位、快速响应的时代是不被允许的。</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 在这时候把 startupProbe 和 livenessProbe 结合起来使用就可以很大程度上解决问题。</span></span><br><span class="line"></span><br><span class="line"><span class="attr">livenessProbe:</span> </span><br><span class="line">  <span class="attr">httpGet:</span> </span><br><span class="line">    <span class="attr">path:</span> <span class="string">/test</span> </span><br><span class="line">    <span class="attr">prot:</span> <span class="number">80</span> </span><br><span class="line">  <span class="attr">failureThreshold:</span> <span class="number">1</span> </span><br><span class="line">  <span class="attr">initialDelay:</span> <span class="number">10</span> </span><br><span class="line">  <span class="attr">periodSeconds:</span> <span class="number">10</span> </span><br><span class="line"><span class="attr">startupProbe:</span> </span><br><span class="line">  <span class="attr">httpGet:</span> </span><br><span class="line">    <span class="attr">path:</span> <span class="string">/test</span> </span><br><span class="line">    <span class="attr">prot:</span> <span class="number">80</span> </span><br><span class="line">  <span class="attr">failureThreshold:</span> <span class="number">10</span> </span><br><span class="line">  <span class="attr">initialDelay:</span> <span class="number">10</span> </span><br><span class="line">  <span class="attr">periodSeconds:</span> <span class="number">10</span></span><br><span class="line">  </span><br><span class="line"> </span><br><span class="line"><span class="comment"># 上面的配置是只有 startupProbe 探测成功后再交给 livenessProbe。</span></span><br><span class="line"><span class="comment"># startupProbe 配置的是10*10s，也就是说只要应用在 100s 内启动都是可以的，而且应用挂掉了 10s 就会发现问题。</span></span><br></pre></td></tr></table></figure>

<ul>
<li>K8s 的 LivenessProbe 和 ReadinessProbe 的启动顺序问题</li>
</ul>
<blockquote>
<p><code>LivenessProbe</code> 会导致 pod 重启，<code>ReadinessProbe</code> 只是不提供服务</p>
<p>我们最初的理解是 <code>LivenessProbe</code> 会在 <code>ReadinessProbe</code> 成功后开始检查，但事实并非如此。 </p>
<p>kubelet 使用<code>存活探测器</code>来知道什么时候要重启容器。 例如，存活探测器可以捕捉到死锁（应用程序在运行，但是无法继续执行后面的步骤）。 这样的情况下重启容器有助于让应用程序在有问题的情况下可用。 </p>
<p>kubelet 使用<code>就绪探测器</code>可以知道容器什么时候准备好了并可以开始接受请求流量， 当一个 Pod 内的所有容器都准备好了，才能把这个 Pod 看作就绪了。 这种信号的一个用途就是控制哪个 Pod 作为Service 的后端。 在 Pod 还没有准备好的时候，会从 Service 的负载均衡器中被剔除的。 </p>
<p>kubelet 使用<code>启动探测器</code>(startupProbe)可以知道应用程序容器什么时候启动了。 如果配置了这类探测器，就可以控制容器在启动成功后再进行存活性和就绪检查， 确保这些存活、就绪探测器不会影响应用程序的启动。 这可以用于对慢启动容器进行存活性检测，避免它们在启动运行之前就被杀掉。</p>
<p>真正的启动顺序：<br><a target="_blank" rel="noopener" href="https://github.com/kubernetes/kubernetes/issues/60647">https://github.com/kubernetes/kubernetes/issues/60647</a><br><a target="_blank" rel="noopener" href="https://github.com/kubernetes/kubernetes/issues/27114">https://github.com/kubernetes/kubernetes/issues/27114</a><br><a target="_blank" rel="noopener" href="https://kubernetes.io/docs/tasks/configure-pod-container/configure-liveness-readiness-startup-probes/#define-readiness-probes">https://kubernetes.io/docs/tasks/configure-pod-container/configure-liveness-readiness-startup-probes/#define-readiness-probes</a>  </p>
<p>官方文档：Caution: Liveness probes do not wait for readiness probes to succeed. If you want to wait before executing a liveness probe you should use initialDelaySeconds or a startupProbe. </p>
<p>也就是 <code>Liveness probes</code> 并不会等到  <code>Readiness probes</code> 成功之后才运行</p>
<p>根据上面的官方文档，<code>Liveness</code> 和 <code>readiness</code> 应该是某种并发的关系</p>
</blockquote>
<h1 id="k8s-控制器：Replicaset"><a href="#k8s-控制器：Replicaset" class="headerlink" title="k8s 控制器：Replicaset"></a>k8s 控制器：Replicaset</h1><blockquote>
<p>在定义 pod 资源时，可以直接创建一个 kind：Pod 类型的自主式 pod，但是这存在一个问题，假如 pod 被删除了，那这个 pod 就不能自我恢复，就会彻底被删除，线上这种情况非常危险</p>
<p>所以就要用到 pod 的控制器，所谓控制器就是能够管理 pod，监测 pod 运行状况，当 pod 发生故障，可以自动恢复 pod。也就是说能够代我们去管理 pod 中间层，并帮助我们确保每一个 pod 资源始终处于我们所定义或者我们所期望的目标状态，一旦 pod 资源出现故障，那么控制器会尝试重启 pod 或者里面的容器，如果一直重启有问题的话那么它可能会基于某种策略来进行重新布派或者重新编排；如果 pod 副本数量低于用户所定义的目标数量，它也会自动补全；如果多余，也会自动终止pod 资源。</p>
</blockquote>
<h2 id="Replicaset-概述"><a href="#Replicaset-概述" class="headerlink" title="Replicaset 概述"></a>Replicaset 概述</h2><blockquote>
<p><code>ReplicaSet</code> 是 kubernetes 中的一种副本控制器，简称 rs，主要作用是控制由其管理的 pod，使 pod 副本的数量始终维持在预设的个数。它的主要作用就是保证一定数量的 Pod 能够在集群中正常运行，它会持续监听这些 Pod 的运行状态，在 Pod 发生故障时重启 pod，pod 数量减少时重新运行新的 Pod 副本。</p>
<p>官方推荐不要直接使用 <code>ReplicaSet</code>，用 <code>Deployment</code> 取而代之，<code>Deployment</code> 是比 <code>ReplicaSet</code> 更高级的概念，它会管理 <code>ReplicaSet</code> 并提供很多其它有用的特性，最重要的是 <code>Deployment</code> 支持声明式更新，声明式更新的好处是不会丢失历史变更。所以 <code>Deployment</code> 控制器不直接管理 Pod 对象，而是由 <code>Deployment</code> 管理 <code>ReplicaSet</code>，再由 <code>ReplicaSet</code> 负责管理 Pod 对象。 </p>
</blockquote>
<h2 id="Replicaset-工作原理"><a href="#Replicaset-工作原理" class="headerlink" title="Replicaset 工作原理"></a>Replicaset 工作原理</h2><blockquote>
<p>Replicaset 核心作用在于代用户创建指定数量的 pod 副本，并确保 pod 副本一直处于满足用户期望的数量， 起到多退少补的作用，并且还具有自动扩容缩容等机制。 </p>
</blockquote>
<p>Replicaset 控制器主要由三个部分组成：</p>
<ul>
<li><p>用户期望的 pod 副本数：用来定义由这个控制器管控的 pod 副本有几个 </p>
</li>
<li><p>标签选择器：选定哪些 pod 是自己管理的，如果通过标签选择器选到的 pod 副本数量少于我们指定的数量，需要用到下面的组件 </p>
</li>
<li><p>pod 资源模板：如果集群中现存的 pod 数量不够我们定义的副本中期望的数量怎么办，需要新建 pod，这就需要 pod 模板，新建的 pod 是基于模板来创建的。</p>
</li>
</ul>
<h2 id="Replicaset-资源清单文件"><a href="#Replicaset-资源清单文件" class="headerlink" title="Replicaset 资源清单文件"></a>Replicaset 资源清单文件</h2><ul>
<li>查看 <code>Replicaset</code> 需要哪些字段</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[root@master1 ~]# kubectl explain rs</span><br><span class="line">KIND:     ReplicaSet</span><br><span class="line">VERSION:  apps/v1</span><br><span class="line"></span><br><span class="line">DESCRIPTION:</span><br><span class="line">     ReplicaSet ensures that a specified number of pod replicas are running at</span><br><span class="line">     any given time.</span><br><span class="line"></span><br><span class="line">FIELDS:</span><br><span class="line">   apiVersion	&lt;string&gt;	# 当前资源使用的api版本</span><br><span class="line">   kind	&lt;string&gt;			# 资源类型</span><br><span class="line">   metadata	&lt;Object&gt;		# 元数据</span><br><span class="line">   spec	&lt;Object&gt;			# 定义副本数、定义标签选择器、定义Pod模板</span><br><span class="line">   status	&lt;Object&gt;		# 状态信息，不能改</span><br></pre></td></tr></table></figure>

<ul>
<li>查看 <code>rs.spec</code> 字段</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[root@master1 ~]# kubectl explain rs.spec</span><br><span class="line">KIND:     ReplicaSet</span><br><span class="line">VERSION:  apps/v1</span><br><span class="line">RESOURCE: spec &lt;Object&gt;</span><br><span class="line"></span><br><span class="line">FIELDS:</span><br><span class="line">   minReadySeconds	&lt;integer&gt;</span><br><span class="line">   replicas	&lt;integer&gt;				# 定义pod副本数</span><br><span class="line">   selector	&lt;Object&gt; -required-		# 用于匹配pod的标签选择器</span><br><span class="line">   template	&lt;Object&gt;				# 定义Pod模板</span><br></pre></td></tr></table></figure>

<ul>
<li>查看 <code>rs.spec.template</code> 字段</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@master1 ~]# kubectl explain rs.spec.template</span><br><span class="line">KIND:     ReplicaSet</span><br><span class="line">VERSION:  apps/v1</span><br><span class="line">RESOURCE: template &lt;Object&gt;</span><br><span class="line"></span><br><span class="line">FIELDS:</span><br><span class="line">   metadata	&lt;Object&gt;</span><br><span class="line">   spec	&lt;Object&gt;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>通过上面可以看到，ReplicaSet 资源中有两个 spec 字段。第一个 spec 声明的是 ReplicaSet 定义多少个 Pod 副本（默认将仅部署 1 个 Pod）、匹配 Pod 标签的选择器、创建 pod 的模板。第二个 spec 是 <code>spec.template.spec</code>：主要用于 Pod 里的容器属性等配置。</p>
</blockquote>
<blockquote>
<p><code>.spec.template</code> 里的内容是声明 Pod 对象时要定义的各种属性，所以这部分也叫做<code> PodTemplate</code>（Pod 模板）。还有一个值得注意的地方是：在<code>.spec.selector</code> 中定义的标签选择器必须能够匹配到 <code>spec.template.metadata.labels</code> 里定义的 Pod 标签，否则 Kubernetes 将不允许创建 ReplicaSet。</p>
</blockquote>
<h2 id="Replicaset-使用案例"><a href="#Replicaset-使用案例" class="headerlink" title="Replicaset 使用案例"></a>Replicaset 使用案例</h2><ul>
<li>部署Guestbook 留言板</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span>			<span class="comment"># ReplicaSet 这个控制器属于的核心群组</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ReplicaSet</span>			<span class="comment"># 创建的资源类型</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">frontend</span>			<span class="comment"># 控制器的名字</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">guestbook</span></span><br><span class="line">    <span class="attr">tier:</span> <span class="string">frontend</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">3</span>				<span class="comment"># 管理的 pod 副本数量</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">tier:</span> <span class="string">frontend</span>		<span class="comment"># 管理带有 tier=frontend 标签的pod</span></span><br><span class="line">  <span class="attr">template:</span>					<span class="comment"># 定义 pod 的模板</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">tier:</span> <span class="string">frontend</span>		<span class="comment"># pod 标签，一定要有</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">php-redis</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">yecc/gcr.io-google_samples-gb-frontend:v3</span></span><br><span class="line">        <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">http</span></span><br><span class="line">          <span class="attr">containerPort:</span> <span class="number">80</span></span><br><span class="line"></span><br><span class="line">[<span class="string">root@master1</span> <span class="string">~</span>]<span class="comment"># kubectl get rs</span></span><br><span class="line"><span class="string">NAME</span>                    <span class="string">DESIRED</span>   <span class="string">CURRENT</span>   <span class="string">READY</span>   <span class="string">AGE</span></span><br><span class="line"><span class="string">frontend</span>                <span class="number">3</span>         <span class="number">3</span>         <span class="number">3</span>       <span class="string">31s</span></span><br><span class="line"></span><br><span class="line">[<span class="string">root@master1</span> <span class="string">~</span>]<span class="comment"># kubectl get pods</span></span><br><span class="line"><span class="string">NAME</span>                          <span class="string">READY</span>   <span class="string">STATUS</span>    <span class="string">RESTARTS</span>   <span class="string">AGE</span></span><br><span class="line"><span class="string">frontend-57g5j</span>                <span class="number">1</span><span class="string">/1</span>     <span class="string">Running</span>   <span class="number">0</span>          <span class="string">41s</span></span><br><span class="line"><span class="string">frontend-6zgqn</span>                <span class="number">1</span><span class="string">/1</span>     <span class="string">Running</span>   <span class="number">0</span>          <span class="string">41s</span></span><br><span class="line"><span class="string">frontend-tw2ld</span>                <span class="number">1</span><span class="string">/1</span>     <span class="string">Running</span>   <span class="number">0</span>          <span class="string">41s</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># pod 的名字是由控制器的名字-随机数组成的</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>ReplicaSet 最核心的功能是可以动态扩容和回缩，如果我们觉得两个副本太少了，想要增加，只需要修改配置文件 replicaset.yaml 里的 replicas 的值即可，原来 replicas: 3，现在变成 replicaset: 4，修改之后更新</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">[root@master1 ~]# kubectl get rs</span><br><span class="line">NAME                    DESIRED   CURRENT   READY   AGE</span><br><span class="line">frontend                4         4         4       8m17s</span><br><span class="line"></span><br><span class="line">[root@master1 ~]# kubectl get pods</span><br><span class="line">NAME                          READY   STATUS    RESTARTS   AGE</span><br><span class="line">frontend-57g5j                1/1     Running   0          8m3s</span><br><span class="line">frontend-6zgqn                1/1     Running   0          8m3s</span><br><span class="line">frontend-tgmxk                1/1     Running   0          2s</span><br><span class="line">frontend-tw2ld                1/1     Running   0          8m3s</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">也可以直接编辑控制器实现扩容</span> </span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">把请求提交给了 apiserver，实时修改</span></span><br><span class="line">[root@master1 ~]# kubectl edit rs frontend</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">把上面的 spec 下的 replicas 后面的值改成 5，保存退出</span></span><br><span class="line"></span><br><span class="line">[root@master1 ~]# kubectl get rs</span><br><span class="line">NAME                    DESIRED   CURRENT   READY   AGE</span><br><span class="line">frontend                5         5         5       30m</span><br><span class="line"></span><br><span class="line">[root@master1 ~]# kubectl get pods</span><br><span class="line">NAME                          READY   STATUS    RESTARTS   AGE</span><br><span class="line">frontend-57g5j                1/1     Running   0          30m</span><br><span class="line">frontend-6zgqn                1/1     Running   0          30m</span><br><span class="line">frontend-rf7gd                1/1     Running   0          25s</span><br><span class="line">frontend-tgmxk                1/1     Running   0          22m</span><br><span class="line">frontend-tw2ld                1/1     Running   0          30m</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">如果觉得 5 个 Pod 副本太多了，想要减少，只需要修改配置文件里的 replicas 的值即可</span></span><br></pre></td></tr></table></figure>

<ul>
<li>ReplicasSet 实现 Pod 的更新</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">[root@master1 ~]# kubectl edit rs frontend</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">修改镜像 image: yecc/gcr.io-google_samples-gb-frontend:v3 变成 image: ikubernetes/myapp:v2，修改之后保存退出</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@master1 ~]# kubectl get rs -o wide</span><br><span class="line">NAME                    DESIRED   CURRENT   READY   AGE   CONTAINERS   IMAGES                                  SELECTOR</span><br><span class="line">frontend                5         5         5       34m   php-redis    ikubernetes/myapp:v2</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">上面可以看到镜像变成了 ikubernetes/myapp:v2，说明滚动升级成功了</span></span><br><span class="line"></span><br><span class="line">[root@master1 ~]# kubectl get pods -o wide</span><br><span class="line">NAME                          READY   STATUS    RESTARTS   AGE     IP               NODE    NOMINATED NODE   READINESS GATES</span><br><span class="line">frontend-57g5j                1/1     Running   0          37m     10.244.104.24    node2   &lt;none&gt;           &lt;none&gt;</span><br><span class="line"></span><br><span class="line">[root@master1 ~]# curl 10.244.104.24</span><br><span class="line">      &lt;h2&gt;Guestbook&lt;/h2&gt;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">上面可以看到虽然镜像已经更新了，但是原来的 pod 使用的还是之前的镜像，新创建的 pod 才会使用最新的镜像</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">删除 10.244.104.24 ip对应的pod</span></span><br><span class="line">[root@master1 ~]# kubectl delete pods frontend-57g5j</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@master1 ~]# kubectl get pods -o wide</span><br><span class="line">NAME                          READY   STATUS    RESTARTS   AGE     IP               NODE    NOMINATED NODE   READINESS GATES</span><br><span class="line">frontend-5b49g                1/1     Running   0          12s     10.244.166.170   node1</span><br><span class="line"></span><br><span class="line">[root@master1 ~]# curl 10.244.166.170</span><br><span class="line">Hello MyApp | Version: v2 | &lt;a href=&quot;hostname.html&quot;&gt;Pod Name&lt;/a&gt;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">新生成的 pod 的镜像已经变成了 myapp 的，说明更新完成了</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>如果直接修改 replicaset.yaml 文件，把 image: yecc/gcr.io-google_samples-gb-frontend:v3 变成- image: ikubernetes/myapp:v2<br>kubectl apply -f replicaset.yaml<br>发现原来的 pod 还是用的 frontend:v3 这个镜像，没有实现自动更新 </p>
<p>生产环境如果升级，可以删除一个 pod，观察一段时间之后没问题再删除另一个 pod，但是这样需要人工干预多次；实际生产环境一般采用蓝绿发布，原来有一个 rs1，再创建一个 rs2（控制器），通过修改 service 标签，修改 service 可以匹配到 rs2 的控制器，这样才是<code>蓝绿发布</code>，这个也需要我们精心的部署规划，我们有一个控制器就是建立在 rs 之上完成的，叫做 Deployment</p>
</blockquote>
<h1 id="k8s-控制器：Deployment"><a href="#k8s-控制器：Deployment" class="headerlink" title="k8s 控制器：Deployment"></a>k8s 控制器：Deployment</h1><blockquote>
<p><code>Deployment</code> 是 kubernetes 中最常用的资源对象，为 <code>ReplicaSet</code> 和 Pod 的创建提供了一种声明式的定义方法，在 <code>Deployment</code> 对象中描述一个期望的状态，<code>Deployment</code> 控制器就会按照一定的控制速率把实际状态改成期望状态，通过定义一个 <code>Deployment</code> 控制器会创建一个新的 <code>ReplicaSet</code> 控制器，通过 <code>ReplicaSet</code> 创建 pod，删除 <code>Deployment</code> 控制器，也会删除 <code>Deployment</code> 控制器下对应的 <code>ReplicaSet</code> 控制器和 pod 资源。</p>
</blockquote>
<ul>
<li>Deployment 官方文档：<a target="_blank" rel="noopener" href="https://kubernetes.io/docs/concepts/workloads/controllers/deployment/">https://kubernetes.io/docs/concepts/workloads/controllers/deployment/</a></li>
</ul>
<blockquote>
<p>使用 <code>Deployment</code> 而不直接创建 ReplicaSet 是因为 Deployment 对象拥有许多 ReplicaSet 没有的特性，例如<code>滚动升级和回滚</code>。</p>
<p>扩展：声明式定义是指直接修改资源清单 yaml 文件，然后通过 kubectl apply -f 资源清单 yaml 文件，就可以更改资源</p>
</blockquote>
<blockquote>
<p>Deployment 控制器是建立在 rs 之上的一个控制器，可以管理多个 rs，每次更新镜像版本，都会生成一个新的 rs，把旧的 rs 替换掉，多个 rs 同时存在，但是只有一个 rs 运行。 </p>
<blockquote>
<p>rs v1 控制三个 pod，删除一个 pod，在 rs v2 上重新建立一个，依次类推，直到全部都是由 rs v2控制，如果 rs v2 有问题，还可以回滚，Deployment 是建构在 rs 之上的，多个 rs 组成一个Deployment，但是只有一个 rs 处于活跃状态。</p>
</blockquote>
</blockquote>
<p><img src="../../../../images/image/k8s-han/20.png" alt="20"></p>
<h2 id="Deployment-工作原理"><a href="#Deployment-工作原理" class="headerlink" title="Deployment 工作原理"></a>Deployment 工作原理</h2><blockquote>
<p>Deployment 可以使用声明式定义，直接在<code>命令行通过纯命令的方式完成对应资源版本的内容的修改</code>，也就是通过打补丁的方式进行修改；Deployment 能提供滚动式自定义自控制的更新；对 Deployment来讲，在实现更新时还可以实现控制更新节奏和更新逻辑。 </p>
</blockquote>
<p><em>互动：什么叫做更新节奏和更新逻辑呢？</em></p>
<blockquote>
<p>比如说 Deployment 控制 5 个 pod 副本，pod 的期望值是 5 个，但是升级的时候需要额外多几个pod，那我们控制器可以控制在 5 个 pod 副本之外还能再增加几个 pod 副本；比方说能多一个，但是不能少，那么升级的时候就是先增加一个，再删除一个，增加一个删除一个，始终保持 pod 副本数是 5 个；还有一种情况，最多允许多一个，最少允许少一个，也就是最多 6 个，最少 4 个，第一次加一个，删除两个，第二次加两个，删除两个，依次类推，可以自己控制更新方式，这种滚动更新需要加 <code>readinessProbe</code> 和 <code>livenessProbe</code> 探测，确保 pod 中容器里的应用都正常启动了才删除之前的 pod。</p>
<p>启动第一步，刚更新第一批就暂停了也可以；假如目标是 5 个，允许一个也不能少，允许最多可以10 个，那一次加 5 个即可；这就是我们可以自己控制节奏来控制更新的方法。</p>
</blockquote>
<p><em>通过 Deployment 对象，可以轻松的做到以下事情：</em></p>
<ul>
<li>创建 ReplicaSet 和 Pod</li>
<li>滚动升级（不停止旧服务的状态下升级）和回滚应用（将应用回滚到之前的版本）</li>
<li>平滑地扩容和缩容</li>
<li>暂停和继续 Deployment</li>
</ul>
<h2 id="Deployment-资源清单文件"><a href="#Deployment-资源清单文件" class="headerlink" title="Deployment 资源清单文件"></a>Deployment 资源清单文件</h2><ul>
<li>查看 Deployment 由哪些字段组成</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root@master1 ~]# kubectl explain deployment</span><br><span class="line">KIND:     Deployment</span><br><span class="line">VERSION:  apps/v1</span><br><span class="line">DESCRIPTION:</span><br><span class="line"></span><br><span class="line">FIELDS:</span><br><span class="line">   apiVersion	&lt;string&gt;</span><br><span class="line">   kind	&lt;string&gt;</span><br><span class="line">   metadata	&lt;Object&gt;</span><br><span class="line">   spec	&lt;Object&gt;</span><br><span class="line">   status	&lt;Object&gt;</span><br></pre></td></tr></table></figure>

<ul>
<li>查看 <code>deployment.spec</code> 字段</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">[root@master1 ~]# kubectl explain deployment.spec</span><br><span class="line">KIND:     Deployment</span><br><span class="line">VERSION:  apps/v1</span><br><span class="line">RESOURCE: spec &lt;Object&gt;</span><br><span class="line">DESCRIPTION:</span><br><span class="line"></span><br><span class="line">FIELDS:</span><br><span class="line">   minReadySeconds	&lt;integer&gt;</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Kubernetes 在等待设置的时间后才进行升级</span> </span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">如果没有设置该值，Kubernetes 会假设该容器启动起来后就提供服务了</span></span><br><span class="line"></span><br><span class="line">   paused	&lt;boolean&gt;</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">暂停，当我们更新的时候创建 pod 先暂停，不是立即更新</span></span><br><span class="line"></span><br><span class="line">   progressDeadlineSeconds	&lt;integer&gt;</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">k8s 在升级过程中有可能由于各种原因升级卡住（这个时候还没有明确的升级失败）</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">比如在拉取被墙的镜像，权限不够等错误。那么这个时候就需要有个 deadline ，在 deadline 之内如果还卡着，那么就上报这个情况</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">这个时候这个 Deployment 状态就被标记为 False，并且注明原因。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">但是它并不会阻止 Deployment 继续进行卡住后面的操作。完全由用户进行控制。</span></span><br><span class="line"></span><br><span class="line">   replicas	&lt;integer&gt;				# 副本数</span><br><span class="line">   revisionHistoryLimit	&lt;integer&gt;	# 保留的历史版本，默认是10</span><br><span class="line">   selector	&lt;Object&gt; -required-		# 标签选择器，选择它关联的pod</span><br><span class="line">   strategy	&lt;Object&gt;				# 更新策略</span><br><span class="line">   template	&lt;Object&gt; -required-		# 定义 pod 模板</span><br></pre></td></tr></table></figure>

<ul>
<li>查看<code>deployment.spec.strategy</code>字段</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[root@master1 ~]# kubectl explain deployment.spec.strategy</span><br><span class="line">KIND:     Deployment</span><br><span class="line">VERSION:  apps/v1</span><br><span class="line">RESOURCE: strategy &lt;Object&gt;</span><br><span class="line"></span><br><span class="line">FIELDS:</span><br><span class="line">   rollingUpdate	&lt;Object&gt;</span><br><span class="line">   type	&lt;string&gt;</span><br><span class="line">     Type of deployment. Can be &quot;Recreate&quot; or &quot;RollingUpdate&quot;. Default is RollingUpdate.</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">支持两种更新，Recreate 和 RollingUpdate</span> </span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Recreate 是重建式更新，删除一个更新一个</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">RollingUpdate 滚动更新，定义滚动更新方式，也就是 pod 能多几个，少几个</span></span><br></pre></td></tr></table></figure>

<ul>
<li>查看<code>deployment.spec.strategy.rollingUpdate</code>字段</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[root@master1 ~]# kubectl explain deployment.spec.strategy.rollingUpdate</span><br><span class="line">KIND:     Deployment</span><br><span class="line">VERSION:  apps/v1</span><br><span class="line">RESOURCE: rollingUpdate &lt;Object&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">FIELDS:</span><br><span class="line">   maxSurge	&lt;string&gt;</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">更新的过程当中最多允许超出的指定的目标副本数有几个；</span> </span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">它有两种取值方式，第一种直接给定数量，</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">第二种根据百分比，百分比表示原本是 5 个，最多可以超出 20%，那就允许多一个，最多可以超过 40%，那就允许多两个</span></span><br><span class="line"></span><br><span class="line">   maxUnavailable	&lt;string&gt;</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">最多允许几个不可用</span> </span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">假设有 5 个副本，最多一个不可用，就表示最少有 4 个可用</span></span><br></pre></td></tr></table></figure>

<ul>
<li>查看<code>deploy.spec.template</code>字段</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[root@master1 ~]# kubectl explain deployment.spec.template</span><br><span class="line">KIND:     Deployment</span><br><span class="line">VERSION:  apps/v1</span><br><span class="line">RESOURCE: template &lt;Object&gt;</span><br><span class="line">DESCRIPTION:</span><br><span class="line"></span><br><span class="line">FIELDS:</span><br><span class="line">   metadata	&lt;Object&gt;	# 定义模板的名字</span><br><span class="line">   spec	&lt;Object&gt;</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">deployment.spec.template 为 Pod 定义的模板，和 Pod 定义不太一样</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">template 中不包含apiVersion 和 Kind 属性，要求必须有 metadata。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">deployment.spec.template.spec 为容器的属性信息，其他定义内容和 Pod 一致。</span></span><br></pre></td></tr></table></figure>

<ul>
<li>查看<code>deploy.spec.template.spec</code>字段</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><span class="line">[root@master1 ~]# kubectl explain deployment.spec.template.spec</span><br><span class="line">KIND:     Deployment</span><br><span class="line">VERSION:  apps/v1</span><br><span class="line">RESOURCE: spec &lt;Object&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">FIELDS:</span><br><span class="line">   activeDeadlineSeconds	&lt;integer&gt;</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">表示 pod 可以运行的最长时间，达到设置的值后，pod会自动停止</span></span><br><span class="line"></span><br><span class="line">   affinity	&lt;Object&gt;</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">定义亲和性，跟直接创建pod时候定义的亲和性类似</span></span><br><span class="line"></span><br><span class="line">   automountServiceAccountToken	&lt;boolean&gt;</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">身份认证相关的</span></span><br><span class="line"></span><br><span class="line">   containers	&lt;[]Object&gt; -required-</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">定义容器属性</span></span><br><span class="line"></span><br><span class="line">   dnsConfig	&lt;Object&gt;</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">设置pod的DNS （写入 pod 的 /etc/resolv.conf 需要与 dnsPolicy字段连用）</span></span><br><span class="line">   dnsConfig:</span><br><span class="line">     nameservers:</span><br><span class="line">     - 192.xxx.xxx.6</span><br><span class="line">     searches:</span><br><span class="line">     - xianchao.svc.cluster.local</span><br><span class="line">     - my.dns.search.xianchao</span><br><span class="line"></span><br><span class="line">   dnsPolicy	&lt;string&gt;</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">决定pod内预设的DNS配置策略</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">None 无任何策略：使用自定义的策略</span> </span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Default 默认：使用宿主机的 dns 配置，/etc/resolv.conf</span> </span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">ClusterFirst 集群 DNS 优先，与 Default 相反，会预先使用 kube-dns (或 CoreDNS ) 的信息当预设置参数写入到该 Pod 内的 DNS 配置。</span> </span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">ClusterFirstWithHostNet 集群 DNS 优先，并伴随着使用宿主机网络：同时使用 hostNetwork 与 kube-dns 作为 Pod 预设 DNS 配置。</span></span><br><span class="line"></span><br><span class="line">   enableServiceLinks	&lt;boolean&gt;</span><br><span class="line">   ephemeralContainers	&lt;[]Object&gt;</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">定义临时容器</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">临时容器与其他容器的不同之处在于，它们缺少对资源或执行的保证，并且永远不会自动重启，因此不适用于构建应用程序。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">临时容器使用与常规容器相同的 ContainerSpec 段进行描述，但许多字段是不相容且不允许的。</span> </span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">临时容器没有端口配置，因此像 ports，livenessProbe，readinessProbe 这样的字段是不允许的。</span> </span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Pod 资源分配是不可变的，因此 resources 配置是不允许的。</span> </span><br><span class="line"><span class="meta prompt_"> </span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">临时容器用途：</span> </span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">当由于容器崩溃或容器镜像不包含调试应用程序而导致 kubectl <span class="built_in">exec</span> 无用时，临时容器对于交互式故障排查很有用。</span></span><br><span class="line"></span><br><span class="line">   hostAliases	&lt;[]Object&gt;</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">在pod中增加域名解析的（写入 pod 中的 /etc/hosts）</span></span><br><span class="line">   hostAliases</span><br><span class="line">   - ip: &quot;10.1.2.2&quot;</span><br><span class="line">     hostnames:</span><br><span class="line">     - &quot;mc.local&quot;</span><br><span class="line">     - &quot;rabbitmq.local&quot;</span><br><span class="line">   - ip: &quot;10.1.2.3&quot;</span><br><span class="line">     hostnames:</span><br><span class="line">     - &quot;redis.local&quot;</span><br><span class="line">     - &quot;mq.local&quot;</span><br><span class="line"></span><br><span class="line">   hostIPC	&lt;boolean&gt;			# 使用主机IPC</span><br><span class="line">   hostNetwork	&lt;boolean&gt;		# 是否使用宿主机的网络</span><br><span class="line">   hostPID	&lt;boolean&gt;			# 可以设置容器里是否可以看到宿主机上的进程</span><br><span class="line">   hostname	&lt;string&gt;</span><br><span class="line">   imagePullSecrets	&lt;[]Object&gt;</span><br><span class="line">   initContainers	&lt;[]Object&gt;	# 定义初始化容器</span><br><span class="line">   nodeName	&lt;string&gt;			# 定义pod调度到具体哪个节点上</span><br><span class="line">   nodeSelector	&lt;map[string]string&gt;	# 定义节点选择器</span><br><span class="line"></span><br><span class="line">   overhead	&lt;map[string]string&gt;</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">overhead 是 1.16 引入的字段</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">在没有引入 Overhead 之前，只要一个节点的资源可用量大于等于 Pod 的 requests 时，这个 Pod 就可以被调度到这个节点上。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">引入 Overhead 之后，只有节点的资源可用量大于等于 Overhead 加上 requests 的和时才能被调度上来。</span></span><br><span class="line"></span><br><span class="line">   preemptionPolicy	&lt;string&gt;</span><br><span class="line">   priority	&lt;integer&gt;</span><br><span class="line">   priorityClassName	&lt;string&gt;</span><br><span class="line">   readinessGates	&lt;[]Object&gt;</span><br><span class="line">   restartPolicy	&lt;string&gt;	# pod重启策略</span><br><span class="line">   runtimeClassName	&lt;string&gt;</span><br><span class="line">   schedulerName	&lt;string&gt;</span><br><span class="line">   securityContext	&lt;Object&gt;	# 是否开启特权模式</span><br><span class="line">   serviceAccount	&lt;string&gt;</span><br><span class="line">   serviceAccountName	&lt;string&gt;</span><br><span class="line">   setHostnameAsFQDN	&lt;boolean&gt;</span><br><span class="line">   shareProcessNamespace	&lt;boolean&gt;</span><br><span class="line">   subdomain	&lt;string&gt;</span><br><span class="line"></span><br><span class="line">   terminationGracePeriodSeconds	&lt;integer&gt;</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">在真正删除容器之前，K8S 会先发终止信号（<span class="built_in">kill</span> -15 &#123;pid&#125;）给容器，默认 30s</span></span><br><span class="line"></span><br><span class="line">   tolerations	&lt;[]Object&gt;		# 定义容忍度</span><br><span class="line">   topologySpreadConstraints	&lt;[]Object&gt;</span><br><span class="line">   volumes	&lt;[]Object&gt;			# 挂载存储卷</span><br></pre></td></tr></table></figure>

<h2 id="Deployment案例"><a href="#Deployment案例" class="headerlink" title="Deployment案例"></a>Deployment案例</h2><ul>
<li>创建一个web站点</li>
<li>deployment 是一个三级结构，deployment 管理 replicaset，replicaset 管理 pod</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">myapp-v1</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">2</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">myapp</span></span><br><span class="line">      <span class="attr">version:</span> <span class="string">v1</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">myapp</span></span><br><span class="line">        <span class="attr">version:</span> <span class="string">v1</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">myapp</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">janakiramm/myapp:v1</span></span><br><span class="line">        <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">80</span></span><br><span class="line">        </span><br><span class="line">[<span class="string">root@master1</span> <span class="string">~</span>]<span class="comment"># kubectl get deploy</span></span><br><span class="line"><span class="string">NAME</span>       <span class="string">READY</span>   <span class="string">UP-TO-DATE</span>   <span class="string">AVAILABLE</span>   <span class="string">AGE</span></span><br><span class="line"><span class="string">myapp-v1</span>   <span class="number">2</span><span class="string">/2</span>     <span class="number">2</span>            <span class="number">2</span>           <span class="string">72s</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建的控制器名字是 myapp-v1 </span></span><br><span class="line"><span class="comment"># 1.NAME ：列出名称空间中 deployment 的名称。 </span></span><br><span class="line"><span class="comment"># 2.READY：显示 deployment 有多少副本数。它遵循 ready/desired 的模式。 </span></span><br><span class="line"><span class="comment"># 3.UP-TO-DATE： 显示已更新到所需状态的副本数。 </span></span><br><span class="line"><span class="comment"># 4.AVAILABLE： 显示你的可以使用多少个应用程序副本。 </span></span><br><span class="line"><span class="comment"># 5.AGE ：显示应用程序已运行的时间。</span></span><br><span class="line"></span><br><span class="line">[<span class="string">root@master1</span> <span class="string">~</span>]<span class="comment"># kubectl get rs</span></span><br><span class="line"><span class="string">NAME</span>                  <span class="string">DESIRED</span>   <span class="string">CURRENT</span>   <span class="string">READY</span>   <span class="string">AGE</span></span><br><span class="line"><span class="string">myapp-v1-67fd9fc9c8</span>   <span class="number">2</span>         <span class="number">2</span>         <span class="number">2</span>       <span class="string">3m9s</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建 deploy 的时候也会创建一个 rs（replicaset），67fd9fc9c8 这个随机数字是我们引用pod 的模板 template 的名字的 hash 值 </span></span><br><span class="line"><span class="comment"># 1.NAME： 列出名称空间中 ReplicaSet 资源 </span></span><br><span class="line"><span class="comment"># 2.DESIRED：显示应用程序的所需副本数，这些副本数是在创建时定义的。这是所需的状态。 </span></span><br><span class="line"><span class="comment"># 3.CURRENT： 显示当前正在运行多少个副本。 </span></span><br><span class="line"><span class="comment"># 4.READY： 显示你的用户可以使用多少个应用程序副本。 </span></span><br><span class="line"><span class="comment"># 5.AGE ：显示应用程序已运行的时间。 </span></span><br><span class="line"> </span><br><span class="line"><span class="comment"># 请注意，ReplicaSet 的名称始终设置为[DEPLOYMENT-NAME]-[RANDOM-STRING]。RANDOM-STRING 是随机生成的</span></span><br><span class="line"></span><br><span class="line">[<span class="string">root@master1</span> <span class="string">~</span>]<span class="comment"># kubectl get pods -o wide</span></span><br><span class="line"><span class="string">NAME</span>                        <span class="string">READY</span>   <span class="string">STATUS</span>    <span class="string">RESTARTS</span>   <span class="string">AGE</span>     <span class="string">IP</span>               <span class="string">NODE</span>    <span class="string">NOMINATED</span> <span class="string">NODE</span>   <span class="string">READINESS</span> <span class="string">GATES</span></span><br><span class="line"><span class="string">myapp-v1-67fd9fc9c8-9ffjn</span>   <span class="number">1</span><span class="string">/1</span>     <span class="string">Running</span>   <span class="number">0</span>          <span class="string">4m41s</span>   <span class="number">10.244</span><span class="number">.104</span><span class="number">.2</span>     <span class="string">node2</span>   <span class="string">&lt;none&gt;</span>           <span class="string">&lt;none&gt;</span></span><br><span class="line"><span class="string">myapp-v1-67fd9fc9c8-qccls</span>   <span class="number">1</span><span class="string">/1</span>     <span class="string">Running</span>   <span class="number">0</span>          <span class="string">4m41s</span>   <span class="number">10.244</span><span class="number">.166</span><span class="number">.130</span>   <span class="string">node1</span>   <span class="string">&lt;none&gt;</span>           <span class="string">&lt;none&gt;</span></span><br><span class="line"></span><br><span class="line">[<span class="string">root@master1</span> <span class="string">~</span>]<span class="comment"># curl 10.244.104.2</span></span><br><span class="line">      <span class="attr">background-color:</span> <span class="string">blue;</span></span><br><span class="line"></span><br><span class="line">[<span class="string">root@master1</span> <span class="string">~</span>]<span class="comment"># curl 10.244.166.130</span></span><br><span class="line">      <span class="attr">background-color:</span> <span class="string">blue;</span></span><br></pre></td></tr></table></figure>

<h2 id="扩容、缩容、滚动更新、回滚"><a href="#扩容、缩容、滚动更新、回滚" class="headerlink" title="扩容、缩容、滚动更新、回滚"></a>扩容、缩容、滚动更新、回滚</h2><blockquote>
<p>通过deployment管理应用，实现扩容，把副本数变成3</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[root@master1 ~]# vim deploy-demo.yaml </span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">直接修改 replicas 数量，如下，变成 3</span> </span><br><span class="line">spec: </span><br><span class="line"> replicas: 3</span><br><span class="line"></span><br><span class="line">[root@master1 ~]# kubectl apply -f deploy-demo.yaml</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">注意：apply 不同于 create，apply 可以执行多次；create 执行一次，再执行就会报错复。</span></span><br><span class="line"></span><br><span class="line">[root@master1 ~]# kubectl get pods</span><br><span class="line">NAME                        READY   STATUS    RESTARTS   AGE</span><br><span class="line">myapp-v1-67fd9fc9c8-9ffjn   1/1     Running   0          8m4s</span><br><span class="line">myapp-v1-67fd9fc9c8-qccls   1/1     Running   0          8m4s</span><br><span class="line">myapp-v1-67fd9fc9c8-w7khk   1/1     Running   0          2s</span><br></pre></td></tr></table></figure>

<blockquote>
<p>通过deployment管理应用，实现缩容，把副本数变成2</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">修改deploy清单文件，把副本数改为2</span></span><br><span class="line">spec: </span><br><span class="line"> replicas: 2</span><br><span class="line"></span><br><span class="line">[root@master1 ~]# kubectl apply -f deploy-demo.yaml</span><br><span class="line"></span><br><span class="line">[root@master1 ~]# kubectl get pods</span><br><span class="line">NAME                        READY   STATUS    RESTARTS   AGE</span><br><span class="line">myapp-v1-67fd9fc9c8-9ffjn   1/1     Running   0          11m</span><br><span class="line">myapp-v1-67fd9fc9c8-qccls   1/1     Running   0          11m</span><br></pre></td></tr></table></figure>

<blockquote>
<p>通过deployment管理应用，实现滚动更新</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">在一个终端执行</span></span><br><span class="line">[root@master1 ~]# kubectl get pods -l app=myapp -w</span><br><span class="line">NAME                        READY   STATUS    RESTARTS   AGE</span><br><span class="line">myapp-v1-67fd9fc9c8-9ffjn   1/1     Running   0          13m</span><br><span class="line">myapp-v1-67fd9fc9c8-qccls   1/1     Running   0          13m</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">打开一个新的终端窗口更改镜像版本</span></span><br><span class="line">[root@master1 ~]# vim deploy-demo.yaml </span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">把janakiramm/myapp:v1变成janakiramm/myapp:v2</span> </span><br><span class="line"> </span><br><span class="line">[root@master1 ~]# kubectl apply -f deploy-demo.yaml</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">再回到刚才执行监测 kubectl get pods -l app=myapp -w 的那个窗口</span></span><br><span class="line">[root@master1 ~]# kubectl get pods -l app=myapp -w</span><br><span class="line">NAME                        READY   STATUS    RESTARTS   AGE</span><br><span class="line">myapp-v1-67fd9fc9c8-9ffjn   1/1     Running   0          13m</span><br><span class="line">myapp-v1-67fd9fc9c8-qccls   1/1     Running   0          13m</span><br><span class="line">myapp-v1-75fb478d6c-w99v2   0/1     Pending   0          0s</span><br><span class="line">myapp-v1-75fb478d6c-w99v2   0/1     Pending   0          0s</span><br><span class="line">myapp-v1-75fb478d6c-w99v2   0/1     ContainerCreating   0          0s</span><br><span class="line">myapp-v1-75fb478d6c-w99v2   0/1     ContainerCreating   0          0s</span><br><span class="line">myapp-v1-75fb478d6c-w99v2   1/1     Running             0          1s</span><br><span class="line">myapp-v1-67fd9fc9c8-qccls   1/1     Terminating         0          15m</span><br><span class="line">myapp-v1-75fb478d6c-jdrjj   0/1     Pending             0          0s</span><br><span class="line">myapp-v1-75fb478d6c-jdrjj   0/1     Pending             0          0s</span><br><span class="line">myapp-v1-75fb478d6c-jdrjj   0/1     ContainerCreating   0          0s</span><br><span class="line">myapp-v1-67fd9fc9c8-qccls   1/1     Terminating         0          15m</span><br><span class="line">myapp-v1-75fb478d6c-jdrjj   0/1     ContainerCreating   0          1s</span><br><span class="line">myapp-v1-67fd9fc9c8-qccls   0/1     Terminating         0          15m</span><br><span class="line">myapp-v1-75fb478d6c-jdrjj   1/1     Running             0          1s</span><br><span class="line">myapp-v1-67fd9fc9c8-9ffjn   1/1     Terminating         0          15m</span><br><span class="line">myapp-v1-67fd9fc9c8-9ffjn   1/1     Terminating         0          15m</span><br><span class="line">myapp-v1-67fd9fc9c8-9ffjn   0/1     Terminating         0          15m</span><br><span class="line">myapp-v1-67fd9fc9c8-9ffjn   0/1     Terminating         0          15m</span><br><span class="line">myapp-v1-67fd9fc9c8-9ffjn   0/1     Terminating         0          15m</span><br><span class="line">myapp-v1-67fd9fc9c8-qccls   0/1     Terminating         0          15m</span><br><span class="line">myapp-v1-67fd9fc9c8-qccls   0/1     Terminating         0          15m</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">pending 表示正在进行调度</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">ContainerCreating 表示正在创建一个 pod</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">running 表示运行</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">一个 pod，running 起来一个 pod 之后再 Terminating（停掉）一个 pod，以此类推，直到所有 pod 完成滚动升级</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">在另外一个窗口执行</span></span><br><span class="line">[root@master1 ~]# kubectl get rs</span><br><span class="line">NAME                  DESIRED   CURRENT   READY   AGE</span><br><span class="line">myapp-v1-67fd9fc9c8   0         0         0       16m</span><br><span class="line">myapp-v1-75fb478d6c   2         2         2       76s</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">上面可以看到 rs 有两个，上面那个是升级之前的，已经被停掉，但是可以随时回滚</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">查看 myapp-v1 这个控制器的历史版本</span></span><br><span class="line">[root@master1 ~]# kubectl rollout history deployment myapp-v1 </span><br><span class="line">deployment.apps/myapp-v1 </span><br><span class="line">REVISION  CHANGE-CAUSE</span><br><span class="line">1         &lt;none&gt;</span><br><span class="line">2         &lt;none&gt;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>回滚</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@master1 ~]# kubectl rollout undo deployment myapp-v1 --to-revision=1</span><br><span class="line"></span><br><span class="line">[root@master1 ~]# kubectl rollout history deployment myapp-v1 </span><br><span class="line">deployment.apps/myapp-v1 </span><br><span class="line">REVISION  CHANGE-CAUSE</span><br><span class="line">2         &lt;none&gt;</span><br><span class="line">3         &lt;none&gt;</span><br></pre></td></tr></table></figure>

<h2 id="自定义滚动更新策略"><a href="#自定义滚动更新策略" class="headerlink" title="自定义滚动更新策略"></a>自定义滚动更新策略</h2><blockquote>
<p><code>maxSurge</code> 和 <code>maxUnavailable</code> 用来控制滚动更新的更新策略</p>
</blockquote>
<h3 id="取值范围"><a href="#取值范围" class="headerlink" title="取值范围"></a>取值范围</h3><p><em>数值</em></p>
<ul>
<li><code>maxUnavailable</code>: [0, 副本数]</li>
<li><code>maxSurge</code>: [0, 副本数]</li>
<li>注意：两者不能同时为 0。</li>
</ul>
<p><em>比例</em></p>
<ul>
<li><p><code>maxUnavailable</code>: [0%, 100%] 向下取整</p>
<p>比如 10 个副本，5%的话==0.5 个，但计算按照 0 个</p>
</li>
<li><p><code>maxSurge</code>: [0%, 100%] 向上取整</p>
<p>比如 10 个副本，5%的话==0.5 个，但计算按照 1 个</p>
</li>
<li><p>注意：两者不能同时为 0。</p>
</li>
</ul>
<p><em>建议配置</em></p>
<ul>
<li><p><code>maxUnavailable</code> == 0 </p>
</li>
<li><p><code>maxSurge</code> == 1</p>
</li>
<li><p>这是生产环境提供给用户的默认配置。即“一上一下，先上后下”最平滑原则：1 个新版本 pod ready（结合 readiness）后，才销毁旧版本 pod。此配置适用场景是平滑更新、保证服务平稳，但也有缺点，就是“太慢”了。</p>
</li>
</ul>
<p><em>总结</em></p>
<ul>
<li><p>maxUnavailable：和期望的副本数比，不可用副本数最大比例（或最大值），<code>这个值越小，越能保证服务稳定，更新越平滑</code>；</p>
</li>
<li><p>maxSurge：和期望的副本数比，超过期望副本数最大比例（或最大值），<code>这个值调的越大，副本更新速度越快</code>。</p>
</li>
</ul>
<h3 id="自定义策略"><a href="#自定义策略" class="headerlink" title="自定义策略"></a>自定义策略</h3><ul>
<li>修改更新策略：<code>maxUnavailable=1，maxSurge=1</code></li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[root@master1 ~]# kubectl patch deployments myapp-v1 -p &#x27;&#123;&quot;spec&quot;:&#123;&quot;strategy&quot;:&#123;&quot;rollingUpdate&quot;:&#123;&quot;maxSurge&quot;:1,&quot;maxUnavailable&quot;:1&#125;&#125;&#125;&#125;&#x27;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">也可以写 yaml 文件，在 deploy.spec 下</span></span><br><span class="line">strategy:</span><br><span class="line">  rollingUpdate:</span><br><span class="line">    maxSurge: 1</span><br><span class="line">    maxUnavailable: 1</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">查看 myapp-v1 这个控制器的详细信息</span></span><br><span class="line">[root@master1 ~]# kubectl describe deployments myapp-v1 </span><br><span class="line"></span><br><span class="line">RollingUpdateStrategy:  1 max unavailable, 1 max surge</span><br></pre></td></tr></table></figure>

<ul>
<li>上面可以看到 <code>RollingUpdateStrategy: 1 max unavailable, 1 max surge</code> 这个 <code>rollingUpdate</code> 更新策略变成了刚才设定的，因为我们设定的 pod 副本数是 3，1 和 1 表示最少不能少于 2 个 pod，最多不能超过 4 个 pod 这个就是通过控制 <code>RollingUpdateStrategy</code> 这个字段来设置滚动更新策略的</li>
</ul>
<h1 id="k8s-四层负载均衡-service"><a href="#k8s-四层负载均衡-service" class="headerlink" title="k8s 四层负载均衡-service"></a>k8s 四层负载均衡-service</h1><h2 id="概念、原理解读"><a href="#概念、原理解读" class="headerlink" title="概念、原理解读"></a>概念、原理解读</h2><ul>
<li>为什么要有 Service</li>
</ul>
<blockquote>
<p>在 kubernetes 中，Pod 是有生命周期的，如果 Pod 重启它的 IP 很有可能会发生变化。</p>
<p>如果我们的服务都是将 Pod 的 IP 地址写死，Pod 挂掉或者重启，和刚才重启的 pod 相关联的其他服务将会找不到它所关联的 Pod，为了解决这个问题，在 kubernetes 中定义了 service 资源对象，<code>Service 定义了一个服务访问的入口，客户端通过这个入口即可访问服务背后的应用集群实例</code>，service 是一组 Pod 的逻辑集合，这一组 Pod 能够被 Service 访问到，通常是通过 <code>Label Selector</code> 实现的。</p>
</blockquote>
<p><img src="../../../../images/image/k8s-han/21.png" alt="21"></p>
<blockquote>
<p>pod ip 经常变化，service 是 pod 的代理，我们客户端访问，只需要访问 service，就会把请求代理到 Pod</p>
<p>pod ip 在 k8s 集群之外无法访问，所以需要创建 service，这个 service 可以在 k8s 集群外访问的。</p>
</blockquote>
<ul>
<li>Service 概述</li>
</ul>
<blockquote>
<p>service 是一个固定接入层，客户端可以通过访问 service 的 ip 和端口访问到 service 关联的后端pod，这个 service 工作依赖于在 kubernetes 集群之上部署的一个附件，就是 kubernetes 的 dns 服务（不同 kubernetes 版本的 dns 默认使用的也是不一样的，1.11 之前的版本使用的是 kubeDNS，较新的版本使用的是 coredns），<code>service 的名称解析是依赖于 dns 附件的，因此在部署完 k8s 之后需要再部署 dns附件</code>，kubernetes 要想给客户端提供网络功能，需要依赖第三方的网络插件（flannel，calico 等）。</p>
<p>每个 K8s 节点上都有一个组件叫做 kube-proxy，<code>kube-proxy 这个组件将始终监视着 apiserver 中有关 service 资源的变动信息</code>，需要跟 master 之上的 apiserver 交互，<code>随时连接到 apiserver 上获取任何一个与 service 资源相关的资源变动状态</code>，这种是通过 kubernetes 中固有的一种请求方法 watch（监视）来实现的，一旦有 service 资源的内容发生变动（如创建，删除），kube-proxy 都会将它转化成当前节点之上的能够实现 service 资源调度，把我们请求调度到后端特定的 pod 资源之上的规则，这个规则可能是 iptables，也可能是 ipvs，取决于 service 的实现方式。</p>
</blockquote>
<ul>
<li>Service 工作原理</li>
</ul>
<blockquote>
<p>k8s 在创建 Service 时，会根据<code>标签选择器</code> selector(lable selector)来查找 Pod，据此创建与<code> Service</code> 同名的 endpoint 对象，当 Pod 地址发生变化时，endpoint 也会随之发生变化，service 接收前端 client 请求的时候，就会通过 endpoint，找到转发到哪个 Pod 进行访问的地址。(至于转发到哪个节点的 Pod，由负载均衡 <code>kube-proxy</code> 决定) </p>
</blockquote>
<ul>
<li>k8s 集群中有三类 IP 地址</li>
</ul>
<blockquote>
<p>Node Network（节点网络）：物理节点或者虚拟节点的网络，如 ens32接口上的网络地址</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@master1 ~]# ip addr</span><br><span class="line">2: ens32: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc pfifo_fast state UP group default qlen 1000</span><br><span class="line">    link/ether 00:0c:29:73:1d:1f brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    inet 192.168.1.180/24 brd 192.168.1.255 scope global noprefixroute ens32</span><br></pre></td></tr></table></figure>

<blockquote>
<p>Pod Network（pod 网络）：创建的 Pod 具有的IP地址</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@master1 ~]# kubectl get pods -o wide</span><br><span class="line">NAME                        READY   STATUS    RESTARTS   AGE   IP               NODE    NOMINATED NODE   READINESS GATES</span><br><span class="line">myapp-v1-67fd9fc9c8-lzsjb   1/1     Running   0          74m   10.244.104.5     node2   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">myapp-v1-67fd9fc9c8-m7hhp   1/1     Running   0          74m   10.244.166.134   node1   &lt;none&gt;           &lt;none&gt;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Node Network 和 Pod network 这两种网络地址是我们实实在在配置的</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">其中节点网络地址是配置在节点接口之上</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">而 pod 网络地址是配置在 pod 资源之上的</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">因此这些地址都是配置在某些设备之上的，这些设备可能是硬件，也可能是软件模拟的</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>Cluster Network（集群地址，也成为 service network）：这个地址是虚拟的地址（virtual ip），没有配置在某个接口上，只是出现在 service 的规则当中</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@master1 ~]# kubectl get svc</span><br><span class="line">NAME         TYPE           CLUSTER-IP      EXTERNAL-IP   PORT(S)        AGE</span><br><span class="line">kubernetes   ClusterIP      10.96.0.1       &lt;none&gt;        443/TCP        3d19h</span><br></pre></td></tr></table></figure>

<h2 id="创建Service资源"><a href="#创建Service资源" class="headerlink" title="创建Service资源"></a>创建Service资源</h2><ul>
<li>查看 <code>Service</code> 所需字段</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[root@master1 ~]# kubectl explain service</span><br><span class="line">KIND:     Service</span><br><span class="line">VERSION:  v1</span><br><span class="line"></span><br><span class="line">FIELDS:</span><br><span class="line">   apiVersion	&lt;string&gt;	# service资源使用的api组</span><br><span class="line">   kind	&lt;string&gt;			# 创建的资源类型</span><br><span class="line">   metadata	&lt;Object&gt;		# 定义元数据</span><br><span class="line">   spec	&lt;Object&gt;</span><br><span class="line">   status	&lt;Object&gt;</span><br></pre></td></tr></table></figure>

<ul>
<li>查看 <code>service.spec</code> 字段</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">[root@master1 ~]# kubectl explain service.spec</span><br><span class="line">KIND:     Service</span><br><span class="line">VERSION:  v1</span><br><span class="line">RESOURCE: spec &lt;Object&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">FIELDS:</span><br><span class="line">   allocateLoadBalancerNodePorts	&lt;boolean&gt;</span><br><span class="line"></span><br><span class="line">   clusterIP	&lt;string&gt;</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">动态分配的地址，也可以自己在创建的时候指定，创建之后就改不了了</span></span><br><span class="line"></span><br><span class="line">   clusterIPs	&lt;[]string&gt;</span><br><span class="line">   externalIPs	&lt;[]string&gt;</span><br><span class="line">   externalName	&lt;string&gt;</span><br><span class="line">   externalTrafficPolicy	&lt;string&gt;</span><br><span class="line">   healthCheckNodePort	&lt;integer&gt;</span><br><span class="line">   ipFamilies	&lt;[]string&gt;</span><br><span class="line">   ipFamilyPolicy	&lt;string&gt;</span><br><span class="line">   loadBalancerIP	&lt;string&gt;</span><br><span class="line">   loadBalancerSourceRanges	&lt;[]string&gt;</span><br><span class="line"></span><br><span class="line">   ports	&lt;[]Object&gt;	</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">定义 service 端口，用来和后端 pod 建立联系</span></span><br><span class="line"></span><br><span class="line">   publishNotReadyAddresses	&lt;boolean&gt;</span><br><span class="line"></span><br><span class="line">   selector	&lt;map[string]string&gt;</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">通过标签选择器选择关联的 pod 由哪些</span></span><br><span class="line"></span><br><span class="line">   sessionAffinity	&lt;string&gt;</span><br><span class="line">   sessionAffinityConfig	&lt;Object&gt;</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">service 在实现负载句哼的时候还支持 sessionAffinity，sessionAffinityConfig</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">会话联系，默认是 none，随机调度（基于 iptables 规则调度）</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">如果定义 sessionAffinity 的 client ip，那就表示把来自同一个客户端的 ip 请求调度到同一个 pod 上</span></span><br><span class="line"></span><br><span class="line">   topologyKeys	&lt;[]string&gt;</span><br><span class="line">   type	&lt;string&gt;		# 定义 service 的类型</span><br></pre></td></tr></table></figure>

<h3 id="Service-的四种类型"><a href="#Service-的四种类型" class="headerlink" title="Service 的四种类型"></a>Service 的四种类型</h3><ul>
<li>查看 <code>service.spec.type</code> 字段</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">[root@master1 ~]# kubectl explain service.spec.type</span><br><span class="line">KIND:     Service</span><br><span class="line">VERSION:  v1</span><br><span class="line">FIELD:    type &lt;string&gt;</span><br><span class="line"></span><br><span class="line">DESCRIPTION:</span><br><span class="line">     type determines how the Service is exposed. Defaults to ClusterIP. Valid</span><br><span class="line">     options are `ExternalName`, `ClusterIP`, `NodePort`, and `LoadBalancer`.</span><br><span class="line">     </span><br><span class="line">     &quot;ClusterIP&quot; allocates a cluster-internal IP address for load-balancing to</span><br><span class="line">     endpoints. Endpoints are determined by the selector or if that is not</span><br><span class="line">     specified, by manual construction of an Endpoints object or EndpointSlice</span><br><span class="line">     objects. If clusterIP is &quot;None&quot;, no virtual IP is allocated and the</span><br><span class="line">     endpoints are published as a set of endpoints rather than a virtual IP.</span><br><span class="line">     &quot;NodePort&quot; builds on ClusterIP and allocates a port on every node which</span><br><span class="line">     routes to the same endpoints as the clusterIP. &quot;LoadBalancer&quot; builds on</span><br><span class="line">     NodePort and creates an external load-balancer (if supported in the current</span><br><span class="line">     cloud) which routes to the same endpoints as the clusterIP. &quot;ExternalName&quot;</span><br><span class="line">     aliases this service to the specified externalName. Several other fields do</span><br><span class="line">     not apply to ExternalName services. More info:</span><br><span class="line">     https://kubernetes.io/docs/concepts/services-networking/service/#publishing-services-service-types</span><br></pre></td></tr></table></figure>

<ul>
<li><code>ExternalName</code></li>
</ul>
<blockquote>
<p>适用于 k8s 集群内部容器访问外部资源，它没有 selector，也没有定义任何的端口和 Endpoint。 </p>
</blockquote>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 以下 Service 定义的是将 prod 名称空间中的 my-service 服务映射到 my.database.example.com</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">my-service</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">prod</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">ExternalName</span></span><br><span class="line">  <span class="attr">externalName:</span> <span class="string">my.database.example.com</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 当查询主机 my-service.prod.svc.cluster.local 时，群集 DNS 将返回值为 my.database.example.com 的 CNAME 记录。</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># service 的 FQDN（Fully Qualified Domain Name，完全限定域名/全程域名） 是： &lt;service_name&gt;.&lt;namespace&gt;.svc.cluster.local</span></span><br><span class="line"><span class="comment"># my-service.prod. svc.cluster.local</span></span><br></pre></td></tr></table></figure>

<ul>
<li><code>ClusterIP</code></li>
</ul>
<blockquote>
<p>通过 k8s 集群内部 IP 暴露服务，选择该值，服务只能够在集群内部访问，这也是默认的ServiceType。</p>
</blockquote>
<ul>
<li><code>NodePort</code></li>
</ul>
<blockquote>
<p>通过每个 Node 节点上的 IP 和静态端口暴露 k8s 集群内部的服务。通过请求 &lt;NodeIP&gt;:&lt;NodePort&gt;可以把请求代理到内部的 pod。</p>
<p>Client—–&gt;NodeIP:NodePort—–&gt;Service Ip:ServicePort—–&gt;PodIP:ContainerPort。</p>
</blockquote>
<ul>
<li><code>LoadBalancer</code></li>
</ul>
<blockquote>
<p>使用云提供商的负载均衡器，可以向外部暴露服务。外部的负载均衡器可以路由到 NodePort 服务和 ClusterIP 服务。</p>
</blockquote>
<h3 id="Service-的端口"><a href="#Service-的端口" class="headerlink" title="Service 的端口"></a>Service 的端口</h3><ul>
<li>查看 <code>service.spec.ports</code> 字段</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">[root@master1 ~]# kubectl explain service.spec.ports</span><br><span class="line">KIND:     Service</span><br><span class="line">VERSION:  v1</span><br><span class="line">RESOURCE: ports &lt;[]Object&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">FIELDS:</span><br><span class="line">   appProtocol	&lt;string&gt;</span><br><span class="line"></span><br><span class="line">   name	&lt;string&gt;		# 定义端口的名字</span><br><span class="line"></span><br><span class="line">   nodePort	&lt;integer&gt;</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">宿主机上映射的端口，比如一个 Web 应用需要被 k8s 集群之外的其他用户访问，那么需要配置<span class="built_in">type</span>=NodePort</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">若配置 nodePort=30001，那么其他机器就可以通过浏览器访问 scheme://k8s 集群中的任何一个节点 ip:30001 即可访问到该服务，例如 http://192.168.1.63:30001。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">如果在 k8s 中部署MySQL 数据库，MySQL 可能不需要被外界访问，只需被内部服务访问，那么就不需要设置 NodePort</span></span><br><span class="line"></span><br><span class="line">   port	&lt;integer&gt; -required-	</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">service 的端口，这个是 k8s 集群内部服务可访问的端口</span></span><br><span class="line"></span><br><span class="line">   protocol	&lt;string&gt;</span><br><span class="line">   targetPort	&lt;string&gt;</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">targetPort 是 pod 上的端口，从 port 和 nodePort 上来的流量，经过 kube-proxy 流入到后端 pod的 targetPort 上，最后进入容器。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">与制作容器时暴露的端口一致（使用 DockerFile 中的 EXPOSE），例如官方的 nginx 暴露 80 端口。</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>创建 service：type 类型是 <code>ClusterIP</code></p>
</blockquote>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">my-nginx</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">2</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">run:</span> <span class="string">my-nginx</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">run:</span> <span class="string">my-nginx</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">my-nginx</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">nginx</span></span><br><span class="line">        <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">80</span></span><br><span class="line"></span><br><span class="line">[<span class="string">root@master1</span> <span class="string">service</span>]<span class="comment"># kubectl get pods -o wide</span></span><br><span class="line"><span class="string">NAME</span>                        <span class="string">READY</span>   <span class="string">STATUS</span>    <span class="string">RESTARTS</span>   <span class="string">AGE</span>   <span class="string">IP</span>               <span class="string">NODE</span>    <span class="string">NOMINATED</span> <span class="string">NODE</span>   <span class="string">READINESS</span> <span class="string">GATES</span></span><br><span class="line"><span class="string">my-nginx-69f769d56f-6jqkc</span>   <span class="number">1</span><span class="string">/1</span>     <span class="string">Running</span>   <span class="number">0</span>          <span class="string">44s</span>   <span class="number">10.244</span><span class="number">.166</span><span class="number">.135</span>   <span class="string">node1</span>   <span class="string">&lt;none&gt;</span>           <span class="string">&lt;none&gt;</span></span><br><span class="line"><span class="string">my-nginx-69f769d56f-fckmc</span>   <span class="number">1</span><span class="string">/1</span>     <span class="string">Running</span>   <span class="number">0</span>          <span class="string">44s</span>   <span class="number">10.244</span><span class="number">.104</span><span class="number">.6</span>     <span class="string">node2</span>   <span class="string">&lt;none&gt;</span>           <span class="string">&lt;none&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 请求pod ip地址，查看结果</span></span><br><span class="line">[<span class="string">root@master1</span> <span class="string">service</span>]<span class="comment"># curl 10.244.166.135</span></span><br><span class="line"><span class="string">&lt;!DOCTYPE</span> <span class="string">html&gt;</span></span><br><span class="line"><span class="string">&lt;html&gt;</span></span><br><span class="line"><span class="string">&lt;h1&gt;Welcome</span> <span class="string">to</span> <span class="string">nginx!&lt;/h1&gt;</span></span><br><span class="line"><span class="string">&lt;/html&gt;</span></span><br><span class="line"></span><br><span class="line">[<span class="string">root@master1</span> <span class="string">service</span>]<span class="comment"># curl 10.244.104.6</span></span><br><span class="line"><span class="string">&lt;!DOCTYPE</span> <span class="string">html&gt;</span></span><br><span class="line"><span class="string">&lt;html&gt;</span></span><br><span class="line"><span class="string">&lt;h1&gt;Welcome</span> <span class="string">to</span> <span class="string">nginx!&lt;/h1&gt;</span></span><br><span class="line"><span class="string">&lt;/html&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 需要注意的是，pod 虽然定义了容器端口，但是不会使用调度到该节点上的 80 端口，也不会使用任何特定的 NAT 规则去路由流量到 Pod 上。</span></span><br><span class="line"><span class="comment"># 这意味着可以在同一个节点上运行多个 Pod，使用相同的容器端口，并且可以从集群中任何其他的 Pod 或节点上使用 IP 的方式访问到它们。</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 误删除其中一个 Pod</span></span><br><span class="line">[<span class="string">root@master1</span> <span class="string">~</span>]<span class="comment"># kubectl delete pods my-nginx-69f769d56f-fckmc</span></span><br><span class="line"></span><br><span class="line">[<span class="string">root@master1</span> <span class="string">~</span>]<span class="comment"># kubectl get pods -o wide</span></span><br><span class="line"><span class="string">NAME</span>                        <span class="string">READY</span>   <span class="string">STATUS</span>    <span class="string">RESTARTS</span>   <span class="string">AGE</span>     <span class="string">IP</span>               <span class="string">NODE</span>    <span class="string">NOMINATED</span> <span class="string">NODE</span>   <span class="string">READINESS</span> <span class="string">GATES</span></span><br><span class="line"><span class="string">my-nginx-69f769d56f-6jqkc</span>   <span class="number">1</span><span class="string">/1</span>     <span class="string">Running</span>   <span class="number">0</span>          <span class="string">4m59s</span>   <span class="number">10.244</span><span class="number">.166</span><span class="number">.135</span>   <span class="string">node1</span>   <span class="string">&lt;none&gt;</span>           <span class="string">&lt;none&gt;</span></span><br><span class="line"><span class="string">my-nginx-69f769d56f-ztl2w</span>   <span class="number">1</span><span class="string">/1</span>     <span class="string">Running</span>   <span class="number">0</span>          <span class="string">19s</span>     <span class="number">10.244</span><span class="number">.166</span><span class="number">.136</span>   <span class="string">node1</span>   <span class="string">&lt;none&gt;</span>           <span class="string">&lt;none&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 通过上面可以看到重新生成了一个 pod ：my-nginx-69f769d56f-ztl2w，ip 是 10.244.166.136</span></span><br><span class="line"><span class="comment"># 在k8s 中创建 pod，如果 pod 被删除了，重新生成的 pod ip 地址会发生变化，所以需要在 pod 前端加一个固定接入层。</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 接下来创建 service</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">my-nginx</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">run:</span> <span class="string">my-nginx</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">ClusterIP</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">run:</span> <span class="string">my-nginx</span>		<span class="comment"># 选择拥有 run=my-nginx 标签的 pod</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">80</span>			<span class="comment"># service 的端口，暴露给 k8s 集群内部服务访问</span></span><br><span class="line">    <span class="attr">targetPort:</span> <span class="number">80</span>		<span class="comment"># pod 容器中定义的端口</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 上述 yaml 文件将创建一个 Service，具有标签 run=my-nginx 的 Pod，目标 TCP 端口 80</span></span><br><span class="line"><span class="comment"># 并且在一个抽象的 Service 端口（targetPort：容器接收流量的端口；port：抽象的 Service 端口，可以使任何其它 Pod 访问该 Service 的端口）上暴露。</span></span><br><span class="line"></span><br><span class="line">[<span class="string">root@master1</span> <span class="string">~</span>]<span class="comment"># kubectl get svc -l run=my-nginx</span></span><br><span class="line"><span class="string">NAME</span>       <span class="string">TYPE</span>        <span class="string">CLUSTER-IP</span>       <span class="string">EXTERNAL-IP</span>   <span class="string">PORT(S)</span>   <span class="string">AGE</span></span><br><span class="line"><span class="string">my-nginx</span>   <span class="string">ClusterIP</span>   <span class="number">10.105</span><span class="number">.193</span><span class="number">.164</span>   <span class="string">&lt;none&gt;</span>        <span class="number">80</span><span class="string">/TCP</span>    <span class="string">3m52s</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 在 k8s 控制节点访问 service 的 ip:端口就可以把请求代理到后端 pod</span></span><br><span class="line">[<span class="string">root@master1</span> <span class="string">~</span>]<span class="comment"># curl 10.105.193.164</span></span><br><span class="line"><span class="string">&lt;!DOCTYPE</span> <span class="string">html&gt;</span></span><br><span class="line"><span class="string">&lt;html&gt;</span></span><br><span class="line"><span class="string">&lt;h1&gt;Welcome</span> <span class="string">to</span> <span class="string">nginx!&lt;/h1&gt;</span></span><br><span class="line"><span class="string">&lt;/html&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 通过上面可以看到请求 service IP:port 跟直接访问 pod ip:port 看到的结果一样，这就说明 service 可以把请求代理到它所关联的后端 pod </span></span><br><span class="line"><span class="comment"># 注意：上面的 10.105.193.164:80 地址只能是在 k8s 集群内部可以访问，在外部无法访问，比方说我们想要通过浏览器访问，那么是访问不通的</span></span><br><span class="line"><span class="comment"># 如果想要在 k8s 集群之外访问，是需要把 service type 类型改成 nodePort 的</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看 service 详细信息</span></span><br><span class="line"><span class="string">root@master1</span> <span class="string">~]#</span> <span class="string">kubectl</span> <span class="string">describe</span> <span class="string">svc</span> <span class="string">my-nginx</span> </span><br><span class="line"><span class="attr">Name:</span>              <span class="string">my-nginx</span></span><br><span class="line"><span class="attr">Namespace:</span>         <span class="string">default</span></span><br><span class="line"><span class="attr">Labels:</span>            <span class="string">run=my-nginx</span></span><br><span class="line"><span class="attr">Annotations:</span>       <span class="string">&lt;none&gt;</span></span><br><span class="line"><span class="attr">Selector:</span>          <span class="string">run=my-nginx</span></span><br><span class="line"><span class="attr">Type:</span>              <span class="string">ClusterIP</span></span><br><span class="line"><span class="attr">IP Families:</span>       <span class="string">&lt;none&gt;</span></span><br><span class="line"><span class="attr">IP:</span>                <span class="number">10.105</span><span class="number">.193</span><span class="number">.164</span></span><br><span class="line"><span class="attr">IPs:</span>               <span class="number">10.105</span><span class="number">.193</span><span class="number">.164</span></span><br><span class="line"><span class="attr">Port:</span>              <span class="string">&lt;unset&gt;</span>  <span class="number">80</span><span class="string">/TCP</span></span><br><span class="line"><span class="attr">TargetPort:</span>        <span class="number">80</span><span class="string">/TCP</span></span><br><span class="line"><span class="attr">Endpoints:</span>         <span class="number">10.244</span><span class="number">.166</span><span class="number">.135</span><span class="string">:80,10.244.166.136:80</span></span><br><span class="line"><span class="attr">Session Affinity:</span>  <span class="string">None</span></span><br><span class="line"><span class="attr">Events:</span>            <span class="string">&lt;none&gt;</span></span><br><span class="line"></span><br><span class="line">[<span class="string">root@master1</span> <span class="string">~</span>]<span class="comment"># kubectl get ep my-nginx </span></span><br><span class="line"><span class="string">NAME</span>       <span class="string">ENDPOINTS</span>                             <span class="string">AGE</span></span><br><span class="line"><span class="string">my-nginx</span>   <span class="number">10.244</span><span class="number">.166</span><span class="number">.135</span><span class="string">:80,10.244.166.136:80</span>   <span class="string">6m59s</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># service 可以对外提供统一固定的 ip 地址，并将请求重定向至集群中的 pod。</span></span><br><span class="line"><span class="comment"># 其中“将请求重定向至集群中的 pod”就是通过 endpoint 与 selector 协同工作实现。</span></span><br><span class="line"><span class="comment"># selector 是用于选择 pod，由selector 选择出来的 pod 的 ip 地址和端口号，将会被记录在 endpoint 中。endpoint 便记录了所有 pod的 ip 地址和端口号。</span></span><br><span class="line"><span class="comment"># 当一个请求访问到 service 的 ip 地址时，就会从 endpoint 中选择出一个 ip 地址和端口号，然后将请求重定向至 pod 中。</span></span><br><span class="line"><span class="comment"># 具体把请求代理到哪个 pod，需要的就是 kube-proxy 的轮询实现的。service 不会直接到 pod，service 是直接到 endpoint 资源，就是地址加端口，再由 endpoint 再关联到 pod。</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># service 只要创建完成，我们就可以直接解析它的服务名，每一个服务创建完成后都会在集群 dns 中动态添加一个资源记录，添加完成后我们就可以解析了，资源记录格式是： </span></span><br><span class="line"><span class="comment"># SVC_NAME.NS_NAME.DOMAIN.LTD. </span></span><br><span class="line"><span class="comment"># 服务名.命名空间.域名后缀 </span></span><br><span class="line"><span class="comment"># 集群默认的域名后缀是 svc.cluster.local. </span></span><br><span class="line"><span class="comment"># 就像我们上面创建的 my-nginx 这个服务，它的完整名称解析就是my-nginx.default.svc.cluster.local</span></span><br><span class="line"></span><br><span class="line">[<span class="string">root@master1</span> <span class="string">~</span>]<span class="comment"># kubectl exec -it my-nginx-69f769d56f-ztl2w -- /bin/bash</span></span><br><span class="line"><span class="string">root@my-nginx-69f769d56f-ztl2w:/#</span> <span class="string">curl</span> <span class="string">my-nginx.default.svc.cluster.local</span></span><br><span class="line"><span class="string">&lt;!DOCTYPE</span> <span class="string">html&gt;</span></span><br><span class="line"><span class="string">&lt;html&gt;</span></span><br><span class="line"><span class="string">&lt;h1&gt;Welcome</span> <span class="string">to</span> <span class="string">nginx!&lt;/h1&gt;</span></span><br><span class="line"><span class="string">&lt;/html&gt;</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>创建 Service：type 类型是 NodePort</p>
</blockquote>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">2</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">run:</span> <span class="string">nginx-nodeport</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">run:</span> <span class="string">nginx-nodeport</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">nginx</span></span><br><span class="line">        <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">80</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">my-nginx</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">run:</span> <span class="string">nginx-nodeport</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">run:</span> <span class="string">nginx-nodeport</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">    <span class="attr">targetPort:</span> <span class="number">80</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">    <span class="attr">nodePort:</span> <span class="number">30380</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">NodePort</span></span><br><span class="line"></span><br><span class="line">[<span class="string">root@master1</span> <span class="string">~</span>]<span class="comment"># kubectl get svc -l run=nginx-nodeport</span></span><br><span class="line"><span class="string">NAME</span>       <span class="string">TYPE</span>       <span class="string">CLUSTER-IP</span>      <span class="string">EXTERNAL-IP</span>   <span class="string">PORT(S)</span>        <span class="string">AGE</span></span><br><span class="line"><span class="string">my-nginx</span>   <span class="string">NodePort</span>   <span class="number">10.96</span><span class="number">.56</span><span class="number">.24</span>     <span class="string">&lt;none&gt;</span>        <span class="number">80</span><span class="string">:30380/TCP</span>   <span class="string">36s</span></span><br><span class="line"></span><br><span class="line">[<span class="string">root@master1</span> <span class="string">~</span>]<span class="comment"># curl 10.96.56.24</span></span><br><span class="line"><span class="string">&lt;!DOCTYPE</span> <span class="string">html&gt;</span></span><br><span class="line"><span class="string">&lt;html&gt;</span></span><br><span class="line"><span class="string">&lt;h1&gt;Welcome</span> <span class="string">to</span> <span class="string">nginx!&lt;/h1&gt;</span></span><br><span class="line"><span class="string">&lt;/html&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 注意： </span></span><br><span class="line"><span class="comment"># 10.96.56.24 是 k8s 集群内部的 service ip 地址，只能在 k8s 集群内部访问，在集群外无法访问。</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 在集群外访问/在浏览器访问</span></span><br><span class="line">[<span class="string">root@master1</span> <span class="string">~</span>]<span class="comment"># curl 192.168.1.181:30380</span></span><br><span class="line"><span class="string">&lt;!DOCTYPE</span> <span class="string">html&gt;</span></span><br><span class="line"><span class="string">&lt;html&gt;</span></span><br><span class="line"><span class="string">&lt;h1&gt;Welcome</span> <span class="string">to</span> <span class="string">nginx!&lt;/h1&gt;</span></span><br><span class="line"><span class="string">&lt;/html&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 服务请求走向：Client-→node ip:30380-&gt;service ip:80-→pod ip:container port </span></span><br><span class="line"><span class="comment"># Client -&gt;192.168.1.181:30380-&gt;10.96.56.24:80-&gt;pod ip:80</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>创建 Service：type 类型是 ExternalName</p>
<p> 应用场景：跨名称空间访问<br>需求：default 名称空间下的 client 服务想要访问 nginx-ns 名称空间下的 nginx-svc 服务</p>
</blockquote>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">client</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">busybox</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">busybox</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">busybox</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">busybox</span></span><br><span class="line">        <span class="attr">command:</span> [<span class="string">&quot;/bin/sh&quot;</span>,<span class="string">&quot;-c&quot;</span>,<span class="string">&quot;sleep 36000&quot;</span>]</span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">client-svc</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">ExternalName</span></span><br><span class="line">  <span class="attr">externalName:</span> <span class="string">nginx-svc.nginx-ns.svc.cluster.local</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">http</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">    <span class="attr">targetPort:</span> <span class="number">80</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 该文件中指定了到 nginx-svc 的软链，让使用者感觉就好像调用自己命名空间的服务一样。</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建 nginx-ns 命名空间</span></span><br><span class="line">[<span class="string">root@master1</span> <span class="string">~</span>]<span class="comment"># kubectl create namespace nginx-ns</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建 nginx-ns 名称空间下的服务</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">nginx-ns</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">nginx</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">80</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx-svc</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">nginx-ns</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">http</span></span><br><span class="line">    <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">    <span class="attr">targetPort:</span> <span class="number">80</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 登录到client pod</span></span><br><span class="line">[<span class="string">root@master1</span> <span class="string">~</span>]<span class="comment"># kubectl exec -it client-76b6556d97-mmqm9 -- /bin/sh</span></span><br><span class="line"><span class="string">/</span> <span class="comment"># wget -q -O - client-svc.default.svc.cluster.local</span></span><br><span class="line"><span class="string">&lt;!DOCTYPE</span> <span class="string">html&gt;</span></span><br><span class="line"><span class="string">&lt;html&gt;</span></span><br><span class="line"><span class="string">&lt;h1&gt;Welcome</span> <span class="string">to</span> <span class="string">nginx!&lt;/h1&gt;</span></span><br><span class="line"><span class="string">&lt;/html&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="string">/</span> <span class="comment"># wget -q -O - nginx-svc.nginx-ns.svc.cluster.local</span></span><br><span class="line"><span class="string">&lt;!DOCTYPE</span> <span class="string">html&gt;</span></span><br><span class="line"><span class="string">&lt;html&gt;</span></span><br><span class="line"><span class="string">&lt;h1&gt;Welcome</span> <span class="string">to</span> <span class="string">nginx!&lt;/h1&gt;</span></span><br><span class="line"><span class="string">&lt;/html&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 上面两个请求的结果一样</span></span><br></pre></td></tr></table></figure>

<h2 id="k8s-实践：映射外部服务"><a href="#k8s-实践：映射外部服务" class="headerlink" title="k8s 实践：映射外部服务"></a>k8s 实践：映射外部服务</h2><ul>
<li>k8s 集群引用外部 mysql 数据库</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">在 node2 上安装mysql数据库</span></span><br><span class="line">[root@node2 ~]# yum install mariadb-server -y</span><br><span class="line"></span><br><span class="line">[root@node2 ~]# systemctl start mariadb.service</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">创建 service</span></span><br><span class="line"></span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  name: mysql</span><br><span class="line">spec:</span><br><span class="line">  type: ClusterIP</span><br><span class="line">  ports:</span><br><span class="line">  - port: 3306</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@master1 ~]# kubectl get svc | grep mysql</span><br><span class="line">mysql        ClusterIP      10.107.38.63    &lt;none&gt;                                 3306/TCP       17s</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@master1 ~]# kubectl describe svc mysql </span><br><span class="line">Name:              mysql</span><br><span class="line">Namespace:         default</span><br><span class="line">Labels:            &lt;none&gt;</span><br><span class="line">Annotations:       &lt;none&gt;</span><br><span class="line">Selector:          &lt;none&gt;</span><br><span class="line">Type:              ClusterIP</span><br><span class="line">IP Families:       &lt;none&gt;</span><br><span class="line">IP:                10.107.38.63</span><br><span class="line">IPs:               10.107.38.63</span><br><span class="line">Port:              &lt;unset&gt;  3306/TCP</span><br><span class="line">TargetPort:        3306/TCP</span><br><span class="line">Endpoints:         &lt;none&gt;	# 还没有 endpoints</span><br><span class="line">Session Affinity:  None</span><br><span class="line">Events:            &lt;none&gt;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">创建 mysql endpoints</span></span><br><span class="line"></span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Endpoints</span><br><span class="line">metadata:</span><br><span class="line">  name: mysql		# 名字需要跟 service name 保持一致</span><br><span class="line">subsets:</span><br><span class="line">- addresses:</span><br><span class="line">  - ip: 192.168.1.182</span><br><span class="line">  ports:</span><br><span class="line">  - port: 3306</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@master1 ~]# kubectl describe svc mysql </span><br><span class="line">Name:              mysql</span><br><span class="line">Namespace:         default</span><br><span class="line">Labels:            &lt;none&gt;</span><br><span class="line">Annotations:       &lt;none&gt;</span><br><span class="line">Selector:          &lt;none&gt;</span><br><span class="line">Type:              ClusterIP</span><br><span class="line">IP Families:       &lt;none&gt;</span><br><span class="line">IP:                10.107.38.63</span><br><span class="line">IPs:               10.107.38.63</span><br><span class="line">Port:              &lt;unset&gt;  3306/TCP</span><br><span class="line">TargetPort:        3306/TCP</span><br><span class="line">Endpoints:         192.168.1.182:3306	# 这个就是定义的外部数据库</span><br><span class="line">Session Affinity:  None</span><br><span class="line">Events:            &lt;none&gt;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">上面配置就是将外部 IP 地址和服务引入到 k8s 集群内部，由 service 作为一个代理来达到能够访问外部服务的目的。</span></span><br></pre></td></tr></table></figure>

<h2 id="Service-代理：kube-proxy-组件详解"><a href="#Service-代理：kube-proxy-组件详解" class="headerlink" title="Service 代理：kube-proxy 组件详解"></a>Service 代理：kube-proxy 组件详解</h2><h3 id="kube-proxy-组件介绍"><a href="#kube-proxy-组件介绍" class="headerlink" title="kube-proxy 组件介绍"></a>kube-proxy 组件介绍</h3><blockquote>
<p>Kubernetes service 只是把应用对外提供服务的方式做了抽象，真正的应用跑在 Pod 中的container 里，我们的请求转到 kubernetes nodes 对应的 nodePort 上，那么 nodePort 上的请求是如何进一步转到提供后台服务的 Pod 的呢？ 就是通过 <code>kube-proxy</code> 实现的</p>
</blockquote>
<blockquote>
<p>kube-proxy 部署在 k8s 的每一个 Node 节点上，是 Kubernetes 的核心组件，我们创建一个 service 的时候，kube-proxy 会在 <code>iptables</code> 中追加一些规则，为我们实现路由与负载均衡的功能。在 k8s1.8 之前，kube-proxy 默认使用的是 iptables 模式，通过各个 node 节点上的 iptables 规则来实现 service 的负载均衡，但是随着 service 数量的增大，iptables 模式由于线性查找匹配、全量更新等特点，其性能会显著下降。从 k8s 的 1.8 版本开始，kube-proxy 引入了 <code>IPVS</code> 模式，IPVS 模式与 iptables 同样基于Netfilter，但是采用的 hash 表，因此当 service 数量达到一定规模时，hash 查表的<code>速度优势</code>就会显现出来，从而提高 service 的服务性能。</p>
</blockquote>
<blockquote>
<p>service 是一组 pod 的服务抽象，相当于一组 pod 的 LB，负责将请求分发给对应的 pod。service 会为这个 LB 提供一个 IP，一般称为 cluster IP。kube-proxy 的作用主要是负责 service 的实现，具体来说，就是实现了内部从 pod 到 service 和外部的从 node port 向 service 的访问。 </p>
<p>1、kube-proxy 其实就是管理 service 的访问入口，包括集群内 Pod 到 Service 的访问和集群外访问 service。 </p>
<p>2、kube-proxy 管理 sevice 的 Endpoints，该 service 对外暴露一个 Virtual IP，也可以称为是 Cluster IP, 集群内通过访问这个 Cluster IP:Port 就能访问到集群内对应的 serivce 下的 Pod。</p>
</blockquote>
<h3 id="kube-proxy-三种工作模式"><a href="#kube-proxy-三种工作模式" class="headerlink" title="kube-proxy 三种工作模式"></a>kube-proxy 三种工作模式</h3><ul>
<li><code>Userspace</code>方式</li>
</ul>
<p><img src="../../../../images/image/k8s-han/22.png" alt="22"></p>
<blockquote>
<p>Client Pod 要访问 Server Pod 时，它先将请求发给内核空间中的 service iptables 规则，由它再将请求转给监听在指定套接字上的 kube-proxy 的端口，kube-proxy 处理完请求，并分发请求到指定Server Pod 后，再将请求转发给内核空间中的 service ip，由 service iptables 将请求转给各个节点中的 Server Pod。</p>
<p>这个模式有很大的问题，客户端请求先进入内核空间的，又进去用户空间访问 kube-proxy，由 kube-proxy 封装完成后再进去内核空间的 iptables，再根据 iptables 的规则分发给各节点的用户空间的 pod。由于其需要来回在用户空间和内核空间交互通信，因此效率很差。在 Kubernetes 1.1 版本之前，userspace 是默认的代理模型。 </p>
</blockquote>
<ul>
<li><code>iptablees</code>方式</li>
</ul>
<p><img src="../../../../images/image/k8s-han/23.png" alt="23"></p>
<blockquote>
<p>客户端 IP 请求时，直接请求本地内核 service ip，根据 iptables 的规则直接将请求转发到到各 pod 上，因为使用 iptable NAT 来完成转发，也存在不可忽视的性能损耗。另外，如果集群中存上万的 Service/Endpoint，那么 Node 上的 iptables rules 将会非常庞大，性能还会再打折</p>
<p> iptables 代理模式由 Kubernetes 1.1 版本引入，自 1.2 版本开始成为默认类型。</p>
</blockquote>
<ul>
<li><code>ipvs</code>模式</li>
</ul>
<p><img src="../../../../images/image/k8s-han/24.png" alt="24"></p>
<blockquote>
<p>Kubernetes 自 1.9-alpha 版本引入了 ipvs 代理模式，自 1.11 版本开始成为默认设置。</p>
<p>客户端请求时到达内核空间时，<code>根据 ipvs 的规则直接分发到各 pod 上</code>。kube-proxy 会监视 Kubernetes Service 对象和 Endpoints，调用 netlink 接口以相应地创建 ipvs 规则并定期与 Kubernetes Service 对象和 Endpoints 对象同步 ipvs 规则，以确保 ipvs 状态与期望一致。访问服务时，流量将被重定向到其中一个后端 Pod。与 iptables 类似，ipvs 基于 netfilter 的 hook 功能，但使用<code>哈希表</code>作为底层数据结构并在内核空间中工作。这意味着 ipvs 可以更快地重定向流量，并且在同步代理规则时具有更好的性能。此外，ipvs 为负载均衡算法提供了更多选项，例如：</p>
<ul>
<li>rr：轮询调度</li>
<li>lc：最小连接数</li>
<li>dh：目标哈希</li>
<li>sh：源哈希</li>
<li>sed：最短期望延迟</li>
<li>nq：不排队调度</li>
</ul>
</blockquote>
<blockquote>
<p>如果某个服务后端 pod 发生变化，标签选择器适应的 pod 又多一个，适应的信息会立即反映到 apiserver 上，而 kube-proxy 一定可以 watch 到 etc 中的信息变化，而将它立即转为 ipvs 或者 iptables 中的规则，这一切都是动态和实时的，删除一个 pod 也是同样的原理。如图：</p>
</blockquote>
<p><img src="../../../../images/image/k8s-han/25.png" alt="25"></p>
<blockquote>
<p>注:</p>
<p>以上不论哪种，kube-proxy 都通过 watch 的方式监控着 apiserver 写入 etcd 中关于 Pod 的最新状态信息，它一旦检查到一个 Pod 资源被删除了或新建了，它将立即将这些变化，反应在 iptables 或 ipvs 规则中，以便 iptables 和 ipvs 在调度 Clinet Pod 请求到 Server Pod 时，不会出现 Server Pod 不存在的情况。</p>
<p>自 k8s1.11 以后，service 默认使用 ipvs 规则，若 ipvs 没有被激活，则降级使用 iptables 规则。</p>
</blockquote>
<h3 id="kube-proxy-生成的-iptables-规则"><a href="#kube-proxy-生成的-iptables-规则" class="headerlink" title="kube-proxy 生成的 iptables 规则"></a>kube-proxy 生成的 iptables 规则</h3><ul>
<li>service 的 type 类型是 ClusterIp，iptables 规则分析</li>
</ul>
<blockquote>
<p>在 k8s 创建的 service，虽然有 ip 地址，但是 service 的 ip 是虚拟的，不存在物理机上的，是在 iptables 或者 ipvs 规则里的。</p>
</blockquote>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">my-nginx</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">run:</span> <span class="string">my-nginx</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">my-nginx</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">80</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">my-nginx</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">run:</span> <span class="string">my-nginx</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">ClusterIP</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">run:</span> <span class="string">my-nginx</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">    <span class="attr">targetPort:</span> <span class="number">80</span></span><br><span class="line">    </span><br><span class="line">[<span class="string">root@master1</span> <span class="string">~</span>]<span class="comment"># kubectl get svc -l run=my-nginx</span></span><br><span class="line"><span class="string">NAME</span>       <span class="string">TYPE</span>        <span class="string">CLUSTER-IP</span>       <span class="string">EXTERNAL-IP</span>   <span class="string">PORT(S)</span>   <span class="string">AGE</span></span><br><span class="line"><span class="string">my-nginx</span>   <span class="string">ClusterIP</span>   <span class="number">10.109</span><span class="number">.210</span><span class="number">.245</span>   <span class="string">&lt;none&gt;</span>        <span class="number">80</span><span class="string">/TCP</span>    <span class="string">60s</span></span><br><span class="line"></span><br><span class="line">[<span class="string">root@master1</span> <span class="string">~</span>]<span class="comment"># kubectl get pods -o wide</span></span><br><span class="line"><span class="string">NAME</span>       <span class="string">READY</span>   <span class="string">STATUS</span>    <span class="string">RESTARTS</span>   <span class="string">AGE</span>     <span class="string">IP</span>               <span class="string">NODE</span>    <span class="string">NOMINATED</span> <span class="string">NODE</span>   <span class="string">READINESS</span> <span class="string">GATES</span></span><br><span class="line"><span class="string">my-nginx</span>   <span class="number">1</span><span class="string">/1</span>     <span class="string">Running</span>   <span class="number">0</span>          <span class="string">3m42s</span>   <span class="number">10.244</span><span class="number">.166</span><span class="number">.140</span>   <span class="string">node1</span>   <span class="string">&lt;none&gt;</span>           <span class="string">&lt;none&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[<span class="string">root@master1</span> <span class="string">~</span>]<span class="comment"># iptables -t nat -L | grep 10.109.210.245</span></span><br><span class="line"><span class="string">KUBE-MARK-MASQ</span>  <span class="string">tcp</span>  <span class="string">--</span> <span class="type">!10.244.0.0/16</span>        <span class="number">10.109</span><span class="number">.210</span><span class="number">.245</span>       <span class="string">/*</span> <span class="string">default/my-nginx</span> <span class="string">cluster</span> <span class="string">IP</span> <span class="string">*/</span> <span class="string">tcp</span> <span class="string">dpt:http</span></span><br><span class="line"><span class="string">KUBE-SVC-L65ENXXZWWSAPRCR</span>  <span class="string">tcp</span>  <span class="string">--</span>  <span class="string">anywhere</span>             <span class="number">10.109</span><span class="number">.210</span><span class="number">.245</span>       <span class="string">/*</span> <span class="string">default/my-nginx</span> <span class="string">cluster</span> <span class="string">IP</span> <span class="string">*/</span> <span class="string">tcp</span> <span class="string">dpt:http</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[<span class="string">root@master1</span> <span class="string">~</span>]<span class="comment"># iptables -t nat -L | grep KUBE-SVC-L65ENXXZWWSAPRCR</span></span><br><span class="line"><span class="string">KUBE-SVC-L65ENXXZWWSAPRCR</span>  <span class="string">tcp</span>  <span class="string">--</span>  <span class="string">anywhere</span>             <span class="number">10.109</span><span class="number">.210</span><span class="number">.245</span>       <span class="string">/*</span> <span class="string">default/my-nginx</span> <span class="string">cluster</span> <span class="string">IP</span> <span class="string">*/</span> <span class="string">tcp</span> <span class="string">dpt:http</span></span><br><span class="line"><span class="string">Chain</span> <span class="string">KUBE-SVC-L65ENXXZWWSAPRCR</span> <span class="string">(1</span> <span class="string">references)</span></span><br><span class="line"></span><br><span class="line">[<span class="string">root@master1</span> <span class="string">~</span>]<span class="comment"># iptables -t nat -L | grep 10.244.166.140</span></span><br><span class="line"><span class="string">KUBE-MARK-MASQ</span>  <span class="string">all</span>  <span class="string">--</span>  <span class="number">10.244</span><span class="number">.166</span><span class="number">.140</span>       <span class="string">anywhere</span>             <span class="string">/*</span> <span class="string">default/my-nginx</span> <span class="string">*/</span></span><br><span class="line"><span class="string">DNAT</span>       <span class="string">tcp</span>  <span class="string">--</span>  <span class="string">anywhere</span>             <span class="string">anywhere</span>             <span class="string">/*</span> <span class="string">default/my-nginx</span> <span class="string">*/</span> <span class="string">tcp</span> <span class="string">to:10.244.166.140:80</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 通过上面可以看到之前创建的 service，会通过 kube-proxy 在 iptables 中生成一个规则，来实现流量路由，有一系列目标为 KUBE-SVC-xxx 链的规则，每条规则都会匹配某个目标 ip 与端口。</span></span><br><span class="line"><span class="comment"># 也就是说访问某个 ip:port 的请求会由 KUBE-SVC-xxx 链来处理。这个目标 IP 其实就是 service ip。</span></span><br></pre></td></tr></table></figure>

<ul>
<li>service 的 type 类型是 nodePort，iptables 规则分析</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">my-nginx</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">run:</span> <span class="string">my-nginx</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">my-nginx</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">80</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">my-nginx</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">run:</span> <span class="string">my-nginx</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">NodePort</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">run:</span> <span class="string">my-nginx</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">    <span class="attr">targetPort:</span> <span class="number">80</span></span><br><span class="line">    <span class="attr">nodePort:</span> <span class="number">30380</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[<span class="string">root@master1</span> <span class="string">~</span>]<span class="comment"># kubectl get pods -o wide</span></span><br><span class="line"><span class="string">NAME</span>       <span class="string">READY</span>   <span class="string">STATUS</span>    <span class="string">RESTARTS</span>   <span class="string">AGE</span>   <span class="string">IP</span>               <span class="string">NODE</span>    <span class="string">NOMINATED</span> <span class="string">NODE</span>   <span class="string">READINESS</span> <span class="string">GATES</span></span><br><span class="line"><span class="string">my-nginx</span>   <span class="number">1</span><span class="string">/1</span>     <span class="string">Running</span>   <span class="number">0</span>          <span class="string">19s</span>   <span class="number">10.244</span><span class="number">.166</span><span class="number">.141</span>   <span class="string">node1</span>   <span class="string">&lt;none&gt;</span>           <span class="string">&lt;none&gt;</span></span><br><span class="line"></span><br><span class="line">[<span class="string">root@master1</span> <span class="string">~</span>]<span class="comment"># kubectl get svc -l run=my-nginx</span></span><br><span class="line"><span class="string">NAME</span>       <span class="string">TYPE</span>       <span class="string">CLUSTER-IP</span>       <span class="string">EXTERNAL-IP</span>   <span class="string">PORT(S)</span>        <span class="string">AGE</span></span><br><span class="line"><span class="string">my-nginx</span>   <span class="string">NodePort</span>   <span class="number">10.104</span><span class="number">.149</span><span class="number">.141</span>   <span class="string">&lt;none&gt;</span>        <span class="number">80</span><span class="string">:30380/TCP</span>   <span class="string">33s</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[<span class="string">root@master1</span> <span class="string">~</span>]<span class="comment"># iptables -t nat -S | grep 30380</span></span><br><span class="line"><span class="string">-A</span> <span class="string">KUBE-NODEPORTS</span> <span class="string">-p</span> <span class="string">tcp</span> <span class="string">-m</span> <span class="string">comment</span> <span class="string">--comment</span> <span class="string">&quot;default/my-nginx&quot;</span> <span class="string">-m</span> <span class="string">tcp</span> <span class="string">--dport</span> <span class="number">30380</span> <span class="string">-j</span> <span class="string">KUBE-MARK-MASQ</span></span><br><span class="line"><span class="string">-A</span> <span class="string">KUBE-NODEPORTS</span> <span class="string">-p</span> <span class="string">tcp</span> <span class="string">-m</span> <span class="string">comment</span> <span class="string">--comment</span> <span class="string">&quot;default/my-nginx&quot;</span> <span class="string">-m</span> <span class="string">tcp</span> <span class="string">--dport</span> <span class="number">30380</span> <span class="string">-j</span> <span class="string">KUBE-SVC-L65ENXXZWWSAPRCR</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[<span class="string">root@master1</span> <span class="string">~</span>]<span class="comment"># iptables -t nat -S | grep KUBE-SVC-L65ENXXZWWSAPRCR</span></span><br><span class="line"><span class="string">-N</span> <span class="string">KUBE-SVC-L65ENXXZWWSAPRCR</span></span><br><span class="line"><span class="string">-A</span> <span class="string">KUBE-NODEPORTS</span> <span class="string">-p</span> <span class="string">tcp</span> <span class="string">-m</span> <span class="string">comment</span> <span class="string">--comment</span> <span class="string">&quot;default/my-nginx&quot;</span> <span class="string">-m</span> <span class="string">tcp</span> <span class="string">--dport</span> <span class="number">30380</span> <span class="string">-j</span> <span class="string">KUBE-SVC-L65ENXXZWWSAPRCR</span></span><br><span class="line"><span class="string">-A</span> <span class="string">KUBE-SERVICES</span> <span class="string">-d</span> <span class="number">10.104</span><span class="number">.149</span><span class="number">.141</span><span class="string">/32</span> <span class="string">-p</span> <span class="string">tcp</span> <span class="string">-m</span> <span class="string">comment</span> <span class="string">--comment</span> <span class="string">&quot;default/my-nginx cluster IP&quot;</span> <span class="string">-m</span> <span class="string">tcp</span> <span class="string">--dport</span> <span class="number">80</span> <span class="string">-j</span> <span class="string">KUBE-SVC-L65ENXXZWWSAPRCR</span></span><br><span class="line"><span class="string">-A</span> <span class="string">KUBE-SVC-L65ENXXZWWSAPRCR</span> <span class="string">-m</span> <span class="string">comment</span> <span class="string">--comment</span> <span class="string">&quot;default/my-nginx&quot;</span> <span class="string">-j</span> <span class="string">KUBE-SEP-LT262BZBHIW45DZX</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[<span class="string">root@master1</span> <span class="string">~</span>]<span class="comment"># iptables -t nat -S | grep KUBE-SEP-LT262BZBHIW45DZX</span></span><br><span class="line"><span class="string">-N</span> <span class="string">KUBE-SEP-LT262BZBHIW45DZX</span></span><br><span class="line"><span class="string">-A</span> <span class="string">KUBE-SEP-LT262BZBHIW45DZX</span> <span class="string">-s</span> <span class="number">10.244</span><span class="number">.166</span><span class="number">.141</span><span class="string">/32</span> <span class="string">-m</span> <span class="string">comment</span> <span class="string">--comment</span> <span class="string">&quot;default/my-nginx&quot;</span> <span class="string">-j</span> <span class="string">KUBE-MARK-MASQ</span></span><br><span class="line"><span class="string">-A</span> <span class="string">KUBE-SEP-LT262BZBHIW45DZX</span> <span class="string">-p</span> <span class="string">tcp</span> <span class="string">-m</span> <span class="string">comment</span> <span class="string">--comment</span> <span class="string">&quot;default/my-nginx&quot;</span> <span class="string">-m</span> <span class="string">tcp</span> <span class="string">-j</span> <span class="string">DNAT</span> <span class="string">--to-destination</span> <span class="number">10.244</span><span class="number">.166</span><span class="number">.141</span><span class="string">:80</span></span><br><span class="line"><span class="string">-A</span> <span class="string">KUBE-SVC-L65ENXXZWWSAPRCR</span> <span class="string">-m</span> <span class="string">comment</span> <span class="string">--comment</span> <span class="string">&quot;default/my-nginx&quot;</span> <span class="string">-j</span> <span class="string">KUBE-SEP-LT262BZBHIW45DZX</span></span><br></pre></td></tr></table></figure>

<h2 id="Service-服务发现：coredns-组件"><a href="#Service-服务发现：coredns-组件" class="headerlink" title="Service 服务发现：coredns 组件"></a>Service 服务发现：coredns 组件</h2><h3 id="DNS-是什么"><a href="#DNS-是什么" class="headerlink" title="DNS 是什么"></a>DNS 是什么</h3><blockquote>
<p>DNS 全称是 Domain Name System：域名系统，是整个互联网的电话簿，它能够将可被人理解的域名翻译成可被机器理解 IP 地址，使得互联网的使用者不再需要直接接触很难阅读和理解的 IP 地址。</p>
<p>域名系统在现在的互联网中非常重要，因为服务器的 IP 地址可能会经常变动，如果没有了 DNS，那么可能 IP 地址一旦发生了更改，当前服务器的客户端就没有办法连接到目标的服务器了，如果我们为 IP 地址提供一个『别名』并在其发生变动时修改别名和 IP 地址的关系，那么我们就可以保证集群对外提供的服务能够相对稳定地被其他客户端访问。</p>
<p>DNS 其实就是一个分布式的树状命名系统，它就像一个去中心化的分布式数据库，存储着从域名到 IP 地址的映射。</p>
</blockquote>
<h3 id="CoreDNS"><a href="#CoreDNS" class="headerlink" title="CoreDNS"></a>CoreDNS</h3><blockquote>
<p>CoreDNS 其实就是一个 DNS 服务，而 DNS 作为一种常见的服务发现手段，所以很多开源项目以及工程师都会使用 CoreDNS 为集群提供服务发现的功能，Kubernetes 就在集群中使用 CoreDNS 解决服务发现的问题。 作为一个加入 CNCF（Cloud Native Computing Foundation）的服务， CoreDNS 的实现非常简单。</p>
</blockquote>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">dig</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">dig</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">xianchao/dig:latest</span></span><br><span class="line">    <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">    <span class="attr">command:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">sleep</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&quot;3600&quot;</span></span><br><span class="line">  <span class="attr">restartPolicy:</span> <span class="string">Always</span></span><br><span class="line"></span><br><span class="line">[<span class="string">root@master1</span> <span class="string">~</span>]<span class="comment"># kubectl get svc | grep kubernetes</span></span><br><span class="line"><span class="string">kubernetes</span>   <span class="string">ClusterIP</span>      <span class="number">10.96</span><span class="number">.0</span><span class="number">.1</span>        <span class="string">&lt;none&gt;</span>                                 <span class="number">443</span><span class="string">/TCP</span>        <span class="string">4d12h</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 解析 dns，如有以下返回说明 dns 安装成功</span></span><br><span class="line">[<span class="string">root@master1</span> <span class="string">~</span>]<span class="comment"># kubectl exec -it dig -- nslookup kubernetes</span></span><br><span class="line"><span class="attr">Server:</span>		<span class="number">10.96</span><span class="number">.0</span><span class="number">.10</span></span><br><span class="line"><span class="attr">Address:</span>	<span class="number">10.96</span><span class="number">.0</span><span class="number">.10</span><span class="comment">#53</span></span><br><span class="line"></span><br><span class="line"><span class="attr">Name:</span>	<span class="string">kubernetes.default.svc.cluster.local</span></span><br><span class="line"><span class="attr">Address:</span> <span class="number">10.96</span><span class="number">.0</span><span class="number">.1</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># kubernetes.default.svc.cluster.local </span></span><br><span class="line"><span class="comment"># 服务名.名称空间.默认后缀</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 在 k8s 中创建 service 之后，service 默认的 FQDN 是&lt;service name&gt;.&lt;namespace&gt;.svc.cluster.local，那么 k8s 集群内部的服务就可以通过 FQDN 访问</span></span><br></pre></td></tr></table></figure>

<h1 id="k8s持久化存储"><a href="#k8s持久化存储" class="headerlink" title="k8s持久化存储"></a>k8s持久化存储</h1><blockquote>
<p>在 k8s 中部署的应用都是以 pod 容器的形式运行的，假如我们部署 MySQL、Redis 等数据库，需要对这些数据库产生的数据做备份。因为 Pod 是有生命周期的，如果 pod 不挂载数据卷，那 pod 被删除或重启后这些数据会随之消失，如果想要长久的保留这些数据就要用到 pod 数据持久化存储。</p>
</blockquote>
<ul>
<li>查看 k8s 支持哪些存储</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">[root@master1 ~]# kubectl explain pods.spec.volumes</span><br><span class="line">KIND:     Pod</span><br><span class="line">VERSION:  v1</span><br><span class="line">RESOURCE: volumes &lt;[]Object&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">FIELDS:</span><br><span class="line">   awsElasticBlockStore	&lt;Object&gt;</span><br><span class="line">   azureDisk	&lt;Object&gt;</span><br><span class="line">   azureFile	&lt;Object&gt;</span><br><span class="line">   `cephfs`	&lt;Object&gt;</span><br><span class="line">   cinder	&lt;Object&gt;</span><br><span class="line">   `configMap`	&lt;Object&gt;</span><br><span class="line">   csi	&lt;Object&gt;</span><br><span class="line">   downwardAPI	&lt;Object&gt;</span><br><span class="line">   `emptyDir`	&lt;Object&gt;</span><br><span class="line">   ephemeral	&lt;Object&gt;</span><br><span class="line">   fc	&lt;Object&gt;</span><br><span class="line">   flexVolume	&lt;Object&gt;</span><br><span class="line">   gcePersistentDisk	&lt;Object&gt;</span><br><span class="line">   gitRepo	&lt;Object&gt;</span><br><span class="line">   `glusterfs`	&lt;Object&gt;</span><br><span class="line">   `hostPath`	&lt;Object&gt;</span><br><span class="line">   iscsi	&lt;Object&gt;</span><br><span class="line">   name	&lt;string&gt; -required-</span><br><span class="line">   `nfs`	&lt;Object&gt;</span><br><span class="line">   `persistentVolumeClaim`	&lt;Object&gt;</span><br><span class="line">   photonPersistentDisk	&lt;Object&gt;</span><br><span class="line">   portworxVolume	&lt;Object&gt;</span><br><span class="line">   projected	&lt;Object&gt;</span><br><span class="line">   quobyte	&lt;Object&gt;</span><br><span class="line">   rbd	&lt;Object&gt;</span><br><span class="line">   scaleIO	&lt;Object&gt;</span><br><span class="line">   `secret`	&lt;Object&gt;</span><br><span class="line">   storageos	&lt;Object&gt;</span><br><span class="line">   vsphereVolume	&lt;Object&gt;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">常用的如下：</span> </span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">emptyDir</span> </span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">hostPath</span> </span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">nfs</span> </span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">persistentVolumeClaim</span> </span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">glusterfs</span> </span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">cephfs</span> </span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">configMap</span> </span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">secret</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">想要使用存储卷，需要经历如下步骤</span> </span><br><span class="line">1、定义 pod 的 volume，这个 volume 指明它要关联到哪个存储上的 </span><br><span class="line">2、在容器中要使用 volumemounts 挂载对应的存储 </span><br><span class="line"><span class="meta prompt_"> </span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">经过以上两步才能正确的使用存储卷</span></span><br></pre></td></tr></table></figure>

<h2 id="k8s持久化存储：emptyDir"><a href="#k8s持久化存储：emptyDir" class="headerlink" title="k8s持久化存储：emptyDir"></a>k8s持久化存储：emptyDir</h2><blockquote>
<p>emptyDir 类型的 Volume 是在 Pod 分配到 Node 上时被创建，Kubernetes 会在 Node 上自动分配一个目录，因此无需指定宿主机 Node 上对应的目录文件。 这个目录的初始内容为空，当 Pod 从 Node 上移除时，emptyDir 中的数据会被永久删除。emptyDir Volume 主要用于某些应用程序<code>无需永久保存的临时目录</code>，<code>多个容器的共享目录</code>等。</p>
<p>Emptydir 的官方网址：<a target="_blank" rel="noopener" href="https://kubernetes.io/docs/concepts/storage/volumes#emptydir">https://kubernetes.io/docs/concepts/storage/volumes#emptydir</a></p>
</blockquote>
<ul>
<li>创建一个pod，挂载临时目录 <code>emptyDir</code></li>
</ul>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">pod-empty</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">container-empty</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">volumeMounts:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">cache-volume</span></span><br><span class="line">      <span class="attr">mountPath:</span> <span class="string">/cache</span></span><br><span class="line">  <span class="attr">volumes:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">cache-volume</span></span><br><span class="line">    <span class="attr">emptyDir:</span> &#123;&#125;</span><br><span class="line">    </span><br><span class="line"><span class="comment"># 查看本机临时目录存在的位置，可用如下方法：</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看 pod 调度到哪个节点</span></span><br><span class="line">[<span class="string">root@master1</span> <span class="string">~</span>]<span class="comment"># kubectl get pods pod-empty -o wide</span></span><br><span class="line"><span class="string">NAME</span>        <span class="string">READY</span>   <span class="string">STATUS</span>    <span class="string">RESTARTS</span>   <span class="string">AGE</span>   <span class="string">IP</span>              <span class="string">NODE</span>    <span class="string">NOMINATED</span> <span class="string">NODE</span>   <span class="string">READINESS</span> <span class="string">GATES</span></span><br><span class="line"><span class="string">pod-empty</span>   <span class="number">1</span><span class="string">/1</span>     <span class="string">Running</span>   <span class="number">0</span>          <span class="string">63s</span>   <span class="number">10.244</span><span class="number">.104</span><span class="number">.10</span>   <span class="string">node2</span>   <span class="string">&lt;none&gt;</span>           <span class="string">&lt;none&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看 pod 的 uid</span></span><br><span class="line">[<span class="string">root@master1</span> <span class="string">~</span>]<span class="comment"># kubectl get pods pod-empty -o yaml | grep uid</span></span><br><span class="line">  <span class="attr">uid:</span> <span class="string">3bc98582-6066-49bf-90a5-bd57567d82e2</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 到 node2 上</span></span><br><span class="line">[<span class="string">root@node2</span> <span class="string">~</span>]<span class="comment"># tree /var/lib/kubelet/pods/3bc98582-6066-49bf-90a5-bd57567d82e2/</span></span><br><span class="line"><span class="string">/var/lib/kubelet/pods/3bc98582-6066-49bf-90a5-bd57567d82e2/</span></span><br><span class="line"><span class="string">├──</span> <span class="string">containers</span></span><br><span class="line"><span class="string">│</span>   <span class="string">└──</span> <span class="string">container-empty</span></span><br><span class="line"><span class="string">│</span>       <span class="string">└──</span> <span class="string">64f0c29b</span></span><br><span class="line"><span class="string">├──</span> <span class="string">etc-hosts</span></span><br><span class="line"><span class="string">├──</span> <span class="string">plugins</span></span><br><span class="line"><span class="string">│</span>   <span class="string">└──</span> <span class="string">kubernetes.io~empty-dir</span></span><br><span class="line"><span class="string">│</span>       <span class="string">├──</span> <span class="string">cache-volume</span></span><br><span class="line"><span class="string">│</span>       <span class="string">│</span>   <span class="string">└──</span> <span class="string">ready</span></span><br><span class="line"><span class="string">│</span>       <span class="string">└──</span> <span class="string">wrapped_default-token-bnmcc</span></span><br><span class="line"><span class="string">│</span>           <span class="string">└──</span> <span class="string">ready</span></span><br><span class="line"><span class="string">└──</span> <span class="string">volumes</span></span><br><span class="line">    <span class="string">├──</span> <span class="string">kubernetes.io~empty-dir</span></span><br><span class="line">    <span class="string">│</span>   <span class="string">└──</span> <span class="string">cache-volume</span></span><br><span class="line">    <span class="string">└──</span> <span class="string">kubernetes.io~secret</span></span><br><span class="line">        <span class="string">└──</span> <span class="string">default-token-bnmcc</span></span><br><span class="line">            <span class="string">├──</span> <span class="string">ca.crt</span> <span class="string">-&gt;</span> <span class="string">..data/ca.crt</span></span><br><span class="line">            <span class="string">├──</span> <span class="string">namespace</span> <span class="string">-&gt;</span> <span class="string">..data/namespace</span></span><br><span class="line">            <span class="string">└──</span> <span class="string">token</span> <span class="string">-&gt;</span> <span class="string">..data/token</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 由上可知，临时目录在本地的/var/lib/kubelet/pods/3bc98582-6066-49bf-90a5-bd57567d82e2/volumes/kubernetes.io~empty-dir/cache-volume/下</span></span><br></pre></td></tr></table></figure>

<h2 id="k8s持久化存储：hostPath"><a href="#k8s持久化存储：hostPath" class="headerlink" title="k8s持久化存储：hostPath"></a>k8s持久化存储：hostPath</h2><blockquote>
<p>hostPath Volume 是指 Pod 挂载宿主机上的目录或文件。 hostPath Volume 使得容器可以使用宿主机的文件系统进行存储，hostpath（宿主机路径）：节点级别的存储卷，在 pod 被删除，这个存储卷还是存在的，不会被删除，所以只要同一个 pod 被调度到同一个节点上来，在 pod 被删除重新被调度到这个节点之后，对应的数据依然是存在的。</p>
</blockquote>
<ul>
<li>查看 <code>hostPath</code> 存储卷的用法</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@master1 ~]# kubectl explain pod.spec.volumes.hostPath</span><br><span class="line">KIND:     Pod</span><br><span class="line">VERSION:  v1</span><br><span class="line">RESOURCE: hostPath &lt;Object&gt;</span><br><span class="line"></span><br><span class="line">FIELDS:</span><br><span class="line">   path	&lt;string&gt; -required-</span><br><span class="line">   type	&lt;string&gt;</span><br></pre></td></tr></table></figure>

<ul>
<li>创建一个 pod，挂载 <code>hostPath</code> 存储卷</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">test-hostpath</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">test-nginx</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">volumeMounts:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">test-volume</span></span><br><span class="line">      <span class="attr">mountPath:</span> <span class="string">/test-nginx</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">test-tomcat</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">tomcat</span></span><br><span class="line">    <span class="attr">volumeMounts:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">test-volume</span></span><br><span class="line">      <span class="attr">mountPath:</span> <span class="string">/test-tomcat</span></span><br><span class="line">  <span class="attr">volumes:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">test-volume</span></span><br><span class="line">    <span class="attr">hostPath:</span></span><br><span class="line">      <span class="attr">path:</span> <span class="string">/data1</span></span><br><span class="line">      <span class="attr">type:</span> <span class="string">DirectoryOrCreate</span></span><br><span class="line">      </span><br><span class="line"><span class="comment"># DirectoryOrCreate 表示本地有/data1 目录，就用本地的，本地没有就会在 pod 调度到的节点自动创建一个</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看 pod 调度到了哪个物理节点</span></span><br><span class="line">[<span class="string">root@master1</span> <span class="string">~</span>]<span class="comment"># kubectl get pods -o wide</span></span><br><span class="line"><span class="string">NAME</span>            <span class="string">READY</span>   <span class="string">STATUS</span>    <span class="string">RESTARTS</span>   <span class="string">AGE</span>   <span class="string">IP</span>               <span class="string">NODE</span>    <span class="string">NOMINATED</span> <span class="string">NODE</span>   <span class="string">READINESS</span> <span class="string">GATES</span></span><br><span class="line"><span class="string">test-hostpath</span>   <span class="number">2</span><span class="string">/2</span>     <span class="string">Running</span>   <span class="number">0</span>          <span class="string">64s</span>   <span class="number">10.244</span><span class="number">.166</span><span class="number">.144</span>   <span class="string">node1</span>   <span class="string">&lt;none&gt;</span>           <span class="string">&lt;none&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 可以看到 node1 已经创建了存储目录/data1，这个/data1 会作为 pod 的持久化存储目录</span></span><br><span class="line">[<span class="string">root@node1</span> <span class="string">~</span>]<span class="comment"># ll /data1/</span></span><br><span class="line"><span class="string">总用量</span> <span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 在 node1 上的 /data1 下创建一个目录</span></span><br><span class="line">[<span class="string">root@node1</span> <span class="string">~</span>]<span class="comment"># mkdir /data1/aa</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 测试存储卷是否可以正常使用,登录到 nginx 容器</span></span><br><span class="line">[<span class="string">root@master1</span> <span class="string">~</span>]<span class="comment"># kubectl exec -it test-hostpath -c test-nginx -- /bin/bash</span></span><br><span class="line"><span class="string">root@test-hostpath:/#</span> <span class="string">cd</span> <span class="string">test-nginx/</span></span><br><span class="line"><span class="string">root@test-hostpath:/test-nginx#</span> <span class="string">ls</span></span><br><span class="line"><span class="string">aa</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 测试存储卷是否可以正常使用,登录到 tomcat 容器</span></span><br><span class="line">[<span class="string">root@master1</span> <span class="string">~</span>]<span class="comment"># kubectl exec -it test-hostpath -c test-tomcat -- /bin/bash</span></span><br><span class="line"><span class="string">root@test-hostpath:/usr/local/tomcat#</span> <span class="string">cd</span> <span class="string">/test-tomcat/</span></span><br><span class="line"><span class="string">root@test-hostpath:/test-tomcat#</span> <span class="string">ls</span></span><br><span class="line"><span class="string">aa</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 通过上面测试可以看到，同一个 pod 里的 test-nginx 和 test-tomcat 这两个容器是共享存储卷的。</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>hostpath 存储卷缺点：</p>
<p><code>单节点</code><br>pod 删除之后重新创建必须调度到同一个 node 节点，数据才不会丢失</p>
<p>可以用分布式存储：<br><code>nfs</code>，<code>cephfs</code>，<code>glusterfs</code></p>
</blockquote>
<h2 id="k8s持久化存储：nfs"><a href="#k8s持久化存储：nfs" class="headerlink" title="k8s持久化存储：nfs"></a>k8s持久化存储：nfs</h2><blockquote>
<p>上面说的 hostPath 存储，存在单点故障，pod 挂载 hostPath 时，只有调度到同一个节点，数据才不会丢失。那可以使用 nfs 作为持久化存储。</p>
<p>Pod 挂载 nfs 的官方地址：<a target="_blank" rel="noopener" href="https://kubernetes.io/zh/docs/concepts/storage/volumes/">https://kubernetes.io/zh/docs/concepts/storage/volumes/</a></p>
</blockquote>
<ul>
<li>搭建 nfs 服务</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">以 master1 作为 NFS 服务端</span></span><br><span class="line">[root@master1 ~]# yum install nfs-utils -y</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">在宿主机创建 NFS服务端</span></span><br><span class="line">[root@master1 ~]# mkdir -pv /data/volumes</span><br><span class="line">mkdir: 已创建目录 &quot;/data&quot;</span><br><span class="line">mkdir: 已创建目录 &quot;/data/volumes&quot;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">配置 nfs 共享服务器上的 /data/volumes 目录</span></span><br><span class="line">[root@master1 ~]# vim /etc/exports</span><br><span class="line">/data/volumes 192.168.1.0/24(rw,no_root_squash)</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">no_root_squash: 用户具有根目录的完全管理访问权限</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">使 NFS 配置生效</span></span><br><span class="line">[root@master1 ~]# exportfs -arv</span><br><span class="line">exporting 192.168.1.0/24:/data/volumes</span><br><span class="line"></span><br><span class="line">[root@master1 ~]# systemctl enable --now nfs</span><br><span class="line">[root@master1 ~]# systemctl status nfs</span><br><span class="line">   Active: active (exited)</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">看到 nfs 是 active，说明 nfs 正常启动了</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">node1 和 node2 上也安装 nfs 驱动</span></span><br><span class="line">[root@node1 ~]# yum install nfs-utils -y</span><br><span class="line">[root@node1 ~]# systemctl enable --now nfs</span><br><span class="line">[root@node2 ~]# yum install nfs-utils -y</span><br><span class="line">[root@node2 ~]# systemctl enable --now nfs</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">在 node1 上挂载测试</span></span><br><span class="line">[root@node1 ~]# mkdir /test</span><br><span class="line">[root@node1 ~]# mount 192.168.1.180:/data/volumes /test</span><br><span class="line">[root@node1 ~]# df -h</span><br><span class="line">192.168.1.180:/data/volumes   79G  5.5G   74G    7% /test</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">手动卸载</span></span><br><span class="line">[root@node1 ~]# umount /test</span><br></pre></td></tr></table></figure>

<ul>
<li>创建 pod，挂载 NFS 共享出来的目录</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">test-nfs</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">test-nfs</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">      <span class="attr">containerPort:</span> <span class="number">80</span></span><br><span class="line">    <span class="attr">volumeMounts:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nfs-volume</span></span><br><span class="line">      <span class="attr">mountPath:</span> <span class="string">/usr/share/nginx/html</span></span><br><span class="line">  <span class="attr">volumes:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nfs-volume</span></span><br><span class="line">    <span class="attr">nfs:</span></span><br><span class="line">      <span class="attr">path:</span> <span class="string">/data/volumes</span></span><br><span class="line">      <span class="attr">server:</span> <span class="number">192.168</span><span class="number">.1</span><span class="number">.180</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 注：path: /data/volumes # nfs 的共享目录 </span></span><br><span class="line"><span class="comment"># server：192.168.1.180 是 master1 机器的 ip，这个是安装 nfs 服务的地址</span></span><br><span class="line"></span><br><span class="line">[<span class="string">root@master1</span> <span class="string">~</span>]<span class="comment"># kubectl get pods -o wide</span></span><br><span class="line"><span class="string">NAME</span>       <span class="string">READY</span>   <span class="string">STATUS</span>    <span class="string">RESTARTS</span>   <span class="string">AGE</span>   <span class="string">IP</span>               <span class="string">NODE</span>    <span class="string">NOMINATED</span> <span class="string">NODE</span>   <span class="string">READINESS</span> <span class="string">GATES</span></span><br><span class="line"><span class="string">test-nfs</span>   <span class="number">1</span><span class="string">/1</span>     <span class="string">Running</span>   <span class="number">0</span>          <span class="string">58s</span>   <span class="number">10.244</span><span class="number">.166</span><span class="number">.145</span>   <span class="string">node1</span>   <span class="string">&lt;none&gt;</span>           <span class="string">&lt;none&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 登录到 nfs 服务器，在共享目录创建一个 index.html</span></span><br><span class="line">[<span class="string">root@master1</span> <span class="string">~</span>]<span class="comment"># vim /data/volumes/index.html</span></span><br><span class="line"><span class="string">Hello</span> <span class="string">World!!!</span></span><br><span class="line"><span class="string">Hello</span> <span class="string">World!!!</span></span><br><span class="line"><span class="string">Hello</span> <span class="string">World!!!</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 请求 pod，查看结果</span></span><br><span class="line">[<span class="string">root@master1</span> <span class="string">~</span>]<span class="comment"># curl 10.244.166.145</span></span><br><span class="line"><span class="string">Hello</span> <span class="string">World!!!</span></span><br><span class="line"><span class="string">Hello</span> <span class="string">World!!!</span></span><br><span class="line"><span class="string">Hello</span> <span class="string">World!!!</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 登录到 pod 验证</span></span><br><span class="line">[<span class="string">root@master1</span> <span class="string">~</span>]<span class="comment"># kubectl exec -it test-nfs -- /bin/bash</span></span><br><span class="line"><span class="string">root@test-nfs:/#</span> <span class="string">cat</span> <span class="string">/usr/share/nginx/html/index.html</span> </span><br><span class="line"><span class="string">Hello</span> <span class="string">World!!!</span></span><br><span class="line"><span class="string">Hello</span> <span class="string">World!!!</span></span><br><span class="line"><span class="string">Hello</span> <span class="string">World!!!</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>上面说明挂载 nfs 存储卷成功了，nfs 支持多个客户端挂载，可以创建多个 pod，挂载同一个 nfs 服务器共享出来的目录；但是 nfs 如果宕机了，数据也就丢失了，所以需要使用分布式存储，常见的分布式存储有 <code>glusterfs</code> 和 <code>cephfs</code></p>
</blockquote>
<h2 id="k8s持久化存储：PVC"><a href="#k8s持久化存储：PVC" class="headerlink" title="k8s持久化存储：PVC"></a>k8s持久化存储：PVC</h2><ul>
<li><p>参考官网: <a target="_blank" rel="noopener" href="https://kubernetes.io/docs/concepts/storage/persistent-volumes/#access-modes">https://kubernetes.io/docs/concepts/storage/persistent-volumes/#access-modes</a> </p>
</li>
<li><p>pv是什么</p>
</li>
</ul>
<blockquote>
<p><code>PersistentVolume</code>（PV）是群集中的一块存储，由管理员配置或使用存储类动态配置。 它是集群中的资源，就像 pod 是 k8s 集群资源一样。 PV 是容量插件，如 Volumes，其生命周期独立于使用 PV 的任何单个 pod。</p>
</blockquote>
<ul>
<li>pvc是什么</li>
</ul>
<blockquote>
<p><code>PersistentVolumeClaim</code>（PVC）是一个持久化存储卷，我们在创建 pod 时可以定义这个类型的存储卷。 它类似于一个 pod。 Pod 消耗节点资源，PVC 消耗 PV 资源。 Pod 可以请求特定级别的资源（CPU 和内存）。 pvc 在申请 pv 的时候也可以请求特定的大小和访问模式（例如，可以一次读写或多次只读）。</p>
</blockquote>
<h3 id="k8s-PVC-和-PV-工作原理"><a href="#k8s-PVC-和-PV-工作原理" class="headerlink" title="k8s PVC 和 PV 工作原理"></a>k8s PVC 和 PV 工作原理</h3><blockquote>
<p>PV 是群集中的资源。 PVC 是对这些资源的请求。<br>PV 和 PVC 之间的相互作用遵循以下生命周期：</p>
</blockquote>
<ol>
<li>pv 的供应方式</li>
</ol>
<blockquote>
<p>可以通过两种方式配置 PV：静态或动态。</p>
</blockquote>
<p><em>静态</em></p>
<ul>
<li>集群管理员创建了许多 <code>PV</code>。它们包含可供群集用户使用的实际存储的详细信息。它们存在于 <code>Kubernetes API</code> 中，可供使用。</li>
</ul>
<p><em>动态</em></p>
<ul>
<li>当管理员创建的静态 PV 都不匹配用户的 <code>PersistentVolumeClaim</code> 时，群集可能会尝试为 PVC 专门动态配置卷。此配置基于 <code>StorageClasses</code>，PVC 必须请求存储类，管理员必须创建并配置该类，以便进行动态配置</li>
</ul>
<ol start="2">
<li>绑定</li>
</ol>
<ul>
<li>用户创建 pvc 并指定需要的资源和访问模式。在找到可用 pv 之前，pvc 会保持未绑定状态</li>
</ul>
<ol start="3">
<li>使用</li>
</ol>
<ul>
<li><p>需要找一个存储服务器，把它划分成多个存储空间； </p>
</li>
<li><p>k8s 管理员可以把这些存储空间定义成多个 pv； </p>
</li>
<li><p>在 pod 中使用 pvc 类型的存储卷之前需要先创建 pvc，通过定义需要使用的 pv 的大小和对应的访问模式，找到合适的 pv； </p>
</li>
<li><p>pvc 被创建之后，就可以当成存储卷来使用了，我们在定义 pod 时就可以使用这个 pvc 的存储卷 </p>
</li>
<li><p>pvc 和 pv 它们是一一对应的关系，pv 如果被 pvc 绑定了，就不能被其他 pvc 使用了； </p>
</li>
<li><p>在创建 pvc 的时候，应该确保和底下的 pv 能绑定，如果没有合适的 pv，那么 pvc 就会处于 pending 状态。</p>
</li>
</ul>
<ol start="4">
<li>回收策略</li>
</ol>
<blockquote>
<p>创建 pod 时如果使用 pvc 做为存储卷，那么它会和 pv 绑定，当删除 pod，pvc 和 pv 绑定就会解除，解除之后和 pvc 绑定的 pv 卷里的数据需要怎么处理，目前，卷可以保留，回收或删除： </p>
</blockquote>
<ul>
<li><p>Retain </p>
</li>
<li><p><del>Recycle</del> （不推荐使用，1.15 可能被废弃了）</p>
</li>
<li><p>Delete </p>
</li>
</ul>
<p><em>Retain</em></p>
<ul>
<li>当删除 pvc 的时候，pv 仍然存在，处于 released 状态，但是它不能被其他 pvc 绑定使用，里面的数据还是存在的，当我们下次再使用的时候，数据还是存在的，这个是默认的回收策略 </li>
</ul>
<p><em>Delete</em></p>
<ul>
<li>删除 pvc 时即会从 Kubernetes 中移除 PV，也会从相关的外部设施中删除存储资产 </li>
</ul>
<h3 id="创建-pod，使用-pvc-作为持久存储卷"><a href="#创建-pod，使用-pvc-作为持久存储卷" class="headerlink" title="创建 pod，使用 pvc 作为持久存储卷"></a>创建 pod，使用 pvc 作为持久存储卷</h3><ul>
<li>创建 nfs 共享目录</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[root@master1 ~]# mkdir -p /data/volume_test/v&#123;1..10&#125;</span><br><span class="line"></span><br><span class="line">[root@master1 ~]# vim /etc/exports</span><br><span class="line">/data/volume_test/v1 192.168.1.0/24(rw,no_root_squash)</span><br><span class="line">/data/volume_test/v2 192.168.1.0/24(rw,no_root_squash)</span><br><span class="line">/data/volume_test/v3 192.168.1.0/24(rw,no_root_squash)</span><br><span class="line">/data/volume_test/v4 192.168.1.0/24(rw,no_root_squash)</span><br><span class="line">/data/volume_test/v5 192.168.1.0/24(rw,no_root_squash)</span><br><span class="line">/data/volume_test/v6 192.168.1.0/24(rw,no_root_squash)</span><br><span class="line">/data/volume_test/v7 192.168.1.0/24(rw,no_root_squash)</span><br><span class="line">/data/volume_test/v8 192.168.1.0/24(rw,no_root_squash)</span><br><span class="line">/data/volume_test/v9 192.168.1.0/24(rw,no_root_squash)</span><br><span class="line">/data/volume_test/v10 192.168.1.0/24(rw,no_root_squash)</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">重新加载配置，使配置成效</span></span><br><span class="line">[root@master1 ~]# exportfs -arv</span><br></pre></td></tr></table></figure>

<ul>
<li>查看定义 <code>pv</code> 需要的字段</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[root@master1 ~]# kubectl explain pv</span><br><span class="line">KIND:     PersistentVolume</span><br><span class="line">VERSION:  v1</span><br><span class="line"></span><br><span class="line">FIELDS:</span><br><span class="line">   apiVersion	&lt;string&gt;</span><br><span class="line">   kind	&lt;string&gt;</span><br><span class="line">   metadata	&lt;Object&gt;</span><br><span class="line">   spec	&lt;Object&gt;</span><br><span class="line">   status	&lt;Object&gt;</span><br></pre></td></tr></table></figure>

<ul>
<li>查看定义 <code>nfs</code> 类型的 <code>pv</code> 需要的的字段</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@master1 ~]# kubectl explain pv.spec.nfs</span><br><span class="line">KIND:     PersistentVolume</span><br><span class="line">VERSION:  v1</span><br><span class="line">RESOURCE: nfs &lt;Object&gt;</span><br><span class="line"></span><br><span class="line">FIELDS:</span><br><span class="line">   path	&lt;string&gt; -required-</span><br><span class="line">   readOnly	&lt;boolean&gt;</span><br><span class="line">   server	&lt;string&gt; -required-</span><br></pre></td></tr></table></figure>

<ul>
<li>创建 pv</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 参考：https://kubernetes.io/zh/docs/concepts/storage/persistent-volumes/#reclaiming</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PersistentVolume</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">capacity:</span></span><br><span class="line">    <span class="attr">storage:</span> <span class="string">1Gi</span></span><br><span class="line">  <span class="attr">accessModes:</span> [<span class="string">&quot;ReadWriteOnce&quot;</span>]</span><br><span class="line">  <span class="attr">nfs:</span></span><br><span class="line">    <span class="attr">path:</span> <span class="string">/data/volume_test/v1</span></span><br><span class="line">    <span class="attr">server:</span> <span class="number">192.168</span><span class="number">.1</span><span class="number">.180</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PersistentVolume</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">v2</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">capacity:</span></span><br><span class="line">    <span class="attr">storage:</span> <span class="string">2Gi</span></span><br><span class="line">  <span class="attr">accessModes:</span> [<span class="string">&quot;ReadWriteMany&quot;</span>]</span><br><span class="line">  <span class="attr">nfs:</span></span><br><span class="line">    <span class="attr">path:</span> <span class="string">/data/volume_test/v2</span> </span><br><span class="line">    <span class="attr">server:</span> <span class="number">192.168</span><span class="number">.1</span><span class="number">.180</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PersistentVolume</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">v3</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">capacity:</span></span><br><span class="line">    <span class="attr">storage:</span> <span class="string">3Gi</span></span><br><span class="line">  <span class="attr">accessModes:</span> [<span class="string">&quot;ReadWriteMany&quot;</span>]</span><br><span class="line">  <span class="attr">nfs:</span></span><br><span class="line">    <span class="attr">path:</span> <span class="string">/data/volume_test/v3</span></span><br><span class="line">    <span class="attr">server:</span> <span class="number">192.168</span><span class="number">.1</span><span class="number">.180</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PersistentVolume</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">v4</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">capacity:</span></span><br><span class="line">    <span class="attr">storage:</span> <span class="string">4Gi</span></span><br><span class="line">  <span class="attr">accessModes:</span> [<span class="string">&quot;ReadWriteOnce&quot;</span>,<span class="string">&quot;ReadWriteMany&quot;</span>]</span><br><span class="line">  <span class="attr">nfs:</span></span><br><span class="line">    <span class="attr">path:</span> <span class="string">/data/volume_test/v4</span></span><br><span class="line">    <span class="attr">server:</span> <span class="number">192.168</span><span class="number">.1</span><span class="number">.180</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PersistentVolume</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">v5</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">capacity:</span></span><br><span class="line">    <span class="attr">storage:</span> <span class="string">5Gi</span></span><br><span class="line">  <span class="attr">accessModes:</span> [<span class="string">&quot;ReadWriteOnce&quot;</span>,<span class="string">&quot;ReadWriteMany&quot;</span>]</span><br><span class="line">  <span class="attr">nfs:</span></span><br><span class="line">    <span class="attr">path:</span> <span class="string">/data/volume_test/v5</span></span><br><span class="line">    <span class="attr">server:</span> <span class="number">192.168</span><span class="number">.1</span><span class="number">.180</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PersistentVolume</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">v6</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">capacity:</span></span><br><span class="line">    <span class="attr">storage:</span> <span class="string">6Gi</span></span><br><span class="line">  <span class="attr">accessModes:</span> [<span class="string">&quot;ReadWriteOnce&quot;</span>,<span class="string">&quot;ReadWriteMany&quot;</span>]</span><br><span class="line">  <span class="attr">nfs:</span></span><br><span class="line">    <span class="attr">path:</span> <span class="string">/data/volume_test/v6</span></span><br><span class="line">    <span class="attr">server:</span> <span class="number">192.168</span><span class="number">.1</span><span class="number">.180</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PersistentVolume</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">v7</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">capacity:</span></span><br><span class="line">    <span class="attr">storage:</span> <span class="string">7Gi</span></span><br><span class="line">  <span class="attr">accessModes:</span> [<span class="string">&quot;ReadWriteOnce&quot;</span>,<span class="string">&quot;ReadWriteMany&quot;</span>]</span><br><span class="line">  <span class="attr">nfs:</span></span><br><span class="line">    <span class="attr">path:</span> <span class="string">/data/volume_test/v7</span></span><br><span class="line">    <span class="attr">server:</span> <span class="number">192.168</span><span class="number">.1</span><span class="number">.180</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PersistentVolume</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">v8</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">capacity:</span></span><br><span class="line">    <span class="attr">storage:</span> <span class="string">8Gi</span></span><br><span class="line">  <span class="attr">accessModes:</span> [<span class="string">&quot;ReadWriteOnce&quot;</span>,<span class="string">&quot;ReadWriteMany&quot;</span>]</span><br><span class="line">  <span class="attr">nfs:</span></span><br><span class="line">    <span class="attr">path:</span> <span class="string">/data/volume_test/v8</span></span><br><span class="line">    <span class="attr">server:</span> <span class="number">192.168</span><span class="number">.1</span><span class="number">.180</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PersistentVolume</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">v9</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">capacity:</span></span><br><span class="line">    <span class="attr">storage:</span> <span class="string">9Gi</span></span><br><span class="line">  <span class="attr">accessModes:</span> [<span class="string">&quot;ReadWriteOnce&quot;</span>,<span class="string">&quot;ReadWriteMany&quot;</span>]</span><br><span class="line">  <span class="attr">nfs:</span></span><br><span class="line">    <span class="attr">path:</span> <span class="string">/data/volume_test/v9</span></span><br><span class="line">    <span class="attr">server:</span> <span class="number">192.168</span><span class="number">.1</span><span class="number">.180</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PersistentVolume</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">v10</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">capacity:</span></span><br><span class="line">    <span class="attr">storage:</span> <span class="string">10Gi</span></span><br><span class="line">  <span class="attr">accessModes:</span> [<span class="string">&quot;ReadWriteOnce&quot;</span>,<span class="string">&quot;ReadWriteMany&quot;</span>]</span><br><span class="line">  <span class="attr">nfs:</span></span><br><span class="line">    <span class="attr">path:</span> <span class="string">/data/volume_test/v10</span></span><br><span class="line">    <span class="attr">server:</span> <span class="number">192.168</span><span class="number">.1</span><span class="number">.180</span></span><br><span class="line">    </span><br><span class="line">[<span class="string">root@master1</span> <span class="string">~</span>]<span class="comment"># kubectl get pv</span></span><br><span class="line"><span class="string">NAME</span>   <span class="string">CAPACITY</span>   <span class="string">ACCESS</span> <span class="string">MODES</span>   <span class="string">RECLAIM</span> <span class="string">POLICY</span>   <span class="string">STATUS</span>      <span class="string">CLAIM</span>   <span class="string">STORAGECLASS</span>   <span class="string">REASON</span>   <span class="string">AGE</span></span><br><span class="line"><span class="string">v1</span>     <span class="string">1Gi</span>        <span class="string">RWO</span>            <span class="string">Retain</span>           <span class="string">Available</span>                                   <span class="string">4m34s</span></span><br><span class="line"><span class="string">v10</span>    <span class="string">10Gi</span>       <span class="string">RWO,RWX</span>        <span class="string">Retain</span>           <span class="string">Available</span>                                   <span class="string">4m34s</span></span><br><span class="line"><span class="string">v2</span>     <span class="string">2Gi</span>        <span class="string">RWX</span>            <span class="string">Retain</span>           <span class="string">Available</span>                                   <span class="string">4m34s</span></span><br><span class="line"><span class="string">v3</span>     <span class="string">3Gi</span>        <span class="string">RWX</span>            <span class="string">Retain</span>           <span class="string">Available</span>                                   <span class="string">4m34s</span></span><br><span class="line"><span class="string">v4</span>     <span class="string">4Gi</span>        <span class="string">RWO,RWX</span>        <span class="string">Retain</span>           <span class="string">Available</span>                                   <span class="string">4m34s</span></span><br><span class="line"><span class="string">v5</span>     <span class="string">5Gi</span>        <span class="string">RWO,RWX</span>        <span class="string">Retain</span>           <span class="string">Available</span>                                   <span class="string">4m34s</span></span><br><span class="line"><span class="string">v6</span>     <span class="string">6Gi</span>        <span class="string">RWO,RWX</span>        <span class="string">Retain</span>           <span class="string">Available</span>                                   <span class="string">4m34s</span></span><br><span class="line"><span class="string">v7</span>     <span class="string">7Gi</span>        <span class="string">RWO,RWX</span>        <span class="string">Retain</span>           <span class="string">Available</span>                                   <span class="string">4m34s</span></span><br><span class="line"><span class="string">v8</span>     <span class="string">8Gi</span>        <span class="string">RWO,RWX</span>        <span class="string">Retain</span>           <span class="string">Available</span>                                   <span class="string">4m34s</span></span><br><span class="line"><span class="string">v9</span>     <span class="string">9Gi</span>        <span class="string">RWO,RWX</span>        <span class="string">Retain</span>           <span class="string">Available</span>                                   <span class="string">4m34s</span></span><br><span class="line"><span class="comment"># STATUS 是 Available，表示 pv 是可用的</span></span><br></pre></td></tr></table></figure>

<ul>
<li>创建 <code>pvc</code>，和符合条件的 <code>pv</code> 绑定</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PersistentVolumeClaim</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">my-pvc</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">accessModes:</span> [<span class="string">&quot;ReadWriteMany&quot;</span>]</span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">    <span class="attr">requests:</span></span><br><span class="line">      <span class="attr">storage:</span> <span class="string">2Gi</span></span><br><span class="line"></span><br><span class="line">[<span class="string">root@master1</span> <span class="string">~</span>]<span class="comment"># kubectl get pv</span></span><br><span class="line"><span class="string">NAME</span>   <span class="string">CAPACITY</span>   <span class="string">ACCESS</span> <span class="string">MODES</span>   <span class="string">RECLAIM</span> <span class="string">POLICY</span>   <span class="string">STATUS</span>      <span class="string">CLAIM</span>            <span class="string">STORAGECLASS</span>   <span class="string">REASON</span>   <span class="string">AGE</span></span><br><span class="line"><span class="string">v2</span>     <span class="string">2Gi</span>        <span class="string">RWX</span>            <span class="string">Retain</span>           <span class="string">Bound</span>       <span class="string">default/my-pvc</span>                           <span class="string">7m42s</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># STATUS 是 Bound，表示这个 pv 已经被 my-pvc 绑定了</span></span><br><span class="line"></span><br><span class="line">[<span class="string">root@master1</span> <span class="string">~</span>]<span class="comment"># kubectl get pvc</span></span><br><span class="line"><span class="string">NAME</span>     <span class="string">STATUS</span>   <span class="string">VOLUME</span>   <span class="string">CAPACITY</span>   <span class="string">ACCESS</span> <span class="string">MODES</span>   <span class="string">STORAGECLASS</span>   <span class="string">AGE</span></span><br><span class="line"><span class="string">my-pvc</span>   <span class="string">Bound</span>    <span class="string">v2</span>       <span class="string">2Gi</span>        <span class="string">RWX</span>                           <span class="string">57s</span></span><br></pre></td></tr></table></figure>

<ul>
<li>创建 pod 挂载 pvc</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">pgd-pvc</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">volumeMounts:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nginx-html</span></span><br><span class="line">      <span class="attr">mountPath:</span> <span class="string">/usr/share/nginx/html</span></span><br><span class="line">  <span class="attr">volumes:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nginx-html</span></span><br><span class="line">    <span class="attr">persistentVolumeClaim:</span></span><br><span class="line">      <span class="attr">claimName:</span> <span class="string">my-pvc</span></span><br><span class="line"></span><br><span class="line">[<span class="string">root@master1</span> <span class="string">~</span>]<span class="comment"># kubectl get pods</span></span><br><span class="line"><span class="string">NAME</span>      <span class="string">READY</span>   <span class="string">STATUS</span>    <span class="string">RESTARTS</span>   <span class="string">AGE</span></span><br><span class="line"><span class="string">pgd-pvc</span>   <span class="number">1</span><span class="string">/1</span>     <span class="string">Running</span>   <span class="number">0</span>          <span class="string">31s</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>注：使用 pvc 和 pv 的注意事项 </p>
<p>1、每次创建 pvc 的时候，需要事先有划分好的 pv，这样可能不方便，那么可以在创建 pvc 的时候直接动态创建一个 pv 这个存储类，pv 事先是不存在的</p>
<p>2、pvc 和 pv 绑定，如果使用默认的回收策略 retain，那么删除 pvc 之后，pv 会处于 released 状态，我们想要继续使用这个 pv，需要手动删除 pv，kubectl delete pv pv_name，删除 pv，不会删除 pv 里的数据，当我们重新创建 pvc 时还会和这个最匹配的 pv 绑定，数据还是原来数据，不会丢失。</p>
</blockquote>
<h2 id="k8s-存储类：storageclass"><a href="#k8s-存储类：storageclass" class="headerlink" title="k8s 存储类：storageclass"></a>k8s 存储类：storageclass</h2><blockquote>
<p>上面介绍的 PV 和 PVC 模式都是需要先创建好 PV，然后定义好 PVC 和 pv 进行一对一的 Bond，但是如果 PVC 请求成千上万，那么就需要创建成千上万的 PV，对于运维人员来说维护成本很高，Kubernetes 提供一种自动创建 PV 的机制，叫 <code>StorageClass</code>，它的作用就是创建 PV 的模板。k8s 集群管理员通过创建 storageclass 可以动态生成一个存储卷 pv 供 k8s pvc 使用。</p>
</blockquote>
<blockquote>
<p>每个 StorageClass 都包含字段 provisioner，parameters 和 reclaimPolicy。 </p>
<p>具体来说，StorageClass 会定义以下两部分：<br>1、PV 的属性 ，比如存储的大小、类型等；<br>2、创建这种 PV 需要使用到的存储插件，比如 Ceph、NFS 等 </p>
<p>有了这两部分信息，Kubernetes 就能够根据用户提交的 PVC，找到对应的 StorageClass，然后Kubernetes 就会调用 StorageClass 声明的存储插件，创建出需要的 PV。 </p>
</blockquote>
<ul>
<li>查看定义 <code>storageclass</code> 需要的字段</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">[root@master1 ~]# kubectl explain storageclass</span><br><span class="line">KIND:     StorageClass</span><br><span class="line">VERSION:  storage.k8s.io/v1</span><br><span class="line"></span><br><span class="line">FIELDS:</span><br><span class="line">   allowVolumeExpansion	&lt;boolean&gt;</span><br><span class="line">   allowedTopologies	&lt;[]Object&gt;</span><br><span class="line">   apiVersion	&lt;string&gt;</span><br><span class="line">   kind	&lt;string&gt;</span><br><span class="line">   metadata	&lt;Object&gt;</span><br><span class="line">   mountOptions	&lt;[]string&gt;</span><br><span class="line">   parameters	&lt;map[string]string&gt;</span><br><span class="line">   provisioner	&lt;string&gt; -required-</span><br><span class="line">   reclaimPolicy	&lt;string&gt;</span><br><span class="line">   volumeBindingMode	&lt;string&gt;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">provisioner：供应商，storageclass 需要有一个供应者，用来确定我们使用什么样的存储来创建 pv</span></span><br></pre></td></tr></table></figure>

<ul>
<li>常见的 provisioner 如下：<a target="_blank" rel="noopener" href="https://kubernetes.io/zh/docs/concepts/storage/storage-classes/">https://kubernetes.io/zh/docs/concepts/storage/storage-classes/</a></li>
</ul>
<p><img src="../../../../images/image/k8s-han/26.png" alt="26"></p>
<blockquote>
<p>provisioner 既可以由内部供应商提供，也可以由外部供应商提供，如果是外部供应商可以参考：<a target="_blank" rel="noopener" href="https://github.com/kubernetes-incubator/external-storage/%E4%B8%8B%E6%8F%90%E4%BE%9B%E7%9A%84%E6%96%B9%E6%B3%95%E5%88%9B%E5%BB%BA%E3%80%82">https://github.com/kubernetes-incubator/external-storage/下提供的方法创建。</a> </p>
</blockquote>
<blockquote>
<p>以 NFS 为例，要想使用 NFS，我们需要一个 nfs-client 的自动装载程序，称之为 provisioner，这个程序会使用我们已经配置好的 NFS 服务器自动创建持久卷，也就是自动帮我们创建 PV。  </p>
</blockquote>
<blockquote>
<p><code>reclaimPolicy</code>：回收策略</p>
<p><code>allowVolumeExpansion</code>：允许卷扩展，<code>PersistentVolume</code> 可以配置成可扩展。将此功能设置为 true时，允许用户通过编辑相应的 PVC 对象来调整卷大小。当基础存储类的 <code>allowVolumeExpansion</code> 字段设置为 true 时，以下类型的卷支持卷扩展。 </p>
</blockquote>
<p><img src="../../../../images/image/k8s-han/27.png" alt="27"></p>
<blockquote>
<p>注意：此功能仅用于扩容卷，不能用于缩小卷。</p>
</blockquote>
<ul>
<li>安装 <code>nfs provisioner</code> 用于配置存储类动态生成 pv</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 把 nfs-subdir-external-provisioner.tar.gz 上传到 node2 和 node1 上，手动解压</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="number">1</span><span class="string">.创建运行</span> <span class="string">nfs-provisioner</span> <span class="string">需要的</span> <span class="string">sa</span> <span class="string">账号</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nfs-provisioner</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 扩展：什么是 sa？ </span></span><br><span class="line"><span class="comment"># sa 的全称是 serviceaccount。 </span></span><br><span class="line"><span class="comment"># serviceaccount 是为了方便 Pod 里面的进程调用 Kubernetes API 或其他外部服务而设计的。 </span></span><br><span class="line"><span class="comment"># 指定了 serviceaccount 之后，我们把 pod 创建出来了，我们在使用这个 pod 时，这个 pod 就有了指定的账户的权限了。</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># pod 默认的 sa 是没有权限对 k8s 集群做任何操作，因为 nfs 驱动运行在 pod 中，需要一个授予了与 k8s apiserver 交互的权限，来创建 pv</span></span><br><span class="line"></span><br><span class="line"><span class="number">2</span><span class="string">.对</span> <span class="string">sa</span> <span class="string">授权</span></span><br><span class="line">[<span class="string">root@master1</span> <span class="string">~</span>]<span class="comment"># kubectl create clusterrolebinding nfs-provisioner-clusterrolebingding --clusterrole=cluster-admin --serviceaccount=default:nfs-provisioner</span></span><br><span class="line"></span><br><span class="line"><span class="number">3</span><span class="string">.安装</span> <span class="string">nfs-provisioner</span> <span class="string">程序</span></span><br><span class="line">[<span class="string">root@master1</span> <span class="string">~</span>]<span class="comment"># mkdir /data/nfs_pro</span></span><br><span class="line"></span><br><span class="line">[<span class="string">root@master1</span> <span class="string">~</span>]<span class="comment"># vim /etc/exports</span></span><br><span class="line"><span class="string">/data/nfs_pro</span> <span class="number">192.168</span><span class="number">.1</span><span class="number">.0</span><span class="string">/24(rw,no_root_squash)</span></span><br><span class="line"></span><br><span class="line">[<span class="string">root@master1</span> <span class="string">~</span>]<span class="comment"># exportfs -arv</span></span><br><span class="line"></span><br><span class="line">[<span class="string">root@master1</span> <span class="string">~</span>]<span class="comment"># cat storageclass/nfs-deployment.yaml</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nfs-provisioner</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">nfs-provisioner</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">strategy:</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">Recreate</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">nfs-provisioner</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">serviceAccount:</span> <span class="string">nfs-provisioner</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nfs-provisioner</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">registry.cn-beijing.aliyuncs.com/mydlq/nfs-subdir-external-provisioner:v4.0.0</span></span><br><span class="line">        <span class="attr">volumeMounts:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nfs-client-root</span></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/persistentvolumes</span></span><br><span class="line">        <span class="attr">env:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">PROVISIONER_NAME</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">example.com/nfs</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">NFS_SERVER</span></span><br><span class="line">          <span class="attr">value:</span> <span class="number">192.168</span><span class="number">.1</span><span class="number">.180</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">NFS_PATH</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">/data/nfs_pro</span></span><br><span class="line">      <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nfs-client-root</span></span><br><span class="line">        <span class="attr">nfs:</span></span><br><span class="line">          <span class="attr">server:</span> <span class="number">192.168</span><span class="number">.1</span><span class="number">.180</span></span><br><span class="line">          <span class="attr">path:</span> <span class="string">/data/nfs_pro</span></span><br><span class="line"></span><br><span class="line">[<span class="string">root@master1</span> <span class="string">~</span>]<span class="comment"># kubectl get pods</span></span><br><span class="line"><span class="string">NAME</span>                              <span class="string">READY</span>   <span class="string">STATUS</span>    <span class="string">RESTARTS</span>   <span class="string">AGE</span></span><br><span class="line"><span class="string">nfs-provisioner-cd8bf8889-gb2ft</span>   <span class="number">1</span><span class="string">/1</span>     <span class="string">Running</span>   <span class="number">0</span>          <span class="string">22s</span></span><br></pre></td></tr></table></figure>

<ul>
<li>创建 <code>storageclass</code>，动态供给 pv</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">storage.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">StorageClass</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nfs</span></span><br><span class="line"><span class="attr">provisioner:</span> <span class="string">example.com/nfs</span>	<span class="comment"># 内部 kubernetes.io 开头</span></span><br><span class="line"></span><br><span class="line">[<span class="string">root@master1</span> <span class="string">~</span>]<span class="comment"># kubectl get storageclasses</span></span><br><span class="line"><span class="string">NAME</span>   <span class="string">PROVISIONER</span>       <span class="string">RECLAIMPOLICY</span>   <span class="string">VOLUMEBINDINGMODE</span>   <span class="string">ALLOWVOLUMEEXPANSION</span>   <span class="string">AGE</span></span><br><span class="line"><span class="string">nfs</span>    <span class="string">example.com/nfs</span>   <span class="string">Delete</span>          <span class="string">Immediate</span>           <span class="literal">false</span>                  <span class="string">17s</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 注意：provisioner 处写的 example.com/nfs 应该跟安装 nfs provisioner 时候的 env 下的 PROVISIONER_NAME 的 value 值保持一致，如下： </span></span><br><span class="line"><span class="attr">env:</span> </span><br><span class="line"> <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">PROVISIONER_NAME</span> </span><br><span class="line">   <span class="attr">value:</span> <span class="string">example.com/nfs</span></span><br></pre></td></tr></table></figure>

<ul>
<li>创建 pvc，通过 storageclass 动态生成 pv</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PersistentVolumeClaim</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">test-claim1</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">accessModes:</span> [<span class="string">&quot;ReadWriteMany&quot;</span>]</span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">    <span class="attr">requests:</span></span><br><span class="line">      <span class="attr">storage:</span> <span class="string">1Gi</span></span><br><span class="line">  <span class="attr">storageClassName:</span> <span class="string">nfs</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看是否动态生成了 pv，pvc 是否创建成功，并和 pv 绑定</span></span><br><span class="line">[<span class="string">root@master1</span> <span class="string">~</span>]<span class="comment"># kubectl get pvc</span></span><br><span class="line"><span class="string">NAME</span>          <span class="string">STATUS</span>   <span class="string">VOLUME</span>                                     <span class="string">CAPACITY</span>   <span class="string">ACCESS</span> <span class="string">MODES</span>   <span class="string">STORAGECLASS</span>   <span class="string">AGE</span></span><br><span class="line"><span class="string">test-claim1</span>   <span class="string">Bound</span>    <span class="string">pvc-42b53b60-30b0-4e74-9f40-0f86aa8c5ef8</span>   <span class="string">1Gi</span>        <span class="string">RWX</span>            <span class="string">nfs</span>            <span class="string">18s</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 通过上面可以看到 test-claim1 的 pvc 已经成功创建了，绑定的 pv 是 pvc-42b53b60-30b0-4e74-9f40-0f86aa8c5ef8，这个 pv 是由 storageclass 调用 nfs provisioner 自动生成的。</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>步骤总结：</p>
<p>1.供应商：创建一个 nfs provisioner<br>2.创建 storageclass，storageclass 指定刚才创建的供应商<br>3.创建 pvc，这个 pvc 指定 storageclass</p>
</blockquote>
<ul>
<li>创建 pod，挂载 storageclass 动态生成的 pvc</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">read-pod</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">read-pod</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">volumeMounts:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nfs-pvc</span></span><br><span class="line">      <span class="attr">mountPath:</span> <span class="string">/usr/share/nginx/html</span></span><br><span class="line">  <span class="attr">restartPolicy:</span> <span class="string">&quot;Never&quot;</span></span><br><span class="line">  <span class="attr">volumes:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nfs-pvc</span></span><br><span class="line">    <span class="attr">persistentVolumeClaim:</span></span><br><span class="line">      <span class="attr">claimName:</span> <span class="string">test-claim1</span></span><br><span class="line"></span><br><span class="line">[<span class="string">root@master1</span> <span class="string">~</span>]<span class="comment"># kubectl get pods read-pod </span></span><br><span class="line"><span class="string">NAME</span>       <span class="string">READY</span>   <span class="string">STATUS</span>    <span class="string">RESTARTS</span>   <span class="string">AGE</span></span><br><span class="line"><span class="string">read-pod</span>   <span class="number">1</span><span class="string">/1</span>     <span class="string">Running</span>   <span class="number">0</span>          <span class="string">40s</span></span><br></pre></td></tr></table></figure>

<ul>
<li>默认回收策略是 delete，删除 pvc 后 pv 也会被删除，修改为ratain</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 修改 storageclass</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">storage.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">StorageClass</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nfs</span></span><br><span class="line"><span class="attr">provisioner:</span> <span class="string">example.com/nfs</span></span><br><span class="line"><span class="attr">reclaimPolicy:</span> <span class="string">Retain</span></span><br></pre></td></tr></table></figure>

<h1 id="k8s-控制器：StatefulSet"><a href="#k8s-控制器：StatefulSet" class="headerlink" title="k8s 控制器：StatefulSet"></a>k8s 控制器：StatefulSet</h1><h2 id="概念、原理解读-1"><a href="#概念、原理解读-1" class="headerlink" title="概念、原理解读"></a>概念、原理解读</h2><ul>
<li><code>StatefulSet</code> 是为了管理有状态服务的问题而设计的</li>
</ul>
<blockquote>
<p>扩展：</p>
<p>有状态服务？<br><code>StatefulSet</code> 是有状态的集合，管理有状态的服务，它所管理的 Pod 的名称不能随意变化。数据持久化的目录也是不一样，每一个 Pod 都有自己独有的数据持久化存储目录。比如 MySQL 主从、redis 集群等。</p>
<p>无状态服务？<br><code>RC</code>、<code>Deployment</code>、<code>DaemonSet</code> 都是管理无状态的服务，它们所管理的 Pod 的 IP、名字，启停顺序等都是随机的。个体对整体无影响，所有 pod 都是共用一个数据卷的，部署的 tomcat 就是无状态的服务，tomcat 被删除，在启动一个新的 tomcat，加入到集群即可，跟 tomcat 的名字无关。</p>
</blockquote>
<p><em><code>StatefulSet</code> 由以下几个部分组成</em></p>
<ol>
<li><p><code>Headless Service</code>：用来定义 pod 网路标识，生成可解析的 DNS 记录</p>
</li>
<li><p><code>volumeClaimTemplates</code>：存储卷申请模板，创建 pvc，指定 pvc 名称大小，自动创建pvc，且 pvc 由存储类供应。</p>
</li>
<li><p><code>StatefulSet</code>：管理 pod 的</p>
</li>
</ol>
<blockquote>
<p>扩展：什么是 Headless service?</p>
<p>Headless service 不分配 clusterIP，headless service 可以通过解析 service 的 DNS，返回所有 Pod 的 dns 和 ip 地址 (statefulSet 部署的 Pod 才有 DNS)，普通的 service，只能通过解析service 的 DNS 返回 service 的 ClusterIP。</p>
<p>为什么要用 headless service（<code>没有 service ip 的 service</code>）？</p>
<p>在使用 <code>Deployment</code> 时，创建的 Pod 名称是没有顺序的，是随机字符串，在用 <code>statefulset</code> 管理 pod 时要求 pod 名称必须是有序的 ，每一个 pod 不能被随意取代，pod 重建后 pod 名称还是一样的。因为 pod IP 是变化的，所以要用 Pod 名称来识别。<code>pod 名称是 pod 唯一性的标识符，必须持久稳定有效</code>。这时候要用到无头服务，它可以给每个 Pod 一个唯一的名称。</p>
</blockquote>
<ol>
<li>headless service 会为 service 分配一个域名</li>
</ol>
<ul>
<li>&lt;service name&gt;.$&lt;namespace name&gt;.svc.cluster.local</li>
</ul>
<p><em><code>K8s 中资源的全局 FQDN 格式</code></em></p>
<ul>
<li><code>Service_NAME.NameSpace_NAME.Domain.LTD.</code></li>
<li><code>Domain.LTD.=svc.cluster.local.</code> 这是默认 k8s 集群的域名。</li>
</ul>
<blockquote>
<p>FQDN 全称 Fully Qualified Domain Name，即全限定域名：同时带有主机名和域名的名称<br>FQDN = Hostname + DomainName</p>
<p>如主机名是 master，域名是 baidu.com<br>FQDN= master.baidu.com</p>
</blockquote>
<ol start="2">
<li><code>StatefulSet</code> 会为关联的 Pod 保持一个不变的 Pod Name</li>
</ol>
<ul>
<li>statefulset 中 Pod 的名字格式为<code>$(StatefulSet name)-$(pod 序号)</code></li>
</ul>
<ol start="3">
<li><code>StatefulSet</code> 会为关联的 Pod 分配一个 <code>dnsName</code></li>
</ol>
<ul>
<li><code>$&lt;Pod Name&gt;.$&lt;service name&gt;.$&lt;namespace name&gt;.svc.cluster.local</code></li>
</ul>
<blockquote>
<p>为什么要用 <code>volumeClaimTemplate</code>？</p>
<p>对于有状态应用都会用到持久化存储，比如 mysql 主从，由于主从数据库的数据是不能存放在一个目录下的，每个 mysql 节点都需要有自己独立的存储空间。而在 deployment 中创建的存储卷是一个共享的存储卷，多个 pod 使用同一个存储卷，它们数据是同步的，而 <code>statefulset</code> 定义中的每一个 pod 都不能使用同一个存储卷，这就需要使用 <code>volumeClainTemplate</code>，当在使用 statefulset 创建 pod 时，volumeClainTemplate 会自动生成一个 PVC，从而请求绑定一个 PV，每一个 pod 都有自己专用的存储卷。</p>
</blockquote>
<ul>
<li>Pod、PVC 和 PV 对应的关系图</li>
</ul>
<p><img src="../../../../images/image/k8s-han/28.jpg" alt="28"></p>
<h2 id="Statefulset-资源清单文件编写技巧"><a href="#Statefulset-资源清单文件编写技巧" class="headerlink" title="Statefulset 资源清单文件编写技巧"></a>Statefulset 资源清单文件编写技巧</h2><ul>
<li>查看 <code>statefulset</code> 资源需要的字段</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">[root@master1 ~]# kubectl explain statefulset</span><br><span class="line">KIND:     StatefulSet</span><br><span class="line">VERSION:  apps/v1</span><br><span class="line"></span><br><span class="line">DESCRIPTION:</span><br><span class="line">     StatefulSet represents a set of pods with consistent identities. Identities</span><br><span class="line">     are defined as:</span><br><span class="line">     - Network: A single stable DNS and hostname.</span><br><span class="line">     - Storage: As many VolumeClaims as requested. The StatefulSet guarantees</span><br><span class="line">     that a given network identity will always map to the same storage identity.</span><br><span class="line"></span><br><span class="line">FIELDS:</span><br><span class="line">   apiVersion	&lt;string&gt;</span><br><span class="line">   kind	&lt;string&gt;</span><br><span class="line">   metadata	&lt;Object&gt;</span><br><span class="line">   spec	&lt;Object&gt;</span><br><span class="line">   status	&lt;Object&gt;</span><br></pre></td></tr></table></figure>

<ul>
<li>查看 <code>statefulset.spec</code> 字段</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">[root@master1 ~]# kubectl explain statefulset.spec</span><br><span class="line">KIND:     StatefulSet</span><br><span class="line">VERSION:  apps/v1</span><br><span class="line"></span><br><span class="line">RESOURCE: spec &lt;Object&gt;</span><br><span class="line"></span><br><span class="line">DESCRIPTION:</span><br><span class="line">     Spec defines the desired identities of pods in this set.</span><br><span class="line"></span><br><span class="line">     A StatefulSetSpec is the specification of a StatefulSet.</span><br><span class="line"></span><br><span class="line">FIELDS:</span><br><span class="line">   podManagementPolicy	&lt;string&gt;	# pod 管理策略</span><br><span class="line">   replicas	&lt;integer&gt;				# 副本数</span><br><span class="line">   revisionHistoryLimit	&lt;integer&gt;	# 保留的历史版本</span><br><span class="line">   selector	&lt;Object&gt; -required-		# 标签选择器，选择关联的 pod</span><br><span class="line">   serviceName	&lt;string&gt; -required-	# headless service 的名字</span><br><span class="line">   template	&lt;Object&gt; -required-		# 生成 pod 的模板</span><br><span class="line">   updateStrategy	&lt;Object&gt;		# 更新策略</span><br><span class="line">   volumeClaimTemplates	&lt;[]Object&gt;	# 存储卷申请模板</span><br></pre></td></tr></table></figure>

<ul>
<li>查看 <code>statefulset.spec.template</code>  字段</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">对于 template 而言，其内部定义的就是 pod，pod 模板是一个独立的对象</span></span><br><span class="line"></span><br><span class="line">[root@master1 ~]# kubectl explain statefulset.spec.template</span><br><span class="line">KIND:     StatefulSet</span><br><span class="line">VERSION:  apps/v1</span><br><span class="line">RESOURCE: template &lt;Object&gt;</span><br><span class="line">DESCRIPTION:</span><br><span class="line">     template is the object that describes the pod that will be created if</span><br><span class="line">     insufficient replicas are detected. Each pod stamped out by the StatefulSet</span><br><span class="line">     will fulfill this Template, but have a unique identity from the rest of the</span><br><span class="line">     StatefulSet.</span><br><span class="line">     PodTemplateSpec describes the data a pod should have when created from a</span><br><span class="line">     template</span><br><span class="line"></span><br><span class="line">FIELDS:</span><br><span class="line">   metadata	&lt;Object&gt;</span><br><span class="line">   spec	&lt;Object&gt;	# 定义容器属性</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">通过上面可以看到，statefulset 资源中有两个 spec 字段。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">第一个 spec 声明的是 statefulset 定义多少个 Pod 副本（默认将仅部署 1 个 Pod）、匹配 Pod 标签的选择器、创建 pod 的模板、存储卷申请模板。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">第二个 spec 是 spec.template.spec：主要用于 Pod 里的容器属性等配置。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">.spec.template 里的内容是声明 Pod 对象时要定义的各种属性，所以这部分也叫做 PodTemplate（Pod 模板）。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">还有一个值得注意的地方是：在.spec.selector 中定义的标签选择器必须能够匹配到 spec.template.metadata.labels 里定义的 Pod 标签，否则 Kubernetes 将不允许创建 statefulset。</span></span><br></pre></td></tr></table></figure>

<h2 id="Statefulset-使用案例：部署-web-站点"><a href="#Statefulset-使用案例：部署-web-站点" class="headerlink" title="Statefulset 使用案例：部署 web 站点"></a>Statefulset 使用案例：部署 web 站点</h2><ul>
<li>创建存储类</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">storage.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">StorageClass</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nfs-web</span></span><br><span class="line"><span class="attr">provisioner:</span> <span class="string">example.com/nfs</span></span><br></pre></td></tr></table></figure>

<ul>
<li>编写 statefulset 资源清单文件</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">  <span class="attr">clusterIP:</span> <span class="string">None</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">StatefulSet</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">web</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">serviceName:</span> <span class="string">&quot;nginx&quot;</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">2</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">nginx</span></span><br><span class="line">        <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">web</span></span><br><span class="line">          <span class="attr">containerPort:</span> <span class="number">80</span></span><br><span class="line">        <span class="attr">volumeMounts:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">www</span></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/ust/share/nginx/html</span></span><br><span class="line">  <span class="attr">volumeClaimTemplates:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">www</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">accessModes:</span> [<span class="string">&quot;ReadWriteOnce&quot;</span>]</span><br><span class="line">      <span class="attr">storageClassName:</span> <span class="string">&quot;nfs-web&quot;</span></span><br><span class="line">      <span class="attr">resources:</span></span><br><span class="line">        <span class="attr">requests:</span></span><br><span class="line">          <span class="attr">storage:</span> <span class="string">1Gi</span></span><br></pre></td></tr></table></figure>

<ul>
<li>查看</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">查看 statefulset</span></span><br><span class="line">[root@master1 ~]# kubectl get statefulsets.apps </span><br><span class="line">NAME   READY   AGE</span><br><span class="line">web    2/2     40s</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">查看 pod</span></span><br><span class="line">[root@master1 ~]# kubectl get pods -l app=nginx</span><br><span class="line">NAME    READY   STATUS    RESTARTS   AGE</span><br><span class="line">web-0   1/1     Running   0          67s</span><br><span class="line">web-1   1/1     Running   0          54s</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">查看 headless service</span></span><br><span class="line">[root@master1 ~]# kubectl get svc -l app=nginx</span><br><span class="line">NAME    TYPE        CLUSTER-IP   EXTERNAL-IP   PORT(S)   AGE</span><br><span class="line">nginx   ClusterIP   None         &lt;none&gt;        80/TCP    7m40s</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">查看 pvc</span></span><br><span class="line">[root@master1 ~]# kubectl get pvc </span><br><span class="line">NAME          STATUS   VOLUME                                     CAPACITY   ACCESS MODES   STORAGECLASS   AGE</span><br><span class="line">www-web-0     Bound    pvc-f41837a4-ad51-4193-aac4-b47b4214c02a   1Gi        RWO            nfs-web        114s</span><br><span class="line">www-web-1     Bound    pvc-702c097e-dbb8-4433-a735-3830e6e27e9a   1Gi        RWO            nfs-web        101s</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">查看 pv</span></span><br><span class="line">[root@master1 ~]# kubectl get pv</span><br><span class="line">NAME                                       CAPACITY   ACCESS MODES   RECLAIM POLICY   STATUS      CLAIM                 STORAGECLASS   REASON   AGE</span><br><span class="line">pvc-702c097e-dbb8-4433-a735-3830e6e27e9a   1Gi        RWO            Delete           Bound       default/www-web-1     nfs-web                 2m15s</span><br><span class="line">pvc-f41837a4-ad51-4193-aac4-b47b4214c02a   1Gi        RWO            Delete           Bound       default/www-web-0     nfs-web</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">查看 pod 主机名</span></span><br><span class="line">[root@master1 ~]# for i in 0 1;do kubectl exec web-$i -- sh -c &quot;hostname&quot;;done</span><br><span class="line">web-0</span><br><span class="line">web-1</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">使用 kubectl run 运行一个提供 nslookup 命令的容器的，这个命令来自于 dnsutils 包，通过对 pod 主机名执行 nslookup，可以检查它们在集群内部的 DNS 地址</span></span><br><span class="line">[root@master1 ~]# kubectl exec -it web-1 -- /bin/bash</span><br><span class="line">root@web-1:/# apt-get update</span><br><span class="line">root@web-1:/# apt-get install dnsutils -y</span><br><span class="line"></span><br><span class="line">root@web-1:/# nslookup web-0.nginx.default.svc.cluster.local</span><br><span class="line">Server:		10.96.0.10</span><br><span class="line">Address:	10.96.0.10#53</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">statefulset 创建的 pod 也是有 dns 记录的</span></span><br><span class="line">Name:	web-0.nginx.default.svc.cluster.local</span><br><span class="line">Address: 10.244.166.148	# 解析的是 pod 的 ip</span><br><span class="line"></span><br><span class="line">root@web-1:/# nslookup nginx.default.svc.cluster.local</span><br><span class="line">Server:		10.96.0.10	# 查询 service dns，会把对应的 pod ip 解析出来</span><br><span class="line">Address:	10.96.0.10#53</span><br><span class="line"></span><br><span class="line">Name:	nginx.default.svc.cluster.local</span><br><span class="line">Address: 10.244.166.148</span><br><span class="line">Name:	nginx.default.svc.cluster.local</span><br><span class="line">Address: 10.244.104.12</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">root@web-1:/# dig -t A nginx.default.svc.cluster.local @10.96.0.10</span><br><span class="line"></span><br><span class="line">; &lt;&lt;&gt;&gt; DiG 9.16.42-Debian &lt;&lt;&gt;&gt; -t A nginx.default.svc.cluster.local @10.96.0.10</span><br><span class="line">;; global options: +cmd</span><br><span class="line">;; Got answer:</span><br><span class="line">;; WARNING: .local is reserved for Multicast DNS</span><br><span class="line">;; You are currently testing what happens when an mDNS query is leaked to DNS</span><br><span class="line">;; -&gt;&gt;HEADER&lt;&lt;- opcode: QUERY, status: NOERROR, id: 33624</span><br><span class="line">;; flags: qr aa rd; QUERY: 1, ANSWER: 2, AUTHORITY: 0, ADDITIONAL: 1</span><br><span class="line">;; WARNING: recursion requested but not available</span><br><span class="line"></span><br><span class="line">;; OPT PSEUDOSECTION:</span><br><span class="line">; EDNS: version: 0, flags:; udp: 4096</span><br><span class="line">; COOKIE: 780d6610adb0a779 (echoed)</span><br><span class="line">;; QUESTION SECTION:</span><br><span class="line">;nginx.default.svc.cluster.local. IN	A</span><br><span class="line"></span><br><span class="line">;; ANSWER SECTION:</span><br><span class="line">nginx.default.svc.cluster.local. 30 IN	A	10.244.104.12</span><br><span class="line">nginx.default.svc.cluster.local. 30 IN	A	10.244.166.148</span><br><span class="line"></span><br><span class="line">;; Query time: 25 msec</span><br><span class="line">;; SERVER: 10.96.0.10#53(10.96.0.10)</span><br><span class="line">;; WHEN: Tue Aug 01 10:12:58 UTC 2023</span><br><span class="line">;; MSG SIZE  rcvd: 166</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">dig 的使用</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">dig -t A nginx.default.svc.cluster.local @10.96.0.10</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">格式如下：</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">@来指定域名服务器</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">A 为解析类型 ，A 记录</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">-t 指定要解析的类型</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">A 记录：</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">A 记录是解析域名到 IP</span></span><br></pre></td></tr></table></figure>

<ul>
<li>service 和 headless service 区别</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">创建一个 <span class="built_in">type</span> 为 clusterip 的 service，并绑定 pod</span></span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  name: test</span><br><span class="line">  labels:</span><br><span class="line">    app: test</span><br><span class="line">spec:</span><br><span class="line">  selector:</span><br><span class="line">    app: test</span><br><span class="line">  ports:</span><br><span class="line">  - port: 80</span><br><span class="line">  type: ClusterIP</span><br><span class="line">---</span><br><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: test</span><br><span class="line">spec:</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: test</span><br><span class="line">  replicas: 2</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: test</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - name: test</span><br><span class="line">        image: nginx</span><br><span class="line">        imagePullPolicy: IfNotPresent</span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: 80</span><br><span class="line"></span><br><span class="line">[root@master1 ~]# kubectl get pods -o wide -l app=test</span><br><span class="line">NAME                    READY   STATUS    RESTARTS   AGE   IP               NODE    NOMINATED NODE   READINESS GATES</span><br><span class="line">test-59d44ff467-hrz92   1/1     Running   0          45s   10.244.166.152   node1   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">test-59d44ff467-jp8k5   1/1     Running   0          45s   10.244.104.13    node2   &lt;none&gt;           &lt;none&gt;</span><br><span class="line"></span><br><span class="line">[root@master1 ~]# kubectl get svc -l app=test</span><br><span class="line">NAME   TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)   AGE</span><br><span class="line">test   ClusterIP   10.111.14.127   &lt;none&gt;        80/TCP    55s</span><br><span class="line"></span><br><span class="line">[root@master1 ~]# kubectl exec -it web-1 -- /bin/bash</span><br><span class="line"></span><br><span class="line">root@web-1:/# nslookup test.default.svc.cluster.local</span><br><span class="line">Server:		10.96.0.10</span><br><span class="line">Address:	10.96.0.10#53</span><br><span class="line"></span><br><span class="line">Name:	test.default.svc.cluster.local</span><br><span class="line">Address: 10.111.14.127	# 解析的是 service 的 ip 地址</span><br></pre></td></tr></table></figure>

<h2 id="Statefulset-管理-pod：扩容、缩容、更新"><a href="#Statefulset-管理-pod：扩容、缩容、更新" class="headerlink" title="Statefulset 管理 pod：扩容、缩容、更新"></a>Statefulset 管理 pod：扩容、缩容、更新</h2><ul>
<li>Statefulset 实现 pod 的动态扩容</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">可以直接修改 statefulset.yaml 里的 replicas 的值</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">也可以直接编辑控制器实现扩容</span></span><br><span class="line">[root@master1 ~]# kubectl edit sts web</span><br><span class="line">replicas: 4</span><br><span class="line"></span><br><span class="line">[root@master1 ~]# kubectl get pods -l app=nginx</span><br><span class="line">NAME    READY   STATUS    RESTARTS   AGE</span><br><span class="line">web-0   1/1     Running   0          16h</span><br><span class="line">web-1   1/1     Running   0          16h</span><br><span class="line">web-2   1/1     Running   0          50s</span><br><span class="line">web-3   1/1     Running   0          24s</span><br></pre></td></tr></table></figure>

<ul>
<li>Statefulset 实现 pod 的动态缩容</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">可以直接修改 statefulset.yaml 里的 replicas 的值</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">也可以直接编辑控制器实现扩容</span></span><br><span class="line">replicas: 2</span><br><span class="line"></span><br><span class="line">[root@master1 ~]# kubectl get pods -l app=nginx</span><br><span class="line">NAME    READY   STATUS    RESTARTS   AGE</span><br><span class="line">web-0   1/1     Running   0          16h</span><br><span class="line">web-1   1/1     Running   0          16h</span><br></pre></td></tr></table></figure>

<ul>
<li>Statefulset 实现 pod 的更新</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">修改镜像 nginx 变成- image: ikubernetes/myapp:v2，修改之后保存退出</span></span><br><span class="line">[root@master1 ~]# kubectl edit sts web</span><br><span class="line">image: ikubernetes/myapp:v2</span><br><span class="line"></span><br><span class="line">[root@master1 ~]# kubectl get pods -l app=nginx -o wide</span><br><span class="line">NAME    READY   STATUS    RESTARTS   AGE   IP               NODE    NOMINATED NODE   READINESS GATES</span><br><span class="line">web-0   1/1     Running   0          37s   10.244.166.154   node1   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">web-1   1/1     Running   0          41s   10.244.104.15    node2   &lt;none&gt;           &lt;none&gt;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">查看 pod 详细信息</span></span><br><span class="line">[root@master1 ~]# kubectl describe pods web-0</span><br><span class="line">    Image:          ikubernetes/myapp:v2</span><br></pre></td></tr></table></figure>

<h1 id="k8s-控制器：Daemonset"><a href="#k8s-控制器：Daemonset" class="headerlink" title="k8s 控制器：Daemonset"></a>k8s 控制器：Daemonset</h1><h2 id="DaemonSet-控制器：概念、原理解读"><a href="#DaemonSet-控制器：概念、原理解读" class="headerlink" title="DaemonSet 控制器：概念、原理解读"></a>DaemonSet 控制器：概念、原理解读</h2><ul>
<li>DaemonSet 概述</li>
</ul>
<blockquote>
<p>DaemonSet 控制器能够确保 k8s 集群所有的节点都运行一个相同的 pod 副本，当向 k8s 集群中增加 node 节点时，这个 node 节点也会自动创建一个 pod 副本，当 node 节点从集群移除，这些 pod 也会自动删除；删除 Daemonset 也会删除它们创建的 pod </p>
</blockquote>
<ul>
<li>DaemonSet 工作原理</li>
</ul>
<blockquote>
<p>如何管理 Pod</p>
<p>daemonset 的控制器会监听 kuberntes 的 daemonset 对象、pod 对象、node 对象，这些被监听的对象之变动，就会触发 syncLoop 循环让 kubernetes 集群朝着 daemonset 对象描述的状态进行演进。 </p>
</blockquote>
<ul>
<li>Daemonset 典型的应用场景</li>
</ul>
<blockquote>
<p>在集群的每个节点上运行存储，比如：glusterd 或 ceph。 </p>
<p>在每个节点上运行日志收集组件，比如：flunentd 、 logstash、filebeat 等。 </p>
<p>在每个节点上运行监控组件，比如：Prometheus、 Node Exporter 、collectd 等。</p>
</blockquote>
<ul>
<li>DaemonSet 与 Deployment 的区别</li>
</ul>
<blockquote>
<p>Deployment 部署的副本 Pod 会分布在各个 Node 上，每个 Node 都可能运行好几个副本。DaemonSet 的不同之处在于：每个 Node 上最多只能运行一个副本。</p>
</blockquote>
<h2 id="DaemonSet-资源清单文件编写技巧"><a href="#DaemonSet-资源清单文件编写技巧" class="headerlink" title="DaemonSet 资源清单文件编写技巧"></a>DaemonSet 资源清单文件编写技巧</h2><ul>
<li>查看定义<code>Daemonset</code>资源需要的字段</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[root@master1 ~]# kubectl explain ds</span><br><span class="line">KIND:     DaemonSet</span><br><span class="line">VERSION:  apps/v1</span><br><span class="line">DESCRIPTION:</span><br><span class="line">     DaemonSet represents the configuration of a daemon set.</span><br><span class="line"></span><br><span class="line">FIELDS:</span><br><span class="line">   apiVersion	&lt;string&gt;</span><br><span class="line">   kind	&lt;string&gt;</span><br><span class="line">   metadata	&lt;Object&gt;</span><br><span class="line">   spec	&lt;Object&gt;</span><br><span class="line">   status	&lt;Object&gt;</span><br></pre></td></tr></table></figure>

<ul>
<li>查看 <code>daemonset.spec</code> 字段</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">[root@master1 ~]# kubectl explain ds.spec</span><br><span class="line">KIND:     DaemonSet</span><br><span class="line">VERSION:  apps/v1</span><br><span class="line"></span><br><span class="line">RESOURCE: spec &lt;Object&gt;</span><br><span class="line"></span><br><span class="line">DESCRIPTION:</span><br><span class="line">     The desired behavior of this daemon set. More info:</span><br><span class="line">     https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#spec-and-status</span><br><span class="line"></span><br><span class="line">     DaemonSetSpec is the specification of a daemon set.</span><br><span class="line"></span><br><span class="line">FIELDS:</span><br><span class="line">   minReadySeconds	&lt;integer&gt;		# 当新的 pod 启动几秒后，再kill 掉旧的 pod</span><br><span class="line">   revisionHistoryLimit	&lt;integer&gt;	# 历史版本</span><br><span class="line">   selector	&lt;Object&gt; -required-</span><br><span class="line">   template	&lt;Object&gt; -required-</span><br><span class="line">   updateStrategy	&lt;Object&gt;		# daemonset 升级策略</span><br></pre></td></tr></table></figure>

<ul>
<li>查看 <code>ds.spec.template</code> 字段</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@master1 ~]# kubectl explain ds.spec.template</span><br><span class="line">KIND:     DaemonSet</span><br><span class="line">VERSION:  apps/v1</span><br><span class="line">RESOURCE: template &lt;Object&gt;</span><br><span class="line"></span><br><span class="line">FIELDS:</span><br><span class="line">   metadata	&lt;Object&gt;</span><br><span class="line">   spec	&lt;Object&gt;</span><br></pre></td></tr></table></figure>

<h2 id="DaemonSet-使用案例"><a href="#DaemonSet-使用案例" class="headerlink" title="DaemonSet 使用案例"></a>DaemonSet 使用案例</h2><ul>
<li>部署日志收集组件 fluentd</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">DaemonSet</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">fluentd-elasticsearch</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kube-system</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">k8s-app:</span> <span class="string">fluentd-logging</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">k8s-app:</span> <span class="string">fluentd-logging</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span> </span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">k8s-app:</span> <span class="string">fluentd-logging</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">tolerations:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">key:</span> <span class="string">node-role.kubernetes.io/master</span></span><br><span class="line">        <span class="attr">effect:</span> <span class="string">NoSchedule</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">fluentd-elasticsearch</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">xianchao/fluentd:v2.5.1</span></span><br><span class="line">        <span class="attr">resources:</span></span><br><span class="line">          <span class="attr">requests:</span></span><br><span class="line">            <span class="attr">cpu:</span> <span class="string">100m</span></span><br><span class="line">            <span class="attr">memory:</span> <span class="string">200Mi</span></span><br><span class="line">          <span class="attr">limits:</span></span><br><span class="line">            <span class="attr">memory:</span> <span class="string">200Mi</span></span><br><span class="line">        <span class="attr">volumeMounts:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">varlog</span></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/var/log</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">varlibdockercontainers</span></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/var/lib/docker/containers</span></span><br><span class="line">          <span class="attr">readOnly:</span> <span class="literal">true</span></span><br><span class="line">      <span class="attr">terminationGracePeriodSeconds:</span> <span class="number">30</span>	<span class="comment"># 优雅的关闭服务</span></span><br><span class="line">      <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">varlog</span></span><br><span class="line">        <span class="attr">hostPath:</span> </span><br><span class="line">          <span class="attr">path:</span> <span class="string">/var/log</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">varlibdockercontainers</span></span><br><span class="line">        <span class="attr">hostPath:</span></span><br><span class="line">          <span class="attr">path:</span> <span class="string">/var/lib/docker/containers</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看</span></span><br><span class="line">[<span class="string">root@master1</span> <span class="string">~</span>]<span class="comment"># kubectl get ds -n kube-system fluentd-elasticsearch</span></span><br><span class="line"><span class="string">NAME</span>                    <span class="string">DESIRED</span>   <span class="string">CURRENT</span>   <span class="string">READY</span>   <span class="string">UP-TO-DATE</span>   <span class="string">AVAILABLE</span>   <span class="string">NODE</span> <span class="string">SELECTOR</span>   <span class="string">AGE</span></span><br><span class="line"><span class="string">fluentd-elasticsearch</span>   <span class="number">3</span>         <span class="number">3</span>         <span class="number">3</span>       <span class="number">3</span>            <span class="number">3</span>           <span class="string">&lt;none&gt;</span>          <span class="string">38s</span></span><br><span class="line"></span><br><span class="line">[<span class="string">root@master1</span> <span class="string">~</span>]<span class="comment"># kubectl get pods -n kube-system -o wide -l k8s-app=fluentd-logging</span></span><br><span class="line"><span class="string">NAME</span>                          <span class="string">READY</span>   <span class="string">STATUS</span>    <span class="string">RESTARTS</span>   <span class="string">AGE</span>   <span class="string">IP</span>               <span class="string">NODE</span>      <span class="string">NOMINATED</span> <span class="string">NODE</span>   <span class="string">READINESS</span> <span class="string">GATES</span></span><br><span class="line"><span class="string">fluentd-elasticsearch-2lg85</span>   <span class="number">1</span><span class="string">/1</span>     <span class="string">Running</span>   <span class="number">0</span>          <span class="string">62s</span>   <span class="number">10.244</span><span class="number">.104</span><span class="number">.19</span>    <span class="string">node2</span>     <span class="string">&lt;none&gt;</span>           <span class="string">&lt;none&gt;</span></span><br><span class="line"><span class="string">fluentd-elasticsearch-n76zw</span>   <span class="number">1</span><span class="string">/1</span>     <span class="string">Running</span>   <span class="number">0</span>          <span class="string">62s</span>   <span class="number">10.244</span><span class="number">.137</span><span class="number">.67</span>    <span class="string">master1</span>   <span class="string">&lt;none&gt;</span>           <span class="string">&lt;none&gt;</span></span><br><span class="line"><span class="string">fluentd-elasticsearch-nkbx5</span>   <span class="number">1</span><span class="string">/1</span>     <span class="string">Running</span>   <span class="number">0</span>          <span class="string">62s</span>   <span class="number">10.244</span><span class="number">.166</span><span class="number">.156</span>   <span class="string">node1</span>     <span class="string">&lt;none&gt;</span>           <span class="string">&lt;none&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 通过上面可以看到在 k8s 的三个节点均创建了 fluentd 这个 pod </span></span><br><span class="line"><span class="comment"># pod 的名字是由控制器的名字-随机数组成的</span></span><br></pre></td></tr></table></figure>

<h2 id="Daemonset-管理-pod：滚动更新"><a href="#Daemonset-管理-pod：滚动更新" class="headerlink" title="Daemonset 管理 pod：滚动更新"></a>Daemonset 管理 pod：滚动更新</h2><ul>
<li>查看 <code>daemonset</code> 的滚动更新策略</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[root@master1 ~]# kubectl explain ds.spec.updateStrategy</span><br><span class="line">KIND:     DaemonSet</span><br><span class="line">VERSION:  apps/v1</span><br><span class="line">RESOURCE: updateStrategy &lt;Object&gt;</span><br><span class="line"></span><br><span class="line">FIELDS:</span><br><span class="line">   rollingUpdate	&lt;Object&gt;</span><br><span class="line">     Rolling update config params. Present only if type = &quot;RollingUpdate&quot;.</span><br><span class="line"></span><br><span class="line">   type	&lt;string&gt;</span><br><span class="line">     Type of daemon set update. Can be &quot;RollingUpdate&quot; or &quot;OnDelete&quot;. Default is</span><br><span class="line">     RollingUpdate.</span><br></pre></td></tr></table></figure>

<ul>
<li>查看 <code>rollingUpdate</code> 支持的更新策略</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">[root@master1 ~]# kubectl explain ds.spec.updateStrategy.rollingUpdate</span><br><span class="line">KIND:     DaemonSet</span><br><span class="line">VERSION:  apps/v1</span><br><span class="line"></span><br><span class="line">RESOURCE: rollingUpdate &lt;Object&gt;</span><br><span class="line"></span><br><span class="line">DESCRIPTION:</span><br><span class="line">     Rolling update config params. Present only if type = &quot;RollingUpdate&quot;.</span><br><span class="line"></span><br><span class="line">     Spec to control the desired behavior of daemon set rolling update.</span><br><span class="line"></span><br><span class="line">FIELDS:</span><br><span class="line">   maxUnavailable	&lt;string&gt;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">上面表示 rollingUpdate 更新策略只支持 maxUnavailabe，先删除再更新；因为我们不支持一个节点运行两个 pod，因此需要先删除一个，在更新一个。</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">更新镜像版本，可以按照如下方法：</span> </span><br><span class="line">kubectl set image daemonsets fluentd-elasticsearch fluentd-elasticsearch=ikubernetes/filebeat:5.6.6-alpine -n kube-system</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">第一个 fluentd-elasticsearch 为 daemonset 的名字</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">第二个 fluentd-elasticsearch 为 daemonset 中 container 的名字</span></span><br></pre></td></tr></table></figure>

<h1 id="配置管理中心-configmap"><a href="#配置管理中心-configmap" class="headerlink" title="配置管理中心 configmap"></a>配置管理中心 configmap</h1><h2 id="Configmap-概述"><a href="#Configmap-概述" class="headerlink" title="Configmap 概述"></a>Configmap 概述</h2><ul>
<li>什么是 Configmap</li>
</ul>
<blockquote>
<p>Configmap 是 k8s 中的资源对象，用于保存非机密性的配置的，数据可以用 key/value 键值对的形式保存，也可通过文件的形式保存。</p>
</blockquote>
<ul>
<li>Configmap 能解决哪些问题</li>
</ul>
<blockquote>
<p>我们在部署服务的时候，每个服务都有自己的配置文件，如果一台服务器上部署多个服务：nginx、tomcat、apache 等，那么这些配置都存在这个节点上，假如一台服务器不能满足线上高并发的要求，需要对服务器扩容，扩容之后的服务器还是需要部署多个服务：nginx、tomcat、apache，新增加的服务器上还是要管理这些服务的配置，如果有一个服务出现问题，需要修改配置文件，每台物理节点上的配置都需要修改，这种方式肯定满足不了线上大批量的配置变更要求。 所以，k8s 中引入了 Configmap 资源对象，可以当成 volume 挂载到 pod 中，<code>实现统一的配置管理</code>。 </p>
</blockquote>
<p><img src="../../../../images/image/k8s-han/28.png" alt="28"></p>
<ol>
<li><p>Configmap 是 k8s 中的资源， 相当于配置文件，可以有一个或者多个 Configmap； </p>
</li>
<li><p>Configmap 可以做成 Volume，k8s pod 启动之后，通过 volume 形式映射到容器内部指定目录上； </p>
</li>
<li><p>容器中应用程序按照原有方式读取容器特定目录上的配置文件。 </p>
</li>
<li><p>在容器看来，配置文件就像是打包在容器内部特定目录，整个过程对应用没有任何侵入。 </p>
</li>
</ol>
<ul>
<li>Configmap 应用场景</li>
</ul>
<blockquote>
<p>使用 k8s 部署应用，当你将应用配置写进代码中，更新配置时也需要打包镜像，configmap 可以将配置信息和 docker 镜像解耦，以便实现镜像的可移植性和可复用性，因为一个 configMap 其实就是一系列配置信息的集合，可直接注入到 Pod 中给容器使用。configmap 注入方式有两种，一种将 configMap 做为<code>存储卷</code>，一种是将 configMap 通过 <code>env 中 configMapKeyRef</code> 注入到容器中。 </p>
<p>使用微服务架构的话，存在多个服务共用配置的情况，如果每个服务中单独一份配置的话，那么更新配置就很麻烦，使用 configmap 可以友好的进行配置共享。</p>
</blockquote>
<ul>
<li>局限性</li>
</ul>
<blockquote>
<p>ConfigMap 在设计上不是用来保存大量数据的。在 ConfigMap 中保存的数据不可超过 1 MiB。如果你需要保存超出此尺寸限制的数据，可以考虑挂载存储卷或者使用独立的数据库或者文件服务。 </p>
</blockquote>
<h2 id="Configmap-创建方法"><a href="#Configmap-创建方法" class="headerlink" title="Configmap 创建方法"></a>Configmap 创建方法</h2><ul>
<li>命令行直接创建</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">直接在命令行中指定 configmap 参数创建，通过--from-literal 指定参数</span></span><br><span class="line">[root@master1 ~]# kubectl create configmap tomcat-config --from-literal=tomcat_port=8080 --from-literal=server_name=myapp.tomcat.com</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@master1 ~]# kubectl describe configmap tomcat-config</span><br><span class="line">Name:         tomcat-config</span><br><span class="line">Namespace:    default</span><br><span class="line">Labels:       &lt;none&gt;</span><br><span class="line">Annotations:  &lt;none&gt;</span><br><span class="line"></span><br><span class="line">Data</span><br><span class="line">====</span><br><span class="line">server_name:</span><br><span class="line">----</span><br><span class="line">myapp.tomcat.com</span><br><span class="line">tomcat_port:</span><br><span class="line">----</span><br><span class="line">8080</span><br><span class="line">Events:  &lt;none&gt;</span><br></pre></td></tr></table></figure>

<ul>
<li>通过文件创建</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">通过指定文件创建一个 configmap，--from-file=&lt;文件&gt;</span></span><br><span class="line"></span><br><span class="line">[root@master1 ~]# vim nginx.conf</span><br><span class="line">server &#123;</span><br><span class="line">  server_name www.nginx.com;</span><br><span class="line">  listen 80;</span><br><span class="line">  root /home/nginx/www/</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">定义一个 key 是 www，值是 nginx.conf 中的内容</span></span><br><span class="line">[root@master1 ~]# kubectl create configmap www-nginx --from-file=www=./nginx.conf</span><br><span class="line"></span><br><span class="line">[root@master1 ~]# kubectl describe configmaps www-nginx </span><br><span class="line">Name:         www-nginx</span><br><span class="line">Namespace:    default</span><br><span class="line">Labels:       &lt;none&gt;</span><br><span class="line">Annotations:  &lt;none&gt;</span><br><span class="line"></span><br><span class="line">Data</span><br><span class="line">====</span><br><span class="line">www:</span><br><span class="line">----</span><br><span class="line">server &#123;</span><br><span class="line">  server_name www.nginx.com;</span><br><span class="line">  listen 80;</span><br><span class="line">  root /home/nginx/www/</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Events:  &lt;none&gt;</span><br></pre></td></tr></table></figure>

<ul>
<li>指定目录创建 configmap</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">[root@master1 ~]# mkdir test-a</span><br><span class="line"></span><br><span class="line">[root@master1 ~]# echo &quot;server-id=1&quot; &gt; test-a/my-server.cnf</span><br><span class="line">[root@master1 ~]# echo &quot;server-id=2&quot; &gt; test-a/my-slave.cnf</span><br><span class="line"></span><br><span class="line">[root@master1 ~]# kubectl create configmap mysql-config --from-file=/root/test-a/</span><br><span class="line"></span><br><span class="line">[root@master1 ~]# kubectl describe configmaps mysql-config </span><br><span class="line">Name:         mysql-config</span><br><span class="line">Namespace:    default</span><br><span class="line">Labels:       &lt;none&gt;</span><br><span class="line">Annotations:  &lt;none&gt;</span><br><span class="line"></span><br><span class="line">Data</span><br><span class="line">====</span><br><span class="line">my-server.cnf:</span><br><span class="line">----</span><br><span class="line">server-id=1</span><br><span class="line"></span><br><span class="line">my-slave.cnf:</span><br><span class="line">----</span><br><span class="line">server-id=2</span><br><span class="line"></span><br><span class="line">Events:  &lt;none&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ul>
<li>编写 configmap 资源清单 YAML 文件</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">mysql</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">mysql</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">master.cnf:</span> <span class="string">|</span>		<span class="comment"># 表示文件为多行</span></span><br><span class="line">    [<span class="string">mysqld</span>]</span><br><span class="line">    <span class="string">log-bin</span></span><br><span class="line">    <span class="string">log_bin_trust_function_creators=1</span></span><br><span class="line">  <span class="attr">slave.cnf:</span> <span class="string">|</span></span><br><span class="line"><span class="string">    [mysqld]</span></span><br><span class="line"><span class="string">    super-read-only</span></span><br><span class="line"><span class="string">    log_bin_trust_function_creators=1</span></span><br></pre></td></tr></table></figure>

<h2 id="使用-ConfigMap"><a href="#使用-ConfigMap" class="headerlink" title="使用 ConfigMap"></a>使用 ConfigMap</h2><blockquote>
<p>通过环境变量引入：使用 configMapKeyRef</p>
</blockquote>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建一个存储 mysql 配置的 configmap</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">mysql</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">mysql</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">log:</span> <span class="string">&quot;1&quot;</span></span><br><span class="line">  <span class="attr">lower:</span> <span class="string">&quot;1&quot;</span></span><br><span class="line">  </span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">mysql-pod</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">mysql</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">busybox</span></span><br><span class="line">    <span class="attr">command:</span> [<span class="string">&quot;/bin/sh&quot;</span>,<span class="string">&quot;-c&quot;</span>,<span class="string">&quot;sleep 3600&quot;</span>]</span><br><span class="line">    <span class="attr">env:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">log_bin</span>		<span class="comment"># 定义环境变量log——bin</span></span><br><span class="line">        <span class="attr">valueFrom:</span></span><br><span class="line">          <span class="attr">configMapKeyRef:</span></span><br><span class="line">            <span class="attr">name:</span> <span class="string">mysql</span>		<span class="comment"># 指定 configmap 的名字</span></span><br><span class="line">            <span class="attr">key:</span> <span class="string">log</span>		<span class="comment"># 指定 configmap 中的 key</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">lower</span></span><br><span class="line">        <span class="attr">valueFrom:</span></span><br><span class="line">          <span class="attr">configMapKeyRef:</span></span><br><span class="line">            <span class="attr">name:</span> <span class="string">mysql</span></span><br><span class="line">            <span class="attr">key:</span> <span class="string">lower</span></span><br><span class="line">  <span class="attr">restartPolicy:</span> <span class="string">Never</span></span><br><span class="line"></span><br><span class="line">[<span class="string">root@master1</span> <span class="string">~</span>]<span class="comment"># kubectl exec -it mysql-pod -- /bin/sh</span></span><br><span class="line"><span class="string">/</span> <span class="comment"># printenv</span></span><br><span class="line"><span class="string">log_bin=1</span></span><br><span class="line"><span class="string">lower=1</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>通过环境变量引入：使用 envfrom</p>
</blockquote>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">mysql-pod-envfrom</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">mysql</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">busybox</span></span><br><span class="line">    <span class="attr">command:</span> [<span class="string">&quot;/bin/sh&quot;</span>,<span class="string">&quot;-c&quot;</span>,<span class="string">&quot;sleep 3600&quot;</span>]</span><br><span class="line">    <span class="attr">envFrom:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">configMapRef:</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">mysql</span></span><br><span class="line">  <span class="attr">restartPolicy:</span> <span class="string">Never</span></span><br><span class="line"></span><br><span class="line">[<span class="string">root@master1</span> <span class="string">~</span>]<span class="comment"># kubectl exec -it mysql-pod-envfrom -- /bin/sh</span></span><br><span class="line"><span class="string">/</span> <span class="comment"># printenv</span></span><br><span class="line"><span class="string">lower=1</span></span><br><span class="line"><span class="string">log=1</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>把 configmap 做成 volume，挂载到 pod</p>
</blockquote>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">mysql</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">mysql</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">log:</span> <span class="string">&quot;1&quot;</span></span><br><span class="line">  <span class="attr">lower:</span> <span class="string">&quot;1&quot;</span></span><br><span class="line">  <span class="attr">my.cnf:</span> <span class="string">|</span></span><br><span class="line"><span class="string">    [mysqld]</span></span><br><span class="line"><span class="string">    Welcome=master</span></span><br><span class="line"><span class="string"></span><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">mysql-pod-volume</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">mysql</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">busybox</span></span><br><span class="line">    <span class="attr">command:</span> [<span class="string">&quot;/bin/sh&quot;</span>,<span class="string">&quot;-c&quot;</span>,<span class="string">&quot;sleep 3600&quot;</span>]</span><br><span class="line">    <span class="attr">volumeMounts:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">mysql-config</span></span><br><span class="line">      <span class="attr">mountPath:</span> <span class="string">/tmp/config</span></span><br><span class="line">  <span class="attr">volumes:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">mysql-config</span></span><br><span class="line">    <span class="attr">configMap:</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">mysql</span></span><br><span class="line">  <span class="attr">restartPolicy:</span> <span class="string">Never</span></span><br><span class="line">  </span><br><span class="line">[<span class="string">root@master1</span> <span class="string">~</span>]<span class="comment"># kubectl exec -it mysql-pod-volume -- /bin/sh</span></span><br><span class="line"><span class="string">/</span> <span class="comment"># cd /tmp/config/</span></span><br><span class="line"><span class="string">/tmp/config</span> <span class="comment"># ls</span></span><br><span class="line"><span class="string">log</span>     <span class="string">lower</span>   <span class="string">my.cnf</span></span><br><span class="line"></span><br><span class="line"><span class="string">/tmp/config</span> <span class="comment"># cat log </span></span><br><span class="line"><span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="string">/tmp/config</span> <span class="comment"># cat lower</span></span><br><span class="line"><span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="string">/tmp/config</span> <span class="comment"># cat my.cnf</span></span><br><span class="line">[<span class="string">mysqld</span>]</span><br><span class="line"><span class="string">Welcome=master</span></span><br></pre></td></tr></table></figure>

<h2 id="ConfigMap-热更新"><a href="#ConfigMap-热更新" class="headerlink" title="ConfigMap 热更新"></a>ConfigMap 热更新</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[root@master1 ~]# kubectl edit configmaps mysql</span><br><span class="line">  log: &quot;2&quot;</span><br><span class="line"></span><br><span class="line">[root@master1 ~]# kubectl exec -it mysql-pod-volume -- /bin/sh</span><br><span class="line"></span><br><span class="line">/ # cat /tmp/config/log </span><br><span class="line">2</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">注意：</span> </span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">更新 ConfigMap 后：使用该 ConfigMap 挂载的 Env 不会同步更新</span> </span><br><span class="line"><span class="meta prompt_"> </span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">使用该 ConfigMap 挂载的 Volume 中的数据需要一段时间（实测大概 10 秒）才能同步更新</span></span><br></pre></td></tr></table></figure>

<h1 id="配置管理中心-Secret"><a href="#配置管理中心-Secret" class="headerlink" title="配置管理中心 Secret"></a>配置管理中心 Secret</h1><h2 id="Secret-概述"><a href="#Secret-概述" class="headerlink" title="Secret 概述"></a>Secret 概述</h2><blockquote>
<p>Configmap 一般是用来存放明文数据的，如配置文件，对于一些敏感数据，如密码、私钥等数据时，要用 secret 类型。</p>
<p>Secret 解决了密码、token、秘钥等敏感数据的配置问题，而不需要把这些敏感数据暴露到镜像或者 Pod Spec 中。Secret 可以以 Volume 或者环境变量的方式使用。 </p>
<p>要使用 secret，pod 需要引用 secret。Pod 可以用两种方式使用 secret：作为 volume 中的文件被挂载到 pod 中的一个或者多个容器里，或者当 kubelet 为 pod 拉取镜像时使用。 </p>
<p>secret 可选参数有三种: </p>
<ul>
<li>generic: 通用类型，通常用于存储密码数据。 </li>
<li>tls：此类型仅用于存储私钥和证书。 </li>
<li>docker-registry: 若要保存 docker 仓库的认证信息的话，就必须使用此种类型来创建。</li>
</ul>
<p>Secret 类型 </p>
<ul>
<li><p>Service Account：用于被 serviceaccount 引用。serviceaccout 创建时Kubernetes 会默认创建对应的 secret。Pod 如果使用了 serviceaccount，对应的 secret 会自动挂载到 Pod 的 /run/secrets/kubernetes.io/serviceaccount 目录中。 </p>
</li>
<li><p>Opaque：base64 编码格式的 Secret，用来存储密码、秘钥等。可以通过 base64 –decode 解码获得原始数据，因此安全性弱 </p>
</li>
<li><p>kubernetes.io/dockerconfigjson：用来存储私有 docker registry 的认证信息。 </p>
</li>
</ul>
</blockquote>
<h2 id="使用-Secret"><a href="#使用-Secret" class="headerlink" title="使用 Secret"></a>使用 Secret</h2><blockquote>
<p>通过环境变量引入 Secret</p>
</blockquote>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 把 mysql 的 root 用户的 password 创建成 secret</span></span><br><span class="line">[<span class="string">root@master1</span> <span class="string">~</span>]<span class="comment"># kubectl create secret generic mysql-password --from-literal=password=masterpod**lucky66</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[<span class="string">root@master1</span> <span class="string">~</span>]<span class="comment"># kubectl describe secrets mysql-password </span></span><br><span class="line"><span class="attr">Name:</span>         <span class="string">mysql-password</span></span><br><span class="line"><span class="attr">Namespace:</span>    <span class="string">default</span></span><br><span class="line"><span class="attr">Labels:</span>       <span class="string">&lt;none&gt;</span></span><br><span class="line"><span class="attr">Annotations:</span>  <span class="string">&lt;none&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">Type:</span>  <span class="string">Opaque</span></span><br><span class="line"></span><br><span class="line"><span class="string">Data</span></span><br><span class="line"><span class="string">====</span></span><br><span class="line"><span class="attr">password:</span>  <span class="number">18</span> <span class="string">bytes</span></span><br><span class="line"><span class="comment"># password 的值是加密的， </span></span><br><span class="line"><span class="comment"># 但 secret 的加密是一种伪加密，它仅仅是将数据做了 base64 的编码.</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建 pod，引用 secret</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">pod-secret</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">myapp</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">myapp</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">ikubernetes/myapp:v1</span></span><br><span class="line">    <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">http</span></span><br><span class="line">      <span class="attr">containerPort:</span> <span class="number">80</span></span><br><span class="line">    <span class="attr">env:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">MYSQL_ROOT_PASSWORD</span>			<span class="comment"># 它是 pod 启动成功后的环境变量名</span></span><br><span class="line">      <span class="attr">valueFrom:</span></span><br><span class="line">        <span class="attr">secretKeyRef:</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">mysql-password</span>          <span class="comment"># 这是 secret 的对象名</span></span><br><span class="line">          <span class="attr">key:</span> <span class="string">password</span>                 <span class="comment"># 它是 secret 中的 key 名</span></span><br><span class="line"></span><br><span class="line">[<span class="string">root@master1</span> <span class="string">~</span>]<span class="comment"># kubectl exec -it pod-secret -- /bin/sh</span></span><br><span class="line"><span class="string">/</span> <span class="comment"># printenv</span></span><br><span class="line"></span><br><span class="line"><span class="string">MYSQL_ROOT_PASSWORD=masterpod**lucky66</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>通过 volume 挂载 Secret</p>
</blockquote>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建 Secret，手动加密，基于 base64 加密</span></span><br><span class="line">[<span class="string">root@master1</span> <span class="string">~</span>]<span class="comment"># echo -n &quot;admin&quot; | base64</span></span><br><span class="line"><span class="string">YWRtaW4=</span></span><br><span class="line">[<span class="string">root@master1</span> <span class="string">~</span>]<span class="comment"># echo -n &quot;master123456f&quot; | base64</span></span><br><span class="line"><span class="string">bWFzdGVyMTIzNDU2Zg==</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 解码</span></span><br><span class="line">[<span class="string">root@master1</span> <span class="string">~</span>]<span class="comment"># echo bWFzdGVyMTIzNDU2Zg== | base64 -d</span></span><br><span class="line"><span class="string">master123456f</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建 secret.yaml 文件</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Secret</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">mysecret</span></span><br><span class="line"><span class="attr">type:</span> <span class="string">Opaque</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">username:</span> <span class="string">YWRtaW4=</span></span><br><span class="line">  <span class="attr">password:</span> <span class="string">bWFzdGVyMTIzNDU2Zg==</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[<span class="string">root@master1</span> <span class="string">~</span>]<span class="comment"># kubectl describe secrets mysecret </span></span><br><span class="line"><span class="attr">Name:</span>         <span class="string">mysecret</span></span><br><span class="line"><span class="attr">Namespace:</span>    <span class="string">default</span></span><br><span class="line"><span class="attr">Labels:</span>       <span class="string">&lt;none&gt;</span></span><br><span class="line"><span class="attr">Annotations:</span>  <span class="string">&lt;none&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">Type:</span>  <span class="string">Opaque</span></span><br><span class="line"></span><br><span class="line"><span class="string">Data</span></span><br><span class="line"><span class="string">====</span></span><br><span class="line"><span class="attr">password:</span>  <span class="number">13</span> <span class="string">bytes</span></span><br><span class="line"><span class="attr">username:</span>  <span class="number">5</span> <span class="string">bytes</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 将 Secret 挂载到 Volume 中</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">pod-secret-volume</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">myapp</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">registry.cn-beijing.aliyuncs.com/google_registry/myapp:v1</span></span><br><span class="line">    <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">    <span class="attr">volumeMounts:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">secret-volume</span></span><br><span class="line">      <span class="attr">mountPath:</span> <span class="string">/etc/secret</span></span><br><span class="line">      <span class="attr">readOnly:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">volumes:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">secret-volume</span></span><br><span class="line">    <span class="attr">secret:</span></span><br><span class="line">      <span class="attr">secretName:</span> <span class="string">mysecret</span></span><br><span class="line">      </span><br><span class="line">[<span class="string">root@master1</span> <span class="string">~</span>]<span class="comment"># kubectl exec -it pod-secret-volume -- /bin/sh</span></span><br><span class="line"><span class="string">/</span> <span class="comment"># ls /etc/secret/</span></span><br><span class="line"><span class="string">password</span>  <span class="string">username</span></span><br><span class="line"></span><br><span class="line"><span class="string">/</span> <span class="comment"># cat /etc/secret/username </span></span><br><span class="line"><span class="string">admin</span> </span><br><span class="line"></span><br><span class="line"><span class="string">/</span> <span class="comment"># cat /etc/secret/password </span></span><br><span class="line"><span class="string">master123456f</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 由上可见，在 pod 中的 secret 信息实际已经被解密</span></span><br></pre></td></tr></table></figure>

<h1 id="k8s-安全管理：RBAC授权"><a href="#k8s-安全管理：RBAC授权" class="headerlink" title="k8s 安全管理：RBAC授权"></a>k8s 安全管理：RBAC授权</h1><h2 id="认证、授权、准入控制概述"><a href="#认证、授权、准入控制概述" class="headerlink" title="认证、授权、准入控制概述"></a>认证、授权、准入控制概述</h2><blockquote>
<p>k8s 对我们整个系统的认证，授权，访问控制做了精密的设置；对于 k8s 集群来说，<code>apiserver</code> 是整个集群访问控制的唯一入口，我们在 k8s 集群之上部署应用程序的时候，也可以通过宿主机的 <code>NodePort</code> 暴露的端口访问里面的程序，用户访问 kubernetes 集群需要经历如下认证过程：认证-&gt;授权-&gt;准入控制（<code>adminationcontroller</code>）</p>
</blockquote>
<ol>
<li><p>认证(Authenticating)是对客户端的认证，通俗点就是用户名密码验证</p>
</li>
<li><p>授权(Authorization)是对资源的授权，k8s 中的资源无非是容器，最终其实就是容器的计算，网络，存储资源，当一个请求经过认证后，需要访问某一个资源（比如创建一个 pod），授权检查会根据授权规则判定该资源（比如某 namespace 下的 pod）是否是该客户可访问的。</p>
</li>
<li><p>准入(Admission Control)机制：准入控制器（Admission Controller）位于 API Server 中，在对象被持久化之前，准入控制器拦截对 API Server 的请求，一般用来做身份验证和授权。其中包含两个特殊的控制器：<br><code>MutatingAdmissionWebhook</code> 和 <code>ValidatingAdmissionWebhook</code>。分别作为配置的变异和验证准入控制 webhook。<br>变更（Mutating）准入控制：修改请求的对象<br>验证（Validating）准入控制：验证请求的对象<br>准入控制器是在 API Server 的启动参数配置的。一个准入控制器可能属于以上两者中的一种，也可能两者都属于。当请求到达 API Server 的时候首先执行变更准入控制，然后再执行验证准入控制。</p>
</li>
</ol>
<blockquote>
<p>我们在部署 Kubernetes 集群的时候都会默认开启一系列准入控制器，如果没有设置这些准入控制器的话可以说你的 Kubernetes 集群就是在裸奔，应该只有集群管理员可以修改集群的准入控制器。</p>
<p>例如我会默认开启如下的准入控制器。</p>
<p>–admission-control=ServiceAccount,NamespaceLifecycle,NamespaceExists,LimitRanger,ResourceQuota,MutatingAdmissionWebhook,ValidatingAdmissionWebhook</p>
<p>k8s 的整体架构也是一个微服务的架构，所有的请求都是通过一个 GateWay，也就是 kube-apiserver 这个组件（对外提供 REST 服务），k8s 中客户端有两类，一种是普通用户，一种是集群内的 Pod，这两种客户端的认证机制略有不同，但无论是哪一种，都需要依次经过认证，授权，准入这三个机制。</p>
</blockquote>
<h3 id="认证"><a href="#认证" class="headerlink" title="认证"></a>认证</h3><ol>
<li>认证支持多种插件</li>
</ol>
<blockquote>
<p>令牌（token）认证：</p>
<p>双方有一个共享密钥，服务器上先创建一个密码下来，客户端登陆的时候拿这个密码登陆即可，这个就是对称密钥认证方式；k8s 提供了一个 restful 风格的接口，它的所有服务都是通过 http 协议提供的，因此认证信息只能经由 http 协议的认证首部进行传递，这种认证首部进行传递通常叫做令牌；</p>
</blockquote>
<blockquote>
<p>ssl 认证：</p>
<p>对于 k8s 访问来讲，ssl 认证能让客户端确认服务器的认证身份，我们在跟服务器通信的时候，需要服务器发过来一个证书，我们需要确认这个证书是不是 ca 签署的，如果是我们认可的 ca 签署的，里面的 subj 信息与我们访问的目标主机信息保持一致，没有问题，那么我们就认为服务器的身份得到认证了，k8s 中最重要的是服务器还需要认证客户端的信息，kubectl 也应该有一个证书，这个证书也是 server 所认可的 ca 签署的证书，双方需要互相认证，实现加密通信，这就是 ssl 认证。</p>
</blockquote>
<ol start="2">
<li>kubernetes 上的账号</li>
</ol>
<blockquote>
<p>客户端对 apiserver 发起请求，apiserver 要识别这个用户是否有请求的权限，要识别用户本身能否通过 apiserver 执行相应的操作，那么需要哪些信息才能识别用户信息来完成对用户的相关的访问控制呢？</p>
<p><code>kubectl explain pods.spec</code> 可以看到有一个字段 <code>serviceAccountName</code>（服务账号名称），这个就是我们 pod 连接 apiserver 时使用的账号，因此整个 kubernetes 集群中的账号有两类，<code>ServiceAccount</code>（服务账号），<code>User account</code>（用户账号）</p>
<p>User account：实实在在现实中的人，人可以登陆的账号，客户端想要对 apiserver 发起请求，apiserver 要识别这个客户端是否有请求的权限，那么不同的用户就会有不同的权限，靠用户账号表示，叫做 username</p>
<p>ServiceAccount：方便 Pod 里面的进程调用 Kubernetes API 或其他外部服务而设计的，是 kubernetes 中的一种资源</p>
<p>sa 账号：登陆 dashboard 使用的账号<br>user account：这个是登陆 k8s 物理机器的用户</p>
</blockquote>
<ul>
<li><code>ServiceAccount</code></li>
</ul>
<blockquote>
<p>Service account 是为了方便 Pod 里面的进程调用 Kubernetes API 或其他外部服务而设计的。它与 User account 不同，User account 是为人设计的，而 service account 则是为 Pod 中的进程调用 Kubernetes API 而设计；User account 是跨 namespace 的，而 service account 则是仅局限它所在的 namespace；每个 namespace 都会自动创建一个 default service account；开启 ServiceAccount Admission Controller 后</p>
<ol>
<li>每个 Pod 在创建后都会自动设置 spec.serviceAccount 为 default（除非指定了其他 ServiceAccout）</li>
<li>验证 Pod 引用的 service account 已经存在，否则拒绝创建；</li>
</ol>
<p>当创建 pod 的时候，如果没有指定一个 serviceaccount，系统会自动在与该 pod 相同的 namespace 下为其指派一个 default service account。这是 pod 和 apiserver 之间进行通信的账号，如下</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[root@master1 ~]# kubectl get pods</span><br><span class="line">NAME                              READY   STATUS      RESTARTS   AGE</span><br><span class="line">nfs-provisioner-cd8bf8889-gb2ft   1/1     Running     0          5d17h</span><br><span class="line">pod-secret                        1/1     Running     0          41h</span><br><span class="line">pod-secret-volume                 1/1     Running     0          40h</span><br><span class="line"></span><br><span class="line">[root@master1 ~]# kubectl get pods pod-secret -o yaml | grep &quot;serviceAccountName&quot;</span><br><span class="line">  serviceAccountName: default</span><br><span class="line"></span><br><span class="line">[root@master1 ~]# kubectl describe pods pod-secret</span><br><span class="line">Volumes:</span><br><span class="line">  default-token-bnmcc:</span><br><span class="line">    Type:        Secret (a volume populated by a Secret)</span><br><span class="line">    SecretName:  default-token-bnmcc</span><br><span class="line">    Optional:    false</span><br></pre></td></tr></table></figure>

<blockquote>
<p>从上面可以看到每个 Pod 无论定义与否都会有个存储卷，这个存储卷为 default-token-xxx。pod 和 apiserver 的认证信息通过 secret 进行定义，由于认证信息属于敏感信息，所以需要保存在 secret 资源当中，并以存储卷的方式挂载到 Pod 当中。从而让 Pod 内运行的应用通过对应的 secret 中的信息来连接 apiserver，并完成认证。每个 namespace 中都有一个默认的叫做 default 的 serviceaccount 资源。查看名称空间内的 secret，也可以看到对应的 default-token。让当前名称空间中所有的 pod 在连接 apiserver 时可以使用的预制认证信息，从而保证 pod 之间的通信。</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@master1 ~]# kubectl get sa</span><br><span class="line">NAME              SECRETS   AGE</span><br><span class="line">default           1         11d</span><br><span class="line"></span><br><span class="line">[root@master1 ~]# kubectl get secrets </span><br><span class="line">NAME                          TYPE                                  DATA   AGE</span><br><span class="line">default-token-bnmcc           kubernetes.io/service-account-token   3      11d</span><br></pre></td></tr></table></figure>

<blockquote>
<p>默认的 service account 仅仅只能获取当前 Pod 自身的相关属性，无法观察到其他名称空间 Pod 的相关属性信息。如果想要扩展 Pod，假设有一个 Pod 需要用于管理其他 Pod 或者是其他资源对象，是无法通过自身的名称空间的 serviceaccount 进行获取其他 Pod 的相关属性信息的，此时就需要进行手动创建一个 serviceaccount，并在创建 Pod 时进行定义。那么 serviceaccount 该如何进行定义呢？实际上，service accout 也属于一个 k8s 资源，serviceAccount 也属于标准的 k8s 资源，可以创建一个 serviceAccount，创建之后由我们创建的 pod 使用 serviceAccountName 去加载自己定义的 serviceAccount 就可以了，如下：</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">创建 serviceaccount</span></span><br><span class="line">[root@master1 ~]# kubectl create sa test</span><br><span class="line"></span><br><span class="line">[root@master1 ~]# kubectl get sa</span><br><span class="line">NAME              SECRETS   AGE</span><br><span class="line">default           1         11d</span><br><span class="line">test              1         9s</span><br><span class="line"></span><br><span class="line">[root@master1 ~]# kubectl describe sa test </span><br><span class="line">Name:                test</span><br><span class="line">Namespace:           default</span><br><span class="line">Labels:              &lt;none&gt;</span><br><span class="line">Annotations:         &lt;none&gt;</span><br><span class="line">Image pull secrets:  &lt;none&gt;</span><br><span class="line">Mountable secrets:   test-token-r2zmh</span><br><span class="line">Tokens:              test-token-r2zmh</span><br><span class="line">Events:              &lt;none&gt;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">上面可以看到生成了一个 test-token-r2zmh 的 secret 和 test-token-r2zmh 的 token</span></span><br><span class="line"></span><br><span class="line">[root@master1 ~]# kubectl get secrets </span><br><span class="line">NAME                          TYPE                                  DATA   AGE</span><br><span class="line">test-token-r2zmh              kubernetes.io/service-account-token   3      2m48s</span><br><span class="line"></span><br><span class="line">[root@master1 ~]# kubectl describe secrets test-token-r2zmh </span><br><span class="line">Name:         test-token-r2zmh</span><br><span class="line">Namespace:    default</span><br><span class="line">Labels:       &lt;none&gt;</span><br><span class="line">Annotations:  kubernetes.io/service-account.name: test</span><br><span class="line">              kubernetes.io/service-account.uid: 0dd14a67-3d78-4612-acdb-51f72efedf24</span><br><span class="line"></span><br><span class="line">Type:  kubernetes.io/service-account-token</span><br><span class="line"></span><br><span class="line">Data</span><br><span class="line">====</span><br><span class="line">ca.crt:     1066 bytes</span><br><span class="line">namespace:  7 bytes</span><br><span class="line">token:      eyJhbGciOiJSUzI1NiIsImtpZCI6IjBCaXlVcWRjT29MSUhNVDdCOXN0TmpfUXNBdEhSdnBVazZqRWNKNENSRFEifQ.eyJpc3MiOiJrdWJlcm5ldGVzL3NlcnZpY2VhY2NvdW50Iiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9uYW1lc3BhY2UiOiJkZWZhdWx0Iiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9zZWNyZXQubmFtZSI6InRlc3QtdG9rZW4tcjJ6bWgiLCJrdWJlcm5ldGVzLmlvL3NlcnZpY2VhY2NvdW50L3NlcnZpY2UtYWNjb3VudC5uYW1lIjoidGVzdCIsImt1YmVybmV0ZXMuaW8vc2VydmljZWFjY291bnQvc2VydmljZS1hY2NvdW50LnVpZCI6IjBkZDE0YTY3LTNkNzgtNDYxMi1hY2RiLTUxZjcyZWZlZGYyNCIsInN1YiI6InN5c3RlbTpzZXJ2aWNlYWNjb3VudDpkZWZhdWx0OnRlc3QifQ.lSgX4-ikGFIaCT7luCPu0_U_25MG9zPxcZdufIo-Wzctf1DvTsst90FcSMqIFWts8pBQm9KxJLtAfeZlHNSx088ukfwZHExcrKkmq7pJQ0zE_3aU3gTPqOFErFiCmP7wdpTemidf69si8Ez24gPLvPjv4QZnjRKuESS7_sSn9XUbyu1kKSKQUWw1Jx3Jpbb2b5STV-2fE_8PFe8Lcg0N2DD8_iZFWZ_yVIna57KCJ-uO80wT-K7XsxdKTlipRp7K74v1CKq9RQy19vZ3pPJNf4CVzkZLpMwBhCkvYU1Of1jLZZkg7A-3y1x2OvVueqztVhseric7eJe9utndLMOcLw</span><br></pre></td></tr></table></figure>

<blockquote>
<p>上面可以看到生成了 test-token-r2zmh 的 token 详细信息，这个 token 就是 sa 连接 apiserver 的认证信息，这个 token 也是登陆 k8s dashboard 的 token，这些是一个认证信息，能够登陆 k8s，能认证到 k8s，但是不能做别的事情，不代表权限，想要做其他事情，需要授权</p>
</blockquote>
<ul>
<li>kubeconfig 文件</li>
</ul>
<blockquote>
<p>在 K8S 集群当中，每一个用户对资源的访问都是需要通过 apiserver 进行通信认证才能进行访问的，那么在此机制当中，对资源的访问可以是 token，也可以是通过配置文件的方式进行保存和使用认证信息，可以通过 kubectl config 进行查看配置，如下：</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">[root@master1 ~]# kubectl config view</span><br><span class="line">apiVersion: v1</span><br><span class="line">clusters:</span><br><span class="line">- cluster:</span><br><span class="line">    certificate-authority-data: DATA+OMITTED</span><br><span class="line">    server: https://192.168.1.180:6443		# apiserver 的地址</span><br><span class="line">  name: kubernetes							# 集群的名字</span><br><span class="line">contexts:</span><br><span class="line">- context:</span><br><span class="line">    cluster: kubernetes</span><br><span class="line">    user: kubernetes-admin</span><br><span class="line">  name: kubernetes-admin@kubernetes			# 上下文的名字</span><br><span class="line">current-context: kubernetes-admin@kubernetes	# 当前上下文</span><br><span class="line">kind: Config</span><br><span class="line">preferences: &#123;&#125;</span><br><span class="line">users:</span><br><span class="line">- name: kubernetes-admin</span><br><span class="line">  user:</span><br><span class="line">    client-certificate-data: REDACTED</span><br><span class="line">    client-key-data: REDACTED</span><br></pre></td></tr></table></figure>

<blockquote>
<p>在上面的配置文件当中，定义了集群、上下文以及用户。其中 Config 也是 K8S 的标准资源之一，在该配置文件当中定义了一个集群列表，指定的集群可以有多个；用户列表也可以有多个，指明集群中的用户；而在上下文列表当中，是进行定义可以使用哪个用户对哪个集群进行访问，以及当前使用的上下文是什么。</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@master1 ~]# kubectl get pods --kubeconfig=.kube/config </span><br><span class="line">NAME                              READY   STATUS      RESTARTS   AGE</span><br><span class="line">mysql-pod                         0/1     Completed   0          17h</span><br><span class="line">mysql-pod-volume                  0/1     Completed   0          42h</span><br><span class="line">nfs-provisioner-cd8bf8889-gb2ft   1/1     Running     0          5d17h</span><br><span class="line">pod-secret                        1/1     Running     0          41h</span><br><span class="line">pod-secret-volume                 1/1     Running     0          41h</span><br></pre></td></tr></table></figure>

<h3 id="授权"><a href="#授权" class="headerlink" title="授权"></a>授权</h3><blockquote>
<p>如果用户通过认证，什么权限都没有，需要一些后续的授权操作，如对资源的增删该查等，kubernetes1.6 之后开始有 RBAC（基于角色的访问控制机制）授权检查机制。Kubernetes 的授权是基于插件形成的，其常用的授权插件有以下几种：</p>
</blockquote>
<ol>
<li>Node（节点认证）</li>
<li>ABAC(基于属性的访问控制)</li>
<li>RBAC（基于角色的访问控制）</li>
<li>Webhook（基于 http 回调机制的访问控制）</li>
</ol>
<blockquote>
<p>什么是 RBAC（基于角色的访问控制）</p>
<p>让一个用户（Users）扮演一个角色（Role），角色拥有权限，从而让用户拥有这样的权限，随后在授权机制当中，只需要将权限授予某个角色，此时用户将获取对应角色的权限，从而实现角色的访问控制。如图：</p>
</blockquote>
<p><img src="../../../../images/image/k8s-han/29.png" alt="29"></p>
<blockquote>
<p>在 k8s 的授权机制当中，采用 RBAC 的方式进行授权，其工作逻辑是，把对对象的操作权限定义到一个角色当中，再将用户绑定到该角色，从而使用户得到对应角色的权限。如果通过 <code>rolebinding</code> 绑定 role，只能对 <code>rolebingding</code> 所在的名称空间的资源有权限，上图 user1 这个用户绑定到 role1 上，只对 role1 这个名称空间的资源有权限，对其他名称空间资源没有权限，属于名称空间级别的；</p>
<p>另外，k8s 为此还有一种集群级别的授权机制，就是定义一个集群角色（<code>ClusterRole</code>），对集群内的所有资源都有可操作的权限，从而将 User2 通过 <code>ClusterRoleBinding</code> 到  <code>ClusterRole</code>，从而使 User2 拥有集群的操作权限。</p>
<p>Role、RoleBinding、ClusterRole 和 ClusterRoleBinding 的关系如下图：</p>
</blockquote>
<p><img src="../../../../images/image/k8s-han/30.png" alt="30"></p>
<blockquote>
<p>通过上图可以看到，可以通过 rolebinding 绑定 role，rolebinding 绑定 clusterrole，clusterrolebinding 绑定 clusterrole。</p>
<p>上面我们说了两个角色绑定：<br>（1）用户通过 rolebinding 绑定 role<br>（2）用户通过 clusterrolebinding 绑定 clusterrole</p>
<p>还有一种：rolebinding 绑定 clusterrole</p>
<p>rolebinding 绑定 clusterrole 的好处：</p>
<p>假如有 6 个名称空间，每个名称空间的用户都需要对自己的名称空间有管理员权限，那么需要定义 6 个 role 和 rolebinding，然后依次绑定，如果名称空间更多，我们需要定义更多的 role，这个是很麻烦的，所以我们引入 clusterrole，定义一个 clusterrole，对 clusterrole 授予所有权限，然后用户通过 rolebinding 绑定到 clusterrole，就会拥有自己名称空间的管理员权限了</p>
<p>注：RoleBinding 仅仅对当前名称空间有对应的权限。</p>
</blockquote>
<h3 id="准入控制"><a href="#准入控制" class="headerlink" title="准入控制"></a>准入控制</h3><blockquote>
<p>一般而言，准入控制只是用来定义我们授权检查完成之后的后续的其他安全检查操作的，进一步补充了授权机制，由多个插件组合实行，一般而言在创建，删除，修改或者做代理时做补充；</p>
</blockquote>
<blockquote>
<p>Kubernetes 的 Admission Control 实际上是一个准入控制器(Admission Controller)插件列表，发送到 APIServer 的请求都需要经过这个列表中的每个准入控制器插件的检查，如果某一个控制器插件准入失败，就准入失败。</p>
</blockquote>
<blockquote>
<p>控制器插件如下：</p>
</blockquote>
<ul>
<li><p><code>AlwaysAdmit</code>：允许所有请求通过</p>
</li>
<li><p><code>AlwaysPullImages</code>：在启动容器之前总是去下载镜像，相当于每当容器启动前做一次用于是否有权使用该容器镜像的检查</p>
</li>
<li><p><code>AlwaysDeny</code>：禁止所有请求通过，用于测试</p>
</li>
<li><p><code>DenyEscalatingExec</code>：拒绝 exec 和 attach 命令到有升级特权的 Pod 的终端用户访问。如果集中包含升级特权的容器，而要限制终端用户在这些容器中执行命令的能力，推荐使用此插件 <code>ImagePolicyWebhook</code></p>
</li>
<li><p><code>ServiceAccount</code>：这个插件实现了 serviceAccounts 等等自动化，如果使用 ServiceAccount 对象，强烈推荐使用这个插件</p>
</li>
<li><p><code>SecurityContextDeny</code>：将 Pod 定义中定义了的  SecurityContext 选项全部失效。SecurityContext 包含在容器中定义了操作系统级别的安全选型如 fsGroup，selinux 等选项</p>
</li>
<li><p><code>ResourceQuota</code>：用于 namespace 上的配额管理，它会观察进入的请求，确保在 namespace 上的配额不超标。推荐将这个插件放到准入控制器列表的最后一个。ResourceQuota 准入控制器既可以限制某个 namespace 中创建资源的数量，又可以限制某个 namespace 中被 Pod 请求的资源总量。ResourceQuota 准入控制器和 ResourceQuota 资源对象一起可以实现资源配额管理。</p>
</li>
<li><p><code>LimitRanger</code>：用于 Pod 和容器上的配额管理，它会观察进入的请求，确保 Pod 和容器上的配额不会超标。准入控制器 LimitRanger 和资源对象 LimitRange 一起实现资源限制管理</p>
</li>
<li><p><code>NamespaceLifecycle</code>：当一个请求是在一个不存在的 namespace 下创建资源对象时，该请求会被拒绝。当删除一个 namespace 时，将会删除该 namespace 下的所有资源对象</p>
<p>DefaultStorageClass</p>
<p>DefaultTolerationSeconds</p>
<p>PodSecurityPolicy</p>
</li>
</ul>
<blockquote>
<p>当 Kubernetes 版本&gt;=1.6.0，官方建议使用这些插件：</p>
<p>–admission-control=NamespaceLifecycle,LimitRanger,ServiceAccount,PersistentVolumeLabel,DefaultStorageClass,ResourceQuota,DefaultTolerationSeconds</p>
<p>当 Kubernetes 版本&gt;=1.4.0，官方建议使用这些插件：</p>
<p>–admission-control=NamespaceLifecycle,LimitRanger,ServiceAccount,DefaultStorageClass,ResourceQuota</p>
<p>以上是标准的准入插件，如果是自己定制的话，k8s1.7 版出了两个 alpha features, Initializers 和 External Admission Webhooks</p>
</blockquote>
<h2 id="ServiceAccount-介绍"><a href="#ServiceAccount-介绍" class="headerlink" title="ServiceAccount 介绍"></a>ServiceAccount 介绍</h2><blockquote>
<p>kubernetes 中账户区分为：User Accounts（用户账户） 和 Service Accounts（服务账户）两种：</p>
<p>UserAccount 是给 kubernetes 集群外部用户使用的，例如运维或者集群管理人员，，kubeadm 安装的 k8s，默认用户账号是 kubernetes-admin；</p>
<p>k8s 客户端(一般用: kubectl) ——&gt;API Server</p>
<p>APIServer 需要对客户端做认证，使用 kubeadm 安装的 K8s，会在用户家目录下创建一个认证配置文件 .kube/config 这里面保存了客户端访问 API Server 的密钥相关信息，这样当用 kubectl 访问 k8s 时，它就会自动读取该配置文件，向 API Server 发起认证，然后完成操作请求。</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@master1 ~]# cat .kube/config </span><br><span class="line">······</span><br><span class="line">users:</span><br><span class="line">- name: kubernetes-admin</span><br><span class="line">······</span><br></pre></td></tr></table></figure>

<blockquote>
<p>ServiceAccount 是 Pod 使用的账号，Pod 容器的进程需要访问 API Server 时用的就是ServiceAccount 账户；ServiceAccount 仅局限它所在的 namespace，每个 namespace 创建时都会自动创建一个 default service account；创建 Pod 时，如果没有指定 Service Account，Pod 则会使用 default Service Account。</p>
</blockquote>
<h2 id="RBAC-认证授权策略"><a href="#RBAC-认证授权策略" class="headerlink" title="RBAC 认证授权策略"></a>RBAC 认证授权策略</h2><blockquote>
<p>RBAC 介绍</p>
<p>在 Kubernetes 中，所有资源对象都是通过 API 进行操作，他们保存在 etcd 里。而对 etcd 的操作我们需要通过访问 kube-apiserver 来实现，上面的 Service Account 其实就是 APIServer 的认证过程，而授权的机制是通过 RBAC：基于角色的访问控制实现。</p>
<p>RBAC 有四个资源对象，分别是 Role、ClusterRole、RoleBinding、ClusterRoleBinding</p>
</blockquote>
<h3 id="Role：角色"><a href="#Role：角色" class="headerlink" title="Role：角色"></a>Role：角色</h3><blockquote>
<p>一组权限的集合，在一个命名空间中，可以用其来定义一个角色，只能对命名空间内的资源进行授权。如果是集群级别的资源，则需要使用 ClusterRole。</p>
<p>例如：定义一个角色用来读取 Pod 的权限</p>
</blockquote>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Role</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">rbac</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">pod-read</span></span><br><span class="line"><span class="attr">rules:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span> [<span class="string">&quot;&quot;</span>]</span><br><span class="line">  <span class="attr">resources:</span> [<span class="string">&quot;pods&quot;</span>]</span><br><span class="line">  <span class="attr">resourceNames:</span> [<span class="string">&quot;&quot;</span>]</span><br><span class="line">  <span class="attr">verbs:</span> [<span class="string">&quot;get&quot;</span>,<span class="string">&quot;watch&quot;</span>,<span class="string">&quot;list&quot;</span>]</span><br></pre></td></tr></table></figure>

<p><em>rules 中的参数说明</em></p>
<ol>
<li>apiGroups：支持的 API 组列表，例如：“apiVersion: batch/v1”等</li>
<li>resources：支持的资源对象列表，例如 pods、deplayments、jobs 等</li>
<li>resourceNames: 指定 resource 的名称</li>
<li>verbs：对资源对象的操作方法列表。</li>
</ol>
<h3 id="ClusterRole：集群角色"><a href="#ClusterRole：集群角色" class="headerlink" title="ClusterRole：集群角色"></a>ClusterRole：集群角色</h3><blockquote>
<p>具有和角色一致的命名空间资源的管理能力，还可用于以下特殊元素的授权</p>
</blockquote>
<ol>
<li>集群范围的资源，例如 Node</li>
<li>非资源型的路径，例如：/healthz</li>
<li>包含全部命名空间的资源，例如 Pods</li>
</ol>
<blockquote>
<p>例如：定义一个集群角色可让用户访问任意 secrets</p>
</blockquote>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">secret-clusterrole</span></span><br><span class="line"><span class="attr">rules:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span> [<span class="string">&quot;&quot;</span>]</span><br><span class="line">  <span class="attr">resources:</span> [<span class="string">&quot;secret&quot;</span>]</span><br><span class="line">  <span class="attr">verbs:</span> [<span class="string">&quot;get&quot;</span>,<span class="string">&quot;watch&quot;</span>,<span class="string">&quot;list&quot;</span>]</span><br></pre></td></tr></table></figure>

<h3 id="RoleBinding-amp-amp-ClusterRolebinding"><a href="#RoleBinding-amp-amp-ClusterRolebinding" class="headerlink" title="RoleBinding &amp;&amp; ClusterRolebinding"></a>RoleBinding &amp;&amp; ClusterRolebinding</h3><blockquote>
<p>角色绑定和集群角色绑定用于把一个角色绑定在一个目标上，可以是 User，Group，Service Account，使用 RoleBinding 为某个命名空间授权，使用 ClusterRoleBinding 为集群范围内授权。</p>
<p>例如：将在 rbac 命名空间中把 pod-read 角色授予用户 es</p>
</blockquote>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">RoleBinding</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">pod-read-bind</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">rbac</span></span><br><span class="line"><span class="attr">subjects:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">User</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">es</span></span><br><span class="line">  <span class="attr">apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br><span class="line"><span class="attr">roleRef:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">Role</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">pod-read</span></span><br><span class="line">  <span class="attr">apiGroup:</span> <span class="string">rbac.authorizatioin.k8s.io</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>RoleBinding 也可以引用 ClusterRole，对属于同一命名空间内的 ClusterRole 定义的资源主体进行授权</p>
<p>例如：es 能获取到集群中所有的资源信息</p>
</blockquote>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">RoleBinding</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">ex-allresource</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">rbac</span></span><br><span class="line"><span class="attr">subjects:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">User</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">es</span></span><br><span class="line">  <span class="attr">apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br><span class="line"><span class="attr">roleRef:</span></span><br><span class="line">  <span class="attr">apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br><span class="line">  <span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">cluster-admin</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>集群角色绑定的角色只能是集群角色，用于进行集群级别或对所有命名空间都生效的授权</p>
<p>例如：允许 manager 组的用户读取所有 namaspace 的 secrets</p>
</blockquote>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRoleBinding</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">read-secret-global</span></span><br><span class="line"><span class="attr">subjects:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">Group</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">manager</span></span><br><span class="line">  <span class="attr">apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br><span class="line"><span class="attr">ruleRef:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">secret-read</span></span><br><span class="line">  <span class="attr">apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br></pre></td></tr></table></figure>

<h2 id="资源的引用方式"><a href="#资源的引用方式" class="headerlink" title="资源的引用方式"></a>资源的引用方式</h2><blockquote>
<p>多数资源可以用其名称的字符串表示，也就是 Endpoint 中的 URL 相对路径，例如 pod 中的日志是GET /api/v1/namaspaces/{namespace}/pods/{podname}/log</p>
<p>如果需要在一个 RBAC 对象中体现上下级资源，就需要使用 “/” 分割资源和下级资源。</p>
<p>例如：若想授权让某个主体同时能够读取 Pod 和 Pod log，则可以配置 resources 为一个数组</p>
</blockquote>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Role</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">logs-reader</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">rules:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span> [<span class="string">&quot;&quot;</span>]</span><br><span class="line">  <span class="attr">resources:</span> [<span class="string">&quot;pods&quot;</span>,<span class="string">&quot;pods/log&quot;</span>]</span><br><span class="line">  <span class="attr">verbs:</span> [<span class="string">&quot;get&quot;</span>,<span class="string">&quot;list&quot;</span>]</span><br></pre></td></tr></table></figure>

<blockquote>
<p>资源还可以通过名称（ResourceName）进行引用，在指定 ResourceName 后，使用 get、delete、update、patch 请求，就会被限制在这个资源实例范围内</p>
<p>例如，下面的声明让一个主体只能对名为 my-configmap 的 Configmap 进行 get 和 update 操作</p>
</blockquote>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Role</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">configmap-update</span></span><br><span class="line"><span class="attr">rules:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span> [<span class="string">&quot;&quot;</span>]</span><br><span class="line">  <span class="attr">resources:</span> [<span class="string">&quot;configmap&quot;</span>]</span><br><span class="line">  <span class="attr">resourceNames:</span> [<span class="string">&quot;my-configmap&quot;</span>]</span><br><span class="line">  <span class="attr">verbs:</span> [<span class="string">&quot;get&quot;</span>,<span class="string">&quot;update&quot;</span>]</span><br></pre></td></tr></table></figure>

<h2 id="常见角色示例"><a href="#常见角色示例" class="headerlink" title="常见角色示例"></a>常见角色示例</h2><ul>
<li>允许读取核心 API 组的 Pod 资源</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">rules:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span> [<span class="string">&quot;&quot;</span>]</span><br><span class="line">  <span class="attr">resources:</span> [<span class="string">&quot;pods&quot;</span>]</span><br><span class="line">  <span class="attr">verbs:</span> [<span class="string">&quot;get&quot;</span>,<span class="string">&quot;list&quot;</span>,<span class="string">&quot;watch&quot;</span>]</span><br></pre></td></tr></table></figure>

<ul>
<li>允许读写 extensions 和 apps 两个 API 组中的 deployment 资源</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">rules:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span> [<span class="string">&quot;extensions&quot;</span>,<span class="string">&quot;apps&quot;</span>]</span><br><span class="line">  <span class="attr">resources:</span> [<span class="string">&quot;deployment&quot;</span>]</span><br><span class="line">  <span class="attr">verbs:</span> [<span class="string">&quot;get&quot;</span>,<span class="string">&quot;list&quot;</span>,<span class="string">&quot;watch&quot;</span>,<span class="string">&quot;create&quot;</span>,<span class="string">&quot;update&quot;</span>,<span class="string">&quot;patch&quot;</span>,<span class="string">&quot;delete&quot;</span>]</span><br></pre></td></tr></table></figure>

<ul>
<li>允许读取 Pod 以及读写 job 信息</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">rules:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span> [<span class="string">&quot;&quot;</span>]</span><br><span class="line">  <span class="attr">resources:</span> [<span class="string">&quot;pods&quot;</span>]</span><br><span class="line">  <span class="attr">verbs:</span> [<span class="string">&quot;get&quot;</span>,<span class="string">&quot;list&quot;</span>,<span class="string">&quot;watch&quot;</span>]</span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span> [<span class="string">&quot;extensions&quot;</span>,<span class="string">&quot;batch&quot;</span>]</span><br><span class="line">  <span class="attr">resources:</span> [<span class="string">&quot;jobs&quot;</span>]</span><br><span class="line">  <span class="attr">verbs:</span> [<span class="string">&quot;get&quot;</span>,<span class="string">&quot;list&quot;</span>,<span class="string">&quot;watch&quot;</span>,<span class="string">&quot;create&quot;</span>,<span class="string">&quot;update&quot;</span>,<span class="string">&quot;patch&quot;</span>,<span class="string">&quot;delete&quot;</span>]</span><br></pre></td></tr></table></figure>

<ul>
<li>允许读取一个名为 my-config 的 ConfigMap（必须绑定到一个 RoleBinding 来限制到一个 Namespace 下的 ConfigMap）</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">rules:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span> [<span class="string">&quot;&quot;</span>]</span><br><span class="line">  <span class="attr">resources:</span> [<span class="string">&quot;configmap&quot;</span>]</span><br><span class="line">  <span class="attr">resourceNames:</span> [<span class="string">&quot;my-configmap&quot;</span>]</span><br><span class="line">  <span class="attr">verbs:</span> [<span class="string">&quot;get&quot;</span>]</span><br></pre></td></tr></table></figure>

<ul>
<li>读取核心组的 Node 资源（Node 属于集群级的资源，所以必须存在于 ClusterRole 中，并使用 ClusterRoleBinding 进行绑定）</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">rules:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span> [<span class="string">&quot;&quot;</span>]</span><br><span class="line">  <span class="attr">resources:</span> [<span class="string">&quot;nodes&quot;</span>]</span><br><span class="line">  <span class="attr">verbs:</span> [<span class="string">&quot;get&quot;</span>,<span class="string">&quot;list&quot;</span>,<span class="string">&quot;watch&quot;</span>]</span><br></pre></td></tr></table></figure>

<ul>
<li>允许对非资源端点 “/healthz” 及其所有子路径进行 GET 和 POST 操作（必须使用 ClusterRole 和 ClusterRoleBinding）</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">rules:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">nonResourcesURLs:</span> [<span class="string">&quot;/healthz&quot;</span>,<span class="string">&quot;/healthz/*&quot;</span>]</span><br><span class="line">  <span class="attr">verbs:</span> [<span class="string">&quot;get&quot;</span>,<span class="string">&quot;post&quot;</span>]</span><br></pre></td></tr></table></figure>

<h2 id="常见的角色绑定示例"><a href="#常见的角色绑定示例" class="headerlink" title="常见的角色绑定示例"></a>常见的角色绑定示例</h2><ul>
<li>用户名 alice</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">subjects:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">User</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">alice</span></span><br><span class="line">  <span class="attr">apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br></pre></td></tr></table></figure>

<ul>
<li>组名 alice</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">subjects:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">Group</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">alice</span></span><br><span class="line">  <span class="attr">apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br></pre></td></tr></table></figure>

<ul>
<li>kube-system 命名空间中默认 Service Account</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">subjects:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">default</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kube-system</span></span><br></pre></td></tr></table></figure>

<ul>
<li>qa 命名空间中的所有 Service Account</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">subjects:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">Group</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">system:serviceaccounts:qa</span></span><br><span class="line">  <span class="attr">apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br></pre></td></tr></table></figure>

<ul>
<li>所有 Service Account</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">subjects:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">Group</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">system:serviceaccountes</span></span><br><span class="line">  <span class="attr">apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br></pre></td></tr></table></figure>

<ul>
<li>所有认证用户</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">subjects:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">Group</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">system:authenticated</span></span><br><span class="line">  <span class="attr">apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br></pre></td></tr></table></figure>

<ul>
<li>所有未认证用户</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">subjects:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">Group</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">system:unauthenticated</span></span><br><span class="line">  <span class="attr">apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br></pre></td></tr></table></figure>

<ul>
<li>全部用户</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">subjects:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">Group</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">system:authenticated</span></span><br><span class="line">  <span class="attr">apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">Group</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">system:unauthenticated</span></span><br><span class="line">  <span class="attr">apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br></pre></td></tr></table></figure>

<h2 id="对-Service-Account-的授权管理"><a href="#对-Service-Account-的授权管理" class="headerlink" title="对 Service Account 的授权管理"></a>对 Service Account 的授权管理</h2><blockquote>
<p>Service Account 也是一种账号，是给运行在 Pod 里的进程提供了必要的身份证明。需要在 Pod定义中指明引用的 Service Account，这样就可以对 Pod 的进行赋权操作。</p>
<p>例如：pod 内可获取rbac 命名空间的所有 Pod 资源，pod-reader-sc 的 Service Account 是绑定了名为 pod-read 的Role</p>
</blockquote>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadta:</span> </span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">rbac</span></span><br><span class="line"><span class="attr">spec:</span> </span><br><span class="line">  <span class="attr">serviceAccountName:</span> <span class="string">pod-reader-sc</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">80</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>默认的 RBAC 策略为控制平台组件、节点和控制器授予有限范围的权限，但是除 kube-system 外的 Service Account 是没有任何权限的。</p>
<ol>
<li>为一个应用专属的 Service Account 赋权</li>
</ol>
<p>此应用需要在 Pod 的 spec 中指定一个 serviceAccountName，用于 API、Application Manifest、kubectl create serviceaccount 等创建 Service Account 的命令。</p>
<p>例如为 my-namespace 中的 my-sa Service Account 授予只读权限</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl create rolebinding my-sa-view --clusterrole=view --serviceaccount=my-namespace:my-sa --namespace=my-namespace</span><br></pre></td></tr></table></figure>

<blockquote>
<ol start="2">
<li>为一个命名空间中名为 default 的 Service Account 授权</li>
</ol>
<p>如果一个应用没有指定 serviceAccountName，则会使用名为 default 的 Service Account。注意，赋予 Service Account “default”的权限会让所有没有指定 serviceAccountName 的 Pod都具有这些权限</p>
<p>例如，在 my-namespace 命名空间中为 Service Account“default”授予只读权限：</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl create rolebinding default-view --clusterrole=view --serviceaccount=my-namespace:default --namespace=my-namespace</span><br></pre></td></tr></table></figure>

<blockquote>
<p>另外，许多系统级 Add-Ons 都需要在 kube-system 命名空间中运行，要让这些 Add-Ons 能够使用超级用户权限，则可以把 cluster-admin 权限赋予 kube-system 命名空间中名为 default 的 Service Account，这一操作意味着 kube-system 命名空间包含了通向 API 超级用户的捷径。</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl create clusterrolebinding add-ons-add-admin --clusterrole=cluster-admin --serviceaccount=kube-system:default</span><br></pre></td></tr></table></figure>

<blockquote>
<ol start="3">
<li>为命名空间中所有 Service Account 都授予一个角色</li>
</ol>
<p>如果希望在一个命名空间中，任何 Service Account 应用都具有一个角色，则可以为这一命名空间的 Service Account 群组进行授权</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl create rolebinding serviceaccounts-view --clusterrole=view --group=system:serviceaccounts:my-namespace --namespace=my-namespace</span><br></pre></td></tr></table></figure>

<blockquote>
<ol start="4">
<li>为集群范围内所有 Service Account 都授予一个低权限角色</li>
</ol>
<p>如果不想为每个命名空间管理授权，则可以把一个集群级别的角色赋给所有 Service Account。</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl create clusterrolebinding serviceaccounts-view --clusterrole=view --group=system:serviceaccounts</span><br></pre></td></tr></table></figure>

<blockquote>
<ol start="5">
<li>为所有 Service Account 授予超级用户权限</li>
</ol>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl create clusterrolebinding serviceaccounts-view --clusterrole=cluster-admin --group=system:serviceaccounts</span><br></pre></td></tr></table></figure>

<h2 id="使用-kubectl-命令行工具创建资源对象"><a href="#使用-kubectl-命令行工具创建资源对象" class="headerlink" title="使用 kubectl 命令行工具创建资源对象"></a>使用 kubectl 命令行工具创建资源对象</h2><ul>
<li>在命名空间 rbac 中为用户 es 授权 admin ClusterRole</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl create rolebinding bob-admin-binding --clusterrole=admin --user=es --namespace=rbac</span><br></pre></td></tr></table></figure>

<ul>
<li>在命名空间 rbac 中为名为 myapp 的 Service Account 授予 view ClusterRole</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl create rolebinding myapp-role-binding --clusterrole=view --serviceaccount=rbac:myapp --namespace=rbac</span><br></pre></td></tr></table></figure>

<ul>
<li>在全集群范围内为用户 root 授予 cluster-admin ClusterRole</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl create clusterrolebinding cluster-binding --clusterrole=cluster-admin --user=root</span><br></pre></td></tr></table></figure>

<ul>
<li>在全集群范围内为名为 myapp 的 Service Account 授予 view ClusterRole</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl create clusterrolebinding service-account-binding --clusterrole=view --serviceaccount=myapp</span><br></pre></td></tr></table></figure>

<ul>
<li>yaml 文件进行 rbac 授权：<a target="_blank" rel="noopener" href="https://kubernetes.io/zh/docs/reference/access-authn-authz/rbac/">https://kubernetes.io/zh/docs/reference/access-authn-authz/rbac/</a></li>
</ul>
<h2 id="限制不同的用户操作-k8s-集群"><a href="#限制不同的用户操作-k8s-集群" class="headerlink" title="限制不同的用户操作 k8s 集群"></a>限制不同的用户操作 k8s 集群</h2><ul>
<li>ssl认证</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">生成私钥</span></span><br><span class="line">cd /etc/kubernetes/pki/</span><br><span class="line">(umask 077;openssl genrsa -out lucky.key 2048)</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">生成证书请求</span></span><br><span class="line">openssl req -new -key lucky.key -out lucky.csr -subj &quot;/CN=lucky&quot;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">生成证书</span></span><br><span class="line">openssl x509 -req -in lucky.csr -CA ca.crt -CAkey ca.key -CAcreateserial -out lucky.crt -days 3650</span><br></pre></td></tr></table></figure>

<ul>
<li>在 kubeconfig 下新添加一个 lucky 这个用户</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">把 lucky 这个用户添加到 kubernetes 集群中，可以用来认证 apiserver 的连接</span></span><br><span class="line">kubectl config set-credentials lucky --client-certificate=./lucky.crt --client-key=./lucky.key --embed-certs=true</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">在 kubeconfig 下新增加一个 lucky 这个账号</span></span><br><span class="line">kubectl config set-context lucky@kubernetes --cluster=kubernetes --user=lucky</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">切换账号到 lucky，默认没有任何权限</span></span><br><span class="line">kubectl config use-context lucky@kubernetes</span><br><span class="line"></span><br><span class="line">kubectl config use-context kubernetes-admin@kubernetes</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">这个是集群用户，有任何权限</span></span><br></pre></td></tr></table></figure>

<ul>
<li>把 user 这个用户通过 rolebinding 绑定到 clusterrole 上，授予权限,权限只是在 lucky 这个名称空间有效</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">把 lucky 这个用户通过 rolebinding 绑定到 clusterrole 上</span></span><br><span class="line">kubectl create ns lucky</span><br><span class="line"></span><br><span class="line">kubectl create rolebinding lucky -n lucky --clusterrole=cluster-admin --user=lucky</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">切换到 lucky 这个用户</span></span><br><span class="line">kubectl config use-context lucky@kubernetes</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">测试是否有权限</span></span><br><span class="line">kubectl get pods -n lucky</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">有权限操作这个名称空间</span></span><br><span class="line"></span><br><span class="line">kubectl get pods</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">没有权限操作其他名称空间</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">添加一个 lucky 的普通用户</span></span><br><span class="line">useradd lucky</span><br><span class="line"></span><br><span class="line">cp -ar /root/.kube/ /home/lucky/</span><br><span class="line"></span><br><span class="line">chown -R lucky.lucky /home/lucky/</span><br><span class="line"></span><br><span class="line">su - lucky</span><br><span class="line"></span><br><span class="line">kubectl get pods -n lucky</span><br></pre></td></tr></table></figure>



</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="http://example.com">૮(˶ᵔ ᵕ ᵔ˶)ა</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="http://example.com/2024/10/22/HXC-Kubernetes/">http://example.com/2024/10/22/HXC-Kubernetes/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="http://example.com" target="_blank">૮(˶ᵔ ᵕ ᵔ˶)ა</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/Kubernetes/">Kubernetes</a></div><div class="post_share"><div class="social-share" data-image="/../images/title/k8s1.png" data-sites="wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2024/10/20/SRE-%E6%96%87%E4%BB%B6%E6%9F%A5%E6%89%BE%E5%92%8C%E6%89%93%E5%8C%85%E5%8E%8B%E7%BC%A9/" title="文件查找和打包压缩"><img class="cover" src="/../images/title/linux1.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">文件查找和打包压缩</div></div></a></div><div class="next-post pull-right"><a href="/2024/10/24/HXC-Prometheus+Alertmanager%E6%9E%84%E5%BB%BA%E7%9B%91%E6%8E%A7%E7%B3%BB%E7%BB%9F/" title="Prometheus+Grafana+Alertmanager 构建监控系统"><img class="cover" src="/../images/title/k8s2.png" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">Prometheus+Grafana+Alertmanager 构建监控系统</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><div><a href="/2023/04/15/DN-kubernetes/" title="Kubernetes"><img class="cover" src="/../images/title/k8s5.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-04-15</div><div class="title">Kubernetes</div></div></a></div><div><a href="/2023/08/11/DX-K8s%E5%B9%B3%E5%8F%B0%E9%83%A8%E7%BD%B2%E4%B8%8E%E5%9F%BA%E7%A1%80%E8%BF%90%E7%BB%B4/" title="k8s：(1)K8s平台部署与基础运维"><img class="cover" src="/../images/title/k8s2.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-08-11</div><div class="title">k8s：(1)K8s平台部署与基础运维</div></div></a></div><div><a href="/2023/08/11/DX-kubevirt%E8%BF%90%E7%BB%B4%E6%A1%88%E4%BE%8B/" title="k8s：(8)kubevirt运维案例"><img class="cover" src="/../images/title/kubevirt.jpeg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-08-11</div><div class="title">k8s：(8)kubevirt运维案例</div></div></a></div><div><a href="/2023/08/11/DX-%E5%9F%BA%E4%BA%8EHelm3%E5%AE%9E%E7%8E%B0%E6%9C%8D%E5%8A%A1%E5%8F%91%E5%B8%83%E6%A1%88%E4%BE%8B/" title="k8s：(6)基于Helm3实现服务发布案例"><img class="cover" src="/../images/title/helm.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-08-11</div><div class="title">k8s：(6)基于Helm3实现服务发布案例</div></div></a></div><div><a href="/2023/08/11/DX-%E5%9F%BA%E4%BA%8EKubernetes+Istio%E5%AE%9E%E7%8E%B0%E7%81%B0%E5%BA%A6%E5%8F%91%E5%B8%83%E6%A1%88%E4%BE%8B/" title="k8s：(5)基于Kubernetes+Istio实现灰度发布案例"><img class="cover" src="/../images/title/istio.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-08-11</div><div class="title">k8s：(5)基于Kubernetes+Istio实现灰度发布案例</div></div></a></div><div><a href="/2023/08/11/DX-%E5%9F%BA%E4%BA%8EKubernetes%E6%9E%84%E5%BB%BACICD%E6%A1%88%E4%BE%8B/" title="k8s：(7)基于Kubernetes构建CICD案例"><img class="cover" src="/../images/title/cicd.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-08-11</div><div class="title">k8s：(7)基于Kubernetes构建CICD案例</div></div></a></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="/../images/title/user.webp" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">૮(˶ᵔ ᵕ ᵔ˶)ა</div><div class="author-info__description">这家伙很勤奋，什么都留下了</div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">87</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">29</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">4</div></a></div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content is-expand"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Kubernetes%E7%AE%80%E4%BB%8B"><span class="toc-number">1.</span> <span class="toc-text">Kubernetes简介</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#kubernetes%E8%B5%B7%E6%BA%90"><span class="toc-number">1.1.</span> <span class="toc-text">kubernetes起源</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Kubernetes%E6%9E%B6%E6%9E%84"><span class="toc-number">1.2.</span> <span class="toc-text">Kubernetes架构</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Kubernetes%E7%BB%84%E4%BB%B6"><span class="toc-number">1.3.</span> <span class="toc-text">Kubernetes组件</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Master-node"><span class="toc-number">1.3.1.</span> <span class="toc-text">Master node</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Work-node"><span class="toc-number">1.3.2.</span> <span class="toc-text">Work node</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%90%84%E7%BB%84%E4%BB%B6%E8%A7%A3%E6%9E%90"><span class="toc-number">1.3.3.</span> <span class="toc-text">各组件解析</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Kubernetes%E6%A0%B8%E5%BF%83%E8%B5%84%E6%BA%90%E8%A7%A3%E8%AF%BB"><span class="toc-number">1.4.</span> <span class="toc-text">Kubernetes核心资源解读</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Pod"><span class="toc-number">1.4.1.</span> <span class="toc-text">Pod</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#label"><span class="toc-number">1.4.2.</span> <span class="toc-text">label</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Deployment"><span class="toc-number">1.4.3.</span> <span class="toc-text">Deployment</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Service"><span class="toc-number">1.4.4.</span> <span class="toc-text">Service</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#kubeadm%E5%AE%89%E8%A3%85%E9%AB%98%E5%8F%AF%E7%94%A8%E7%9A%84k8s%E9%9B%86%E7%BE%A4"><span class="toc-number">2.</span> <span class="toc-text">kubeadm安装高可用的k8s集群</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#k8s%E7%8E%AF%E5%A2%83%E8%A7%84%E5%88%92"><span class="toc-number">2.1.</span> <span class="toc-text">k8s环境规划</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%9D%E5%A7%8B%E5%8C%96%E5%AE%9E%E9%AA%8C%E7%8E%AF%E5%A2%83"><span class="toc-number">2.2.</span> <span class="toc-text">初始化实验环境</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%89%E8%A3%85docker"><span class="toc-number">2.3.</span> <span class="toc-text">安装docker</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%89%E8%A3%85%E5%88%9D%E5%A7%8B%E5%8C%96-k8s-%E9%9C%80%E8%A6%81%E7%9A%84%E8%BD%AF%E4%BB%B6%E5%8C%85"><span class="toc-number">2.4.</span> <span class="toc-text">安装初始化 k8s 需要的软件包</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%80%9A%E8%BF%87-keepalive-nginx-%E5%AE%9E%E7%8E%B0-k8s-apiserver-%E8%8A%82%E7%82%B9%E9%AB%98%E5%8F%AF%E7%94%A8"><span class="toc-number">2.5.</span> <span class="toc-text">通过 keepalive+nginx 实现 k8s apiserver 节点高可用</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#kubeadm-%E5%88%9D%E5%A7%8B%E5%8C%96-k8s-%E9%9B%86%E7%BE%A4"><span class="toc-number">2.6.</span> <span class="toc-text">kubeadm 初始化 k8s 集群</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%89%A9%E5%AE%B9-k8s-%E9%9B%86%E7%BE%A4-%E6%B7%BB%E5%8A%A0-master-%E8%8A%82%E7%82%B9"><span class="toc-number">2.7.</span> <span class="toc-text">扩容 k8s 集群-添加 master 节点</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%89%A9%E5%AE%B9-k8s-%E9%9B%86%E7%BE%A4-%E6%B7%BB%E5%8A%A0-node-%E8%8A%82%E7%82%B9"><span class="toc-number">2.8.</span> <span class="toc-text">扩容 k8s 集群-添加 node 节点</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%89%E8%A3%85-kubernetes-%E7%BD%91%E7%BB%9C%E7%BB%84%E4%BB%B6-Calico"><span class="toc-number">2.9.</span> <span class="toc-text">安装 kubernetes 网络组件-Calico</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%BA%8C%E8%BF%9B%E5%88%B6%E5%AE%89%E8%A3%85%E5%A4%9Amaster%E7%9A%84k8s%E9%9B%86%E7%BE%A4"><span class="toc-number">3.</span> <span class="toc-text">二进制安装多master的k8s集群</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#k8s%E7%8E%AF%E5%A2%83%E8%A7%84%E5%88%92-1"><span class="toc-number">3.1.</span> <span class="toc-text">k8s环境规划</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%9D%E5%A7%8B%E5%8C%96"><span class="toc-number">3.2.</span> <span class="toc-text">初始化</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%90%AD%E5%BB%BAetcd%E9%9B%86%E7%BE%A4"><span class="toc-number">3.3.</span> <span class="toc-text">搭建etcd集群</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%89%E8%A3%85kubernetes%E7%BB%84%E4%BB%B6"><span class="toc-number">3.4.</span> <span class="toc-text">安装kubernetes组件</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%8B%E8%BD%BD%E5%AE%89%E8%A3%85%E5%8C%85"><span class="toc-number">3.4.1.</span> <span class="toc-text">下载安装包</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%83%A8%E7%BD%B2apiserver%E7%BB%84%E4%BB%B6"><span class="toc-number">3.4.2.</span> <span class="toc-text">部署apiserver组件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%83%A8%E7%BD%B2kubectl%E7%BB%84%E4%BB%B6"><span class="toc-number">3.4.3.</span> <span class="toc-text">部署kubectl组件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%83%A8%E7%BD%B2-kube-controller-manager-%E7%BB%84%E4%BB%B6"><span class="toc-number">3.4.4.</span> <span class="toc-text">部署 kube-controller-manager 组件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%83%A8%E7%BD%B2kube-scheduler%E7%BB%84%E4%BB%B6"><span class="toc-number">3.4.5.</span> <span class="toc-text">部署kube-scheduler组件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AF%BC%E5%85%A5%E7%A6%BB%E7%BA%BF%E9%95%9C%E5%83%8F%E5%8E%8B%E7%BC%A9%E5%8C%85"><span class="toc-number">3.4.6.</span> <span class="toc-text">导入离线镜像压缩包</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%83%A8%E7%BD%B2kubelet%E7%BB%84%E4%BB%B6"><span class="toc-number">3.4.7.</span> <span class="toc-text">部署kubelet组件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%83%A8%E7%BD%B2kube-proxy%E7%BB%84%E4%BB%B6"><span class="toc-number">3.4.8.</span> <span class="toc-text">部署kube-proxy组件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%83%A8%E7%BD%B2calico%E7%BB%84%E4%BB%B6"><span class="toc-number">3.4.9.</span> <span class="toc-text">部署calico组件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%83%A8%E7%BD%B2coredns%E7%BB%84%E4%BB%B6"><span class="toc-number">3.4.10.</span> <span class="toc-text">部署coredns组件</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%B5%8B%E8%AF%95k8s%E9%9B%86%E7%BE%A4%E9%83%A8%E7%BD%B2tomcat"><span class="toc-number">3.5.</span> <span class="toc-text">测试k8s集群部署tomcat</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%AA%8C%E8%AF%81cordns"><span class="toc-number">3.6.</span> <span class="toc-text">验证cordns</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%89%E8%A3%85keepalived-nginx%E5%AE%9E%E7%8E%B0k8s%E9%AB%98%E5%8F%AF%E7%94%A8"><span class="toc-number">3.7.</span> <span class="toc-text">安装keepalived+nginx实现k8s高可用</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%9F%BA%E4%BA%8Econtainerd%E5%AE%89%E8%A3%85k8s1-26%E9%9B%86%E7%BE%A4"><span class="toc-number">4.</span> <span class="toc-text">基于containerd安装k8s1.26集群</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#k8s%E7%8E%AF%E5%A2%83%E8%A7%84%E5%88%92-2"><span class="toc-number">4.1.</span> <span class="toc-text">k8s环境规划</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%9D%E5%A7%8B%E5%8C%96-1"><span class="toc-number">4.2.</span> <span class="toc-text">初始化</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%89%E8%A3%85containerd%E6%9C%8D%E5%8A%A1"><span class="toc-number">4.3.</span> <span class="toc-text">安装containerd服务</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%89%E8%A3%85docker-ce"><span class="toc-number">4.4.</span> <span class="toc-text">安装docker-ce</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%89%E8%A3%85%E5%88%9D%E5%A7%8B%E5%8C%96k8s%E9%9C%80%E8%A6%81%E7%9A%84%E8%BD%AF%E4%BB%B6%E5%8C%85"><span class="toc-number">4.5.</span> <span class="toc-text">安装初始化k8s需要的软件包</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#kubeadm%E5%88%9D%E5%A7%8B%E5%8C%96k8s%E9%9B%86%E7%BE%A4"><span class="toc-number">4.6.</span> <span class="toc-text">kubeadm初始化k8s集群</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%89%A9%E5%AE%B9k8s%E9%9B%86%E7%BE%A4"><span class="toc-number">4.7.</span> <span class="toc-text">扩容k8s集群</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%89%E8%A3%85%E7%BD%91%E7%BB%9C%E7%BB%84%E4%BB%B6calico"><span class="toc-number">4.8.</span> <span class="toc-text">安装网络组件calico</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ctr%E5%92%8Ccrictl%E5%8C%BA%E5%88%AB"><span class="toc-number">4.9.</span> <span class="toc-text">ctr和crictl区别</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#kubeadm%E5%AE%89%E8%A3%85%E5%8D%95master%E5%A4%9Anode%E6%B5%8B%E8%AF%95%E7%8E%AF%E5%A2%83k8s%E9%9B%86%E7%BE%A4"><span class="toc-number">5.</span> <span class="toc-text">kubeadm安装单master多node测试环境k8s集群</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#k8s%E7%8E%AF%E5%A2%83%E8%A7%84%E5%88%92-3"><span class="toc-number">5.1.</span> <span class="toc-text">k8s环境规划</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%9D%E5%A7%8B%E5%8C%96%E5%AE%9E%E9%AA%8C%E7%8E%AF%E5%A2%83-1"><span class="toc-number">5.2.</span> <span class="toc-text">初始化实验环境</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%89%E8%A3%85docker-1"><span class="toc-number">5.3.</span> <span class="toc-text">安装docker</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%89%E8%A3%85%E5%88%9D%E5%A7%8B%E5%8C%96-k8s-%E9%9C%80%E8%A6%81%E7%9A%84%E8%BD%AF%E4%BB%B6%E5%8C%85-1"><span class="toc-number">5.4.</span> <span class="toc-text">安装初始化 k8s 需要的软件包</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#kubeadm-%E5%88%9D%E5%A7%8B%E5%8C%96-k8s-%E9%9B%86%E7%BE%A4-1"><span class="toc-number">5.5.</span> <span class="toc-text">kubeadm 初始化 k8s 集群</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%89%A9%E5%AE%B9k8s%E9%9B%86%E7%BE%A4-%E6%B7%BB%E5%8A%A0node%E8%8A%82%E7%82%B9"><span class="toc-number">5.6.</span> <span class="toc-text">扩容k8s集群-添加node节点</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%89%E8%A3%85kubernetes%E7%BD%91%E7%BB%9C%E7%BB%84%E4%BB%B6calico"><span class="toc-number">5.7.</span> <span class="toc-text">安装kubernetes网络组件calico</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%89%E8%A3%85k8s%E5%8F%AF%E8%A7%86%E5%8C%96UI%E7%95%8C%E9%9D%A2dashboard"><span class="toc-number">5.8.</span> <span class="toc-text">安装k8s可视化UI界面dashboard</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%89%E8%A3%85-metrics-server-%E7%BB%84%E4%BB%B6"><span class="toc-number">5.9.</span> <span class="toc-text">安装 metrics-server 组件</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%8A%8A-scheduler%E3%80%81controller-manager-%E7%AB%AF%E5%8F%A3%E5%8F%98%E6%88%90%E7%89%A9%E7%90%86%E6%9C%BA%E5%8F%AF%E4%BB%A5%E7%9B%91%E5%90%AC%E7%9A%84%E7%AB%AF%E5%8F%A3"><span class="toc-number">5.10.</span> <span class="toc-text">把 scheduler、controller-manager 端口变成物理机可以监听的端口</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Pod%E5%9F%BA%E7%A1%80"><span class="toc-number">6.</span> <span class="toc-text">Pod基础</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#k8s%E6%A0%B8%E5%BF%83%E8%B5%84%E6%BA%90Pod%E4%BB%8B%E7%BB%8D"><span class="toc-number">6.1.</span> <span class="toc-text">k8s核心资源Pod介绍</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Pod%E6%98%AF%E4%BB%80%E4%B9%88"><span class="toc-number">6.1.1.</span> <span class="toc-text">Pod是什么</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Pod-%E5%A6%82%E4%BD%95%E7%AE%A1%E7%90%86%E5%A4%9A%E4%B8%AA%E5%AE%B9%E5%99%A8"><span class="toc-number">6.1.1.1.</span> <span class="toc-text">Pod 如何管理多个容器</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Pod%E7%BD%91%E7%BB%9C"><span class="toc-number">6.1.1.2.</span> <span class="toc-text">Pod网络</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Pod%E5%AD%98%E5%82%A8"><span class="toc-number">6.1.1.3.</span> <span class="toc-text">Pod存储</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Pod%E5%B7%A5%E4%BD%9C%E6%96%B9%E5%BC%8F"><span class="toc-number">6.2.</span> <span class="toc-text">Pod工作方式</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%87%AA%E4%B8%BB%E5%BC%8FPod"><span class="toc-number">6.2.1.</span> <span class="toc-text">自主式Pod</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%8E%A7%E5%88%B6%E5%99%A8%E7%AE%A1%E7%90%86Pod"><span class="toc-number">6.2.2.</span> <span class="toc-text">控制器管理Pod</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Pod%E5%88%9B%E5%BB%BA%E5%85%B7%E4%BD%93%E6%B5%81%E7%A8%8B"><span class="toc-number">6.3.</span> <span class="toc-text">Pod创建具体流程</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Pod-%E8%B5%84%E6%BA%90%E6%B8%85%E5%8D%95%E7%BC%96%E5%86%99%E6%8A%80%E5%B7%A7"><span class="toc-number">6.4.</span> <span class="toc-text">Pod 资源清单编写技巧</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9F%A5%E7%9C%8Bpod-spec%E5%AD%97%E6%AE%B5%E5%A6%82%E4%BD%95%E5%AE%9A%E4%B9%89"><span class="toc-number">6.4.1.</span> <span class="toc-text">查看pod.spec字段如何定义</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9F%A5%E7%9C%8Bpod-spec-containers%E5%AD%97%E6%AE%B5%E5%A6%82%E4%BD%95%E5%AE%9A%E4%B9%89"><span class="toc-number">6.4.2.</span> <span class="toc-text">查看pod.spec.containers字段如何定义</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9F%A5%E7%9C%8Bpod-spec-containers-ports%E5%AD%97%E6%AE%B5%E5%A6%82%E4%BD%95%E5%AE%9A%E4%B9%89"><span class="toc-number">6.4.3.</span> <span class="toc-text">查看pod.spec.containers.ports字段如何定义</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%80%9A%E8%BF%87%E8%B5%84%E6%BA%90%E6%B8%85%E5%8D%95%E6%96%87%E4%BB%B6%E5%88%9B%E5%BB%BAPod"><span class="toc-number">6.5.</span> <span class="toc-text">通过资源清单文件创建Pod</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%80%9A%E8%BF%87kubectl-run%E5%88%9B%E5%BB%BAPod"><span class="toc-number">6.6.</span> <span class="toc-text">通过kubectl run创建Pod</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Pod%E8%B5%84%E6%BA%90%E6%B8%85%E5%8D%95%E8%AF%A6%E7%BB%86%E8%A7%A3%E8%AF%BB"><span class="toc-number">6.7.</span> <span class="toc-text">Pod资源清单详细解读</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%91%BD%E5%90%8D%E7%A9%BA%E9%97%B4"><span class="toc-number">7.</span> <span class="toc-text">命名空间</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BB%80%E4%B9%88%E6%98%AF%E5%91%BD%E5%90%8D%E7%A9%BA%E9%97%B4"><span class="toc-number">7.1.</span> <span class="toc-text">什么是命名空间</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#namespace%E5%BA%94%E7%94%A8%E5%9C%BA%E6%99%AF"><span class="toc-number">7.2.</span> <span class="toc-text">namespace应用场景</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#namespace%E4%BD%BF%E7%94%A8%E6%A1%88%E4%BE%8B"><span class="toc-number">7.3.</span> <span class="toc-text">namespace使用案例</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E4%B8%80%E4%B8%AAtest%E5%91%BD%E5%90%8D%E7%A9%BA%E9%97%B4"><span class="toc-number">7.3.1.</span> <span class="toc-text">创建一个test命名空间</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%87%E6%8D%A2%E5%91%BD%E5%90%8D%E7%A9%BA%E9%97%B4"><span class="toc-number">7.3.2.</span> <span class="toc-text">切换命名空间</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9F%A5%E7%9C%8B%E5%93%AA%E4%BA%9B%E8%B5%84%E6%BA%90%E5%B1%9E%E4%BA%8E%E5%91%BD%E5%90%8D%E7%A9%BA%E9%97%B4%E7%BA%A7%E5%88%AB%E7%9A%84"><span class="toc-number">7.3.3.</span> <span class="toc-text">查看哪些资源属于命名空间级别的</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#namespace-%E8%B5%84%E6%BA%90%E9%99%90%E9%A2%9D"><span class="toc-number">7.3.4.</span> <span class="toc-text">namespace 资源限额</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%A0%87%E7%AD%BE"><span class="toc-number">8.</span> <span class="toc-text">标签</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BB%80%E4%B9%88%E6%98%AF%E6%A0%87%E7%AD%BE"><span class="toc-number">8.1.</span> <span class="toc-text">什么是标签</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BB%99pod%E8%B5%84%E6%BA%90%E6%89%93%E6%A0%87%E7%AD%BE"><span class="toc-number">8.2.</span> <span class="toc-text">给pod资源打标签</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9F%A5%E7%9C%8B%E8%B5%84%E6%BA%90%E6%A0%87%E7%AD%BE"><span class="toc-number">8.3.</span> <span class="toc-text">查看资源标签</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#node%E8%8A%82%E7%82%B9%E9%80%89%E6%8B%A9%E5%99%A8"><span class="toc-number">9.</span> <span class="toc-text">node节点选择器</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#nodeName"><span class="toc-number">9.1.</span> <span class="toc-text">nodeName</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#nodeSelector"><span class="toc-number">9.2.</span> <span class="toc-text">nodeSelector</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%BA%B2%E5%92%8C%E3%80%81%E6%B1%A1%E7%82%B9%E5%92%8C%E5%AE%B9%E5%BF%8D%E5%BA%A6"><span class="toc-number">10.</span> <span class="toc-text">亲和、污点和容忍度</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#node%E8%8A%82%E7%82%B9%E4%BA%B2%E5%92%8C%E6%80%A7"><span class="toc-number">10.1.</span> <span class="toc-text">node节点亲和性</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Pod%E8%8A%82%E7%82%B9%E4%BA%B2%E5%92%8C%E6%80%A7"><span class="toc-number">10.2.</span> <span class="toc-text">Pod节点亲和性</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%B1%A1%E7%82%B9%EF%BC%8C%E5%AE%B9%E5%BF%8D%E5%BA%A6"><span class="toc-number">10.3.</span> <span class="toc-text">污点，容忍度</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Pod%E5%B8%B8%E8%A7%81%E7%9A%84%E7%8A%B6%E6%80%81%E5%92%8C%E9%87%8D%E5%90%AF%E7%AD%96%E7%95%A5"><span class="toc-number">11.</span> <span class="toc-text">Pod常见的状态和重启策略</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%B8%B8%E8%A7%81%E7%9A%84Pod%E7%8A%B6%E6%80%81"><span class="toc-number">11.1.</span> <span class="toc-text">常见的Pod状态</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Pod%E9%87%8D%E5%90%AF%E7%AD%96%E7%95%A5"><span class="toc-number">11.2.</span> <span class="toc-text">Pod重启策略</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Pod%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F"><span class="toc-number">12.</span> <span class="toc-text">Pod生命周期</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Init%E5%AE%B9%E5%99%A8"><span class="toc-number">12.1.</span> <span class="toc-text">Init容器</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%BB%E5%AE%B9%E5%99%A8"><span class="toc-number">12.2.</span> <span class="toc-text">主容器</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA-pod-%E9%9C%80%E8%A6%81%E7%BB%8F%E8%BF%87%E7%9A%84%E9%98%B6%E6%AE%B5"><span class="toc-number">12.3.</span> <span class="toc-text">创建 pod 需要经过的阶段</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Pod%E5%AE%B9%E5%99%A8%E6%8E%A2%E6%B5%8B%E5%92%8C%E9%92%A9%E5%AD%90"><span class="toc-number">13.</span> <span class="toc-text">Pod容器探测和钩子</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%B9%E5%99%A8%E9%92%A9%E5%AD%90"><span class="toc-number">13.1.</span> <span class="toc-text">容器钩子</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AD%98%E6%B4%BB%E6%80%A7%E6%8E%A2%E6%B5%8B%E5%92%8C%E5%B0%B1%E7%BB%AA%E6%80%A7%E6%8E%A2%E6%B5%8B"><span class="toc-number">13.2.</span> <span class="toc-text">存活性探测和就绪性探测</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%A4%E7%A7%8D%E6%8E%A2%E9%92%88%E5%8C%BA%E5%88%AB"><span class="toc-number">13.2.1.</span> <span class="toc-text">两种探针区别</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Pod%E6%8E%A2%E9%92%88%E4%BD%BF%E7%94%A8"><span class="toc-number">13.2.2.</span> <span class="toc-text">Pod探针使用</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%90%AF%E5%8A%A8%E6%8E%A2%E6%B5%8B"><span class="toc-number">13.3.</span> <span class="toc-text">启动探测</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#k8s-%E6%8E%A7%E5%88%B6%E5%99%A8%EF%BC%9AReplicaset"><span class="toc-number">14.</span> <span class="toc-text">k8s 控制器：Replicaset</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Replicaset-%E6%A6%82%E8%BF%B0"><span class="toc-number">14.1.</span> <span class="toc-text">Replicaset 概述</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Replicaset-%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86"><span class="toc-number">14.2.</span> <span class="toc-text">Replicaset 工作原理</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Replicaset-%E8%B5%84%E6%BA%90%E6%B8%85%E5%8D%95%E6%96%87%E4%BB%B6"><span class="toc-number">14.3.</span> <span class="toc-text">Replicaset 资源清单文件</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Replicaset-%E4%BD%BF%E7%94%A8%E6%A1%88%E4%BE%8B"><span class="toc-number">14.4.</span> <span class="toc-text">Replicaset 使用案例</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#k8s-%E6%8E%A7%E5%88%B6%E5%99%A8%EF%BC%9ADeployment"><span class="toc-number">15.</span> <span class="toc-text">k8s 控制器：Deployment</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Deployment-%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86"><span class="toc-number">15.1.</span> <span class="toc-text">Deployment 工作原理</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Deployment-%E8%B5%84%E6%BA%90%E6%B8%85%E5%8D%95%E6%96%87%E4%BB%B6"><span class="toc-number">15.2.</span> <span class="toc-text">Deployment 资源清单文件</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Deployment%E6%A1%88%E4%BE%8B"><span class="toc-number">15.3.</span> <span class="toc-text">Deployment案例</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%89%A9%E5%AE%B9%E3%80%81%E7%BC%A9%E5%AE%B9%E3%80%81%E6%BB%9A%E5%8A%A8%E6%9B%B4%E6%96%B0%E3%80%81%E5%9B%9E%E6%BB%9A"><span class="toc-number">15.4.</span> <span class="toc-text">扩容、缩容、滚动更新、回滚</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89%E6%BB%9A%E5%8A%A8%E6%9B%B4%E6%96%B0%E7%AD%96%E7%95%A5"><span class="toc-number">15.5.</span> <span class="toc-text">自定义滚动更新策略</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8F%96%E5%80%BC%E8%8C%83%E5%9B%B4"><span class="toc-number">15.5.1.</span> <span class="toc-text">取值范围</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89%E7%AD%96%E7%95%A5"><span class="toc-number">15.5.2.</span> <span class="toc-text">自定义策略</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#k8s-%E5%9B%9B%E5%B1%82%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1-service"><span class="toc-number">16.</span> <span class="toc-text">k8s 四层负载均衡-service</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%A6%82%E5%BF%B5%E3%80%81%E5%8E%9F%E7%90%86%E8%A7%A3%E8%AF%BB"><span class="toc-number">16.1.</span> <span class="toc-text">概念、原理解读</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%9B%E5%BB%BAService%E8%B5%84%E6%BA%90"><span class="toc-number">16.2.</span> <span class="toc-text">创建Service资源</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Service-%E7%9A%84%E5%9B%9B%E7%A7%8D%E7%B1%BB%E5%9E%8B"><span class="toc-number">16.2.1.</span> <span class="toc-text">Service 的四种类型</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Service-%E7%9A%84%E7%AB%AF%E5%8F%A3"><span class="toc-number">16.2.2.</span> <span class="toc-text">Service 的端口</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#k8s-%E5%AE%9E%E8%B7%B5%EF%BC%9A%E6%98%A0%E5%B0%84%E5%A4%96%E9%83%A8%E6%9C%8D%E5%8A%A1"><span class="toc-number">16.3.</span> <span class="toc-text">k8s 实践：映射外部服务</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Service-%E4%BB%A3%E7%90%86%EF%BC%9Akube-proxy-%E7%BB%84%E4%BB%B6%E8%AF%A6%E8%A7%A3"><span class="toc-number">16.4.</span> <span class="toc-text">Service 代理：kube-proxy 组件详解</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#kube-proxy-%E7%BB%84%E4%BB%B6%E4%BB%8B%E7%BB%8D"><span class="toc-number">16.4.1.</span> <span class="toc-text">kube-proxy 组件介绍</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#kube-proxy-%E4%B8%89%E7%A7%8D%E5%B7%A5%E4%BD%9C%E6%A8%A1%E5%BC%8F"><span class="toc-number">16.4.2.</span> <span class="toc-text">kube-proxy 三种工作模式</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#kube-proxy-%E7%94%9F%E6%88%90%E7%9A%84-iptables-%E8%A7%84%E5%88%99"><span class="toc-number">16.4.3.</span> <span class="toc-text">kube-proxy 生成的 iptables 规则</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Service-%E6%9C%8D%E5%8A%A1%E5%8F%91%E7%8E%B0%EF%BC%9Acoredns-%E7%BB%84%E4%BB%B6"><span class="toc-number">16.5.</span> <span class="toc-text">Service 服务发现：coredns 组件</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#DNS-%E6%98%AF%E4%BB%80%E4%B9%88"><span class="toc-number">16.5.1.</span> <span class="toc-text">DNS 是什么</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#CoreDNS"><span class="toc-number">16.5.2.</span> <span class="toc-text">CoreDNS</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#k8s%E6%8C%81%E4%B9%85%E5%8C%96%E5%AD%98%E5%82%A8"><span class="toc-number">17.</span> <span class="toc-text">k8s持久化存储</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#k8s%E6%8C%81%E4%B9%85%E5%8C%96%E5%AD%98%E5%82%A8%EF%BC%9AemptyDir"><span class="toc-number">17.1.</span> <span class="toc-text">k8s持久化存储：emptyDir</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#k8s%E6%8C%81%E4%B9%85%E5%8C%96%E5%AD%98%E5%82%A8%EF%BC%9AhostPath"><span class="toc-number">17.2.</span> <span class="toc-text">k8s持久化存储：hostPath</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#k8s%E6%8C%81%E4%B9%85%E5%8C%96%E5%AD%98%E5%82%A8%EF%BC%9Anfs"><span class="toc-number">17.3.</span> <span class="toc-text">k8s持久化存储：nfs</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#k8s%E6%8C%81%E4%B9%85%E5%8C%96%E5%AD%98%E5%82%A8%EF%BC%9APVC"><span class="toc-number">17.4.</span> <span class="toc-text">k8s持久化存储：PVC</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#k8s-PVC-%E5%92%8C-PV-%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86"><span class="toc-number">17.4.1.</span> <span class="toc-text">k8s PVC 和 PV 工作原理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA-pod%EF%BC%8C%E4%BD%BF%E7%94%A8-pvc-%E4%BD%9C%E4%B8%BA%E6%8C%81%E4%B9%85%E5%AD%98%E5%82%A8%E5%8D%B7"><span class="toc-number">17.4.2.</span> <span class="toc-text">创建 pod，使用 pvc 作为持久存储卷</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#k8s-%E5%AD%98%E5%82%A8%E7%B1%BB%EF%BC%9Astorageclass"><span class="toc-number">17.5.</span> <span class="toc-text">k8s 存储类：storageclass</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#k8s-%E6%8E%A7%E5%88%B6%E5%99%A8%EF%BC%9AStatefulSet"><span class="toc-number">18.</span> <span class="toc-text">k8s 控制器：StatefulSet</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%A6%82%E5%BF%B5%E3%80%81%E5%8E%9F%E7%90%86%E8%A7%A3%E8%AF%BB-1"><span class="toc-number">18.1.</span> <span class="toc-text">概念、原理解读</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Statefulset-%E8%B5%84%E6%BA%90%E6%B8%85%E5%8D%95%E6%96%87%E4%BB%B6%E7%BC%96%E5%86%99%E6%8A%80%E5%B7%A7"><span class="toc-number">18.2.</span> <span class="toc-text">Statefulset 资源清单文件编写技巧</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Statefulset-%E4%BD%BF%E7%94%A8%E6%A1%88%E4%BE%8B%EF%BC%9A%E9%83%A8%E7%BD%B2-web-%E7%AB%99%E7%82%B9"><span class="toc-number">18.3.</span> <span class="toc-text">Statefulset 使用案例：部署 web 站点</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Statefulset-%E7%AE%A1%E7%90%86-pod%EF%BC%9A%E6%89%A9%E5%AE%B9%E3%80%81%E7%BC%A9%E5%AE%B9%E3%80%81%E6%9B%B4%E6%96%B0"><span class="toc-number">18.4.</span> <span class="toc-text">Statefulset 管理 pod：扩容、缩容、更新</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#k8s-%E6%8E%A7%E5%88%B6%E5%99%A8%EF%BC%9ADaemonset"><span class="toc-number">19.</span> <span class="toc-text">k8s 控制器：Daemonset</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#DaemonSet-%E6%8E%A7%E5%88%B6%E5%99%A8%EF%BC%9A%E6%A6%82%E5%BF%B5%E3%80%81%E5%8E%9F%E7%90%86%E8%A7%A3%E8%AF%BB"><span class="toc-number">19.1.</span> <span class="toc-text">DaemonSet 控制器：概念、原理解读</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#DaemonSet-%E8%B5%84%E6%BA%90%E6%B8%85%E5%8D%95%E6%96%87%E4%BB%B6%E7%BC%96%E5%86%99%E6%8A%80%E5%B7%A7"><span class="toc-number">19.2.</span> <span class="toc-text">DaemonSet 资源清单文件编写技巧</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#DaemonSet-%E4%BD%BF%E7%94%A8%E6%A1%88%E4%BE%8B"><span class="toc-number">19.3.</span> <span class="toc-text">DaemonSet 使用案例</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Daemonset-%E7%AE%A1%E7%90%86-pod%EF%BC%9A%E6%BB%9A%E5%8A%A8%E6%9B%B4%E6%96%B0"><span class="toc-number">19.4.</span> <span class="toc-text">Daemonset 管理 pod：滚动更新</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE%E7%AE%A1%E7%90%86%E4%B8%AD%E5%BF%83-configmap"><span class="toc-number">20.</span> <span class="toc-text">配置管理中心 configmap</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Configmap-%E6%A6%82%E8%BF%B0"><span class="toc-number">20.1.</span> <span class="toc-text">Configmap 概述</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Configmap-%E5%88%9B%E5%BB%BA%E6%96%B9%E6%B3%95"><span class="toc-number">20.2.</span> <span class="toc-text">Configmap 创建方法</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8-ConfigMap"><span class="toc-number">20.3.</span> <span class="toc-text">使用 ConfigMap</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ConfigMap-%E7%83%AD%E6%9B%B4%E6%96%B0"><span class="toc-number">20.4.</span> <span class="toc-text">ConfigMap 热更新</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE%E7%AE%A1%E7%90%86%E4%B8%AD%E5%BF%83-Secret"><span class="toc-number">21.</span> <span class="toc-text">配置管理中心 Secret</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Secret-%E6%A6%82%E8%BF%B0"><span class="toc-number">21.1.</span> <span class="toc-text">Secret 概述</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8-Secret"><span class="toc-number">21.2.</span> <span class="toc-text">使用 Secret</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#k8s-%E5%AE%89%E5%85%A8%E7%AE%A1%E7%90%86%EF%BC%9ARBAC%E6%8E%88%E6%9D%83"><span class="toc-number">22.</span> <span class="toc-text">k8s 安全管理：RBAC授权</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%AE%A4%E8%AF%81%E3%80%81%E6%8E%88%E6%9D%83%E3%80%81%E5%87%86%E5%85%A5%E6%8E%A7%E5%88%B6%E6%A6%82%E8%BF%B0"><span class="toc-number">22.1.</span> <span class="toc-text">认证、授权、准入控制概述</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%AE%A4%E8%AF%81"><span class="toc-number">22.1.1.</span> <span class="toc-text">认证</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%8E%88%E6%9D%83"><span class="toc-number">22.1.2.</span> <span class="toc-text">授权</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%87%86%E5%85%A5%E6%8E%A7%E5%88%B6"><span class="toc-number">22.1.3.</span> <span class="toc-text">准入控制</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ServiceAccount-%E4%BB%8B%E7%BB%8D"><span class="toc-number">22.2.</span> <span class="toc-text">ServiceAccount 介绍</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#RBAC-%E8%AE%A4%E8%AF%81%E6%8E%88%E6%9D%83%E7%AD%96%E7%95%A5"><span class="toc-number">22.3.</span> <span class="toc-text">RBAC 认证授权策略</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Role%EF%BC%9A%E8%A7%92%E8%89%B2"><span class="toc-number">22.3.1.</span> <span class="toc-text">Role：角色</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ClusterRole%EF%BC%9A%E9%9B%86%E7%BE%A4%E8%A7%92%E8%89%B2"><span class="toc-number">22.3.2.</span> <span class="toc-text">ClusterRole：集群角色</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#RoleBinding-amp-amp-ClusterRolebinding"><span class="toc-number">22.3.3.</span> <span class="toc-text">RoleBinding &amp;&amp; ClusterRolebinding</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%B5%84%E6%BA%90%E7%9A%84%E5%BC%95%E7%94%A8%E6%96%B9%E5%BC%8F"><span class="toc-number">22.4.</span> <span class="toc-text">资源的引用方式</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%B8%B8%E8%A7%81%E8%A7%92%E8%89%B2%E7%A4%BA%E4%BE%8B"><span class="toc-number">22.5.</span> <span class="toc-text">常见角色示例</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%B8%B8%E8%A7%81%E7%9A%84%E8%A7%92%E8%89%B2%E7%BB%91%E5%AE%9A%E7%A4%BA%E4%BE%8B"><span class="toc-number">22.6.</span> <span class="toc-text">常见的角色绑定示例</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AF%B9-Service-Account-%E7%9A%84%E6%8E%88%E6%9D%83%E7%AE%A1%E7%90%86"><span class="toc-number">22.7.</span> <span class="toc-text">对 Service Account 的授权管理</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8-kubectl-%E5%91%BD%E4%BB%A4%E8%A1%8C%E5%B7%A5%E5%85%B7%E5%88%9B%E5%BB%BA%E8%B5%84%E6%BA%90%E5%AF%B9%E8%B1%A1"><span class="toc-number">22.8.</span> <span class="toc-text">使用 kubectl 命令行工具创建资源对象</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%99%90%E5%88%B6%E4%B8%8D%E5%90%8C%E7%9A%84%E7%94%A8%E6%88%B7%E6%93%8D%E4%BD%9C-k8s-%E9%9B%86%E7%BE%A4"><span class="toc-number">22.9.</span> <span class="toc-text">限制不同的用户操作 k8s 集群</span></a></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2025/02/18/SRE-OpenVPN/" title="OpenVPN"><img src="/../images/image/SRE/day25/5.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="OpenVPN"/></a><div class="content"><a class="title" href="/2025/02/18/SRE-OpenVPN/" title="OpenVPN">OpenVPN</a><time datetime="2025-02-18T09:33:52.000Z" title="发表于 2025-02-18 17:33:52">2025-02-18</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2025/02/17/SRE-MySQL/" title="MySQL"><img src="/../images/title/mysql.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="MySQL"/></a><div class="content"><a class="title" href="/2025/02/17/SRE-MySQL/" title="MySQL">MySQL</a><time datetime="2025-02-17T04:27:15.000Z" title="发表于 2025-02-17 12:27:15">2025-02-17</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2024/12/08/SRE-linux%E5%91%BD%E4%BB%A4%E7%B4%A2%E5%BC%95/" title="linux命令索引"><img src="/../images/title/linux3.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="linux命令索引"/></a><div class="content"><a class="title" href="/2024/12/08/SRE-linux%E5%91%BD%E4%BB%A4%E7%B4%A2%E5%BC%95/" title="linux命令索引">linux命令索引</a><time datetime="2024-12-08T12:10:30.000Z" title="发表于 2024-12-08 20:10:30">2024-12-08</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2024/12/08/SRE-Linux%E9%98%B2%E7%81%AB%E5%A2%99/" title="Linux防火墙"><img src="/../images/image/SRE/day17/12.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Linux防火墙"/></a><div class="content"><a class="title" href="/2024/12/08/SRE-Linux%E9%98%B2%E7%81%AB%E5%A2%99/" title="Linux防火墙">Linux防火墙</a><time datetime="2024-12-08T08:10:35.000Z" title="发表于 2024-12-08 16:10:35">2024-12-08</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2023 - 2025 By ૮(˶ᵔ ᵕ ᵔ˶)ა</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div><div class="footer_custom_text"><a target="_blank" rel="noopener" href="https://beian.miit.gov.cn/#/Integrated/index"><img src="https://jihulab.com/wsq1203/images/-/raw/main/gonganbeian/icp.png" width="15" height="15">豫ICP备2023009931号</a></br><a href="http://www.beian.gov.cn/portal/registerSystemInfo?recordcode=41162702000178" target="_blank"><img src="https://jihulab.com/wsq1203/images/-/raw/main/gonganbeian/beian.png" width="15" height="15">豫公网安备 41162702000178号</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.umd.min.js"></script><script src="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.js"></script><script>function panguFn () {
  if (typeof pangu === 'object') pangu.autoSpacingPage()
  else {
    getScript('https://cdn.jsdelivr.net/npm/pangu/dist/browser/pangu.min.js')
      .then(() => {
        pangu.autoSpacingPage()
      })
  }
}

function panguInit () {
  if (true){
    GLOBAL_CONFIG_SITE.isPost && panguFn()
  } else {
    panguFn()
  }
}

document.addEventListener('DOMContentLoaded', panguInit)</script><div class="js-pjax"></div><canvas id="universe"></canvas><script src="/js/universe.js"></script><canvas class="fireworks" mobile="true"></canvas><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/fireworks.min.js"></script><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/activate-power-mode.min.js"></script><script>POWERMODE.colorful = true;
POWERMODE.shake = false;
POWERMODE.mobile = false;
document.body.addEventListener('input', POWERMODE);
</script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>