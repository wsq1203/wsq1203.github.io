<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>企业级容器技术Docker | ૮(˶ᵔ ᵕ ᵔ˶)ა</title><meta name="author" content="૮(˶ᵔ ᵕ ᵔ˶)ა"><meta name="copyright" content="૮(˶ᵔ ᵕ ᵔ˶)ა"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="ffffff"><meta name="description" content="Site Reliability Engineering">
<meta property="og:type" content="article">
<meta property="og:title" content="企业级容器技术Docker">
<meta property="og:url" content="http://example.com/2025/04/13/SRE-docker/index.html">
<meta property="og:site_name" content="૮(˶ᵔ ᵕ ᵔ˶)ა">
<meta property="og:description" content="Site Reliability Engineering">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://example.com/images/SRE/day46/1.jpg">
<meta property="article:published_time" content="2025-04-13T09:39:38.000Z">
<meta property="article:modified_time" content="2025-04-13T09:43:08.114Z">
<meta property="article:author" content="૮(˶ᵔ ᵕ ᵔ˶)ა">
<meta property="article:tag" content="Docker">
<meta property="article:tag" content="SRE">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://example.com/images/SRE/day46/1.jpg"><link rel="shortcut icon" href="/../images/TITLE/user.webp"><link rel="canonical" href="http://example.com/2025/04/13/SRE-docker/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//fonts.googleapis.com" crossorigin=""/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Titillium+Web&amp;display=swap" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":false,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: true,
    post: true
  },
  runtime: '天',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: {"chs_to_cht":"你已切换为繁体","cht_to_chs":"你已切换为简体","day_to_night":"你已切换为深色模式","night_to_day":"你已切换为浅色模式","bgLight":"#49b1f5","bgDark":"#1f1f1f","position":"top-center"},
  source: {
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: true,
  }
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: '企业级容器技术Docker',
  isPost: true,
  isHome: false,
  isHighlightShrink: undefined,
  isToc: true,
  postUpdate: '2025-04-13 17:43:08'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
    win.getCSS = (url,id = false) => new Promise((resolve, reject) => {
      const link = document.createElement('link')
      link.rel = 'stylesheet'
      link.href = url
      if (id) link.id = id
      link.onerror = reject
      link.onload = link.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        link.onload = link.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(link)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', 'ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><link rel="stylesheet" href="/css/custom.css"  media="defer" onload="this.media='all'"><meta name="generator" content="Hexo 5.4.2"></head><body><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="/../images/TITLE/user.webp" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">97</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">37</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">30</div></a></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间线</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('/../images/SRE/day46/1.jpg')"><nav id="nav"><span id="blog-info"><a href="/" title="૮(˶ᵔ ᵕ ᵔ˶)ა"><span class="site-name">૮(˶ᵔ ᵕ ᵔ˶)ა</span></a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间线</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">企业级容器技术Docker</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2025-04-13T09:39:38.000Z" title="发表于 2025-04-13 17:39:38">2025-04-13</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2025-04-13T09:43:08.114Z" title="更新于 2025-04-13 17:43:08">2025-04-13</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/Docker/">Docker</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">字数总计:</span><span class="word-count">117.9k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>602分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="企业级容器技术Docker"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="Docker-介绍和基础操作"><a href="#Docker-介绍和基础操作" class="headerlink" title="Docker 介绍和基础操作"></a>Docker 介绍和基础操作</h1><p><img src="../../../../images/SRE/day46/1.jpg" alt="1"></p>
<p>Container 即容器，平时生活中指的是可以装下其它物品的工具， 以方便人类归纳放置物品 、存储和异地运输 ，比如人类使用的衣柜 、行李箱、 背包等可以成为容器，Container 除了容器以外，另一个意思是集装箱, 很多码头工人将很多装有不同物品但却整齐划一的箱子装载到停靠在岸边大船，然后方便的运来运去。</p>
<p><img src="../../../../images/SRE/day46/2.jpg" alt="2"></p>
<p>容器其实是一种沙盒技术。顾名思义，沙盒就是能够像一个集装箱一样，把你的应用装起来。这样，应用与应用之间就有了边界而不会相互干扰;同时装在沙盒里面的应用，也可以很方便的被搬来搬去，这也是 PaaS 想要的最理想的状态( 可移植性,标准化,隔离性 )。</p>
<p>容器是软件工业上的集装箱的技术，集装箱的标准化，减少了包装成本，大大提高货物运输和装卸效率，是传统运输行业的重大变革。早期的软件项目中软件更新，发布低效，开发测试发布周期很长，很难敏捷。有了容器技术，就可以利用其标准化的特点，大幅提高生产效率。</p>
<p>容器技术是虚拟化、云计算、大数据之后的一门新兴的并且是炙手可热的新技术， 容器技术提高了硬件资源利用率、 方便了企业的业务快速横向扩容（可以达到秒级快速扩容）、 实现了业务宕机自愈功能（配合K8S可以实现，但OpenStack无此功能），因此未来数年会是一个容器愈发流行的时代 ，这是 一个对于 IT 行业来说非常有影响和价值的技术，而对于IT行业的从业者来说，熟练掌握容器技术无疑是一个很有前景的行业工作机会。</p>
<p><img src="../../../../images/SRE/day46/3.jpg" alt="3"></p>
<h2 id="Docker-介绍"><a href="#Docker-介绍" class="headerlink" title="Docker 介绍"></a>Docker 介绍</h2><h3 id="容器历史"><a href="#容器历史" class="headerlink" title="容器历史"></a>容器历史</h3><p>虽然 docker 把容器技术推向了巅峰，但容器技术却不是从 docker 诞生的。实际上，容器技术连新技术都算不上，因为它的诞生和使用确实有些年头了。下面的一串名称可能有的你都没有听说过，但它们的确都是容器技术的应用:</p>
<p> 1 、Chroot Jail</p>
<p>就是我们常见的 chroot 命令的用法。它在 1979 年的时候就出现了，被认为是最早的容器化技术之一。</p>
<p>它可以把一个进程的文件系统隔离起来。</p>
<p>2 、The FreeBSD Jail</p>
<p>Freebsd Jail (监狱)实现了操作系统级别的虚拟化，它是操作系统级别虚拟化技术的先驱之一。 2000 年，伴随FreeBSD4.0版的发布</p>
<p>3 、Linux VServer</p>
<p>使用添加到 Linux 内核的系统级别的虚拟化功能实现的专用虚拟服务器。允许创建许多独立的虚拟专用服务器（VPS），这些虚拟专用服务器在单个物理服务器上全速同时运行，从而有效地共享硬件资源。</p>
<p>VPS提供与传统Linux服务器几乎相同的操作环境。可以在这样的VPS上启动所有服务（例如ssh，邮件Web和数据库服务器），而无需（或者在特殊情况下只需进行很少的修改），就像在任何真实服务器上一样。</p>
<p>每个VPS都有自己的用户帐户数据库和root密码，并且与其他虚拟服务器隔离，但它们共享相同的硬件资源</p>
<p>2003 年 11 月 1 日 VServer 1.0 发布</p>
<p>官网:<a target="_blank" rel="noopener" href="http://linux-vserver.org/">http://linux-vserver.org/</a></p>
<p>4 、Solaris Containers</p>
<p>它也是操作系统级别的虚拟化技术，专为 X86 和 SPARC 系统设计。Solaris 容器是系统资源控制和通过”区域” 提供边界隔离的组合。</p>
<p>5 、OpenVZ</p>
<p>OpenVZ 是一种 Linux 中操作系统级别的虚拟化技术。 它允许创建多个安全隔离的 Linux 容器，即VPS。</p>
<p>6 、Process Containers</p>
<p>Process 容器由 Google 的工程师开发，一般被称为 cgroups。</p>
<p>7 、LXC</p>
<p>LXC为Linux Container的简写。可以提供轻量级的虚拟化，以便隔离进程和资源，而且不需要提供指令解释机制以及全虚拟化的其他复杂性。容器有效地将由单个操作系统管理的资源划分到孤立的组中，以更好地在孤立的组之间平衡有冲突的资源使用需求</p>
<p>Linux Container提供了在单一可控主机节点上支持多个相互隔离的server container同时执行的机制。</p>
<p>Linux Container有点像chroot，提供了一个拥有自己进程和网络空间的虚拟环境，但又有别于虚拟机，因为lxc是一种操作系统层次上的资源的虚拟化。</p>
<p>8 、Warden</p>
<p>在最初阶段，Warden 使用 LXC 作为容器运行时。 如今已被 CloudFoundy 取代。</p>
<p>9 、LMCTFY</p>
<p>LMCTY 是 Let me contain that for you 的缩写。它是 Google 的容器技术栈的开源版本。</p>
<p>Google 的工程师一直在与 docker 的 libertainer 团队合作，并将 libertainer 的核心概念进行抽象并移植到此项目中。该项目的进展不明，估计会被 libcontainer 取代。</p>
<p>10 、Docker</p>
<p>Docker 是一个可以将应用程序及其依赖打包到几乎可以在任何服务器上运行的容器的工具。</p>
<p>11 、RKT</p>
<p>RKT 是 Rocket 的缩写，它是一个专注于安全和开放标准的应用程序容器引擎。</p>
<p>综上所述正如我们所看到的，docker 并不是第一个容器化技术，但它的确是最知名的一个。</p>
<h3 id="Docker-是什么"><a href="#Docker-是什么" class="headerlink" title="Docker 是什么"></a>Docker 是什么</h3><p><img src="../../../../images/SRE/day46/4.jpg" alt="4"></p>
<p>2010 年，Solomon Hykes(Docker CTO)和几个年轻人在美国旧金山成立了一家 PaaS平台的dotCloud公司 , 此公司主要基于PaaS平台为开发者提供技术服务。</p>
<p>Docker 是一个开源项目，诞生于 2013 年 3 月 27 日，最初是 dotCloud 公司（后由于 Docker 开源后大受欢迎在 2013 年 10 月就将公司改名为 Docker Inc ，总部位于美国加州的旧金山）内部的一个开源的PAAS 服务 (Platform as a ServiceService )的业余项目。它基于 Google 公司推出的 Go 语言实现。 项目后来加入了 Linux 基金会，遵从了 Apache 2.0 协议，项目代码在 GitHub 上进行维护。</p>
<p>Docker 是基于 Linux 内核实现，Docker 最早采用 LXC 技术 ，LXC 是 Linux 原生支持的容器技术 ，可以提供轻量级的虚拟化 ，可以说 docker 就是基于 LXC 发展起来 的，提供 LXC 的高级封装，标准的配置方法，在LXC的基础之上，docker提供了一系列更强大的功能。而虚拟化技术 KVM(KernelKernel-based Virtual Machine Machine) 基于 模块实现， 后来Docker 改为自己研发并开源的 runc 技术运行容器，彻底抛弃了LXC。</p>
<p>Docker 相比虚拟机的交付速度更快，资源消耗更低，Docker 采用客户端/服务端架构，使用远程API来管理和创建容器，其可以轻松的创建一个轻量级的、可移植的、自给自足的容器，docker 的三大理念是build(构建)、ship(运输)、 run(运行)，Docker遵从apache 2.0协议，并通过（namespace及cgroup等）来提供容器的资源隔离与安全保障等，所以Docke容器在运行时不需要类似虚拟机（空运行的虚拟机占用物理机6-8%性能）的额外资源开销，因此可以大幅提高资源利用率,总而言之Docker是一种用了新颖方式实现的轻量级虚拟机.类似于VM但是在原理和应用上和VM的差别还是很大的，并且docker的专业叫法是应用容器(Application Container)。</p>
<p><strong>Docker 的主要目标</strong></p>
<p><img src="../../../../images/SRE/day46/5.jpg" alt="5"></p>
<p>Build, Ship and Run Any App, Anywhere，即通过对应用组件的封装（Packaging）、分发（Distribution）、部署（Deployment）、运行（Runtime）等生命周期的管理，达到应用组件级别的“一次封装，到处运行”。这里的应用组件，既可以是一个Web应用，也可以是一套数据库服务，甚至是一个操作系统。将应用运行在Docker 容器上，可以实现跨平台，跨服务器，只需一次配置准备好相关的应用环境，即可实现到处运行，保证研发和生产环境的一致性，解决了应用和运行环境的兼容性问题，从而极大提升了部署效率，减少故障的可能性</p>
<p><strong>使用Docker 容器化封装应用程序的意义:</strong></p>
<p><img src="../../../../images/SRE/day46/6.jpg" alt="6"></p>
<ul>
<li><p>统一基础设施环境-docker环境</p>
<ul>
<li>硬件的组成配置</li>
<li>操作系统的版本</li>
<li>运行时环境的异构</li>
</ul>
</li>
<li><p>统一程序打包（装箱）方式-docker镜像</p>
<ul>
<li>java程序</li>
<li>python程序</li>
<li>nodejs程序</li>
</ul>
</li>
<li><p>统一程序部署（运行）方式-docker容器</p>
<ul>
<li>java-jar…→ docker run…</li>
<li>python manage.py runserver… → docker run…</li>
<li>npm run dev … → docker run…</li>
</ul>
</li>
</ul>
<h3 id="Docker-和虚拟机，物理主机"><a href="#Docker-和虚拟机，物理主机" class="headerlink" title="Docker 和虚拟机，物理主机"></a>Docker 和虚拟机，物理主机</h3><p><img src="../../../../images/SRE/day46/7.jpg" alt="7"></p>
<p><strong>容器和虚拟机技术比较</strong></p>
<p><img src="../../../../images/SRE/day46/8.jpg" alt="8"></p>
<ul>
<li>传统虚拟机是虚拟出一个主机硬件,并且运行一个完整的操作系统 ,然后在这个系统上安装和运行软件</li>
<li>容器内的应用直接运行在宿主机的内核之上,容器并没有自己的内核,也不需要虚拟硬件,相当轻量化</li>
<li>每个容器间是互相隔离,每个容器内都有一个属于自己的独立文件系统,独立的进程空间,网络空间,用户空间等,所以在同一个宿主机上的多个容器之间彼此不会相互影响</li>
</ul>
<p><strong>容器和虚拟机表现比较</strong></p>
<p><img src="../../../../images/SRE/day46/9.jpg" alt="9"></p>
<ul>
<li>资源利用率更高: 开销更小,不需要启动单独的虚拟机OS内核占用硬件资源,可以将服务器性能压榨至极致.虚拟机一般会有5-20%的损耗,容器运行基本无损耗,所以生产中一台物理机只能运行数十个虚拟机，但是一般可以运行数百个容器</li>
<li>启动速度更快: 可以在数秒内完成启动</li>
<li>占用空间更小: 容器一般占用的磁盘空间以MB为单位,而虚拟机以GB</li>
<li>集成性更好: 和 CI/CD（持续集成/持续部署）相关技术结合性更好，实现打包镜像发布测试可以一键运行,做到自动化并快速的部署管理,实现高效的开发生命周期</li>
</ul>
<p>使用虚拟机是为了更好的实现服务运行环境隔离，每个虚拟机都有独立的内核，虚拟化可以实现不同操作系统的虚拟机，但是通常一个虚拟机只运行一个服务，很明显资源利用率比较低且造成不必要的性能损耗，我们创建虚拟机的目的是为了运行应用程序，比如Nginx、PHP、Tomcat等web程序，使用虚拟机无疑带来了一些不必要的资源开销，但是容器技术则基于减少中间运行环节带来较大的性能提升。</p>
<p>根据实验，一个运行着CentOS的KVM虚拟机启动后，在不做优化的情况下，虚拟机自己就需要占用100~200 MB内存。此外，用户应用运行在虚拟机里面，它对宿主机操作系统的调用就不可避免地要经过虚拟化软件的拦截和处理，这本身又是一层性能损耗，尤其对计算资源、网络和磁盘I/O的损耗非常大。</p>
<p>比如: 一台96G内存的物理服务器，为了运行java程序的虚拟机一般需要分配8G内存/4核的资源，只能运行 13 台左右虚拟机，但是改为在docker容器上运行Java程序,每个容器只需要分配4G内存即可，同样的物理服务器就可以运行 25 个左右容器，运行数量相当于提高一倍，可以大幅节省IT支出，通常情况下至少可节约一半以上的物理设备</p>
<h3 id="Docker-的组成"><a href="#Docker-的组成" class="headerlink" title="Docker 的组成"></a>Docker 的组成</h3><p>docker 官网: <a target="_blank" rel="noopener" href="http://www.docker.com/">http://www.docker.com</a></p>
<p>帮助文档链接: <a target="_blank" rel="noopener" href="https://docs.docker.com/">https://docs.docker.com/</a></p>
<p>docker 镜像: <a target="_blank" rel="noopener" href="https://hub.docker.com/">https://hub.docker.com/</a></p>
<p>docker 中文网站: <a target="_blank" rel="noopener" href="http://www.docker.org.cn/">http://www.docker.org.cn/</a></p>
<p><img src="../../../../images/SRE/day46/10.jpg" alt="10"></p>
<ul>
<li>Docker 主机(Host): 一个物理机或虚拟机，用于运行Docker服务进程和容器，也称为宿主机，node节点</li>
<li>Docker 服务端(Server): Docker守护进程，运行docker容器</li>
<li>Docker 客户端(Client): 客户端使用 docker 命令或其他工具调用docker API</li>
<li>Docker 镜像(Images): 镜像可以理解为创建实例使用的模板,本质上就是一些程序文件的集合</li>
<li>Docker 仓库(Registry): 保存镜像的仓库，官方仓库: <a target="_blank" rel="noopener" href="https://hub.docker.com/%EF%BC%8C%E5%8F%AF%E4%BB%A5%E6%90%AD%E5%BB%BA%E7%A7%81%E6%9C%89%E4%BB%93%E5%BA%93harbor">https://hub.docker.com/，可以搭建私有仓库harbor</a></li>
<li>Docker 容器(Container): 容器是从镜像生成对外提供服务的一个或一组服务,其本质就是将镜像中的程序启动后生成的进程</li>
</ul>
<p><img src="../../../../images/SRE/day46/10-5.jpg" alt="10-5"></p>
<h3 id="Namespace"><a href="#Namespace" class="headerlink" title="Namespace"></a>Namespace</h3><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">https://man7.org/linux/man-pages/man7/namespaces.7.html</span><br><span class="line">https://en.wikipedia.org/wiki/Linux_namespaces</span><br></pre></td></tr></table></figure>

<p>一个宿主机运行了N个容器，多个容器共用一个 OS，必然带来的以下问题:</p>
<ul>
<li>怎么样保证每个容器都有不同的文件系统并且能互不影响？</li>
<li>一个docker主进程内的各个容器都是其子进程，那么如果实现同一个主进程下不同类型的子进程？各个容器子进程间能相互通信(内存数据)吗？</li>
<li>每个容器怎么解决IP及端口分配的问题？</li>
<li>多个容器的主机名能一样吗？</li>
<li>每个容器都要不要有root用户？怎么解决账户重名问题？</li>
</ul>
<p><img src="../../../../images/SRE/day46/11.jpg" alt="11"></p>
<p>namespace是Linux系统的底层概念，在内核层实现，即有一些不同类型的命名空间被部署在内核，各个docker容器运行在同一个docker主进程并且共用同一个宿主机系统内核，各docker容器运行在宿主机的用户空间，每个容器都要有类似于虚拟机一样的相互隔离的运行空间，但是容器技术是在一个进程内实现运行指定服务的运行环境，并且还可以保护宿主机内核不受其他进程的干扰和影响，如文件系统空间、网络空间、进程空间等，目前主要通过以下技术实现容器运行空间的相互隔离:</p>
<table>
<thead>
<tr>
<th>隔离类型</th>
<th>功能</th>
<th>系统调用参数</th>
<th>内核版本</th>
</tr>
</thead>
<tbody><tr>
<td>MNT Namespace(mount)</td>
<td>提供磁盘挂载点和文件系统的隔离能力</td>
<td>CLONE_NEWNS</td>
<td>2.4.19</td>
</tr>
<tr>
<td>IPC Namespace(Inter-Process Communication)</td>
<td>提供进程间通信的隔离能力,包括信号量,消息队列和共享内存</td>
<td>CLONE_NEWIPC</td>
<td>2.6.19</td>
</tr>
<tr>
<td>UTS Namespace(UNIX Timesharing System)</td>
<td>提供内核,主机名和域名隔离能力</td>
<td>CLONE_NEWUTS</td>
<td>2.6.19</td>
</tr>
<tr>
<td>PID Namespace(Process Identification)</td>
<td>提供进程隔离能力</td>
<td>CLONE_NEWPID</td>
<td>2.6.24</td>
</tr>
<tr>
<td>Net Namespace(network)</td>
<td>提供网络隔离能力,包括网络设备,网络栈,端口等</td>
<td>CLONE_NEWNET</td>
<td>2.6.29</td>
</tr>
<tr>
<td>User Namespace(user)</td>
<td>提供用户隔离能力,包括用户和组</td>
<td>CLONE_NEWUSER</td>
<td>3.8</td>
</tr>
</tbody></table>
<p>Pid namespace</p>
<ul>
<li>不同用户的进程就是通过Pid namespace 隔离开的，且不同namespace 中可以有相同Pid。</li>
<li>有了Pid namespace, 每个namespace 中的Pid 能够相互隔离。</li>
</ul>
<p>net namespace</p>
<ul>
<li>网络隔离是通过net namespace 实现的， 每个net namespace 有独立的network devices, IP addresses, IP routing tables, /proc/net 目录。</li>
<li>Docker 默认采用veth 的方式将container 中的虚拟网卡同host 上的一个docker bridge: docker连接在一起。</li>
</ul>
<p>ipc namespace</p>
<ul>
<li>Container 中进程交互还是采用linux 常见的进程间交互方法（interprocess communication –IPC）, 包括常见的信号量、消息队列和共享内存。</li>
<li>container 的进程间交互实际上还是host上具有相同Pid namespace 中的进程间交互，因此需要在IPC 资源申请时加入namespace 信息- 每个IPC 资源有一个唯一的 32 位ID。</li>
</ul>
<p>mnt namespace</p>
<ul>
<li>mnt namespace 允许不同namespace 的进程看到的文件结构不同，这样每个namespace 中的进程所看到的文件目录就被隔离开了</li>
</ul>
<p>uts namespace</p>
<ul>
<li>UTS(“UNIX Time-sharing System”) namespace允许每个container 拥有独立的hostname 和domain name, 使其在网络上可以被视作一个独立的节点而非Host 上的一个进程。</li>
</ul>
<p>user namespace</p>
<ul>
<li>每个container 可以有不同的user 和group id, 也就是说可以在container 内部用container 内部的用户执行程序而非Host 上的用户。</li>
</ul>
<p>范例: namespace</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br></pre></td><td class="code"><pre><span class="line">[root@master1 ~]<span class="comment"># lsns --help</span></span><br><span class="line"></span><br><span class="line">用法：</span><br><span class="line">    lsns [选项] [&lt;名字空间&gt;]</span><br><span class="line"></span><br><span class="line">列出系统名字空间。</span><br><span class="line"></span><br><span class="line">选项：</span><br><span class="line">  -J, --json                     使用 JSON 输出格式</span><br><span class="line">  -l, --list                     使用列表格式的输出</span><br><span class="line">  -n, --noheadings               不打印标题</span><br><span class="line">  -o, --output &lt;list&gt;            定义使用哪个输出列</span><br><span class="line">      --output-all output all columns</span><br><span class="line">  -p, --task &lt;pid&gt;               打印进程名字空间</span><br><span class="line">  -r, --raw                      使用原生输出格式</span><br><span class="line">  -u, --notruncate               不截断列中的文本</span><br><span class="line">  -W, --nowrap don<span class="string">&#x27;t use multi-line representation</span></span><br><span class="line"><span class="string">  -t, --type &lt;name&gt; namespace type (mnt, net, ipc, user, pid, uts, cgroup,time)</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">  -h, --help                     display this help</span></span><br><span class="line"><span class="string">  -V, --version                  display version</span></span><br><span class="line"><span class="string">  </span></span><br><span class="line"><span class="string">Available output columns:</span></span><br><span class="line"><span class="string">          NS      名字空间标识符 (inode 号)</span></span><br><span class="line"><span class="string">          TYPE    名字空间类型</span></span><br><span class="line"><span class="string">          PATH    名字空间路径</span></span><br><span class="line"><span class="string">          NPROCS  名字空间中的进程数</span></span><br><span class="line"><span class="string">          PID     名字空间中的最低 PID</span></span><br><span class="line"><span class="string">          PPID    PID 的 PPID</span></span><br><span class="line"><span class="string">          COMMAND PID 的命令行</span></span><br><span class="line"><span class="string">          UID     PID 的 UID</span></span><br><span class="line"><span class="string">          USER    PID 的用户名</span></span><br><span class="line"><span class="string">          NETNSID namespace ID as used by network subsystem</span></span><br><span class="line"><span class="string">          NSFS    nsfs mountpoint (usually used network subsystem)</span></span><br><span class="line"><span class="string">          PNS     parent namespace identifier (inode number)</span></span><br><span class="line"><span class="string">          ONS     owner namespace identifier (inode number)</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">更多信息请参阅 lsns(8)。</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">[root@ubuntu2204 ~]# nsenter --help</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">用法：</span></span><br><span class="line"><span class="string">  nsenter [选项] [&lt;程序&gt; [&lt;参数&gt;...]]</span></span><br><span class="line"><span class="string">  </span></span><br><span class="line"><span class="string">以其他程序的名字空间运行某个程序。</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">选项：</span></span><br><span class="line"><span class="string">  -a, --all              enter all namespaces</span></span><br><span class="line"><span class="string">  -t, --target &lt;pid&gt;     要获取名字空间的目标进程</span></span><br><span class="line"><span class="string">  -m, --mount[=&lt;文件&gt;]    进入 mount 名字空间</span></span><br><span class="line"><span class="string">  -u, --uts[=&lt;文件&gt;]      进入 UTS 名字空间(主机名等)</span></span><br><span class="line"><span class="string">  -i, --ipc[=&lt;文件&gt;]      进入 System V IPC 名字空间</span></span><br><span class="line"><span class="string">  -n, --net[=&lt;文件&gt;]      进入网络名字空间</span></span><br><span class="line"><span class="string">  -p, --pid[=&lt;文件&gt;]      进入 pid 名字空间</span></span><br><span class="line"><span class="string">  -C, --cgroup[=&lt;文件&gt;]   进入 cgroup 名字空间</span></span><br><span class="line"><span class="string">  -U, --user[=&lt;文件&gt;]     进入用户名字空间</span></span><br><span class="line"><span class="string">  -T, --time[=&lt;file&gt;]     enter time namespace</span></span><br><span class="line"><span class="string">  -S, --setuid &lt;uid&gt;     设置进入空间中的 uid</span></span><br><span class="line"><span class="string">  -G, --setgid &lt;gid&gt;     设置进入名字空间中的 gid</span></span><br><span class="line"><span class="string">      --preserve-credentials 不干涉 uid 或 gid</span></span><br><span class="line"><span class="string">  -r, --root[=&lt;目录&gt;]     设置根目录</span></span><br><span class="line"><span class="string">  -w, --wd[=&lt;dir&gt;]       设置工作目录</span></span><br><span class="line"><span class="string">  -F, --no-fork          执行 &lt;程序&gt; 前不 fork</span></span><br><span class="line"><span class="string">  -Z, --follow-context   根据 --target PID 设置 SELinux 环境</span></span><br><span class="line"><span class="string">  -h, --help             display this help</span></span><br><span class="line"><span class="string">  -V, --version          display version</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">更多信息请参阅 nsenter(1)。</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">[root@ubuntu2204 ~]# lsns -t net</span></span><br><span class="line"><span class="string">        NS TYPE NPROCS   PID USER     NETNSID NSFS                           COMMAND</span></span><br><span class="line"><span class="string">4026531840 net     229     1 root  unassigned /run/docker/netns/default      /sbin/init</span></span><br><span class="line"><span class="string">4026532691 net       2  4136 65535          1 /run/docker/netns/5090da825e77 /pause</span></span><br><span class="line"><span class="string">4026532770 net       2  4140 65535          0 /run/docker/netns/cb903a9d63e0 /pause</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">[root@ubuntu2204 ~]# ls -l /proc/4140/ns </span></span><br><span class="line"><span class="string">总用量 0</span></span><br><span class="line"><span class="string">lrwxrwxrwx 1 65535 65535 0 11月 12 18:47 cgroup -&gt; &#x27;</span>cgroup:[4026532838]<span class="string">&#x27;</span></span><br><span class="line"><span class="string">lrwxrwxrwx 1 65535 65535 0 11月 12 18:35 ipc -&gt; &#x27;</span>ipc:[4026532768]<span class="string">&#x27;</span></span><br><span class="line"><span class="string">lrwxrwxrwx 1 65535 65535 0 11月 12 18:47 mnt -&gt; &#x27;</span>mnt:[4026532766]<span class="string">&#x27;</span></span><br><span class="line"><span class="string">lrwxrwxrwx 1 65535 65535 0 11月 12 18:35 net -&gt; &#x27;</span>net:[4026532770]<span class="string">&#x27;</span></span><br><span class="line"><span class="string">lrwxrwxrwx 1 65535 65535 0 11月 12 18:35 pid -&gt; &#x27;</span>pid:[4026532769]<span class="string">&#x27;</span></span><br><span class="line"><span class="string">lrwxrwxrwx 1 65535 65535 0 11月 12 18:47 pid_for_children -&gt; &#x27;</span>pid:[4026532769]<span class="string">&#x27;</span></span><br><span class="line"><span class="string">lrwxrwxrwx 1 65535 65535 0 11月 12 18:47 time -&gt; &#x27;</span>time:[4026531834]<span class="string">&#x27;</span></span><br><span class="line"><span class="string">lrwxrwxrwx 1 65535 65535 0 11月 12 18:47 time_for_children -&gt; &#x27;</span>time:[4026531834]<span class="string">&#x27;</span></span><br><span class="line"><span class="string">lrwxrwxrwx 1 65535 65535 0 11月 12 18:47 user -&gt; &#x27;</span>user:[4026531837]<span class="string">&#x27;</span></span><br><span class="line"><span class="string">lrwxrwxrwx 1 65535 65535 0 11月 12 18:47 uts -&gt; &#x27;</span>uts:[4026532767]<span class="string">&#x27;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">#说明4136为容器在宿主机的Pid,下面表示进入4136容器的对应网络名称空间执行命令</span></span><br><span class="line"><span class="string">[root@ubuntu2204 ~]# nsenter -t 4136 -n ip a</span></span><br><span class="line"><span class="string">1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group </span></span><br><span class="line"><span class="string">default qlen 1000</span></span><br><span class="line"><span class="string">   link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00</span></span><br><span class="line"><span class="string">   inet 127.0.0.1/8 scope host lo</span></span><br><span class="line"><span class="string">       valid_lft forever preferred_lft forever</span></span><br><span class="line"><span class="string">3: eth0@if7: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1450 qdisc noqueue state UP </span></span><br><span class="line"><span class="string">group default </span></span><br><span class="line"><span class="string">   link/ether 42:73:2e:34:e3:91 brd ff:ff:ff:ff:ff:ff link-netnsid 0</span></span><br><span class="line"><span class="string">   inet 10.244.0.11/24 brd 10.244.0.255 scope global eth0</span></span><br><span class="line"><span class="string">       valid_lft forever preferred_lft forever</span></span><br><span class="line"><span class="string">       </span></span><br><span class="line"><span class="string">[root@ubuntu2204 ~]# nsenter -t 4140 -n ip a</span></span><br><span class="line"><span class="string">1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group </span></span><br><span class="line"><span class="string">default qlen 1000</span></span><br><span class="line"><span class="string">   link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00</span></span><br><span class="line"><span class="string">   inet 127.0.0.1/8 scope host lo</span></span><br><span class="line"><span class="string">       valid_lft forever preferred_lft forever</span></span><br><span class="line"><span class="string">3: eth0@if6: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1450 qdisc noqueue state UP </span></span><br><span class="line"><span class="string">group default </span></span><br><span class="line"><span class="string">   link/ether f6:20:4e:63:e9:0a brd ff:ff:ff:ff:ff:ff link-netnsid 0</span></span><br><span class="line"><span class="string">   inet 10.244.0.10/24 brd 10.244.0.255 scope global eth0</span></span><br><span class="line"><span class="string">       valid_lft forever preferred_lft forever</span></span><br></pre></td></tr></table></figure>

<h3 id="Control-groups"><a href="#Control-groups" class="headerlink" title="Control groups"></a>Control groups</h3><p>Linux Cgroups的全称是Linux Control Groups,是Linux内核的一个功能.最早是由Google的工程师（主要是Paul Menage和Rohit Seth）在 2006 年发起，最早的名称为 进程容器 （process containers）。在2007 年时，因为在Linux内核中，容器（container）这个名词有许多不同的意义，为避免混乱，被重命名为cgroup，并且被合并到2.6.24版的内核中去。自那以后，又添加了很多功能。</p>
<p>如果不对一个容器做任何资源限制，则宿主机会允许其占用无限大的内存空间，有时候会因为代码bug程序会一直申请内存，直到把宿主机内存占完，为了避免此类的问题出现，宿主机有必要对容器进行资源分配限制，比如CPU、内存等</p>
<p>Cgroups 最主要的作用，就是限制一个进程组能够使用的资源上限，包括CPU、内存、磁盘、网络带宽等等。此外，还能够对进程进行优先级设置，资源的计量以及资源的控制(比如:将进程挂起和恢复等操作)。</p>
<p>Cgroups在内核层默认已经开启，从CentOS 和 Ubuntu 不同版本对比，显然内核较新的支持的功能更多。</p>
<p><strong>Centos 8.1 cgroups:</strong></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ~]<span class="comment"># cat /etc/redhat-release</span></span><br><span class="line">CentOS Linux release 8.1.1911 (Core)</span><br><span class="line"></span><br><span class="line">[root@centos8 ~]<span class="comment"># grep CGROUP /boot/config-4.18.0-147.el8.x86_64</span></span><br><span class="line">CONFIG_CGROUPS=y</span><br><span class="line">CONFIG_BLK_CGROUP=y</span><br><span class="line"><span class="comment"># CONFIG_DEBUG_BLK_CGROUP is not set</span></span><br><span class="line">CONFIG_CGROUP_WRITEBACK=y</span><br><span class="line">CONFIG_CGROUP_SCHED=y</span><br><span class="line">CONFIG_CGROUP_PIDS=y</span><br><span class="line">CONFIG_CGROUP_RDMA=y</span><br><span class="line">CONFIG_CGROUP_FREEZER=y</span><br><span class="line">CONFIG_CGROUP_HUGETLB=y</span><br><span class="line">CONFIG_CGROUP_DEVICE=y</span><br><span class="line">CONFIG_CGROUP_CPUACCT=y</span><br><span class="line">CONFIG_CGROUP_PERF=y</span><br><span class="line">CONFIG_CGROUP_BPF=y</span><br><span class="line"><span class="comment"># CONFIG_CGROUP_DEBUG is not set</span></span><br><span class="line">CONFIG_SOCK_CGROUP_DATA=y</span><br><span class="line"><span class="comment"># CONFIG_BLK_CGROUP_IOLATENCY is not set</span></span><br><span class="line">CONFIG_NETFILTER_XT_MATCH_CGROUP=m</span><br><span class="line">CONFIG_NET_CLS_CGROUP=y</span><br><span class="line">CONFIG_CGROUP_NET_PRIO=y</span><br><span class="line">CONFIG_CGROUP_NET_CLASSID=y</span><br></pre></td></tr></table></figure>

<p><strong>Centos 7.6 cgroups:</strong></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">[root@centos7 ~]<span class="comment"># cat /etc/redhat-release </span></span><br><span class="line">CentOS Linux release 7.6.1810 (Core) </span><br><span class="line"></span><br><span class="line">[root@centos7 ~]<span class="comment"># grep CGROUP /boot/config-3.10.0-957.el7.x86_64 </span></span><br><span class="line">CONFIG_CGROUPS=y</span><br><span class="line"><span class="comment"># CONFIG_CGROUP_DEBUG is not set</span></span><br><span class="line">CONFIG_CGROUP_FREEZER=y</span><br><span class="line">CONFIG_CGROUP_PIDS=y</span><br><span class="line">CONFIG_CGROUP_DEVICE=y</span><br><span class="line">CONFIG_CGROUP_CPUACCT=y</span><br><span class="line">CONFIG_CGROUP_HUGETLB=y</span><br><span class="line">CONFIG_CGROUP_PERF=y</span><br><span class="line">CONFIG_CGROUP_SCHED=y</span><br><span class="line">CONFIG_BLK_CGROUP=y</span><br><span class="line"><span class="comment"># CONFIG_DEBUG_BLK_CGROUP is not set</span></span><br><span class="line">CONFIG_NETFILTER_XT_MATCH_CGROUP=m</span><br><span class="line">CONFIG_NET_CLS_CGROUP=y</span><br><span class="line">CONFIG_NETPRIO_CGROUP=y</span><br></pre></td></tr></table></figure>

<p><strong>ubuntu cgroups:</strong></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">[root@ubuntu1804 ~]<span class="comment"># grep CGROUP /boot/config-4.15.0-29-generic</span></span><br><span class="line">CONFIG_CGROUPS=y</span><br><span class="line">CONFIG_BLK_CGROUP=y</span><br><span class="line"><span class="comment"># CONFIG_DEBUG_BLK_CGROUP is not set</span></span><br><span class="line">CONFIG_CGROUP_WRITEBACK=y</span><br><span class="line">CONFIG_CGROUP_SCHED=y</span><br><span class="line">CONFIG_CGROUP_PIDS=y</span><br><span class="line">CONFIG_CGROUP_RDMA=y</span><br><span class="line">CONFIG_CGROUP_FREEZER=y</span><br><span class="line">CONFIG_CGROUP_HUGETLB=y</span><br><span class="line">CONFIG_CGROUP_DEVICE=y</span><br><span class="line">CONFIG_CGROUP_CPUACCT=y</span><br><span class="line">CONFIG_CGROUP_PERF=y</span><br><span class="line">CONFIG_CGROUP_BPF=y</span><br><span class="line"><span class="comment"># CONFIG_CGROUP_DEBUG is not set</span></span><br><span class="line">CONFIG_SOCK_CGROUP_DATA=y</span><br><span class="line">CONFIG_NETFILTER_XT_MATCH_CGROUP=m</span><br><span class="line">CONFIG_NET_CLS_CGROUP=m</span><br><span class="line">CONFIG_CGROUP_NET_PRIO=y</span><br><span class="line">CONFIG_CGROUP_NET_CLASSID=y</span><br></pre></td></tr></table></figure>

<p><strong>cgroups 中内存模块:</strong></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@ubuntu1804 ~]<span class="comment">#grep MEMCG /boot/config-4.15.0-29-generic</span></span><br><span class="line">CONFIG_MEMCG=y</span><br><span class="line">CONFIG_MEMCG_SWAP=y</span><br><span class="line"><span class="comment"># CONFIG_MEMCG_SWAP_ENABLED is not set</span></span><br><span class="line">CONFIG_SLUB_MEMCG_SYSFS_ON=y</span><br></pre></td></tr></table></figure>

<h3 id="容器管理工具"><a href="#容器管理工具" class="headerlink" title="容器管理工具"></a>容器管理工具</h3><p>有了以上的chroot、namespace、cgroups就具备了基础的容器运行环境，但是还需要有相应的容器创建与删除的管理工具、以及怎么样把容器运行起来、容器数据怎么处理、怎么进行启动与关闭等问题需要解决，于是容器管理技术出现了。目前主要是使用docker，早期使用 LXC</p>
<h4 id="LXC"><a href="#LXC" class="headerlink" title="LXC"></a>LXC</h4><p>LXC: Linux Container。可以提供轻量级的虚拟化功能,以便隔离进程和资源,包括一系列容器的管理工具软件,如，lxc-create,lxc-start,lxc-attach等,但这技术功能不完善,目前较少使用</p>
<p>官方网站: <a target="_blank" rel="noopener" href="https://linuxcontainers.org/">https://linuxcontainers.org/</a></p>
<p>案例: Ubuntu安装 和使用 LXC</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">[root@ubuntu1804 ~]<span class="comment"># apt install lxc lxd</span></span><br><span class="line">Reading package lists... Done</span><br><span class="line">Building dependency tree</span><br><span class="line">Reading state information... Done</span><br><span class="line">lxd is already the newest version (3.0.3-0ubuntu1~18.04.1).</span><br><span class="line">lxc is already the newest version (3.0.3-0ubuntu1~18.04.1).</span><br><span class="line">......</span><br><span class="line"></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment"># lxc-checkconfig #检查内核对lcx的支持状况，必须全部为lcx</span></span><br><span class="line">Kernel configuration not found at /proc/config.gz; searching...</span><br><span class="line">Kernel configuration found at /boot/config-4.15.0-29-generic</span><br><span class="line">--- Namespaces ---</span><br><span class="line">Namespaces: enabled</span><br><span class="line">Utsname namespace: enabled</span><br><span class="line">Ipc namespace: enabled</span><br><span class="line">Pid namespace: enabled</span><br><span class="line">User namespace: enabled</span><br><span class="line">Network namespace: enabled</span><br><span class="line">......</span><br><span class="line"></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment"># lxc-create -t download --name alpine1 -- --dist alpine --release 3.9 --arch amd</span></span><br><span class="line">Setting up the GPG keyring</span><br><span class="line">Downloading the image index</span><br><span class="line">Downloading the rootfs</span><br><span class="line">Downloading the metadata</span><br><span class="line">The image cache is now ready</span><br><span class="line">Unpacking the rootfs</span><br></pre></td></tr></table></figure>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">---</span><br><span class="line">You just created an Alpinelinux 3.9 x86_64 (20200121_13:00) container.</span><br><span class="line"></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment"># lxc-start alpine1 #启动lxc容器</span></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment"># lxc-attach alpine1 #进入lxc容器</span></span><br><span class="line">~ <span class="comment"># ifconfig</span></span><br><span class="line">eth0      Link encap:Ethernet HWaddr 00:16:3E:DF:9E:</span><br><span class="line">          inet addr:10.0.1.51 Bcast:10.0.1.255 Mask:255.255.255.</span><br><span class="line">          inet6 addr: fe80::216:3eff:fedf:9e45/64 Scope:Link</span><br><span class="line">          UP BROADCAST RUNNING MULTICAST MTU:1500 Metric:</span><br><span class="line">          RX packets:23 errors:0 dropped:0 overruns:0 frame:</span><br><span class="line">          TX packets:12 errors:0 dropped:0 overruns:0 carrier:</span><br><span class="line">          collisions:0 txqueuelen:</span><br><span class="line">          RX bytes:2484 (2.4 KiB) TX bytes:1726 (1.6 KiB)</span><br><span class="line"></span><br><span class="line">lo        Link encap:Local Loopback</span><br><span class="line">          inet addr:127.0.0.1 Mask:255.0.0.</span><br><span class="line">          inet6 addr: ::1/128 Scope:Host</span><br><span class="line">          UP LOOPBACK RUNNING MTU:65536 Metric:</span><br><span class="line">          RX packets:0 errors:0 dropped:0 overruns:0 frame:</span><br><span class="line">          TX packets:0 errors:0 dropped:0 overruns:0 carrier:</span><br><span class="line">          collisions:0 txqueuelen:</span><br><span class="line">          RX bytes:0 (0.0 B) TX bytes:0 (0.0 B)</span><br><span class="line"></span><br><span class="line">~ <span class="comment"># uname -r</span></span><br><span class="line">4.15.0-29-generic</span><br><span class="line"></span><br><span class="line">~ <span class="comment"># uname -a</span></span><br><span class="line">Linux alpine12 4.15.0-29-generic <span class="comment">#31-Ubuntu SMP Tue Jul 17 15:39:52 UTC 2018x86_64 Linux</span></span><br><span class="line"></span><br><span class="line">~ <span class="comment"># cat /etc/issue</span></span><br><span class="line">Welcome to Alpine Linux 9</span><br><span class="line">Kernel \r on an \m (\l)</span><br><span class="line"></span><br><span class="line">~ <span class="comment"># exit</span></span><br></pre></td></tr></table></figure>

<p>命令选项说明:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">-t 模板: -t 选项后面跟的是模板，模式可以认为是一个原型，用来说明需要一个什么样的容器(比如容器里面需不需要有</span><br><span class="line">vim, apache等软件)．模板实际上就是一个脚本文件(位于/usr/share/lxc/templates目录)，我们这里指定</span><br><span class="line">download模板(lxc-create会调用lxc-download脚本，该脚本位于刚说的模板目录中)是说明我们目前没有自己模板，需要下载官方的模板</span><br><span class="line"></span><br><span class="line">--name    容器名称: 为创建的容器命名</span><br><span class="line">-- :      --用来说明后面的参数是传递给download脚本的，告诉脚本需要下载什么样的模板</span><br><span class="line">--dist    操作系统名称: 指定操作系统</span><br><span class="line">--release 操作系统: 指定操作系统，可以是各种Linux的变种</span><br><span class="line">--<span class="built_in">arch</span>    架构: 指定架构，是x86还是arm，是 32 位还是 64 位</span><br></pre></td></tr></table></figure>

<p>lxc启动容器依赖于模板，清华模板源: <a target="_blank" rel="noopener" href="https://mirrors.tuna.tsinghua.edu.cn/help/lxc-images/%EF%BC%8C%E4%BD%86%E6%98%AF%E5%81%9A%E6%A8%A1%E6%9D%BF%E7%9B%B8%E5%AF%B9%E8%BE%83%E9%9A%BE%EF%BC%8C%E9%9C%80%E8%A6%81%E6%89%8B%E5%8A%A8%E4%B8%80%E6%AD%A5%E6%AD%A5%E5%88%9B%E6%9E%84%E5%BB%BA%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%E3%80%81%E5%87%86%E5%A4%87%E5%9F%BA%E7%A1%80%E7%9B%AE%E5%BD%95%E5%8F%8A%E5%8F%AF%E6%89%A7%E8%A1%8C%E7%A8%8B%E5%BA%8F%E7%AD%89%EF%BC%8C%E8%80%8C%E4%B8%94%E5%9C%A8%E5%A4%A7%E8%A7%84%E6%A8%A1%E4%BD%BF%E7%94%A8%E5%AE%B9%E5%99%A8%E7%9A%84%E5%9C%BA%E6%99%AF%E5%BE%88%E9%9A%BE%E6%A8%AA%E5%90%91%E6%89%A9%E5%B1%95%EF%BC%8C%E5%8F%A6%E5%A4%96%E5%90%8E%E6%9C%9F%E4%BB%A3%E7%A0%81%E5%8D%87%E7%BA%A7%E4%B9%9F%E9%9C%80%E8%A6%81%E9%87%8D%E6%96%B0%E4%BB%8E%E5%A4%B4%E6%9E%84%E5%BB%BA%E6%A8%A1%E6%9D%BF%EF%BC%8C%E5%9F%BA%E4%BA%8E%E4%BB%A5%E4%B8%8A%E7%A7%8D%E7%A7%8D%E5%8E%9F%E5%9B%A0%E4%BE%BF%E6%9C%89%E4%BA%86docker">https://mirrors.tuna.tsinghua.edu.cn/help/lxc-images/，但是做模板相对较难，需要手动一步步创构建文件系统、准备基础目录及可执行程序等，而且在大规模使用容器的场景很难横向扩展，另外后期代码升级也需要重新从头构建模板，基于以上种种原因便有了docker</a></p>
<h4 id="docker"><a href="#docker" class="headerlink" title="docker"></a>docker</h4><p>Docker 相当于增强版的LXC,功能更为强大和易用,也是当前最主流的容器前端管理工具</p>
<p>Docker 先启动一个容器也需要一个外部模板，也称为镜像，docke的镜像可以保存在一个公共的地方共享使用，只要把镜像下载下来就可以使用，最主要的是可以在镜像基础之上做自定义配置并且可以再把其提交为一个镜像，一个镜像可以被启动为多个容器。</p>
<p><img src="../../../../images/SRE/day46/12.jpg" alt="12"></p>
<p>Docker的镜像是分层的，镜像底层为库文件且只读层即不能写入也不能删除数据，从镜像加载启动为一个容器后会生成一个可写层，其写入的数据会复制到宿主机上对应容器的目录，但是容器内的数据在删除容器后也会被随之删除。</p>
<h4 id="pouch"><a href="#pouch" class="headerlink" title="pouch"></a>pouch</h4><p>项目网点: <a target="_blank" rel="noopener" href="https://github.com/alibaba/pouch">https://github.com/alibaba/pouch</a></p>
<p>Pouch （小袋子）起源于 2011 年，并于 2017 年 11 月 19 日上午，在中国开源年会现场，阿里巴巴正式开源了基于 Apache 2.0 协议的容器技术 Pouch。Pouch 是一款轻量级的容器技术，拥有快速高效、可移植性高、资源占用少等特性，主要帮助阿里更快的做到内部业务的交付，同时提高超大规模下数据中心的物理资源利用率</p>
<p>目前的容器方案大多基于 Linux 内核提供的 cgroup 和 namespace 来实现隔离，然后这样轻量级方案存在弊端:</p>
<ul>
<li>容器间，容器与宿主间，共享同一个内核</li>
<li>内核实现的隔离资源，维度不足</li>
</ul>
<p>面对如此的内核现状，阿里巴巴采取了三个方面的工作，来解决容器的安全问题:</p>
<ul>
<li>用户态增强容器的隔离维度，比如网络带宽、磁盘使用量等</li>
<li>给内核提交 patch，修复容器的资源可见性问题，cgroup 方面的 bug</li>
<li>实现基于 Hypervisor 的容器，通过创建新内核来实现容器隔离</li>
</ul>
<h4 id="Podman"><a href="#Podman" class="headerlink" title="Podman"></a>Podman</h4><p><img src="../../../../images/SRE/day46/12-5.jpg" alt="12-5"></p>
<p>虽然目前 Docker 是管理 Linux 容器最好的工具，注意没有之一，但是podman的横空出现即将改变这一点</p>
<p>什么是Podman？</p>
<p>Podman即Pod Manager tool，从名称上可以看出和kubernets的pod的密切联系，不过就其功能来说，简而言之: <code>alias docker = podman</code>,是CentOS 8 新集成的功能，或许不久的未来会代替docker</p>
<p>Podman是一个 为 Kubernetes 而生的开源的容器管理工具，原来是 CRI-O（即容器运行时接口CRI 和开放容器计划OCI） 项目的一部分，后来被分离成一个单独的项目叫 libpod。其可在大多数Linux平台上使用，它是一种无守护程序的容器引擎，用于在Linux系统上开发，管理和运行任何符合Open Container Initiative（OCI）标准的容器和容器镜像。</p>
<p>Podman 提供了一个与Docker兼容的命令行前端，Podman 里面87%的指令都和Docker CLI 相同，因此可以简单地为Docker CLI别名，即“ alias docker = podman”，事实上，podman使用的一些库也是docker的一部分。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">CRI-O is an implementation of the Kubernetes CRI (Container Runtime Interface) to</span><br><span class="line"><span class="built_in">enable</span> using OCI (Open Container Initiative) compatible runtimes</span><br></pre></td></tr></table></figure>

<p>官网地址: <a target="_blank" rel="noopener" href="https://podman.io/">https://podman.io/</a></p>
<p>项目地址: <a target="_blank" rel="noopener" href="https://github.com/containers/libpod">https://github.com/containers/libpod</a></p>
<p><strong>Podman 和docker不同之处</strong></p>
<ul>
<li>docker 需要在系统上运行一个守护进程(docker daemon)，这会产生一定的开销，而 podman 不需要</li>
<li>启动容器的方式不同:<br><code>docker cli</code> 命令通过API跟 <code>Docker Engine(引擎)</code>交互告诉它我想创建一个container，然后<code>docker Engine</code>才会调用<code>OCI container runtime(runc)</code>来启动一个container。这代表container的process(进程)不会是<code>Docker CLI</code>的<code>child process(子进程)</code>，而是<code>Docker Engine</code>的<code>child process</code>。<br><code>Podman</code>是直接给<code>OCI containner runtime(runc)</code>进行交互来创建container的，所以<code>container process</code>直接是<code>podman</code>的<code>child process</code>。</li>
<li>因为docke有docker daemon，所以docker启动的容器支持–restart策略，但是podman不支持</li>
<li>docker需要使用root用户来创建容器。 这可能会产生安全风险，尤其是当用户知道docker run命令的–privileged选项时。podman既可以由root用户运行，也可以由非特权用户运行</li>
<li>docker在Linux上作为守护进程运行扼杀了容器社区的创新。 如果要更改容器的工作方式，则需要更改docker守护程序并将这些更改推送到上游。 没有守护进程，容器基础结构更加模块化，更容易进行更改。 podman的无守护进程架构更加灵活和安全。</li>
</ul>
<h3 id="Docker-的优势"><a href="#Docker-的优势" class="headerlink" title="Docker 的优势"></a>Docker 的优势</h3><ul>
<li>快速部署: 短时间内可以部署成百上千个应用，更快速交付到线上</li>
<li>高效虚拟化: 不需要额外hypervisor支持，基于linux内核实现应用虚拟化，相比虚拟机大幅提高性能和效率</li>
<li>节省开支: 提高服务器利用率，降低IT支出</li>
<li>简化配置: 将运行环境打包保存至容器，使用时直接启动即可</li>
<li>环境统一: 将开发，测试，生产的应用运行环境进行标准化和统一，减少环境不一样带来的各种问题</li>
<li>快速迁移和扩展: 可实现跨平台运行在物理机、虚拟机、公有云等环境，良好的兼容性可以方便将应用从A宿主机迁移到B宿主机，甚至是A平台迁移到B平台</li>
<li>更好的实现面向服务的架构,推荐一个容器只运行一个应用,实现分布的应用模型,可以方便的进行横向扩展,符合开发中高内聚,低耦合的要求,减少不同服务之间的相互影响</li>
</ul>
<h3 id="Docker-的缺点"><a href="#Docker-的缺点" class="headerlink" title="Docker 的缺点"></a>Docker 的缺点</h3><ul>
<li>多个容器共用宿主机的内核，各应用之间的隔离不如虚拟机彻底</li>
<li>由于和宿主机之间的进程也是隔离的,需要进入容器查看和调试容器内进程等资源,变得比较困难和繁琐</li>
<li>如果容器内进程需要查看和调试,需要在每个容器内都需要安装相应的工具,这也造成存储空间的重复浪费</li>
</ul>
<h3 id="容器的相关技术"><a href="#容器的相关技术" class="headerlink" title="容器的相关技术"></a>容器的相关技术</h3><h4 id="容器规范"><a href="#容器规范" class="headerlink" title="容器规范"></a>容器规范</h4><p><img src="../../../../images/SRE/day46/13.jpg" alt="13"></p>
<p>OCI 官网:<a target="_blank" rel="noopener" href="https://opencontainers.org/">https://opencontainers.org/</a></p>
<p>容器技术除了的docker之外，还有coreOS的rkt，还有阿里的Pouch，为了保证容器生态的标准性和健康可持续发展，包括Linux 基金会、Docker、微软、红帽谷歌和IBM等公司在 2015 年 6 月共同成立了一个叫Open Container Initiative（OCI）的组织，其目的就是制定开放的标准的容器规范，目前OCI一共发布了两个规范， 分别是<strong>runtime spec</strong> 和 <strong>image format spec</strong> ，有了这两个规范，不同的容器公司开发的容器只要兼容这两个规范，就可以保证容器的可移植性和相互可操作性。</p>
<h4 id="容器-runtime"><a href="#容器-runtime" class="headerlink" title="容器 runtime"></a>容器 runtime</h4><p>runtime是真正运行容器的地方，因此为了运行不同的容器runtime需要和操作系统内核紧密合作相互在<br>支持，以便为容器提供相应的运行环境</p>
<p>runtime 类型:</p>
<ul>
<li>Lxc: linux上早期的runtime，在 2013 年 Docker 刚发布的时候,就是采用lxc作为runtime, Docker把 LXC 复杂的容器创建与使用方式简化为 Docker 自己的一套命令体系。随着Docker的发展，原有的LXC不能满足Docker的需求,比如跨平台功能</li>
<li>Libcontainer: 随着 Docker 的不断发展，重新定义容器的实现标准，将底层实现都抽象化到Libcontainer 的接口。这就意味着，底层容器的实现方式变成了一种可变的方案，无论是使用namespace、cgroups 技术抑或是使用 systemd 等其他方案，只要实现了 Libcontainer 定义的一组接口，Docker 都可以运行。这也为 Docker 实现全面的跨平台带来了可能。</li>
<li>runc : 早期libcontainer是Docker公司控制的一个开源项目，OCI的成立后,Docker把libcontainer项目移交给了OCI组织,runC就是在libcontainer的基础上进化而来,目前Docker默认的runtime，runc遵守OCI规范</li>
<li>rkt: 是CoreOS开发的容器runtime，也符合OCI规范，所以使用rktruntime也可以运行Docker容器</li>
</ul>
<p>范例: 查看docker的 runtime</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">[root@ubuntu1804 ~]<span class="comment"># docker info</span></span><br><span class="line">Client:</span><br><span class="line">  Debug Mode: <span class="literal">false</span></span><br><span class="line"></span><br><span class="line">Server:</span><br><span class="line">  Containers: 0</span><br><span class="line">    Running: 0</span><br><span class="line">    Paused: 0</span><br><span class="line">    Stopped: 0</span><br><span class="line">  Images: 1</span><br><span class="line">  Server Version: 19.03.5</span><br><span class="line">  Storage Driver: overlay2</span><br><span class="line">    Backing Filesystem: extfs</span><br><span class="line">    Supports d_type: <span class="literal">true</span></span><br><span class="line">    Native Overlay Diff: <span class="literal">true</span></span><br><span class="line">  Logging Driver: json-file</span><br><span class="line">  Cgroup Driver: cgroupfs</span><br><span class="line">  Plugins:</span><br><span class="line">    Volume: <span class="built_in">local</span></span><br><span class="line">    Network: bridge host ipvlan macvlan null overlay</span><br><span class="line">    Log: awslogs fluentd gcplogs gelf journald json-file <span class="built_in">local</span> logentries splunk syslog</span><br><span class="line">Swarm: inactive</span><br><span class="line">  Runtimes: runc         <span class="comment">#Runtimes</span></span><br><span class="line">  Default Runtime: runc  <span class="comment">#runtime</span></span><br><span class="line">  Init Binary: docker-init</span><br><span class="line">  containerd version: b34a5c8af56e510852c35414db4c1f4fa6172339</span><br><span class="line">  runc version: 3e425f80a8c931f88e6d94a8c831b9d5aa481657</span><br><span class="line">  init version: fec3683</span><br><span class="line">  Security Options:</span><br><span class="line">    apparmor</span><br><span class="line">    seccomp</span><br><span class="line">      Profile: default</span><br><span class="line">  Kernel Version: 4.15.0-29-generic</span><br><span class="line">  Operating System: Ubuntu 18.04.1 LTS</span><br><span class="line">  OSType: linux</span><br><span class="line">  Architecture: x86_64</span><br><span class="line">  CPUs: 1</span><br><span class="line">  Total Memory: 962MiB</span><br><span class="line">  Name: ubuntu1804.wang.org</span><br><span class="line">  ID: G2JQ:M4DG:CW74:EETR:GU5U:OROC:ZN2F:RKSA:YQY2:XJYX:OHG7:SSVE</span><br><span class="line">  Docker Root Dir: /var/lib/docker</span><br><span class="line">  Debug Mode: <span class="literal">false</span></span><br><span class="line">  Registry: https://index.docker.io/v1/</span><br><span class="line">  Labels:</span><br><span class="line">  Experimental: <span class="literal">false</span></span><br><span class="line">  Insecure Registries:</span><br><span class="line">    127.0.0.0/8</span><br><span class="line">  Live Restore Enabled: <span class="literal">false</span></span><br><span class="line"></span><br><span class="line">WARNING: No swap <span class="built_in">limit</span> support</span><br></pre></td></tr></table></figure>

<h4 id="容器管理工具-1"><a href="#容器管理工具-1" class="headerlink" title="容器管理工具"></a>容器管理工具</h4><p>管理工具连接runtime与用户，对用户提供图形或命令方式操作，然后管理工具将用户操作传递给runtime执行。</p>
<ul>
<li>lxc 是lxd 的管理工具</li>
<li>Runc的管理工具是 docker engine ，docker engine包含后台deamon和cli两部分，大家经常提到的Docker就是指的docker engine</li>
<li>Rkt的管理工具是rkt cli</li>
</ul>
<p>范例: 查看docker engine</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">[root@ubuntu1804 ~]<span class="comment"># docker version</span></span><br><span class="line">Client: Docker Engine - Community</span><br><span class="line"> Version:           19.03.5</span><br><span class="line"> API version:       1.40</span><br><span class="line"> Go version:        go1.12.12</span><br><span class="line"> Git commit:        633a0ea838</span><br><span class="line"> Built:             Wed Nov 13 07:29:52 2019</span><br><span class="line"> OS/Arch:           linux/amd64</span><br><span class="line"> Experimental:      <span class="literal">false</span></span><br><span class="line"></span><br><span class="line">Server: Docker Engine - Community</span><br><span class="line">Engine:</span><br><span class="line"> Version:        19.03.5</span><br><span class="line"> API version:    1.40 (minimum version 1.12)</span><br><span class="line"> Go version:     go1.12.12</span><br><span class="line"> Git commit:     633a0ea838</span><br><span class="line"> Built:          Wed Nov 13 07:28:22 2019</span><br><span class="line"> OS/Arch:        linux/amd64</span><br><span class="line"> Experimental:   <span class="literal">false</span></span><br><span class="line">containerd:</span><br><span class="line"> Version:        1.2.10</span><br><span class="line"> GitCommit:      b34a5c8af56e510852c35414db4c1f4fa6172339</span><br><span class="line">runc:</span><br><span class="line"> Version:        1.0.0-rc8+dev</span><br><span class="line"> GitCommit:      3e425f80a8c931f88e6d94a8c831b9d5aa481657</span><br><span class="line">docker-init:</span><br><span class="line"> Version:        0.18.0</span><br><span class="line"> GitCommit:      fec3683</span><br></pre></td></tr></table></figure>


<h4 id="镜像仓库-Registry"><a href="#镜像仓库-Registry" class="headerlink" title="镜像仓库 Registry"></a>镜像仓库 Registry</h4><p>统一保存镜像而且是多个不同镜像版本的地方，叫做镜像仓库</p>
<ul>
<li>Docker hub: docker官方的公共仓库，已经保存了大量的常用镜像，可以方便大家直接使用</li>
<li>阿里云，网易等第三方镜像的公共仓库</li>
<li>Image registry: docker 官方提供的私有仓库部署工具，无web管理界面，目前使用较少</li>
<li>Harbor: vmware 提供的自带web界面自带认证功能的镜像私有仓库，目前有很多公司使用</li>
</ul>
<p>范例: 镜像地址格式</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">docker.io/library/alpine</span><br><span class="line">harbor.wang.org/project/centos:7.2.1511</span><br><span class="line">registry.cn-hangzhou.aliyuncs.com/wangxiaochun/magedu:v1</span><br><span class="line">172.18.200.101/project/centos: latest</span><br><span class="line">172.18.200.101/project/java-7.0.59:v1</span><br></pre></td></tr></table></figure>

<h4 id="容器编排工具"><a href="#容器编排工具" class="headerlink" title="容器编排工具"></a>容器编排工具</h4><p><img src="../../../../images/SRE/day46/14.jpg" alt="14"></p>
<p>当多个容器在多个主机运行的时候，单独管理容器是相当复杂而且很容易出错，而且也无法实现某一台主机宕机后容器自动迁移到其他主机从而实现高可用的目的，也无法实现动态伸缩的功能，因此需要有一种工具可以实现统一管理、动态伸缩、故障自愈、批量执行等功能，这就是容器编排引擎</p>
<p>容器编排通常包括容器管理、调度、集群定义和服务发现等功能</p>
<ul>
<li>Docker compose : docker 官方实现单机的容器的编排工具</li>
<li>Docker swarm: docker 官方开发的容器编排引擎,支持overlay network</li>
<li>Mesos+Marathon: Mesos是Apache下的开源分布式资源管理框架，它被称为是分布式系统的内核。Mesos最初是由加州大学伯克利分校的AMPLab开发的，后在Twitter得到广泛使用。通用的集群组员调度平台，mesos(资源分配)与marathon(容器编排平台)一起提供容器编排引擎功能</li>
<li>Kubernetes: google领导开发的容器编排引擎，内部项目为Borg，且其同时支持 docker 和CoreOS,当前已成为容器编排工具事实上的标准</li>
</ul>
<h2 id="Docker-安装及基础命令介绍"><a href="#Docker-安装及基础命令介绍" class="headerlink" title="Docker 安装及基础命令介绍"></a>Docker 安装及基础命令介绍</h2><h3 id="Docker-安装准备"><a href="#Docker-安装准备" class="headerlink" title="Docker 安装准备"></a>Docker 安装准备</h3><p>官方网址: <a target="_blank" rel="noopener" href="https://www.docker.com/">https://www.docker.com/</a></p>
<p><strong>OS系统版本选择:</strong></p>
<p>Docker 目前已经支持多种操作系统的安装运行，比如Ubuntu、CentOS、Redhat、Debian、Fedora，甚至是还支持了Mac和Windows，在linux系统上需要内核版本在3.10或以上</p>
<p>Docker版本选择:</p>
<p><img src="../../../../images/SRE/day46/15.jpg" alt="15"></p>
<p>Docker版本号之前一直是0.X版本或1.X版本，从 2013 年 3 月 13 日发布第一个版本0.1.1-1开始一直到 2017年 02 月 08 日发布1.13.1版</p>
<p>从 2017 年 3 月 1 号开始改为每个季度发布一次稳定版，其版本号规则也统一变更为YY.MM.xx，第一个版本为17.03.0, 例如17.09表示是 2017 年 9 月份发布的</p>
<p>Docker之前没有区分版本，但是 2017 年推出(将docker更名为)新的项目Moby，github地址: <a target="_blank" rel="noopener" href="https://github.com/moby/moby%EF%BC%8CMoby%E9%A1%B9%E7%9B%AE%E5%B1%9E%E4%BA%8EDocker%E9%A1%B9%E7%9B%AE%E7%9A%84%E5%85%A8%E6%96%B0%E4%B8%8A%E6%B8%B8%EF%BC%8CDocker%E5%B0%86%E6%98%AF%E4%B8%80%E4%B8%AA%E9%9A%B6%E5%B1%9E%E4%BA%8E%E7%9A%84Moby%E7%9A%84%E5%AD%90%E4%BA%A7%E5%93%81%EF%BC%8C%E8%80%8C%E4%B8%94%E4%B9%8B%E5%90%8E%E7%9A%84%E7%89%88%E6%9C%AC%E4%B9%8B%E5%90%8E%E5%BC%80%E5%A7%8B%E5%8C%BA%E5%88%86%E4%B8%BA">https://github.com/moby/moby，Moby项目属于Docker项目的全新上游，Docker将是一个隶属于的Moby的子产品，而且之后的版本之后开始区分为</a> CE（Docker Community Edition，社区版本）和 EE（Docker Enterprise Edition，企业收费版），CE社区版本和EE企业版本都是每个季度发布一个新版本，但是EE版本提供后期安全维护 1 年，而CE版本是 4 个月，以下为官方原文:</p>
<p><a target="_blank" rel="noopener" href="https://blog.docker.com/2017/03/docker-enterprise-edition/">https://blog.docker.com/2017/03/docker-enterprise-edition/</a></p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Docker CE and EE are released quarterly, and CE also has a monthly “Edge” option.</span><br><span class="line">Each Docker EE release is supported and maintained for one year and receives</span><br><span class="line">security and critical bugfixes during that period. We are also improving Docker</span><br><span class="line">CE maintainability by maintaining each quarterly CE release for 4 months. That</span><br><span class="line">gets Docker CE users a new 1-month window to update from one version to the next.</span><br></pre></td></tr></table></figure>

<p>如果要布署到 kubernetes上，需要查看相关kubernetes对docker版本要求的说明，比如:</p>
<p><a target="_blank" rel="noopener" href="https://github.com/kubernetes/kubernetes/blob/v1.17.2/CHANGELOG-1.17.md">https://github.com/kubernetes/kubernetes/blob/v1.17.2/CHANGELOG-1.17.md</a></p>
<h3 id="安装和删除方法"><a href="#安装和删除方法" class="headerlink" title="安装和删除方法"></a>安装和删除方法</h3><p>官方文档 : <a target="_blank" rel="noopener" href="https://docs.docker.com/engine/install/">https://docs.docker.com/engine/install/</a></p>
<p>阿里云文档: <a target="_blank" rel="noopener" href="https://developer.aliyun.com/mirror/docker-ce?spm=a2c6h.13651102.0.0.3e221b11guHCWE">https://developer.aliyun.com/mirror/docker-ce?spm=a2c6h.13651102.0.0.3e221b11guHCWE</a></p>
<h4 id="Ubuntu-安装和删除Docker"><a href="#Ubuntu-安装和删除Docker" class="headerlink" title="Ubuntu 安装和删除Docker"></a>Ubuntu 安装和删除Docker</h4><p>官方文档: <a target="_blank" rel="noopener" href="https://docs.docker.com/install/linux/docker-ce/ubuntu/">https://docs.docker.com/install/linux/docker-ce/ubuntu/</a></p>
<p><strong>Ubuntu 14.04/16.04/18.04/20.04 安装docker</strong></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># step 1: 安装必要的一些系统工具</span></span><br><span class="line">sudo apt-get update</span><br><span class="line">sudo apt-get -y install apt-transport-https ca-certificates curl software-properties-common</span><br><span class="line"></span><br><span class="line"><span class="comment"># step 2: 安装GPG证书</span></span><br><span class="line">curl -fsSL https://mirrors.aliyun.com/docker-ce/linux/ubuntu/gpg | sudo apt-keyadd -</span><br><span class="line"></span><br><span class="line"><span class="comment"># Step 3: 写入软件源信息</span></span><br><span class="line">sudo add-apt-repository <span class="string">&quot;deb [arch=amd64] https://mirrors.aliyun.com/docker-ce/linux/ubuntu <span class="subst">$(lsb_release -cs)</span> stable&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Step 4: 更新并安装Docker-CE</span></span><br><span class="line">sudo apt-get -y update</span><br><span class="line">sudo apt-get -y install docker-ce</span><br><span class="line"></span><br><span class="line"><span class="comment"># 安装指定版本的Docker-CE:</span></span><br><span class="line"><span class="comment"># Step 1: 查找Docker-CE的版本:</span></span><br><span class="line">apt-cache madison docker-ce</span><br><span class="line">docker-ce | 5:19.03.5~3-0~ubuntu-bionic | https://mirrors.aliyun.com/docker-ce/linux/ubuntu bionic/stable amd64 Packages</span><br><span class="line"></span><br><span class="line"><span class="comment"># Step 2: 安装指定版本的Docker-CE: (VERSION例如上面的5:17.03.1~ce-0~ubuntu-xenial)</span></span><br><span class="line">sudo apt-get -y install docker-ce=[VERSION] docker-ce-cli=[VERSION]</span><br><span class="line"><span class="comment">#示例:指定版本安装</span></span><br><span class="line">apt-get -y install docker-ce=5:18.09.9~3-0~ubuntu-bionic  docker-ce-cli=5:18.09.9~3-0~ubuntu-bionic</span><br></pre></td></tr></table></figure>
<p><strong>删除docker</strong></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@ubuntu ~]<span class="comment"># apt purge docker-ce</span></span><br><span class="line">[root@ubuntu ~]<span class="comment"># rm -rf /var/lib/docker</span></span><br></pre></td></tr></table></figure>

<p>范例: 内置仓库安装docker</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line">[root@ubuntu2004 ~]<span class="comment"># apt -y install docker.io</span></span><br><span class="line">[root@ubuntu2004 ~]<span class="comment"># docker version</span></span><br><span class="line">Client:</span><br><span class="line"> Version: 20.10.12</span><br><span class="line"> API version: 1.41</span><br><span class="line"> Go version: go1.16.2</span><br><span class="line"> Git commit: 20.10.12-0ubuntu2~20.04.1</span><br><span class="line"> Built: Wed Apr 6 02:14:38 2022</span><br><span class="line"> OS/Arch: linux/amd64</span><br><span class="line"> Context: default</span><br><span class="line"> Experimental: <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">Server:</span><br><span class="line"> Engine:</span><br><span class="line">  Version: 20.10.12</span><br><span class="line">  API version: 1.41 (minimum version 1.12)</span><br><span class="line">  Go version: go1.16.2</span><br><span class="line">  Git commit: 20.10.12-0ubuntu2~20.04.1</span><br><span class="line">  Built: Thu Feb 10 15:03:35 2022</span><br><span class="line">  OS/Arch: linux/amd64</span><br><span class="line">  Experimental: <span class="literal">false</span></span><br><span class="line"> containerd:</span><br><span class="line">  Version: 1.5.9-0ubuntu1~20.04.4</span><br><span class="line">  GitCommit:</span><br><span class="line"> runc:</span><br><span class="line">  Version: 1.1.0-0ubuntu1~20.04.1</span><br><span class="line">  GitCommit:</span><br><span class="line"> docker-init:</span><br><span class="line">  Version: 0.19.0</span><br><span class="line">  GitCommit:</span><br><span class="line"></span><br><span class="line">[root@ubuntu2004 ~]<span class="comment"># docker info</span></span><br><span class="line">Client:</span><br><span class="line"> Context: default</span><br><span class="line"> Debug Mode: <span class="literal">false</span></span><br><span class="line"></span><br><span class="line">Server:</span><br><span class="line"> Containers: 0</span><br><span class="line">  Running: 0</span><br><span class="line">  Paused: 0</span><br><span class="line">  Stopped: 0</span><br><span class="line"> Images: 0</span><br><span class="line">  Server Version: 20.10.12</span><br><span class="line">  Storage Driver: overlay2</span><br><span class="line">  Backing Filesystem: extfs</span><br><span class="line">  Supports d_type: <span class="literal">true</span></span><br><span class="line">  Native Overlay Diff: <span class="literal">true</span></span><br><span class="line">  userxattr: <span class="literal">false</span></span><br><span class="line"> Logging Driver: json-file</span><br><span class="line"> Cgroup Driver: cgroupfs</span><br><span class="line"> Cgroup Version: 1</span><br><span class="line"> Plugins:</span><br><span class="line">  Volume: <span class="built_in">local</span></span><br><span class="line">  Network: bridge host ipvlan macvlan null overlay</span><br><span class="line">  Log: awslogs fluentd gcplogs gelf journald json-file <span class="built_in">local</span> logentries splunk</span><br><span class="line"> syslog</span><br><span class="line">  Swarm: inactive</span><br><span class="line">  Runtimes: io.containerd.runtime.v1.linux runc io.containerd.runc.v2</span><br><span class="line"> Default Runtime: runc</span><br><span class="line"> Init Binary: docker-init</span><br><span class="line"> containerd version:</span><br><span class="line"> runc version:</span><br><span class="line"> init version:</span><br><span class="line"> Security Options:</span><br><span class="line">  apparmor</span><br><span class="line">  seccomp</span><br><span class="line">   Profile: default</span><br><span class="line"> Kernel Version: 5.4.0-89-generic</span><br><span class="line"> Operating System: Ubuntu 20.04.3 LTS</span><br><span class="line"> OSType: linux</span><br><span class="line"> Architecture: x86_64</span><br><span class="line"> CPUs: 2</span><br><span class="line"> Total Memory: 1.913GiB</span><br><span class="line"> Name: ubuntu2004.wang.org</span><br><span class="line"> ID: UF2A:GX7G:OIWE:W35O:EFSB:5WBH:AYCZ:N37P:YCIF:4AXD:D3IL:NCI4 </span><br><span class="line"> Docker Root Dir: /var/lib/docker</span><br><span class="line"> Debug Mode: <span class="literal">false</span></span><br><span class="line"> Registry: https://index.docker.io/v1/</span><br><span class="line"> Labels:</span><br><span class="line"> Experimental: <span class="literal">false</span></span><br><span class="line"> Insecure Registries:</span><br><span class="line">  127.0.0.0/8</span><br><span class="line"> Live Restore Enabled: <span class="literal">false</span></span><br><span class="line"> </span><br><span class="line"> WARNING: No swap <span class="built_in">limit</span> support</span><br></pre></td></tr></table></figure>


<p>范例： 安装指定版本</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># step 1: 安装必要的一些系统工具</span></span><br><span class="line">[root@ubuntu2004 ~]<span class="comment"># sudo apt-get update</span></span><br><span class="line">[root@ubuntu2004 ~]<span class="comment"># sudo apt-get -y install apt-transport-https ca-certificates curl software-properties-common</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># step 2: 安装GPG证书</span></span><br><span class="line">[root@ubuntu2004 ~]<span class="comment"># curl -fsSL https://mirrors.aliyun.com/docker-ce/linux/ubuntu/gpg | sudo apt-key add -</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Step 3: 写入软件源信息</span></span><br><span class="line">[root@ubuntu2004 ~]<span class="comment"># sudo add-apt-repository &quot;deb [arch=amd64] https://mirrors.aliyun.com/docker-ce/linux/ubuntu $(lsb_release -cs) stable&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Step 4: 更新并安装Docker-CE</span></span><br><span class="line">[root@ubuntu2004 ~]<span class="comment"># sudo apt-get -y update</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 安装指定版本的Docker-CE:</span></span><br><span class="line"><span class="comment"># Step 1: 查找Docker-CE的版本:</span></span><br><span class="line">[root@ubuntu2004 ~]<span class="comment"># apt-cache madison docker-ce</span></span><br><span class="line"><span class="comment"># docker-ce | 17.03.1~ce-0~ubuntu-xenial | https://mirrors.aliyun.com/docker-ce/linux/ubuntu xenial/stable amd64 Packages</span></span><br><span class="line"><span class="comment"># docker-ce | 17.03.0~ce-0~ubuntu-xenial | https://mirrors.aliyun.com/docker-ce/linux/ubuntu xenial/stable amd64 Packages</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Step 2: 安装指定版本的Docker-CE: (VERSION例如上面的17.03.1~ce-0~ubuntu-xenial)</span></span><br><span class="line"><span class="comment"># sudo apt-get -y install docker-ce=[VERSION]</span></span><br><span class="line">[root@ubuntu2004 ~]<span class="comment"># apt-cache madison docker-ce</span></span><br><span class="line">docker-ce | 5:20.10.17~3-0~ubuntu-focal | https://mirrors.aliyun.com/docker-ce/linux/ubuntu focal/stable amd64 Packages</span><br><span class="line">docker-ce | 5:20.10.16~3-0~ubuntu-focal | https://mirrors.aliyun.com/docker-ce/linux/ubuntu focal/stable amd64 Packages</span><br><span class="line">docker-ce | 5:20.10.15~3-0~ubuntu-focal | https://mirrors.aliyun.com/docker-ce/linux/ubuntu focal/stable amd64 Packages</span><br><span class="line"></span><br><span class="line">[root@ubuntu2004 ~]<span class="comment"># apt install docker-ce=5:20.10.10~3-0~ubuntu-focal docker-ce-cli=5:20.10.10~3-0~ubuntu-focal</span></span><br><span class="line"></span><br><span class="line">[root@ubuntu2004 ~]<span class="comment"># docker version</span></span><br><span class="line">Client: Docker Engine - Community</span><br><span class="line"> Version: 20.10.10</span><br><span class="line"> API version: 1.41</span><br><span class="line"> Go version: go1.16.9</span><br><span class="line"> Git commit: b485636</span><br><span class="line"> Built: Mon Oct 25 07:42:59 2021</span><br><span class="line"> OS/Arch: linux/amd64</span><br><span class="line"> Context: default</span><br><span class="line"> Experimental:  <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">Server: Docker Engine - Community</span><br><span class="line"> Engine:</span><br><span class="line">  Version:  20.10.10</span><br><span class="line">  API version:  1.41 (minimum version 1.12)</span><br><span class="line">  Goversion: go1.16.9</span><br><span class="line">  Git commit: e2f740d</span><br><span class="line">  Built: Mon Oct 25 07:41:08 2021</span><br><span class="line">  OS/Arch: linux/amd64</span><br><span class="line">  Experimental: <span class="literal">false</span></span><br><span class="line"> containerd:</span><br><span class="line">  Version:  1.6.6</span><br><span class="line">  GitCommit: 10c12954828e7c7c9b6e0ea9b0c02b01407d3ae1</span><br><span class="line"> runc:</span><br><span class="line">  Version:  1.1.2</span><br><span class="line">  GitCommit: v1.1.2-0-ga916309</span><br><span class="line"> docker-init:</span><br><span class="line">  Version:  0.19.0</span><br><span class="line">  GitCommit: de40ad0</span><br></pre></td></tr></table></figure>
<h4 id="CentOS-安装和删除Docker"><a href="#CentOS-安装和删除Docker" class="headerlink" title="CentOS 安装和删除Docker"></a>CentOS 安装和删除Docker</h4><p>官方文档: <a target="_blank" rel="noopener" href="https://docs.docker.com/install/linux/docker-ce/centos/">https://docs.docker.com/install/linux/docker-ce/centos/</a></p>
<p>CentOS 6 因内核太旧，即使支持安装docker，但会有各种问题，不建议安装</p>
<p>CentOS 7 的 extras 源虽然可以安装docker，但包比较旧，建议从官方源或镜像源站点下载安装docker</p>
<p>CentOS 8 有新技术 podman 代替 docker</p>
<p>因此建议在CentOS 7 上安装 docker</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#extras 源中包名为docker</span></span><br><span class="line">[root@centos7 ~]<span class="comment"># yum list docker</span></span><br><span class="line">Loaded plugins: fastestmirror</span><br><span class="line">Repository base is listed more than once <span class="keyword">in</span> the configuration</span><br><span class="line">Repository extras is listed more than once <span class="keyword">in</span> the configuration</span><br><span class="line">Loading mirror speeds from cached hostfile</span><br><span class="line"> * base: mirrors.tuna.tsinghua.edu.cn</span><br><span class="line"> * extras: mirrors.tuna.tsinghua.edu.cn</span><br><span class="line"> * updates: mirrors.tuna.tsinghua.edu.cn</span><br><span class="line">Available Packages</span><br><span class="line">docker.x86_64  2:1.13.1-103.git7f2769b.el7.centos</span><br><span class="line">extras</span><br></pre></td></tr></table></figure>

<p><strong>下载rpm包安装:</strong></p>
<p>官方rpm包下载地址:</p>
<p><a target="_blank" rel="noopener" href="https://download.docker.com/linux/centos/7/x86_64/stable/Packages/">https://download.docker.com/linux/centos/7/x86_64/stable/Packages/</a></p>
<p>阿里镜像下载地址:</p>
<p><a target="_blank" rel="noopener" href="https://mirrors.aliyun.com/docker-ce/linux/centos/7/x86_64/stable/Packages/">https://mirrors.aliyun.com/docker-ce/linux/centos/7/x86_64/stable/Packages/</a></p>
<p><strong>通过yum源安装:</strong></p>
<p>由于官网的yum源太慢，下面使用阿里云的Yum源进行安装</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">rm</span> -rf /etc/yum.repos.d/*</span><br><span class="line"></span><br><span class="line"><span class="comment">#CentOS 7 安装docker依赖三个yum源:Base,Extras,docker-ce</span></span><br><span class="line">wget -O /etc/yum.repos.d/CentOS-Base.repo http://mirrors.aliyun.com/repo/Centos-7.repo</span><br><span class="line">wget -O /etc/yum.repos.d/epel.repo http://mirrors.aliyun.com/repo/epel-7.repo</span><br><span class="line">wget -O /etc/yum.repos.d/docker-ce.repo https://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo</span><br><span class="line"></span><br><span class="line">yum clean all</span><br><span class="line">yum -y install docker-ce</span><br><span class="line">systemctl <span class="built_in">enable</span> --now docker</span><br></pre></td></tr></table></figure>



<p><strong>删除 docker</strong></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@centos7 ~]<span class="comment"># yum remove docker-ce</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#删除docker资源存放的相关文件</span></span><br><span class="line">[root@centos7 ~]<span class="comment"># rm -rf /var/lib/docker</span></span><br></pre></td></tr></table></figure>

<p>范例： 安装指定版本</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line">[root@rocky8 ~]<span class="comment"># cat /etc/yum.repos.d/docker.repo</span></span><br><span class="line">[docker-ce]</span><br><span class="line">name=docker-ce</span><br><span class="line">baseurl=https://mirrors.aliyun.com/docker-ce/linux/centos/8/x86_64/stable/</span><br><span class="line">gpgcheck=0</span><br><span class="line"></span><br><span class="line">[root@rocky8 ~]<span class="comment"># yum list docker-ce --showduplicates </span></span><br><span class="line">Last metadata expiration check: 0:00:13 ago on Mon 07 Apr 2025 08:41:43 AM CST.</span><br><span class="line">Available Packages</span><br><span class="line">docker-ce.x86_64                                3:19.03.13-3.el8                                docker-ce</span><br><span class="line">docker-ce.x86_64                                3:19.03.14-3.el8                                docker-ce</span><br><span class="line">docker-ce.x86_64                                3:19.03.15-3.el8                                docker-ce</span><br><span class="line">docker-ce.x86_64                                3:20.10.0-3.el8                                 docker-ce</span><br><span class="line">docker-ce.x86_64                                3:20.10.1-3.el8                                 docker-ce</span><br><span class="line">docker-ce.x86_64                                3:20.10.2-3.el8                                 docker-ce</span><br><span class="line">docker-ce.x86_64                                3:20.10.3-3.el8                                 docker-ce</span><br><span class="line">docker-ce.x86_64                                3:20.10.4-3.el8                                 docker-ce</span><br><span class="line">docker-ce.x86_64                                3:20.10.5-3.el8                                 docker-ce</span><br><span class="line">docker-ce.x86_64                                3:20.10.6-3.el8                                 docker-ce</span><br><span class="line">docker-ce.x86_64                                3:20.10.7-3.el8                                 docker-ce</span><br><span class="line">docker-ce.x86_64                                3:20.10.8-3.el8                                 docker-ce</span><br><span class="line">docker-ce.x86_64                                3:20.10.9-3.el8                                 docker-ce</span><br><span class="line">docker-ce.x86_64                                3:20.10.10-3.el8                                docker-ce</span><br><span class="line">docker-ce.x86_64                                3:20.10.11-3.el8                                docker-ce</span><br><span class="line">docker-ce.x86_64                                3:20.10.12-3.el8                                docker-ce</span><br><span class="line">docker-ce.x86_64                                3:20.10.13-3.el8                                docker-ce</span><br><span class="line">docker-ce.x86_64                                3:20.10.14-3.el8                                docker-ce</span><br><span class="line">docker-ce.x86_64                                3:20.10.15-3.el8                                docker-ce</span><br><span class="line">docker-ce.x86_64                                3:20.10.16-3.el8                                docker-ce</span><br><span class="line">docker-ce.x86_64                                3:20.10.17-3.el8                                docker-ce</span><br><span class="line">docker-ce.x86_64                                3:20.10.18-3.el8                                docker-ce</span><br><span class="line">docker-ce.x86_64                                3:20.10.19-3.el8                                docker-ce</span><br><span class="line">docker-ce.x86_64                                3:20.10.20-3.el8                                docker-ce</span><br><span class="line">docker-ce.x86_64                                3:20.10.21-3.el8                                docker-ce</span><br><span class="line">docker-ce.x86_64                                3:20.10.22-3.el8                                docker-ce</span><br><span class="line">docker-ce.x86_64                                3:20.10.23-3.el8                                docker-ce</span><br><span class="line">docker-ce.x86_64                                3:20.10.24-3.el8                                docker-ce</span><br><span class="line">docker-ce.x86_64                                3:23.0.0-1.el8                                  docker-ce</span><br><span class="line">docker-ce.x86_64                                3:23.0.1-1.el8                                  docker-ce</span><br><span class="line">docker-ce.x86_64                                3:23.0.2-1.el8                                  docker-ce</span><br><span class="line">docker-ce.x86_64                                3:23.0.3-1.el8                                  docker-ce</span><br><span class="line">docker-ce.x86_64                                3:23.0.4-1.el8                                  docker-ce</span><br><span class="line">docker-ce.x86_64                                3:23.0.5-1.el8                                  docker-ce</span><br><span class="line">docker-ce.x86_64                                3:23.0.6-1.el8                                  docker-ce</span><br><span class="line">docker-ce.x86_64                                3:24.0.0-1.el8                                  docker-ce</span><br><span class="line">docker-ce.x86_64                                3:24.0.1-1.el8                                  docker-ce</span><br><span class="line">docker-ce.x86_64                                3:24.0.2-1.el8                                  docker-ce</span><br><span class="line">docker-ce.x86_64                                3:24.0.3-1.el8                                  docker-ce</span><br><span class="line">docker-ce.x86_64                                3:24.0.4-1.el8                                  docker-ce</span><br><span class="line">docker-ce.x86_64                                3:24.0.5-1.el8                                  docker-ce</span><br><span class="line">docker-ce.x86_64                                3:24.0.6-1.el8                                  docker-ce</span><br><span class="line">docker-ce.x86_64                                3:24.0.7-1.el8                                  docker-ce</span><br><span class="line">docker-ce.x86_64                                3:24.0.8-1.el8                                  docker-ce</span><br><span class="line">docker-ce.x86_64                                3:24.0.9-1.el8                                  docker-ce</span><br><span class="line">docker-ce.x86_64                                3:25.0.0-1.el8                                  docker-ce</span><br><span class="line">docker-ce.x86_64                                3:25.0.1-1.el8                                  docker-ce</span><br><span class="line">docker-ce.x86_64                                3:25.0.2-1.el8                                  docker-ce</span><br><span class="line">docker-ce.x86_64                                3:25.0.3-1.el8                                  docker-ce</span><br><span class="line">docker-ce.x86_64                                3:25.0.4-1.el8                                  docker-ce</span><br><span class="line">docker-ce.x86_64                                3:25.0.5-1.el8                                  docker-ce</span><br><span class="line">docker-ce.x86_64                                3:26.0.0-1.el8                                  docker-ce</span><br><span class="line">docker-ce.x86_64                                3:26.0.1-1.el8                                  docker-ce</span><br><span class="line">docker-ce.x86_64                                3:26.0.2-1.el8                                  docker-ce</span><br><span class="line">docker-ce.x86_64                                3:26.1.0-1.el8                                  docker-ce</span><br><span class="line">docker-ce.x86_64                                3:26.1.1-1.el8                                  docker-ce</span><br><span class="line">docker-ce.x86_64                                3:26.1.2-1.el8                                  docker-ce</span><br><span class="line">docker-ce.x86_64                                3:26.1.3-1.el8                                  docker-ce</span><br><span class="line"></span><br><span class="line">[root@rocky8 ~]<span class="comment"># yum install docker-ce-3:26.1.3-1.el8 docker-ce-cli-1:26.1.3-1.el8 -y</span></span><br><span class="line"></span><br><span class="line">[root@rocky8 ~]<span class="comment"># docker version</span></span><br><span class="line">Client: Docker Engine - Community</span><br><span class="line"> Version:           26.1.3</span><br><span class="line"> API version:       1.45</span><br><span class="line"> Go version:        go1.21.10</span><br><span class="line"> Git commit:        b72abbb</span><br><span class="line"> Built:             Thu May 16 08:34:39 2024</span><br><span class="line"> OS/Arch:           linux/amd64</span><br><span class="line"> Context:           default</span><br><span class="line">Cannot connect to the Docker daemon at unix:///var/run/docker.sock. Is the docker daemon running?</span><br><span class="line"></span><br><span class="line">[root@rocky8 ~]<span class="comment"># systemctl enable --now docker.service </span></span><br><span class="line">Created symlink /etc/systemd/system/multi-user.target.wants/docker.service → /usr/lib/systemd/system/docker.service.</span><br></pre></td></tr></table></figure>


<p>范例: CentOS 7 基于阿里云的安装docker方法</p>
<p>阿里云说明: <a target="_blank" rel="noopener" href="https://developer.aliyun.com/mirror/docker-ce?spm=a2c6h.13651102.0.0.3e221b11sUMKNV">https://developer.aliyun.com/mirror/docker-ce?spm=a2c6h.13651102.0.0.3e221b11sUMKNV</a></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># step 1: 安装必要的一些系统工具</span></span><br><span class="line">yum install -y yum-utils device-mapper-persistent-data lvm2</span><br><span class="line"><span class="comment"># Step 2: 添加软件源信息</span></span><br><span class="line">yum-config-manager --add-repo https://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo</span><br><span class="line"><span class="comment"># Step 3: 更新并安装Docker-CE</span></span><br><span class="line">yum makecache fast</span><br><span class="line">yum -y install docker-ce</span><br><span class="line"><span class="comment"># Step 4: 开启Docker服务</span></span><br><span class="line">service docker start</span><br><span class="line"></span><br><span class="line"><span class="comment"># 注意:</span></span><br><span class="line"><span class="comment"># 官方软件源默认启用了最新的软件，您可以通过编辑软件源的方式获取各个版本的软件包。例如官方并没有将测试版本的软件源置为可用，您可以通过以下方式开启。同理可以开启各种测试版本等。</span></span><br><span class="line"><span class="comment"># vim /etc/yum.repos.d/docker-ee.repo</span></span><br><span class="line"><span class="comment"># 将[docker-ce-test]下方的enabled=0修改为enabled=1</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># 安装指定版本的Docker-CE:</span></span><br><span class="line"><span class="comment"># Step 1: 查找Docker-CE的版本:</span></span><br><span class="line"><span class="comment"># yum list docker-ce.x86_64 --showduplicates | sort -r</span></span><br><span class="line"><span class="comment"># Loading mirror speeds from cached hostfile</span></span><br><span class="line"><span class="comment"># Loaded plugins: branch, fastestmirror, langpacks</span></span><br><span class="line"><span class="comment"># docker-ce.x86_64 17.03.1.ce-1.el7.centos docker-ce-stable</span></span><br><span class="line"><span class="comment"># docker-ce.x86_64 17.03.1.ce-1.el7.centos @docker-ce-stable</span></span><br><span class="line"><span class="comment"># docker-ce.x86_64 17.03.0.ce-1.el7.centos docker-ce-stable</span></span><br><span class="line"><span class="comment"># Available Packages</span></span><br><span class="line"><span class="comment"># Step2: 安装指定版本的Docker-CE: (VERSION例如上面的17.03.0.ce.1-1.el7.centos)</span></span><br><span class="line">yum -y install docker-ce-[VERSION]</span><br><span class="line"></span><br><span class="line"><span class="comment">#示例</span></span><br><span class="line">[root@centos7 ~]<span class="comment"># yum -y install docker-ce-19.03.12-3.el7</span></span><br><span class="line">[root@centos7 ~]<span class="comment"># cat /etc/redhat-release</span></span><br><span class="line">CentOS Linux release 7.6.1810 (Core)</span><br><span class="line"></span><br><span class="line">[root@centos7 ~]<span class="comment"># ls /etc/yum.repos.d/</span></span><br></pre></td></tr></table></figure>

<p>范例: 在CentOS 7上安装指定版本的docker</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line">[root@centos7 ~]<span class="comment"># cat /etc/redhat-release </span></span><br><span class="line">CentOS Linux release 7.6.1810 (Core)</span><br><span class="line"></span><br><span class="line">[root@centos7 ~]<span class="comment"># ls /etc/yum.repos.d/</span></span><br><span class="line">backup base.repo</span><br><span class="line"></span><br><span class="line">[root@centos7 ~]<span class="comment"># wget -P /etc/yum.repos.d/ https://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo</span></span><br><span class="line">Saving to: ‘/etc/yum.repos.d/docker-ce.repo’</span><br><span class="line">100%[====================================================================&gt;]</span><br><span class="line">2,640 --.-K/s <span class="keyword">in</span> 0s</span><br><span class="line"></span><br><span class="line">2020-01-23 21:56:21 (505 MB/s) - ‘/etc/yum.repos.d/docker-ce.repo’ saved [2640/2640]</span><br><span class="line"></span><br><span class="line">[root@centos7 ~]<span class="comment"># ls /etc/yum.repos.d/</span></span><br><span class="line">backup base.repo docker-ce.repo</span><br><span class="line"></span><br><span class="line">[root@centos7 ~]<span class="comment"># yum clean all</span></span><br><span class="line">Loaded plugins: fastestmirror</span><br><span class="line">Cleaning repos: base docker-ce-stable epel extras</span><br><span class="line">Cleaning up list of fastest mirrors</span><br><span class="line"></span><br><span class="line">[root@centos7 ~]<span class="comment"># yum repolist</span></span><br><span class="line">[root@centos7 ~]<span class="comment"># yum list docker-ce* --showduplicates | sort -r</span></span><br><span class="line">Loading mirror speeds from cached hostfile</span><br><span class="line">Loaded plugins: fastestmirror</span><br><span class="line">docker-ce.x86_64  3:19.03.5-3.el7 docker-ce-stable</span><br><span class="line">docker-ce.x86_64  3:19.03.4-3.el7 docker-ce-stable</span><br><span class="line">docker-ce.x86_64  3:19.03.3-3.el7 docker-ce-stable</span><br><span class="line">docker-ce.x86_64  3:19.03.2-3.el7 docker-ce-stable</span><br><span class="line">......</span><br><span class="line"></span><br><span class="line">[root@centos7 ~]<span class="comment"># yum -y install docker-ce-18.09.9-3.el7 docker-ce-cli-18.09.9-3.el7</span></span><br><span class="line"></span><br><span class="line">[root@centos7 ~]<span class="comment"># docker version</span></span><br><span class="line">Client:</span><br><span class="line"> Version: 18.09.9</span><br><span class="line"> API version: 1.39</span><br><span class="line"> Go version: go1.11.13</span><br><span class="line"> Git commit: 039a7df9ba</span><br><span class="line"> Built: Wed Sep  4 16:51:21 2019</span><br><span class="line"> OS/Arch: linux/amd64</span><br><span class="line"> Experimental:  <span class="literal">false</span></span><br><span class="line">Cannot connect to the Docker daemon at unix:///var/run/docker.sock. Is the docker daemon running?</span><br><span class="line"></span><br><span class="line">[root@centos7 ~]<span class="comment"># systemctl enable --now docker</span></span><br><span class="line">[root@centos7 ~]<span class="comment"># docker version</span></span><br><span class="line">Client:</span><br><span class="line"> Version: 18.09.9</span><br><span class="line"> API version: 1.39</span><br><span class="line"> Go version: go1.11.13</span><br><span class="line"> Git commit: 039a7df9ba</span><br><span class="line"> Built: Wed Sep  4 16:51:21 2019</span><br><span class="line"> OS/Arch: linux/amd64</span><br><span class="line"> Experimental:  <span class="literal">false</span></span><br><span class="line"></span><br><span class="line">Server: Docker Engine - Community</span><br><span class="line"> Engine:</span><br><span class="line">  Version:  18.09.9</span><br><span class="line">  API version:  1.39 (minimum version 1.12)</span><br><span class="line">  Go version: go1.11.13</span><br><span class="line">  Git commit: 039a7df</span><br><span class="line">  Built: Wed Sep  4 16:22:32 2019</span><br><span class="line">  OS/Arch: linux/amd64</span><br><span class="line">  Experimental: <span class="literal">false</span></span><br></pre></td></tr></table></figure>
<p>范例: 在CentOS8安装docker</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ~]<span class="comment"># tee /etc/yum.repos.d/docker.repo &lt;&lt;EOF</span></span><br><span class="line">[docker]</span><br><span class="line">name=docker</span><br><span class="line">gpgcheck=0</span><br><span class="line">baseurl=https://mirrors.aliyun.com/docker-ce/linux/centos/8/x86_64/stable/</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">[root@centos8 ~]<span class="comment"># dnf -y install docker-ce</span></span><br></pre></td></tr></table></figure>

<h4 id="Linux-二进制安装"><a href="#Linux-二进制安装" class="headerlink" title="Linux 二进制安装"></a>Linux 二进制安装</h4><p>本方法适用于无法上网或无法通过包安装方式安装的主机上安装docker</p>
<p>安装文档: <a target="_blank" rel="noopener" href="https://docs.docker.com/install/linux/docker-ce/binaries/">https://docs.docker.com/install/linux/docker-ce/binaries/</a></p>
<p><strong>二进制安装下载路径</strong></p>
<p><a target="_blank" rel="noopener" href="https://download.docker.com/linux/">https://download.docker.com/linux/</a></p>
<p><a target="_blank" rel="noopener" href="https://mirrors.aliyun.com/docker-ce/linux/static/stable/x86_64/">https://mirrors.aliyun.com/docker-ce/linux/static/stable/x86_64/</a></p>
<p>范例: 在CentOS8上实现二进制安装docker</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ~]<span class="comment"># wget https://download.docker.com/linux/static/stable/x86_64/docker-19.03.5.tgz</span></span><br><span class="line"></span><br><span class="line">[root@centos8 ~]<span class="comment"># tar xvf docker-19.03.5.tgz</span></span><br><span class="line">docker/</span><br><span class="line">docker/docker-init</span><br><span class="line">docker/docker</span><br><span class="line">docker/dockerd</span><br><span class="line">docker/runc</span><br><span class="line">docker/ctr</span><br><span class="line">docker/docker-proxy</span><br><span class="line">docker/containerd</span><br><span class="line">docker/containerd-shim</span><br><span class="line"></span><br><span class="line">[root@centos8 ~]<span class="comment"># cp docker/* /usr/bin/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#启动dockerd服务</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># dockerd &amp;&gt;/dev/null &amp;</span></span><br><span class="line"></span><br><span class="line">[root@centos8 ~]<span class="comment"># docker version</span></span><br><span class="line">Client: Docker Engine - Community</span><br><span class="line"> Version: 19.03.5</span><br><span class="line"> API version: 1.40</span><br><span class="line"> Go version: go1.12.12</span><br><span class="line"> Git commit: 633a0ea838</span><br><span class="line"> Built: Wed Nov 13 07:22:05 2019</span><br><span class="line"> OS/Arch: linux/amd64</span><br><span class="line"> Experimental:  <span class="literal">false</span></span><br><span class="line"></span><br><span class="line">Server: Docker Engine - Community</span><br><span class="line"> Engine:</span><br><span class="line">  Version:  19.03.5</span><br><span class="line">  API version:  1.40 (minimum version 1.12)</span><br><span class="line">  Go version: go1.12.12</span><br><span class="line">  Git commit: 633a0ea838</span><br><span class="line">  Built: Wed Nov 13 07:28:45 2019</span><br><span class="line">  OS/Arch: linux/amd64</span><br><span class="line">  Experimental: <span class="literal">false</span></span><br><span class="line"> containerd:</span><br><span class="line">  Version: v1.2.10</span><br><span class="line">  GitCommit: b34a5c8af56e510852c35414db4c1f4fa6172339</span><br><span class="line"> runc:</span><br><span class="line">  Version:  1.0.0-rc8+dev</span><br><span class="line">  GitCommit: 3e425f80a8c931f88e6d94a8c831b9d5aa481657</span><br><span class="line"> docker-init:</span><br><span class="line">  Version:  0.18.0</span><br><span class="line">  GitCommit: fec3683</span><br><span class="line"></span><br><span class="line">[root@centos8 ~]<span class="comment"># docker run hello-world</span></span><br><span class="line">Unable to find image <span class="string">&#x27;hello-world:latest&#x27;</span> locally</span><br><span class="line">latest: Pulling from library/hello-world</span><br><span class="line">1b930d010525: Pull complete</span><br><span class="line">Digest: sha256:9572f7cdcee8591948c2963463447a53466950b3fc15a247fcad1917ca215a2f</span><br><span class="line">Status: Downloaded newer image <span class="keyword">for</span> hello-world:latest</span><br><span class="line"></span><br><span class="line">Hello from Docker!</span><br><span class="line">This message shows that your installation appears to be working correctly.</span><br><span class="line"></span><br><span class="line">To generate this message, Docker took the following steps:</span><br><span class="line"></span><br><span class="line">1. The Docker client contacted the Docker daemon.</span><br><span class="line">2. The Docker daemon pulled the <span class="string">&quot;hello-world&quot;</span> image from the Docker Hub.</span><br><span class="line">   (amd64)</span><br><span class="line">3. The Docker daemon created a new container from that image <span class="built_in">which</span> runs the</span><br><span class="line">   executable that produces the output you are currently reading.</span><br><span class="line">4. The Docker daemon streamed that output to the Docker client, <span class="built_in">which</span> sent it    to your terminal.</span><br><span class="line"></span><br><span class="line">To try something more ambitious, you can run an Ubuntu container with:</span><br><span class="line">$ docker run -it ubuntu bash</span><br><span class="line"></span><br><span class="line">Share images, automate workflows, and more with a free Docker ID:</span><br><span class="line">https://hub.docker.com/</span><br><span class="line"></span><br><span class="line">For more examples and ideas, visit:</span><br><span class="line">https://docs.docker.com/get-started/</span><br><span class="line"></span><br><span class="line">[root@centos8 ~]<span class="comment"># pstree -p</span></span><br><span class="line">systemd(1)─┬─NetworkManager(829)─┬─&#123;NetworkManager&#125;(846)</span><br><span class="line">           │                     └─&#123;NetworkManager&#125;(847)</span><br><span class="line">           ├─agetty(855)</span><br><span class="line">           ├─atd(854)</span><br><span class="line">           ├─auditd(792)───&#123;auditd&#125;(793)</span><br><span class="line">           ├─chronyd(838)</span><br><span class="line">           ├─containerd(2589)─┬─&#123;containerd&#125;(2590)</span><br><span class="line">           │                  ├─&#123;containerd&#125;(2591)</span><br><span class="line">           │                  ├─&#123;containerd&#125;(2592)</span><br><span class="line">           │                  ├─&#123;containerd&#125;(2593)</span><br><span class="line">           │                  ├─&#123;containerd&#125;(2594)</span><br><span class="line">           │                  ├─&#123;containerd&#125;(2595)</span><br><span class="line">           │                  ├─&#123;containerd&#125;(2596)</span><br><span class="line">           │                  ├─&#123;containerd&#125;(2597)</span><br><span class="line">           │                  └─&#123;containerd&#125;(2599)</span><br><span class="line">           ├─crond(859)</span><br><span class="line">           ├─dbus-daemon(823)</span><br><span class="line">           ├─dockerd(2600)─┬─&#123;dockerd&#125;(2601)</span><br><span class="line">           │               ├─&#123;dockerd&#125;(2602)</span><br><span class="line">           │               ├─&#123;dockerd&#125;(2603)</span><br><span class="line">           │               ├─&#123;dockerd&#125;(2604)</span><br><span class="line">           │               ├─&#123;dockerd&#125;(2605)</span><br><span class="line">           │               ├─&#123;dockerd&#125;(2606)</span><br><span class="line">           │               ├─&#123;dockerd&#125;(2607)</span><br><span class="line">           │               ├─&#123;dockerd&#125;(2608)</span><br><span class="line">           │               └─&#123;dockerd&#125;(2609)</span><br><span class="line">           ├─irqbalance(816)───&#123;irqbalance&#125;(819)</span><br><span class="line">           ├─lsmd(815)</span><br><span class="line">           ├─polkitd(1102)─┬─&#123;polkitd&#125;(1109)</span><br><span class="line">           │               ├─&#123;polkitd&#125;(1110)</span><br><span class="line">           │               ├─&#123;polkitd&#125;(1112)</span><br><span class="line">           │               ├─&#123;polkitd&#125;(1113)</span><br><span class="line">           │               ├─&#123;polkitd&#125;(1114)</span><br><span class="line">           │               ├─&#123;polkitd&#125;(1116)</span><br><span class="line">           │               └─&#123;polkitd&#125;(1122)</span><br><span class="line">           ├─smartd(837)</span><br><span class="line">           ├─sshd(850)───sshd(1125)───sshd(1137)───bash(1138)───pstree(2768)</span><br><span class="line">           ├─systemd(1129)───(sd-pam)(1131)</span><br><span class="line">           ├─systemd-journal(649)</span><br><span class="line">           ├─systemd-logind(817)</span><br><span class="line">           ├─systemd-udevd(677)</span><br><span class="line">           └─tuned(848)─┬─&#123;tuned&#125;(1101)</span><br><span class="line">                        ├─&#123;tuned&#125;(1115)</span><br><span class="line">                        └─&#123;tuned&#125;(1118)</span><br></pre></td></tr></table></figure>

<p>范例: 创建 service文件</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ~]<span class="comment"># cat &gt; /lib/systemd/system/docker.service &lt;&lt;-EOF</span></span><br><span class="line">[Unit]</span><br><span class="line">Description=Docker Application Container Engine</span><br><span class="line">Documentation=https://docs.docker.com</span><br><span class="line">After=network-online.target firewalld.service</span><br><span class="line">Wants=network-online.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">Type=notify</span><br><span class="line"><span class="comment"># the default is not to use systemd for cgroups because the delegate issues still</span></span><br><span class="line"><span class="comment"># exists and systemd currently does not support the cgroup feature set required</span></span><br><span class="line"><span class="comment"># for containers run by docker</span></span><br><span class="line">ExecStart=/usr/bin/dockerd -H unix://var/run/docker.sock</span><br><span class="line">ExecReload=/bin/kill -s HUP \<span class="variable">$MAINPID</span></span><br><span class="line"><span class="comment"># Having non-zero Limit*s causes performance problems due to accounting overhead</span></span><br><span class="line"><span class="comment"># in the kernel. We recommend using cgroups to do container-local accounting.</span></span><br><span class="line">LimitNOFILE=infinity</span><br><span class="line">LimitNPROC=infinity</span><br><span class="line">LimitCORE=infinity</span><br><span class="line"><span class="comment"># Uncomment TasksMax if your systemd version supports it.</span></span><br><span class="line"><span class="comment"># Only systemd 226 and above support this version.</span></span><br><span class="line"><span class="comment">#TasksMax=infinity</span></span><br><span class="line">TimeoutStartSec=0</span><br><span class="line"><span class="comment"># set delegate yes so that systemd does not reset the cgroups of docker</span></span><br><span class="line">containers</span><br><span class="line">Delegate=<span class="built_in">yes</span></span><br><span class="line"><span class="comment"># kill only the docker process, not all processes in the cgroup</span></span><br><span class="line">KillMode=process</span><br><span class="line"><span class="comment"># restart the docker process if it exits prematurely</span></span><br><span class="line">Restart=on-failure</span><br><span class="line">StartLimitBurst=3</span><br><span class="line">StartLimitInterval=60s</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">[root@centos8 ~]<span class="comment"># systemctl daemon-reload</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># systemctl enable --now docker</span></span><br></pre></td></tr></table></figure>
<p>范例: 创建相关的service文件,此方式新版有问题</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#创建相关的service文件,此方式新版有问题</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># groupadd -r docker</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#将Ubuntu1804或CentOS7基于包方式安装的相关文件复制到相应目录下</span></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment"># ll /lib/systemd/system/docker.*</span></span><br><span class="line">-rw-r--r-- 1 root root 1683 Jun 22 23:44 /lib/systemd/system/docker.service</span><br><span class="line">-rw-r--r-- 1 root root  197 Jun 22 23:44 /lib/systemd/system/docker.socket</span><br><span class="line"></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment"># ll /lib/systemd/system/containerd.service</span></span><br><span class="line">-rw-r--r-- 1 root root 1085 May  2  2020 /lib/systemd/system/containerd.service</span><br><span class="line"></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment"># cat /lib/systemd/system/docker.socket</span></span><br><span class="line">[Unit]</span><br><span class="line">Description=Docker Socket <span class="keyword">for</span> the API</span><br><span class="line">PartOf=docker.service</span><br><span class="line"></span><br><span class="line">[Socket]</span><br><span class="line">ListenStream=/var/run/docker.sock</span><br><span class="line">SocketMode=0660</span><br><span class="line">SocketUser=root</span><br><span class="line">SocketGroup=docker</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=sockets.target</span><br><span class="line"></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment"># cat /lib/systemd/system/docker.service</span></span><br><span class="line">[Unit]</span><br><span class="line">Description=Docker Application Container Engine</span><br><span class="line">Documentation=https://docs.docker.com</span><br><span class="line">BindsTo=containerd.service</span><br><span class="line">After=network-online.target firewalld.service containerd.service</span><br><span class="line">Wants=network-online.target</span><br><span class="line">Requires=docker.socket</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">Type=notify</span><br><span class="line"><span class="comment"># the default is not to use systemd for cgroups because the delegate issues still</span></span><br><span class="line"><span class="comment"># exists and systemd currently does not support the cgroup feature set required</span></span><br><span class="line"><span class="comment">#for containers run by docker</span></span><br><span class="line"></span><br><span class="line">ExecStart=/usr/bin/dockerd -H fd:// --containerd=/run/containerd/containerd.sock</span><br><span class="line">ExecReload=/bin/kill -s HUP <span class="variable">$MAINPID</span></span><br><span class="line">TimeoutSec=0</span><br><span class="line">RestartSec=2</span><br><span class="line">Restart=always</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Note that StartLimit* options were moved from &quot;Service&quot; to &quot;Unit&quot; in systemd 229.</span></span><br><span class="line"><span class="comment"># Both the old, and new location are accepted by systemd 229 and up, so using the old location</span></span><br><span class="line"><span class="comment"># to make them work for either version of systemd.</span></span><br><span class="line">StartLimitBurst=3</span><br><span class="line"></span><br><span class="line"><span class="comment"># Note that StartLimitInterval was renamed to StartLimitIntervalSec in systemd 230.</span></span><br><span class="line"><span class="comment"># Both the old, and new name are accepted by systemd 230 and up, so using the old name to make</span></span><br><span class="line"><span class="comment"># this option work for either version of systemd.</span></span><br><span class="line">StartLimitInterval=60s</span><br><span class="line"></span><br><span class="line"><span class="comment"># Having non-zero Limit*s causes performance problems due to accounting overhead</span></span><br><span class="line"><span class="comment"># in the kernel. We recommend using cgroups to do container-local accounting.</span></span><br><span class="line">LimitNOFILE=infinity</span><br><span class="line">LimitNPROC=infinity</span><br><span class="line">LimitCORE=infinity</span><br><span class="line"></span><br><span class="line"><span class="comment"># Comment TasksMax if your systemd version does not support it.</span></span><br><span class="line"><span class="comment"># Only systemd 226 and above support this option.</span></span><br><span class="line">TasksMax=infinity</span><br><span class="line"></span><br><span class="line"><span class="comment"># set delegate yes so that systemd does not reset the cgroups of docker containers</span></span><br><span class="line">Delegate=<span class="built_in">yes</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># kill only the docker process, not all processes in the cgroup</span></span><br><span class="line">KillMode=process</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line"></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment"># cat /lib/systemd/system/containerd.service</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#   Copyright 2018-2020 Docker Inc.</span></span><br><span class="line"><span class="comment">#   Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span></span><br><span class="line"><span class="comment">#   you may not use this file except in compliance with the License.</span></span><br><span class="line"><span class="comment">#   You may obtain a copy of the License at</span></span><br><span class="line"><span class="comment">#       http://www.apache.org/licenses/LICENSE-2.0</span></span><br><span class="line"><span class="comment">#   Unless required by applicable law or agreed to in writing, software</span></span><br><span class="line"><span class="comment">#   distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span></span><br><span class="line"><span class="comment">#   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span></span><br><span class="line"><span class="comment">#   See the License for the specific language governing permissions and</span></span><br><span class="line"><span class="comment">#   limitations under the License.</span></span><br><span class="line"></span><br><span class="line">[Unit]</span><br><span class="line">Description=containerd container runtime</span><br><span class="line">Documentation=https://containerd.io</span><br><span class="line">After=network.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">ExecStartPre=-/sbin/modprobe overlay</span><br><span class="line">ExecStart=/usr/bin/containerd</span><br><span class="line">KillMode=process</span><br><span class="line">Delegate=<span class="built_in">yes</span></span><br><span class="line">LimitNOFILE=1048576</span><br><span class="line"><span class="comment"># Having non-zero Limit*s causes performance problems due to accounting overhead</span></span><br><span class="line"><span class="comment"># in the kernel. We recommend using cgroups to do container-local accounting.</span></span><br><span class="line">LimitNPROC=infinity</span><br><span class="line">LimitCORE=infinity</span><br><span class="line">TasksMax=infinity</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line"></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment"># scp /lib/systemd/system/docker.* /lib/systemd/system/containerd.service 10.0.0.8:/lib/systemd/system/</span></span><br><span class="line"></span><br><span class="line">[root@centos8 ~]<span class="comment"># systemctl daemon-reload</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># systemctl enable --now docker</span></span><br></pre></td></tr></table></figure>

<p>范例： 一键离线安装二进制 docker</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line">DOCKER_VERSION=20.10.10</span><br><span class="line">URL=https://mirrors.aliyun.com</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">prepare</span></span> () &#123;</span><br><span class="line"> <span class="keyword">if</span> [! -e docker-<span class="variable">$&#123;DOCKER_VERSION&#125;</span>.tgz ];<span class="keyword">then</span></span><br><span class="line">         wget <span class="variable">$&#123;URL&#125;</span>/docker-ce/linux/static/stable/x86_64/docker-<span class="variable">$&#123;DOCKER_VERSION&#125;</span>.tgz</span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line">   [ $? -ne 0 ] &amp;&amp; &#123; <span class="built_in">echo</span> <span class="string">&quot;文件下载失败&quot;</span>; <span class="built_in">exit</span>; &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">install_docker</span></span> () &#123;</span><br><span class="line">    tar xf docker-<span class="variable">$&#123;DOCKER_VERSION&#125;</span>.tgz -C /usr/local/</span><br><span class="line">    <span class="built_in">cp</span> /usr/local/docker/* /usr/bin/</span><br><span class="line">    <span class="built_in">cat</span> &gt; /lib/systemd/system/docker.service &lt;&lt;-<span class="string">EOF</span></span><br><span class="line"><span class="string">[Unit]</span></span><br><span class="line"><span class="string">Description=Docker Application Container Engine</span></span><br><span class="line"><span class="string">Documentation=https://docs.docker.com</span></span><br><span class="line"><span class="string">After=network-online.target firewalld.service</span></span><br><span class="line"><span class="string">Wants=network-online.target</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">[Service]</span></span><br><span class="line"><span class="string">Type=notify</span></span><br><span class="line"><span class="string"># the default is not to use systemd for cgroups because the delegate issues still</span></span><br><span class="line"><span class="string"># exists and systemd currently does not support the cgroup feature set required</span></span><br><span class="line"><span class="string"># for containers run by docker</span></span><br><span class="line"><span class="string">ExecStart=/usr/bin/dockerd -H unix://var/run/docker.sock</span></span><br><span class="line"><span class="string">ExecReload=/bin/kill -s HUP \$MAINPID</span></span><br><span class="line"><span class="string"># Having non-zero Limit*s causes performance problems due to accounting overhead</span></span><br><span class="line"><span class="string"># in the kernel. We recommend using cgroups to do container-local accounting.</span></span><br><span class="line"><span class="string">LimitNOFILE=infinity</span></span><br><span class="line"><span class="string">LimitNPROC=infinity</span></span><br><span class="line"><span class="string">LimitCORE=infinity</span></span><br><span class="line"><span class="string"># Uncomment TasksMax if your systemd version supports it.</span></span><br><span class="line"><span class="string"># Only systemd 226 and above support this version.</span></span><br><span class="line"><span class="string">#TasksMax=infinity</span></span><br><span class="line"><span class="string">TimeoutStartSec=0</span></span><br><span class="line"><span class="string"># set delegate yes so that systemd does not reset the cgroups of docker containers</span></span><br><span class="line"><span class="string">Delegate=yes</span></span><br><span class="line"><span class="string"># kill only the docker process, not all processes in the cgroup</span></span><br><span class="line"><span class="string">KillMode=process</span></span><br><span class="line"><span class="string"># restart the docker process if it exits prematurely</span></span><br><span class="line"><span class="string">Restart=on-failure</span></span><br><span class="line"><span class="string">StartLimitBurst=3</span></span><br><span class="line"><span class="string">StartLimitInterval=60s</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">[Install]</span></span><br><span class="line"><span class="string">WantedBy=multi-user.target</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line">   systemctl daemon-reload</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="title">start_docker</span></span> ()&#123;</span><br><span class="line">   systemctl <span class="built_in">enable</span> --now docker</span><br><span class="line">   docker version</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">prepare</span><br><span class="line">install_docker</span><br><span class="line">start_docker</span><br></pre></td></tr></table></figure>

<h4 id="安装-podman"><a href="#安装-podman" class="headerlink" title="安装 podman"></a>安装 podman</h4><p>范例: 在CentOS8上安装podman</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#在CentOS8上安装docker会自动安装podman,docker工具只是一个脚本，调用了Podman</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># dnf install docker</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># rpm -ql podman-docker</span></span><br><span class="line">/usr/bin/docker</span><br><span class="line"></span><br><span class="line">[root@centos8 ~]<span class="comment"># cat /usr/bin/docker</span></span><br><span class="line"><span class="comment">#!/bin/sh</span></span><br><span class="line">[ -f /etc/containers/nodocker ] || \</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;Emulate Docker CLI using podman. Create /etc/containers/nodocker to quiet msg.&quot;</span> &gt;&amp;2</span><br><span class="line"><span class="built_in">exec</span> /usr/bin/podman <span class="string">&quot;<span class="variable">$@</span>&quot;</span></span><br><span class="line"></span><br><span class="line">[root@centos8 ~]<span class="comment"># podman version</span></span><br><span class="line">Version:  1.4.2-stable2</span><br><span class="line">RemoteAPI Version: 1</span><br><span class="line">Go Version: go1.12.8</span><br><span class="line">OS/Arch: linux/amd64</span><br><span class="line"></span><br><span class="line"><span class="comment">#修改拉取镜像的地址的顺序，提高速度</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># vim /etc/containers/registries.conf</span></span><br><span class="line">[registries.search]</span><br><span class="line">registries = [<span class="string">&#x27;docker.io&#x27;</span>，<span class="string">&#x27;quay.io&#x27;</span>，<span class="string">&#x27;registry.redhat.io&#x27;</span>,<span class="string">&#x27;registry.access.redhat.com&#x27;</span>]</span><br></pre></td></tr></table></figure>

<h4 id="在不同系统上实现一键安装-docker-脚本"><a href="#在不同系统上实现一键安装-docker-脚本" class="headerlink" title="在不同系统上实现一键安装 docker 脚本"></a>在不同系统上实现一键安装 docker 脚本</h4><h5 id="基于-ubuntu-18-04和20-04-的-一键安装-docker-脚本"><a href="#基于-ubuntu-18-04和20-04-的-一键安装-docker-脚本" class="headerlink" title="基于 ubuntu 18.04和20.04 的 一键安装 docker 脚本"></a>基于 ubuntu 18.04和20.04 的 一键安装 docker 脚本</h5><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">[root@ubuntu1804 ~]<span class="comment"># cat install_docker_ubuntu.sh</span></span><br><span class="line"><span class="comment">#!/bin/bash</span></span><br><span class="line"><span class="comment">#Description: Install docker on Ubuntu18.04 and 20.04</span></span><br><span class="line"><span class="comment">#Version:1.0</span></span><br><span class="line"><span class="comment">#Date:2020-01-22</span></span><br><span class="line"></span><br><span class="line">COLOR=<span class="string">&quot;echo -e \\033[1;31m&quot;</span></span><br><span class="line">END=<span class="string">&quot;\033[m&quot;</span></span><br><span class="line">DOCKER_VERSION=<span class="string">&quot;5:19.03.5~3-0~ubuntu-bionic&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">install_docker</span></span>()&#123;</span><br><span class="line">dpkg -s docker-ce &amp;&gt; /dev/null &amp;&amp; <span class="variable">$&#123;COLOR&#125;</span><span class="string">&quot;Docker已安装，退出&quot;</span><span class="variable">$&#123;END&#125;</span> &amp;&amp; <span class="built_in">exit</span></span><br><span class="line">apt update</span><br><span class="line">apt  -y install apt-transport-https ca-certificates curl software-properties-common</span><br><span class="line"></span><br><span class="line"><span class="comment">#curl -fsSL https://mirrors.aliyun.com/docker-ce/linux/ubuntu/gpg | sudo apt-keyadd -</span></span><br><span class="line"><span class="comment">#add-apt-repository &quot;deb [arch=amd64] https://mirrors.aliyun.com/docker-ce/linux/ubuntu $(lsb_release -cs) stable&quot;</span></span><br><span class="line"></span><br><span class="line">curl -fsSL https://mirrors.tuna.tsinghua.edu.cn/docker-ce/linux/ubuntu/gpg | sudo apt-key add -</span><br><span class="line">add-apt-repository <span class="string">&quot;deb [arch=amd64]</span></span><br><span class="line"><span class="string">https://mirrors.tuna.tsinghua.edu.cn/docker-ce/linux/ubuntu <span class="subst">$(lsb_release -cs)</span>stable&quot;</span></span><br><span class="line"></span><br><span class="line">apt update</span><br><span class="line"><span class="variable">$&#123;COLOR&#125;</span><span class="string">&quot;Docker有以下版本&quot;</span><span class="variable">$&#123;END&#125;</span></span><br><span class="line">apt-cache madison docker-ce</span><br><span class="line"><span class="variable">$&#123;COLOR&#125;</span><span class="string">&quot;5秒后即将安装: docker-&quot;</span><span class="variable">$&#123;DOCKER_VERSION&#125;</span><span class="string">&quot; 版本.....&quot;</span><span class="variable">$&#123;END&#125;</span></span><br><span class="line"><span class="variable">$&#123;COLOR&#125;</span><span class="string">&quot;如果想安装其它Docker版本，请按ctrl+c键退出，修改版本再执行&quot;</span><span class="variable">$&#123;END&#125;</span></span><br><span class="line"><span class="built_in">sleep</span> 5</span><br><span class="line"></span><br><span class="line">apt -y install docker-ce=<span class="variable">$&#123;DOCKER_VERSION&#125;</span> docker-ce-cli=<span class="variable">$&#123;DOCKER_VERSION&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">mkdir</span> -p /etc/docker</span><br><span class="line"><span class="built_in">tee</span> /etc/docker/daemon.json &lt;&lt;-<span class="string">&#x27;EOF&#x27;</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;registry-mirrors&quot;</span>: [<span class="string">&quot;https://si7y70hh.mirror.aliyuncs.com&quot;</span>]</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">systemctl daemon-reload</span><br><span class="line">systemctl <span class="built_in">enable</span> --now docker</span><br><span class="line">docker version &amp;&amp; <span class="variable">$&#123;COLOR&#125;</span><span class="string">&quot;Docker 安装成功&quot;</span><span class="variable">$&#123;END&#125;</span> ||  <span class="variable">$&#123;COLOR&#125;</span><span class="string">&quot;Docker 安装失败&quot;</span> <span class="variable">$&#123;END&#125;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">install_docker</span><br></pre></td></tr></table></figure>

<h5 id="基于-CentOS-8-实现一键安装-docker-脚本"><a href="#基于-CentOS-8-实现一键安装-docker-脚本" class="headerlink" title="基于 CentOS 8 实现一键安装 docker 脚本"></a>基于 CentOS 8 实现一键安装 docker 脚本</h5><h6 id="脚本-1"><a href="#脚本-1" class="headerlink" title="脚本 1"></a>脚本 1</h6><p>利用阿里云的基于CentOS8的docker yum源实现</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line">. /etc/init.d/functions</span><br><span class="line">COLOR=<span class="string">&quot;echo -e \\E[1;32m&quot;</span></span><br><span class="line">END=<span class="string">&quot;\\E[0m&quot;</span></span><br><span class="line">DOCKER_VERSION=<span class="string">&quot;-19.03.13-3.el8&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">install_docker</span></span>() &#123;</span><br><span class="line">  rpm -q docker-ce &amp;&gt; /dev/null &amp;&amp; action <span class="string">&quot;Docker已安装&quot;</span> &amp;&amp; <span class="built_in">exit</span></span><br><span class="line">  <span class="variable">$&#123;COLOR&#125;</span><span class="string">&quot;开始安装 Docker.....&quot;</span><span class="variable">$&#123;END&#125;</span></span><br><span class="line">  <span class="built_in">sleep</span> 1</span><br><span class="line">  <span class="built_in">cat</span> &gt; /etc/yum.repos.d/docker.repo &lt;&lt;<span class="string">EOF</span></span><br><span class="line"><span class="string">[docker]</span></span><br><span class="line"><span class="string">name=docker</span></span><br><span class="line"><span class="string">gpgcheck=0</span></span><br><span class="line"><span class="string">baseurl=https://mirrors.tuna.tsinghua.edu.cn/docker-ce/linux/centos/8/x86_64/stable/</span></span><br><span class="line"><span class="string">#baseurl=https://mirrors.aliyun.com/docker-ce/linux/centos/8/x86_64/stable/</span></span><br><span class="line"><span class="string">#EOF</span></span><br><span class="line"></span><br><span class="line">  yum clean all</span><br><span class="line">  yum -y install docker-ce<span class="variable">$DOCKER_VERSION</span> docker-ce-cli<span class="variable">$DOCKER_VERSION</span> \</span><br><span class="line">    || &#123; <span class="variable">$&#123;COLOR&#125;</span><span class="string">&quot;Base,Extras的yum源失败,请检查yum源配置&quot;</span><span class="variable">$&#123;END&#125;</span>;<span class="built_in">exit</span>; &#125;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">mkdir</span> -p /etc/docker</span><br><span class="line">  <span class="built_in">cat</span> &gt; /etc/docker/daemon.json &lt;&lt;<span class="string">EOF</span></span><br><span class="line"><span class="string"> &#123;</span></span><br><span class="line"><span class="string">   &quot;registry-mirrors&quot;: [&quot;https://si7y70hh.mirror.aliyuncs.com&quot;]</span></span><br><span class="line"><span class="string"> &#125;</span></span><br><span class="line"><span class="string"> EOF</span></span><br><span class="line"></span><br><span class="line">  systemctl <span class="built_in">enable</span> --now docker</span><br><span class="line">  docker version &amp;&amp; <span class="variable">$&#123;COLOR&#125;</span><span class="string">&quot;Docker安装成功&quot;</span><span class="variable">$&#123;END&#125;</span> || <span class="variable">$&#123;COLOR&#125;</span><span class="string">&quot;Docker安装失败&quot;</span> <span class="variable">$&#123;END&#125;</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">install_docker</span><br></pre></td></tr></table></figure>

<h6 id="脚本-2"><a href="#脚本-2" class="headerlink" title="脚本 2"></a>脚本 2</h6><p>早期CentOS8无yum仓库,可以利用下面脚本安装docker</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line">. /etc/init.d/functions</span><br><span class="line">COLOR=<span class="string">&quot;echo -e \\E[1;32m&quot;</span></span><br><span class="line">END=<span class="string">&quot;\\E[0m&quot;</span></span><br><span class="line">DOCKER_VERSION=<span class="string">&quot;-19.03.8-3.el7&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">install_docker</span></span>() &#123;</span><br><span class="line"></span><br><span class="line">  <span class="variable">$&#123;COLOR&#125;</span><span class="string">&quot;开始安装 Docker.....&quot;</span><span class="variable">$&#123;END&#125;</span></span><br><span class="line">  <span class="built_in">sleep</span> 1</span><br><span class="line"></span><br><span class="line">  <span class="comment">#wget -P /etc/yum.repos.d/ https://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo || &#123; $&#123;COLOR&#125;&quot;互联网连接失败，请检查网络配置!&quot;$&#123;END&#125;;exit; &#125;</span></span><br><span class="line">  wget -P /etc/yum.repos.d/ https://mirrors.tuna.tsinghua.edu.cn/docker-ce/linux/centos/docker-ce.repo || &#123; <span class="variable">$&#123;COLOR&#125;</span><span class="string">&quot;互联网连接失败，请检查网络配置!&quot;</span> <span class="variable">$&#123;END&#125;</span>;<span class="built_in">exit</span>; &#125;</span><br><span class="line">  yum clean all</span><br><span class="line"></span><br><span class="line">  dnf -y install https://mirrors.aliyun.com/docker-ce/linux/centos/7/x86_64/stable/Packages/containerd.io-1.2.13-3.1.el7.x86_64.rpm</span><br><span class="line">  yum -y install docker-ce<span class="variable">$DOCKER_VERSION</span> docker-ce-cli<span class="variable">$DOCKER_VERSION</span> \</span><br><span class="line">    || &#123; <span class="variable">$&#123;COLOR&#125;</span><span class="string">&quot;Base,Extras的yum源失败,请检查yum源配置&quot;</span><span class="variable">$&#123;END&#125;</span>;<span class="built_in">exit</span>; &#125;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">mkdir</span> -p /etc/docker</span><br><span class="line">  <span class="built_in">cat</span> &gt; /etc/docker/daemon.json &lt;&lt;<span class="string">EOF</span></span><br><span class="line"><span class="string"> &#123;</span></span><br><span class="line"><span class="string">   &quot;registry-mirrors&quot;: [&quot;https://si7y70hh.mirror.aliyuncs.com&quot;]</span></span><br><span class="line"><span class="string"> &#125;</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"></span><br><span class="line">  systemctl <span class="built_in">enable</span> --now docker</span><br><span class="line">  docker version &amp;&amp; <span class="variable">$&#123;COLOR&#125;</span><span class="string">&quot;Docker安装成功&quot;</span><span class="variable">$&#123;END&#125;</span> || <span class="variable">$&#123;COLOR&#125;</span><span class="string">&quot;Docker安装失败&quot;</span> <span class="variable">$&#123;END&#125;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">rpm -q docker &amp;&gt; /dev/null &amp;&amp; action <span class="string">&quot;Docker已安装&quot;</span> || install_docker</span><br></pre></td></tr></table></figure>

<h5 id="基于-CentOS-7-实现一键安装docker-脚本"><a href="#基于-CentOS-7-实现一键安装docker-脚本" class="headerlink" title="基于 CentOS 7 实现一键安装docker 脚本"></a>基于 CentOS 7 实现一键安装docker 脚本</h5><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">[root@centos7 ~]<span class="comment">#cat install_docker_for_centos7.sh</span></span><br><span class="line"><span class="comment">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line">. /etc/init.d/functions</span><br><span class="line">COLOR=<span class="string">&quot;echo -e \\033[1;31m&quot;</span></span><br><span class="line">END=<span class="string">&quot;\033[m&quot;</span></span><br><span class="line">VERSION=<span class="string">&quot;19.03.5-3.el7&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">rpm -q docker-ce &amp;&gt; /dev/null &amp;&amp; action <span class="string">&quot;Docker已安装&quot;</span> &amp;&amp; <span class="built_in">exit</span></span><br><span class="line"></span><br><span class="line">wget -P /etc/yum.repos.d/ https://mirrors.tuna.tsinghua.edu.cn/docker-ce/linux/centos/docker-ce.repo || &#123; <span class="variable">$&#123;COLOR&#125;</span><span class="string">&quot;互联网连接失败，请检查网络配置!&quot;</span> <span class="variable">$&#123;END&#125;</span>;<span class="built_in">exit</span>; &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">#wget -P /etc/yum.repos.d/ https://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo || &#123; $&#123;COLOR&#125;&quot;互联网连接失败，请检查网络配置!&quot;$&#123;END&#125;;exit; &#125;</span></span><br><span class="line"></span><br><span class="line">yum clean all</span><br><span class="line">yum -y install docker-ce-<span class="variable">$VERSION</span> docker-ce-cli-<span class="variable">$VERSION</span> || &#123;<span class="variable">$&#123;COLOR&#125;</span><span class="string">&quot;Base,Extras的yum源失败,请检查yum源配置&quot;</span><span class="variable">$&#123;END&#125;</span>;<span class="built_in">exit</span>; &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">#使用阿里做镜像加速</span></span><br><span class="line"><span class="built_in">mkdir</span> -p /etc/docker</span><br><span class="line"><span class="built_in">cat</span> &gt; /etc/docker/daemon.json &lt;&lt;<span class="string">EOF</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">  &quot;registry-mirrors&quot;: [&quot;https://si7y70hh.mirror.aliyuncs.com&quot;]</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"></span><br><span class="line">systemctl <span class="built_in">enable</span> --now docker</span><br><span class="line">docker version &amp;&amp; <span class="variable">$&#123;COLOR&#125;</span><span class="string">&quot;Docker安装成功&quot;</span><span class="variable">$&#123;END&#125;</span> || <span class="variable">$&#123;COLOR&#125;</span><span class="string">&quot;Docker安装失败&quot;</span><span class="variable">$&#123;END&#125;</span></span><br></pre></td></tr></table></figure>

<h5 id="通用安装Docker脚本"><a href="#通用安装Docker脚本" class="headerlink" title="通用安装Docker脚本"></a>通用安装Docker脚本</h5><p>从Docker官方下载通用安装脚本</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@ubuntu1804 ~]<span class="comment"># curl -fsSL get.docker.com -o get-docker.sh</span></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment"># sh get-docker.sh --mirror Aliyun</span></span><br></pre></td></tr></table></figure>

<h3 id="Docker-程序环境"><a href="#Docker-程序环境" class="headerlink" title="Docker 程序环境"></a>Docker 程序环境</h3><p>环境配置文件:</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">/etc/sysconfig/docker-network</span><br><span class="line">/etc/sysconfig/docker-storage</span><br><span class="line">/etc/sysconfig/docker</span><br></pre></td></tr></table></figure>

<p>Unit File:</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/usr/lib/systemd/system/docker.service</span><br></pre></td></tr></table></figure>

<p>docker-ce 配置文件:</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/etc/docker/daemon.json</span><br></pre></td></tr></table></figure>

<p>Docker Registry配置文件:</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/etc/containers/registries.conf</span><br></pre></td></tr></table></figure>

<p>范例: ubuntu 查看docker相关文件</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">##服务器端相关文件</span></span><br><span class="line"></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment"># dpkg -L docker-ce</span></span><br><span class="line">/.</span><br><span class="line">/etc</span><br><span class="line">/etc/default</span><br><span class="line">/etc/default/docker</span><br><span class="line">/etc/init</span><br><span class="line">/etc/init/docker.conf</span><br><span class="line">/etc/init.d</span><br><span class="line">/etc/init.d/docker</span><br><span class="line">/lib</span><br><span class="line">/lib/systemd</span><br><span class="line">/lib/systemd/system</span><br><span class="line">/lib/systemd/system/docker.service</span><br><span class="line">/lib/systemd/system/docker.socket</span><br><span class="line">/usr</span><br><span class="line">/usr/bin</span><br><span class="line">/usr/bin/docker-init</span><br><span class="line">/usr/bin/docker-proxy</span><br><span class="line">/usr/bin/dockerd</span><br><span class="line">/usr/share</span><br><span class="line">/usr/share/doc</span><br><span class="line">/usr/share/doc/docker-ce</span><br><span class="line">/usr/share/doc/docker-ce/README.md</span><br><span class="line">/usr/share/doc/docker-ce/changelog.Debian.gz</span><br><span class="line">/var</span><br><span class="line">/var/lib</span><br><span class="line">/var/lib/docker-engine</span><br><span class="line">/var/lib/docker-engine/distribution_based_engine.json</span><br><span class="line"></span><br><span class="line"><span class="comment">##客户端相关文件</span></span><br><span class="line"></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment"># dpkg -L docker-ce-cli</span></span><br><span class="line">/.</span><br><span class="line">/usr</span><br><span class="line">/usr/bin</span><br><span class="line">/usr/bin/docker</span><br><span class="line">/usr/libexec</span><br><span class="line">/usr/libexec/docker</span><br><span class="line">/usr/libexec/docker/cli-plugins</span><br><span class="line">/usr/libexec/docker/cli-plugins/docker-app</span><br><span class="line">/usr/libexec/docker/cli-plugins/docker-buildx</span><br><span class="line">/usr/share</span><br><span class="line">/usr/share/bash-completion</span><br><span class="line">/usr/share/bash-completion/completions</span><br><span class="line">/usr/share/bash-completion/completions/docker</span><br><span class="line">/usr/share/doc</span><br><span class="line">/usr/share/doc/docker-ce-cli</span><br><span class="line">/usr/share/doc/docker-ce-cli/changelog.Debian.gz</span><br><span class="line">/usr/share/fish</span><br><span class="line">/usr/share/fish/vendor_completions.d</span><br><span class="line">/usr/share/fish/vendor_completions.d/docker.fish</span><br><span class="line">/usr/share/man</span><br><span class="line">/usr/share/man/man1</span><br><span class="line">/usr/share/man/man1/docker-attach.1.gz</span><br><span class="line">/usr/share/man/man1/docker-build.1.gz</span><br><span class="line">/usr/share/man/man1/docker-builder-build.1.gz</span><br><span class="line">/usr/share/man/man1/docker-builder-prune.1.gz</span><br><span class="line">/usr/share/man/man1/docker-builder.1.gz</span><br><span class="line">/usr/share/man/man1/docker-checkpoint-create.1.gz</span><br><span class="line">/usr/share/man/man1/docker-checkpoint-ls.1.gz</span><br><span class="line">/usr/share/man/man1/docker-checkpoint-rm.1.gz</span><br><span class="line">/usr/share/man/man1/docker-checkpoint.1.gz</span><br><span class="line">/usr/share/man/man1/docker-commit.1.gz</span><br><span class="line">/usr/share/man/man1/docker-config-create.1.gz</span><br><span class="line">/usr/share/man/man1/docker-config-inspect.1.gz</span><br><span class="line">/usr/share/man/man1/docker-config-ls.1.gz</span><br><span class="line">/usr/share/man/man1/docker-config-rm.1.gz</span><br><span class="line">/usr/share/man/man1/docker-config.1.gz</span><br><span class="line">/usr/share/man/man1/docker-container-attach.1.gz</span><br><span class="line">/usr/share/man/man1/docker-container-commit.1.gz</span><br><span class="line">/usr/share/man/man1/docker-container-cp.1.gz</span><br><span class="line">/usr/share/man/man1/docker-container-create.1.gz</span><br><span class="line">/usr/share/man/man1/docker-container-diff.1.gz</span><br><span class="line">/usr/share/man/man1/docker-container-exec.1.gz</span><br><span class="line">/usr/share/man/man1/docker-container-export.1.gz</span><br><span class="line">/usr/share/man/man1/docker-container-inspect.1.gz</span><br><span class="line">/usr/share/man/man1/docker-container-kill.1.gz</span><br><span class="line">/usr/share/man/man1/docker-container-logs.1.gz</span><br><span class="line">/usr/share/man/man1/docker-container-ls.1.gz</span><br><span class="line">/usr/share/man/man1/docker-container-pause.1.gz</span><br><span class="line">/usr/share/man/man1/docker-container-port.1.gz</span><br><span class="line">/usr/share/man/man1/docker-container-prune.1.gz</span><br><span class="line">/usr/share/man/man1/docker-container-rename.1.gz</span><br><span class="line">/usr/share/man/man1/docker-container-restart.1.gz</span><br><span class="line">/usr/share/man/man1/docker-container-rm.1.gz</span><br><span class="line">/usr/share/man/man1/docker-container-run.1.gz</span><br><span class="line">/usr/share/man/man1/docker-container-start.1.gz</span><br><span class="line">/usr/share/man/man1/docker-container-stats.1.gz</span><br><span class="line">/usr/share/man/man1/docker-container-stop.1.gz</span><br><span class="line">/usr/share/man/man1/docker-container-top.1.gz</span><br><span class="line">/usr/share/man/man1/docker-container-unpause.1.gz</span><br><span class="line">/usr/share/man/man1/docker-container-update.1.gz</span><br><span class="line">/usr/share/man/man1/docker-container-wait.1.gz</span><br><span class="line">/usr/share/man/man1/docker-container.1.gz</span><br><span class="line">/usr/share/man/man1/docker-context-create.1.gz</span><br><span class="line">/usr/share/man/man1/docker-context-export.1.gz</span><br><span class="line">/usr/share/man/man1/docker-context-import.1.gz</span><br><span class="line">/usr/share/man/man1/docker-context-inspect.1.gz</span><br><span class="line">/usr/share/man/man1/docker-context-ls.1.gz</span><br><span class="line">/usr/share/man/man1/docker-context-rm.1.gz</span><br><span class="line">/usr/share/man/man1/docker-context-update.1.gz</span><br><span class="line">/usr/share/man/man1/docker-context-use.1.gz</span><br><span class="line">/usr/share/man/man1/docker-context.1.gz</span><br><span class="line">/usr/share/man/man1/docker-cp.1.gz</span><br><span class="line">/usr/share/man/man1/docker-create.1.gz</span><br><span class="line">/usr/share/man/man1/docker-deploy.1.gz</span><br><span class="line">/usr/share/man/man1/docker-diff.1.gz</span><br><span class="line">/usr/share/man/man1/docker-engine-activate.1.gz</span><br><span class="line">/usr/share/man/man1/docker-engine-check.1.gz</span><br><span class="line">/usr/share/man/man1/docker-engine-update.1.gz</span><br><span class="line">/usr/share/man/man1/docker-engine.1.gz</span><br><span class="line">/usr/share/man/man1/docker-events.1.gz</span><br><span class="line">/usr/share/man/man1/docker-exec.1.gz</span><br><span class="line">/usr/share/man/man1/docker-export.1.gz</span><br><span class="line">/usr/share/man/man1/docker-history.1.gz</span><br><span class="line">/usr/share/man/man1/docker-image-build.1.gz</span><br><span class="line">/usr/share/man/man1/docker-image-history.1.gz</span><br><span class="line">/usr/share/man/man1/docker-image-import.1.gz</span><br><span class="line">/usr/share/man/man1/docker-image-inspect.1.gz</span><br><span class="line">/usr/share/man/man1/docker-image-load.1.gz</span><br><span class="line">/usr/share/man/man1/docker-image-ls.1.gz</span><br><span class="line">/usr/share/man/man1/docker-image-prune.1.gz</span><br><span class="line">/usr/share/man/man1/docker-image-pull.1.gz</span><br><span class="line">/usr/share/man/man1/docker-image-push.1.gz</span><br><span class="line">/usr/share/man/man1/docker-image-rm.1.gz</span><br><span class="line">/usr/share/man/man1/docker-image-save.1.gz</span><br><span class="line">/usr/share/man/man1/docker-image-tag.1.gz</span><br><span class="line">/usr/share/man/man1/docker-image.1.gz</span><br><span class="line">/usr/share/man/man1/docker-images.1.gz</span><br><span class="line">/usr/share/man/man1/docker-import.1.gz</span><br><span class="line">/usr/share/man/man1/docker-info.1.gz</span><br><span class="line">/usr/share/man/man1/docker-inspect.1.gz</span><br><span class="line">/usr/share/man/man1/docker-kill.1.gz</span><br><span class="line">/usr/share/man/man1/docker-load.1.gz</span><br><span class="line">/usr/share/man/man1/docker-login.1.gz</span><br><span class="line">/usr/share/man/man1/docker-logout.1.gz</span><br><span class="line">/usr/share/man/man1/docker-logs.1.gz</span><br><span class="line">/usr/share/man/man1/docker-manifest-annotate.1.gz</span><br><span class="line">/usr/share/man/man1/docker-manifest-create.1.gz</span><br><span class="line">/usr/share/man/man1/docker-manifest-inspect.1.gz</span><br><span class="line">/usr/share/man/man1/docker-manifest-push.1.gz</span><br><span class="line">/usr/share/man/man1/docker-manifest.1.gz</span><br><span class="line">/usr/share/man/man1/docker-network-connect.1.gz</span><br><span class="line">/usr/share/man/man1/docker-network-create.1.gz</span><br><span class="line">/usr/share/man/man1/docker-network-disconnect.1.gz</span><br><span class="line">/usr/share/man/man1/docker-network-inspect.1.gz</span><br><span class="line">/usr/share/man/man1/docker-network-ls.1.gz</span><br><span class="line">/usr/share/man/man1/docker-network-prune.1.gz</span><br><span class="line">/usr/share/man/man1/docker-network-rm.1.gz</span><br><span class="line">/usr/share/man/man1/docker-network.1.gz</span><br><span class="line">/usr/share/man/man1/docker-node-demote.1.gz</span><br><span class="line">/usr/share/man/man1/docker-node-inspect.1.gz</span><br><span class="line">/usr/share/man/man1/docker-node-ls.1.gz</span><br><span class="line">/usr/share/man/man1/docker-node-promote.1.gz</span><br><span class="line">/usr/share/man/man1/docker-node-ps.1.gz</span><br><span class="line">/usr/share/man/man1/docker-node-rm.1.gz</span><br><span class="line">/usr/share/man/man1/docker-node-update.1.gz</span><br><span class="line">/usr/share/man/man1/docker-node.1.gz</span><br><span class="line">/usr/share/man/man1/docker-pause.1.gz</span><br><span class="line">/usr/share/man/man1/docker-plugin-create.1.gz</span><br><span class="line">/usr/share/man/man1/docker-plugin-disable.1.gz</span><br><span class="line">/usr/share/man/man1/docker-plugin-enable.1.gz</span><br><span class="line">/usr/share/man/man1/docker-plugin-inspect.1.gz</span><br><span class="line">/usr/share/man/man1/docker-plugin-install.1.gz</span><br><span class="line">/usr/share/man/man1/docker-plugin-ls.1.gz</span><br><span class="line">/usr/share/man/man1/docker-plugin-push.1.gz</span><br><span class="line">/usr/share/man/man1/docker-plugin-rm.1.gz</span><br><span class="line">/usr/share/man/man1/docker-plugin-set.1.gz</span><br><span class="line">/usr/share/man/man1/docker-plugin-upgrade.1.gz</span><br><span class="line">/usr/share/man/man1/docker-plugin.1.gz</span><br><span class="line">/usr/share/man/man1/docker-port.1.gz</span><br><span class="line">/usr/share/man/man1/docker-ps.1.gz</span><br><span class="line">/usr/share/man/man1/docker-pull.1.gz</span><br><span class="line">/usr/share/man/man1/docker-push.1.gz</span><br><span class="line">/usr/share/man/man1/docker-rename.1.gz</span><br><span class="line">/usr/share/man/man1/docker-restart.1.gz</span><br><span class="line">/usr/share/man/man1/docker-rm.1.gz</span><br><span class="line">/usr/share/man/man1/docker-rmi.1.gz</span><br><span class="line">/usr/share/man/man1/docker-run.1.gz</span><br><span class="line">/usr/share/man/man1/docker-save.1.gz</span><br><span class="line">/usr/share/man/man1/docker-search.1.gz</span><br><span class="line">/usr/share/man/man1/docker-secret-create.1.gz</span><br><span class="line">/usr/share/man/man1/docker-secret-inspect.1.gz</span><br><span class="line">/usr/share/man/man1/docker-secret-ls.1.gz</span><br><span class="line">/usr/share/man/man1/docker-secret-rm.1.gz</span><br><span class="line">/usr/share/man/man1/docker-secret.1.gz</span><br><span class="line">/usr/share/man/man1/docker-service-create.1.gz</span><br><span class="line">/usr/share/man/man1/docker-service-inspect.1.gz</span><br><span class="line">/usr/share/man/man1/docker-service-logs.1.gz</span><br><span class="line">/usr/share/man/man1/docker-service-ls.1.gz</span><br><span class="line">/usr/share/man/man1/docker-service-ps.1.gz</span><br><span class="line">/usr/share/man/man1/docker-service-rm.1.gz</span><br><span class="line">/usr/share/man/man1/docker-service-rollback.1.gz</span><br><span class="line">/usr/share/man/man1/docker-service-scale.1.gz</span><br><span class="line">/usr/share/man/man1/docker-service-update.1.gz</span><br><span class="line">/usr/share/man/man1/docker-service.1.gz</span><br><span class="line">/usr/share/man/man1/docker-stack-deploy.1.gz</span><br><span class="line">/usr/share/man/man1/docker-stack-ls.1.gz</span><br><span class="line">/usr/share/man/man1/docker-stack-ps.1.gz</span><br><span class="line">/usr/share/man/man1/docker-stack-rm.1.gz</span><br><span class="line">/usr/share/man/man1/docker-stack-services.1.gz</span><br><span class="line">/usr/share/man/man1/docker-stack.1.gz</span><br><span class="line">/usr/share/man/man1/docker-start.1.gz</span><br><span class="line">/usr/share/man/man1/docker-stats.1.gz</span><br><span class="line">/usr/share/man/man1/docker-stop.1.gz</span><br><span class="line">/usr/share/man/man1/docker-swarm-ca.1.gz</span><br><span class="line">/usr/share/man/man1/docker-swarm-init.1.gz</span><br><span class="line">/usr/share/man/man1/docker-swarm-join-token.1.gz</span><br><span class="line">/usr/share/man/man1/docker-swarm-join.1.gz</span><br><span class="line">/usr/share/man/man1/docker-swarm-leave.1.gz</span><br><span class="line">/usr/share/man/man1/docker-swarm-unlock-key.1.gz</span><br><span class="line">/usr/share/man/man1/docker-swarm-unlock.1.gz</span><br><span class="line">/usr/share/man/man1/docker-swarm-update.1.gz</span><br><span class="line">/usr/share/man/man1/docker-swarm.1.gz</span><br><span class="line">/usr/share/man/man1/docker-system-df.1.gz</span><br><span class="line">/usr/share/man/man1/docker-system-events.1.gz</span><br><span class="line">/usr/share/man/man1/docker-system-info.1.gz</span><br><span class="line">/usr/share/man/man1/docker-system-prune.1.gz</span><br><span class="line">/usr/share/man/man1/docker-system.1.gz</span><br><span class="line">/usr/share/man/man1/docker-tag.1.gz</span><br><span class="line">/usr/share/man/man1/docker-top.1.gz</span><br><span class="line">/usr/share/man/man1/docker-trust-inspect.1.gz</span><br><span class="line">/usr/share/man/man1/docker-trust-key-generate.1.gz</span><br><span class="line">/usr/share/man/man1/docker-trust-key-load.1.gz</span><br><span class="line">/usr/share/man/man1/docker-trust-key.1.gz</span><br><span class="line">/usr/share/man/man1/docker-trust-revoke.1.gz</span><br><span class="line">/usr/share/man/man1/docker-trust-sign.1.gz</span><br><span class="line">/usr/share/man/man1/docker-trust-signer-add.1.gz</span><br><span class="line">/usr/share/man/man1/docker-trust-signer-remove.1.gz</span><br><span class="line">/usr/share/man/man1/docker-trust-signer.1.gz</span><br><span class="line">/usr/share/man/man1/docker-trust.1.gz</span><br><span class="line">/usr/share/man/man1/docker-unpause.1.gz</span><br><span class="line">/usr/share/man/man1/docker-update.1.gz</span><br><span class="line">/usr/share/man/man1/docker-version.1.gz</span><br><span class="line">/usr/share/man/man1/docker-volume-create.1.gz</span><br><span class="line">/usr/share/man/man1/docker-volume-inspect.1.gz</span><br><span class="line">/usr/share/man/man1/docker-volume-ls.1.gz</span><br><span class="line">/usr/share/man/man1/docker-volume-prune.1.gz</span><br><span class="line">/usr/share/man/man1/docker-volume-rm.1.gz</span><br><span class="line">/usr/share/man/man1/docker-volume.1.gz</span><br><span class="line">/usr/share/man/man1/docker-wait.1.gz</span><br><span class="line">/usr/share/man/man1/docker.1.gz</span><br><span class="line">/usr/share/man/man5</span><br><span class="line">/usr/share/man/man5/Dockerfile.5.gz</span><br><span class="line">/usr/share/man/man5/docker-config-json.5.gz</span><br><span class="line">/usr/share/man/man8</span><br><span class="line">/usr/share/man/man8/dockerd.8.gz</span><br><span class="line">/usr/share/zsh</span><br><span class="line">/usr/share/zsh/vendor-completions</span><br><span class="line">/usr/share/zsh/vendor-completions/_docker</span><br></pre></td></tr></table></figure>

<p><strong>范例: CentOS7 查看docker相关文件</strong></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br></pre></td><td class="code"><pre><span class="line">[root@centos7 ~]<span class="comment"># rpm -ql docker-ce</span></span><br><span class="line">/usr/bin/docker-init</span><br><span class="line">/usr/bin/docker-proxy</span><br><span class="line">/usr/bin/dockerd</span><br><span class="line">/usr/lib/systemd/system/docker.service</span><br><span class="line">/usr/lib/systemd/system/docker.socket</span><br><span class="line"></span><br><span class="line">[root@centos7 ~]<span class="comment"># rpm -ql docker-ce-cli</span></span><br><span class="line">/usr/bin/docker</span><br><span class="line">/usr/libexec/docker/cli-plugins/docker-app</span><br><span class="line">/usr/libexec/docker/cli-plugins/docker-buildx</span><br><span class="line">/usr/share/bash-completion/completions/docker</span><br><span class="line">/usr/share/doc/docker-ce-cli-19.03.12</span><br><span class="line">/usr/share/doc/docker-ce-cli-19.03.12/LICENSE</span><br><span class="line">/usr/share/doc/docker-ce-cli-19.03.12/MAINTAINERS</span><br><span class="line">/usr/share/doc/docker-ce-cli-19.03.12/NOTICE</span><br><span class="line">/usr/share/doc/docker-ce-cli-19.03.12/README.md</span><br><span class="line">/usr/share/fish/vendor_completions.d/docker.fish</span><br><span class="line">/usr/share/man/man1/docker-attach.1.gz</span><br><span class="line">/usr/share/man/man1/docker-build.1.gz</span><br><span class="line">/usr/share/man/man1/docker-builder-build.1.gz</span><br><span class="line">/usr/share/man/man1/docker-builder-prune.1.gz</span><br><span class="line">/usr/share/man/man1/docker-builder.1.gz</span><br><span class="line">/usr/share/man/man1/docker-checkpoint-create.1.gz</span><br><span class="line">/usr/share/man/man1/docker-checkpoint-ls.1.gz</span><br><span class="line">/usr/share/man/man1/docker-checkpoint-rm.1.gz</span><br><span class="line">/usr/share/man/man1/docker-checkpoint.1.gz</span><br><span class="line">/usr/share/man/man1/docker-commit.1.gz</span><br><span class="line">/usr/share/man/man1/docker-config-create.1.gz</span><br><span class="line">/usr/share/man/man1/docker-config-inspect.1.gz</span><br><span class="line">/usr/share/man/man1/docker-config-ls.1.gz</span><br><span class="line">/usr/share/man/man1/docker-config-rm.1.gz</span><br><span class="line">/usr/share/man/man1/docker-config.1.gz</span><br><span class="line">/usr/share/man/man1/docker-container-attach.1.gz</span><br><span class="line">/usr/share/man/man1/docker-container-commit.1.gz</span><br><span class="line">/usr/share/man/man1/docker-container-cp.1.gz</span><br><span class="line">/usr/share/man/man1/docker-container-create.1.gz</span><br><span class="line">/usr/share/man/man1/docker-container-diff.1.gz</span><br><span class="line">/usr/share/man/man1/docker-container-exec.1.gz</span><br><span class="line">/usr/share/man/man1/docker-container-export.1.gz</span><br><span class="line">/usr/share/man/man1/docker-container-inspect.1.gz</span><br><span class="line">/usr/share/man/man1/docker-container-kill.1.gz</span><br><span class="line">/usr/share/man/man1/docker-container-logs.1.gz</span><br><span class="line">/usr/share/man/man1/docker-container-ls.1.gz</span><br><span class="line">/usr/share/man/man1/docker-container-pause.1.gz</span><br><span class="line">/usr/share/man/man1/docker-container-port.1.gz</span><br><span class="line">/usr/share/man/man1/docker-container-prune.1.gz</span><br><span class="line">/usr/share/man/man1/docker-container-rename.1.gz</span><br><span class="line">/usr/share/man/man1/docker-container-restart.1.gz</span><br><span class="line">/usr/share/man/man1/docker-container-rm.1.gz</span><br><span class="line">/usr/share/man/man1/docker-container-run.1.gz</span><br><span class="line">/usr/share/man/man1/docker-container-start.1.gz</span><br><span class="line">/usr/share/man/man1/docker-container-stats.1.gz</span><br><span class="line">/usr/share/man/man1/docker-container-stop.1.gz</span><br><span class="line">/usr/share/man/man1/docker-container-top.1.gz</span><br><span class="line">/usr/share/man/man1/docker-container-unpause.1.gz</span><br><span class="line">/usr/share/man/man1/docker-container-update.1.gz</span><br><span class="line">/usr/share/man/man1/docker-container-wait.1.gz</span><br><span class="line">/usr/share/man/man1/docker-container.1.gz</span><br><span class="line">/usr/share/man/man1/docker-context-create.1.gz</span><br><span class="line">/usr/share/man/man1/docker-context-export.1.gz</span><br><span class="line">/usr/share/man/man1/docker-context-import.1.gz</span><br><span class="line">/usr/share/man/man1/docker-context-inspect.1.gz</span><br><span class="line">/usr/share/man/man1/docker-context-ls.1.gz</span><br><span class="line">/usr/share/man/man1/docker-context-rm.1.gz</span><br><span class="line">/usr/share/man/man1/docker-context-update.1.gz</span><br><span class="line">/usr/share/man/man1/docker-context-use.1.gz</span><br><span class="line">/usr/share/man/man1/docker-context.1.gz</span><br><span class="line">/usr/share/man/man1/docker-cp.1.gz</span><br><span class="line">/usr/share/man/man1/docker-create.1.gz</span><br><span class="line">/usr/share/man/man1/docker-deploy.1.gz</span><br><span class="line">/usr/share/man/man1/docker-diff.1.gz</span><br><span class="line">/usr/share/man/man1/docker-engine-activate.1.gz</span><br><span class="line">/usr/share/man/man1/docker-engine-check.1.gz</span><br><span class="line">/usr/share/man/man1/docker-engine-update.1.gz</span><br><span class="line">/usr/share/man/man1/docker-engine.1.gz</span><br><span class="line">/usr/share/man/man1/docker-events.1.gz</span><br><span class="line">/usr/share/man/man1/docker-exec.1.gz</span><br><span class="line">/usr/share/man/man1/docker-export.1.gz</span><br><span class="line">/usr/share/man/man1/docker-history.1.gz</span><br><span class="line">/usr/share/man/man1/docker-image-build.1.gz</span><br><span class="line">/usr/share/man/man1/docker-image-history.1.gz</span><br><span class="line">/usr/share/man/man1/docker-image-import.1.gz</span><br><span class="line">/usr/share/man/man1/docker-image-inspect.1.gz</span><br><span class="line">/usr/share/man/man1/docker-image-load.1.gz</span><br><span class="line">/usr/share/man/man1/docker-image-ls.1.gz</span><br><span class="line">/usr/share/man/man1/docker-image-prune.1.gz</span><br><span class="line">/usr/share/man/man1/docker-image-pull.1.gz</span><br><span class="line">/usr/share/man/man1/docker-image-push.1.gz</span><br><span class="line">/usr/share/man/man1/docker-image-rm.1.gz</span><br><span class="line">/usr/share/man/man1/docker-image-save.1.gz</span><br><span class="line">/usr/share/man/man1/docker-image-tag.1.gz</span><br><span class="line">/usr/share/man/man1/docker-image.1.gz</span><br><span class="line">/usr/share/man/man1/docker-images.1.gz</span><br><span class="line">/usr/share/man/man1/docker-import.1.gz</span><br><span class="line">/usr/share/man/man1/docker-info.1.gz</span><br><span class="line">/usr/share/man/man1/docker-inspect.1.gz</span><br><span class="line">/usr/share/man/man1/docker-kill.1.gz</span><br><span class="line">/usr/share/man/man1/docker-load.1.gz</span><br><span class="line">/usr/share/man/man1/docker-login.1.gz</span><br><span class="line">/usr/share/man/man1/docker-logout.1.gz</span><br><span class="line">/usr/share/man/man1/docker-logs.1.gz</span><br><span class="line">/usr/share/man/man1/docker-manifest-annotate.1.gz</span><br><span class="line">/usr/share/man/man1/docker-manifest-create.1.gz</span><br><span class="line">/usr/share/man/man1/docker-manifest-inspect.1.gz</span><br><span class="line">/usr/share/man/man1/docker-manifest-push.1.gz</span><br><span class="line">/usr/share/man/man1/docker-manifest.1.gz</span><br><span class="line">/usr/share/man/man1/docker-network-connect.1.gz</span><br><span class="line">/usr/share/man/man1/docker-network-create.1.gz</span><br><span class="line">/usr/share/man/man1/docker-network-disconnect.1.gz</span><br><span class="line">/usr/share/man/man1/docker-network-inspect.1.gz</span><br><span class="line">/usr/share/man/man1/docker-network-ls.1.gz</span><br><span class="line">/usr/share/man/man1/docker-network-prune.1.gz</span><br><span class="line">/usr/share/man/man1/docker-network-rm.1.gz</span><br><span class="line">/usr/share/man/man1/docker-network.1.gz</span><br><span class="line">/usr/share/man/man1/docker-node-demote.1.gz</span><br><span class="line">/usr/share/man/man1/docker-node-inspect.1.gz</span><br><span class="line">/usr/share/man/man1/docker-node-ls.1.gz</span><br><span class="line">/usr/share/man/man1/docker-node-promote.1.gz</span><br><span class="line">/usr/share/man/man1/docker-node-ps.1.gz</span><br><span class="line">/usr/share/man/man1/docker-node-rm.1.gz</span><br><span class="line">/usr/share/man/man1/docker-node-update.1.gz</span><br><span class="line">/usr/share/man/man1/docker-node.1.gz</span><br><span class="line">/usr/share/man/man1/docker-pause.1.gz</span><br><span class="line">/usr/share/man/man1/docker-plugin-create.1.gz</span><br><span class="line">/usr/share/man/man1/docker-plugin-disable.1.gz</span><br><span class="line">/usr/share/man/man1/docker-plugin-enable.1.gz</span><br><span class="line">/usr/share/man/man1/docker-plugin-inspect.1.gz</span><br><span class="line">/usr/share/man/man1/docker-plugin-install.1.gz</span><br><span class="line">/usr/share/man/man1/docker-plugin-ls.1.gz</span><br><span class="line">/usr/share/man/man1/docker-plugin-push.1.gz</span><br><span class="line">/usr/share/man/man1/docker-plugin-rm.1.gz</span><br><span class="line">/usr/share/man/man1/docker-plugin-set.1.gz</span><br><span class="line">/usr/share/man/man1/docker-plugin-upgrade.1.gz</span><br><span class="line">/usr/share/man/man1/docker-plugin.1.gz</span><br><span class="line">/usr/share/man/man1/docker-port.1.gz</span><br><span class="line">/usr/share/man/man1/docker-ps.1.gz</span><br><span class="line">/usr/share/man/man1/docker-pull.1.gz</span><br><span class="line">/usr/share/man/man1/docker-push.1.gz</span><br><span class="line">/usr/share/man/man1/docker-rename.1.gz</span><br><span class="line">/usr/share/man/man1/docker-restart.1.gz</span><br><span class="line">/usr/share/man/man1/docker-rm.1.gz</span><br><span class="line">/usr/share/man/man1/docker-rmi.1.gz</span><br><span class="line">/usr/share/man/man1/docker-run.1.gz</span><br><span class="line">/usr/share/man/man1/docker-save.1.gz</span><br><span class="line">/usr/share/man/man1/docker-search.1.gz</span><br><span class="line">/usr/share/man/man1/docker-secret-create.1.gz</span><br><span class="line">/usr/share/man/man1/docker-secret-inspect.1.gz</span><br><span class="line">/usr/share/man/man1/docker-secret-ls.1.gz</span><br><span class="line">/usr/share/man/man1/docker-secret-rm.1.gz</span><br><span class="line">/usr/share/man/man1/docker-secret.1.gz</span><br><span class="line">/usr/share/man/man1/docker-service-create.1.gz</span><br><span class="line">/usr/share/man/man1/docker-service-inspect.1.gz</span><br><span class="line">/usr/share/man/man1/docker-service-logs.1.gz</span><br><span class="line">/usr/share/man/man1/docker-service-ls.1.gz</span><br><span class="line">/usr/share/man/man1/docker-service-ps.1.gz</span><br><span class="line">/usr/share/man/man1/docker-service-rm.1.gz</span><br><span class="line">/usr/share/man/man1/docker-service-rollback.1.gz</span><br><span class="line">/usr/share/man/man1/docker-service-scale.1.gz</span><br><span class="line">/usr/share/man/man1/docker-service-update.1.gz</span><br><span class="line">/usr/share/man/man1/docker-service.1.gz</span><br><span class="line">/usr/share/man/man1/docker-stack-deploy.1.gz</span><br><span class="line">/usr/share/man/man1/docker-stack-ls.1.gz</span><br><span class="line">/usr/share/man/man1/docker-stack-ps.1.gz</span><br><span class="line">/usr/share/man/man1/docker-stack-rm.1.gz</span><br><span class="line">/usr/share/man/man1/docker-stack-services.1.gz</span><br><span class="line">/usr/share/man/man1/docker-stack.1.gz</span><br><span class="line">/usr/share/man/man1/docker-start.1.gz</span><br><span class="line">/usr/share/man/man1/docker-stats.1.gz</span><br></pre></td></tr></table></figure>

<h3 id="Docker-命令帮助"><a href="#Docker-命令帮助" class="headerlink" title="Docker 命令帮助"></a>Docker 命令帮助</h3><p>docker 命令是最常使用的 docker 客户端命令，其后面可以加不同的参数以实现不同的功能</p>
<p>docker 命令格式</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">docker [OPTIONS] COMMAND</span><br><span class="line"></span><br><span class="line">COMMAND分为</span><br><span class="line">Management Commands  <span class="comment">#指定管理的资源对象类型,较新的命令用法,将命令按资源类型进行分类,方便使用</span></span><br><span class="line">Commands             <span class="comment">#对不同资源操作的命令不分类,使用容易产生混乱</span></span><br></pre></td></tr></table></figure>

<p>docker 命令有很多子命令，可以用下面方法查看帮助</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#docker 命令帮助</span></span><br><span class="line">man docker</span><br><span class="line">docker</span><br><span class="line">docker  --<span class="built_in">help</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#docker 子命令帮助</span></span><br><span class="line">man docker-COMMAND</span><br><span class="line">docker COMMAND --<span class="built_in">help</span></span><br></pre></td></tr></table></figure>

<p>官方文档:</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">https://docs.docker.com/reference/</span><br><span class="line">https://docs.docker.com/engine/reference/commandline/cli/</span><br></pre></td></tr></table></figure>

<p><img src="../../../../images/SRE/day46/16.jpg" alt="16"></p>
<p>范例: 查看docker命令帮助</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@ubuntu1804 ~]<span class="comment"># docker --help</span></span><br></pre></td></tr></table></figure>

<h3 id="查看-Docker-相关信息"><a href="#查看-Docker-相关信息" class="headerlink" title="查看 Docker 相关信息"></a>查看 Docker 相关信息</h3><h4 id="查看-docker-版本"><a href="#查看-docker-版本" class="headerlink" title="查看 docker 版本"></a>查看 docker 版本</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">[root@ubuntu1804 ~]<span class="comment"># docker version</span></span><br><span class="line">Client: Docker Engine - Community</span><br><span class="line"> Version: 19.03.5</span><br><span class="line"> API version: 1.40</span><br><span class="line"> Go version: go1.12.12</span><br><span class="line"> Git commit: 633a0ea838</span><br><span class="line"> Built: Wed Nov 13 07:29:52 2019</span><br><span class="line"> OS/Arch: linux/amd64</span><br><span class="line"> Experimental:  <span class="literal">false</span></span><br><span class="line"></span><br><span class="line">Server: Docker Engine - Community</span><br><span class="line"> Engine:</span><br><span class="line">  Version:  19.03.5</span><br><span class="line">  API version:  1.40 (minimum version 1.12)</span><br><span class="line">  Go version: go1.12.12</span><br><span class="line">  Git commit: 633a0ea838</span><br><span class="line">  Built: Wed Nov 13 07:28:22 2019</span><br><span class="line">  OS/Arch: linux/amd64</span><br><span class="line">  Experimental: <span class="literal">false</span></span><br><span class="line">  containerd:</span><br><span class="line">    Version:  1.2.10</span><br><span class="line">    GitCommit: b34a5c8af56e510852c35414db4c1f4fa6172339</span><br><span class="line">  runc:</span><br><span class="line">    Version:  1.0.0-rc8+dev</span><br><span class="line">    GitCommit: 3e425f80a8c931f88e6d94a8c831b9d5aa481657</span><br><span class="line"> docker-init:</span><br><span class="line">    Version:  0.18.0</span><br><span class="line">   GitCommit: fec3683</span><br></pre></td></tr></table></figure>

<h4 id="查看-docker-详解信息"><a href="#查看-docker-详解信息" class="headerlink" title="查看 docker 详解信息"></a>查看 docker 详解信息</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">[root@ubuntu1804 ~]<span class="comment"># docker info</span></span><br><span class="line">Client:</span><br><span class="line"> Debug Mode: <span class="literal">false</span>     <span class="comment">#client 端是否开启 debug</span></span><br><span class="line">Server:</span><br><span class="line"> Containers: 2   <span class="comment">#当前主机运行的容器总数</span></span><br><span class="line"> Running: 0      <span class="comment">#有几个容器是正在运行的</span></span><br><span class="line"> Paused: 0       <span class="comment">#有几个容器是暂停的</span></span><br><span class="line"> Stopped: 2      <span class="comment">#有几个容器是停止的</span></span><br><span class="line"> Images: 4       <span class="comment">#当前服务器的镜像数</span></span><br><span class="line"> Server Version: 19.03.5     <span class="comment">#服务端版本</span></span><br><span class="line"> Storage Driver: overlay2    <span class="comment">#正在使用的存储引擎</span></span><br><span class="line"> Backing Filesystem: extfs   <span class="comment">#后端文件系统，即服务器的磁盘文件系统</span></span><br><span class="line"> Supports d_type: <span class="literal">true</span>       <span class="comment">#是否支持 d_type</span></span><br><span class="line"> Native Overlay Diff: <span class="literal">true</span>   <span class="comment">#是否支持差异数据存储</span></span><br><span class="line"> Logging Driver: json-file   <span class="comment">#日志类型,每个容器的标准输出以日志存放在/var/lib/docker/containers/&lt;CONTAINER ID&gt;/&lt;CONTAINER ID&gt;-json.log </span></span><br><span class="line"> Cgroup Driver: cgroupfs     <span class="comment">#Cgroups 类型</span></span><br><span class="line"> Plugins:                    <span class="comment">#插件</span></span><br><span class="line"> Volume: <span class="built_in">local</span>               <span class="comment">#卷</span></span><br><span class="line"> Network: bridge host ipvlan macvlan null overlay <span class="comment"># overlay 跨主机通信</span></span><br><span class="line"> Log: awslogs fluentd gcplogs gelf journald json-file <span class="built_in">local</span> logentries splunk </span><br><span class="line">syslog                       <span class="comment"># 日志类型</span></span><br><span class="line"> Swarm: inactive             <span class="comment">#是否支持 swarm</span></span><br><span class="line"> Runtimes: runc              <span class="comment">#已安装的容器运行时</span></span><br><span class="line"> Default Runtime: runc       <span class="comment">#默认使用的容器运行时</span></span><br><span class="line"> Init Binary: docker-init    <span class="comment">#初始化容器的守护进程，即 pid 为 1 的进程</span></span><br><span class="line"> containerd version: b34a5c8af56e510852c35414db4c1f4fa6172339 <span class="comment">#版本</span></span><br><span class="line"> runc version: 3e425f80a8c931f88e6d94a8c831b9d5aa481657  <span class="comment">#runc 版本</span></span><br><span class="line"> init version: fec3683   <span class="comment">#init 版本</span></span><br><span class="line"> Security Options:       <span class="comment">#安全选项</span></span><br><span class="line"> apparmor                <span class="comment">#安全模块，https://docs.docker.com/engine/security/apparmor/</span></span><br><span class="line"> seccomp                 <span class="comment">#安全计算模块，即制容器操作，https://docs.docker.com/engine/security/seccomp/</span></span><br><span class="line">   Profile: default      <span class="comment">#默认的配置文件</span></span><br><span class="line"> Kernel Version: 4.15.0-29-generic     <span class="comment">#宿主机内核版本</span></span><br><span class="line"> Operating System: Ubuntu 18.04.1 LTS  <span class="comment">#宿主机操作系统</span></span><br><span class="line"> OSType: linux           <span class="comment">#宿主机操作系统类型</span></span><br><span class="line"> Architecture: x86_64    <span class="comment">#宿主机架构</span></span><br><span class="line"> CPUs: 1                 <span class="comment">#宿主机 CPU 数量</span></span><br><span class="line"> Total Memory: 962MiB    <span class="comment">#宿主机总内存</span></span><br><span class="line"> Name: ubuntu1804.wang.org <span class="comment">#宿主机 hostname</span></span><br><span class="line"> ID: IZHJ:WPIN:BRMC:XQUI:VVVR:UVGK:NZBM:YQXT:JDWB:33RS:45V7:SQWJ <span class="comment">#宿主机 ID</span></span><br><span class="line"> Docker Root Dir: /var/lib/docker   <span class="comment">#宿主机关于docker数据的保存目录,建议使用独立SSD的磁盘,保证性能和空间</span></span><br><span class="line"> Debug Mode: <span class="literal">false</span>                  <span class="comment">#server 端是否开启 debug</span></span><br><span class="line"> Registry: https://index.docker.io/v1/  <span class="comment">#仓库路径</span></span><br><span class="line"> Labels:</span><br><span class="line"> Experimental: <span class="literal">false</span>      <span class="comment">#是否测试版</span></span><br><span class="line"> Insecure Registries:</span><br><span class="line">  127.0.0.0/8 :           <span class="comment">#非安全的镜像仓库</span></span><br><span class="line"> Registry Mirrors:</span><br><span class="line"> https://si7y70hh.mirror.aliyuncs.com/   <span class="comment">#镜像仓库</span></span><br><span class="line"> Live Restore Enabled: <span class="literal">false</span>             <span class="comment">#是否开启活动重启 (重启docker-daemon 不关闭容器 )</span></span><br><span class="line"> </span><br><span class="line">WARNING: No swap <span class="built_in">limit</span> support  <span class="comment">#系统警告信息 (没有开启 swap 资源限制 )</span></span><br></pre></td></tr></table></figure>

<p>范例: 解决上述SWAP报警提示</p>
<p>官方文档: <a target="_blank" rel="noopener" href="https://docs.docker.com/install/linux/linux-postinstall/#your-kernel-does-not-support-cgroup-swap-limit-capabilities">https://docs.docker.com/install/linux/linux-postinstall/#your-kernel-does-not-support-cgroup-swap-limit-capabilities</a></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[root@ubuntu1804 ~]<span class="comment"># docker info</span></span><br><span class="line">......</span><br><span class="line">WARNING: No swap <span class="built_in">limit</span> support </span><br><span class="line"></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment"># vim /etc/default/grub</span></span><br><span class="line">GRUB_DEFAULT=0</span><br><span class="line">GRUB_TIMEOUT_STYLE=hidden</span><br><span class="line">GRUB_TIMEOUT=2</span><br><span class="line">GRUB_DISTRIBUTOR=`lsb_ release -i -s 2&gt; /dev/null || <span class="built_in">echo</span> Debian`</span><br><span class="line">GRUB_CMDLINE_LINUX_DEFAULT=<span class="string">&quot;&quot;</span></span><br><span class="line">GRUB_CMDLINE_LINUX=<span class="string">&quot;net.ifnames=0 biosdevname=0 swapaccount=1&quot;</span>  <span class="comment">#修改此行</span></span><br><span class="line"></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment"># update-grub</span></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment"># reboot</span></span><br></pre></td></tr></table></figure>

<p>范例: Docker 优化</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">[root@ubuntu2004 ~]<span class="comment"># vim /etc/docker/daemon.json</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;registry-mirrors&quot;</span>: [</span><br><span class="line">        <span class="string">&quot;https://registry.docker-cn.com&quot;</span>,</span><br><span class="line">        <span class="string">&quot;http://hub-mirror.c.163.com&quot;</span>,</span><br><span class="line">        <span class="string">&quot;https://docker.mirrors.ustc.edu.cn&quot;</span></span><br><span class="line">    ],</span><br><span class="line">    <span class="string">&quot;insecure-registries&quot;</span>: [<span class="string">&quot;harbor.wang.org&quot;</span>],</span><br><span class="line">    <span class="string">&quot;exec-opts&quot;</span>: [<span class="string">&quot;native.cgroupdriver=systemd&quot;</span>],</span><br><span class="line">    <span class="string">&quot;data-root&quot;</span>: <span class="string">&quot;/data/docker&quot;</span>,  <span class="comment"># Docker 23.0+ 版本已弃用 graph 参数，需改为 data-root</span></span><br><span class="line">    <span class="string">&quot;max-concurrent-downloads&quot;</span>: 10,</span><br><span class="line">    <span class="string">&quot;max-concurrent-uploads&quot;</span>: 5,</span><br><span class="line">    <span class="string">&quot;log-opts&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;max-size&quot;</span>: <span class="string">&quot;300m&quot;</span>,</span><br><span class="line">        <span class="string">&quot;max-file&quot;</span>: <span class="string">&quot;2&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">&quot;live-restore&quot;</span>: <span class="literal">true</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@ubuntu2004 ~]<span class="comment"># systemctl daemon-reload ;systemctl restart docker.service</span></span><br></pre></td></tr></table></figure>

<h4 id="查看-docker0-网卡"><a href="#查看-docker0-网卡" class="headerlink" title="查看 docker0 网卡"></a>查看 docker0 网卡</h4><p>在docker安装启动之后，默认会生成一个名称为docker0的网卡并且默认IP地址为172.17.0.1的网卡</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#ubuntu18.04安装docker后网卡配置</span></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment"># ip a</span></span><br><span class="line">1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group </span><br><span class="line">default qlen 1000</span><br><span class="line">   <span class="built_in">link</span>/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00</span><br><span class="line">   inet 127.0.0.1/8 scope host lo</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">   inet6 ::1/128 scope host </span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">2: eth0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc fq_codel state UP </span><br><span class="line">group default qlen 1000</span><br><span class="line">   <span class="built_in">link</span>/ether 00:0c:29:34:<span class="built_in">df</span>:91 brd ff:ff:ff:ff:ff:ff</span><br><span class="line">   inet 10.0.0.100/24 brd 10.0.0.255 scope global eth0</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">   inet6 fe80::20c:29ff:fe34:df91/64 scope <span class="built_in">link</span></span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">4: docker0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue state UP </span><br><span class="line">group default </span><br><span class="line">   <span class="built_in">link</span>/ether 02:42:d3:26:ed:4e brd ff:ff:ff:ff:ff:ff</span><br><span class="line">   inet 172.17.0.1/16 brd 172.17.255.255 scope global docker0</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">   inet6 fe80::42:d3ff:fe26:ed4e/64 scope <span class="built_in">link</span> </span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">       </span><br><span class="line"><span class="comment">#CentOS 7.6 安装docker后网卡配置</span></span><br><span class="line">[root@centos7 ~]<span class="comment"># ip a</span></span><br><span class="line">1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group </span><br><span class="line">default qlen 1000</span><br><span class="line">   <span class="built_in">link</span>/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00</span><br><span class="line">   inet 127.0.0.1/8 scope host lo</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">   inet6 ::1/128 scope host </span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">2: eth0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc pfifo_fast state UP </span><br><span class="line">group default qlen 1000</span><br><span class="line">   <span class="built_in">link</span>/ether 00:0c:29:ca:00:e4 brd ff:ff:ff:ff:ff:ff</span><br><span class="line">   inet 10.0.0.7/24 brd 10.0.0.255 scope global noprefixroute eth0</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">   inet6 fe80::20c:29ff:feca:e4/64 scope <span class="built_in">link</span> </span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">3: docker0: &lt;NO-CARRIER,BROADCAST,MULTICAST,UP&gt; mtu 1500 qdisc noqueue state </span><br><span class="line">DOWN group default </span><br><span class="line">   <span class="built_in">link</span>/ether 02:42:d2:81:c2:e0 brd ff:ff:ff:ff:ff:ff</span><br><span class="line">   inet 172.17.0.1/16 brd 172.17.255.255 scope global docker0</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">       </span><br><span class="line"><span class="comment">#CentOS 8.1 安装docker后网卡配置   </span></span><br><span class="line">[root@centos8 ~]<span class="comment"># ip a</span></span><br><span class="line">1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000</span><br><span class="line">    <span class="built_in">link</span>/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00</span><br><span class="line">    inet 127.0.0.1/8 scope host lo</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    inet6 ::1/128 scope host </span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">2: ens160: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc mq state UP group default qlen 1000</span><br><span class="line">    <span class="built_in">link</span>/ether 00:0c:29:71:6e:af brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    altname enp3s0</span><br><span class="line">    inet 192.168.1.11/24 brd 192.168.1.255 scope global noprefixroute ens160</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    inet6 fe80::20c:29ff:fe71:6eaf/64 scope <span class="built_in">link</span> </span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">3: docker0: &lt;NO-CARRIER,BROADCAST,MULTICAST,UP&gt; mtu 1500 qdisc noqueue state DOWN group default </span><br><span class="line">    <span class="built_in">link</span>/ether 02:42:ee:76:de:00 brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    inet 172.17.0.1/16 brd 172.17.255.255 scope global docker0</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line"></span><br><span class="line">       </span><br><span class="line">[root@centos8 ~]<span class="comment"># route -n</span></span><br><span class="line">Kernel IP routing table</span><br><span class="line">Destination     Gateway         Genmask         Flags Metric Ref    Use Iface</span><br><span class="line">0.0.0.0         192.168.1.2     0.0.0.0         UG    100    0        0 ens160</span><br><span class="line">172.17.0.0      0.0.0.0         255.255.0.0     U     0      0        0 docker0</span><br><span class="line">192.168.1.0     0.0.0.0         255.255.255.0   U     100    0        0 ens160</span><br></pre></td></tr></table></figure>

<h4 id="docker-存储引擎"><a href="#docker-存储引擎" class="headerlink" title="docker 存储引擎"></a>docker 存储引擎</h4><p>官方文档关于存储引擎的相关文档:</p>
<p><a target="_blank" rel="noopener" href="https://docs.docker.com/storage/storagedriver/">https://docs.docker.com/storage/storagedriver/</a></p>
<p><a target="_blank" rel="noopener" href="https://docs.docker.com/storage/storagedriver/select-storage-driver/">https://docs.docker.com/storage/storagedriver/select-storage-driver/</a></p>
<ul>
<li><p>AUFS: （Advanced Mult-Layered Unification Filesystem，版本 2 之前旧称AnotherUnionFS）是一种 Union FS ，是文件级的存储驱动。Aufs是之前的UnionFS的重新实现， 2006 年由JunjiroOkajima开发</p>
<p>所谓 UnionFS就是把不同物理位置的目录合并 mount 到同一个目录中。简单来说就是支持将不同目录挂载到一个虚拟文件系统下的。这种可以层层地叠加修改文件。无论底下有多少都是只读的，最上系统可写的。当需要修改一个文件时， AUFS 创建该文件的一个副本，使用 CoW 将文件从只读层复制到可写进行修改，结果也保存在Docker 中，底下的只读层就是 image，可写层就是Container</p>
<p>aufs 被拒绝合并到主线 Linux 。其代码被批评为”dense, unreadable, uncommented 密集、不可读、未注释”。 相反，OverlayFS被合并到 Linux 内核中。在多次尝试将 aufs 合并到主线内核失败后，作者放弃了</p>
<p>AUFS 是 Docker 18.06 及更早版本的首选存储驱动程序，在内核 3.13 上运行 Ubuntu 14.04 时不支持 overlay2</p>
</li>
<li><p>Overlay: 一种 Union FS 文件系统， Linux 内核 3.18 后支持</p>
</li>
<li><p>Overlay2: Overlay 的升级版，到目前为止，所有 Linux 发行版推荐使用的存储类 型，也是docker默认使用的存储引擎为overlay2，需要磁盘分区支持d-type功能，因此需要系统磁盘的额外支持,相对AUFS来说Overlay2 有以下优势: 更简单地设计； 从3.18开始就进入了Linux内核主线；资源消耗更少</p>
</li>
<li><p>devicemapper: 因为CentOS 7.2和RHEL 7.2 的之前版本内核版本不支持 overlay2，默认使用的存储驱动程序，最大数据容量只支持100GB且性能不佳，当前较新版本的CentOS 已经支持overlay2， 因此推荐使用 overlay2,另外此存储引擎已在Docker Engine 18.09中弃用</p>
</li>
<li><p>ZFS(Sun -2005)/btrfs(Oracle-2007): 目前没有广泛使用</p>
</li>
<li><p>vfs: 用于测试环境，适用于无法使用 copy-on -writewrite 时的情况。 此存储驱动程序的性能很差，通常不建议用于生产</p>
</li>
</ul>
<p>修改存储引擎参考文档:</p>
<p><a target="_blank" rel="noopener" href="https://docs.docker.com/storage/storagedriver/overlayfs-driver/">https://docs.docker.com/storage/storagedriver/overlayfs-driver/</a></p>
<p>范例: 在CentOS7.2修改存储引擎</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root@centos7 ~]<span class="comment"># vim /lib/systemd/system/docker.service</span></span><br><span class="line">.....</span><br><span class="line">ExecStart=/usr/bin/dockerd -s overlay2 -H fd:// --containerd=/run/containerd/containerd.sock</span><br><span class="line">......</span><br><span class="line"></span><br><span class="line"><span class="comment">#创建新的xfs分区,添加ftype特性,否则默认无法启动docker服务</span></span><br><span class="line">[root@centos7 ~]<span class="comment"># mkfs.xfs -n ftype=1 /dev/sdb</span></span><br><span class="line">[root@centos7 ~]<span class="comment"># mount /dev/sdb /var/lib/docker</span></span><br><span class="line"></span><br><span class="line">[root@centos7 ~]<span class="comment"># systemctl daemon-reload</span></span><br><span class="line">[root@centos7 ~]<span class="comment"># systemctl restart docker</span></span><br></pre></td></tr></table></figure>

<p>注意:修改存储引擎会导致所有容器丢失,所以先备份再修改</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#查看Ubuntu1804的默认存储引擎</span></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment"># docker info |grep Storage</span></span><br><span class="line">WARNING: No swap <span class="built_in">limit</span> support</span><br><span class="line"> Storage Driver: overlay2</span><br><span class="line"> </span><br><span class="line"><span class="comment">#查看CentOS7.6的默认存储引擎</span></span><br><span class="line">[root@centos7 ~]<span class="comment"># docker info |grep Storage</span></span><br><span class="line">WARNING: bridge-nf-call-iptables is disabled</span><br><span class="line">WARNING: bridge-nf-call-ip6tables is disabled</span><br><span class="line">Storage Driver: overlay2</span><br></pre></td></tr></table></figure>

<p>Docker官方推荐首选存储引擎为overlay2，其次为devicemapper，但是devicemapper存在使用空间方面的一些限制，虽然可以通过后期配置解决，但是官方依然推荐使用overlay2</p>
<p>范例: aufs 实现联合文件系统挂载</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br></pre></td><td class="code"><pre><span class="line">[root@ubuntu1804 ~]<span class="comment"># cat /proc/filesystems </span></span><br><span class="line">nodev sysfs</span><br><span class="line">nodev rootfs</span><br><span class="line">nodev ramfs</span><br><span class="line">nodev bdev</span><br><span class="line">nodev proc</span><br><span class="line">nodev cpuset</span><br><span class="line">nodev cgroup</span><br><span class="line">nodev cgroup2</span><br><span class="line">nodev tmpfs</span><br><span class="line">nodev devtmpfs</span><br><span class="line">nodev configfs</span><br><span class="line">nodev debugfs</span><br><span class="line">nodev tracefs</span><br><span class="line">nodev securityfs</span><br><span class="line">nodev sockfs</span><br><span class="line">nodev dax</span><br><span class="line">nodev bpf</span><br><span class="line">nodev pipefs</span><br><span class="line">nodev hugetlbfs</span><br><span class="line">nodev devpts</span><br><span class="line"></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment"># grep -i aufs /boot/config-4.15.0-29-generic </span></span><br><span class="line">CONFIG_AUFS_FS=m</span><br><span class="line">CONFIG_AUFS_BRANCH_MAX_127=y</span><br><span class="line"><span class="comment"># CONFIG_AUFS_BRANCH_MAX_511 is not set</span></span><br><span class="line"><span class="comment"># CONFIG_AUFS_BRANCH_MAX_1023 is not set</span></span><br><span class="line"><span class="comment"># CONFIG_AUFS_BRANCH_MAX_32767 is not set</span></span><br><span class="line">CONFIG_AUFS_SBILIST=y</span><br><span class="line"><span class="comment"># CONFIG_AUFS_HNOTIFY is not set</span></span><br><span class="line">CONFIG_AUFS_EXPORT=y</span><br><span class="line">CONFIG_AUFS_INO_T_64=y</span><br><span class="line">CONFIG_AUFS_XATTR=y</span><br><span class="line"><span class="comment"># CONFIG_AUFS_FHSM is not set</span></span><br><span class="line"><span class="comment"># CONFIG_AUFS_RDU is not set</span></span><br><span class="line">CONFIG_AUFS_DIRREN=y</span><br><span class="line"><span class="comment"># CONFIG_AUFS_SHWH is not set</span></span><br><span class="line"><span class="comment"># CONFIG_AUFS_BR_RAMFS is not set</span></span><br><span class="line"><span class="comment"># CONFIG_AUFS_BR_FUSE is not set</span></span><br><span class="line">CONFIG_AUFS_BR_HFSPLUS=y</span><br><span class="line">CONFIG_AUFS_BDEV_LOOP=y</span><br><span class="line"><span class="comment"># CONFIG_AUFS_DEBUG is not set</span></span><br><span class="line"></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment"># mkdir dir&#123;1,2&#125;</span></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment"># echo here is dir1 &gt; dir1/file1</span></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment"># echo here is dir2 &gt; dir2/file2</span></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment"># mkdir /data/aufs</span></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment"># mount -t aufs -o br=/root/dir1=ro:/root/dir2=rw none /data/aufs</span></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment"># ll /data/aufs/</span></span><br><span class="line">total 16</span><br><span class="line">drwxr-xr-x 4 root root 4096 Jan 25 16:22 ./</span><br><span class="line">drwxr-xr-x 4 root root 4096 Jan 25 16:22 ../</span><br><span class="line">-rw-r--r-- 1 root root   13 Jan 25 16:22 file1</span><br><span class="line">-rw-r--r-- 1 root root   13 Jan 25 16:22 file2</span><br><span class="line"></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment"># cat /data/aufs/file1</span></span><br><span class="line">here is dir1</span><br><span class="line"></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment"># cat /data/aufs/file2</span></span><br><span class="line">here is dir2</span><br><span class="line"></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment"># df -T</span></span><br><span class="line">Filesystem     Type     1K-blocks   Used Available Use% Mounted on</span><br><span class="line">udev           devtmpfs    462560       0    462560   0% /dev</span><br><span class="line">tmpfs         tmpfs        98512   10296     88216  11% /run</span><br><span class="line">/dev/sda2     ext4      47799020 2770244  42570972   7% /</span><br><span class="line">tmpfs         tmpfs       492552       0    492552   0% /dev/shm</span><br><span class="line">tmpfs         tmpfs         5120       0      5120   0% /run/lock</span><br><span class="line">tmpfs         tmpfs       492552       0    492552   0% /sys/fs/cgroup</span><br><span class="line">/dev/sda3     ext4      19091540   45084  18053588   1% /data</span><br><span class="line">/dev/sda1     ext4        944120   77112    801832   9% /boot</span><br><span class="line">tmpfs         tmpfs        98508       0     98508   0% /run/user/0</span><br><span class="line">none           aufs      47799020 2770244  42570972   7% /data/aufs</span><br><span class="line">[root@ubuntu1804 ~]<span class="comment"># echo write to file1 &gt;&gt; /data/aufs/file1</span></span><br><span class="line">-bash: /data/aufs/file1: Read-only file system</span><br><span class="line"></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment"># echo write to file2 &gt;&gt; /data/aufs/file2</span></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment"># cat /data/aufs/file1</span></span><br><span class="line">here is dir1</span><br><span class="line"></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment"># cat /data/aufs/file2</span></span><br><span class="line">here is dir2</span><br><span class="line">write to file2</span><br><span class="line"></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment"># umount /data/aufs </span></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment"># mv dir1/file1 dir1/file2</span></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment"># cat dir1/file2</span></span><br><span class="line">here is dir1</span><br><span class="line"></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment"># cat dir2/file2</span></span><br><span class="line">here is dir2</span><br><span class="line">write to file2</span><br><span class="line"></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment"># mount -t aufs -o br=/root/dir1=ro:/root/dir2=rw none /data/aufs</span></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment"># ls /data/aufs -l</span></span><br><span class="line">total 4</span><br><span class="line">-rw-r--r-- 1 root root 13 Jan 25 16:22 file2</span><br><span class="line"></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment"># cat /data/aufs/file2 </span></span><br><span class="line">here is dir1</span><br></pre></td></tr></table></figure>

<h2 id="镜像管理"><a href="#镜像管理" class="headerlink" title="镜像管理"></a>镜像管理</h2><h3 id="镜像结构和原理"><a href="#镜像结构和原理" class="headerlink" title="镜像结构和原理"></a>镜像结构和原理</h3><p><img src="../../../../images/SRE/day46/17.jpg" alt="17"></p>
<p>镜像即创建容器的模版，含有启动容器所需要的文件系统及所需要的内容，因此镜像主要用于方便和快速的创建并启动容器</p>
<p>镜像含里面是一层层的文件系统,叫做 Union FS（联合文件系统）,联合文件系统，可以将几层目录挂载到一起（就像千层饼，洋葱头，俄罗斯套娃一样），形成一个虚拟文件系统,虚拟文件系统的目录结构就像普通 linux 的目录结构一样，镜像通过这些文件再加上宿主机的内核共同提供了一个 linux 的虚拟环境，每一层文件系统叫做一层 layer，联合文件系统可以对每一层文件系统设置三种权限，只读（readonly）、读写（readwrite）和写出（whiteout-able），但是镜像中每一层文件系统都是只读的,构建镜像的时候，从一个最基本的操作系统开始，每个构建提交的操作都相当于做一层的修改，增加了一层文件系统，一层层往上叠加，上层的修改会覆盖底层该位置的可见性，这也很容易理解，就像上层把底层遮住了一样，当使用镜像的时候，我们只会看到一个完全的整体，不知道里面有几层,实际上也不需要知道里面有几层，结构如下:</p>
<p><img src="../../../../images/SRE/day46/18.jpg" alt="18"></p>
<p>一个典型的 Linux文件系统由 bootfs 和 rootfs 两部分组成</p>
<p>bootfs(boot file system) 主要包含bootloader和kernel，bootloader主要用于引导加载 kernel，Linux刚启动时会加载bootfs文件系统,当boot加载完成后,kernel 被加载到内存中后接管系统的控制权,bootfs会被 umount 掉</p>
<p>rootfs (root file system) 包含的就是典型 Linux 系统中的/dev，/proc，/bin，/etc 等标准目录和文件，不同的 linux 发行版（如 ubuntu 和 CentOS ) 主要在 rootfs 这一层会有所区别。</p>
<p>一般的镜像通常都比较小，官方提供的Ubuntu镜像只有60MB多点，而 CentOS 基础镜像也只有200MB左右，一些其他版本的镜像甚至只有几MB，比如: busybox 才1.22MB，alpine镜像也只有5M左右。镜像直接调用宿主机的内核，镜像中只提供 rootfs，也就是只需要包括最基本的命令,配置文件和程序库等相关文件就可以了。</p>
<p>下图就是有两个不同的镜像在一个宿主机内核上实现不同的rootfs。</p>
<p><img src="../../../../images/SRE/day46/19.jpg" alt="19"></p>
<p><strong>容器、镜像和父镜像关系:</strong></p>
<p><img src="../../../../images/SRE/day46/20.jpg" alt="20"></p>
<p>范例: 查看镜像的分层结构</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br></pre></td><td class="code"><pre><span class="line">[root@ubuntu1804 ~]<span class="comment"># docker pull nginx</span></span><br><span class="line">Using default tag: latest</span><br><span class="line">latest: Pulling from library/nginx</span><br><span class="line">6e909acdb790: Pull complete </span><br><span class="line">5eaa34f5b9c2: Pull complete </span><br><span class="line">417c4bccf534: Pull complete </span><br><span class="line">e7e0ca015e55: Pull complete </span><br><span class="line">373fe654e984: Pull complete </span><br><span class="line">97f5c0f51d43: Pull complete </span><br><span class="line">c22eb46e871a: Pull complete </span><br><span class="line">Digest: sha256:124b44bfc9ccd1f3cedf4b592d4d1e8bddb78b51ec2ed5056c52d3692baebc19</span><br><span class="line">Status: Downloaded newer image <span class="keyword">for</span> nginx:latest</span><br><span class="line">docker.io/library/nginx:latest</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#查看镜像分层历史</span></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment"># docker image history nginx</span></span><br><span class="line">IMAGE          CREATED        CREATED BY                                      SIZE      COMMENT</span><br><span class="line">53a18edff809   2 months ago   CMD [<span class="string">&quot;nginx&quot;</span> <span class="string">&quot;-g&quot;</span> <span class="string">&quot;daemon off;&quot;</span>]                0B        buildkit.dockerfile.v0</span><br><span class="line">&lt;missing&gt;      2 months ago   STOPSIGNAL SIGQUIT                              0B        buildkit.dockerfile.v0</span><br><span class="line">&lt;missing&gt;      2 months ago   EXPOSE map[80/tcp:&#123;&#125;]                           0B        buildkit.dockerfile.v0</span><br><span class="line">&lt;missing&gt;      2 months ago   ENTRYPOINT [<span class="string">&quot;/docker-entrypoint.sh&quot;</span>]            0B        buildkit.dockerfile.v0</span><br><span class="line">&lt;missing&gt;      2 months ago   COPY 30-tune-worker-processes.sh /docker-ent…   4.62kB    buildkit.dockerfile.v0</span><br><span class="line">&lt;missing&gt;      2 months ago   COPY 20-envsubst-on-templates.sh /docker-ent…   3.02kB    buildkit.dockerfile.v0</span><br><span class="line">&lt;missing&gt;      2 months ago   COPY 15-local-resolvers.envsh /docker-entryp…   389B      buildkit.dockerfile.v0</span><br><span class="line">&lt;missing&gt;      2 months ago   COPY 10-listen-on-ipv6-by-default.sh /docker…   2.12kB    buildkit.dockerfile.v0</span><br><span class="line">&lt;missing&gt;      2 months ago   COPY docker-entrypoint.sh / <span class="comment"># buildkit          1.62kB    buildkit.dockerfile.v0</span></span><br><span class="line">&lt;missing&gt;      2 months ago   RUN /bin/sh -c <span class="built_in">set</span> -x     &amp;&amp; groupadd --syst…   117MB     buildkit.dockerfile.v0</span><br><span class="line">&lt;missing&gt;      2 months ago   ENV DYNPKG_RELEASE=1~bookworm                   0B        buildkit.dockerfile.v0</span><br><span class="line">&lt;missing&gt;      2 months ago   ENV PKG_RELEASE=1~bookworm                      0B        buildkit.dockerfile.v0</span><br><span class="line">&lt;missing&gt;      2 months ago   ENV NJS_RELEASE=1~bookworm                      0B        buildkit.dockerfile.v0</span><br><span class="line">&lt;missing&gt;      2 months ago   ENV NJS_VERSION=0.8.9                           0B        buildkit.dockerfile.v0</span><br><span class="line">&lt;missing&gt;      2 months ago   ENV NGINX_VERSION=1.27.4                        0B        buildkit.dockerfile.v0</span><br><span class="line">&lt;missing&gt;      2 months ago   LABEL maintainer=NGINX Docker Maintainers &lt;d…   0B        buildkit.dockerfile.v0</span><br><span class="line">&lt;missing&gt;      2 months ago   <span class="comment"># debian.sh --arch &#x27;amd64&#x27; out/ &#x27;bookworm&#x27; &#x27;…   74.8MB    debuerreotype 0.15</span></span><br><span class="line"></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment"># docker inspect nginx</span></span><br><span class="line">[</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="string">&quot;Id&quot;</span>: <span class="string">&quot;sha256:53a18edff8091d5faff1e42b4d885bc5f0f897873b0b8f0ace236cd5930819b0&quot;</span>,</span><br><span class="line">        <span class="string">&quot;RepoTags&quot;</span>: [</span><br><span class="line">            <span class="string">&quot;nginx:latest&quot;</span></span><br><span class="line">        ],</span><br><span class="line">        <span class="string">&quot;RepoDigests&quot;</span>: [</span><br><span class="line">            <span class="string">&quot;nginx@sha256:124b44bfc9ccd1f3cedf4b592d4d1e8bddb78b51ec2ed5056c52d3692baebc19&quot;</span></span><br><span class="line">        ],</span><br><span class="line">        <span class="string">&quot;Parent&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">        <span class="string">&quot;Comment&quot;</span>: <span class="string">&quot;buildkit.dockerfile.v0&quot;</span>,</span><br><span class="line">        <span class="string">&quot;Created&quot;</span>: <span class="string">&quot;2025-02-05T21:27:16Z&quot;</span>,</span><br><span class="line">        <span class="string">&quot;DockerVersion&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">        <span class="string">&quot;Author&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">        <span class="string">&quot;Config&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;Hostname&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">            <span class="string">&quot;Domainname&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">            <span class="string">&quot;User&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">            <span class="string">&quot;AttachStdin&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">            <span class="string">&quot;AttachStdout&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">            <span class="string">&quot;AttachStderr&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">            <span class="string">&quot;ExposedPorts&quot;</span>: &#123;</span><br><span class="line">                <span class="string">&quot;80/tcp&quot;</span>: &#123;&#125;</span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="string">&quot;Tty&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">            <span class="string">&quot;OpenStdin&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">            <span class="string">&quot;StdinOnce&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">            <span class="string">&quot;Env&quot;</span>: [</span><br><span class="line">                <span class="string">&quot;PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin&quot;</span>,</span><br><span class="line">                <span class="string">&quot;NGINX_VERSION=1.27.4&quot;</span>,</span><br><span class="line">                <span class="string">&quot;NJS_VERSION=0.8.9&quot;</span>,</span><br><span class="line">                <span class="string">&quot;NJS_RELEASE=1~bookworm&quot;</span>,</span><br><span class="line">                <span class="string">&quot;PKG_RELEASE=1~bookworm&quot;</span>,</span><br><span class="line">                <span class="string">&quot;DYNPKG_RELEASE=1~bookworm&quot;</span></span><br><span class="line">            ],</span><br><span class="line">            <span class="string">&quot;Cmd&quot;</span>: [</span><br><span class="line">                <span class="string">&quot;nginx&quot;</span>,</span><br><span class="line">                <span class="string">&quot;-g&quot;</span>,</span><br><span class="line">                <span class="string">&quot;daemon off;&quot;</span></span><br><span class="line">            ],</span><br><span class="line">            <span class="string">&quot;Image&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">            <span class="string">&quot;Volumes&quot;</span>: null,</span><br><span class="line">            <span class="string">&quot;WorkingDir&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">            <span class="string">&quot;Entrypoint&quot;</span>: [</span><br><span class="line">                <span class="string">&quot;/docker-entrypoint.sh&quot;</span></span><br><span class="line">            ],</span><br><span class="line">            <span class="string">&quot;OnBuild&quot;</span>: null,</span><br><span class="line">            <span class="string">&quot;Labels&quot;</span>: &#123;</span><br><span class="line">                <span class="string">&quot;maintainer&quot;</span>: <span class="string">&quot;NGINX Docker Maintainers &lt;docker-maint@nginx.com&gt;&quot;</span></span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="string">&quot;StopSignal&quot;</span>: <span class="string">&quot;SIGQUIT&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">&quot;Architecture&quot;</span>: <span class="string">&quot;amd64&quot;</span>,</span><br><span class="line">        <span class="string">&quot;Os&quot;</span>: <span class="string">&quot;linux&quot;</span>,</span><br><span class="line">        <span class="string">&quot;Size&quot;</span>: 192004242,</span><br><span class="line">        <span class="string">&quot;GraphDriver&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;Data&quot;</span>: &#123;</span><br><span class="line">                <span class="string">&quot;LowerDir&quot;</span>: <span class="string">&quot;/var/lib/docker/overlay2/7aa5619fb13336c1c67cd7588653a68b6412bf4d73c3909af5ff7be664e7a95d/diff:/var/lib/docker/overlay2/81ed2cec722ec310e32e8032a03ea7072b5773b4f7cafb34407170f8a3122cf6/diff:/var/lib/docker/overlay2/ebc78063335a2b83f75456cf7dfe02e77ef1f99004adeee38d7f265574f88616/diff:/var/lib/docker/overlay2/b8ad0e4caf8900050d73217dd80fcec67140d5d4de83e36d89437800d0d4947f/diff:/var/lib/docker/overlay2/6c43d1009f3e35653277132cde4ab4fe92e18cf7951223722c4ccc846bc6cbe3/diff:/var/lib/docker/overlay2/c8e2efbf3fc876783f1bcc80fb5cf73d1af097a4ab09484b6c45527b74c7861f/diff&quot;</span>,</span><br><span class="line">                <span class="string">&quot;MergedDir&quot;</span>: <span class="string">&quot;/var/lib/docker/overlay2/3cc13c6e69f8dab680ad2d891cc6e4c59110921c51b478bdb9e2eccbff9069b9/merged&quot;</span>,</span><br><span class="line">                <span class="string">&quot;UpperDir&quot;</span>: <span class="string">&quot;/var/lib/docker/overlay2/3cc13c6e69f8dab680ad2d891cc6e4c59110921c51b478bdb9e2eccbff9069b9/diff&quot;</span>,</span><br><span class="line">                <span class="string">&quot;WorkDir&quot;</span>: <span class="string">&quot;/var/lib/docker/overlay2/3cc13c6e69f8dab680ad2d891cc6e4c59110921c51b478bdb9e2eccbff9069b9/work&quot;</span></span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="string">&quot;Name&quot;</span>: <span class="string">&quot;overlay2&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">&quot;RootFS&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;Type&quot;</span>: <span class="string">&quot;layers&quot;</span>,</span><br><span class="line">            <span class="string">&quot;Layers&quot;</span>: [</span><br><span class="line">                <span class="string">&quot;sha256:1287fbecdfcce6ee8cf2436e5b9e9d86a4648db2d91080377d499737f1b307f3&quot;</span>,</span><br><span class="line">                <span class="string">&quot;sha256:135f786ad04647c6e58d9a2d4f6f87bd677ef6144ab24c81a6f5be7acc63fbc9&quot;</span>,</span><br><span class="line">                <span class="string">&quot;sha256:ad2f08e39a9de1e12157c800bd31ba86f8cc222eedec11e8e072c3ba608d26fb&quot;</span>,</span><br><span class="line">                <span class="string">&quot;sha256:d98dcc720ae098efb91563f0a9abe03de50b403f7aa6c6f0e1dfb8297aedb61f&quot;</span>,</span><br><span class="line">                <span class="string">&quot;sha256:aa82c57cd9fe730130e35d42c6b26a4a9d3c858f61c23f63d53b703abf30adf8&quot;</span>,</span><br><span class="line">                <span class="string">&quot;sha256:d26dc06ef910f67b1b2bcbcc6318e2e08881011abc7ad40fd859f38641ab105c&quot;</span>,</span><br><span class="line">                <span class="string">&quot;sha256:03d9365bc5dc9ec8b2f032927d3d3ae10b840252c86cf245a63b713d50eaa2fd&quot;</span></span><br><span class="line">            ]</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">&quot;Metadata&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;LastTagTime&quot;</span>: <span class="string">&quot;0001-01-01T00:00:00Z&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment"># docker save nginx -o nginx.tar</span></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment"># docker images</span></span><br><span class="line">REPOSITORY   TAG       IMAGE ID       CREATED        SIZE</span><br><span class="line">alpine       latest    aded1e1a5b37   7 weeks ago    7.83MB</span><br><span class="line">nginx        latest    53a18edff809   2 months ago   192MB</span><br><span class="line"></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment"># ll -h nginx.tar</span></span><br><span class="line">-rw------- 1 root root 131M Jul 20 22:33 nginx.tar</span><br><span class="line"></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment"># tar xf nginx.tar -C /data</span></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment"># ll /data</span></span><br><span class="line">total 60</span><br><span class="line">drwxr-xr-x  8 root root  4096 Jul 20 22:34 ./</span><br><span class="line">drwxr-xr-x 24 root root  4096 Jul 20 16:23 ../</span><br><span class="line">-rw-r--r--  1 root root  7510 Jul 11 04:26 0901fa9da894a8e9de5cb26d6749eaffb67b373dc1ff8a26c46b23b1175c913a.json</span><br><span class="line">drwxr-xr-x  2 root root  4096 Jul 11 04:26 0bb74fcd4b686412f7993916e58c26abd155fa10b10a4dc09a778e7c324c39a2/</span><br><span class="line">drwxr-xr-x  2 root root  4096 Jul 11 04:26 517e3239147277447b60191907bc66168963e0ce8707a6a33532f7c63a0d2f12/</span><br><span class="line">drwxr-xr-x  2 root root  4096 Jul 11 04:26 68c9e9da52d5a57ee196829ce4a461cc9425b0b920689da9ad547f1da13dbc9d/</span><br><span class="line">drwxr-xr-x  2 root root  4096 Jul 11 04:26 d2cf0fc540bb3be33ee7340498c41fd4fc82c6bb02b9955fca2109e599301dbd/</span><br><span class="line">drwxr-xr-x  2 root root  4096 Jul 11 04:26 f4bf863ecdbb8bddb4b3bb271bdd97b067dcb6c95c56f720018abec6af190c6e/</span><br><span class="line">drwx------  2 root root 16384 Mar 18 09:49 lost+found/</span><br><span class="line">-rw-r--r--  1 root root 509 Jan  1  1970 manifest.json</span><br><span class="line">-rw-r--r--  1 root root  88 Jan  1  1970 repositories</span><br><span class="line"></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment"># cat /data/manifest.json</span></span><br><span class="line">[&#123;<span class="string">&quot;Config&quot;</span>:<span class="string">&quot;0901fa9da894a8e9de5cb26d6749eaffb67b373dc1ff8a26c46b23b1175c913a.json&quot;</span>,<span class="string">&quot;RepoTags&quot;</span>:[<span class="string">&quot;nginx:latest&quot;</span>],<span class="string">&quot;Layers&quot;</span>:</span><br><span class="line">[<span class="string">&quot;d2cf0fc540bb3be33ee7340498c41fd4fc82c6bb02b9955fca2109e599301dbd/layer.tar&quot;</span>,<span class="string">&quot;f</span></span><br><span class="line"><span class="string">4bf863ecdbb8bddb4b3bb271bdd97b067dcb6c95c56f720018abec6af190c6e/layer.tar&quot;</span>,<span class="string">&quot;517e</span></span><br><span class="line"><span class="string">3239147277447b60191907bc66168963e0ce8707a6a33532f7c63a0d2f12/layer.tar&quot;</span>,<span class="string">&quot;0bb74fc</span></span><br><span class="line"><span class="string">d4b686412f7993916e58c26abd155fa10b10a4dc09a778e7c324c39a2/layer.tar&quot;</span>,<span class="string">&quot;68c9e9da52</span></span><br><span class="line"><span class="string">d5a57ee196829ce4a461cc9425b0b920689da9ad547f1da13dbc9d/layer.tar&quot;</span>]&#125;]</span><br><span class="line"></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment"># du -sh /data/*</span></span><br><span class="line">8.0K /data/0901fa9da894a8e9de5cb26d6749eaffb67b373dc1ff8a26c46b23b1175c913a.json</span><br><span class="line">16K /data/0bb74fcd4b686412f7993916e58c26abd155fa10b10a4dc09a778e7c324c39a2</span><br><span class="line">16K /data/517e3239147277447b60191907bc66168963e0ce8707a6a33532f7c63a0d2f12</span><br><span class="line">16K /data/68c9e9da52d5a57ee196829ce4a461cc9425b0b920689da9ad547f1da13dbc9d</span><br><span class="line">70M /data/d2cf0fc540bb3be33ee7340498c41fd4fc82c6bb02b9955fca2109e599301dbd</span><br><span class="line">62M /data/f4bf863ecdbb8bddb4b3bb271bdd97b067dcb6c95c56f720018abec6af190c6e</span><br><span class="line">16K /data/lost+found</span><br><span class="line">4.0K /data/manifest.json</span><br><span class="line">4.0K /data/repositories</span><br><span class="line"></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment"># cd /data/d2cf0fc540bb3be33ee7340498c41fd4fc82c6bb02b9955fca2109e599301dbd/</span></span><br><span class="line">[root@ubuntu1804 d2cf0fc540bb3be33ee7340498c41fd4fc82c6bb02b9955fca2109e599301dbd]<span class="comment"># ls</span></span><br><span class="line">json layer.tar VERSION</span><br><span class="line"></span><br><span class="line">[root@ubuntu1804 d2cf0fc540bb3be33ee7340498c41fd4fc82c6bb02b9955fca2109e599301dbd]<span class="comment"># tar xf layer.tar</span></span><br><span class="line">[root@ubuntu1804 d2cf0fc540bb3be33ee7340498c41fd4fc82c6bb02b9955fca2109e599301dbd]<span class="comment"># ls</span></span><br><span class="line">bin dev home layer.tar lib64 mnt proc run srv tmp var</span><br><span class="line">boot etc json lib media opt root sbin sys usr VERSION</span><br><span class="line"></span><br><span class="line">[root@ubuntu1804 d2cf0fc540bb3be33ee7340498c41fd4fc82c6bb02b9955fca2109e599301dbd]<span class="comment"># cat etc/i</span></span><br><span class="line">init.d/ issue issue.net</span><br><span class="line"></span><br><span class="line">[root@ubuntu1804 d2cf0fc540bb3be33ee7340498c41fd4fc82c6bb02b9955fca2109e599301dbd]<span class="comment"># cat etc/issue</span></span><br><span class="line">Debian GNU/Linux 10 \n \l</span><br></pre></td></tr></table></figure>

<h3 id="搜索镜像"><a href="#搜索镜像" class="headerlink" title="搜索镜像"></a>搜索镜像</h3><h4 id="搜索镜像-1"><a href="#搜索镜像-1" class="headerlink" title="搜索镜像"></a>搜索镜像</h4><h5 id="官方网站进行镜像的搜索"><a href="#官方网站进行镜像的搜索" class="headerlink" title="官方网站进行镜像的搜索"></a>官方网站进行镜像的搜索</h5><p>官网:</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">http://hub.docker.com</span><br><span class="line">http://dockerhub.com</span><br></pre></td></tr></table></figure>
<p><img src="../../../../images/SRE/day46/21.jpg" alt="21"></p>
<p><img src="../../../../images/SRE/day46/22.jpg" alt="22"></p>
<p>在官方的docker 仓库中搜索指定名称的docker镜像，也会有很多三方镜像。</p>
<h5 id="执行docker-search命令进行搜索"><a href="#执行docker-search命令进行搜索" class="headerlink" title="执行docker search命令进行搜索"></a>执行docker search命令进行搜索</h5><p>格式如下:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">Usage: docker search [OPTIONS] TERM</span><br><span class="line">Options:</span><br><span class="line">  -f, --filter filter   Filter output based on conditions provided</span><br><span class="line">      --format string   Pretty-<span class="built_in">print</span> search using a Go template</span><br><span class="line">      --<span class="built_in">limit</span> int       Max number of search results (default 25)</span><br><span class="line">      --no-trunc       Don<span class="string">&#x27;t truncate output</span></span><br><span class="line"><span class="string">      </span></span><br><span class="line"><span class="string">说明:  </span></span><br><span class="line"><span class="string">OFFICIAL: 官方</span></span><br><span class="line"><span class="string">AUTOMATED: 使用第三方docker服务来帮助编译镜像，可以在互联网上面直接拉取到镜像，减少了繁琐的编译过程</span></span><br></pre></td></tr></table></figure>

<p>范例: </p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@ubuntu1804 ~]<span class="comment"># docker search centos</span></span><br><span class="line">......</span><br></pre></td></tr></table></figure>

<p>范例: 选择性的查找镜像</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#搜索点赞 100 个以上的镜像</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#旧语法</span></span><br><span class="line"></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment"># docker search -s 100 centos</span></span><br><span class="line">Flag --stars has been deprecated, use --filter=stars=3 instead</span><br><span class="line">......</span><br><span class="line"></span><br><span class="line"><span class="comment">#新语法</span></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment"># docker search --filter=stars=100 centos</span></span><br></pre></td></tr></table></figure>

<h4 id="alpine-介绍"><a href="#alpine-介绍" class="headerlink" title="alpine 介绍"></a>alpine 介绍</h4><p><img src="../../../../images/SRE/day46/23.jpg" alt="23"></p>
<p>Alpine 操作系统是一个面向安全的轻型 Linux 发行版。它不同于通常 Linux 发行版，Alpine 采用了musl libc 和 busybox 以减小系统的体积和运行时资源消耗，但功能上比 busybox 又完善的多，因此得到开源社区越来越多的青睐。在保持瘦身的同时，Alpine 还提供了自己的包管理工具 apk，可以通过 <a target="_blank" rel="noopener" href="https://pkgs.alpinelinux.org/packages">https://pkgs.alpinelinux.org/packages</a> 网站上查询包信息，也可以直接通过 apk 命令直接查询和安装各种软件。</p>
<p>Alpine 由非商业组织维护的，支持广泛场景的 Linux发行版，它特别为资深/重度Linux用户而优化，关注安全，性能和资源效能。Alpine 镜像可以适用于更多常用场景，并且是一个优秀的可以适用于生产的基础系统/环境。</p>
<p>Alpine Docker 镜像也继承了 Alpine Linux 发行版的这些优势。相比于其他 Docker 镜像，它的容量非常小，仅仅只有 5 MB 左右（对比 Ubuntu 系列镜像接近 200 MB），且拥有非常友好的包管理机制。官方镜像来自 docker-alpine 项目。</p>
<p>目前 Docker 官方已开始推荐使用 Alpine 替代之前的 Ubuntu 做为基础镜像环境。这样会带来多个好处。包括镜像下载速度加快，镜像安全性提高，主机之间的切换更方便，占用更少磁盘空间等。</p>
<p>下表是官方镜像的大小比较:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">REPOSITORY  TAG       IMAGE ID      VIRTUAL SIZE</span><br><span class="line"></span><br><span class="line">alpine      latest    4e38e38c8ce0  4.799 MB</span><br><span class="line">debian      latest    4d6ce913b130  84.98 MB</span><br><span class="line">ubuntu      latest    b39b81afc8ca  188.3 MB</span><br><span class="line">centos      latest    8efe422e6104  210 MB</span><br></pre></td></tr></table></figure>

<ul>
<li>Alpine 官网: <a target="_blank" rel="noopener" href="https://www.alpinelinux.org/">https://www.alpinelinux.org/</a></li>
<li>Alpine 官方仓库: <a target="_blank" rel="noopener" href="https://github.com/alpinelinux">https://github.com/alpinelinux</a></li>
<li>Alpine 官方镜像: <a target="_blank" rel="noopener" href="https://hub.docker.com/_/alpine/">https://hub.docker.com/_/alpine/</a></li>
<li>Alpine 官方镜像仓库: <a target="_blank" rel="noopener" href="https://github.com/gliderlabs/docker-alpine">https://github.com/gliderlabs/docker-alpine</a></li>
<li>Alpine 阿里云的镜像仓库: <a target="_blank" rel="noopener" href="https://mirrors.aliyun.com/alpine/">https://mirrors.aliyun.com/alpine/</a></li>
</ul>
<p>范例: alpine管理软件</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#修改源替换成阿里源，将里面 dl-cdn.alpinelinux.org 的 改成 mirrors.aliyun.com</span></span><br><span class="line">vi /etc/apk/repositories</span><br><span class="line">http://mirrors.aliyun.com/alpine/v3.8/main/</span><br><span class="line">http://mirrors.aliyun.com/alpine/v3.8/community/</span><br><span class="line"></span><br><span class="line"><span class="comment">#更新源</span></span><br><span class="line">apk update</span><br><span class="line"></span><br><span class="line"><span class="comment">#安装软件</span></span><br><span class="line">apk add vim</span><br><span class="line"></span><br><span class="line"><span class="comment">#删除软件</span></span><br><span class="line">apk del openssh openntp vim</span><br></pre></td></tr></table></figure>

<p>范例:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">/ <span class="comment"># apk --help</span></span><br><span class="line">/ <span class="comment"># apk add nginx</span></span><br><span class="line">/ <span class="comment"># apk info nginx</span></span><br><span class="line">nginx-1.16.1-r6 description:</span><br><span class="line">HTTP and reverse proxy server (stable version)</span><br><span class="line"></span><br><span class="line">nginx-1.16.1-r6 webpage:</span><br><span class="line">https://www.nginx.org/</span><br><span class="line"></span><br><span class="line">nginx-1.16.1-r6 installed size:</span><br><span class="line">1126400</span><br><span class="line"></span><br><span class="line">~ <span class="comment"># apk manifest nginx</span></span><br><span class="line">sha1:d21a96358a10b731f8847e6d32799efdc2a7f421 etc/logrotate.d/nginx</span><br><span class="line">sha1:50bd6d3b4f3e6b577d852f12cd6939719d2c2db5 etc/init.d/nginx</span><br><span class="line">sha1:379c1e2a2a5ffb8c91a07328d4c9be2bc58799fd etc/nginx/scgi_params</span><br><span class="line">sha1:da38e2a0dded838afbe0eade6cb837ac30fd8046 etc/nginx/fastcgi_params</span><br><span class="line">sha1:cc2fcdb4605dcac23d59f667889ccbdfdc6e3668 etc/nginx/uwsgi_params</span><br><span class="line">sha1:cbf596ddb3433a8e0d325f3c188bec9c1bb746b3 etc/nginx/fastcgi.conf</span><br><span class="line">sha1:e39dbc36680b717ec902fadc805a302f1cf62245 etc/nginx/mime.types</span><br><span class="line">sha1:e9dddf20f1196bb67eef28107438b60c4060f4d3 etc/nginx/nginx.conf</span><br><span class="line">sha1:7b2a4da1a14166442c10cbf9e357fa9fb53542ca etc/nginx/conf.d/default.conf</span><br><span class="line">sha1:cd7f5dc8ccdc838a2d0107511c90adfe318a81e7 etc/conf.d/nginx</span><br><span class="line">sha1:05f050f6ed86c5e6b48c2d2328e81583315431be usr/sbin/nginx</span><br><span class="line">sha1:c3f02ca81f7f2c6bde3f878b3176f225c7781c7d var/lib/nginx/modules</span><br><span class="line">sha1:0510312d465b86769136983657df98c1854f0b60 var/lib/nginx/run</span><br><span class="line">sha1:35db17c18ce0b9f84a3cc113c8a9e94e19f632b1 var/lib/nginx/logs</span><br><span class="line">sha1:7dd71afcfb14e105e80b0c0d7fce370a28a41f0a var/lib/nginx/html/index.html</span><br><span class="line">sha1:95de71d58b37f9f74bede0e91bc381d6059fc2d7 var/lib/nginx/html/50x.html</span><br><span class="line"></span><br><span class="line">~ <span class="comment"># ls -l /bin</span></span><br><span class="line">total 824</span><br><span class="line">lrwxrwxrwx  1 root root  12 Jan 16 21:52 <span class="built_in">arch</span> -&gt; /bin/busybox</span><br><span class="line">lrwxrwxrwx  1 root root  12 Jan 16 21:52 ash -&gt; /bin/busybox</span><br><span class="line">lrwxrwxrwx  1 root root  12 Jan 16 21:52 <span class="built_in">base64</span> -&gt; /bin/busybox</span><br><span class="line">lrwxrwxrwx  1 root root  12 Jan 16 21:52 bbconfig -&gt; /bin/busybox</span><br><span class="line">-rwxr-xr-x  1 root root 841288 Jan 15 10:36 busybox</span><br><span class="line">lrwxrwxrwx  1 root root  12 Jan 16 21:52 <span class="built_in">cat</span> -&gt; /bin/busybox</span><br><span class="line">lrwxrwxrwx  1 root root  12 Jan 16 21:52 <span class="built_in">chgrp</span> -&gt; /bin/busybox</span><br><span class="line">lrwxrwxrwx  1 root root  12 Jan 16 21:52 <span class="built_in">chmod</span> -&gt; /bin/busybox</span><br><span class="line">lrwxrwxrwx  1 root root  12 Jan 16 21:52 <span class="built_in">chown</span> -&gt; /bin/busybox</span><br></pre></td></tr></table></figure>

<h4 id="Debian-ubuntu-系统建议安装的基础包"><a href="#Debian-ubuntu-系统建议安装的基础包" class="headerlink" title="Debian(ubuntu)系统建议安装的基础包"></a>Debian(ubuntu)系统建议安装的基础包</h4><p>在很多软件官方提供的镜像都使用的是Debian(ubuntu)的系统,比如:nginx,tomcat,mysql,httpd 等,但镜像内缺少很多常用的调试工具.当需要进入容器内进行调试管理时,可以安装以下常用工具包</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># apt update #安装软件前需要先更新索引</span></span><br><span class="line"><span class="comment"># apt install procps #提供top,ps,free等命令</span></span><br><span class="line"><span class="comment"># apt install psmisc #提供pstree,killall等命令</span></span><br><span class="line"><span class="comment"># apt install iputils-ping #提供ping命令</span></span><br><span class="line"><span class="comment"># apt install net-tools #提供netstat网络工具等</span></span><br></pre></td></tr></table></figure>

<h3 id="下载镜像"><a href="#下载镜像" class="headerlink" title="下载镜像"></a>下载镜像</h3><p>从 docker 仓库将镜像下载到本地，命令格式如下:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">docker pull [OPTIONS] NAME[:TAG|@DIGEST]</span><br><span class="line">Options:</span><br><span class="line">    -a, --all-tags Download all tagged images <span class="keyword">in</span> the repository</span><br><span class="line">    --disable-content-trust Skip image verification (default <span class="literal">true</span>)</span><br><span class="line">    --platform string Set platform <span class="keyword">if</span> server is multi-platform capable</span><br><span class="line">    -q, --quiet Suppress verbose output</span><br><span class="line"></span><br><span class="line">NAME: 是镜像名,一般的形式 仓库服务器:端口/项目名称/镜像名称</span><br><span class="line">:TAG: 即版本号,如果不指定:TAG,则下载最新版镜像</span><br></pre></td></tr></table></figure>

<p><strong>镜像下载说明</strong></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@ubuntu1804 ~]<span class="comment"># docker pull hello-world</span></span><br><span class="line">Using default tag: latest <span class="comment">#默认下载最新版本</span></span><br><span class="line">latest: Pulling from library/hello-world</span><br><span class="line">1b930d010525: Pull complete  <span class="comment">#分层下载</span></span><br><span class="line">Digest: sha256:9572f7cdcee8591948c2963463447a53466950b3fc15a247fcad1917ca215a2f</span><br><span class="line"><span class="comment">#摘要</span></span><br><span class="line">Status: Downloaded newer image <span class="keyword">for</span> hello-world:latest</span><br><span class="line">docker.io/library/hello-world:latest  <span class="comment">#下载的完整地址</span></span><br></pre></td></tr></table></figure>

<p>镜像下载保存的路径:</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/var/lib/docker/overlay2/镜像ID</span><br></pre></td></tr></table></figure>

<p>注意: 镜像下载完成后，会自动解压缩，比官网显示的可能会大很多，如: centos8.1.1911下载时只有70MB，下载完后显示237MB</p>
<p>范例: 从docker官网下载镜像</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">docker pull hello-world</span><br><span class="line">docker pull alpine</span><br><span class="line">docker pull busybox</span><br><span class="line">docker pull nginx</span><br><span class="line">docker pull centos</span><br><span class="line">docker pull centos:centos7.7.1908</span><br><span class="line">docker pull docker.io/library/mysql:5.7.30</span><br><span class="line">docker pull mysql:5.6.47</span><br></pre></td></tr></table></figure>

<p>范例: 下载镜像 alpine,busybox等镜像,查看下载的存放目录</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">[root@ubuntu1804 ~]<span class="comment"># ls /var/lib/docker/overlay2/</span></span><br><span class="line">1</span><br><span class="line">[root@ubuntu1804 ~]<span class="comment"># du -sh /var/lib/docker/overlay2</span></span><br><span class="line">8.0K /var/lib/docker/overlay2</span><br><span class="line"></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment"># ls /var/lib/docker/overlay2/1</span></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment"># docker pull hello-world</span></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment"># docker pull alpine:3.11.3</span></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment"># docker pull busybox</span></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment"># docker pull centos:centos8.1.1911</span></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment"># du -sh /var/lib/docker/overlay2/*</span></span><br><span class="line">5.9M  /var/lib/docker/overlay2/1802616f4c8e0a0b52c839431b6faa8ac21f4bd831548dcbd46943d3f60061fa</span><br><span class="line">16K  /var/lib/docker/overlay2/5773b92e1351da5e589d0573d9f22d1ec3be1e0e98edbfcddba4b830f12c7be2</span><br><span class="line">1.3M  /var/lib/docker/overlay2/de31641b8d2207de7f08eabb5240474a1aaccfef08b6034dcee02b9623f8d9dc</span><br><span class="line">252M  /var/lib/docker/overlay2/f41df336075611f9e358e5eaf2ebd5089920a90ba68760cdec8da03edff362f7</span><br><span class="line">20K  /var/lib/docker/overlay2/l</span><br><span class="line"></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment"># docker images</span></span><br><span class="line">REPOSITORY TAG IMAGE ID CREATED SIZE</span><br><span class="line">alpine  3.11.3 e7d92cdc71fe  7 days ago  5.59MB</span><br><span class="line">centos centos8.1.1911 470671670cac  7 days ago 237MB</span><br><span class="line">busybox latest 6d5fcfe5ff17  4 weeks ago 1.22MB</span><br><span class="line">hello-world latest fce289e99eb9  12 months ago 1.84kB</span><br><span class="line"></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment"># ls -l /var/lib/docker/overlay2/l</span></span><br><span class="line">total 16</span><br><span class="line">lrwxrwxrwx 1 root root 72 Jan 25 19:51 C5ZTDYHYDTO7BQG6HX36MU6X5K -&gt; ../de31641b8d2207de7f08eabb5240474a1aaccfef08b6034dcee02b9623f8d9dc/diff</span><br><span class="line">lrwxrwxrwx 1 root root 72 Jan 25 19:57 DEXHVNUGFLFJCSJAKISOHQG7JY -&gt; ../f41df336075611f9e358e5eaf2ebd5089920a90ba68760cdec8da03edff362f7/diff</span><br><span class="line">lrwxrwxrwx 1 root root 72 Jan 25 19:51 KJ5IA5AUHFUEQXFKJA7UDUIA7A -&gt; ../1802616f4c8e0a0b52c839431b6faa8ac21f4bd831548dcbd46943d3f60061fa/diff</span><br><span class="line">lrwxrwxrwx 1 root root 72 Jan 25 19:51 ZM3U4WDNHGJJX5DXHA5M4ZWAIW -&gt; ../5773b92e1351da5e589d0573d9f22d1ec3be1e0e98edbfcddba4b830f12c7be2/diff</span><br></pre></td></tr></table></figure>

<p>范例: 指定 TAG下载特定版本的镜像</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@ubuntu1804 ~]<span class="comment"># docker pull docker.io/library/mysql:5.7.30</span></span><br><span class="line"></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment"># docker pull mysql:5.6.47</span></span><br></pre></td></tr></table></figure>

<p>范例: 指定DIGEST下载特定版本的镜像</p>
<p>先到 hub.docker.com查到指定版本的DIGEST</p>
<p><img src="../../../../images/SRE/day46/24.jpg" alt="24"></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[root@ubuntu1804 ~]<span class="comment"># docker pull alpine@sha256:156f59dc1cbe233827642e09ed06e259ef6fa1ca9b2e29d52ae14d5e7b79d7f0</span></span><br><span class="line">sha256:156f59dc1cbe233827642e09ed06e259ef6fa1ca9b2e29d52ae14d5e7b79d7f0: Pulling</span><br><span class="line">from library/alpine</span><br><span class="line">5d2415897100: Pull complete</span><br><span class="line">Digest: sha256:156f59dc1cbe233827642e09ed06e259ef6fa1ca9b2e29d52ae14d5e7b79d7f0</span><br><span class="line">Status: Downloaded newer image <span class="keyword">for</span></span><br><span class="line">alpine@sha256:156f59dc1cbe233827642e09ed06e259ef6fa1ca9b2e29d52ae14d5e7b79d7f0</span><br><span class="line">docker.io/library/alpine@sha256:156f59dc1cbe233827642e09ed06e259ef6fa1ca9b2e29d5</span><br><span class="line">2ae14d5e7b79d7f0</span><br><span class="line"></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment"># docker images</span></span><br><span class="line">REPOSITORY TAG IMAGE ID CREATED SIZE</span><br><span class="line">alpine &lt;none&gt; 3c791e92a856  3 weeks ago 5.57MB</span><br></pre></td></tr></table></figure>

<h3 id="镜像加速配置和优化"><a href="#镜像加速配置和优化" class="headerlink" title="镜像加速配置和优化"></a>镜像加速配置和优化</h3><p>docker 镜像官方的下载站点是: <a target="_blank" rel="noopener" href="https://hub.docker.com/">https://hub.docker.com/</a></p>
<p><img src="../../../../images/SRE/day46/25.jpg" alt="25"></p>
<p>从国内下载官方的镜像站点有时候会很慢，因此可以更改docker配置文件添加一个加速器，可以通过加速器达到加速下载镜像的目的</p>
<p>国内有许多公司都提供了docker 加速镜像，比如: 阿里云，腾讯云，网易云，以下以阿里云为例</p>
<h4 id="阿里云获取加速地址"><a href="#阿里云获取加速地址" class="headerlink" title="阿里云获取加速地址"></a>阿里云获取加速地址</h4><p>浏览器打开<a target="_blank" rel="noopener" href="http://cr.console.aliyun.com,注册或登录阿里云账号,点击左侧的镜像加速器,将会得到一个专属的加速地址,而且下面有使用配置说明/">http://cr.console.aliyun.com，注册或登录阿里云账号，点击左侧的镜像加速器，将会得到一个专属的加速地址，而且下面有使用配置说明</a>:</p>
<p><img src="../../../../images/SRE/day46/26.jpg" alt="26"></p>
<h4 id="docker-镜像加速配置"><a href="#docker-镜像加速配置" class="headerlink" title="docker 镜像加速配置"></a>docker 镜像加速配置</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">1. 安装／升级Docker客户端</span><br><span class="line">推荐安装1.10.0以上版本的Docker客户端，参考文档 docker-ce</span><br><span class="line"></span><br><span class="line">2. 配置镜像加速器</span><br><span class="line">修改daemon配置文件/etc/docker/daemon.json来使用加速器</span><br><span class="line"></span><br><span class="line"><span class="built_in">mkdir</span> -p /etc/docker</span><br><span class="line"></span><br><span class="line"><span class="comment">#因为政策，国内封了dockerhub，以下时可用的镜像加速地址</span></span><br><span class="line">sudo <span class="built_in">tee</span> /etc/docker/daemon.json &lt;&lt;-<span class="string">&#x27;EOF&#x27;</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;registry-mirrors&quot;</span>: [</span><br><span class="line">     <span class="string">&quot;https://docker.m.daocloud.io&quot;</span>,</span><br><span class="line">     <span class="string">&quot;https://docker.imgdb.de&quot;</span>,</span><br><span class="line">     <span class="string">&quot;https://docker-0.unsee.tech&quot;</span>,</span><br><span class="line">     <span class="string">&quot;https://docker.hlmirror.com&quot;</span>,</span><br><span class="line">     <span class="string">&quot;https://docker.1ms.run&quot;</span>,</span><br><span class="line">     <span class="string">&quot;https://func.ink&quot;</span>,</span><br><span class="line">     <span class="string">&quot;https://lispy.org&quot;</span>,</span><br><span class="line">     <span class="string">&quot;https://docker.xiaogenban1993.com&quot;</span></span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"><span class="comment">#网易云: http://hub-mirror.c.163.com/</span></span><br><span class="line"><span class="comment">#中科大: https://docker.mirrors.ustc.edu.cn</span></span><br><span class="line"><span class="comment">#腾讯云: https://mirror.ccs.tencentyun.com</span></span><br><span class="line"><span class="comment">#七牛云: https://reg-mirror.qiniu.com</span></span><br><span class="line"></span><br><span class="line">systemctl daemon-reload</span><br><span class="line">systemctl restart docker</span><br></pre></td></tr></table></figure>

<p>范例: 利用阿里云实现镜像加速</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">[root@ubuntu1804 ~]<span class="comment"># docker info |tail</span></span><br><span class="line">WARNING: the overlay storage-driver is deprecated, and will be removed <span class="keyword">in</span> a future release.</span><br><span class="line">  ID: IZHJ:WPIN:BRMC:XQUI:VVVR:UVGK:NZBM:YQXT:JDWB:33RS:45V7:SQWJ</span><br><span class="line">  Docker Root Dir: /var/lib/docker</span><br><span class="line">  Debug Mode: <span class="literal">false</span></span><br><span class="line">  Registry: https://index.docker.io/v1/</span><br><span class="line">  Labels:</span><br><span class="line">  Experimental: <span class="literal">false</span></span><br><span class="line">  Insecure Registries:</span><br><span class="line">    127.0.0.0/8</span><br><span class="line">  Live Restore Enabled: <span class="literal">false</span></span><br><span class="line"></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment"># vim /etc/docker/daemon.json</span></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment"># cat /etc/docker/daemon.json</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;storage-driver&quot;</span>: <span class="string">&quot;overlay&quot;</span>,</span><br><span class="line">  <span class="string">&quot;registry-mirrors&quot;</span>: [<span class="string">&quot;https://si7y70hh.mirror.aliyuncs.com&quot;</span>]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment"># systemctl daemon-reload</span></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment"># systemctl restart docker</span></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment"># docker info |tail</span></span><br><span class="line">WARNING: the overlay storage-driver is deprecated, and will be removed <span class="keyword">in</span> a future release.</span><br><span class="line">  Debug Mode: <span class="literal">false</span></span><br><span class="line">  Registry: https://index.docker.io/v1/</span><br><span class="line">  Labels:</span><br><span class="line">  Experimental: <span class="literal">false</span></span><br><span class="line">  Insecure Registries:</span><br><span class="line">    127.0.0.0/8</span><br><span class="line">  Registry Mirrors:</span><br><span class="line">    https://si7y70hh.mirror.aliyuncs.com/</span><br><span class="line">  Live Restore Enabled: <span class="literal">false</span></span><br></pre></td></tr></table></figure>

<p>范例： 镜像加速器</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[root@ubuntu1804 ~]<span class="comment"># vim /etc/docker/daemon.json</span></span><br><span class="line">&#123;</span><br><span class="line"> <span class="string">&quot;registry-mirrors&quot;</span> : [</span><br><span class="line"> <span class="string">&quot;http://registry.docker-cn.com&quot;</span>,</span><br><span class="line"> <span class="string">&quot;http://docker.mirrors.ustc.edu.cn&quot;</span>,</span><br><span class="line"> <span class="string">&quot;http://hub-mirror.c.163.com&quot;</span></span><br><span class="line">],</span><br><span class="line"> <span class="string">&quot;insecure-registries&quot;</span> : [</span><br><span class="line"> <span class="string">&quot;registry.docker-cn.com&quot;</span>,</span><br><span class="line"> <span class="string">&quot;docker.mirrors.ustc.edu.cn&quot;</span></span><br><span class="line">],</span><br><span class="line"> <span class="string">&quot;debug&quot;</span> : <span class="literal">true</span>,</span><br><span class="line"> <span class="string">&quot;experimental&quot;</span> : <span class="literal">true</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="查看本地镜像"><a href="#查看本地镜像" class="headerlink" title="查看本地镜像"></a>查看本地镜像</h3><p>docker images 可以查看下载至本地的镜像</p>
<p>格式:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">docker images [OPTIONS] [REPOSITORY[:TAG]]</span><br><span class="line">docker image <span class="built_in">ls</span> [OPTIONS] [REPOSITORY[:TAG]]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#常用选项:  </span></span><br><span class="line">-q, --quiet         Only show numeric IDs</span><br><span class="line">-a, --all           Show all images (default hides intermediate images)</span><br><span class="line">    --digests       Show digests</span><br><span class="line">    --no-trunc      Don<span class="string">&#x27;t truncate output</span></span><br><span class="line"><span class="string">-f, --filter filter   Filter output based on conditions provided</span></span><br><span class="line"><span class="string">    --format string   Pretty-print images using a Go template</span></span><br></pre></td></tr></table></figure>

<p>执行结果的显示信息说明: </p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">REPOSITORY      <span class="comment">#镜像所属的仓库名称</span></span><br><span class="line">TAG             <span class="comment">#镜像版本号（标识符），默认为latest</span></span><br><span class="line">IMAGE ID        <span class="comment">#镜像唯一ID标识,如果ID相同,说明是同一个镜像有多个名称</span></span><br><span class="line">CREATED         <span class="comment">#镜像在仓库中被创建时间</span></span><br><span class="line">VIRTUAL SIZE    <span class="comment">#镜像的大小</span></span><br></pre></td></tr></table></figure>

<p>Repository仓库</p>
<ul>
<li>由某特定的docker镜像的所有迭代版本组成的镜像仓库</li>
<li>一个Registry中可以存在多个Repository</li>
<li>Repository可分为“顶层仓库”和“用户仓库”</li>
<li>Repository用户仓库名称一般格式为“用户名/仓库名”</li>
<li>每个Repository仓库可以包含多个Tag(标签),每个标签对应一个镜像</li>
</ul>
<p>范例:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[root@ubuntu1804 ~]<span class="comment"># docker images</span></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment"># docker images -q</span></span><br><span class="line">e7d92cdc71fe</span><br><span class="line">470671670cac</span><br><span class="line">6d5fcfe5ff17</span><br><span class="line">fce289e99eb9</span><br><span class="line"></span><br><span class="line"><span class="comment">#显示完整的ImageID</span></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment"># docker images --no-trunc</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#只查看指定REPOSITORY的镜像</span></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment"># docker images tomcat</span></span><br><span class="line">REPOSITORY TAG IMAGE ID CREATED SIZE</span><br><span class="line">tomcat  9.0.37-v1 b8d669ebf99e  47 hours ago 652MB</span><br><span class="line">tomcat latest df72227b40e1  5 days ago 647MB</span><br></pre></td></tr></table></figure>

<p>范例: 查看指定镜像的详细信息</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ~]<span class="comment"># podman image inspect alpine</span></span><br></pre></td></tr></table></figure>

<h3 id="镜像导出"><a href="#镜像导出" class="headerlink" title="镜像导出"></a>镜像导出</h3><p>利用docker save命令可以将从本地镜像导出为一个打包 tar文件，然后复制到其他服务器进行导入使用</p>
<p>格式:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">docker save [OPTIONS] IMAGE [IMAGE...]</span><br><span class="line">选项:  </span><br><span class="line">-o, --output string   Write to a file, instead of STDOUT</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#说明:</span></span><br><span class="line">Docker save 使用IMAGE ID导出，在导入后的镜像没有REPOSITORY和TAG,显示为&lt;none&gt;</span><br></pre></td></tr></table></figure>

<p>常见用法: </p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#导出为tar格式</span></span><br><span class="line">docker save -o /path/file.tar IMAGE1 IMAGE2 ...</span><br><span class="line">docker save IMAGE1 IMAGE2 ... &gt; /path/file.tar</span><br><span class="line"></span><br><span class="line"><span class="comment">#导出为压缩格式</span></span><br><span class="line">docker save IMAGE1 IMAGE2 ... | gzip &gt; /path/file.tar.gz</span><br></pre></td></tr></table></figure>

<p>范例: 导出指定镜像</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@ubuntu1804 ~]<span class="comment"># docker images</span></span><br><span class="line"></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment"># docker save mysql:5.7.30 alpine:3.11.3 -o /data/myimages.tar</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#或者</span></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment"># docker save mysql:5.7.30 alpine:3.11.3 &gt; /data/myimages.tar</span></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment"># scp /data/myimages.tar   10.0.0.7:/data</span></span><br></pre></td></tr></table></figure>

<p>范例: 导出所有镜像至不同的文件中</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ~]<span class="comment"># docker images | awk &#x27;NR!=1&#123;print $1,$2&#125;&#x27; | while read repo tag ;do docker save   $repo:$tag -o /opt/$repo-$tag.tar ;done</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># ls /opt/*.tar</span></span><br><span class="line">/opt/alpine-3.21.3.tar   /opt/centos-centos7.7.1908.tar  /opt/nginx-latest.tar</span><br><span class="line">/opt/alpine-latest.tar   /opt/hello-world-latest.tar</span><br><span class="line">/opt/busybox-latest.tar  /opt/my-alpine-latest.tar</span><br></pre></td></tr></table></figure>

<p>范例:导出所有镜像到一个打包文件</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#方法1: 使用image ID导出镜像,在导入后的镜像没有REPOSITORY和TAG,显示为&lt;none&gt;</span></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment"># docker save `docker images -qa` -o all.tar</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#方法2:将所有镜像导入到一个文件中,此方法导入后可以看REPOSITORY和TAG</span></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment"># docker save `docker images | awk &#x27;NR!=1&#123;print $1&quot;:&quot;$2&#125;&#x27;` -o all.tar</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#方法3:将所有镜像导入到一个文件中,此方法导入后可以看REPOSITORY和TAG</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># docker image save `docker image ls --format &quot;&#123;&#123;.Repository&#125;&#125;:&#123;&#123;.Tag&#125;&#125;&quot;` -o all.tar</span></span><br></pre></td></tr></table></figure>

<h3 id="镜像导入"><a href="#镜像导入" class="headerlink" title="镜像导入"></a>镜像导入</h3><p>利用docker load命令可以将镜像导出的打包或压缩文件再导入</p>
<p>格式: </p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">docker load [OPTIONS]</span><br><span class="line"></span><br><span class="line"><span class="comment">#选项</span></span><br><span class="line">-i, --input string    Read from tar archive file, instead of STDIN</span><br><span class="line">-q, --quiet           Suppress the load output</span><br></pre></td></tr></table></figure>

<p>常见用法: </p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">docker load -i /path/file.tar</span><br><span class="line">docker load &lt; /path/file.tar</span><br></pre></td></tr></table></figure>

<p>范例: 镜像导入</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">[root@rocky8 ~]<span class="comment"># docker images</span></span><br><span class="line">REPOSITORY   TAG       IMAGE ID   CREATED   SIZE</span><br><span class="line"></span><br><span class="line">[root@rocky8 ~]<span class="comment"># docker load -i  /opt/alpine-3.21.3.tar </span></span><br><span class="line">Loaded image: alpine:3.21.3</span><br><span class="line"></span><br><span class="line"><span class="comment">#或者</span></span><br><span class="line">[root@rocky8 ~]<span class="comment"># docker load &lt; /opt/nginx-latest.tar </span></span><br><span class="line">1287fbecdfcc: Loading layer  77.84MB/77.84MB</span><br><span class="line">135f786ad046: Loading layer  118.3MB/118.3MB</span><br><span class="line">ad2f08e39a9d: Loading layer  3.584kB/3.584kB</span><br><span class="line">d98dcc720ae0: Loading layer  4.608kB/4.608kB</span><br><span class="line">aa82c57cd9fe: Loading layer   2.56kB/2.56kB</span><br><span class="line">d26dc06ef910: Loading layer   5.12kB/5.12kB</span><br><span class="line">03d9365bc5dc: Loading layer  7.168kB/7.168kB</span><br><span class="line">Loaded image: nginx:latest</span><br><span class="line"></span><br><span class="line">[root@rocky8 ~]<span class="comment"># docker images</span></span><br><span class="line">REPOSITORY   TAG       IMAGE ID       CREATED          SIZE</span><br><span class="line">alpine       3.21.3    60733ce3f702   30 minutes ago   7.83MB</span><br><span class="line">nginx        latest    53a18edff809   2 months ago     192MB</span><br></pre></td></tr></table></figure>

<p>范例: 一次导出多个镜像</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">[root@rocky8 ~]<span class="comment"># docker images</span></span><br><span class="line">REPOSITORY   TAG       IMAGE ID       CREATED          SIZE</span><br><span class="line">alpine       3.21.3    60733ce3f702   34 minutes ago   7.83MB</span><br><span class="line">nginx        latest    53a18edff809   2 months ago     192MB</span><br><span class="line"></span><br><span class="line">[root@rocky8 ~]<span class="comment"># docker save alpine:3.21.3 nginx -o test.tar</span></span><br><span class="line">[root@rocky8 ~]<span class="comment"># ll -h test.tar</span></span><br><span class="line">-rw------- 1 root root 195M Apr  7 16:01 test.tar</span><br><span class="line"></span><br><span class="line">[root@rocky8 ~]<span class="comment"># docker rmi -f `docker images -q`</span></span><br><span class="line">Untagged: alpine:3.21.3</span><br><span class="line">Deleted: sha256:60733ce3f702b79c9026de89d902b80386827dd39800802081c630ed15a0b1e2</span><br><span class="line">Untagged: nginx:latest</span><br><span class="line">Deleted: sha256:53a18edff8091d5faff1e42b4d885bc5f0f897873b0b8f0ace236cd5930819b0</span><br><span class="line">Deleted: sha256:9624c14fde1debdc1256228b54278fec5e576a42dcbf73f420762a91f4a06c87</span><br><span class="line">Deleted: sha256:75cef3a8c4e762e0d3d0c01fbe5cf9407478057005f945fa78edef29a2bc6e33</span><br><span class="line">Deleted: sha256:bf22610f6a6c90cb4a456617b926c87cb1c50efd3f90b1d96d9c88e5f4b75a6e</span><br><span class="line">Deleted: sha256:8e41d2be566aeafda18718a8a4b8c515c50b06f82cd7a92420ae91010773e15c</span><br><span class="line">Deleted: sha256:da2d6794d8696a98178b6882353953c9f410dcffff428cfa3caa5759036d24bd</span><br><span class="line">Deleted: sha256:e9228041e2928859e124edaf5a456926097605092e1855d51aa9e43f984f770e</span><br><span class="line">Deleted: sha256:1287fbecdfcce6ee8cf2436e5b9e9d86a4648db2d91080377d499737f1b307f3</span><br><span class="line"></span><br><span class="line">[root@rocky8 ~]<span class="comment"># docker images</span></span><br><span class="line">REPOSITORY   TAG       IMAGE ID   CREATED   SIZE</span><br><span class="line"></span><br><span class="line">[root@rocky8 ~]<span class="comment"># docker load -i test.tar </span></span><br><span class="line">Loaded image: alpine:3.21.3</span><br><span class="line">1287fbecdfcc: Loading layer  77.84MB/77.84MB</span><br><span class="line">135f786ad046: Loading layer  118.3MB/118.3MB</span><br><span class="line">ad2f08e39a9d: Loading layer  3.584kB/3.584kB</span><br><span class="line">d98dcc720ae0: Loading layer  4.608kB/4.608kB</span><br><span class="line">aa82c57cd9fe: Loading layer   2.56kB/2.56kB</span><br><span class="line">d26dc06ef910: Loading layer   5.12kB/5.12kB</span><br><span class="line">03d9365bc5dc: Loading layer  7.168kB/7.168kB</span><br><span class="line">Loaded image: nginx:latest</span><br><span class="line"></span><br><span class="line">[root@rocky8 ~]<span class="comment"># docker images</span></span><br><span class="line">REPOSITORY   TAG       IMAGE ID       CREATED          SIZE</span><br><span class="line">alpine       3.21.3    60733ce3f702   35 minutes ago   7.83MB</span><br><span class="line">nginx        latest    53a18edff809   2 months ago     192MB</span><br></pre></td></tr></table></figure>

<p>面试题: 将一台主机的所有镜像传到另一台主机</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#方法1: 使用image ID导出镜像,在导入后的镜像没有REPOSITORY和TAG,显示为&lt;none&gt;</span></span><br><span class="line">[root@rocky8 ~]<span class="comment"># docker save `docker images -qa` -o all.tar</span></span><br><span class="line">[root@rocky8 ~]<span class="comment"># scp all.tar 192.168.1.12:</span></span><br><span class="line">[root@rocky8 ~]<span class="comment"># docker load -i all.tar </span></span><br><span class="line">08000c18d16d: Loading layer  8.121MB/8.121MB</span><br><span class="line">068f50152bbc: Loading layer  4.516MB/4.516MB</span><br><span class="line">Loaded image ID: sha256:aded1e1a5b3705116fa0a92ba074a5e0b0031647d9c315983ccba2ee5428ec8b</span><br><span class="line">Loaded image ID: sha256:ff7a7936e9306ce4a789cf5523922da5e585dc1216e400efb3b6872a5137ee6b</span><br><span class="line"></span><br><span class="line">[root@rocky8 ~]<span class="comment"># docker images</span></span><br><span class="line">REPOSITORY   TAG       IMAGE ID       CREATED        SIZE</span><br><span class="line">&lt;none&gt;       &lt;none&gt;    aded1e1a5b37   7 weeks ago    7.83MB</span><br><span class="line">&lt;none&gt;       &lt;none&gt;    ff7a7936e930   6 months ago   4.28MB</span><br><span class="line"></span><br><span class="line"><span class="comment">#方法2:将所有镜像导入到一个文件中,此方法导入后可以看REPOSITORY和TAG</span></span><br><span class="line">[root@rocky8 ~]<span class="comment"># docker save `docker images | awk &#x27;NR!=1&#123;print $1&quot;:&quot;$2&#125;&#x27;` -o backup.tar</span></span><br><span class="line"></span><br><span class="line">[root@rocky8 ~]<span class="comment"># docker images</span></span><br><span class="line">REPOSITORY   TAG       IMAGE ID   CREATED   SIZE</span><br><span class="line"></span><br><span class="line">[root@rocky8 ~]<span class="comment"># docker load -i backup.tar </span></span><br><span class="line">08000c18d16d: Loading layer  8.121MB/8.121MB</span><br><span class="line">Loaded image: alpine:latest</span><br><span class="line">068f50152bbc: Loading layer  4.516MB/4.516MB</span><br><span class="line">Loaded image: busybox:latest</span><br><span class="line"></span><br><span class="line">[root@rocky8 ~]<span class="comment"># docker images</span></span><br><span class="line">REPOSITORY   TAG       IMAGE ID       CREATED        SIZE</span><br><span class="line">alpine       latest    aded1e1a5b37   7 weeks ago    7.83MB</span><br><span class="line">busybox      latest    ff7a7936e930   6 months ago   4.28MB</span><br><span class="line"></span><br><span class="line"><span class="comment">#方法3:将所有镜像导入到一个文件中,此方法导入后可以看REPOSITORY和TAG</span></span><br><span class="line">[root@rocky8 ~]<span class="comment"># docker image save `docker images --format &quot;&#123;&#123;.Repository&#125;&#125;:&#123;&#123;.Tag&#125;&#125;&quot;` -o test.tar</span></span><br><span class="line"></span><br><span class="line">[root@rocky8 ~]<span class="comment"># docker load -i test.tar </span></span><br><span class="line">08000c18d16d: Loading layer  8.121MB/8.121MB</span><br><span class="line">Loaded image: alpine:latest</span><br><span class="line">068f50152bbc: Loading layer  4.516MB/4.516MB</span><br><span class="line">Loaded image: busybox:latest</span><br><span class="line"></span><br><span class="line">[root@rocky8 ~]<span class="comment"># docker images</span></span><br><span class="line">REPOSITORY   TAG       IMAGE ID       CREATED        SIZE</span><br><span class="line">alpine       latest    aded1e1a5b37   7 weeks ago    7.83MB</span><br><span class="line">busybox      latest    ff7a7936e930   6 months ago   4.28MB</span><br></pre></td></tr></table></figure>

<h3 id="删除镜像"><a href="#删除镜像" class="headerlink" title="删除镜像"></a>删除镜像</h3><p>docker rmi 命令可以删除本地镜像</p>
<p>格式</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">docker rmi [OPTIONS] IMAGE [IMAGE...]</span><br><span class="line">docker image <span class="built_in">rm</span> [OPTIONS] IMAGE [IMAGE...]</span><br><span class="line"></span><br><span class="line"><span class="comment">#选项:</span></span><br><span class="line">  -f, --force      Force removal of the image</span><br><span class="line">      --no-prune   Do not delete untagged parents</span><br></pre></td></tr></table></figure>

<p>范例:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">[root@rocky8 ~]<span class="comment"># docker images</span></span><br><span class="line">REPOSITORY   TAG       IMAGE ID       CREATED        SIZE</span><br><span class="line">alpine       latest    aded1e1a5b37   7 weeks ago    7.83MB</span><br><span class="line">busybox      latest    ff7a7936e930   6 months ago   4.28MB</span><br><span class="line"></span><br><span class="line">[root@rocky8 ~]<span class="comment"># docker rmi aded</span></span><br><span class="line">Untagged: alpine:latest</span><br><span class="line">Deleted: sha256:aded1e1a5b3705116fa0a92ba074a5e0b0031647d9c315983ccba2ee5428ec8b</span><br><span class="line">Deleted: sha256:08000c18d16dadf9553d747a58cf44023423a9ab010aab96cf263d2216b8b350</span><br><span class="line"></span><br><span class="line">[root@rocky8 ~]<span class="comment"># docker rmi busybox</span></span><br><span class="line">Untagged: busybox:latest</span><br><span class="line">Deleted: sha256:ff7a7936e9306ce4a789cf5523922da5e585dc1216e400efb3b6872a5137ee6b</span><br><span class="line">Deleted: sha256:068f50152bbc6e10c9d223150c9fbd30d11bcfd7789c432152aa0a99703bd03a</span><br><span class="line"></span><br><span class="line">[root@rocky8 ~]<span class="comment"># docker images</span></span><br><span class="line">REPOSITORY   TAG       IMAGE ID   CREATED   SIZE</span><br></pre></td></tr></table></figure>

<p>范例: 删除多个镜像</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[root@rocky8 ~]<span class="comment"># docker images</span></span><br><span class="line">REPOSITORY   TAG       IMAGE ID       CREATED        SIZE</span><br><span class="line">alpine       latest    aded1e1a5b37   7 weeks ago    7.83MB</span><br><span class="line">busybox      latest    ff7a7936e930   6 months ago   4.28MB</span><br><span class="line"></span><br><span class="line">[root@rocky8 ~]<span class="comment"># docker rmi alpine:latest busybox:latest </span></span><br><span class="line">Untagged: alpine:latest</span><br><span class="line">Deleted: sha256:aded1e1a5b3705116fa0a92ba074a5e0b0031647d9c315983ccba2ee5428ec8b</span><br><span class="line">Deleted: sha256:08000c18d16dadf9553d747a58cf44023423a9ab010aab96cf263d2216b8b350</span><br><span class="line">Untagged: busybox:latest</span><br><span class="line">Deleted: sha256:ff7a7936e9306ce4a789cf5523922da5e585dc1216e400efb3b6872a5137ee6b</span><br><span class="line">Deleted: sha256:068f50152bbc6e10c9d223150c9fbd30d11bcfd7789c432152aa0a99703bd03a</span><br><span class="line"></span><br><span class="line">[root@rocky8 ~]<span class="comment"># docker images</span></span><br><span class="line">REPOSITORY   TAG       IMAGE ID   CREATED   SIZE</span><br></pre></td></tr></table></figure>

<p>范例: 强制删除正在使用的镜像，也会删除对应的容器(新版删不了)</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">[root@rocky8 ~]<span class="comment"># docker ps -a</span></span><br><span class="line">CONTAINER ID   IMAGE                   COMMAND          CREATED          STATUS          PORTS     NAMES</span><br><span class="line">ed697ade69d6   centos:centos7.7.1908   <span class="string">&quot;ping 8.8.8.8&quot;</span>   25 seconds ago   Up 24 seconds             centos7</span><br><span class="line"></span><br><span class="line">[root@rocky8 ~]<span class="comment"># docker rmi centos:centos7.7.1908 </span></span><br><span class="line">Error response from daemon: conflict: unable to remove repository reference <span class="string">&quot;centos:centos7.7.1908&quot;</span> (must force) - container ed697ade69d6 is using its referenced image 08d05d1d5859</span><br><span class="line"></span><br><span class="line">[root@rocky8 ~]<span class="comment"># docker rmi -f centos:centos7.7.1908 </span></span><br><span class="line">Untagged: centos:centos7.7.1908</span><br><span class="line"></span><br><span class="line">[root@rocky8 ~]<span class="comment"># docker ps -a</span></span><br><span class="line">CONTAINER ID   IMAGE          COMMAND          CREATED          STATUS          PORTS     NAMES</span><br><span class="line">ed697ade69d6   08d05d1d5859   <span class="string">&quot;ping 8.8.8.8&quot;</span>   50 seconds ago   Up 49 seconds             centos7</span><br><span class="line"></span><br><span class="line">[root@rocky8 ~]<span class="comment"># docker images</span></span><br><span class="line">REPOSITORY   TAG       IMAGE ID       CREATED       SIZE</span><br><span class="line">&lt;none&gt;       &lt;none&gt;    08d05d1d5859   5 years ago   204MB</span><br><span class="line"></span><br><span class="line">[root@rocky8 ~]<span class="comment"># docker rmi -f 08d0</span></span><br><span class="line">Error response from daemon: conflict: unable to delete 08d05d1d5859 (cannot be forced) - image is being used by running container ed697ade69d6</span><br></pre></td></tr></table></figure>

<p>范例: 删除所有镜像</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[root@rocky8 ~]<span class="comment"># docker images</span></span><br><span class="line">REPOSITORY   TAG       IMAGE ID       CREATED        SIZE</span><br><span class="line">alpine       latest    aded1e1a5b37   7 weeks ago    7.83MB</span><br><span class="line">busybox      latest    ff7a7936e930   6 months ago   4.28MB</span><br><span class="line"></span><br><span class="line">[root@rocky8 ~]<span class="comment"># docker rmi -f `docker images -q`</span></span><br><span class="line">Untagged: alpine:latest</span><br><span class="line">Deleted: sha256:aded1e1a5b3705116fa0a92ba074a5e0b0031647d9c315983ccba2ee5428ec8b</span><br><span class="line">Deleted: sha256:08000c18d16dadf9553d747a58cf44023423a9ab010aab96cf263d2216b8b350</span><br><span class="line">Untagged: busybox:latest</span><br><span class="line">Deleted: sha256:ff7a7936e9306ce4a789cf5523922da5e585dc1216e400efb3b6872a5137ee6b</span><br><span class="line">Deleted: sha256:068f50152bbc6e10c9d223150c9fbd30d11bcfd7789c432152aa0a99703bd03a</span><br><span class="line"></span><br><span class="line">[root@rocky8 ~]<span class="comment"># docker images</span></span><br><span class="line">REPOSITORY   TAG       IMAGE ID   CREATED   SIZE</span><br></pre></td></tr></table></figure>

<h3 id="镜像打标签"><a href="#镜像打标签" class="headerlink" title="镜像打标签"></a>镜像打标签</h3><p>docker tag 可以给镜像打标签，类似于起别名,但通常要遵守一定的命名规范,才可以上传到指定的仓库</p>
<p>格式</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">docker tag SOURCE_IMAGE[:TAG] TARGET_IMAGE[:TAG]</span><br><span class="line"></span><br><span class="line"><span class="comment">#TARGET_IMAGE[:TAG]格式一般形式</span></span><br><span class="line">仓库主机FQDN或IP[:端口]/项目名(或用户名)/image名字:版本</span><br></pre></td></tr></table></figure>

<p>TAG默认为latest</p>
<p>范例: </p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root@rocky8 ~]<span class="comment"># docker images </span></span><br><span class="line">REPOSITORY   TAG       IMAGE ID       CREATED        SIZE</span><br><span class="line">alpine       latest    aded1e1a5b37   7 weeks ago    7.83MB</span><br><span class="line">busybox      latest    ff7a7936e930   6 months ago   4.28MB</span><br><span class="line"></span><br><span class="line">[root@rocky8 ~]<span class="comment"># docker tag alpine alpine:3.11</span></span><br><span class="line">[root@rocky8 ~]<span class="comment"># docker images</span></span><br><span class="line">REPOSITORY   TAG       IMAGE ID       CREATED        SIZE</span><br><span class="line">alpine       3.11      aded1e1a5b37   7 weeks ago    7.83MB</span><br><span class="line">alpine       latest    aded1e1a5b37   7 weeks ago    7.83MB</span><br><span class="line">busybox      latest    ff7a7936e930   6 months ago   4.28MB</span><br></pre></td></tr></table></figure>

<p>总结: 企业使用镜像及常见操作: 搜索、下载、导出、导入、删除</p>
<p><strong>命令总结:</strong> </p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">docker search centos</span><br><span class="line">docker pull alpine</span><br><span class="line">docker images</span><br><span class="line">docker save &gt; /opt/centos.tar   <span class="comment">#centos #导出镜像</span></span><br><span class="line">docker load -i /opt/centos.tar  <span class="comment">#导入本地镜像</span></span><br><span class="line">docker rmi 镜像ID/镜像名称        <span class="comment">#删除指定ID的镜像，此镜像对应容器正启动镜像不能被删除，除非将容器全部关闭</span></span><br></pre></td></tr></table></figure>

<h2 id="容器操作基础命令"><a href="#容器操作基础命令" class="headerlink" title="容器操作基础命令"></a>容器操作基础命令</h2><p><strong>容器生命周期</strong></p>
<p><img src="../../../../images/SRE/day46/27.jpg" alt="27"></p>
<p>容器相关命令</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">[root@rocky8 ~]<span class="comment"># docker container </span></span><br><span class="line"></span><br><span class="line">Usage:  docker container COMMAND</span><br><span class="line"></span><br><span class="line">Manage containers</span><br><span class="line"></span><br><span class="line">Commands:</span><br><span class="line">  attach      Attach <span class="built_in">local</span> standard input, output, and error streams to a running container</span><br><span class="line">  commit      Create a new image from a container<span class="string">&#x27;s changes</span></span><br><span class="line"><span class="string">  cp          Copy files/folders between a container and the local filesystem</span></span><br><span class="line"><span class="string">  create      Create a new container</span></span><br><span class="line"><span class="string">  diff        Inspect changes to files or directories on a container&#x27;</span>s filesystem</span><br><span class="line">  <span class="built_in">exec</span>        Execute a <span class="built_in">command</span> <span class="keyword">in</span> a running container</span><br><span class="line">  <span class="built_in">export</span>      Export a container<span class="string">&#x27;s filesystem as a tar archive</span></span><br><span class="line"><span class="string">  inspect     Display detailed information on one or more containers</span></span><br><span class="line"><span class="string">  kill        Kill one or more running containers</span></span><br><span class="line"><span class="string">  logs        Fetch the logs of a container</span></span><br><span class="line"><span class="string">  ls          List containers</span></span><br><span class="line"><span class="string">  pause       Pause all processes within one or more containers</span></span><br><span class="line"><span class="string">  port        List port mappings or a specific mapping for the container</span></span><br><span class="line"><span class="string">  prune       Remove all stopped containers</span></span><br><span class="line"><span class="string">  rename      Rename a container</span></span><br><span class="line"><span class="string">  restart     Restart one or more containers</span></span><br><span class="line"><span class="string">  rm          Remove one or more containers</span></span><br><span class="line"><span class="string">  run         Create and run a new container from an image</span></span><br><span class="line"><span class="string">  start       Start one or more stopped containers</span></span><br><span class="line"><span class="string">  stats       Display a live stream of container(s) resource usage statistics</span></span><br><span class="line"><span class="string">  stop        Stop one or more running containers</span></span><br><span class="line"><span class="string">  top         Display the running processes of a container</span></span><br><span class="line"><span class="string">  unpause     Unpause all processes within one or more containers</span></span><br><span class="line"><span class="string">  update      Update configuration of one or more containers</span></span><br><span class="line"><span class="string">  wait        Block until one or more containers stop, then print their exit codes</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Run &#x27;</span>docker container COMMAND --<span class="built_in">help</span><span class="string">&#x27; for more information on a command.</span></span><br></pre></td></tr></table></figure>

<h3 id="启动容器"><a href="#启动容器" class="headerlink" title="启动容器"></a>启动容器</h3><p>docker run 可以启动容器，进入到容器，并随机生成容器ID和名称</p>
<h4 id="启动第一个容器"><a href="#启动第一个容器" class="headerlink" title="启动第一个容器"></a>启动第一个容器</h4><p>范例: 运行docker 的 hello world </p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">[root@rocky8 ~]<span class="comment"># docker run hello-world</span></span><br><span class="line"></span><br><span class="line">Hello from Docker!</span><br><span class="line">This message shows that your installation appears to be working correctly.</span><br><span class="line"></span><br><span class="line">To generate this message, Docker took the following steps:</span><br><span class="line"> 1. The Docker client contacted the Docker daemon.</span><br><span class="line"> 2. The Docker daemon pulled the <span class="string">&quot;hello-world&quot;</span> image from the Docker Hub.</span><br><span class="line">    (amd64)</span><br><span class="line"> 3. The Docker daemon created a new container from that image <span class="built_in">which</span> runs the</span><br><span class="line">    executable that produces the output you are currently reading.</span><br><span class="line"> 4. The Docker daemon streamed that output to the Docker client, <span class="built_in">which</span> sent it</span><br><span class="line">    to your terminal.</span><br><span class="line"></span><br><span class="line">To try something more ambitious, you can run an Ubuntu container with:</span><br><span class="line"> $ docker run -it ubuntu bash</span><br><span class="line"></span><br><span class="line">Share images, automate workflows, and more with a free Docker ID:</span><br><span class="line"> https://hub.docker.com/</span><br><span class="line"></span><br><span class="line">For more examples and ideas, visit:</span><br><span class="line"> https://docs.docker.com/get-started/</span><br><span class="line"></span><br><span class="line">[root@rocky8 ~]<span class="comment"># docker images</span></span><br><span class="line">REPOSITORY    TAG       IMAGE ID       CREATED        SIZE</span><br><span class="line">hello-world   latest    74cc54e27dc4   2 months ago   10.1kB</span><br><span class="line"></span><br><span class="line">[root@rocky8 ~]<span class="comment"># docker ps -a</span></span><br><span class="line">CONTAINER ID   IMAGE         COMMAND    CREATED          STATUS                      PORTS     NAMES</span><br><span class="line">baeee841d085   hello-world   <span class="string">&quot;/hello&quot;</span>   24 seconds ago   Exited (0) 24 seconds ago             quizzical_curran</span><br></pre></td></tr></table></figure>

<h4 id="启动容器的流程"><a href="#启动容器的流程" class="headerlink" title="启动容器的流程"></a>启动容器的流程</h4><p><img src="../../../../images/SRE/day46/28.jpg" alt="28"></p>
<h4 id="启动容器用法"><a href="#启动容器用法" class="headerlink" title="启动容器用法"></a>启动容器用法</h4><p>帮助: man docker-run  </p>
<p>命令格式:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">docker run [选项] [镜像名] [shell命令] [参数]</span><br><span class="line"></span><br><span class="line"><span class="comment">#选项:  </span></span><br><span class="line">-i, --interactive   Keep STDIN open even <span class="keyword">if</span> not attached，通常和-t一起使用</span><br><span class="line">-t, --<span class="built_in">tty</span>           分配pseudo-TTY，通常和-i一起使用,注意对应的容器必须运行shell才支持进入</span><br><span class="line">-d, --detach        Run container <span class="keyword">in</span> background and <span class="built_in">print</span> container ID,台后运行，默认前台</span><br><span class="line">--name string       Assign a name to the container</span><br><span class="line">--h, --hostname string Container host name </span><br><span class="line">--<span class="built_in">rm</span>                Automatically remove the container when it exits</span><br><span class="line">-p, --publish list  Publish a container<span class="string">&#x27;s port(s) to the host</span></span><br><span class="line"><span class="string">-P, --publish-all   Publish all exposed ports to random ports</span></span><br><span class="line"><span class="string">--dns list          Set custom DNS servers</span></span><br><span class="line"><span class="string">--entrypoint string Overwrite the default ENTRYPOINT of the image</span></span><br><span class="line"><span class="string">--restart policy  </span></span><br><span class="line"><span class="string">--privileged        Give extended privileges to container</span></span><br><span class="line"><span class="string">-e, --env=[] Set environment variables</span></span><br><span class="line"><span class="string">--env-file=[]       Read in a line delimited file of environment variables</span></span><br></pre></td></tr></table></figure>

<p><strong>–restart 可以指定四种不同的policy</strong></p>
<table>
<thead>
<tr>
<th>policy</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>no</td>
<td>Default is no，Do not automatically restart the container when it exits.</td>
</tr>
<tr>
<td>on-failure[:max-retries]</td>
<td>on-failure[:max-retries] Restart only if the container exits with a non-zero exit status. Optionally, limit the number of restart retries the Docker daemon attempts.</td>
</tr>
<tr>
<td>always</td>
<td>Always restart the container regardless of the exit status. When you specify always, the Docker daemon will try to restart the container indefinitely. The container will also always start on daemon startup, regardless of the current state of the container.利用此项可以实现开机自动启动容器</td>
</tr>
<tr>
<td>unless-stopped</td>
<td>Always restart the container regardless of the exit status, but do not start it on daemon startup if the container has been put to a stopped state before.</td>
</tr>
</tbody></table>
<p><strong>注意: 容器启动后,如果容器内没有前台运行的进程,将自动退出停止</strong></p>
<p>从容器内退出,并停止容器</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">exit</span></span><br></pre></td></tr></table></figure>

<p>从容器内退出,且容器不停止</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">同时按三个键，ctrl+p+q</span><br></pre></td></tr></table></figure>

<p>范例: 运行容器</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#启动容器时会自动随机字符作为容器名</span></span><br><span class="line">[root@rocky8 ~]<span class="comment"># docker run alpine</span></span><br><span class="line">[root@rocky8 ~]<span class="comment"># docker ps -a</span></span><br><span class="line">CONTAINER ID   IMAGE     COMMAND     CREATED         STATUS                     PORTS     NAMES</span><br><span class="line">1510db110e72   alpine    <span class="string">&quot;/bin/sh&quot;</span>   5 seconds ago   Exited (0) 4 seconds ago             quizzical_blackwell</span><br></pre></td></tr></table></figure>

<p>范例: 一次性运行容器中命令</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#启动的容器在执行完shell命令就退出，用于测试</span></span><br><span class="line">[root@rocky8 ~]<span class="comment"># docker run busybox echo &quot;Hello WANG&quot;</span></span><br><span class="line">Hello WANG</span><br><span class="line"></span><br><span class="line">[root@rocky8 ~]<span class="comment"># docker ps</span></span><br><span class="line">CONTAINER ID   IMAGE     COMMAND   CREATED   STATUS    PORTS     NAMES</span><br><span class="line"></span><br><span class="line">[root@rocky8 ~]<span class="comment"># docker ps -a</span></span><br><span class="line">CONTAINER ID   IMAGE     COMMAND               CREATED              STATUS                          PORTS     NAMES</span><br><span class="line">4bcd7fa5126a   busybox   <span class="string">&quot;echo &#x27;Hello WANG&#x27;&quot;</span>   12 seconds ago       Exited (0) 10 seconds ago                 frosty_matsumoto</span><br><span class="line">1510db110e72   alpine    <span class="string">&quot;/bin/sh&quot;</span>             About a minute ago   Exited (0) About a minute ago             quizzical_blackwell</span><br></pre></td></tr></table></figure>

<p>范例: 指定容器名称</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#注意每个容器的名称要唯一</span></span><br><span class="line">[root@rocky8 ~]<span class="comment"># docker run --name a1 alpine</span></span><br><span class="line">[root@rocky8 ~]<span class="comment"># docker ps -a</span></span><br><span class="line">CONTAINER ID   IMAGE     COMMAND               CREATED              STATUS                          PORTS     NAMES</span><br><span class="line">fabb2001c932   alpine    <span class="string">&quot;/bin/sh&quot;</span>             5 seconds ago        Exited (0) 4 seconds ago                  a1</span><br><span class="line">4bcd7fa5126a   busybox   <span class="string">&quot;echo &#x27;Hello WANG&#x27;&quot;</span>   About a minute ago   Exited (0) About a minute ago             frosty_matsumoto</span><br><span class="line">1510db110e72   alpine    <span class="string">&quot;/bin/sh&quot;</span>             2 minutes ago        Exited (0) 2 minutes ago                  quizzical_blackwell</span><br></pre></td></tr></table></figure>

<p>范例: 运行交互式容器并退出</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[root@rocky8 ~]<span class="comment"># docker run -it busybox sh</span></span><br><span class="line">/ <span class="comment"># exit</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#用exit退出后容器也停止</span></span><br><span class="line">[root@rocky8 ~]<span class="comment"># docker ps -l</span></span><br><span class="line">CONTAINER ID   IMAGE     COMMAND   CREATED          STATUS                      PORTS     NAMES</span><br><span class="line">901cc5325c3d   busybox   <span class="string">&quot;sh&quot;</span>      32 seconds ago   Exited (0) 26 seconds ago</span><br><span class="line"></span><br><span class="line">[root@rocky8 ~]<span class="comment"># docker run -it busybox sh</span></span><br><span class="line">/ <span class="comment"># 同时按三个键:ctrl+p+q</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#用同时按三个键ctrl+p+q退出后容器不会停止</span></span><br><span class="line">[root@rocky8 ~]<span class="comment"># docker ps -l</span></span><br><span class="line">CONTAINER ID   IMAGE     COMMAND   CREATED          STATUS          PORTS     NAMES</span><br><span class="line">13bdfadb18b5   busybox   <span class="string">&quot;sh&quot;</span>      42 seconds ago   Up 41 seconds             friendly_wozniak</span><br></pre></td></tr></table></figure>

<p>范例: 设置容器内的主机名</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">[root@rocky8 ~]<span class="comment"># docker run -it --name a1 -h a1.wang.org alpine</span></span><br><span class="line">/ <span class="comment"># hostname</span></span><br><span class="line">a1.wang.org</span><br><span class="line"></span><br><span class="line">/ <span class="comment"># cat /etc/hosts</span></span><br><span class="line">127.0.0.1	localhost</span><br><span class="line">::1	localhost ip6-localhost ip6-loopback</span><br><span class="line">fe00::0	ip6-localnet</span><br><span class="line">ff00::0	ip6-mcastprefix</span><br><span class="line">ff02::1	ip6-allnodes</span><br><span class="line">ff02::2	ip6-allrouters</span><br><span class="line">172.17.0.2	a1.wang.org a1</span><br><span class="line"></span><br><span class="line">/ <span class="comment"># cat /etc/resolv.conf </span></span><br><span class="line"><span class="comment"># Generated by Docker Engine.</span></span><br><span class="line"><span class="comment"># This file can be edited; Docker Engine will not make further changes once it</span></span><br><span class="line"><span class="comment"># has been modified.</span></span><br><span class="line"></span><br><span class="line">nameserver 223.5.5.5</span><br><span class="line">nameserver 223.6.6.6</span><br><span class="line"></span><br><span class="line"><span class="comment"># Based on host file: &#x27;/etc/resolv.conf&#x27; (legacy)</span></span><br><span class="line"><span class="comment"># Overrides: []</span></span><br></pre></td></tr></table></figure>

<p>范例: 一次性运行容器，退出后立即删除，用于测试</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@rocky8 ~]<span class="comment"># docker run --rm alpine cat /etc/issue</span></span><br><span class="line">Welcome to Alpine Linux 3.21</span><br><span class="line">Kernel \r on an \m (\l)</span><br><span class="line"></span><br><span class="line">[root@rocky8 ~]<span class="comment"># docker ps -a</span></span><br><span class="line">CONTAINER ID   IMAGE     COMMAND   CREATED   STATUS    PORTS     NAMES</span><br></pre></td></tr></table></figure>

<p>范例: 创建容器后直接进入并退出</p>
<p>退出两种方式:</p>
<ul>
<li>exit 容器也停止</li>
<li>按ctrl+p+q 容器不停止</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#执行exit退出后容器关闭</span></span><br><span class="line">[root@rocky8 ~]<span class="comment"># docker run -it --name alpine2 alpine</span></span><br><span class="line">/ <span class="comment"># cat /etc/issue </span></span><br><span class="line">Welcome to Alpine Linux 3.21</span><br><span class="line">Kernel \r on an \m (\l)</span><br><span class="line"></span><br><span class="line">/ <span class="comment"># exit #退出容器,容器也停止运行</span></span><br><span class="line"></span><br><span class="line">[root@rocky8 ~]<span class="comment"># docker ps -a</span></span><br><span class="line">CONTAINER ID   IMAGE     COMMAND     CREATED          STATUS                     PORTS     NAMES</span><br><span class="line">46c789f613b3   alpine    <span class="string">&quot;/bin/sh&quot;</span>   37 seconds ago   Exited (0) 5 seconds ago             alpine2</span><br><span class="line"></span><br><span class="line">[root@rocky8 ~]<span class="comment"># docker run -it --name alpine3 alpine</span></span><br><span class="line">/ <span class="comment"># #同时按ctrl+p+q 三个键退出后,容器不停止</span></span><br><span class="line"></span><br><span class="line">[root@rocky8 ~]<span class="comment"># docker ps -a</span></span><br><span class="line">CONTAINER ID   IMAGE     COMMAND     CREATED              STATUS                      PORTS     NAMES</span><br><span class="line">e2d2b939be82   alpine    <span class="string">&quot;/bin/sh&quot;</span>   17 seconds ago       Up 16 seconds                         alpine3</span><br><span class="line">46c789f613b3   alpine    <span class="string">&quot;/bin/sh&quot;</span>   About a minute ago   Exited (0) 33 seconds ago             alpine2</span><br></pre></td></tr></table></figure>

<p><strong>什么是守护式容器:</strong> </p>
<ul>
<li>能够长期运行</li>
<li>无需交互式会话</li>
<li>适合运行应用程序和服务</li>
</ul>
<p>范例: 启动前台守护式容器</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line">[root@rocky8 ~]<span class="comment"># docker run nginx</span></span><br><span class="line">/docker-entrypoint.sh: /docker-entrypoint.d/ is not empty, will attempt to perform configuration</span><br><span class="line">/docker-entrypoint.sh: Looking <span class="keyword">for</span> shell scripts <span class="keyword">in</span> /docker-entrypoint.d/</span><br><span class="line">/docker-entrypoint.sh: Launching /docker-entrypoint.d/10-listen-on-ipv6-by-default.sh</span><br><span class="line">10-listen-on-ipv6-by-default.sh: info: Getting the checksum of /etc/nginx/conf.d/default.conf</span><br><span class="line">10-listen-on-ipv6-by-default.sh: info: Enabled listen on IPv6 <span class="keyword">in</span> /etc/nginx/conf.d/default.conf</span><br><span class="line">/docker-entrypoint.sh: Sourcing /docker-entrypoint.d/15-local-resolvers.envsh</span><br><span class="line">/docker-entrypoint.sh: Launching /docker-entrypoint.d/20-envsubst-on-templates.sh</span><br><span class="line">/docker-entrypoint.sh: Launching /docker-entrypoint.d/30-tune-worker-processes.sh</span><br><span class="line">/docker-entrypoint.sh: Configuration complete; ready <span class="keyword">for</span> start up</span><br><span class="line">2025/04/07 08:55:01 [notice] 1<span class="comment">#1: using the &quot;epoll&quot; event method</span></span><br><span class="line">2025/04/07 08:55:01 [notice] 1<span class="comment">#1: nginx/1.27.4</span></span><br><span class="line">2025/04/07 08:55:01 [notice] 1<span class="comment">#1: built by gcc 12.2.0 (Debian 12.2.0-14) </span></span><br><span class="line">2025/04/07 08:55:01 [notice] 1<span class="comment">#1: OS: Linux 4.18.0-553.el8_10.x86_64</span></span><br><span class="line">2025/04/07 08:55:01 [notice] 1<span class="comment">#1: getrlimit(RLIMIT_NOFILE): 1048576:1048576</span></span><br><span class="line">2025/04/07 08:55:01 [notice] 1<span class="comment">#1: start worker processes</span></span><br><span class="line">2025/04/07 08:55:01 [notice] 1<span class="comment">#1: start worker process 28</span></span><br><span class="line">2025/04/07 08:55:01 [notice] 1<span class="comment">#1: start worker process 29</span></span><br><span class="line">2025/04/07 08:55:01 [notice] 1<span class="comment">#1: start worker process 30</span></span><br><span class="line">2025/04/07 08:55:01 [notice] 1<span class="comment">#1: start worker process 31</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#另一个终端进入nginx容器</span></span><br><span class="line">[root@rocky8 ~]<span class="comment"># docker exec -it f35ebf8bb84f sh</span></span><br><span class="line"><span class="comment"># cat /etc/hosts         </span></span><br><span class="line">127.0.0.1	localhost</span><br><span class="line">::1	localhost ip6-localhost ip6-loopback</span><br><span class="line">fe00::0	ip6-localnet</span><br><span class="line">ff00::0	ip6-mcastprefix</span><br><span class="line">ff02::1	ip6-allnodes</span><br><span class="line">ff02::2	ip6-allrouters</span><br><span class="line">172.17.0.3	f35ebf8bb84f   <span class="comment">#IP地址</span></span><br><span class="line"><span class="comment"># ctrl+p+q</span></span><br><span class="line"></span><br><span class="line">[root@rocky8 ~]<span class="comment"># docker run --rm --name b1 busybox wget -qO - 172.17.0.3</span></span><br><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;<span class="built_in">head</span>&gt;</span><br><span class="line">&lt;title&gt;Welcome to nginx!&lt;/title&gt;</span><br><span class="line">&lt;style&gt;</span><br><span class="line">html &#123; color-scheme: light dark; &#125;</span><br><span class="line">body &#123; width: 35em; margin: 0 auto;</span><br><span class="line">font-family: Tahoma, Verdana, Arial, sans-serif; &#125;</span><br><span class="line">&lt;/style&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">&lt;h1&gt;Welcome to nginx!&lt;/h1&gt;</span><br><span class="line">&lt;p&gt;If you see this page, the nginx web server is successfully installed and</span><br><span class="line">working. Further configuration is required.&lt;/p&gt;</span><br><span class="line"></span><br><span class="line">&lt;p&gt;For online documentation and support please refer to</span><br><span class="line">&lt;a href=<span class="string">&quot;http://nginx.org/&quot;</span>&gt;nginx.org&lt;/a&gt;.&lt;br/&gt;</span><br><span class="line">Commercial support is available at</span><br><span class="line">&lt;a href=<span class="string">&quot;http://nginx.com/&quot;</span>&gt;nginx.com&lt;/a&gt;.&lt;/p&gt;</span><br><span class="line"></span><br><span class="line">&lt;p&gt;&lt;em&gt;Thank you <span class="keyword">for</span> using nginx.&lt;/em&gt;&lt;/p&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure>

<p>范例: 启动后台守护式容器</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">[root@rocky8 ~]<span class="comment"># docker run -d nginx</span></span><br><span class="line">10047369f7c26ba8b0d0a32705bbd77a96fc4ac729db979f33c50570e4c1648e</span><br><span class="line"></span><br><span class="line">[root@rocky8 ~]<span class="comment"># docker ps -l</span></span><br><span class="line">CONTAINER ID   IMAGE     COMMAND                  CREATED         STATUS         PORTS     NAMES</span><br><span class="line">10047369f7c2   nginx     <span class="string">&quot;/docker-entrypoint.…&quot;</span>   4 seconds ago   Up 3 seconds   80/tcp    competent_visvesvaraya</span><br><span class="line"></span><br><span class="line"><span class="comment">#有些容器后台启动不会持续运行</span></span><br><span class="line">[root@rocky8 ~]<span class="comment"># docker run -d --name alpine4 alpine</span></span><br><span class="line">d3762c34560b5e1855e8b492ba0d0972769ea38aefce0d495b27850d51e0f175</span><br><span class="line"></span><br><span class="line">[root@rocky8 ~]<span class="comment"># docker ps -a</span></span><br><span class="line">CONTAINER ID   IMAGE     COMMAND                  CREATED          STATUS                     PORTS     NAMES</span><br><span class="line">d3762c34560b   alpine    <span class="string">&quot;/bin/sh&quot;</span>                9 seconds ago    Exited (0) 8 seconds ago             alpine4</span><br><span class="line">10047369f7c2   nginx     <span class="string">&quot;/docker-entrypoint.…&quot;</span>   53 seconds ago   Up 51 seconds              80/tcp    competent_visvesvaraya</span><br><span class="line">f35ebf8bb84f   nginx     <span class="string">&quot;/docker-entrypoint.…&quot;</span>   5 minutes ago    Up 5 minutes               80/tcp    musing_cray</span><br><span class="line">e2d2b939be82   alpine    <span class="string">&quot;/bin/sh&quot;</span>                7 minutes ago    Up 7 minutes                         alpine3</span><br><span class="line">46c789f613b3   alpine    <span class="string">&quot;/bin/sh&quot;</span>                7 minutes ago    Exited (0) 7 minutes ago             alpine2</span><br><span class="line"></span><br><span class="line">[root@rocky8 ~]<span class="comment"># docker run -td --name alpine5 alpine</span></span><br><span class="line">185a22f886147340c5207585ae578b13ab32b843ee3616e03fd67602d690f44b</span><br><span class="line"></span><br><span class="line">[root@rocky8 ~]<span class="comment"># docker ps -a</span></span><br><span class="line">CONTAINER ID   IMAGE     COMMAND                  CREATED              STATUS                      PORTS     NAMES</span><br><span class="line">185a22f88614   alpine    <span class="string">&quot;/bin/sh&quot;</span>                3 seconds ago        Up 2 seconds                          alpine5</span><br><span class="line">d3762c34560b   alpine    <span class="string">&quot;/bin/sh&quot;</span>                58 seconds ago       Exited (0) 57 seconds ago             alpine4</span><br><span class="line">10047369f7c2   nginx     <span class="string">&quot;/docker-entrypoint.…&quot;</span>   About a minute ago   Up About a minute           80/tcp    competent_visvesvaraya</span><br><span class="line">f35ebf8bb84f   nginx     <span class="string">&quot;/docker-entrypoint.…&quot;</span>   5 minutes ago        Up 5 minutes                80/tcp    musing_cray</span><br><span class="line">e2d2b939be82   alpine    <span class="string">&quot;/bin/sh&quot;</span>                7 minutes ago        Up 7 minutes                          alpine3</span><br><span class="line">46c789f613b3   alpine    <span class="string">&quot;/bin/sh&quot;</span>                8 minutes ago        Exited (0) 8 minutes ago              alpine2</span><br></pre></td></tr></table></figure>

<p>范例: 开机自动运行容器</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#默认容器不会自动启动</span></span><br><span class="line">[root@rocky8 ~]<span class="comment"># docker run -d --name nginx -p 80:80 nginx</span></span><br><span class="line">f3816fb172d300183ada1aa0e31a3561f66dcc162389533293d480abe48210a9</span><br><span class="line"></span><br><span class="line">[root@rocky8 ~]<span class="comment"># docker ps</span></span><br><span class="line">CONTAINER ID   IMAGE     COMMAND                  CREATED          STATUS          PORTS                               NAMES</span><br><span class="line">f3816fb172d3   nginx     <span class="string">&quot;/docker-entrypoint.…&quot;</span>   2 seconds ago    Up 1 second     0.0.0.0:80-&gt;80/tcp, :::80-&gt;80/tcp   nginx</span><br><span class="line"></span><br><span class="line">[root@rocky8 ~]<span class="comment"># reboot</span></span><br><span class="line">[root@rocky8 ~]<span class="comment"># docker ps </span></span><br><span class="line">CONTAINER ID   IMAGE     COMMAND   CREATED   STATUS    PORTS     NAMES</span><br><span class="line"></span><br><span class="line"><span class="comment">#设置容器总是运行</span></span><br><span class="line">[root@rocky8 ~]<span class="comment"># docker run -d --name ngnix --restart=always -p 80:80 nginx</span></span><br><span class="line">047e2e36e07cabe62bd3538507ce8da45d45a0ee50171a868fb3106d2f29af33</span><br><span class="line"></span><br><span class="line">[root@rocky8 ~]<span class="comment"># reboot</span></span><br><span class="line">[root@rocky8 ~]<span class="comment"># docker ps</span></span><br><span class="line">CONTAINER ID   IMAGE     COMMAND                  CREATED          STATUS          PORTS                               NAMES</span><br><span class="line">047e2e36e07c   nginx     <span class="string">&quot;/docker-entrypoint.…&quot;</span>   35 seconds ago   Up 12 seconds   0.0.0.0:80-&gt;80/tcp, :::80-&gt;80/tcp   ngnix</span><br></pre></td></tr></table></figure>

<p><strong>–privileged 选项</strong></p>
<p>大约在0.6版，–privileged 选项被引入docker。使用该参数，container内的root拥有真正的root权限。否则，container内的root只是外部的一个普通用户权限。privileged启动的容器，可以看到很多host上的设备，并且可以执行mount。甚至允许你在docker容器中启动docker容器。</p>
<p>范例: 使用–privileged 让容器获取 root 权限</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">[root@rocky8 ~]<span class="comment"># docker run -it centos:centos7.7.1908</span></span><br><span class="line">[root@939a9ec34aef /]<span class="comment"># cat /etc/redhat-release </span></span><br><span class="line">CentOS Linux release 7.7.1908 (Core)</span><br><span class="line"></span><br><span class="line">[root@939a9ec34aef /]<span class="comment"># lsblk</span></span><br><span class="line">NAME   MAJ:MIN RM SIZE RO TYPE MOUNTPOINT</span><br><span class="line">sda      8:0    0 200G  0 disk </span><br><span class="line">|-sda1   8:1    0   1G  0 part </span><br><span class="line">|-sda2   8:2    0 100G  0 part </span><br><span class="line">|-sda3   8:3    0   50G  0 part </span><br><span class="line">|-sda4   8:4    0   1K  0 part </span><br><span class="line">`-sda5   8:5   0   2G 0 part [SWAP]</span><br><span class="line">sr0     11:0    1   7G  0 rom </span><br><span class="line">[root@382ab09932a7 /]<span class="comment"># mount /dev/sda3 /mnt</span></span><br><span class="line">mount: /mnt: permission denied.</span><br><span class="line"></span><br><span class="line">[root@939a9ec34aef /]<span class="comment"># exit</span></span><br><span class="line"><span class="built_in">exit</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#利用 --privileged 选项运行容器</span></span><br><span class="line">[root@rocky8 ~]<span class="comment"># docker run -it --privileged centos:centos7.7.1908</span></span><br><span class="line"><span class="comment">#可以看到宿主机的设备</span></span><br><span class="line">[root@a6391a8f82e3 /]<span class="comment"># lsblk</span></span><br><span class="line">NAME   MAJ:MIN RM SIZE RO TYPE MOUNTPOINT</span><br><span class="line">sda      8:0    0 200G  0 disk </span><br><span class="line">|-sda1   8:1    0   1G  0 part </span><br><span class="line">|-sda2   8:2    0 100G  0 part </span><br><span class="line">|-sda3   8:3    0   50G  0 part </span><br><span class="line">|-sda4   8:4    0   1K  0 part </span><br><span class="line">`-sda5   8:5   0   2G 0 part [SWAP]</span><br><span class="line">sr0     11:0    1   7G  0 rom </span><br><span class="line"></span><br><span class="line">[root@a6391a8f82e3 /]<span class="comment"># df</span></span><br><span class="line">Filesystem     1K-blocks   Used Available Use% Mounted on</span><br><span class="line">overlay        104806400 2754832 102051568   3% /</span><br><span class="line">tmpfs              65536       0     65536   0% /dev</span><br><span class="line">tmpfs             408092    5892    402200   2% /etc/hosts</span><br><span class="line">shm                64000       0     64000   0% /dev/shm</span><br><span class="line">tmpfs             408092       0    408092   0% /sys/fs/cgroup</span><br><span class="line">[root@a6391a8f82e3 /]<span class="comment"># mount /dev/sda3 /mnt</span></span><br><span class="line"></span><br><span class="line">[root@a6391a8f82e3 /]<span class="comment"># df</span></span><br><span class="line">Filesystem     1K-blocks   Used Available Use% Mounted on</span><br><span class="line">overlay        104806400 2754632 102051768   3% /</span><br><span class="line">tmpfs              65536       0     65536   0% /dev</span><br><span class="line">tmpfs             408092    5892    402200   2% /etc/hosts</span><br><span class="line">shm                64000       0     64000   0% /dev/shm</span><br><span class="line">tmpfs             408092       0    408092   0% /sys/fs/cgroup</span><br><span class="line">/dev/sda3       52403200  619068  51784132   2% /mnt</span><br></pre></td></tr></table></figure>

<p>范例: 运行docker官方文档容器</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ~]<span class="comment"># docker run -it -d -p 4000:4000 docs/docker.github.io:latest</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># docker images docs/docker.github.io</span></span><br><span class="line">REPOSITORY                       TAG     IMAGE ID       CREATED     SIZE</span><br><span class="line">docker.io/docs/docker.github.io   latest   ffd9131eeee7   2 days ago   1.99 GB</span><br><span class="line"><span class="comment">#用浏览器访问http://localhost:4000/可以看到下面docker文档资料</span></span><br></pre></td></tr></table></figure>

<p><img src="../../../../images/SRE/day46/29.jpg" alt="29"></p>
<h3 id="查看容器信息"><a href="#查看容器信息" class="headerlink" title="查看容器信息"></a>查看容器信息</h3><h4 id="显示当前存在容器"><a href="#显示当前存在容器" class="headerlink" title="显示当前存在容器"></a>显示当前存在容器</h4><p>格式</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">docker ps [OPTIONS]</span><br><span class="line">docker container <span class="built_in">ls</span> [OPTIONS]</span><br><span class="line"></span><br><span class="line">选项:  </span><br><span class="line">-a, --all             Show all containers (default shows just running)</span><br><span class="line">-q, --quiet           Only display numeric IDs</span><br><span class="line">-s, --size            Display total file sizes</span><br><span class="line">-f, --filter filter   Filter output based on conditions provided</span><br><span class="line">-l, --latest          Show the latest created container (includes all states)</span><br><span class="line">-n, --last int        Show n last created containers (includes all states) (default -1)</span><br></pre></td></tr></table></figure>

<p>范例: </p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#显示运行的容器</span></span><br><span class="line">[root@rocky8 ~]<span class="comment"># docker ps</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#显示全部容器，包括退出状态的容器</span></span><br><span class="line">[root@rocky8 ~]<span class="comment"># docker ps -a</span></span><br><span class="line">CONTAINER ID   IMAGE                   COMMAND       CREATED          STATUS                        PORTS     NAMES</span><br><span class="line">76818e032218   centos:centos7.7.1908   <span class="string">&quot;/bin/bash&quot;</span>   29 minutes ago   Exited (0) 23 minutes ago               magical_kapitsa</span><br><span class="line">1458fb8f2e1c   centos:centos7.7.1908   <span class="string">&quot;/bin/bash&quot;</span>   29 minutes ago   Exited (0) 29 minutes ago               admiring_diffie</span><br><span class="line">939a9ec34aef   centos:centos7.7.1908   <span class="string">&quot;/bin/bash&quot;</span>   32 minutes ago   Exited (127) 29 minutes ago             priceless_jepsen</span><br><span class="line"></span><br><span class="line"><span class="comment">#只显示容器ID</span></span><br><span class="line">[root@rocky8 ~]<span class="comment"># docker ps -aq</span></span><br><span class="line">76818e032218</span><br><span class="line">1458fb8f2e1c</span><br><span class="line">939a9ec34aef</span><br><span class="line"></span><br><span class="line"><span class="comment">#显示容器大小</span></span><br><span class="line">[root@rocky8 ~]<span class="comment"># docker ps -as</span></span><br><span class="line">CONTAINER ID   IMAGE                   COMMAND       CREATED          STATUS                        PORTS     NAMES              SIZE</span><br><span class="line">76818e032218   centos:centos7.7.1908   <span class="string">&quot;/bin/bash&quot;</span>   29 minutes ago   Exited (0) 24 minutes ago               magical_kapitsa    23B (virtual 204MB)</span><br><span class="line">1458fb8f2e1c   centos:centos7.7.1908   <span class="string">&quot;/bin/bash&quot;</span>   30 minutes ago   Exited (0) 29 minutes ago               admiring_diffie    14B (virtual 204MB)</span><br><span class="line">939a9ec34aef   centos:centos7.7.1908   <span class="string">&quot;/bin/bash&quot;</span>   32 minutes ago   Exited (127) 30 minutes ago             priceless_jepsen   44B (virtual 204MB)</span><br><span class="line"></span><br><span class="line"><span class="comment">#显示最新创建的容器(停止的容器也能显示)</span></span><br><span class="line">[root@rocky8 ~]<span class="comment"># docker ps -l</span></span><br><span class="line">CONTAINER ID   IMAGE                   COMMAND       CREATED          STATUS                      PORTS     NAMES</span><br><span class="line">76818e032218   centos:centos7.7.1908   <span class="string">&quot;/bin/bash&quot;</span>   30 minutes ago   Exited (0) 24 minutes ago             magical_kapitsa</span><br></pre></td></tr></table></figure>

<p>范例: 显示指定状态的容器</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">[root@rocky8 ~]<span class="comment"># docker ps -a</span></span><br><span class="line">CONTAINER ID   IMAGE                   COMMAND                  CREATED          STATUS                        PORTS                               NAMES</span><br><span class="line">7916dfca4670   nginx                   <span class="string">&quot;/docker-entrypoint.…&quot;</span>   16 seconds ago   Up 14 seconds                 0.0.0.0:80-&gt;80/tcp, :::80-&gt;80/tcp   ngnix</span><br><span class="line">76818e032218   centos:centos7.7.1908   <span class="string">&quot;/bin/bash&quot;</span>              30 minutes ago   Exited (0) 25 minutes ago                                         magical_kapitsa</span><br><span class="line">1458fb8f2e1c   centos:centos7.7.1908   <span class="string">&quot;/bin/bash&quot;</span>              31 minutes ago   Exited (0) 30 minutes ago                                         admiring_diffie</span><br><span class="line">939a9ec34aef   centos:centos7.7.1908   <span class="string">&quot;/bin/bash&quot;</span>              33 minutes ago   Exited (127) 31 minutes ago                                       priceless_jepsen</span><br><span class="line"></span><br><span class="line">[root@rocky8 ~]<span class="comment"># docker ps</span></span><br><span class="line">CONTAINER ID   IMAGE     COMMAND                  CREATED          STATUS          PORTS                               NAMES</span><br><span class="line">7916dfca4670   nginx     <span class="string">&quot;/docker-entrypoint.…&quot;</span>   20 seconds ago   Up 19 seconds   0.0.0.0:80-&gt;80/tcp, :::80-&gt;80/tcp   ngnix</span><br><span class="line"></span><br><span class="line"><span class="comment">#查看退出状态的容器</span></span><br><span class="line">[root@rocky8 ~]<span class="comment"># docker ps -f &#x27;status=exited&#x27;</span></span><br><span class="line">CONTAINER ID   IMAGE                   COMMAND       CREATED          STATUS                        PORTS     NAMES</span><br><span class="line">76818e032218   centos:centos7.7.1908   <span class="string">&quot;/bin/bash&quot;</span>   31 minutes ago   Exited (0) 25 minutes ago               magical_kapitsa</span><br><span class="line">1458fb8f2e1c   centos:centos7.7.1908   <span class="string">&quot;/bin/bash&quot;</span>   31 minutes ago   Exited (0) 31 minutes ago               admiring_diffie</span><br><span class="line">939a9ec34aef   centos:centos7.7.1908   <span class="string">&quot;/bin/bash&quot;</span>   34 minutes ago   Exited (127) 32 minutes ago             priceless_jepsen</span><br></pre></td></tr></table></figure>

<h4 id="查看容器内的进程"><a href="#查看容器内的进程" class="headerlink" title="查看容器内的进程"></a>查看容器内的进程</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker top CONTAINER [ps OPTIONS]</span><br></pre></td></tr></table></figure>

<p>范例: </p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">[root@rocky8 ~]<span class="comment"># docker run -d httpd</span></span><br><span class="line">0186ab10e78a7b1a42e4ff8a96efc41e83e9070d9ff536a8f12fc56f95bcf9f3</span><br><span class="line"></span><br><span class="line">[root@rocky8 ~]<span class="comment"># docker top 0186ab</span></span><br><span class="line">UID                 PID                 PPID                C                   STIME               TTY                 TIME                CMD</span><br><span class="line">root                2631                2610                0                   17:45               ?                   00:00:00            httpd -DFOREGROUND</span><br><span class="line">33                  2655                2631                0                   17:45               ?                   00:00:00            httpd -DFOREGROUND</span><br><span class="line">33                  2656                2631                0                   17:45               ?                   00:00:00            httpd -DFOREGROUND</span><br><span class="line">33                  2657                2631                0                   17:45               ?                   00:00:00            httpd -DFOREGROUND</span><br><span class="line"> </span><br><span class="line">[root@rocky8 ~]<span class="comment"># docker run -d alpine /bin/sh -c &#x27;i=1;while true;do echo hello$i;let i++;sleep 1;done&#x27;</span></span><br><span class="line">75ac4bb8b6fa2417fef6aa09dbe33ed112bbcd6fa900433b2b29de85fef40efe</span><br><span class="line"></span><br><span class="line">[root@rocky8 ~]<span class="comment"># docker top 75ac4b</span></span><br><span class="line">UID                 PID                 PPID                C                   STIME               TTY                 TIME                CMD</span><br><span class="line">root                2813                2791                0                   17:46               ?                   00:00:00            /bin/sh -c i=1;<span class="keyword">while</span> <span class="literal">true</span>;<span class="keyword">do</span> <span class="built_in">echo</span> hello<span class="variable">$i</span>;<span class="built_in">let</span> i++;<span class="built_in">sleep</span> 1;<span class="keyword">done</span></span><br><span class="line">root                2848                2813                0                   17:46               ?                   00:00:00            <span class="built_in">sleep</span> 1</span><br></pre></td></tr></table></figure>

<h4 id="查看容器资源使用情况"><a href="#查看容器资源使用情况" class="headerlink" title="查看容器资源使用情况"></a>查看容器资源使用情况</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">docker stats [OPTIONS] [CONTAINER...]</span><br><span class="line"></span><br><span class="line">Display a live stream of container(s) resource usage statistics</span><br><span class="line"></span><br><span class="line">Options:</span><br><span class="line">-a, --all             Show all containers (default shows just running)</span><br><span class="line">    --format string   Pretty-<span class="built_in">print</span> images using a Go template</span><br><span class="line">    --no-stream       Disable streaming stats and only pull the first result</span><br><span class="line">    --no-trunc        Do not <span class="built_in">truncate</span> output</span><br></pre></td></tr></table></figure>

<p>范例: </p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line">[root@rocky8 ~]<span class="comment"># docker stats 75ac4b</span></span><br><span class="line"></span><br><span class="line">CONTAINER ID   NAME              CPU %     MEM USAGE / LIMIT    MEM %     NET I/O     BLOCK I/O     PIDS</span><br><span class="line">75ac4bb8b6fa   elegant_leavitt   0.01%     2.32MiB / 3.799GiB   0.06%     866B / 0B   3.33MB / 0B   2</span><br><span class="line"></span><br><span class="line">CONTAINER ID   NAME              CPU %     MEM USAGE / LIMIT     MEM %     NET I/O     BLOCK I/O     PIDS</span><br><span class="line">75ac4bb8b6fa   elegant_leavitt   0.11%     2.336MiB / 3.799GiB   0.06%     866B / 0B   3.33MB / 0B   2</span><br><span class="line"></span><br><span class="line">CONTAINER ID   NAME              CPU %     MEM USAGE / LIMIT     MEM %     NET I/O     BLOCK I/O     PIDS</span><br><span class="line">75ac4bb8b6fa   elegant_leavitt   0.11%     2.336MiB / 3.799GiB   0.06%     866B / 0B   3.33MB / 0B   2</span><br><span class="line"></span><br><span class="line">CONTAINER ID   NAME              CPU %     MEM USAGE / LIMIT     MEM %     NET I/O     BLOCK I/O     PIDS</span><br><span class="line">75ac4bb8b6fa   elegant_leavitt   0.11%     2.336MiB / 3.799GiB   0.06%     866B / 0B   3.33MB / 0B   2</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#默认启动elasticsearch会使用较多的内存</span></span><br><span class="line">[root@rocky8 ~]<span class="comment"># docker run -d --name elasticsearch -p 9200:9200 -p 9300:9300 -e &quot;discovery.type=single-node&quot; elasticsearch:7.6.2</span></span><br><span class="line">55debcbd3f0fcd123096478d923d6a85a30a8c0a65c1f979e861fd42dee192c4</span><br><span class="line"></span><br><span class="line">[root@rocky8 ~]<span class="comment"># curl 192.168.1.11:9200</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;name&quot;</span> : <span class="string">&quot;55debcbd3f0f&quot;</span>,</span><br><span class="line">  <span class="string">&quot;cluster_name&quot;</span> : <span class="string">&quot;docker-cluster&quot;</span>,</span><br><span class="line">  <span class="string">&quot;cluster_uuid&quot;</span> : <span class="string">&quot;jei5FPBRT9-p0kcDIuYqlw&quot;</span>,</span><br><span class="line">  <span class="string">&quot;version&quot;</span> : &#123;</span><br><span class="line">    <span class="string">&quot;number&quot;</span> : <span class="string">&quot;7.6.2&quot;</span>,</span><br><span class="line">    <span class="string">&quot;build_flavor&quot;</span> : <span class="string">&quot;default&quot;</span>,</span><br><span class="line">    <span class="string">&quot;build_type&quot;</span> : <span class="string">&quot;docker&quot;</span>,</span><br><span class="line">    <span class="string">&quot;build_hash&quot;</span> : <span class="string">&quot;ef48eb35cf30adf4db14086e8aabd07ef6fb113f&quot;</span>,</span><br><span class="line">    <span class="string">&quot;build_date&quot;</span> : <span class="string">&quot;2020-03-26T06:34:37.794943Z&quot;</span>,</span><br><span class="line">    <span class="string">&quot;build_snapshot&quot;</span> : <span class="literal">false</span>,</span><br><span class="line">    <span class="string">&quot;lucene_version&quot;</span> : <span class="string">&quot;8.4.0&quot;</span>,</span><br><span class="line">    <span class="string">&quot;minimum_wire_compatibility_version&quot;</span> : <span class="string">&quot;6.8.0&quot;</span>,</span><br><span class="line">    <span class="string">&quot;minimum_index_compatibility_version&quot;</span> : <span class="string">&quot;6.0.0-beta1&quot;</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">&quot;tagline&quot;</span> : <span class="string">&quot;You Know, for Search&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">#查看所有容器</span></span><br><span class="line">[root@rocky8 ~]<span class="comment"># docker stats</span></span><br><span class="line"></span><br><span class="line">CONTAINER ID   NAME              CPU %     MEM USAGE / LIMIT     MEM %     NET I/O         BLOCK I/O         PIDS</span><br><span class="line">55debcbd3f0f   elasticsearch     1.19%     1.265GiB / 3.799GiB   33.29%    1.29kB / 984B   0B / 1.89MB       47</span><br><span class="line">75ac4bb8b6fa   elegant_leavitt   0.16%     2.457MiB / 3.799GiB   0.06%     1.02kB / 0B     3.33MB / 0B       2</span><br><span class="line">0186ab10e78a   elegant_cannon    0.00%     25.16MiB / 3.799GiB   0.65%     1.02kB / 0B     483kB / 0B        82</span><br><span class="line">7916dfca4670   ngnix             0.00%     5.18MiB / 3.799GiB    0.13%     1.31kB / 0B     1.36MB / 23.6kB   5</span><br><span class="line"></span><br><span class="line"><span class="comment">#限制内存使用大小</span></span><br><span class="line">[root@rocky8 ~]<span class="comment"># docker run -d --name elasticsearch -p 9200:9200 -p 9300:9300 -e &quot;discovery.type=single-node&quot; -e ES_JAVA_OPTS=&quot;-Xms64m -Xmx128m&quot;  elasticsearch:7.6.2</span></span><br><span class="line">8544b4374f6d6534f15be516274805a993cc65f62af0ada370370b23b2470748</span><br><span class="line"></span><br><span class="line">[root@rocky8 ~]<span class="comment"># docker stats</span></span><br><span class="line"></span><br><span class="line">CONTAINER ID   NAME            CPU %     MEM USAGE / LIMIT     MEM %     NET I/O     BLOCK I/O     PIDS</span><br><span class="line">8544b4374f6d   elasticsearch   1.17%     385.7MiB / 3.799GiB   9.92%     806B / 0B   0B / 1.69MB   48</span><br></pre></td></tr></table></figure>

<h4 id="查看容器的详细信息"><a href="#查看容器的详细信息" class="headerlink" title="查看容器的详细信息"></a>查看容器的详细信息</h4><p>docker inspect 可以查看docker各种对象的详细信息,包括:镜像,容器,网络等</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">docker inspect [OPTIONS] NAME|ID [NAME|ID...]</span><br><span class="line">Options:</span><br><span class="line">-f, --format string   Format the output using the given Go template</span><br><span class="line">-s, --size            Display total file sizes <span class="keyword">if</span> the <span class="built_in">type</span> is container</span><br></pre></td></tr></table></figure>

<p>范例: </p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br></pre></td><td class="code"><pre><span class="line">[root@rocky8 ~]<span class="comment"># docker run -d alpine /bin/sh -c &#x27;i=1;while true;do echo hello$i;let i++;sleep 1;done&#x27;</span></span><br><span class="line">08a0f574a380ba09be166e93f1fc16338d304c9c2ce22b075761137c7f784c1f</span><br><span class="line"></span><br><span class="line">[root@rocky8 ~]<span class="comment"># docker inspect 08a0f5</span></span><br><span class="line">[</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="string">&quot;Id&quot;</span>: <span class="string">&quot;08a0f574a380ba09be166e93f1fc16338d304c9c2ce22b075761137c7f784c1f&quot;</span>,</span><br><span class="line">        <span class="string">&quot;Created&quot;</span>: <span class="string">&quot;2025-04-07T10:12:39.096014483Z&quot;</span>,</span><br><span class="line">        <span class="string">&quot;Path&quot;</span>: <span class="string">&quot;/bin/sh&quot;</span>,</span><br><span class="line">        <span class="string">&quot;Args&quot;</span>: [</span><br><span class="line">            <span class="string">&quot;-c&quot;</span>,</span><br><span class="line">            <span class="string">&quot;i=1;while true;do echo hello<span class="variable">$i</span>;let i++;sleep 1;done&quot;</span></span><br><span class="line">        ],</span><br><span class="line">        <span class="string">&quot;State&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;Status&quot;</span>: <span class="string">&quot;running&quot;</span>,</span><br><span class="line">            <span class="string">&quot;Running&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">            <span class="string">&quot;Paused&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">            <span class="string">&quot;Restarting&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">            <span class="string">&quot;OOMKilled&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">            <span class="string">&quot;Dead&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">            <span class="string">&quot;Pid&quot;</span>: 4206,</span><br><span class="line">            <span class="string">&quot;ExitCode&quot;</span>: 0,</span><br><span class="line">            <span class="string">&quot;Error&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">            <span class="string">&quot;StartedAt&quot;</span>: <span class="string">&quot;2025-04-07T10:12:39.473043374Z&quot;</span>,</span><br><span class="line">            <span class="string">&quot;FinishedAt&quot;</span>: <span class="string">&quot;0001-01-01T00:00:00Z&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">&quot;Image&quot;</span>: <span class="string">&quot;sha256:aded1e1a5b3705116fa0a92ba074a5e0b0031647d9c315983ccba2ee5428ec8b&quot;</span>,</span><br><span class="line">        <span class="string">&quot;ResolvConfPath&quot;</span>: <span class="string">&quot;/var/lib/docker/containers/08a0f574a380ba09be166e93f1fc16338d304c9c2ce22b075761137c7f784c1f/resolv.conf&quot;</span>,</span><br><span class="line">        <span class="string">&quot;HostnamePath&quot;</span>: <span class="string">&quot;/var/lib/docker/containers/08a0f574a380ba09be166e93f1fc16338d304c9c2ce22b075761137c7f784c1f/hostname&quot;</span>,</span><br><span class="line">        <span class="string">&quot;HostsPath&quot;</span>: <span class="string">&quot;/var/lib/docker/containers/08a0f574a380ba09be166e93f1fc16338d304c9c2ce22b075761137c7f784c1f/hosts&quot;</span>,</span><br><span class="line">        <span class="string">&quot;LogPath&quot;</span>: <span class="string">&quot;/var/lib/docker/containers/08a0f574a380ba09be166e93f1fc16338d304c9c2ce22b075761137c7f784c1f/08a0f574a380ba09be166e93f1fc16338d304c9c2ce22b075761137c7f784c1f-json.log&quot;</span>,</span><br><span class="line">        <span class="string">&quot;Name&quot;</span>: <span class="string">&quot;/ecstatic_goodall&quot;</span>,</span><br><span class="line">        <span class="string">&quot;RestartCount&quot;</span>: 0,</span><br><span class="line">        <span class="string">&quot;Driver&quot;</span>: <span class="string">&quot;overlay2&quot;</span>,</span><br><span class="line">        <span class="string">&quot;Platform&quot;</span>: <span class="string">&quot;linux&quot;</span>,</span><br><span class="line">        <span class="string">&quot;MountLabel&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">        <span class="string">&quot;ProcessLabel&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">        <span class="string">&quot;AppArmorProfile&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">        <span class="string">&quot;ExecIDs&quot;</span>: null,</span><br><span class="line">        <span class="string">&quot;HostConfig&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;Binds&quot;</span>: null,</span><br><span class="line">            <span class="string">&quot;ContainerIDFile&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">            <span class="string">&quot;LogConfig&quot;</span>: &#123;</span><br><span class="line">                <span class="string">&quot;Type&quot;</span>: <span class="string">&quot;json-file&quot;</span>,</span><br><span class="line">                <span class="string">&quot;Config&quot;</span>: &#123;&#125;</span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="string">&quot;NetworkMode&quot;</span>: <span class="string">&quot;bridge&quot;</span>,</span><br><span class="line">            <span class="string">&quot;PortBindings&quot;</span>: &#123;&#125;,</span><br><span class="line">            <span class="string">&quot;RestartPolicy&quot;</span>: &#123;</span><br><span class="line">                <span class="string">&quot;Name&quot;</span>: <span class="string">&quot;no&quot;</span>,</span><br><span class="line">                <span class="string">&quot;MaximumRetryCount&quot;</span>: 0</span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="string">&quot;AutoRemove&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">            <span class="string">&quot;VolumeDriver&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">            <span class="string">&quot;VolumesFrom&quot;</span>: null,</span><br><span class="line">            <span class="string">&quot;ConsoleSize&quot;</span>: [</span><br><span class="line">                24,</span><br><span class="line">                105</span><br><span class="line">            ],</span><br><span class="line">            <span class="string">&quot;CapAdd&quot;</span>: null,</span><br><span class="line">            <span class="string">&quot;CapDrop&quot;</span>: null,</span><br><span class="line">            <span class="string">&quot;CgroupnsMode&quot;</span>: <span class="string">&quot;host&quot;</span>,</span><br><span class="line">            <span class="string">&quot;Dns&quot;</span>: [],</span><br><span class="line">            <span class="string">&quot;DnsOptions&quot;</span>: [],</span><br><span class="line">            <span class="string">&quot;DnsSearch&quot;</span>: [],</span><br><span class="line">            <span class="string">&quot;ExtraHosts&quot;</span>: null,</span><br><span class="line">            <span class="string">&quot;GroupAdd&quot;</span>: null,</span><br><span class="line">            <span class="string">&quot;IpcMode&quot;</span>: <span class="string">&quot;private&quot;</span>,</span><br><span class="line">            <span class="string">&quot;Cgroup&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">            <span class="string">&quot;Links&quot;</span>: null,</span><br><span class="line">            <span class="string">&quot;OomScoreAdj&quot;</span>: 0,</span><br><span class="line">            <span class="string">&quot;PidMode&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">            <span class="string">&quot;Privileged&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">            <span class="string">&quot;PublishAllPorts&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">            <span class="string">&quot;ReadonlyRootfs&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">            <span class="string">&quot;SecurityOpt&quot;</span>: null,</span><br><span class="line">            <span class="string">&quot;UTSMode&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">            <span class="string">&quot;UsernsMode&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">            <span class="string">&quot;ShmSize&quot;</span>: 67108864,</span><br><span class="line">            <span class="string">&quot;Runtime&quot;</span>: <span class="string">&quot;runc&quot;</span>,</span><br><span class="line">            <span class="string">&quot;Isolation&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">            <span class="string">&quot;CpuShares&quot;</span>: 0,</span><br><span class="line">            <span class="string">&quot;Memory&quot;</span>: 0,</span><br><span class="line">            <span class="string">&quot;NanoCpus&quot;</span>: 0,</span><br><span class="line">            <span class="string">&quot;CgroupParent&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">            <span class="string">&quot;BlkioWeight&quot;</span>: 0,</span><br><span class="line">            <span class="string">&quot;BlkioWeightDevice&quot;</span>: [],</span><br><span class="line">            <span class="string">&quot;BlkioDeviceReadBps&quot;</span>: [],</span><br><span class="line">            <span class="string">&quot;BlkioDeviceWriteBps&quot;</span>: [],</span><br><span class="line">            <span class="string">&quot;BlkioDeviceReadIOps&quot;</span>: [],</span><br><span class="line">            <span class="string">&quot;BlkioDeviceWriteIOps&quot;</span>: [],</span><br><span class="line">            <span class="string">&quot;CpuPeriod&quot;</span>: 0,</span><br><span class="line">            <span class="string">&quot;CpuQuota&quot;</span>: 0,</span><br><span class="line">            <span class="string">&quot;CpuRealtimePeriod&quot;</span>: 0,</span><br><span class="line">            <span class="string">&quot;CpuRealtimeRuntime&quot;</span>: 0,</span><br><span class="line">            <span class="string">&quot;CpusetCpus&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">            <span class="string">&quot;CpusetMems&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">            <span class="string">&quot;Devices&quot;</span>: [],</span><br><span class="line">            <span class="string">&quot;DeviceCgroupRules&quot;</span>: null,</span><br><span class="line">            <span class="string">&quot;DeviceRequests&quot;</span>: null,</span><br><span class="line">            <span class="string">&quot;MemoryReservation&quot;</span>: 0,</span><br><span class="line">            <span class="string">&quot;MemorySwap&quot;</span>: 0,</span><br><span class="line">            <span class="string">&quot;MemorySwappiness&quot;</span>: null,</span><br><span class="line">            <span class="string">&quot;OomKillDisable&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">            <span class="string">&quot;PidsLimit&quot;</span>: null,</span><br><span class="line">            <span class="string">&quot;Ulimits&quot;</span>: [],</span><br><span class="line">            <span class="string">&quot;CpuCount&quot;</span>: 0,</span><br><span class="line">            <span class="string">&quot;CpuPercent&quot;</span>: 0,</span><br><span class="line">            <span class="string">&quot;IOMaximumIOps&quot;</span>: 0,</span><br><span class="line">            <span class="string">&quot;IOMaximumBandwidth&quot;</span>: 0,</span><br><span class="line">            <span class="string">&quot;MaskedPaths&quot;</span>: [</span><br><span class="line">                <span class="string">&quot;/proc/asound&quot;</span>,</span><br><span class="line">                <span class="string">&quot;/proc/acpi&quot;</span>,</span><br><span class="line">                <span class="string">&quot;/proc/kcore&quot;</span>,</span><br><span class="line">                <span class="string">&quot;/proc/keys&quot;</span>,</span><br><span class="line">                <span class="string">&quot;/proc/latency_stats&quot;</span>,</span><br><span class="line">                <span class="string">&quot;/proc/timer_list&quot;</span>,</span><br><span class="line">                <span class="string">&quot;/proc/timer_stats&quot;</span>,</span><br><span class="line">                <span class="string">&quot;/proc/sched_debug&quot;</span>,</span><br><span class="line">                <span class="string">&quot;/proc/scsi&quot;</span>,</span><br><span class="line">                <span class="string">&quot;/sys/firmware&quot;</span>,</span><br><span class="line">                <span class="string">&quot;/sys/devices/virtual/powercap&quot;</span></span><br><span class="line">            ],</span><br><span class="line">            <span class="string">&quot;ReadonlyPaths&quot;</span>: [</span><br><span class="line">                <span class="string">&quot;/proc/bus&quot;</span>,</span><br><span class="line">                <span class="string">&quot;/proc/fs&quot;</span>,</span><br><span class="line">                <span class="string">&quot;/proc/irq&quot;</span>,</span><br><span class="line">                <span class="string">&quot;/proc/sys&quot;</span>,</span><br><span class="line">                <span class="string">&quot;/proc/sysrq-trigger&quot;</span></span><br><span class="line">            ]</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">&quot;GraphDriver&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;Data&quot;</span>: &#123;</span><br><span class="line">                <span class="string">&quot;LowerDir&quot;</span>: <span class="string">&quot;/var/lib/docker/overlay2/d3d1532ed4844473a09b14337e529c428c0264b52ae86642ce90da8415721c09-init/diff:/var/lib/docker/overlay2/1f2e711c2a688ce87a4484c61dd45092a07dff03f1af2802a01dcfc9f89f9947/diff&quot;</span>,</span><br><span class="line">                <span class="string">&quot;MergedDir&quot;</span>: <span class="string">&quot;/var/lib/docker/overlay2/d3d1532ed4844473a09b14337e529c428c0264b52ae86642ce90da8415721c09/merged&quot;</span>,</span><br><span class="line">                <span class="string">&quot;UpperDir&quot;</span>: <span class="string">&quot;/var/lib/docker/overlay2/d3d1532ed4844473a09b14337e529c428c0264b52ae86642ce90da8415721c09/diff&quot;</span>,</span><br><span class="line">                <span class="string">&quot;WorkDir&quot;</span>: <span class="string">&quot;/var/lib/docker/overlay2/d3d1532ed4844473a09b14337e529c428c0264b52ae86642ce90da8415721c09/work&quot;</span></span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="string">&quot;Name&quot;</span>: <span class="string">&quot;overlay2&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">&quot;Mounts&quot;</span>: [],</span><br><span class="line">        <span class="string">&quot;Config&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;Hostname&quot;</span>: <span class="string">&quot;08a0f574a380&quot;</span>,</span><br><span class="line">            <span class="string">&quot;Domainname&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">            <span class="string">&quot;User&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">            <span class="string">&quot;AttachStdin&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">            <span class="string">&quot;AttachStdout&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">            <span class="string">&quot;AttachStderr&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">            <span class="string">&quot;Tty&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">            <span class="string">&quot;OpenStdin&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">            <span class="string">&quot;StdinOnce&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">            <span class="string">&quot;Env&quot;</span>: [</span><br><span class="line">                <span class="string">&quot;PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin&quot;</span></span><br><span class="line">            ],</span><br><span class="line">            <span class="string">&quot;Cmd&quot;</span>: [</span><br><span class="line">                <span class="string">&quot;/bin/sh&quot;</span>,</span><br><span class="line">                <span class="string">&quot;-c&quot;</span>,</span><br><span class="line">                <span class="string">&quot;i=1;while true;do echo hello<span class="variable">$i</span>;let i++;sleep 1;done&quot;</span></span><br><span class="line">            ],</span><br><span class="line">            <span class="string">&quot;Image&quot;</span>: <span class="string">&quot;alpine&quot;</span>,</span><br><span class="line">            <span class="string">&quot;Volumes&quot;</span>: null,</span><br><span class="line">            <span class="string">&quot;WorkingDir&quot;</span>: <span class="string">&quot;/&quot;</span>,</span><br><span class="line">            <span class="string">&quot;Entrypoint&quot;</span>: null,</span><br><span class="line">            <span class="string">&quot;OnBuild&quot;</span>: null,</span><br><span class="line">            <span class="string">&quot;Labels&quot;</span>: &#123;&#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">&quot;NetworkSettings&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;Bridge&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">            <span class="string">&quot;SandboxID&quot;</span>: <span class="string">&quot;eb790be35916ad9a95540dbdf5de9d9d3046d7e1a43cd9add0e02c9073b8fc7c&quot;</span>,</span><br><span class="line">            <span class="string">&quot;SandboxKey&quot;</span>: <span class="string">&quot;/var/run/docker/netns/eb790be35916&quot;</span>,</span><br><span class="line">            <span class="string">&quot;Ports&quot;</span>: &#123;&#125;,</span><br><span class="line">            <span class="string">&quot;HairpinMode&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">            <span class="string">&quot;LinkLocalIPv6Address&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">            <span class="string">&quot;LinkLocalIPv6PrefixLen&quot;</span>: 0,</span><br><span class="line">            <span class="string">&quot;SecondaryIPAddresses&quot;</span>: null,</span><br><span class="line">            <span class="string">&quot;SecondaryIPv6Addresses&quot;</span>: null,</span><br><span class="line">            <span class="string">&quot;EndpointID&quot;</span>: <span class="string">&quot;c42012ade215635feb2b1b63f41050340079d912dc528205997a1e389808893e&quot;</span>,</span><br><span class="line">            <span class="string">&quot;Gateway&quot;</span>: <span class="string">&quot;172.17.0.1&quot;</span>,</span><br><span class="line">            <span class="string">&quot;GlobalIPv6Address&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">            <span class="string">&quot;GlobalIPv6PrefixLen&quot;</span>: 0,</span><br><span class="line">            <span class="string">&quot;IPAddress&quot;</span>: <span class="string">&quot;172.17.0.3&quot;</span>,</span><br><span class="line">            <span class="string">&quot;IPPrefixLen&quot;</span>: 16,</span><br><span class="line">            <span class="string">&quot;IPv6Gateway&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">            <span class="string">&quot;MacAddress&quot;</span>: <span class="string">&quot;02:42:ac:11:00:03&quot;</span>,</span><br><span class="line">            <span class="string">&quot;Networks&quot;</span>: &#123;</span><br><span class="line">                <span class="string">&quot;bridge&quot;</span>: &#123;</span><br><span class="line">                    <span class="string">&quot;IPAMConfig&quot;</span>: null,</span><br><span class="line">                    <span class="string">&quot;Links&quot;</span>: null,</span><br><span class="line">                    <span class="string">&quot;Aliases&quot;</span>: null,</span><br><span class="line">                    <span class="string">&quot;MacAddress&quot;</span>: <span class="string">&quot;02:42:ac:11:00:03&quot;</span>,</span><br><span class="line">                    <span class="string">&quot;NetworkID&quot;</span>: <span class="string">&quot;f2c0f57eee5abd7e3329ea9b7363e06af0230327e5f9fbc8d384b8b572c5ca59&quot;</span>,</span><br><span class="line">                    <span class="string">&quot;EndpointID&quot;</span>: <span class="string">&quot;c42012ade215635feb2b1b63f41050340079d912dc528205997a1e389808893e&quot;</span>,</span><br><span class="line">                    <span class="string">&quot;Gateway&quot;</span>: <span class="string">&quot;172.17.0.1&quot;</span>,</span><br><span class="line">                    <span class="string">&quot;IPAddress&quot;</span>: <span class="string">&quot;172.17.0.3&quot;</span>,</span><br><span class="line">                    <span class="string">&quot;IPPrefixLen&quot;</span>: 16,</span><br><span class="line">                    <span class="string">&quot;IPv6Gateway&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">                    <span class="string">&quot;GlobalIPv6Address&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">                    <span class="string">&quot;GlobalIPv6PrefixLen&quot;</span>: 0,</span><br><span class="line">                    <span class="string">&quot;DriverOpts&quot;</span>: null,</span><br><span class="line">                    <span class="string">&quot;DNSNames&quot;</span>: null</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line"><span class="comment">#选择性查看</span></span><br><span class="line">[root@rocky8 ~]<span class="comment"># docker inspect -f &quot;&#123;&#123;.Metadata&#125;&#125;&quot; 08a0f5 </span></span><br><span class="line"></span><br><span class="line">template parsing error: template: :1:2: executing <span class="string">&quot;&quot;</span> at &lt;.Metadata&gt;: map has no entry <span class="keyword">for</span> key <span class="string">&quot;Metadata&quot;</span></span><br><span class="line"></span><br><span class="line">[root@rocky8 ~]<span class="comment"># docker inspect -f &quot;&#123;&#123;.Created&#125;&#125;&quot; 08a0f5 </span></span><br><span class="line">2025-04-07T10:12:39.096014483Z</span><br><span class="line"></span><br><span class="line">[root@rocky8 ~]<span class="comment"># docker inspect --format &quot;&#123;&#123;.Created&#125;&#125;&quot; 08a0f5 </span></span><br><span class="line">2025-04-07T10:12:39.096014483Z</span><br></pre></td></tr></table></figure>

<h3 id="删除容器"><a href="#删除容器" class="headerlink" title="删除容器"></a>删除容器</h3><p>docker rm 可以删除容器，即使容器正在运行当中，也可以被强制删除掉</p>
<p>格式</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">docker <span class="built_in">rm</span> [OPTIONS] CONTAINER [CONTAINER...]</span><br><span class="line">docker container <span class="built_in">rm</span> [OPTIONS] CONTAINER [CONTAINER...]</span><br><span class="line"></span><br><span class="line"><span class="comment">#选项:  </span></span><br><span class="line">-f, --force     Force the removal of a running container (uses SIGKILL)</span><br><span class="line">-v, --volumes   Remove the volumes associated with the container</span><br><span class="line"></span><br><span class="line"><span class="comment">#删除停止的容器</span></span><br><span class="line">docker container prune [OPTIONS]</span><br><span class="line">Options:</span><br><span class="line">      --filter filter   Provide filter values (e.g. <span class="string">&#x27;until=&lt;timestamp&gt;&#x27;</span>)</span><br><span class="line">  -f, --force           Do not prompt <span class="keyword">for</span> confirmation</span><br></pre></td></tr></table></figure>

<p>范例: </p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[root@rocky8 ~]<span class="comment"># docker ps -a</span></span><br><span class="line">CONTAINER ID   IMAGE                 COMMAND                  CREATED        STATUS                      PORTS     NAMES</span><br><span class="line">08a0f574a380   alpine                <span class="string">&quot;/bin/sh -c &#x27;i=1;whi…&quot;</span>   14 hours ago   Exited (137) 12 hours ago             ecstatic_goodall</span><br><span class="line">8544b4374f6d   elasticsearch:7.6.2   <span class="string">&quot;/usr/local/bin/dock…&quot;</span>   14 hours ago   Exited (143) 12 hours ago             elasticsearch</span><br><span class="line"></span><br><span class="line">[root@rocky8 ~]<span class="comment"># docker rm 08a0f574a380</span></span><br><span class="line">08a0f574a380</span><br><span class="line"></span><br><span class="line">[root@rocky8 ~]<span class="comment"># docker rm elasticsearch</span></span><br><span class="line">elasticsearch</span><br><span class="line"></span><br><span class="line">[root@rocky8 ~]<span class="comment"># docker ps -a</span></span><br><span class="line">CONTAINER ID   IMAGE     COMMAND   CREATED   STATUS    PORTS     NAMES</span><br></pre></td></tr></table></figure>

<p>范例: 删除所有容器</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">[root@rocky8 ~]<span class="comment"># docker ps</span></span><br><span class="line">CONTAINER ID   IMAGE     COMMAND                  CREATED          STATUS          PORTS     NAMES</span><br><span class="line">85840eb8ad82   alpine    <span class="string">&quot;ping 8.8.8.8&quot;</span>           4 seconds ago    Up 3 seconds              a1</span><br><span class="line">6c8aafb81343   nginx     <span class="string">&quot;/docker-entrypoint.…&quot;</span>   36 seconds ago   Up 35 seconds   80/tcp    relaxed_tu</span><br><span class="line">8a54f8d25ecd   httpd     <span class="string">&quot;httpd-foreground&quot;</span>       41 seconds ago   Up 40 seconds   80/tcp    sad_montalcini</span><br><span class="line"></span><br><span class="line">[root@rocky8 ~]<span class="comment"># docker rm -f `docker ps -aq`</span></span><br><span class="line">85840eb8ad82</span><br><span class="line">6c8aafb81343</span><br><span class="line">8a54f8d25ecd</span><br><span class="line"></span><br><span class="line">[root@rocky8 ~]<span class="comment"># docker ps -a</span></span><br><span class="line">CONTAINER ID   IMAGE     COMMAND   CREATED   STATUS    PORTS     NAMES</span><br><span class="line"></span><br><span class="line">[root@rocky8 ~]<span class="comment"># docker ps -aq | xargs docker rm -f</span></span><br><span class="line">2f088e3f3827</span><br><span class="line">7b6de60ca4de</span><br><span class="line">daf51f6b687b</span><br><span class="line">5866c2002463</span><br></pre></td></tr></table></figure>

<p>范例: 删除指定状态的容器</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[root@rocky8 ~]<span class="comment"># docker ps -a</span></span><br><span class="line">CONTAINER ID   IMAGE     COMMAND                  CREATED          STATUS                      PORTS     NAMES</span><br><span class="line">736f59e27fe4   alpine    <span class="string">&quot;/bin/sh&quot;</span>                39 seconds ago   Exited (0) 38 seconds ago             reverent_burnell</span><br><span class="line">0227d775fbe9   alpine    <span class="string">&quot;ping 8.8.8.8&quot;</span>           39 seconds ago   Up 38 seconds                         gracious_austin</span><br><span class="line">0f5ae325ed84   nginx     <span class="string">&quot;/docker-entrypoint.…&quot;</span>   40 seconds ago   Up 38 seconds               80/tcp    intelligent_chandrasekhar</span><br><span class="line">7b03de1b8d6b   httpd     <span class="string">&quot;httpd-foreground&quot;</span>       40 seconds ago   Up 39 seconds               80/tcp    elated_elgamal</span><br><span class="line"></span><br><span class="line">[root@rocky8 ~]<span class="comment"># docker rm `docker ps -qf status=exited`</span></span><br><span class="line">736f59e27fe4</span><br><span class="line"></span><br><span class="line">[root@rocky8 ~]<span class="comment"># docker ps -a</span></span><br><span class="line">CONTAINER ID   IMAGE     COMMAND                  CREATED          STATUS          PORTS     NAMES</span><br><span class="line">0227d775fbe9   alpine    <span class="string">&quot;ping 8.8.8.8&quot;</span>           47 seconds ago   Up 46 seconds             gracious_austin</span><br><span class="line">0f5ae325ed84   nginx     <span class="string">&quot;/docker-entrypoint.…&quot;</span>   48 seconds ago   Up 47 seconds   80/tcp    intelligent_chandrasekhar</span><br><span class="line">7b03de1b8d6b   httpd     <span class="string">&quot;httpd-foreground&quot;</span>       48 seconds ago   Up 47 seconds   80/tcp    elated_elgamal</span><br></pre></td></tr></table></figure>

<p>范例: 删除所有停止的容器</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">[root@rocky8 ~]<span class="comment"># docker stop `docker ps -qa`</span></span><br><span class="line">0227d775fbe9</span><br><span class="line">0f5ae325ed84</span><br><span class="line">7b03de1b8d6b</span><br><span class="line"></span><br><span class="line">[root@rocky8 ~]<span class="comment"># docker ps -a</span></span><br><span class="line">CONTAINER ID   IMAGE     COMMAND                  CREATED         STATUS                        PORTS     NAMES</span><br><span class="line">0227d775fbe9   alpine    <span class="string">&quot;ping 8.8.8.8&quot;</span>           3 minutes ago   Exited (137) 10 seconds ago             gracious_austin</span><br><span class="line">0f5ae325ed84   nginx     <span class="string">&quot;/docker-entrypoint.…&quot;</span>   3 minutes ago   Exited (0) 20 seconds ago               intelligent_chandrasekhar</span><br><span class="line">7b03de1b8d6b   httpd     <span class="string">&quot;httpd-foreground&quot;</span>       3 minutes ago   Exited (0) 19 seconds ago               elated_elgamal</span><br><span class="line"></span><br><span class="line">[root@rocky8 ~]<span class="comment"># docker container prune -f</span></span><br><span class="line">Deleted Containers:</span><br><span class="line">0227d775fbe91cb4845f27d2339534e3ffc95f0dff099bed13443be7ba0cbc34</span><br><span class="line">0f5ae325ed84d686ded23fbbac5fcfbf46cd814cadbbacbd0025f683398647fd</span><br><span class="line">7b03de1b8d6ba6ae243fa9a7a15a5525cd55c8d9dc72f18fdbb5bd2a7615da7d</span><br><span class="line"></span><br><span class="line">Total reclaimed space: 1.093kB</span><br><span class="line"></span><br><span class="line">[root@rocky8 ~]<span class="comment"># docker ps -a</span></span><br><span class="line">CONTAINER ID   IMAGE     COMMAND   CREATED   STATUS    PORTS     NAMES</span><br></pre></td></tr></table></figure>

<h3 id="容器的启动和停止"><a href="#容器的启动和停止" class="headerlink" title="容器的启动和停止"></a>容器的启动和停止</h3><p>格式</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker start|stop|restart|pause|unpause 容器ID</span><br></pre></td></tr></table></figure>

<p>批量正常启动或关闭所有容器</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">docker start $(docker ps -a -q)  </span><br><span class="line">docker stop $(docker ps -a -q) </span><br></pre></td></tr></table></figure>

<p>范例: </p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">[root@rocky8 ~]<span class="comment"># docker run -d --name nginx1 nginx</span></span><br><span class="line">9da772bc04c74891bbf755d39f48018dd0be69ffb7f618c554a3cebcc128a7ba</span><br><span class="line"></span><br><span class="line">[root@rocky8 ~]<span class="comment"># docker ps -a</span></span><br><span class="line">CONTAINER ID   IMAGE     COMMAND                  CREATED         STATUS         PORTS     NAMES</span><br><span class="line">9da772bc04c7   nginx     <span class="string">&quot;/docker-entrypoint.…&quot;</span>   5 seconds ago   Up 5 seconds   80/tcp    nginx1</span><br><span class="line"></span><br><span class="line">[root@rocky8 ~]<span class="comment"># docker stop nginx1 </span></span><br><span class="line">nginx1</span><br><span class="line"></span><br><span class="line">[root@rocky8 ~]<span class="comment"># docker ps -a</span></span><br><span class="line">CONTAINER ID   IMAGE     COMMAND                  CREATED          STATUS                     PORTS     NAMES</span><br><span class="line">9da772bc04c7   nginx     <span class="string">&quot;/docker-entrypoint.…&quot;</span>   19 seconds ago   Exited (0) 2 seconds ago             nginx1</span><br><span class="line"></span><br><span class="line">[root@rocky8 ~]<span class="comment"># docker start nginx1 </span></span><br><span class="line">nginx1</span><br><span class="line"></span><br><span class="line">[root@rocky8 ~]<span class="comment"># docker ps -a</span></span><br><span class="line">CONTAINER ID   IMAGE     COMMAND                  CREATED          STATUS         PORTS     NAMES</span><br><span class="line">9da772bc04c7   nginx     <span class="string">&quot;/docker-entrypoint.…&quot;</span>   32 seconds ago   Up 2 seconds   80/tcp    nginx1</span><br><span class="line"></span><br><span class="line">[root@rocky8 ~]<span class="comment"># docker restart nginx1 </span></span><br><span class="line">nginx1</span><br><span class="line"></span><br><span class="line">[root@rocky8 ~]<span class="comment"># docker ps -a</span></span><br><span class="line">CONTAINER ID   IMAGE     COMMAND                  CREATED          STATUS        PORTS     NAMES</span><br><span class="line">9da772bc04c7   nginx     <span class="string">&quot;/docker-entrypoint.…&quot;</span>   39 seconds ago   Up 1 second   80/tcp    nginx1</span><br></pre></td></tr></table></figure>

<p>范例: 启动并进入容器</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">[root@rocky8 ~]<span class="comment"># docker run --name c1 -it ubuntu bash</span></span><br><span class="line">Unable to find image <span class="string">&#x27;ubuntu:latest&#x27;</span> locally</span><br><span class="line">latest: Pulling from library/ubuntu</span><br><span class="line">5a7813e071bf: Pull complete </span><br><span class="line">Digest: sha256:72297848456d5d37d1262630108ab308d3e9ec7ed1c3286a32fe09856619a782</span><br><span class="line">Status: Downloaded newer image <span class="keyword">for</span> ubuntu:latest</span><br><span class="line">root@087d1e8eb24c:/<span class="comment"># exit</span></span><br><span class="line"><span class="built_in">exit</span></span><br><span class="line"></span><br><span class="line">[root@rocky8 ~]<span class="comment"># docker ps -l</span></span><br><span class="line">CONTAINER ID   IMAGE     COMMAND   CREATED          STATUS                     PORTS     NAMES</span><br><span class="line">087d1e8eb24c   ubuntu    <span class="string">&quot;bash&quot;</span>    13 seconds ago   Exited (0) 3 seconds ago             c1</span><br><span class="line"></span><br><span class="line">[root@rocky8 ~]<span class="comment"># docker start c1 </span></span><br><span class="line">c1</span><br><span class="line"></span><br><span class="line">[root@rocky8 ~]<span class="comment"># docker ps -l</span></span><br><span class="line">CONTAINER ID   IMAGE     COMMAND   CREATED          STATUS        PORTS     NAMES</span><br><span class="line">087d1e8eb24c   ubuntu    <span class="string">&quot;bash&quot;</span>    21 seconds ago   Up 1 second             c1</span><br><span class="line"></span><br><span class="line">[root@rocky8 ~]<span class="comment"># docker stop c1 </span></span><br><span class="line">c1</span><br><span class="line"></span><br><span class="line">[root@rocky8 ~]<span class="comment"># docker ps -l</span></span><br><span class="line">CONTAINER ID   IMAGE     COMMAND   CREATED          STATUS                       PORTS     NAMES</span><br><span class="line">087d1e8eb24c   ubuntu    <span class="string">&quot;bash&quot;</span>    51 seconds ago   Exited (137) 5 seconds ago             c1</span><br><span class="line"></span><br><span class="line"><span class="comment">#启动并进入容器</span></span><br><span class="line">[root@rocky8 ~]<span class="comment"># docker start -i c1 </span></span><br><span class="line">root@087d1e8eb24c:/<span class="comment"># exit</span></span><br><span class="line"><span class="built_in">exit</span></span><br><span class="line"></span><br><span class="line">[root@rocky8 ~]<span class="comment"># docker ps -l</span></span><br><span class="line">CONTAINER ID   IMAGE     COMMAND   CREATED         STATUS                     PORTS     NAMES</span><br><span class="line">087d1e8eb24c   ubuntu    <span class="string">&quot;bash&quot;</span>    2 minutes ago   Exited (0) 2 seconds ago             c1</span><br></pre></td></tr></table></figure>

<p>范例: 启动和停止所有容器</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">[root@rocky8 ~]<span class="comment"># docker rm -f `docker ps -aq`</span></span><br><span class="line">087d1e8eb24c</span><br><span class="line">9da772bc04c7</span><br><span class="line"></span><br><span class="line">[root@rocky8 ~]<span class="comment"># docker run -d --name nginx1 nginx</span></span><br><span class="line">e091ef51076092115a362c2e7b31a44fef580efc5fbbd681e49fb8c926ce7e4d</span><br><span class="line"></span><br><span class="line">[root@rocky8 ~]<span class="comment"># docker run -d --name nginx2 nginx</span></span><br><span class="line">1385dac196bfd5ee5fcb33ee124b29ea6837eab60a7f6b869149974b7df7a1f7</span><br><span class="line"></span><br><span class="line">[root@rocky8 ~]<span class="comment"># docker ps -a</span></span><br><span class="line">CONTAINER ID   IMAGE     COMMAND                  CREATED         STATUS         PORTS     NAMES</span><br><span class="line">1385dac196bf   nginx     <span class="string">&quot;/docker-entrypoint.…&quot;</span>   3 seconds ago   Up 2 seconds   80/tcp    nginx2</span><br><span class="line">e091ef510760   nginx     <span class="string">&quot;/docker-entrypoint.…&quot;</span>   7 seconds ago   Up 6 seconds   80/tcp    nginx1</span><br><span class="line"></span><br><span class="line">[root@rocky8 ~]<span class="comment"># docker stop `docker ps -aq`</span></span><br><span class="line">1385dac196bf</span><br><span class="line">e091ef510760</span><br><span class="line"></span><br><span class="line">[root@rocky8 ~]<span class="comment"># docker ps -a</span></span><br><span class="line">CONTAINER ID   IMAGE     COMMAND                  CREATED          STATUS                     PORTS     NAMES</span><br><span class="line">1385dac196bf   nginx     <span class="string">&quot;/docker-entrypoint.…&quot;</span>   16 seconds ago   Exited (0) 3 seconds ago             nginx2</span><br><span class="line">e091ef510760   nginx     <span class="string">&quot;/docker-entrypoint.…&quot;</span>   20 seconds ago   Exited (0) 3 seconds ago             nginx1</span><br><span class="line"></span><br><span class="line">[root@rocky8 ~]<span class="comment"># docker start `docker ps -aq`</span></span><br><span class="line">1385dac196bf</span><br><span class="line">e091ef510760</span><br><span class="line"></span><br><span class="line">[root@rocky8 ~]<span class="comment"># docker ps -a</span></span><br><span class="line">CONTAINER ID   IMAGE     COMMAND                  CREATED          STATUS         PORTS     NAMES</span><br><span class="line">1385dac196bf   nginx     <span class="string">&quot;/docker-entrypoint.…&quot;</span>   26 seconds ago   Up 4 seconds   80/tcp    nginx2</span><br><span class="line">e091ef510760   nginx     <span class="string">&quot;/docker-entrypoint.…&quot;</span>   30 seconds ago   Up 3 seconds   80/tcp    nginx1</span><br></pre></td></tr></table></figure>

<p>范例: 暂停和恢复容器</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">[root@rocky8 ~]<span class="comment"># docker run -d --name n1 nginx</span></span><br><span class="line">3ea6c5504968a12dbe9c3d1bb274888b8157a3b05ca664e164695e07e5516bff</span><br><span class="line"></span><br><span class="line">[root@rocky8 ~]<span class="comment"># docker top n1</span></span><br><span class="line">UID                 PID                 PPID                C                   STIME               TTY                 TIME                CMD</span><br><span class="line">root                6206                6185                0                   08:30               ?                   00:00:00            nginx: master process nginx -g daemon off;</span><br><span class="line">101                 6250                6206                0                   08:30               ?                   00:00:00            nginx: worker process</span><br><span class="line">101                 6251                6206                0                   08:30               ?                   00:00:00            nginx: worker process</span><br><span class="line">101                 6252                6206                0                   08:30               ?                   00:00:00            nginx: worker process</span><br><span class="line">101                 6253                6206                0                   08:30               ?                   00:00:00            nginx: worker process</span><br><span class="line"></span><br><span class="line">[root@rocky8 ~]<span class="comment"># ps aux | grep nginx</span></span><br><span class="line">root        6206  0.1  0.1  11456  7672 ?        Ss   08:30   0:00 nginx: master process nginx -g daemon off;</span><br><span class="line">101         6250  0.0  0.0  11952  2788 ?        S    08:30   0:00 nginx: worker process</span><br><span class="line">101         6251  0.0  0.0  11952  2788 ?        S    08:30   0:00 nginx: worker process</span><br><span class="line">101         6252  0.0  0.0  11952  2788 ?        S    08:30   0:00 nginx: worker process</span><br><span class="line">101         6253  0.0  0.0  11952  2792 ?        S    08:30   0:00 nginx: worker process</span><br><span class="line">root        6268  0.0  0.0 222012  1100 pts/0    S+   08:31   0:00 grep --color=autonginx</span><br><span class="line"></span><br><span class="line">[root@rocky8 ~]<span class="comment"># docker pause n1</span></span><br><span class="line">n1</span><br><span class="line"></span><br><span class="line">[root@rocky8 ~]<span class="comment"># docker ps</span></span><br><span class="line">CONTAINER ID   IMAGE     COMMAND                  CREATED          STATUS                   PORTS     NAMES</span><br><span class="line">3ea6c5504968   nginx     <span class="string">&quot;/docker-entrypoint.…&quot;</span>   29 seconds ago   Up 28 seconds (Paused)   80/tcp    n1</span><br><span class="line"></span><br><span class="line">[root@rocky8 ~]<span class="comment"># ps aux | grep nginx</span></span><br><span class="line">root        6206  0.0  0.1  11456  7672 ?        Ds   08:30   0:00 nginx: master process nginx -g daemon off;</span><br><span class="line">101         6250  0.0  0.0  11952  2788 ?        D    08:30   0:00 nginx: worker process</span><br><span class="line">101         6251  0.0  0.0  11952  2788 ?        D    08:30   0:00 nginx: worker process</span><br><span class="line">101         6252  0.0  0.0  11952  2788 ?        D    08:30   0:00 nginx: worker process</span><br><span class="line">101         6253  0.0  0.0  11952  2792 ?        D    08:30   0:00 nginx: worker process</span><br><span class="line">root        6289  0.0  0.0 222012  1172 pts/0    S+   08:31   0:00 grep --color=autonginx</span><br><span class="line"></span><br><span class="line">[root@rocky8 ~]<span class="comment"># docker unpause n1</span></span><br><span class="line">n1</span><br><span class="line"></span><br><span class="line">[root@rocky8 ~]<span class="comment"># ps aux | grep nginx</span></span><br><span class="line">root        6206  0.0  0.1  11456  7672 ?        Ss   08:30   0:00 nginx: master process nginx -g daemon off;</span><br><span class="line">101         6250  0.0  0.0  11952  2788 ?        S    08:30   0:00 nginx: worker process</span><br><span class="line">101         6251  0.0  0.0  11952  2788 ?        S    08:30   0:00 nginx: worker process</span><br><span class="line">101         6252  0.0  0.0  11952  2788 ?        S    08:30   0:00 nginx: worker process</span><br><span class="line">101         6253  0.0  0.0  11952  2792 ?        S    08:30   0:00 nginx: worker process</span><br><span class="line">root        6353  0.0  0.0 222012  1200 pts/0    S+   08:32   0:00 grep --color=autonginx</span><br></pre></td></tr></table></figure>

<p>范例: 容器的暂停和恢复</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">[root@rocky8 ~]<span class="comment"># docker run -itd centos:8</span></span><br><span class="line">b96b24033d05fa8de1ce9a79305a78fd34047c38bad4ecbcb187c1e7e33137f3</span><br><span class="line"></span><br><span class="line">[root@rocky8 ~]<span class="comment"># docker ps -a</span></span><br><span class="line">CONTAINER ID   IMAGE      COMMAND                  CREATED         STATUS         PORTS     NAMES</span><br><span class="line">b96b24033d05   centos:8   <span class="string">&quot;/bin/bash&quot;</span>              4 seconds ago   Up 3 seconds             upbeat_khayyam</span><br><span class="line">3ea6c5504968   nginx      <span class="string">&quot;/docker-entrypoint.…&quot;</span>   5 minutes ago   Up 5 minutes   80/tcp    n1</span><br><span class="line"></span><br><span class="line">[root@rocky8 ~]<span class="comment"># docker pause upbeat_khayyam </span></span><br><span class="line">upbeat_khayyam</span><br><span class="line"></span><br><span class="line">[root@rocky8 ~]<span class="comment"># docker ps -a</span></span><br><span class="line">CONTAINER ID   IMAGE      COMMAND                  CREATED          STATUS                   PORTS     NAMES</span><br><span class="line">b96b24033d05   centos:8   <span class="string">&quot;/bin/bash&quot;</span>              26 seconds ago   Up 25 seconds (Paused)             upbeat_khayyam</span><br><span class="line">3ea6c5504968   nginx      <span class="string">&quot;/docker-entrypoint.…&quot;</span>   5 minutes ago    Up 5 minutes             80/tcp    n1</span><br><span class="line"></span><br><span class="line">[root@rocky8 ~]<span class="comment"># docker unpause upbeat_khayyam </span></span><br><span class="line">upbeat_khayyam</span><br><span class="line"></span><br><span class="line">[root@rocky8 ~]<span class="comment"># docker ps -a</span></span><br><span class="line">CONTAINER ID   IMAGE      COMMAND                  CREATED          STATUS          PORTS     NAMES</span><br><span class="line">b96b24033d05   centos:8   <span class="string">&quot;/bin/bash&quot;</span>              48 seconds ago   Up 47 seconds             upbeat_khayyam</span><br><span class="line">3ea6c5504968   nginx      <span class="string">&quot;/docker-entrypoint.…&quot;</span>   6 minutes ago    Up 6 minutes    80/tcp    n1</span><br></pre></td></tr></table></figure>

<h3 id="给正在运行的容器发信号"><a href="#给正在运行的容器发信号" class="headerlink" title="给正在运行的容器发信号"></a>给正在运行的容器发信号</h3><p>docker kill 可以给容器发信号,默认号SIGKILL,即9信号</p>
<p>格式</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">docker <span class="built_in">kill</span> [OPTIONS] CONTAINER [CONTAINER...]</span><br><span class="line"></span><br><span class="line"><span class="comment">#选项:</span></span><br><span class="line">-s, --signal string   Signal to send to the container (default <span class="string">&quot;KILL&quot;</span>)</span><br></pre></td></tr></table></figure>

<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[root@rocky8 ~]<span class="comment"># docker ps -a</span></span><br><span class="line">CONTAINER ID   IMAGE      COMMAND                  CREATED         STATUS         PORTS     NAMES</span><br><span class="line">b96b24033d05   centos:8   <span class="string">&quot;/bin/bash&quot;</span>              2 minutes ago   Up 2 minutes             upbeat_khayyam</span><br><span class="line">3ea6c5504968   nginx      <span class="string">&quot;/docker-entrypoint.…&quot;</span>   7 minutes ago   Up 7 minutes   80/tcp    n1</span><br><span class="line"></span><br><span class="line">[root@rocky8 ~]<span class="comment"># docker kill n1 </span></span><br><span class="line">n1</span><br><span class="line"></span><br><span class="line">[root@rocky8 ~]<span class="comment"># docker ps -a</span></span><br><span class="line">CONTAINER ID   IMAGE      COMMAND                  CREATED         STATUS                       PORTS     NAMES</span><br><span class="line">b96b24033d05   centos:8   <span class="string">&quot;/bin/bash&quot;</span>              2 minutes ago   Up 2 minutes                           upbeat_khayyam</span><br><span class="line">3ea6c5504968   nginx      <span class="string">&quot;/docker-entrypoint.…&quot;</span>   8 minutes ago   Exited (137) 2 seconds ago             n1</span><br></pre></td></tr></table></figure>

<p>范例: 关闭所有容器</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[root@rocky8 ~]<span class="comment"># docker ps -a</span></span><br><span class="line">CONTAINER ID   IMAGE      COMMAND                  CREATED         STATUS         PORTS     NAMES</span><br><span class="line">b96b24033d05   centos:8   <span class="string">&quot;/bin/bash&quot;</span>              3 minutes ago   Up 3 minutes             upbeat_khayyam</span><br><span class="line">3ea6c5504968   nginx      <span class="string">&quot;/docker-entrypoint.…&quot;</span>   9 minutes ago   Up 1 second    80/tcp    n1</span><br><span class="line"></span><br><span class="line"><span class="comment">#强制关闭所有运行中的容器</span></span><br><span class="line">[root@rocky8 ~]<span class="comment"># docker kill `docker ps -aq`</span></span><br><span class="line">b96b24033d05</span><br><span class="line">3ea6c5504968</span><br><span class="line"></span><br><span class="line">[root@rocky8 ~]<span class="comment"># docker ps -a</span></span><br><span class="line">CONTAINER ID   IMAGE      COMMAND                  CREATED         STATUS                       PORTS     NAMES</span><br><span class="line">b96b24033d05   centos:8   <span class="string">&quot;/bin/bash&quot;</span>              4 minutes ago   Exited (137) 5 seconds ago             upbeat_khayyam</span><br><span class="line">3ea6c5504968   nginx      <span class="string">&quot;/docker-entrypoint.…&quot;</span>   9 minutes ago   Exited (137) 5 seconds ago             n1</span><br></pre></td></tr></table></figure>

<h3 id="进入正在运行的容器"><a href="#进入正在运行的容器" class="headerlink" title="进入正在运行的容器"></a>进入正在运行的容器</h3><h4 id="使用attach命令"><a href="#使用attach命令" class="headerlink" title="使用attach命令"></a>使用attach命令</h4><p>docker attach 容器名，attach 类似于vnc，操作会在同一个容器的多个会话界面同步显示，所有使用此方式进入容器的操作都是同步显示的，且使用exit退出后容器自动关闭，<strong>不推荐使用</strong>，需要进入到有shell环境的容器</p>
<p>格式: </p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker attach [OPTIONS] CONTAINER</span><br></pre></td></tr></table></figure>

<p>范例: </p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">[root@rocky8 ~]<span class="comment"># docker run -it centos:8</span></span><br><span class="line">[root@a3d06b403f2d /]<span class="comment"># cat /etc/redhat-release </span></span><br><span class="line">CentOS Linux release 8.4.2105</span><br><span class="line"> <span class="comment">#ctrl+p+q 退出</span></span><br><span class="line"></span><br><span class="line">[root@rocky8 ~]<span class="comment"># docker ps</span></span><br><span class="line">CONTAINER ID   IMAGE      COMMAND       CREATED          STATUS          PORTS     NAMES</span><br><span class="line">a3d06b403f2d   centos:8   <span class="string">&quot;/bin/bash&quot;</span>   23 seconds ago   Up 22 seconds             blissful_kare</span><br><span class="line"></span><br><span class="line">[root@rocky8 ~]<span class="comment"># docker attach a3d06b</span></span><br><span class="line">[root@a3d06b403f2d /]<span class="comment"># cat /etc/redhat-release </span></span><br><span class="line">CentOS Linux release 8.4.2105</span><br><span class="line"></span><br><span class="line"><span class="comment">#同时在第二个终端attach到同一个容器，执行命令，可以在前一终端看到显示图面是同步的</span></span><br><span class="line">[root@rocky8 /]<span class="comment"># docker attach a3d06b</span></span><br><span class="line">[root@a3d06b403f2d /]<span class="comment"># cat /etc/redhat-release </span></span><br><span class="line">CentOS Linux release 8.4.2105</span><br><span class="line"></span><br><span class="line"><span class="comment">#两个终端都同时退出</span></span><br><span class="line">[root@a3d06b403f2d /]<span class="comment"># exit</span></span><br><span class="line"><span class="built_in">exit</span></span><br><span class="line"></span><br><span class="line">[root@rocky8 ~]<span class="comment"># docker ps -a</span></span><br><span class="line">CONTAINER ID   IMAGE      COMMAND       CREATED         STATUS                      PORTS     NAMES</span><br><span class="line">a3d06b403f2d   centos:8   <span class="string">&quot;/bin/bash&quot;</span>   2 minutes ago   Exited (0) 25 seconds ago             blissful_kare</span><br></pre></td></tr></table></figure>

<h4 id="使用exec命令"><a href="#使用exec命令" class="headerlink" title="使用exec命令"></a>使用exec命令</h4><p>在运行中的容器启动新进程,可以执行单次命令，以及进入容器</p>
<p>测试环境使用此方式，使用exit退出,但容器还在运行，<strong>此为推荐方式</strong></p>
<p>格式: </p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">docker <span class="built_in">exec</span> [OPTIONS] CONTAINER COMMAND [ARG...]</span><br><span class="line">常用选项:  </span><br><span class="line">-d, --detach               Detached mode: run <span class="built_in">command</span> <span class="keyword">in</span> the background</span><br><span class="line">-e, --<span class="built_in">env</span> list             Set environment variables</span><br><span class="line">-i, --interactive          Keep STDIN open even <span class="keyword">if</span> not attached</span><br><span class="line">-t, --<span class="built_in">tty</span>                  Allocate a pseudo-TTY</span><br><span class="line"></span><br><span class="line"><span class="comment">#常见用法</span></span><br><span class="line">docker <span class="built_in">exec</span> -it 容器ID sh|bash</span><br></pre></td></tr></table></figure>

<p>范例: </p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">[root@rocky8 ~]<span class="comment"># docker run -itd centos:8</span></span><br><span class="line">363bd34686630dbfd71ba719d14b9d905347fbb98d72fd9c987679c3203d6885</span><br><span class="line"></span><br><span class="line">[root@rocky8 ~]<span class="comment"># docker ps</span></span><br><span class="line">CONTAINER ID   IMAGE      COMMAND       CREATED         STATUS         PORTS     NAMES</span><br><span class="line">363bd3468663   centos:8   <span class="string">&quot;/bin/bash&quot;</span>   4 seconds ago   Up 3 seconds             vibrant_rosalind</span><br><span class="line"></span><br><span class="line"><span class="comment">#执行一次性命令</span></span><br><span class="line">[root@rocky8 ~]<span class="comment"># docker exec 363bd3 cat /etc/redhat-release</span></span><br><span class="line">CentOS Linux release 8.4.2105</span><br><span class="line"></span><br><span class="line"><span class="comment">#进入容器，执行命令，exit退出但容器不停止</span></span><br><span class="line">[root@rocky8 ~]<span class="comment"># docker exec -it 363bd3 bash</span></span><br><span class="line">[root@363bd3468663 /]<span class="comment"># cat /etc/redhat-release </span></span><br><span class="line">CentOS Linux release 8.4.2105</span><br><span class="line"></span><br><span class="line">[root@363bd3468663 /]<span class="comment"># exit</span></span><br><span class="line"><span class="built_in">exit</span></span><br><span class="line"></span><br><span class="line">[root@rocky8 ~]<span class="comment"># docker ps</span></span><br><span class="line">CONTAINER ID   IMAGE      COMMAND       CREATED              STATUS              PORTS     NAMES</span><br><span class="line">363bd3468663   centos:8   <span class="string">&quot;/bin/bash&quot;</span>   About a minute ago   Up About a minute             vibrant_rosalind</span><br></pre></td></tr></table></figure>

<h3 id="暴露所有容器端口"><a href="#暴露所有容器端口" class="headerlink" title="暴露所有容器端口"></a>暴露所有容器端口</h3><p>容器启动后,默认处于预定义的NAT网络中,所以外部网络的主机无法直接访问容器中网络服务</p>
<p><strong>docker run -P</strong> 可以将事先容器预定义的所有端口映射宿主机的网卡的随机端口，默认从32768开始</p>
<p>使用随机端口 时,当停止容器后再启动可能会导致端口发生变化</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">-P , --publish-all= <span class="literal">true</span> | <span class="literal">false</span>默认为<span class="literal">false</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#示例:</span></span><br><span class="line">docker run -d -P --name nginx-c1 nginx  <span class="comment">#映射容器所有暴露端口至随机本地端口</span></span><br></pre></td></tr></table></figure>

<p><strong>docker port</strong> 可以查看容器的端口映射关系</p>
<p>格式</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker port CONTAINER [PRIVATE_PORT[/PROTO]]</span><br></pre></td></tr></table></figure>

<p>范例: </p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@rocky8 ~]<span class="comment"># docker port nginx-c1 </span></span><br><span class="line">80/tcp -&gt; 0.0.0.0:32769</span><br><span class="line">80/tcp -&gt; [::]:32769</span><br><span class="line"></span><br><span class="line">[root@rocky8 ~]<span class="comment"># docker port nginx-c1 80/tcp</span></span><br><span class="line">0.0.0.0:32769</span><br><span class="line">[::]:32769</span><br></pre></td></tr></table></figure>

<p>范例: </p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br></pre></td><td class="code"><pre><span class="line">[root@rocky8 ~]<span class="comment"># docker ps -a</span></span><br><span class="line">CONTAINER ID   IMAGE     COMMAND   CREATED   STATUS    PORTS     NAMES</span><br><span class="line"></span><br><span class="line">[root@rocky8 ~]<span class="comment"># ss -lnt</span></span><br><span class="line">State    Recv-Q   Send-Q      Local Address:Port       Peer Address:Port   Process   </span><br><span class="line">LISTEN   0        128               0.0.0.0:22              0.0.0.0:*                </span><br><span class="line">LISTEN   0        128                  [::]:22                 [::]:*                </span><br><span class="line"></span><br><span class="line"><span class="comment">#前台启动的会话窗口无法进行其他操作，除非退出，但是退出后容器也会退出</span></span><br><span class="line">[root@rocky8 ~]<span class="comment"># docker run -P nginx</span></span><br><span class="line">/docker-entrypoint.sh: /docker-entrypoint.d/ is not empty, will attempt to perform configuration</span><br><span class="line">/docker-entrypoint.sh: Looking <span class="keyword">for</span> shell scripts <span class="keyword">in</span> /docker-entrypoint.d/</span><br><span class="line">/docker-entrypoint.sh: Launching /docker-entrypoint.d/10-listen-on-ipv6-by-default.sh</span><br><span class="line">10-listen-on-ipv6-by-default.sh: info: Getting the checksum of /etc/nginx/conf.d/default.conf</span><br><span class="line">10-listen-on-ipv6-by-default.sh: info: Enabled listen on IPv6 <span class="keyword">in</span> /etc/nginx/conf.d/default.conf</span><br><span class="line">/docker-entrypoint.sh: Sourcing /docker-entrypoint.d/15-local-resolvers.envsh</span><br><span class="line">/docker-entrypoint.sh: Launching /docker-entrypoint.d/20-envsubst-on-templates.sh</span><br><span class="line">/docker-entrypoint.sh: Launching /docker-entrypoint.d/30-tune-worker-processes.sh</span><br><span class="line">/docker-entrypoint.sh: Configuration complete; ready <span class="keyword">for</span> start up</span><br><span class="line">2025/04/08 00:56:05 [notice] 1<span class="comment">#1: using the &quot;epoll&quot; event method</span></span><br><span class="line">2025/04/08 00:56:05 [notice] 1<span class="comment">#1: nginx/1.27.4</span></span><br><span class="line">2025/04/08 00:56:05 [notice] 1<span class="comment">#1: built by gcc 12.2.0 (Debian 12.2.0-14) </span></span><br><span class="line">2025/04/08 00:56:05 [notice] 1<span class="comment">#1: OS: Linux 4.18.0-553.el8_10.x86_64</span></span><br><span class="line">2025/04/08 00:56:05 [notice] 1<span class="comment">#1: getrlimit(RLIMIT_NOFILE): 1048576:1048576</span></span><br><span class="line">2025/04/08 00:56:05 [notice] 1<span class="comment">#1: start worker processes</span></span><br><span class="line">2025/04/08 00:56:05 [notice] 1<span class="comment">#1: start worker process 28</span></span><br><span class="line">2025/04/08 00:56:05 [notice] 1<span class="comment">#1: start worker process 29</span></span><br><span class="line">2025/04/08 00:56:05 [notice] 1<span class="comment">#1: start worker process 30</span></span><br><span class="line">2025/04/08 00:56:05 [notice] 1<span class="comment">#1: start worker process 31</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#另开一个窗口执行下面命令</span></span><br><span class="line">[root@rocky8 /]<span class="comment"># ss -lnt</span></span><br><span class="line">State    Recv-Q   Send-Q     Local Address:Port        Peer Address:Port   Process   </span><br><span class="line">LISTEN   0        128              0.0.0.0:22               0.0.0.0:*                </span><br><span class="line">LISTEN   0        2048             0.0.0.0:32770            0.0.0.0:*                </span><br><span class="line">LISTEN   0        128                 [::]:22                  [::]:*                </span><br><span class="line">LISTEN   0        2048                [::]:32770               [::]:*                </span><br><span class="line"></span><br><span class="line">[root@rocky8 /]<span class="comment"># docker ps </span></span><br><span class="line">CONTAINER ID   IMAGE     COMMAND                  CREATED          STATUS          PORTS                                     NAMES</span><br><span class="line">33e4f9e80b99   nginx     <span class="string">&quot;/docker-entrypoint.…&quot;</span>   56 seconds ago   Up 56 seconds   0.0.0.0:32770-&gt;80/tcp, :::32770-&gt;80/tcp   nice_ganguly</span><br><span class="line"></span><br><span class="line">[root@rocky8 /]<span class="comment"># curl 127.0.0.1:32770</span></span><br><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;<span class="built_in">head</span>&gt;</span><br><span class="line">&lt;title&gt;Welcome to nginx!&lt;/title&gt;</span><br><span class="line">&lt;style&gt;</span><br><span class="line">html &#123; color-scheme: light dark; &#125;</span><br><span class="line">body &#123; width: 35em; margin: 0 auto;</span><br><span class="line">font-family: Tahoma, Verdana, Arial, sans-serif; &#125;</span><br><span class="line">&lt;/style&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">&lt;h1&gt;Welcome to nginx!&lt;/h1&gt;</span><br><span class="line">&lt;p&gt;If you see this page, the nginx web server is successfully installed and</span><br><span class="line">working. Further configuration is required.&lt;/p&gt;</span><br><span class="line"></span><br><span class="line">&lt;p&gt;For online documentation and support please refer to</span><br><span class="line">&lt;a href=<span class="string">&quot;http://nginx.org/&quot;</span>&gt;nginx.org&lt;/a&gt;.&lt;br/&gt;</span><br><span class="line">Commercial support is available at</span><br><span class="line">&lt;a href=<span class="string">&quot;http://nginx.com/&quot;</span>&gt;nginx.com&lt;/a&gt;.&lt;/p&gt;</span><br><span class="line"></span><br><span class="line">&lt;p&gt;&lt;em&gt;Thank you <span class="keyword">for</span> using nginx.&lt;/em&gt;&lt;/p&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment">#自动生成Iptables规则</span></span><br><span class="line">[root@rocky8 /]<span class="comment"># iptables -vnL -t nat</span></span><br><span class="line">Chain PREROUTING (policy ACCEPT 0 packets, 0 bytes)</span><br><span class="line"> pkts bytes target     prot opt <span class="keyword">in</span>     out     <span class="built_in">source</span>               destination         </span><br><span class="line">    2   104 DOCKER     all  --  *      *       0.0.0.0/0            0.0.0.0/0            ADDRTYPE match dst-type LOCAL</span><br><span class="line"></span><br><span class="line">Chain INPUT (policy ACCEPT 0 packets, 0 bytes)</span><br><span class="line"> pkts bytes target     prot opt <span class="keyword">in</span>     out     <span class="built_in">source</span>               destination         </span><br><span class="line"></span><br><span class="line">Chain POSTROUTING (policy ACCEPT 0 packets, 0 bytes)</span><br><span class="line"> pkts bytes target     prot opt <span class="keyword">in</span>     out     <span class="built_in">source</span>               destination         </span><br><span class="line">    3   252 MASQUERADE  all  --  *      !docker0  172.17.0.0/16        0.0.0.0/0           </span><br><span class="line">    0     0 MASQUERADE  tcp  --  *      *       172.17.0.2           172.17.0.2           tcp dpt:80</span><br><span class="line"></span><br><span class="line">Chain OUTPUT (policy ACCEPT 0 packets, 0 bytes)</span><br><span class="line"> pkts bytes target     prot opt <span class="keyword">in</span>     out     <span class="built_in">source</span>               destination         </span><br><span class="line">    0     0 DOCKER     all  --  *      *       0.0.0.0/0           !127.0.0.0/8          ADDRTYPE match dst-type LOCAL</span><br><span class="line"></span><br><span class="line">Chain DOCKER (2 references)</span><br><span class="line"> pkts bytes target     prot opt <span class="keyword">in</span>     out     <span class="built_in">source</span>               destination         </span><br><span class="line">    0     0 RETURN     all  --  docker0 *       0.0.0.0/0            0.0.0.0/0           </span><br><span class="line">    0     0 DNAT       tcp  --  !docker0 *       0.0.0.0/0            0.0.0.0/0            tcp dpt:32770 to:172.17.0.2:80</span><br><span class="line"></span><br><span class="line"><span class="comment">#回到之前的会话窗口，同时按两个键 ctrl+c 退出容器</span></span><br><span class="line">[root@rocky8 ~]<span class="comment"># docker ps -a</span></span><br><span class="line">CONTAINER ID   IMAGE     COMMAND                  CREATED         STATUS                      PORTS     NAMES</span><br><span class="line">33e4f9e80b99   nginx     <span class="string">&quot;/docker-entrypoint.…&quot;</span>   3 minutes ago   Exited (0) 14 seconds ago             nice_ganguly</span><br></pre></td></tr></table></figure>

<p><strong>端口映射的本质就是利用NAT技术实现的</strong></p>
<p>范例: 端口映射和iptables</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#端口映射前的iptables规则</span></span><br><span class="line">[root@rocky8 ~]<span class="comment"># iptables -S</span></span><br><span class="line">-P INPUT ACCEPT</span><br><span class="line">-P FORWARD DROP</span><br><span class="line">-P OUTPUT ACCEPT</span><br><span class="line">-N DOCKER</span><br><span class="line">-N DOCKER-ISOLATION-STAGE-1</span><br><span class="line">-N DOCKER-ISOLATION-STAGE-2</span><br><span class="line">-N DOCKER-USER</span><br><span class="line">-A FORWARD -j DOCKER-USER</span><br><span class="line">-A FORWARD -j DOCKER-ISOLATION-STAGE-1</span><br><span class="line">-A FORWARD -o docker0 -m conntrack --ctstate RELATED,ESTABLISHED -j ACCEPT</span><br><span class="line">-A FORWARD -o docker0 -j DOCKER</span><br><span class="line">-A FORWARD -i docker0 ! -o docker0 -j ACCEPT</span><br><span class="line">-A FORWARD -i docker0 -o docker0 -j ACCEPT</span><br><span class="line">-A DOCKER-ISOLATION-STAGE-1 -i docker0 ! -o docker0 -j DOCKER-ISOLATION-STAGE-2</span><br><span class="line">-A DOCKER-ISOLATION-STAGE-1 -j RETURN</span><br><span class="line">-A DOCKER-ISOLATION-STAGE-2 -o docker0 -j DROP</span><br><span class="line">-A DOCKER-ISOLATION-STAGE-2 -j RETURN</span><br><span class="line">-A DOCKER-USER -j RETURN</span><br><span class="line"></span><br><span class="line">[root@rocky8 ~]<span class="comment"># iptables -S -t nat</span></span><br><span class="line">-P PREROUTING ACCEPT</span><br><span class="line">-P INPUT ACCEPT</span><br><span class="line">-P POSTROUTING ACCEPT</span><br><span class="line">-P OUTPUT ACCEPT</span><br><span class="line">-N DOCKER</span><br><span class="line">-A PREROUTING -m addrtype --dst-type LOCAL -j DOCKER</span><br><span class="line">-A POSTROUTING -s 172.17.0.0/16 ! -o docker0 -j MASQUERADE</span><br><span class="line">-A OUTPUT ! -d 127.0.0.0/8 -m addrtype --dst-type LOCAL -j DOCKER</span><br><span class="line">-A DOCKER -i docker0 -j RETURN</span><br><span class="line"></span><br><span class="line">[root@rocky8 ~]<span class="comment"># iptables -S &gt; pre.filter</span></span><br><span class="line">[root@rocky8 ~]<span class="comment"># iptables -S -t nat &gt; pre.nat</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#实现端口映射</span></span><br><span class="line">[root@rocky8 ~]<span class="comment"># docker run -d -P --name nginx1 nginx</span></span><br><span class="line">c20e59dcc412733425ce8dd4726711c8ac6ebd34a40440c06c103af418a8ccb9</span><br><span class="line"></span><br><span class="line">[root@rocky8 ~]<span class="comment"># docker exec -it nginx1 hostname -i</span></span><br><span class="line">172.17.0.2</span><br><span class="line"></span><br><span class="line">[root@rocky8 ~]<span class="comment"># docker port nginx1 </span></span><br><span class="line">80/tcp -&gt; 0.0.0.0:32771</span><br><span class="line">80/tcp -&gt; [::]:32771</span><br><span class="line"></span><br><span class="line"><span class="comment">#端口映射后的iptables规则</span></span><br><span class="line">[root@rocky8 ~]<span class="comment"># iptables -S</span></span><br><span class="line">-P INPUT ACCEPT</span><br><span class="line">-P FORWARD DROP</span><br><span class="line">-P OUTPUT ACCEPT</span><br><span class="line">-N DOCKER</span><br><span class="line">-N DOCKER-ISOLATION-STAGE-1</span><br><span class="line">-N DOCKER-ISOLATION-STAGE-2</span><br><span class="line">-N DOCKER-USER</span><br><span class="line">-A FORWARD -j DOCKER-USER</span><br><span class="line">-A FORWARD -j DOCKER-ISOLATION-STAGE-1</span><br><span class="line">-A FORWARD -o docker0 -m conntrack --ctstate RELATED,ESTABLISHED -j ACCEPT</span><br><span class="line">-A FORWARD -o docker0 -j DOCKER</span><br><span class="line">-A FORWARD -i docker0 ! -o docker0 -j ACCEPT</span><br><span class="line">-A FORWARD -i docker0 -o docker0 -j ACCEPT</span><br><span class="line">-A DOCKER -d 172.17.0.2/32 ! -i docker0 -o docker0 -p tcp -m tcp --dport 80 -j ACCEPT</span><br><span class="line">-A DOCKER-ISOLATION-STAGE-1 -i docker0 ! -o docker0 -j DOCKER-ISOLATION-STAGE-2</span><br><span class="line">-A DOCKER-ISOLATION-STAGE-1 -j RETURN</span><br><span class="line">-A DOCKER-ISOLATION-STAGE-2 -o docker0 -j DROP</span><br><span class="line">-A DOCKER-ISOLATION-STAGE-2 -j RETURN</span><br><span class="line">-A DOCKER-USER -j RETURN</span><br><span class="line"></span><br><span class="line">[root@rocky8 ~]<span class="comment"># iptables -S -t nat</span></span><br><span class="line">-P PREROUTING ACCEPT</span><br><span class="line">-P INPUT ACCEPT</span><br><span class="line">-P POSTROUTING ACCEPT</span><br><span class="line">-P OUTPUT ACCEPT</span><br><span class="line">-N DOCKER</span><br><span class="line">-A PREROUTING -m addrtype --dst-type LOCAL -j DOCKER</span><br><span class="line">-A POSTROUTING -s 172.17.0.0/16 ! -o docker0 -j MASQUERADE</span><br><span class="line">-A POSTROUTING -s 172.17.0.2/32 -d 172.17.0.2/32 -p tcp -m tcp --dport 80 -j MASQUERADE</span><br><span class="line">-A OUTPUT ! -d 127.0.0.0/8 -m addrtype --dst-type LOCAL -j DOCKER</span><br><span class="line">-A DOCKER -i docker0 -j RETURN</span><br><span class="line">-A DOCKER ! -i docker0 -p tcp -m tcp --dport 32771 -j DNAT --to-destination 172.17.0.2:80</span><br><span class="line"></span><br><span class="line"><span class="comment">#对比端口映射前后的变化</span></span><br><span class="line">[root@rocky8 ~]<span class="comment"># diff pre.filter post.filter </span></span><br><span class="line">13a14</span><br><span class="line">&gt; -A DOCKER -d 172.17.0.2/32 ! -i docker0 -o docker0 -p tcp -m tcp --dport 80 -j ACCEPT</span><br><span class="line"></span><br><span class="line">[root@rocky8 ~]<span class="comment"># diff pre.nat post.nat </span></span><br><span class="line">7a8</span><br><span class="line">&gt; -A POSTROUTING -s 172.17.0.2/32 -d 172.17.0.2/32 -p tcp -m tcp --dport 80 -j MASQUERADE</span><br><span class="line">9a11</span><br><span class="line">&gt; -A DOCKER ! -i docker0 -p tcp -m tcp --dport 32771 -j DNAT --to-destination 172.17.0.2:80</span><br><span class="line"></span><br><span class="line"><span class="comment">#本地和选程都可以访问</span></span><br><span class="line">[root@rocky8 ~]<span class="comment"># curl 127.0.0.1:32771</span></span><br><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;<span class="built_in">head</span>&gt;</span><br><span class="line">&lt;title&gt;Welcome to nginx!&lt;/title&gt;</span><br><span class="line">&lt;style&gt;</span><br><span class="line">html &#123; color-scheme: light dark; &#125;</span><br><span class="line">body &#123; width: 35em; margin: 0 auto;</span><br><span class="line">font-family: Tahoma, Verdana, Arial, sans-serif; &#125;</span><br><span class="line">&lt;/style&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">&lt;h1&gt;Welcome to nginx!&lt;/h1&gt;</span><br><span class="line">&lt;p&gt;If you see this page, the nginx web server is successfully installed and</span><br><span class="line">working. Further configuration is required.&lt;/p&gt;</span><br><span class="line"></span><br><span class="line">&lt;p&gt;For online documentation and support please refer to</span><br><span class="line">&lt;a href=<span class="string">&quot;http://nginx.org/&quot;</span>&gt;nginx.org&lt;/a&gt;.&lt;br/&gt;</span><br><span class="line">Commercial support is available at</span><br><span class="line">&lt;a href=<span class="string">&quot;http://nginx.com/&quot;</span>&gt;nginx.com&lt;/a&gt;.&lt;/p&gt;</span><br><span class="line"></span><br><span class="line">&lt;p&gt;&lt;em&gt;Thank you <span class="keyword">for</span> using nginx.&lt;/em&gt;&lt;/p&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@rocky8 ~]<span class="comment"># curl 192.168.1.11:32771</span></span><br><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;<span class="built_in">head</span>&gt;</span><br><span class="line">&lt;title&gt;Welcome to nginx!&lt;/title&gt;</span><br><span class="line">&lt;style&gt;</span><br><span class="line">html &#123; color-scheme: light dark; &#125;</span><br><span class="line">body &#123; width: 35em; margin: 0 auto;</span><br><span class="line">font-family: Tahoma, Verdana, Arial, sans-serif; &#125;</span><br><span class="line">&lt;/style&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">&lt;h1&gt;Welcome to nginx!&lt;/h1&gt;</span><br><span class="line">&lt;p&gt;If you see this page, the nginx web server is successfully installed and</span><br><span class="line">working. Further configuration is required.&lt;/p&gt;</span><br><span class="line"></span><br><span class="line">&lt;p&gt;For online documentation and support please refer to</span><br><span class="line">&lt;a href=<span class="string">&quot;http://nginx.org/&quot;</span>&gt;nginx.org&lt;/a&gt;.&lt;br/&gt;</span><br><span class="line">Commercial support is available at</span><br><span class="line">&lt;a href=<span class="string">&quot;http://nginx.com/&quot;</span>&gt;nginx.com&lt;/a&gt;.&lt;/p&gt;</span><br><span class="line"></span><br><span class="line">&lt;p&gt;&lt;em&gt;Thank you <span class="keyword">for</span> using nginx.&lt;/em&gt;&lt;/p&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment">#利用iptables 阻止同一个宿主机的其它容器CentOS8的访问</span></span><br><span class="line">[root@rocky8 ~]<span class="comment"># iptables -I DOCKER -s 192.168.1.11 -d 172.17.0.2 -p tcp --dport 80 -j REJECT</span></span><br><span class="line"></span><br><span class="line">[root@rocky8 ~]<span class="comment"># iptables -S</span></span><br><span class="line">-P INPUT ACCEPT</span><br><span class="line">-P FORWARD DROP</span><br><span class="line">-P OUTPUT ACCEPT</span><br><span class="line">-N DOCKER</span><br><span class="line">-N DOCKER-ISOLATION-STAGE-1</span><br><span class="line">-N DOCKER-ISOLATION-STAGE-2</span><br><span class="line">-N DOCKER-USER</span><br><span class="line">-A FORWARD -j DOCKER-USER</span><br><span class="line">-A FORWARD -j DOCKER-ISOLATION-STAGE-1</span><br><span class="line">-A FORWARD -o docker0 -m conntrack --ctstate RELATED,ESTABLISHED -j ACCEPT</span><br><span class="line">-A FORWARD -o docker0 -j DOCKER</span><br><span class="line">-A FORWARD -i docker0 ! -o docker0 -j ACCEPT</span><br><span class="line">-A FORWARD -i docker0 -o docker0 -j ACCEPT</span><br><span class="line">-A DOCKER -s 192.168.1.11/32 -d 172.17.0.2/32 -p tcp -m tcp --dport 80 -j REJECT --reject-with icmp-port-unreachable</span><br><span class="line">-A DOCKER -d 172.17.0.2/32 ! -i docker0 -o docker0 -p tcp -m tcp --dport 80 -j ACCEPT</span><br><span class="line">-A DOCKER-ISOLATION-STAGE-1 -i docker0 ! -o docker0 -j DOCKER-ISOLATION-STAGE-2</span><br><span class="line">-A DOCKER-ISOLATION-STAGE-1 -j RETURN</span><br><span class="line">-A DOCKER-ISOLATION-STAGE-2 -o docker0 -j DROP</span><br><span class="line">-A DOCKER-ISOLATION-STAGE-2 -j RETURN</span><br><span class="line">-A DOCKER-USER -j RETURN</span><br><span class="line"></span><br><span class="line"><span class="comment">#测试访问</span></span><br><span class="line">[root@rocky8 ~]<span class="comment"># docker run -it centos:8</span></span><br><span class="line">[root@4ff6133ab467 /]<span class="comment"># curl 172.17.0.2      </span></span><br><span class="line">curl: (7) Failed to connect to 172.17.0.2 port 80: Connection timed out</span><br></pre></td></tr></table></figure>

<h3 id="指定端口映射"><a href="#指定端口映射" class="headerlink" title="指定端口映射"></a>指定端口映射</h3><p>docker run -p 可以将容器的预定义的指定端口映射到宿主机的相应端口</p>
<p>注意: 多个容器映射到宿主机的端口不能冲突，但容器内使用的端口可以相同</p>
<p>方式1: 容器80端口映射宿主机本地随机端口</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run  -p 80 --name nginx-test-port1 nginx</span><br></pre></td></tr></table></figure>

<p>方式2: 容器80端口映射到宿主机本地端口81</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run  -p 81:80 --name nginx-test-port2 nginx</span><br></pre></td></tr></table></figure>

<p>方式3: 宿主机本地IP:宿主机本地端口:容器端口</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run  -p 10.0.0.100:82:80 --name nginx-test-port3 docker.io/nginx</span><br></pre></td></tr></table></figure>

<p>方式4: 宿主机本地IP:宿主机本地随机端口:容器端口，默认从32768开始</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -p 10.0.0.100::80 --name nginx-test-port4 docker.io/nginx</span><br></pre></td></tr></table></figure>

<p>方式5: 宿主机本机ip:宿主机本地端口:容器端口/协议，默认为tcp协议</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run  -p 10.0.0.100:83:80/udp --name nginx-test-port5 docker.io/nginx</span><br></pre></td></tr></table></figure>

<p>方式6: 一次性映射多个端口+协议</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run  -p 8080:80/tcp -p 8443:443/tcp -p 53:53/udp --name nginx-test-port6 nginx</span><br></pre></td></tr></table></figure>

<p>范例: </p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">[root@rocky8 ~]<span class="comment"># docker run -d -p 8080:80 -p 8443:443 -p 8053:53/udp nginx</span></span><br><span class="line">e9cda15aaa0194a12f64991aa787a185a6ddbcd6264352a3dd55cdd6daa66d40</span><br><span class="line">[root@rocky8 ~]<span class="comment"># docker ps</span></span><br><span class="line">CONTAINER ID   IMAGE     COMMAND                  CREATED         STATUS         PORTS                                                                                                                   NAMES</span><br><span class="line">e9cda15aaa01   nginx     <span class="string">&quot;/docker-entrypoint.…&quot;</span>   7 seconds ago   Up 6 seconds   0.0.0.0:8053-&gt;53/udp, :::8053-&gt;53/udp, 0.0.0.0:8080-&gt;80/tcp, :::8080-&gt;80/tcp, 0.0.0.0:8443-&gt;443/tcp, :::8443-&gt;443/tcp   dazzling_goldberg</span><br><span class="line"></span><br><span class="line">        </span><br><span class="line">[root@rocky8 ~]<span class="comment"># ss -luntp</span></span><br><span class="line">Netid   State    Recv-Q    Send-Q       Local Address:Port       Peer Address:Port   Process                                                                              </span><br><span class="line">udp     UNCONN   0         0                  0.0.0.0:8053            0.0.0.0:*       <span class="built_in">users</span>:((&quot;docker-proxy&quot;,pid=<span class="number">11020</span>,fd=<span class="number">4</span>))                                             </span><br><span class="line">udp     UNCONN   0         0                127.0.0.1:323             0.0.0.0:*       <span class="built_in">users</span>:((&quot;chronyd&quot;,pid=<span class="number">834</span>,fd=<span class="number">5</span>))                                                    </span><br><span class="line">udp     UNCONN   0         0                     [::]:8053               [::]:*       <span class="built_in">users</span>:((&quot;docker-proxy&quot;,pid=<span class="number">11026</span>,fd=<span class="number">4</span>))                                             </span><br><span class="line">udp     UNCONN   0         0                    [::1]:323                [::]:*       <span class="built_in">users</span>:((&quot;chronyd&quot;,pid=<span class="number">834</span>,fd=<span class="number">6</span>))                                                    </span><br><span class="line">tcp     LISTEN   0         2048               0.0.0.0:8080            0.0.0.0:*       <span class="built_in">users</span>:((&quot;docker-proxy&quot;,pid=<span class="number">10998</span>,fd=<span class="number">4</span>))                                             </span><br><span class="line">tcp     LISTEN   0         128                0.0.0.0:22              0.0.0.0:*       <span class="built_in">users</span>:((&quot;sshd&quot;,pid=<span class="number">852</span>,fd=<span class="number">3</span>))                                                       </span><br><span class="line">tcp     LISTEN   0         2048               0.0.0.0:8443            0.0.0.0:*       <span class="built_in">users</span>:((&quot;docker-proxy&quot;,pid=<span class="number">10976</span>,fd=<span class="number">4</span>))                                             </span><br><span class="line">tcp     LISTEN   0         2048                  [::]:8080               [::]:*       <span class="built_in">users</span>:((&quot;docker-proxy&quot;,pid=<span class="number">11006</span>,fd=<span class="number">4</span>))                                             </span><br><span class="line">tcp     LISTEN   0         128                   [::]:22                 [::]:*       <span class="built_in">users</span>:((&quot;sshd&quot;,pid=<span class="number">852</span>,fd=<span class="number">4</span>))                                                       </span><br><span class="line">tcp     LISTEN   0         2048                  [::]:8443               [::]:*       <span class="built_in">users</span>:((&quot;docker-proxy&quot;,pid=<span class="number">10984</span>,fd=<span class="number">4</span>)) </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@rocky8 ~]<span class="comment"># iptables -vnL -t nat</span></span><br><span class="line">Chain PREROUTING (policy ACCEPT 0 packets, 0 bytes)</span><br><span class="line"> pkts bytes target     prot opt <span class="keyword">in</span>     out     <span class="built_in">source</span>               destination         </span><br><span class="line">   69  3804 DOCKER     all  --  *      *       0.0.0.0/0            0.0.0.0/0            ADDRTYPE match dst-type LOCAL</span><br><span class="line"></span><br><span class="line">Chain INPUT (policy ACCEPT 0 packets, 0 bytes)</span><br><span class="line"> pkts bytes target     prot opt <span class="keyword">in</span>     out     <span class="built_in">source</span>               destination         </span><br><span class="line"></span><br><span class="line">Chain POSTROUTING (policy ACCEPT 0 packets, 0 bytes)</span><br><span class="line"> pkts bytes target     prot opt <span class="keyword">in</span>     out     <span class="built_in">source</span>               destination         </span><br><span class="line">    3   252 MASQUERADE  all  --  *      !docker0  172.17.0.0/16        0.0.0.0/0           </span><br><span class="line">    0     0 MASQUERADE  tcp  --  *      *       172.17.0.2           172.17.0.2           tcp dpt:443</span><br><span class="line">    0     0 MASQUERADE  tcp  --  *      *       172.17.0.2           172.17.0.2           tcp dpt:80</span><br><span class="line">    0     0 MASQUERADE  udp  --  *      *       172.17.0.2           172.17.0.2           udp dpt:53</span><br><span class="line"></span><br><span class="line">Chain OUTPUT (policy ACCEPT 0 packets, 0 bytes)</span><br><span class="line"> pkts bytes target     prot opt <span class="keyword">in</span>     out     <span class="built_in">source</span>               destination         </span><br><span class="line">   14   840 DOCKER     all  --  *      *       0.0.0.0/0           !127.0.0.0/8          ADDRTYPE match dst-type LOCAL</span><br><span class="line"></span><br><span class="line">Chain DOCKER (2 references)</span><br><span class="line"> pkts bytes target     prot opt <span class="keyword">in</span>     out     <span class="built_in">source</span>               destination         </span><br><span class="line">   27  1620 RETURN     all  --  docker0 *       0.0.0.0/0            0.0.0.0/0           </span><br><span class="line">    0     0 DNAT       tcp  --  !docker0 *       0.0.0.0/0            0.0.0.0/0            tcp dpt:8443 to:172.17.0.2:443</span><br><span class="line">    0     0 DNAT       tcp  --  !docker0 *       0.0.0.0/0            0.0.0.0/0            tcp dpt:8080 to:172.17.0.2:80</span><br><span class="line">    0     0 DNAT       udp  --  !docker0 *       0.0.0.0/0            0.0.0.0/0            udp dpt:8053 to:172.17.0.2:53</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line"><span class="comment">#杀死nginx进程，nginx将关闭，相应端口也会关闭</span></span><br><span class="line">[root@rocky8 ~]<span class="comment"># kill &lt;NGINXPID&gt;</span></span><br></pre></td></tr></table></figure>

<p><strong>实战案例: 修改已经创建的容器的端口映射关系</strong></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">[root@rocky8 ~]<span class="comment"># docker run -d -p 80:80 --name nginx01 nginx</span></span><br><span class="line">87f4d74f1c261085d3545c884a87ff9f39b962da568e5b01c7caa7379606da60</span><br><span class="line"></span><br><span class="line">[root@rocky8 ~]<span class="comment"># docker port nginx01 </span></span><br><span class="line">80/tcp -&gt; 0.0.0.0:80</span><br><span class="line">80/tcp -&gt; [::]:80</span><br><span class="line"></span><br><span class="line">[root@rocky8 ~]<span class="comment"># lsof -i:80</span></span><br><span class="line">COMMAND     PID USER   FD   TYPE DEVICE SIZE/OFF NODE NAME</span><br><span class="line">docker-pr 11593 root    4u  IPv4  70300      0t0  TCP *:http (LISTEN)</span><br><span class="line">docker-pr 11600 root    4u  IPv6  70303      0t0  TCP *:http (LISTEN)</span><br><span class="line"></span><br><span class="line">[root@rocky8 ~]<span class="comment"># ls /var/lib/docker/containers/87f4d74f1c261085d3545c884a87ff9f39b962da568e5b01c7caa7379606da60/</span></span><br><span class="line">87f4d74f1c261085d3545c884a87ff9f39b962da568e5b01c7caa7379606da60-json.log</span><br><span class="line">checkpoints</span><br><span class="line">config.v2.json</span><br><span class="line">hostconfig.json</span><br><span class="line">hostname</span><br><span class="line">hosts</span><br><span class="line">mounts</span><br><span class="line">resolv.conf</span><br><span class="line">resolv.conf.hash</span><br><span class="line"></span><br><span class="line">[root@rocky8 ~]<span class="comment"># systemctl stop docker</span></span><br><span class="line">[root@rocky8 ~]<span class="comment"># vim /var/lib/docker/containers/87f4d74f1c261085d3545c884a87ff9f39b962da568e5b01c7caa7379606da60/hostconfig.json </span></span><br><span class="line"><span class="string">&quot;PortBindings&quot;</span>:&#123;<span class="string">&quot;80/tcp&quot;</span>:[&#123;<span class="string">&quot;HostIp&quot;</span>:<span class="string">&quot;&quot;</span>,<span class="string">&quot;HostPort&quot;</span>:<span class="string">&quot;80&quot;</span>&#125;]&#125; </span><br><span class="line"><span class="comment">#PortBindings后80/tcp对应的是容器内部的80端口，HostPort对应的是映射到宿主机的端口80 修改此处为8000</span></span><br><span class="line"><span class="string">&quot;PortBindings&quot;</span>:&#123;<span class="string">&quot;80/tcp&quot;</span>:[&#123;<span class="string">&quot;HostIp&quot;</span>:<span class="string">&quot;&quot;</span>,<span class="string">&quot;HostPort&quot;</span>:<span class="string">&quot;8000&quot;</span>&#125;]&#125; </span><br><span class="line"></span><br><span class="line">[root@rocky8 ~]<span class="comment"># systemctl start docker.service </span></span><br><span class="line">[root@rocky8 ~]<span class="comment"># docker start nginx01 </span></span><br><span class="line">nginx01</span><br><span class="line"></span><br><span class="line">[root@rocky8 ~]<span class="comment"># docker port nginx01</span></span><br><span class="line">80/tcp -&gt; 0.0.0.0:8080</span><br><span class="line">80/tcp -&gt; [::]:8080</span><br></pre></td></tr></table></figure>

<p>范例：实现 wordpress 应用</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@rocky8 ~]<span class="comment"># docker run -p 3306:3306 -e MYSQL_ROOT_PASSWORD=000000 \</span></span><br><span class="line"> -e MYSQL_DATABASE=wordpress -e MYSQL_USER=wordpress -e MYSQL_PASSWORD=000000 \</span><br><span class="line"> --name mysql -d --restart=always mysql:8.0.29-oracle</span><br><span class="line"></span><br><span class="line">[root@rocky8 ~]<span class="comment"># docker run -d -p 8080:80 --name wordpress -v /data/wordpress:/var/www/html/ \</span></span><br><span class="line"> --restart=always wordpress:php7.4-apache</span><br></pre></td></tr></table></figure>

<h3 id="查看容器的日志"><a href="#查看容器的日志" class="headerlink" title="查看容器的日志"></a>查看容器的日志</h3><p>docker logs 可以查看容器中运行的进程在控制台输出的日志信息</p>
<p>格式</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">docker logs [OPTIONS] CONTAINER</span><br><span class="line"></span><br><span class="line">选项:</span><br><span class="line">--details        Show extra details provided to logs</span><br><span class="line">-f, --follow     Follow <span class="built_in">log</span> output</span><br><span class="line">--since string   Show logs since timestamp (e.g. 2013-01-02T13:23:37) or relative (e.g. 42m <span class="keyword">for</span>   42 minutes)</span><br><span class="line">--<span class="built_in">tail</span> string    Number of lines to show from the end of the logs (default <span class="string">&quot;all&quot;</span>)</span><br><span class="line">-t, --timestamps     Show timestamps</span><br><span class="line">--until string       Show logs before a timestamp (e.g. 2013-01-02T13:23:37) or relative (e.g. 42m <span class="keyword">for</span> 42 minutes)</span><br></pre></td></tr></table></figure>

<p>范例: 查看容器日志</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">[root@rocky8 ~]<span class="comment"># docker run -d alpine /bin/sh -c &#x27;i=1;while true;do echo hello$i;let i++;sleep 2;done&#x27;</span></span><br><span class="line">718a94fe85e607cf7ece3d408862faa34771b997dc479ed8c420a80163b1fa2c</span><br><span class="line"></span><br><span class="line">[root@rocky8 ~]<span class="comment"># docker logs 718a</span></span><br><span class="line">hello1</span><br><span class="line">hello2</span><br><span class="line">hello3</span><br><span class="line">hello4</span><br><span class="line">hello5</span><br><span class="line">hello6</span><br><span class="line">hello7</span><br><span class="line"></span><br><span class="line">[root@rocky8 ~]<span class="comment"># docker logs 718a</span></span><br><span class="line">hello1</span><br><span class="line">hello2</span><br><span class="line">hello3</span><br><span class="line">hello4</span><br><span class="line">hello5</span><br><span class="line">hello6</span><br><span class="line">hello7</span><br><span class="line">hello8</span><br><span class="line">hello9</span><br><span class="line">hello10</span><br><span class="line">hello11</span><br><span class="line"></span><br><span class="line">[root@rocky8 ~]<span class="comment"># docker logs --tail 3 718a</span></span><br><span class="line">hello13</span><br><span class="line">hello14</span><br><span class="line">hello15</span><br><span class="line"></span><br><span class="line"><span class="comment">#显示时间</span></span><br><span class="line">[root@rocky8 ~]<span class="comment"># docker logs --tail 1 -t 718a</span></span><br><span class="line">2025-04-08T02:23:03.178747914Z hello40</span><br><span class="line"></span><br><span class="line"><span class="comment">#持续跟踪</span></span><br><span class="line">[root@rocky8 ~]<span class="comment"># docker logs -f 718a</span></span><br><span class="line">hello1</span><br><span class="line">hello2</span><br><span class="line">hello3</span><br><span class="line">hello4</span><br><span class="line">......</span><br></pre></td></tr></table></figure>

<p>范例: 查看httpd服务日志</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[root@rocky8 ~]<span class="comment"># docker run -d -p 80:80 --name web1 httpd</span></span><br><span class="line">f12a28ff05a7323d0081618d4ab8b5056a6a6113ff644e2d3604128739005ee1</span><br><span class="line"></span><br><span class="line">[root@rocky8 ~]<span class="comment"># docker logs web1 </span></span><br><span class="line">AH00558: httpd: Could not reliably determine the server<span class="string">&#x27;s fully qualified domain name, using 172.17.0.3. Set the &#x27;</span>ServerName<span class="string">&#x27; directive globally to suppress this message</span></span><br><span class="line"><span class="string">AH00558: httpd: Could not reliably determine the server&#x27;</span>s fully qualified domain name, using 172.17.0.3. Set the <span class="string">&#x27;ServerName&#x27;</span> directive globally to suppress this message</span><br><span class="line">[Tue Apr 08 02:25:04.722339 2025] [mpm_event:notice] [pid 1:tid 1] AH00489: Apache/2.4.63 (Unix) configured -- resuming normal operations</span><br><span class="line">[Tue Apr 08 02:25:04.722480 2025] [core:notice] [pid 1:tid 1] AH00094: Command line: <span class="string">&#x27;httpd -D FOREGROUND&#x27;</span></span><br><span class="line"></span><br><span class="line">[root@rocky8 ~]<span class="comment"># docker logs -f web1 </span></span><br><span class="line">AH00558: httpd: Could not reliably determine the server<span class="string">&#x27;s fully qualified domain name, using 172.17.0.3. Set the &#x27;</span>ServerName<span class="string">&#x27; directive globally to suppress this message</span></span><br><span class="line"><span class="string">AH00558: httpd: Could not reliably determine the server&#x27;</span>s fully qualified domain name, using 172.17.0.3. Set the <span class="string">&#x27;ServerName&#x27;</span> directive globally to suppress this message</span><br><span class="line">[Tue Apr 08 02:25:04.722339 2025] [mpm_event:notice] [pid 1:tid 1] AH00489: Apache/2.4.63 (Unix) configured -- resuming normal operations</span><br><span class="line">[Tue Apr 08 02:25:04.722480 2025] [core:notice] [pid 1:tid 1] AH00094: Command line: <span class="string">&#x27;httpd -D FOREGROUND&#x27;</span></span><br></pre></td></tr></table></figure>

<p>范例: 查看nginx服务访问日志</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#查看一次</span></span><br><span class="line">[root@rocky8 ~]<span class="comment"># docker logs nginx1 </span></span><br><span class="line">172.17.0.1 - - [08/Apr/2025:07:47:38 +0000] <span class="string">&quot;GET / HTTP/1.1&quot;</span> 200 615 <span class="string">&quot;-&quot;</span> <span class="string">&quot;curl/7.61.1&quot;</span> <span class="string">&quot;-&quot;</span></span><br><span class="line">172.17.0.1 - - [08/Apr/2025:07:47:39 +0000] <span class="string">&quot;GET / HTTP/1.1&quot;</span> 200 615 <span class="string">&quot;-&quot;</span> <span class="string">&quot;curl/7.61.1&quot;</span> <span class="string">&quot;-&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#持续查看</span></span><br><span class="line">[root@rocky8 ~]<span class="comment"># docker logs -f nginx1 </span></span><br><span class="line">172.17.0.1 - - [08/Apr/2025:07:47:38 +0000] <span class="string">&quot;GET / HTTP/1.1&quot;</span> 200 615 <span class="string">&quot;-&quot;</span> <span class="string">&quot;curl/7.61.1&quot;</span> <span class="string">&quot;-&quot;</span></span><br><span class="line">172.17.0.1 - - [08/Apr/2025:07:47:39 +0000] <span class="string">&quot;GET / HTTP/1.1&quot;</span> 200 615 <span class="string">&quot;-&quot;</span> <span class="string">&quot;curl/7.61.1&quot;</span> <span class="string">&quot;-&quot;</span></span><br><span class="line">172.17.0.1 - - [08/Apr/2025:07:48:35 +0000] <span class="string">&quot;GET / HTTP/1.1&quot;</span> 200 615 <span class="string">&quot;-&quot;</span> <span class="string">&quot;curl/7.61.1&quot;</span> <span class="string">&quot;-&quot;</span></span><br><span class="line">172.17.0.1 - - [08/Apr/2025:07:48:52 +0000] <span class="string">&quot;GET / HTTP/1.1&quot;</span> 200 615 <span class="string">&quot;-&quot;</span> <span class="string">&quot;curl/7.61.1&quot;</span> <span class="string">&quot;-&quot;</span></span><br><span class="line">172.17.0.1 - - [08/Apr/2025:07:48:58 +0000] <span class="string">&quot;GET / HTTP/1.1&quot;</span> 200 615 <span class="string">&quot;-&quot;</span> <span class="string">&quot;curl/7.61.1&quot;</span> <span class="string">&quot;-&quot;</span></span><br><span class="line">172.17.0.1 - - [08/Apr/2025:07:49:04 +0000] <span class="string">&quot;GET / HTTP/1.1&quot;</span> 200 615 <span class="string">&quot;-&quot;</span> <span class="string">&quot;curl/7.61.1&quot;</span> <span class="string">&quot;-&quot;</span></span><br><span class="line">172.17.0.1 - - [08/Apr/2025:07:49:08 +0000] <span class="string">&quot;GET /test HTTP/1.1&quot;</span> 404 153 <span class="string">&quot;-&quot;</span> <span class="string">&quot;curl/7.61.1&quot;</span> <span class="string">&quot;-&quot;</span></span><br><span class="line">2025/04/08 07:49:08 [error] 29<span class="comment">#29: *7 open() &quot;/usr/share/nginx/html/test&quot; failed (2: No such file or directory), client: 172.17.0.1, server: localhost, request: &quot;GET /test HTTP/1.1&quot;, host: &quot;172.17.0.2&quot;</span></span><br></pre></td></tr></table></figure>

<h3 id="传递运行命令"><a href="#传递运行命令" class="headerlink" title="传递运行命令"></a>传递运行命令</h3><p>容器需要有一个前台运行的进程才能保持容器的运行，通过传递运行参数是一种方式，另外也可以在构建镜像的时候指定容器启动时运行的前台命令</p>
<p>容器里的PID为1的守护进程的实现方式</p>
<ul>
<li>服务类: 如: Nginx，Tomcat，Apache ，但服务不能停</li>
<li>命令类: 如: tail -f /etc/hosts ，主要用于测试环境，注意: 不要tail -f &lt;服务访问日志&gt; 会产生不 必要的磁盘IO </li>
</ul>
<p>范例: </p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">[root@rocky8 ~]<span class="comment"># docker run -d alpine</span></span><br><span class="line">6b0764be17d18ae532f048a9f9c70c05e2e0dccdc5577e5024da8e5872ba9507</span><br><span class="line"></span><br><span class="line">[root@rocky8 ~]<span class="comment"># docker ps -a</span></span><br><span class="line">CONTAINER ID   IMAGE     COMMAND     CREATED         STATUS                     PORTS     NAMES</span><br><span class="line">6b0764be17d1   alpine    <span class="string">&quot;/bin/sh&quot;</span>   3 seconds ago   Exited (0) 2 seconds ago             brave_pasteur</span><br><span class="line"></span><br><span class="line">[root@rocky8 ~]<span class="comment"># docker run -d alpine tail -f /etc/hosts</span></span><br><span class="line">78138ac0a2f3871f2e6021facdd6f19a4d2054866da308d1a6dcf637bcb1dda9</span><br><span class="line"></span><br><span class="line">[root@rocky8 ~]<span class="comment"># docker ps -a</span></span><br><span class="line">CONTAINER ID   IMAGE     COMMAND                CREATED          STATUS                      PORTS     NAMES</span><br><span class="line">78138ac0a2f3   alpine    <span class="string">&quot;tail -f /etc/hosts&quot;</span>   5 seconds ago    Up 4 seconds                          pensive_volhard</span><br><span class="line">6b0764be17d1   alpine    <span class="string">&quot;/bin/sh&quot;</span>              27 seconds ago   Exited (0) 26 seconds ago             brave_pasteur</span><br><span class="line"></span><br><span class="line">[root@rocky8 ~]<span class="comment"># docker exec -it 78138a sh</span></span><br><span class="line">/ <span class="comment"># ps aux</span></span><br><span class="line">PID   USER     TIME  COMMAND</span><br><span class="line">    1 root      0:00 <span class="built_in">tail</span> -f /etc/hosts</span><br><span class="line">    7 root      0:00 sh</span><br><span class="line">   13 root      0:00 ps aux</span><br><span class="line">   </span><br><span class="line">/ <span class="comment"># exit</span></span><br><span class="line"></span><br><span class="line">[root@rocky8 ~]<span class="comment"># docker ps -a</span></span><br><span class="line">CONTAINER ID   IMAGE     COMMAND                CREATED              STATUS                          PORTS     NAMES</span><br><span class="line">78138ac0a2f3   alpine    <span class="string">&quot;tail -f /etc/hosts&quot;</span>   58 seconds ago       Up 56 seconds                             pensive_volhard</span><br><span class="line">6b0764be17d1   alpine    <span class="string">&quot;/bin/sh&quot;</span>              About a minute ago   Exited (0) About a minute ago             brave_pasteur</span><br></pre></td></tr></table></figure>

<h3 id="容器内部的hosts文件"><a href="#容器内部的hosts文件" class="headerlink" title="容器内部的hosts文件"></a>容器内部的hosts文件</h3><p>容器会自动将容器的ID加入自已的/etc/hosts文件中，并解析成容器的IP</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">[root@rocky8 ~]<span class="comment"># docker run -it centos /bin/bash</span></span><br><span class="line">[root@aae98e2610ba /]<span class="comment"># cat /etc/hosts</span></span><br><span class="line">127.0.0.1	localhost</span><br><span class="line">::1	localhost ip6-localhost ip6-loopback</span><br><span class="line">fe00::0	ip6-localnet</span><br><span class="line">ff00::0	ip6-mcastprefix</span><br><span class="line">ff02::1	ip6-allnodes</span><br><span class="line">ff02::2	ip6-allrouters</span><br><span class="line">172.17.0.2	aae98e2610ba   <span class="comment">#默认会将实例的ID 添加到自己的hosts文件</span></span><br><span class="line"></span><br><span class="line">[root@aae98e2610ba /]<span class="comment"># hostname</span></span><br><span class="line">aae98e2610ba</span><br><span class="line"></span><br><span class="line">[root@aae98e2610ba /]<span class="comment"># ping aae98e2610ba</span></span><br><span class="line">PING aae98e2610ba (172.17.0.2) 56(84) bytes of data.</span><br><span class="line">64 bytes from aae98e2610ba (172.17.0.2): icmp_seq=1 ttl=64 time=0.033 ms</span><br><span class="line">64 bytes from aae98e2610ba (172.17.0.2): icmp_seq=2 ttl=64 time=0.037 ms</span><br><span class="line">64 bytes from aae98e2610ba (172.17.0.2): icmp_seq=3 ttl=64 time=0.057 ms</span><br><span class="line">^C</span><br><span class="line">--- aae98e2610ba ping statistics ---</span><br><span class="line">3 packets transmitted, 3 received, 0% packet loss, time 2060ms</span><br><span class="line">rtt min/avg/max/mdev = 0.033/0.042/0.057/0.011 ms</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#在另一个会话执行</span></span><br><span class="line">[root@rocky8 ~]<span class="comment"># docker ps</span></span><br><span class="line">CONTAINER ID   IMAGE     COMMAND       CREATED          STATUS          PORTS     NAMES</span><br><span class="line">aae98e2610ba   centos    <span class="string">&quot;/bin/bash&quot;</span>   57 seconds ago   Up 56 seconds             awesome_leakey</span><br></pre></td></tr></table></figure>

<p>范例: 修改容器的 hosts文件</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[root@rocky8 ~]<span class="comment"># docker run -it --rm --add-host www.wang.org:6.6.6.6 \</span></span><br><span class="line">--add-host www.wang.com:8.8.8.8 busybox</span><br><span class="line"></span><br><span class="line">/ <span class="comment"># cat /etc/hosts</span></span><br><span class="line">127.0.0.1	localhost</span><br><span class="line">::1	localhost ip6-localhost ip6-loopback</span><br><span class="line">fe00::0	ip6-localnet</span><br><span class="line">ff00::0	ip6-mcastprefix</span><br><span class="line">ff02::1	ip6-allnodes</span><br><span class="line">ff02::2	ip6-allrouters</span><br><span class="line">6.6.6.6	www.wang.org</span><br><span class="line">8.8.8.8	www.wang.com</span><br><span class="line">172.17.0.2	6ac4986f2cb6</span><br></pre></td></tr></table></figure>

<h3 id="指定容器DNS"><a href="#指定容器DNS" class="headerlink" title="指定容器DNS"></a>指定容器DNS</h3><p>容器的dns服务器，默认采用宿主机的dns 地址，可以用下面方式指定其它的DNS地址</p>
<ul>
<li>将dns地址配置在宿主机</li>
<li>在容器启动时加选项 –dns=x.x.x.x</li>
<li>在/etc/docker/daemon.json 文件中指定</li>
</ul>
<p>范例: 容器的DNS默认从宿主机的DNS获取</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">[root@rocky8 ~]<span class="comment"># cat /etc/resolv.conf </span></span><br><span class="line"><span class="comment"># Generated by NetworkManager</span></span><br><span class="line">nameserver 223.5.5.5</span><br><span class="line">nameserver 223.6.6.6</span><br><span class="line"></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment">#systemd-resolve --status|grep -A1 -i &quot;DNS Servers&quot;</span></span><br><span class="line">         DNS Servers: 180.76.76.76</span><br><span class="line">                      223.6.6.6</span><br><span class="line"></span><br><span class="line">[root@rocky8 ~]<span class="comment"># docker run -it --rm centos bash</span></span><br><span class="line">[root@1f89c014042c /]<span class="comment"># cat /etc/resolv.conf </span></span><br><span class="line"><span class="comment"># Generated by Docker Engine.</span></span><br><span class="line"><span class="comment"># This file can be edited; Docker Engine will not make further changes once it</span></span><br><span class="line"><span class="comment"># has been modified.</span></span><br><span class="line"></span><br><span class="line">nameserver 223.5.5.5</span><br><span class="line">nameserver 223.6.6.6</span><br><span class="line"></span><br><span class="line"><span class="comment"># Based on host file: &#x27;/etc/resolv.conf&#x27; (legacy)</span></span><br><span class="line"><span class="comment"># Overrides: []</span></span><br><span class="line">[root@1f89c014042c /]<span class="comment"># exit</span></span><br><span class="line"><span class="built_in">exit</span></span><br></pre></td></tr></table></figure>

<p>范例: 指定DNS地址</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[root@rocky8 ~]<span class="comment"># docker run -it --rm --dns 1.1.1.1 --dns 8.8.8.8 centos bash</span></span><br><span class="line"></span><br><span class="line">[root@01037b0422ff /]<span class="comment"># cat /etc/resolv.conf </span></span><br><span class="line"><span class="comment"># Generated by Docker Engine.</span></span><br><span class="line"><span class="comment"># This file can be edited; Docker Engine will not make further changes once it</span></span><br><span class="line"><span class="comment"># has been modified.</span></span><br><span class="line"></span><br><span class="line">nameserver 1.1.1.1</span><br><span class="line">nameserver 8.8.8.8</span><br><span class="line"></span><br><span class="line"><span class="comment"># Based on host file: &#x27;/etc/resolv.conf&#x27; (legacy)</span></span><br><span class="line"><span class="comment"># Overrides: [nameservers]</span></span><br><span class="line">[root@01037b0422ff /]<span class="comment"># exit</span></span><br><span class="line"><span class="built_in">exit</span></span><br></pre></td></tr></table></figure>

<p>范例: 指定domain名</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[root@rocky8 ~]<span class="comment"># docker run -it --rm --dns 1.1.1.1 --dns 8.8.8.8 --dns-search a.com --dns-search b.com busybox</span></span><br><span class="line"></span><br><span class="line">/ <span class="comment"># cat /etc/resolv.conf </span></span><br><span class="line"><span class="comment"># Generated by Docker Engine.</span></span><br><span class="line"><span class="comment"># This file can be edited; Docker Engine will not make further changes once it</span></span><br><span class="line"><span class="comment"># has been modified.</span></span><br><span class="line"></span><br><span class="line">nameserver 1.1.1.1</span><br><span class="line">nameserver 8.8.8.8</span><br><span class="line">search a.com b.com</span><br><span class="line"></span><br><span class="line"><span class="comment"># Based on host file: &#x27;/etc/resolv.conf&#x27; (legacy)</span></span><br><span class="line"><span class="comment"># Overrides: [nameservers search]</span></span><br><span class="line">/ <span class="comment"># exit</span></span><br></pre></td></tr></table></figure>

<p>范例: 配置文件指定DNS和搜索domain名</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">[root@rocky8 ~]<span class="comment"># vim /etc/docker/daemon.json </span></span><br><span class="line">[root@rocky8 ~]<span class="comment"># cat /etc/docker/daemon.json</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;registry-mirrors&quot;</span>: [</span><br><span class="line">    	<span class="string">&quot;https://docker.m.daocloud.io&quot;</span>,</span><br><span class="line">    	<span class="string">&quot;https://docker.imgdb.de&quot;</span>,</span><br><span class="line">	    <span class="string">&quot;https://docker-0.unsee.tech&quot;</span>,</span><br><span class="line">   	 	<span class="string">&quot;https://docker.hlmirror.com&quot;</span>,</span><br><span class="line">     	<span class="string">&quot;https://docker.1ms.run&quot;</span>,</span><br><span class="line">     	<span class="string">&quot;https://func.ink&quot;</span>,</span><br><span class="line">     	<span class="string">&quot;https://lispy.org&quot;</span>,</span><br><span class="line">     	<span class="string">&quot;https://docker.xiaogenban1993.com&quot;</span></span><br><span class="line">    ],</span><br><span class="line">	<span class="string">&quot;storage-driver&quot;</span>: <span class="string">&quot;overlay2&quot;</span>,</span><br><span class="line">	<span class="string">&quot;dns&quot;</span>: [ <span class="string">&quot;114.114.114.114&quot;</span>, <span class="string">&quot;119.29.29.29&quot;</span> ],</span><br><span class="line">	<span class="string">&quot;dns-search&quot;</span>: [ <span class="string">&quot;wang.com&quot;</span>, <span class="string">&quot;wang.org&quot;</span> ] </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">[root@rocky8 ~]<span class="comment"># systemctl restart docker.service </span></span><br><span class="line">[root@rocky8 ~]<span class="comment"># docker run -it --rm centos bash</span></span><br><span class="line">[root@b3299209b405 /]<span class="comment"># cat /etc/resolv.conf </span></span><br><span class="line"><span class="comment"># Generated by Docker Engine.</span></span><br><span class="line"><span class="comment"># This file can be edited; Docker Engine will not make further changes once it</span></span><br><span class="line"><span class="comment"># has been modified.</span></span><br><span class="line"></span><br><span class="line">nameserver 114.114.114.114</span><br><span class="line">nameserver 119.29.29.29</span><br><span class="line">search wang.com wang.org</span><br><span class="line"></span><br><span class="line"><span class="comment"># Based on host file: &#x27;/etc/resolv.conf&#x27; (legacy)</span></span><br><span class="line"><span class="comment"># Overrides: [nameservers search]</span></span><br><span class="line">[root@b3299209b405 /]<span class="comment"># exit</span></span><br><span class="line"><span class="built_in">exit</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#用--dns指定优先级更高</span></span><br><span class="line">[root@rocky8 ~]<span class="comment"># docker run -it --rm --dns 1.1.1.1 --dns 8.8.8.8 centos bash</span></span><br><span class="line">[root@39ab9050332b /]<span class="comment"># cat /etc/resolv.conf </span></span><br><span class="line"><span class="comment"># Generated by Docker Engine.</span></span><br><span class="line"><span class="comment"># This file can be edited; Docker Engine will not make further changes once it</span></span><br><span class="line"><span class="comment"># has been modified.</span></span><br><span class="line"></span><br><span class="line">nameserver 1.1.1.1</span><br><span class="line">nameserver 8.8.8.8</span><br><span class="line">search wang.com wang.org</span><br><span class="line"></span><br><span class="line"><span class="comment"># Based on host file: &#x27;/etc/resolv.conf&#x27; (legacy)</span></span><br><span class="line"><span class="comment"># Overrides: [nameservers search]</span></span><br><span class="line">[root@39ab9050332b /]<span class="comment"># exit </span></span><br><span class="line"><span class="built_in">exit</span></span><br></pre></td></tr></table></figure>

<h3 id="容器内和宿主机之间复制文件"><a href="#容器内和宿主机之间复制文件" class="headerlink" title="容器内和宿主机之间复制文件"></a>容器内和宿主机之间复制文件</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">docker <span class="built_in">cp</span> [OPTIONS] CONTAINER:SRC_PATH DEST_PATH|-</span><br><span class="line">docker <span class="built_in">cp</span> [OPTIONS] SRC_PATH|- CONTAINER:DEST_PATH</span><br><span class="line">Options:</span><br><span class="line">  -a, --archive       Archive mode (copy all uid/gid information)</span><br><span class="line">  -L, --follow-link   Always follow symbol <span class="built_in">link</span> <span class="keyword">in</span> SRC_PATH</span><br></pre></td></tr></table></figure>

<p>范例： 复制容器的文件至宿主机</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@rocky8 ~]<span class="comment"># docker run -it --name b1 --rm busybox sh</span></span><br><span class="line">[root@rocky8 ~]<span class="comment"># docker cp b1:/bin/busybox /usr/local/bin/</span></span><br><span class="line">[root@rocky8 ~]<span class="comment"># busybox ls</span></span><br></pre></td></tr></table></figure>

<p>范例: </p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">[root@rocky8 ~]<span class="comment"># docker run -itd centos</span></span><br><span class="line">ea5987185dbc7e3993fe57e3df198704dd10e7d97db6e63cacef1ae7567f3eb9</span><br><span class="line"></span><br><span class="line">[root@rocky8 ~]<span class="comment"># docker ps</span></span><br><span class="line">CONTAINER ID   IMAGE     COMMAND       CREATED         STATUS         PORTS     NAMES</span><br><span class="line">ea5987185dbc   centos    <span class="string">&quot;/bin/bash&quot;</span>   4 seconds ago   Up 3 seconds             stupefied_merkle</span><br><span class="line"></span><br><span class="line"><span class="comment">#将容器内文件复制到宿主机</span></span><br><span class="line">[root@rocky8 ~]<span class="comment"># docker cp -a ea5987:/etc/centos-release .</span></span><br><span class="line">Successfully copied 2.05kB to /root/.</span><br><span class="line"></span><br><span class="line">[root@rocky8 ~]<span class="comment"># cat centos-release </span></span><br><span class="line">CentOS Linux release 8.4.2105</span><br><span class="line"></span><br><span class="line"><span class="comment">#将宿主机文件复制到容器内</span></span><br><span class="line">[root@rocky8 ~]<span class="comment"># docker cp /etc/issue ea5987:/root/</span></span><br><span class="line">Successfully copied 2.05kB to ea5987:/root/</span><br><span class="line"></span><br><span class="line">[root@rocky8 ~]<span class="comment"># docker exec ea5987 cat /root/issue</span></span><br><span class="line">\S</span><br><span class="line">Kernel \r on an \m</span><br></pre></td></tr></table></figure>

<h3 id="使用-systemd-控制容器运行"><a href="#使用-systemd-控制容器运行" class="headerlink" title="使用 systemd 控制容器运行"></a>使用 systemd 控制容器运行</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">[root@rocky8 ~]<span class="comment"># vim /lib/systemd/system/hello.service</span></span><br><span class="line">[root@rocky8 ~]<span class="comment"># cat /lib/systemd/system/hello.service</span></span><br><span class="line">[Unit] </span><br><span class="line">Description=Hello World </span><br><span class="line">After=docker.service </span><br><span class="line">Requires=docker.service</span><br><span class="line"></span><br><span class="line">[Service] </span><br><span class="line">TimeoutStartSec=0</span><br><span class="line">ExecStartPre=-/usr/bin/docker <span class="built_in">kill</span> busybox-hello</span><br><span class="line">ExecStartPre=-/usr/bin/docker <span class="built_in">rm</span> busybox-hello</span><br><span class="line">ExecStartPre=/usr/bin/docker pull busybox</span><br><span class="line">ExecStart=/usr/bin/docker run --name busybox-hello busybox /bin/sh -c <span class="string">&quot;while true; do echo Hello World; sleep 1; done&quot;</span></span><br><span class="line">ExecStop=/usr/bin/docker <span class="built_in">kill</span> busybox-hello</span><br><span class="line"></span><br><span class="line">[Install] </span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@rocky8 ~]<span class="comment"># systemctl daemon-reload </span></span><br><span class="line">[root@rocky8 ~]<span class="comment"># systemctl enable --now hello.service </span></span><br><span class="line">[root@rocky8 ~]<span class="comment"># docker ps -l</span></span><br><span class="line">CONTAINER ID   IMAGE     COMMAND                  CREATED         STATUS         PORTS     NAMES</span><br><span class="line">2ec8b0636e22   busybox   <span class="string">&quot;/bin/sh -c &#x27;while t…&quot;</span>   6 seconds ago   Up 5 seconds             busybox-hello</span><br></pre></td></tr></table></figure>

<h3 id="传递环境变量"><a href="#传递环境变量" class="headerlink" title="传递环境变量"></a>传递环境变量</h3><p>有些容器运行时，需要传递变量，可以使用 -e &lt;参数&gt; 或 –env-file &lt;参数文件&gt; 实现</p>
<p>范例: 传递变量创建MySQL</p>
<p>变量参考链接: <a target="_blank" rel="noopener" href="https://hub.docker.com/_/mysql">https://hub.docker.com/_/mysql</a></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#MySQL容器运行时需要指定root的口令</span></span><br><span class="line">[root@rocky8 ~]<span class="comment"># docker run --name mysql mysql:8.0.29-oracle </span></span><br><span class="line">    You need to specify one of the following:</span><br><span class="line">    - MYSQL_ROOT_PASSWORD</span><br><span class="line">    - MYSQL_ALLOW_EMPTY_PASSWORD</span><br><span class="line">    - MYSQL_RANDOM_ROOT_PASSWORD</span><br><span class="line"></span><br><span class="line">[root@rocky8 ~]<span class="comment"># docker run --name mysql-test1 -v /data/mysql:/var/lib/mysql/ \</span></span><br><span class="line"> -e MYSQL_ROOT_PASSWORD=000000 -e MYSQL_DATABASE=wordpress -e MYSQL_USER=wpuser \                          </span><br><span class="line"> -e MYSQL_PASSWORD=000000 -d -p 3306:3306 mysql:8.0.29-oracle</span><br><span class="line">df13cf06cc56ccb3f286bd3fcdf68e0b60c312a057b922defff975bfbde24995</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@rocky8 ~]<span class="comment"># cat mysql/mysql-test.cnf</span></span><br><span class="line">[mysqld]</span><br><span class="line">server-id=100</span><br><span class="line">log-bin=mysql-bin</span><br><span class="line"></span><br><span class="line">[root@rocky8 ~]<span class="comment"># cat env.list </span></span><br><span class="line">MYSQL_ROOT_PASSWORD=000000</span><br><span class="line">MYSQL_DATABASE=wordpress</span><br><span class="line">MYSQL_USER=wpuser</span><br><span class="line">MYSQL_PASSWORD=000000</span><br><span class="line"></span><br><span class="line">[root@rocky8 ~]<span class="comment"># docker run --name mysql-test2 -v /root/mysql/:/etc/mysql/conf.d -v /data/mysql2:/var/lib/mysql --env-file=env.list -d -p 3307:3306 mysql:8.0.29-oracle</span></span><br><span class="line">1de4c0ab06265c3b95f4ebddc5395ccd8b14f31233b95007b75eb97bce94a2eb</span><br></pre></td></tr></table></figure>

<h2 id="实战案例-利用-docker-快速部署自动化运维平台"><a href="#实战案例-利用-docker-快速部署自动化运维平台" class="headerlink" title="实战案例: 利用 docker 快速部署自动化运维平台"></a>实战案例: 利用 docker 快速部署自动化运维平台</h2><p><img src="../../../../images/SRE/day46/30.jpg" alt="30"></p>
<h3 id="项目说明"><a href="#项目说明" class="headerlink" title="项目说明"></a>项目说明</h3><p>Spug 面向中小型企业设计的轻量级无 Agent 的自动化运维平台，整合了主机管理、主机批量执行、主机在线终端、文件在线上传下载、应用发布部署、在线任务计划、配置中心、监控、报警等一系列功能</p>
<p><strong>特性</strong> </p>
<ul>
<li>批量执行: 主机命令在线批量执行</li>
<li>在线终端: 主机支持浏览器在线终端登录</li>
<li>文件管理: 主机文件在线上传下载</li>
<li>任务计划: 灵活的在线任务计划</li>
<li>发布部署: 支持自定义发布部署流程</li>
<li>配置中心: 支持 KV、文本、json 等格式的配置</li>
<li>监控中心: 支持站点、端口、进程、自定义等监控</li>
<li>报警中心: 支持短信、邮件、钉钉、微信等报警方式</li>
<li>优雅美观: 基于 Ant Design 的 UI 界面</li>
<li>开源免费: 前后端代码完全开源</li>
</ul>
<p>官网地址: <a target="_blank" rel="noopener" href="https://www.spug.dev/">https://www.spug.dev/</a></p>
<p>使用文档：<a target="_blank" rel="noopener" href="https://www.spug.dev/docs/about-spug/">https://www.spug.dev/docs/about-spug/</a></p>
<p>gitee链接: <a target="_blank" rel="noopener" href="https://gitee.com/openspug/spug">https://gitee.com/openspug/spug</a></p>
<h3 id="部署过程"><a href="#部署过程" class="headerlink" title="部署过程"></a>部署过程</h3><p>官方说明:</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://www.spug.dev/docs/install-docker/</span><br></pre></td></tr></table></figure>

<h4 id="安装docker"><a href="#安装docker" class="headerlink" title="安装docker"></a>安装docker</h4><p>略</p>
<p><img src="https://ts1.tc.mm.bing.net/th/id/R-C.5c2000813358a08c1cc56db64e5b06ec?rik=jcAky4JVD7IzBg&riu=http://www.guangyuanol.cn/uploads/allimg/190611/1241413247-5.png&ehk=D7K80AxH19rJKqG5JCObuX7cM9NCzDrA2rVP+r9INfY=&risl=&pid=ImgRaw&r=0" alt="lue"></p>
<h4 id="拉取镜像"><a href="#拉取镜像" class="headerlink" title="拉取镜像"></a>拉取镜像</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@rocky8 ~]<span class="comment"># docker pull registry.aliyuncs.com/openspug/spug</span></span><br></pre></td></tr></table></figure>

<h4 id="启动容器-1"><a href="#启动容器-1" class="headerlink" title="启动容器"></a>启动容器</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@rocky8 ~]<span class="comment"># docker run -d --restart always --name spug -p 80:80 registry.aliyuncs.com/openspug/spug</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 持久化存储启动命令：</span></span><br><span class="line"><span class="comment"># mydata指的是本地磁盘路径，也可以是其他目录，但需要保证映射的本地磁盘路径已经存在，/data是容器内代码和数据初始化存储的路径</span></span><br><span class="line">$ docker run -d --restart=always --name=spug -p 80:80 -v /mydata/:/data/spug</span><br></pre></td></tr></table></figure>

<h4 id="初始化"><a href="#初始化" class="headerlink" title="初始化"></a>初始化</h4><p>以下操作会创建一个用户名为 <code>admin</code> 密码为 <code>000000</code>的管理员账户，可自行替换管理员账户。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">[root@rocky8 ~]<span class="comment"># docker exec spug init_spug admin 000000</span></span><br><span class="line"></span><br><span class="line">Running migrations:</span><br><span class="line">  Applying account.0001_initial... OK</span><br><span class="line">  Applying alarm.0001_initial... OK</span><br><span class="line">  Applying config.0001_initial... OK</span><br><span class="line">  Applying app.0001_initial... OK</span><br><span class="line">  Applying repository.0001_initial... OK</span><br><span class="line">  Applying deploy.0001_initial... OK</span><br><span class="line">  Applying exec.0001_initial... OK</span><br><span class="line">  Applying home.0001_initial... OK</span><br><span class="line">  Applying host.0001_initial... OK</span><br><span class="line">  Applying monitor.0001_initial... OK</span><br><span class="line">  Applying notify.0001_initial... OK</span><br><span class="line">  Applying schedule.0001_initial... OK</span><br><span class="line">  Applying setting.0001_initial... OK</span><br><span class="line">初始化/更新成功</span><br><span class="line">/usr/local/lib/python3.6/site-packages/OpenSSL/_util.py:6: CryptographyDeprecationWarning: Python 3.6 is no longer supported by the Python core team. Therefore, support <span class="keyword">for</span> it is deprecated <span class="keyword">in</span> cryptography. The next release of cryptography will remove support <span class="keyword">for</span> Python 3.6.</span><br><span class="line">  from cryptography.hazmat.bindings.openssl.binding import Binding</span><br><span class="line">创建用户成功</span><br></pre></td></tr></table></figure>

<h4 id="访问测试"><a href="#访问测试" class="headerlink" title="访问测试"></a>访问测试</h4><p>在浏览器中输入 <a target="_blank" rel="noopener" href="http://localhost/">http://localhost:80</a> 访问。</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">用户名： admin 密码： 000000</span><br></pre></td></tr></table></figure>

<p><img src="../../../../images/SRE/day46/31.jpg" alt="31"><br><img src="../../../../images/SRE/day46/32.jpg" alt="32"></p>
<h1 id="Docker-镜像制作和管理"><a href="#Docker-镜像制作和管理" class="headerlink" title="Docker 镜像制作和管理"></a>Docker 镜像制作和管理</h1><h2 id="Docker-镜像说明"><a href="#Docker-镜像说明" class="headerlink" title="Docker 镜像说明"></a>Docker 镜像说明</h2><h3 id="Docker-镜像中有没有内核"><a href="#Docker-镜像中有没有内核" class="headerlink" title="Docker 镜像中有没有内核"></a>Docker 镜像中有没有内核</h3><p>从镜像大小上面来说，一个比较小的镜像只有1MB多点或几MB，而内核文件需要几十MB， 因此镜像里面是没有内核的，镜像在被启动为容器后将直接使用宿主机的内核，而镜像本身则只提供相应的rootfs，即系统正常运行所必须的用户空间的文件系统，比如: /dev/，/proc，/bin，/etc等目录，容器当中/boot目录是空的，而/boot当中保存的就是与内核相关的文件和目录。</p>
<h3 id="为什么没有内核"><a href="#为什么没有内核" class="headerlink" title="为什么没有内核"></a>为什么没有内核</h3><p>由于容器启动和运行过程中是直接使用了宿主机的内核，不会直接调用物理硬件，所以也不会涉及到硬件驱动，因此也无需容器内拥有自已的内核和驱动。而如果使用虚拟机技术，对应每个虚拟机都有自已独立的内核</p>
<h3 id="容器中的程序后台运行会导致此容器启动后立即退出"><a href="#容器中的程序后台运行会导致此容器启动后立即退出" class="headerlink" title="容器中的程序后台运行会导致此容器启动后立即退出"></a>容器中的程序后台运行会导致此容器启动后立即退出</h3><p>Docker容器如果希望启动后能持续运行,就必须有一个能前台持续运行的进程，如果在容器中启动传统的服务，如:httpd,php-fpm等均为后台进程模式运行,就导致 docker 在前台没有运行的应用,这样的容器启动后会立即退出。所以一般会将服务程序以前台方式运行，对于有一些可能不知道怎么实现前台运行的程序,只需要在你启动的该程序之后添加类似于 tail ，top 这种可以前台运行的程序即可. 比较常用的方法，如 <code>tail -f /etc/hosts</code>。</p>
<p>范例:</p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#httpd</span></span><br><span class="line"><span class="keyword">ENTRYPOINT</span><span class="language-bash"> [ <span class="string">&quot;/usr/sbin/apache2&quot;</span> ]  </span></span><br><span class="line"><span class="keyword">CMD</span><span class="language-bash"> [<span class="string">&quot;-D&quot;</span>, <span class="string">&quot;FOREGROUND&quot;</span>] </span></span><br><span class="line"></span><br><span class="line"><span class="comment">#nginx</span></span><br><span class="line"><span class="keyword">ENTRYPOINT</span><span class="language-bash"> [ <span class="string">&quot;/usr/sbin/nginx&quot;</span>, <span class="string">&quot;-g&quot;</span>, <span class="string">&quot;daemon off;&quot;</span> ]  </span></span><br><span class="line"></span><br><span class="line"><span class="comment">#用脚本运行容器</span></span><br><span class="line">cat run_haproxy.sh </span><br><span class="line"><span class="comment">#!/bin/bash</span></span><br><span class="line">haproxy -f /etc/haproxy/haproxy.cfg</span><br><span class="line">tail -f /etc/hosts</span><br><span class="line">tail -n1 Dockerfile </span><br><span class="line"><span class="keyword">CMD</span><span class="language-bash"> [<span class="string">&quot;run_haproxy.sh&quot;</span>]</span></span><br></pre></td></tr></table></figure>

<h3 id="docker-镜像生命周期"><a href="#docker-镜像生命周期" class="headerlink" title="docker 镜像生命周期"></a>docker 镜像生命周期</h3><p><img src="../../../../images/SRE/day46/33.jpg" alt="33"></p>
<h3 id="制作镜像方式"><a href="#制作镜像方式" class="headerlink" title="制作镜像方式"></a>制作镜像方式</h3><p>Docker 镜像制作类似于虚拟机的镜像（模版）制作，即按照公司的实际业务需求将需要安装的软件、相关配置等基础环境配置完成，然后将其做成镜像，最后再批量从镜像批量生成容器实例，这样可以极大的简化相同环境的部署工作.</p>
<p>Docker的镜像制作分为手动制作（基于容器）和自动制作(基于DockerFile)，企业通常都是基于Dockerfile制作镜像</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">docker commit   <span class="comment">#通过修改现有容器,将之手动构建为镜像</span></span><br><span class="line">docker build    <span class="comment">#通过Dockerfile文件,批量构建为镜像</span></span><br></pre></td></tr></table></figure>

<h2 id="将现有容器通过-docker-commit-手动构建镜像"><a href="#将现有容器通过-docker-commit-手动构建镜像" class="headerlink" title="将现有容器通过 docker commit 手动构建镜像"></a>将现有容器通过 docker commit 手动构建镜像</h2><h3 id="基于容器手动制作镜像步骤"><a href="#基于容器手动制作镜像步骤" class="headerlink" title="基于容器手动制作镜像步骤"></a>基于容器手动制作镜像步骤</h3><p><strong>docker commit 格式</strong></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">docker commit [OPTIONS] CONTAINER [REPOSITORY[:TAG]]</span><br><span class="line"></span><br><span class="line"><span class="comment">#选项</span></span><br><span class="line">-a, --author string    Author (e.g., <span class="string">&quot;John Hannibal Smith &lt;hannibal@a-team.com&gt;&quot;</span>)</span><br><span class="line">-c, --change list      Apply Dockerfile instruction to the created image</span><br><span class="line">-m, --message string   Commit message</span><br><span class="line">-p, --pause            Pause container during commit (default <span class="literal">true</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#说明:</span></span><br><span class="line">制作镜像和CONTAINER状态无关,停止状态也可以制作镜像</span><br><span class="line">如果没有指定[REPOSITORY[:TAG]],REPOSITORY和TAG都为&lt;none&gt;</span><br><span class="line">提交的时候标记TAG号: 生产当中常用，后期可以根据TAG标记创建不同版本的镜像以及创建不同版本的容器</span><br></pre></td></tr></table></figure>

<p><strong>基于容器手动制作镜像步骤具体如下:</strong></p>
<ol>
<li><p>下载一个系统的官方基础镜像，如: CentOS 或 Ubuntu</p>
</li>
<li><p>基于基础镜像启动一个容器,并进入到容器</p>
</li>
<li><p>在容器里面做配置操作</p>
<ul>
<li>安装基础命令</li>
<li>配置运行环境</li>
<li>安装服务和配置服务</li>
<li>放业务程序代码</li>
</ul>
</li>
<li><p>提交为一个新镜像 docker commit</p>
</li>
<li><p>基于自己的的镜像创建容器并测试访问</p>
</li>
</ol>
<h3 id="实战案例-基于-busybox-制作-httpd-镜像"><a href="#实战案例-基于-busybox-制作-httpd-镜像" class="headerlink" title="实战案例: 基于 busybox 制作 httpd 镜像"></a>实战案例: 基于 busybox 制作 httpd 镜像</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line">[root@rocky8 ~]<span class="comment"># docker run -it --name b1 busybox</span></span><br><span class="line">/ <span class="comment"># mkdir /data/html -p</span></span><br><span class="line">/ <span class="comment"># echo &quot;httpd website in busybox&quot; &gt; /data/html/index.html</span></span><br><span class="line">/ <span class="comment"># httpd --help</span></span><br><span class="line">BusyBox v1.37.0 (2024-09-26 21:31:42 UTC) multi-call binary.</span><br><span class="line"></span><br><span class="line">Usage: httpd [-ifv[v]] [-c CONFFILE] [-p [IP:]PORT] [-u USER[:GRP]] [-r REALM] [-h HOME]</span><br><span class="line">or httpd -d/-e/-m STRING</span><br><span class="line"></span><br><span class="line">Listen <span class="keyword">for</span> incoming HTTP requests</span><br><span class="line"></span><br><span class="line">	-i		Inetd mode</span><br><span class="line">	-f		Run <span class="keyword">in</span> foreground</span><br><span class="line">	-v[v]		Verbose</span><br><span class="line">	-p [IP:]PORT	Bind to IP:PORT (default *:80)</span><br><span class="line">	-u USER[:GRP]	Set uid/gid after binding to port</span><br><span class="line">	-r REALM	Authentication Realm <span class="keyword">for</span> Basic Authentication</span><br><span class="line">	-h HOME		Home directory (default .)</span><br><span class="line">	-c FILE		Configuration file (default &#123;/etc,HOME&#125;/httpd.conf)</span><br><span class="line">	-m STRING	MD5 crypt STRING</span><br><span class="line">	-e STRING	HTML encode STRING</span><br><span class="line">	-d STRING	URL decode STRING</span><br><span class="line">/ <span class="comment"># exit</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#格式1</span></span><br><span class="line">[root@rocky8 ~]<span class="comment"># docker commit -a &quot;wang&lt;root@wshuaiqing.cn&gt;&quot; -c &quot;CMD /bin/httpd -fv -h /data/html&quot; -c &quot;EXPOSE 80&quot; b1 httpd-busybox:v1.0</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#格式2</span></span><br><span class="line">[root@rocky8 ~]<span class="comment"># docker commit -a &quot;wang&lt;root@wshuaiqing.cn&gt;&quot; -c &#x27;CMD [&quot;/bin/httpd&quot;, &quot;-f&quot;, &quot;-v&quot;, &quot;-h&quot;, &quot;/data/html&quot;]&#x27; -c &quot;EXPOSE 80&quot; b1 httpd-busybox:v2.0</span></span><br><span class="line"></span><br><span class="line">[root@rocky8 ~]<span class="comment"># docker images</span></span><br><span class="line">REPOSITORY                            TAG              IMAGE ID       CREATED          SIZE</span><br><span class="line">httpd-busybox                         v2.0             171d8747fd7f   24 seconds ago   4.28MB</span><br><span class="line">httpd-busybox                         v1.0             f9b8dfc20bc0   2 minutes ago    4.28MB</span><br><span class="line"></span><br><span class="line">[root@rocky8 ~]<span class="comment"># docker run -d -P --name httpd01 httpd-busybox:v1.0 </span></span><br><span class="line">ed184063880e560573a587e62ef866fd04d654588a1028c96a1c2fa5e1f8ff05</span><br><span class="line"></span><br><span class="line">[root@rocky8 ~]<span class="comment"># docker run -d -P --name httpd02 httpd-busybox:v2.0 </span></span><br><span class="line">c5e31570973b418e157ef2a638fbfacd33226b0df7b029fb08f201b919a4063f</span><br><span class="line"></span><br><span class="line">[root@rocky8 ~]<span class="comment"># docker inspect -f &quot;&#123;&#123;.NetworkSettings.Networks.bridge.IPAddress&#125;&#125;&quot; httpd01</span></span><br><span class="line">172.17.0.2</span><br><span class="line"></span><br><span class="line">[root@rocky8 ~]<span class="comment"># docker inspect -f &quot;&#123;&#123;.NetworkSettings.Networks.bridge.IPAddress&#125;&#125;&quot; httpd02</span></span><br><span class="line">172.17.0.3</span><br><span class="line"></span><br><span class="line"><span class="comment">#对应格式1</span></span><br><span class="line">[root@rocky8 ~]<span class="comment"># docker inspect -f &quot;&#123;&#123;.Config.Cmd&#125;&#125;&quot; httpd01</span></span><br><span class="line">[/bin/sh -c /bin/httpd -fv -h /data/html]</span><br><span class="line"></span><br><span class="line"><span class="comment">#对应格式2</span></span><br><span class="line">[root@rocky8 ~]<span class="comment"># docker run -d -P --name httpd02 httpd-busybox:v2.0 </span></span><br><span class="line">c5e31570973b418e157ef2a638fbfacd33226b0df7b029fb08f201b919a4063f</span><br><span class="line"></span><br><span class="line">[root@rocky8 ~]<span class="comment"># docker inspect -f &quot;&#123;&#123;.Config.Cmd&#125;&#125;&quot; httpd02</span></span><br><span class="line">[/bin/httpd -f -v -h /data/html]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@rocky8 ~]<span class="comment"># docker exec -it httpd01 sh</span></span><br><span class="line">/ <span class="comment"># pstree -p</span></span><br><span class="line">httpd(1)</span><br><span class="line"></span><br><span class="line">/ <span class="comment"># ps aux</span></span><br><span class="line">PID   USER     TIME  COMMAND</span><br><span class="line">    1 root      0:00 /bin/httpd -fv -h /data/html</span><br><span class="line">    7 root      0:00 sh</span><br><span class="line">   14 root      0:00 ps aux</span><br><span class="line"></span><br><span class="line">[root@rocky8 ~]<span class="comment"># curl 172.17.0.2</span></span><br><span class="line">httpd website <span class="keyword">in</span> busybox</span><br><span class="line"></span><br><span class="line">[root@rocky8 ~]<span class="comment"># curl 192.168.1.11:32768</span></span><br><span class="line">httpd website <span class="keyword">in</span> busybox</span><br></pre></td></tr></table></figure>

<h3 id="实战案例-基于官方镜像生成的容器制作-tomcat-镜像"><a href="#实战案例-基于官方镜像生成的容器制作-tomcat-镜像" class="headerlink" title="实战案例: 基于官方镜像生成的容器制作 tomcat 镜像"></a>实战案例: 基于官方镜像生成的容器制作 tomcat 镜像</h3><h4 id="下载官方的tomcat镜像并运行"><a href="#下载官方的tomcat镜像并运行" class="headerlink" title="下载官方的tomcat镜像并运行"></a>下载官方的tomcat镜像并运行</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">[root@rocky8 ~]<span class="comment"># docker images</span></span><br><span class="line">REPOSITORY   TAG       IMAGE ID   CREATED   SIZE</span><br><span class="line"></span><br><span class="line">[root@rocky8 ~]<span class="comment"># docker run -d -p 8080:8080 tomcat</span></span><br><span class="line">Unable to find image <span class="string">&#x27;tomcat:latest&#x27;</span> locally</span><br><span class="line">latest: Pulling from library/tomcat</span><br><span class="line">5a7813e071bf: Pull complete </span><br><span class="line">8dbbbc6af9dc: Pull complete </span><br><span class="line">a10b6847b9f1: Pull complete </span><br><span class="line">dcc1c5ea3c7d: Pull complete </span><br><span class="line">91e6cc55403a: Pull complete </span><br><span class="line">5d4660d0a9e9: Pull complete </span><br><span class="line">4f4fb700ef54: Pull complete </span><br><span class="line">e231914ca483: Pull complete </span><br><span class="line">Digest: sha256:1374a565d5122fdb42807f3a5f2d4fcc245a5e15420ff5bb5123afedc8ef769d</span><br><span class="line">Status: Downloaded newer image <span class="keyword">for</span> tomcat:latest</span><br><span class="line">871ddf4c5611ee11afee3bb62cfdab10b6a9b5eb069173e45152583c7a0a2bc4</span><br><span class="line"></span><br><span class="line">[root@rocky8 ~]<span class="comment"># docker ps</span></span><br><span class="line">CONTAINER ID   IMAGE     COMMAND             CREATED          STATUS          PORTS                                       NAMES</span><br><span class="line">871ddf4c5611   tomcat    <span class="string">&quot;catalina.sh run&quot;</span>   42 seconds ago   Up 41 seconds   0.0.0.0:8080-&gt;8080/tcp, :::8080-&gt;8080/tcp   heuristic_poitras</span><br><span class="line"></span><br><span class="line">[root@rocky8 ~]<span class="comment"># curl -I 127.0.0.1:8080</span></span><br><span class="line">HTTP/1.1 404 </span><br><span class="line">Content-Type: text/html;charset=utf-8</span><br><span class="line">Content-Language: en</span><br><span class="line">Content-Length: 682</span><br><span class="line">Date: Tue, 08 Apr 2025 10:12:04 GMT</span><br></pre></td></tr></table></figure>

<h4 id="修改容器"><a href="#修改容器" class="headerlink" title="修改容器"></a>修改容器</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">[root@rocky8 ~]<span class="comment"># docker exec -it 871ddf bash</span></span><br><span class="line">root@871ddf4c5611:/usr/local/tomcat<span class="comment"># ls</span></span><br><span class="line">bin              lib             README.md      webapps</span><br><span class="line">BUILDING.txt     LICENSE         RELEASE-NOTES  webapps.dist</span><br><span class="line">conf             logs            RUNNING.txt    work</span><br><span class="line">CONTRIBUTING.md  native-jni-lib  temp</span><br><span class="line">filtered-KEYS    NOTICE          upstream-KEYS</span><br><span class="line"></span><br><span class="line">root@871ddf4c5611:/usr/local/tomcat<span class="comment"># ls webapps</span></span><br><span class="line">root@871ddf4c5611:/usr/local/tomcat<span class="comment"># ls webapps.dist/</span></span><br><span class="line">docs  examples  host-manager  manager  ROOT</span><br><span class="line"></span><br><span class="line">root@871ddf4c5611:/usr/local/tomcat<span class="comment"># cp -a webapps.dist/* webapps/</span></span><br><span class="line">root@871ddf4c5611:/usr/local/tomcat<span class="comment"># ls webapps/</span></span><br><span class="line">docs  examples  host-manager  manager  ROOT</span><br><span class="line"></span><br><span class="line">root@871ddf4c5611:/usr/local/tomcat<span class="comment"># exit</span></span><br><span class="line"><span class="built_in">exit</span></span><br><span class="line"></span><br><span class="line">[root@rocky8 ~]<span class="comment"># curl -I 127.0.0.1:8080</span></span><br><span class="line">HTTP/1.1 200 </span><br><span class="line">Content-Type: text/html;charset=UTF-8</span><br><span class="line">Date: Tue, 08 Apr 2025 10:18:57 GMT</span><br></pre></td></tr></table></figure>

<h4 id="提交新镜像"><a href="#提交新镜像" class="headerlink" title="提交新镜像"></a>提交新镜像</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br></pre></td><td class="code"><pre><span class="line">[root@rocky8 ~]<span class="comment"># docker commit 871ddf tomcat:11.0.5</span></span><br><span class="line">sha256:e25d1667ae52b796c9e64d56b981e8aeec16d80bdd712a13cb491313bb84a1e6</span><br><span class="line"></span><br><span class="line">[root@rocky8 ~]<span class="comment"># docker images</span></span><br><span class="line">REPOSITORY   TAG       IMAGE ID       CREATED         SIZE</span><br><span class="line">tomcat       11.0.5    e25d1667ae52   4 seconds ago   524MB</span><br><span class="line">tomcat       latest    88b0f1cee84c   4 weeks ago     519MB</span><br><span class="line"></span><br><span class="line">[root@rocky8 ~]<span class="comment"># docker inspect tomcat:11.0.5 </span></span><br><span class="line">[</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="string">&quot;Id&quot;</span>: <span class="string">&quot;sha256:e25d1667ae52b796c9e64d56b981e8aeec16d80bdd712a13cb491313bb84a1e6&quot;</span>,</span><br><span class="line">        <span class="string">&quot;RepoTags&quot;</span>: [</span><br><span class="line">            <span class="string">&quot;tomcat:11.0.5&quot;</span></span><br><span class="line">        ],</span><br><span class="line">        <span class="string">&quot;RepoDigests&quot;</span>: [],</span><br><span class="line">        <span class="string">&quot;Parent&quot;</span>: <span class="string">&quot;sha256:88b0f1cee84c76bb84a450edacdc37fb3ee00a8706be9298dfe8ec69e5040cdb&quot;</span>,</span><br><span class="line">        <span class="string">&quot;Comment&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">        <span class="string">&quot;Created&quot;</span>: <span class="string">&quot;2025-04-08T10:26:01.404563755Z&quot;</span>,</span><br><span class="line">        <span class="string">&quot;DockerVersion&quot;</span>: <span class="string">&quot;26.1.3&quot;</span>,</span><br><span class="line">        <span class="string">&quot;Author&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">        <span class="string">&quot;Config&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;Hostname&quot;</span>: <span class="string">&quot;871ddf4c5611&quot;</span>,</span><br><span class="line">            <span class="string">&quot;Domainname&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">            <span class="string">&quot;User&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">            <span class="string">&quot;AttachStdin&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">            <span class="string">&quot;AttachStdout&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">            <span class="string">&quot;AttachStderr&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">            <span class="string">&quot;ExposedPorts&quot;</span>: &#123;</span><br><span class="line">                <span class="string">&quot;8080/tcp&quot;</span>: &#123;&#125;</span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="string">&quot;Tty&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">            <span class="string">&quot;OpenStdin&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">            <span class="string">&quot;StdinOnce&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">            <span class="string">&quot;Env&quot;</span>: [</span><br><span class="line">                <span class="string">&quot;PATH=/usr/local/tomcat/bin:/opt/java/openjdk/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin&quot;</span>,</span><br><span class="line">                <span class="string">&quot;JAVA_HOME=/opt/java/openjdk&quot;</span>,</span><br><span class="line">                <span class="string">&quot;LANG=en_US.UTF-8&quot;</span>,</span><br><span class="line">                <span class="string">&quot;LANGUAGE=en_US:en&quot;</span>,</span><br><span class="line">                <span class="string">&quot;LC_ALL=en_US.UTF-8&quot;</span>,</span><br><span class="line">                <span class="string">&quot;JAVA_VERSION=jdk-21.0.6+7&quot;</span>,</span><br><span class="line">                <span class="string">&quot;CATALINA_HOME=/usr/local/tomcat&quot;</span>,</span><br><span class="line">                <span class="string">&quot;TOMCAT_NATIVE_LIBDIR=/usr/local/tomcat/native-jni-lib&quot;</span>,</span><br><span class="line">                <span class="string">&quot;LD_LIBRARY_PATH=/usr/local/tomcat/native-jni-lib&quot;</span>,</span><br><span class="line">                <span class="string">&quot;TOMCAT_MAJOR=11&quot;</span>,</span><br><span class="line">                <span class="string">&quot;TOMCAT_VERSION=11.0.5&quot;</span>,</span><br><span class="line">                <span class="string">&quot;TOMCAT_SHA512=99c4b3acafd5bd1a10c15b52b97ed7ff3ac7b943bf324aba0645d9894aa6f2868ebb746571332f4fa826209aa4d48b70a66e96998cecb3eac93b74f3f29170f2&quot;</span></span><br><span class="line">            ],</span><br><span class="line">            <span class="string">&quot;Cmd&quot;</span>: [</span><br><span class="line">                <span class="string">&quot;catalina.sh&quot;</span>,</span><br><span class="line">                <span class="string">&quot;run&quot;</span></span><br><span class="line">            ],</span><br><span class="line">            <span class="string">&quot;Image&quot;</span>: <span class="string">&quot;tomcat&quot;</span>,</span><br><span class="line">            <span class="string">&quot;Volumes&quot;</span>: null,</span><br><span class="line">            <span class="string">&quot;WorkingDir&quot;</span>: <span class="string">&quot;/usr/local/tomcat&quot;</span>,</span><br><span class="line">            <span class="string">&quot;Entrypoint&quot;</span>: null,</span><br><span class="line">            <span class="string">&quot;OnBuild&quot;</span>: null,</span><br><span class="line">            <span class="string">&quot;Labels&quot;</span>: &#123;</span><br><span class="line">                <span class="string">&quot;org.opencontainers.image.ref.name&quot;</span>: <span class="string">&quot;ubuntu&quot;</span>,</span><br><span class="line">                <span class="string">&quot;org.opencontainers.image.version&quot;</span>: <span class="string">&quot;24.04&quot;</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">&quot;Architecture&quot;</span>: <span class="string">&quot;amd64&quot;</span>,</span><br><span class="line">        <span class="string">&quot;Os&quot;</span>: <span class="string">&quot;linux&quot;</span>,</span><br><span class="line">        <span class="string">&quot;Size&quot;</span>: 524063690,</span><br><span class="line">        <span class="string">&quot;GraphDriver&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;Data&quot;</span>: &#123;</span><br><span class="line">                <span class="string">&quot;LowerDir&quot;</span>: <span class="string">&quot;/var/lib/docker/overlay2/4c598f6c21c79adcf8f1d312fed49f68e5db5b0afb8fcda9d332303a8dea8692/diff:/var/lib/docker/overlay2/797aad065a1d507081a17332e3a2c01d5bf21c2dfb554bc09c1bbac3731d87b4/diff:/var/lib/docker/overlay2/2cc3ec97291901f9e15385d34b28a4ac16439676afa5eae573d9e0e636afd7eb/diff:/var/lib/docker/overlay2/2765f5d286d88192ec9002c5520768204d36a0e505b9bcad07cf080cc6a347c3/diff:/var/lib/docker/overlay2/ed720e91c6c2a38da16b553482ac194287a8bdcb3998cd34e8e802807dc18c2c/diff:/var/lib/docker/overlay2/5003434228b4449ab4a73897f0790b3e92456e1d28fe58c81bc077ec55bbb66f/diff:/var/lib/docker/overlay2/34bbbc437d8c55a50d7fbaa7b6b2cf7a40b19e167b3847a9949afeb799643bc4/diff:/var/lib/docker/overlay2/fb1889a11761e13b8225d853aacaaf21849f474b19152aa6a262ca7ff1a5fde3/diff:/var/lib/docker/overlay2/3a277976be1007eb2f7d79cbadca141937db61eb38a7ab5c8e358a72e8ca60fa/diff&quot;</span>,</span><br><span class="line">                <span class="string">&quot;MergedDir&quot;</span>: <span class="string">&quot;/var/lib/docker/overlay2/b2643d3dcd360f19e02339bf76708020390b9f5c1f27552ea5808971092c78c7/merged&quot;</span>,</span><br><span class="line">                <span class="string">&quot;UpperDir&quot;</span>: <span class="string">&quot;/var/lib/docker/overlay2/b2643d3dcd360f19e02339bf76708020390b9f5c1f27552ea5808971092c78c7/diff&quot;</span>,</span><br><span class="line">                <span class="string">&quot;WorkDir&quot;</span>: <span class="string">&quot;/var/lib/docker/overlay2/b2643d3dcd360f19e02339bf76708020390b9f5c1f27552ea5808971092c78c7/work&quot;</span></span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="string">&quot;Name&quot;</span>: <span class="string">&quot;overlay2&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">&quot;RootFS&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;Type&quot;</span>: <span class="string">&quot;layers&quot;</span>,</span><br><span class="line">            <span class="string">&quot;Layers&quot;</span>: [</span><br><span class="line">                <span class="string">&quot;sha256:4b7c01ed0534d4f9be9cf97d068da1598c6c20b26cb6134fad066defdb6d541d&quot;</span>,</span><br><span class="line">                <span class="string">&quot;sha256:3359bc3d7a6a1f94c063d743f3ebd025e299dfbbbb1d48afe18a90e4d5e1f36f&quot;</span>,</span><br><span class="line">                <span class="string">&quot;sha256:f844dcf94898d99c5a27de863a79e15d5353a6802f1804d01475be0e7b23221f&quot;</span>,</span><br><span class="line">                <span class="string">&quot;sha256:39cf0ac89a5a18bb69e6cc51b9f37eb9025b0bc85a7433d2ef85256810804361&quot;</span>,</span><br><span class="line">                <span class="string">&quot;sha256:4e5b554b734518d308942fd75da104b3dc27a25676fa51ce8d36a40e4a5f2491&quot;</span>,</span><br><span class="line">                <span class="string">&quot;sha256:49cb1bc2daeb9c8543094a01a8a7e261040e7a3cbbc9e58ffae279dde71ac65b&quot;</span>,</span><br><span class="line">                <span class="string">&quot;sha256:5f70bf18a086007016e948b04aed3b82103a36bea41755b6cddfaf10ace3c6ef&quot;</span>,</span><br><span class="line">                <span class="string">&quot;sha256:6fbdf02a6a33fb7e6564c9d0d4f879d3845c91f60805babfe73104e1e0969def&quot;</span>,</span><br><span class="line">                <span class="string">&quot;sha256:5f70bf18a086007016e948b04aed3b82103a36bea41755b6cddfaf10ace3c6ef&quot;</span>,</span><br><span class="line">                <span class="string">&quot;sha256:bb6d85a0bf949d520975c55f10dd895eeb849e980e631b5ca83aae8ef5f29f81&quot;</span></span><br><span class="line">            ]</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">&quot;Metadata&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;LastTagTime&quot;</span>: <span class="string">&quot;2025-04-08T18:26:01.407969774+08:00&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line"><span class="comment">#删除当前的容器</span></span><br><span class="line">[root@rocky8 ~]<span class="comment"># docker rm -f 871ddf4c5611</span></span><br><span class="line">[root@rocky8 ~]<span class="comment"># docker ps -a</span></span><br><span class="line">CONTAINER ID   IMAGE     COMMAND   CREATED   STATUS    PORTS     NAMES</span><br></pre></td></tr></table></figure>

<h4 id="利用新镜像启动容器"><a href="#利用新镜像启动容器" class="headerlink" title="利用新镜像启动容器"></a>利用新镜像启动容器</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@rocky8 ~]<span class="comment"># docker run -d --name tomcat -p 8080:8080 tomcat:11.0.5</span></span><br><span class="line">bd112dd8a3040a91b06d76fbdac96964b75f4a8ea3413b591d9c7206c7be7a96</span><br><span class="line"></span><br><span class="line">[root@rocky8 ~]<span class="comment"># docker ps</span></span><br><span class="line">CONTAINER ID   IMAGE           COMMAND             CREATED         STATUS         PORTS                                       NAMES</span><br><span class="line">bd112dd8a304   tomcat:11.0.5   <span class="string">&quot;catalina.sh run&quot;</span>   4 seconds ago   Up 3 seconds   0.0.0.0:8080-&gt;8080/tcp, :::8080-&gt;8080/tcp   tomcat</span><br></pre></td></tr></table></figure>

<h4 id="测试新镜像启动的容器"><a href="#测试新镜像启动的容器" class="headerlink" title="测试新镜像启动的容器"></a>测试新镜像启动的容器</h4><p>浏览器访问 <a target="_blank" rel="noopener" href="http://192.168.1.11:8080/">http://192.168.1.11:8080/</a> 可以看到下面显示</p>
<p><img src="../../../../images/SRE/day46/34.jpg" alt="34"></p>
<h3 id="实战案例-基于Ubuntu的基础镜像利用-apt-安装手动制作-nginx-的镜像"><a href="#实战案例-基于Ubuntu的基础镜像利用-apt-安装手动制作-nginx-的镜像" class="headerlink" title="实战案例: 基于Ubuntu的基础镜像利用 apt 安装手动制作 nginx 的镜像"></a>实战案例: 基于Ubuntu的基础镜像利用 apt 安装手动制作 nginx 的镜像</h3><h4 id="启动Ubuntu基础镜像并实现相关的配置"><a href="#启动Ubuntu基础镜像并实现相关的配置" class="headerlink" title="启动Ubuntu基础镜像并实现相关的配置"></a>启动Ubuntu基础镜像并实现相关的配置</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br></pre></td><td class="code"><pre><span class="line">[root@rocky8 ~]<span class="comment"># docker run -it -p 80 --name nginx_ubuntu ubuntu bash</span></span><br><span class="line">root@ecb03c42d1f0:/<span class="comment"># cat /etc/os-release </span></span><br><span class="line">PRETTY_NAME=<span class="string">&quot;Ubuntu 24.04.1 LTS&quot;</span></span><br><span class="line">NAME=<span class="string">&quot;Ubuntu&quot;</span></span><br><span class="line">VERSION_ID=<span class="string">&quot;24.04&quot;</span></span><br><span class="line">VERSION=<span class="string">&quot;24.04.1 LTS (Noble Numbat)&quot;</span></span><br><span class="line">VERSION_CODENAME=noble</span><br><span class="line">ID=ubuntu</span><br><span class="line">ID_LIKE=debian</span><br><span class="line">HOME_URL=<span class="string">&quot;https://www.ubuntu.com/&quot;</span></span><br><span class="line">SUPPORT_URL=<span class="string">&quot;https://help.ubuntu.com/&quot;</span></span><br><span class="line">BUG_REPORT_URL=<span class="string">&quot;https://bugs.launchpad.net/ubuntu/&quot;</span></span><br><span class="line">PRIVACY_POLICY_URL=<span class="string">&quot;https://www.ubuntu.com/legal/terms-and-policies/privacy-policy&quot;</span></span><br><span class="line">UBUNTU_CODENAME=noble</span><br><span class="line">LOGO=ubuntu-logo</span><br><span class="line"></span><br><span class="line">root@ecb03c42d1f0:/<span class="comment"># ll /etc/apt/sources.list</span></span><br><span class="line">-rw-r--r-- 1 root root 270 Jan 27 02:09 /etc/apt/sources.list</span><br><span class="line"></span><br><span class="line"><span class="comment">#如果时间不对需要同步以下时间，如果不同步下面配置阿里源报错</span></span><br><span class="line">root@ecb03c42d1f0:/<span class="comment"># apt install -y ntpdate</span></span><br><span class="line">------------------</span><br><span class="line"></span><br><span class="line">Please select the geographic area <span class="keyword">in</span> <span class="built_in">which</span> you live. Subsequent configuration</span><br><span class="line">questions will narrow this down by presenting a list of cities, representing the time</span><br><span class="line">zones <span class="keyword">in</span> <span class="built_in">which</span> they are located.</span><br><span class="line"></span><br><span class="line">  1. Africa   3. Antarctica  5. Asia      7. Australia  9. Indian    11. Etc</span><br><span class="line">  2. America  4. Arctic      6. Atlantic  8. Europe     10. Pacific  12. Legacy</span><br><span class="line">Geographic area: 5</span><br><span class="line"></span><br><span class="line">Please select the city or region corresponding to your time zone.</span><br><span class="line"></span><br><span class="line">  1. Aden         23. Dili         45. Krasnoyarsk   67. Samarkand</span><br><span class="line">  2. Almaty       24. Dubai        46. Kuala_Lumpur  68. Seoul</span><br><span class="line">  3. Amman        25. Dushanbe     47. Kuching       69. Shanghai</span><br><span class="line">  4. Anadyr       26. Famagusta    48. Kuwait        70. Singapore</span><br><span class="line">  5. Aqtau        27. Gaza         49. Macau         71. Srednekolymsk</span><br><span class="line">  6. Aqtobe       28. Harbin       50. Magadan       72. Taipei</span><br><span class="line">  7. Ashgabat     29. Hebron       51. Makassar      73. Tashkent</span><br><span class="line">  8. Atyrau       30. Ho_Chi_Minh  52. Manila        74. Tbilisi</span><br><span class="line">  9. Baghdad      31. Hong_Kong    53. Muscat        75. Tehran</span><br><span class="line">  10. Bahrain     32. Hovd         54. Nicosia       76. Tel_Aviv</span><br><span class="line">  11. Baku        33. Irkutsk      55. Novokuznetsk  77. Thimphu</span><br><span class="line">  12. Bangkok     34. Istanbul     56. Novosibirsk   78. Tokyo</span><br><span class="line">  13. Barnaul     35. Jakarta      57. Omsk          79. Tomsk</span><br><span class="line">  14. Beirut      36. Jayapura     58. Oral          80. Ulaanbaatar</span><br><span class="line">  15. Bishkek     37. Jerusalem    59. Phnom_Penh    81. Urumqi</span><br><span class="line">  16. Brunei      38. Kabul        60. Pontianak     82. Ust-Nera</span><br><span class="line">  17. Chita       39. Kamchatka    61. Pyongyang     83. Vientiane</span><br><span class="line">  18. Choibalsan  40. Karachi      62. Qatar         84. Vladivostok</span><br><span class="line">  19. Chongqing   41. Kashgar      63. Qostanay      85. Yakutsk</span><br><span class="line">  20. Colombo     42. Kathmandu    64. Qyzylorda     86. Yangon</span><br><span class="line">  21. Damascus    43. Khandyga     65. Riyadh        87. Yekaterinburg</span><br><span class="line">  22. Dhaka       44. Kolkata      66. Sakhalin      88. Yerevan</span><br><span class="line">Time zone: 69</span><br><span class="line"></span><br><span class="line">root@ecb03c42d1f0:/<span class="comment"># date</span></span><br><span class="line">Wed Apr  9 09:03:22 CST 2025</span><br><span class="line"></span><br><span class="line">root@ecb03c42d1f0:/<span class="comment"># cat &gt; /etc/apt/sources.list</span></span><br><span class="line">deb http://mirrors.aliyun.com/ubuntu/ focal main restricted universe multiverse</span><br><span class="line">deb-src http://mirrors.aliyun.com/ubuntu/ focal main restricted universe multiverse</span><br><span class="line"></span><br><span class="line">deb http://mirrors.aliyun.com/ubuntu/ focal-security main restricted universe multiverse</span><br><span class="line">deb-src http://mirrors.aliyun.com/ubuntu/ focal-security main restricted universe multiverse</span><br><span class="line"></span><br><span class="line">deb http://mirrors.aliyun.com/ubuntu/ focal-updates main restricted universe multiverse</span><br><span class="line">deb-src http://mirrors.aliyun.com/ubuntu/ focal-updates main restricted universe multiverse</span><br><span class="line"></span><br><span class="line">deb http://mirrors.aliyun.com/ubuntu/ focal-proposed main restricted universe multiverse</span><br><span class="line">deb-src http://mirrors.aliyun.com/ubuntu/ focal-proposed main restricted universe multiverse</span><br><span class="line"></span><br><span class="line">deb http://mirrors.aliyun.com/ubuntu/ focal-backports main restricted universe multiverse</span><br><span class="line">deb-src http://mirrors.aliyun.com/ubuntu/ focal-backports main restricted universe multiverse</span><br><span class="line">^C</span><br><span class="line"></span><br><span class="line">root@ecb03c42d1f0:/<span class="comment"># apt update</span></span><br><span class="line">root@ecb03c42d1f0:/<span class="comment"># apt install -y nginx</span></span><br><span class="line">root@ecb03c42d1f0:/<span class="comment"># nginx -v</span></span><br><span class="line">nginx version: nginx/1.24.0 (Ubuntu)</span><br><span class="line"></span><br><span class="line">root@ecb03c42d1f0:/<span class="comment"># grep include /etc/nginx/nginx.conf </span></span><br><span class="line">include /etc/nginx/modules-enabled/*.conf;</span><br><span class="line">	include /etc/nginx/mime.types;</span><br><span class="line">	include /etc/nginx/conf.d/*.conf;</span><br><span class="line">	include /etc/nginx/sites-enabled/*;</span><br><span class="line"></span><br><span class="line">root@ecb03c42d1f0:/<span class="comment"># grep root /etc/nginx/sites-enabled/default </span></span><br><span class="line">	root /var/www/html;</span><br><span class="line">	<span class="comment"># deny access to .htaccess files, if Apache&#x27;s document root</span></span><br><span class="line"><span class="comment">#	root /var/www/example.com;</span></span><br><span class="line"></span><br><span class="line">root@ecb03c42d1f0:/<span class="comment"># echo Nginx Website in Docker &gt; /var/www/html/index.html</span></span><br><span class="line"></span><br><span class="line">root@ecb03c42d1f0:/<span class="comment"># exit</span></span><br><span class="line"><span class="built_in">exit</span></span><br></pre></td></tr></table></figure>

<h4 id="提交为镜像"><a href="#提交为镜像" class="headerlink" title="提交为镜像"></a>提交为镜像</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@rocky8 ~]<span class="comment"># docker commit -a &quot;wshuaiqing.cn&quot; -m &#x27;nginx-ubuntu:24.04&#x27; nginx_ubuntu nginx_ubuntu24.04:v1.18.0</span></span><br><span class="line">sha256:e41ea02f6d243d55402d0934905b56e9a1605b8162ffaa4a611f5f226c8e4a39</span><br><span class="line"></span><br><span class="line">[root@rocky8 ~]<span class="comment"># docker images nginx_ubuntu24.04:v1.18.0</span></span><br><span class="line">REPOSITORY          TAG       IMAGE ID       CREATED          SIZE</span><br><span class="line">nginx_ubuntu24.04   v1.18.0   e41ea02f6d24   12 seconds ago   266MB</span><br></pre></td></tr></table></figure>

<h4 id="从制作的新镜像启动容器并测试访问"><a href="#从制作的新镜像启动容器并测试访问" class="headerlink" title="从制作的新镜像启动容器并测试访问"></a>从制作的新镜像启动容器并测试访问</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[root@rocky8 ~]<span class="comment"># docker run -d -p 80 --name nginx-web nginx_ubuntu24.04:v1.18.0 nginx -g &#x27;daemon off;&#x27;</span></span><br><span class="line">6a433a6c11cbb44c95c4980e74f0178381f76b10bd7151d62e13ec0982adf413</span><br><span class="line"></span><br><span class="line">[root@rocky8 ~]<span class="comment"># docker ps -l</span></span><br><span class="line">CONTAINER ID   IMAGE                       COMMAND                  CREATED         STATUS         PORTS                                     NAMES</span><br><span class="line">6a433a6c11cb   nginx_ubuntu24.04:v1.18.0   <span class="string">&quot;nginx -g &#x27;daemon of…&quot;</span>   6 seconds ago   Up 5 seconds   0.0.0.0:32772-&gt;80/tcp, :::32772-&gt;80/tcp   nginx-web</span><br><span class="line"></span><br><span class="line">[root@rocky8 ~]<span class="comment"># docker port nginx-web </span></span><br><span class="line">80/tcp -&gt; 0.0.0.0:32772</span><br><span class="line">80/tcp -&gt; [::]:32772</span><br><span class="line"></span><br><span class="line">[root@rocky8 ~]<span class="comment"># curl 127.0.0.1:32772</span></span><br><span class="line">Nginx Website <span class="keyword">in</span> Docker</span><br></pre></td></tr></table></figure>

<h3 id="实战案例-基于CentOS的基础镜像利用-yum-安装手动制作-nginx-的镜像"><a href="#实战案例-基于CentOS的基础镜像利用-yum-安装手动制作-nginx-的镜像" class="headerlink" title="实战案例: 基于CentOS的基础镜像利用 yum 安装手动制作 nginx 的镜像"></a>实战案例: 基于CentOS的基础镜像利用 yum 安装手动制作 nginx 的镜像</h3><h4 id="下载基础镜像并初始化系统"><a href="#下载基础镜像并初始化系统" class="headerlink" title="下载基础镜像并初始化系统"></a>下载基础镜像并初始化系统</h4><p>基于某个基础镜像之上重新制作，因此需要先有一个基础镜像，本次使用官方提供的centos镜像为基础</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">[root@rocky8 ~]<span class="comment"># docker run -it --name nginx_centos centos bash</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#修改时区</span></span><br><span class="line">[root@37bb54287e87 /]<span class="comment"># rm -rf /etc/localtime </span></span><br><span class="line">[root@37bb54287e87 /]<span class="comment"># ln -s /usr/share/zoneinfo/Asia/Shanghai /etc/localtime</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#更改yum 源</span></span><br><span class="line">[root@37bb54287e87 /]<span class="comment"># rm -rf /etc/yum.repos.d/*</span></span><br><span class="line">[root@37bb54287e87 /]<span class="comment"># curl -o /etc/yum.repos.d/CentOS-Base.repo https://mirrors.aliyun.com/repo/Centos-vault-8.5.2111.repo</span></span><br><span class="line">  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current</span><br><span class="line">                                 Dload  Upload   Total   Spent    Left  Speed</span><br><span class="line">100  2495  100  2495    0     0   6160      0 --:--:-- --:--:-- --:--:--  6175</span><br><span class="line"></span><br><span class="line">[root@37bb54287e87 /]<span class="comment"># yum repolist</span></span><br><span class="line">Failed to <span class="built_in">set</span> locale, defaulting to C.UTF-8</span><br><span class="line">repo <span class="built_in">id</span>                 repo name</span><br><span class="line">AppStream               CentOS-8.5.2111 - AppStream - mirrors.aliyun.com</span><br><span class="line">base                    CentOS-8.5.2111 - Base - mirrors.aliyun.com</span><br><span class="line">extras                  CentOS-8.5.2111 - Extras - mirrors.aliyun.com</span><br></pre></td></tr></table></figure>

<h4 id="安装相关软件和工具"><a href="#安装相关软件和工具" class="headerlink" title="安装相关软件和工具"></a>安装相关软件和工具</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#yum安装nginx</span></span><br><span class="line">[root@37bb54287e87 /]<span class="comment"># yum install -y nginx</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#安装常用命令</span></span><br><span class="line">[root@37bb54287e87 /]<span class="comment"># yum install -y vim curl iproute net-tools wget</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#清理yum缓存</span></span><br><span class="line">[root@37bb54287e87 /]<span class="comment"># rm -rf /var/cache/dnf/*</span></span><br></pre></td></tr></table></figure>

<h4 id="修改服务的配置信息关闭服务后台运行"><a href="#修改服务的配置信息关闭服务后台运行" class="headerlink" title="修改服务的配置信息关闭服务后台运行"></a>修改服务的配置信息关闭服务后台运行</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#关闭nginx后台运行</span></span><br><span class="line">[root@37bb54287e87 /]<span class="comment"># vim /etc/nginx/nginx.conf</span></span><br><span class="line">user nginx;</span><br><span class="line">daemon off;  <span class="comment">#关闭后台运行</span></span><br></pre></td></tr></table></figure>

<h4 id="准备程序和数据"><a href="#准备程序和数据" class="headerlink" title="准备程序和数据"></a>准备程序和数据</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#自定义web界面</span></span><br><span class="line">[root@37bb54287e87 /]<span class="comment"># rm -f /usr/share/nginx/html/index.html </span></span><br><span class="line">[root@37bb54287e87 /]<span class="comment"># echo &quot;Nginx Page in Docker&quot; &gt; /usr/share/nginx/html/index.html</span></span><br></pre></td></tr></table></figure>

<h4 id="提交为镜像-1"><a href="#提交为镜像-1" class="headerlink" title="提交为镜像"></a>提交为镜像</h4><p>docker commit 命令在宿主机基于容器ID 提交为镜像</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#不关闭容器的情况,将容器提交为镜像</span></span><br><span class="line">[root@rocky8 /]<span class="comment"># docker commit -a &quot;wshuaiqing.cn&quot; -m &quot;nginx yum v1&quot; -c &quot;EXPOSE 80 443&quot; nginx_centos centos8-nginx:1.16.1.v1</span></span><br><span class="line">sha256:049d292d07454f71532acfcaaeffc221bf2e8a2ba1d91f7314c910e33cd493f1</span><br><span class="line"></span><br><span class="line">[root@rocky8 /]<span class="comment"># docker images centos8-nginx:1.16.1.v1</span></span><br><span class="line">REPOSITORY      TAG         IMAGE ID       CREATED          SIZE</span><br><span class="line">centos8-nginx   1.16.1.v1   049d292d0745   16 seconds ago   348MB</span><br></pre></td></tr></table></figure>

<h4 id="从制作的镜像启动容器"><a href="#从制作的镜像启动容器" class="headerlink" title="从制作的镜像启动容器"></a>从制作的镜像启动容器</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@rocky8 /]<span class="comment"># docker run -d -p 8080:80 --name nginx_centos centos8-nginx:1.16.1.v1 /usr/sbin/nginx</span></span><br><span class="line">c0c74b99406df23273a79838db9360c76c874740feb497eda8bf1cc92d59b430</span><br><span class="line"></span><br><span class="line">[root@rocky8 /]<span class="comment"># docker ps</span></span><br><span class="line">CONTAINER ID   IMAGE                     COMMAND             CREATED         STATUS         PORTS                                            NAMES</span><br><span class="line">c0c74b99406d   centos8-nginx:1.16.1.v1   <span class="string">&quot;/usr/sbin/nginx&quot;</span>   5 seconds ago   Up 4 seconds   443/tcp, 0.0.0.0:8080-&gt;80/tcp, :::8080-&gt;80/tcp   nginx_centos</span><br></pre></td></tr></table></figure>

<h4 id="访问测试镜像"><a href="#访问测试镜像" class="headerlink" title="访问测试镜像"></a>访问测试镜像</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@rocky8 /]<span class="comment"># curl 127.0.0.1:8080</span></span><br><span class="line">Nginx Page <span class="keyword">in</span> Docker</span><br></pre></td></tr></table></figure>

<h3 id="实战案例-基于CentOS-基础镜像手动制作编译版本-nginx-镜像"><a href="#实战案例-基于CentOS-基础镜像手动制作编译版本-nginx-镜像" class="headerlink" title="实战案例: 基于CentOS 基础镜像手动制作编译版本 nginx 镜像"></a>实战案例: 基于CentOS 基础镜像手动制作编译版本 nginx 镜像</h3><p>在CentOS 基础镜像的容器之上手动编译安装nginx，然后再将此容器提交为镜像</p>
<h4 id="下载镜像并初始化系统"><a href="#下载镜像并初始化系统" class="headerlink" title="下载镜像并初始化系统"></a>下载镜像并初始化系统</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[root@rocky8 ~]<span class="comment"># docker run -it centos /bin/bash</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#生成yum源配置</span></span><br><span class="line">[root@d4641b86e4d3 /]<span class="comment"># rm -rf /etc/yum.repos.d/*</span></span><br><span class="line">[root@d4641b86e4d3 /]<span class="comment"># curl -o /etc/yum.repos.d/CentOS-Base.repo https://mirrors.aliyun.com/repo/Centos-vault-8.5.2111.repo</span></span><br><span class="line">  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current</span><br><span class="line">                                 Dload  Upload   Total   Spent    Left  Speed</span><br><span class="line">100  2495  100  2495    0     0   6911      0 --:--:-- --:--:-- --:--:--  6911</span><br><span class="line"></span><br><span class="line">[root@d4641b86e4d3 /]<span class="comment"># yum install wget -y</span></span><br></pre></td></tr></table></figure>

<h4 id="编译安装-nginx"><a href="#编译安装-nginx" class="headerlink" title="编译安装 nginx"></a>编译安装 nginx</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root@d4641b86e4d3 /]<span class="comment"># useradd -r -s /sbin/nologin nginx</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#安装基础包</span></span><br><span class="line">[root@d4641b86e4d3 /]<span class="comment"># yum install -y gcc gcc-c++ automake pcre pcre-devel zlib zlib-devel openssl openssl-devel make</span></span><br><span class="line"></span><br><span class="line">[root@d4641b86e4d3 src]<span class="comment"># wget https://nginx.org/download/nginx-1.26.3.tar.gz</span></span><br><span class="line">[root@d4641b86e4d3 src]<span class="comment"># tar xf nginx-1.26.3.tar.gz </span></span><br><span class="line">[root@d4641b86e4d3 src]<span class="comment"># cd nginx-1.26.3</span></span><br><span class="line">[root@d4641b86e4d3 nginx-1.26.3]<span class="comment"># ./configure --prefix=/apps/nginx</span></span><br><span class="line">[root@d4641b86e4d3 nginx-1.26.3]<span class="comment"># make &amp;&amp; make install</span></span><br><span class="line">[root@d4641b86e4d3 nginx-1.26.3]<span class="comment"># rm -rf /var/cache/dnf/*</span></span><br></pre></td></tr></table></figure>

<h4 id="关闭-nginx-后台运行"><a href="#关闭-nginx-后台运行" class="headerlink" title="关闭 nginx 后台运行"></a>关闭 nginx 后台运行</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@d4641b86e4d3 nginx-1.26.3]<span class="comment"># cd /apps/nginx/conf/</span></span><br><span class="line">[root@d4641b86e4d3 conf]<span class="comment"># vi nginx.conf</span></span><br><span class="line">user  nginx;</span><br><span class="line">daemon off;</span><br><span class="line"></span><br><span class="line">[root@d4641b86e4d3 conf]<span class="comment"># ln -s /apps/nginx/sbin/nginx /usr/sbin/</span></span><br><span class="line">[root@d4641b86e4d3 conf]<span class="comment"># ls -l /usr/sbin/nginx </span></span><br><span class="line">lrwxrwxrwx 1 root root 22 Apr  9 02:24 /usr/sbin/nginx -&gt; /apps/nginx/sbin/nginx</span><br></pre></td></tr></table></figure>

<h4 id="准备相关数据自定义web界面"><a href="#准备相关数据自定义web界面" class="headerlink" title="准备相关数据自定义web界面"></a>准备相关数据自定义web界面</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@d4641b86e4d3 conf]<span class="comment"># echo &quot;Nginx Test Page in Docker&quot; &gt; /apps/nginx/html/index.html</span></span><br></pre></td></tr></table></figure>

<h4 id="提交为镜像-2"><a href="#提交为镜像-2" class="headerlink" title="提交为镜像"></a>提交为镜像</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#不要退出容器，在另一个终端窗口执行以下命令</span></span><br><span class="line">[root@rocky8 /]<span class="comment"># docker commit -c &quot;CMD nginx&quot; d4641b86e4d3 centos8-nginx:1.26.3</span></span><br><span class="line">sha256:a5f1a17e45cfbd889a1db5d1924f49bafa0d4d8dcdbdab627c18dc8c53004b67</span><br><span class="line"></span><br><span class="line">[root@rocky8 /]<span class="comment"># docker images centos8-nginx:1.26.3</span></span><br><span class="line">REPOSITORY      TAG       IMAGE ID       CREATED          SIZE</span><br><span class="line">centos8-nginx   1.26.3    a5f1a17e45cf   11 seconds ago   530MB</span><br></pre></td></tr></table></figure>

<h4 id="从自己的镜像启动容器"><a href="#从自己的镜像启动容器" class="headerlink" title="从自己的镜像启动容器"></a>从自己的镜像启动容器</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@rocky8 /]<span class="comment"># docker run -d -p 80:80 centos8-nginx:1.26.3 nginx</span></span><br><span class="line">f07cbcf3fdfb0638520fcc30bdf79d9f8e3f9b0ab993b5839c85dd82b7058118</span><br><span class="line"></span><br><span class="line">[root@rocky8 /]<span class="comment"># docker ps -l</span></span><br><span class="line">CONTAINER ID   IMAGE                  COMMAND   CREATED         STATUS         PORTS                               NAMES</span><br><span class="line">f07cbcf3fdfb   centos8-nginx:1.26.3   <span class="string">&quot;nginx&quot;</span>   5 seconds ago   Up 4 seconds   0.0.0.0:80-&gt;80/tcp, :::80-&gt;80/tcp   optimistic_cori</span><br></pre></td></tr></table></figure>

<p>备注: 最后面的nginx是运行的命令，即镜像里面要运行一个nginx命令，所以前面软链接到/usr/sbin/nginx，目的为了让系统不需要指定路径就可以执行此命令</p>
<h4 id="访问测试-1"><a href="#访问测试-1" class="headerlink" title="访问测试"></a>访问测试</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@rocky8 /]<span class="comment"># curl 127.0.0.1</span></span><br><span class="line">Nginx Test Page <span class="keyword">in</span> Docker</span><br></pre></td></tr></table></figure>

<h4 id="查看Nginx访问日志和进程"><a href="#查看Nginx访问日志和进程" class="headerlink" title="查看Nginx访问日志和进程"></a>查看Nginx访问日志和进程</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">[root@rocky8 /]<span class="comment"># docker exec -it f07cbcf3fdfb bash</span></span><br><span class="line">[root@f07cbcf3fdfb /]<span class="comment"># cat /apps/nginx/logs/access.log </span></span><br><span class="line">172.17.0.1 - - [09/Apr/2025:02:32:39 +0000] <span class="string">&quot;GET / HTTP/1.1&quot;</span> 200 25 <span class="string">&quot;-&quot;</span> <span class="string">&quot;curl/7.61.1&quot;</span></span><br><span class="line">172.17.0.1 - - [09/Apr/2025:02:33:16 +0000] <span class="string">&quot;GET / HTTP/1.1&quot;</span> 200 25 <span class="string">&quot;-&quot;</span> <span class="string">&quot;curl/7.61.1&quot;</span></span><br><span class="line">172.17.0.1 - - [09/Apr/2025:02:33:17 +0000] <span class="string">&quot;GET / HTTP/1.1&quot;</span> 200 25 <span class="string">&quot;-&quot;</span> <span class="string">&quot;curl/7.61.1&quot;</span></span><br><span class="line">172.17.0.1 - - [09/Apr/2025:02:33:17 +0000] <span class="string">&quot;GET / HTTP/1.1&quot;</span> 200 25 <span class="string">&quot;-&quot;</span> <span class="string">&quot;curl/7.61.1&quot;</span></span><br><span class="line">172.17.0.1 - - [09/Apr/2025:02:33:18 +0000] <span class="string">&quot;GET / HTTP/1.1&quot;</span> 200 25 <span class="string">&quot;-&quot;</span> <span class="string">&quot;curl/7.61.1&quot;</span></span><br><span class="line">172.17.0.1 - - [09/Apr/2025:02:33:18 +0000] <span class="string">&quot;GET / HTTP/1.1&quot;</span> 200 25 <span class="string">&quot;-&quot;</span> <span class="string">&quot;curl/7.61.1&quot;</span></span><br><span class="line">172.17.0.1 - - [09/Apr/2025:02:33:18 +0000] <span class="string">&quot;GET / HTTP/1.1&quot;</span> 200 25 <span class="string">&quot;-&quot;</span> <span class="string">&quot;curl/7.61.1&quot;</span></span><br><span class="line">172.17.0.1 - - [09/Apr/2025:02:33:19 +0000] <span class="string">&quot;GET / HTTP/1.1&quot;</span> 200 25 <span class="string">&quot;-&quot;</span> <span class="string">&quot;curl/7.61.1&quot;</span></span><br><span class="line"></span><br><span class="line">[root@f07cbcf3fdfb /]<span class="comment"># ps aux</span></span><br><span class="line">USER         PID %CPU %MEM    VSZ   RSS TTY      STAT START   TIME COMMAND</span><br><span class="line">root           1  0.0  0.0  18660  2628 ?        Ss   02:31   0:00 nginx: master proce</span><br><span class="line">nginx          6  0.0  0.0  37408  4280 ?        S    02:31   0:00 nginx: worker proce</span><br><span class="line">root           7  0.1  0.0  15096  3640 pts/0    Ss   02:33   0:00 bash</span><br><span class="line">root          22  0.0  0.0  47596  3764 pts/0    R+   02:33   0:00 ps aux</span><br></pre></td></tr></table></figure>

<h2 id="利用-DockerFile-文件执行-docker-build-自动构建镜像"><a href="#利用-DockerFile-文件执行-docker-build-自动构建镜像" class="headerlink" title="利用 DockerFile 文件执行 docker build 自动构建镜像"></a>利用 DockerFile 文件执行 docker build 自动构建镜像</h2><h3 id="Dockfile-使用详解"><a href="#Dockfile-使用详解" class="headerlink" title="Dockfile 使用详解"></a>Dockfile 使用详解</h3><h4 id="Dockerfile-介绍"><a href="#Dockerfile-介绍" class="headerlink" title="Dockerfile 介绍"></a>Dockerfile 介绍</h4><p>DockerFile 是一种被Docker程序解释执行的脚本，由一条条的命令组成的，每条命令对应linux下面的一条命令，Docker程序将这些DockerFile指令再翻译成真正的linux命令，其有自己的书写方式和支持的命令，Docker程序读取DockerFile并根据指令生成Docker镜像，相比手动制作镜像的方式，DockerFile更能直观的展示镜像是怎么产生的，有了DockerFile，当后期有额外的需求时，只要在之前的DockerFile添加或者修改响应的命令即可重新生成新的Docker镜像，避免了重复手动制作镜像的麻烦,类似与shell脚本一样,可以方便高效的制作镜像</p>
<p>Docker守护程序 Dockerfile 逐一运行指令，如有必要，将每个指令的结果提交到新镜像，然后最终输出新镜像的ID。Docker守护程序将自动清理之前发送的上下文</p>
<p>请注意，每条指令都是独立运行的，并会导致创建新镜像，比如 RUN cd /tmp 对下一条指令不会有任何影响。 </p>
<p>Docker将尽可能重用中间镜像层（缓存），以显著加速 docker build 命令的执行过程，这由 Using cache 控制台输出中的消息指示</p>
<h4 id="Dockerfile-镜像制作和使用流程"><a href="#Dockerfile-镜像制作和使用流程" class="headerlink" title="Dockerfile 镜像制作和使用流程"></a>Dockerfile 镜像制作和使用流程</h4><p><img src="../../../../images/SRE/day46/35.jpg" alt="35"></p>
<h4 id="Dockerfile文件的制作镜像的分层结构"><a href="#Dockerfile文件的制作镜像的分层结构" class="headerlink" title="Dockerfile文件的制作镜像的分层结构"></a>Dockerfile文件的制作镜像的分层结构</h4><p><img src="../../../../images/SRE/day46/36.jpg" alt="36"></p>
<p>范例:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#按照业务类型或系统类型等方式划分创建目录环境，方便后期镜像比较多的时候进行分类</span></span><br><span class="line">[root@rocky8 ~]<span class="comment"># mkdir /data/dockerfile/&#123;web/&#123;nginx,apache,tomcat,jdk&#125;,system/&#123;centos,ubuntu,alpine,debian&#125;&#125; -p</span></span><br><span class="line">[root@rocky8 ~]<span class="comment"># tree /data/dockerfile/</span></span><br><span class="line">/data/dockerfile/</span><br><span class="line">├── system</span><br><span class="line">│   ├── alpine</span><br><span class="line">│   ├── centos</span><br><span class="line">│   ├── debian</span><br><span class="line">│   └── ubuntu</span><br><span class="line">└── web</span><br><span class="line">    ├── apache</span><br><span class="line">    ├── jdk</span><br><span class="line">    ├── nginx</span><br><span class="line">    └── tomcat</span><br><span class="line"></span><br><span class="line">10 directories, 0 files</span><br></pre></td></tr></table></figure>

<h4 id="Dockerfile-文件格式"><a href="#Dockerfile-文件格式" class="headerlink" title="Dockerfile 文件格式"></a>Dockerfile 文件格式</h4><p>Dockerfile 是一个有特定语法格式的文本文件</p>
<p>dockerfile 官方说明: <a target="_blank" rel="noopener" href="https://docs.docker.com/engine/reference/builder/">https://docs.docker.com/engine/reference/builder/</a></p>
<p>帮助: man 5 dockerfile</p>
<p><strong>Dockerfile 文件说明</strong> </p>
<ul>
<li>每一行以Dockerfile的指令开头，指令不区分大小写，但是惯例使用大写 使用</li>
<li># 开始作为注释</li>
<li>每一行只支持一条指令，每条指令可以携带多个参数</li>
<li>指令按文件的顺序从上至下进行执行</li>
<li>每个指令的执行会生成一个新的镜像层，为了减少分层和镜像大小，尽可能将多条指令合并成一条指令</li>
<li>制作镜像一般可能需要反复多次，每次执行dockfile都按顺序执行，从头开始，已经执行过的指令已经缓存，不需要再执行，如果后续有一行新的指令没执行过，其往后的指令将会重新执行，所以为加速镜像制作，将最常变化的内容放下dockerfile的文件的后面</li>
</ul>
<h4 id="Dockerfile-相关指令"><a href="#Dockerfile-相关指令" class="headerlink" title="Dockerfile 相关指令"></a>Dockerfile 相关指令</h4><p>dockerfile 文件中的常见指令:</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">ADD</span><br><span class="line">COPY</span><br><span class="line">ENV</span><br><span class="line">EXPOSE</span><br><span class="line">FROM</span><br><span class="line">LABEL</span><br><span class="line">STOPSIGNAL</span><br><span class="line">USER</span><br><span class="line">VOLUME</span><br><span class="line">WORKDIR</span><br></pre></td></tr></table></figure>

<p><img src="../../../../images/SRE/day46/37.jpg" alt="37"></p>
<h5 id="FROM-指定基础镜像"><a href="#FROM-指定基础镜像" class="headerlink" title="FROM: 指定基础镜像"></a>FROM: 指定基础镜像</h5><p>定制镜像，需要先有一个基础镜像，在这个基础镜像上进行定制。 </p>
<p><strong>FROM</strong> 就是指定基础镜像，此指令通常必需放在Dockerfile文件第一个非注释行。后续的指令都是运行于此基准镜像所提供的运行环境</p>
<p>基础镜像可以是任何可用镜像文件，默认情况下，docker build会在docker主机上查找指定的镜像文件，在其不存在时，则会从Docker Hub Registry上拉取所需的镜像文件.如果找不到指定的镜像文件，docker build会返回一个错误信息</p>
<p><strong>如何选择合适的镜像呢？</strong> </p>
<p>对于不同的软件官方都提供了相关的docker镜像，比如: nginx、redis、mysql、httpd、tomcat等服务类的镜像，也有操作系统类，如: centos、ubuntu、debian等。建议使用官方镜像，比较安全。</p>
<p>格式: </p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> [--platform=&lt;platform&gt;] &lt;image&gt; [AS &lt;name&gt;]</span><br><span class="line"><span class="keyword">FROM</span> [--platform=&lt;platform&gt;] &lt;image&gt;[:&lt;tag&gt;] [AS &lt;name&gt;]</span><br><span class="line"><span class="keyword">FROM</span> [--platform=&lt;platform&gt;] &lt;image&gt;[@&lt;digest&gt;] [AS &lt;name&gt;]</span><br><span class="line"></span><br><span class="line"><span class="comment">#说明:  </span></span><br><span class="line">--platform 指定镜像的平台，比如: linux/amd64, linux/arm64, or windows/amd64</span><br><span class="line">tag 和 digest是可选项，如果不指定，默认为latest</span><br></pre></td></tr></table></figure>

<p><strong>说明: 关于scratch 镜像</strong></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">FROM scratch</span><br><span class="line">参考链接:</span><br><span class="line">https://hub.docker.com/_/scratch?tab=description</span><br><span class="line">https://docs.docker.com/develop/develop-images/baseimages/</span><br><span class="line">该镜像是一个空的镜像，可以用于构建busybox等超小镜像，可以说是真正的从零开始构建属于自己的镜像</span><br><span class="line">该镜像在构建基础镜像（例如debian和busybox）或超最小镜像（仅包含一个二进制文件及其所需内容，例如:hello-world）的上下文中最有用。</span><br></pre></td></tr></table></figure>

<p>范例: </p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> scratch <span class="comment">#所有镜像的起源镜像，相当于Object类</span></span><br><span class="line"><span class="keyword">FROM</span> ubuntu</span><br><span class="line"><span class="keyword">FROM</span> ubuntu:bionic</span><br><span class="line"><span class="keyword">FROM</span> debian:buster-slim</span><br></pre></td></tr></table></figure>

<h5 id="LABEL-指定镜像元数据"><a href="#LABEL-指定镜像元数据" class="headerlink" title="LABEL: 指定镜像元数据"></a>LABEL: 指定镜像元数据</h5><p>可以指定镜像元数据，如: 镜像作者等</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">LABEL &lt;key&gt;=&lt;value&gt; &lt;key&gt;=&lt;value&gt; &lt;key&gt;=&lt;value&gt; ...</span><br></pre></td></tr></table></figure>

<p>范例: </p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">LABEL <span class="string">&quot;com.example.vendor&quot;</span>=<span class="string">&quot;ACME Incorporated&quot;</span></span><br><span class="line">LABEL com.example.label-with-value=<span class="string">&quot;foo&quot;</span></span><br><span class="line">LABEL version=<span class="string">&quot;1.0&quot;</span></span><br><span class="line">LABEL description=<span class="string">&quot;This text illustrates \</span></span><br><span class="line"><span class="string">that label-values can span multiple lines.&quot;</span></span><br></pre></td></tr></table></figure>

<p>一个镜像可以有多个label ,还可以写在一行中,即多标签写法,可以减少镜像的的大小</p>
<p>范例: 多标签写法</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#一行格式</span></span><br><span class="line">LABEL multi.label1=<span class="string">&quot;value1&quot;</span> multi.label2=<span class="string">&quot;value2&quot;</span> other=<span class="string">&quot;value3&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#多行格式</span></span><br><span class="line">LABEL multi.label1=<span class="string">&quot;value1&quot;</span> \</span><br><span class="line">      multi.label2=<span class="string">&quot;value2&quot;</span> \</span><br><span class="line">      other=<span class="string">&quot;value3&quot;</span></span><br></pre></td></tr></table></figure>

<p>docker inspect 命令可以查看LABEL</p>
<p>范例: </p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&quot;Labels&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;com.example.vendor&quot;</span>: <span class="string">&quot;ACME Incorporated&quot;</span></span><br><span class="line">    <span class="string">&quot;com.example.label-with-value&quot;</span>: <span class="string">&quot;foo&quot;</span>,</span><br><span class="line">    <span class="string">&quot;version&quot;</span>: <span class="string">&quot;1.0&quot;</span>,</span><br><span class="line">    <span class="string">&quot;description&quot;</span>: <span class="string">&quot;This text illustrates that label-values can span multiple lines.&quot;</span>,</span><br><span class="line">    <span class="string">&quot;multi.label1&quot;</span>: <span class="string">&quot;value1&quot;</span>,</span><br><span class="line">    <span class="string">&quot;multi.label2&quot;</span>: <span class="string">&quot;value2&quot;</span>,</span><br><span class="line">    <span class="string">&quot;other&quot;</span>: <span class="string">&quot;value3&quot;</span></span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure>

<p>**MAINTAINER: 指定维护者信息 **</p>
<p>此指令已过时，用LABEL代替</p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">MAINTAINER</span> &lt;name&gt;</span><br></pre></td></tr></table></figure>

<p>范例: </p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">MAINTAINER</span> wangxiaochun &lt;root@wangxiaochun.com&gt;</span><br><span class="line"><span class="comment">#用LABEL代替</span></span><br><span class="line"><span class="keyword">LABEL</span><span class="language-bash"> maintainer=<span class="string">&quot;wangxiaochun &lt;root@wangxiaochun.com&gt;&quot;</span></span></span><br></pre></td></tr></table></figure>

<h5 id="RUN-执行-shell命令"><a href="#RUN-执行-shell命令" class="headerlink" title="RUN: 执行 shell命令"></a>RUN: 执行 shell命令</h5><p><strong>RUN</strong> 指令用来在<strong>构建镜像阶段</strong>需要执行 FROM 指定镜像所支持的Shell命令。</p>
<p>通常各种基础镜像一般都支持丰富的shell命令</p>
<p>注意: RUN 可以写多个，每一个RUN指令都会建立一个镜像层，所以尽可能合并成一条指令,比如将多个shell命令通过 &amp;&amp; 连接一起成为在一条指令</p>
<p>每个RUN都是独立运行的,和前一个RUN无关</p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#shell 格式: 相当于 /bin/sh -c &lt;命令&gt; 此种形式支持环境变量</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> &lt;命令&gt; </span></span><br><span class="line"></span><br><span class="line"><span class="comment">#exec 格式: 此种形式不支持环境变量,注意:是双引号,不能是单引号</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> [<span class="string">&quot;executable&quot;</span>,<span class="string">&quot;param1&quot;</span>,<span class="string">&quot;param2&quot;</span>...]</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#exec格式可以指定其它shell</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> [<span class="string">&quot;/bin/bash&quot;</span>,<span class="string">&quot;-c&quot;</span>,<span class="string">&quot;echo hello wang&quot;</span>]</span></span><br></pre></td></tr></table></figure>

<p>说明:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">shell格式中，&lt;<span class="built_in">command</span>&gt;通常是一个shell命令，且以<span class="string">&quot;/bin/sh -c”来运行它，这意味着此进程在容器中的PID不为1，不能接收Unix信号，因此，当使用docker stop &lt;container&gt;命令停止容器时，此进程接收不到SIGTERM信号</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">exec格式中的参数是一个JSON格式的数组，其中&lt;executable&gt;为要运行的命令，后面的&lt;paramN&gt;为传递给命令的选项或参数;然而，此种格式指定的命令不会以&quot;</span>/bin/sh -c<span class="string">&quot;来发起，因此常见的shell操作如变</span></span><br><span class="line"><span class="string">量替换以及通配符(?,*等)替换将不会进行;不过，如果要运行的命令依赖于此shell特性的话，可以将其替换为类似下面的格式。</span></span><br><span class="line"><span class="string">RUN [&quot;</span>/bin/bash<span class="string">&quot;, &quot;</span>-c<span class="string">&quot;, &quot;</span>&lt;executable&gt;<span class="string">&quot;, &quot;</span>&lt;param1&gt;<span class="string">&quot;]</span></span><br></pre></td></tr></table></figure>

<p>范例: </p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">RUN</span><span class="language-bash"> <span class="built_in">echo</span> <span class="string">&#x27;&lt;h1&gt;Hello, Docker!&lt;/h1&gt;&#x27;</span> &gt; /usr/share/nginx/html/index.html</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> [<span class="string">&quot;/bin/bash&quot;</span>, <span class="string">&quot;-c&quot;</span>, <span class="string">&quot;echo hello world&quot;</span>]</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> yum -y install epel-release \</span></span><br><span class="line"><span class="language-bash">     &amp;&amp; yum -y install nginx \</span></span><br><span class="line"><span class="language-bash">     &amp;&amp; <span class="built_in">rm</span> -rf /usr/share/nginx/html/*</span></span><br><span class="line">     &amp;&amp; echo <span class="string">&quot;&lt;h1&gt; docker test nginx &lt;/h1&gt;&quot;</span> &gt; /usr/share/nginx/html/index.html</span><br></pre></td></tr></table></figure>

<p>范例: 多个前后RUN 命令独立无关和shell命令不同</p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#world.txt并不存放在/app内</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> <span class="built_in">cd</span> /app</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> <span class="built_in">echo</span> <span class="string">&quot;hello&quot;</span> &gt; world.txt</span></span><br></pre></td></tr></table></figure>

<h5 id="ENV-设置环境变量"><a href="#ENV-设置环境变量" class="headerlink" title="ENV: 设置环境变量"></a>ENV: 设置环境变量</h5><p>ENV 可以定义环境变量和值，会被后续指令(如:ENV,ADD,COPY,RUN等)通过$KEY或${KEY}进行引用，并在容器运行时保持</p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#变量赋值格式1</span></span><br><span class="line"><span class="keyword">ENV</span> &lt;key&gt; &lt;value&gt;   <span class="comment">#此格式只能对一个key赋值,&lt;key&gt;之后的所有内容均会被视作其&lt;value&gt;的组成部分</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#变量赋值格式2</span></span><br><span class="line"><span class="keyword">ENV</span> &lt;key1&gt;=&lt;value1&gt; &lt;key2&gt;=&lt;value2&gt; \  <span class="comment">#此格式可以支持多个key赋值,定义多个变量建议使用,减少镜像层</span></span><br><span class="line">    &lt;key3&gt;=&lt;value3&gt; ...</span><br><span class="line"> </span><br><span class="line"><span class="comment">#如果&lt;value&gt;中包含空格，可以以反斜线\进行转义，也可通过对&lt;value&gt;加引号进行标识;另外，反斜线也可用于续行</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#只使用一次变量</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> &lt;key&gt;=&lt;value&gt; &lt;<span class="built_in">command</span>&gt;</span></span><br><span class="line">    </span><br><span class="line"><span class="comment">#引用变量</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> <span class="variable">$key</span> .....</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#变量支持高级赋值格式</span></span><br><span class="line">$&#123;key:-word&#125;</span><br><span class="line">$&#123;kye:+word&#125;</span><br></pre></td></tr></table></figure>

<p>如果运行容器时如果需要修改变量,可以执行下面通过基于 <code>exec</code> 机制实现</p>
<p>注意: 下面方式只影响容器运行时环境,而不影响构建镜像的过程,即只能覆盖docker run时的环境变量,而不会影响docker build时环境变量的值</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">docker run -e|--<span class="built_in">env</span> &lt;key&gt;=&lt;value&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment">#说明</span></span><br><span class="line">-e, --<span class="built_in">env</span> list   <span class="comment">#Set environment variables</span></span><br><span class="line">    --env-file filename     <span class="comment">#Read in a file of environment variables</span></span><br></pre></td></tr></table></figure>

<p>示例: 两种格式功能相同</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#格式1</span></span><br><span class="line">ENV myName=<span class="string">&quot;John Doe&quot;</span> myDog=Rex\ The\ Dog \</span><br><span class="line">    myCat=fluffy</span><br><span class="line">    </span><br><span class="line"><span class="comment">#格式2</span></span><br><span class="line">ENV myName John Doe</span><br><span class="line">ENV myDog Rex The Dog</span><br><span class="line">ENV myCat fluffy</span><br></pre></td></tr></table></figure>

<p>范例: </p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ENV</span> VERSION=<span class="number">1.0</span> DEBUG=on NAME=<span class="string">&quot;Happy Feet&quot;</span></span><br><span class="line"><span class="keyword">ENV</span> PG_MAJOR <span class="number">9.3</span></span><br><span class="line"><span class="keyword">ENV</span> PG_VERSION <span class="number">9.3</span>.<span class="number">4</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> curl -SL http://example.com/postgres-<span class="variable">$PG_VERSION</span>.tar.xz | tar -xJC /usr/src/postgress &amp;&amp; …</span></span><br><span class="line"><span class="keyword">ENV</span> PATH /usr/local/postgres-$PG_MAJOR/bin:$PATH</span><br></pre></td></tr></table></figure>

<p>范例:</p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line">[root@rocky8 dockerfile]<span class="comment"># cat Dockerfile </span></span><br><span class="line"><span class="keyword">FROM</span> busybox</span><br><span class="line"><span class="keyword">LABEL</span><span class="language-bash"> maintainer=<span class="string">&quot;wsq &lt;wshuaiqing.cn&gt;&quot;</span></span></span><br><span class="line"><span class="keyword">ENV</span> NAME wang shuai qing</span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> <span class="built_in">touch</span> <span class="variable">$NAME</span>.txt</span></span><br><span class="line"></span><br><span class="line">[root@rocky8 dockerfile]<span class="comment"># docker build -t test:v5.0 .</span></span><br><span class="line">[+] Building <span class="number">0.5</span>s (<span class="number">6</span>/<span class="number">6</span>) FINISHED                                       docker:default</span><br><span class="line"> =&gt; [internal] load build definition <span class="keyword">from</span> Dockerfile                             <span class="number">0.0</span>s</span><br><span class="line"> =&gt; =&gt; transferring dockerfile: <span class="number">134</span>B                                             <span class="number">0.0</span>s</span><br><span class="line"> =&gt; [internal] load metadata for docker.io/library/busybox:latest                <span class="number">0.0</span>s</span><br><span class="line"> =&gt; [internal] load .dockerignore                                                <span class="number">0.0</span>s</span><br><span class="line"> =&gt; =&gt; transferring context: <span class="number">2</span>B                                                  <span class="number">0.0</span>s</span><br><span class="line"> =&gt; [<span class="number">1</span>/<span class="number">2</span>] <span class="keyword">FROM</span> docker.io/library/busybox:latest                                  <span class="number">0.0</span>s</span><br><span class="line"> =&gt; [<span class="number">2</span>/<span class="number">2</span>] <span class="keyword">RUN</span><span class="language-bash"> <span class="built_in">touch</span> wang shuai qing.txt                                          0.4s</span></span><br><span class="line"> =&gt; exporting to image                                                           <span class="number">0.0</span>s</span><br><span class="line"> =&gt; =&gt; exporting layers                                                          <span class="number">0.0</span>s</span><br><span class="line"> =&gt; =&gt; writing image sha256:<span class="number">554</span>ed570553dad4f1bff217c761345377f7429e6c0d190c5bd1  <span class="number">0.0</span>s</span><br><span class="line"> =&gt; =&gt; naming to docker.io/library/test:v5.<span class="number">0</span> </span><br><span class="line"> </span><br><span class="line">[root@rocky8 dockerfile]<span class="comment"># docker run --rm --name c1 test:v5.0 env</span></span><br><span class="line">PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin</span><br><span class="line">HOSTNAME=<span class="number">35</span>ad9638af4a</span><br><span class="line">NAME=wang shuai qing</span><br><span class="line">HOME=/root</span><br><span class="line"></span><br><span class="line">[root@rocky8 dockerfile]<span class="comment"># docker run --rm -e NAME=mage --name c1 test:v5.0 env</span></span><br><span class="line">PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin</span><br><span class="line">HOSTNAME=<span class="number">1</span>e2a1905450e</span><br><span class="line">NAME=mage</span><br><span class="line">HOME=/root</span><br><span class="line"></span><br><span class="line">[root@rocky8 dockerfile]<span class="comment"># docker run --rm -e NAME=mage --name c1 test:v5.0 ls -l</span></span><br><span class="line">total <span class="number">20</span></span><br><span class="line">drwxr-xr-x    <span class="number">2</span> root     root         <span class="number">12288</span> Sep <span class="number">26</span>  <span class="number">2024</span> bin</span><br><span class="line">drwxr-xr-x    <span class="number">5</span> root     root           <span class="number">340</span> Apr  <span class="number">9</span> <span class="number">03</span>:<span class="number">22</span> dev</span><br><span class="line">drwxr-xr-x    <span class="number">1</span> root     root            <span class="number">66</span> Apr  <span class="number">9</span> <span class="number">03</span>:<span class="number">22</span> etc</span><br><span class="line">drwxr-xr-x    <span class="number">2</span> nobody   nobody           <span class="number">6</span> Sep <span class="number">26</span>  <span class="number">2024</span> home</span><br><span class="line">drwxr-xr-x    <span class="number">2</span> root     root          <span class="number">4096</span> Sep <span class="number">26</span>  <span class="number">2024</span> lib</span><br><span class="line">lrwxrwxrwx    <span class="number">1</span> root     root             <span class="number">3</span> Sep <span class="number">26</span>  <span class="number">2024</span> lib64 -&gt; lib</span><br><span class="line">dr-xr-xr-x  <span class="number">206</span> root     root             <span class="number">0</span> Apr  <span class="number">9</span> <span class="number">03</span>:<span class="number">22</span> proc</span><br><span class="line">-rw-r--r--    <span class="number">1</span> root     root             <span class="number">0</span> Apr  <span class="number">9</span> <span class="number">03</span>:<span class="number">20</span> qing.txt</span><br><span class="line">drwx------    <span class="number">2</span> root     root             <span class="number">6</span> Sep <span class="number">26</span>  <span class="number">2024</span> root</span><br><span class="line">-rw-r--r--    <span class="number">1</span> root     root             <span class="number">0</span> Apr  <span class="number">9</span> <span class="number">03</span>:<span class="number">20</span> shuai</span><br><span class="line">dr-xr-xr-x   <span class="number">13</span> root     root             <span class="number">0</span> Apr  <span class="number">9</span> <span class="number">03</span>:<span class="number">22</span> sys</span><br><span class="line">drwxrwxrwt    <span class="number">2</span> root     root             <span class="number">6</span> Sep <span class="number">26</span>  <span class="number">2024</span> tmp</span><br><span class="line">drwxr-xr-x    <span class="number">4</span> root     root            <span class="number">29</span> Sep <span class="number">26</span>  <span class="number">2024</span> usr</span><br><span class="line">drwxr-xr-x    <span class="number">4</span> root     root            <span class="number">30</span> Sep <span class="number">26</span>  <span class="number">2024</span> var</span><br><span class="line">-rw-r--r--    <span class="number">1</span> root     root             <span class="number">0</span> Apr  <span class="number">9</span> <span class="number">03</span>:<span class="number">20</span> wang</span><br><span class="line"></span><br><span class="line">[root@rocky8 dockerfile]<span class="comment"># docker run --rm --env-file env.txt --name c1 test:v5.0 env</span></span><br><span class="line">PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin</span><br><span class="line">HOSTNAME=<span class="number">64</span>cbb34a5896</span><br><span class="line">NAME=wang</span><br><span class="line">TITLE=cto</span><br><span class="line">HOME=/root</span><br></pre></td></tr></table></figure>

<h5 id="COPY-复制文本"><a href="#COPY-复制文本" class="headerlink" title="COPY: 复制文本"></a>COPY: 复制文本</h5><p>复制本地宿主机的到容器中的 。</p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">COPY</span><span class="language-bash"> [--<span class="built_in">chown</span>=&lt;user&gt;:&lt;group&gt;] &lt;src&gt;... &lt;dest&gt;</span></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> [--<span class="built_in">chown</span>=&lt;user&gt;:&lt;group&gt;] [<span class="string">&quot;&lt;src&gt;&quot;</span>,... <span class="string">&quot;&lt;dest&gt;&quot;</span>] <span class="comment">#路径中有空白字符时,建议使用此格式</span></span></span><br></pre></td></tr></table></figure>

<p>说明: </p>
<ul>
<li><p>可以是多个,可以使用通配符，通配符规则满足Go的filepath.Match 规则</p>
<p>filepath.Match 参考链接: <a target="_blank" rel="noopener" href="https://golang.org/pkg/path/filepath/#Match">https://golang.org/pkg/path/filepath/#Match</a></p>
</li>
<li><p>必须是build上下文中的路径(为 Dockerfile 所在目录的相对路径），<strong>不能是其父目录中的文件</strong></p>
</li>
<li><p>如果是目录，则其内部文件或子目录会被递归复制，<strong>但目录自身不会被复制</strong></p>
</li>
<li><p>如果指定了多个, 或在中使用了通配符，则必须是一个目 录，<strong>且必须以 / 结尾</strong></p>
</li>
<li><p>可以是绝对路径或者是 WORKDIR 指定的相对路径</p>
</li>
<li><p>使用 COPY 指令，源文件的各种元数据都会保留。比如读、写、执行权限、文件变更时间等</p>
</li>
<li><p>如果事先不存在，它将会被自动创建，这包括其父目录路径,即递归创建目录</p>
</li>
</ul>
<p>范例: </p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">COPY</span><span class="language-bash"> hom* /mydir/    </span></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> hom?.txt /mydir/</span></span><br></pre></td></tr></table></figure>

<h5 id="ADD-复制和解包文件"><a href="#ADD-复制和解包文件" class="headerlink" title="ADD: 复制和解包文件"></a>ADD: 复制和解包文件</h5><p>该命令可认为是增强版的COPY，不仅支持COPY，还支持自动解压缩。可以将复制指定的 到容器中的</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ADD [--<span class="built_in">chown</span>=&lt;user&gt;:&lt;group&gt;] &lt;src&gt;... &lt;dest&gt;</span><br><span class="line">ADD [--<span class="built_in">chown</span>=&lt;user&gt;:&lt;group&gt;] [<span class="string">&quot;&lt;src&gt;&quot;</span>,... <span class="string">&quot;&lt;dest&gt;&quot;</span>]</span><br></pre></td></tr></table></figure>

<p>说明: </p>
<ul>
<li>可以是Dockerfile所在目录的一个相对路径；也可是一个 URL；还可是一个 tar 文件（自动解压）</li>
<li>可以是绝对路径或者是 WORKDIR 指定的相对路径</li>
<li>如果是目录，只复制目录中的内容，而非目录本身</li>
<li>如果是一个 URL ，下载后的文件权限自动设置为 600</li>
<li>如果为URL且不以/结尾，则指定的文件将被下载并直接被创建为,如果以 / 结尾，则文件名URL指定的文件将被直接下载并保存为/&lt; filename&gt;</li>
<li>如果是一个本地文件系统上的打包文件,如: gz, bz2 ,xz ，它将被解包 ，其行为类似于”tar -x”命令,但是通过URL获取到的tar文件将不会自动展开</li>
<li>如果有多个，或其间接或直接使用了通配符，则必须是一个以/结尾的目录路径;如果不以/结尾，则其被视作一个普通文件，的内容将被直接写入到</li>
</ul>
<p>范例: </p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ADD</span><span class="language-bash"> <span class="built_in">test</span> relativeDir/          <span class="comment"># adds &quot;test&quot; to `WORKDIR`/relativeDir/</span></span></span><br><span class="line"><span class="keyword">ADD</span><span class="language-bash"> <span class="built_in">test</span> /absoluteDir/         <span class="comment"># adds &quot;test&quot; to /absoluteDir/</span></span></span><br><span class="line"><span class="keyword">ADD</span><span class="language-bash"> --<span class="built_in">chown</span>=55:mygroup files* /somedir/</span></span><br><span class="line"><span class="keyword">ADD</span><span class="language-bash"> --<span class="built_in">chown</span>=bin files* /somedir/</span></span><br><span class="line"><span class="keyword">ADD</span><span class="language-bash"> --<span class="built_in">chown</span>=1 files* /somedir/</span></span><br><span class="line"><span class="keyword">ADD</span><span class="language-bash"> --<span class="built_in">chown</span>=10:11 files* /somedir/</span></span><br><span class="line"><span class="keyword">ADD</span><span class="language-bash"> ubuntu-xenial-core-cloudimg-amd64-root.tar.gz /</span></span><br></pre></td></tr></table></figure>

<h5 id="CMD-容器启动命令"><a href="#CMD-容器启动命令" class="headerlink" title="CMD: 容器启动命令"></a>CMD: 容器启动命令</h5><p><img src="../../../../images/SRE/day46/38.jpg" alt="38"></p>
<p>一个容器中需要持续运行的进程一般只有一个,CMD 用来指定启动容器时默认执行的一个命令，且其运行结束后,容器也会停止,所以一般CMD 指定的命令为持续运行且为前台命令.</p>
<ul>
<li>如果docker run没有指定任何的执行命令或者dockerfile里面也没有ENTRYPOINT命令，那么开启容器时就会使用执行CMD指定的默认的命令</li>
<li>前面介绍过的 RUN 命令是在构建镜像时执行的命令,注意二者的不同之处</li>
<li>每个 Dockerfile 只能有一条 CMD 命令。如指定了多条，只有最后一条被执行</li>
<li>如果用户启动容器时用 docker run xxx 指定运行的命令，则会覆盖 CMD 指定的命令</li>
</ul>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 使用 exec 执行，推荐方式，第一个参数必须是命令的全路径,此种形式不支持环境变量</span></span><br><span class="line"><span class="keyword">CMD</span><span class="language-bash"> [<span class="string">&quot;executable&quot;</span>,<span class="string">&quot;param1&quot;</span>,<span class="string">&quot;param2&quot;</span>] </span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 在 /bin/sh 中执行，提供给需要交互的应用；此种形式支持环境变量</span></span><br><span class="line"><span class="keyword">CMD</span><span class="language-bash"> <span class="built_in">command</span> param1 param2 </span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 提供给 ENTRYPOINT 命令的默认参数</span></span><br><span class="line"><span class="keyword">CMD</span><span class="language-bash"> [<span class="string">&quot;param1&quot;</span>,<span class="string">&quot;param2&quot;</span>] </span></span><br></pre></td></tr></table></figure>

<p>范例: </p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CMD</span><span class="language-bash"> [<span class="string">&quot;nginx&quot;</span>, <span class="string">&quot;-g&quot;</span>, <span class="string">&quot;daemon off;&quot;</span>]</span></span><br></pre></td></tr></table></figure>

<p>范例: </p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">[root@rocky8 dockerfile]<span class="comment"># cat Dockerfile </span></span><br><span class="line"><span class="keyword">FROM</span> ubuntu</span><br><span class="line"><span class="keyword">LABEL</span><span class="language-bash"> maintainer=<span class="string">&quot;wsq &lt;wshuaiqing.cn&gt;&quot;</span></span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> apt update \</span></span><br><span class="line"><span class="language-bash">&amp;&amp; apt -y install curl \</span></span><br><span class="line"><span class="language-bash">&amp;&amp; <span class="built_in">rm</span> -rf /var/lib/apt/lists/*</span></span><br><span class="line"><span class="keyword">CMD</span><span class="language-bash"> [<span class="string">&quot;curl&quot;</span>,<span class="string">&quot;-s&quot;</span>,<span class="string">&quot;https://cip.cc&quot;</span>]</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@rocky8 dockerfile]<span class="comment">#  docker build -t test:v1.0 .</span></span><br><span class="line">[+] Building <span class="number">0.1</span>s (<span class="number">6</span>/<span class="number">6</span>) FINISHED                                       docker:default</span><br><span class="line"> =&gt; [internal] load build definition <span class="keyword">from</span> Dockerfile                             <span class="number">0.0</span>s</span><br><span class="line"> =&gt; =&gt; transferring dockerfile: <span class="number">198</span>B                                             <span class="number">0.0</span>s</span><br><span class="line"> =&gt; [internal] load metadata for docker.io/library/ubuntu:latest                 <span class="number">0.0</span>s</span><br><span class="line"> =&gt; [internal] load .dockerignore                                                <span class="number">0.0</span>s</span><br><span class="line"> =&gt; =&gt; transferring context: <span class="number">2</span>B                                                  <span class="number">0.0</span>s</span><br><span class="line"> =&gt; [<span class="number">1</span>/<span class="number">2</span>] <span class="keyword">FROM</span> docker.io/library/ubuntu:latest                                   <span class="number">0.0</span>s</span><br><span class="line"> =&gt; CACHED [<span class="number">2</span>/<span class="number">2</span>] <span class="keyword">RUN</span><span class="language-bash"> apt update &amp;&amp; apt -y install curl &amp;&amp; <span class="built_in">rm</span> -rf /var/lib/apt/l  0.0s</span></span><br><span class="line"> =&gt; exporting to image                                                           <span class="number">0.0</span>s</span><br><span class="line"> =&gt; =&gt; exporting layers                                                          <span class="number">0.0</span>s</span><br><span class="line"> =&gt; =&gt; writing image sha256:aedaa0715b9ce6ad6b981ff182c3b883358fc9fc5ec7a728674  <span class="number">0.0</span>s</span><br><span class="line"> =&gt; =&gt; naming to docker.io/library/test:v1.<span class="number">0</span> </span><br><span class="line"> </span><br><span class="line">[root@rocky8 dockerfile]<span class="comment"># docker run test:v1.0 </span></span><br><span class="line">IP	: <span class="number">106.34</span>.<span class="number">172.94</span></span><br><span class="line">地址	: 中国 河南</span><br><span class="line">运营商	: 电信</span><br><span class="line"></span><br><span class="line">数据二	: 中国河南郑州 | 电信</span><br><span class="line"></span><br><span class="line">数据三	: 中国河南省郑州市 | 电信</span><br><span class="line"></span><br><span class="line">URL	: http://www.cip.cc/<span class="number">106.34</span>.<span class="number">172.94</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#cat /etc/etc/issue覆盖了curl命令</span></span><br><span class="line">[root@rocky8 dockerfile]<span class="comment"># docker run test:v1.0 cat /etc/issue</span></span><br><span class="line">Ubuntu <span class="number">24.04</span>.<span class="number">1</span> LTS \n \l</span><br></pre></td></tr></table></figure>

<p>范例: </p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">[root@rocky8 dockerfile]<span class="comment"># cat Dockerfile </span></span><br><span class="line"><span class="keyword">FROM</span> busybox</span><br><span class="line"><span class="keyword">LABEL</span><span class="language-bash"> maintainer=<span class="string">&quot;wsq &lt;wshuaiqing.cn&gt;&quot;</span></span></span><br><span class="line"><span class="keyword">ENV</span> ROOT /data/website</span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> index.html <span class="variable">$&#123;ROOT&#125;</span>/index.html</span></span><br><span class="line"><span class="keyword">CMD</span><span class="language-bash"> /bin/httpd -f -h <span class="variable">$&#123;ROOT&#125;</span></span></span><br><span class="line"><span class="keyword">EXPOSE</span> <span class="number">80</span></span><br><span class="line"></span><br><span class="line">[root@rocky8 dockerfile]<span class="comment"># cat index.html </span></span><br><span class="line">website in Dockerfile</span><br><span class="line"></span><br><span class="line">[root@rocky8 dockerfile]<span class="comment"># docker build -t test:v2.0 .</span></span><br><span class="line">[+] Building <span class="number">0.1</span>s (<span class="number">7</span>/<span class="number">7</span>) FINISHED                                       docker:default</span><br><span class="line"> =&gt; [internal] load build definition <span class="keyword">from</span> Dockerfile                             <span class="number">0.0</span>s</span><br><span class="line"> =&gt; =&gt; transferring dockerfile: <span class="number">188</span>B                                             <span class="number">0.0</span>s</span><br><span class="line"> =&gt; [internal] load metadata for docker.io/library/busybox:latest                <span class="number">0.0</span>s</span><br><span class="line"> =&gt; [internal] load .dockerignore                                                <span class="number">0.0</span>s</span><br><span class="line"> =&gt; =&gt; transferring context: <span class="number">2</span>B                                                  <span class="number">0.0</span>s</span><br><span class="line"> =&gt; [internal] load build context                                                <span class="number">0.0</span>s</span><br><span class="line"> =&gt; =&gt; transferring context: <span class="number">59</span>B                                                 <span class="number">0.0</span>s</span><br><span class="line"> =&gt; CACHED [<span class="number">1</span>/<span class="number">2</span>] <span class="keyword">FROM</span> docker.io/library/busybox:latest                           <span class="number">0.0</span>s</span><br><span class="line"> =&gt; [<span class="number">2</span>/<span class="number">2</span>] <span class="keyword">COPY</span><span class="language-bash"> index.html /data/website/index.html                               0.0s</span></span><br><span class="line"> =&gt; exporting to image                                                           <span class="number">0.0</span>s</span><br><span class="line"> =&gt; =&gt; exporting layers                                                          <span class="number">0.0</span>s</span><br><span class="line"> =&gt; =&gt; writing image sha256:e6cebb60862b142410c25e440e656b56bd111743938ecf50fd4  <span class="number">0.0</span>s</span><br><span class="line"> =&gt; =&gt; naming to docker.io/library/test:v2.<span class="number">0</span>  </span><br><span class="line"> </span><br><span class="line">[root@rocky8 dockerfile]<span class="comment"># docker run -d --rm -P --name c1 test:v2.0 </span></span><br><span class="line">fbcc56f0dd2e93c7667d01773708c272913cab3d72dfd954e6dbdb150d007edc</span><br><span class="line"></span><br><span class="line">[root@rocky8 dockerfile]<span class="comment"># docker port c1 </span></span><br><span class="line"><span class="number">80</span>/tcp -&gt; <span class="number">0.0</span>.<span class="number">0.0</span>:<span class="number">32773</span></span><br><span class="line"><span class="number">80</span>/tcp -&gt; [::]:<span class="number">32773</span></span><br><span class="line"></span><br><span class="line">[root@rocky8 dockerfile]<span class="comment"># curl 127.0.0.1:32773</span></span><br><span class="line">website in Dockerfile</span><br></pre></td></tr></table></figure>

<p>范例: </p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">[root@rocky8 dockerfile]<span class="comment"># cat Dockerfile </span></span><br><span class="line"><span class="keyword">FROM</span> busybox</span><br><span class="line"><span class="keyword">LABEL</span><span class="language-bash"> maintainer=<span class="string">&quot;wsq &lt;wshuaiqing.cn&gt;&quot;</span></span></span><br><span class="line"><span class="keyword">ENV</span> ROOT /data/website</span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> <span class="built_in">mkdir</span> -p <span class="variable">$&#123;ROOT&#125;</span> &amp;&amp; <span class="built_in">echo</span> <span class="string">&#x27;&lt;h1&gt;Busybox httpd server in Dockerfile&lt;/h1&gt;&#x27;</span> &gt; <span class="variable">$&#123;ROOT&#125;</span>/index.html</span></span><br><span class="line"><span class="keyword">CMD</span><span class="language-bash"> [ <span class="string">&quot;/bin/sh&quot;</span>, <span class="string">&quot;-c&quot;</span>, <span class="string">&quot;/bin/httpd -f -h <span class="variable">$&#123;ROOT&#125;</span>&quot;</span> ]</span></span><br><span class="line"><span class="keyword">EXPOSE</span> <span class="number">80</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@rocky8 dockerfile]<span class="comment"># docker build -t test:v3.0 .</span></span><br><span class="line">[+] Building <span class="number">0.4</span>s (<span class="number">6</span>/<span class="number">6</span>) FINISHED                                       docker:default</span><br><span class="line"> =&gt; [internal] load build definition <span class="keyword">from</span> Dockerfile                             <span class="number">0.0</span>s</span><br><span class="line"> =&gt; =&gt; transferring dockerfile: <span class="number">272</span>B                                             <span class="number">0.0</span>s</span><br><span class="line"> =&gt; [internal] load metadata for docker.io/library/busybox:latest                <span class="number">0.0</span>s</span><br><span class="line"> =&gt; [internal] load .dockerignore                                                <span class="number">0.0</span>s</span><br><span class="line"> =&gt; =&gt; transferring context: <span class="number">2</span>B                                                  <span class="number">0.0</span>s</span><br><span class="line"> =&gt; CACHED [<span class="number">1</span>/<span class="number">2</span>] <span class="keyword">FROM</span> docker.io/library/busybox:latest                           <span class="number">0.0</span>s</span><br><span class="line"> =&gt; [<span class="number">2</span>/<span class="number">2</span>] <span class="keyword">RUN</span><span class="language-bash"> <span class="built_in">mkdir</span> -p /data/website &amp;&amp; <span class="built_in">echo</span> <span class="string">&#x27;&lt;h1&gt;Busybox httpd server in Docke  0.4s</span></span></span><br><span class="line"> =&gt; exporting to image                                                           <span class="number">0.0</span>s</span><br><span class="line"> =&gt; =&gt; exporting layers                                                          <span class="number">0.0</span>s</span><br><span class="line"> =&gt; =&gt; writing image sha256:<span class="number">95</span>db5b4e1a69931ca64d07064224183cfa85f5114057fb0be49  <span class="number">0.0</span>s</span><br><span class="line"> =&gt; =&gt; naming to docker.io/library/test:v3.<span class="number">0</span> </span><br><span class="line"> </span><br><span class="line"></span><br><span class="line">[root@rocky8 dockerfile]<span class="comment"># docker run -d --rm -P --name c3 test:v3.0 </span></span><br><span class="line"><span class="number">0</span>edfa6ceb89bb92b8c4e078ed6e9d0e02c7be995742744ca8f13d832d391dd22</span><br><span class="line"></span><br><span class="line">[root@rocky8 dockerfile]<span class="comment"># docker port c3</span></span><br><span class="line"><span class="number">80</span>/tcp -&gt; <span class="number">0.0</span>.<span class="number">0.0</span>:<span class="number">32774</span></span><br><span class="line"><span class="number">80</span>/tcp -&gt; [::]:<span class="number">32774</span></span><br><span class="line"></span><br><span class="line">[root@rocky8 dockerfile]<span class="comment"># curl 127.0.0.1:32774</span></span><br><span class="line">&lt;h1&gt;Busybox httpd server in Dockerfile&lt;/h1&gt;</span><br><span class="line"></span><br><span class="line">[root@rocky8 dockerfile]<span class="comment"># docker inspect -f &quot;&#123;&#123;.Config&#125;&#125;&quot; test:v3.0 </span></span><br><span class="line">&#123;   false false false map[<span class="number">80</span>/tcp:&#123;&#125;] false false false [PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin ROOT=/data/website] [/bin/sh -c /bin/httpd -f -h $&#123;ROOT&#125;] &lt;nil&gt; true  map[]  [] false  [] map[<span class="keyword">maintainer</span>:wsq &lt;wshuaiqing.cn&gt;]  &lt;nil&gt; []&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#查看进程关系</span></span><br><span class="line">[root@rocky8 dockerfile]<span class="comment"># docker exec -it c3 sh</span></span><br><span class="line">/ <span class="comment"># ps</span></span><br><span class="line">PID   <span class="keyword">USER</span>     TIME  COMMAND</span><br><span class="line">    <span class="number">1</span> root      <span class="number">0</span>:<span class="number">00</span> /bin/httpd -f -h /data/website</span><br><span class="line">    <span class="number">8</span> root      <span class="number">0</span>:<span class="number">00</span> sh</span><br><span class="line">   <span class="number">14</span> root      <span class="number">0</span>:<span class="number">00</span> ps</span><br></pre></td></tr></table></figure>

<h5 id="ENTRYPOINT-入口点"><a href="#ENTRYPOINT-入口点" class="headerlink" title="ENTRYPOINT: 入口点"></a>ENTRYPOINT: 入口点</h5><p>功能类似于CMD，配置容器启动后执行的命令及参数</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 使用 exec 执行</span></span><br><span class="line">ENTRYPOINT [<span class="string">&quot;executable&quot;</span>, <span class="string">&quot;param1&quot;</span>, <span class="string">&quot;param2&quot;</span>...]</span><br><span class="line"></span><br><span class="line"><span class="comment"># shell中执行</span></span><br><span class="line">ENTRYPOINT <span class="built_in">command</span> param1 param2</span><br></pre></td></tr></table></figure>

<ul>
<li>ENTRYPOINT 不能被 docker run 提供的参数覆盖，而是追加,即如果docker run 命令有参数，那么参数全部都会作为ENTRYPOINT的参数</li>
<li>如果docker run 后面没有额外参数，但是dockerfile中有CMD命令（即上面CMD的第三种用法），即Dockerfile中即有CMD也有ENTRYPOINT,那么CMD的全部内容会作为ENTRYPOINT的参数</li>
<li>如果docker run 后面有额外参数，同时Dockerfile中即有CMD也有ENTRYPOINT,那么docker run 后面的参数覆盖掉CMD参数内容,最终作为ENTRYPOINT的参数</li>
<li>可以通过docker run –entrypoint string 参数在运行时替换,注意string不要加空格</li>
<li>使用CMD要在运行时重新写命令本身,然后在后面才能追加运行参数，ENTRYPOINT则可以运行时无需重写命令就可以直接接受新参数</li>
<li>每个 Dockerfile 中只能有一个 ENTRYPOINT，当指定多个时，只有最后一个生效</li>
<li>通常会利用ENTRYPOINT指令配合脚本,可以为CMD指令提供环境配置</li>
</ul>
<p>范例:</p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> centos:centos7.<span class="number">9</span>-v10.<span class="number">0</span></span><br><span class="line"><span class="keyword">LABEL</span><span class="language-bash"> maintainer=<span class="string">&quot;wangxiaochun &lt;root@wangxiaochun.com&gt;&quot;</span></span></span><br><span class="line"><span class="keyword">ENV</span> version=<span class="number">1.18</span>.<span class="number">0</span></span><br><span class="line"><span class="keyword">ADD</span><span class="language-bash"> nginx-<span class="variable">$version</span>.tar.gz /usr/local/</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> <span class="built_in">cd</span> /usr/local/nginx-<span class="variable">$version</span> &amp;&amp; ./configure --prefix=/apps/nginx &amp;&amp; make &amp;&amp; </span></span><br><span class="line">make install &amp;&amp; rm -rf /usr/local/nginx* &amp;&amp; sed -i <span class="string">&#x27;s/.*nobody.*/user nginx;/&#x27;</span> </span><br><span class="line">/apps/nginx/conf/nginx.conf &amp;&amp; useradd -r nginx</span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> index.html /apps/nginx/html</span></span><br><span class="line"><span class="keyword">VOLUME</span><span class="language-bash"> [<span class="string">&quot;/apps/nginx/html&quot;</span>]</span></span><br><span class="line"><span class="keyword">EXPOSE</span> <span class="number">80</span> <span class="number">443</span></span><br><span class="line"><span class="keyword">CMD</span><span class="language-bash"> [<span class="string">&quot;-g&quot;</span>,<span class="string">&quot;daemon off;&quot;</span>]</span></span><br><span class="line"><span class="keyword">ENTRYPOINT</span><span class="language-bash"> [<span class="string">&quot;/apps/nginx/sbin/nginx&quot;</span>]</span></span><br><span class="line"><span class="comment">#上面两条指令相当于ENTRYPOINT [&quot;/apps/nginx/sbin/nginx&quot;,&quot;-g&quot;,&quot;daemon off;&quot;]</span></span><br><span class="line"><span class="keyword">HEALTHCHECK</span><span class="language-bash"> --interval=5s --<span class="built_in">timeout</span>=3s CMD curl -fs http://127.0.0.1/</span></span><br></pre></td></tr></table></figure>

<p>范例:</p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@ubuntu1804 ~]<span class="comment">#docker run -it --entrypoint cat alpine /etc/issue</span></span><br><span class="line">Welcome to Alpine Linux <span class="number">3.12</span></span><br><span class="line">Kernel \r on an \m (\l)</span><br></pre></td></tr></table></figure>

<p>范例: </p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line">[root@rocky8 dockerfile]<span class="comment"># cat Dockerfile </span></span><br><span class="line"><span class="keyword">FROM</span> ubuntu</span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> apt update \</span></span><br><span class="line"><span class="language-bash">&amp;&amp; apt -y install curl \</span></span><br><span class="line"><span class="language-bash">&amp;&amp; <span class="built_in">rm</span> -rf /var/lib/apt/lists/*</span></span><br><span class="line"><span class="keyword">ENTRYPOINT</span><span class="language-bash"> [ <span class="string">&quot;curl&quot;</span>, <span class="string">&quot;-s&quot;</span>, <span class="string">&quot;https://cip.cc&quot;</span> ]</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@rocky8 dockerfile]<span class="comment"># docker build -t test:v4.0 .</span></span><br><span class="line">[+] Building <span class="number">0.1</span>s (<span class="number">6</span>/<span class="number">6</span>) FINISHED                                       docker:default</span><br><span class="line"> =&gt; [internal] load build definition <span class="keyword">from</span> Dockerfile                             <span class="number">0.0</span>s</span><br><span class="line"> =&gt; =&gt; transferring dockerfile: <span class="number">170</span>B                                             <span class="number">0.0</span>s</span><br><span class="line"> =&gt; [internal] load metadata for docker.io/library/ubuntu:latest                 <span class="number">0.0</span>s</span><br><span class="line"> =&gt; [internal] load .dockerignore                                                <span class="number">0.0</span>s</span><br><span class="line"> =&gt; =&gt; transferring context: <span class="number">2</span>B                                                  <span class="number">0.0</span>s</span><br><span class="line"> =&gt; [<span class="number">1</span>/<span class="number">2</span>] <span class="keyword">FROM</span> docker.io/library/ubuntu:latest                                   <span class="number">0.0</span>s</span><br><span class="line"> =&gt; CACHED [<span class="number">2</span>/<span class="number">2</span>] <span class="keyword">RUN</span><span class="language-bash"> apt update &amp;&amp; apt -y install curl &amp;&amp; <span class="built_in">rm</span> -rf /var/lib/apt/l  0.0s</span></span><br><span class="line"> =&gt; exporting to image                                                           <span class="number">0.0</span>s</span><br><span class="line"> =&gt; =&gt; exporting layers                                                          <span class="number">0.0</span>s</span><br><span class="line"> =&gt; =&gt; writing image sha256:b750d685d2be39f30f640eb49d55c9faf1d7f628e30161f21e6  <span class="number">0.0</span>s</span><br><span class="line"> =&gt; =&gt; naming to docker.io/library/test:v4.<span class="number">0</span>                                     <span class="number">0.0</span>s</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">[root@rocky8 dockerfile]<span class="comment"># docker run -it --rm test:v4.0 </span></span><br><span class="line">IP	: <span class="number">106.34</span>.<span class="number">172.94</span></span><br><span class="line">地址	: 中国 河南</span><br><span class="line">运营商	: 电信</span><br><span class="line"></span><br><span class="line">数据二	: 中国河南郑州 | 电信</span><br><span class="line"></span><br><span class="line">数据三	: 中国河南省郑州市 | 电信</span><br><span class="line"></span><br><span class="line">URL	: http://www.cip.cc/<span class="number">106.34</span>.<span class="number">172.94</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#追加-i参数</span></span><br><span class="line">[root@rocky8 dockerfile]<span class="comment"># docker run -it --rm test:v4.0 -i</span></span><br><span class="line">HTTP/<span class="number">1.1</span> <span class="number">200</span> OK</span><br><span class="line">Server: openresty</span><br><span class="line">Date: Wed, <span class="number">09</span> Apr <span class="number">2025</span> <span class="number">07</span>:<span class="number">51</span>:<span class="number">32</span> GMT</span><br><span class="line">Content-Type: text/plain; charset=utf-<span class="number">8</span></span><br><span class="line">Content-Length: <span class="number">188</span></span><br><span class="line">Connection: keep-alive</span><br><span class="line">x-content-type-options: nosniff</span><br><span class="line">permissions-policy: interest-cohort=()</span><br><span class="line">x-frame-options: SAMEORIGIN</span><br><span class="line"></span><br><span class="line">IP	: <span class="number">106.34</span>.<span class="number">172.94</span></span><br><span class="line">地址	: 中国 河南</span><br><span class="line">运营商	: 电信</span><br><span class="line"></span><br><span class="line">数据二	: 中国河南郑州 | 电信</span><br><span class="line"></span><br><span class="line">数据三	: 中国河南省郑州市 | 电信</span><br><span class="line"></span><br><span class="line">URL	: http://www.cip.cc/<span class="number">106.34</span>.<span class="number">172.94</span></span><br></pre></td></tr></table></figure>

<p>范例: 利用脚本实现指定环境变量动态生成配置文件内容</p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">[root@rocky8 dockerfile]<span class="comment"># cat entrypoint.sh </span></span><br><span class="line"><span class="comment">#!/bin/bash</span></span><br><span class="line">cat &gt; /etc/nginx/conf.d/www.conf &lt;&lt;EOF</span><br><span class="line">server &#123;</span><br><span class="line">   server_name $&#123;HOSTNAME&#125;;</span><br><span class="line">   listen $&#123;IP:-<span class="number">0.0</span>.<span class="number">0.0</span>&#125;:$&#123;PORT:-<span class="number">80</span>&#125;;</span><br><span class="line">   root   $&#123;DOC_ROOT:-/usr/share/nginx/html&#125;;</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">[root@rocky8 dockerfile]<span class="comment"># cat Dockerfile </span></span><br><span class="line"><span class="keyword">FROM</span> nginx</span><br><span class="line"><span class="keyword">ENV</span> DOC_ROOT=<span class="string">&#x27;/data/website/&#x27;</span></span><br><span class="line"><span class="keyword">ADD</span><span class="language-bash"> index.html <span class="variable">$&#123;DOC_ROOT&#125;</span></span></span><br><span class="line"><span class="keyword">ADD</span><span class="language-bash"> entrypoint.sh /bin/</span></span><br><span class="line"><span class="keyword">EXPOSE</span> <span class="number">80</span>/tcp <span class="number">8080</span></span><br><span class="line"><span class="keyword">CMD</span><span class="language-bash"> [ <span class="string">&quot;/usr/sbin/nginx&quot;</span>, <span class="string">&quot;-g&quot;</span>, <span class="string">&quot;daemon off;&quot;</span> ]  <span class="comment">#CMD指令的内容都成为了ENTRYPOINT的参数</span></span></span><br><span class="line"><span class="keyword">ENTRYPOINT</span><span class="language-bash"> [ <span class="string">&quot;/bin/entrypoint.sh&quot;</span> ]</span></span><br><span class="line"></span><br><span class="line">[root@rocky8 dockerfile]<span class="comment"># chmod +x entrypoint.sh </span></span><br><span class="line">[root@rocky8 dockerfile]<span class="comment"># docker build -t nginx:v1.0 .</span></span><br><span class="line">[root@rocky8 dockerfile]<span class="comment"># docker run --name n1 --rm -P -e &quot;PORT=8080&quot; -e &quot;HOSTNAME=www.wang.org&quot; nginx:v1.0 </span></span><br></pre></td></tr></table></figure>

<h5 id="ARG-构建参数"><a href="#ARG-构建参数" class="headerlink" title="ARG: 构建参数"></a>ARG: 构建参数</h5><p>ARG指令在build 阶段指定变量,和ENV不同的是，容器运行时不会存在这些环境变量</p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ARG</span> &lt;name&gt;[=&lt;default value&gt;]</span><br></pre></td></tr></table></figure>

<p>如果和ENV同名，ENV覆盖ARG变量</p>
<p>可以用 docker build –build-arg &lt;参数名&gt;=&lt;值&gt; 来覆盖</p>
<p>范例: </p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> busybox</span><br><span class="line"><span class="keyword">ARG</span> author=<span class="string">&quot;wang &lt;root@wangxiaochun.com&gt;&quot;</span></span><br><span class="line"><span class="keyword">LABEL</span><span class="language-bash"> maintainer=<span class="string">&quot;<span class="variable">$&#123;author&#125;</span>&quot;</span></span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment"># docker build --build-arg author=&quot;29308620@qq.com&quot; -t busybox:v1.0 . </span></span><br></pre></td></tr></table></figure>

<p>说明: ARG 和 FROM</p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#FROM指令支持ARG指令放在第一个FROM之前声明变量</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#示例:</span></span><br><span class="line"><span class="keyword">ARG</span>  CODE_VERSION=latest</span><br><span class="line"><span class="keyword">FROM</span> base:$&#123;CODE_VERSION&#125;</span><br><span class="line"><span class="keyword">CMD</span><span class="language-bash"> /code/run-app</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">FROM</span> extras:$&#123;CODE_VERSION&#125;</span><br><span class="line"><span class="keyword">CMD</span><span class="language-bash"> /code/run-extras</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#在FROM之前声明的ARG在构建阶段之外，所以它不能在FROM之后的任何指令中使用。 要使用在第一个FROM之前声明的ARG的默认值，请在构建阶段内使用没有值的ARG指令</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#示例:</span></span><br><span class="line"><span class="keyword">ARG</span> VERSION=latest</span><br><span class="line"><span class="keyword">FROM</span> busybox:$VERSION</span><br><span class="line"><span class="keyword">ARG</span> VERSION</span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> <span class="built_in">echo</span> <span class="variable">$VERSION</span> &gt; image_version</span></span><br></pre></td></tr></table></figure>

<h5 id="VOLUME-匿名卷"><a href="#VOLUME-匿名卷" class="headerlink" title="VOLUME: 匿名卷"></a>VOLUME: 匿名卷</h5><p>在容器中创建一个可以从本地主机或其他容器挂载的挂载点，一般用来存放数据库和需要保持的数据等，默认会将宿主机上的目录挂载至VOLUME 指令指定的容器目录。即使容器后期被删除，此宿主机的目录仍会保留，从而实现容器数据的持久保存。</p>
<p>宿主机目录为</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/var/lib/docker/volumes/&lt;volume_id&gt;/_data</span><br></pre></td></tr></table></figure>

<p>语法: </p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">VOLUME &lt;容器内路径&gt;</span><br><span class="line">VOLUME [<span class="string">&quot;&lt;容器内路径1&gt;&quot;</span>, <span class="string">&quot;&lt;容器内路径2&gt;&quot;</span>...]</span><br><span class="line">    </span><br><span class="line">注意: </span><br><span class="line">&lt;容器内路径&gt;如果在容器内不存在,在创建容器时会自动创建</span><br><span class="line">&lt;容器内路径&gt;如果是存在的,同时目录内有内容,将会把此目录的内容复制到宿主机的实际目录</span><br></pre></td></tr></table></figure>

<p>注意: </p>
<ul>
<li>Dockerfile中的VOLUME实现的是匿名数据卷,无法指定宿主机路径和容器目录的挂载关系 </li>
<li>通过docker rm -fv &lt;容器ID&gt; 可以删除容器的同时删除VOLUME指定的卷</li>
</ul>
<p>范例: 在容器创建两个/data1 ,/data2的挂载点</p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">VOLUME</span><span class="language-bash"> [ <span class="string">&quot;/data1&quot;</span>,<span class="string">&quot;/data2&quot;</span> ]</span></span><br></pre></td></tr></table></figure>

<p>范例: </p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">[root@rocky8 dockerfile]<span class="comment"># cat Dockerfile </span></span><br><span class="line"><span class="keyword">FROM</span> alpine</span><br><span class="line"><span class="keyword">VOLUME</span><span class="language-bash"> [ <span class="string">&quot;/testdata1&quot;</span>,<span class="string">&quot;/testdata2&quot;</span> ]</span></span><br><span class="line"></span><br><span class="line">[root@rocky8 dockerfile]<span class="comment"># docker build -t test:v7.0 .</span></span><br><span class="line">[root@rocky8 dockerfile]<span class="comment"># docker run -it --rm test:v7.0 sh</span></span><br><span class="line">/ <span class="comment"># df</span></span><br><span class="line">Filesystem           <span class="number">1</span>K-blocks      Used Available Use% Mounted on</span><br><span class="line">overlay               <span class="number">52403200</span>  <span class="number">12414100</span>  <span class="number">39989100</span>  <span class="number">24</span>% /</span><br><span class="line">tmpfs                    <span class="number">65536</span>         <span class="number">0</span>     <span class="number">65536</span>   <span class="number">0</span>% /dev</span><br><span class="line">tmpfs                  <span class="number">2845540</span>         <span class="number">0</span>   <span class="number">2845540</span>   <span class="number">0</span>% /sys/fs/cgroup</span><br><span class="line">shm                      <span class="number">65536</span>         <span class="number">0</span>     <span class="number">65536</span>   <span class="number">0</span>% /dev/shm</span><br><span class="line">/dev/mapper/rl-root   <span class="number">52403200</span>  <span class="number">12414100</span>  <span class="number">39989100</span>  <span class="number">24</span>% /testdata2</span><br><span class="line">/dev/mapper/rl-root   <span class="number">52403200</span>  <span class="number">12414100</span>  <span class="number">39989100</span>  <span class="number">24</span>% /testdata1</span><br><span class="line"></span><br><span class="line">/ <span class="comment"># cp /etc/issue /testdata1/f1.txt</span></span><br><span class="line">/ <span class="comment"># cp /etc/issue /testdata2/f2.txt</span></span><br><span class="line">/ <span class="comment"># exit</span></span><br><span class="line"></span><br><span class="line">[root@rocky8 /]<span class="comment"># tree /var/lib/docker/volumes/</span></span><br><span class="line">/var/lib/docker/volumes/</span><br><span class="line">├── <span class="number">5</span>bec1388af1d923f77220700dd7f458068f2ed956513ec8e9dfb336e9f5529c4</span><br><span class="line">│   └── _data</span><br><span class="line">│       └── f1.txt</span><br><span class="line">├── <span class="number">8</span>e2e3802d6c512d9f94a5912e5cdca326cb1cca0212607e2da2abdb964532415</span><br><span class="line">│   └── _data</span><br><span class="line">│       └── f2.txt</span><br></pre></td></tr></table></figure>

<h5 id="EXPOSE-暴露端口"><a href="#EXPOSE-暴露端口" class="headerlink" title="EXPOSE: 暴露端口"></a>EXPOSE: 暴露端口</h5><p>指定服务端的容器需要对外暴露(监听)的端口号，以实现容器与外部通信。</p>
<p>EXPOSE 仅仅是声明容器打算使用什么端口而已,并不会真正暴露端口,即不会自动在宿主进行端口映射</p>
<p>因此，在启动容器时需要通过 -P 或 -p ，Docker 主机才会真正分配一个端口转发到指定暴露的端口才可使用</p>
<p><strong>注意: 即使 Dockerfile 没有 EXPOSE 端口指令,也可以通过docker run -p 临时暴露容器内程序真正监听的端口</strong>,所以EXPOSE 相当于指定默认的暴露端口,可以通过docker run -P 进行真正暴露</p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">EXPOSE</span> &lt;port&gt;[/ &lt;protocol&gt;] [&lt;port&gt;[/ &lt;protocol&gt;] ..]</span><br><span class="line">    </span><br><span class="line"><span class="comment">#说明</span></span><br><span class="line">&lt;protocol&gt;用于指定传输层协议，可为tcp或udp二者之一，默认为TCP协议</span><br></pre></td></tr></table></figure>

<p>范例:</p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">EXPOSE</span> <span class="number">80</span> <span class="number">443</span></span><br><span class="line"><span class="keyword">EXPOSE</span> <span class="number">11211</span>/udp <span class="number">11211</span>/tcp</span><br></pre></td></tr></table></figure>

<p>范例:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">[root@rocky8 dockerfile]<span class="comment"># echo website in Dockerfile &gt; index.html</span></span><br><span class="line">[root@rocky8 dockerfile]<span class="comment"># cat Dockerfile </span></span><br><span class="line">FROM busybox</span><br><span class="line">LABEL maintainer=<span class="string">&quot;wshuaiqing.cn&quot;</span></span><br><span class="line">COPY index.html /data/website/</span><br><span class="line">EXPOSE 80</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@rocky8 dockerfile]<span class="comment"># docker build -t test:v1.0 .</span></span><br><span class="line">[root@rocky8 dockerfile]<span class="comment"># docker run --rm -P --name c1 test:v1.0 /bin/httpd -f -h /data/website</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#新终端</span></span><br><span class="line">[root@rocky8 /]<span class="comment"># docker port c1</span></span><br><span class="line">80/tcp -&gt; 0.0.0.0:32778</span><br><span class="line">80/tcp -&gt; [::]:32778</span><br><span class="line"></span><br><span class="line">[root@rocky8 /]<span class="comment"># curl 127.0.0.1:32778</span></span><br><span class="line">website <span class="keyword">in</span> Dockerfile</span><br><span class="line"></span><br><span class="line">[root@rocky8 /]<span class="comment"># docker kill c1</span></span><br><span class="line">c1</span><br></pre></td></tr></table></figure>

<h5 id="WORKDIR-指定工作目录"><a href="#WORKDIR-指定工作目录" class="headerlink" title="WORKDIR: 指定工作目录"></a>WORKDIR: 指定工作目录</h5><p>为后续的 RUN、CMD、ENTRYPOINT 指令配置工作目录，当容器运行后，进入容器内WORKDIR指定的默认目录</p>
<p>WORKDIR 指定工作目录（或称当前目录），以后各层的当前目录就被改为指定的目录，如该目录不存在，WORKDIR 会自行创建</p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">WORKDIR</span><span class="language-bash"> /path/to/workdir</span></span><br></pre></td></tr></table></figure>

<p>范例: </p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#两次RUN独立运行,不在同一个目录</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> <span class="built_in">cd</span> /app</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> <span class="built_in">echo</span> <span class="string">&quot;hello&quot;</span> &gt; world.txt</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#如果想实现相同目录可以使用WORKDIR</span></span><br><span class="line"><span class="keyword">WORKDIR</span><span class="language-bash"> /app</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> <span class="built_in">echo</span> <span class="string">&quot;hello&quot;</span> &gt; world.txt</span></span><br></pre></td></tr></table></figure>

<p>可以使用多个 WORKDIR 指令，后续命令如果参数是相对路径，则会基于之前命令指定的路径。例如</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">WORKDIR /a</span><br><span class="line">WORKDIR b</span><br><span class="line">WORKDIR c</span><br><span class="line">RUN pwd</span><br><span class="line">#则最终路径为 /a/b/c</span><br></pre></td></tr></table></figure>

<h5 id="ONBUILD-子镜像引用父镜像的指令"><a href="#ONBUILD-子镜像引用父镜像的指令" class="headerlink" title="ONBUILD: 子镜像引用父镜像的指令"></a>ONBUILD: 子镜像引用父镜像的指令</h5><p>可以用来配置当构建当前镜像的子镜像时，会自动触发执行的指令,但在当前镜像构建时,并不会执行,即延迟到子镜像构建时才执行</p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ONBUILD</span> [INSTRUCTION]</span><br></pre></td></tr></table></figure>

<p>例如，Dockerfile 使用如下的内容创建了镜像 image-A。</p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line"><span class="keyword">ONBUILD</span> <span class="keyword">ADD</span><span class="language-bash"> http://www.magedu.com/wp-content/uploads/2017/09/logo.png /data/</span></span><br><span class="line"><span class="keyword">ONBUILD</span> <span class="keyword">RUN</span><span class="language-bash"> <span class="built_in">rm</span> -rf /*</span></span><br><span class="line"><span class="keyword">ONBUILD</span> <span class="keyword">RUN</span><span class="language-bash"> /usr/local/bin/python-build --<span class="built_in">dir</span> /app/src...</span></span><br></pre></td></tr></table></figure>

<p>如果基于 image-A 创建新的镜像image-B时，新的Dockerfile中使用 FROM image-A指定基础镜像时，会自动执行ONBUILD 指令内容，等价于在后面添加了两条指令。</p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> image-A</span><br><span class="line"></span><br><span class="line"><span class="comment">#Automatically run the following</span></span><br><span class="line"><span class="keyword">ADD</span><span class="language-bash"> http://www.magedu.com/wp-content/uploads/2017/09/logo.png /data</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> /usr/local/bin/python-build --<span class="built_in">dir</span> /app/src</span></span><br></pre></td></tr></table></figure>

<p>说明: </p>
<ul>
<li>尽管任何指令都可注册成为触发器指令，但ONBUILD不能自我能套，且不会触发FROM和MAINTAINER指令</li>
<li>使用 ONBUILD 指令的镜像，推荐在标签中注明，例如 ruby:1.9-onbuild</li>
</ul>
<h5 id="USER-指定当前用户"><a href="#USER-指定当前用户" class="headerlink" title="USER: 指定当前用户"></a>USER: 指定当前用户</h5><p>指定运行容器的用户名或 UID，在后续dockerfile中的 RUN ，CMD和ENTRYPOINT指令时使用此用户</p>
<p>当服务不需要管理员权限时，可以通过该命令指定运行用户</p>
<p>这个用户必须是事先建立好的，否则无法切换</p>
<p>如果没有指定 USER,默认是 root 身份执行</p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">USER</span> &lt;<span class="keyword">user</span>&gt;[:&lt;group&gt;] </span><br><span class="line"><span class="keyword">USER</span> &lt;UID&gt;[:&lt;GID&gt;]</span><br></pre></td></tr></table></figure>

<p>范例: </p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">RUN</span><span class="language-bash"> groupadd -r mysql &amp;&amp; useradd -r -g mysql mysql</span></span><br><span class="line"><span class="keyword">USER</span> mysql</span><br></pre></td></tr></table></figure>

<h5 id="HEALTHCHECK-健康检查"><a href="#HEALTHCHECK-健康检查" class="headerlink" title="HEALTHCHECK: 健康检查"></a>HEALTHCHECK: 健康检查</h5><p>检查容器的健康性</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">HEALTHCHECK [选项] CMD &lt;命令&gt; <span class="comment">#设置检查容器健康状况的命令,如果命令执行失败,则返回1,即unhealthy</span></span><br><span class="line">HEALTHCHECK NONE             <span class="comment">#如果基础镜像有健康检查指令，使用这行可以屏蔽掉其健康检查指令</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">HEALTHCHECK 支持下列选项:  </span><br><span class="line">--interval=&lt;间隔&gt;   <span class="comment">#两次健康检查的间隔，默认为 30 秒</span></span><br><span class="line">--<span class="built_in">timeout</span>=&lt;时长&gt;    <span class="comment">#健康检查命令运行超时时间，如果超过这个时间，本次健康检查就被视为失败，默认 30 秒</span></span><br><span class="line">--retries=&lt;次数&gt;    <span class="comment">#当连续失败指定次数后，则将容器状态视为 unhealthy，默认3次</span></span><br><span class="line">--start-period=&lt;FDURATION&gt; <span class="comment">#default: 0s</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#检查结果返回值:</span></span><br><span class="line">0  <span class="comment">#success     the container is healthy and ready for use</span></span><br><span class="line">1  <span class="comment">#unhealthy   the container is not working correctly</span></span><br><span class="line">2  <span class="comment">#reserved    do not use this exit code</span></span><br></pre></td></tr></table></figure>

<p>范例</p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> nginx</span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> apt-get update &amp;&amp; apt-get install -y curl &amp;&amp; <span class="built_in">rm</span> -rf /var/lib/apt/lists/*</span></span><br><span class="line"><span class="keyword">HEALTHCHECK</span><span class="language-bash"> --interval=5s --<span class="built_in">timeout</span>=3s CMD curl -fs http://localhost/ </span></span><br></pre></td></tr></table></figure>

<p>范例:</p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#如果健康性检查成功,STATUS会显示 (healthy)</span></span><br><span class="line">[root@rocky8 dockerfile]<span class="comment"># docker ps </span></span><br><span class="line">CONTAINER ID   IMAGE       COMMAND                  CREATED          STATUS                    PORTS     NAMES</span><br><span class="line"><span class="number">56060</span>ebe7bca   test:v2.<span class="number">0</span>   <span class="string">&quot;/docker-entrypoint.…&quot;</span>   <span class="number">12</span> seconds ago   Up <span class="number">11</span> seconds (healthy)   <span class="number">80</span>/tcp    happy_goldberg</span><br><span class="line"><span class="number">2</span>b7b33437449   nginx       <span class="string">&quot;/docker-entrypoint.…&quot;</span>   <span class="number">15</span> minutes ago   Up <span class="number">15</span> minutes             <span class="number">80</span>/tcp    quizzical_tharp</span><br><span class="line"></span><br><span class="line"><span class="comment">#如果健康性检查不通过,STATUS会显示(unhealthy) </span></span><br><span class="line">[root@rocky8 dockerfile]<span class="comment"># docker ps </span></span><br><span class="line">CONTAINER ID   IMAGE       COMMAND                  CREATED          STATUS                    PORTS     NAMES</span><br><span class="line"><span class="number">56060</span>ebe7bca   test:v2.<span class="number">0</span>   <span class="string">&quot;/docker-entrypoint.…&quot;</span>   <span class="number">12</span> seconds ago   Up <span class="number">11</span> seconds (unhealthy)   <span class="number">80</span>/tcp    happy_goldberg</span><br><span class="line"></span><br><span class="line"><span class="comment">#查看健康状态</span></span><br><span class="line">[root@rocky8 dockerfile]<span class="comment"># docker inspect -f &#x27;&#123;&#123;.State.Health.Status&#125;&#125;&#x27; 56060ebe7bca</span></span><br><span class="line">healthy</span><br><span class="line"></span><br><span class="line"><span class="comment">#以json格式显示</span></span><br><span class="line">[root@rocky8 dockerfile]<span class="comment"># docker inspect -f &#x27;&#123;&#123;json .State.Health&#125;&#125;&#x27; 56060ebe7bca</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@rocky8 dockerfile]<span class="comment"># docker inspect -f &#x27;&#123;&#123;json .State.Health&#125;&#125;&#x27; 56060ebe7bca | python3 -m json.tool</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;Status&quot;</span>: <span class="string">&quot;healthy&quot;</span>,</span><br><span class="line">    <span class="string">&quot;FailingStreak&quot;</span>: <span class="number">0</span>,</span><br><span class="line">    ......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="dockerignore文件"><a href="#dockerignore文件" class="headerlink" title=".dockerignore文件"></a>.dockerignore文件</h5><p>官方文档: <a target="_blank" rel="noopener" href="https://docs.docker.com/engine/reference/builder/#dockerignore-file%E4%B8%8E.gitignore%E6%96%87%E4%BB%B6%E7%B1%BB%E4%BC%BC%EF%BC%8C%E7%94%9F%E6%88%90%E6%9E%84%E5%BB%BA%E4%B8%8A%E4%B8%8B%E6%96%87%E6%97%B6Docker%E5%AE%A2%E6%88%B7%E7%AB%AF%E5%BA%94%E5%BF%BD%E7%95%A5%E7%9A%84%E6%96%87%E4%BB%B6%E5%92%8C%E6%96%87%E4%BB%B6%E5%A4%B9%E6%8C%87%E5%AE%9A%E6%A8%A1%E5%BC%8F">https://docs.docker.com/engine/reference/builder/#dockerignore-file与.gitignore文件类似，生成构建上下文时Docker客户端应忽略的文件和文件夹指定模式</a> </p>
<p>.dockerignore 使用 Go 的文件路径规则 filepath.Match </p>
<p>参考链接: <a target="_blank" rel="noopener" href="https://golang.org/pkg/path/filepath/#Match">https://golang.org/pkg/path/filepath/#Match</a></p>
<p><strong>完整的语法</strong></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#     #以#开头的行为注释</span></span><br><span class="line">*     <span class="comment">#匹配任何非分隔符字符序列</span></span><br><span class="line">?     <span class="comment">#匹配任何单个非分隔符</span></span><br><span class="line">\\    <span class="comment">#表示 \</span></span><br><span class="line">**    <span class="comment">#匹配任意数量的目录（包括零）例如，**/*.go将排除在所有目录中以.go结尾的所有文件，包括构建上下文的根。</span></span><br><span class="line">!     <span class="comment">#表示取反，可用于排除例外情况</span></span><br></pre></td></tr></table></figure>

<p>范例: </p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#排除 test 目录下的所有文件</span></span><br><span class="line"><span class="built_in">test</span>/*</span><br><span class="line"></span><br><span class="line"><span class="comment">#排除 md 目录下的 xttblog.md 文件</span></span><br><span class="line">md/xttblog.md</span><br><span class="line"></span><br><span class="line"><span class="comment">#排除 xttblog 目录下的所有 .md 的文件</span></span><br><span class="line">xttblog/*.md</span><br><span class="line"></span><br><span class="line"><span class="comment">#排除以 xttblog 为前缀的文件和文件夹</span></span><br><span class="line">xttblog?</span><br><span class="line"></span><br><span class="line"><span class="comment">#排除所有目录下的 .sql 文件夹</span></span><br><span class="line">**/*.sql</span><br></pre></td></tr></table></figure>

<p>范例: </p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#除了README的md不排外，排除所有md文件，但不排除README-secret.md</span></span><br><span class="line">*.md</span><br><span class="line">!README*.md</span><br><span class="line">README-secret.md</span><br><span class="line"></span><br><span class="line"><span class="comment">#除了所有README的md文件以外的md都排除</span></span><br><span class="line">*.md</span><br><span class="line">README-secret.md</span><br><span class="line">!README*.md</span><br></pre></td></tr></table></figure>

<h5 id="Dockerfile-构建过程和指令总结"><a href="#Dockerfile-构建过程和指令总结" class="headerlink" title="Dockerfile 构建过程和指令总结"></a>Dockerfile 构建过程和指令总结</h5><p><strong>Dockerfile 构建过程</strong></p>
<ul>
<li>基础镜像运行一个容器</li>
<li>执行一条指令，对容器做出修改</li>
<li>执行类似docker commit的操作，提交一个新的中间镜像层(可以利用中间层镜像创建容器进行调试和排错)</li>
<li>再基于刚提交的镜像运行一个新容器</li>
<li>执行Dockerfile中的下一条指令，直至所有指令执行完毕</li>
</ul>
<p><strong>Dockerfile 指令总结</strong></p>
<p><img src="../../../../images/SRE/day46/39.jpg" alt="39"></p>
<h4 id="构建镜像docker-build-命令"><a href="#构建镜像docker-build-命令" class="headerlink" title="构建镜像docker build 命令"></a>构建镜像docker build 命令</h4><p>docker build命令使用Dockerfile文件创建镜像</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">docker build [OPTIONS] PATH | URL | -</span><br><span class="line"></span><br><span class="line">说明:  </span><br><span class="line">PATH | URL | -      <span class="comment">#可以使是本地路径，也可以是URL路径。若设置为 - ，则从标准输入获取Dockerfile的内容</span></span><br><span class="line">-f, --file string   <span class="comment">#Dockerfile文件名,默认为 PATH/Dockerfile</span></span><br><span class="line">--force-rm          <span class="comment">#总是删除中间层容器,创建镜像失败时，删除临时容器</span></span><br><span class="line">--no-cache          <span class="comment">#不使用之前构建中创建的缓存</span></span><br><span class="line">-q  --quiet=<span class="literal">false</span>   <span class="comment">#不显示Dockerfile的RUN运行的输出结果</span></span><br><span class="line">--<span class="built_in">rm</span>=<span class="literal">true</span>           <span class="comment">#创建镜像成功时，删除临时容器</span></span><br><span class="line">-t --tag list       <span class="comment">#设置注册名称、镜像名称、标签。格式为 &lt;注册名称&gt;/&lt;镜像名称&gt;:&lt;标签&gt;（标签默认为latest）</span></span><br></pre></td></tr></table></figure>

<p>范例: </p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">docker build .</span><br><span class="line">docker build /usr/local/src/nginx</span><br><span class="line">docker build -f /path/to/a/Dockerfile .</span><br><span class="line">docker build -t shykes/myapp .</span><br><span class="line">docker build -t shykes/myapp:1.0.2 -t shykes/myapp:latest .</span><br><span class="line">docker build -t <span class="built_in">test</span>/myapp .</span><br><span class="line">docker build -t nginx:v1 /usr/local/src/nginx</span><br></pre></td></tr></table></figure>

<p><strong>查看镜像的构建历史:</strong></p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker history 镜像ID</span><br></pre></td></tr></table></figure>

<p>范例:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">root@rocky8 dockerfile]<span class="comment"># docker history nginx:latest </span></span><br><span class="line">IMAGE          CREATED        CREATED BY                                      SIZE      COMMENT</span><br><span class="line">4cad75abc83d   2 months ago   CMD [<span class="string">&quot;nginx&quot;</span> <span class="string">&quot;-g&quot;</span> <span class="string">&quot;daemon off;&quot;</span>]                0B        buildkit.dockerfile.v0</span><br><span class="line">&lt;missing&gt;      2 months ago   STOPSIGNAL SIGQUIT                              0B        buildkit.dockerfile.v0</span><br><span class="line">&lt;missing&gt;      2 months ago   EXPOSE map[80/tcp:&#123;&#125;]                           0B        buildkit.dockerfile.v0</span><br><span class="line">&lt;missing&gt;      2 months ago   ENTRYPOINT [<span class="string">&quot;/docker-entrypoint.sh&quot;</span>]            0B        buildkit.dockerfile.v0</span><br><span class="line">&lt;missing&gt;      2 months ago   COPY 30-tune-worker-processes.sh /docker-ent…   4.62kB    buildkit.dockerfile.v0</span><br><span class="line">&lt;missing&gt;      2 months ago   COPY 20-envsubst-on-templates.sh /docker-ent…   3.02kB    buildkit.dockerfile.v0</span><br><span class="line">&lt;missing&gt;      2 months ago   COPY 15-local-resolvers.envsh /docker-entryp…   389B      buildkit.dockerfile.v0</span><br><span class="line">&lt;missing&gt;      2 months ago   COPY 10-listen-on-ipv6-by-default.sh /docker…   2.12kB    buildkit.dockerfile.v0</span><br><span class="line">&lt;missing&gt;      2 months ago   COPY docker-entrypoint.sh / <span class="comment"># buildkit          1.62kB    buildkit.dockerfile.v0</span></span><br><span class="line">&lt;missing&gt;      2 months ago   RUN /bin/sh -c <span class="built_in">set</span> -x     &amp;&amp; groupadd --syst…   117MB     buildkit.dockerfile.v0</span><br><span class="line">&lt;missing&gt;      2 months ago   ENV DYNPKG_RELEASE=1~bookworm                   0B        buildkit.dockerfile.v0</span><br><span class="line">&lt;missing&gt;      2 months ago   ENV PKG_RELEASE=1~bookworm                      0B        buildkit.dockerfile.v0</span><br><span class="line">&lt;missing&gt;      2 months ago   ENV NJS_RELEASE=1~bookworm                      0B        buildkit.dockerfile.v0</span><br><span class="line">&lt;missing&gt;      2 months ago   ENV NJS_VERSION=0.8.9                           0B        buildkit.dockerfile.v0</span><br><span class="line">&lt;missing&gt;      2 months ago   ENV NGINX_VERSION=1.27.4                        0B        buildkit.dockerfile.v0</span><br><span class="line">&lt;missing&gt;      2 months ago   LABEL maintainer=NGINX Docker Maintainers &lt;d…   0B        buildkit.dockerfile.v0</span><br><span class="line">&lt;missing&gt;      2 months ago   <span class="comment"># debian.sh --arch &#x27;amd64&#x27; out/ &#x27;bookworm&#x27; &#x27;…   74.8MB    debuerreotype 0.15</span></span><br></pre></td></tr></table></figure>

<p><strong>范例: 利用Dockerfile构建基于CentOS的nginx镜像</strong></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">[root@rocky8 dockerfile]<span class="comment"># cat Dockerfile </span></span><br><span class="line">FROM centos:8</span><br><span class="line">LABEL maintainer=<span class="string">&quot;wshuaiqing.cn&quot;</span></span><br><span class="line">RUN <span class="built_in">rm</span> -rf /etc/yum.repos.d/* &amp;&amp; curl -o /etc/yum.repos.d/CentOS-Base.repo https://mirrors.aliyun.com/repo/Centos-vault-8.5.2111.repo</span><br><span class="line">RUN yum install -y nginx &amp;&amp; <span class="built_in">echo</span> Nginx Website <span class="keyword">in</span> Docker &gt; /usr/share/nginx/html/index.html</span><br><span class="line">EXPOSE 80</span><br><span class="line">CMD [ <span class="string">&quot;nginx&quot;</span>,<span class="string">&quot;-g&quot;</span>,<span class="string">&quot;daemon off;&quot;</span> ]</span><br><span class="line"></span><br><span class="line">[root@rocky8 dockerfile]<span class="comment"># docker build -t nginx_centos8:v1.26.3 .</span></span><br><span class="line">[root@rocky8 dockerfile]<span class="comment"># docker run -d -P --name nginx-web nginx_centos8:v1.26.3 </span></span><br><span class="line">4bb1b8095dde2fce2ced8c92cb69506be03ea256533eca8ffe92e2c0837a7e44</span><br><span class="line"></span><br><span class="line">[root@rocky8 dockerfile]<span class="comment"># docker ps -l</span></span><br><span class="line">CONTAINER ID   IMAGE                   COMMAND                  CREATED          STATUS          PORTS                                     NAMES</span><br><span class="line">4bb1b8095dde   nginx_centos8:v1.26.3   <span class="string">&quot;nginx -g &#x27;daemon of…&quot;</span>   11 seconds ago   Up 10 seconds   0.0.0.0:32779-&gt;80/tcp, :::32779-&gt;80/tcp   nginx-web</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@rocky8 dockerfile]<span class="comment"># curl http://127.0.0.1:32779</span></span><br><span class="line">Nginx Website <span class="keyword">in</span> Docker</span><br><span class="line"></span><br><span class="line">[root@rocky8 dockerfile]<span class="comment"># curl -I http://127.0.0.1:32779</span></span><br><span class="line">HTTP/1.1 200 OK</span><br><span class="line">Server: nginx/1.14.1</span><br><span class="line">Date: Wed, 09 Apr 2025 11:38:05 GMT</span><br><span class="line">Content-Type: text/html</span><br><span class="line">Content-Length: 24</span><br><span class="line">Last-Modified: Wed, 09 Apr 2025 11:35:14 GMT</span><br><span class="line">Connection: keep-alive</span><br><span class="line">ETag: <span class="string">&quot;67f65b72-18&quot;</span></span><br><span class="line">Accept-Ranges: bytes</span><br></pre></td></tr></table></figure>

<p>范例: 刷新镜像缓存重新构建新镜像</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[root@ubuntu1804 ~]<span class="comment"># cat /data/Dockerfile</span></span><br><span class="line">FROM centos </span><br><span class="line">LABEL maintainer=<span class="string">&quot;wangxiaochun &lt;root@wangxiaochun.com&gt;&quot;</span></span><br><span class="line">RUN yum install -y nginx</span><br><span class="line">RUN <span class="built_in">echo</span> Nginx Website <span class="keyword">in</span> Docker &gt; /usr/share/nginx/html/index.html</span><br><span class="line"><span class="comment">#修改下面行,从下面行开始不再使用缓存</span></span><br><span class="line">ENV REFRESH_DATA 2020-01-01</span><br><span class="line">EXPOSE 80</span><br><span class="line">CMD [<span class="string">&quot;nginx&quot;</span>, <span class="string">&quot;-g&quot;</span>, <span class="string">&quot;daemon off;&quot;</span>]</span><br><span class="line"></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment"># docker build   -t nginx_centos8.2:v1.14.1 /data/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#全部不利用缓存重新构建镜像</span></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment"># docker build --no-cache -t nginx_centos8.2:v1.14.1 /data/</span></span><br></pre></td></tr></table></figure>

<h3 id="实战案例-Dockerfile-制作基于基础镜像的Base镜像"><a href="#实战案例-Dockerfile-制作基于基础镜像的Base镜像" class="headerlink" title="实战案例: Dockerfile 制作基于基础镜像的Base镜像"></a>实战案例: Dockerfile 制作基于基础镜像的Base镜像</h3><h4 id="准备目录结构，下载镜像并初始化系统"><a href="#准备目录结构，下载镜像并初始化系统" class="headerlink" title="准备目录结构，下载镜像并初始化系统"></a>准备目录结构，下载镜像并初始化系统</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#按照业务类型或系统类型等方式划分创建目录环境，方便后期镜像比较多的时候进行分类</span></span><br><span class="line">[root@rocky8 dockerfile]<span class="comment"># mkdir /data/dockerfile/&#123;web/&#123;nginx,apache,tomcat,jdk&#125;,system/&#123;centos,ubuntu,alpine,debian&#125;&#125; -p</span></span><br><span class="line">[root@rocky8 dockerfile]<span class="comment"># tree /data/dockerfile/</span></span><br><span class="line">/data/dockerfile/</span><br><span class="line">├── system</span><br><span class="line">│   ├── alpine</span><br><span class="line">│   ├── centos</span><br><span class="line">│   ├── debian</span><br><span class="line">│   └── ubuntu</span><br><span class="line">└── web</span><br><span class="line">    ├── apache</span><br><span class="line">    ├── jdk</span><br><span class="line">    ├── nginx</span><br><span class="line">    └── tomcat</span><br><span class="line"></span><br><span class="line">10 directories, 0 files</span><br><span class="line"></span><br><span class="line"><span class="comment">#下载基础镜像</span></span><br><span class="line">[root@rocky8 ~]<span class="comment"># docker pull centos:centos7.7.1908</span></span><br><span class="line">[root@rocky8 ~]<span class="comment"># docker images</span></span><br><span class="line">REPOSITORY   TAG              IMAGE ID       CREATED       SIZE</span><br><span class="line">centos       centos7.7.1908   08d05d1d5859   5 years ago   204MB</span><br></pre></td></tr></table></figure>

<h4 id="先制作基于基础镜像的系统Base镜像"><a href="#先制作基于基础镜像的系统Base镜像" class="headerlink" title="先制作基于基础镜像的系统Base镜像"></a>先制作基于基础镜像的系统Base镜像</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#先制作基于基础镜像的系统base镜像</span></span><br><span class="line">[root@rocky8 ~]<span class="comment"># cd /data/dockerfile/system/centos/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#创建Dockerfile，注意可以是dockerfile，但无语法着色功能</span></span><br><span class="line">[root@rocky8 centos]<span class="comment"># vim Dockerfile</span></span><br><span class="line">[root@rocky8 centos]<span class="comment"># cat Dockerfile </span></span><br><span class="line">FROM centos:centos7.7.1908</span><br><span class="line">LABEL maintainer=<span class="string">&quot;wshuaiqing.cn&quot;</span></span><br><span class="line">RUN <span class="built_in">rm</span> -rf /etc/yum.repos.d/* &amp;&amp; curl -o /etc/yum.repos.d/Centos-7.repo http://mirrors.aliyun.com/repo/Centos-7.repo \</span><br><span class="line">  &amp;&amp; curl -o /etc/yum.repos.d/epel-7.repo http://mirrors.aliyun.com/repo/epel-7.repo \</span><br><span class="line">  &amp;&amp; yum install -y vim-enhanced tcpdump lrzsz tree telnet bash-completion net-tools wget curl bzip2 lsof zip unzip nfs-utils gcc make gcc-c++ glibc glibc-devel pcre pcre-devel openssl openssl-devel systemd-devel zlib-devel vim \</span><br><span class="line">  &amp;&amp; yum clean all \</span><br><span class="line">  &amp;&amp; <span class="built_in">rm</span> -rf /etc/localtime \</span><br><span class="line">  &amp;&amp; <span class="built_in">ln</span> -s /usr/share/zoneinfo/Asia/Shanghai /etc/localtime</span><br><span class="line"></span><br><span class="line">[root@rocky8 centos]<span class="comment"># docker build -t centos7-base:v1 .</span></span><br><span class="line">[root@rocky8 centos]<span class="comment"># docker images                                     </span></span><br><span class="line">REPOSITORY     TAG              IMAGE ID       CREATED         SIZE     </span><br><span class="line">centos7-base   v1               4215b0f03391   2 minutes ago   435MB</span><br><span class="line">centos         centos7.7.1908   08d05d1d5859   5 years ago     204MB</span><br><span class="line"></span><br><span class="line">[root@rocky8 centos]<span class="comment"># docker history centos7-base:v1 </span></span><br><span class="line">IMAGE          CREATED         CREATED BY                                      SIZE      COMMENT</span><br><span class="line">4215b0f03391   2 minutes ago   RUN /bin/sh -c <span class="built_in">rm</span> -rf /etc/yum.repos.d/* &amp;&amp; …   231MB     buildkit.dockerfile.v0</span><br><span class="line">&lt;missing&gt;      2 minutes ago   LABEL maintainer=wshuaiqing.cn                  0B        buildkit.dockerfile.v0</span><br><span class="line">&lt;missing&gt;      5 years ago     /bin/sh -c <span class="comment">#(nop)  CMD [&quot;/bin/bash&quot;]            0B        </span></span><br><span class="line">&lt;missing&gt;      5 years ago     /bin/sh -c <span class="comment">#(nop)  LABEL org.label-schema.sc…   0B        </span></span><br><span class="line">&lt;missing&gt;      5 years ago     /bin/sh -c <span class="comment">#(nop) ADD file:3e2a127b44ed01afc…   204MB </span></span><br></pre></td></tr></table></figure>

<h3 id="实战案例-Dockerfile-制作基于Base镜像的-nginx-镜像"><a href="#实战案例-Dockerfile-制作基于Base镜像的-nginx-镜像" class="headerlink" title="实战案例: Dockerfile 制作基于Base镜像的 nginx 镜像"></a>实战案例: Dockerfile 制作基于Base镜像的 nginx 镜像</h3><h4 id="在Dockerfile目录下准备编译安装的相关文件"><a href="#在Dockerfile目录下准备编译安装的相关文件" class="headerlink" title="在Dockerfile目录下准备编译安装的相关文件"></a>在Dockerfile目录下准备编译安装的相关文件</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@rocky8 ~]<span class="comment"># mkdir /data/dockerfile/web/nginx/1.26</span></span><br><span class="line">[root@rocky8 ~]<span class="comment"># cd /data/dockerfile/web/nginx/1.26</span></span><br><span class="line">[root@rocky8 1.26]<span class="comment"># wget https://nginx.org/download/nginx-1.26.3.tar.gz</span></span><br><span class="line">[root@rocky8 1.26]<span class="comment"># mkdir app</span></span><br><span class="line">[root@rocky8 1.26]<span class="comment"># echo &quot;Test page in app&quot; &gt; app/index.html</span></span><br><span class="line">[root@rocky8 1.26]<span class="comment"># tar zcf app.tar.gz app</span></span><br><span class="line">[root@rocky8 1.26]<span class="comment"># ls</span></span><br><span class="line">app  app.tar.gz  nginx-1.26.3.tar.gz</span><br></pre></td></tr></table></figure>

<h4 id="在一台测试机进行编译安装同一版本的nginx-生成模版配置文件"><a href="#在一台测试机进行编译安装同一版本的nginx-生成模版配置文件" class="headerlink" title="在一台测试机进行编译安装同一版本的nginx 生成模版配置文件"></a>在一台测试机进行编译安装同一版本的nginx 生成模版配置文件</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[root@rocky8 src]<span class="comment"># yum install -y vim-enhanced tcpdump lrzsz tree telnet bash-completion net-tools wget curl bzip2 lsof zip unzip nfs-utils gcc make gcc-c++ glibc glibc-devel pcre pcre-devel openssl openssl-devel systemd-devel zlib-devel</span></span><br><span class="line"></span><br><span class="line">[root@rocky8 nginx-1.26.3]<span class="comment"># ./configure --prefix=/apps/nginx &amp;&amp; make -j 4 &amp;&amp; make install</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#将配置文件复制到nginx镜像的服务器相应目录下</span></span><br><span class="line">[root@rocky8 ~]<span class="comment"># scp /apps/nginx/conf/nginx.conf /data/dockerfile/web/nginx/1.26/</span></span><br><span class="line"></span><br><span class="line">[root@rocky8 ~]<span class="comment"># vim /data/dockerfile/web/nginx/1.26/nginx.conf </span></span><br><span class="line">user  nginx;</span><br><span class="line">worker_processes  1;</span><br><span class="line">daemon off;		<span class="comment">#增加此行,前台运行nginx</span></span><br></pre></td></tr></table></figure>

<h4 id="编写Dockerfile文件"><a href="#编写Dockerfile文件" class="headerlink" title="编写Dockerfile文件"></a>编写Dockerfile文件</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[root@rocky8 ~]<span class="comment"># cd /data/dockerfile/web/nginx/1.26</span></span><br><span class="line">[root@rocky8 1.26]<span class="comment"># vim Dockerfile</span></span><br><span class="line">[root@rocky8 1.26]<span class="comment"># cat Dockerfile</span></span><br><span class="line">FROM centos7-base:v1</span><br><span class="line">LABEL maintainers=<span class="string">&quot;wshuaiqing.cn&quot;</span></span><br><span class="line">ADD nginx-1.26.3.tar.gz /usr/local/src</span><br><span class="line">RUN <span class="built_in">cd</span> /usr/local/src/nginx-1.26.3 \</span><br><span class="line">    &amp;&amp; ./configure --prefix=/apps/nginx \</span><br><span class="line">	&amp;&amp; make &amp;&amp; make install \</span><br><span class="line">	&amp;&amp; <span class="built_in">rm</span> -rf /usr/local/src/nginx* \</span><br><span class="line">	&amp;&amp; useradd -r nginx</span><br><span class="line">COPY nginx.conf /apps/nginx/conf/</span><br><span class="line">ADD app.tar.gz /apps/nginx/html/</span><br><span class="line">EXPOSE 80 443</span><br><span class="line">CMD [<span class="string">&quot;/apps/nginx/sbin/nginx&quot;</span>]</span><br></pre></td></tr></table></figure>

<h4 id="生成nginx镜像"><a href="#生成nginx镜像" class="headerlink" title="生成nginx镜像"></a>生成nginx镜像</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@rocky8 1.26]<span class="comment"># ls</span></span><br><span class="line">app  app.tar.gz  Dockerfile  nginx-1.26.3.tar.gz  nginx.conf</span><br><span class="line"></span><br><span class="line">[root@rocky8 1.26]<span class="comment"># docker build -t nginx-centos7:1.26.1 .</span></span><br><span class="line">[root@rocky8 1.26]<span class="comment"># docker images</span></span><br><span class="line">REPOSITORY      TAG              IMAGE ID       CREATED          SIZE</span><br><span class="line">nginx-centos7   1.26.1           e3157f879258   10 seconds ago   446MB</span><br><span class="line">centos7-base    v1               4215b0f03391   37 minutes ago   435MB</span><br><span class="line">centos          centos7.7.1908   08d05d1d5859   5 years ago      204MB</span><br></pre></td></tr></table></figure>

<h4 id="生成的容器测试镜像"><a href="#生成的容器测试镜像" class="headerlink" title="生成的容器测试镜像"></a>生成的容器测试镜像</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">[root@rocky8 ~]<span class="comment"># docker run -d -p 80:80 nginx-centos7:1.26.1 </span></span><br><span class="line">7afa7df01d49a11f2ba22582ed5e90df89c0de35e6aff907cf6513ef072eb17b</span><br><span class="line"></span><br><span class="line">[root@rocky8 ~]<span class="comment"># docker ps</span></span><br><span class="line">CONTAINER ID   IMAGE                  COMMAND                  CREATED         STATUS         PORTS                                        NAMES</span><br><span class="line">7afa7df01d49   nginx-centos7:1.26.1   <span class="string">&quot;/apps/nginx/sbin/ng…&quot;</span>   3 seconds ago   Up 2 seconds   0.0.0.0:80-&gt;80/tcp, :::80-&gt;80/tcp, 443/tcp   focused_golick</span><br><span class="line"></span><br><span class="line">[root@rocky8 ~]<span class="comment"># docker exec -it 7afa7df01d49 bash</span></span><br><span class="line">[root@7afa7df01d49 /]<span class="comment"># ps aux</span></span><br><span class="line">USER         PID %CPU %MEM    VSZ   RSS TTY      STAT START   TIME COMMAND</span><br><span class="line">root           1  0.0  0.0  20604  2404 ?        Ss   20:33   0:00 nginx</span><br><span class="line">nginx          7  0.0  0.0  21048  2300 ?        S    20:33   0:00 nginx</span><br><span class="line">root          14  0.5  0.0  12368  3608 pts/0    Ss   20:33   0:00 bash</span><br><span class="line">root          34  0.0  0.0  51772  3536 pts/0    R+   20:33   0:00 ps au</span><br><span class="line">[root@7afa7df01d49 /]<span class="comment"># exit</span></span><br><span class="line"><span class="built_in">exit</span></span><br><span class="line"></span><br><span class="line">[root@rocky8 ~]<span class="comment"># curl 127.0.0.1/app/</span></span><br><span class="line">Test page <span class="keyword">in</span> app</span><br></pre></td></tr></table></figure>

<h3 id="实战案例-Dockerfile-直接制作-nginx-镜像"><a href="#实战案例-Dockerfile-直接制作-nginx-镜像" class="headerlink" title="实战案例: Dockerfile 直接制作 nginx 镜像"></a>实战案例: Dockerfile 直接制作 nginx 镜像</h3><h4 id="在Dockerfile目录下准备编译安装的相关文件-1"><a href="#在Dockerfile目录下准备编译安装的相关文件-1" class="headerlink" title="在Dockerfile目录下准备编译安装的相关文件"></a>在Dockerfile目录下准备编译安装的相关文件</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[root@rocky8 ~]<span class="comment"># cd /data/dockerfile/web/nginx/1.26/</span></span><br><span class="line"></span><br><span class="line">[root@rocky8 1.26]<span class="comment"># wget https://nginx.org/download/nginx-1.26.3.tar.gz</span></span><br><span class="line">[root@rocky8 1.26]<span class="comment"># ls</span></span><br><span class="line">Dockerfile  index.html  nginx-1.26.3.tar.gz  nginx.conf</span><br><span class="line"></span><br><span class="line">[root@rocky8 1.26]<span class="comment"># vim nginx.conf </span></span><br><span class="line">user  nginx;</span><br><span class="line">worker_processes  1;</span><br><span class="line"><span class="comment">#daemon off;</span></span><br></pre></td></tr></table></figure>

<h4 id="编写Dockerfile文件-1"><a href="#编写Dockerfile文件-1" class="headerlink" title="编写Dockerfile文件"></a>编写Dockerfile文件</h4><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">[root@rocky8 <span class="number">1.26</span>]<span class="comment"># cat Dockerfile </span></span><br><span class="line"><span class="keyword">FROM</span> centos:centos7.<span class="number">7.1908</span></span><br><span class="line"><span class="keyword">LABEL</span><span class="language-bash"> maintainers=<span class="string">&quot;wshuaiqing.cn&quot;</span></span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> <span class="built_in">rm</span> -rf /etc/yum.repos.d/* &amp;&amp; curl -o /etc/yum.repos.d/CentOS-Base.repo https://mirrors.aliyun.com/repo/Centos-7.repo \</span></span><br><span class="line"><span class="language-bash">	&amp;&amp; curl -o /etc/yum.repos.d/epel.repo https://mirrors.aliyun.com/repo/epel-7.repo</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> yum install -y vim make gcc gcc-c++ pcre pcre-devel zlib zlib-devel openssl openssl-devel \</span></span><br><span class="line"><span class="language-bash">	&amp;&amp; useradd -r -s /sbin/nologin nginx \</span></span><br><span class="line"><span class="language-bash">	&amp;&amp; yum clean all</span></span><br><span class="line"><span class="keyword">ADD</span><span class="language-bash"> nginx-1.26.3.tar.gz /usr/local/src</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> <span class="built_in">cd</span> /usr/local/src/nginx-1.26.3  \</span></span><br><span class="line"><span class="language-bash">    &amp;&amp; ./configure --prefix=/apps/nginx \</span></span><br><span class="line"><span class="language-bash">	&amp;&amp; make &amp;&amp; make install \</span></span><br><span class="line"><span class="language-bash">	&amp;&amp; <span class="built_in">rm</span> -rf /usr/local/src/nginx*</span></span><br><span class="line"><span class="keyword">ADD</span><span class="language-bash"> nginx.conf /apps/nginx/conf/nginx.conf</span></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> index.html /apps/nginx/html/index.html</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> <span class="built_in">ln</span> -s /apps/nginx/sbin/nginx /usr/sbin/nginx</span></span><br><span class="line"><span class="keyword">EXPOSE</span> <span class="number">80</span> <span class="number">443</span></span><br><span class="line"><span class="keyword">CMD</span><span class="language-bash"> [<span class="string">&quot;nginx&quot;</span>,<span class="string">&quot;-g&quot;</span>,<span class="string">&quot;daemon off;&quot;</span>]</span></span><br></pre></td></tr></table></figure>

<h4 id="生成nginx镜像-1"><a href="#生成nginx镜像-1" class="headerlink" title="生成nginx镜像"></a>生成nginx镜像</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[root@rocky8 1.26]<span class="comment"># vim build.sh</span></span><br><span class="line">[root@rocky8 1.26]<span class="comment"># cat build.sh </span></span><br><span class="line"><span class="comment">#!/bin/bash</span></span><br><span class="line">docker build -t nginx-centos7:1.26.3-v2 .</span><br><span class="line"></span><br><span class="line">[root@rocky8 1.26]<span class="comment"># chmod +x build.sh</span></span><br><span class="line">[root@rocky8 1.26]<span class="comment"># ./build.sh </span></span><br><span class="line">[root@rocky8 1.26]<span class="comment"># docker images</span></span><br><span class="line">REPOSITORY      TAG              IMAGE ID       CREATED          SIZE</span><br><span class="line">nginx-centos7   1.26.3-v2        08c66ca1868e   13 seconds ago   405MB</span><br><span class="line">nginx-centos7   1.26.1           e3157f879258   4 hours ago      446MB</span><br><span class="line">centos7-base    v1               4215b0f03391   4 hours ago      435MB</span><br><span class="line">centos          centos7.7.1908   08d05d1d5859   5 years ago      204MB</span><br></pre></td></tr></table></figure>

<h4 id="生成容器测试镜像"><a href="#生成容器测试镜像" class="headerlink" title="生成容器测试镜像"></a>生成容器测试镜像</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">[root@rocky8 1.26]<span class="comment"># docker run -d -p 80:80 nginx-centos7:1.26.3-v2 </span></span><br><span class="line">600c8cb0a99fb7d35a0074f42a3cf42ea664b6d9eabbd58b54e7cc449eb4cb21</span><br><span class="line"></span><br><span class="line">[root@rocky8 1.26]<span class="comment"># docker ps</span></span><br><span class="line">CONTAINER ID   IMAGE                     COMMAND                  CREATED         STATUS         PORTS                                        NAMES</span><br><span class="line">600c8cb0a99f   nginx-centos7:1.26.3-v2   <span class="string">&quot;nginx -g &#x27;daemon of…&quot;</span>   4 seconds ago   Up 3 seconds   0.0.0.0:80-&gt;80/tcp, :::80-&gt;80/tcp, 443/tcp   affectionate_hypatia</span><br><span class="line"></span><br><span class="line">[root@rocky8 1.26]<span class="comment"># docker exec -it 600c8cb0a99f bash</span></span><br><span class="line">[root@600c8cb0a99f /]<span class="comment"># ps aux</span></span><br><span class="line">USER         PID %CPU %MEM    VSZ   RSS TTY      STAT START   TIME COMMAND</span><br><span class="line">root           1  0.0  0.0  20604  2432 ?        Ss   16:04   0:00 nginx</span><br><span class="line">nginx          7  0.0  0.0  21048  2428 ?        S    16:04   0:00 nginx</span><br><span class="line">root           8  0.2  0.0  11844  3064 pts/0    Ss   16:05   0:00 bash</span><br><span class="line">root          24  0.0  0.0  51772  3500 pts/0    R+   16:05   0:00 ps au</span><br><span class="line"></span><br><span class="line">[root@600c8cb0a99f /]<span class="comment"># exit</span></span><br><span class="line"><span class="built_in">exit</span></span><br></pre></td></tr></table></figure>

<h3 id="实战案例-多阶段构建"><a href="#实战案例-多阶段构建" class="headerlink" title="实战案例: 多阶段构建"></a>实战案例: 多阶段构建</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">[root@rocky8 go-hello]<span class="comment"># cat Dockerfile </span></span><br><span class="line">FROM golang:1.18-alpine</span><br><span class="line">COPY hello.go /opt</span><br><span class="line">WORKDIR /opt</span><br><span class="line">RUN go build hello.go</span><br><span class="line">CMD <span class="string">&quot;./hello&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@rocky8 go-hello]<span class="comment"># cat hello.go </span></span><br><span class="line">package main</span><br><span class="line"></span><br><span class="line">import <span class="string">&quot;fmt&quot;</span></span><br><span class="line"></span><br><span class="line">func <span class="function"><span class="title">main</span></span>() &#123;</span><br><span class="line">	fmt.Println(<span class="string">&quot;hello,world&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@rocky8 go-hello]<span class="comment"># cat build.sh </span></span><br><span class="line"><span class="comment">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line">docker build -t go-hello:<span class="variable">$1</span> .</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@rocky8 go-hello]<span class="comment"># bash build.sh v1.0</span></span><br><span class="line">[root@rocky8 go-hello]<span class="comment"># docker run --name hello go-hello:v1.0 </span></span><br><span class="line">hello,world</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@rocky8 go-hello]<span class="comment"># cp Dockerfile Dockerfile-v1.0</span></span><br><span class="line">[root@rocky8 go-hello]<span class="comment"># vim Dockerfile</span></span><br><span class="line">[root@rocky8 go-hello]<span class="comment"># cat Dockerfile</span></span><br><span class="line">FROM golang:1.18-alpine as builder</span><br><span class="line">COPY hello.go /opt</span><br><span class="line">WORKDIR /opt</span><br><span class="line">RUN go build hello.go</span><br><span class="line"></span><br><span class="line">FROM alpine:3.15.0</span><br><span class="line">COPY --from=builder /opt/hello /opt/hello</span><br><span class="line">CMD [<span class="string">&quot;/opt/hello&quot;</span>]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@rocky8 go-hello]<span class="comment"># bash build.sh v2.0</span></span><br><span class="line">[root@rocky8 go-hello]<span class="comment"># docker run --name hello2 go-hello:v2.0 </span></span><br><span class="line">hello,world</span><br><span class="line"></span><br><span class="line">[root@rocky8 go-hello]<span class="comment"># docker images go-hello</span></span><br><span class="line">REPOSITORY   TAG       IMAGE ID       CREATED              SIZE</span><br><span class="line">go-hello     v2.0      f94585d3013e   About a minute ago   7.35MB</span><br><span class="line">go-hello     v1.0      e127f2c277ec   4 minutes ago        331MB</span><br></pre></td></tr></table></figure>

<h3 id="生产案例-制作自定义tomcat业务镜像"><a href="#生产案例-制作自定义tomcat业务镜像" class="headerlink" title="生产案例: 制作自定义tomcat业务镜像"></a>生产案例: 制作自定义tomcat业务镜像</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">[root@rocky8 ~]<span class="comment"># cd /data/dockerfile/system/centos/</span></span><br><span class="line">[root@rocky8 centos]<span class="comment"># cat Dockerfile </span></span><br><span class="line">FROM centos:centos7.7.1908</span><br><span class="line">LABEL maintainer=<span class="string">&quot;wshuaiqing.cn&quot;</span></span><br><span class="line">RUN <span class="built_in">rm</span> -rf /etc/yum.repos.d/* &amp;&amp; curl -o /etc/yum.repos.d/Centos-7.repo http://mirrors.aliyun.com/repo/Centos-7.repo \</span><br><span class="line">  &amp;&amp; curl -o /etc/yum.repos.d/epel-7.repo http://mirrors.aliyun.com/repo/epel-7.repo \</span><br><span class="line">  &amp;&amp; yum install -y vim-enhanced tcpdump lrzsz tree telnet bash-completion net-tools wget curl bzip2 lsof zip unzip nfs-utils gcc make gcc-c++ glibc glibc-devel pcre pcre-devel openssl openssl-devel systemd-devel zlib-devel vim \</span><br><span class="line">  &amp;&amp; yum clean all \</span><br><span class="line">  &amp;&amp; <span class="built_in">rm</span> -rf /etc/localtime \</span><br><span class="line">  &amp;&amp; <span class="built_in">ln</span> -s /usr/share/zoneinfo/Asia/Shanghai /etc/localtime</span><br><span class="line"><span class="comment"># 添加系统用户</span></span><br><span class="line">RUN groupadd www -g 2019 &amp;&amp; useradd www -u 2019 -g www</span><br><span class="line"></span><br><span class="line">[root@rocky8 centos]<span class="comment"># cat build.sh </span></span><br><span class="line"><span class="comment">#!/bin/bash</span></span><br><span class="line">docker build -t centos7-base:v2 .</span><br><span class="line"></span><br><span class="line">[root@rocky8 centos]<span class="comment"># bash build.sh </span></span><br><span class="line">[root@rocky8 centos]<span class="comment"># docker images centos7-base:v2 </span></span><br><span class="line">REPOSITORY     TAG       IMAGE ID       CREATED              SIZE</span><br><span class="line">centos7-base   v2        356779b33302   About a minute ago   435MB</span><br></pre></td></tr></table></figure>

<h4 id="构建JDK-镜像"><a href="#构建JDK-镜像" class="headerlink" title="构建JDK 镜像"></a>构建JDK 镜像</h4><h5 id="上传JDK压缩包和profile文件上传到Dockerfile当前目录"><a href="#上传JDK压缩包和profile文件上传到Dockerfile当前目录" class="headerlink" title="上传JDK压缩包和profile文件上传到Dockerfile当前目录"></a>上传JDK压缩包和profile文件上传到Dockerfile当前目录</h5><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#将CentOS7主机上的/etc/profile文件传到 Dockerfile 所在目录下</span></span><br><span class="line">[root@rocky8 ~]<span class="comment"># scp 192.168.1.100:/etc/profile /data/dockerfile/web/jdk/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#修改profile文件，加下面四行相关变量</span></span><br><span class="line">[root@rocky8 ~]<span class="comment"># vim /data/dockerfile/web/jdk/profile </span></span><br><span class="line">[root@rocky8 ~]<span class="comment"># tail -5 /data/dockerfile/web/jdk/profile</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">export</span> JAVA_HOME=/usr/local/jdk</span><br><span class="line"><span class="built_in">export</span> TOMCAT_HOME=/apps/tomcat</span><br><span class="line"><span class="built_in">export</span> PATH=<span class="variable">$JAVA_HOME</span>/bin:<span class="variable">$JAVA_HOME</span>/jre/bin:<span class="variable">$TOMCAT_HOME</span>/bin:<span class="variable">$PATH</span></span><br><span class="line"><span class="built_in">export</span> CLASSPATH=.<span class="variable">$CLASSPATH</span>:<span class="variable">$JAVA_HOME</span>/lib:<span class="variable">$JAVA_HOME</span>/jre/lib:<span class="variable">$JAVA_HOME</span>/lib/tools.jar</span><br><span class="line"></span><br><span class="line"><span class="comment">#下载jdk文件传到Dockfile目录下</span></span><br><span class="line"><span class="comment">#https://www.oracle.com/technetwork/java/javase/downloads/jdk8-downloads-2133151.html</span></span><br><span class="line">[root@rocky8 ~]<span class="comment"># tree /data/dockerfile/web/jdk/</span></span><br><span class="line">/data/dockerfile/web/jdk/</span><br><span class="line">├── jdk-8u441-linux-x64.tar.gz</span><br><span class="line">└── profile</span><br><span class="line"></span><br><span class="line">0 directories, 2 files</span><br></pre></td></tr></table></figure>

<h5 id="准备Dockerfile文件"><a href="#准备Dockerfile文件" class="headerlink" title="准备Dockerfile文件"></a>准备Dockerfile文件</h5><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root@rocky8 ~]<span class="comment"># vim /data/dockerfile/web/jdk/Dockerfile</span></span><br><span class="line">[root@rocky8 ~]<span class="comment"># cat /data/dockerfile/web/jdk/Dockerfile</span></span><br><span class="line">FROM centos7-base:v2</span><br><span class="line">LABEL maintainer=<span class="string">&quot;wshuaiqing.cn&quot;</span></span><br><span class="line">ADD jdk-8u441-linux-x64.tar.gz /usr/local/src/</span><br><span class="line">RUN <span class="built_in">ln</span> -s /usr/local/src/jdk1.8.0_441 /usr/local/jdk</span><br><span class="line">ADD profile /etc/profile</span><br><span class="line">ENV JAVA_HOME /usr/local/jdk</span><br><span class="line">ENV JRE_HOME <span class="variable">$JAVA_HOME</span>/jre</span><br><span class="line">ENV CLASSPATH <span class="variable">$JAVA_HOME</span>/lib/:<span class="variable">$JRE_HOME</span>/lib/</span><br><span class="line">ENV PATH <span class="variable">$PATH</span>:<span class="variable">$JAVA_HOME</span>/bin</span><br></pre></td></tr></table></figure>

<h4 id="执行构建脚本制作镜像"><a href="#执行构建脚本制作镜像" class="headerlink" title="执行构建脚本制作镜像"></a>执行构建脚本制作镜像</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">[root@rocky8 ~]<span class="comment"># vim /data/dockerfile/web/jdk/build.sh</span></span><br><span class="line">[root@rocky8 ~]<span class="comment"># cat /data/dockerfile/web/jdk/build.sh</span></span><br><span class="line"><span class="comment">#!/bin/bash</span></span><br><span class="line">docker build -t centos7-jdk:8u441 .</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@rocky8 ~]<span class="comment"># tree /data/dockerfile/web/jdk/</span></span><br><span class="line">/data/dockerfile/web/jdk/</span><br><span class="line">├── build.sh</span><br><span class="line">├── Dockerfile</span><br><span class="line">├── jdk-8u441-linux-x64.tar.gz</span><br><span class="line">└── profile</span><br><span class="line"></span><br><span class="line">0 directories, 4 files</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@rocky8 ~]<span class="comment"># cd /data/dockerfile/web/jdk/</span></span><br><span class="line">[root@rocky8 jdk]<span class="comment"># bash build.sh </span></span><br><span class="line">[root@rocky8 jdk]<span class="comment"># docker images centos7-jdk:8u441 </span></span><br><span class="line">REPOSITORY    TAG       IMAGE ID       CREATED          SIZE</span><br><span class="line">centos7-jdk   8u441     050430ff2ca1   23 seconds ago   805MB</span><br></pre></td></tr></table></figure>

<h4 id="从镜像启动容器测试"><a href="#从镜像启动容器测试" class="headerlink" title="从镜像启动容器测试"></a>从镜像启动容器测试</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@rocky8 jdk]<span class="comment"># docker run -it --rm centos7-jdk:8u441 bash</span></span><br><span class="line">[root@fabb4583c19b /]<span class="comment"># java -version</span></span><br><span class="line">java version <span class="string">&quot;1.8.0_441&quot;</span></span><br><span class="line">Java(TM) SE Runtime Environment (build 1.8.0_441-b07)</span><br><span class="line">Java HotSpot(TM) 64-Bit Server VM (build 25.441-b07, mixed mode)</span><br></pre></td></tr></table></figure>

<h4 id="从JDK镜像构建tomcat-8-Base镜像"><a href="#从JDK镜像构建tomcat-8-Base镜像" class="headerlink" title="从JDK镜像构建tomcat 8 Base镜像"></a>从JDK镜像构建tomcat 8 Base镜像</h4><p>基于自定义的 JDK 基础镜像，构建出通用的自定义 Tomcat 基础镜像，此镜像后期会被多个业务的多个服务共同引用(相同的JDK 版本和Tomcat 版本)</p>
<h5 id="上传tomcat-压缩包"><a href="#上传tomcat-压缩包" class="headerlink" title="上传tomcat 压缩包"></a>上传tomcat 压缩包</h5><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@rocky8 ~]<span class="comment"># mkdir /data/dockerfile/web/tomcat/tomcat-base-8.5.50</span></span><br><span class="line">[root@rocky8 ~]<span class="comment"># cd /data/dockerfile/web/tomcat/tomcat-base-8.5.50</span></span><br><span class="line">[root@rocky8 tomcat-base-8.5.50]<span class="comment"># wget https://archive.apache.org/dist/tomcat/tomcat-8/v8.5.50/bin/apache-tomcat-8.5.50.tar.gz</span></span><br></pre></td></tr></table></figure>

<h5 id="编辑Dockerfile"><a href="#编辑Dockerfile" class="headerlink" title="编辑Dockerfile"></a>编辑Dockerfile</h5><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[root@rocky8 tomcat-base-8.5.50]<span class="comment"># vim Dockerfile</span></span><br><span class="line">[root@rocky8 tomcat-base-8.5.50]<span class="comment"># cat Dockerfile</span></span><br><span class="line">FROM centos7-jdk:8u441</span><br><span class="line">LABEL maintainer=<span class="string">&quot;wshuaiqing.cn&quot;</span></span><br><span class="line"><span class="comment">#env</span></span><br><span class="line">ENV TZ <span class="string">&quot;Asia/Shanghai&quot;</span></span><br><span class="line">ENV LANG en_US.UTF-8</span><br><span class="line">ENV TERM xterm</span><br><span class="line">ENV TOMCAT_MAJOR_VERSION 8</span><br><span class="line">ENV TOMCAT_MINOR_VERSION 8.5.50</span><br><span class="line">ENV APP_DIR <span class="variable">$&#123;CATALINA_HOME&#125;</span>/webapps</span><br><span class="line">RUN <span class="built_in">mkdir</span> /apps</span><br><span class="line">ADD apache-tomcat-8.5.50.tar.gz /apps</span><br><span class="line">RUN <span class="built_in">ln</span> -s /apps/apache-tomcat-8.5.50 /apps/tomcat</span><br></pre></td></tr></table></figure>

<h5 id="通过脚本构建tomcat-基础镜像"><a href="#通过脚本构建tomcat-基础镜像" class="headerlink" title="通过脚本构建tomcat 基础镜像"></a>通过脚本构建tomcat 基础镜像</h5><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">[root@rocky8 tomcat-base-8.5.50]<span class="comment"># vim build.sh</span></span><br><span class="line">[root@rocky8 tomcat-base-8.5.50]<span class="comment"># cat build.sh</span></span><br><span class="line"><span class="comment">#!/bin/bash</span></span><br><span class="line">docker build -t tomcat-base:v8.5.50 .</span><br><span class="line"></span><br><span class="line">[root@rocky8 tomcat-base-8.5.50]<span class="comment"># tree</span></span><br><span class="line">.</span><br><span class="line">├── apache-tomcat-8.5.50.tar.gz</span><br><span class="line">├── build.sh</span><br><span class="line">└── Dockerfile</span><br><span class="line"></span><br><span class="line">0 directories, 3 files</span><br><span class="line"></span><br><span class="line">[root@rocky8 tomcat-base-8.5.50]<span class="comment"># bash build.sh </span></span><br><span class="line">[root@rocky8 tomcat-base-8.5.50]<span class="comment"># docker images tomcat-base:v8.5.50 </span></span><br><span class="line">REPOSITORY    TAG       IMAGE ID       CREATED              SIZE</span><br><span class="line">tomcat-base   v8.5.50   49991f088aa0   About a minute ago   819MB</span><br></pre></td></tr></table></figure>

<h5 id="验证镜像构建完成"><a href="#验证镜像构建完成" class="headerlink" title="验证镜像构建完成"></a>验证镜像构建完成</h5><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[root@rocky8 tomcat-base-8.5.50]<span class="comment"># docker run -itt --rm -p 8080:8080 tomcat-base:v8.5.50 bash</span></span><br><span class="line"></span><br><span class="line">[root@c42f13fbb34d /]<span class="comment"># /apps/tomcat/bin/catalina.sh start</span></span><br><span class="line">Using CATALINA_BASE:   /apps/tomcat</span><br><span class="line">Using CATALINA_HOME:   /apps/tomcat</span><br><span class="line">Using CATALINA_TMPDIR: /apps/tomcat/temp</span><br><span class="line">Using JRE_HOME:        /usr/local/jdk/jre</span><br><span class="line">Using CLASSPATH:       /apps/tomcat/bin/bootstrap.jar:/apps/tomcat/bin/tomcat-juli.jar</span><br><span class="line">Tomcat started.</span><br><span class="line"></span><br><span class="line">[root@c42f13fbb34d /]<span class="comment"># netstat -ntl</span></span><br><span class="line">Active Internet connections (only servers)</span><br><span class="line">Proto Recv-Q Send-Q Local Address           Foreign Address         State      </span><br><span class="line">tcp6       0      0 127.0.0.1:8005          :::*                    LISTEN     </span><br><span class="line">tcp6       0      0 :::8009                 :::*                    LISTEN     </span><br><span class="line">tcp6       0      0 :::8080                 :::*                    LISTEN </span><br></pre></td></tr></table></figure>

<h4 id="构建业务镜像1"><a href="#构建业务镜像1" class="headerlink" title="构建业务镜像1"></a>构建业务镜像1</h4><p>创建tomcat-app1和tomcat-app2两个目录，代表不同的两个基于tomcat的业务。</p>
<h5 id="准备tomcat的配置文件"><a href="#准备tomcat的配置文件" class="headerlink" title="准备tomcat的配置文件"></a>准备tomcat的配置文件</h5><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">[root@rocky8 ~]<span class="comment"># mkdir -p /data/dockerfile/web/tomcat/tomcat-app&#123;1,2&#125;</span></span><br><span class="line">[root@rocky8 ~]<span class="comment"># tree /data/dockerfile/web/tomcat/</span></span><br><span class="line">/data/dockerfile/web/tomcat/</span><br><span class="line">├── tomcat-app1</span><br><span class="line">├── tomcat-app2</span><br><span class="line">└── tomcat-base-8.5.50</span><br><span class="line">    ├── apache-tomcat-8.5.50.tar.gz</span><br><span class="line">    ├── build.sh</span><br><span class="line">    └── Dockerfile</span><br><span class="line"></span><br><span class="line">3 directories, 3 files</span><br><span class="line"></span><br><span class="line"><span class="comment">#上传和修改server.xml </span></span><br><span class="line">[root@rocky8 ~]<span class="comment"># cd /data/dockerfile/web/tomcat/tomcat-base-8.5.50/</span></span><br><span class="line">[root@rocky8 tomcat-base-8.5.50]<span class="comment"># tar xf apache-tomcat-8.5.50.tar.gz </span></span><br><span class="line">[root@rocky8 tomcat-base-8.5.50]<span class="comment"># cp apache-tomcat-8.5.50/conf/server.xml /data/dockerfile/web/tomcat/tomcat-app1/</span></span><br><span class="line">[root@rocky8 tomcat-base-8.5.50]<span class="comment"># cd /data/dockerfile/web/tomcat/tomcat-app1/</span></span><br><span class="line">[root@rocky8 tomcat-app1]<span class="comment"># vim server.xml </span></span><br><span class="line">......</span><br><span class="line">      &lt;Host name=<span class="string">&quot;localhost&quot;</span>  appBase=<span class="string">&quot;/data/tomcat/webapps&quot;</span></span><br><span class="line">            unpackWARs=<span class="string">&quot;true&quot;</span> autoDeploy=<span class="string">&quot;true&quot;</span>&gt;</span><br><span class="line">......</span><br></pre></td></tr></table></figure>

<p><img src="../../../../images/SRE/day46/40.jpg" alt="40"></p>
<h5 id="准备自定义页面"><a href="#准备自定义页面" class="headerlink" title="准备自定义页面"></a>准备自定义页面</h5><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@rocky8 tomcat-app1]<span class="comment"># mkdir app</span></span><br><span class="line">[root@rocky8 tomcat-app1]<span class="comment"># echo &quot;Tomcat Page in app1&quot; &gt; app/index.jsp</span></span><br><span class="line">[root@rocky8 tomcat-app1]<span class="comment"># tar zcf app.tar.gz app</span></span><br></pre></td></tr></table></figure>

<h5 id="准备容器启动执行脚本"><a href="#准备容器启动执行脚本" class="headerlink" title="准备容器启动执行脚本"></a>准备容器启动执行脚本</h5><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@rocky8 tomcat-app1]<span class="comment"># vim run_tomcat.sh</span></span><br><span class="line">[root@rocky8 tomcat-app1]<span class="comment"># cat run_tomcat.sh</span></span><br><span class="line"><span class="comment">#!/bin/bash</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;nameserver 180.76.76.76&quot;</span> &gt; /etc/resolv.conf</span><br><span class="line">su - www -c <span class="string">&quot;/apps/tomcat/bin/catalina.sh start&quot;</span></span><br><span class="line">su - www -c <span class="string">&quot;tail -f /etc/hosts&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@rocky8 tomcat-app1]<span class="comment"># chmod +x run_tomcat.sh</span></span><br></pre></td></tr></table></figure>

<h5 id="准备Dockerfile"><a href="#准备Dockerfile" class="headerlink" title="准备Dockerfile"></a>准备Dockerfile</h5><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@rocky8 tomcat-app1]<span class="comment"># vim Dockerfile</span></span><br><span class="line">[root@rocky8 tomcat-app1]<span class="comment"># cat Dockerfile</span></span><br><span class="line">FROM tomcat-base:v8.5.50</span><br><span class="line">ADD server.xml /apps/tomcat/conf/server.xml</span><br><span class="line">ADD run_tomcat.sh /apps/tomcat/bin/run_tomcat.sh</span><br><span class="line">ADD app.tar.gz /data/tomcat/webapps/</span><br><span class="line">RUN <span class="built_in">chown</span> -R www.www /apps/ /data/tomcat/</span><br><span class="line">EXPOSE 8080 8009</span><br><span class="line">CMD [<span class="string">&quot;/apps/tomcat/bin/run_tomcat.sh&quot;</span>]</span><br></pre></td></tr></table></figure>

<h5 id="执行构建脚本制作镜像-1"><a href="#执行构建脚本制作镜像-1" class="headerlink" title="执行构建脚本制作镜像"></a>执行构建脚本制作镜像</h5><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">[root@rocky8 tomcat-app1]<span class="comment"># vim build.sh</span></span><br><span class="line">[root@rocky8 tomcat-app1]<span class="comment"># cat build.sh</span></span><br><span class="line"><span class="comment">#!/bin/bash</span></span><br><span class="line">docker build -t tomcat-web:app1 .</span><br><span class="line">[root@rocky8 tomcat-app1]<span class="comment"># tree</span></span><br><span class="line">.</span><br><span class="line">├── app</span><br><span class="line">│   └── index.jsp</span><br><span class="line">├── app.tar.gz</span><br><span class="line">├── build.sh</span><br><span class="line">├── Dockerfile</span><br><span class="line">├── run_tomcat.sh</span><br><span class="line">└── server.xml</span><br><span class="line"></span><br><span class="line">1 directory, 6 files</span><br><span class="line"></span><br><span class="line">[root@rocky8 tomcat-app1]<span class="comment"># bash build.sh </span></span><br><span class="line">[root@rocky8 tomcat-app1]<span class="comment"># docker images</span></span><br><span class="line">REPOSITORY      TAG              IMAGE ID       CREATED          SIZE</span><br><span class="line">tomcat-web      app1             ec2c46689170   11 seconds ago   834MB</span><br><span class="line">tomcat-base     v8.5.50          49991f088aa0   3 hours ago      819MB</span><br><span class="line">tomcat-bash     v8.5.50          49991f088aa0   3 hours ago      819MB</span><br><span class="line">centos7-jdk     8u441            050430ff2ca1   3 hours ago      805MB</span><br><span class="line">centos7-base    v2               356779b33302   4 hours ago      435MB</span><br><span class="line">go-hello        v2.0             f94585d3013e   4 hours ago      7.35MB</span><br><span class="line">go-hello        v1.0             e127f2c277ec   4 hours ago      331MB</span><br><span class="line">nginx-centos7   1.26.3-v2        08c66ca1868e   4 hours ago      405MB</span><br><span class="line">nginx-centos7   1.26.1           e3157f879258   7 hours ago      446MB</span><br><span class="line">centos7-base    v1               4215b0f03391   8 hours ago      435MB</span><br><span class="line">centos          centos7.7.1908   08d05d1d5859   5 years ago      204MB</span><br></pre></td></tr></table></figure>

<h5 id="从镜像启动测试容器"><a href="#从镜像启动测试容器" class="headerlink" title="从镜像启动测试容器"></a>从镜像启动测试容器</h5><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@rocky8 tomcat-app1]<span class="comment"># docker run -d -p 8080:8080 tomcat-web:app1 </span></span><br><span class="line">c45493cae1a6bfa4999b55b37576cfa294dcbdad27a821c19c24f1561c6aa80a</span><br></pre></td></tr></table></figure>

<h5 id="访问测试-2"><a href="#访问测试-2" class="headerlink" title="访问测试"></a>访问测试</h5><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">[root@rocky8 tomcat-app1]<span class="comment"># docker run -d -p 8080:8080 tomcat-web:app1 </span></span><br><span class="line">a21fcd34f711bc27379fea90137805dfc8b79c55123b1919c1e7b6154d4f52a4</span><br><span class="line"></span><br><span class="line">[root@rocky8 tomcat-app1]<span class="comment"># curl 127.0.0.1:8080/app/</span></span><br><span class="line">Tomcat Page <span class="keyword">in</span> app1</span><br><span class="line"></span><br><span class="line">[root@rocky8 tomcat-app1]<span class="comment"># docker exec -it a21fcd bash</span></span><br><span class="line">[root@a21fcd34f711 /]<span class="comment"># ps aux</span></span><br><span class="line">USER         PID %CPU %MEM    VSZ   RSS TTY      STAT START   TIME COMMAND</span><br><span class="line">root           1  0.0  0.0  13308  3108 ?        Ss   04:02   0:00 /bin/</span><br><span class="line">www           26  5.3  2.3 5460176 136224 ?      Sl   04:02   0:02 /usr/</span><br><span class="line">root          28  0.0  0.0  83600  4528 ?        S    04:02   0:00 su - </span><br><span class="line">www           29  0.0  0.0   4420   684 ?        Ss   04:02   0:00 <span class="built_in">tail</span> </span><br><span class="line">root          91  0.4  0.0  13972  4068 pts/0    Ss   04:03   0:00 bash</span><br><span class="line">root         111  0.0  0.0  53372  3940 pts/0    R+   04:03   0:00 ps au</span><br><span class="line"></span><br><span class="line">[root@a21fcd34f711 /]<span class="comment"># vim /data/tomcat/webapps/app/index.jsp </span></span><br><span class="line">[root@a21fcd34f711 /]<span class="comment"># cat /data/tomcat/webapps/app/index.jsp</span></span><br><span class="line">Tomcat Page <span class="keyword">in</span> app1 v2</span><br><span class="line"></span><br><span class="line">[root@a21fcd34f711 /]<span class="comment"># /apps/tomcat/bin/catalina.sh stop</span></span><br><span class="line">Using CATALINA_BASE:   /apps/tomcat</span><br><span class="line">Using CATALINA_HOME:   /apps/tomcat</span><br><span class="line">Using CATALINA_TMPDIR: /apps/tomcat/temp</span><br><span class="line">Using JRE_HOME:        /usr/local/jdk/jre</span><br><span class="line">Using CLASSPATH:       /apps/tomcat/bin/bootstrap.jar:/apps/tomcat/bin/tomcat-juli.jar</span><br><span class="line"></span><br><span class="line">[root@a21fcd34f711 /]<span class="comment"># /apps/tomcat/bin/catalina.sh start</span></span><br><span class="line">Using CATALINA_BASE:   /apps/tomcat</span><br><span class="line">Using CATALINA_HOME:   /apps/tomcat</span><br><span class="line">Using CATALINA_TMPDIR: /apps/tomcat/temp</span><br><span class="line">Using JRE_HOME:        /usr/local/jdk/jre</span><br><span class="line">Using CLASSPATH:       /apps/tomcat/bin/bootstrap.jar:/apps/tomcat/bin/tomcat-juli.jar</span><br><span class="line">Tomcat started.</span><br><span class="line"></span><br><span class="line">[root@a21fcd34f711 /]<span class="comment"># exit</span></span><br><span class="line"><span class="built_in">exit</span></span><br><span class="line"></span><br><span class="line">[root@rocky8 tomcat-app1]<span class="comment"># curl 127.0.0.1:8080/app/</span></span><br><span class="line">Tomcat Page <span class="keyword">in</span> app1 v2</span><br></pre></td></tr></table></figure>

<h4 id="构建业务镜像2"><a href="#构建业务镜像2" class="headerlink" title="构建业务镜像2"></a>构建业务镜像2</h4><h5 id="准备自定义页面和其它数据"><a href="#准备自定义页面和其它数据" class="headerlink" title="准备自定义页面和其它数据"></a>准备自定义页面和其它数据</h5><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">[root@rocky8 tomcat]<span class="comment"># pwd</span></span><br><span class="line">/data/dockerfile/web/tomcat</span><br><span class="line"></span><br><span class="line">[root@rocky8 tomcat]<span class="comment"># cp -a tomcat-app1/* tomcat-app2/</span></span><br><span class="line">[root@rocky8 tomcat]<span class="comment"># tree tomcat-app2/</span></span><br><span class="line">tomcat-app2/</span><br><span class="line">├── app</span><br><span class="line">│   └── index.jsp</span><br><span class="line">├── app.tar.gz</span><br><span class="line">├── build.sh</span><br><span class="line">├── Dockerfile</span><br><span class="line">├── run_tomcat.sh</span><br><span class="line">└── server.xml</span><br><span class="line"></span><br><span class="line">1 directory, 6 files</span><br><span class="line"></span><br><span class="line">[root@rocky8 tomcat]<span class="comment"># cd tomcat-app2/</span></span><br><span class="line">[root@rocky8 tomcat-app2]<span class="comment"># vim app/index.jsp </span></span><br><span class="line">[root@rocky8 tomcat-app2]<span class="comment"># cat app/index.jsp</span></span><br><span class="line">Tomcat Page <span class="keyword">in</span> app2</span><br><span class="line"></span><br><span class="line">[root@rocky8 tomcat-app2]<span class="comment"># rm -rf app.tar.gz </span></span><br><span class="line">[root@rocky8 tomcat-app2]<span class="comment"># tar zcf app.tar.gz app</span></span><br></pre></td></tr></table></figure>

<h5 id="准备容器启动脚本run-tomcat-sh"><a href="#准备容器启动脚本run-tomcat-sh" class="headerlink" title="准备容器启动脚本run_tomcat.sh"></a>准备容器启动脚本run_tomcat.sh</h5><p>和业务1一样不变</p>
<h5 id="准备Dockerfile-1"><a href="#准备Dockerfile-1" class="headerlink" title="准备Dockerfile"></a>准备Dockerfile</h5><p>和业务1一样不变</p>
<h5 id="执行构建脚本制作镜像-2"><a href="#执行构建脚本制作镜像-2" class="headerlink" title="执行构建脚本制作镜像"></a>执行构建脚本制作镜像</h5><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[root@rocky8 tomcat-app2]<span class="comment"># vim build.sh </span></span><br><span class="line">[root@rocky8 tomcat-app2]<span class="comment"># cat build.sh</span></span><br><span class="line"><span class="comment">#!/bin/bash</span></span><br><span class="line">docker build -t tomcat-web:app2 .</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@rocky8 tomcat-app2]<span class="comment"># bash build.sh</span></span><br><span class="line">[root@rocky8 tomcat-app2]<span class="comment"># docker images tomcat-web:app2 </span></span><br><span class="line">REPOSITORY   TAG       IMAGE ID       CREATED          SIZE</span><br><span class="line">tomcat-web   app2      5f2fe69f2115   23 seconds ago   834MB</span><br></pre></td></tr></table></figure>

<h5 id="从镜像启动容器测试-1"><a href="#从镜像启动容器测试-1" class="headerlink" title="从镜像启动容器测试"></a>从镜像启动容器测试</h5><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@rocky8 tomcat-app2]<span class="comment"># docker run -d -p 8082:8080 tomcat-web:app2 </span></span><br><span class="line">65714811a3c2fff043aa44948ad16efc350a35da4192edb54c2a9200283db3e5</span><br></pre></td></tr></table></figure>

<h5 id="访问测试-3"><a href="#访问测试-3" class="headerlink" title="访问测试"></a>访问测试</h5><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@rocky8 tomcat-app2]<span class="comment"># curl 127.0.0.1:8082/app/</span></span><br><span class="line">Tomcat Page <span class="keyword">in</span> app2</span><br></pre></td></tr></table></figure>

<p>生产案例: 构建haproxy镜像</p>
<h4 id="准备相关文件"><a href="#准备相关文件" class="headerlink" title="准备相关文件"></a>准备相关文件</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#准备haproxy源码文件</span></span><br><span class="line">[root@rocky8 ~]<span class="comment"># mkdir -p /data/dockerfile/web/haproxy/2.1.2-centos7</span></span><br><span class="line">[root@rocky8 ~]<span class="comment"># cd /data/dockerfile/web/haproxy/2.1.2-centos7</span></span><br><span class="line">[root@rocky8 2.1.2-centos7]<span class="comment"># wget http://www.haproxy.org/download/2.1/src/haproxy-2.1.2.tar.gz</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#准备haproxy启动脚本</span></span><br><span class="line">[root@rocky8 2.1.2-centos7]<span class="comment"># vim run_haproxy.sh</span></span><br><span class="line">[root@rocky8 2.1.2-centos7]<span class="comment"># cat run_haproxy.sh</span></span><br><span class="line"><span class="comment">#!/bin/bash</span></span><br><span class="line">haproxy -f /etc/haproxy/haproxy.cfg</span><br><span class="line"><span class="built_in">tail</span> -f /etc/hosts</span><br><span class="line"></span><br><span class="line">[root@rocky8 2.1.2-centos7]<span class="comment"># chmod +x run_haproxy.sh</span></span><br></pre></td></tr></table></figure>

<h4 id="准备haproxy配置文件"><a href="#准备haproxy配置文件" class="headerlink" title="准备haproxy配置文件"></a>准备haproxy配置文件</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">[root@rocky8 2.1.2-centos7]<span class="comment"># vim haproxy.cfg</span></span><br><span class="line">[root@rocky8 2.1.2-centos7]<span class="comment"># cat haproxy.cfg</span></span><br><span class="line">global</span><br><span class="line"><span class="built_in">chroot</span> /apps/haproxy</span><br><span class="line"><span class="comment">#stats socket /var/lib/haproxy/haproxy.sock mode 600 level admin</span></span><br><span class="line">uid 99</span><br><span class="line">gid 99</span><br><span class="line">daemon</span><br><span class="line">nbproc 1</span><br><span class="line">pidfile /apps/haproxy/run/haproxy.pid</span><br><span class="line"><span class="built_in">log</span> 127.0.0.1 local3 info</span><br><span class="line">defaults</span><br><span class="line">option http-keep-alive</span><br><span class="line">option forwardfor</span><br><span class="line">mode http</span><br><span class="line"><span class="built_in">timeout</span> connect 300000ms</span><br><span class="line"><span class="built_in">timeout</span> client 300000ms</span><br><span class="line"><span class="built_in">timeout</span> server 300000ms</span><br><span class="line"></span><br><span class="line">listen stats</span><br><span class="line"> mode http</span><br><span class="line"> <span class="built_in">bind</span> 0.0.0.0:9999</span><br><span class="line"> stats <span class="built_in">enable</span></span><br><span class="line"> <span class="built_in">log</span> global</span><br><span class="line"> stats uri   /haproxy-status</span><br><span class="line"> stats auth haadmin:123456</span><br><span class="line"></span><br><span class="line">listen web_port</span><br><span class="line"> <span class="built_in">bind</span> 0.0.0.0:80</span><br><span class="line"> mode http</span><br><span class="line"> <span class="built_in">log</span> global</span><br><span class="line"> balance roundrobin</span><br><span class="line"> server web1 192.168.1.12:8080 check inter 3000 fall 2 rise 5</span><br><span class="line"> server web2 192.168.1.13:8080 check inter 3000 fall 2 rise 5</span><br></pre></td></tr></table></figure>

<h4 id="准备Dockerfile-2"><a href="#准备Dockerfile-2" class="headerlink" title="准备Dockerfile"></a>准备Dockerfile</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[root@rocky8 2.1.2-centos7]<span class="comment"># vim Dockerfile</span></span><br><span class="line">[root@rocky8 2.1.2-centos7]<span class="comment"># cat Dockerfile</span></span><br><span class="line">FROM centos7-base:v1</span><br><span class="line">LABEL maintainer=<span class="string">&quot;wshuaiqing.cn&quot;</span></span><br><span class="line">ADD haproxy-2.1.2.tar.gz /usr/local/src/</span><br><span class="line">RUN <span class="built_in">cd</span> /usr/local/src/haproxy-2.1.2 \</span><br><span class="line">	&amp;&amp; make ARCH=x86_64 TARGET=linux-glibc USE_PCRE=1 USE_OPENSSL=1 USE_ZLIB=1 USE_SYSTEMD=1 USE_CPU_AFFINITY=1 PREFIX=/apps/haproxy \</span><br><span class="line">	&amp;&amp; make install PREFIX=/apps/haproxy \</span><br><span class="line">	&amp;&amp; <span class="built_in">ln</span> -s /apps/haproxy/sbin/haproxy /usr/sbin/ \</span><br><span class="line">	&amp;&amp; <span class="built_in">mkdir</span> /apps/haproxy/run \</span><br><span class="line">	&amp;&amp; <span class="built_in">rm</span> -rf /usr/local/src/haproxy*</span><br><span class="line">ADD haproxy.cfg /etc/haproxy/</span><br><span class="line">ADD run_haproxy.sh /usr/bin</span><br><span class="line">EXPOSE 80 9999</span><br><span class="line">CMD [<span class="string">&quot;run_haproxy.sh&quot;</span>] </span><br></pre></td></tr></table></figure>

<h4 id="准备构建脚本构建haproxy镜像"><a href="#准备构建脚本构建haproxy镜像" class="headerlink" title="准备构建脚本构建haproxy镜像"></a>准备构建脚本构建haproxy镜像</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[root@rocky8 2.1.2-centos7]<span class="comment"># vim build.sh</span></span><br><span class="line">[root@rocky8 2.1.2-centos7]<span class="comment"># cat build.sh</span></span><br><span class="line"><span class="comment">#!/bin/bash</span></span><br><span class="line">docker build -t haproxy-centos7:2.1.2 .</span><br><span class="line"></span><br><span class="line">[root@rocky8 2.1.2-centos7]<span class="comment"># ls</span></span><br><span class="line">build.sh  Dockerfile  haproxy-2.1.2.tar.gz  haproxy.cfg  run_haproxy.sh</span><br><span class="line"></span><br><span class="line">[root@rocky8 2.1.2-centos7]<span class="comment"># bash build.sh</span></span><br><span class="line">[root@rocky8 2.1.2-centos7]<span class="comment"># docker images haproxy-centos7:2.1.2 </span></span><br><span class="line">REPOSITORY        TAG       IMAGE ID       CREATED          SIZE</span><br><span class="line">haproxy-centos7   2.1.2     02fcdab2f4db   10 minutes ago   460MB</span><br></pre></td></tr></table></figure>

<h4 id="从镜像启动容器"><a href="#从镜像启动容器" class="headerlink" title="从镜像启动容器"></a>从镜像启动容器</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@rocky8 2.1.2-centos7]<span class="comment"># docker run -d -p 80:80 -p 9999:9999 haproxy-centos7:2.1.2 </span></span><br><span class="line">7032ef4a9005920386b9cc7e6ccd053e10b46f38aef72c42861fc98b2b594e37</span><br><span class="line"></span><br><span class="line">[root@rocky8 2.1.2-centos7]<span class="comment"># docker ps -l</span></span><br><span class="line">CONTAINER ID   IMAGE                   COMMAND            CREATED          STATUS          PORTS                                                                          NAMES</span><br><span class="line">7032ef4a9005   haproxy-centos7:2.1.2   <span class="string">&quot;run_haproxy.sh&quot;</span>   13 seconds ago   Up 13 seconds   0.0.0.0:80-&gt;80/tcp, :::80-&gt;80/tcp, 0.0.0.0:9999-&gt;9999/tcp, :::9999-&gt;9999/tcp   affectionate_shannon</span><br></pre></td></tr></table></figure>

<h4 id="在另外两台主机启动容器"><a href="#在另外两台主机启动容器" class="headerlink" title="在另外两台主机启动容器"></a>在另外两台主机启动容器</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#导出本地相关镜像</span></span><br><span class="line">[root@rocky8 ~]<span class="comment"># docker save centos7-base:v2 -o /data/centos7-base.tar.gz</span></span><br><span class="line">[root@rocky8 ~]<span class="comment"># docker save centos7-jdk:8u441 -o /data/centos7-jdk.tar.gz</span></span><br><span class="line">[root@rocky8 ~]<span class="comment"># docker save tomcat-base:v8.5.50 -o /data/tomcat-base.tar.gz</span></span><br><span class="line">[root@rocky8 ~]<span class="comment"># docker save tomcat-web:app1 -o /data/tomcat-web-app1.tar.gz</span></span><br><span class="line">[root@rocky8 ~]<span class="comment"># docker save tomcat-web:app2 -o /data/tomcat-web-app2.tar.gz</span></span><br><span class="line">[root@rocky8 ~]<span class="comment"># ls /data/</span></span><br><span class="line">centos7-base.tar.gz  dockerfile          tomcat-web-app1.tar.gz</span><br><span class="line">centos7-jdk.tar.gz   tomcat-base.tar.gz  tomcat-web-app2.tar.gz</span><br><span class="line"></span><br><span class="line"><span class="comment">#将镜像复制到另外两台主机</span></span><br><span class="line">[root@rocky8 ~]<span class="comment"># scp /data/*.gz 192.168.1.12:/data/</span></span><br><span class="line">[root@rocky8 ~]<span class="comment"># scp /data/*.gz 192.168.1.13:/data/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#在另外两台主机上执行下面操作导入镜像</span></span><br><span class="line">[root@rocky8 ~]<span class="comment"># ls /data/</span></span><br><span class="line">centos7-base.tar.gz  tomcat-base.tar.gz      tomcat-web-app2.tar.gz</span><br><span class="line">centos7-jdk.tar.gz   tomcat-web-app1.tar.gz</span><br><span class="line"></span><br><span class="line">[root@rocky8 ~]<span class="comment"># for i in /data/*.gz;do docker load -i $i;done</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#在另外两台主机上创建相关容器</span></span><br><span class="line">[root@rocky8 ~]<span class="comment"># docker run -d -p 8080:8080 tomcat-web:app1 </span></span><br><span class="line">1ce807b8bde21115cacec3a3bede4233a584666b587b62779a78ec19107a53b0</span><br><span class="line"></span><br><span class="line">[root@rocky8 ~]<span class="comment"># docker run -d -p 8080:8080 tomcat-web:app2</span></span><br><span class="line">8d37533a827e502df3f5725d5e92ce6729d96a38426aae8fa44eccccba951314</span><br></pre></td></tr></table></figure>

<h4 id="web访问验证"><a href="#web访问验证" class="headerlink" title="web访问验证"></a>web访问验证</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">[root@rocky8 ~]<span class="comment"># curl 192.168.1.11/app/</span></span><br><span class="line">Tomcat Page <span class="keyword">in</span> app1</span><br><span class="line">[root@rocky8 ~]<span class="comment"># curl 192.168.1.11/app/</span></span><br><span class="line">Tomcat Page <span class="keyword">in</span> app2</span><br><span class="line">[root@rocky8 ~]<span class="comment"># curl 192.168.1.11/app/</span></span><br><span class="line">Tomcat Page <span class="keyword">in</span> app1</span><br><span class="line">[root@rocky8 ~]<span class="comment"># curl 192.168.1.11/app/</span></span><br><span class="line">Tomcat Page <span class="keyword">in</span> app2</span><br><span class="line"></span><br><span class="line">[root@rocky8 ~]<span class="comment"># docker exec -it 01e717 bash</span></span><br><span class="line">[root@01e717049173 /]<span class="comment"># netstat -ntl</span></span><br><span class="line">Active Internet connections (only servers)</span><br><span class="line">Proto Recv-Q Send-Q Local Address           Foreign Address         State      </span><br><span class="line">tcp        0      0 0.0.0.0:9999            0.0.0.0:*               LISTEN     </span><br><span class="line">tcp        0      0 0.0.0.0:80              0.0.0.0:*               LISTEN   </span><br><span class="line"></span><br><span class="line">[root@01e717049173 /]<span class="comment"># ps aux</span></span><br><span class="line">USER         PID %CPU %MEM    VSZ   RSS TTY      STAT START   TIME COMMAND</span><br><span class="line">root           1  0.0  0.0  11704  2664 ?        Ss   05:30   0:00 /bin/bash /usr/bin/run_haproxy.sh</span><br><span class="line">nobody         8  0.0  1.2 492416 73004 ?        Ssl  05:30   0:00 haproxy -f /etc/haproxy/haproxy.cfg</span><br><span class="line">root           9  0.0  0.0   4420   760 ?        S    05:30   0:00 <span class="built_in">tail</span> -f /etc/hosts</span><br><span class="line">root          14  0.0  0.0  12368  3596 pts/0    Ss   05:31   0:00 bash</span><br><span class="line">root          36  0.0  0.0  51772  3564 pts/0    R+   05:32   0:00 ps aux</span><br></pre></td></tr></table></figure>

<p><img src="../../../../images/SRE/day46/41.jpg" alt="41"></p>
<p><img src="../../../../images/SRE/day46/42.jpg" alt="42"></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#在第二台主机上停止容器</span></span><br><span class="line">[root@rocky8 ~]<span class="comment"># docker stop 8d37533a827e</span></span><br><span class="line">8d37533a827e</span><br><span class="line"></span><br><span class="line">[root@rocky8 ~]<span class="comment"># docker ps -a</span></span><br><span class="line">CONTAINER ID   IMAGE             COMMAND                  CREATED          STATUS                       PORTS     NAMES</span><br><span class="line">8d37533a827e   tomcat-web:app2   <span class="string">&quot;/apps/tomcat/bin/ru…&quot;</span>   11 minutes ago   Exited (137) 3 seconds ago             eager_hermann</span><br><span class="line"></span><br><span class="line"><span class="comment">#观察状态页，发现后端服务器down</span></span><br></pre></td></tr></table></figure>

<p><img src="../../../../images/SRE/day46/43.jpg" alt="43"></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#在第二台主机上恢复启动容器</span></span><br><span class="line">[root@rocky8 ~]<span class="comment"># docker start 8d37533a827e</span></span><br><span class="line">8d37533a827e</span><br><span class="line"></span><br><span class="line">[root@rocky8 ~]<span class="comment"># docker ps</span></span><br><span class="line">CONTAINER ID   IMAGE             COMMAND                  CREATED          STATUS         PORTS                                                 NAMES</span><br><span class="line">8d37533a827e   tomcat-web:app2   <span class="string">&quot;/apps/tomcat/bin/ru…&quot;</span>   12 minutes ago   Up 3 seconds   8009/tcp, 0.0.0.0:8080-&gt;8080/tcp, :::8080-&gt;8080/tcp   eager_hermann</span><br><span class="line"></span><br><span class="line"><span class="comment">#再次观察状态页，发现后端服务器上线</span></span><br></pre></td></tr></table></figure>

<p><img src="../../../../images/SRE/day46/44.jpg" alt="44"></p>
<h3 id="生产案例-基于-Alpine-基础镜像制作-Nginx-镜像"><a href="#生产案例-基于-Alpine-基础镜像制作-Nginx-镜像" class="headerlink" title="生产案例: 基于 Alpine 基础镜像制作 Nginx 镜像"></a>生产案例: 基于 Alpine 基础镜像制作 Nginx 镜像</h3><h4 id="制作-Alpine-的自定义系统镜像"><a href="#制作-Alpine-的自定义系统镜像" class="headerlink" title="制作 Alpine 的自定义系统镜像"></a>制作 Alpine 的自定义系统镜像</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#下载alpine镜像,打新标签</span></span><br><span class="line">[root@rocky8 ~]<span class="comment"># docker pull alpine</span></span><br><span class="line">[root@rocky8 ~]<span class="comment"># docker history alpine:latest </span></span><br><span class="line">IMAGE          CREATED       CREATED BY                                      SIZE      COMMENT</span><br><span class="line">aded1e1a5b37   7 weeks ago   CMD [<span class="string">&quot;/bin/sh&quot;</span>]                                 0B        buildkit.dockerfile.v0</span><br><span class="line">&lt;missing&gt;      7 weeks ago   ADD alpine-minirootfs-3.21.3-x86_64.tar.gz /…   7.83MB    buildkit.dockerfile.v0</span><br><span class="line"></span><br><span class="line">[root@rocky8 ~]<span class="comment"># docker tag alpine:latest alpine:3.21</span></span><br><span class="line">[root@rocky8 ~]<span class="comment"># docker images alpine</span></span><br><span class="line">REPOSITORY   TAG       IMAGE ID       CREATED       SIZE</span><br><span class="line">alpine       3.21      aded1e1a5b37   7 weeks ago   7.83MB</span><br><span class="line">alpine       latest    aded1e1a5b37   7 weeks ago   7.83MB</span><br><span class="line"></span><br><span class="line"><span class="comment">#准备相关文件</span></span><br><span class="line">[root@rocky8 ~]<span class="comment"># cd /data/dockerfile/system/alpine/</span></span><br><span class="line">[root@rocky8 alpine]<span class="comment"># vim repositories</span></span><br><span class="line">[root@rocky8 alpine]<span class="comment"># cat repositories</span></span><br><span class="line">http://mirrors.aliyun.com/alpine/v3.21/main</span><br><span class="line">http://mirrors.aliyun.com/alpine/v3.21/community</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#准备Dockerfile文件</span></span><br><span class="line">[root@rocky8 alpine]<span class="comment"># vim Dockerfile</span></span><br><span class="line">[root@rocky8 alpine]<span class="comment"># cat Dockerfile </span></span><br><span class="line">FROM alpine:3.21</span><br><span class="line">LABEL maintainer=<span class="string">&quot;wshuaiqing.cn&quot;</span></span><br><span class="line">COPY repositories /etc/apk/repositories</span><br><span class="line">RUN apk update &amp;&amp; apk --no-cache add \</span><br><span class="line">    iotop net-tools pstree wget zip unzip iproute2 \</span><br><span class="line">    gcc libgcc musl-dev make \</span><br><span class="line">    curl-dev libevent libevent-dev \</span><br><span class="line">    libnfs zlib-dev pcre-dev pcre pcre2</span><br><span class="line"></span><br><span class="line">	</span><br><span class="line"><span class="comment">#准备构建脚本</span></span><br><span class="line">[root@rocky8 alpine]<span class="comment"># vim build.sh</span></span><br><span class="line">[root@rocky8 alpine]<span class="comment"># cat build.sh</span></span><br><span class="line"><span class="comment">#!/bin/bash</span></span><br><span class="line">docker build -t alpine-base:3.21 .</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@rocky8 alpine]<span class="comment"># bash build.sh</span></span><br><span class="line">[root@rocky8 alpine]<span class="comment"># docker images alpine*</span></span><br><span class="line">REPOSITORY    TAG       IMAGE ID       CREATED          SIZE</span><br><span class="line">alpine-base   3.21      4cbc214985ab   40 seconds ago   238MB</span><br><span class="line">alpine        3.21      aded1e1a5b37   7 weeks ago      7.83MB</span><br><span class="line">alpine        latest    aded1e1a5b37   7 weeks ago      7.83MB</span><br></pre></td></tr></table></figure>

<h4 id="制作基于-Alpine-自定义镜像的-Nginx-镜像"><a href="#制作基于-Alpine-自定义镜像的-Nginx-镜像" class="headerlink" title="制作基于 Alpine 自定义镜像的 Nginx 镜像"></a>制作基于 Alpine 自定义镜像的 Nginx 镜像</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#准备相关文件</span></span><br><span class="line">[root@rocky8 alpine]<span class="comment"># mkdir /data/dockerfile/web/nginx/1.16.1-alpine/</span></span><br><span class="line">[root@rocky8 alpine]<span class="comment"># cd /data/dockerfile/web/nginx/1.16.1-alpine/</span></span><br><span class="line">[root@rocky8 1.16.1-alpine]<span class="comment"># wget http://nginx.org/download/nginx-1.16.1.tar.gz</span></span><br><span class="line">[root@rocky8 1.16.1-alpine]<span class="comment"># echo Test Page based nginx-alpine &gt; index.html</span></span><br><span class="line">[root@rocky8 1.16.1-alpine]<span class="comment"># tar xf nginx-1.16.1.tar.gz </span></span><br><span class="line">[root@rocky8 1.16.1-alpine]<span class="comment"># cp nginx-1.16.1/conf/nginx.conf .</span></span><br><span class="line">[root@rocky8 1.16.1-alpine]<span class="comment"># rm -rf nginx-1.16.1</span></span><br><span class="line">[root@rocky8 1.16.1-alpine]<span class="comment"># vim nginx.conf </span></span><br><span class="line">user  nginx;</span><br><span class="line">worker_processes  1;</span><br><span class="line">daemon off;</span><br><span class="line"></span><br><span class="line"><span class="comment">#编写Dockerfile文件</span></span><br><span class="line">[root@rocky8 1.16.1-alpine]<span class="comment"># vim Dockerfile</span></span><br><span class="line">[root@rocky8 1.16.1-alpine]<span class="comment"># cat Dockerfile </span></span><br><span class="line">FROM alpine-base:3.21</span><br><span class="line">LABEL maintainer=<span class="string">&quot;wshuaiqing.cn&quot;</span></span><br><span class="line">ADD nginx-1.16.1.tar.gz /usr/local/src/</span><br><span class="line">RUN <span class="built_in">cd</span> /usr/local/src/nginx-1.16.1 &amp;&amp; ./configure  --prefix=/apps/nginx &amp;&amp; make \</span><br><span class="line">&amp;&amp; make install &amp;&amp; <span class="built_in">ln</span> -s /apps/nginx/sbin/nginx /usr/bin/</span><br><span class="line">RUN addgroup  -g 2019 -S nginx &amp;&amp; adduser  -s /sbin/nologin -S -D  -u 2019 -G nginx nginx</span><br><span class="line">COPY nginx.conf /apps/nginx/conf/nginx.conf </span><br><span class="line">ADD index.html /apps/nginx/html/index.html</span><br><span class="line">RUN <span class="built_in">chown</span> -R nginx:nginx /apps/nginx/</span><br><span class="line">EXPOSE 80 443</span><br><span class="line">CMD [<span class="string">&quot;nginx&quot;</span>] </span><br><span class="line"></span><br><span class="line"><span class="comment">#构建镜像</span></span><br><span class="line">[root@rocky8 1.16.1-alpine]<span class="comment"># cat build.sh</span></span><br><span class="line"><span class="comment">#!/bin/bash</span></span><br><span class="line">docker build -t nginx-alpine:1.16.1 .</span><br><span class="line"></span><br><span class="line">[root@rocky8 1.16.1-alpine]<span class="comment"># bash build.sh</span></span><br><span class="line">[root@rocky8 1.16.1-alpine]<span class="comment"># docker images nginx-alpine</span></span><br><span class="line">REPOSITORY     TAG       IMAGE ID       CREATED          SIZE</span><br><span class="line">nginx-alpine   1.16.1    e750a0c3b172   27 seconds ago   262MB</span><br><span class="line"></span><br><span class="line"><span class="comment">#生成容器测试镜像</span></span><br><span class="line">[root@rocky8 1.16.1-alpine]<span class="comment"># docker run -d -p 80:80 nginx-alpine:1.16.1 0338dec04d3327718af273dd4ae29497f8e714da76c7c0a5eb052be513bf6968</span></span><br><span class="line">[root@rocky8 1.16.1-alpine]<span class="comment"># curl 127.0.0.1</span></span><br><span class="line">Test Page based nginx-alpine</span><br></pre></td></tr></table></figure>

<h3 id="生产案例-基于-Ubuntu-基础镜像制作-Nginx-镜像"><a href="#生产案例-基于-Ubuntu-基础镜像制作-Nginx-镜像" class="headerlink" title="生产案例: 基于 Ubuntu 基础镜像制作 Nginx 镜像"></a>生产案例: 基于 Ubuntu 基础镜像制作 Nginx 镜像</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#下载ubuntu1804镜像</span></span><br><span class="line">[root@rocky8 ~]<span class="comment"># docker pull ubuntu:18.04</span></span><br><span class="line">[root@rocky8 ~]<span class="comment"># docker images ubuntu*</span></span><br><span class="line">REPOSITORY   TAG       IMAGE ID       CREATED         SIZE</span><br><span class="line">ubuntu       18.04     f9a80a55f492   22 months ago   63.2MB</span><br><span class="line"></span><br><span class="line"><span class="comment">#准备相关文件</span></span><br><span class="line">[root@rocky8 ~]<span class="comment"># mkdir /data/dockerfile/web/nginx/1.16.1-ubuntu1804</span></span><br><span class="line">[root@rocky8 ~]<span class="comment"># cd /data/dockerfile/web/nginx/1.16.1-ubuntu1804</span></span><br><span class="line">[root@rocky8 1.16.1-ubuntu1804]<span class="comment"># vim sources.list</span></span><br><span class="line">[root@rocky8 1.16.1-ubuntu1804]<span class="comment"># cat sources.list </span></span><br><span class="line">deb http://mirrors.aliyun.com/ubuntu/ bionic main restricted universe mul</span><br><span class="line">deb-src http://mirrors.aliyun.com/ubuntu/ bionic main restricted universe</span><br><span class="line"></span><br><span class="line">deb http://mirrors.aliyun.com/ubuntu/ bionic-security main restricted uni</span><br><span class="line">deb-src http://mirrors.aliyun.com/ubuntu/ bionic-security main restricted</span><br><span class="line"></span><br><span class="line">deb http://mirrors.aliyun.com/ubuntu/ bionic-updates main restricted univ</span><br><span class="line">deb-src http://mirrors.aliyun.com/ubuntu/ bionic-updates main restricted </span><br><span class="line"></span><br><span class="line">deb http://mirrors.aliyun.com/ubuntu/ bionic-proposed main restricted uni</span><br><span class="line">deb-src http://mirrors.aliyun.com/ubuntu/ bionic-proposed main restricted</span><br><span class="line"></span><br><span class="line">deb http://mirrors.aliyun.com/ubuntu/ bionic-backports main restricted un</span><br><span class="line">deb-src http://mirrors.aliyun.com/ubuntu/ bionic-backports main restricte</span><br><span class="line"></span><br><span class="line">[root@rocky8 1.16.1-ubuntu1804]<span class="comment"># wget http://nginx.org/download/nginx-1.16.1.tar.gz</span></span><br><span class="line">[root@rocky8 1.16.1-ubuntu1804]<span class="comment"># cp ../1.16.1-alpine/nginx.conf .</span></span><br><span class="line">[root@rocky8 1.16.1-ubuntu1804]<span class="comment"># cat nginx.conf </span></span><br><span class="line">user  nginx;</span><br><span class="line">worker_processes  1;</span><br><span class="line">daemon off;</span><br><span class="line"></span><br><span class="line">[root@rocky8 1.16.1-ubuntu1804]<span class="comment"># echo Test Page based nginx-ubuntu1804 &gt; index.html</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#编写Dockerfile文件</span></span><br><span class="line">[root@rocky8 1.16.1-ubuntu1804]<span class="comment"># vim Dockerfile</span></span><br><span class="line">[root@rocky8 1.16.1-ubuntu1804]<span class="comment"># cat Dockerfile</span></span><br><span class="line">FROM ubuntu:18.04</span><br><span class="line">LABEL maintainer=<span class="string">&quot;wshuaiqing.cn&quot;</span></span><br><span class="line">COPY sources.list /etc/apt/sources.list</span><br><span class="line">RUN apt update &amp;&amp; apt install -y \</span><br><span class="line">    ca-certificates lrzsz tree unzip zip \</span><br><span class="line">    gcc make \</span><br><span class="line">    openssh-server nfs-kernel-server nfs-common \</span><br><span class="line">    openssl libssl-dev zlib1g-dev \</span><br><span class="line">    libpcre3 libpcre3-dev</span><br><span class="line">ADD nginx-1.16.1.tar.gz /usr/local/src</span><br><span class="line">RUN <span class="built_in">cd</span> /usr/local/src/nginx-1.16.1 &amp;&amp; ./configure --prefix=/apps/nginx &amp;&amp; make \</span><br><span class="line">    &amp;&amp; make install &amp;&amp; <span class="built_in">ln</span> -s /apps/nginx/sbin/nginx /usr/bin &amp;&amp; <span class="built_in">rm</span>  -rf /usr/local/src/nginx-1.16.1*</span><br><span class="line">ADD nginx.conf /apps/nginx/conf/nginx.conf</span><br><span class="line">ADD index.html /apps/nginx/html/index.html</span><br><span class="line">RUN groupadd  -g 2019 nginx &amp;&amp; useradd  -g nginx -s /usr/sbin/nologin -u 2019 nginx \</span><br><span class="line">    &amp;&amp; <span class="built_in">chown</span> -R nginx.nginx /apps/nginx</span><br><span class="line">EXPOSE 80 443</span><br><span class="line">CMD [<span class="string">&quot;nginx&quot;</span>]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#构建镜像</span></span><br><span class="line">[root@rocky8 1.16.1-ubuntu1804]<span class="comment"># vim build.sh</span></span><br><span class="line">[root@rocky8 1.16.1-ubuntu1804]<span class="comment"># cat build.sh</span></span><br><span class="line"><span class="comment">#!/bin/bash</span></span><br><span class="line">docker build -t nginx-ubuntu1804:1.16.1 .</span><br><span class="line"></span><br><span class="line">[root@rocky8 1.16.1-ubuntu1804]<span class="comment"># ls</span></span><br><span class="line">build.sh    index.html           nginx.conf</span><br><span class="line">Dockerfile  nginx-1.16.1.tar.gz  sources.list</span><br><span class="line"></span><br><span class="line">[root@rocky8 1.16.1-ubuntu1804]<span class="comment"># bash build.sh </span></span><br><span class="line">[root@rocky8 1.16.1-ubuntu1804]<span class="comment"># docker images nginx-ubuntu1804</span></span><br><span class="line">REPOSITORY         TAG       IMAGE ID       CREATED         SIZE</span><br><span class="line">nginx-ubuntu1804   1.16.1    7d7aa6c8e4ef   3 minutes ago   394MB</span><br><span class="line"></span><br><span class="line"><span class="comment">#启动容器测试镜像</span></span><br><span class="line">[root@rocky8 1.16.1-ubuntu1804]<span class="comment"># docker run -d -p 80:80 nginx-ubuntu1804:1.16.1 </span></span><br><span class="line">a0e60f7059745ab55e9f724f38ad7b65f540d368bd9b9851fef2e901b54037d0</span><br><span class="line"></span><br><span class="line">[root@rocky8 1.16.1-ubuntu1804]<span class="comment"># curl 127.0.0.1</span></span><br><span class="line">Test Page based nginx-ubuntu1804</span><br></pre></td></tr></table></figure>

<h1 id="Docker-数据管理"><a href="#Docker-数据管理" class="headerlink" title="Docker 数据管理"></a>Docker 数据管理</h1><p><img src="../../../../images/SRE/day46/45.jpg" alt="45"></p>
<p>Docker镜像由多个只读层叠加而成，启动容器时，Docker会加载只读镜像层并在镜像栈顶部添加一个读写层</p>
<p>如果运行中的容器修改了现有的一个已经存在的文件，那该文件将会从读写层下面的只读层复制到读写层，该文件的只读版本仍然存在，只是已经被读写层中该文件的副本所隐藏，此即“写时复制(COW copy on write)”机制</p>
<p>如果将正在运行中的容器修改生成了新的数据，那么新产生的数据将会被复制到读写层，进行持久化保存，这个读写层也就是容器的工作目录，也为写时复制(COW) 机制。</p>
<p>COW机制节约空间,但会导致性低下,虽然关闭重启容器,数据不受影响,但会随着容器的删除,其对应的可写层也会随之而删除,即数据也会丢失.如果容器需要持久保存数据,并不影响性能可以用数据卷技术实现</p>
<p>如下图是将对根的数据写入到了容器的可写层，但是把/data 中的数据写入到了一个另外的volume 中用于数据持久化</p>
<p><img src="../../../../images/SRE/day46/46.jpg" alt="46"></p>
<h2 id="容器的数据管理介绍"><a href="#容器的数据管理介绍" class="headerlink" title="容器的数据管理介绍"></a>容器的数据管理介绍</h2><p>Docker镜像是分层设计的，镜像层是只读的，通过镜像启动的容器添加了一层可读写的文件系统，用户写入的数据都保存在这一层中。</p>
<h3 id="Docker容器的分层"><a href="#Docker容器的分层" class="headerlink" title="Docker容器的分层"></a>Docker容器的分层</h3><p>容器的数据分层目录</p>
<ul>
<li>LowerDir: image 镜像层,即镜像本身，只读</li>
<li>UpperDir: 容器的上层,可读写 ,容器变化的数据存放在此处</li>
<li>MergedDir: 容器的文件系统，使用Union FS（联合文件系统）将lowerdir 和 upperdir 合并完成后给容器使用,最终呈现给用户的统一视图</li>
<li>WorkDir: 容器在宿主机的工作目录,挂载后内容会被清空，且在使用过程中其内容用户不可见</li>
</ul>
<p>范例: 查看指定容器数据分层</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">[root@rocky8 ~]<span class="comment"># docker inspect aded1e1a5b37</span></span><br><span class="line">                <span class="string">&quot;MergedDir&quot;</span>: <span class="string">&quot;/var/lib/docker/overlay2/7f4c0529efeac793e40f797caf266129cd2a47e7353421e123db0e413c4f7304/merged&quot;</span>,</span><br><span class="line">                <span class="string">&quot;UpperDir&quot;</span>: <span class="string">&quot;/var/lib/docker/overlay2/7f4c0529efeac793e40f797caf266129cd2a47e7353421e123db0e413c4f7304/diff&quot;</span>,</span><br><span class="line">                <span class="string">&quot;WorkDir&quot;</span>: <span class="string">&quot;/var/lib/docker/overlay2/7f4c0529efeac793e40f797caf266129cd2a47e7353421e123db0e413c4f7304/work&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@rocky8 ~]<span class="comment"># ll -i /var/lib/docker/overlay2/7f4c0529efeac793e40f797caf266129cd2a47e7353421e123db0e413c4f7304</span></span><br><span class="line">total 8</span><br><span class="line"> 69311616 -rw-------  1 root root    0 Apr 10 05:52 committed</span><br><span class="line">101962085 drwxr-xr-x 19 root root 4096 Apr  8 19:49 diff</span><br><span class="line"> 68334207 -rw-r--r--  1 root root   26 Apr  8 19:49 <span class="built_in">link</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@rocky8 ~]<span class="comment"># mount</span></span><br><span class="line">overlay on /var/lib/docker/overlay2/262df7accd0cfc5a9419c286311d5aa2227036d46f53c90fae3f335a8035bd92/merged <span class="built_in">type</span> overlay (rw,relatime,lowerdir=/var/lib/docker/overlay2/l/XSKSD5QI45KMGQLHL2SPMZZWE5:/var/lib/docker/overlay2/l/R3QW44B3Y7JFMBAW7OQ2SAHXAI,upperdir=/var/lib/docker/overlay2/262df7accd0cfc5a9419c286311d5aa2227036d46f53c90fae3f335a8035bd92/diff,workdir=/var/lib/docker/overlay2/262df7accd0cfc5a9419c286311d5aa2227036d46f53c90fae3f335a8035bd92/work)</span><br><span class="line">nsfs on /run/docker/netns/9d7642d20c01 <span class="built_in">type</span> nsfs (rw)</span><br></pre></td></tr></table></figure>

<h3 id="哪些数据需要持久化"><a href="#哪些数据需要持久化" class="headerlink" title="哪些数据需要持久化"></a>哪些数据需要持久化</h3><p><strong>有状态的协议</strong></p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">有状态协议就是就通信双方要记住双方，并且共享一些信息。而无状态协议的通信每次都是独立的，与上一次的通信没什么关系。</span><br><span class="line">&quot;状态”可以理解为“记忆”，有状态对应有记忆，无状态对应无记忆</span><br></pre></td></tr></table></figure>

<p><img src="../../../../images/SRE/day46/47.jpg" alt="47"></p>
<ul>
<li>下层是无状态的http请求服务，上层为有状态</li>
<li>左侧为不需要存储的服务，右侧为需要存储的部分服务</li>
</ul>
<h3 id="容器数据持久保存方式"><a href="#容器数据持久保存方式" class="headerlink" title="容器数据持久保存方式"></a>容器数据持久保存方式</h3><p>如果要将写入到容器的数据永久保存，则需要将容器中的数据保存到宿主机的指定目录</p>
<p>Docker的数据类型分为两种: </p>
<ul>
<li>数据卷(Data Volume): 直接将宿主机目录挂载至容器的指定的目录 ，推荐使用此种方式，此方式较常用</li>
<li>数据卷容器(Data Volume Container): 间接使用宿主机空间，数据卷容器是将宿主机的目录挂载至一个专门的数据卷容器，然后让其他容器通过数据卷容器读写宿主机的数据 ，此方式不常用</li>
</ul>
<p><img src="../../../../images/SRE/day46/48.jpg" alt="48"></p>
<h2 id="数据卷-data-volume"><a href="#数据卷-data-volume" class="headerlink" title="数据卷(data volume)"></a>数据卷(data volume)</h2><h3 id="数据卷特点和使用"><a href="#数据卷特点和使用" class="headerlink" title="数据卷特点和使用"></a>数据卷特点和使用</h3><p>数据卷实际上就是宿主机上的目录或者是文件，可以被直接mount到容器当中使用 </p>
<p>实际生成环境中，需要针对不同类型的服务、不同类型的数据存储要求做相应的规划，最终保证服务的可扩展性、稳定性以及数据的安全性</p>
<h4 id="数据卷使用场景"><a href="#数据卷使用场景" class="headerlink" title="数据卷使用场景"></a>数据卷使用场景</h4><ul>
<li>数据库</li>
<li>日志输出</li>
<li>静态web页面</li>
<li>应用配置文件</li>
<li>多容器间目录或文件共享</li>
</ul>
<h4 id="数据卷的特点"><a href="#数据卷的特点" class="headerlink" title="数据卷的特点"></a>数据卷的特点</h4><ul>
<li>数据卷是目录或者文件，并且可以在多个容器之间共同使用,实现容器之间共享和重用</li>
<li>对数据卷更改数据在所有容器里面会立即更新。</li>
<li>数据卷的数据可以持久保存，即使删除使用使用该容器卷的容器也不影响。 </li>
<li>在容器里面的写入数据不会影响到镜像本身,即数据卷的变化不会影响镜像的更新</li>
<li>依赖于宿主机目录，宿主机出问题，上面容器会受影响，当宿主机较多时，不方便统一管理</li>
<li>匿名和命名数据卷在容器启动时初始化，如果容器使用的镜像在挂载点包含了数据，会拷贝到新初始化的数据卷中</li>
</ul>
<h4 id="数据卷分类"><a href="#数据卷分类" class="headerlink" title="数据卷分类"></a>数据卷分类</h4><p>启动容器时，可以指定使用数据卷实现容器数据的持久化,数据卷有三种</p>
<ul>
<li>指定宿主机目录或文件: 指定宿主机的具体路径和容器路径的挂载关系，此方式不会创建数据卷</li>
<li>匿名卷: 不指定数据名称,只指定容器内目录路径充当挂载点,docker自动指定宿主机的路径进行挂载，此方式会创建匿名数据卷,Dockerfile中VOLUME指定的卷即为此种</li>
<li>命名卷: 指定数据卷的名称和容器路径的挂载关系，此方式会创建命名数据卷</li>
</ul>
<h4 id="数据卷使用方法"><a href="#数据卷使用方法" class="headerlink" title="数据卷使用方法"></a>数据卷使用方法</h4><p>docker run 命令的以下格式可以实现数据卷</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">-v, --volume=[host-src:]container-dest[:&lt;options&gt;]</span><br><span class="line"></span><br><span class="line">&lt;options&gt;</span><br><span class="line">ro 从容器内对此数据卷是只读，不写此项默认为可读可写</span><br><span class="line">rw 从容器内对此数据卷可读可写,此为默认值</span><br></pre></td></tr></table></figure>

<p><strong>方式1</strong></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#指定宿主机目录或文件格式: </span></span><br><span class="line">-v   &lt;宿主机绝对路径的目录或文件&gt;:&lt;容器目录或文件&gt;[:ro]  <span class="comment">#将宿主机目录挂载容器目录，两个目录都可自动创建</span></span><br></pre></td></tr></table></figure>

<p><strong>方式2</strong></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#匿名卷,只指定容器内路径,没有指定宿主机路径信息,宿主机自动生成/var/lib/docker/volumes/&lt;卷ID&gt;/_data目录,并挂载至容器指定路径</span></span><br><span class="line">-v &lt;容器内路径&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment">#示例:</span></span><br><span class="line">docker run --name nginx -v /etc/nginx nginx</span><br></pre></td></tr></table></figure>

<p><strong>方式3</strong></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#命名卷将固定的存放在/var/lib/docker/volumes/&lt;卷名&gt;/_data</span></span><br><span class="line">-v &lt;卷名&gt;:&lt;容器目录路径&gt;</span><br><span class="line"><span class="comment">#可以通过以下命令事先创建,如可没有事先创建卷名,docker run时也会自动创建卷</span></span><br><span class="line">docker volume create &lt;卷名&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment">#示例:</span></span><br><span class="line">docker volume create vol1  <span class="comment">#也可以事先不创建</span></span><br><span class="line">docker run -d  -p 80:80 --name nginx01 -v vol1:/usr/share/nginx/html nginx</span><br></pre></td></tr></table></figure>

<p><strong>docker rm 的 -v 选项可以删除容器时，同时删除相关联的匿名卷</strong></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-v, --volumes   Remove the volumes associated with the container</span><br></pre></td></tr></table></figure>

<p><strong>管理数据卷命令</strong></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">docker volume COMMAND</span><br><span class="line"></span><br><span class="line">Commands:</span><br><span class="line">  create      Create a volume</span><br><span class="line">  inspect     Display detailed information on one or more volumes</span><br><span class="line">  <span class="built_in">ls</span>          List volumes</span><br><span class="line">  prune       Remove all unused <span class="built_in">local</span> volumes</span><br><span class="line">  <span class="built_in">rm</span>          Remove one or more volumes</span><br></pre></td></tr></table></figure>

<p><strong>查看数据卷的挂载关系</strong></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker inspect --format=<span class="string">&quot;&#123;&#123;.Mounts&#125;&#125;&quot;</span> &lt;容器ID&gt;</span><br></pre></td></tr></table></figure>

<p>范例: 删除所有数据卷</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@ubuntu1804 ~]<span class="comment"># docker volume rm `docker volume ls -q`</span></span><br></pre></td></tr></table></figure>

<p>范例：创建命名卷并删除</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">[root@ubuntu1804 ~]<span class="comment">#docker volume create mysql-vol</span></span><br><span class="line">mysql-vol</span><br><span class="line"></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment">#docker volume ls</span></span><br><span class="line">DRIVER             VOLUME NAME</span><br><span class="line"><span class="built_in">local</span>               mysql-vol</span><br><span class="line"></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment">#tree /var/lib/docker/volumes/</span></span><br><span class="line">/var/lib/docker/volumes/</span><br><span class="line">├── metadata.db</span><br><span class="line">└── mysql-vol</span><br><span class="line">   └── _data</span><br><span class="line">   </span><br><span class="line">2 directories, 1 file</span><br><span class="line"></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment">#docker volume rm mysql-vol </span></span><br><span class="line">mysql-vol</span><br><span class="line"></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment">#docker volume ls</span></span><br><span class="line">DRIVER             VOLUME NAME</span><br></pre></td></tr></table></figure>

<p>范例：删除不再使用的数据卷</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[root@ubuntu1804 ~]<span class="comment">#docker volume ls</span></span><br><span class="line">DRIVER             VOLUME NAME</span><br><span class="line"><span class="built_in">local</span>              897bd48c5c5e2067627d5c6d10dad17d4793132a638986c16f36820663728ee1</span><br><span class="line"></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment">#docker volume prune -f</span></span><br><span class="line">Deleted Volumes:</span><br><span class="line">897bd48c5c5e2067627d5c6d10dad17d4793132a638986c16f36820663728ee1</span><br><span class="line">Total reclaimed space: 219.5MB</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment">#docker volume ls</span></span><br><span class="line">DRIVER             VOLUME NAME</span><br></pre></td></tr></table></figure>

<p><strong>关于匿名数据卷和命名数据卷</strong></p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">命名卷就是有名字的卷，使用 docker volume create &lt;卷名&gt; 形式创建并命名的卷；而匿名卷就是没名</span><br><span class="line">字的卷，一般是 docker run -v /data 这种不指定卷名的时候所产生，或者 Dockerfile 里面的定义直接使用的。</span><br><span class="line"></span><br><span class="line">有名字的卷，在用过一次后，以后挂载容器的时候还可以使用，因为有名字可以指定。所以一般需要保存的数据使用命名卷保存。</span><br><span class="line">而匿名卷则是随着容器建立而建立，随着容器消亡而淹没于卷列表中（对于 docker run 匿名卷不会被自动</span><br><span class="line">删除）。 因此匿名卷只存放无关紧要的临时数据，随着容器消亡，这些数据将失去存在的意义。</span><br><span class="line"></span><br><span class="line">Dockerfile中指定VOLUME为匿名数据卷,其目的只是为了将某个路径确定为卷。</span><br><span class="line"></span><br><span class="line">按照最佳实践的要求，不应该在容器存储层内进行数据写入操作，所有写入应该使用卷。如果定制镜像的时</span><br><span class="line">候，就可以确定某些目录会发生频繁大量的读写操作，那么为了避免在运行时由于用户疏忽而忘记指定卷，导</span><br><span class="line">致容器发生存储层写入的问题，就可以在 Dockerfile 中使用 VOLUME 来指定某些目录为匿名卷。这样即使用户忘记了指定卷，也不会产生不良的后果。</span><br><span class="line">这个设置可以在运行时覆盖。通过 docker run 的 -v 参数或者 docker-compose.yml 的 volumes </span><br><span class="line">指定。使用命名卷的好处是可以复用，其它容器可以通过这个命名数据卷的名字来指定挂载，共享其内容（不过要注意并发访问的竞争问题）。</span><br><span class="line"></span><br><span class="line">比如，Dockerfile 中说 VOLUME /data，那么如果直接 docker run，其 /data 就会被挂载为匿名</span><br><span class="line">卷，向 /data 写入的操作不会写入到容器存储层，而是写入到了匿名卷中。但是如果运行时 docker run </span><br><span class="line">-v mydata:/data，这就覆盖了 /data 的挂载设置，要求将 /data 挂载到名为 mydata 的命名卷中。</span><br><span class="line">所以说 Dockerfile 中的 VOLUME 实际上是一层保险，确保镜像运行可以更好的遵循最佳实践，不向容器存储层内进行写入操作。</span><br><span class="line"></span><br><span class="line">数据卷默认可能会保存于 /var/lib/docker/volumes，不过一般不需要、也不应该访问这个位置。</span><br></pre></td></tr></table></figure>

<h3 id="实战案例-目录数据卷"><a href="#实战案例-目录数据卷" class="headerlink" title="实战案例: 目录数据卷"></a>实战案例: 目录数据卷</h3><h4 id="在宿主机创建容器所使用的目录"><a href="#在宿主机创建容器所使用的目录" class="headerlink" title="在宿主机创建容器所使用的目录"></a>在宿主机创建容器所使用的目录</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@rocky8 ~]<span class="comment"># mkdir /data/testdir</span></span><br><span class="line">[root@rocky8 ~]<span class="comment"># echo Test page on host &gt; /data/testdir/index.html </span></span><br></pre></td></tr></table></figure>

<h4 id="查看容器相关目录路径"><a href="#查看容器相关目录路径" class="headerlink" title="查看容器相关目录路径"></a>查看容器相关目录路径</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">[root@rocky8 ~]<span class="comment"># docker images nginx*</span></span><br><span class="line">REPOSITORY         TAG         IMAGE ID       CREATED             SIZE</span><br><span class="line">nginx-ubuntu1804   1.16.1      7d7aa6c8e4ef   About an hour ago   394MB</span><br><span class="line">nginx-alpine       1.16.1      e7fc09b41ec4   2 hours ago         262MB</span><br><span class="line">nginx-centos7      1.26.3-v2   08c66ca1868e   8 hours ago         405MB</span><br><span class="line">nginx-centos7      1.26.1      e3157f879258   12 hours ago        446MB</span><br><span class="line">nginx              latest      53a18edff809   2 months ago        192MB</span><br><span class="line"></span><br><span class="line">[root@rocky8 ~]<span class="comment"># docker run -it --rm nginx-alpine:1.16.1 sh</span></span><br><span class="line">/ <span class="comment"># cat /apps/nginx/conf/nginx.conf</span></span><br><span class="line">        location / &#123;</span><br><span class="line">            root   html;</span><br><span class="line">            index  index.html index.htm;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">/ <span class="comment"># cat apps/nginx/html/index.html </span></span><br><span class="line">Test Page based nginx-alpine</span><br><span class="line"></span><br><span class="line">/ <span class="comment"># exit</span></span><br></pre></td></tr></table></figure>

<h4 id="引用宿主机的数据卷启动容器"><a href="#引用宿主机的数据卷启动容器" class="headerlink" title="引用宿主机的数据卷启动容器"></a>引用宿主机的数据卷启动容器</h4><p>引用同一个数据卷目录，开启多个容器，实现多个容器共享数据</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[root@rocky8 ~]<span class="comment"># docker run -d -v /data/testdir/:/apps/nginx/html/ -p 8081:80 nginx-alpine:1.16.1 </span></span><br><span class="line">3c4f3b870399b42199e7a79c4f74403ccf05ff515dec5b3da906c95b122a851d</span><br><span class="line"></span><br><span class="line">[root@rocky8 ~]<span class="comment"># docker run -d -v /data/testdir/:/apps/nginx/html/ -p 8082:80 nginx-alpine:1.16.1 </span></span><br><span class="line">53e62af7dc575b5a9b1d5146579a5e3c41abcad947bdcfe29ca7eb8d3a40333d</span><br><span class="line"></span><br><span class="line">[root@rocky8 ~]<span class="comment"># docker ps</span></span><br><span class="line">CONTAINER ID   IMAGE                     COMMAND   CREATED             STATUS             PORTS                                            NAMES</span><br><span class="line">53e62af7dc57   nginx-alpine:1.16.1       <span class="string">&quot;nginx&quot;</span>   6 seconds ago       Up 5 seconds       443/tcp, 0.0.0.0:8082-&gt;80/tcp, :::8082-&gt;80/tcp   hungry_kilby</span><br><span class="line">3c4f3b870399   nginx-alpine:1.16.1       <span class="string">&quot;nginx&quot;</span>   13 seconds ago      Up 12 seconds      443/tcp, 0.0.0.0:8081-&gt;80/tcp, :::8081-&gt;80/tcp   blissful_black</span><br><span class="line"></span><br><span class="line">[root@rocky8 ~]<span class="comment"># curl 127.0.0.1:8081</span></span><br><span class="line">Test page on host</span><br><span class="line"></span><br><span class="line">[root@rocky8 ~]<span class="comment"># curl 127.0.0.1:8082</span></span><br><span class="line">Test page on host</span><br></pre></td></tr></table></figure>

<h4 id="进入到容器内测试写入数据"><a href="#进入到容器内测试写入数据" class="headerlink" title="进入到容器内测试写入数据"></a>进入到容器内测试写入数据</h4><p>进入其中一个容器写入数据，可以其它容器的数据也变化</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">[root@rocky8 ~]<span class="comment"># docker exec -it 53e62af7dc57 sh</span></span><br><span class="line">/ <span class="comment"># df</span></span><br><span class="line">Filesystem           1K-blocks      Used Available Use% Mounted on</span><br><span class="line">overlay               52403200  16849844  35553356  32% /</span><br><span class="line">tmpfs                    65536         0     65536   0% /dev</span><br><span class="line">tmpfs                  2845540         0   2845540   0% /sys/fs/cgroup</span><br><span class="line">shm                      65536         0     65536   0% /dev/shm</span><br><span class="line">/dev/mapper/rl-root   52403200  16849844  35553356  32% /etc/resolv.conf</span><br><span class="line">/dev/mapper/rl-root   52403200  16849844  35553356  32% /etc/hostname</span><br><span class="line">/dev/mapper/rl-root   52403200  16849844  35553356  32% /etc/hosts</span><br><span class="line">/dev/mapper/rl-root   52403200  16849844  35553356  32% /apps/nginx/html</span><br><span class="line">tmpfs                  2845540         0   2845540   0% /proc/acpi</span><br><span class="line">tmpfs                    65536         0     65536   0% /proc/kcore</span><br><span class="line">tmpfs                    65536         0     65536   0% /proc/keys</span><br><span class="line">tmpfs                    65536         0     65536   0% /proc/timer_list</span><br><span class="line">tmpfs                    65536         0     65536   0% /proc/sched_debug</span><br><span class="line">tmpfs                  2845540         0   2845540   0% /proc/scsi</span><br><span class="line">tmpfs                  2845540         0   2845540   0% /sys/firmware</span><br><span class="line"></span><br><span class="line">/ <span class="comment"># cat /apps/nginx/html/index.html </span></span><br><span class="line">Test page on host</span><br><span class="line"></span><br><span class="line">/ <span class="comment"># echo Test page v2 on host &gt; /apps/nginx/html/index.html </span></span><br><span class="line"></span><br><span class="line"><span class="comment">#进入另一个容器看到数据变化</span></span><br><span class="line">[root@rocky8 ~]<span class="comment"># docker exec -it 3c4f3b870399 sh</span></span><br><span class="line">/ <span class="comment"># cat /apps/nginx/html/index.html </span></span><br><span class="line">Test page v2 on host</span><br><span class="line"></span><br><span class="line">[root@rocky8 ~]<span class="comment"># curl 127.0.0.1:8081</span></span><br><span class="line">Test page v2 on host</span><br><span class="line"></span><br><span class="line">[root@rocky8 ~]<span class="comment"># curl 127.0.0.1:8082</span></span><br><span class="line">Test page v2 on host</span><br></pre></td></tr></table></figure>

<h4 id="在宿主机修改数据"><a href="#在宿主机修改数据" class="headerlink" title="在宿主机修改数据"></a>在宿主机修改数据</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[root@rocky8 ~]<span class="comment"># echo Test page v3 on host &gt; /data/testdir/index.html </span></span><br><span class="line">[root@rocky8 ~]<span class="comment"># cat /data/testdir/index.html</span></span><br><span class="line">Test page v3 on host</span><br><span class="line"></span><br><span class="line">[root@rocky8 ~]<span class="comment"># curl 127.0.0.1:8081</span></span><br><span class="line">Test page v3 on host</span><br><span class="line"></span><br><span class="line">[root@rocky8 ~]<span class="comment"># curl 127.0.0.1:8082</span></span><br><span class="line">Test page v3 on host</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@rocky8 ~]<span class="comment"># docker exec -it 3c4f3b870399 sh</span></span><br><span class="line">/ <span class="comment"># cat /apps/nginx/html/index.html </span></span><br><span class="line">Test page v3 on host</span><br></pre></td></tr></table></figure>

<h4 id="只读方法挂载数据卷"><a href="#只读方法挂载数据卷" class="headerlink" title="只读方法挂载数据卷"></a>只读方法挂载数据卷</h4><p>默认数据卷为可读可写，加ro选项，可以实现只读挂载，对于不希望容器修改的数据，比如: 配置文件，脚本等，可以用此方式挂载</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@rocky8 ~]<span class="comment"># docker run -d -v /data/testdir/:/apps/nginx/html/:ro -p 8004:80 nginx-alpine:1.16.1 </span></span><br><span class="line">d4b616f58917b5516b280b442f4bd71e03e4ef244e67fa4b698a401935e2e169</span><br><span class="line"></span><br><span class="line">[root@rocky8 ~]<span class="comment"># docker exec -it d4b616 sh</span></span><br><span class="line">/ <span class="comment"># cat /apps/nginx/html/index.html </span></span><br><span class="line">Test page v3 on host</span><br><span class="line"></span><br><span class="line">/ <span class="comment"># echo test &gt; /apps/nginx/html/index.html </span></span><br><span class="line">sh: can<span class="string">&#x27;t create /apps/nginx/html/index.html: Read-only file system</span></span><br></pre></td></tr></table></figure>

<h4 id="删除容器-1"><a href="#删除容器-1" class="headerlink" title="删除容器"></a>删除容器</h4><p>删除容器后，宿主机的数据卷还存在，可继续给新的容器使用</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@rocky8 ~]<span class="comment"># docker rm -f `docker ps -aq`</span></span><br><span class="line">[root@rocky8 ~]<span class="comment"># cat /data/testdir/index.html </span></span><br><span class="line">Test page v3 on host</span><br></pre></td></tr></table></figure>

<h3 id="实战案例-MySQL使用的数据卷"><a href="#实战案例-MySQL使用的数据卷" class="headerlink" title="实战案例: MySQL使用的数据卷"></a>实战案例: MySQL使用的数据卷</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br></pre></td><td class="code"><pre><span class="line">[root@rocky8 ~]<span class="comment"># docker pull mysql:5.7.30</span></span><br><span class="line">[root@rocky8 ~]<span class="comment"># docker images mysql</span></span><br><span class="line">REPOSITORY   TAG             IMAGE ID       CREATED       SIZE</span><br><span class="line">mysql        8.0.29-oracle   33037edcac9b   2 years ago   444MB</span><br><span class="line">mysql        5.7.30          9cfcce23593a   4 years ago   448MB</span><br><span class="line"></span><br><span class="line">[root@rocky8 ~]<span class="comment"># docker run -d -p 3306:3306 -e MYSQL_ROOT_PASSWORD=000000 mysql:5.7.30 </span></span><br><span class="line">61ad12a974dcaeb49688862c20746cd81da7a8dd62fde4b7dac67836a99b9dd0</span><br><span class="line"></span><br><span class="line">[root@rocky8 ~]<span class="comment"># docker ps</span></span><br><span class="line">CONTAINER ID   IMAGE          COMMAND                  CREATED          STATUS          PORTS                                                  NAMES</span><br><span class="line">61ad12a974dc   mysql:5.7.30   <span class="string">&quot;docker-entrypoint.s…&quot;</span>   16 seconds ago   Up 15 seconds   0.0.0.0:3306-&gt;3306/tcp, :::3306-&gt;3306/tcp, 33060/tcp   hungry_williams</span><br><span class="line"></span><br><span class="line">[root@rocky8 ~]<span class="comment"># docker exec -it 61ad12a974dc bash</span></span><br><span class="line">root@61ad12a974dc:/<span class="comment"># cat /etc/issue</span></span><br><span class="line">Debian GNU/Linux 10 \n \l</span><br><span class="line"></span><br><span class="line">root@61ad12a974dc:/<span class="comment"># cat /etc/mysql/my.cnf</span></span><br><span class="line">......</span><br><span class="line">!includedir /etc/mysql/conf.d/</span><br><span class="line">!includedir /etc/mysql/mysql.conf.d/</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">root@61ad12a974dc:/<span class="comment"># cat /etc/mysql/mysql.conf.d/mysqld.cnf</span></span><br><span class="line">[mysqld]</span><br><span class="line">pid-file	= /var/run/mysqld/mysqld.pid</span><br><span class="line">socket		= /var/run/mysqld/mysqld.sock</span><br><span class="line">datadir		= /var/lib/mysql	  <span class="comment">#数据存放路径</span></span><br><span class="line"><span class="comment">#log-error	= /var/log/mysql/error.log</span></span><br><span class="line"><span class="comment"># By default we only accept connections from localhost</span></span><br><span class="line"><span class="comment">#bind-address	= 127.0.0.1</span></span><br><span class="line"><span class="comment"># Disabling symbolic-links is recommended to prevent assorted security risks</span></span><br><span class="line">symbolic-links=0</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">root@61ad12a974dc:/<span class="comment"># pstree -p</span></span><br><span class="line">mysqld(1)-+-&#123;mysqld&#125;(128)</span><br><span class="line">          |-&#123;mysqld&#125;(129)</span><br><span class="line">          |-&#123;mysqld&#125;(130)</span><br><span class="line">          |-&#123;mysqld&#125;(131)</span><br><span class="line">          |-&#123;mysqld&#125;(132)</span><br><span class="line">          |-&#123;mysqld&#125;(133)</span><br><span class="line">          |-&#123;mysqld&#125;(134)</span><br><span class="line">          |-&#123;mysqld&#125;(135)</span><br><span class="line">          |-&#123;mysqld&#125;(136)</span><br><span class="line">          |-&#123;mysqld&#125;(137)</span><br><span class="line">          |-&#123;mysqld&#125;(138)</span><br><span class="line">          |-&#123;mysqld&#125;(139)</span><br><span class="line">          |-&#123;mysqld&#125;(141)</span><br><span class="line">          |-&#123;mysqld&#125;(142)</span><br><span class="line">          |-&#123;mysqld&#125;(143)</span><br><span class="line">          |-&#123;mysqld&#125;(144)</span><br><span class="line">          |-&#123;mysqld&#125;(145)</span><br><span class="line">          |-&#123;mysqld&#125;(146)</span><br><span class="line">          |-&#123;mysqld&#125;(147)</span><br><span class="line">          |-&#123;mysqld&#125;(148)</span><br><span class="line">          |-&#123;mysqld&#125;(149)</span><br><span class="line">          |-&#123;mysqld&#125;(150)</span><br><span class="line">          |-&#123;mysqld&#125;(151)</span><br><span class="line">          |-&#123;mysqld&#125;(152)</span><br><span class="line">          |-&#123;mysqld&#125;(153)</span><br><span class="line">          `-&#123;mysqld&#125;(154)</span><br><span class="line"></span><br><span class="line"><span class="comment">#另一个终端</span></span><br><span class="line">[root@rocky8 /]<span class="comment"># mysql -uroot -p000000 -h127.0.0.1</span></span><br><span class="line">mysql&gt; show databases;</span><br><span class="line">+--------------------+</span><br><span class="line">| Database           |</span><br><span class="line">+--------------------+</span><br><span class="line">| information_schema |</span><br><span class="line">| mysql              |</span><br><span class="line">| performance_schema |</span><br><span class="line">| sys                |</span><br><span class="line">+--------------------+</span><br><span class="line">4 rows <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; create database dockerdb;</span><br><span class="line">Query OK, 1 row affected (0.01 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; show databases;</span><br><span class="line">+--------------------+</span><br><span class="line">| Database           |</span><br><span class="line">+--------------------+</span><br><span class="line">| information_schema |</span><br><span class="line">| dockerdb           |</span><br><span class="line">| mysql              |</span><br><span class="line">| performance_schema |</span><br><span class="line">| sys                |</span><br><span class="line">+--------------------+</span><br><span class="line">5 rows <span class="keyword">in</span> <span class="built_in">set</span> (0.01 sec)</span><br><span class="line"></span><br><span class="line"><span class="comment">#删除容器后，再创建新的容器，数据库信息丢失</span></span><br><span class="line">[root@rocky8 ~]<span class="comment"># docker rm -f 61ad12a974dc</span></span><br><span class="line">61ad12a974dc</span><br><span class="line"></span><br><span class="line">[root@rocky8 ~]<span class="comment"># docker run -d -p 3306:3306 -e MYSQL_ROOT_PASSWORD=000000 mysql:5.7.30 </span></span><br><span class="line">a5bf1eb53a617f46507980646497794b59acfb3312bf21f9468e4846ad8b17ee</span><br><span class="line"></span><br><span class="line">[root@rocky8 /]<span class="comment"># mysql -uroot -p000000 -h127.0.0.1</span></span><br><span class="line">mysql&gt; show databases;</span><br><span class="line">+--------------------+</span><br><span class="line">| Database           |</span><br><span class="line">+--------------------+</span><br><span class="line">| information_schema |</span><br><span class="line">| mysql              |</span><br><span class="line">| performance_schema |</span><br><span class="line">| sys                |</span><br><span class="line">+--------------------+</span><br><span class="line">4 rows <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br><span class="line"></span><br><span class="line"><span class="comment">#利用数据卷创建容器</span></span><br><span class="line">[root@rocky8 ~]<span class="comment"># docker run -d --name mysql -p 3306:3306 -v \</span></span><br><span class="line">/data/mysql/:/var/lib/mysql/ -e MYSQL_ROOT_PASSWORD=000000 mysql:5.7.30 </span><br><span class="line">a791bfede6c626a74824f9dd7cdbe86372849ee34e290d3deea9f8714f43f1ae</span><br><span class="line"></span><br><span class="line">[root@rocky8 ~]<span class="comment"># mysql -uroot -p000000 -h127.0.0.1 -e &quot;create database dockerdb;show databases;&quot;</span></span><br><span class="line">+--------------------+</span><br><span class="line">| Database           |</span><br><span class="line">+--------------------+</span><br><span class="line">| information_schema |</span><br><span class="line">| dockerdb           |</span><br><span class="line">| mysql              |</span><br><span class="line">| performance_schema |</span><br><span class="line">| sys                |</span><br><span class="line">+--------------------+</span><br><span class="line"></span><br><span class="line"><span class="comment">#删除容器，数据存放在挂载数据卷中，不会删除</span></span><br><span class="line">[root@rocky8 ~]<span class="comment"># docker rm -f mysql </span></span><br><span class="line">mysql</span><br><span class="line"></span><br><span class="line">[root@rocky8 ~]<span class="comment"># ls /data/mysql/</span></span><br><span class="line">auto.cnf         dockerdb        ibtmp1              server-cert.pem</span><br><span class="line">ca-key.pem       ib_buffer_pool  mysql               server-key.pem</span><br><span class="line">ca.pem           ibdata1         performance_schema  sys</span><br><span class="line">client-cert.pem  ib_logfile0     private_key.pem</span><br><span class="line">client-key.pem   ib_logfile1     public_key.pem</span><br><span class="line"></span><br><span class="line"><span class="comment">#重新创建新容器，之前数据还在</span></span><br><span class="line">[root@rocky8 ~]<span class="comment"># docker run -d --name mysql -p 3306:3306 -v /data/mysql/:/var/lib/mysql/ -e MYSQL_ROOT_PASSWORD=000000 mysql:5.7.30 </span></span><br><span class="line">705ff0ea8fcb7d882a19ed4e3e1a980842d2ecef27eeb24960684945cfca74f8</span><br><span class="line"></span><br><span class="line">[root@rocky8 ~]<span class="comment"># mysql -uroot -p000000 -h127.0.0.1 -e &quot;show databases;&quot;</span></span><br><span class="line">+--------------------+</span><br><span class="line">| Database           |</span><br><span class="line">+--------------------+</span><br><span class="line">| information_schema |</span><br><span class="line">| dockerdb           |</span><br><span class="line">| mysql              |</span><br><span class="line">| performance_schema |</span><br><span class="line">| sys                |</span><br><span class="line">+--------------------+</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#指定多个数据卷，创建MySQL</span></span><br><span class="line">[root@rocky8 ~]<span class="comment"># docker run --name mysql-test1 \</span></span><br><span class="line">-v /data/mysql/:/var/lib/mysql -e MYSQL_ROOT_PASSWORD=000000 \</span><br><span class="line">-e MYSQL_DATABASE=wordpress -e MYSQL_USER=wpuser -e MYSQL_PASSWORD=000000 /</span><br><span class="line">-d -p 3306:3306 mysql:5.7.30</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@rocky8 ~]<span class="comment"># cat env.list </span></span><br><span class="line">MYSQL_ROOT_PASSWORD=123456</span><br><span class="line">MYSQL_DATABASE=wordpress</span><br><span class="line">MYSQL_USER=wpuser</span><br><span class="line">MYSQL_PASSWORD=wppass</span><br><span class="line"></span><br><span class="line">[root@rocky8 ~]<span class="comment"># docker run --name mysql-test2 \</span></span><br><span class="line">-v /root/mysql/:/etc/mysql/conf.d -v /data/mysql2:/var/lib/mysql \</span><br><span class="line">--env-file=env.list -d -p 3307:3306 mysql:5.7.30</span><br></pre></td></tr></table></figure>

<h3 id="实战案例-文件数据卷"><a href="#实战案例-文件数据卷" class="headerlink" title="实战案例: 文件数据卷"></a>实战案例: 文件数据卷</h3><p>文件挂载用于很少更改文件内容的场景，比如: nginx 的配置文件、tomcat的配置文件等。</p>
<h4 id="准备相关文件-1"><a href="#准备相关文件-1" class="headerlink" title="准备相关文件"></a>准备相关文件</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">[root@rocky8 ~]<span class="comment"># mkdir /data/&#123;bin,testapp,logs&#125;</span></span><br><span class="line">[root@rocky8 ~]<span class="comment"># echo testapp v1 &gt; /data/testapp/index.html</span></span><br><span class="line">[root@rocky8 ~]<span class="comment"># cat /data/testapp/index.html</span></span><br><span class="line">testapp v1</span><br><span class="line"></span><br><span class="line">[root@rocky8 ~]<span class="comment"># cp /data/dockerfile/web/tomcat/tomcat-base-8.5.50/apache-tomcat-8.5.50/bin/catalina.sh /data/bin/</span></span><br><span class="line">[root@rocky8 ~]<span class="comment"># vim /data/bin/catalina.sh</span></span><br><span class="line"><span class="comment">#加下面tomcat的优化参数行(一行)</span></span><br><span class="line"><span class="comment"># -----------------------------------------------------------------------------</span></span><br><span class="line">JAVA_OPTS=<span class="string">&quot;-server -Xms4g -Xmx4g -Xss512k -Xmn1g -XX:CMSInitiatingOccupancyFraction=65 -XX:+UseFastAccessorMethods -XX:+AggressiveOpts -XX:+UseBiasedLocking -XX:+DisableExplicitGC -XX:MaxTenuringThreshold=10 -XX:NewSize=2048M -XX:MaxNewSize=2048M -XX:NewRatio=2 -XX:PermSize=128m -XX:MaxPermSize=512m -XX:CMSFullGCsBeforeCompaction=5 -XX:+ExplicitGCInvokesConcurrent -XX:+UseConcMarkSweepGC -XX:+UseParNewGC -XX:+CMSParallelRemarkEnabled -XX:+UseCMSCompactAtFullCollection -XX:LargePageSizeInBytes=128m -XX:+UseFastAccessorMethods&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># OS specific support.  $var _must_ be set to either true or false.</span></span><br><span class="line"></span><br><span class="line">[root@rocky8 ~]<span class="comment"># chown 2019:2019 /data/bin/catalina.sh </span></span><br><span class="line">[root@rocky8 ~]<span class="comment"># chown 2019:2019 /data/logs/</span></span><br><span class="line">[root@rocky8 ~]<span class="comment"># ll /data/bin/catalina.sh </span></span><br><span class="line">-rwxr-x--- 1 2019 2019 24323 Apr 10 14:31 /data/bin/catalina.sh</span><br></pre></td></tr></table></figure>

<h4 id="引用文件数据卷启动容器"><a href="#引用文件数据卷启动容器" class="headerlink" title="引用文件数据卷启动容器"></a>引用文件数据卷启动容器</h4><p>同时挂载可读可写方式的目录数据卷和只读方式的文件数据卷，实现三个数据卷的挂载，数据，日志和启动脚本</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@rocky8 ~]<span class="comment"># docker run -d -v /data/bin/catalina.sh:/apps/tomcat/bin/catalina.sh:ro \</span></span><br><span class="line"> -v /data/testapp:/data/tomcat/webapps/testapp \</span><br><span class="line"> -v /data/logs:/apps/tomcat/logs \</span><br><span class="line"> -p 8080:8080 tomcat-web:app1</span><br><span class="line"> d83a282d18ddb7abd8aedb33c5049db6ea477e1788be1e48c90b630f0493f4d1</span><br></pre></td></tr></table></figure>

<h4 id="验证容器可以访问"><a href="#验证容器可以访问" class="headerlink" title="验证容器可以访问"></a>验证容器可以访问</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root@rocky8 ~]<span class="comment"># curl 127.0.0.1:8080/testapp/</span></span><br><span class="line">testapp v1</span><br><span class="line"></span><br><span class="line">[root@rocky8 ~]<span class="comment"># ls -l /data/logs/</span></span><br><span class="line">total 40</span><br><span class="line">-rw-r----- 1 2019 2019 16304 Apr 10 14:47 catalina.2025-04-10.log</span><br><span class="line">-rw-r----- 1 2019 2019 17248 Apr 10 14:47 catalina.out</span><br><span class="line">-rw-r----- 1 2019 2019     0 Apr 10 14:43 host-manager.2025-04-10.log</span><br><span class="line">-rw-r----- 1 2019 2019     0 Apr 10 14:43 localhost.2025-04-10.log</span><br><span class="line">-rw-r----- 1 2019 2019   230 Apr 10 14:47 localhost_access_log.2025-04-10.txt</span><br><span class="line">-rw-r----- 1 2019 2019     0 Apr 10 14:43 manager.2025-04-10.log</span><br></pre></td></tr></table></figure>

<h4 id="直接修改宿主机的数据"><a href="#直接修改宿主机的数据" class="headerlink" title="直接修改宿主机的数据"></a>直接修改宿主机的数据</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#宿主机修改目录数据卷</span></span><br><span class="line">[root@rocky8 ~]<span class="comment"># echo testapp v2 &gt; /data/testapp/index.html </span></span><br><span class="line">[root@rocky8 ~]<span class="comment"># curl 127.0.0.1:8080/testapp/</span></span><br><span class="line">testapp v2</span><br><span class="line"></span><br><span class="line">[root@rocky8 ~]<span class="comment"># ll /data/bin/catalina.sh </span></span><br><span class="line">-rwxr-x--- 1 2019 2019 24323 Apr 10 14:31 /data/bin/catalina.sh</span><br><span class="line"></span><br><span class="line">[root@rocky8 ~]<span class="comment"># ll /data/bin/catalina.sh </span></span><br><span class="line">-rwxr-x--- 1 2019 2019 24323 Apr 10 14:31 /data/bin/catalina.sh</span><br><span class="line"></span><br><span class="line">[root@rocky8 ~]<span class="comment"># echo &gt;&gt; /data/bin/catalina.sh</span></span><br><span class="line">[root@rocky8 ~]<span class="comment"># ll /data/bin/catalina.sh </span></span><br><span class="line">-rwxr-x--- 1 2019 2019 24324 Apr 10 14:53 /data/bin/catalina.sh</span><br></pre></td></tr></table></figure>

<h4 id="进入容器修改数据"><a href="#进入容器修改数据" class="headerlink" title="进入容器修改数据"></a>进入容器修改数据</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">[root@rocky8 ~]<span class="comment"># docker exec -it d83a282d18dd bash</span></span><br><span class="line">[root@d83a282d18dd /]<span class="comment"># netstat -ntl</span></span><br><span class="line">Active Internet connections (only servers)</span><br><span class="line">Proto Recv-Q Send-Q Local Address           Foreign Address         State      </span><br><span class="line">tcp6       0      0 127.0.0.1:8005          :::*                    LISTEN     </span><br><span class="line">tcp6       0      0 :::8009                 :::*                    LISTEN     </span><br><span class="line">tcp6       0      0 :::8080                 :::*                    LISTEN</span><br><span class="line"></span><br><span class="line"><span class="comment">#文件数据卷上的文件为只读</span></span><br><span class="line">[root@d83a282d18dd /]<span class="comment"># echo &gt;&gt; /apps/tomcat/bin/catalina.sh </span></span><br><span class="line">bash: /apps/tomcat/bin/catalina.sh: Read-only file system</span><br><span class="line"></span><br><span class="line"><span class="comment">#目录数据卷可读可写</span></span><br><span class="line">[root@d83a282d18dd /]<span class="comment"># cat /data/tomcat/webapps/testapp/index.html </span></span><br><span class="line">testapp v2</span><br><span class="line"></span><br><span class="line">[root@d83a282d18dd /]<span class="comment"># echo testapp v3 &gt; /data/tomcat/webapps/testapp/index.html</span></span><br><span class="line">[root@d83a282d18dd /]<span class="comment"># cat /data/tomcat/webapps/testapp/index.html </span></span><br><span class="line">testapp v3</span><br><span class="line"></span><br><span class="line">[root@rocky8 ~]<span class="comment"># curl 127.0.0.1:8080/testapp/</span></span><br><span class="line">testapp v3</span><br></pre></td></tr></table></figure>

<h4 id="查看容器中挂载和进程信息"><a href="#查看容器中挂载和进程信息" class="headerlink" title="查看容器中挂载和进程信息"></a>查看容器中挂载和进程信息</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">[root@d83a282d18dd /]<span class="comment"># mount</span></span><br><span class="line">......</span><br><span class="line">/dev/mapper/rl-root on /etc/resolv.conf <span class="built_in">type</span> xfs (rw,relatime,attr2,inode64,logbufs=8,logbsize=32k,noquota)</span><br><span class="line">/dev/mapper/rl-root on /etc/hostname <span class="built_in">type</span> xfs (rw,relatime,attr2,inode64,logbufs=8,logbsize=32k,noquota)</span><br><span class="line">/dev/mapper/rl-root on /etc/hosts <span class="built_in">type</span> xfs (rw,relatime,attr2,inode64,logbufs=8,logbsize=32k,noquota)</span><br><span class="line">/dev/mapper/rl-root on /apps/apache-tomcat-8.5.50/logs <span class="built_in">type</span> xfs (rw,relatime,attr2,inode64,logbufs=8,logbsize=32k,noquota)</span><br><span class="line">/dev/mapper/rl-root on /apps/apache-tomcat-8.5.50/bin/catalina.sh <span class="built_in">type</span> xfs (ro,relatime,attr2,inode64,logbufs=8,logbsize=32k,noquota)</span><br><span class="line">/dev/mapper/rl-root on /data/tomcat/webapps/testapp <span class="built_in">type</span> xfs (rw,relatime,attr2,inode64,logbufs=8,logbsize=32k,noquota)</span><br><span class="line">......</span><br><span class="line"></span><br><span class="line">[root@d83a282d18dd /]<span class="comment"># df</span></span><br><span class="line">Filesystem          1K-blocks     Used Available Use% Mounted on</span><br><span class="line">overlay              52403200 22521664  29881536  43% /</span><br><span class="line">tmpfs                   65536        0     65536   0% /dev</span><br><span class="line">tmpfs                 2845540        0   2845540   0% /sys/fs/cgroup</span><br><span class="line">shm                     65536        0     65536   0% /dev/shm</span><br><span class="line">/dev/mapper/rl-root  52403200 22521664  29881536  43% /etc/hosts</span><br><span class="line">tmpfs                 2845540        0   2845540   0% /proc/acpi</span><br><span class="line">tmpfs                 2845540        0   2845540   0% /proc/scsi</span><br><span class="line">tmpfs                 2845540        0   2845540   0% /sys/firmware</span><br><span class="line"></span><br><span class="line">[root@d83a282d18dd /]<span class="comment"># ps aux</span></span><br><span class="line">USER         PID %CPU %MEM    VSZ   RSS TTY      STAT START   TIME COMMAND</span><br><span class="line">root           1  0.0  0.0  13308  3060 ?        Ss   14:47   0:00 /bin/bash /apps/tomcat/bin/run_tomcat.sh</span><br><span class="line">www           26  0.4  3.1 8234820 178880 ?      Sl   14:47   0:03 /usr/local/jdk/bin/java -Djava.util.logging.config.file=/apps/tomca</span><br><span class="line">root          27  0.0  0.0  83600  4580 ?        S    14:47   0:00 su - www -c <span class="built_in">tail</span> -f /etc/hosts</span><br><span class="line">www           29  0.0  0.0   4420   672 ?        Ss   14:47   0:00 <span class="built_in">tail</span> -f /etc/hosts</span><br><span class="line">root         145  0.0  0.0  13972  4088 pts/0    Ss   14:57   0:00 bash</span><br><span class="line">root         170  0.0  0.0  53372  3880 pts/0    R+   14:59   0:00 ps aux</span><br><span class="line"></span><br><span class="line">[root@d83a282d18dd /]<span class="comment"># ps aux | grep java</span></span><br><span class="line">www           26  0.4  3.1 8234820 178880 ?      Sl   14:47   0:03 /usr/local/jdk/bin/java -Djava.util.logging.config.file=/apps/tomcat/conf/logging.properties -Djava.util.logging.manager=org.apache.juli.ClassLoaderLogManager -server -Xms4g -Xmx4g -Xss512k -Xmn1g -XX:CMSInitiatingOccupancyFraction=65 -XX:+UseFastAccessorMethods -XX:+AggressiveOpts -XX:+UseBiasedLocking -XX:+DisableExplicitGC -XX:MaxTenuringThreshold=10 -XX:NewSize=2048M -XX:MaxNewSize=2048M -XX:NewRatio=2 -XX:PermSize=128m -XX:MaxPermSize=512m -XX:CMSFullGCsBeforeCompaction=5 -XX:+ExplicitGCInvokesConcurrent -XX:+UseConcMarkSweepGC -XX:+UseParNewGC -XX:+CMSParallelRemarkEnabled -XX:+UseCMSCompactAtFullCollection -XX:LargePageSizeInBytes=128m -XX:+UseFastAccessorMethods -Djdk.tls.ephemeralDHKeySize=2048 -Djava.protocol.handler.pkgs=org.apache.catalina.webresources -Dorg.apache.catalina.security.SecurityListener.UMASK=0027 -Dignore.endorsed.dirs= -classpath /apps/tomcat/bin/bootstrap.jar:/apps/tomcat/bin/tomcat-juli.jar -Dcatalina.base=/apps/tomcat -Dcatalina.home=/apps/tomcat -Djava.io.tmpdir=/apps/tomcat/temp org.apache.catalina.startup.Bootstrap start</span><br><span class="line">root         174  0.0  0.0  10708  2232 pts/0    S+   15:00   0:00 grep --color=auto java</span><br></pre></td></tr></table></figure>

<h3 id="实战案例-匿名数据卷"><a href="#实战案例-匿名数据卷" class="headerlink" title="实战案例: 匿名数据卷"></a>实战案例: 匿名数据卷</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line">[root@rocky8 ~]<span class="comment"># docker volume ls</span></span><br><span class="line">DRIVER    VOLUME NAME</span><br><span class="line"></span><br><span class="line">[root@rocky8 ~]<span class="comment"># docker ps -a</span></span><br><span class="line">CONTAINER ID   IMAGE     COMMAND   CREATED   STATUS    PORTS     NAMES</span><br><span class="line"></span><br><span class="line"><span class="comment">#利用匿名数据卷创建容器</span></span><br><span class="line">[root@rocky8 ~]<span class="comment"># docker run -d -p 80:80 --name nginx01 -v /usr/share/nginx/html nginx</span></span><br><span class="line">b51e5babee75887b6579837ad79a548e71774c2e2bc6497ddeac7972c5f055df</span><br><span class="line"></span><br><span class="line">[root@rocky8 ~]<span class="comment"># curl 127.0.0.1</span></span><br><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;<span class="built_in">head</span>&gt;</span><br><span class="line">&lt;title&gt;Welcome to nginx!&lt;/title&gt;</span><br><span class="line">&lt;style&gt;</span><br><span class="line">html &#123; color-scheme: light dark; &#125;</span><br><span class="line">body &#123; width: 35em; margin: 0 auto;</span><br><span class="line">font-family: Tahoma, Verdana, Arial, sans-serif; &#125;</span><br><span class="line">&lt;/style&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">&lt;h1&gt;Welcome to nginx!&lt;/h1&gt;</span><br><span class="line">&lt;p&gt;If you see this page, the nginx web server is successfully installed and</span><br><span class="line">working. Further configuration is required.&lt;/p&gt;</span><br><span class="line"></span><br><span class="line">&lt;p&gt;For online documentation and support please refer to</span><br><span class="line">&lt;a href=<span class="string">&quot;http://nginx.org/&quot;</span>&gt;nginx.org&lt;/a&gt;.&lt;br/&gt;</span><br><span class="line">Commercial support is available at</span><br><span class="line">&lt;a href=<span class="string">&quot;http://nginx.com/&quot;</span>&gt;nginx.com&lt;/a&gt;.&lt;/p&gt;</span><br><span class="line"></span><br><span class="line">&lt;p&gt;&lt;em&gt;Thank you <span class="keyword">for</span> using nginx.&lt;/em&gt;&lt;/p&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment">#查看自动生成的匿名数据卷</span></span><br><span class="line">[root@rocky8 ~]<span class="comment"># docker volume ls</span></span><br><span class="line">DRIVER    VOLUME NAME</span><br><span class="line"><span class="built_in">local</span>     ef90c2af7491adf2f522a7a312e939d2fb5339f5e7561ba17d954693432d0964</span><br><span class="line"></span><br><span class="line"><span class="comment">#查看匿名数据卷的详细信息</span></span><br><span class="line">[root@rocky8 ~]<span class="comment"># docker volume inspect ef90c2af7491adf2f522a7a312e939d2fb5339f5e7561ba17d954693432d0964 </span></span><br><span class="line">[</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="string">&quot;CreatedAt&quot;</span>: <span class="string">&quot;2025-04-10T15:05:00+08:00&quot;</span>,</span><br><span class="line">        <span class="string">&quot;Driver&quot;</span>: <span class="string">&quot;local&quot;</span>,</span><br><span class="line">        <span class="string">&quot;Labels&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;com.docker.volume.anonymous&quot;</span>: <span class="string">&quot;&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">&quot;Mountpoint&quot;</span>: <span class="string">&quot;/var/lib/docker/volumes/ef90c2af7491adf2f522a7a312e939d2fb5339f5e7561ba17d954693432d0964/_data&quot;</span>,</span><br><span class="line">        <span class="string">&quot;Name&quot;</span>: <span class="string">&quot;ef90c2af7491adf2f522a7a312e939d2fb5339f5e7561ba17d954693432d0964&quot;</span>,</span><br><span class="line">        <span class="string">&quot;Options&quot;</span>: null,</span><br><span class="line">        <span class="string">&quot;Scope&quot;</span>: <span class="string">&quot;local&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@rocky8 ~]<span class="comment"># docker inspect --format=&quot;&#123;&#123;.Mounts&#125;&#125;&quot; nginx01</span></span><br><span class="line">[&#123;volume ef90c2af7491adf2f522a7a312e939d2fb5339f5e7561ba17d954693432d0964 /var/lib/docker/volumes/ef90c2af7491adf2f522a7a312e939d2fb5339f5e7561ba17d954693432d0964/_data /usr/share/nginx/html <span class="built_in">local</span>  <span class="literal">true</span> &#125;]</span><br><span class="line"></span><br><span class="line"><span class="comment">#查看匿名数据卷的文件</span></span><br><span class="line">[root@rocky8 ~]<span class="comment"># ls /var/lib/docker/volumes/ef90c2af7491adf2f522a7a312e939d2fb5339f5e7561ba17d954693432d0964/_data</span></span><br><span class="line">50x.html  index.html</span><br><span class="line"></span><br><span class="line"><span class="comment">#修改宿主机中匿名数据卷的文件</span></span><br><span class="line">[root@rocky8 ~]<span class="comment"># echo Anonymous Volume &gt; /var/lib/docker/volumes/ef90c2af7491adf2f522a7a312e939d2fb5339f5e7561ba17d954693432d0964/_data/index.html</span></span><br><span class="line">[root@rocky8 ~]<span class="comment"># curl 127.0.0.1</span></span><br><span class="line">Anonymous Volume</span><br><span class="line"></span><br><span class="line"><span class="comment">#删除容器不会删除匿名数据卷</span></span><br><span class="line">[root@rocky8 ~]<span class="comment"># docker rm -f nginx01 </span></span><br><span class="line">nginx01</span><br><span class="line"></span><br><span class="line">[root@rocky8 ~]<span class="comment"># docker volume ls</span></span><br><span class="line">DRIVER    VOLUME NAME</span><br><span class="line"><span class="built_in">local</span>     ef90c2af7491adf2f522a7a312e939d2fb5339f5e7561ba17d954693432d0964</span><br><span class="line"></span><br><span class="line">[root@rocky8 ~]<span class="comment"># docker run -d -p 80:80 --name nginx01 -v /usr/share/nginx/html nginx</span></span><br><span class="line">e9d657fa9cc59c027201779a36cc87a1dd5ec419f138ab7c32ced9fe75a2b29e</span><br><span class="line"></span><br><span class="line">[root@rocky8 ~]<span class="comment"># cat /var/lib/docker/volumes/ef90c2af7491adf2f522a7a312e939d2fb5339f5e7561ba17d954693432d0964/_data/index.html </span></span><br><span class="line">Anonymous Volume</span><br><span class="line"></span><br><span class="line"><span class="comment">#删除匿名数据卷</span></span><br><span class="line">[root@rocky8 ~]<span class="comment"># docker volume rm ef90c2af7491adf2f522a7a312e939d2fb5339f5e7561ba17d954693432d0964 </span></span><br><span class="line">ef90c2af7491adf2f522a7a312e939d2fb5339f5e7561ba17d954693432d0964</span><br></pre></td></tr></table></figure>

<h3 id="实战案例-命名数据卷"><a href="#实战案例-命名数据卷" class="headerlink" title="实战案例: 命名数据卷"></a>实战案例: 命名数据卷</h3><h4 id="创建命名数据卷"><a href="#创建命名数据卷" class="headerlink" title="创建命名数据卷"></a>创建命名数据卷</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">[root@rocky8 ~]<span class="comment"># docker volume create vol1</span></span><br><span class="line">vol1</span><br><span class="line">[root@rocky8 ~]<span class="comment"># docker volume ls</span></span><br><span class="line">DRIVER    VOLUME NAME</span><br><span class="line"><span class="built_in">local</span>     vol1</span><br><span class="line">[root@rocky8 ~]<span class="comment"># docker inspect vol1</span></span><br><span class="line">[</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="string">&quot;CreatedAt&quot;</span>: <span class="string">&quot;2025-04-10T15:13:44+08:00&quot;</span>,</span><br><span class="line">        <span class="string">&quot;Driver&quot;</span>: <span class="string">&quot;local&quot;</span>,</span><br><span class="line">        <span class="string">&quot;Labels&quot;</span>: null,</span><br><span class="line">        <span class="string">&quot;Mountpoint&quot;</span>: <span class="string">&quot;/var/lib/docker/volumes/vol1/_data&quot;</span>,</span><br><span class="line">        <span class="string">&quot;Name&quot;</span>: <span class="string">&quot;vol1&quot;</span>,</span><br><span class="line">        <span class="string">&quot;Options&quot;</span>: null,</span><br><span class="line">        <span class="string">&quot;Scope&quot;</span>: <span class="string">&quot;local&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">]</span><br></pre></td></tr></table></figure>

<h4 id="使用命名数据卷创建容器"><a href="#使用命名数据卷创建容器" class="headerlink" title="使用命名数据卷创建容器"></a>使用命名数据卷创建容器</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line">[root@rocky8 ~]<span class="comment"># docker run -d -p 8001:80 --name nginx01 -v vol1:/usr/share/nginx/html nginx</span></span><br><span class="line">67e8b53447bd457d3010f395a5667a9c15a4f583788a87bdec0d283dcb90b6f4</span><br><span class="line"></span><br><span class="line">[root@rocky8 ~]<span class="comment"># curl 127.0.0.1:8001</span></span><br><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;<span class="built_in">head</span>&gt;</span><br><span class="line">&lt;title&gt;Welcome to nginx!&lt;/title&gt;</span><br><span class="line">&lt;style&gt;</span><br><span class="line">html &#123; color-scheme: light dark; &#125;</span><br><span class="line">body &#123; width: 35em; margin: 0 auto;</span><br><span class="line">font-family: Tahoma, Verdana, Arial, sans-serif; &#125;</span><br><span class="line">&lt;/style&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">&lt;h1&gt;Welcome to nginx!&lt;/h1&gt;</span><br><span class="line">&lt;p&gt;If you see this page, the nginx web server is successfully installed and</span><br><span class="line">working. Further configuration is required.&lt;/p&gt;</span><br><span class="line"></span><br><span class="line">&lt;p&gt;For online documentation and support please refer to</span><br><span class="line">&lt;a href=<span class="string">&quot;http://nginx.org/&quot;</span>&gt;nginx.org&lt;/a&gt;.&lt;br/&gt;</span><br><span class="line">Commercial support is available at</span><br><span class="line">&lt;a href=<span class="string">&quot;http://nginx.com/&quot;</span>&gt;nginx.com&lt;/a&gt;.&lt;/p&gt;</span><br><span class="line"></span><br><span class="line">&lt;p&gt;&lt;em&gt;Thank you <span class="keyword">for</span> using nginx.&lt;/em&gt;&lt;/p&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment">#显示命名数据卷</span></span><br><span class="line">[root@rocky8 ~]<span class="comment"># docker volume ls</span></span><br><span class="line">DRIVER    VOLUME NAME</span><br><span class="line"><span class="built_in">local</span>     vol1</span><br><span class="line"></span><br><span class="line"><span class="comment">#查看命名数据卷详解信息</span></span><br><span class="line">[root@rocky8 ~]<span class="comment"># docker volume inspect vol1 </span></span><br><span class="line">[</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="string">&quot;CreatedAt&quot;</span>: <span class="string">&quot;2025-04-10T15:13:44+08:00&quot;</span>,</span><br><span class="line">        <span class="string">&quot;Driver&quot;</span>: <span class="string">&quot;local&quot;</span>,</span><br><span class="line">        <span class="string">&quot;Labels&quot;</span>: null,</span><br><span class="line">        <span class="string">&quot;Mountpoint&quot;</span>: <span class="string">&quot;/var/lib/docker/volumes/vol1/_data&quot;</span>,</span><br><span class="line">        <span class="string">&quot;Name&quot;</span>: <span class="string">&quot;vol1&quot;</span>,</span><br><span class="line">        <span class="string">&quot;Options&quot;</span>: null,</span><br><span class="line">        <span class="string">&quot;Scope&quot;</span>: <span class="string">&quot;local&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line">[root@rocky8 ~]<span class="comment"># docker inspect --format=&quot;&#123;&#123;.Mounts&#125;&#125;&quot; nginx01</span></span><br><span class="line">[&#123;volume vol1 /var/lib/docker/volumes/vol1/_data /usr/share/nginx/html <span class="built_in">local</span> z <span class="literal">true</span> &#125;]</span><br><span class="line"></span><br><span class="line"><span class="comment">#查看命名数据卷的文件</span></span><br><span class="line">[root@rocky8 ~]<span class="comment"># ls /var/lib/docker/volumes/vol1/_data/</span></span><br><span class="line">50x.html  index.html</span><br><span class="line"></span><br><span class="line"><span class="comment">#修改宿主机命名数据卷的文件</span></span><br><span class="line">[root@rocky8 ~]<span class="comment"># echo nginx vol1 website &gt; /var/lib/docker/volumes/vol1/_data/index.html </span></span><br><span class="line">[root@rocky8 ~]<span class="comment"># curl 127.0.0.1:8001</span></span><br><span class="line">nginx vol1 website</span><br><span class="line"></span><br><span class="line"><span class="comment">#利用现在的命名数据卷再创建新容器,可以和原有容器共享同一个命名数据卷的数据</span></span><br><span class="line">[root@rocky8 ~]<span class="comment"># docker run -d -p 8002:80 --name nginx02 -v vol1:/usr/share/nginx/html nginx</span></span><br><span class="line">abc2c0b606f505b0ac6e41ac8a627714e66c66c2ac6cade24a32c6a84d85ed01</span><br><span class="line"></span><br><span class="line">[root@rocky8 ~]<span class="comment"># curl 127.0.0.1:8002</span></span><br><span class="line">nginx vol1 website</span><br></pre></td></tr></table></figure>

<h4 id="创建容器时自动创建命名数据卷"><a href="#创建容器时自动创建命名数据卷" class="headerlink" title="创建容器时自动创建命名数据卷"></a>创建容器时自动创建命名数据卷</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#创建容器自动创建命名数据卷</span></span><br><span class="line">[root@rocky8 ~]<span class="comment"># docker run -d -p 8003:80 --name nginx03 -v vol2:/usr/share/nginx/html nginx</span></span><br><span class="line">136c337d758f92dd92a42c19850be9ebc72d35d697d832a34a8fb6da523d2450</span><br><span class="line"></span><br><span class="line">[root@rocky8 ~]<span class="comment"># docker volume ls</span></span><br><span class="line">DRIVER    VOLUME NAME</span><br><span class="line"><span class="built_in">local</span>     vol1</span><br><span class="line"><span class="built_in">local</span>     vol2</span><br></pre></td></tr></table></figure>

<h4 id="删除数据卷"><a href="#删除数据卷" class="headerlink" title="删除数据卷"></a>删除数据卷</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#删除指定的命名数据卷</span></span><br><span class="line">[root@rocky8 ~]<span class="comment"># docker volume rm vol1</span></span><br><span class="line">vol1</span><br><span class="line"></span><br><span class="line"><span class="comment">#清理全部不再使用的卷</span></span><br><span class="line">[root@rocky8 ~]<span class="comment"># docker volume prune -f</span></span><br></pre></td></tr></table></figure>

<h3 id="实战案例：实现-wordpress-持久化"><a href="#实战案例：实现-wordpress-持久化" class="headerlink" title="实战案例：实现 wordpress 持久化"></a>实战案例：实现 wordpress 持久化</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@rocky8 ~]<span class="comment"># docker run -p 3306:3306 -e MYSQL_ROOT_PASSWORD=123456 \</span></span><br><span class="line">-e MYSQL_DATABASE=wordpress -e MYSQL_USER=wordpress -e MYSQL_PASSWORD=123456 \</span><br><span class="line">--name mysql -d -v /data/mysql/:/var/lib/mysql --restart=always mysql:</span><br><span class="line">8.0.29-oracle</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@rocky8 ~]<span class="comment"># docker run -d -p 80:80 --name wordpress \</span></span><br><span class="line">-v /data/wordpress:/var/www/html --restart=always wordpress:php7.4-apache</span><br></pre></td></tr></table></figure>

<h2 id="数据卷容器"><a href="#数据卷容器" class="headerlink" title="数据卷容器"></a>数据卷容器</h2><h3 id="数据卷容器介绍"><a href="#数据卷容器介绍" class="headerlink" title="数据卷容器介绍"></a>数据卷容器介绍</h3><p><img src="../../../../images/SRE/day46/49.jpg" alt="49"></p>
<p>在Dockerfile中创建的是匿名数据卷,无法直接实现多个容器之间共享数据</p>
<p>数据卷容器最大的功能是可以让数据在多个docker容器之间共享</p>
<p>如下图所示: 即可以让B容器访问A容器的内容，而容器C也可以访问A容器的内容，即可以实现A，B，C 三个容器之间的数据读写共享。</p>
<p><img src="../../../../images/SRE/day46/50.jpg" alt="50"></p>
<p>相当于先要创建一个后台运行的容器作为 Server，用于提供数据卷，这个卷可以为其他容器提供数据存储服务，其他使用此卷的容器作为client端 ，但此方法并不常使用</p>
<p>缺点: 因为依赖一个 Server 的容器，所以此 Server 容器出了问题，其它 Client容器都会受影响</p>
<h3 id="使用数据卷容器"><a href="#使用数据卷容器" class="headerlink" title="使用数据卷容器"></a>使用数据卷容器</h3><p>启动容器时，指定使用数据卷容器</p>
<p>docker run 命令的以下选项可以实现数据卷容器，格式如下: </p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">--volumes-from &lt;数据卷容器&gt;     Mount volumes from the specified container(s)</span><br></pre></td></tr></table></figure>

<h3 id="实战案例-数据卷容器"><a href="#实战案例-数据卷容器" class="headerlink" title="实战案例: 数据卷容器"></a>实战案例: 数据卷容器</h3><h4 id="创建一个数据卷容器-Server"><a href="#创建一个数据卷容器-Server" class="headerlink" title="创建一个数据卷容器 Server"></a>创建一个数据卷容器 Server</h4><p>先创建一个挂载宿主机的数据目录的容器，且可以无需启动</p>
<p>范例: 使用之前的镜像创建数据卷容器</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#数据卷容器一般无需映射端口</span></span><br><span class="line">[root@rocky8 ~]<span class="comment"># docker run -d --name volume-server \</span></span><br><span class="line"> -v /data/bin/catalina.sh:/apps/tomcat/bin/catalina.sh:ro \</span><br><span class="line"> -v /data/testapp:/data/tomcat/webapps/testapp tomcat-web:app1</span><br><span class="line">1c9e7ccc82c8f777b387cc83789bb5334174e6c872ec2e7ca52b9393973b27a3</span><br><span class="line"></span><br><span class="line">[root@rocky8 ~]<span class="comment"># docker ps</span></span><br><span class="line">CONTAINER ID   IMAGE             COMMAND                  CREATED          STATUS          PORTS                NAMES</span><br><span class="line">1c9e7ccc82c8   tomcat-web:app1   <span class="string">&quot;/apps/tomcat/bin/ru…&quot;</span>   15 seconds ago   Up 14 seconds   8009/tcp, 8080/tcp   volume-server</span><br></pre></td></tr></table></figure>

<h4 id="启动多个数据卷容器-Client"><a href="#启动多个数据卷容器-Client" class="headerlink" title="启动多个数据卷容器 Client"></a>启动多个数据卷容器 Client</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root@rocky8 ~]<span class="comment"># docker run -d --name client1 --volumes-from volume-server -p 8081:8080 tomcat-web:app1 </span></span><br><span class="line">2fb21a5681ca662f7113d3cb27dc2ed8b69a332821e884ecb2c544521c00c527</span><br><span class="line"></span><br><span class="line">[root@rocky8 ~]<span class="comment"># docker run -d --name client2 --volumes-from volume-server -p 8082:8080 tomcat-web:app1 </span></span><br><span class="line">7d0cf30474af6cf379049927ba3b4a36fc612f586b35cadb1adcef130391c1a1</span><br><span class="line"></span><br><span class="line">[root@rocky8 ~]<span class="comment"># docker ps</span></span><br><span class="line">CONTAINER ID   IMAGE             COMMAND                  CREATED          STATUS          PORTS                                                 NAMES</span><br><span class="line">7d0cf30474af   tomcat-web:app1   <span class="string">&quot;/apps/tomcat/bin/ru…&quot;</span>   23 seconds ago   Up 22 seconds   8009/tcp, 0.0.0.0:8082-&gt;8080/tcp, :::8082-&gt;8080/tcp   client2</span><br><span class="line">2fb21a5681ca   tomcat-web:app1   <span class="string">&quot;/apps/tomcat/bin/ru…&quot;</span>   33 seconds ago   Up 32 seconds   8009/tcp, 0.0.0.0:8081-&gt;8080/tcp, :::8081-&gt;8080/tcp   client1</span><br><span class="line">1c9e7ccc82c8   tomcat-web:app1   <span class="string">&quot;/apps/tomcat/bin/ru…&quot;</span>   2 minutes ago    Up 2 minutes    8009/tcp, 8080/tcp                                    volume-server</span><br></pre></td></tr></table></figure>

<h4 id="验证访问"><a href="#验证访问" class="headerlink" title="验证访问"></a>验证访问</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@rocky8 ~]<span class="comment"># curl 127.0.0.1:8081/testapp/</span></span><br><span class="line">testapp v3</span><br><span class="line"></span><br><span class="line">[root@rocky8 ~]<span class="comment"># curl 127.0.0.1:8082/testapp/</span></span><br><span class="line">testapp v3</span><br></pre></td></tr></table></figure>

<h4 id="进入容器测试读写"><a href="#进入容器测试读写" class="headerlink" title="进入容器测试读写"></a>进入容器测试读写</h4><p>读写权限依赖于源数据卷Server容器</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#进入 Server 容器修改数据</span></span><br><span class="line">[root@rocky8 ~]<span class="comment"># docker exec -it volume-server bash</span></span><br><span class="line">[root@1c9e7ccc82c8 /]<span class="comment"># cat /data/tomcat/webapps/testapp/index.html </span></span><br><span class="line">testapp v3</span><br><span class="line"></span><br><span class="line">[root@1c9e7ccc82c8 /]<span class="comment"># echo testapp v4 &gt; /data/tomcat/webapps/testapp/index.html</span></span><br><span class="line"></span><br><span class="line">[root@rocky8 ~]<span class="comment"># curl 127.0.0.1:8081/testapp/</span></span><br><span class="line">testapp v4</span><br><span class="line"></span><br><span class="line">[root@rocky8 ~]<span class="comment"># curl 127.0.0.1:8082/testapp/</span></span><br><span class="line">testapp v4</span><br><span class="line"></span><br><span class="line"><span class="comment">#进入 Client 容器修改数据</span></span><br><span class="line">[root@rocky8 ~]<span class="comment"># docker exec -it client1 bash</span></span><br><span class="line">[root@2fb21a5681ca /]<span class="comment"># cat /data/tomcat/webapps/testapp/index.html </span></span><br><span class="line">testapp v4</span><br><span class="line"></span><br><span class="line">[root@2fb21a5681ca /]<span class="comment"># echo testapp v5 &gt; /data/tomcat/webapps/testapp/index.html</span></span><br><span class="line">[root@2fb21a5681ca /]<span class="comment"># cat /data/tomcat/webapps/testapp/index.html </span></span><br><span class="line">testapp v5</span><br><span class="line"></span><br><span class="line">[root@rocky8 ~]<span class="comment"># curl 127.0.0.1:8081/testapp/</span></span><br><span class="line">testapp v5</span><br><span class="line"></span><br><span class="line">[root@rocky8 ~]<span class="comment"># curl 127.0.0.1:8082/testapp/</span></span><br><span class="line">testapp v5</span><br></pre></td></tr></table></figure>

<h4 id="在宿主机直接修改"><a href="#在宿主机直接修改" class="headerlink" title="在宿主机直接修改"></a>在宿主机直接修改</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[root@rocky8 ~]<span class="comment"># cat /data/testapp/index.html </span></span><br><span class="line">testapp v5</span><br><span class="line"></span><br><span class="line">[root@rocky8 ~]<span class="comment"># echo testapp v6 &gt; /data/testapp/index.html</span></span><br><span class="line">[root@rocky8 ~]<span class="comment"># cat /data/testapp/index.html </span></span><br><span class="line">testapp v6</span><br><span class="line"></span><br><span class="line">[root@rocky8 ~]<span class="comment"># curl 127.0.0.1:8081/testapp/</span></span><br><span class="line">testapp v6</span><br><span class="line"></span><br><span class="line">[root@rocky8 ~]<span class="comment"># curl 127.0.0.1:8082/testapp/</span></span><br><span class="line">testapp v6</span><br><span class="line"></span><br><span class="line">[root@rocky8 ~]<span class="comment"># docker exec -it volume-server cat /data/tomcat/webapps/testapp/index.html</span></span><br><span class="line">testapp v6</span><br></pre></td></tr></table></figure>

<h4 id="关闭卷容器Server测试能否启动新容器"><a href="#关闭卷容器Server测试能否启动新容器" class="headerlink" title="关闭卷容器Server测试能否启动新容器"></a>关闭卷容器Server测试能否启动新容器</h4><p><strong>关闭卷容器Server，仍然可以创建新的client容器及访问旧的client容器</strong></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">[root@rocky8 ~]<span class="comment"># docker stop volume-server </span></span><br><span class="line">volume-server</span><br><span class="line"></span><br><span class="line">[root@rocky8 ~]<span class="comment"># docker ps</span></span><br><span class="line">CONTAINER ID   IMAGE             COMMAND                  CREATED          STATUS          PORTS                                                 NAMES</span><br><span class="line">7d0cf30474af   tomcat-web:app1   <span class="string">&quot;/apps/tomcat/bin/ru…&quot;</span>   11 minutes ago   Up 11 minutes   8009/tcp, 0.0.0.0:8082-&gt;8080/tcp, :::8082-&gt;8080/tcp   client2</span><br><span class="line">2fb21a5681ca   tomcat-web:app1   <span class="string">&quot;/apps/tomcat/bin/ru…&quot;</span>   11 minutes ago   Up 11 minutes   8009/tcp, 0.0.0.0:8081-&gt;8080/tcp, :::8081-&gt;8080/tcp   client1</span><br><span class="line"></span><br><span class="line">[root@rocky8 ~]<span class="comment"># docker run -d --name client3 --volumes-from volume-server -p 8083:8080 tomcat-web:app1</span></span><br><span class="line">d33c495361824608003a0543bef493bc99cf7b85d74597df3ac15a5ea0d4128b</span><br><span class="line"></span><br><span class="line">[root@rocky8 ~]<span class="comment"># docker ps -a</span></span><br><span class="line">CONTAINER ID   IMAGE             COMMAND                  CREATED          STATUS                            PORTS                                                 NAMES</span><br><span class="line">d33c49536182   tomcat-web:app1   <span class="string">&quot;/apps/tomcat/bin/ru…&quot;</span>   15 seconds ago   Up 14 seconds                     8009/tcp, 0.0.0.0:8083-&gt;8080/tcp, :::8083-&gt;8080/tcp   client3</span><br><span class="line">7d0cf30474af   tomcat-web:app1   <span class="string">&quot;/apps/tomcat/bin/ru…&quot;</span>   12 minutes ago   Up 12 minutes                     8009/tcp, 0.0.0.0:8082-&gt;8080/tcp, :::8082-&gt;8080/tcp   client2</span><br><span class="line">2fb21a5681ca   tomcat-web:app1   <span class="string">&quot;/apps/tomcat/bin/ru…&quot;</span>   12 minutes ago   Up 12 minutes                     8009/tcp, 0.0.0.0:8081-&gt;8080/tcp, :::8081-&gt;8080/tcp   client1</span><br><span class="line">1c9e7ccc82c8   tomcat-web:app1   <span class="string">&quot;/apps/tomcat/bin/ru…&quot;</span>   14 minutes ago   Exited (137) About a minute ago                                                         volume-server</span><br><span class="line"></span><br><span class="line">[root@rocky8 ~]<span class="comment"># curl 127.0.0.1:8081/testapp/</span></span><br><span class="line">testapp v6</span><br><span class="line"></span><br><span class="line">[root@rocky8 ~]<span class="comment"># curl 127.0.0.1:8082/testapp/</span></span><br><span class="line">testapp v6</span><br><span class="line"></span><br><span class="line">[root@rocky8 ~]<span class="comment"># curl 127.0.0.1:8083/testapp/</span></span><br><span class="line">testapp v6</span><br></pre></td></tr></table></figure>

<h4 id="删除源卷容器Server，访问client和创建新的client容器"><a href="#删除源卷容器Server，访问client和创建新的client容器" class="headerlink" title="删除源卷容器Server，访问client和创建新的client容器"></a>删除源卷容器Server，访问client和创建新的client容器</h4><p><strong>删除数据卷容器后，旧的client 容器仍能访问，但无法再创建新的client容器</strong></p>
<p><strong>删除数据卷容器后，旧的client 容器仍能访问，但无法再创建基于数据卷容器的新的client容器,但可以创建基于已创建的Client容器的Client容器</strong></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">[root@rocky8 ~]<span class="comment"># docker rm -f volume-server </span></span><br><span class="line">volume-server</span><br><span class="line"></span><br><span class="line">[root@rocky8 ~]<span class="comment"># docker ps -a</span></span><br><span class="line">CONTAINER ID   IMAGE             COMMAND                  CREATED          STATUS          PORTS                                                 NAMES</span><br><span class="line">d33c49536182   tomcat-web:app1   <span class="string">&quot;/apps/tomcat/bin/ru…&quot;</span>   3 minutes ago    Up 3 minutes    8009/tcp, 0.0.0.0:8083-&gt;8080/tcp, :::8083-&gt;8080/tcp   client3</span><br><span class="line">7d0cf30474af   tomcat-web:app1   <span class="string">&quot;/apps/tomcat/bin/ru…&quot;</span>   15 minutes ago   Up 15 minutes   8009/tcp, 0.0.0.0:8082-&gt;8080/tcp, :::8082-&gt;8080/tcp   client2</span><br><span class="line">2fb21a5681ca   tomcat-web:app1   <span class="string">&quot;/apps/tomcat/bin/ru…&quot;</span>   15 minutes ago   Up 15 minutes   8009/tcp, 0.0.0.0:8081-&gt;8080/tcp, :::8081-&gt;8080/tcp   client1</span><br><span class="line"></span><br><span class="line">[root@rocky8 ~]<span class="comment"># docker run -d --name client4 --volumes-from volume-server -p 8084:8080 tomcat-web:app1</span></span><br><span class="line">docker: Error response from daemon: No such container: volume-server.</span><br><span class="line">See <span class="string">&#x27;docker run --help&#x27;</span>.</span><br><span class="line"></span><br><span class="line">[root@rocky8 ~]<span class="comment"># curl 127.0.0.1:8081/testapp/</span></span><br><span class="line">testapp v6</span><br><span class="line"></span><br><span class="line">[root@rocky8 ~]<span class="comment"># curl 127.0.0.1:8082/testapp/</span></span><br><span class="line">testapp v6</span><br><span class="line"></span><br><span class="line">[root@rocky8 ~]<span class="comment"># curl 127.0.0.1:8083/testapp/</span></span><br><span class="line">testapp v6</span><br></pre></td></tr></table></figure>

<h4 id="重新创建容器卷-Server"><a href="#重新创建容器卷-Server" class="headerlink" title="重新创建容器卷 Server"></a>重新创建容器卷 Server</h4><p>重新创建容器卷容器后，还可继续创建新client 容器</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">[root@rocky8 ~]<span class="comment"># docker run -d --name volume-server \</span></span><br><span class="line">  -v /data/bin/catalina.sh:/apps/tomcat/bin/catalina.sh:ro \</span><br><span class="line">  -v /data/testapp:/data/tomcat/webapps/testapp tomcat-web:app1</span><br><span class="line">b60540d21cce2f61413cb230455bcb7a9534f0e847ef9f459d095ae6ef8f1ce9</span><br><span class="line"></span><br><span class="line">[root@rocky8 ~]<span class="comment"># docker run -d --name client4 --volumes-from volume-server -p 8084:8080 tomcat-web:app1</span></span><br><span class="line">e8813afeaeaeb0682bd02b3b0c46fff35bbc8a6bb790310bc1d76922fe004a44</span><br><span class="line"></span><br><span class="line">[root@rocky8 ~]<span class="comment"># curl 127.0.0.1:8081/testapp/</span></span><br><span class="line">testapp v6</span><br><span class="line"></span><br><span class="line">[root@rocky8 ~]<span class="comment"># curl 127.0.0.1:8082/testapp/</span></span><br><span class="line">testapp v6</span><br><span class="line"></span><br><span class="line">[root@rocky8 ~]<span class="comment"># curl 127.0.0.1:8083/testapp/</span></span><br><span class="line">testapp v6</span><br><span class="line"></span><br><span class="line">[root@rocky8 ~]<span class="comment"># curl 127.0.0.1:8084/testapp/</span></span><br><span class="line">testapp v6</span><br></pre></td></tr></table></figure>

<h3 id="利用数据卷容器备份指定容器的数据卷实现"><a href="#利用数据卷容器备份指定容器的数据卷实现" class="headerlink" title="利用数据卷容器备份指定容器的数据卷实现"></a>利用数据卷容器备份指定容器的数据卷实现</h3><p>由于匿名数据卷在宿主机中的存储位置不确定,所以为了方便的备份匿名数据卷,可以利用数据卷容器实现数据卷的备份</p>
<p><img src="../../../../images/SRE/day46/51.jpg" alt="51"></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#在执行备份命令容器上执行备份方式</span></span><br><span class="line">docker run -it --<span class="built_in">rm</span> --volumes-from [container name] -v $(<span class="built_in">pwd</span>):/backup ubuntu</span><br><span class="line">root@ca5bb2c1f877:/<span class="comment">#tar cvf /backup/backup.tar [container data volume]</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#说明</span></span><br><span class="line">[container name] <span class="comment">#表示需要备份的容器</span></span><br><span class="line">[container data volume] <span class="comment">#表示容器内的需要备份的数据卷对应的目录</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#还原方式</span></span><br><span class="line">docker run -it --<span class="built_in">rm</span> --volumes-from [container name] -V $(<span class="built_in">pwd</span>):/backup ubuntu</span><br><span class="line">root@ca5bb2c1f877:/<span class="comment">#tar xvf /backup/backup.tar -C [container data volume]</span></span><br></pre></td></tr></table></figure>

<p>范例: </p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#创建需要备份的匿名数据卷容器</span></span><br><span class="line">[root@rocky8 ~]<span class="comment"># docker run -it -v /datavolume1 --name volume-server centos:8 bash</span></span><br><span class="line"></span><br><span class="line">[root@74d45f88e427 /]<span class="comment"># ls </span></span><br><span class="line">bin	     dev  home	lib64	    media  opt	 root  sbin  sys  usr</span><br><span class="line">datavolume1  etc  lib	lost+found  mnt    proc  run   srv   tmp  var</span><br><span class="line"></span><br><span class="line">[root@74d45f88e427 /]<span class="comment"># touch /datavolume1/centos.txt</span></span><br><span class="line">[root@74d45f88e427 /]<span class="comment"># exit</span></span><br><span class="line"><span class="built_in">exit</span></span><br><span class="line"></span><br><span class="line">[root@rocky8 ~]<span class="comment"># docker ps -a</span></span><br><span class="line">CONTAINER ID   IMAGE      COMMAND   CREATED          STATUS                     PORTS     NAMES</span><br><span class="line">74d45f88e427   centos:8   <span class="string">&quot;bash&quot;</span>    34 seconds ago   Exited (0) 9 seconds ago             volume-server</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#基于前面的匿名数据卷容器创建执行备份操作的容器</span></span><br><span class="line">[root@rocky8 ~]<span class="comment"># docker run -it --rm --volumes-from volume-server -v ~/backup:/backup --name backup-server ubuntu</span></span><br><span class="line">root@c02524bf5791:/<span class="comment"># ls backup/</span></span><br><span class="line">root@c02524bf5791:/<span class="comment"># ls   </span></span><br><span class="line">backup  boot         dev  home  lib64  mnt  proc  run   srv  tmp  var</span><br><span class="line">bin     datavolume1  etc  lib   media  opt  root  sbin  sys  usr</span><br><span class="line"></span><br><span class="line">root@c02524bf5791:/<span class="comment"># ls backup/</span></span><br><span class="line">root@c02524bf5791:/<span class="comment"># ls /datavolume1/</span></span><br><span class="line">centos.txt</span><br><span class="line"></span><br><span class="line">root@c02524bf5791:/<span class="comment"># cd /datavolume1/          </span></span><br><span class="line">root@c02524bf5791:/datavolume1<span class="comment"># tar cvf /backup/data.tar .</span></span><br><span class="line">./</span><br><span class="line">./centos.txt</span><br><span class="line"></span><br><span class="line">root@c02524bf5791:/datavolume1<span class="comment"># exit</span></span><br><span class="line"><span class="built_in">exit</span></span><br><span class="line"></span><br><span class="line">[root@rocky8 ~]<span class="comment"># ls backup/</span></span><br><span class="line">data.tar</span><br><span class="line"></span><br><span class="line"><span class="comment">#删除容器的数据</span></span><br><span class="line">[root@rocky8 ~]<span class="comment"># docker start -i volume-server </span></span><br><span class="line">[root@74d45f88e427 /]<span class="comment"># rm -rf /datavolume1/*</span></span><br><span class="line">[root@74d45f88e427 /]<span class="comment"># ls /datavolume1/</span></span><br><span class="line">[root@74d45f88e427 /]<span class="comment"># exit</span></span><br><span class="line"><span class="built_in">exit</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#进行还原</span></span><br><span class="line">[root@rocky8 ~]<span class="comment"># docker run --rm --volumes-from volume-server -v ~/backup:/backup --name backup-server ubuntu tar xvf /backup/data.tar -C /datavolume1/</span></span><br><span class="line">./</span><br><span class="line">./centos.txt</span><br><span class="line"></span><br><span class="line"><span class="comment">#验证是否还原</span></span><br><span class="line">[root@rocky8 ~]<span class="comment"># docker start -i volume-server </span></span><br><span class="line">[root@74d45f88e427 /]<span class="comment"># ls /datavolume1/</span></span><br><span class="line">centos.txt</span><br></pre></td></tr></table></figure>

<p>范例： 利用数据卷容器备份MySQL数据库</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#MySQL容器默认使用了匿名卷</span></span><br><span class="line">[root@rocky8 ~]<span class="comment"># docker run -d --name mysql -p 3306:3306 -e MYSQL_ROOT_PASSWORD=123456 mysql:5.7.30 </span></span><br><span class="line">4a2d92bfb3e1f1202fd589ce4811d20a4252648118e3b70003f3eac65d112abf</span><br><span class="line"></span><br><span class="line">[root@rocky8 ~]<span class="comment"># docker volume ls</span></span><br><span class="line">DRIVER    VOLUME NAME</span><br><span class="line"><span class="built_in">local</span>     3598d975cc6a8b2f621e1e19e4109fcd1ae1815bf160b2306f80d2f2810aaa85</span><br><span class="line"></span><br><span class="line"><span class="comment">#备份数据库</span></span><br><span class="line">[root@rocky8 ~]<span class="comment"># docker run -it --rm --volumes-from mysql -v $(pwd):/backup centos:8 tar cf /backup/mysql.tar /var/lib/mysql</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#删除数据库文件</span></span><br><span class="line">[root@rocky8 ~]<span class="comment"># rm -rf /var/lib/docker/volumes/3598d975cc6a8b2f621e1e19e4109fcd1ae1815bf160b2306f80d2f2810aaa85/_data/*</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#还原数据库</span></span><br><span class="line">[root@rocky8 ~]<span class="comment"># docker run -it --rm --volumes-from mysql -v $(pwd):/backup centos:8 tar xf /backup/mysql.tar -C /var/lib/mysql</span></span><br></pre></td></tr></table></figure>

<h3 id="数据卷容器总结"><a href="#数据卷容器总结" class="headerlink" title="数据卷容器总结"></a>数据卷容器总结</h3><p>将提供卷的容器Server 删除，已经运行的容器Client依然可以使用挂载的卷，因为容器是通过挂载访问数据的，但是无法创建新的卷容器客户端，但是再把卷容器Server创建后即可正常创建卷容器Client，此方式可以用于线上共享数据目录等环境，因为即使数据卷容器被删除了，其他已经运行的容器依然可以挂载使用</p>
<p>由此可知, 数据卷容器的功能只是将数据挂载信息传递给了其它使用数据卷容器的容器,而数据卷容器本身并不提供数据存储功能</p>
<p>数据卷容器可以作为共享的方式为其他容器提供文件共享，类似于NFS共享，可以在生产中启动一个实例挂载本地的目录，然后其他的容器分别挂载此容器的目录，即可保证各容器之间的数据一致性</p>
<p>数据卷容器的 Server 和 Client 可以不使用同一个镜像生成</p>
<p>当创建Client容器时,会复制Server容器的数据卷信息,后续Server容器状态和存在与否,都不会影响Client容器使用的数据卷</p>
<p>当Server容器删除后,不能再基于Server容器创建新的Client容器,但可以基于已存在的Client容器来创建新的Client容器</p>
<p>最终实现了多个客户端容器共享相同的持久化宿主机的存储方案</p>
<h1 id="Docker-网络管理"><a href="#Docker-网络管理" class="headerlink" title="Docker 网络管理"></a>Docker 网络管理</h1><p><img src="../../../../images/SRE/day46/52.jpg" alt="52"></p>
<p>docker容器创建后，必不可少的要和其它主机或容器进行网络通信</p>
<p>官方文档:</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://docs.docker.com/network/</span><br></pre></td></tr></table></figure>

<h2 id="Docker的默认的网络通信"><a href="#Docker的默认的网络通信" class="headerlink" title="Docker的默认的网络通信"></a>Docker的默认的网络通信</h2><h3 id="Docker安装后默认的网络设置"><a href="#Docker安装后默认的网络设置" class="headerlink" title="Docker安装后默认的网络设置"></a>Docker安装后默认的网络设置</h3><p>Docker服务安装完成之后，默认在每个宿主机会生成一个名称为docker0的网卡其IP地址都是172.17.0.1/16</p>
<p>范例: 安装Docker的默认的网络配置</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">[root@rocky8 ~]<span class="comment"># ip a</span></span><br><span class="line">1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000</span><br><span class="line">    <span class="built_in">link</span>/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00</span><br><span class="line">    inet 127.0.0.1/8 scope host lo</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    inet6 ::1/128 scope host </span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">2: ens160: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc mq state UP group default qlen 1000</span><br><span class="line">    <span class="built_in">link</span>/ether 00:0c:29:71:6e:af brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    altname enp3s0</span><br><span class="line">    inet 192.168.1.11/24 brd 192.168.1.255 scope global noprefixroute ens160</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    inet6 fe80::20c:29ff:fe71:6eaf/64 scope <span class="built_in">link</span> </span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">3: docker0: &lt;NO-CARRIER,BROADCAST,MULTICAST,UP&gt; mtu 1500 qdisc noqueue state DOWN group default </span><br><span class="line">    <span class="built_in">link</span>/ether 02:42:59:31:5b:67 brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    inet 172.17.0.1/16 brd 172.17.255.255 scope global docker0</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    inet6 fe80::42:59ff:fe31:5b67/64 scope <span class="built_in">link</span> </span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@rocky8 ~]<span class="comment"># brctl show</span></span><br><span class="line">bridge name	bridge <span class="built_in">id</span>		STP enabled	interfaces</span><br><span class="line">docker0		8000.024259315b67	no	</span><br></pre></td></tr></table></figure>

<h3 id="创建容器后的网络配置"><a href="#创建容器后的网络配置" class="headerlink" title="创建容器后的网络配置"></a>创建容器后的网络配置</h3><p>每次新建容器后</p>
<ul>
<li>宿主机多了一个虚拟网卡，和容器的网卡组合成一个网卡，比如: 137: veth8ca6d43@if136，而在容器内的网卡名为136，可以看出和宿主机的网卡之间的关联</li>
<li>容器会自动获取一个172.17.0.0/16网段的随机地址，默认从172.17.0.2开始分配给第1个容器使用，第2个容器为172.17.0.3，以此类推</li>
<li>容器获取的地址并不固定,每次容器重启,可能会发生地址变化</li>
</ul>
<h4 id="创建第一个容器后的网络状态"><a href="#创建第一个容器后的网络状态" class="headerlink" title="创建第一个容器后的网络状态"></a>创建第一个容器后的网络状态</h4><p>范例: 创建容器，容器自动获取IP地址</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">[root@rocky8 ~]<span class="comment"># docker run -it --rm alpine sh</span></span><br><span class="line">/ <span class="comment"># ip a</span></span><br><span class="line">1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN qlen 1000</span><br><span class="line">    <span class="built_in">link</span>/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00</span><br><span class="line">    inet 127.0.0.1/8 scope host lo</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    inet6 ::1/128 scope host </span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">366: eth0@if367: &lt;BROADCAST,MULTICAST,UP,LOWER_UP,M-DOWN&gt; mtu 1500 qdisc noqueue state UP </span><br><span class="line">    <span class="built_in">link</span>/ether 02:42:ac:11:00:02 brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    inet 172.17.0.2/16 brd 172.17.255.255 scope global eth0</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">       </span><br><span class="line">/ <span class="comment"># cat /etc/hosts</span></span><br><span class="line">127.0.0.1	localhost</span><br><span class="line">::1	localhost ip6-localhost ip6-loopback</span><br><span class="line">fe00::0	ip6-localnet</span><br><span class="line">ff00::0	ip6-mcastprefix</span><br><span class="line">ff02::1	ip6-allnodes</span><br><span class="line">ff02::2	ip6-allrouters</span><br><span class="line">172.17.0.2	7f5ae721e596</span><br><span class="line"></span><br><span class="line">[root@rocky8 ~]<span class="comment"># docker ps</span></span><br><span class="line">CONTAINER ID   IMAGE     COMMAND   CREATED          STATUS          PORTS     NAMES</span><br><span class="line">7f5ae721e596   alpine    <span class="string">&quot;sh&quot;</span>      30 seconds ago   Up 30 seconds             epic_antonelli</span><br></pre></td></tr></table></figure>

<p>范例: 新建第一个容器，宿主机的网卡多了一个新网卡</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">[root@rocky8 ~]<span class="comment"># ip a</span></span><br><span class="line">1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000</span><br><span class="line">    <span class="built_in">link</span>/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00</span><br><span class="line">    inet 127.0.0.1/8 scope host lo</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    inet6 ::1/128 scope host </span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">2: ens160: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc mq state UP group default qlen 1000</span><br><span class="line">    <span class="built_in">link</span>/ether 00:0c:29:71:6e:af brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    altname enp3s0</span><br><span class="line">    inet 192.168.1.11/24 brd 192.168.1.255 scope global noprefixroute ens160</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    inet6 fe80::20c:29ff:fe71:6eaf/64 scope <span class="built_in">link</span> </span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">3: docker0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue state UP group default </span><br><span class="line">    <span class="built_in">link</span>/ether 02:42:59:31:5b:67 brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    inet 172.17.0.1/16 brd 172.17.255.255 scope global docker0</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    inet6 fe80::42:59ff:fe31:5b67/64 scope <span class="built_in">link</span> </span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">367: veth753221b@if366: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue master docker0 state UP group default </span><br><span class="line">    <span class="built_in">link</span>/ether 1e:17:3c:42:c4:15 brd ff:ff:ff:ff:ff:ff link-netnsid 0</span><br><span class="line">    inet6 fe80::1c17:3cff:fe42:c415/64 scope <span class="built_in">link</span> </span><br><span class="line">       valid_lft forever preferred_lft forever</span><br></pre></td></tr></table></figure>

<p>范例: 查看新建容器后桥接状态</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@rocky8 ~]<span class="comment"># brctl show</span></span><br><span class="line">bridge name	bridge <span class="built_in">id</span>		STP enabled	interfaces</span><br><span class="line">docker0		8000.024259315b67	no		veth753221b</span><br></pre></td></tr></table></figure>

<h4 id="创建第二个容器后面的网络状态"><a href="#创建第二个容器后面的网络状态" class="headerlink" title="创建第二个容器后面的网络状态"></a>创建第二个容器后面的网络状态</h4><p>范例: 再次创建第二个容器</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">[root@rocky8 ~]<span class="comment"># docker run -it --rm alpine sh</span></span><br><span class="line">/ <span class="comment"># ip a</span></span><br><span class="line">1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN qlen 1000</span><br><span class="line">    <span class="built_in">link</span>/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00</span><br><span class="line">    inet 127.0.0.1/8 scope host lo</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    inet6 ::1/128 scope host </span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">368: eth0@if369: &lt;BROADCAST,MULTICAST,UP,LOWER_UP,M-DOWN&gt; mtu 1500 qdisc noqueue state UP </span><br><span class="line">    <span class="built_in">link</span>/ether 02:42:ac:11:00:03 brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    inet 172.17.0.3/16 brd 172.17.255.255 scope global eth0</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">       </span><br><span class="line">/ <span class="comment"># cat /etc/hosts</span></span><br><span class="line">127.0.0.1	localhost</span><br><span class="line">::1	localhost ip6-localhost ip6-loopback</span><br><span class="line">fe00::0	ip6-localnet</span><br><span class="line">ff00::0	ip6-mcastprefix</span><br><span class="line">ff02::1	ip6-allnodes</span><br><span class="line">ff02::2	ip6-allrouters</span><br><span class="line">172.17.0.3	7e2db63c597b</span><br><span class="line"></span><br><span class="line">/ <span class="comment"># ping 7f5ae721e596</span></span><br><span class="line">PING 7f5ae721e596 (205.178.189.129): 56 data bytes</span><br><span class="line">64 bytes from 205.178.189.129: <span class="built_in">seq</span>=0 ttl=127 time=252.690 ms</span><br><span class="line">64 bytes from 205.178.189.129: <span class="built_in">seq</span>=1 ttl=127 time=278.889 ms</span><br><span class="line"></span><br><span class="line">[root@rocky8 ~]<span class="comment"># docker ps</span></span><br><span class="line">CONTAINER ID   IMAGE     COMMAND   CREATED         STATUS         PORTS     NAMES</span><br><span class="line">7e2db63c597b   alpine    <span class="string">&quot;sh&quot;</span>      2 minutes ago   Up 2 minutes             hardcore_easley</span><br><span class="line">7f5ae721e596   alpine    <span class="string">&quot;sh&quot;</span>      4 minutes ago   Up 4 minutes             epic_antonelli</span><br></pre></td></tr></table></figure>

<p>范例: 新建第二个容器后宿主机又多了一个虚拟网卡</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">[root@rocky8 ~]<span class="comment"># ip a</span></span><br><span class="line">1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000</span><br><span class="line">    <span class="built_in">link</span>/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00</span><br><span class="line">    inet 127.0.0.1/8 scope host lo</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    inet6 ::1/128 scope host </span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">2: ens160: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc mq state UP group default qlen 1000</span><br><span class="line">    <span class="built_in">link</span>/ether 00:0c:29:71:6e:af brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    altname enp3s0</span><br><span class="line">    inet 192.168.1.11/24 brd 192.168.1.255 scope global noprefixroute ens160</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    inet6 fe80::20c:29ff:fe71:6eaf/64 scope <span class="built_in">link</span> </span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">3: docker0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue state UP group default </span><br><span class="line">    <span class="built_in">link</span>/ether 02:42:59:31:5b:67 brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    inet 172.17.0.1/16 brd 172.17.255.255 scope global docker0</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    inet6 fe80::42:59ff:fe31:5b67/64 scope <span class="built_in">link</span> </span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">367: veth753221b@if366: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue master docker0 state UP group default </span><br><span class="line">    <span class="built_in">link</span>/ether 1e:17:3c:42:c4:15 brd ff:ff:ff:ff:ff:ff link-netnsid 0</span><br><span class="line">    inet6 fe80::1c17:3cff:fe42:c415/64 scope <span class="built_in">link</span> </span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">369: veth721158f@if368: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue master docker0 state UP group default </span><br><span class="line">    <span class="built_in">link</span>/ether 5e:5d:<span class="built_in">fc</span>:33:c1:93 brd ff:ff:ff:ff:ff:ff link-netnsid 1</span><br><span class="line">    inet6 fe80::5c5d:fcff:fe33:c193/64 scope <span class="built_in">link</span> </span><br><span class="line">       valid_lft forever preferred_lft forever</span><br></pre></td></tr></table></figure>

<p>范例: 查看新建第二个容器后桥接状态</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@rocky8 ~]<span class="comment"># brctl show</span></span><br><span class="line">bridge name	bridge <span class="built_in">id</span>		STP enabled	interfaces</span><br><span class="line">docker0		8000.024259315b67	no		veth721158f</span><br><span class="line">						            	veth753221b</span><br></pre></td></tr></table></figure>

<h3 id="容器间的通信"><a href="#容器间的通信" class="headerlink" title="容器间的通信"></a>容器间的通信</h3><h4 id="同一个宿主机的不同容器可相互通信"><a href="#同一个宿主机的不同容器可相互通信" class="headerlink" title="同一个宿主机的不同容器可相互通信"></a>同一个宿主机的不同容器可相互通信</h4><p>默认情况下</p>
<ul>
<li>同一个宿主机的不同容器之间可以相互通信</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">dockerd   --icc   Enable inter-container communication (default <span class="literal">true</span>)</span><br><span class="line">--icc=<span class="literal">false</span>  <span class="comment">#此配置可以禁止同一个宿主机的容器之间通信</span></span><br></pre></td></tr></table></figure>

<ul>
<li>不同宿主机之间的容器IP地址重复，默认不能相互通信</li>
</ul>
<p>范例: 同一个宿主机的容器之间访问</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">[root@rocky8 ~]<span class="comment"># docker run -it --rm alpine sh</span></span><br><span class="line">/ <span class="comment"># cat /etc/hosts</span></span><br><span class="line">127.0.0.1	localhost</span><br><span class="line">::1	localhost ip6-localhost ip6-loopback</span><br><span class="line">fe00::0	ip6-localnet</span><br><span class="line">ff00::0	ip6-mcastprefix</span><br><span class="line">ff02::1	ip6-allnodes</span><br><span class="line">ff02::2	ip6-allrouters</span><br><span class="line">172.17.0.2	7f5ae721e596</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@rocky8 ~]<span class="comment"># docker run -it --rm alpine sh</span></span><br><span class="line">/ <span class="comment"># cat /etc/hosts</span></span><br><span class="line">127.0.0.1	localhost</span><br><span class="line">::1	localhost ip6-localhost ip6-loopback</span><br><span class="line">fe00::0	ip6-localnet</span><br><span class="line">ff00::0	ip6-mcastprefix</span><br><span class="line">ff02::1	ip6-allnodes</span><br><span class="line">ff02::2	ip6-allrouters</span><br><span class="line">172.17.0.3	7e2db63c597b</span><br><span class="line"></span><br><span class="line">/ <span class="comment"># ping 7f5ae721e596</span></span><br><span class="line">PING 7f5ae721e596 (205.178.189.129): 56 data bytes</span><br><span class="line">64 bytes from 205.178.189.129: <span class="built_in">seq</span>=0 ttl=127 time=252.690 ms</span><br><span class="line">64 bytes from 205.178.189.129: <span class="built_in">seq</span>=1 ttl=127 time=278.889 ms</span><br></pre></td></tr></table></figure>

<h4 id="禁止同一个宿主机的不同容器间通信"><a href="#禁止同一个宿主机的不同容器间通信" class="headerlink" title="禁止同一个宿主机的不同容器间通信"></a>禁止同一个宿主机的不同容器间通信</h4><p>范例: 同一个宿主机不同容器间禁止通信</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#dockerd 的 --icc=false 选项可以禁止同一个宿主机的不同容器间通信</span></span><br><span class="line">[root@rocky8 ~]<span class="comment"># vim /lib/systemd/system/docker.service</span></span><br><span class="line">ExecStart=/usr/bin/dockerd -H fd:// --containerd=/run/containerd/containerd.sock --icc=<span class="literal">false</span></span><br><span class="line"></span><br><span class="line">[root@rocky8 ~]<span class="comment"># systemctl daemon-reload </span></span><br><span class="line">[root@rocky8 ~]<span class="comment"># systemctl restart docker.service </span></span><br><span class="line"></span><br><span class="line"><span class="comment">#创建两个容器,测试无法通信</span></span><br><span class="line">[root@rocky8 ~]<span class="comment"># docker run -it --rm alpine  sh</span></span><br><span class="line">/ <span class="comment"># hostname -i</span></span><br><span class="line">172.17.0.2</span><br><span class="line"></span><br><span class="line">[root@rocky8 ~]<span class="comment"># docker run -it --rm alpine  sh</span></span><br><span class="line">/ <span class="comment"># hostname -i</span></span><br><span class="line">172.17.0.3</span><br><span class="line"></span><br><span class="line">/ <span class="comment"># ping 172.17.0.2</span></span><br><span class="line">PING 172.17.0.2 (172.17.0.2): 56 data bytes</span><br><span class="line">      ^C </span><br><span class="line">--- 172.17.0.2 ping statistics ---</span><br><span class="line">13 packets transmitted, 0 packets received, 100% packet loss</span><br></pre></td></tr></table></figure>

<p>范例: 在第二个宿主机上创建容器，跨宿主机的容器之间默认不能通信</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@rocky8 /]<span class="comment"># docker run -it --rm alpine  sh</span></span><br><span class="line">/ <span class="comment"># ping 172.17.0.3</span></span><br><span class="line">PING 172.17.0.3 (172.17.0.3): 56 data bytes</span><br><span class="line">^C</span><br><span class="line">--- 172.17.0.3 ping statistics ---</span><br><span class="line">7 packets transmitted, 0 packets received, 100% packet loss</span><br></pre></td></tr></table></figure>

<h3 id="修改默认docker0网桥的网络配置"><a href="#修改默认docker0网桥的网络配置" class="headerlink" title="修改默认docker0网桥的网络配置"></a>修改默认docker0网桥的网络配置</h3><p>默认docker后会自动生成一个docker0的网桥,使用的IP是172.17.0.1/16,可能和宿主机的网段发生冲突,可以将其修改为其它网段的地址,避免冲突</p>
<p>范例: 将docker0的IP修改为指定IP</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#方法1</span></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment"># vim /etc/docker/daemon.json </span></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment"># cat /etc/docker/daemon.json</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;bip&quot;</span>: <span class="string">&quot;192.168.100.1/24&quot;</span>,</span><br><span class="line">    <span class="string">&quot;registry-mirrors&quot;</span>: [<span class="string">&quot;https://si7y70hh.mirror.aliyuncs.com&quot;</span>]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment"># systemctl restart docker.service</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#方法2</span></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment"># vim /lib/systemd/system/docker.service</span></span><br><span class="line">ExecStart=/usr/bin/dockerd -H fd:// --containerd=/run/containerd/containerd.sock --bip=192.168.100.1/24</span><br><span class="line"></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment">#systemctl daemon-reload </span></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment">#systemctl restart docker.service</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#注意两种方法不可混用,否则将无法启动docker服务</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#验证结果</span></span><br><span class="line">[root@rocky8 ~]<span class="comment"># ip a</span></span><br><span class="line">1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000</span><br><span class="line">    <span class="built_in">link</span>/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00</span><br><span class="line">    inet 127.0.0.1/8 scope host lo</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    inet6 ::1/128 scope host </span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">2: ens160: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc mq state UP group default qlen 1000</span><br><span class="line">    <span class="built_in">link</span>/ether 00:0c:29:71:6e:af brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    altname enp3s0</span><br><span class="line">    inet 192.168.1.11/24 brd 192.168.1.255 scope global noprefixroute ens160</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    inet6 fe80::20c:29ff:fe71:6eaf/64 scope <span class="built_in">link</span> </span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">3: docker0: &lt;NO-CARRIER,BROADCAST,MULTICAST,UP&gt; mtu 1500 qdisc noqueue state DOWN group default </span><br><span class="line">    <span class="built_in">link</span>/ether 02:42:59:31:5b:67 brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    inet 192.168.100.1/24 brd 192.168.100.255 scope global docker0</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    inet6 fe80::42:59ff:fe31:5b67/64 scope <span class="built_in">link</span> </span><br><span class="line">       valid_lft forever preferred_lft forever</span><br></pre></td></tr></table></figure>

<h3 id="修改默认网络设置使用自定义网桥"><a href="#修改默认网络设置使用自定义网桥" class="headerlink" title="修改默认网络设置使用自定义网桥"></a>修改默认网络设置使用自定义网桥</h3><p>新建容器默认使用docker0的网络配置,可以修改默认指向自定义的网桥网络</p>
<p>范例: 用自定义的网桥代替默认的docker0</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#查看默认网络</span></span><br><span class="line">[root@rocky8 ~]<span class="comment"># ip a</span></span><br><span class="line">1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000</span><br><span class="line">    <span class="built_in">link</span>/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00</span><br><span class="line">    inet 127.0.0.1/8 scope host lo</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    inet6 ::1/128 scope host </span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">2: ens160: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc mq state UP group default qlen 1000</span><br><span class="line">    <span class="built_in">link</span>/ether 00:0c:29:71:6e:af brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    altname enp3s0</span><br><span class="line">    inet 192.168.1.11/24 brd 192.168.1.255 scope global noprefixroute ens160</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    inet6 fe80::20c:29ff:fe71:6eaf/64 scope <span class="built_in">link</span> </span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">3: docker0: &lt;NO-CARRIER,BROADCAST,MULTICAST,UP&gt; mtu 1500 qdisc noqueue state DOWN group default </span><br><span class="line">    <span class="built_in">link</span>/ether 02:42:59:31:5b:67 brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    inet 172.17.0.1/16 brd 172.17.255.255 scope global docker0</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    inet6 fe80::42:59ff:fe31:5b67/64 scope <span class="built_in">link</span> </span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line"></span><br><span class="line">[root@rocky8 ~]<span class="comment"># yum install -y bridge-utils</span></span><br><span class="line">[root@rocky8 ~]<span class="comment"># brctl addbr br0</span></span><br><span class="line">[root@rocky8 ~]<span class="comment"># ip a a 192.168.100.1/24 dev br0</span></span><br><span class="line">[root@rocky8 ~]<span class="comment"># brctl show</span></span><br><span class="line">bridge name	bridge <span class="built_in">id</span>		STP enabled	interfaces</span><br><span class="line">br0		8000.000000000000	no		</span><br><span class="line">docker0		8000.024259315b67	no		</span><br><span class="line"></span><br><span class="line">[root@rocky8 ~]<span class="comment"># ip a</span></span><br><span class="line">1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000</span><br><span class="line">    <span class="built_in">link</span>/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00</span><br><span class="line">    inet 127.0.0.1/8 scope host lo</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    inet6 ::1/128 scope host </span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">2: ens160: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc mq state UP group default qlen 1000</span><br><span class="line">    <span class="built_in">link</span>/ether 00:0c:29:71:6e:af brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    altname enp3s0</span><br><span class="line">    inet 192.168.1.11/24 brd 192.168.1.255 scope global noprefixroute ens160</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    inet6 fe80::20c:29ff:fe71:6eaf/64 scope <span class="built_in">link</span> </span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">3: docker0: &lt;NO-CARRIER,BROADCAST,MULTICAST,UP&gt; mtu 1500 qdisc noqueue state DOWN group default </span><br><span class="line">    <span class="built_in">link</span>/ether 02:42:59:31:5b:67 brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    inet 172.17.0.1/16 brd 172.17.255.255 scope global docker0</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    inet6 fe80::42:59ff:fe31:5b67/64 scope <span class="built_in">link</span> </span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">378: br0: &lt;BROADCAST,MULTICAST&gt; mtu 1500 qdisc noop state DOWN group default qlen 1000</span><br><span class="line">    <span class="built_in">link</span>/ether d6:75:ba:11:b8:f2 brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    inet 192.168.100.1/24 scope global br0</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@rocky8 ~]<span class="comment"># vim /lib/systemd/system/docker.service </span></span><br><span class="line">ExecStart=/usr/bin/dockerd -H fd:// --containerd=/run/containerd/containerd.sock -b br0</span><br><span class="line">[root@rocky8 ~]<span class="comment"># systemctl daemon-reload </span></span><br><span class="line">[root@rocky8 ~]<span class="comment"># systemctl restart docker.service</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 如果daemon.json中也定义了pid则会报错</span></span><br><span class="line">[root@rocky8 ~]<span class="comment"># systemctl restart docker.service </span></span><br><span class="line">Job <span class="keyword">for</span> docker.service failed because the control process exited with error code.</span><br><span class="line">See <span class="string">&quot;systemctl status docker.service&quot;</span> and <span class="string">&quot;journalctl -xe&quot;</span> <span class="keyword">for</span> details.</span><br><span class="line"></span><br><span class="line">[root@rocky8 ~]<span class="comment"># ps -ef | grep dockerd</span></span><br><span class="line">root      155119       1  0 18:10 ?        00:00:00 /usr/bin/dockerd -H fd:// --containerd=/run/containerd/containerd.sock -b br0</span><br><span class="line">root      155289  133677  0 18:12 pts/1    00:00:00 grep --color=auto dockerd</span><br><span class="line"></span><br><span class="line">[root@rocky8 ~]<span class="comment"># docker run --rm alpine hostname -i</span></span><br><span class="line">192.168.100.2</span><br></pre></td></tr></table></figure>

<h2 id="容器名称互联"><a href="#容器名称互联" class="headerlink" title="容器名称互联"></a>容器名称互联</h2><p>新建容器时，docker会自动分配容器名称，容器ID和IP地址，导致容器名称，容器ID和IP都不固定，那么如何区分不同的容器，实现和确定目标容器的通信呢？解决方案是给容器起个固定的名称，容器之间通过固定名称实现确定目标的通信</p>
<p>有两种固定名称:</p>
<ul>
<li>容器名称</li>
<li>容器名称的别名</li>
</ul>
<p>注意: 两种方式都最少需要两个容器才能实现</p>
<h3 id="通过容器名称互联"><a href="#通过容器名称互联" class="headerlink" title="通过容器名称互联"></a>通过容器名称互联</h3><h4 id="容器名称介绍"><a href="#容器名称介绍" class="headerlink" title="容器名称介绍"></a>容器名称介绍</h4><p>即在同一个宿主机上的容器之间可以通过自定义的容器名称相互访问，比如: 一个业务前端静态页面是使用nginx，动态页面使用的是tomcat，另外还需要负载均衡调度器，如: haproxy 对请求调度至nginx和tomcat的容器，由于容器在启动的时候其内部IP地址是DHCP随机分配的，而给容器起个固定的名称，则是相对比较固定的，因此比较适用于此场景</p>
<p><strong>注意: 如果被引用的容器地址变化,必须重启当前容器才能生效</strong></p>
<h4 id="容器名称实现"><a href="#容器名称实现" class="headerlink" title="容器名称实现"></a>容器名称实现</h4><p>docker run 创建容器，可使用–link选项实现容器名称的引用，其本质就是在容器内的/etc/hosts中添加–link后指定的容器的IP和主机名的对应关系，从而实现名称解析</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">--<span class="built_in">link</span> list                     <span class="comment">#Add link to another container</span></span><br><span class="line"></span><br><span class="line">格式:  </span><br><span class="line">docker run --name &lt;容器名称&gt;                    <span class="comment">#先创建指定名称的容器</span></span><br><span class="line">docker run --<span class="built_in">link</span> &lt;目标通信的容器ID或容器名称&gt;     <span class="comment">#再创建容器时引用上面容器的名称</span></span><br></pre></td></tr></table></figure>

<h4 id="实战案例1-使用容器名称进行容器间通信"><a href="#实战案例1-使用容器名称进行容器间通信" class="headerlink" title="实战案例1: 使用容器名称进行容器间通信"></a>实战案例1: 使用容器名称进行容器间通信</h4><p><strong>1. 先创建第一个指定容器名称的容器</strong></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">[root@rocky8 ~]<span class="comment"># docker run -it --name server1 --rm alpine sh</span></span><br><span class="line">/ <span class="comment"># cat /etc/hosts</span></span><br><span class="line">127.0.0.1	localhost</span><br><span class="line">::1	localhost ip6-localhost ip6-loopback</span><br><span class="line">fe00::0	ip6-localnet</span><br><span class="line">ff00::0	ip6-mcastprefix</span><br><span class="line">ff02::1	ip6-allnodes</span><br><span class="line">ff02::2	ip6-allrouters</span><br><span class="line">192.168.100.2	4be083330070</span><br><span class="line"></span><br><span class="line">/ <span class="comment"># ip a</span></span><br><span class="line">1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN qlen 1000</span><br><span class="line">    <span class="built_in">link</span>/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00</span><br><span class="line">    inet 127.0.0.1/8 scope host lo</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    inet6 ::1/128 scope host </span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">381: eth0@if382: &lt;BROADCAST,MULTICAST,UP,LOWER_UP,M-DOWN&gt; mtu 1500 qdisc noqueue state UP </span><br><span class="line">    <span class="built_in">link</span>/ether 02:42:c0:a8:64:02 brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    inet 192.168.100.2/24 brd 192.168.100.255 scope global eth0</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">       </span><br><span class="line">/ <span class="comment"># ping 192.168.100.2</span></span><br><span class="line">PING 192.168.100.2 (192.168.100.2): 56 data bytes</span><br><span class="line">64 bytes from 192.168.100.2: <span class="built_in">seq</span>=0 ttl=64 time=0.082 ms</span><br><span class="line">64 bytes from 192.168.100.2: <span class="built_in">seq</span>=1 ttl=64 time=0.082 ms</span><br><span class="line">^C</span><br><span class="line">--- 192.168.100.2 ping statistics ---</span><br><span class="line">2 packets transmitted, 2 packets received, 0% packet loss</span><br><span class="line">round-trip min/avg/max = 0.082/0.082/0.082 ms</span><br><span class="line"></span><br><span class="line">/ <span class="comment"># ping server1</span></span><br><span class="line">ping: bad address <span class="string">&#x27;server1&#x27;</span></span><br><span class="line"></span><br><span class="line">/ <span class="comment"># ping 4be083330070</span></span><br><span class="line">PING 4be083330070 (192.168.100.2): 56 data bytes</span><br><span class="line">64 bytes from 192.168.100.2: <span class="built_in">seq</span>=0 ttl=64 time=0.042 ms</span><br><span class="line">64 bytes from 192.168.100.2: <span class="built_in">seq</span>=1 ttl=64 time=0.065 ms</span><br><span class="line">^C</span><br><span class="line">--- 4be083330070 ping statistics ---</span><br><span class="line">2 packets transmitted, 2 packets received, 0% packet loss</span><br><span class="line">round-trip min/avg/max = 0.042/0.053/0.065 ms</span><br></pre></td></tr></table></figure>

<p><strong>2. 新建第二个容器时引用第一个容器的名称</strong></p>
<p>会自动将第一个主机的名称加入/etc/hosts文件,从而可以利用第一个容器名称进行访问</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line">[root@rocky8 ~]<span class="comment"># docker run -it --name server2 --rm  --link server1 alpine sh</span></span><br><span class="line">/ <span class="comment"># env</span></span><br><span class="line">HOSTNAME=a10a01eee894</span><br><span class="line">SHLVL=1</span><br><span class="line">HOME=/root</span><br><span class="line">SERVER1_NAME=/server2/server1</span><br><span class="line">TERM=xterm</span><br><span class="line">PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin</span><br><span class="line">PWD=/</span><br><span class="line"></span><br><span class="line">/ <span class="comment"># cat /etc/hosts</span></span><br><span class="line">127.0.0.1	localhost</span><br><span class="line">::1	localhost ip6-localhost ip6-loopback</span><br><span class="line">fe00::0	ip6-localnet</span><br><span class="line">ff00::0	ip6-mcastprefix</span><br><span class="line">ff02::1	ip6-allnodes</span><br><span class="line">ff02::2	ip6-allrouters</span><br><span class="line">192.168.100.2	server1 4be083330070</span><br><span class="line">192.168.100.3	a10a01eee894</span><br><span class="line"></span><br><span class="line">/ <span class="comment"># ping server1</span></span><br><span class="line">PING server1 (192.168.100.2): 56 data bytes</span><br><span class="line">64 bytes from 192.168.100.2: <span class="built_in">seq</span>=0 ttl=64 time=0.229 ms</span><br><span class="line">64 bytes from 192.168.100.2: <span class="built_in">seq</span>=1 ttl=64 time=0.133 ms</span><br><span class="line">^C</span><br><span class="line">--- server1 ping statistics ---</span><br><span class="line">2 packets transmitted, 2 packets received, 0% packet loss</span><br><span class="line">round-trip min/avg/max = 0.133/0.181/0.229 ms</span><br><span class="line"></span><br><span class="line">/ <span class="comment"># cat /etc/hosts</span></span><br><span class="line">127.0.0.1	localhost</span><br><span class="line">::1	localhost ip6-localhost ip6-loopback</span><br><span class="line">fe00::0	ip6-localnet</span><br><span class="line">ff00::0	ip6-mcastprefix</span><br><span class="line">ff02::1	ip6-allnodes</span><br><span class="line">ff02::2	ip6-allrouters</span><br><span class="line">192.168.100.2	server1 4be083330070</span><br><span class="line">192.168.100.3	a10a01eee894</span><br><span class="line"></span><br><span class="line">/ <span class="comment"># ping server2</span></span><br><span class="line">ping: bad address <span class="string">&#x27;server2&#x27;</span></span><br><span class="line"></span><br><span class="line">/ <span class="comment"># ping 4be083330070</span></span><br><span class="line">PING 4be083330070 (192.168.100.2): 56 data bytes</span><br><span class="line">64 bytes from 192.168.100.2: <span class="built_in">seq</span>=0 ttl=64 time=0.118 ms</span><br><span class="line">^C</span><br><span class="line">--- 4be083330070 ping statistics ---</span><br><span class="line">1 packets transmitted, 1 packets received, 0% packet loss</span><br><span class="line">round-trip min/avg/max = 0.118/0.118/0.118 ms</span><br><span class="line"></span><br><span class="line">/ <span class="comment"># ping a10a01eee894</span></span><br><span class="line">PING a10a01eee894 (192.168.100.3): 56 data bytes</span><br><span class="line">64 bytes from 192.168.100.3: <span class="built_in">seq</span>=0 ttl=64 time=0.100 ms</span><br><span class="line">64 bytes from 192.168.100.3: <span class="built_in">seq</span>=1 ttl=64 time=0.077 ms</span><br><span class="line">^C</span><br><span class="line">--- a10a01eee894 ping statistics ---</span><br><span class="line">2 packets transmitted, 2 packets received, 0% packet loss</span><br><span class="line">round-trip min/avg/max = 0.077/0.088/0.100 ms</span><br><span class="line"></span><br><span class="line">[root@rocky8 /]<span class="comment"># docker ps</span></span><br><span class="line">CONTAINER ID   IMAGE     COMMAND   CREATED         STATUS         PORTS     NAMES</span><br><span class="line">a10a01eee894   alpine    <span class="string">&quot;sh&quot;</span>      2 minutes ago   Up 2 minutes             server2</span><br><span class="line">4be083330070   alpine    <span class="string">&quot;sh&quot;</span>      5 minutes ago   Up 5 minutes             server1</span><br></pre></td></tr></table></figure>

<h4 id="实战案例2-实现-wordpress-和-MySQL-两个容器互连"><a href="#实战案例2-实现-wordpress-和-MySQL-两个容器互连" class="headerlink" title="实战案例2: 实现 wordpress 和 MySQL 两个容器互连"></a>实战案例2: 实现 wordpress 和 MySQL 两个容器互连</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">[root@rocky8 ~]<span class="comment"># mkdir -p lamp_docker/mysql</span></span><br><span class="line">[root@rocky8 ~]<span class="comment"># vim lamp_docker/env_mysql.list</span></span><br><span class="line">[root@rocky8 ~]<span class="comment"># vim lamp_docker/env_wordpress.list </span></span><br><span class="line">[root@rocky8 ~]<span class="comment"># vim lamp_docker/mysql/mysql_test.cnf</span></span><br><span class="line"></span><br><span class="line">[root@rocky8 ~]<span class="comment"># tree lamp_docker/</span></span><br><span class="line">lamp_docker/</span><br><span class="line">├── env_mysql.list</span><br><span class="line">├── env_wordpress.list</span><br><span class="line">└── mysql</span><br><span class="line">    └── mysql_test.cnf</span><br><span class="line"></span><br><span class="line">1 directory, 3 files</span><br><span class="line"></span><br><span class="line">[root@rocky8 ~]<span class="comment"># cat lamp_docker/env_mysql.list </span></span><br><span class="line">MYSQL_ROOT_PASSWORD=123456</span><br><span class="line">MYSQL_DATABASE=wordpress</span><br><span class="line">MYSQL_USER=wpuser</span><br><span class="line">MYSQL_PASSWORD=wppass</span><br><span class="line"></span><br><span class="line">[root@rocky8 ~]<span class="comment"># cat lamp_docker/env_wordpress.list </span></span><br><span class="line">WORDPRESS_DB_HOST=mysql:3306</span><br><span class="line">WORDPRESS_DB_NAME=wordpress</span><br><span class="line">WORDPRESS_DB_USER=wpuser</span><br><span class="line">WORDPRESS_DB_PASSWORD=wppass</span><br><span class="line">WORDPRESS_TABLE_PREFIX=wp_</span><br><span class="line"></span><br><span class="line">[root@rocky8 ~]<span class="comment"># cat lamp_docker/mysql/mysql_test.cnf </span></span><br><span class="line">[mysqld]</span><br><span class="line">server-id=100</span><br><span class="line">log-bin=mysql-bin</span><br><span class="line"></span><br><span class="line">[root@rocky8 ~]<span class="comment"># docker run --name mysql \</span></span><br><span class="line">-v /root/lamp_docker/mysql/:/etc/mysql/conf.d \</span><br><span class="line">-v /data/mysql:/var/lib/mysql \</span><br><span class="line">--env-file=/root/lamp_docker/env_mysql.list \</span><br><span class="line">-d -p 3306:3306 mysql:5.7.30 </span><br><span class="line"></span><br><span class="line">[root@rocky8 ~]<span class="comment"># docker run -d --name wordpress \</span></span><br><span class="line">--<span class="built_in">link</span> mysql -v /data/wordpress:/var/www/html/wp-content \</span><br><span class="line">--env-file=/root/lamp_docker/env_wordpress.list \</span><br><span class="line">-p 80:80 wordpress:php7.4-apache </span><br></pre></td></tr></table></figure>

<p><img src="../../../../images/SRE/day46/53.jpg" alt="53"></p>
<p><img src="../../../../images/SRE/day46/54.jpg" alt="54"></p>
<h3 id="通过自定义容器别名互联"><a href="#通过自定义容器别名互联" class="headerlink" title="通过自定义容器别名互联"></a>通过自定义容器别名互联</h3><h4 id="容器别名介绍"><a href="#容器别名介绍" class="headerlink" title="容器别名介绍"></a>容器别名介绍</h4><p>自定义的容器名称可能后期会发生变化，那么一旦名称发生变化，容器内程序之间也必须要随之发生变化，比如:程序通过固定的容器名称进行服务调用，但是容器名称发生变化之后再使用之前的名称肯定是无法成功调用，每次都进行更改的话又比较麻烦，因此可以使用自定义别名的方式解决，即容器名称可以随意更改，只要不更改别名即可</p>
<h4 id="容器别名实现"><a href="#容器别名实现" class="headerlink" title="容器别名实现"></a>容器别名实现</h4><p>命令格式: </p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">docker run --name &lt;容器名称&gt; </span><br><span class="line"><span class="comment">#先创建指定名称的容器</span></span><br><span class="line"></span><br><span class="line">docker run --name &lt;容器名称&gt; --<span class="built_in">link</span> &lt;目标容器名称&gt;:<span class="string">&quot;&lt;容器别名1&gt; &lt;容器别名2&gt; ...&quot;</span> </span><br><span class="line"><span class="comment">#给上面创建的容器起别名,来创建新容器</span></span><br></pre></td></tr></table></figure>

<h4 id="实战案例-使用容器别名"><a href="#实战案例-使用容器别名" class="headerlink" title="实战案例: 使用容器别名"></a>实战案例: 使用容器别名</h4><p>范例: 创建第三个容器，引用前面创建的容器，并起别名</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">[root@rocky8 ~]<span class="comment"># docker run -it --name server1 --rm alpine sh</span></span><br><span class="line">[root@rocky8 ~]<span class="comment"># docker run -it --rm --name server3 --link server1:server1-alias alpine</span></span><br><span class="line">/ <span class="comment"># env</span></span><br><span class="line">HOSTNAME=b593c2b99a62</span><br><span class="line">SHLVL=1</span><br><span class="line">HOME=/root</span><br><span class="line">TERM=xterm</span><br><span class="line">PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin</span><br><span class="line">PWD=/</span><br><span class="line">SERVER1_ALIAS_NAME=/server3/server1-<span class="built_in">alias</span></span><br><span class="line"></span><br><span class="line">/ <span class="comment"># cat /etc/hosts</span></span><br><span class="line">127.0.0.1	localhost</span><br><span class="line">::1	localhost ip6-localhost ip6-loopback</span><br><span class="line">fe00::0	ip6-localnet</span><br><span class="line">ff00::0	ip6-mcastprefix</span><br><span class="line">ff02::1	ip6-allnodes</span><br><span class="line">ff02::2	ip6-allrouters</span><br><span class="line">172.17.0.4	server1-alias 0c6696f75e1d server1</span><br><span class="line">172.17.0.5	b593c2b99a62</span><br><span class="line"></span><br><span class="line">/ <span class="comment"># ping server1</span></span><br><span class="line">PING server1 (172.17.0.4): 56 data bytes</span><br><span class="line">64 bytes from 172.17.0.4: <span class="built_in">seq</span>=0 ttl=64 time=0.118 ms</span><br><span class="line"></span><br><span class="line">/ <span class="comment"># ping server1-alias</span></span><br><span class="line">PING server1-alias (172.17.0.4): 56 data bytes</span><br><span class="line">64 bytes from 172.17.0.4: <span class="built_in">seq</span>=0 ttl=64 time=0.129 ms</span><br></pre></td></tr></table></figure>

<p>范例: 创建第四个容器，引用前面创建的容器，并起多个别名</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[root@rocky8 ~]<span class="comment"># docker run -it --rm --name server4 --link server1:&quot;server1-alias1 server1-alias2&quot; alpine</span></span><br><span class="line">/ <span class="comment"># cat /etc/hosts</span></span><br><span class="line">127.0.0.1	localhost</span><br><span class="line">::1	localhost ip6-localhost ip6-loopback</span><br><span class="line">fe00::0	ip6-localnet</span><br><span class="line">ff00::0	ip6-mcastprefix</span><br><span class="line">ff02::1	ip6-allnodes</span><br><span class="line">ff02::2	ip6-allrouters</span><br><span class="line">172.17.0.4	server1-alias1 server1-alias2 0c6696f75e1d server1</span><br><span class="line">172.17.0.6	d969ab602d04</span><br><span class="line"></span><br><span class="line">/ <span class="comment"># ping server1-alias2</span></span><br><span class="line">PING server1-alias2 (172.17.0.4): 56 data bytes</span><br><span class="line">64 bytes from 172.17.0.4: <span class="built_in">seq</span>=0 ttl=64 time=0.151 ms</span><br><span class="line">64 bytes from 172.17.0.4: <span class="built_in">seq</span>=1 ttl=64 time=0.128 ms</span><br></pre></td></tr></table></figure>

<h2 id="Docker-网络连接模式"><a href="#Docker-网络连接模式" class="headerlink" title="Docker 网络连接模式"></a>Docker 网络连接模式</h2><h3 id="网络模式介绍"><a href="#网络模式介绍" class="headerlink" title="网络模式介绍"></a>网络模式介绍</h3><p><img src="../../../../images/SRE/day46/55.jpg" alt="55"></p>
<p>Docker 的网络支持5种网络模式:</p>
<ul>
<li>none</li>
<li>bridge</li>
<li>host</li>
<li>container</li>
<li>network-name</li>
</ul>
<p>范例: 查看默认的网络模式有三个</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@rocky8 ~]<span class="comment"># docker network ls</span></span><br><span class="line">NETWORK ID     NAME      DRIVER    SCOPE</span><br><span class="line">4048bc584ca0   bridge    bridge    <span class="built_in">local</span></span><br><span class="line">aef2f5228637   host      host      <span class="built_in">local</span></span><br><span class="line">3709f184390d   none      null      <span class="built_in">local</span></span><br></pre></td></tr></table></figure>

<h3 id="网络模式指定"><a href="#网络模式指定" class="headerlink" title="网络模式指定"></a>网络模式指定</h3><p>默认新建的容器使用Bridge模式，创建容器时，docker run 命令使用以下选项指定网络模式</p>
<p>格式</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">docker run --network &lt;mode&gt;</span><br><span class="line">docker run --net=&lt;mode&gt;</span><br><span class="line"></span><br><span class="line">&lt;mode&gt;: 可是以下值</span><br><span class="line">none</span><br><span class="line">bridge</span><br><span class="line">host</span><br><span class="line">container:&lt;容器名或容器ID&gt;</span><br><span class="line">&lt;自定义网络名称&gt;</span><br></pre></td></tr></table></figure>

<h3 id="bridge网络模式"><a href="#bridge网络模式" class="headerlink" title="bridge网络模式"></a>bridge网络模式</h3><h4 id="bridge-网络模式架构"><a href="#bridge-网络模式架构" class="headerlink" title="bridge 网络模式架构"></a>bridge 网络模式架构</h4><p><img src="../../../../images/SRE/day46/56.jpg" alt="56"></p>
<p>本模式是docker的默认模式，即不指定任何模式就是bridge模式，也是使用比较多的模式，此模式创建的容器会为每一个容器分配自己的网络 IP 等信息，并将容器连接到一个虚拟网桥与外界通信</p>
<p><img src="../../../../images/SRE/day46/57.jpg" alt="57"></p>
<p>可以和外部网络之间进行通信，通过SNAT访问外网，使用DNAT可以让容器被外部主机访问，所以此模式也称为NAT模式</p>
<p>此模式宿主机需要启动ip_forward功能</p>
<p>bridge网络模式特点</p>
<ul>
<li>网络资源隔离: 不同宿主机的容器无法直接通信，各自使用独立网络</li>
<li>无需手动配置: 容器默认自动获取172.17.0.0/16的IP地址，此地址可以修改</li>
<li>可访问外网: 利用宿主机的物理网卡，SNAT连接外网</li>
<li>外部主机无法直接访问容器: 可以通过配置DNAT接受外网的访问</li>
<li>低性能较低: 因为可通过NAT，网络转换带来更的损耗</li>
<li>端口管理繁琐: 每个容器必须手动指定唯一的端口，容器产生端口冲容</li>
</ul>
<h4 id="bridge-模式的默认设置"><a href="#bridge-模式的默认设置" class="headerlink" title="bridge 模式的默认设置"></a>bridge 模式的默认设置</h4><p>范例: 查看bridge模式信息</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line">[root@rocky8 ~]<span class="comment"># docker network inspect bridge </span></span><br><span class="line">[</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="string">&quot;Name&quot;</span>: <span class="string">&quot;bridge&quot;</span>,</span><br><span class="line">        <span class="string">&quot;Id&quot;</span>: <span class="string">&quot;4048bc584ca02c83479e862bd60c153886afb02987e57b4c04a2d73e916ad516&quot;</span>,</span><br><span class="line">        <span class="string">&quot;Created&quot;</span>: <span class="string">&quot;2025-04-11T14:19:27.916624164+08:00&quot;</span>,</span><br><span class="line">        <span class="string">&quot;Scope&quot;</span>: <span class="string">&quot;local&quot;</span>,</span><br><span class="line">        <span class="string">&quot;Driver&quot;</span>: <span class="string">&quot;bridge&quot;</span>,</span><br><span class="line">        <span class="string">&quot;EnableIPv6&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">        <span class="string">&quot;IPAM&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;Driver&quot;</span>: <span class="string">&quot;default&quot;</span>,</span><br><span class="line">            <span class="string">&quot;Options&quot;</span>: null,</span><br><span class="line">            <span class="string">&quot;Config&quot;</span>: [</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="string">&quot;Subnet&quot;</span>: <span class="string">&quot;172.17.0.0/16&quot;</span>,</span><br><span class="line">                    <span class="string">&quot;Gateway&quot;</span>: <span class="string">&quot;172.17.0.1&quot;</span></span><br><span class="line">                &#125;</span><br><span class="line">            ]</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">&quot;Internal&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">        <span class="string">&quot;Attachable&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">        <span class="string">&quot;Ingress&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">        <span class="string">&quot;ConfigFrom&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;Network&quot;</span>: <span class="string">&quot;&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">&quot;ConfigOnly&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">        <span class="string">&quot;Containers&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;8cc94ae40dd2e69ca1aee9e7ed9ff756445c28f35d5bc41dc59de16770175d14&quot;</span>: &#123;</span><br><span class="line">                <span class="string">&quot;Name&quot;</span>: <span class="string">&quot;mysql&quot;</span>,</span><br><span class="line">                <span class="string">&quot;EndpointID&quot;</span>: <span class="string">&quot;b5fdf2a3dda5ea2e746ab9eb6794f59d53bddfcca7a85b92069e40b6bd236c12&quot;</span>,</span><br><span class="line">                <span class="string">&quot;MacAddress&quot;</span>: <span class="string">&quot;02:42:ac:11:00:02&quot;</span>,</span><br><span class="line">                <span class="string">&quot;IPv4Address&quot;</span>: <span class="string">&quot;172.17.0.2/16&quot;</span>,</span><br><span class="line">                <span class="string">&quot;IPv6Address&quot;</span>: <span class="string">&quot;&quot;</span></span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="string">&quot;db145a4d599893bd37609ba258bbe336a06257d31ee2f70535ae095a505d4974&quot;</span>: &#123;</span><br><span class="line">                <span class="string">&quot;Name&quot;</span>: <span class="string">&quot;wordpress&quot;</span>,</span><br><span class="line">                <span class="string">&quot;EndpointID&quot;</span>: <span class="string">&quot;2e3b69ecb7b72b4aa935fe28e7373bc91b760ee4d47dec67de5e0190c074c1c1&quot;</span>,</span><br><span class="line">                <span class="string">&quot;MacAddress&quot;</span>: <span class="string">&quot;02:42:ac:11:00:03&quot;</span>,</span><br><span class="line">                <span class="string">&quot;IPv4Address&quot;</span>: <span class="string">&quot;172.17.0.3/16&quot;</span>,</span><br><span class="line">                <span class="string">&quot;IPv6Address&quot;</span>: <span class="string">&quot;&quot;</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">&quot;Options&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;com.docker.network.bridge.default_bridge&quot;</span>: <span class="string">&quot;true&quot;</span>,</span><br><span class="line">            <span class="string">&quot;com.docker.network.bridge.enable_icc&quot;</span>: <span class="string">&quot;true&quot;</span>,</span><br><span class="line">            <span class="string">&quot;com.docker.network.bridge.enable_ip_masquerade&quot;</span>: <span class="string">&quot;true&quot;</span>,</span><br><span class="line">            <span class="string">&quot;com.docker.network.bridge.host_binding_ipv4&quot;</span>: <span class="string">&quot;0.0.0.0&quot;</span>,</span><br><span class="line">            <span class="string">&quot;com.docker.network.bridge.name&quot;</span>: <span class="string">&quot;docker0&quot;</span>,</span><br><span class="line">            <span class="string">&quot;com.docker.network.driver.mtu&quot;</span>: <span class="string">&quot;1500&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">&quot;Labels&quot;</span>: &#123;&#125;</span><br><span class="line">    &#125;</span><br><span class="line">]</span><br></pre></td></tr></table></figure>

<p>范例: 宿主机的网络状态</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#安装docker后.默认启用ip_forward</span></span><br><span class="line">[root@rocky8 ~]<span class="comment"># cat /proc/sys/net/ipv4/ip_forward</span></span><br><span class="line">1</span><br><span class="line"></span><br><span class="line">[root@rocky8 ~]<span class="comment"># iptables -vnL -t nat</span></span><br><span class="line">Chain PREROUTING (policy ACCEPT 0 packets, 0 bytes)</span><br><span class="line"> pkts bytes target     prot opt <span class="keyword">in</span>     out     <span class="built_in">source</span>               destination         </span><br><span class="line">   11   572 DOCKER     all  --  *      *       0.0.0.0/0            0.0.0.0/0            ADDRTYPE match dst-type LOCAL</span><br><span class="line"></span><br><span class="line">Chain INPUT (policy ACCEPT 0 packets, 0 bytes)</span><br><span class="line"> pkts bytes target     prot opt <span class="keyword">in</span>     out     <span class="built_in">source</span>               destination         </span><br><span class="line"></span><br><span class="line">Chain POSTROUTING (policy ACCEPT 0 packets, 0 bytes)</span><br><span class="line"> pkts bytes target     prot opt <span class="keyword">in</span>     out     <span class="built_in">source</span>               destination         </span><br><span class="line">   11   711 MASQUERADE  all  --  *      !docker0  172.17.0.0/16        0.0.0.0/0           </span><br><span class="line">    0     0 MASQUERADE  tcp  --  *      *       172.17.0.2           172.17.0.2           tcp dpt:3306</span><br><span class="line">    0     0 MASQUERADE  tcp  --  *      *       172.17.0.3           172.17.0.3           tcp dpt:80</span><br><span class="line"></span><br><span class="line">Chain OUTPUT (policy ACCEPT 0 packets, 0 bytes)</span><br><span class="line"> pkts bytes target     prot opt <span class="keyword">in</span>     out     <span class="built_in">source</span>               destination         </span><br><span class="line">    0     0 DOCKER     all  --  *      *       0.0.0.0/0           !127.0.0.0/8          ADDRTYPE match dst-type LOCAL</span><br><span class="line"></span><br><span class="line">Chain DOCKER (2 references)</span><br><span class="line"> pkts bytes target     prot opt <span class="keyword">in</span>     out     <span class="built_in">source</span>               destination         </span><br><span class="line">    0     0 RETURN     all  --  docker0 *       0.0.0.0/0            0.0.0.0/0           </span><br><span class="line">    0     0 DNAT       tcp  --  !docker0 *       0.0.0.0/0            0.0.0.0/0            tcp dpt:3306 to:172.17.0.2:3306</span><br><span class="line">    9   468 DNAT       tcp  --  !docker0 *       0.0.0.0/0            0.0.0.0/0            tcp dpt:80 to:172.17.0.3:80</span><br></pre></td></tr></table></figure>

<p>范例: 通过宿主机的物理网卡利用SNAT访问外部网络</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#在另一台主机上建立httpd服务器</span></span><br><span class="line">[root@centos7 ~]<span class="comment">#systemctl is-active httpd</span></span><br><span class="line">active</span><br><span class="line"><span class="comment">#启动容器，默认是bridge网络模式</span></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment">#docker run -it --rm alpine:3.11 sh</span></span><br><span class="line">/ <span class="comment"># ip a</span></span><br><span class="line">1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN qlen 1000</span><br><span class="line">   <span class="built_in">link</span>/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00</span><br><span class="line">   inet 127.0.0.1/8 scope host lo</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">166: eth0@if167: &lt;BROADCAST,MULTICAST,UP,LOWER_UP,M-DOWN&gt; mtu 1500 qdisc noqueue </span><br><span class="line">state UP </span><br><span class="line">   <span class="built_in">link</span>/ether 02:42:ac:11:00:02 brd ff:ff:ff:ff:ff:ff</span><br><span class="line">   inet 172.17.0.2/16 brd 172.17.255.255 scope global eth0</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line"></span><br><span class="line"><span class="comment">#可能访问其它宿主机</span></span><br><span class="line">/ <span class="comment"># ping 10.0.0.7</span></span><br><span class="line">PING 10.0.0.7 (10.0.0.7): 56 data bytes</span><br><span class="line">64 bytes from 10.0.0.7: <span class="built_in">seq</span>=0 ttl=63 time=0.764 ms</span><br><span class="line"></span><br><span class="line">/ <span class="comment"># ping www.baidu.com</span></span><br><span class="line">PING www.baidu.com (61.135.169.125): 56 data bytes</span><br><span class="line">64 bytes from 61.135.169.125: <span class="built_in">seq</span>=0 ttl=127 time=5.182 ms</span><br><span class="line"></span><br><span class="line">/ <span class="comment"># traceroute 10.0.0.7</span></span><br><span class="line">traceroute to 10.0.0.7 (10.0.0.7), 30 hops max, 46 byte packets</span><br><span class="line">1  172.17.0.1 (172.17.0.1)  0.008 ms  0.008 ms  0.007 ms</span><br><span class="line">2  10.0.0.7 (10.0.0.7)  0.255 ms  0.510 ms  0.798 ms</span><br><span class="line"></span><br><span class="line">/ <span class="comment"># wget -qO - 10.0.0.7</span></span><br><span class="line">Website on 10.0.0.7</span><br><span class="line"></span><br><span class="line">/ <span class="comment"># route -n</span></span><br><span class="line">Kernel IP routing table</span><br><span class="line">Destination     Gateway         Genmask         Flags Metric Ref   Use Iface</span><br><span class="line">0.0.0.0         172.17.0.1      0.0.0.0         UG    0      0        0 eth0</span><br><span class="line">172.17.0.0      0.0.0.0         255.255.0.0     U     0      0        0 eth0</span><br><span class="line"></span><br><span class="line">[root@centos7 ~]<span class="comment"># curl 127.0.0.1</span></span><br><span class="line">Website on 10.0.0.7</span><br><span class="line"></span><br><span class="line">[root@centos7 ~]<span class="comment"># tail /var/log/httpd/access_log </span></span><br><span class="line">127.0.0.1 - - [01/Feb/2020:19:31:16 +0800] <span class="string">&quot;GET / HTTP/1.1&quot;</span> 200 20 <span class="string">&quot;-&quot;</span> <span class="string">&quot;curl/7.29.0&quot;</span></span><br><span class="line">10.0.0.100 - - [01/Feb/2020:19:31:21 +0800] <span class="string">&quot;GET / HTTP/1.1&quot;</span> 200 20 <span class="string">&quot;-&quot;</span> <span class="string">&quot;Wget&quot;</span></span><br></pre></td></tr></table></figure>

<h4 id="修改默认的-bridge-模式网络配置"><a href="#修改默认的-bridge-模式网络配置" class="headerlink" title="修改默认的 bridge 模式网络配置"></a>修改默认的 bridge 模式网络配置</h4><p>有两种方法修改默认的bridge 模式的网络配置，但两种方式只能选一种，否则会导致冲容，docker服务无法启动</p>
<p>范例: 修改bridge模式默认的网段方法1</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@ubuntu1804 ~]<span class="comment"># vim /lib/systemd/system/docker.service</span></span><br><span class="line">ExecStart=/usr/bin/dockerd -H fd:// --containerd=/run/containerd/containerd.sock --bip=10.100.0.1/24</span><br><span class="line"></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment"># systemctl daemon-reload</span></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment"># systemctl restart docker</span></span><br></pre></td></tr></table></figure>

<p>范例: 修改bridge网络配置方法2</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[root@ubuntu1804 ~]<span class="comment">#vim /etc/docker/daemon.json</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;hosts&quot;</span>: [<span class="string">&quot;tcp://0.0.0.0:2375&quot;</span>, <span class="string">&quot;fd://&quot;</span>],</span><br><span class="line">  <span class="string">&quot;bip&quot;</span>: <span class="string">&quot;192.168.100.100/24&quot;</span>,           <span class="comment">#分配docker0网卡的IP,24是容器IP的netmask</span></span><br><span class="line">  <span class="string">&quot;fixed-cidr&quot;</span>: <span class="string">&quot;192.168.100.128/26&quot;</span>,    <span class="comment">#分配容器IP范围,26不是容器IP的子网掩码,只表示地址范围</span></span><br><span class="line">  <span class="string">&quot;fixed-cidr-v6&quot;</span>: <span class="string">&quot;2001:db8::/64&quot;</span>,</span><br><span class="line">  <span class="string">&quot;mtu&quot;</span>: 1500,</span><br><span class="line">  <span class="string">&quot;default-gateway&quot;</span>: <span class="string">&quot;192.168.100.200&quot;</span>,  <span class="comment">#网关必须和bip在同一个网段</span></span><br><span class="line">  <span class="string">&quot;default-gateway-v6&quot;</span>: <span class="string">&quot;2001:db8:abcd::89&quot;</span>,</span><br><span class="line">  <span class="string">&quot;dns&quot;</span>: [ <span class="string">&quot;1.1.1.1&quot;</span>, <span class="string">&quot;8.8.8.8&quot;</span>]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment">#systemctl restart docker </span></span><br></pre></td></tr></table></figure>

<h3 id="Host-模式"><a href="#Host-模式" class="headerlink" title="Host 模式"></a>Host 模式</h3><p><img src="../../../../images/SRE/day46/58.jpg" alt="58"></p>
<p>如果指定host模式启动的容器，那么新创建的容器不会创建自己的虚拟网卡，而是直接使用宿主机的网卡和IP地址，因此在容器里面查看到的IP信息就是宿主机的信息，访问容器的时候直接使用宿主机IP+容器端口即可，不过容器内除网络以外的其它资源，如: 文件系统、系统进程等仍然和宿主机保持隔离</p>
<p>此模式由于直接使用宿主机的网络无需转换，网络性能最高，但是各容器内使用的端口不能相同，适用于运行容器端口比较固定的业务</p>
<p>Host 网络模式特点: </p>
<ul>
<li>使用参数 –network host 指定</li>
<li>共享宿主机网络</li>
<li>网络性能无损耗</li>
<li>网络故障排除相对简单</li>
<li>各容器网络无隔离</li>
<li>网络资源无法分别统计</li>
<li>端口管理困难: 容易产生端口冲突</li>
<li>不支持端口映射</li>
</ul>
<p>范例: </p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#查看宿主机的网络设置</span></span><br><span class="line">[root@rocky8 ~]<span class="comment"># ifconfig </span></span><br><span class="line">docker0: flags=4099&lt;UP,BROADCAST,MULTICAST&gt;  mtu 1500</span><br><span class="line">        inet 172.17.0.1  netmask 255.255.0.0  broadcast 172.17.255.255</span><br><span class="line">        inet6 fe80::42:6dff:fe39:e862  prefixlen 64  scopeid 0x20&lt;<span class="built_in">link</span>&gt;</span><br><span class="line">        ether 02:42:6d:39:e8:62  txqueuelen 0  (Ethernet)</span><br><span class="line">        RX packets 221  bytes 460817 (450.0 KiB)</span><br><span class="line">        RX errors 0  dropped 0  overruns 0  frame 0</span><br><span class="line">        TX packets 218  bytes 827111 (807.7 KiB)</span><br><span class="line">        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0</span><br><span class="line"></span><br><span class="line">ens160: flags=4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt;  mtu 1500</span><br><span class="line">        inet 192.168.1.11  netmask 255.255.255.0  broadcast 192.168.1.255</span><br><span class="line">        inet6 fe80::20c:29ff:fe71:6eaf  prefixlen 64  scopeid 0x20&lt;<span class="built_in">link</span>&gt;</span><br><span class="line">        ether 00:0c:29:71:6e:af  txqueuelen 1000  (Ethernet)</span><br><span class="line">        RX packets 14534  bytes 16576014 (15.8 MiB)</span><br><span class="line">        RX errors 0  dropped 0  overruns 0  frame 0</span><br><span class="line">        TX packets 3734  bytes 769276 (751.2 KiB)</span><br><span class="line">        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0</span><br><span class="line"></span><br><span class="line">lo: flags=73&lt;UP,LOOPBACK,RUNNING&gt;  mtu 65536</span><br><span class="line">        inet 127.0.0.1  netmask 255.0.0.0</span><br><span class="line">        inet6 ::1  prefixlen 128  scopeid 0x10&lt;host&gt;</span><br><span class="line">        loop  txqueuelen 1000  (Local Loopback)</span><br><span class="line">        RX packets 0  bytes 0 (0.0 B)</span><br><span class="line">        RX errors 0  dropped 0  overruns 0  frame 0</span><br><span class="line">        TX packets 0  bytes 0 (0.0 B)</span><br><span class="line">        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@rocky8 ~]<span class="comment"># route -n</span></span><br><span class="line">Kernel IP routing table</span><br><span class="line">Destination     Gateway         Genmask         Flags Metric Ref    Use Iface</span><br><span class="line">0.0.0.0         192.168.1.2     0.0.0.0         UG    100    0        0 ens160</span><br><span class="line">172.17.0.0      0.0.0.0         255.255.0.0     U     0      0        0 docker0</span><br><span class="line">192.168.1.0     0.0.0.0         255.255.255.0   U     100    0        0 ens160</span><br><span class="line"></span><br><span class="line"><span class="comment">#打开容器前确认宿主机的80/tcp端口没有打开</span></span><br><span class="line">[root@rocky8 ~]<span class="comment"># ss -lnt | grep 80</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#创建host模式的容器</span></span><br><span class="line">[root@rocky8 ~]<span class="comment"># docker run -d --network host --name web1 nginx</span></span><br><span class="line">f63085341930c4ca47d765a7029c730c10eb6a517d06fed86422dd0aa9b7e52a</span><br><span class="line"></span><br><span class="line"><span class="comment">#创建容器后，宿主机的80/tcp端口打开</span></span><br><span class="line">[root@rocky8 ~]<span class="comment"># ss -lnt | grep 80</span></span><br><span class="line">LISTEN 0      511          0.0.0.0:80        0.0.0.0:*          </span><br><span class="line">LISTEN 0      511             [::]:80           [::]:*          </span><br><span class="line"></span><br><span class="line"><span class="comment">#进入容器</span></span><br><span class="line">[root@rocky8 ~]<span class="comment"># docker exec -it web1 bash</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#进入容器后仍显示宿主机的主机名提示符信息</span></span><br><span class="line">root@rocky8:/<span class="comment"># hostname </span></span><br><span class="line">rocky8</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#从容器访问远程主机</span></span><br><span class="line">[root@rocky8 ~]<span class="comment"># curl 192.168.1.11</span></span><br><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;<span class="built_in">head</span>&gt;</span><br><span class="line">&lt;title&gt;Welcome to nginx!&lt;/title&gt;</span><br><span class="line">&lt;style&gt;</span><br><span class="line">html &#123; color-scheme: light dark; &#125;</span><br><span class="line">body &#123; width: 35em; margin: 0 auto;</span><br><span class="line">font-family: Tahoma, Verdana, Arial, sans-serif; &#125;</span><br><span class="line">&lt;/style&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">&lt;h1&gt;Welcome to nginx!&lt;/h1&gt;</span><br><span class="line">&lt;p&gt;If you see this page, the nginx web server is successfully installed and</span><br><span class="line">working. Further configuration is required.&lt;/p&gt;</span><br><span class="line"></span><br><span class="line">&lt;p&gt;For online documentation and support please refer to</span><br><span class="line">&lt;a href=<span class="string">&quot;http://nginx.org/&quot;</span>&gt;nginx.org&lt;/a&gt;.&lt;br/&gt;</span><br><span class="line">Commercial support is available at</span><br><span class="line">&lt;a href=<span class="string">&quot;http://nginx.com/&quot;</span>&gt;nginx.com&lt;/a&gt;.&lt;/p&gt;</span><br><span class="line"></span><br><span class="line">&lt;p&gt;&lt;em&gt;Thank you <span class="keyword">for</span> using nginx.&lt;/em&gt;&lt;/p&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure>

<p>范例: host模式下端口映射无法实现</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@rocky8 ~]<span class="comment"># docker run -d --network host --name web2 -p 81:80 nginx</span></span><br><span class="line">WARNING: Published ports are discarded when using host network mode</span><br><span class="line">2036d93321c622cf004bf38ff6f78c64c327eb6d6446266f3b34e6faddaf3aab</span><br><span class="line"></span><br><span class="line"><span class="comment">#host模块下端口映射不成功，但是容器可以启动</span></span><br><span class="line">[root@rocky8 ~]<span class="comment"># docker ps -l</span></span><br><span class="line">CONTAINER ID   IMAGE     COMMAND                  CREATED          STATUS                      PORTS     NAMES</span><br><span class="line">2036d93321c6   nginx     <span class="string">&quot;/docker-entrypoint.…&quot;</span>   25 seconds ago   Exited (1) 22 seconds ago             web2</span><br></pre></td></tr></table></figure>

<p>范例: 对比前面host模式的容器和bridge模式的端口映射</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@rocky8 ~]<span class="comment"># docker port web1</span></span><br><span class="line">[root@rocky8 ~]<span class="comment"># docker port web2</span></span><br><span class="line">[root@rocky8 ~]<span class="comment"># docker run -d --network bridge -p 8001:80 --name web3 nginx</span></span><br><span class="line">2a97a0f7764c336c45fb6302c66fc6ee5af647d50fea68f5b2957a9f5d820bd1</span><br><span class="line"></span><br><span class="line">[root@rocky8 ~]<span class="comment"># docker port web3</span></span><br><span class="line">80/tcp -&gt; 0.0.0.0:8001</span><br><span class="line">80/tcp -&gt; [::]:8001</span><br></pre></td></tr></table></figure>

<h3 id="none-模式"><a href="#none-模式" class="headerlink" title="none 模式"></a>none 模式</h3><p>在使用none 模式后，Docker 容器不会进行任何网络配置，没有网卡、没有IP也没有路由，因此默认无法与外界通信，需要手动添加网卡配置IP等，所以极少使用</p>
<p>none模式特点</p>
<ul>
<li>使用参数 –network none指定</li>
<li>默认无网络功能，无法和外部通信</li>
<li>无法实现端口映射</li>
<li>适用于测试环境</li>
</ul>
<p>范例: 启动none模式的容器</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">[root@rocky8 ~]<span class="comment"># docker run -d --network none -p 8001:80 --name web1-none nginx</span></span><br><span class="line">1e06466d3bf508c5e630909e741365339f4877095f0092fd267b79c335766698</span><br><span class="line"></span><br><span class="line">[root@rocky8 ~]<span class="comment"># docker ps</span></span><br><span class="line">CONTAINER ID   IMAGE     COMMAND                  CREATED         STATUS         PORTS     NAMES</span><br><span class="line">1e06466d3bf5   nginx     <span class="string">&quot;/docker-entrypoint.…&quot;</span>   4 seconds ago   Up 3 seconds             web1-none</span><br><span class="line"></span><br><span class="line">[root@rocky8 ~]<span class="comment"># docker exec -it web1-none</span></span><br><span class="line">[root@5207dcbd0aee /]<span class="comment"># ifconfig -a</span></span><br><span class="line">lo: flags=73&lt;UP,LOOPBACK,RUNNING&gt; mtu 65536</span><br><span class="line">       inet 127.0.0.1 netmask 255.0.0.0</span><br><span class="line">       loop txqueuelen 1000 (Local Loopback)</span><br><span class="line">       RX packets 0 bytes 0 (0.0 B)</span><br><span class="line">       RX errors 0 dropped 0 overruns 0 frame 0</span><br><span class="line">       TX packets 0 bytes 0 (0.0 B)</span><br><span class="line">       TX errors 0 dropped 0 overruns 0 carrier 0 collisions 0</span><br><span class="line">       </span><br><span class="line">[root@5207dcbd0aee /]<span class="comment"># route -n</span></span><br><span class="line">Kernel IP routing table</span><br><span class="line">Destination     Gateway         Genmask         Flags Metric Ref   Use Iface</span><br><span class="line"></span><br><span class="line">[root@5207dcbd0aee /]<span class="comment"># netstat -ntl</span></span><br><span class="line">Active Internet connections (only servers)</span><br><span class="line">Proto Recv-Q Send-Q Local Address           Foreign Address         State      </span><br><span class="line">tcp        0      0 0.0.0.0:80              0.0.0.0:*               LISTEN     </span><br><span class="line"></span><br><span class="line">[root@5207dcbd0aee /]<span class="comment"># ping www.baidu.com</span></span><br><span class="line">ping: www.baidu.com: Name or service not known</span><br><span class="line"></span><br><span class="line">[root@5207dcbd0aee /]<span class="comment"># ping 172.17.0.1</span></span><br><span class="line">connect: Network is unreachable</span><br></pre></td></tr></table></figure>

<h3 id="Container-模式"><a href="#Container-模式" class="headerlink" title="Container 模式"></a>Container 模式</h3><p><img src="../../../../images/SRE/day46/59.jpg" alt="59"></p>
<p>使用此模式创建的容器需指定和一个已经存在的容器共享一个网络，而不是和宿主机共享网络，新创建的容器不会创建自己的网卡也不会配置自己的IP，而是和一个被指定的已经存在的容器共享IP和端口范围，因此这个容器的端口不能和被指定容器的端口冲突，除了网络之外的文件系统、进程信息等仍然保持相互隔离，两个容器的进程可以通过lo网卡进行通信</p>
<p>Container 模式特点</p>
<ul>
<li>使用参数 –-network container:名称或ID指定</li>
<li>与宿主机网络空间隔离</li>
<li>空器间共享网络空间</li>
<li>适合频繁的容器间的网络通信</li>
<li>直接使用对方的网络，较少使用</li>
</ul>
<p>范例： 通过容器模式实现 wordpress</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@rocky8 ~]<span class="comment"># docker run -d -p 80:80 --name wordpress \</span></span><br><span class="line"> -v /data/wordpress:/var/www/html --restart=always wordpress:php7.4-apache</span><br><span class="line">82c534f135fb2340632b450142b712ad762f4e62e69662e334324b24ad15b3e4</span><br><span class="line"></span><br><span class="line">[root@rocky8 ~]<span class="comment"># docker run --network container:wordpress \</span></span><br><span class="line"> -e MYSQL_ROOT_PASSWORD=123456 -e MYSQL_DATABASE=wordpress \</span><br><span class="line"> -e MYSQL_USER=wordpress -e MYSQL_PASSWORD=123456 \</span><br><span class="line"> -v /data/mysql:/var/lib/mysql --name mysql -d --restart=always mysql:8.0.29-oracle</span><br><span class="line">515083b8ced2fe1bfff6ab8c541f36b814d250980f7f4c69f5d6ba81390bac96</span><br></pre></td></tr></table></figure>

<p><img src="../../../../images/SRE/day46/60.jpg" alt="60"></p>
<p>范例: </p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#创建第一个容器</span></span><br><span class="line">[root@rocky8 ~]<span class="comment"># docker run -it --name server1 -p 80:80 alpine sh</span></span><br><span class="line">/ <span class="comment"># ifconfig</span></span><br><span class="line">eth0      Link encap:Ethernet  HWaddr 02:42:AC:11:00:02  </span><br><span class="line">          inet addr:172.17.0.2  Bcast:172.17.255.255  Mask:255.255.0.0</span><br><span class="line">          UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1</span><br><span class="line">          RX packets:8 errors:0 dropped:0 overruns:0 frame:0</span><br><span class="line">          TX packets:0 errors:0 dropped:0 overruns:0 carrier:0</span><br><span class="line">          collisions:0 txqueuelen:0 </span><br><span class="line">          RX bytes:736 (736.0 B)  TX bytes:0 (0.0 B)</span><br><span class="line"></span><br><span class="line">lo        Link encap:Local Loopback  </span><br><span class="line">          inet addr:127.0.0.1  Mask:255.0.0.0</span><br><span class="line">          inet6 addr: ::1/128 Scope:Host</span><br><span class="line">          UP LOOPBACK RUNNING  MTU:65536  Metric:1</span><br><span class="line">          RX packets:0 errors:0 dropped:0 overruns:0 frame:0</span><br><span class="line">          TX packets:0 errors:0 dropped:0 overruns:0 carrier:0</span><br><span class="line">          collisions:0 txqueuelen:1000 </span><br><span class="line">          RX bytes:0 (0.0 B)  TX bytes:0 (0.0 B)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">/ <span class="comment"># netstat -ntl</span></span><br><span class="line">Active Internet connections (only servers)</span><br><span class="line">Proto Recv-Q Send-Q Local Address           Foreign Address         State  </span><br><span class="line"></span><br><span class="line"><span class="comment">#在另一个终端执行下面操作</span></span><br><span class="line">[root@rocky8 ~]<span class="comment"># docker ps</span></span><br><span class="line">CONTAINER ID   IMAGE     COMMAND   CREATED          STATUS          PORTS                               NAMES</span><br><span class="line">92287d1cc7fe   alpine    <span class="string">&quot;sh&quot;</span>      40 seconds ago   Up 39 seconds   0.0.0.0:80-&gt;80/tcp, :::80-&gt;80/tcp   server1</span><br><span class="line"></span><br><span class="line">[root@rocky8 ~]<span class="comment"># docker port server1 </span></span><br><span class="line">80/tcp -&gt; 0.0.0.0:80</span><br><span class="line">80/tcp -&gt; [::]:80</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#无法访问web服务</span></span><br><span class="line">[root@rocky8 ~]<span class="comment"># curl 127.0.0.1</span></span><br><span class="line">curl: (56) Recv failure: Connection reset by peer</span><br><span class="line"></span><br><span class="line"><span class="comment">#创建第二个容器，基于第一个容器的container的网络模式</span></span><br><span class="line">[root@rocky8 ~]<span class="comment"># docker run -d --name server2 --network container:server1 nginx</span></span><br><span class="line">1ddae1258f466d5043dcf25dc97084bad747261c22dc21bc1dcbd70cf07a5aef</span><br><span class="line"></span><br><span class="line"><span class="comment">#可以访问web服务</span></span><br><span class="line">[root@rocky8 ~]<span class="comment"># curl 127.0.0.1</span></span><br><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;<span class="built_in">head</span>&gt;</span><br><span class="line">&lt;title&gt;Welcome to nginx!&lt;/title&gt;</span><br><span class="line">&lt;style&gt;</span><br><span class="line">html &#123; color-scheme: light dark; &#125;</span><br><span class="line">body &#123; width: 35em; margin: 0 auto;</span><br><span class="line">font-family: Tahoma, Verdana, Arial, sans-serif; &#125;</span><br><span class="line">&lt;/style&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">&lt;h1&gt;Welcome to nginx!&lt;/h1&gt;</span><br><span class="line">&lt;p&gt;If you see this page, the nginx web server is successfully installed and</span><br><span class="line">working. Further configuration is required.&lt;/p&gt;</span><br><span class="line"></span><br><span class="line">&lt;p&gt;For online documentation and support please refer to</span><br><span class="line">&lt;a href=<span class="string">&quot;http://nginx.org/&quot;</span>&gt;nginx.org&lt;/a&gt;.&lt;br/&gt;</span><br><span class="line">Commercial support is available at</span><br><span class="line">&lt;a href=<span class="string">&quot;http://nginx.com/&quot;</span>&gt;nginx.com&lt;/a&gt;.&lt;/p&gt;</span><br><span class="line"></span><br><span class="line">&lt;p&gt;&lt;em&gt;Thank you <span class="keyword">for</span> using nginx.&lt;/em&gt;&lt;/p&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment">#和第一个容器共享相同的网络</span></span><br><span class="line">[root@rocky8 ~]<span class="comment"># docker exec -it server2 sh</span></span><br><span class="line"><span class="comment"># cat /etc/hosts      </span></span><br><span class="line">127.0.0.1	localhost</span><br><span class="line">::1	localhost ip6-localhost ip6-loopback</span><br><span class="line">fe00::0	ip6-localnet</span><br><span class="line">ff00::0	ip6-mcastprefix</span><br><span class="line">ff02::1	ip6-allnodes</span><br><span class="line">ff02::2	ip6-allrouters</span><br><span class="line">172.17.0.2	92287d1cc7fe</span><br><span class="line"></span><br><span class="line"><span class="comment">#可访问外网</span></span><br><span class="line">ping www.baidu.com</span><br><span class="line">64 bytes from 61.135.169.121 (61.135.169.121): icmp_seq=1 ttl=127 time=3.99 ms</span><br></pre></td></tr></table></figure>

<p>范例: 第一个容器使用host网络模式,第二个容器与之共享网络</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">[root@ubuntu1804 ~]<span class="comment"># docker run -d --name c1 --network host nginx-centos7.8:v5.0-1.18.0</span></span><br><span class="line">5a60804f3917d82dfe32db140411cf475f20acce0fe4674d94e4557e1003d8e0</span><br><span class="line"></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment"># docker run -it --name c2 --network container:c1 centos7.8:v1.0</span></span><br><span class="line"></span><br><span class="line">[root@ubuntu1804 /]<span class="comment"># ip a</span></span><br><span class="line">1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group </span><br><span class="line">default qlen 1000</span><br><span class="line">   <span class="built_in">link</span>/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00</span><br><span class="line">   inet 127.0.0.1/8 scope host lo</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">   inet6 ::1/128 scope host </span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">2: eth0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc fq_codel state UP </span><br><span class="line">group default qlen 1000</span><br><span class="line">   <span class="built_in">link</span>/ether 00:0c:29:63:8b:ac brd ff:ff:ff:ff:ff:ff</span><br><span class="line">   inet 10.0.0.100/24 brd 10.0.0.255 scope global eth0</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">   inet6 fe80::20c:29ff:fe63:8bac/64 scope <span class="built_in">link</span> </span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">3: docker0: &lt;NO-CARRIER,BROADCAST,MULTICAST,UP&gt; mtu 1500 qdisc noqueue state </span><br><span class="line">DOWN group default </span><br><span class="line">   <span class="built_in">link</span>/ether 02:42:24:86:98:fb brd ff:ff:ff:ff:ff:ff</span><br><span class="line">   inet 172.17.0.1/16 brd 172.17.255.255 scope global docker0</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">   inet6 fe80::42:24ff:fe86:98fb/64 scope <span class="built_in">link</span> </span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">       </span><br><span class="line">[root@ubuntu1804 ~]<span class="comment"># docker exec -it c1 bash</span></span><br><span class="line">[root@ubuntu1804 /]<span class="comment"># ip a</span></span><br><span class="line">1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group </span><br><span class="line">default qlen 1000</span><br><span class="line">   <span class="built_in">link</span>/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00</span><br><span class="line">   inet 127.0.0.1/8 scope host lo</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">   inet6 ::1/128 scope host </span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">2: eth0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc fq_codel state UP </span><br><span class="line">group default qlen 1000</span><br><span class="line">   <span class="built_in">link</span>/ether 00:0c:29:63:8b:ac brd ff:ff:ff:ff:ff:ff</span><br><span class="line">   inet 10.0.0.100/24 brd 10.0.0.255 scope global eth0</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">   inet6 fe80::20c:29ff:fe63:8bac/64 scope <span class="built_in">link</span> </span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">3: docker0: &lt;NO-CARRIER,BROADCAST,MULTICAST,UP&gt; mtu 1500 qdisc noqueue state </span><br><span class="line">DOWN group default </span><br><span class="line">   <span class="built_in">link</span>/ether 02:42:24:86:98:fb brd ff:ff:ff:ff:ff:ff</span><br><span class="line">   inet 172.17.0.1/16 brd 172.17.255.255 scope global docker0</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">   inet6 fe80::42:24ff:fe86:98fb/64 scope <span class="built_in">link</span> </span><br><span class="line">       valid_lft forever preferred_lft forever</span><br></pre></td></tr></table></figure>

<p>范例:第一个容器使用none网络模式,第二个容器与之共享网络</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root@ubuntu1804 ~]<span class="comment">#docker run -d --name c1 --network none nginx-centos7.8:v5.0-1.18.0</span></span><br><span class="line">caf5b57299c8359f21f30b8894c5f8496ff39b44ead6a732056000689cb0c91c</span><br><span class="line"></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment">#docker run -it --name c2 --network container:c1 centos7.8:v1.0</span></span><br><span class="line"></span><br><span class="line">[root@caf5b57299c8 /]<span class="comment"># ip a</span></span><br><span class="line">1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group </span><br><span class="line">default qlen 1000</span><br><span class="line">   <span class="built_in">link</span>/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00</span><br><span class="line">   inet 127.0.0.1/8 scope host lo</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br></pre></td></tr></table></figure>

<h3 id="自定义网络模式"><a href="#自定义网络模式" class="headerlink" title="自定义网络模式"></a>自定义网络模式</h3><p>除了以上的网络模式，也可以自定义网络，使用自定义的网段地址，网关等信息</p>
<p><strong>注意: 自定义网络内的容器可以直接通过容器名进行相互的访问,而无需使用 –link</strong></p>
<p>可以使用自定义网络模式,实现不同集群应用的独立网络管理,而互不影响,而且在网一个网络内,可以直接利用容器名相互访问，非常便利</p>
<h4 id="自定义网络实现"><a href="#自定义网络实现" class="headerlink" title="自定义网络实现"></a>自定义网络实现</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[root@ubuntu1804 ~]<span class="comment"># docker network --help</span></span><br><span class="line"></span><br><span class="line">Usage: docker network COMMAND</span><br><span class="line"></span><br><span class="line">Manage networks</span><br><span class="line"></span><br><span class="line">Commands:</span><br><span class="line">  connect     Connect a container to a network</span><br><span class="line">  create      Create a network</span><br><span class="line">  disconnect  Disconnect a container from a network</span><br><span class="line">  inspect     Display detailed information on one or more networks</span><br><span class="line">  <span class="built_in">ls</span>          List networks</span><br><span class="line">  prune       Remove all unused networks</span><br><span class="line">  <span class="built_in">rm</span>          Remove one or more networks</span><br></pre></td></tr></table></figure>

<p>创建自定义网络: </p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">docker network create -d &lt;mode&gt; --subnet &lt;CIDR&gt; --gateway &lt;网关&gt; &lt;自定义网络名称&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment">#注意mode不支持host和none,默认是bridge模式</span></span><br></pre></td></tr></table></figure>

<p>查看自定义网络信息</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker network inspect &lt;自定义网络名称或网络ID&gt;</span><br></pre></td></tr></table></figure>

<p>引用自定义网络</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">docker run --network &lt;自定义网络名称&gt; &lt;镜像名称&gt;</span><br><span class="line">docker run --net &lt;自定义网络名称&gt; --ip &lt;指定静态IP&gt; &lt;镜像名称&gt;</span><br><span class="line"><span class="comment">#注意：静态IP只支持自定义网络模型</span></span><br></pre></td></tr></table></figure>

<p>删除自定义网络</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">doccker network <span class="built_in">rm</span> &lt;自定义网络名称或网络ID&gt;</span><br></pre></td></tr></table></figure>

<p>范例：内置的三个网络无法删除</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[root@ubuntu1804 ~]<span class="comment"># docker network rm test-net</span></span><br><span class="line">test-net</span><br><span class="line"></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment"># docker network rm none</span></span><br><span class="line">Error response from daemon: none is a pre-defined network and cannot be removed</span><br><span class="line"></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment"># docker network rm bridge</span></span><br><span class="line">Error response from daemon: bridge is a pre-defined network and cannot be </span><br><span class="line">removed</span><br><span class="line"></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment"># docker network rm host</span></span><br><span class="line">Error response from daemon: host is a pre-defined network and cannot be removed</span><br></pre></td></tr></table></figure>

<h4 id="实战案例-自定义网络"><a href="#实战案例-自定义网络" class="headerlink" title="实战案例: 自定义网络"></a>实战案例: 自定义网络</h4><h5 id="创建自定义的网络"><a href="#创建自定义的网络" class="headerlink" title="创建自定义的网络"></a>创建自定义的网络</h5><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line">[root@rocky8 ~]<span class="comment"># docker network create -d bridge --subnet 172.27.0.0/16 --gateway 172.27.0.1 test-net</span></span><br><span class="line">26dc4700293ee569474a78798d7ff862fbd4648e18539f349824130a914294ad</span><br><span class="line"></span><br><span class="line">[root@rocky8 ~]<span class="comment"># docker network ls</span></span><br><span class="line">NETWORK ID     NAME       DRIVER    SCOPE</span><br><span class="line">4048bc584ca0   bridge     bridge    <span class="built_in">local</span></span><br><span class="line">aef2f5228637   host       host      <span class="built_in">local</span></span><br><span class="line">3709f184390d   none       null      <span class="built_in">local</span></span><br><span class="line">26dc4700293e   test-net   bridge    <span class="built_in">local</span></span><br><span class="line"></span><br><span class="line">[root@rocky8 ~]<span class="comment"># docker inspect test-net </span></span><br><span class="line">[</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="string">&quot;Name&quot;</span>: <span class="string">&quot;test-net&quot;</span>,</span><br><span class="line">        <span class="string">&quot;Id&quot;</span>: <span class="string">&quot;26dc4700293ee569474a78798d7ff862fbd4648e18539f349824130a914294ad&quot;</span>,</span><br><span class="line">        <span class="string">&quot;Created&quot;</span>: <span class="string">&quot;2025-04-11T16:18:45.152295655+08:00&quot;</span>,</span><br><span class="line">        <span class="string">&quot;Scope&quot;</span>: <span class="string">&quot;local&quot;</span>,</span><br><span class="line">        <span class="string">&quot;Driver&quot;</span>: <span class="string">&quot;bridge&quot;</span>,</span><br><span class="line">        <span class="string">&quot;EnableIPv6&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">        <span class="string">&quot;IPAM&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;Driver&quot;</span>: <span class="string">&quot;default&quot;</span>,</span><br><span class="line">            <span class="string">&quot;Options&quot;</span>: &#123;&#125;,</span><br><span class="line">            <span class="string">&quot;Config&quot;</span>: [</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="string">&quot;Subnet&quot;</span>: <span class="string">&quot;172.27.0.0/16&quot;</span>,</span><br><span class="line">                    <span class="string">&quot;Gateway&quot;</span>: <span class="string">&quot;172.27.0.1&quot;</span></span><br><span class="line">                &#125;</span><br><span class="line">            ]</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">&quot;Internal&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">        <span class="string">&quot;Attachable&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">        <span class="string">&quot;Ingress&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">        <span class="string">&quot;ConfigFrom&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;Network&quot;</span>: <span class="string">&quot;&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">&quot;ConfigOnly&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">        <span class="string">&quot;Containers&quot;</span>: &#123;&#125;,</span><br><span class="line">        <span class="string">&quot;Options&quot;</span>: &#123;&#125;,</span><br><span class="line">        <span class="string">&quot;Labels&quot;</span>: &#123;&#125;</span><br><span class="line">    &#125;</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line">[root@rocky8 ~]<span class="comment"># ip a</span></span><br><span class="line">1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000</span><br><span class="line">    <span class="built_in">link</span>/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00</span><br><span class="line">    inet 127.0.0.1/8 scope host lo</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    inet6 ::1/128 scope host </span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">2: ens160: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc mq state UP group default qlen 1000</span><br><span class="line">    <span class="built_in">link</span>/ether 00:0c:29:71:6e:af brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    altname enp3s0</span><br><span class="line">    inet 192.168.1.11/24 brd 192.168.1.255 scope global noprefixroute ens160</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    inet6 fe80::20c:29ff:fe71:6eaf/64 scope <span class="built_in">link</span> </span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">3: docker0: &lt;NO-CARRIER,BROADCAST,MULTICAST,UP&gt; mtu 1500 qdisc noqueue state DOWN group default </span><br><span class="line">    <span class="built_in">link</span>/ether 02:42:6d:39:e8:62 brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    inet 172.17.0.1/16 brd 172.17.255.255 scope global docker0</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    inet6 fe80::42:6dff:fe39:e862/64 scope <span class="built_in">link</span> </span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line"><span class="comment">#新添加了一个虚拟网卡</span></span><br><span class="line">28: br-26dc4700293e: &lt;NO-CARRIER,BROADCAST,MULTICAST,UP&gt; mtu 1500 qdisc noqueue state DOWN group default </span><br><span class="line">    <span class="built_in">link</span>/ether 02:42:b8:53:5e:8e brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    inet 172.27.0.1/16 brd 172.27.255.255 scope global br-26dc4700293e</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line"></span><br><span class="line"><span class="comment">#新加了一个网桥</span></span><br><span class="line">[root@rocky8 ~]<span class="comment"># brctl show</span></span><br><span class="line">bridge name	bridge <span class="built_in">id</span>		STP enabled	interfaces</span><br><span class="line">br-26dc4700293e		8000.0242b8535e8e	no		</span><br><span class="line">docker0		8000.02426d39e862	no	</span><br><span class="line"></span><br><span class="line">[root@rocky8 ~]<span class="comment"># route -n</span></span><br><span class="line">Kernel IP routing table</span><br><span class="line">Destination     Gateway         Genmask         Flags Metric Ref    Use Iface</span><br><span class="line">0.0.0.0         192.168.1.2     0.0.0.0         UG    100    0        0 ens160</span><br><span class="line">172.17.0.0      0.0.0.0         255.255.0.0     U     0      0        0 docker0</span><br><span class="line">172.27.0.0      0.0.0.0         255.255.0.0     U     0      0        0 br-26dc4700293e</span><br><span class="line">192.168.1.0     0.0.0.0         255.255.255.0   U     100    0        0 ens160</span><br></pre></td></tr></table></figure>

<h5 id="利用自定义的网络创建容器"><a href="#利用自定义的网络创建容器" class="headerlink" title="利用自定义的网络创建容器"></a>利用自定义的网络创建容器</h5><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line">[root@rocky8 ~]<span class="comment"># docker run -it --rm --network test-net alpine sh</span></span><br><span class="line">/ <span class="comment"># ip a</span></span><br><span class="line">1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN qlen 1000</span><br><span class="line">    <span class="built_in">link</span>/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00</span><br><span class="line">    inet 127.0.0.1/8 scope host lo</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    inet6 ::1/128 scope host </span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">29: eth0@if30: &lt;BROADCAST,MULTICAST,UP,LOWER_UP,M-DOWN&gt; mtu 1500 qdisc noqueue state UP </span><br><span class="line">    <span class="built_in">link</span>/ether 02:42:ac:1b:00:02 brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    inet 172.27.0.2/16 brd 172.27.255.255 scope global eth0</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">       </span><br><span class="line">/ <span class="comment"># route -n</span></span><br><span class="line">Kernel IP routing table</span><br><span class="line">Destination     Gateway         Genmask         Flags Metric Ref    Use Iface</span><br><span class="line">0.0.0.0         172.27.0.1      0.0.0.0         UG    0      0        0 eth0</span><br><span class="line">172.27.0.0      0.0.0.0         255.255.0.0     U     0      0        0 eth0</span><br><span class="line"></span><br><span class="line">/ <span class="comment"># cat /etc/resolv.conf </span></span><br><span class="line">nameserver 127.0.0.11</span><br><span class="line">options ndots:0</span><br><span class="line"></span><br><span class="line">/ <span class="comment"># ping -c1 www.baidu.com</span></span><br><span class="line">PING www.baidu.com (220.181.111.1): 56 data bytes</span><br><span class="line">64 bytes from 220.181.111.1: <span class="built_in">seq</span>=0 ttl=127 time=38.511 ms</span><br><span class="line"></span><br><span class="line"><span class="comment">#再开一个新终端窗口查看网络</span></span><br><span class="line">[root@rocky8 ~]<span class="comment"># docker inspect test-net</span></span><br><span class="line">[</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="string">&quot;Name&quot;</span>: <span class="string">&quot;test-net&quot;</span>,</span><br><span class="line">        <span class="string">&quot;Id&quot;</span>: <span class="string">&quot;26dc4700293ee569474a78798d7ff862fbd4648e18539f349824130a914294ad&quot;</span>,</span><br><span class="line">        <span class="string">&quot;Created&quot;</span>: <span class="string">&quot;2025-04-11T16:18:45.152295655+08:00&quot;</span>,</span><br><span class="line">        <span class="string">&quot;Scope&quot;</span>: <span class="string">&quot;local&quot;</span>,</span><br><span class="line">        <span class="string">&quot;Driver&quot;</span>: <span class="string">&quot;bridge&quot;</span>,</span><br><span class="line">        <span class="string">&quot;EnableIPv6&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">        <span class="string">&quot;IPAM&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;Driver&quot;</span>: <span class="string">&quot;default&quot;</span>,</span><br><span class="line">            <span class="string">&quot;Options&quot;</span>: &#123;&#125;,</span><br><span class="line">            <span class="string">&quot;Config&quot;</span>: [</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="string">&quot;Subnet&quot;</span>: <span class="string">&quot;172.27.0.0/16&quot;</span>,</span><br><span class="line">                    <span class="string">&quot;Gateway&quot;</span>: <span class="string">&quot;172.27.0.1&quot;</span></span><br><span class="line">                &#125;</span><br><span class="line">            ]</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">&quot;Internal&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">        <span class="string">&quot;Attachable&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">        <span class="string">&quot;Ingress&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">        <span class="string">&quot;ConfigFrom&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;Network&quot;</span>: <span class="string">&quot;&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">&quot;ConfigOnly&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">        <span class="comment">#出现此网络中容器的网络信息</span></span><br><span class="line">        <span class="string">&quot;Containers&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;d5da2c9ec06cddc34d4dfa8b67af3aa13e0d58f97d007a25193f7788525287b9&quot;</span>: &#123;</span><br><span class="line">                <span class="string">&quot;Name&quot;</span>: <span class="string">&quot;brave_pasteur&quot;</span>,</span><br><span class="line">                <span class="string">&quot;EndpointID&quot;</span>: <span class="string">&quot;d27c8cc7f6afaaeab19043a01dc6de766d08b5213b1ce3b9910902f25000ca8d&quot;</span>,</span><br><span class="line">                <span class="string">&quot;MacAddress&quot;</span>: <span class="string">&quot;02:42:ac:1b:00:02&quot;</span>,</span><br><span class="line">                <span class="string">&quot;IPv4Address&quot;</span>: <span class="string">&quot;172.27.0.2/16&quot;</span>,</span><br><span class="line">                <span class="string">&quot;IPv6Address&quot;</span>: <span class="string">&quot;&quot;</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">&quot;Options&quot;</span>: &#123;&#125;,</span><br><span class="line">        <span class="string">&quot;Labels&quot;</span>: &#123;&#125;</span><br><span class="line">    &#125;</span><br><span class="line">]</span><br></pre></td></tr></table></figure>

<h4 id="实战案例-自定义网络中的容器之间通信"><a href="#实战案例-自定义网络中的容器之间通信" class="headerlink" title="实战案例: 自定义网络中的容器之间通信"></a>实战案例: 自定义网络中的容器之间通信</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line">[root@rocky8 ~]<span class="comment"># docker network ls</span></span><br><span class="line">NETWORK ID     NAME       DRIVER    SCOPE</span><br><span class="line">4048bc584ca0   bridge     bridge    <span class="built_in">local</span></span><br><span class="line">aef2f5228637   host       host      <span class="built_in">local</span></span><br><span class="line">3709f184390d   none       null      <span class="built_in">local</span></span><br><span class="line">26dc4700293e   test-net   bridge    <span class="built_in">local</span></span><br><span class="line"></span><br><span class="line">[root@rocky8 ~]<span class="comment"># docker run -it --rm --network test-net --name test1 alpine sh</span></span><br><span class="line">/ <span class="comment"># ip a</span></span><br><span class="line">1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN qlen 1000</span><br><span class="line">    <span class="built_in">link</span>/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00</span><br><span class="line">    inet 127.0.0.1/8 scope host lo</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    inet6 ::1/128 scope host </span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">31: eth0@if32: &lt;BROADCAST,MULTICAST,UP,LOWER_UP,M-DOWN&gt; mtu 1500 qdisc noqueue state UP </span><br><span class="line">    <span class="built_in">link</span>/ether 02:42:ac:1b:00:02 brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    inet 172.27.0.2/16 brd 172.27.255.255 scope global eth0</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">       </span><br><span class="line">/ <span class="comment"># cat /etc/hosts</span></span><br><span class="line">127.0.0.1	localhost</span><br><span class="line">::1	localhost ip6-localhost ip6-loopback</span><br><span class="line">fe00::0	ip6-localnet</span><br><span class="line">ff00::0	ip6-mcastprefix</span><br><span class="line">ff02::1	ip6-allnodes</span><br><span class="line">ff02::2	ip6-allrouters</span><br><span class="line">172.27.0.2	2625d628d599</span><br><span class="line"></span><br><span class="line">[root@rocky8 ~]<span class="comment"># docker run -it --rm --network test-net --name test2 alpine sh</span></span><br><span class="line">/ <span class="comment"># ip a</span></span><br><span class="line">1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN qlen 1000</span><br><span class="line">    <span class="built_in">link</span>/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00</span><br><span class="line">    inet 127.0.0.1/8 scope host lo</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    inet6 ::1/128 scope host </span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">33: eth0@if34: &lt;BROADCAST,MULTICAST,UP,LOWER_UP,M-DOWN&gt; mtu 1500 qdisc noqueue state UP </span><br><span class="line">    <span class="built_in">link</span>/ether 02:42:ac:1b:00:03 brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    inet 172.27.0.3/16 brd 172.27.255.255 scope global eth0</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">       </span><br><span class="line">/ <span class="comment"># cat /etc/hosts</span></span><br><span class="line">127.0.0.1	localhost</span><br><span class="line">::1	localhost ip6-localhost ip6-loopback</span><br><span class="line">fe00::0	ip6-localnet</span><br><span class="line">ff00::0	ip6-mcastprefix</span><br><span class="line">ff02::1	ip6-allnodes</span><br><span class="line">ff02::2	ip6-allrouters</span><br><span class="line">172.27.0.3	153409970a1c</span><br><span class="line"></span><br><span class="line">/ <span class="comment"># ping -c1 test1</span></span><br><span class="line">PING test1 (172.27.0.2): 56 data bytes</span><br><span class="line">64 bytes from 172.27.0.2: <span class="built_in">seq</span>=0 ttl=64 time=0.102 ms</span><br></pre></td></tr></table></figure>

<p><strong>结论: 自定义网络中的容器之间可以直接利用容器名进行通信</strong></p>
<h4 id="实战案例-利用自定义网络实现-wordpress"><a href="#实战案例-利用自定义网络实现-wordpress" class="headerlink" title="实战案例: 利用自定义网络实现 wordpress"></a>实战案例: 利用自定义网络实现 wordpress</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[root@rocky8 ~]<span class="comment"># docker network create -d bridge --subnet 172.27.0.0/16 --gateway 172.27.0.1 bridge2</span></span><br><span class="line">63c2670c48f7f16f33a6c0dce4a30a8fd5f9756f2fc5ecec7e0f1f4858417ea6</span><br><span class="line"></span><br><span class="line">[root@rocky8 ~]<span class="comment"># docker run -d -p 8080:80 --network bridge2 --name wordpress2 \</span></span><br><span class="line"> -v /data/wordpress2:/var/www/html --restart=always wordpress:php7.4-apache</span><br><span class="line"></span><br><span class="line">d2ca13c0a23ebca999811ad8e140c03f1b085c025119fec34afde3d0d83460fd</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@rocky8 ~]<span class="comment"># docker run --network container:wordpress2 \</span></span><br><span class="line"> -e MYSQL_ROOT_PASSWORD=123456 -e MYSQL_DATABASE=wordpress \</span><br><span class="line"> -e MYSQL_USER=wordpress -e MYSQL_PASSWORD=123456 \</span><br><span class="line"> --name mysql2 -d -v /data/mysql2:/var/lib/mysql \</span><br><span class="line"> --restart=always mysql:8.0.29-oracle</span><br><span class="line"> </span><br><span class="line">5cf68ca5de3bc93b3bced8c1b8ec388e8724e35d85c9fa4fac27efb4682ad705</span><br></pre></td></tr></table></figure>

<p><img src="../../../../images/SRE/day46/61.jpg" alt="61"></p>
<h4 id="实战案例-利用自定义网络实现-Redis-Cluster"><a href="#实战案例-利用自定义网络实现-Redis-Cluster" class="headerlink" title="实战案例: 利用自定义网络实现 Redis Cluster"></a>实战案例: 利用自定义网络实现 Redis Cluster</h4><p><img src="../../../../images/SRE/day46/62.jpg" alt="62"></p>
<h5 id="创建自定义网络"><a href="#创建自定义网络" class="headerlink" title="创建自定义网络"></a>创建自定义网络</h5><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@ubuntu1804 ~]<span class="comment"># docker network create net-redis --subnet 172.18.0.0/16</span></span><br><span class="line">09b9dded99787835dccc029e16fa2782292d22c3e258f60a1db15d44e7a3bd93</span><br></pre></td></tr></table></figure>

<h5 id="创建6个redis容器配置"><a href="#创建6个redis容器配置" class="headerlink" title="创建6个redis容器配置"></a>创建6个redis容器配置</h5><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 通过脚本创建六个redis容器配置</span></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment"># for port in &#123;1..6&#125;;do </span></span><br><span class="line">  <span class="built_in">mkdir</span> -p /data/redis/node-<span class="variable">$&#123;port&#125;</span>/conf</span><br><span class="line">  <span class="built_in">cat</span> &gt;&gt; /data/redis/node-<span class="variable">$&#123;port&#125;</span>/conf/redis.conf &lt;&lt; <span class="string">EOF</span></span><br><span class="line"><span class="string">port 6379</span></span><br><span class="line"><span class="string">bind 0.0.0.0</span></span><br><span class="line"><span class="string">masterauth 123456</span></span><br><span class="line"><span class="string">requirepass 123456</span></span><br><span class="line"><span class="string">cluster-enabled yes</span></span><br><span class="line"><span class="string">cluster-config-file nodes.conf</span></span><br><span class="line"><span class="string">cluster-node-timeout 5000</span></span><br><span class="line"><span class="string">cluster-announce-ip 172.18.0.1$&#123;port&#125;</span></span><br><span class="line"><span class="string">cluster-announce-port 6379</span></span><br><span class="line"><span class="string">cluster-announce-bus-port 16379</span></span><br><span class="line"><span class="string">appendonly yes</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment"># tree /data/redis/</span></span><br><span class="line">/data/redis/</span><br><span class="line">├── node-1</span><br><span class="line">│   └── conf</span><br><span class="line">│       └── redis.conf</span><br><span class="line">├── node-2</span><br><span class="line">│   └── conf</span><br><span class="line">│       └── redis.conf</span><br><span class="line">├── node-3</span><br><span class="line">│   └── conf</span><br><span class="line">│       └── redis.conf</span><br><span class="line">├── node-4</span><br><span class="line">│   └── conf</span><br><span class="line">│       └── redis.conf</span><br><span class="line">├── node-5</span><br><span class="line">│   └── conf</span><br><span class="line">│       └── redis.conf</span><br><span class="line">└── node-6</span><br><span class="line">   └── conf</span><br><span class="line">       └── redis.conf</span><br><span class="line">12 directories, 6 files</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment"># cat /data/redis/node-1/conf/redis.conf </span></span><br><span class="line">port 6379</span><br><span class="line"><span class="built_in">bind</span> 0.0.0.0</span><br><span class="line">masterauth 123456</span><br><span class="line">requirepass 123456</span><br><span class="line">cluster-enabled <span class="built_in">yes</span></span><br><span class="line">cluster-config-file nodes.conf</span><br><span class="line">cluster-node-timeout 5000</span><br><span class="line">cluster-announce-ip 172.18.0.11</span><br><span class="line">cluster-announce-port 6379</span><br><span class="line">cluster-announce-bus-port 16379</span><br><span class="line">appendonly <span class="built_in">yes</span></span><br></pre></td></tr></table></figure>

<h5 id="创建6个-redis-容器"><a href="#创建6个-redis-容器" class="headerlink" title="创建6个 redis 容器"></a>创建6个 redis 容器</h5><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 通过脚本运行六个redis容器</span></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment"># for port in &#123;1..6&#125;;do</span></span><br><span class="line"> docker run -p 637<span class="variable">$&#123;port&#125;</span>:6379 -p 1667<span class="variable">$&#123;port&#125;</span>:16379 --name redis-<span class="variable">$&#123;port&#125;</span> \</span><br><span class="line"> -v /data/redis/node-<span class="variable">$&#123;port&#125;</span>/data:/data \</span><br><span class="line"> -v /data/redis/node-<span class="variable">$&#123;port&#125;</span>/conf/redis.conf:/etc/redis/redis.conf \</span><br><span class="line"> -d --net net-redis --ip 172.18.0.1<span class="variable">$&#123;port&#125;</span> redis:5.0.9-alpine3.11 redis-server /etc/redis/redis.conf</span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></table></figure>

<h5 id="创建-redis-cluster"><a href="#创建-redis-cluster" class="headerlink" title="创建 redis cluster"></a>创建 redis cluster</h5><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#连接redis cluster</span></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment"># docker exec -it redis-1 /bin/sh</span></span><br><span class="line">/data <span class="comment"># redis-cli -a 123456</span></span><br><span class="line">127.0.0.1:6379&gt; <span class="built_in">exit</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#不支持 &#123; &#125; 扩展</span></span><br><span class="line">/data <span class="comment"># echo &#123;1..10&#125;</span></span><br><span class="line">&#123;1..10&#125;</span><br><span class="line">/data <span class="comment"># echo $-</span></span><br><span class="line">smi</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建集群</span></span><br><span class="line">/data <span class="comment"># redis-cli -a 123456 --cluster create 172.18.0.11:6379 172.18.0.12:6379 172.18.0.13:6379 172.18.0.14:6379 172.18.0.15:6379 172.18.0.16:6379 --cluster-replicas 1</span></span><br><span class="line">Can I <span class="built_in">set</span> the above configuration? (<span class="built_in">type</span> <span class="string">&#x27;yes&#x27;</span> to accept): <span class="comment">#输入yes</span></span><br></pre></td></tr></table></figure>

<h5 id="测试访问-redis-cluster"><a href="#测试访问-redis-cluster" class="headerlink" title="测试访问 redis cluster"></a>测试访问 redis cluster</h5><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#连接redis cluster</span></span><br><span class="line">/data <span class="comment"># redis-cli -a 123456 -c</span></span><br><span class="line">127.0.0.1:6379&gt; cluster info</span><br><span class="line">cluster_known_nodes:6</span><br><span class="line"></span><br><span class="line">127.0.0.1:6379&gt; cluster nodes</span><br><span class="line"><span class="comment">#看到172.18.0.&#123;11,12,13&#125;为master,172.18.0.&#123;14,15,16&#125;为slave</span></span><br><span class="line"><span class="comment">#以下为master/slave关系</span></span><br><span class="line"><span class="comment">#172.18.0.11&lt;---&gt;172.18.0.15</span></span><br><span class="line"><span class="comment">#172.18.0.12&lt;---&gt;172.18.0.16</span></span><br><span class="line"><span class="comment">#172.18.0.13&lt;---&gt;172.18.0.14</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#添加key到redis-2上</span></span><br><span class="line">127.0.0.1:6379&gt; <span class="built_in">set</span> name wang</span><br><span class="line">-&gt; Redirected to slot [5798] located at 172.18.0.12:6379</span><br><span class="line">OK</span><br><span class="line"></span><br><span class="line"><span class="comment">#添加key到redis-1上</span></span><br><span class="line">172.18.0.12:6379&gt; <span class="built_in">set</span> title cto</span><br><span class="line">-&gt; Redirected to slot [2217] located at 172.18.0.11:6379</span><br><span class="line">OK</span><br><span class="line"></span><br><span class="line">172.18.0.11:6379&gt; get name</span><br><span class="line">-&gt; Redirected to slot [5798] located at 172.18.0.12:6379</span><br><span class="line"><span class="string">&quot;wang&quot;</span></span><br><span class="line"></span><br><span class="line">172.18.0.12:6379&gt; get title</span><br><span class="line">-&gt; Redirected to slot [2217] located at 172.18.0.11:6379</span><br><span class="line"><span class="string">&quot;cto&quot;</span></span><br></pre></td></tr></table></figure>

<h5 id="测试故障实现-redis-cluster-高可用性"><a href="#测试故障实现-redis-cluster-高可用性" class="headerlink" title="测试故障实现 redis cluster 高可用性"></a>测试故障实现 redis cluster 高可用性</h5><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#模拟redis-2故障</span></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment"># docker stop redis-2</span></span><br><span class="line">redis-2</span><br><span class="line"></span><br><span class="line"><span class="comment">#再次查看cluster状态,可以看到redis-2出错</span></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment"># docker exec -it redis-1 /bin/sh</span></span><br><span class="line">/data <span class="comment"># redis-cli -a 123456 --cluster check 127.0.0.1:6379</span></span><br><span class="line">Could not connect to Redis at 172.18.0.12:6379: Host is unreachable</span><br><span class="line"></span><br><span class="line"><span class="comment">#查看到 172.18.0.16提升为新的master</span></span><br><span class="line">172.18.0.16:6379 (06295ce4...) -&gt; 1 keys | 5462 slots | 0 slaves.</span><br><span class="line">172.18.0.13:6379 (599f69b4...) -&gt; 0 keys | 5461 slots | 1 slaves.</span><br><span class="line">172.18.0.15:6379 (2f69287f...) -&gt; 1 keys | 5461 slots | 1 slaves.</span><br><span class="line"></span><br><span class="line">/data <span class="comment"># redis-cli -a 123456 -c</span></span><br><span class="line">127.0.0.1:6379&gt; cluster nodes</span><br><span class="line">9b6ab0b8f75516d6acd9d566d0d349f1fdd29540 172.18.0.12:6379@16379 master,fail -</span><br><span class="line">1595404533839 1595404532528 2 connected</span><br><span class="line"></span><br><span class="line">127.0.0.1:6379&gt; get name</span><br><span class="line">-&gt; Redirected to slot [5798] located at 172.18.0.16:6379</span><br><span class="line"><span class="string">&quot;wang&quot;</span></span><br><span class="line"></span><br><span class="line">172.18.0.16:6379&gt; get title</span><br><span class="line">-&gt; Redirected to slot [2217] located at 172.18.0.15:6379</span><br><span class="line"><span class="string">&quot;cto&quot;</span></span><br></pre></td></tr></table></figure>

<h3 id="同一个宿主机之间不同网络的容器通信"><a href="#同一个宿主机之间不同网络的容器通信" class="headerlink" title="同一个宿主机之间不同网络的容器通信"></a>同一个宿主机之间不同网络的容器通信</h3><p>开两个容器，一个使用自定义网络容器，一个使用默认brideg网络的容器,默认因iptables规则导致无法通信</p>
<p><img src="../../../../images/SRE/day46/63.jpg" alt="63"></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">[root@ubuntu1804 ~]<span class="comment"># docker run -it --rm --name test1 alpine sh</span></span><br><span class="line">/ <span class="comment"># ip a</span></span><br><span class="line">1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN qlen 1000</span><br><span class="line">   <span class="built_in">link</span>/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00</span><br><span class="line">   inet 127.0.0.1/8 scope host lo</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">23: eth0@if24: &lt;BROADCAST,MULTICAST,UP,LOWER_UP,M-DOWN&gt; mtu 1500 qdisc noqueue </span><br><span class="line">state UP </span><br><span class="line">   <span class="built_in">link</span>/ether 02:42:ac:11:00:02 brd ff:ff:ff:ff:ff:ff</span><br><span class="line">   inet 172.17.0.2/16 brd 172.17.255.255 scope global eth0</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">       </span><br><span class="line">/ <span class="comment"># ping 172.27.0.2   #无法ping通自定义网络容器</span></span><br><span class="line">PING 172.27.0.2 (172.27.0.2): 56 data bytes</span><br><span class="line"></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment"># docker run -it --rm --network test-net --name test2 alpine sh</span></span><br><span class="line">/ <span class="comment"># ip a</span></span><br><span class="line">1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN qlen 1000</span><br><span class="line">   <span class="built_in">link</span>/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00</span><br><span class="line">   inet 127.0.0.1/8 scope host lo</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">21: eth0@if22: &lt;BROADCAST,MULTICAST,UP,LOWER_UP,M-DOWN&gt; mtu 1500 qdisc noqueue </span><br><span class="line">state UP </span><br><span class="line">   <span class="built_in">link</span>/ether 02:42:ac:1b:00:02 brd ff:ff:ff:ff:ff:ff</span><br><span class="line">   inet 172.27.0.2/16 brd 172.27.255.255 scope global eth0</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">       </span><br><span class="line">/ <span class="comment"># ping 172.17.0.2   #无法ping 通默认的网络容器</span></span><br><span class="line">PING 172.27.0.2 (172.17.0.2): 56 data bytes</span><br></pre></td></tr></table></figure>

<h4 id="实战案例-1-修改iptables实现同一宿主机上的不同网络的容器间通信"><a href="#实战案例-1-修改iptables实现同一宿主机上的不同网络的容器间通信" class="headerlink" title="实战案例 1: 修改iptables实现同一宿主机上的不同网络的容器间通信"></a>实战案例 1: 修改iptables实现同一宿主机上的不同网络的容器间通信</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#确认开启ip_forward</span></span><br><span class="line">[root@rocky8 ~]<span class="comment"># cat /proc/sys/net/ipv4/ip_forward</span></span><br><span class="line">1</span><br><span class="line"></span><br><span class="line"><span class="comment">#默认网络和自定义网络是两个不同的网桥</span></span><br><span class="line">[root@rocky8 ~]<span class="comment"># brctl show</span></span><br><span class="line">bridge name       	bridge <span class="built_in">id</span>		    STP enabled	  interfaces</span><br><span class="line">br-63c2670c48f7		8000.024244685368	no		      vethe6fc5e8</span><br><span class="line">docker0		        8000.02426d39e862	no	  	      vethe659da8</span><br><span class="line"></span><br><span class="line">[root@rocky8 ~]<span class="comment"># iptables -vnL</span></span><br><span class="line">Chain INPUT (policy ACCEPT 0 packets, 0 bytes)</span><br><span class="line"> pkts bytes target     prot opt <span class="keyword">in</span>     out     <span class="built_in">source</span>               destination         </span><br><span class="line"></span><br><span class="line">Chain FORWARD (policy DROP 0 packets, 0 bytes)</span><br><span class="line"> pkts bytes target     prot opt <span class="keyword">in</span>     out     <span class="built_in">source</span>               destination         </span><br><span class="line">  884 1423K DOCKER-USER  all  --  *      *       0.0.0.0/0            0.0.0.0/0           </span><br><span class="line">  884 1423K DOCKER-ISOLATION-STAGE-1  all  --  *      *       0.0.0.0/0            0.0.0.0/0           </span><br><span class="line">  427  846K ACCEPT     all  --  *      br-63c2670c48f7  0.0.0.0/0            0.0.0.0/0            ctstate RELATED,ESTABLISHED</span><br><span class="line">   20  1040 DOCKER     all  --  *      br-63c2670c48f7  0.0.0.0/0            0.0.0.0/0           </span><br><span class="line">  437  576K ACCEPT     all  --  br-63c2670c48f7 !br-63c2670c48f7  0.0.0.0/0            0.0.0.0/0           </span><br><span class="line">    0     0 ACCEPT     all  --  br-63c2670c48f7 br-63c2670c48f7  0.0.0.0/0            0.0.0.0/0           </span><br><span class="line"> 1399 1817K ACCEPT     all  --  *      docker0  0.0.0.0/0            0.0.0.0/0            ctstate RELATED,ESTABLISHED</span><br><span class="line">   27  1532 DOCKER     all  --  *      docker0  0.0.0.0/0            0.0.0.0/0           </span><br><span class="line">  542  526K ACCEPT     all  --  docker0 !docker0  0.0.0.0/0            0.0.0.0/0           </span><br><span class="line">    7   492 ACCEPT     all  --  docker0 docker0  0.0.0.0/0            0.0.0.0/0           </span><br><span class="line"></span><br><span class="line">Chain OUTPUT (policy ACCEPT 0 packets, 0 bytes)</span><br><span class="line"> pkts bytes target     prot opt <span class="keyword">in</span>     out     <span class="built_in">source</span>               destination         </span><br><span class="line"></span><br><span class="line">Chain DOCKER (2 references)</span><br><span class="line"> pkts bytes target     prot opt <span class="keyword">in</span>     out     <span class="built_in">source</span>               destination         </span><br><span class="line">   20  1040 ACCEPT     tcp  --  !br-63c2670c48f7 br-63c2670c48f7  0.0.0.0/0            172.27.0.2           tcp dpt:80</span><br><span class="line"></span><br><span class="line">Chain DOCKER-ISOLATION-STAGE-1 (1 references)</span><br><span class="line"> pkts bytes target     prot opt <span class="keyword">in</span>     out     <span class="built_in">source</span>               destination         </span><br><span class="line">  437  576K DOCKER-ISOLATION-STAGE-2  all  --  br-63c2670c48f7 !br-63c2670c48f7  0.0.0.0/0            0.0.0.0/0           </span><br><span class="line">  542  526K DOCKER-ISOLATION-STAGE-2  all  --  docker0 !docker0  0.0.0.0/0            0.0.0.0/0           </span><br><span class="line"> 2860 3768K RETURN     all  --  *      *       0.0.0.0/0            0.0.0.0/0           </span><br><span class="line"></span><br><span class="line">Chain DOCKER-ISOLATION-STAGE-2 (2 references)</span><br><span class="line"> pkts bytes target     prot opt <span class="keyword">in</span>     out     <span class="built_in">source</span>               destination         </span><br><span class="line">    0     0 DROP       all  --  *      br-63c2670c48f7  0.0.0.0/0            0.0.0.0/0           </span><br><span class="line">    0     0 DROP       all  --  *      docker0  0.0.0.0/0            0.0.0.0/0           </span><br><span class="line">  982 1101K RETURN     all  --  *      *       0.0.0.0/0            0.0.0.0/0           </span><br><span class="line"></span><br><span class="line">Chain DOCKER-USER (1 references)</span><br><span class="line"> pkts bytes target     prot opt <span class="keyword">in</span>     out     <span class="built_in">source</span>               destination         </span><br><span class="line"> 2860 3768K RETURN     all  --  *      *       0.0.0.0/0            0.0.0.0/0</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">[root@rocky8 ~]<span class="comment"># iptables-save </span></span><br><span class="line"><span class="comment"># Generated by iptables-save v1.8.5 on Fri Apr 11 17:23:55 2025</span></span><br><span class="line">*filter</span><br><span class="line">:INPUT ACCEPT [0:0]</span><br><span class="line">:FORWARD DROP [0:0]</span><br><span class="line">:OUTPUT ACCEPT [0:0]</span><br><span class="line">:DOCKER - [0:0]</span><br><span class="line">:DOCKER-ISOLATION-STAGE-1 - [0:0]</span><br><span class="line">:DOCKER-ISOLATION-STAGE-2 - [0:0]</span><br><span class="line">:DOCKER-USER - [0:0]</span><br><span class="line">-A FORWARD -j DOCKER-USER</span><br><span class="line">-A FORWARD -j DOCKER-ISOLATION-STAGE-1</span><br><span class="line">-A FORWARD -o br-63c2670c48f7 -m conntrack --ctstate RELATED,ESTABLISHED -j ACCEPT</span><br><span class="line">-A FORWARD -o br-63c2670c48f7 -j DOCKER</span><br><span class="line">-A FORWARD -i br-63c2670c48f7 ! -o br-63c2670c48f7 -j ACCEPT</span><br><span class="line">-A FORWARD -i br-63c2670c48f7 -o br-63c2670c48f7 -j ACCEPT</span><br><span class="line">-A FORWARD -o docker0 -m conntrack --ctstate RELATED,ESTABLISHED -j ACCEPT</span><br><span class="line">-A FORWARD -o docker0 -j DOCKER</span><br><span class="line">-A FORWARD -i docker0 ! -o docker0 -j ACCEPT</span><br><span class="line">-A FORWARD -i docker0 -o docker0 -j ACCEPT</span><br><span class="line">-A DOCKER -d 172.27.0.2/32 ! -i br-63c2670c48f7 -o br-63c2670c48f7 -p tcp -m tcp --dport 80 -j ACCEPT</span><br><span class="line">-A DOCKER-ISOLATION-STAGE-1 -i br-63c2670c48f7 ! -o br-63c2670c48f7 -j DOCKER-ISOLATION-STAGE-2</span><br><span class="line">-A DOCKER-ISOLATION-STAGE-1 -i docker0 ! -o docker0 -j DOCKER-ISOLATION-STAGE-2</span><br><span class="line">-A DOCKER-ISOLATION-STAGE-1 -j RETURN</span><br><span class="line">-A DOCKER-ISOLATION-STAGE-2 -o br-63c2670c48f7 -j DROP  <span class="comment">#注意此行规则</span></span><br><span class="line">-A DOCKER-ISOLATION-STAGE-2 -o docker0 -j DROP          <span class="comment">#注意此行规则</span></span><br><span class="line">-A DOCKER-ISOLATION-STAGE-2 -j RETURN</span><br><span class="line">-A DOCKER-USER -j RETURN</span><br><span class="line">COMMIT</span><br><span class="line"><span class="comment"># Completed on Fri Apr 11 17:23:55 2025</span></span><br><span class="line"><span class="comment"># Generated by iptables-save v1.8.5 on Fri Apr 11 17:23:55 2025</span></span><br><span class="line">*nat</span><br><span class="line">:PREROUTING ACCEPT [0:0]</span><br><span class="line">:INPUT ACCEPT [0:0]</span><br><span class="line">:POSTROUTING ACCEPT [0:0]</span><br><span class="line">:OUTPUT ACCEPT [0:0]</span><br><span class="line">:DOCKER - [0:0]</span><br><span class="line">-A PREROUTING -m addrtype --dst-type LOCAL -j DOCKER</span><br><span class="line">-A POSTROUTING -s 172.27.0.0/16 ! -o br-63c2670c48f7 -j MASQUERADE</span><br><span class="line">-A POSTROUTING -s 172.17.0.0/16 ! -o docker0 -j MASQUERADE</span><br><span class="line">-A POSTROUTING -s 172.27.0.2/32 -d 172.27.0.2/32 -p tcp -m tcp --dport 80 -j MASQUERADE</span><br><span class="line">-A OUTPUT ! -d 127.0.0.0/8 -m addrtype --dst-type LOCAL -j DOCKER</span><br><span class="line">-A DOCKER -i br-63c2670c48f7 -j RETURN</span><br><span class="line">-A DOCKER -i docker0 -j RETURN</span><br><span class="line">-A DOCKER ! -i br-63c2670c48f7 -p tcp -m tcp --dport 8080 -j DNAT --to-destination 172.27.0.2:80</span><br><span class="line">COMMIT</span><br><span class="line"><span class="comment"># Completed on Fri Apr 11 17:23:55 2025</span></span><br><span class="line"></span><br><span class="line">[root@rocky8 ~]<span class="comment"># iptables-save &gt; iptables.rule</span></span><br><span class="line">[root@rocky8 ~]<span class="comment"># vim iptables.rule </span></span><br><span class="line"><span class="comment">#修改下面两行的规则</span></span><br><span class="line">-A DOCKER-ISOLATION-STAGE-2 -o br-63c2670c48f7 -j ACCEPT</span><br><span class="line">-A DOCKER-ISOLATION-STAGE-2 -o docker0 -j ACCEPT</span><br><span class="line"><span class="comment">#或者执行下面命令</span></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment"># iptables -I DOCKER-ISOLATION-STAGE-2 -j ACCEPT</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@rocky8 ~]<span class="comment"># iptables-restore &lt; iptables.rule</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#再次两个容器之间可以相互通信</span></span><br><span class="line"></span><br><span class="line">/ <span class="comment"># ping 172.27.0.2</span></span><br><span class="line">PING 172.27.0.2 (172.27.0.2): 56 data bytes</span><br><span class="line">64 bytes from 172.27.0.2: <span class="built_in">seq</span>=0 ttl=63 time=0.163 ms</span><br><span class="line">64 bytes from 172.27.0.2: <span class="built_in">seq</span>=1 ttl=63 time=0.128 ms</span><br></pre></td></tr></table></figure>

<h4 id="实战案例-2-通过解决docker-network-connect-实现同一个宿主机不同网络的容器间通信"><a href="#实战案例-2-通过解决docker-network-connect-实现同一个宿主机不同网络的容器间通信" class="headerlink" title="实战案例 2: 通过解决docker network connect 实现同一个宿主机不同网络的容器间通信"></a>实战案例 2: 通过解决docker network connect 实现同一个宿主机不同网络的容器间通信</h4><p>可以使用docker network connect命令实现同一个宿主机不同网络的容器间相互通信</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#将CONTAINER连入指定的NETWORK中,使此CONTAINER可以与NETWORK中的其它容器进行通信</span></span><br><span class="line">docker network connect [OPTIONS] NETWORK CONTAINER</span><br><span class="line"></span><br><span class="line">Connect a container to a network</span><br><span class="line">Options:</span><br><span class="line">      --<span class="built_in">alias</span> strings           Add network-scoped <span class="built_in">alias</span> <span class="keyword">for</span> the container</span><br><span class="line">      --driver-opt strings     driver options <span class="keyword">for</span> the network</span><br><span class="line">      --ip string               IPv4 address (e.g., 172.30.100.104)</span><br><span class="line">      --ip6 string             IPv6 address (e.g., 2001:db8::33)</span><br><span class="line">      --<span class="built_in">link</span> list               Add <span class="built_in">link</span> to another container</span><br><span class="line">      --link-local-ip strings   Add a link-local address <span class="keyword">for</span> the container</span><br><span class="line">      </span><br><span class="line"><span class="comment">#将CONTAINER与指定的NETWORK断开连接,使此CONTAINER可以与CONTAINER中的其它容器进行无法通信</span></span><br><span class="line"><span class="comment">#如果将容器从自定义的网络删除，将加入默认的网络，即docker0网桥中，获取172.17.0.0/16</span></span><br><span class="line"><span class="comment">#如果将容器从默认的网络docker0删除，将加入none网络</span></span><br><span class="line"></span><br><span class="line">docker network disconnect [OPTIONS] NETWORK CONTAINER</span><br><span class="line"></span><br><span class="line">Disconnect a container from a network</span><br><span class="line"></span><br><span class="line">Options:</span><br><span class="line">  -f, --force   Force the container to disconnect from a network</span><br></pre></td></tr></table></figure>

<h5 id="上面案例中test1和test2的容器间默认无法通信"><a href="#上面案例中test1和test2的容器间默认无法通信" class="headerlink" title="上面案例中test1和test2的容器间默认无法通信"></a>上面案例中test1和test2的容器间默认无法通信</h5><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#每个网络中有属于此网络的容器信息</span></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment"># docker network inspect bridge</span></span><br><span class="line">[</span><br><span class="line">   &#123;</span><br><span class="line">        <span class="string">&quot;Name&quot;</span>: <span class="string">&quot;bridge&quot;</span>,</span><br><span class="line">        <span class="string">&quot;Id&quot;</span>: </span><br><span class="line"><span class="string">&quot;c2f770f19400aa482054a92f2ff6ce54cae2ed45a15c7d98e0959c64dfefd58d&quot;</span>,</span><br><span class="line">        <span class="string">&quot;Created&quot;</span>: <span class="string">&quot;2020-07-22T09:23:20.265208248+08:00&quot;</span>,</span><br><span class="line">        <span class="string">&quot;Scope&quot;</span>: <span class="string">&quot;local&quot;</span>,</span><br><span class="line">        <span class="string">&quot;Driver&quot;</span>: <span class="string">&quot;bridge&quot;</span>,</span><br><span class="line">        <span class="string">&quot;EnableIPv6&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">        <span class="string">&quot;IPAM&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;Driver&quot;</span>: <span class="string">&quot;default&quot;</span>,</span><br><span class="line">            <span class="string">&quot;Options&quot;</span>: null,</span><br><span class="line">            <span class="string">&quot;Config&quot;</span>: [</span><br><span class="line">               &#123;</span><br><span class="line">                    <span class="string">&quot;Subnet&quot;</span>: <span class="string">&quot;172.17.0.0/16&quot;</span>,</span><br><span class="line">                    <span class="string">&quot;Gateway&quot;</span>: <span class="string">&quot;172.17.0.1&quot;</span></span><br><span class="line">               &#125;</span><br><span class="line">           ]</span><br><span class="line">       &#125;,</span><br><span class="line">        <span class="string">&quot;Internal&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">        <span class="string">&quot;Attachable&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">        <span class="string">&quot;Ingress&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">        <span class="string">&quot;ConfigFrom&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;Network&quot;</span>: <span class="string">&quot;&quot;</span></span><br><span class="line">       &#125;,</span><br><span class="line">        <span class="string">&quot;ConfigOnly&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">        <span class="string">&quot;Containers&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;9bc707b1a810c4bab39a4c0ed3ff5867cc45b21fe8ae6737f2a9d0163ed2c7a9&quot;</span>: </span><br><span class="line">&#123;</span><br><span class="line">                <span class="string">&quot;Name&quot;</span>: <span class="string">&quot;test1&quot;</span>,</span><br><span class="line">                <span class="string">&quot;EndpointID&quot;</span>: </span><br><span class="line"><span class="string">&quot;475bba6925c426158b3c523e07b6773c884d404d82e6c19d5e4a41f54f8856c2&quot;</span>,</span><br><span class="line">                <span class="string">&quot;MacAddress&quot;</span>: <span class="string">&quot;02:42:ac:11:00:02&quot;</span>,</span><br><span class="line">                <span class="string">&quot;IPv4Address&quot;</span>: <span class="string">&quot;172.17.0.2/16&quot;</span>,</span><br><span class="line">                <span class="string">&quot;IPv6Address&quot;</span>: <span class="string">&quot;&quot;</span></span><br><span class="line">           &#125;</span><br><span class="line">       &#125;,</span><br><span class="line">        <span class="string">&quot;Options&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;com.docker.network.bridge.default_bridge&quot;</span>: <span class="string">&quot;true&quot;</span>,</span><br><span class="line">            <span class="string">&quot;com.docker.network.bridge.enable_icc&quot;</span>: <span class="string">&quot;true&quot;</span>,</span><br><span class="line">            <span class="string">&quot;com.docker.network.bridge.enable_ip_masquerade&quot;</span>: <span class="string">&quot;true&quot;</span>,</span><br><span class="line">            <span class="string">&quot;com.docker.network.bridge.host_binding_ipv4&quot;</span>: <span class="string">&quot;0.0.0.0&quot;</span>,</span><br><span class="line">            <span class="string">&quot;com.docker.network.bridge.name&quot;</span>: <span class="string">&quot;docker0&quot;</span>,</span><br><span class="line">            <span class="string">&quot;com.docker.network.driver.mtu&quot;</span>: <span class="string">&quot;1500&quot;</span></span><br><span class="line">       &#125;,</span><br><span class="line">        <span class="string">&quot;Labels&quot;</span>: &#123;&#125;</span><br><span class="line">   &#125;</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line"><span class="comment">#每个网络中有属于此网络的容器信息</span></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment"># docker network inspect test-net </span></span><br><span class="line">[</span><br><span class="line">   &#123;</span><br><span class="line">        <span class="string">&quot;Name&quot;</span>: <span class="string">&quot;test-net&quot;</span>,</span><br><span class="line">        <span class="string">&quot;Id&quot;</span>: </span><br><span class="line"><span class="string">&quot;00ab0f2d29e82d387755e1bea19532dc279fa134a565e496d308ec62f7edf434&quot;</span>,</span><br><span class="line">        <span class="string">&quot;Created&quot;</span>: <span class="string">&quot;2020-07-22T09:59:09.431393706+08:00&quot;</span>,</span><br><span class="line">        <span class="string">&quot;Scope&quot;</span>: <span class="string">&quot;local&quot;</span>,</span><br><span class="line">        <span class="string">&quot;Driver&quot;</span>: <span class="string">&quot;bridge&quot;</span>,</span><br><span class="line">        <span class="string">&quot;EnableIPv6&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">        <span class="string">&quot;IPAM&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;Driver&quot;</span>: <span class="string">&quot;default&quot;</span>,</span><br><span class="line">            <span class="string">&quot;Options&quot;</span>: &#123;&#125;,</span><br><span class="line">            <span class="string">&quot;Config&quot;</span>: [</span><br><span class="line">               &#123;</span><br><span class="line">                    <span class="string">&quot;Subnet&quot;</span>: <span class="string">&quot;172.27.0.0/16&quot;</span>,</span><br><span class="line">                    <span class="string">&quot;Gateway&quot;</span>: <span class="string">&quot;172.27.0.1&quot;</span></span><br><span class="line">               &#125;</span><br><span class="line">           ]</span><br><span class="line">       &#125;,</span><br><span class="line">        <span class="string">&quot;Internal&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">        <span class="string">&quot;Attachable&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">        <span class="string">&quot;Ingress&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">        <span class="string">&quot;ConfigFrom&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;Network&quot;</span>: <span class="string">&quot;&quot;</span></span><br><span class="line">       &#125;,</span><br><span class="line">        <span class="string">&quot;ConfigOnly&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">        <span class="string">&quot;Containers&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;c3446876a38b3d7e70ca35429051dea7373643a95689d22f252faedc31f3c427&quot;</span>: </span><br><span class="line">&#123;</span><br><span class="line">                <span class="string">&quot;Name&quot;</span>: <span class="string">&quot;test2&quot;</span>,</span><br><span class="line">                <span class="string">&quot;EndpointID&quot;</span>: </span><br><span class="line"><span class="string">&quot;13fb11baeca7e90abdc9183334315e95df4a55367d3add1472d741a556cb662c&quot;</span>,</span><br><span class="line">                <span class="string">&quot;MacAddress&quot;</span>: <span class="string">&quot;02:42:ac:1b:00:02&quot;</span>,</span><br><span class="line">                <span class="string">&quot;IPv4Address&quot;</span>: <span class="string">&quot;172.27.0.2/16&quot;</span>,</span><br><span class="line">                <span class="string">&quot;IPv6Address&quot;</span>: <span class="string">&quot;&quot;</span></span><br><span class="line">           &#125;</span><br><span class="line">       &#125;,</span><br><span class="line">        <span class="string">&quot;Options&quot;</span>: &#123;&#125;,</span><br><span class="line">        <span class="string">&quot;Labels&quot;</span>: &#123;&#125;</span><br><span class="line">   &#125;</span><br><span class="line">]</span><br></pre></td></tr></table></figure>

<h5 id="让默认网络中容器test1可以连通自定义网络test-net的容器test2"><a href="#让默认网络中容器test1可以连通自定义网络test-net的容器test2" class="headerlink" title="让默认网络中容器test1可以连通自定义网络test-net的容器test2"></a>让默认网络中容器test1可以连通自定义网络test-net的容器test2</h5><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br></pre></td><td class="code"><pre><span class="line">[root@ubuntu1804 ~]<span class="comment"># docker network connect test-net test1</span></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment"># docker network inspect test-net </span></span><br><span class="line">[</span><br><span class="line">   &#123;</span><br><span class="line">        <span class="string">&quot;Name&quot;</span>: <span class="string">&quot;test-net&quot;</span>,</span><br><span class="line">        <span class="string">&quot;Id&quot;</span>: </span><br><span class="line"><span class="string">&quot;00ab0f2d29e82d387755e1bea19532dc279fa134a565e496d308ec62f7edf434&quot;</span>,</span><br><span class="line">        <span class="string">&quot;Created&quot;</span>: <span class="string">&quot;2020-07-22T09:59:09.431393706+08:00&quot;</span>,</span><br><span class="line">        <span class="string">&quot;Scope&quot;</span>: <span class="string">&quot;local&quot;</span>,</span><br><span class="line">        <span class="string">&quot;Driver&quot;</span>: <span class="string">&quot;bridge&quot;</span>,</span><br><span class="line">        <span class="string">&quot;EnableIPv6&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">        <span class="string">&quot;IPAM&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;Driver&quot;</span>: <span class="string">&quot;default&quot;</span>,</span><br><span class="line">            <span class="string">&quot;Options&quot;</span>: &#123;&#125;,</span><br><span class="line">            <span class="string">&quot;Config&quot;</span>: [</span><br><span class="line">               &#123;</span><br><span class="line">                    <span class="string">&quot;Subnet&quot;</span>: <span class="string">&quot;172.27.0.0/16&quot;</span>,</span><br><span class="line">                    <span class="string">&quot;Gateway&quot;</span>: <span class="string">&quot;172.27.0.1&quot;</span></span><br><span class="line">               &#125;</span><br><span class="line">           ]</span><br><span class="line">       &#125;,</span><br><span class="line">        <span class="string">&quot;Internal&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">        <span class="string">&quot;Attachable&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">        <span class="string">&quot;Ingress&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">        <span class="string">&quot;ConfigFrom&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;Network&quot;</span>: <span class="string">&quot;&quot;</span></span><br><span class="line">       &#125;,</span><br><span class="line">        <span class="string">&quot;ConfigOnly&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">        <span class="string">&quot;Containers&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;9bc707b1a810c4bab39a4c0ed3ff5867cc45b21fe8ae6737f2a9d0163ed2c7a9&quot;</span>: </span><br><span class="line">&#123;</span><br><span class="line">                <span class="string">&quot;Name&quot;</span>: <span class="string">&quot;test1&quot;</span>,</span><br><span class="line">                <span class="string">&quot;EndpointID&quot;</span>: </span><br><span class="line"><span class="string">&quot;600891a1f0727f0fddcb9c123540d02963a30a54d011554e0dfd1c108ecabdd2&quot;</span>,</span><br><span class="line">                <span class="string">&quot;MacAddress&quot;</span>: <span class="string">&quot;02:42:ac:1b:00:03&quot;</span>,</span><br><span class="line">                <span class="string">&quot;IPv4Address&quot;</span>: <span class="string">&quot;172.27.0.3/16&quot;</span>,</span><br><span class="line">                <span class="string">&quot;IPv6Address&quot;</span>: <span class="string">&quot;&quot;</span></span><br><span class="line">           &#125;,</span><br><span class="line">            <span class="string">&quot;c3446876a38b3d7e70ca35429051dea7373643a95689d22f252faedc31f3c427&quot;</span>: </span><br><span class="line">&#123;</span><br><span class="line">                <span class="string">&quot;Name&quot;</span>: <span class="string">&quot;test2&quot;</span>,</span><br><span class="line">                <span class="string">&quot;EndpointID&quot;</span>: </span><br><span class="line"><span class="string">&quot;13fb11baeca7e90abdc9183334315e95df4a55367d3add1472d741a556cb662c&quot;</span>,</span><br><span class="line">                <span class="string">&quot;MacAddress&quot;</span>: <span class="string">&quot;02:42:ac:1b:00:02&quot;</span>,</span><br><span class="line">                <span class="string">&quot;IPv4Address&quot;</span>: <span class="string">&quot;172.27.0.2/16&quot;</span>,</span><br><span class="line">                <span class="string">&quot;IPv6Address&quot;</span>: <span class="string">&quot;&quot;</span></span><br><span class="line">           &#125;</span><br><span class="line">       &#125;,</span><br><span class="line">        <span class="string">&quot;Options&quot;</span>: &#123;&#125;,</span><br><span class="line">        <span class="string">&quot;Labels&quot;</span>: &#123;&#125;</span><br><span class="line">   &#125;</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line"><span class="comment">#在test1容器中可以看到新添加了一个网卡,并且分配了test-net网络的IP信息</span></span><br><span class="line">/ <span class="comment"># ip a</span></span><br><span class="line">1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN qlen 1000</span><br><span class="line">   <span class="built_in">link</span>/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00</span><br><span class="line">   inet 127.0.0.1/8 scope host lo</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">27: eth0@if28: &lt;BROADCAST,MULTICAST,UP,LOWER_UP,M-DOWN&gt; mtu 1500 qdisc noqueue </span><br><span class="line">state UP </span><br><span class="line">   <span class="built_in">link</span>/ether 02:42:ac:11:00:02 brd ff:ff:ff:ff:ff:ff</span><br><span class="line">   inet 172.17.0.2/16 brd 172.17.255.255 scope global eth0</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">29: eth1@if30: &lt;BROADCAST,MULTICAST,UP,LOWER_UP,M-DOWN&gt; mtu 1500 qdisc noqueue </span><br><span class="line">state UP </span><br><span class="line">   <span class="built_in">link</span>/ether 02:42:ac:1b:00:03 brd ff:ff:ff:ff:ff:ff</span><br><span class="line">   inet 172.27.0.3/16 brd 172.27.255.255 scope global eth1</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">       </span><br><span class="line"><span class="comment">#test1可以连接test2容器</span></span><br><span class="line">/ <span class="comment"># ping -c1 172.27.0.2</span></span><br><span class="line">PING 172.27.0.2 (172.27.0.2): 56 data bytes</span><br><span class="line">64 bytes from 172.27.0.2: <span class="built_in">seq</span>=0 ttl=64 time=0.100 ms</span><br><span class="line">--- 172.27.0.2 ping statistics ---</span><br><span class="line">1 packets transmitted, 1 packets received, 0% packet loss</span><br><span class="line">round-trip min/avg/max = 0.100/0.100/0.100 ms</span><br><span class="line"></span><br><span class="line"><span class="comment">#在test2容器中没有变化,仍然无法连接test1</span></span><br><span class="line">/ <span class="comment"># ip a</span></span><br><span class="line">1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN qlen 1000</span><br><span class="line">   <span class="built_in">link</span>/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00</span><br><span class="line">   inet 127.0.0.1/8 scope host lo</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">23: eth0@if24: &lt;BROADCAST,MULTICAST,UP,LOWER_UP,M-DOWN&gt; mtu 1500 qdisc noqueue </span><br><span class="line">state UP </span><br><span class="line">   <span class="built_in">link</span>/ether 02:42:ac:1b:00:02 brd ff:ff:ff:ff:ff:ff</span><br><span class="line">   inet 172.27.0.2/16 brd 172.27.255.255 scope global eth0</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">       </span><br><span class="line">/ <span class="comment"># ping -c1 172.17.0.2</span></span><br><span class="line">PING 172.17.0.2 (172.17.0.2): 56 data bytes</span><br><span class="line">^C</span><br><span class="line">--- 172.17.0.2 ping statistics ---</span><br><span class="line">1 packets transmitted, 0 packets received, 100% packet loss</span><br></pre></td></tr></table></figure>

<h5 id="让自定义网络中容器test2可以连通默认网络的容器test1"><a href="#让自定义网络中容器test2可以连通默认网络的容器test1" class="headerlink" title="让自定义网络中容器test2可以连通默认网络的容器test1"></a>让自定义网络中容器test2可以连通默认网络的容器test1</h5><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#将自定义网络中的容器test2也加入到默认网络中,使之和默认网络中的容器test1通信</span></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment"># docker network connect bridge test2</span></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment"># docker network inspect bridge</span></span><br><span class="line">[</span><br><span class="line">   &#123;</span><br><span class="line">        <span class="string">&quot;Name&quot;</span>: <span class="string">&quot;bridge&quot;</span>,</span><br><span class="line">        <span class="string">&quot;Id&quot;</span>: </span><br><span class="line"><span class="string">&quot;c2f770f19400aa482054a92f2ff6ce54cae2ed45a15c7d98e0959c64dfefd58d&quot;</span>,</span><br><span class="line">        <span class="string">&quot;Created&quot;</span>: <span class="string">&quot;2020-07-22T09:23:20.265208248+08:00&quot;</span>,</span><br><span class="line">        <span class="string">&quot;Scope&quot;</span>: <span class="string">&quot;local&quot;</span>,</span><br><span class="line">        <span class="string">&quot;Driver&quot;</span>: <span class="string">&quot;bridge&quot;</span>,</span><br><span class="line">        <span class="string">&quot;EnableIPv6&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">        <span class="string">&quot;IPAM&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;Driver&quot;</span>: <span class="string">&quot;default&quot;</span>,</span><br><span class="line">            <span class="string">&quot;Options&quot;</span>: null,</span><br><span class="line">            <span class="string">&quot;Config&quot;</span>: [</span><br><span class="line">               &#123;</span><br><span class="line">                    <span class="string">&quot;Subnet&quot;</span>: <span class="string">&quot;172.17.0.0/16&quot;</span>,</span><br><span class="line">                    <span class="string">&quot;Gateway&quot;</span>: <span class="string">&quot;172.17.0.1&quot;</span></span><br><span class="line">               &#125;</span><br><span class="line">           ]</span><br><span class="line">       &#125;,</span><br><span class="line">        <span class="string">&quot;Internal&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">        <span class="string">&quot;Attachable&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">        <span class="string">&quot;Ingress&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">        <span class="string">&quot;ConfigFrom&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;Network&quot;</span>: <span class="string">&quot;&quot;</span></span><br><span class="line">       &#125;,</span><br><span class="line">        <span class="string">&quot;ConfigOnly&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">        <span class="string">&quot;Containers&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;9bc707b1a810c4bab39a4c0ed3ff5867cc45b21fe8ae6737f2a9d0163ed2c7a9&quot;</span>: </span><br><span class="line">&#123;</span><br><span class="line">                <span class="string">&quot;Name&quot;</span>: <span class="string">&quot;test1&quot;</span>,</span><br><span class="line">                <span class="string">&quot;EndpointID&quot;</span>: </span><br><span class="line"><span class="string">&quot;475bba6925c426158b3c523e07b6773c884d404d82e6c19d5e4a41f54f8856c2&quot;</span>,</span><br><span class="line">                <span class="string">&quot;MacAddress&quot;</span>: <span class="string">&quot;02:42:ac:11:00:02&quot;</span>,</span><br><span class="line">                <span class="string">&quot;IPv4Address&quot;</span>: <span class="string">&quot;172.17.0.2/16&quot;</span>,</span><br><span class="line">                <span class="string">&quot;IPv6Address&quot;</span>: <span class="string">&quot;&quot;</span></span><br><span class="line">           &#125;,</span><br><span class="line">            <span class="string">&quot;c3446876a38b3d7e70ca35429051dea7373643a95689d22f252faedc31f3c427&quot;</span>: </span><br><span class="line">&#123;</span><br><span class="line">                <span class="string">&quot;Name&quot;</span>: <span class="string">&quot;test2&quot;</span>,</span><br><span class="line">                <span class="string">&quot;EndpointID&quot;</span>: </span><br><span class="line"><span class="string">&quot;a049010b37dd5a40c1ff8e8d0b327b70727316dd86b2c69c05231bfd6c985af6&quot;</span>,</span><br><span class="line">                <span class="string">&quot;MacAddress&quot;</span>: <span class="string">&quot;02:42:ac:11:00:03&quot;</span>,</span><br><span class="line">                <span class="string">&quot;IPv4Address&quot;</span>: <span class="string">&quot;172.17.0.3/16&quot;</span>,</span><br><span class="line">                <span class="string">&quot;IPv6Address&quot;</span>: <span class="string">&quot;&quot;</span></span><br><span class="line">           &#125;</span><br><span class="line">       &#125;,</span><br><span class="line">        <span class="string">&quot;Options&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;com.docker.network.bridge.default_bridge&quot;</span>: <span class="string">&quot;true&quot;</span>,</span><br><span class="line">            <span class="string">&quot;com.docker.network.bridge.enable_icc&quot;</span>: <span class="string">&quot;true&quot;</span>,</span><br><span class="line">            <span class="string">&quot;com.docker.network.bridge.enable_ip_masquerade&quot;</span>: <span class="string">&quot;true&quot;</span>,</span><br><span class="line">            <span class="string">&quot;com.docker.network.bridge.host_binding_ipv4&quot;</span>: <span class="string">&quot;0.0.0.0&quot;</span>,</span><br><span class="line">            <span class="string">&quot;com.docker.network.bridge.name&quot;</span>: <span class="string">&quot;docker0&quot;</span>,</span><br><span class="line">            <span class="string">&quot;com.docker.network.driver.mtu&quot;</span>: <span class="string">&quot;1500&quot;</span></span><br><span class="line">       &#125;,</span><br><span class="line">        <span class="string">&quot;Labels&quot;</span>: &#123;&#125;</span><br><span class="line">   &#125;</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line"><span class="comment">#确认自定义网络的容器test2中添加了新网卡,并设置默认网络的IP信息</span></span><br><span class="line">/ <span class="comment"># ip a</span></span><br><span class="line">1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN qlen 1000</span><br><span class="line">   <span class="built_in">link</span>/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00</span><br><span class="line">   inet 127.0.0.1/8 scope host lo</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">23: eth0@if24: &lt;BROADCAST,MULTICAST,UP,LOWER_UP,M-DOWN&gt; mtu 1500 qdisc noqueue </span><br><span class="line">state UP </span><br><span class="line">   <span class="built_in">link</span>/ether 02:42:ac:1b:00:02 brd ff:ff:ff:ff:ff:ff</span><br><span class="line">   inet 172.27.0.2/16 brd 172.27.255.255 scope global eth0</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">31: eth1@if32: &lt;BROADCAST,MULTICAST,UP,LOWER_UP,M-DOWN&gt; mtu 1500 qdisc noqueue </span><br><span class="line">state UP </span><br><span class="line">   <span class="built_in">link</span>/ether 02:42:ac:11:00:03 brd ff:ff:ff:ff:ff:ff</span><br><span class="line">   inet 172.17.0.3/16 brd 172.17.255.255 scope global eth1</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">       </span><br><span class="line"><span class="comment">#test2可以连接test1容器</span></span><br><span class="line">/ <span class="comment"># ping -c1 172.17.0.2</span></span><br><span class="line">PING 172.17.0.2 (172.17.0.2): 56 data bytes</span><br><span class="line">64 bytes from 172.17.0.2: <span class="built_in">seq</span>=0 ttl=64 time=0.128 ms</span><br><span class="line">--- 172.17.0.2 ping statistics ---</span><br><span class="line">1 packets transmitted, 1 packets received, 0% packet loss</span><br><span class="line">round-trip min/avg/max = 0.128/0.128/0.128 ms</span><br><span class="line"></span><br><span class="line"><span class="comment">#在test1中可以利用test2容器名通信</span></span><br><span class="line">/ <span class="comment"># ping -c1 test2</span></span><br><span class="line">PING test2 (172.27.0.2): 56 data bytes</span><br><span class="line">64 bytes from 172.27.0.2: <span class="built_in">seq</span>=0 ttl=64 time=0.076 ms</span><br><span class="line"></span><br><span class="line"><span class="comment">#在test2中可以利test1容器名通信</span></span><br><span class="line">/ <span class="comment"># ping -c1 test1</span></span><br><span class="line">PING test1 (172.27.0.3): 56 data bytes</span><br><span class="line">64 bytes from 172.27.0.3: <span class="built_in">seq</span>=0 ttl=64 time=0.075 ms</span><br></pre></td></tr></table></figure>

<h5 id="断开不同网络中容器的通信"><a href="#断开不同网络中容器的通信" class="headerlink" title="断开不同网络中容器的通信"></a>断开不同网络中容器的通信</h5><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#将test1 断开和网络test-net中其它容器的通信</span></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment"># docker network disconnect test-net test1</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#在容器test1中无法和test2通信</span></span><br><span class="line">/ <span class="comment"># ip a</span></span><br><span class="line">1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN qlen 1000</span><br><span class="line">   <span class="built_in">link</span>/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00</span><br><span class="line">   inet 127.0.0.1/8 scope host lo</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">27: eth0@if28: &lt;BROADCAST,MULTICAST,UP,LOWER_UP,M-DOWN&gt; mtu 1500 qdisc noqueue </span><br><span class="line">state UP </span><br><span class="line">   <span class="built_in">link</span>/ether 02:42:ac:11:00:02 brd ff:ff:ff:ff:ff:ff</span><br><span class="line">   inet 172.17.0.2/16 brd 172.17.255.255 scope global eth0</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">       </span><br><span class="line">/ <span class="comment"># ping -c1 172.27.0.2</span></span><br><span class="line">PING 172.27.0.2 (172.27.0.2): 56 data bytes</span><br><span class="line">--- 172.27.0.2 ping statistics ---</span><br><span class="line">1 packets transmitted, 0 packets received, 100% packet loss</span><br><span class="line"></span><br><span class="line"><span class="comment">#在容器test2中仍能和test1通信</span></span><br><span class="line">/ <span class="comment"># ip a</span></span><br><span class="line">1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN qlen 1000</span><br><span class="line">   <span class="built_in">link</span>/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00</span><br><span class="line">   inet 127.0.0.1/8 scope host lo</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">23: eth0@if24: &lt;BROADCAST,MULTICAST,UP,LOWER_UP,M-DOWN&gt; mtu 1500 qdisc noqueue </span><br><span class="line">state UP </span><br><span class="line">   <span class="built_in">link</span>/ether 02:42:ac:1b:00:02 brd ff:ff:ff:ff:ff:ff</span><br><span class="line">   inet 172.27.0.2/16 brd 172.27.255.255 scope global eth0</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">31: eth1@if32: &lt;BROADCAST,MULTICAST,UP,LOWER_UP,M-DOWN&gt; mtu 1500 qdisc noqueue </span><br><span class="line">state UP </span><br><span class="line">   <span class="built_in">link</span>/ether 02:42:ac:11:00:03 brd ff:ff:ff:ff:ff:ff</span><br><span class="line">   inet 172.17.0.3/16 brd 172.17.255.255 scope global eth1</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">       </span><br><span class="line">/ <span class="comment"># ping -c1 172.17.0.2</span></span><br><span class="line">PING 172.17.0.2 (172.17.0.2): 56 data bytes</span><br><span class="line">64 bytes from 172.17.0.2: <span class="built_in">seq</span>=0 ttl=64 time=0.085 ms</span><br><span class="line"></span><br><span class="line"><span class="comment">#将test2 断开和默认网络中其它容器的通信</span></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment"># docker network disconnect bridge test2</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#在容器test2中无法和test1通信</span></span><br><span class="line">/ <span class="comment"># ip a</span></span><br><span class="line">1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN qlen 1000</span><br><span class="line">   <span class="built_in">link</span>/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00</span><br><span class="line">   inet 127.0.0.1/8 scope host lo</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">23: eth0@if24: &lt;BROADCAST,MULTICAST,UP,LOWER_UP,M-DOWN&gt; mtu 1500 qdisc noqueue </span><br><span class="line">state UP </span><br><span class="line">   <span class="built_in">link</span>/ether 02:42:ac:1b:00:02 brd ff:ff:ff:ff:ff:ff</span><br><span class="line">   inet 172.27.0.2/16 brd 172.27.255.255 scope global eth0</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">       </span><br><span class="line">/ <span class="comment"># ping -c1 172.17.0.2</span></span><br><span class="line">PING 172.17.0.2 (172.17.0.2): 56 data bytes</span><br><span class="line">--- 172.17.0.2 ping statistics ---</span><br><span class="line">1 packets transmitted, 0 packets received, 100% packet loss</span><br></pre></td></tr></table></figure>

<h2 id="实现跨宿主机的容器之间网络互联"><a href="#实现跨宿主机的容器之间网络互联" class="headerlink" title="实现跨宿主机的容器之间网络互联"></a>实现跨宿主机的容器之间网络互联</h2><p>同一个宿主机之间的各个容器之间是可以直接通信的，但是如果访问到另外一台宿主机的容器呢？</p>
<h3 id="方式1-利用桥接实现跨宿主机的容器间互联"><a href="#方式1-利用桥接实现跨宿主机的容器间互联" class="headerlink" title="方式1: 利用桥接实现跨宿主机的容器间互联"></a>方式1: 利用桥接实现跨宿主机的容器间互联</h3><p><img src="../../../../images/SRE/day46/64.jpg" alt="64"></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#分别将两个宿主机都执行下面操作</span></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment"># apt -y install bridge-utils</span></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment"># brctl addif docker0 eth0</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#在两个宿主机上各启动一个容器,需要确保IP不同,相互测试访问</span></span><br><span class="line"><span class="comment">#第一个宿主机的容器</span></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment"># docker run -it --name b1 busybox </span></span><br><span class="line">/ <span class="comment"># hostname -i</span></span><br><span class="line">172.17.0.2</span><br><span class="line"></span><br><span class="line">/ <span class="comment"># httpd -h /data/html/ -f -v</span></span><br><span class="line">[::ffff:172.17.0.3]:42488:response:200</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#第二个宿主机的容器</span></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment"># docker run -it --name b2 busybox </span></span><br><span class="line">/ <span class="comment"># hostname -i</span></span><br><span class="line">172.17.0.3</span><br><span class="line"></span><br><span class="line">/<span class="comment">#wget -q0 - http://172.17.0.2</span></span><br><span class="line">httpd website <span class="keyword">in</span> busybox</span><br></pre></td></tr></table></figure>

<h3 id="方式2-利用NAT实现跨主机的容器间互联"><a href="#方式2-利用NAT实现跨主机的容器间互联" class="headerlink" title="方式2: 利用NAT实现跨主机的容器间互联"></a>方式2: 利用NAT实现跨主机的容器间互联</h3><h4 id="docker跨主机互联实现说明"><a href="#docker跨主机互联实现说明" class="headerlink" title="docker跨主机互联实现说明"></a>docker跨主机互联实现说明</h4><p>跨主机互联是说A宿主机的容器可以访问B主机上的容器，但是前提是保证各宿主机之间的网络是可以相互通信的，然后各容器才可以通过宿主机访问到对方的容器</p>
<p>实现原理: 是在宿主机做一个网络路由就可以实现A宿主机的容器访问B主机的容器的目的</p>
<p>注意: 此方式只适合小型网络环境，复杂的网络或者大型的网络可以使用google开源的k8s进行互联</p>
<h4 id="修改各宿主机网段"><a href="#修改各宿主机网段" class="headerlink" title="修改各宿主机网段"></a>修改各宿主机网段</h4><p>Docker默认网段是172.17.0.x/24,而且每个宿主机都是一样的，因此要做路由的前提就是各个主机的网络不能一致</p>
<h5 id="第一个宿主机A上更改网段"><a href="#第一个宿主机A上更改网段" class="headerlink" title="第一个宿主机A上更改网段"></a>第一个宿主机A上更改网段</h5><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">[root@ubuntu1804 ~]<span class="comment"># vim /etc/docker/daemon.json </span></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment"># cat /etc/docker/daemon.json</span></span><br><span class="line">&#123;</span><br><span class="line">   <span class="string">&quot;bip&quot;</span>: <span class="string">&quot;192.168.100.1/24&quot;</span>,</span><br><span class="line">  <span class="string">&quot;registry-mirrors&quot;</span>: [<span class="string">&quot;https://si7y70hh.mirror.aliyuncs.com&quot;</span>]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment"># systemctl restart docker</span></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment"># ip a</span></span><br><span class="line">1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group </span><br><span class="line">default qlen 1000</span><br><span class="line">   <span class="built_in">link</span>/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00</span><br><span class="line">   inet 127.0.0.1/8 scope host lo</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">   inet6 ::1/128 scope host </span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">2: eth0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc fq_codel state UP </span><br><span class="line">group default qlen 1000</span><br><span class="line">   <span class="built_in">link</span>/ether 00:0c:29:6b:54:d3 brd ff:ff:ff:ff:ff:ff</span><br><span class="line">   inet 10.0.0.101/24 brd 10.0.0.255 scope global eth0</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">   inet6 fe80::20c:29ff:fe6b:54d3/64 scope <span class="built_in">link</span> </span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">3: docker0: &lt;NO-CARRIER,BROADCAST,MULTICAST,UP&gt; mtu 1500 qdisc noqueue state </span><br><span class="line">DOWN group default </span><br><span class="line">   <span class="built_in">link</span>/ether 02:42:e0:ef:72:05 brd ff:ff:ff:ff:ff:ff</span><br><span class="line">   inet 192.168.100.1/24 brd 192.168.100.255 scope global docker0</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">   inet6 fe80::42:e0ff:feef:7205/64 scope <span class="built_in">link</span> </span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">       </span><br><span class="line">       </span><br><span class="line">[root@ubuntu1804 ~]<span class="comment"># route -n</span></span><br><span class="line">Kernel IP routing table</span><br><span class="line">Destination     Gateway         Genmask         Flags Metric Ref   Use Iface</span><br><span class="line">0.0.0.0         10.0.0.2        0.0.0.0         UG    0      0        0 eth0</span><br><span class="line">10.0.0.0        0.0.0.0         255.255.255.0   U     0      0        0 eth0</span><br><span class="line">192.168.100.0   0.0.0.0         255.255.255.0   U     0      0        0 docker0</span><br></pre></td></tr></table></figure>

<h5 id="第二个宿主机B更改网段"><a href="#第二个宿主机B更改网段" class="headerlink" title="第二个宿主机B更改网段"></a>第二个宿主机B更改网段</h5><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">[root@ubuntu1804 ~]<span class="comment"># vim /etc/docker/daemon.json </span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;bip&quot;</span>: <span class="string">&quot;192.168.200.1/24&quot;</span>,</span><br><span class="line">  <span class="string">&quot;registry-mirrors&quot;</span>: [<span class="string">&quot;https://si7y70hh.mirror.aliyuncs.com&quot;</span>]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment"># systemctl restart docker</span></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment"># ip a</span></span><br><span class="line">1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group </span><br><span class="line">default qlen 1000</span><br><span class="line">   <span class="built_in">link</span>/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00</span><br><span class="line">   inet 127.0.0.1/8 scope host lo</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">   inet6 ::1/128 scope host </span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">2: eth0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc fq_codel state UP </span><br><span class="line">group default qlen 1000</span><br><span class="line">   <span class="built_in">link</span>/ether 00:0c:29:01:f3:0c brd ff:ff:ff:ff:ff:ff</span><br><span class="line">   inet 10.0.0.102/24 brd 10.0.0.255 scope global eth0</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">   inet6 fe80::20c:29ff:fe01:f30c/64 scope <span class="built_in">link</span> </span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">3: docker0: &lt;NO-CARRIER,BROADCAST,MULTICAST,UP&gt; mtu 1500 qdisc noqueue state </span><br><span class="line">DOWN group default </span><br><span class="line">   <span class="built_in">link</span>/ether 02:42:e8:c0:a4:d8 brd ff:ff:ff:ff:ff:ff</span><br><span class="line">   inet 192.168.200.1/24 brd 192.168.200.255 scope global docker0</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">   inet6 fe80::42:e8ff:fec0:a4d8/64 scope <span class="built_in">link</span> </span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">       </span><br><span class="line">       </span><br><span class="line">[root@ubuntu1804 ~]<span class="comment"># route -n</span></span><br><span class="line">Kernel IP routing table</span><br><span class="line">Destination     Gateway         Genmask         Flags Metric Ref   Use Iface</span><br><span class="line">0.0.0.0         10.0.0.2        0.0.0.0         UG    0      0        0 eth0</span><br><span class="line">10.0.0.0        0.0.0.0         255.255.255.0   U     0      0        0 eth0</span><br><span class="line">192.168.200.0   0.0.0.0         255.255.255.0   U     0      0        0 docker0</span><br></pre></td></tr></table></figure>

<h4 id="在两个宿主机分别启动一个容器"><a href="#在两个宿主机分别启动一个容器" class="headerlink" title="在两个宿主机分别启动一个容器"></a>在两个宿主机分别启动一个容器</h4><p><strong>第一个宿主机启动容器server1</strong></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">[root@ubuntu1804 ~]<span class="comment"># docker run -it --name server1 --rm alpine sh</span></span><br><span class="line">/ <span class="comment"># ip a </span></span><br><span class="line">1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN qlen 1000</span><br><span class="line">   <span class="built_in">link</span>/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00</span><br><span class="line">   inet 127.0.0.1/8 scope host lo</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">16: eth0@if17: &lt;BROADCAST,MULTICAST,UP,LOWER_UP,M-DOWN&gt; mtu 1500 qdisc noqueue </span><br><span class="line">state UP </span><br><span class="line">   <span class="built_in">link</span>/ether 02:42:c0:a8:64:02 brd ff:ff:ff:ff:ff:ff</span><br><span class="line">   inet 192.168.100.2/24 brd 192.168.100.255 scope global eth0</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">       </span><br><span class="line">       </span><br><span class="line">/ <span class="comment"># route -n</span></span><br><span class="line">Kernel IP routing table</span><br><span class="line">Destination     Gateway         Genmask         Flags Metric Ref   Use Iface</span><br><span class="line">0.0.0.0         192.168.100.1   0.0.0.0         UG    0      0        0 eth0</span><br><span class="line">192.168.100.0   0.0.0.0         255.255.255.0   U     0      0        0 eth0</span><br></pre></td></tr></table></figure>

<p><strong>第二个宿主机启动容器server2</strong></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">[root@ubuntu1804 ~]<span class="comment"># docker run -it --name server2 --rm alpine sh</span></span><br><span class="line">/ <span class="comment"># ip a </span></span><br><span class="line">1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN qlen 1000</span><br><span class="line">   <span class="built_in">link</span>/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00</span><br><span class="line">   inet 127.0.0.1/8 scope host lo</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">8: eth0@if9: &lt;BROADCAST,MULTICAST,UP,LOWER_UP,M-DOWN&gt; mtu 1500 qdisc noqueue </span><br><span class="line">state UP </span><br><span class="line">   <span class="built_in">link</span>/ether 02:42:c0:a8:c8:02 brd ff:ff:ff:ff:ff:ff</span><br><span class="line">   inet 192.168.200.2/24 brd 192.168.200.255 scope global eth0</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">       </span><br><span class="line">       </span><br><span class="line">/ <span class="comment"># route -n</span></span><br><span class="line">Kernel IP routing table</span><br><span class="line">Destination     Gateway         Genmask         Flags Metric Ref   Use Iface</span><br><span class="line">0.0.0.0         192.168.200.1   0.0.0.0         UG    0      0        0 eth0</span><br><span class="line">192.168.200.0   0.0.0.0         255.255.255.0   U     0      0        0 eth0</span><br></pre></td></tr></table></figure>

<p>从第一个宿主机的容器server1无法和第二个宿主机的server2相互访问</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">[root@ubuntu1804 ~]<span class="comment"># docker run -it --name server1 --rm alpine sh</span></span><br><span class="line">/ <span class="comment"># ip a</span></span><br><span class="line">1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN qlen 1000</span><br><span class="line">   <span class="built_in">link</span>/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00</span><br><span class="line">   inet 127.0.0.1/8 scope host lo</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">14: eth0@if15: &lt;BROADCAST,MULTICAST,UP,LOWER_UP,M-DOWN&gt; mtu 1500 qdisc noqueue </span><br><span class="line">state UP </span><br><span class="line">   <span class="built_in">link</span>/ether 02:42:0a:64:00:02 brd ff:ff:ff:ff:ff:ff</span><br><span class="line">   inet 10.100.0.2/16 brd 10.100.255.255 scope global eth0</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">       </span><br><span class="line">       </span><br><span class="line">/ <span class="comment"># ping -c1 192.168.200.2</span></span><br><span class="line">PING 192.168.200.2 (192.168.200.2): 56 data bytes</span><br><span class="line">--- 192.168.200.2 ping statistics ---</span><br><span class="line">1 packets transmitted, 0 packets received, 100% packet loss</span><br></pre></td></tr></table></figure>

<h4 id="添加静态路由和iptables规则"><a href="#添加静态路由和iptables规则" class="headerlink" title="添加静态路由和iptables规则"></a>添加静态路由和iptables规则</h4><p>在各宿主机添加静态路由，网关指向对方宿主机的IP</p>
<h5 id="在第一台宿主机添加静态路由和iptables规则"><a href="#在第一台宿主机添加静态路由和iptables规则" class="headerlink" title="在第一台宿主机添加静态路由和iptables规则"></a>在第一台宿主机添加静态路由和iptables规则</h5><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#添加路由</span></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment"># route add -net 192.168.200.0/24 gw 10.0.0.102</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#修改iptables规则</span></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment"># iptables -A FORWARD -s 10.0.0.0/24 -j ACCEPT</span></span><br><span class="line"><span class="comment">#或者修改FORWARD默认规则</span></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment"># iptables -P FORWARD ACCEPT</span></span><br></pre></td></tr></table></figure>

<h5 id="在第二台宿主机添加静态路由和iptables规则"><a href="#在第二台宿主机添加静态路由和iptables规则" class="headerlink" title="在第二台宿主机添加静态路由和iptables规则"></a>在第二台宿主机添加静态路由和iptables规则</h5><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#添加路由</span></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment">#route add -net 192.168.100.0/24 gw 10.0.0.101</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#修改iptables规则</span></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment">#iptables -A FORWARD -s 10.0.0.0/24 -j ACCEPT</span></span><br><span class="line"><span class="comment">#或者修改FORWARD默认规则</span></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment">#iptables -P FORWARD ACCEPT</span></span><br></pre></td></tr></table></figure>

<h4 id="测试跨宿主机之间容器互联"><a href="#测试跨宿主机之间容器互联" class="headerlink" title="测试跨宿主机之间容器互联"></a>测试跨宿主机之间容器互联</h4><p>宿主机A的容器server1访问宿主机B容器server2，同时在宿主机B上tcpdump抓包观察</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">/ <span class="comment"># ping -c1 192.168.200.2</span></span><br><span class="line">PING 192.168.200.2 (192.168.200.2): 56 data bytes</span><br><span class="line">64 bytes from 192.168.200.2: <span class="built_in">seq</span>=0 ttl=62 time=1.022 ms</span><br><span class="line">--- 192.168.200.2 ping statistics ---</span><br><span class="line">1 packets transmitted, 1 packets received, 0% packet loss</span><br><span class="line">round-trip min/avg/max = 1.022/1.022/1.022 ms</span><br><span class="line"></span><br><span class="line"><span class="comment">#宿主机B的抓包可以观察到</span></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment"># tcpdump -i eth0 -nn icmp</span></span><br><span class="line">tcpdump: verbose output suppressed, use -v or -vv <span class="keyword">for</span> full protocol decode</span><br><span class="line">listening on eth0, link-type EN10MB (Ethernet), capture size 262144 bytes</span><br><span class="line">16:57:37.912925 IP 10.0.0.101 &gt; 192.168.200.2: ICMP <span class="built_in">echo</span> request, <span class="built_in">id</span> 2560, <span class="built_in">seq</span> 0, length 64</span><br><span class="line">16:57:37.913208 IP 192.168.200.2 &gt; 10.0.0.101: ICMP <span class="built_in">echo</span> reply, <span class="built_in">id</span> 2560, <span class="built_in">seq</span> 0, length 64</span><br></pre></td></tr></table></figure>

<p>宿主机B的容器server2访问宿主机B容器server1，同时在宿主机A上tcpdump抓包观察</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">/ <span class="comment"># ping -c1 192.168.100.2</span></span><br><span class="line">PING 192.168.100.2 (192.168.100.2): 56 data bytes</span><br><span class="line">64 bytes from 192.168.100.2: <span class="built_in">seq</span>=0 ttl=62 time=1.041 ms</span><br><span class="line">--- 192.168.100.2 ping statistics ---</span><br><span class="line">1 packets transmitted, 1 packets received, 0% packet loss</span><br><span class="line">round-trip min/avg/max = 1.041/1.041/1.041 ms</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#宿主机A的抓包可以观察到</span></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment"># tcpdump -i eth0 -nn icmp</span></span><br><span class="line">tcpdump: verbose output suppressed, use -v or -vv <span class="keyword">for</span> full protocol decode</span><br><span class="line">listening on eth0, link-type EN10MB (Ethernet), capture size 262144 bytes</span><br><span class="line">16:59:11.775784 IP 10.0.0.102 &gt; 192.168.100.2: ICMP <span class="built_in">echo</span> request, <span class="built_in">id</span> 2560, <span class="built_in">seq</span> 0, length 64</span><br><span class="line">16:59:11.776113 IP 192.168.100.2 &gt; 10.0.0.102: ICMP <span class="built_in">echo</span> reply, <span class="built_in">id</span> 2560, <span class="built_in">seq</span> 0, length 64</span><br></pre></td></tr></table></figure>

<h4 id="创建第三个容器测试"><a href="#创建第三个容器测试" class="headerlink" title="创建第三个容器测试"></a>创建第三个容器测试</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#在第二个宿主机B上启动第一个提供web服务的nginx容器server3</span></span><br><span class="line"><span class="comment">#注意无需打开端口映射</span></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment"># docker run -d --name server3 centos7-nginx:1.6.1</span></span><br><span class="line">69fc554fd00e4f7880c139283b64f2701feafb91047b217906b188c1f461b699</span><br><span class="line"></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment"># docker exec -it server3 bash</span></span><br><span class="line">[root@69fc554fd00e /]<span class="comment"># ifconfig</span></span><br><span class="line">eth0: flags=4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt; mtu 1500</span><br><span class="line">       inet 192.168.200.3 netmask 255.255.255.0 broadcast 192.168.200.255</span><br><span class="line">       ether 02:42:c0:a8:c8:03 txqueuelen 0 (Ethernet)</span><br><span class="line">       RX packets 8 bytes 656 (656.0 B)</span><br><span class="line">       RX errors 0 dropped 0 overruns 0 frame 0</span><br><span class="line">       TX packets 0 bytes 0 (0.0 B)</span><br><span class="line">       TX errors 0 dropped 0 overruns 0 carrier 0 collisions 0</span><br><span class="line">lo: flags=73&lt;UP,LOOPBACK,RUNNING&gt; mtu 65536</span><br><span class="line">       inet 127.0.0.1 netmask 255.0.0.0</span><br><span class="line">       loop txqueuelen 1000 (Local Loopback)</span><br><span class="line">       RX packets 0 bytes 0 (0.0 B)</span><br><span class="line">       RX errors 0 dropped 0 overruns 0 frame 0</span><br><span class="line">       TX packets 0 bytes 0 (0.0 B)</span><br><span class="line">       TX errors 0 dropped 0 overruns 0 carrier 0 collisions 0</span><br><span class="line">       </span><br><span class="line"><span class="comment">#从server1中访问server3的页面可以成功</span></span><br><span class="line">/ <span class="comment"># ip a</span></span><br><span class="line">1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN qlen 1000</span><br><span class="line">   <span class="built_in">link</span>/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00</span><br><span class="line">   inet 127.0.0.1/8 scope host lo</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">14: eth0@if15: &lt;BROADCAST,MULTICAST,UP,LOWER_UP,M-DOWN&gt; mtu 1500 qdisc noqueue </span><br><span class="line">state UP </span><br><span class="line">   <span class="built_in">link</span>/ether 02:42:0a:64:00:02 brd ff:ff:ff:ff:ff:ff</span><br><span class="line">   inet 10.100.0.2/16 brd 10.100.255.255 scope global eth0</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">       </span><br><span class="line">       </span><br><span class="line">/ <span class="comment"># wget -qO - http://192.168.200.3/app</span></span><br><span class="line">Test Page <span class="keyword">in</span> app</span><br><span class="line"></span><br><span class="line"><span class="comment">#从server3容器观察访问日志，可以看到来自于第一个宿主机，而非server1容器</span></span><br><span class="line">[root@69fc554fd00e /]<span class="comment"># tail -f /apps/nginx/logs/access.log </span></span><br><span class="line">10.0.0.101 - - [02/Feb/2020:09:02:00 +0000] <span class="string">&quot;GET /app HTTP/1.1&quot;</span> 301 169 <span class="string">&quot;-&quot;</span> <span class="string">&quot;Wget&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#用tcpdump抓包80/tcp的包，可以观察到以下内容</span></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment"># tcpdump -i eth0 -nn port 80</span></span><br><span class="line">tcpdump: verbose output suppressed, use -v or -vv <span class="keyword">for</span> full protocol decode</span><br><span class="line"></span><br><span class="line">17:03:35.885768 IP 192.168.200.3.80 &gt; 10.0.0.101.43578: Flags [S.], <span class="built_in">seq</span> </span><br><span class="line">2298407060, ack 3672256869, win 28960, options [mss 1460,sackOK,TS val </span><br><span class="line">3131173298 ecr 4161963574,nop,wscale 7], length 0</span><br></pre></td></tr></table></figure>

<h1 id="容器单机编排工具-Docker-Compose"><a href="#容器单机编排工具-Docker-Compose" class="headerlink" title="容器单机编排工具 Docker Compose"></a>容器单机编排工具 Docker Compose</h1><h2 id="Docker-Compose介绍"><a href="#Docker-Compose介绍" class="headerlink" title="Docker Compose介绍"></a>Docker Compose介绍</h2><p><img src="../../../../images/SRE/day46/65.jpg" alt="65"></p>
<p>当在宿主机启动较多的容器时候，如果都是手动操作会觉得比较麻烦而且容易出错，此时推荐使用 docker 单机编排工具 docker-compose</p>
<p>docker-compose 是 docker 容器的一种单机编排服务，docker-compose 是一个管理多个容器的工具，比如: 可以解决容器之间的依赖关系，就像启动一个nginx 前端服务的时候会调用后端的tomcat，那就得先启动tomcat，但是启动tomcat 容器还需要依赖数据库，那就还得先启动数据库，docker-compose 可以用来解决这样的嵌套依赖关系，并且可以替代docker命令对容器进行创建、启动和停止等手工的操作</p>
<p>因此，如果说docker命令就像linux的命令，docker compose就像shell脚本，可以自动的执行容器批量操作，从而实现自动化的容器管理，或者说docker命令相当于ansible命令，那么docker compose文件，就相当于ansible-playbook的yaml文件</p>
<p>docker-compose 项目是Docker 官方的开源项目，负责实现对Docker 容器集群的快速编排，docker-compose 将所管理的容器分为三层，分别是工程（project），服务（service）以及容器（container）</p>
<p>github地址: <a target="_blank" rel="noopener" href="https://github.com/docker/compose">https://github.com/docker/compose</a></p>
<p>官方地址: <a target="_blank" rel="noopener" href="https://docs.docker.com/compose/">https://docs.docker.com/compose/</a></p>
<h2 id="安装和准备"><a href="#安装和准备" class="headerlink" title="安装和准备"></a>安装和准备</h2><h3 id="安装Docker-Compose"><a href="#安装Docker-Compose" class="headerlink" title="安装Docker Compose"></a>安装Docker Compose</h3><h4 id="方法1-在线安装，通过pip安装"><a href="#方法1-在线安装，通过pip安装" class="headerlink" title="方法1: 在线安装，通过pip安装"></a>方法1: 在线安装，通过pip安装</h4><p>python-pip 包将安装一个 pip 的命令，pip 命令是一个python 安装包的安装工具，其类似于ubuntu 的 apt 或者 redhat 的yum，但是pip 只安装 python 相关的安装包，可以在多种操作系统安装和使用pip</p>
<p>此方式当前安装的版本较新，为docker_compose-1.25.3，推荐使用</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">Ubuntu:   </span><br><span class="line"><span class="comment"># apt update </span></span><br><span class="line"><span class="comment"># apt install -y python-pip </span></span><br><span class="line"></span><br><span class="line">CentOS:   </span><br><span class="line"><span class="comment"># yum install epel-release </span></span><br><span class="line"><span class="comment"># yum install -y python-pip </span></span><br><span class="line"><span class="comment"># pip install --upgrade pip </span></span><br></pre></td></tr></table></figure>

<p>范例: 基于python3 安装 docker-compose</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#配置加速</span></span><br><span class="line">[root@ubuntu2004 ~]<span class="comment"># mkdir ~/.pip</span></span><br><span class="line">[root@ubuntu2004 ~]<span class="comment"># cat &gt; ~/.pip/pip.conf &lt;&lt;-EOF</span></span><br><span class="line">[global]</span><br><span class="line">index-url = https://pypi.tuna.tsinghua.edu.cn/simple</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">[root@ubuntu2004 ~]<span class="comment"># apt -y install python3-pip</span></span><br><span class="line">[root@ubuntu2004 ~]<span class="comment"># pip3 install --upgrade pip</span></span><br><span class="line">[root@ubuntu2004 ~]<span class="comment"># pip3 install docker-compose</span></span><br><span class="line">[root@ubuntu2004 ~]<span class="comment"># docker-compose --version</span></span><br><span class="line">docker-compose version 1.27.4, build unknown</span><br><span class="line"></span><br><span class="line"><span class="comment">#基于python2安装docker-compose</span></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment"># apt -y install python-pip</span></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment"># pip install docker-compose</span></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment"># docker-compose --version</span></span><br><span class="line">docker-compose version 1.25.3, build unknown</span><br></pre></td></tr></table></figure>

<h4 id="方法2-在线直接从包仓库安装"><a href="#方法2-在线直接从包仓库安装" class="headerlink" title="方法2: 在线直接从包仓库安装"></a>方法2: 在线直接从包仓库安装</h4><p>此方法安装的版本较旧，不推荐使用</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#ubuntu安装,此为默认版本</span></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment"># apt -y install docker-compose</span></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment"># docker-compose --version</span></span><br><span class="line">docker-compose version 1.17.1, build unknown</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#CentOS7安装，依赖EPEL源</span></span><br><span class="line">[root@centos7 ~]<span class="comment"># yum -y install docker-compose</span></span><br><span class="line">[root@centos7 ~]<span class="comment"># docker-compose --version</span></span><br><span class="line">docker-compose version 1.18.0, buil 8dd22a9 </span><br></pre></td></tr></table></figure>

<h4 id="方法3-离线安装，直接从github或国内镜像站下载安装对应版本"><a href="#方法3-离线安装，直接从github或国内镜像站下载安装对应版本" class="headerlink" title="方法3: 离线安装，直接从github或国内镜像站下载安装对应版本"></a>方法3: 离线安装，直接从github或国内镜像站下载安装对应版本</h4><p>参看说明: <a target="_blank" rel="noopener" href="https://github.com/docker/compose/releases">https://github.com/docker/compose/releases</a></p>
<p>此方法安装版本可方便指定，推荐方法，但网络下载较慢</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[root@ubuntu1804 ~]<span class="comment"># curl -L https://github.com/docker/compose/releases/download/1.25.3/docker-compose-`uname -s`-`uname -m` -o /usr/local/bin/docker-compose</span></span><br><span class="line"></span><br><span class="line">[root@rocky8 ~]<span class="comment"># curl -L https://github.com/docker/compose/releases/download/v2.34.0/docker-compose-`uname -s`-`uname -m`_64 -o /usr/local/bin/docker-compose</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#从国内镜像站下载</span></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment"># curl -L https://get.daocloud.io/docker/compose/releases/download/1.25.3/docker-compose-$(uname -s)-$(uname -m) -o /usr/local/bin/docker-compose</span></span><br><span class="line"></span><br><span class="line">[root@rocky8 ~]<span class="comment"># curl -L https://mirrors.aliyun.com/docker-toolbox/linux/compose/1.21.2/docker-compose-$(uname -s)-$(uname -m) -o /usr/local/bin/docker-compose</span></span><br><span class="line"></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment"># chmod +x /usr/local/bin/docker-compose</span></span><br></pre></td></tr></table></figure>

<h3 id="查看命令格式"><a href="#查看命令格式" class="headerlink" title="查看命令格式"></a>查看命令格式</h3><p>官方文档: <a target="_blank" rel="noopener" href="https://docs.docker.com/compose/reference/">https://docs.docker.com/compose/reference/</a></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">docker-compose --<span class="built_in">help</span></span><br><span class="line">Define and run multi-container applications with Docker.</span><br><span class="line">Usage:</span><br><span class="line">  docker-compose [-f &lt;arg&gt;...] [options] [COMMAND] [ARGS...]</span><br><span class="line">  docker-compose -h|--<span class="built_in">help</span></span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line"><span class="comment">#选项说明:  </span></span><br><span class="line">-f，–file FILE           <span class="comment">#指定Compose 模板文件，默认为docker-compose.yml</span></span><br><span class="line">-p，–project-name NAME   <span class="comment">#指定项目名称，默认将使用当前所在目录名称作为项目名。</span></span><br><span class="line">--verbose                <span class="comment">#显示更多输出信息</span></span><br><span class="line">--log-level LEVEL        <span class="comment">#定义日志级别 (DEBUG, INFO, WARNING, ERROR, CRITICAL) </span></span><br><span class="line">--no-ansi                <span class="comment">#不显示ANSI 控制字符</span></span><br><span class="line">-v, --version            <span class="comment">#显示版本</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#以下为命令选项，需要在docker-compose.yml|yaml 文件所在在目录里执行</span></span><br><span class="line">config  -q    <span class="comment">#查看当前配置，没有错误不输出任何信息</span></span><br><span class="line">up            <span class="comment">#创建并启动容器</span></span><br><span class="line">build         <span class="comment">#构建镜像</span></span><br><span class="line">bundle        <span class="comment">#从当前docker compose 文件生成一个以&lt;当前目录&gt;为名称的json格式的Docker Bundle 备份文件</span></span><br><span class="line">create        <span class="comment">#创建服务</span></span><br><span class="line">down          <span class="comment">#停止和删除所有容器、网络、镜像和卷</span></span><br><span class="line">events        <span class="comment">#从容器接收实时事件，可以指定json 日志格式</span></span><br><span class="line"><span class="built_in">exec</span>          <span class="comment">#进入指定容器进行操作</span></span><br><span class="line"><span class="built_in">help</span>          <span class="comment">#显示帮助细信息</span></span><br><span class="line">images        <span class="comment">#显示镜像信息</span></span><br><span class="line"><span class="built_in">kill</span>          <span class="comment">#强制终止运行中的容器</span></span><br><span class="line">logs          <span class="comment">#查看容器的日志</span></span><br><span class="line">pause         <span class="comment">#暂停服务</span></span><br><span class="line">port          <span class="comment">#查看端口</span></span><br><span class="line">ps            <span class="comment">#列出容器</span></span><br><span class="line">pull          <span class="comment">#重新拉取镜像，镜像发生变化后，需要重新拉取镜像</span></span><br><span class="line">push          <span class="comment">#上传镜像</span></span><br><span class="line">restart       <span class="comment">#重启服务</span></span><br><span class="line"><span class="built_in">rm</span>            <span class="comment">#删除已经停止的服务</span></span><br><span class="line">run           <span class="comment">#一次性运行容器</span></span><br><span class="line">scale         <span class="comment">#设置指定服务运行的容器个数，新版已废弃</span></span><br><span class="line">start         <span class="comment">#启动服务</span></span><br><span class="line">stop          <span class="comment">#停止服务</span></span><br><span class="line">top           <span class="comment">#显示容器运行状态</span></span><br><span class="line">unpause       <span class="comment">#取消暂定</span></span><br></pre></td></tr></table></figure>

<p>范例: </p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@rocky8 ~]<span class="comment"># docker-compose -v</span></span><br><span class="line">Docker Compose version v2.34.0</span><br></pre></td></tr></table></figure>

<h3 id="docker-compose-文件格式"><a href="#docker-compose-文件格式" class="headerlink" title="docker compose 文件格式"></a>docker compose 文件格式</h3><p>官方文档: <a target="_blank" rel="noopener" href="https://docs.docker.com/compose/compose-file/">https://docs.docker.com/compose/compose-file/</a></p>
<p>docker compose 文件是一个yaml格式的文件，所以注意行首的缩进很严格</p>
<p>默认docker-compose命令会调用当前目录下的docker-compose.yml的文件，因此一般执行docker-compose命令前先进入docker-compose.yml文件所在目录</p>
<p>docker compose文件的格式很不同版本，版本不同，语法和格式有所不同，参看以下列表</p>
<table>
<thead>
<tr>
<th>Compose file format</th>
<th>Docker Engine release</th>
</tr>
</thead>
<tbody><tr>
<td>3.7</td>
<td>18.06.0+</td>
</tr>
<tr>
<td>3.6</td>
<td>18.02.0+</td>
</tr>
<tr>
<td>3.5</td>
<td>17.12.0+</td>
</tr>
<tr>
<td>3.4</td>
<td>17.09.0+</td>
</tr>
<tr>
<td>3.3</td>
<td>17.06.0+</td>
</tr>
<tr>
<td>3.2</td>
<td>17.04.0+</td>
</tr>
<tr>
<td>3.1</td>
<td>1.13.1+</td>
</tr>
<tr>
<td>3.0</td>
<td>1.13.0+</td>
</tr>
<tr>
<td>2.4</td>
<td>17.12.0+</td>
</tr>
<tr>
<td>2.3</td>
<td>17.06.0+</td>
</tr>
<tr>
<td>2.3</td>
<td>1.13.0+</td>
</tr>
<tr>
<td>2.1</td>
<td>1.12.0+</td>
</tr>
<tr>
<td>2.0</td>
<td>1.10.0+</td>
</tr>
<tr>
<td>1.0</td>
<td>1.9.1.+</td>
</tr>
</tbody></table>
<p>docker compose版本众多，以下通过具体示例说明docker compose的使用方法</p>
<h2 id="从-docker-compose-启动单个容器"><a href="#从-docker-compose-启动单个容器" class="headerlink" title="从 docker compose 启动单个容器"></a>从 docker compose 启动单个容器</h2><p>注意: 使用Docker compose之前，先要安装docker </p>
<h3 id="创建-docker-compose文件"><a href="#创建-docker-compose文件" class="headerlink" title="创建 docker compose文件"></a>创建 docker compose文件</h3><p>docker compose 文件可在任意目录，创建文件名为docker-compose.yml 配置文件，要注意前后的缩进</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">[root@rocky8 ~]<span class="comment"># docker-compose --version</span></span><br><span class="line">Docker Compose version v2.34.0</span><br><span class="line"></span><br><span class="line">[root@rocky8 ~]<span class="comment"># mkdir /data/docker-compose</span></span><br><span class="line">[root@rocky8 ~]<span class="comment"># cd /data/docker-compose</span></span><br><span class="line">[root@rocky8 docker-compose]<span class="comment"># vim docker-compose.yml</span></span><br><span class="line">[root@rocky8 docker-compose]<span class="comment"># cat docker-compose.yml</span></span><br><span class="line">services:</span><br><span class="line">    nginx-web:</span><br><span class="line">        image: nginx-centos7:1.26.3</span><br><span class="line">        container_name: nginx-web</span><br><span class="line">        expose:</span><br><span class="line">            - 80</span><br><span class="line">            - 443</span><br><span class="line">        ports:</span><br><span class="line">            - <span class="string">&quot;80:80&quot;</span></span><br><span class="line">            - <span class="string">&quot;443:443&quot;</span></span><br></pre></td></tr></table></figure>

<h3 id="查看配置和格式检查"><a href="#查看配置和格式检查" class="headerlink" title="查看配置和格式检查"></a>查看配置和格式检查</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">[root@rocky8 docker-compose]<span class="comment"># docker-compose config </span></span><br><span class="line">name: docker-compose</span><br><span class="line">services:</span><br><span class="line">  nginx-web:</span><br><span class="line">    container_name: nginx-web</span><br><span class="line">    expose:</span><br><span class="line">      - <span class="string">&quot;80&quot;</span></span><br><span class="line">      - <span class="string">&quot;443&quot;</span></span><br><span class="line">    image: nginx-centos7:1.26.3</span><br><span class="line">    networks:</span><br><span class="line">      default: null</span><br><span class="line">    ports:</span><br><span class="line">      - mode: ingress</span><br><span class="line">        target: 80</span><br><span class="line">        published: <span class="string">&quot;80&quot;</span></span><br><span class="line">        protocol: tcp</span><br><span class="line">      - mode: ingress</span><br><span class="line">        target: 443</span><br><span class="line">        published: <span class="string">&quot;443&quot;</span></span><br><span class="line">        protocol: tcp</span><br><span class="line">networks:</span><br><span class="line">  default:</span><br><span class="line">    name: docker-compose_default</span><br><span class="line">    </span><br><span class="line">[root@rocky8 docker-compose]<span class="comment"># docker-compose config -q</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#改错ocker-compose文件格式</span></span><br><span class="line">[root@rocky8 docker-compose]<span class="comment"># cat docker-compose.yml</span></span><br><span class="line">service:  <span class="comment">#少了s</span></span><br><span class="line">    nginx-web:</span><br><span class="line">        image: nginx-centos7:1.26.3</span><br><span class="line">        container_name: nginx-web</span><br><span class="line">        expose:</span><br><span class="line">            - 80</span><br><span class="line">            - 443</span><br><span class="line">        ports:</span><br><span class="line">            - <span class="string">&quot;80:80&quot;</span></span><br><span class="line">            - <span class="string">&quot;443:443&quot;</span></span><br><span class="line"></span><br><span class="line">[root@rocky8 docker-compose]<span class="comment"># docker-compose config </span></span><br><span class="line">validating /data/docker-compose/docker-compose.yml: (root) Additional property service is not allowed</span><br></pre></td></tr></table></figure>

<h3 id="启动容器-2"><a href="#启动容器-2" class="headerlink" title="启动容器"></a>启动容器</h3><p>**注意: 必须要在docker compose文件所在的目录执行 **</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#前台启动</span></span><br><span class="line"></span><br><span class="line"><span class="comment">##########################################################################</span></span><br><span class="line">[root@ubuntu1804 docker-compose]<span class="comment"># docker-compose up</span></span><br><span class="line">Pulling service-nginx-web (harbor.wang.org/example/nginx-centos7-base:1.6.1)...</span><br><span class="line">ERROR: Get https://harbor.wang.org/v2/: dial tcp 10.0.0.102:443: connect: </span><br><span class="line">connection refused</span><br><span class="line"></span><br><span class="line">[root@ubuntu1804 docker-compose]<span class="comment"># vim /lib/systemd/system/docker.service </span></span><br><span class="line">ExecStart=/usr/bin/dockerd -H fd:// --containerd=/run/containerd/containerd.sock --insecure-registry harbor.wang.org </span><br><span class="line"></span><br><span class="line">[root@ubuntu1804 docker-compose]<span class="comment"># systemctl daemon-reload </span></span><br><span class="line">[root@ubuntu1804 docker-compose]<span class="comment"># systemctl restart docker</span></span><br><span class="line"><span class="comment">##########################################################################</span></span><br><span class="line"></span><br><span class="line">[root@rocky8 docker-compose]<span class="comment"># docker-compose up</span></span><br><span class="line">[+] Running 2/2</span><br><span class="line"> ✔ Network docker-compose_default  Created                         0.1s </span><br><span class="line"> ✔ Container nginx-web             Create...                       0.0s </span><br><span class="line">Attaching to nginx-web</span><br><span class="line"></span><br><span class="line"><span class="comment">#以上是前台执行不退出</span></span><br></pre></td></tr></table></figure>

<h3 id="验证docker-compose执行结果"><a href="#验证docker-compose执行结果" class="headerlink" title="验证docker compose执行结果"></a>验证docker compose执行结果</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#上面命令是前台执行，所以要查看结果，可以再开一个终端窗口进行观察</span></span><br><span class="line">[root@rocky8 ~]<span class="comment"># docker ps</span></span><br><span class="line">CONTAINER ID   IMAGE                     COMMAND                  CREATED             STATUS             PORTS                                                                      NAMES</span><br><span class="line">e2629c116bc4   nginx-centos7:1.26.3      <span class="string">&quot;nginx -g &#x27;daemon of…&quot;</span>   3 minutes ago       Up 3 minutes       0.0.0.0:80-&gt;80/tcp, :::80-&gt;80/tcp, 0.0.0.0:443-&gt;443/tcp, :::443-&gt;443/tcp   nginx-web</span><br><span class="line"></span><br><span class="line">[root@rocky8 ~]<span class="comment"># docker-compose ps</span></span><br><span class="line">no configuration file provided: not found</span><br><span class="line">[root@rocky8 ~]<span class="comment"># cd /data/docker-compose/</span></span><br><span class="line"></span><br><span class="line">[root@rocky8 docker-compose]<span class="comment"># docker-compose ps</span></span><br><span class="line">NAME        IMAGE                  COMMAND                  SERVICE     CREATED         STATUS         PORTS</span><br><span class="line">nginx-web   nginx-centos7:1.26.3   <span class="string">&quot;nginx -g &#x27;daemon of…&quot;</span>   nginx-web   4 minutes ago   Up 4 minutes   0.0.0.0:80-&gt;80/tcp, [::]:80-&gt;80/tcp, 0.0.0.0:443-&gt;443/tcp, [::]:443-&gt;443/tcp</span><br><span class="line"></span><br><span class="line">[root@rocky8 docker-compose]<span class="comment"># curl 127.0.0.1</span></span><br><span class="line">Test page <span class="keyword">in</span> app</span><br><span class="line"></span><br><span class="line">[root@rocky8 docker-compose]<span class="comment"># docker-compose images</span></span><br><span class="line">CONTAINER           REPOSITORY          TAG                 IMAGE ID            SIZE</span><br><span class="line">nginx-web           nginx-centos7       1.26.3              08c66ca1868e        405MB</span><br><span class="line"></span><br><span class="line">[root@rocky8 docker-compose]<span class="comment"># docker-compose exec nginx-web bash</span></span><br><span class="line">[root@e2629c116bc4 /]<span class="comment"># tail /apps/nginx/logs/access.log </span></span><br><span class="line">172.18.0.1 - - [12/Apr/2025:03:11:22 +0000] <span class="string">&quot;GET / HTTP/1.1&quot;</span> 200 17 <span class="string">&quot;-&quot;</span> <span class="string">&quot;curl/7.61.1&quot;</span></span><br><span class="line">172.18.0.1 - - [12/Apr/2025:03:12:55 +0000] <span class="string">&quot;GET /app/ HTTP/1.1&quot;</span> 404 153 <span class="string">&quot;-&quot;</span> <span class="string">&quot;curl/7.61.1&quot;</span></span><br><span class="line">172.18.0.1 - - [12/Apr/2025:03:12:58 +0000] <span class="string">&quot;GET / HTTP/1.1&quot;</span> 200 17 <span class="string">&quot;-&quot;</span> <span class="string">&quot;curl/7.61.1&quot;</span></span><br></pre></td></tr></table></figure>

<h3 id="结束前台执行"><a href="#结束前台执行" class="headerlink" title="结束前台执行"></a>结束前台执行</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#ctrl+c键，结束容器</span></span><br><span class="line">Gracefully stopping... (press Ctrl+C again to force)</span><br><span class="line">[+] Stopping 1/1</span><br><span class="line"> ✔ Container nginx-web  Stopped                                    0.3s</span><br><span class="line"> </span><br><span class="line">[root@rocky8 docker-compose]<span class="comment"># docker-compose ps -a</span></span><br><span class="line">NAME        IMAGE                  COMMAND                  SERVICE     CREATED         STATUS                      PORTS</span><br><span class="line">nginx-web   nginx-centos7:1.26.3   <span class="string">&quot;nginx -g &#x27;daemon of…&quot;</span>   nginx-web   7 minutes ago   Exited (0) 23 seconds ago</span><br><span class="line"></span><br><span class="line">[root@rocky8 docker-compose]<span class="comment"># docker-compose start</span></span><br><span class="line">[+] Running 1/1</span><br><span class="line"> ✔ Container nginx-web  Started                                    0.4s </span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">[root@rocky8 docker-compose]<span class="comment"># docker-compose ps</span></span><br><span class="line">NAME        IMAGE                  COMMAND                  SERVICE     CREATED         STATUS         PORTS</span><br><span class="line">nginx-web   nginx-centos7:1.26.3   <span class="string">&quot;nginx -g &#x27;daemon of…&quot;</span>   nginx-web   8 minutes ago   Up 5 seconds   0.0.0.0:80-&gt;80/tcp, [::]:80-&gt;80/tcp, 0.0.0.0:443-&gt;443/tcp, [::]:443-&gt;443/tcp</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#关闭容器</span></span><br><span class="line">[root@rocky8 docker-compose]<span class="comment"># docker-compose kill</span></span><br><span class="line">[+] Killing 1/1</span><br><span class="line"> ✔ Container nginx-web  Killed                                     0.1s </span><br><span class="line"></span><br><span class="line">[root@rocky8 docker-compose]<span class="comment"># docker-compose ps -a</span></span><br><span class="line">NAME        IMAGE                  COMMAND                  SERVICE     CREATED         STATUS                       PORTS</span><br><span class="line">nginx-web   nginx-centos7:1.26.3   <span class="string">&quot;nginx -g &#x27;daemon of…&quot;</span>   nginx-web   8 minutes ago   Exited (137) 6 seconds ago </span><br></pre></td></tr></table></figure>

<h3 id="删除容器-2"><a href="#删除容器-2" class="headerlink" title="删除容器"></a>删除容器</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">[root@rocky8 docker-compose]<span class="comment"># docker-compose ps -a</span></span><br><span class="line">NAME        IMAGE                  COMMAND                  SERVICE     CREATED         STATUS                       PORTS</span><br><span class="line">nginx-web   nginx-centos7:1.26.3   <span class="string">&quot;nginx -g &#x27;daemon of…&quot;</span>   nginx-web   8 minutes ago   Exited (137) 6 seconds ago   </span><br><span class="line"></span><br><span class="line"><span class="comment">#只删除停止的容器</span></span><br><span class="line">[root@rocky8 docker-compose]<span class="comment"># docker-compose rm</span></span><br><span class="line">? Going to remove nginx-web Yes</span><br><span class="line">[+] Removing 1/1</span><br><span class="line"> ✔ Container nginx-web  Removed                                    0.0s </span><br><span class="line"> </span><br><span class="line">[root@rocky8 docker-compose]<span class="comment"># docker-compose up -d</span></span><br><span class="line">[+] Running 1/1</span><br><span class="line"> ✔ Container nginx-web  Started                                    0.4s </span><br><span class="line"> </span><br><span class="line">[root@rocky8 docker-compose]<span class="comment"># docker-compose rm</span></span><br><span class="line">No stopped containers</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#停止并删除容器及镜像</span></span><br><span class="line">[root@rocky8 docker-compose]<span class="comment"># docker-compose down</span></span><br><span class="line">[+] Running 2/2</span><br><span class="line"> ✔ Container nginx-web             Remove...                       0.2s </span><br><span class="line"> ✔ Network docker-compose_default  Removed                         0.1s </span><br><span class="line"> </span><br><span class="line">[root@rocky8 docker-compose]<span class="comment"># docker-compose ps -a</span></span><br><span class="line">NAME      IMAGE     COMMAND   SERVICE   CREATED   STATUS    PORTS</span><br><span class="line"></span><br><span class="line"><span class="comment">#也会自动删除镜像</span></span><br><span class="line">[root@rocky8 docker-compose]<span class="comment"># docker-compose images</span></span><br><span class="line">CONTAINER           REPOSITORY          TAG                 IMAGE ID            SIZE</span><br></pre></td></tr></table></figure>

<h3 id="后台执行"><a href="#后台执行" class="headerlink" title="后台执行"></a>后台执行</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root@rocky8 docker-compose]<span class="comment"># docker-compose up -d</span></span><br><span class="line">[+] Running 2/2</span><br><span class="line"> ✔ Network docker-compose_default  Created                         0.1s </span><br><span class="line"> ✔ Container nginx-web             Starte...                       0.5s </span><br><span class="line"> </span><br><span class="line">[root@rocky8 docker-compose]<span class="comment"># docker-compose ps</span></span><br><span class="line">NAME        IMAGE                  COMMAND                  SERVICE     CREATED         STATUS         PORTS</span><br><span class="line">nginx-web   nginx-centos7:1.26.3   <span class="string">&quot;nginx -g &#x27;daemon of…&quot;</span>   nginx-web   9 seconds ago   Up 8 seconds   0.0.0.0:80-&gt;80/tcp, [::]:80-&gt;80/tcp, 0.0.0.0:443-&gt;443/tcp, [::]:443-&gt;443/tcp</span><br><span class="line"></span><br><span class="line">[root@rocky8 docker-compose]<span class="comment"># curl 127.0.0.1</span></span><br><span class="line">Test page <span class="keyword">in</span> app</span><br></pre></td></tr></table></figure>

<h3 id="停止和启动与日志查看"><a href="#停止和启动与日志查看" class="headerlink" title="停止和启动与日志查看"></a>停止和启动与日志查看</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">[root@rocky8 docker-compose]<span class="comment"># docker-compose stop</span></span><br><span class="line">[+] Stopping 1/1</span><br><span class="line"> ✔ Container nginx-web  Stopped                                    0.2s </span><br><span class="line"> </span><br><span class="line">[root@rocky8 docker-compose]<span class="comment"># docker-compose ps </span></span><br><span class="line">NAME      IMAGE     COMMAND   SERVICE   CREATED   STATUS    PORTS</span><br><span class="line"></span><br><span class="line">[root@rocky8 docker-compose]<span class="comment"># docker-compose ps -a</span></span><br><span class="line">NAME        IMAGE                  COMMAND                  SERVICE     CREATED              STATUS                     PORTS</span><br><span class="line">nginx-web   nginx-centos7:1.26.3   <span class="string">&quot;nginx -g &#x27;daemon of…&quot;</span>   nginx-web   About a minute ago   Exited (0) 8 seconds ago   </span><br><span class="line"></span><br><span class="line">[root@rocky8 docker-compose]<span class="comment"># docker-compose start</span></span><br><span class="line">[+] Running 1/1</span><br><span class="line"> ✔ Container nginx-web  Started                                    0.4s </span><br><span class="line"> </span><br><span class="line">[root@rocky8 docker-compose]<span class="comment"># docker-compose ps </span></span><br><span class="line">NAME        IMAGE                  COMMAND                  SERVICE     CREATED              STATUS         PORTS</span><br><span class="line">nginx-web   nginx-centos7:1.26.3   <span class="string">&quot;nginx -g &#x27;daemon of…&quot;</span>   nginx-web   About a minute ago   Up 3 seconds   0.0.0.0:80-&gt;80/tcp, [::]:80-&gt;80/tcp, 0.0.0.0:443-&gt;443/tcp, [::]:443-&gt;443/tcp</span><br><span class="line"></span><br><span class="line">[root@rocky8 docker-compose]<span class="comment"># docker-compose restart</span></span><br><span class="line">[+] Restarting 1/1</span><br><span class="line"> ✔ Container nginx-web  Started                                    0.5s </span><br><span class="line"> </span><br><span class="line">[root@rocky8 docker-compose]<span class="comment"># docker-compose ps</span></span><br><span class="line">NAME        IMAGE                  COMMAND                  SERVICE     CREATED         STATUS         PORTS</span><br><span class="line">nginx-web   nginx-centos7:1.26.3   <span class="string">&quot;nginx -g &#x27;daemon of…&quot;</span>   nginx-web   2 minutes ago   Up 4 seconds   0.0.0.0:80-&gt;80/tcp, [::]:80-&gt;80/tcp, 0.0.0.0:443-&gt;443/tcp, [::]:443-&gt;443/tcp</span><br><span class="line"></span><br><span class="line"><span class="comment">#执行上面操作时，可以同时开一个终端，观察日事件</span></span><br><span class="line">[root@rocky8 docker-compose]<span class="comment"># docker-compose events</span></span><br><span class="line">2025-04-12 11:23:46.851655 container <span class="built_in">kill</span> d16880d07a9f9781d0c1afe8e0344983e81e8d89a5715aee302e4e9e4ff18dde (name=nginx-web, image=nginx-centos7:1.26.3, org.label-schema.vendor=CentOS, org.label-schema.license=GPLv2, org.label-schema.schema-version=1.0, maintainers=wshuaiqing.cn, org.label-schema.build-date=20191024, signal=15, org.label-schema.name=CentOS Base Image)</span><br><span class="line"></span><br><span class="line">2025-04-12 11:23:46.991651 container stop d16880d07a9f9781d0c1afe8e0344983e81e8d89a5715aee302e4e9e4ff18dde (org.label-schema.name=CentOS Base Image, org.label-schema.vendor=CentOS, maintainers=wshuaiqing.cn, image=nginx-centos7:1.26.3, name=nginx-web, org.label-schema.build-date=20191024, org.label-schema.license=GPLv2, org.label-schema.schema-version=1.0)</span><br><span class="line"></span><br><span class="line">2025-04-12 11:23:46.993807 container die d16880d07a9f9781d0c1afe8e0344983e81e8d89a5715aee302e4e9e4ff18dde (org.label-schema.schema-version=1.0, image=nginx-centos7:1.26.3, org.label-schema.build-date=20191024, org.label-schema.license=GPLv2, org.label-schema.vendor=CentOS, maintainers=wshuaiqing.cn, execDuration=51, exitCode=0, name=nginx-web, org.label-schema.name=CentOS Base Image)</span><br><span class="line"></span><br><span class="line">2025-04-12 11:23:47.386300 container start d16880d07a9f9781d0c1afe8e0344983e81e8d89a5715aee302e4e9e4ff18dde (org.label-schema.build-date=20191024, org.label-schema.schema-version=1.0, org.label-schema.vendor=CentOS, org.label-schema.license=GPLv2, maintainers=wshuaiqing.cn, org.label-schema.name=CentOS Base Image, image=nginx-centos7:1.26.3, name=nginx-web)</span><br><span class="line"></span><br><span class="line">2025-04-12 11:23:47.386409 container restart d16880d07a9f9781d0c1afe8e0344983e81e8d89a5715aee302e4e9e4ff18dde (maintainers=wshuaiqing.cn, org.label-schema.vendor=CentOS, name=nginx-web, org.label-schema.name=CentOS Base Image, org.label-schema.license=GPLv2, org.label-schema.schema-version=1.0, image=nginx-centos7:1.26.3, org.label-schema.build-date=20191024)</span><br><span class="line"></span><br><span class="line"><span class="comment">#以json格式显示日志</span></span><br><span class="line">[root@rocky8 docker-compose]<span class="comment"># docker-compose events --json</span></span><br><span class="line">&#123;<span class="string">&quot;action&quot;</span>:<span class="string">&quot;kill&quot;</span>,<span class="string">&quot;attributes&quot;</span>:&#123;<span class="string">&quot;image&quot;</span>:<span class="string">&quot;nginx-centos7:1.26.3&quot;</span>,<span class="string">&quot;maintainers&quot;</span>:<span class="string">&quot;wshuaiqing.cn&quot;</span>,<span class="string">&quot;name&quot;</span>:<span class="string">&quot;nginx-web&quot;</span>,<span class="string">&quot;org.label-schema.build-date&quot;</span>:<span class="string">&quot;20191024&quot;</span>,<span class="string">&quot;org.label-schema.license&quot;</span>:<span class="string">&quot;GPLv2&quot;</span>,<span class="string">&quot;org.label-schema.name&quot;</span>:<span class="string">&quot;CentOS Base Image&quot;</span>,<span class="string">&quot;org.label-schema.schema-version&quot;</span>:<span class="string">&quot;1.0&quot;</span>,<span class="string">&quot;org.label-schema.vendor&quot;</span>:<span class="string">&quot;CentOS&quot;</span>,<span class="string">&quot;signal&quot;</span>:<span class="string">&quot;15&quot;</span>&#125;,<span class="string">&quot;id&quot;</span>:<span class="string">&quot;d16880d07a9f9781d0c1afe8e0344983e81e8d89a5715aee302e4e9e4ff18dde&quot;</span>,<span class="string">&quot;service&quot;</span>:<span class="string">&quot;nginx-web&quot;</span>,<span class="string">&quot;time&quot;</span>:<span class="string">&quot;2025-04-12T11:24:20.453557731+08:00&quot;</span>,<span class="string">&quot;type&quot;</span>:<span class="string">&quot;container&quot;</span>&#125;</span><br><span class="line">&#123;<span class="string">&quot;action&quot;</span>:<span class="string">&quot;stop&quot;</span>,<span class="string">&quot;attributes&quot;</span>:&#123;<span class="string">&quot;image&quot;</span>:<span class="string">&quot;nginx-centos7:1.26.3&quot;</span>,<span class="string">&quot;maintainers&quot;</span>:<span class="string">&quot;wshuaiqing.cn&quot;</span>,<span class="string">&quot;name&quot;</span>:<span class="string">&quot;nginx-web&quot;</span>,<span class="string">&quot;org.label-schema.build-date&quot;</span>:<span class="string">&quot;20191024&quot;</span>,<span class="string">&quot;org.label-schema.license&quot;</span>:<span class="string">&quot;GPLv2&quot;</span>,<span class="string">&quot;org.label-schema.name&quot;</span>:<span class="string">&quot;CentOS Base Image&quot;</span>,<span class="string">&quot;org.label-schema.schema-version&quot;</span>:<span class="string">&quot;1.0&quot;</span>,<span class="string">&quot;org.label-schema.vendor&quot;</span>:<span class="string">&quot;CentOS&quot;</span>&#125;,<span class="string">&quot;id&quot;</span>:<span class="string">&quot;d16880d07a9f9781d0c1afe8e0344983e81e8d89a5715aee302e4e9e4ff18dde&quot;</span>,<span class="string">&quot;service&quot;</span>:<span class="string">&quot;nginx-web&quot;</span>,<span class="string">&quot;time&quot;</span>:<span class="string">&quot;2025-04-12T11:24:20.590896139+08:00&quot;</span>,<span class="string">&quot;type&quot;</span>:<span class="string">&quot;container&quot;</span>&#125;</span><br><span class="line">&#123;<span class="string">&quot;action&quot;</span>:<span class="string">&quot;die&quot;</span>,<span class="string">&quot;attributes&quot;</span>:&#123;<span class="string">&quot;execDuration&quot;</span>:<span class="string">&quot;33&quot;</span>,<span class="string">&quot;exitCode&quot;</span>:<span class="string">&quot;0&quot;</span>,<span class="string">&quot;image&quot;</span>:<span class="string">&quot;nginx-centos7:1.26.3&quot;</span>,<span class="string">&quot;maintainers&quot;</span>:<span class="string">&quot;wshuaiqing.cn&quot;</span>,<span class="string">&quot;name&quot;</span>:<span class="string">&quot;nginx-web&quot;</span>,<span class="string">&quot;org.label-schema.build-date&quot;</span>:<span class="string">&quot;20191024&quot;</span>,<span class="string">&quot;org.label-schema.license&quot;</span>:<span class="string">&quot;GPLv2&quot;</span>,<span class="string">&quot;org.label-schema.name&quot;</span>:<span class="string">&quot;CentOS Base Image&quot;</span>,<span class="string">&quot;org.label-schema.schema-version&quot;</span>:<span class="string">&quot;1.0&quot;</span>,<span class="string">&quot;org.label-schema.vendor&quot;</span>:<span class="string">&quot;CentOS&quot;</span>&#125;,<span class="string">&quot;id&quot;</span>:<span class="string">&quot;d16880d07a9f9781d0c1afe8e0344983e81e8d89a5715aee302e4e9e4ff18dde&quot;</span>,<span class="string">&quot;service&quot;</span>:<span class="string">&quot;nginx-web&quot;</span>,<span class="string">&quot;time&quot;</span>:<span class="string">&quot;2025-04-12T11:24:20.592716819+08:00&quot;</span>,<span class="string">&quot;type&quot;</span>:<span class="string">&quot;container&quot;</span>&#125;</span><br><span class="line">&#123;<span class="string">&quot;action&quot;</span>:<span class="string">&quot;start&quot;</span>,<span class="string">&quot;attributes&quot;</span>:&#123;<span class="string">&quot;image&quot;</span>:<span class="string">&quot;nginx-centos7:1.26.3&quot;</span>,<span class="string">&quot;maintainers&quot;</span>:<span class="string">&quot;wshuaiqing.cn&quot;</span>,<span class="string">&quot;name&quot;</span>:<span class="string">&quot;nginx-web&quot;</span>,<span class="string">&quot;org.label-schema.build-date&quot;</span>:<span class="string">&quot;20191024&quot;</span>,<span class="string">&quot;org.label-schema.license&quot;</span>:<span class="string">&quot;GPLv2&quot;</span>,<span class="string">&quot;org.label-schema.name&quot;</span>:<span class="string">&quot;CentOS Base Image&quot;</span>,<span class="string">&quot;org.label-schema.schema-version&quot;</span>:<span class="string">&quot;1.0&quot;</span>,<span class="string">&quot;org.label-schema.vendor&quot;</span>:<span class="string">&quot;CentOS&quot;</span>&#125;,<span class="string">&quot;id&quot;</span>:<span class="string">&quot;d16880d07a9f9781d0c1afe8e0344983e81e8d89a5715aee302e4e9e4ff18dde&quot;</span>,<span class="string">&quot;service&quot;</span>:<span class="string">&quot;nginx-web&quot;</span>,<span class="string">&quot;time&quot;</span>:<span class="string">&quot;2025-04-12T11:24:20.95955644+08:00&quot;</span>,<span class="string">&quot;type&quot;</span>:<span class="string">&quot;container&quot;</span>&#125;</span><br><span class="line">&#123;<span class="string">&quot;action&quot;</span>:<span class="string">&quot;restart&quot;</span>,<span class="string">&quot;attributes&quot;</span>:&#123;<span class="string">&quot;image&quot;</span>:<span class="string">&quot;nginx-centos7:1.26.3&quot;</span>,<span class="string">&quot;maintainers&quot;</span>:<span class="string">&quot;wshuaiqing.cn&quot;</span>,<span class="string">&quot;name&quot;</span>:<span class="string">&quot;nginx-web&quot;</span>,<span class="string">&quot;org.label-schema.build-date&quot;</span>:<span class="string">&quot;20191024&quot;</span>,<span class="string">&quot;org.label-schema.license&quot;</span>:<span class="string">&quot;GPLv2&quot;</span>,<span class="string">&quot;org.label-schema.name&quot;</span>:<span class="string">&quot;CentOS Base Image&quot;</span>,<span class="string">&quot;org.label-schema.schema-version&quot;</span>:<span class="string">&quot;1.0&quot;</span>,<span class="string">&quot;org.label-schema.vendor&quot;</span>:<span class="string">&quot;CentOS&quot;</span>&#125;,<span class="string">&quot;id&quot;</span>:<span class="string">&quot;d16880d07a9f9781d0c1afe8e0344983e81e8d89a5715aee302e4e9e4ff18dde&quot;</span>,<span class="string">&quot;service&quot;</span>:<span class="string">&quot;nginx-web&quot;</span>,<span class="string">&quot;time&quot;</span>:<span class="string">&quot;2025-04-12T11:24:20.959621363+08:00&quot;</span>,<span class="string">&quot;type&quot;</span>:<span class="string">&quot;container&quot;</span>&#125;</span><br></pre></td></tr></table></figure>

<h3 id="暂停和恢复"><a href="#暂停和恢复" class="headerlink" title="暂停和恢复"></a>暂停和恢复</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">[root@rocky8 docker-compose]<span class="comment"># docker-compose pause</span></span><br><span class="line">[+] Pausing 1/1</span><br><span class="line"> ✔ Container nginx-web  Paused                                     0.0s </span><br><span class="line"> </span><br><span class="line">[root@rocky8 docker-compose]<span class="comment"># docker-compose ps</span></span><br><span class="line">NAME        IMAGE                  COMMAND                  SERVICE     CREATED         STATUS                  PORTS</span><br><span class="line">nginx-web   nginx-centos7:1.26.3   <span class="string">&quot;nginx -g &#x27;daemon of…&quot;</span>   nginx-web   5 minutes ago   Up 2 minutes (Paused)   0.0.0.0:80-&gt;80/tcp, [::]:80-&gt;80/tcp, 0.0.0.0:443-&gt;443/tcp, [::]:443-&gt;443/tcp</span><br><span class="line"></span><br><span class="line">[root@rocky8 docker-compose]<span class="comment"># curl -m 1 127.0.0.1</span></span><br><span class="line">curl: (28) Operation timed out after 1002 milliseconds with 0 bytes received</span><br><span class="line"></span><br><span class="line">[root@rocky8 docker-compose]<span class="comment"># docker-compose unpause</span></span><br><span class="line">[+] Running 1/1</span><br><span class="line"> ✔ Container nginx-web  Unpaused                                   0.0s </span><br><span class="line"> </span><br><span class="line">[root@rocky8 docker-compose]<span class="comment"># docker-compose ps</span></span><br><span class="line">NAME        IMAGE                  COMMAND                  SERVICE     CREATED         STATUS         PORTS</span><br><span class="line">nginx-web   nginx-centos7:1.26.3   <span class="string">&quot;nginx -g &#x27;daemon of…&quot;</span>   nginx-web   6 minutes ago   Up 3 minutes   0.0.0.0:80-&gt;80/tcp, [::]:80-&gt;80/tcp, 0.0.0.0:443-&gt;443/tcp, [::]:443-&gt;443/tcp</span><br><span class="line"></span><br><span class="line">[root@rocky8 docker-compose]<span class="comment"># curl -m 1 127.0.0.1</span></span><br><span class="line">Test page <span class="keyword">in</span> app</span><br></pre></td></tr></table></figure>

<h2 id="从-docker-compose-启动多个容器"><a href="#从-docker-compose-启动多个容器" class="headerlink" title="从 docker compose 启动多个容器"></a>从 docker compose 启动多个容器</h2><h3 id="编辑-docker-compose-文件并使用数据卷"><a href="#编辑-docker-compose-文件并使用数据卷" class="headerlink" title="编辑 docker-compose 文件并使用数据卷"></a>编辑 docker-compose 文件并使用数据卷</h3><p>注意: 同一个文件 ，数据卷的优先级比镜像内的文件优先级高</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">[root@rocky8 docker-compose]<span class="comment"># cat docker-compose.yml </span></span><br><span class="line">services:</span><br><span class="line">  nginx-web:</span><br><span class="line">    image: nginx-centos7:1.26.3</span><br><span class="line">    container_name: nginx-web</span><br><span class="line">    volumes:</span><br><span class="line">      - /data/nginx:/apps/nginx/html <span class="comment">#指定数据卷，将宿主机/data/nginx挂载到容器/apps/nginx/html</span></span><br><span class="line">    expose:</span><br><span class="line">      - 80</span><br><span class="line">      - 443</span><br><span class="line">    ports:</span><br><span class="line">      - <span class="string">&quot;80:80&quot;</span></span><br><span class="line">      - <span class="string">&quot;443:443&quot;</span></span><br><span class="line">      </span><br><span class="line">  tomcat-app1:</span><br><span class="line">    image: tomcat-web:app1</span><br><span class="line">    container_name: tomcat-app1</span><br><span class="line">    expose:</span><br><span class="line">      - 8080</span><br><span class="line">    ports:</span><br><span class="line">      - <span class="string">&quot;8081:8080&quot;</span></span><br><span class="line">      </span><br><span class="line">  tomcat-app2:</span><br><span class="line">    image: tomcat-web:app2</span><br><span class="line">    container_name: tomcat-app2</span><br><span class="line">    expose:</span><br><span class="line">      - 8080</span><br><span class="line">    ports:</span><br><span class="line">      - <span class="string">&quot;8082:8080&quot;</span></span><br><span class="line"></span><br><span class="line">[root@rocky8 docker-compose]<span class="comment"># docker-compose config -q</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#在宿主机准备nginx测试页面文件</span></span><br><span class="line">[root@rocky8 docker-compose]<span class="comment"># mkdir /data/nginx</span></span><br><span class="line">[root@rocky8 docker-compose]<span class="comment"># echo Docker compose test page &gt; /data/nginx/index.html</span></span><br></pre></td></tr></table></figure>

<h3 id="启动容器并验证结果"><a href="#启动容器并验证结果" class="headerlink" title="启动容器并验证结果"></a>启动容器并验证结果</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">[root@rocky8 docker-compose]<span class="comment"># docker-compose up -d</span></span><br><span class="line">[+] Running 3/3</span><br><span class="line"> ✔ Container tomcat-app2  Started                                  1.2s </span><br><span class="line"> ✔ Container nginx-web    Started                                  1.1s </span><br><span class="line"> ✔ Container tomcat-app1  Started                                  1.1s</span><br><span class="line"></span><br><span class="line">[root@rocky8 docker-compose]<span class="comment"># docker-compose ps</span></span><br><span class="line">NAME          IMAGE                  COMMAND                  SERVICE       CREATED          STATUS          PORTS</span><br><span class="line">nginx-web     nginx-centos7:1.26.3   <span class="string">&quot;nginx -g &#x27;daemon of…&quot;</span>   nginx-web     19 seconds ago   Up 17 seconds   0.0.0.0:80-&gt;80/tcp, [::]:80-&gt;80/tcp, 0.0.0.0:443-&gt;443/tcp, [::]:443-&gt;443/tcp</span><br><span class="line">tomcat-app1   tomcat-web:app1        <span class="string">&quot;/apps/tomcat/bin/ru…&quot;</span>   tomcat-app1   19 seconds ago   Up 17 seconds   8009/tcp, 0.0.0.0:8081-&gt;8080/tcp, [::]:8081-&gt;8080/tcp</span><br><span class="line">tomcat-app2   tomcat-web:app2        <span class="string">&quot;/apps/tomcat/bin/ru…&quot;</span>   tomcat-app2   19 seconds ago   Up 17 seconds   8009/tcp, 0.0.0.0:8082-&gt;8080/tcp, [::]:8082-&gt;8080/tcp</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@rocky8 ~]<span class="comment"># curl 127.0.0.1</span></span><br><span class="line">Docker compose <span class="built_in">test</span> page</span><br><span class="line"></span><br><span class="line">[root@rocky8 ~]<span class="comment"># curl 127.0.0.1:8081/app/</span></span><br><span class="line">Tomcat Page <span class="keyword">in</span> app1</span><br><span class="line"></span><br><span class="line">[root@rocky8 ~]<span class="comment"># curl 127.0.0.1:8082/app/</span></span><br><span class="line">Tomcat Page <span class="keyword">in</span> app2</span><br></pre></td></tr></table></figure>

<h3 id="指定同时启动容器的数量"><a href="#指定同时启动容器的数量" class="headerlink" title="指定同时启动容器的数量"></a>指定同时启动容器的数量</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">[root@rocky8 docker-compose]<span class="comment"># cat docker-compose.yml</span></span><br><span class="line">services:</span><br><span class="line">  nginx-web:</span><br><span class="line">    image: nginx-centos7:1.26.3</span><br><span class="line">    <span class="comment">#container_name: nginx-web #同时启动多个同一镜像的容器，不要指定容器名称，否则会冲突</span></span><br><span class="line">    expose:</span><br><span class="line">      - 80</span><br><span class="line">      - 443</span><br><span class="line">    <span class="comment">#ports:   #同时启动多个同一镜像的容器，不要指定端口号，否则会冲突</span></span><br><span class="line">    <span class="comment">#  - &quot;80:80&quot;</span></span><br><span class="line">    <span class="comment">#  - &quot;443:443&quot;</span></span><br><span class="line">    </span><br><span class="line">  <span class="comment">#再加一个service</span></span><br><span class="line">  tomcat-app1:</span><br><span class="line">    image: tomcat-web:app1</span><br><span class="line">    </span><br><span class="line"></span><br><span class="line">[root@rocky8 docker-compose]<span class="comment"># docker-compose ps -a</span></span><br><span class="line">NAME      IMAGE     COMMAND   SERVICE   CREATED   STATUS    PORTS</span><br><span class="line"></span><br><span class="line">[root@rocky8 docker-compose]<span class="comment"># docker-compose up -d --scale nginx-web=2</span></span><br><span class="line">[+] Running 4/4</span><br><span class="line"> ✔ Network docker-compose_default          Created                 0.1s </span><br><span class="line"> ✔ Container docker-compose-tomcat-app1-1  Started                 0.6s </span><br><span class="line"> ✔ Container docker-compose-nginx-web-2    Started                 1.3s </span><br><span class="line"> ✔ Container docker-compose-nginx-web-1    Started                 0.6s </span><br><span class="line"> </span><br><span class="line">[root@rocky8 docker-compose]<span class="comment"># docker-compose ps</span></span><br><span class="line">NAME                           IMAGE                  COMMAND                  SERVICE       CREATED         STATUS         PORTS</span><br><span class="line">docker-compose-nginx-web-1     nginx-centos7:1.26.3   <span class="string">&quot;nginx -g &#x27;daemon of…&quot;</span>   nginx-web     9 seconds ago   Up 7 seconds   80/tcp, 443/tcp</span><br><span class="line">docker-compose-nginx-web-2     nginx-centos7:1.26.3   <span class="string">&quot;nginx -g &#x27;daemon of…&quot;</span>   nginx-web     9 seconds ago   Up 7 seconds   80/tcp, 443/tcp</span><br><span class="line">docker-compose-tomcat-app1-1   tomcat-web:app1        <span class="string">&quot;/apps/tomcat/bin/ru…&quot;</span>   tomcat-app1   9 seconds ago   Up 7 seconds   8009/tcp, 8080/tcp</span><br><span class="line"></span><br><span class="line">[root@rocky8 docker-compose]<span class="comment"># docker-compose up -d --scale nginx-web=3 --scale tomcat-app1=2</span></span><br><span class="line">[+] Running 5/5</span><br><span class="line"> ✔ Container docker-compose-tomcat-app1-1  Running                 0.0s </span><br><span class="line"> ✔ Container docker-compose-nginx-web-1    Running                 0.0s </span><br><span class="line"> ✔ Container docker-compose-nginx-web-2    Running                 0.0s </span><br><span class="line"> ✔ Container docker-compose-nginx-web-3    Started                 0.7s </span><br><span class="line"> ✔ Container docker-compose-tomcat-app1-2  Started                 0.8s </span><br><span class="line"> </span><br><span class="line">[root@rocky8 docker-compose]<span class="comment"># docker-compose ps</span></span><br><span class="line">NAME                           IMAGE                  COMMAND                  SERVICE       CREATED              STATUS              PORTS</span><br><span class="line">docker-compose-nginx-web-1     nginx-centos7:1.26.3   <span class="string">&quot;nginx -g &#x27;daemon of…&quot;</span>   nginx-web     About a minute ago   Up About a minute   80/tcp, 443/tcp</span><br><span class="line">docker-compose-nginx-web-2     nginx-centos7:1.26.3   <span class="string">&quot;nginx -g &#x27;daemon of…&quot;</span>   nginx-web     About a minute ago   Up About a minute   80/tcp, 443/tcp</span><br><span class="line">docker-compose-nginx-web-3     nginx-centos7:1.26.3   <span class="string">&quot;nginx -g &#x27;daemon of…&quot;</span>   nginx-web     7 seconds ago        Up 6 seconds        80/tcp, 443/tcp</span><br><span class="line">docker-compose-tomcat-app1-1   tomcat-web:app1        <span class="string">&quot;/apps/tomcat/bin/ru…&quot;</span>   tomcat-app1   About a minute ago   Up About a minute   8009/tcp, 8080/tcp</span><br><span class="line">docker-compose-tomcat-app1-2   tomcat-web:app1        <span class="string">&quot;/apps/tomcat/bin/ru…&quot;</span>   tomcat-app1   7 seconds ago        Up 6 seconds        8009/tcp, 8080/tcp</span><br></pre></td></tr></table></figure>

<h3 id="扩容和缩容"><a href="#扩容和缩容" class="headerlink" title="扩容和缩容"></a>扩容和缩容</h3><p>注意: 新版中scale 命令已废弃</p>
<p>推荐使用<code>docker-compose up --scale</code></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#扩容</span></span><br><span class="line">[root@rocky8 docker-compose]<span class="comment"># docker-compose scale nginx-web=5</span></span><br><span class="line"></span><br><span class="line">[root@rocky8 docker-compose]<span class="comment"># docker-compose up --scale nginx-web=5</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#缩容为0，即删除容器</span></span><br><span class="line">[root@rocky8 docker-compose]<span class="comment"># docker-compose scale nginx-web=0</span></span><br><span class="line"> </span><br><span class="line"> [root@rocky8 docker-compose]<span class="comment"># docker-compose up --scale nginx-web=0</span></span><br></pre></td></tr></table></figure>

<h2 id="实战案例-实现-Wordpress-应用"><a href="#实战案例-实现-Wordpress-应用" class="headerlink" title="实战案例: 实现 Wordpress 应用"></a>实战案例: 实现 Wordpress 应用</h2><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">services:</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">db:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">mysql:8.0</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">db</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">unless-stopped</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">MYSQL_DATABASE=wordpress</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">MYSQL_ROOT_PASSWORD=123456</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">MYSQL_USER=wordpress</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">MYSQL_PASSWORD=123456</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">dbdata:/var/lib/mysql</span></span><br><span class="line">    <span class="attr">networks:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">wordpress-network</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">wordpress:</span></span><br><span class="line">    <span class="attr">depends_on:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">db</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">wordpress:5.8.3-apache</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">wordpress</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">unless-stopped</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;80:80&quot;</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">WORDPRESS_DB_HOST=db:3306</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">WORDPRESS_DB_USER=wordpress</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">WORDPRESS_DB_PASSWORD=123456</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">WORDPRESS_DB_NAME=wordpress</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">wordpress:/var/www/html</span></span><br><span class="line">    <span class="attr">networks:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">wordpress-network</span></span><br><span class="line"></span><br><span class="line"><span class="attr">volumes:</span></span><br><span class="line">  <span class="attr">wordpress:</span></span><br><span class="line">  <span class="attr">dbdata:</span></span><br><span class="line"></span><br><span class="line"><span class="attr">networks:</span></span><br><span class="line">  <span class="attr">wordpress-network:</span></span><br><span class="line">    <span class="attr">driver:</span> <span class="string">bridge</span></span><br><span class="line">    <span class="attr">ipam:</span></span><br><span class="line">      <span class="attr">config:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">subnet:</span> <span class="number">172.30</span><span class="number">.0</span><span class="number">.0</span><span class="string">/16</span></span><br></pre></td></tr></table></figure>

<h2 id="实战案例-搭建运维平台-Spug"><a href="#实战案例-搭建运维平台-Spug" class="headerlink" title="实战案例: 搭建运维平台 Spug"></a>实战案例: 搭建运维平台 Spug</h2><p>Spug是面向中小型企业设计的轻量级无Agent的自动化运维平台，整合了主机管理、主机批量执行、主机在线终端、文件在线上传下载、应用发布部署、在线任务计划、配置中心、监控、报警等一系列功 能。</p>
<p>Spug是上海时巴克科技有限公司旗下的开源运维项目，公司旗下现有产品「Spug开源运维平台」「Spug推送助手」，公司专注为中小企业服务。 </p>
<p>参考链接</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://spug.cc/docs/install-docker</span><br></pre></td></tr></table></figure>

<p>范例: 基于docker-compse 部署 Spug</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#安装docker和docker-compse</span></span><br><span class="line"><span class="string">略</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#创建docker-compse.yml文件</span></span><br><span class="line"><span class="comment">#vi docker-compose.yml</span></span><br><span class="line"></span><br><span class="line"><span class="attr">version:</span> <span class="string">&quot;3.9&quot;</span></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line"> <span class="attr">db:</span></span><br><span class="line">   <span class="attr">image:</span> <span class="string">mariadb:10.8</span></span><br><span class="line">   <span class="attr">container_name:</span> <span class="string">spug-db</span></span><br><span class="line">   <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line">   <span class="attr">command:</span> <span class="string">--character-set-server=utf8mb4</span> <span class="string">--collation-server=utf8mb4_unicode_ci</span></span><br><span class="line">   <span class="attr">volumes:</span></span><br><span class="line">     <span class="bullet">-</span> <span class="string">/data/spug/mysql:/var/lib/mysql</span></span><br><span class="line">   <span class="attr">environment:</span></span><br><span class="line">     <span class="bullet">-</span> <span class="string">MYSQL_DATABASE=spug</span></span><br><span class="line">     <span class="bullet">-</span> <span class="string">MYSQL_USER=spug</span></span><br><span class="line">     <span class="bullet">-</span> <span class="string">MYSQL_PASSWORD=spug.cc</span></span><br><span class="line">     <span class="bullet">-</span> <span class="string">MYSQL_ROOT_PASSWORD=spug.cc</span></span><br><span class="line"> <span class="attr">spug:</span></span><br><span class="line">   <span class="attr">image:</span> <span class="string">openspug/spug-service</span></span><br><span class="line">   <span class="attr">container_name:</span> <span class="string">spug</span></span><br><span class="line">   <span class="attr">privileged:</span> <span class="literal">true</span></span><br><span class="line">   <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line">   <span class="attr">volumes:</span></span><br><span class="line">     <span class="bullet">-</span> <span class="string">/data/spug/service:/data/spug</span></span><br><span class="line">     <span class="bullet">-</span> <span class="string">/data/spug/repos:/data/repos</span></span><br><span class="line">   <span class="attr">ports:</span></span><br><span class="line">      <span class="comment"># 如果80端口被占用可替换为其他端口，例如: - &quot;8000:80&quot;</span></span><br><span class="line">     <span class="bullet">-</span> <span class="string">&quot;80:80&quot;</span></span><br><span class="line">   <span class="attr">environment:</span></span><br><span class="line">     <span class="bullet">-</span> <span class="string">SPUG_DOCKER_VERSION=v3.2.1</span></span><br><span class="line">     <span class="bullet">-</span> <span class="string">MYSQL_DATABASE=spug</span></span><br><span class="line">     <span class="bullet">-</span> <span class="string">MYSQL_USER=spug</span></span><br><span class="line">     <span class="bullet">-</span> <span class="string">MYSQL_PASSWORD=spug.cc</span></span><br><span class="line">     <span class="bullet">-</span> <span class="string">MYSQL_HOST=db</span></span><br><span class="line">     <span class="bullet">-</span> <span class="string">MYSQL_PORT=3306</span></span><br><span class="line">   <span class="attr">depends_on:</span></span><br><span class="line">     <span class="bullet">-</span> <span class="string">db</span></span><br><span class="line">     </span><br><span class="line">     </span><br><span class="line"><span class="comment">#启动项目</span></span><br><span class="line"><span class="comment">#docker compose up -d</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#初始化:以下操作会创建一个用户名为 admin 密码为 spug.dev 的管理员账户，可自行替换管理员账户/密码。</span></span><br><span class="line"><span class="string">docker</span> <span class="string">exec</span> <span class="string">spug</span> <span class="string">init_spug</span> <span class="string">admin</span> <span class="string">spug.dev</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#访问测试:在浏览器中输入 http://localhost:80 访问（默认账户密码在上面一步初始化时设置）。</span></span><br></pre></td></tr></table></figure>

<h2 id="案例-一键生成-Docker-Compose"><a href="#案例-一键生成-Docker-Compose" class="headerlink" title="案例: 一键生成 Docker Compose"></a>案例: 一键生成 Docker Compose</h2><p>利用网站将docker 命令自动生成 Docker Compse</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://www.composerize.com/</span><br></pre></td></tr></table></figure>

<p><img src="../../../../images/SRE/day46/66.jpg" alt="66"></p>
<h1 id="Docker-仓库管理"><a href="#Docker-仓库管理" class="headerlink" title="Docker 仓库管理"></a>Docker 仓库管理</h1><p>Docker仓库，类似于yum仓库，是用来保存镜像的仓库。为了方便的管理和使用docker镜像,可以将镜像集中保存至Docker仓库中，将制作好的镜像push到仓库集中保存，在需要镜像时，从仓库中pull镜像即可。</p>
<p>Docker 仓库分为公有云仓库和私有云仓库</p>
<p>公有云仓库: 由互联网公司对外公开的仓库</p>
<ul>
<li>官方</li>
<li>阿里云等第三方仓库</li>
</ul>
<p>私有云仓库: 组织内部搭建的仓库，一般只为组织内部使用，常使用下面软件搭建仓库</p>
<ul>
<li>docker registory</li>
<li>docker harbor</li>
</ul>
<h2 id="官方-Docker-仓库"><a href="#官方-Docker-仓库" class="headerlink" title="官方 Docker 仓库"></a>官方 Docker 仓库</h2><p>将自制的镜像上传至docker仓库；<a target="_blank" rel="noopener" href="https://hub.docker.com/">https://hub.docker.com/</a></p>
<h3 id="注册账户"><a href="#注册账户" class="headerlink" title="注册账户"></a>注册账户</h3><p>访问hub.docker.com注册账户，并登录</p>
<p><img src="../../../../images/SRE/day46/67.jpg" alt="67"><br><img src="../../../../images/SRE/day46/68.jpg" alt="68"></p>
<p><img src="../../../../images/SRE/day46/69.jpg" alt="69"><br><img src="../../../../images/SRE/day46/70.jpg" alt="70"><br><img src="../../../../images/SRE/day46/71.jpg" alt="71"></p>
<h3 id="使用用户仓库管理镜像"><a href="#使用用户仓库管理镜像" class="headerlink" title="使用用户仓库管理镜像"></a>使用用户仓库管理镜像</h3><p>每个注册用户都可以上传和管理自已的镜像</p>
<h4 id="用户登录"><a href="#用户登录" class="headerlink" title="用户登录"></a>用户登录</h4><p>上传镜像前需要执行docker login命令登录，登录后生成~/.docker/config.json文件保存验证信息</p>
<p>格式</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">docker login [OPTIONS] [SERVER]</span><br><span class="line"></span><br><span class="line">选项:  </span><br><span class="line">-p, --password string   Password</span><br><span class="line">    --password-stdin   Take the password from stdin</span><br><span class="line">-u, --username string   Username</span><br></pre></td></tr></table></figure>

<p>范例: </p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#登录docker官方仓库方法1</span></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment"># docker login -u wangxiaochun -pP@ssw0rd! docker.io</span></span><br><span class="line">WARNING! Using --password via the CLI is insecure. Use --password-stdin.</span><br><span class="line">WARNING! Your password will be stored unencrypted <span class="keyword">in</span> /root/.docker/config.json.</span><br><span class="line">Configure a credential helper to remove this warning. See</span><br><span class="line">https://docs.docker.com/engine/reference/commandline/login/<span class="comment">#credentials-store</span></span><br><span class="line"></span><br><span class="line">Login Succeeded</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#登录docker官方仓库方法2</span></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment"># docker login </span></span><br><span class="line">Login with your Docker ID to push and pull images from Docker Hub. If you don<span class="string">&#x27;t </span></span><br><span class="line"><span class="string">have a Docker ID, head over to https://hub.docker.com to create one.</span></span><br><span class="line"><span class="string">Username: wangxiaochun</span></span><br><span class="line"><span class="string">Password: </span></span><br><span class="line"><span class="string">WARNING! Your password will be stored unencrypted in /root/.docker/config.json.</span></span><br><span class="line"><span class="string">Configure a credential helper to remove this warning. See</span></span><br><span class="line"><span class="string">https://docs.docker.com/engine/reference/commandline/login/#credentials-store</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Login Succeeded</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">#登录成功后,自动生成验证信息,下次会自动登录,而无需手动登录</span></span><br><span class="line"><span class="string">[root@ubuntu1804 ~]#cat .docker/config.json </span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">	&quot;auths&quot;: &#123;</span></span><br><span class="line"><span class="string"> 		&quot;https://index.docker.io/v1/&quot;: &#123;</span></span><br><span class="line"><span class="string">			&quot;auth&quot;: &quot;d2FuZ3hpYW9jaHVuOmxidG9vdGgwNjE4&quot;</span></span><br><span class="line"><span class="string">		&#125;</span></span><br><span class="line"><span class="string">	&#125;,</span></span><br><span class="line"><span class="string">	&quot;HttpHeaders&quot;: &#123;</span></span><br><span class="line"><span class="string">	&quot;User-Agent&quot;: &quot;Docker-Client/19.03.5 (linux)&quot;</span></span><br><span class="line"><span class="string">	&#125;</span></span><br><span class="line"><span class="string">&#125;</span></span><br></pre></td></tr></table></figure>

<h4 id="给本地镜像打标签"><a href="#给本地镜像打标签" class="headerlink" title="给本地镜像打标签"></a>给本地镜像打标签</h4><p>上传本地镜像前必须先给上传的镜像用docker tag 命令打标签</p>
<p>标签格式: <code>docker.io/用户帐号/镜像名:TAG</code></p>
<p>范例: </p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@ubuntu1804 ~]<span class="comment"># docker tag alpine:3.11 docker.io/wangxiaochun/alpine:3.11-v1</span></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment"># docker images </span></span><br><span class="line">wangxiaochun/alpine     3.11-v1             e7d92cdc71fe        12 days ago       5.59MB</span><br></pre></td></tr></table></figure>

<h4 id="上传本地镜像至官网"><a href="#上传本地镜像至官网" class="headerlink" title="上传本地镜像至官网"></a>上传本地镜像至官网</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#如tag省略,将上传指定REPOSITORY的所有版本,如下示例</span></span><br><span class="line"><span class="comment">#[root@ubuntu1804 ~]# docker push docker.io/wangxiaochun/alpine</span></span><br><span class="line"></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment"># docker push docker.io/wangxiaochun/alpine:3.11-v1</span></span><br><span class="line">The push refers to repository [docker.io/wangxiaochun/alpine]</span><br><span class="line">5216338b40a7: Mounted from wanglinux/alpine-base </span><br><span class="line">3.11-v1: digest: </span><br><span class="line">sha256:ddba4d27a7ffc3f86dd6c2f92041af252a1f23a8e742c90e6e1297bfa1bc0c45 size: 528</span><br></pre></td></tr></table></figure>

<h4 id="在官网验证上传的镜像"><a href="#在官网验证上传的镜像" class="headerlink" title="在官网验证上传的镜像"></a>在官网验证上传的镜像</h4><p><img src="../../../../images/SRE/day46/72.jpg" alt="72"><br><img src="../../../../images/SRE/day46/73.jpg" alt="73"><br><img src="../../../../images/SRE/day46/74.jpg" alt="74"></p>
<h4 id="下载上传的镜像并创建容器"><a href="#下载上传的镜像并创建容器" class="headerlink" title="下载上传的镜像并创建容器"></a>下载上传的镜像并创建容器</h4><p>在另一台主机上下载镜像</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root@centos7 ~]<span class="comment"># docker pull wangxiaochun/alpine:3.11-v1</span></span><br><span class="line"></span><br><span class="line">[root@centos7 ~]<span class="comment"># docker run -it --rm wangxiaochun/alpine:3.11-v1 sh</span></span><br><span class="line">/ <span class="comment"># cat /etc/issue</span></span><br><span class="line">Welcome to Alpine Linux 3.11</span><br><span class="line">Kernel \r on an \m (\l)</span><br><span class="line"></span><br><span class="line">/ <span class="comment"># du -sh /</span></span><br><span class="line">5.6M /</span><br><span class="line"></span><br><span class="line">/ <span class="comment"># exit</span></span><br></pre></td></tr></table></figure>

<h3 id="使用组织管理镜像"><a href="#使用组织管理镜像" class="headerlink" title="使用组织管理镜像"></a>使用组织管理镜像</h3><p>组织类似于名称空间，每个组织的名称全网站唯一，一个组织可以有多个用户帐户使用，并且可以指定不同用户对组织内的仓库不同的权限</p>
<p>三种不同权限</p>
<ul>
<li>Read-only: Pull and view repository details and builds</li>
<li>Read &amp;Write: Pull, push, and view a repository; view, cancel, retry or trigger builds</li>
<li>Admin: Pull, push, view, edit, and delete a repository; edit build settings; update the repository description</li>
</ul>
<h4 id="创建组织"><a href="#创建组织" class="headerlink" title="创建组织"></a>创建组织</h4><p><img src="../../../../images/SRE/day46/75.jpg" alt="75"><br><img src="../../../../images/SRE/day46/76.jpg" alt="76"><br><img src="../../../../images/SRE/day46/77.jpg" alt="77"></p>
<h4 id="创建组织内的团队，并分配权限"><a href="#创建组织内的团队，并分配权限" class="headerlink" title="创建组织内的团队，并分配权限"></a>创建组织内的团队，并分配权限</h4><p><img src="../../../../images/SRE/day46/78.jpg" alt="78"><br><img src="../../../../images/SRE/day46/79.jpg" alt="79"><br><img src="../../../../images/SRE/day46/80.jpg" alt="80"></p>
<h4 id="上传镜像前登录帐号"><a href="#上传镜像前登录帐号" class="headerlink" title="上传镜像前登录帐号"></a>上传镜像前登录帐号</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[root@ubuntu1804 ~]<span class="comment"># docker login docker.io </span></span><br><span class="line">Login Succeeded</span><br><span class="line"></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment"># cat .docker/config.json </span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="string">&quot;auths&quot;</span>: &#123;</span><br><span class="line">		<span class="string">&quot;https://index.docker.io/v1/&quot;</span>: &#123;</span><br><span class="line">			<span class="string">&quot;auth&quot;</span>: <span class="string">&quot;d2FuZ3hpYW9jaHVuOmxidG9vdGgwNjE4&quot;</span></span><br><span class="line">		&#125;</span><br><span class="line">	&#125;,</span><br><span class="line">	<span class="string">&quot;HttpHeaders&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;User-Agent&quot;</span>: <span class="string">&quot;Docker-Client/19.03.5 (linux)&quot;</span></span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="给本地镜像打标签-1"><a href="#给本地镜像打标签-1" class="headerlink" title="给本地镜像打标签"></a>给本地镜像打标签</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@ubuntu1804 ~]<span class="comment"># docker tag alpine-base:3.11 docker.io/wanglinux/alpine-base:3.11</span></span><br></pre></td></tr></table></figure>

<h4 id="上传镜像到指定的组织"><a href="#上传镜像到指定的组织" class="headerlink" title="上传镜像到指定的组织"></a>上传镜像到指定的组织</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@ubuntu1804 ~]<span class="comment"># docker push docker.io/wanglinux/alpine-base:3.11</span></span><br></pre></td></tr></table></figure>

<h4 id="在网站看查看上传的镜像"><a href="#在网站看查看上传的镜像" class="headerlink" title="在网站看查看上传的镜像"></a>在网站看查看上传的镜像</h4><p><img src="../../../../images/SRE/day46/81.jpg" alt="81"><br><img src="../../../../images/SRE/day46/82.jpg" alt="82"><br><img src="../../../../images/SRE/day46/83.jpg" alt="83"></p>
<h4 id="下载上传的镜像并运行容器"><a href="#下载上传的镜像并运行容器" class="headerlink" title="下载上传的镜像并运行容器"></a>下载上传的镜像并运行容器</h4><p>在另一台主机上下载镜像</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[root@centos7 ~]<span class="comment"># docker pull wanglinux/alpine-base:3.11</span></span><br><span class="line">[root@centos7 ~]<span class="comment"># docker run -it --rm wanglinux/alpine-base:3.11 sh</span></span><br><span class="line">/ <span class="comment"># cat /etc/issue</span></span><br><span class="line">Welcome to Alpine Linux 3.11</span><br><span class="line">Kernel \r on an \m (\l)</span><br><span class="line"></span><br><span class="line">/ <span class="comment"># du -sh /</span></span><br><span class="line">190.1M /</span><br><span class="line"></span><br><span class="line">/ <span class="comment"># exit</span></span><br></pre></td></tr></table></figure>

<h2 id="阿里云Docker仓库"><a href="#阿里云Docker仓库" class="headerlink" title="阿里云Docker仓库"></a>阿里云Docker仓库</h2><p><img src="../../../../images/SRE/day46/84.jpg" alt="84"></p>
<h3 id="注册和登录阿里云仓库"><a href="#注册和登录阿里云仓库" class="headerlink" title="注册和登录阿里云仓库"></a>注册和登录阿里云仓库</h3><p>用浏览器访问<a target="_blank" rel="noopener" href="http://cr.console.aliyun.com,输入注册的用户信息登录网站/">http://cr.console.aliyun.com，输入注册的用户信息登录网站</a></p>
<p><img src="../../../../images/SRE/day46/85.jpg" alt="85"><br><img src="../../../../images/SRE/day46/86.jpg" alt="86"></p>
<h3 id="设置仓库专用管理密码"><a href="#设置仓库专用管理密码" class="headerlink" title="设置仓库专用管理密码"></a>设置仓库专用管理密码</h3><p><img src="../../../../images/SRE/day46/87.jpg" alt="87"><br><img src="../../../../images/SRE/day46/88.jpg" alt="88"><br><img src="../../../../images/SRE/day46/89.jpg" alt="89"></p>
<h3 id="创建仓库"><a href="#创建仓库" class="headerlink" title="创建仓库"></a>创建仓库</h3><p><strong>此步可不事先执行，docker push 时可以自动创建私有仓库</strong></p>
<p><img src="../../../../images/SRE/day46/90.jpg" alt="90"><br><img src="../../../../images/SRE/day46/91.jpg" alt="91"><br><img src="../../../../images/SRE/day46/92.jpg" alt="92"><br><img src="../../../../images/SRE/day46/93.jpg" alt="93"></p>
<p><strong>查看仓库的路径用于上传镜像使用</strong></p>
<p><img src="../../../../images/SRE/day46/94.jpg" alt="94"></p>
<h3 id="上传镜像前先登录阿里云"><a href="#上传镜像前先登录阿里云" class="headerlink" title="上传镜像前先登录阿里云"></a>上传镜像前先登录阿里云</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#用前面设置的专用仓库管理密码登录</span></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment">#docker login --username=29308620@qq.com registry.cn-beijing.aliyuncs.com</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#登录密码保存在~/.docker/config.json文件中，下次将不会需要再输入密码登录</span></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment">#cat .docker/config.json </span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="string">&quot;auths&quot;</span>: &#123;</span><br><span class="line">		<span class="string">&quot;https://index.docker.io/v1/&quot;</span>: &#123;</span><br><span class="line">			<span class="string">&quot;auth&quot;</span>: <span class="string">&quot;d2FuZ3hpYW9jaHVuOmxidG9vdGgwNjE4&quot;</span></span><br><span class="line">		&#125;,</span><br><span class="line">		<span class="string">&quot;registry.cn-beijing.aliyuncs.com&quot;</span>: &#123;</span><br><span class="line">			<span class="string">&quot;auth&quot;</span>: <span class="string">&quot;MjkzMDg2MjBAcXEuY29tOmxidG9vdGgwNjE4&quot;</span></span><br><span class="line">		&#125;</span><br><span class="line"> 	&#125;,</span><br><span class="line">	<span class="string">&quot;HttpHeaders&quot;</span>: &#123;</span><br><span class="line">		<span class="string">&quot;User-Agent&quot;</span>: <span class="string">&quot;Docker-Client/19.03.5 (linux)&quot;</span></span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="给上传的镜像打标签"><a href="#给上传的镜像打标签" class="headerlink" title="给上传的镜像打标签"></a>给上传的镜像打标签</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@ubuntu1804 ~]<span class="comment"># docker tag alpine-base:3.11 registry.cn-beijing.aliyuncs.com/wangxiaochun/alpine:3.11-v1</span></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment"># docker tag centos7-base:v1 registry.cn-beijing.aliyuncs.com/wangxiaochun/centos7-base:v1</span></span><br></pre></td></tr></table></figure>

<h3 id="上传镜像至阿里云"><a href="#上传镜像至阿里云" class="headerlink" title="上传镜像至阿里云"></a>上传镜像至阿里云</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@ubuntu1804 ~]<span class="comment"># docker push registry.cn- beijing.aliyuncs.com/wangxiaochun/alpine:3.11-v1</span></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment">#docker push registry.cn-beijing.aliyuncs.com/wangxiaochun/centos7-base:v1</span></span><br></pre></td></tr></table></figure>

<h3 id="在网站查看上传的镜像"><a href="#在网站查看上传的镜像" class="headerlink" title="在网站查看上传的镜像"></a>在网站查看上传的镜像</h3><p><img src="../../../../images/SRE/day46/95.jpg" alt="95"></p>
<h3 id="从另一台主机上下载刚上传的镜像并运行容器"><a href="#从另一台主机上下载刚上传的镜像并运行容器" class="headerlink" title="从另一台主机上下载刚上传的镜像并运行容器"></a>从另一台主机上下载刚上传的镜像并运行容器</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">[root@centos7 ~]<span class="comment"># docker pull registry.cn-beijing.aliyuncs.com/wangxiaochun/alpine:3.11-v1</span></span><br><span class="line"></span><br><span class="line">[root@centos7 ~]<span class="comment">#docker run -it --rm b162eecf4da9 sh</span></span><br><span class="line">/ <span class="comment"># cat /etc/issue</span></span><br><span class="line">Welcome to Alpine Linux 3.11</span><br><span class="line">Kernel \r on an \m (\l)</span><br><span class="line"></span><br><span class="line">/ <span class="comment"># du -sh /</span></span><br><span class="line">190.1M /</span><br><span class="line"></span><br><span class="line">/ <span class="comment"># exit</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#上传的centos7-base:v1为私有镜像，需要登录才能下载</span></span><br><span class="line">[root@centos7 ~]<span class="comment"># docker pull registry.cn-beijing.aliyuncs.com/wangxiaochun/centos7-base:v1</span></span><br><span class="line">Error response from daemon: pull access denied <span class="keyword">for</span> registry.cn-beijing.aliyuncs.com/wangxiaochun/centos7-base, repository does not exist or may </span><br><span class="line">require <span class="string">&#x27;docker login&#x27;</span>: denied: requested access to the resource is denied</span><br><span class="line"></span><br><span class="line">[root@centos7 ~]<span class="comment"># docker login registry.cn-beijing.aliyuncs.com</span></span><br><span class="line"></span><br><span class="line">[root@centos7 ~]<span class="comment"># docker pull registry.cn-beijing.aliyuncs.com/wangxiaochun/centos7-base:v1</span></span><br></pre></td></tr></table></figure>

<h2 id="私有云单机仓库Docker-Registry"><a href="#私有云单机仓库Docker-Registry" class="headerlink" title="私有云单机仓库Docker Registry"></a>私有云单机仓库Docker Registry</h2><h3 id="Docker-Registry-介绍"><a href="#Docker-Registry-介绍" class="headerlink" title="Docker Registry 介绍"></a>Docker Registry 介绍</h3><p>Docker Registry作为Docker的核心组件之一负责单主机的镜像内容的存储与分发，客户端的docker pull以及push命令都将直接与registry进行交互,最初版本的registry 由Python实现，由于设计初期在安全性，性能以及API的设计上有着诸多的缺陷，该版本在0.9之后停止了开发，由新项目distribution（新的docker register被称为Distribution）来重新设计并开发下一代registry，新的项目由go语言开发，所有的API，底层存储方式，系统架构都进行了全面的重新设计已解决上一代registry中存在的问题，2016年4月份registry 2.0正式发布，docker 1.6版本开始支持registry 2.0，而八月份随着docker 1.8 发布，docker hub正式启用2.1版本registry全面替代之前版本 registry，新版registry对镜像存储格式进行了重新设计并和旧版不兼容，docker 1.5和之前的版本无法读取2.0的镜像，另外，Registry 2.4版本之后支持了回收站机制，也就是可以删除镜像了，在2.4版本之前是无法支持删除镜像的，所以如果你要使用最好是大于Registry 2.4版本的</p>
<p>官方文档地址: <a target="_blank" rel="noopener" href="https://docs.docker.com/registry/">https://docs.docker.com/registry/</a></p>
<p>官方github 地址: <a target="_blank" rel="noopener" href="https://github.com/docker/distribution">https://github.com/docker/distribution</a></p>
<p>官方部署文档: <a target="_blank" rel="noopener" href="https://github.com/docker/docker.github.io/blob/master/registry/deploying.md">https://github.com/docker/docker.github.io/blob/master/registry/deploying.md</a></p>
<p><img src="../../../../images/SRE/day46/96.jpg" alt="96"><br><img src="../../../../images/SRE/day46/97.jpg" alt="97"></p>
<p>以下介绍通过官方提供的docker registry 镜像来简单搭建本地私有仓库环境</p>
<p>环境: 三台主机</p>
<p>10.0.0.100: 充当registry仓库服务器</p>
<p>10.0.0.101: 上传镜像</p>
<p>10.0.0.102: 下载镜像</p>
<h3 id="下载-docker-registry-镜像"><a href="#下载-docker-registry-镜像" class="headerlink" title="下载 docker registry 镜像"></a>下载 docker registry 镜像</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@ubuntu1804 ~]<span class="comment"># docker pull registry:2.7.1</span></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment"># docker images</span></span><br><span class="line">REPOSITORY          TAG                 IMAGE ID           CREATED             SIZE</span><br><span class="line">registry            2.7.1               708bc6af7e5e        6 days ago         25.8MB</span><br></pre></td></tr></table></figure>

<h3 id="搭建单机仓库"><a href="#搭建单机仓库" class="headerlink" title="搭建单机仓库"></a>搭建单机仓库</h3><h4 id="创建授权用户密码使用目录"><a href="#创建授权用户密码使用目录" class="headerlink" title="创建授权用户密码使用目录"></a>创建授权用户密码使用目录</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@ubuntu1804 ~]<span class="comment"># mkdir -p /etc/docker/auth</span></span><br></pre></td></tr></table></figure>

<h4 id="创建授权的registry用户和密码"><a href="#创建授权的registry用户和密码" class="headerlink" title="创建授权的registry用户和密码"></a>创建授权的registry用户和密码</h4><p>创建registry用户，用于上传和下载镜像</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@ubuntu1804 ~]<span class="comment"># apt -y install apache2-utils</span></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment"># htpasswd -Bbn wang 123456 &gt; /etc/docker/auth/registry</span></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment"># cat /etc/docker/auth/registry</span></span><br><span class="line">wang:$2y$05<span class="variable">$nlRIIYEUBTSLdN2PkzodUue4ry7X</span>/UyscpkkEufTDhEdI8nsyJMR6</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#旧版本可以按下面方法生成用户和密码文件</span></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment"># docker run --entrypoint htpasswd registry:2.7.1 -Bbn wang 123456 &gt; /etc/docker/auth/registry</span></span><br></pre></td></tr></table></figure>

<h4 id="启动docker-registry-容器"><a href="#启动docker-registry-容器" class="headerlink" title="启动docker registry 容器"></a>启动docker registry 容器</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@ubuntu1804 ~]<span class="comment"># docker run -d -p 5000:5000 --restart=always --name registry \</span></span><br><span class="line">-v /etc/docker/auth:/auth -e <span class="string">&quot;REGISTRY_AUTH=htpasswd&quot;</span> \</span><br><span class="line">-e <span class="string">&quot;REGISTRY_AUTH_HTPASSWD_REALM=Registry Realm&quot;</span> \</span><br><span class="line">-e REGISTRY_AUTH_HTPASSWD_PATH=/auth/registry registry:2.7.1</span><br><span class="line"></span><br><span class="line">998f970dd8ca6b98002f20ae27330fe607ca78f35bedcc8a6180688e48a907a7</span><br></pre></td></tr></table></figure>

<h4 id="验证端口和容器"><a href="#验证端口和容器" class="headerlink" title="验证端口和容器"></a>验证端口和容器</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@ubuntu1804 ~]<span class="comment">#docker ps </span></span><br><span class="line">CONTAINER ID       IMAGE               COMMAND                 CREATED             STATUS             PORTS                   NAMES</span><br><span class="line">998f970dd8ca       registry:2.7.1      <span class="string">&quot;/entrypoint.sh /etc…&quot;</span>   About a minute ago   Up About a minute   0.0.0.0:5000-&gt;5000/tcp   registry</span><br><span class="line"></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment"># ss -ntl</span></span><br><span class="line">LISTEN   0        128                     *:5000               *:*</span><br></pre></td></tr></table></figure>

<h3 id="登录仓库"><a href="#登录仓库" class="headerlink" title="登录仓库"></a>登录仓库</h3><h4 id="直接登录报错"><a href="#直接登录报错" class="headerlink" title="直接登录报错"></a>直接登录报错</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#docker login 默认使用https登录,而docker registry为http,所以默认登录失败</span></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment"># docker login 10.0.0.100:500</span></span><br><span class="line">Username: wang</span><br><span class="line">Password: </span><br><span class="line">Error response from daemon: Get https://10.0.0.100:500/v2/: dial tcp </span><br><span class="line">10.0.0.100:500: connect: connection refused</span><br></pre></td></tr></table></figure>

<h4 id="将registry仓库服务器地址加入service-单元文件"><a href="#将registry仓库服务器地址加入service-单元文件" class="headerlink" title="将registry仓库服务器地址加入service 单元文件"></a>将registry仓库服务器地址加入service 单元文件</h4><p>官方文档:</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://docs.docker.com/registry/insecure/</span><br></pre></td></tr></table></figure>

<p>范例: </p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#修改配置让docker login支持http协议</span></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment"># vim /lib/systemd/system/docker.service</span></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment"># grep ExecStart /lib/systemd/system/docker.service</span></span><br><span class="line">ExecStart=/usr/bin/dockerd -H fd:// --containerd=/run/containerd/containerd.sock --insecure-registry 10.0.0.100:5000</span><br><span class="line"></span><br><span class="line"><span class="comment">#或者修改下面文件</span></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment"># vim /etc/docker/daemon.json </span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="string">&quot;registry-mirrors&quot;</span>:  [<span class="string">&quot;https://si7y70hh.mirror.aliyuncs.com&quot;</span>], </span><br><span class="line">	<span class="string">&quot;insecure-registries&quot;</span>: [<span class="string">&quot;10.0.0.100:5000&quot;</span>]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment"># systemctl daemon-reload </span></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment"># systemctl restart docker</span></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment"># ps aux|grep dockerd</span></span><br><span class="line">root       2092  1.3  8.4 757088 83056 ?       Ssl  19:19   0:00 </span><br><span class="line">/usr/bin/dockerd -H fd:// --containerd=/run/containerd/containerd.sock --insecure-registry 10.0.0.100:5000</span><br></pre></td></tr></table></figure>

<h4 id="再次登录验证成功"><a href="#再次登录验证成功" class="headerlink" title="再次登录验证成功"></a>再次登录验证成功</h4><p>在10.0.0.101主机上执行下面登录</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@ubuntu1804 ~]<span class="comment"># docker login 10.0.0.100:5000</span></span><br><span class="line">Username: wang</span><br><span class="line">Password: </span><br><span class="line">WARNING! Your password will be stored unencrypted <span class="keyword">in</span> /root/.docker/config.json.</span><br><span class="line">Configure a credential helper to remove this warning. See</span><br><span class="line">https://docs.docker.com/engine/reference/commandline/login/<span class="comment">#credentials-store</span></span><br><span class="line"></span><br><span class="line">Login Succeeded</span><br></pre></td></tr></table></figure>

<h3 id="打标签并上传镜像"><a href="#打标签并上传镜像" class="headerlink" title="打标签并上传镜像"></a>打标签并上传镜像</h3><p>在10.0.0.101主机上执行打标签上传</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@ubuntu1804 ~]<span class="comment"># docker tag centos7-base:v1 10.0.0.100:5000/centos7-base:v1</span></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment"># docker push 10.0.0.100:5000/centos7-base:v1</span></span><br></pre></td></tr></table></figure>

<h3 id="下载镜像并启动容器"><a href="#下载镜像并启动容器" class="headerlink" title="下载镜像并启动容器"></a>下载镜像并启动容器</h3><p>在10.0.0.102主机上下载镜像并启动容器</p>
<h4 id="先修改docker的service-文件"><a href="#先修改docker的service-文件" class="headerlink" title="先修改docker的service 文件"></a>先修改docker的service 文件</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@ubuntu1804 ~]<span class="comment"># vim /lib/systemd/system/docker.service</span></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment"># grep ExecStart /lib/systemd/system/docker.service</span></span><br><span class="line">ExecStart=/usr/bin/dockerd -H fd:// --containerd=/run/containerd/containerd.sock --insecure-registry 10.0.0.100:5000</span><br><span class="line"></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment"># systemctl daemon-reload </span></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment"># systemctl restart docker</span></span><br></pre></td></tr></table></figure>

<h4 id="登录registry仓库服务器"><a href="#登录registry仓库服务器" class="headerlink" title="登录registry仓库服务器"></a>登录registry仓库服务器</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@ubuntu1804 ~]<span class="comment"># docker login 10.0.0.100:5000</span></span><br><span class="line">Username: wang</span><br><span class="line">Password: </span><br><span class="line">WARNING! Your password will be stored unencrypted <span class="keyword">in</span> /root/.docker/config.json.</span><br><span class="line">Configure a credential helper to remove this warning. See</span><br><span class="line">https://docs.docker.com/engine/reference/commandline/login/<span class="comment">#credentials-store</span></span><br><span class="line"></span><br><span class="line">Login Succeeded</span><br></pre></td></tr></table></figure>

<h4 id="下载镜像并启动容器-1"><a href="#下载镜像并启动容器-1" class="headerlink" title="下载镜像并启动容器"></a>下载镜像并启动容器</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@ubuntu1804 ~]<span class="comment"># docker pull 10.0.0.100:5000/centos7-base:v1</span></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment"># docker run -it --rm 10.0.0.100:5000/centos7-base:v1 bash</span></span><br><span class="line">[root@2bcb26b1b568 /]<span class="comment"># cat /etc/redhat-release </span></span><br><span class="line">CentOS Linux release 7.7.1908 (Core)</span><br><span class="line"></span><br><span class="line">[root@2bcb26b1b568 /]<span class="comment"># exit</span></span><br><span class="line"><span class="built_in">exit</span></span><br></pre></td></tr></table></figure>

<h2 id="Docker-之分布式仓库-Harbor"><a href="#Docker-之分布式仓库-Harbor" class="headerlink" title="Docker 之分布式仓库 Harbor"></a>Docker 之分布式仓库 Harbor</h2><h3 id="Harbor-介绍和架构"><a href="#Harbor-介绍和架构" class="headerlink" title="Harbor 介绍和架构"></a>Harbor 介绍和架构</h3><h4 id="Harbor-介绍"><a href="#Harbor-介绍" class="headerlink" title="Harbor 介绍"></a>Harbor 介绍</h4><p><img src="../../../../images/SRE/day46/98.jpg" alt="98"></p>
<p>Harbor是一个用于存储和分发Docker镜像的企业级Registry服务器，由VMware开源，其通过添加一些企业必需的功能特性，例如安全、标识和管理等，扩展了开源 Docker Distribution。作为一个企业级私有Registry服务器，Harbor 提供了更好的性能和安全。提升用户使用Registry构建和运行环境传输镜像的效率。Harbor支持安装在多个Registry节点的镜像资源复制，镜像全部保存在私有 Registry 中， 确保数据和知识产权在公司内部网络中管控，另外，Harbor也提供了高级的安全特性，诸如用户管理，访问控制和活动审计等</p>
<p>vmware 官方开源服务: <a target="_blank" rel="noopener" href="https://vmware.github.io/">https://vmware.github.io/</a></p>
<p>harbor 官方github 地址: <a target="_blank" rel="noopener" href="https://github.com/vmware/harbor">https://github.com/vmware/harbor</a></p>
<p>harbor 官方网址: <a target="_blank" rel="noopener" href="https://goharbor.io/">https://goharbor.io/</a></p>
<p>harbor 官方文档: <a target="_blank" rel="noopener" href="https://goharbor.io/docs/">https://goharbor.io/docs/</a></p>
<p>github文档: <a target="_blank" rel="noopener" href="https://github.com/goharbor/harbor/tree/master/docs">https://github.com/goharbor/harbor/tree/master/docs</a></p>
<h4 id="Harbor功能官方介绍"><a href="#Harbor功能官方介绍" class="headerlink" title="Harbor功能官方介绍"></a>Harbor功能官方介绍</h4><ul>
<li>基于角色的访问控制: 用户与Docker镜像仓库通过“项目”进行组织管理，一个用户可以对多个镜像仓库在同一命名空间（project）里有不同的权限 </li>
<li>镜像复制: 镜像可在多个Registry实例中复制（同步）。尤其适合于负载均衡，高可用，混合云和多云的场景</li>
<li>图形化用户界面: 用户可以通过浏览器来浏览，检索当前Docker镜像仓库，管理项目和命名空间</li>
<li>AD/LDAP 支: Harbor可以集成企业内部已有的AD/LDAP，用于鉴权认证管理</li>
<li>审计管理: 所有针对镜像仓库的操作都可以被记录追溯，用于审计管理</li>
<li>国际化: 已拥有英文、中文、德文、日文和俄文的本地化版本。更多的语言将会添加进来</li>
<li>RESTful API: 提供给管理员对于Harbor更多的操控, 使得与其它管理软件集成变得更容易</li>
<li>部署简单: 提供在线和离线两种安装工具， 也可以安装到vSphere平台(OVA方式)虚拟设备</li>
</ul>
<h4 id="Harbor-组成"><a href="#Harbor-组成" class="headerlink" title="Harbor 组成"></a>Harbor 组成</h4><p><img src="../../../../images/SRE/day46/99.jpg" alt="99"></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#harbor是由很多容器组成实现完整功能</span></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment">#docker ps -a</span></span><br><span class="line">CONTAINER ID       IMAGE                                   COMMAND                 CREATED             STATUS                       PORTS                                                             NAMES</span><br><span class="line">4ec3c3885407       goharbor/nginx-photon:v1.7.6             <span class="string">&quot;nginx -g &#x27;daemon of…&quot;</span>   About a minute ago   Up About a minute (healthy)   0.0.0.0:80-&gt;80/tcp, 0.0.0.0:443-&gt;443/tcp, 0.0.0.0:4443-&gt;4443/tcp   nginx</span><br><span class="line">5707b4ac41d8       goharbor/harbor-portal:v1.7.6            <span class="string">&quot;nginx -g &#x27;daemon of…&quot;</span>   About a minute ago   Up About a minute (healthy)   80/tcp                                                             harbor-portal</span><br><span class="line">0ed230b9b714       goharbor/harbor-jobservice:v1.7.6        <span class="string">&quot;/harbor/start.sh&quot;</span>      About a minute ago   Up About a minute                                                                               harbor-jobservice</span><br><span class="line">fec659188349       goharbor/harbor-core:v1.7.6              <span class="string">&quot;/harbor/start.sh&quot;</span>      About a minute ago   Up About a minute (healthy)                                                                     harbor-core</span><br><span class="line">910d14c1d7f7       goharbor/harbor-adminserver:v1.7.6       <span class="string">&quot;/harbor/start.sh&quot;</span>      2 minutes ago       Up About a minute (healthy)                                                                     harbor-adminserver</span><br><span class="line">4348f503aa0e       goharbor/harbor-db:v1.7.6                <span class="string">&quot;/entrypoint.sh post…&quot;</span>   2 minutes ago       Up About a minute (healthy)   5432/tcp                                                           harbor-db</span><br><span class="line">beff6886f0f1       goharbor/harbor-registryctl:v1.7.6       <span class="string">&quot;/harbor/start.sh&quot;</span>      2 minutes ago       Up About a minute (healthy)                                                                     registryctl</span><br><span class="line">428c99d274bf       goharbor/registry-photon:v2.6.2-v1.7.6   <span class="string">&quot;/entrypoint.sh /etc…&quot;</span>   2 minutes ago       Up About a minute (healthy)   5000/tcp                                                           registry</span><br><span class="line">775b4026fa4e       goharbor/redis-photon:v1.7.6             <span class="string">&quot;dockerentrypoint.s…&quot;</span>   2 minutes ago       Up About a minute             6379/tcp                                                           redis</span><br></pre></td></tr></table></figure>

<ul>
<li>Proxy: 对应启动组件nginx。它是一个nginx反向代理，代理Notary client（镜像认证）、Docker  client（镜像上传下载等）和浏览器的访问请求（Core Service）给后端的各服务</li>
<li>UI（Core Service）: 对应启动组件harbor-ui。底层数据存储使用mysql数据库，主要提供了四个 子功能: <ul>
<li>UI: 一个web管理页面ui</li>
<li>API: Harbor暴露的API服务</li>
<li>Auth: 用户认证服务，decode后的token中的用户信息在这里进行认证；auth后端可以接db、ldap、uaa三种认证实现</li>
<li>Token服务（上图中未体现）: 负责根据用户在每个project中的role来为每一个docker push/pull命令发布一个token，如果从docker client发送给registry的请求没有带token， registry会重定向请求到token服务创建token</li>
</ul>
</li>
<li>Registry: 对应启动组件registry。负责存储镜像文件，和处理镜像的pull/push命令。Harbor对镜像进行强制的访问控制，Registry会将客户端的每个pull、push请求转发到token服务来获取有效的token</li>
<li>Admin Service: 对应启动组件harbor-adminserver。是系统的配置管理中心附带检查存储用量，ui和jobserver启动时候需要加载adminserver的配置</li>
<li>Job Sevice: 对应启动组件harbor-jobservice。负责镜像复制工作的，他和registry通信，从一个registry pull镜像然后push到另一个registry，并记录job_log</li>
<li>Log Collector: 对应启动组件harbor-log。日志汇总组件，通过docker的log-driver把日志汇总到一起</li>
<li>DB: 对应启动组件harbor-db，负责存储project、 user、 role、replication、image_scan、access等的metadata数据</li>
</ul>
<h3 id="安装-Harbor"><a href="#安装-Harbor" class="headerlink" title="安装 Harbor"></a>安装 Harbor</h3><p>下载地址: <a target="_blank" rel="noopener" href="https://github.com/vmware/harbor/releases">https://github.com/vmware/harbor/releases</a></p>
<p>安装文档: <a target="_blank" rel="noopener" href="https://github.com/goharbor/harbor/blob/master/docs/install-config/_index.md">https://github.com/goharbor/harbor/blob/master/docs/install-config/_index.md</a></p>
<p>环境准备: 共四台主机</p>
<ul>
<li>两台主机harbor服务器，地址: 10.0.0.101|102</li>
<li>两台主机harbor客户端上传和下载镜像</li>
</ul>
<p><img src="../../../../images/SRE/day46/100.jpg" alt="100"></p>
<h4 id="下载Harbor安装包并解压缩"><a href="#下载Harbor安装包并解压缩" class="headerlink" title="下载Harbor安装包并解压缩"></a>下载Harbor安装包并解压缩</h4><p><code>必须先安装 docker</code>再安装 <code>docker compose</code></p>
<p>否则会报以下错误</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@ubuntu1804 ~]<span class="comment"># /apps/harbor/install.sh </span></span><br><span class="line">[Step 0]: checking installation environment ...</span><br><span class="line"></span><br><span class="line">Note: docker version: 19.03.5</span><br><span class="line">✖ Need to install docker-compose(1.7.1+) by yourself first and run this script again</span><br></pre></td></tr></table></figure>

<p>以下使用 harbor 稳定版本1.7.6 安装包</p>
<p>方法1: 下载离线完整安装包,推荐使用</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@ubuntu1804 ~]<span class="comment"># wget https://storage.googleapis.com/harbor-releases/release-1.7.0/harbor-offline-installer-v1.7.6.tgz</span></span><br><span class="line"></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment"># wget https://github.com/goharbor/harbor/releases/download/v2.5.2/harbor-offline-installer-v2.5.2.tgz</span></span><br></pre></td></tr></table></figure>

<p>方法2: 下载在线安装包 ,比较慢，不是很推荐</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@ubuntu1804 ~]<span class="comment"># wget https://storage.googleapis.com/harbor-releases/release-1.7.0/harbor-online-installer-v1.7.6.tgz</span></span><br></pre></td></tr></table></figure>

<p><strong>解压缩离线包</strong></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@ubuntu1804 ~]<span class="comment"># mkdir /apps</span></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment"># tar xvf harbor-offline-installer-v1.7.6.tgz -C /apps/</span></span><br></pre></td></tr></table></figure>

<h4 id="编辑-harbor-配置文件"><a href="#编辑-harbor-配置文件" class="headerlink" title="编辑 harbor 配置文件"></a>编辑 harbor 配置文件</h4><p>最新文档: <a target="_blank" rel="noopener" href="https://github.com/goharbor/harbor/blob/master/docs/install-config/configure-yml-file.md">https://github.com/goharbor/harbor/blob/master/docs/install-config/configure-yml-file.md</a></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#新版配置文件为yml格式</span></span><br><span class="line">[root@ubuntu2004~]<span class="comment"># mv /apps/harbor/harbor.yml.tmpl /apps/harbor/harbor.yml</span></span><br><span class="line">[root@ubuntu2004 ~]<span class="comment"># mv /apps/harbor/harbor.yml</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#旧版配置文件为文本格式</span></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment"># vim /apps/harbor/harbor.cfg</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#只需要修改下面两行</span></span><br><span class="line">hostname = 10.0.0.101  <span class="comment">#修改此行,指向当前主机IP 或 FQDN,建议配置IP</span></span><br><span class="line">harbor_admin_password = 123456 <span class="comment">#修改此行指定harbor登录用户admin的密码,默认用户/密码:admin/Harbor12345</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#可选项</span></span><br><span class="line">ui_url_protocol = http <span class="comment">#默认即可,如果修改为https,需要指定下面证书路径</span></span><br><span class="line">ssl_cert = /data/cert/server.crt <span class="comment">#默认即可,https时，需指定下面证书文件路径</span></span><br><span class="line">ss_cert_key = /data/cert/server.key   <span class="comment">#默认即可,https时，需指定下面私钥文件路径</span></span><br></pre></td></tr></table></figure>

<h4 id="运行-harbor-安装脚本"><a href="#运行-harbor-安装脚本" class="headerlink" title="运行 harbor 安装脚本"></a>运行 harbor 安装脚本</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#先安装python</span></span><br><span class="line">root@ubuntu1804 ~]<span class="comment"># apt -y install python</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#安装docker harbor </span></span><br><span class="line">root@ubuntu1804 ~]<span class="comment"># /apps/harbor/install.sh</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#安装harbor后会自动开启很多相关容器</span></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment"># docker ps </span></span><br></pre></td></tr></table></figure>

<h4 id="实现开机自动启动-harbor"><a href="#实现开机自动启动-harbor" class="headerlink" title="实现开机自动启动 harbor"></a>实现开机自动启动 harbor</h4><h5 id="方法1-通过service文件实现"><a href="#方法1-通过service文件实现" class="headerlink" title="方法1: 通过service文件实现"></a>方法1: 通过service文件实现</h5><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">[root@harbor ~]<span class="comment"># vim /lib/systemd/system/harbor.service</span></span><br><span class="line">[Unit]</span><br><span class="line">Description=Harbor</span><br><span class="line">After=docker.service systemd-networkd.service systemd-resolved.service</span><br><span class="line">Requires=docker.service</span><br><span class="line">Documentation=http://github.com/vmware/harbor</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">Type=simple</span><br><span class="line">Restart=on-failure</span><br><span class="line">RestartSec=5</span><br><span class="line">ExecStart=/usr/bin/docker-compose -f /apps/harbor/docker-compose.yml up</span><br><span class="line">ExecStop=/usr/bin/docker-compose -f /apps/harbor/docker-compose.yml down</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line"></span><br><span class="line">[root@harbor ~]<span class="comment"># systemctl daemon-reload </span></span><br><span class="line">[root@harbor ~]<span class="comment"># systemctl enable harbor</span></span><br></pre></td></tr></table></figure>

<h5 id="方法2-通过-rc-local实现"><a href="#方法2-通过-rc-local实现" class="headerlink" title="方法2: 通过 rc.local实现"></a>方法2: 通过 rc.local实现</h5><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@harbor ~]<span class="comment"># cat /etc/rc.local </span></span><br><span class="line"><span class="comment">#!/bin/bash</span></span><br><span class="line"><span class="built_in">cd</span> /apps/harbor</span><br><span class="line">/usr/bin/docker-compose up </span><br><span class="line"></span><br><span class="line">[root@harbor ~]<span class="comment"># chmod +x /etc/rc.local</span></span><br></pre></td></tr></table></figure>

<h4 id="登录-harbor-主机网站"><a href="#登录-harbor-主机网站" class="headerlink" title="登录 harbor 主机网站"></a>登录 harbor 主机网站</h4><p>用浏览器访问: <a target="_blank" rel="noopener" href="http://10.0.0.101/">http://10.0.0.101/</a></p>
<ul>
<li>用户名: admin</li>
<li>密码: 即前面harbor.cfg中指定的密码</li>
</ul>
<p><img src="../../../../images/SRE/day46/101.jpg" alt="101"><br><img src="../../../../images/SRE/day46/102.jpg" alt="102"></p>
<h4 id="实战案例-一键安装Harbor脚本"><a href="#实战案例-一键安装Harbor脚本" class="headerlink" title="实战案例: 一键安装Harbor脚本"></a>实战案例: 一键安装Harbor脚本</h4><h5 id="安装harbor-1-7-6"><a href="#安装harbor-1-7-6" class="headerlink" title="安装harbor 1.7.6"></a>安装harbor 1.7.6</h5><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line">HARBOR_VERSION=2.7.0</span><br><span class="line"><span class="comment">#HARBOR_VERSION=2.6.1</span></span><br><span class="line"><span class="comment">#HARBOR_VERSION=2.6.0</span></span><br><span class="line">HARBOR_BASE=/apps</span><br><span class="line">HARBOR_NAME=10.0.0.202</span><br><span class="line"><span class="comment">#HARBOR_NAME=`hostname -I|awk &#x27;&#123;print $1&#125;&#x27;`</span></span><br><span class="line"></span><br><span class="line">DOCKER_VERSION=<span class="string">&quot;20.10.20&quot;</span></span><br><span class="line"><span class="comment">#DOCKER_VERSION=&quot;19.03.14&quot;</span></span><br><span class="line">DOCKER_URL=<span class="string">&quot;http://mirrors.ustc.edu.cn&quot;</span></span><br><span class="line"><span class="comment">#DOCKER_URL=&quot;https://mirrors.tuna.tsinghua.edu.cn&quot;</span></span><br><span class="line"></span><br><span class="line">DOCKER_COMPOSE_VERSION=2.6.1</span><br><span class="line"><span class="comment">#DOCKER_COMPOSE_VERSION=1.29.2</span></span><br><span class="line">DOCKER_COMPOSE_FILE=docker-compose-Linux-x86_64</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">HARBOR_ADMIN_PASSWORD=123456</span><br><span class="line"></span><br><span class="line">HARBOR_IP=`hostname -I|awk <span class="string">&#x27;&#123;print $1&#125;&#x27;</span>`</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">COLOR_SUCCESS=<span class="string">&quot;echo -e \\033[1;32m&quot;</span></span><br><span class="line">COLOR_FAILURE=<span class="string">&quot;echo -e \\033[1;31m&quot;</span></span><br><span class="line">END=<span class="string">&quot;\033[m&quot;</span></span><br><span class="line"></span><br><span class="line">. /etc/os-release</span><br><span class="line">UBUNTU_DOCKER_VERSION=<span class="string">&quot;5:<span class="variable">$&#123;DOCKER_VERSION&#125;</span>~3-0~<span class="variable">$&#123;ID&#125;</span>-<span class="variable">$&#123;UBUNTU_CODENAME&#125;</span>&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">color</span></span> () &#123;</span><br><span class="line">    RES_COL=60</span><br><span class="line">    MOVE_TO_COL=<span class="string">&quot;echo -en \\033[<span class="variable">$&#123;RES_COL&#125;</span>G&quot;</span></span><br><span class="line">    SETCOLOR_SUCCESS=<span class="string">&quot;echo -en \\033[1;32m&quot;</span></span><br><span class="line">    SETCOLOR_FAILURE=<span class="string">&quot;echo -en \\033[1;31m&quot;</span></span><br><span class="line">    SETCOLOR_WARNING=<span class="string">&quot;echo -en \\033[1;33m&quot;</span></span><br><span class="line">    SETCOLOR_NORMAL=<span class="string">&quot;echo -en \E[0m&quot;</span></span><br><span class="line">    <span class="built_in">echo</span> -n <span class="string">&quot;<span class="variable">$1</span>&quot;</span> &amp;&amp; <span class="variable">$MOVE_TO_COL</span></span><br><span class="line">    <span class="built_in">echo</span> -n <span class="string">&quot;[&quot;</span></span><br><span class="line">    <span class="keyword">if</span> [ <span class="variable">$2</span> = <span class="string">&quot;success&quot;</span> -o <span class="variable">$2</span> = <span class="string">&quot;0&quot;</span> ] ;<span class="keyword">then</span></span><br><span class="line">        <span class="variable">$&#123;SETCOLOR_SUCCESS&#125;</span></span><br><span class="line">        <span class="built_in">echo</span> -n $<span class="string">&quot;  OK  &quot;</span>    </span><br><span class="line">    <span class="keyword">elif</span> [ <span class="variable">$2</span> = <span class="string">&quot;failure&quot;</span> -o <span class="variable">$2</span> = <span class="string">&quot;1&quot;</span>  ] ;<span class="keyword">then</span> </span><br><span class="line">        <span class="variable">$&#123;SETCOLOR_FAILURE&#125;</span></span><br><span class="line">        <span class="built_in">echo</span> -n $<span class="string">&quot;FAILED&quot;</span></span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="variable">$&#123;SETCOLOR_WARNING&#125;</span></span><br><span class="line">        <span class="built_in">echo</span> -n $<span class="string">&quot;WARNING&quot;</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line">    <span class="variable">$&#123;SETCOLOR_NORMAL&#125;</span></span><br><span class="line">    <span class="built_in">echo</span> -n <span class="string">&quot;]&quot;</span></span><br><span class="line">    <span class="built_in">echo</span> </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">install_docker</span></span>()&#123;</span><br><span class="line">    <span class="keyword">if</span> [ <span class="variable">$ID</span> = <span class="string">&quot;centos&quot;</span> -o <span class="variable">$ID</span> = <span class="string">&quot;rocky&quot;</span> ];<span class="keyword">then</span></span><br><span class="line">        <span class="keyword">if</span> [ <span class="variable">$VERSION_ID</span> = <span class="string">&quot;7&quot;</span> ];<span class="keyword">then</span></span><br><span class="line">            <span class="built_in">cat</span> &gt;  /etc/yum.repos.d/docker.repo  &lt;&lt;<span class="string">EOF</span></span><br><span class="line"><span class="string">[docker]</span></span><br><span class="line"><span class="string">name=docker</span></span><br><span class="line"><span class="string">gpgcheck=0</span></span><br><span class="line"><span class="string">#baseurl=https://mirrors.aliyun.com/docker-ce/linux/centos/7/x86_64/stable/</span></span><br><span class="line"><span class="string">baseurl=$&#123;DOCKER_URL&#125;/docker-ce/linux/centos/7/x86_64/stable/</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line">        <span class="keyword">else</span>     </span><br><span class="line">            <span class="built_in">cat</span> &gt;  /etc/yum.repos.d/docker.repo  &lt;&lt;<span class="string">EOF</span></span><br><span class="line"><span class="string">[docker]</span></span><br><span class="line"><span class="string">name=docker</span></span><br><span class="line"><span class="string">gpgcheck=0</span></span><br><span class="line"><span class="string">#baseurl=https://mirrors.aliyun.com/docker-ce/linux/centos/8/x86_64/stable/</span></span><br><span class="line"><span class="string">baseurl=$&#123;DOCKER_URL&#125;/docker-ce/linux/centos/8/x86_64/stable/</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line">        <span class="keyword">fi</span></span><br><span class="line">	    yum clean all </span><br><span class="line">        <span class="variable">$&#123;COLOR_FAILURE&#125;</span> <span class="string">&quot;Docker有以下版本&quot;</span><span class="variable">$&#123;END&#125;</span></span><br><span class="line">        yum list docker-ce --showduplicates</span><br><span class="line">        <span class="variable">$&#123;COLOR_FAILURE&#125;</span><span class="string">&quot;5秒后即将安装: docker-&quot;</span><span class="variable">$&#123;DOCKER_VERSION&#125;</span><span class="string">&quot; 版本.....&quot;</span><span class="variable">$&#123;END&#125;</span></span><br><span class="line">        <span class="variable">$&#123;COLOR_FAILURE&#125;</span><span class="string">&quot;如果想安装其它Docker版本，请按ctrl+c键退出，修改版本再执行&quot;</span><span class="variable">$&#123;END&#125;</span></span><br><span class="line">        <span class="built_in">sleep</span> 5</span><br><span class="line">        yum -y install docker-ce-<span class="variable">$DOCKER_VERSION</span> docker-ce-cli-<span class="variable">$DOCKER_VERSION</span>  \</span><br><span class="line">            || &#123; color <span class="string">&quot;Base,Extras的yum源失败,请检查yum源配置&quot;</span> 1;<span class="built_in">exit</span>; &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">	    dpkg -s docker-ce &amp;&gt; /dev/null &amp;&amp; <span class="variable">$COLOR</span><span class="string">&quot;Docker已安装，退出&quot;</span> 1 &amp;&amp; <span class="built_in">exit</span></span><br><span class="line">        apt update || &#123; color <span class="string">&quot;更新包索引失败&quot;</span> 1 ; <span class="built_in">exit</span> 1; &#125;  </span><br><span class="line">        apt  -y install apt-transport-https ca-certificates curl software-properties-common || \</span><br><span class="line">            &#123; color <span class="string">&quot;安装相关包失败&quot;</span> 1 ; <span class="built_in">exit</span> 2;  &#125;  </span><br><span class="line">        curl -fsSL <span class="variable">$&#123;DOCKER_URL&#125;</span>/docker-ce/linux/ubuntu/gpg | sudo apt-key add -</span><br><span class="line">        add-apt-repository <span class="string">&quot;deb [arch=amd64] <span class="variable">$&#123;DOCKER_URL&#125;</span>/docker-ce/linux/ubuntu <span class="subst">$(lsb_release -cs)</span> stable&quot;</span></span><br><span class="line">        apt update</span><br><span class="line">        <span class="variable">$&#123;COLOR_FAILURE&#125;</span> <span class="string">&quot;Docker有以下版本&quot;</span><span class="variable">$&#123;END&#125;</span></span><br><span class="line">        apt-cache madison docker-ce</span><br><span class="line">        <span class="variable">$&#123;COLOR_FAILURE&#125;</span><span class="string">&quot;5秒后即将安装: docker-&quot;</span><span class="variable">$&#123;UBUNTU_DOCKER_VERSION&#125;</span><span class="string">&quot; 版本.....&quot;</span><span class="variable">$&#123;END&#125;</span></span><br><span class="line">        <span class="variable">$&#123;COLOR_FAILURE&#125;</span><span class="string">&quot;如果想安装其它Docker版本，请按ctrl+c键退出，修改版本再执行&quot;</span><span class="variable">$&#123;END&#125;</span></span><br><span class="line">        <span class="built_in">sleep</span> 5</span><br><span class="line">        apt -y  install docker-ce=<span class="variable">$&#123;UBUNTU_DOCKER_VERSION&#125;</span> docker-ce-cli=<span class="variable">$&#123;UBUNTU_DOCKER_VERSION&#125;</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line">    <span class="keyword">if</span> [ $? -eq 0 ];<span class="keyword">then</span></span><br><span class="line">        color <span class="string">&quot;安装软件包成功&quot;</span>  0</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        color <span class="string">&quot;安装软件包失败，请检查网络配置&quot;</span> 1</span><br><span class="line">        <span class="built_in">exit</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line">        </span><br><span class="line">    <span class="built_in">mkdir</span> -p /etc/docker</span><br><span class="line">    <span class="built_in">tee</span> /etc/docker/daemon.json &lt;&lt;-<span class="string">&#x27;EOF&#x27;</span></span><br><span class="line">&#123;</span><br><span class="line">	  <span class="string">&quot;registry-mirrors&quot;</span>: [<span class="string">&quot;https://si7y70hh.mirror.aliyuncs.com&quot;</span>],</span><br><span class="line">	  <span class="string">&quot;insecure-registries&quot;</span>: [<span class="string">&quot;harbor.wang.org&quot;</span>]</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br><span class="line">    systemctl daemon-reload</span><br><span class="line">    systemctl <span class="built_in">enable</span> docker</span><br><span class="line">    systemctl restart docker</span><br><span class="line">    docker version &amp;&amp; color <span class="string">&quot;Docker 安装成功&quot;</span> 0 ||  color <span class="string">&quot;Docker 安装失败&quot;</span> 1</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&#x27;alias rmi=&quot;docker images -qa|xargs docker rmi -f&quot;&#x27;</span> &gt;&gt; ~/.bashrc</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&#x27;alias rmc=&quot;docker ps -qa|xargs docker rm -f&quot;&#x27;</span> &gt;&gt; ~/.bashrc</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">install_docker_compose</span></span>()&#123;</span><br><span class="line">    <span class="keyword">if</span> [ <span class="variable">$ID</span> = <span class="string">&quot;centos&quot;</span> -o <span class="variable">$ID</span> = <span class="string">&quot;rocky&quot;</span> ];<span class="keyword">then</span></span><br><span class="line">        <span class="variable">$&#123;COLOR_SUCCESS&#125;</span><span class="string">&quot;开始安装 Docker compose.....&quot;</span><span class="variable">$&#123;END&#125;</span></span><br><span class="line">        <span class="built_in">sleep</span> 1</span><br><span class="line">        <span class="keyword">if</span> [ ! -e  <span class="variable">$&#123;DOCKER_COMPOSE_FILE&#125;</span> ];<span class="keyword">then</span></span><br><span class="line">            <span class="comment">#curl -L https://github.com/docker/compose/releases/download/$&#123;DOCKER_COMPOSE_VERSION&#125;/$&#123;DOCKER_COMPOSE_FILE&#125; -o /usr/bin/docker-compose</span></span><br><span class="line">            curl -L https://get.daocloud.io/docker/compose/releases/download/v<span class="variable">$&#123;DOCKER_COMPOSE_VERSION&#125;</span>/docker-compose-$(<span class="built_in">uname</span> -s)-$(<span class="built_in">uname</span> -m) -o /usr/bin/docker-compose</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            <span class="built_in">mv</span> <span class="variable">$&#123;DOCKER_COMPOSE_FILE&#125;</span> /usr/bin/docker-compose</span><br><span class="line">        <span class="keyword">fi</span></span><br><span class="line">        <span class="built_in">chmod</span> +x /usr/bin/docker-compose</span><br><span class="line">    <span class="keyword">else</span> </span><br><span class="line">        apt -y install docker-compose</span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line">    <span class="keyword">if</span> docker-compose --version ;<span class="keyword">then</span></span><br><span class="line">        <span class="variable">$&#123;COLOR_SUCCESS&#125;</span><span class="string">&quot;Docker Compose 安装完成&quot;</span><span class="variable">$&#123;END&#125;</span> </span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="variable">$&#123;COLOR_FAILURE&#125;</span><span class="string">&quot;Docker compose 安装失败&quot;</span><span class="variable">$&#123;END&#125;</span></span><br><span class="line">        <span class="built_in">exit</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">install_harbor</span></span>()&#123;</span><br><span class="line">    <span class="variable">$&#123;COLOR_SUCCESS&#125;</span><span class="string">&quot;开始安装 Harbor.....&quot;</span><span class="variable">$&#123;END&#125;</span></span><br><span class="line">    <span class="built_in">sleep</span> 1</span><br><span class="line">    <span class="keyword">if</span>  [ ! -e  harbor-offline-installer-v<span class="variable">$&#123;HARBOR_VERSION&#125;</span>.tgz ] ;<span class="keyword">then</span></span><br><span class="line">        wget https://github.com/goharbor/harbor/releases/download/v<span class="variable">$&#123;HARBOR_VERSION&#125;</span>/harbor-offline-installer-v<span class="variable">$&#123;HARBOR_VERSION&#125;</span>.tgz || <span class="variable">$&#123;COLOR_FAILURE&#125;</span> <span class="string">&quot;下载失败!&quot;</span> <span class="variable">$&#123;END&#125;</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line">    [ -d <span class="variable">$&#123;HARBOR_BASE&#125;</span> ] ||  <span class="built_in">mkdir</span> <span class="variable">$&#123;HARBOR_BASE&#125;</span></span><br><span class="line">    tar xvf harbor-offline-installer-v<span class="variable">$&#123;HARBOR_VERSION&#125;</span>.tgz  -C <span class="variable">$&#123;HARBOR_BASE&#125;</span></span><br><span class="line">    <span class="built_in">cd</span> <span class="variable">$&#123;HARBOR_BASE&#125;</span>/harbor</span><br><span class="line">    <span class="built_in">cp</span> harbor.yml.tmpl harbor.yml</span><br><span class="line">    sed -ri <span class="string">&quot;/^hostname/s/reg.mydomain.com/<span class="variable">$&#123;HARBOR_NAME&#125;</span>/&quot;</span> harbor.yml</span><br><span class="line">    sed -ri <span class="string">&quot;/^https/s/(https:)/#\1/&quot;</span> harbor.yml</span><br><span class="line">    sed -ri <span class="string">&quot;s/(port: 443)/#\1/&quot;</span> harbor.yml</span><br><span class="line">    sed -ri <span class="string">&quot;/certificate:/s/(.*)/#\1/&quot;</span> harbor.yml</span><br><span class="line">    sed -ri <span class="string">&quot;/private_key:/s/(.*)/#\1/&quot;</span> harbor.yml</span><br><span class="line">    sed -ri <span class="string">&quot;s/Harbor12345/<span class="variable">$&#123;HARBOR_ADMIN_PASSWORD&#125;</span>/&quot;</span> harbor.yml</span><br><span class="line">    sed -i <span class="string">&#x27;s#^data_volume: /data#data_volume: /data/harbor#&#x27;</span> harbor.yml</span><br><span class="line">    <span class="comment">#mkdir -p /data/harbor</span></span><br><span class="line">    <span class="variable">$&#123;HARBOR_BASE&#125;</span>/harbor/install.sh &amp;&amp; <span class="variable">$&#123;COLOR_SUCCESS&#125;</span><span class="string">&quot;Harbor 安装完成&quot;</span><span class="variable">$&#123;END&#125;</span> ||  <span class="variable">$&#123;COLOR_FAILURE&#125;</span><span class="string">&quot;Harbor 安装失败&quot;</span><span class="variable">$&#123;END&#125;</span></span><br><span class="line">    <span class="built_in">cat</span> &gt; /lib/systemd/system/harbor.service &lt;&lt;<span class="string">EOF</span></span><br><span class="line"><span class="string">[Unit]</span></span><br><span class="line"><span class="string">Description=Harbor</span></span><br><span class="line"><span class="string">After=docker.service systemd-networkd.service systemd-resolved.service</span></span><br><span class="line"><span class="string">Requires=docker.service</span></span><br><span class="line"><span class="string">Documentation=http://github.com/vmware/harbor</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">[Service]</span></span><br><span class="line"><span class="string">Type=simple</span></span><br><span class="line"><span class="string">Restart=on-failure</span></span><br><span class="line"><span class="string">RestartSec=5</span></span><br><span class="line"><span class="string">ExecStart=/usr/bin/docker-compose -f  $&#123;HARBOR_BASE&#125;/harbor/docker-compose.yml up</span></span><br><span class="line"><span class="string">ExecStop=/usr/bin/docker-compose -f $&#123;HARBOR_BASE&#125;/harbor/docker-compose.yml down</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">[Install]</span></span><br><span class="line"><span class="string">WantedBy=multi-user.target</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"></span><br><span class="line">    systemctl daemon-reload </span><br><span class="line">    systemctl <span class="built_in">enable</span>  harbor &amp;&gt;/dev/null ||  <span class="variable">$&#123;COLOR&#125;</span><span class="string">&quot;Harbor已配置为开机自动启动&quot;</span><span class="variable">$&#123;END&#125;</span></span><br><span class="line">    <span class="keyword">if</span> [ $?  -eq 0 ];<span class="keyword">then</span>  </span><br><span class="line">        <span class="built_in">echo</span> </span><br><span class="line">        color <span class="string">&quot;Harbor安装完成!&quot;</span> 0</span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;-------------------------------------------------------------------&quot;</span></span><br><span class="line">        <span class="built_in">echo</span> -e <span class="string">&quot;请访问链接: \E[32;1mhttp://<span class="variable">$&#123;HARBOR_IP&#125;</span>/\E[0m&quot;</span> </span><br><span class="line">		<span class="built_in">echo</span> -e <span class="string">&quot;用户和密码: \E[32;1madmin/<span class="variable">$&#123;HARBOR_ADMIN_PASSWORD&#125;</span>\E[0m&quot;</span> </span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        color <span class="string">&quot;Harbor安装失败!&quot;</span> 1</span><br><span class="line">        <span class="built_in">exit</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$HARBOR_IP</span>     <span class="variable">$HARBOR_NAME</span>&quot;</span>   &gt;&gt; /etc/hosts</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">docker info  &amp;&gt; /dev/null  &amp;&amp; <span class="variable">$&#123;COLOR_FAILURE&#125;</span><span class="string">&quot;Docker已安装&quot;</span><span class="variable">$&#123;END&#125;</span> || install_docker</span><br><span class="line"></span><br><span class="line">docker-compose --version &amp;&gt; /dev/null &amp;&amp; <span class="variable">$&#123;COLOR_FAILURE&#125;</span><span class="string">&quot;Docker Compose已安装&quot;</span><span class="variable">$&#123;END&#125;</span> || install_docker_compose</span><br><span class="line"></span><br><span class="line">install_harbor</span><br></pre></td></tr></table></figure>

<h3 id="使用单主机-Harbor"><a href="#使用单主机-Harbor" class="headerlink" title="使用单主机 Harbor"></a>使用单主机 Harbor</h3><h4 id="建立项目"><a href="#建立项目" class="headerlink" title="建立项目"></a>建立项目</h4><p><strong>harbor上必须先建立项目，才能上传镜像</strong></p>
<p><img src="../../../../images/SRE/day46/103.jpg" alt="103"><br><img src="../../../../images/SRE/day46/104.jpg" alt="104"><br><img src="../../../../images/SRE/day46/105.jpg" alt="105"></p>
<h4 id="命令行登录-harbor"><a href="#命令行登录-harbor" class="headerlink" title="命令行登录 harbor"></a>命令行登录 harbor</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#方法1</span></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment"># vim /lib/systemd/system/docker.service</span></span><br><span class="line">ExecStart=/usr/bin/dockerd -H fd:// --containerd=/run/containerd/containerd.sock --insecure-registry 10.0.0.101 --insecure-registry 10.0.0.102</span><br><span class="line"></span><br><span class="line"><span class="comment">#方法2</span></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment"># vim /etc/docker/daemon.json </span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;registry-mirrors&quot;</span>: [<span class="string">&quot;https://si7y70hh.mirror.aliyuncs.com&quot;</span>],</span><br><span class="line">  <span class="string">&quot;insecure-registries&quot;</span>: [<span class="string">&quot;10.0.0.101:80&quot;</span>，<span class="string">&quot;10.0.0.102:80&quot;</span>]  <span class="comment">#说明: &quot;:80&quot;可省略</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment"># systemctl daemon-reload</span></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment"># systemctl restart docker</span></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment"># docker login 10.0.0.101</span></span><br></pre></td></tr></table></figure>

<h4 id="给本地镜像打标签并上传到-Harbor"><a href="#给本地镜像打标签并上传到-Harbor" class="headerlink" title="给本地镜像打标签并上传到 Harbor"></a>给本地镜像打标签并上传到 Harbor</h4><p>修改 images 的名称，不修改成指定格式无法将镜像上传到 harbor仓库</p>
<p>格式为: </p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Harbor主机IP/项目名/image名:版本</span><br></pre></td></tr></table></figure>

<p>范例: </p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#上传镜像前，必须先登录harbor</span></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment"># docker login 10.0.0.101</span></span><br><span class="line"></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment"># docker tag alpine-base:3.11 10.0.0.101/example/alpine-base:3.11</span></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment"># docker push 10.0.0.101/example/alpine-base:3.11</span></span><br></pre></td></tr></table></figure>

<p>访问harbor网站验证上传镜像成功</p>
<p><img src="../../../../images/SRE/day46/106.jpg" alt="106"></p>
<p>范例: 如果不事先建立项目，上传镜像失败</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">[root@ubuntu1804 ~]<span class="comment"># docker tag centos7-base:v1 10.0.0.101/example2/centos7-base:v1</span></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment"># docker push 10.0.0.101/example2/centos7-base:v1</span></span><br><span class="line">The push refers to repository [10.0.0.101/example2/centos7-base]</span><br><span class="line">2073413aebd6: Preparing </span><br><span class="line">6ec9af97c369: Preparing </span><br><span class="line">034f282942cd: Preparing </span><br><span class="line">denied: requested access to the resource is denied</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment"># docker tag centos7-base:v1 10.0.0.101/example/centos7-base:v1</span></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment"># docker push 10.0.0.101/example/centos7-base:v1</span></span><br><span class="line">The push refers to repository [10.0.0.101/example/centos7-base]</span><br><span class="line">2073413aebd6: Pushed </span><br><span class="line">6ec9af97c369: Pushed </span><br><span class="line">034f282942cd: Pushed </span><br><span class="line">v1: digest: </span><br><span class="line">sha256:02cd943f2569c7c55f08a979fd9661f1fd7893c424bca7b343188654ba63d98d size: 949</span><br></pre></td></tr></table></figure>

<p><img src="../../../../images/SRE/day46/107.jpg" alt="107"></p>
<p><strong>可以看到操作的日志记录</strong></p>
<p><img src="../../../../images/SRE/day46/108.jpg" alt="108"></p>
<h4 id="下载-Harbor-的镜像"><a href="#下载-Harbor-的镜像" class="headerlink" title="下载 Harbor 的镜像"></a>下载 Harbor 的镜像</h4><p>在10.0.0.103的CentOS 7 的主机上无需登录，即可下载镜像</p>
<p>下载前必须修改docker的service 文件，加入harbor服务器的地址才可以下载</p>
<p><strong>范例: 修改docker的service文件</strong></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[root@centos7 ~]<span class="comment"># docker pull 10.0.0.101/example/centos7-base:v1</span></span><br><span class="line">Error response from daemon: Get https://10.0.0.101/v2/: dial tcp 10.0.0.101:443: connect: connection refused</span><br><span class="line"></span><br><span class="line"><span class="comment">#方法1</span></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment"># vim /lib/systemd/system/docker.service </span></span><br><span class="line">ExecStart=/usr/bin/dockerd -H fd:// --containerd=/run/containerd/containerd.sock --insecure-registry 10.0.0.101 --insecure-registry 10.0.0.102</span><br><span class="line"></span><br><span class="line"><span class="comment">#方法2</span></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment"># vim/etc/docker/daemon.json</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="string">&quot;insecure-registries&quot;</span>: [<span class="string">&quot;10.0.0.101&quot;</span>, <span class="string">&quot;10.0.0.102&quot;</span>]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">[root@centos7 ~]<span class="comment"># systemctl daemon-reload </span></span><br><span class="line">[root@centos7 ~]<span class="comment"># systemctl restart docker</span></span><br></pre></td></tr></table></figure>

<p><strong>范例: 从harbor下载镜像</strong></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@centos7 ~]<span class="comment"># docker pull 10.0.0.101/example/centos7-base:v1</span></span><br></pre></td></tr></table></figure>

<h4 id="创建自动打标签上传镜像脚本"><a href="#创建自动打标签上传镜像脚本" class="headerlink" title="创建自动打标签上传镜像脚本"></a>创建自动打标签上传镜像脚本</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#在10.0.0.100上修改以前的build.sh脚本</span></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment"># cd /data/dockerfile/web/nginx/1.16.1-alpine/</span></span><br><span class="line">[root@ubuntu1804 1.16.1-alpine]<span class="comment"># vim build.sh</span></span><br><span class="line">[root@ubuntu1804 1.16.1-alpine]<span class="comment"># cat build.sh </span></span><br><span class="line"><span class="comment">#!/bin/bash</span></span><br><span class="line">TAG=<span class="variable">$1</span></span><br><span class="line">docker build -t 10.0.0.101/example/nginx-alpine:1.16.1-<span class="variable">$&#123;TAG&#125;</span> .</span><br><span class="line">docker push 10.0.0.101/example/nginx-alpine:1.16.1-<span class="variable">$&#123;TAG&#125;</span></span><br><span class="line">docker rmi -f 10.0.0.101/example/nginx-alpine:1.16.1-<span class="variable">$&#123;TAG&#125;</span></span><br><span class="line"></span><br><span class="line">[root@ubuntu1804 1.16.1-alpine]<span class="comment"># bash build.sh v1</span></span><br></pre></td></tr></table></figure>

<p>登录harbor网站验证脚本上传镜像成功</p>
<p><img src="../../../../images/SRE/day46/109.jpg" alt="109"></p>
<h4 id="修改-Harbor-配置"><a href="#修改-Harbor-配置" class="headerlink" title="修改 Harbor 配置"></a>修改 Harbor 配置</h4><p>后期如果修改harbor配置，比如: 修改IP地址等，可执行以下步骤生效</p>
<p>方法1: </p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">[root@ubuntu1804 ~]<span class="comment"># cd /apps/harbor/</span></span><br><span class="line">[root@ubuntu1804 harbor]<span class="comment"># docker-compose stop</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#所有相关容器都退出</span></span><br><span class="line">[root@ubuntu1804 harbor]<span class="comment"># docker ps -a</span></span><br><span class="line">......</span><br><span class="line"></span><br><span class="line"><span class="comment">#修改harbor配置</span></span><br><span class="line">[root@ubuntu1804 harbor]<span class="comment"># vim harbor.cfg</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#更新配置</span></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment"># /apps/harbor/prepare</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#重新启动docker compose</span></span><br><span class="line">[root@ubuntu1804 harbor]<span class="comment"># docker-compose start</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#相关容器自动启动</span></span><br><span class="line">[root@ubuntu1804 harbor]<span class="comment"># docker ps </span></span><br><span class="line">......</span><br></pre></td></tr></table></figure>

<p>方法2:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@ubuntu1804 ~]<span class="comment"># /apps/harbor/install.sh</span></span><br></pre></td></tr></table></figure>

<p><img src="../../../../images/SRE/day46/110.jpg" alt="110"></p>
<p>Harbor支持基于策略的Docker镜像复制功能，这类似于MySQL的主从同步，其可以实现不同的数据中心、不同的运行环境之间同步镜像，并提供友好的管理界面，大大简化了实际运维中的镜像管理工作，已经有用很多互联网公司使用harbor搭建内网docker仓库的案例，并且还有实现了双向复制功能</p>
<h4 id="安装第二台-harbor主机"><a href="#安装第二台-harbor主机" class="headerlink" title="安装第二台 harbor主机"></a>安装第二台 harbor主机</h4><p>参考6.4.2的过程，在第二台主机上安装部署好harbor，并登录系统</p>
<p><strong>注意: harbor.cfg中配置 hostname = 10.0.0.102</strong></p>
<p><img src="../../../../images/SRE/day46/111.jpg" alt="111"></p>
<h4 id="第二台harbor上新建项目"><a href="#第二台harbor上新建项目" class="headerlink" title="第二台harbor上新建项目"></a>第二台harbor上新建项目</h4><p>参考第一台harbor服务器的项目名称，在第二台harbor服务器上新建与之同名的项目</p>
<p><img src="../../../../images/SRE/day46/112.jpg" alt="112"></p>
<h4 id="第二台harbor上仓库管理中新建目标"><a href="#第二台harbor上仓库管理中新建目标" class="headerlink" title="第二台harbor上仓库管理中新建目标"></a>第二台harbor上仓库管理中新建目标</h4><p>参考第一台主机信息,新建复制（同步）目标信息,将第一台主机设为复制的目标</p>
<p><img src="../../../../images/SRE/day46/113.jpg" alt="113"></p>
<p><strong>输入第一台harbor服务器上的主机10.0.0.101,目标名(即项目名)example和用户信息及密码admin</strong></p>
<p><img src="../../../../images/SRE/day46/114.jpg" alt="114"><br><img src="../../../../images/SRE/day46/115.jpg" alt="115"></p>
<h4 id="第二台harbor上新建复制规则实现到第一台harbor的单向复制"><a href="#第二台harbor上新建复制规则实现到第一台harbor的单向复制" class="headerlink" title="第二台harbor上新建复制规则实现到第一台harbor的单向复制"></a>第二台harbor上新建复制规则实现到第一台harbor的单向复制</h4><p>在第二台harbor上建立复制的目标主机,将第二台harbor上面的镜像复制到第一台harbor上</p>
<p><img src="../../../../images/SRE/day46/116.jpg" alt="116"><br><img src="../../../../images/SRE/day46/117.jpg" alt="117"></p>
<h4 id="在第一台harbor主机上重复上面操作"><a href="#在第一台harbor主机上重复上面操作" class="headerlink" title="在第一台harbor主机上重复上面操作"></a>在第一台harbor主机上重复上面操作</h4><p>以上操作，只是实现了从第二台harbor主机10.0.0.102到第一台harbor主机10.0.101的单向同步</p>
<p>在第一台harbor上再执行下面操作，才实现双向同步</p>
<p><img src="../../../../images/SRE/day46/118.jpg" alt="118"><br><img src="../../../../images/SRE/day46/119.jpg" alt="119"></p>
<h4 id="确认同步成功"><a href="#确认同步成功" class="headerlink" title="确认同步成功"></a>确认同步成功</h4><p>在第二台harbor主机上可以查看到从第一台主机同步过来的镜像</p>
<p><img src="../../../../images/SRE/day46/120.jpg" alt="120"></p>
<p>也可以查看到同步日志</p>
<p><img src="../../../../images/SRE/day46/121.jpg" alt="121"></p>
<h4 id="上传镜像观察是否可以双高同步"><a href="#上传镜像观察是否可以双高同步" class="headerlink" title="上传镜像观察是否可以双高同步"></a>上传镜像观察是否可以双高同步</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@ubuntu1804 ~]<span class="comment"># docker tag tomcat-web:app1 10.0.0.101/example/tomcat-web:app1</span></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment"># docker push 10.0.0.101/example/tomcat-web:app1</span></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment"># docker tag tomcat-web:app2 10.0.0.102/example/tomcat-web:app2</span></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment"># docker push 10.0.0.102/example/tomcat-web:app2</span></span><br></pre></td></tr></table></figure>

<p><img src="../../../../images/SRE/day46/122.jpg" alt="122"><br><img src="../../../../images/SRE/day46/123.jpg" alt="123"></p>
<h4 id="删除镜像观察是否可自动同步"><a href="#删除镜像观察是否可自动同步" class="headerlink" title="删除镜像观察是否可自动同步"></a>删除镜像观察是否可自动同步</h4><p><img src="../../../../images/SRE/day46/124.jpg" alt="124"><br><img src="../../../../images/SRE/day46/125.jpg" alt="125"><br><img src="../../../../images/SRE/day46/126.jpg" alt="126"><br><img src="../../../../images/SRE/day46/127.jpg" alt="127"></p>
<h4 id="配置-Nginx-做为反向代理"><a href="#配置-Nginx-做为反向代理" class="headerlink" title="配置 Nginx 做为反向代理"></a>配置 Nginx 做为反向代理</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#配置Nginx反向代理</span></span><br><span class="line">[root@ubuntu2004 ~]<span class="comment"># cat /etc/nginx/conf.d/harbor.wang.org.conf</span></span><br><span class="line">upstream harbor &#123;</span><br><span class="line">   ip_hash;</span><br><span class="line">   server harbor1.wang.org:80;</span><br><span class="line">   server harbor2.wang.org:80;</span><br><span class="line">&#125;</span><br><span class="line">server &#123;</span><br><span class="line">   listen 80;</span><br><span class="line">   server_name harbor.wang.org;</span><br><span class="line">   client_max_body_size 10g;</span><br><span class="line">   location / &#123;</span><br><span class="line">       proxy_pass http://harbor;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">#客户端docker配置</span></span><br><span class="line">[root@rocky8 ~]<span class="comment"># cat /etc/docker/daemon.json</span></span><br><span class="line">&#123;</span><br><span class="line">   <span class="string">&quot;registry-mirrors&quot;</span>: [<span class="string">&quot;https://si7y70hh.mirror.aliyuncs.com&quot;</span>],</span><br><span class="line">   <span class="string">&quot;insecure-registries&quot;</span>: [<span class="string">&quot;harbor.wang.org&quot;</span>]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@rocky8 ~]<span class="comment"># systemctl restart docker</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#客户端docker配置名称解析</span></span><br><span class="line">[root@rocky8 ~]<span class="comment"># vim /etc/hosts</span></span><br><span class="line">10.0.0.100 harbor.wang.org</span><br><span class="line"></span><br><span class="line"><span class="comment">#如果harbor配置中的hostname: 指定harbor1.wang.org和harbor2.wang.org名称，还需要加下面解析</span></span><br><span class="line">10.0.0.101 harbor1.wang.org</span><br><span class="line">10.0.0.102 harbor2.wang.org</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="Harbor-安全-Https-配置"><a href="#Harbor-安全-Https-配置" class="headerlink" title="Harbor 安全 Https 配置"></a>Harbor 安全 Https 配置</h3><p>基于安全考虑,生产建议采用 https 代替 http</p>
<h4 id="新版实现实现-Harbor-的-Https-认证"><a href="#新版实现实现-Harbor-的-Https-认证" class="headerlink" title="新版实现实现 Harbor 的 Https 认证"></a>新版实现实现 Harbor 的 Https 认证</h4><p>新版2.5.0的Https实现方法出现了一些变化</p>
<p>官方文档:</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://goharbor.io/docs/2.5.0/install-config/configure-https/</span><br></pre></td></tr></table></figure>

<h5 id="生成-Harbor-服务器证书"><a href="#生成-Harbor-服务器证书" class="headerlink" title="生成 Harbor 服务器证书"></a>生成 Harbor 服务器证书</h5><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#生成ca的私钥</span></span><br><span class="line">openssl genrsa -out ca.key 4096</span><br><span class="line"></span><br><span class="line"><span class="comment">#生成ca的自签名证书</span></span><br><span class="line">openssl req -x509 -new -nodes -sha512 -days 3650 \</span><br><span class="line">-subj <span class="string">&quot;/C=CN/ST=Beijing/L=Beijing/O=example/OU=Personal/CN=wang.org&quot;</span> \</span><br><span class="line">-key ca.key \</span><br><span class="line">-out ca.crt</span><br><span class="line"></span><br><span class="line"><span class="comment">#生成harbor主机的私钥</span></span><br><span class="line">openssl genrsa -out harbor.wang.org.key 4096</span><br><span class="line"></span><br><span class="line"><span class="comment">#生成harbor主机的证书申请</span></span><br><span class="line">openssl req -sha512 -new \</span><br><span class="line">    -subj <span class="string">&quot;/C=CN/ST=Beijing/L=Beijing/O=example/OU=Personal/CN=harbor.wang.org&quot;</span> \</span><br><span class="line">    -key harbor.wang.org.key \</span><br><span class="line">    -out harbor.wang.org.csr</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line"><span class="comment">#创建x509 v3 扩展文件(新版新增加的要求) </span></span><br><span class="line"><span class="built_in">cat</span> &gt; v3.ext &lt;&lt;-<span class="string">EOF</span></span><br><span class="line"><span class="string">authorityKeyIdentifier=keyid,issuer</span></span><br><span class="line"><span class="string">basicConstraints=CA:FALSE</span></span><br><span class="line"><span class="string">keyUsage = digitalSignature, nonRepudiation, keyEncipherment, dataEncipherment</span></span><br><span class="line"><span class="string">extendedKeyUsage = serverAuth</span></span><br><span class="line"><span class="string">subjectAltName = @alt_names</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">[alt_names]</span></span><br><span class="line"><span class="string">DNS.1=wang.org</span></span><br><span class="line"><span class="string">DNS.2=wang</span></span><br><span class="line"><span class="string">DNS.3=harbor.wang.org</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#给 harbor主机颁发证书</span></span><br><span class="line">openssl x509 -req -sha512 -days 3650 \</span><br><span class="line">    -extfile v3.ext \</span><br><span class="line">    -CA ca.crt -CAkey ca.key -CAcreateserial \</span><br><span class="line">    -<span class="keyword">in</span> harbor.wang.org.csr \</span><br><span class="line">    -out harbor.wang.org.crt</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#最终文件列表如下</span></span><br><span class="line">ca.crt ca.key ca.srl harbor.wang.org.crt harbor.wang.org.csr </span><br><span class="line">harbor.wang.org.key v3.ext</span><br></pre></td></tr></table></figure>

<p>注意: 如果不生成创建x509 v3 扩展文件,会出现下面提示错误</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">docker login harbor.wang.org</span><br><span class="line">Username: admin</span><br><span class="line">Password: </span><br><span class="line">Error response from daemon: Get <span class="string">&quot;https://harbor.wang.org/v2/&quot;</span>: x509: certificate </span><br><span class="line">relies on legacy Common Name field, use SANs or temporarily <span class="built_in">enable</span> Common Name </span><br><span class="line">matching with GODEBUG=x509ignoreCN=0</span><br></pre></td></tr></table></figure>

<h5 id="配置-Harbor-服务器使用证书"><a href="#配置-Harbor-服务器使用证书" class="headerlink" title="配置 Harbor 服务器使用证书"></a>配置 Harbor 服务器使用证书</h5><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">mkdir</span> /data/harbor/certs/</span><br><span class="line"><span class="built_in">cp</span> harbor.wang.org.crt harbor.wang.org.key /data/harbor/certs/</span><br><span class="line"></span><br><span class="line">vim /apps/harbor/harbor.yml</span><br><span class="line">......</span><br><span class="line"><span class="comment"># https related config</span></span><br><span class="line">https:</span><br><span class="line">  <span class="comment"># https port for harbor, default is 443</span></span><br><span class="line">  port: 443</span><br><span class="line">  <span class="comment"># The path of cert and key files for nginx</span></span><br><span class="line">  certificate: /data/harbor/certs/harbor.wang.org.crt</span><br><span class="line">  private_key: /data/harbor/certs/harbor.wang.org.key</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#使上面的配置生效</span></span><br><span class="line"><span class="built_in">cd</span> /apps/harbor/</span><br><span class="line">./prepare</span><br><span class="line">docker-compose down -v</span><br><span class="line">docker-compose up -d</span><br></pre></td></tr></table></figure>

<p>输入下面 http 链接自动跳转到 https</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://harbor.wang.org</span><br></pre></td></tr></table></figure>

<p><img src="../../../../images/SRE/day46/128.jpg" alt="128"><br><img src="../../../../images/SRE/day46/129.jpg" alt="129"><br><img src="../../../../images/SRE/day46/130.jpg" alt="130"></p>
<h5 id="配置-Docker-客户端使用证书文件"><a href="#配置-Docker-客户端使用证书文件" class="headerlink" title="配置 Docker 客户端使用证书文件"></a>配置 Docker 客户端使用证书文件</h5><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#转换harbor的crt证书文件为cert后缀,docker识别crt文件为CA证书,cert为客户端证书服务器</span></span><br><span class="line">openssl x509 -inform PEM -<span class="keyword">in</span> harbor.wang.org.crt -out harbor.wang.org.cert</span><br><span class="line"></span><br><span class="line"><span class="comment">#或者</span></span><br><span class="line"><span class="built_in">cp</span> -a harbor.wang.org.crt harbor.wang.org.cert</span><br><span class="line"><span class="comment">#比较两个文件的不同</span></span><br><span class="line"><span class="built_in">md5sum</span> harbor.wang.org.crt harbor.wang.org.cert</span><br><span class="line"></span><br><span class="line"><span class="comment">#在docker客户端使用上面的证书文件</span></span><br><span class="line"><span class="built_in">mkdir</span> -pv /etc/docker/certs.d/harbor.wang.org/</span><br><span class="line"><span class="built_in">cp</span> harbor.wang.org.cert harbor.wang.org.key ca.crt /etc/docker/certs.d/harbor.wang.org/</span><br><span class="line"></span><br><span class="line"><span class="comment">#上面证书配置无需重启服务即生效</span></span><br><span class="line"><span class="comment">#在docker客户端登录harbor服务器,注意:此时无需再配置insecure-registries项即可登录</span></span><br><span class="line">docker login harbor.wang.org</span><br><span class="line"></span><br><span class="line">Username: admin</span><br><span class="line">Password: </span><br><span class="line">WARNING! Your password will be stored unencrypted <span class="keyword">in</span> /root/.docker/config.json.</span><br><span class="line">Configure a credential helper to remove this warning. See</span><br><span class="line">https://docs.docker.com/engine/reference/commandline/login/<span class="comment">#credentials-store</span></span><br><span class="line"></span><br><span class="line">Login Succeeded</span><br></pre></td></tr></table></figure>

<h5 id="Docker-客户端测试推送和拉取镜像"><a href="#Docker-客户端测试推送和拉取镜像" class="headerlink" title="Docker 客户端测试推送和拉取镜像"></a>Docker 客户端测试推送和拉取镜像</h5><p>登录harbor 查看推送命令</p>
<p><img src="../../../../images/SRE/day46/131.jpg" alt="131"></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">docker push wangxiaochun/busybox:1.30.0</span><br><span class="line">docker tag wangxiaochun/busybox:1.30.0 harbor.wang.org/library/busybox:1.30.0</span><br><span class="line">docker push harbor.wang.org/library/busybox:1.30.0</span><br></pre></td></tr></table></figure>

<p>验证推送是否成功</p>
<p><img src="../../../../images/SRE/day46/132.jpg" alt="132"></p>
<p>验证拉取</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker pull harbor.wang.org/library/busybox:1.30.0</span><br></pre></td></tr></table></figure>

<h4 id="旧版实现-Harbor-的-Https-认证"><a href="#旧版实现-Harbor-的-Https-认证" class="headerlink" title="旧版实现 Harbor 的 Https 认证"></a>旧版实现 Harbor 的 Https 认证</h4><p>旧版harbor默认使用http,为了安全，可以使用https </p>
<h5 id="实现Harbor-的-https-认证"><a href="#实现Harbor-的-https-认证" class="headerlink" title="实现Harbor 的 https 认证"></a>实现Harbor 的 https 认证</h5><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#安装docker</span></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment"># bash install_docker_for_ubuntu1804.sh</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#安装docker compose</span></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment"># curl -L https://github.com/docker/compose/releases/download/1.25.3/docker-compose-`uname -s`-`uname -m` -o /usr/local/bin/docker-compose</span></span><br><span class="line"></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment"># chmod +x /usr/local/bin/docker-compose</span></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment"># docker-compose --version</span></span><br><span class="line">docker-compose version 1.25.3, build d4d1b42b</span><br><span class="line"></span><br><span class="line"><span class="comment">#下载harbor离线安装包且解压缩</span></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment"># wget https://storage.googleapis.com/harbor-releases/release-1.7.0/harbor-offline-installer-v1.7.6.tgz</span></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment"># mkdir /apps</span></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment"># tar xvf harbor-offline-installer-v1.7.6.tgz -C /apps/</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#生成私钥和证书</span></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment"># touch /root/.rnd</span></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment"># mkdir /apps/harbor/certs/</span></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment"># cd /apps/harbor/certs/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#生成CA证书</span></span><br><span class="line">[root@ubuntu1804 certs]<span class="comment"># openssl req -newkey rsa:4096 -nodes -sha256 -keyout ca.key -x509 -subj &quot;/CN=ca.wang.org&quot; -days 365 -out ca.crt</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#生成harbor主机的证书申请</span></span><br><span class="line">[root@ubuntu1804 certs]<span class="comment"># openssl req -newkey rsa:4096 -nodes -sha256 -subj &quot;/CN=harbor.wang.org&quot; -keyout harbor.wang.org.key -out harbor.wang.org.csr</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#给harbor主机颁发证书</span></span><br><span class="line">[root@ubuntu1804 certs]<span class="comment"># openssl x509 -req -in harbor.wang.org.csr -CA ca.crt -CAkey ca.key -CAcreateserial -out harbor.wang.org.crt</span></span><br><span class="line"></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment"># tree /apps/harbor/certs</span></span><br><span class="line">/apps/harbor/certs</span><br><span class="line">├── ca.crt</span><br><span class="line">├── ca.key</span><br><span class="line">├── ca.srl</span><br><span class="line">├── harbor.wang.org.crt</span><br><span class="line">├── harbor.wang.org.csr</span><br><span class="line">└── harbor.wang.org.key</span><br><span class="line">0 directories, 6 files</span><br><span class="line"></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment"># vim /apps/harbor/harbor.cfg </span></span><br><span class="line">hostname = harbor.wang.org</span><br><span class="line">ui_url_protocol = https</span><br><span class="line">ssl_cert = /apps/harbor/certs/harbor.wang.org.crt</span><br><span class="line">ssl_cert_key = /apps/harbor/certs/harbor.wang.org.key</span><br><span class="line">harbor_admin_password = 123456 </span><br><span class="line"></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment"># apt -y install python</span></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment"># /apps/harbor/install.sh</span></span><br></pre></td></tr></table></figure>

<h5 id="用https方式访问harbor网站"><a href="#用https方式访问harbor网站" class="headerlink" title="用https方式访问harbor网站"></a>用https方式访问harbor网站</h5><p>修改/etc/hosts文件</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">10.0.0.103 harbor.wang.org</span><br></pre></td></tr></table></figure>

<p>打开浏览器，访问<a target="_blank" rel="noopener" href="http://harbor.wang.org/">http://harbor.wang.org</a> ,可以看到以下界面</p>
<p><img src="../../../../images/SRE/day46/133.jpg" alt="133"><br><img src="../../../../images/SRE/day46/134.jpg" alt="134"><br><img src="../../../../images/SRE/day46/135.jpg" alt="135"><br><img src="../../../../images/SRE/day46/136.jpg" alt="136"><br><img src="../../../../images/SRE/day46/137.jpg" alt="137"></p>
<h5 id="在harbor网站新建项目"><a href="#在harbor网站新建项目" class="headerlink" title="在harbor网站新建项目"></a>在harbor网站新建项目</h5><p><img src="../../../../images/SRE/day46/138.jpg" alt="138"></p>
<h5 id="在客户端下载CA的证书"><a href="#在客户端下载CA的证书" class="headerlink" title="在客户端下载CA的证书"></a>在客户端下载CA的证书</h5><p><strong>直接登录和上传下载镜像会报错</strong></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@ubuntu1804 ~]<span class="comment"># vim /etc/hosts</span></span><br><span class="line">10.0.0.103 harbor.wang.org</span><br><span class="line"></span><br><span class="line"><span class="comment">#没有证书验证，直接登录失败</span></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment"># docker login harbor.wang.org</span></span><br><span class="line">Username: admin</span><br><span class="line">Password: </span><br><span class="line">Error response from daemon: Get https://harbor.wang.org/v2/: x509: certificate </span><br><span class="line">signed by unknown authority</span><br></pre></td></tr></table></figure>

<p><strong>在客户端下载ca的证书</strong></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@ubuntu1804 ~]<span class="comment"># mkdir -pv /etc/docker/certs.d/harbor.wang.org/</span></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment"># scp -r harbor.wang.org:/apps/harbor/certs/ca.crt /etc/docker/certs.d/harbor.wang.org/</span></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment"># tree /etc/docker/certs.d/</span></span><br><span class="line">/etc/docker/certs.d/</span><br><span class="line">└── harbor.wang.org</span><br><span class="line">   └── ca.crt</span><br><span class="line">   </span><br><span class="line">1 directory, 1 file</span><br><span class="line"><span class="comment">#上面证书配置无需重启服务即生效</span></span><br></pre></td></tr></table></figure>

<h5 id="从客户端上传镜像"><a href="#从客户端上传镜像" class="headerlink" title="从客户端上传镜像"></a>从客户端上传镜像</h5><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#先登录系统</span></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment"># docker login harbor.wang.org</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#上传镜像</span></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment"># docker tag alpine:3.11 harbor.wang.org/example/alpine:3.11</span></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment"># docker push harbor.wang.org/example/alpine:3.11</span></span><br></pre></td></tr></table></figure>

<p><strong>在harbor网站上验证上传的镜像</strong></p>
<p><img src="../../../../images/SRE/day46/139.jpg" alt="139"></p>
<h5 id="在客户端下载镜像"><a href="#在客户端下载镜像" class="headerlink" title="在客户端下载镜像"></a>在客户端下载镜像</h5><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">[root@centos7 ~]<span class="comment"># vim /etc/hosts</span></span><br><span class="line">10.0.0.103 harbor.wang.org</span><br><span class="line"></span><br><span class="line">[root@centos7 ~]<span class="comment"># docker pull harbor.wang.org/example/alpine:3.11</span></span><br><span class="line">Error response from daemon: Get https://harbor.wang.org/v2/: x509: certificate </span><br><span class="line">signed by unknown authority</span><br><span class="line"></span><br><span class="line">[root@centos7 ~]<span class="comment"># mkdir -pv /etc/docker/certs.d/harbor.wang.org/</span></span><br><span class="line">[root@centos7 ~]<span class="comment"># scp -r harbor.wang.org:/apps/harbor/certs/ca.crt /etc/docker/certs.d/harbor.wang.org/</span></span><br><span class="line">[root@centos7 ~]<span class="comment"># tree /etc/docker/certs.d/</span></span><br><span class="line">/etc/docker/certs.d/</span><br><span class="line">└── harbor.wang.org</span><br><span class="line">   └── ca.crt</span><br><span class="line">   </span><br><span class="line">1 directory, 1 file</span><br><span class="line"></span><br><span class="line">[root@centos7 ~]<span class="comment"># docker pull harbor.wang.org/example/alpine:3.11</span></span><br></pre></td></tr></table></figure>

<h1 id="Docker-的资源限制"><a href="#Docker-的资源限制" class="headerlink" title="Docker 的资源限制"></a>Docker 的资源限制</h1><h2 id="Docker-资源限制"><a href="#Docker-资源限制" class="headerlink" title="Docker 资源限制"></a>Docker 资源限制</h2><h3 id="容器资源限制介绍"><a href="#容器资源限制介绍" class="headerlink" title="容器资源限制介绍"></a>容器资源限制介绍</h3><p>官方文档: <a target="_blank" rel="noopener" href="https://docs.docker.com/config/containers/resource_constraints/">https://docs.docker.com/config/containers/resource_constraints/</a></p>
<p>默认情况下，容器没有资源的使用限制，可以使用主机内核调度程序允许的尽可能多的资源</p>
<p>Docker 提供了控制容器使用资源的方法,可以限制容器使用多少内存或 CPU等， 在docker run 命令的运行时配置标志实现资源限制功能。 </p>
<p>其中许多功能都要求宿主机的内核支持，要检查是否支持这些功能，可以使用docker info 命令 ，如果内核中的某项特性可能会在输出结尾处看到警告， 如下所示: </p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">WARNING</span><span class="punctuation">: </span>No swap limit support #没有启用 swap 限制功能会出现此提示警报</span><br></pre></td></tr></table></figure>

<p>可通过修改内核参数消除以上警告</p>
<p>官方文档: <a target="_blank" rel="noopener" href="https://docs.docker.com/install/linux/linux-postinstall/#your-kernel-does-not-support-cgroup-swap-limit-capabilities">https://docs.docker.com/install/linux/linux-postinstall/#your-kernel-does-not-support-cgroup-swap-limit-capabilities</a></p>
<p>范例: 修改内核参数消除以上警告</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root@ubuntu1804 ~]<span class="comment"># docker info </span></span><br><span class="line">......</span><br><span class="line">WARNING: No swap <span class="built_in">limit</span> support</span><br><span class="line"></span><br><span class="line"><span class="comment">#修改内核参数</span></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment"># vim /etc/default/grub</span></span><br><span class="line">GRUB_CMDLINE_LINUX=<span class="string">&quot;cgroup_enable=memory net.ifnames=0 swapaccount=1&quot;</span></span><br><span class="line"></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment"># update-grub</span></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment"># reboot</span></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment"># docker info</span></span><br></pre></td></tr></table></figure>

<h3 id="OOM-（Out-of-Memory-Exception）"><a href="#OOM-（Out-of-Memory-Exception）" class="headerlink" title="OOM （Out of Memory Exception）"></a>OOM （Out of Memory Exception）</h3><p>对于 Linux 主机，如果没有足够的内存来执行其他重要的系统任务，将会抛出OOM (Out of Memory Exception,内存溢出、内存泄漏、内存异常 )，随后系统会开始杀死进程以释放内存， 凡是运行在宿主机的进程都有可能被 kill ，包括 Dockerd和其它的应用程序， 如果重要的系统进程被 Kill，会导致和该进程相关的服务全部宕机。通常越消耗内存比较大的应用越容易被kill，比如: MySQL数据库，Java程序等</p>
<p>范例: OOM发生后的日志信息</p>
<p><img src="../../../../images/SRE/day46/140.jpg" alt="140"></p>
<p>产生 OOM 异常时， Dockerd尝试通过调整 Docker 守护程序上的 OOM 优先级来减轻这些风险，以便它比系统上的其他进程更不可能被杀死但是每个容器的 OOM 优先级并未调整， 这使得单个容器被杀死的可能性比 Docker守护程序或其他系统进程被杀死的可能性更大，不推荐通过在守护程序或容器上手动设置– oom -score-adj为极端负数，或通过在容器上设置 – oom-kill-disable来绕过这些安全措施</p>
<p><strong>OOM 优先级机制:</strong> </p>
<p>linux会为每个进程计算一个分数，最终将分数最高的kill </p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">/proc/PID/oom_score_adj </span><br><span class="line"><span class="comment">#范围为 -1000 到 1000，值越高容易被宿主机 kill掉，如果将该值设置为 -1000 ，则进程永远不会被宿主机 kernel kill</span></span><br><span class="line"></span><br><span class="line">/proc/PID/oom_adj </span><br><span class="line"><span class="comment">#范围为 -17 到+15 ，取值越高越容易被干掉，如果是 -17 ， 则表示不能被 kill ，该设置参数的存在是为了和旧版本的 Linux 内核兼容。</span></span><br><span class="line"></span><br><span class="line">/proc/PID/oom_score </span><br><span class="line"><span class="comment">#这个值是系统综合进程的内存消耗量、 CPU 时间 (utime + 存活时间 (uptime - start time) 和oom_adj 计算出的进程得分 ，消耗内存越多得分越高，容易被宿主机 kernel 强制杀死</span></span><br></pre></td></tr></table></figure>

<p>范例: 查看OOM相关值</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#按内存排序</span></span><br><span class="line">top - 18:50:03 up  8:49,  3 <span class="built_in">users</span>,  load average: 0.00, 0.00, 0.00</span><br><span class="line">Tasks: 200 total,   2 running, 198 sleeping,   0 stopped,   0 zombie</span><br><span class="line">%Cpu(s):  0.0 us,  0.1 sy,  0.0 ni, 99.8 <span class="built_in">id</span>,  0.0 wa,  0.1 hi,  0.1 si,  0.0 </span><br><span class="line">MiB Mem :   5557.6 total,   3371.1 free,    899.1 used,   1287.5 buff/cache</span><br><span class="line">MiB Swap:      0.0 total,      0.0 free,      0.0 used.   4370.2 avail Mem </span><br><span class="line"></span><br><span class="line">    PID USER      PR  NI    VIRT    RES    SHR S  %CPU  %MEM     TIME+ </span><br><span class="line">    891 root      20   0  618376  29368  15168 S   0.3   0.5   1:28.19 </span><br><span class="line">   1547 systemd+  20   0 2157152 410584  32848 S   0.3   7.2   1:11.16 </span><br><span class="line">   1755 root      20   0 1236464  13816   8412 S   0.3   0.2   0:06.77 </span><br><span class="line">  39814 root      20   0  269208   4684   3848 R   0.3   0.1   0:00.02 </span><br><span class="line">      1 root      20   0  238236  10724   8056 S   0.0   0.2   0:02.77 </span><br><span class="line">      2 root      20   0       0      0      0 S   0.0   0.0   0:00.03 </span><br><span class="line">      3 root       0 -20       0      0      0 I   0.0   0.0   0:00.00 </span><br><span class="line">      4 root       0 -20       0      0      0 I   0.0   0.0   0:00.00 </span><br><span class="line">      5 root       0 -20       0      0      0 I   0.0   0.0   0:00.00 </span><br><span class="line">      7 root       0 -20       0      0      0 I   0.0   0.0   0:00.00 </span><br><span class="line">     10 root       0 -20       0      0      0 I   0.0   0.0   0:00.00 </span><br><span class="line">     11 root      20   0       0      0      0 S   0.0   0.0   0:00.00 </span><br><span class="line">     12 root      20   0       0      0      0 S   0.0   0.0   0:00.00 </span><br><span class="line">     13 root      20   0       0      0      0 S   0.0   0.0   0:00.06 </span><br><span class="line">     14 root      20   0       0      0      0 I   0.0   0.0   0:03.88 </span><br><span class="line">     15 root      rt   0       0      0      0 S   0.0   0.0   0:00.02 </span><br><span class="line">     16 root      rt   0       0      0      0 S   0.0   0.0   0:00.00 </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@rocky8 ~]<span class="comment"># cat /proc/1547/oom_adj </span></span><br><span class="line">0</span><br><span class="line"></span><br><span class="line">[root@rocky8 ~]<span class="comment"># cat /proc/1547/oom_score</span></span><br><span class="line">714</span><br><span class="line"></span><br><span class="line">[root@rocky8 ~]<span class="comment"># cat /proc/1547/oom_score_adj </span></span><br><span class="line">0</span><br><span class="line"></span><br><span class="line">[root@rocky8 ~]<span class="comment"># cat /proc/891/oom_adj </span></span><br><span class="line">0</span><br><span class="line"></span><br><span class="line">[root@rocky8 ~]<span class="comment"># cat /proc/891/oom_score</span></span><br><span class="line">670</span><br><span class="line"></span><br><span class="line">[root@rocky8 ~]<span class="comment"># cat /proc/891/oom_score_adj </span></span><br><span class="line">0</span><br><span class="line"></span><br><span class="line"><span class="comment">#docker服务进程的OOM默认值</span></span><br><span class="line">[root@rocky8 ~]<span class="comment"># cat /proc/`pidof dockerd`/oom_adj</span></span><br><span class="line">-8</span><br><span class="line"></span><br><span class="line">[root@rocky8 ~]<span class="comment"># cat /proc/`pidof dockerd`/oom_score</span></span><br><span class="line">348</span><br><span class="line"></span><br><span class="line">[root@rocky8 ~]<span class="comment"># cat /proc/`pidof dockerd`/oom_score_adj</span></span><br><span class="line">-500</span><br></pre></td></tr></table></figure>

<h2 id="Stress-ng-压力测试工具"><a href="#Stress-ng-压力测试工具" class="headerlink" title="Stress-ng 压力测试工具"></a>Stress-ng 压力测试工具</h2><h3 id="Stress-ng-工具介绍"><a href="#Stress-ng-工具介绍" class="headerlink" title="Stress-ng 工具介绍"></a>Stress-ng 工具介绍</h3><p><img src="../../../../images/SRE/day46/141.jpg" alt="141"></p>
<p>stress-ng是一个压力测试工具，可以通过软件仓库进行安装，也提供了docker版本的容器</p>
<p>官方链接：<a target="_blank" rel="noopener" href="https://kernel.ubuntu.com/~cking/stress-ng/">https://kernel.ubuntu.com/~cking/stress-ng/</a></p>
<p>官方文档：<a target="_blank" rel="noopener" href="https://wiki.ubuntu.com/Kernel/Reference/stress-ng">https://wiki.ubuntu.com/Kernel/Reference/stress-ng</a></p>
<p><img src="../../../../images/SRE/day46/142.jpg" alt="142"></p>
<h3 id="stress-ng-安装"><a href="#stress-ng-安装" class="headerlink" title="stress-ng 安装"></a>stress-ng 安装</h3><p>范例: 软件包方式安装</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@centos7 ~]<span class="comment"># yum -y install stress-ng</span></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment"># apt -y install stress-ng</span></span><br></pre></td></tr></table></figure>

<p>范例: 容器方式安装</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@ubuntu1804 ~]<span class="comment"># docker pull lorel/docker-stress-ng</span></span><br></pre></td></tr></table></figure>

<h3 id="Stress-ng-使用"><a href="#Stress-ng-使用" class="headerlink" title="Stress-ng 使用"></a>Stress-ng 使用</h3><p>范例: 查看帮助</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br><span class="line">551</span><br><span class="line">552</span><br><span class="line">553</span><br><span class="line">554</span><br><span class="line">555</span><br><span class="line">556</span><br><span class="line">557</span><br><span class="line">558</span><br><span class="line">559</span><br><span class="line">560</span><br><span class="line">561</span><br><span class="line">562</span><br><span class="line">563</span><br><span class="line">564</span><br><span class="line">565</span><br><span class="line">566</span><br><span class="line">567</span><br><span class="line">568</span><br><span class="line">569</span><br><span class="line">570</span><br><span class="line">571</span><br><span class="line">572</span><br><span class="line">573</span><br><span class="line">574</span><br><span class="line">575</span><br><span class="line">576</span><br><span class="line">577</span><br><span class="line">578</span><br><span class="line">579</span><br><span class="line">580</span><br><span class="line">581</span><br><span class="line">582</span><br><span class="line">583</span><br><span class="line">584</span><br><span class="line">585</span><br><span class="line">586</span><br><span class="line">587</span><br><span class="line">588</span><br><span class="line">589</span><br><span class="line">590</span><br><span class="line">591</span><br><span class="line">592</span><br><span class="line">593</span><br><span class="line">594</span><br><span class="line">595</span><br><span class="line">596</span><br><span class="line">597</span><br><span class="line">598</span><br><span class="line">599</span><br><span class="line">600</span><br><span class="line">601</span><br><span class="line">602</span><br><span class="line">603</span><br><span class="line">604</span><br><span class="line">605</span><br><span class="line">606</span><br><span class="line">607</span><br><span class="line">608</span><br><span class="line">609</span><br><span class="line">610</span><br><span class="line">611</span><br><span class="line">612</span><br><span class="line">613</span><br><span class="line">614</span><br><span class="line">615</span><br><span class="line">616</span><br><span class="line">617</span><br><span class="line">618</span><br><span class="line">619</span><br><span class="line">620</span><br><span class="line">621</span><br><span class="line">622</span><br><span class="line">623</span><br><span class="line">624</span><br><span class="line">625</span><br><span class="line">626</span><br><span class="line">627</span><br><span class="line">628</span><br><span class="line">629</span><br><span class="line">630</span><br><span class="line">631</span><br><span class="line">632</span><br><span class="line">633</span><br><span class="line">634</span><br><span class="line">635</span><br><span class="line">636</span><br><span class="line">637</span><br><span class="line">638</span><br><span class="line">639</span><br><span class="line">640</span><br><span class="line">641</span><br><span class="line">642</span><br><span class="line">643</span><br><span class="line">644</span><br><span class="line">645</span><br><span class="line">646</span><br><span class="line">647</span><br><span class="line">648</span><br><span class="line">649</span><br><span class="line">650</span><br><span class="line">651</span><br><span class="line">652</span><br><span class="line">653</span><br><span class="line">654</span><br><span class="line">655</span><br><span class="line">656</span><br><span class="line">657</span><br><span class="line">658</span><br><span class="line">659</span><br><span class="line">660</span><br><span class="line">661</span><br><span class="line">662</span><br><span class="line">663</span><br><span class="line">664</span><br><span class="line">665</span><br><span class="line">666</span><br><span class="line">667</span><br><span class="line">668</span><br><span class="line">669</span><br><span class="line">670</span><br><span class="line">671</span><br><span class="line">672</span><br><span class="line">673</span><br><span class="line">674</span><br><span class="line">675</span><br><span class="line">676</span><br><span class="line">677</span><br><span class="line">678</span><br><span class="line">679</span><br><span class="line">680</span><br><span class="line">681</span><br><span class="line">682</span><br><span class="line">683</span><br><span class="line">684</span><br><span class="line">685</span><br><span class="line">686</span><br><span class="line">687</span><br><span class="line">688</span><br><span class="line">689</span><br><span class="line">690</span><br><span class="line">691</span><br><span class="line">692</span><br><span class="line">693</span><br><span class="line">694</span><br><span class="line">695</span><br><span class="line">696</span><br><span class="line">697</span><br><span class="line">698</span><br><span class="line">699</span><br><span class="line">700</span><br><span class="line">701</span><br><span class="line">702</span><br><span class="line">703</span><br><span class="line">704</span><br><span class="line">705</span><br><span class="line">706</span><br><span class="line">707</span><br><span class="line">708</span><br><span class="line">709</span><br><span class="line">710</span><br><span class="line">711</span><br><span class="line">712</span><br><span class="line">713</span><br><span class="line">714</span><br><span class="line">715</span><br><span class="line">716</span><br><span class="line">717</span><br><span class="line">718</span><br><span class="line">719</span><br><span class="line">720</span><br><span class="line">721</span><br><span class="line">722</span><br><span class="line">723</span><br><span class="line">724</span><br><span class="line">725</span><br><span class="line">726</span><br><span class="line">727</span><br><span class="line">728</span><br><span class="line">729</span><br><span class="line">730</span><br><span class="line">731</span><br><span class="line">732</span><br><span class="line">733</span><br><span class="line">734</span><br><span class="line">735</span><br><span class="line">736</span><br><span class="line">737</span><br><span class="line">738</span><br><span class="line">739</span><br><span class="line">740</span><br><span class="line">741</span><br><span class="line">742</span><br><span class="line">743</span><br><span class="line">744</span><br><span class="line">745</span><br><span class="line">746</span><br><span class="line">747</span><br><span class="line">748</span><br><span class="line">749</span><br><span class="line">750</span><br><span class="line">751</span><br><span class="line">752</span><br><span class="line">753</span><br><span class="line">754</span><br><span class="line">755</span><br><span class="line">756</span><br><span class="line">757</span><br><span class="line">758</span><br><span class="line">759</span><br><span class="line">760</span><br><span class="line">761</span><br><span class="line">762</span><br><span class="line">763</span><br><span class="line">764</span><br><span class="line">765</span><br><span class="line">766</span><br><span class="line">767</span><br><span class="line">768</span><br><span class="line">769</span><br><span class="line">770</span><br><span class="line">771</span><br><span class="line">772</span><br><span class="line">773</span><br><span class="line">774</span><br><span class="line">775</span><br><span class="line">776</span><br><span class="line">777</span><br><span class="line">778</span><br><span class="line">779</span><br><span class="line">780</span><br><span class="line">781</span><br><span class="line">782</span><br><span class="line">783</span><br><span class="line">784</span><br><span class="line">785</span><br><span class="line">786</span><br><span class="line">787</span><br><span class="line">788</span><br><span class="line">789</span><br><span class="line">790</span><br><span class="line">791</span><br><span class="line">792</span><br><span class="line">793</span><br><span class="line">794</span><br><span class="line">795</span><br><span class="line">796</span><br><span class="line">797</span><br><span class="line">798</span><br><span class="line">799</span><br><span class="line">800</span><br><span class="line">801</span><br><span class="line">802</span><br><span class="line">803</span><br><span class="line">804</span><br><span class="line">805</span><br><span class="line">806</span><br><span class="line">807</span><br><span class="line">808</span><br><span class="line">809</span><br><span class="line">810</span><br><span class="line">811</span><br><span class="line">812</span><br><span class="line">813</span><br><span class="line">814</span><br><span class="line">815</span><br><span class="line">816</span><br><span class="line">817</span><br><span class="line">818</span><br><span class="line">819</span><br><span class="line">820</span><br><span class="line">821</span><br><span class="line">822</span><br><span class="line">823</span><br><span class="line">824</span><br><span class="line">825</span><br><span class="line">826</span><br><span class="line">827</span><br><span class="line">828</span><br><span class="line">829</span><br><span class="line">830</span><br><span class="line">831</span><br><span class="line">832</span><br><span class="line">833</span><br><span class="line">834</span><br><span class="line">835</span><br><span class="line">836</span><br><span class="line">837</span><br><span class="line">838</span><br><span class="line">839</span><br><span class="line">840</span><br><span class="line">841</span><br><span class="line">842</span><br><span class="line">843</span><br><span class="line">844</span><br><span class="line">845</span><br><span class="line">846</span><br><span class="line">847</span><br><span class="line">848</span><br><span class="line">849</span><br><span class="line">850</span><br><span class="line">851</span><br><span class="line">852</span><br><span class="line">853</span><br><span class="line">854</span><br><span class="line">855</span><br><span class="line">856</span><br><span class="line">857</span><br><span class="line">858</span><br><span class="line">859</span><br><span class="line">860</span><br><span class="line">861</span><br><span class="line">862</span><br><span class="line">863</span><br><span class="line">864</span><br><span class="line">865</span><br><span class="line">866</span><br><span class="line">867</span><br><span class="line">868</span><br><span class="line">869</span><br><span class="line">870</span><br><span class="line">871</span><br><span class="line">872</span><br><span class="line">873</span><br><span class="line">874</span><br><span class="line">875</span><br><span class="line">876</span><br><span class="line">877</span><br><span class="line">878</span><br><span class="line">879</span><br><span class="line">880</span><br><span class="line">881</span><br><span class="line">882</span><br><span class="line">883</span><br><span class="line">884</span><br><span class="line">885</span><br><span class="line">886</span><br><span class="line">887</span><br><span class="line">888</span><br><span class="line">889</span><br><span class="line">890</span><br><span class="line">891</span><br><span class="line">892</span><br><span class="line">893</span><br><span class="line">894</span><br><span class="line">895</span><br><span class="line">896</span><br><span class="line">897</span><br><span class="line">898</span><br><span class="line">899</span><br><span class="line">900</span><br><span class="line">901</span><br><span class="line">902</span><br><span class="line">903</span><br><span class="line">904</span><br><span class="line">905</span><br><span class="line">906</span><br><span class="line">907</span><br><span class="line">908</span><br><span class="line">909</span><br><span class="line">910</span><br><span class="line">911</span><br><span class="line">912</span><br><span class="line">913</span><br><span class="line">914</span><br><span class="line">915</span><br><span class="line">916</span><br><span class="line">917</span><br><span class="line">918</span><br><span class="line">919</span><br><span class="line">920</span><br><span class="line">921</span><br><span class="line">922</span><br><span class="line">923</span><br><span class="line">924</span><br><span class="line">925</span><br><span class="line">926</span><br><span class="line">927</span><br><span class="line">928</span><br><span class="line">929</span><br><span class="line">930</span><br><span class="line">931</span><br><span class="line">932</span><br><span class="line">933</span><br><span class="line">934</span><br><span class="line">935</span><br><span class="line">936</span><br><span class="line">937</span><br><span class="line">938</span><br><span class="line">939</span><br><span class="line">940</span><br><span class="line">941</span><br><span class="line">942</span><br><span class="line">943</span><br><span class="line">944</span><br><span class="line">945</span><br><span class="line">946</span><br><span class="line">947</span><br><span class="line">948</span><br><span class="line">949</span><br><span class="line">950</span><br><span class="line">951</span><br><span class="line">952</span><br><span class="line">953</span><br><span class="line">954</span><br><span class="line">955</span><br><span class="line">956</span><br><span class="line">957</span><br><span class="line">958</span><br><span class="line">959</span><br><span class="line">960</span><br><span class="line">961</span><br><span class="line">962</span><br><span class="line">963</span><br><span class="line">964</span><br><span class="line">965</span><br><span class="line">966</span><br><span class="line">967</span><br><span class="line">968</span><br><span class="line">969</span><br><span class="line">970</span><br><span class="line">971</span><br><span class="line">972</span><br><span class="line">973</span><br><span class="line">974</span><br><span class="line">975</span><br><span class="line">976</span><br><span class="line">977</span><br><span class="line">978</span><br><span class="line">979</span><br><span class="line">980</span><br><span class="line">981</span><br><span class="line">982</span><br><span class="line">983</span><br><span class="line">984</span><br><span class="line">985</span><br><span class="line">986</span><br><span class="line">987</span><br><span class="line">988</span><br><span class="line">989</span><br><span class="line">990</span><br><span class="line">991</span><br><span class="line">992</span><br><span class="line">993</span><br><span class="line">994</span><br><span class="line">995</span><br><span class="line">996</span><br><span class="line">997</span><br><span class="line">998</span><br><span class="line">999</span><br><span class="line">1000</span><br><span class="line">1001</span><br><span class="line">1002</span><br><span class="line">1003</span><br><span class="line">1004</span><br><span class="line">1005</span><br><span class="line">1006</span><br><span class="line">1007</span><br><span class="line">1008</span><br><span class="line">1009</span><br><span class="line">1010</span><br><span class="line">1011</span><br><span class="line">1012</span><br></pre></td><td class="code"><pre><span class="line">[root@rocky8 ~]<span class="comment"># stress-ng --help</span></span><br><span class="line">stress-ng, version 0.15.00 (gcc 8.5, x86_64 Linux 4.18.0-553.el8_10.x86_64) 💻🔥</span><br><span class="line"></span><br><span class="line">Usage: stress-ng [OPTION [ARG]]</span><br><span class="line"></span><br><span class="line">General control options:</span><br><span class="line">      --abort               abort all stressors <span class="keyword">if</span> any stressor fails</span><br><span class="line">      --aggressive          <span class="built_in">enable</span> all aggressive options</span><br><span class="line">-a N, --all N               start N workers of each stress <span class="built_in">test</span></span><br><span class="line">-b N, --backoff N           <span class="built_in">wait</span> of N microseconds before work starts</span><br><span class="line">      --class name          specify a class of stressors, use with</span><br><span class="line">                            --sequential</span><br><span class="line">-n,   --dry-run             <span class="keyword">do</span> not run</span><br><span class="line">      --ftrace              <span class="built_in">enable</span> kernel <span class="keyword">function</span> call tracing</span><br><span class="line">-h,   --<span class="built_in">help</span>                show <span class="built_in">help</span></span><br><span class="line">      --ignite-cpu          alter kernel controls to make CPU run hot</span><br><span class="line">      --ionice-class C      specify ionice class (idle, besteffort, realtime)</span><br><span class="line">      --ionice-level L      specify ionice level (0 max, 7 min)</span><br><span class="line">-j,   --job jobfile         run the named jobfile</span><br><span class="line">-k,   --keep-name           keep stress worker names to be <span class="string">&#x27;stress-ng&#x27;</span></span><br><span class="line">      --keep-files          <span class="keyword">do</span> not remove files or directories</span><br><span class="line">      --klog-check          check kernel message <span class="built_in">log</span> <span class="keyword">for</span> errors</span><br><span class="line">      --log-brief           less verbose <span class="built_in">log</span> messages</span><br><span class="line">      --log-file filename   <span class="built_in">log</span> messages to a <span class="built_in">log</span> file</span><br><span class="line">      --maximize            <span class="built_in">enable</span> maximum stress options</span><br><span class="line">      --max-fd              <span class="built_in">set</span> maximum file descriptor <span class="built_in">limit</span></span><br><span class="line">      --mbind               <span class="built_in">set</span> NUMA memory binding to specific nodes</span><br><span class="line">-M,   --metrics             <span class="built_in">print</span> pseudo metrics of activity</span><br><span class="line">      --metrics-brief       <span class="built_in">enable</span> metrics and only show non-zero results</span><br><span class="line">      --minimize            <span class="built_in">enable</span> minimal stress options</span><br><span class="line">      --no-madvise          don<span class="string">&#x27;t use random madvise options for each mmap</span></span><br><span class="line"><span class="string">      --no-rand-seed        seed random numbers with the same constant</span></span><br><span class="line"><span class="string">      --oomable             Do not respawn a stressor if it gets OOM&#x27;</span>d</span><br><span class="line">      --oom-avoid           Try to avoid stressors from being OOM<span class="string">&#x27;</span></span><br><span class="line"><span class="string">      --page-in             touch allocated pages that are not in core</span></span><br><span class="line"><span class="string">      --parallel N          synonym for &#x27;</span>all N<span class="string">&#x27;</span></span><br><span class="line"><span class="string">      --pathological        enable stressors that are known to hang a machine</span></span><br><span class="line"><span class="string">      --perf                display perf statistics</span></span><br><span class="line"><span class="string">-q,   --quiet               quiet output</span></span><br><span class="line"><span class="string">-r,   --random N            start N random workers</span></span><br><span class="line"><span class="string">      --sched type          set scheduler type</span></span><br><span class="line"><span class="string">      --sched-prio N        set scheduler priority level N</span></span><br><span class="line"><span class="string">      --sched-period N      set period for SCHED_DEADLINE to N nanosecs</span></span><br><span class="line"><span class="string">                            (Linux only)</span></span><br><span class="line"><span class="string">      --sched-runtime N     set runtime for SCHED_DEADLINE to N nanosecs</span></span><br><span class="line"><span class="string">                            (Linux only)</span></span><br><span class="line"><span class="string">      --sched-deadline N    set deadline for SCHED_DEADLINE to N nanosecs</span></span><br><span class="line"><span class="string">                            (Linux only)</span></span><br><span class="line"><span class="string">      --sched-reclaim       set reclaim cpu bandwidth for deadline scheduler</span></span><br><span class="line"><span class="string">                            (Linux only)</span></span><br><span class="line"><span class="string">      --seed N              set the random number generator seed with a 64</span></span><br><span class="line"><span class="string">                            bit value</span></span><br><span class="line"><span class="string">      --sequential N        run all stressors one by one, invoking N of them</span></span><br><span class="line"><span class="string">      --skip-silent         silently skip unimplemented stressors</span></span><br><span class="line"><span class="string">      --stressors           show available stress tests</span></span><br><span class="line"><span class="string">      --smart               show changes in S.M.A.R.T. data</span></span><br><span class="line"><span class="string">      --syslog              log messages to the syslog</span></span><br><span class="line"><span class="string">      --taskset             use specific CPUs (set CPU affinity)</span></span><br><span class="line"><span class="string">      --temp-path path      specify path for temporary directories and files</span></span><br><span class="line"><span class="string">      --thrash              force all pages in causing swap thrashing</span></span><br><span class="line"><span class="string">-t N, --timeout T           timeout after T seconds</span></span><br><span class="line"><span class="string">      --timer-slack         enable timer slack mode</span></span><br><span class="line"><span class="string">      --times               show run time summary at end of the run</span></span><br><span class="line"><span class="string">      --timestamp           timestamp log output </span></span><br><span class="line"><span class="string">      --tz                  collect temperatures from thermal zones (Linux</span></span><br><span class="line"><span class="string">                            only)</span></span><br><span class="line"><span class="string">-v,   --verbose             verbose output</span></span><br><span class="line"><span class="string">      --verify              verify results (not available on all tests)</span></span><br><span class="line"><span class="string">      --verifiable          show stressors that enable verification via</span></span><br><span class="line"><span class="string">                            --verify</span></span><br><span class="line"><span class="string">-V,   --version             show version</span></span><br><span class="line"><span class="string">-Y,   --yaml file           output results to YAML formatted file</span></span><br><span class="line"><span class="string">-x,   --exclude             list of stressors to exclude (not run)</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Stressor specific options:</span></span><br><span class="line"><span class="string">      --access N            start N workers that stress file access</span></span><br><span class="line"><span class="string">                            permissions</span></span><br><span class="line"><span class="string">      --access-ops N        stop after N file access bogo operations</span></span><br><span class="line"><span class="string">      --af-alg N            start N workers that stress AF_ALG socket domain</span></span><br><span class="line"><span class="string">      --af-alg-dump         dump internal list from /proc/crypto to stdout</span></span><br><span class="line"><span class="string">      --af-alg-ops N        stop after N af-alg bogo operations</span></span><br><span class="line"><span class="string">      --affinity N          start N workers that rapidly change CPU affinity</span></span><br><span class="line"><span class="string">      --affinity-delay D    delay in nanoseconds between affinity changes</span></span><br><span class="line"><span class="string">      --affinity-ops N      stop after N affinity bogo operations</span></span><br><span class="line"><span class="string">      --affinity-pin        keep per stressor threads pinned to same CPU</span></span><br><span class="line"><span class="string">      --affinity-rand       change affinity randomly rather than sequentially</span></span><br><span class="line"><span class="string">      --affinity-sleep      sleep in nanoseconds between affinity changes</span></span><br><span class="line"><span class="string">      --aio N               start N workers that issue async I/O requests</span></span><br><span class="line"><span class="string">      --aio-ops N           stop after N bogo async I/O requests</span></span><br><span class="line"><span class="string">      --aio-requests N      number of async I/O requests per worker</span></span><br><span class="line"><span class="string">      --aiol N              start N workers that exercise Linux async I/O</span></span><br><span class="line"><span class="string">      --aiol-ops N          stop after N bogo Linux aio async I/O requests</span></span><br><span class="line"><span class="string">      --aiol-requests N     number of Linux aio async I/O requests per worker</span></span><br><span class="line"><span class="string">      --apparmor            start N workers exercising AppArmor interfaces</span></span><br><span class="line"><span class="string">      --apparmor-ops N      stop after N bogo AppArmor worker bogo operations</span></span><br><span class="line"><span class="string">      --alarm N             start N workers exercising alarm timers</span></span><br><span class="line"><span class="string">      --alarm-ops N         stop after N alarm bogo operations</span></span><br><span class="line"><span class="string">      --atomic              start N workers exercising GCC atomic operations</span></span><br><span class="line"><span class="string">      --atomic-ops          stop after N bogo atomic bogo operations</span></span><br><span class="line"><span class="string">      --bad-altstack N      start N workers exercising bad signal stacks</span></span><br><span class="line"><span class="string">      --bad-altstack-ops N  stop after N bogo signal stack SIGSEGVs</span></span><br><span class="line"><span class="string">      --bad-ioctl N         start N stressors that perform illegal read</span></span><br><span class="line"><span class="string">                            ioctls on devices</span></span><br><span class="line"><span class="string">      --bad-ioctl-ops  N    stop after N bad ioctl bogo operations</span></span><br><span class="line"><span class="string">-B N, --bigheap N           start N workers that grow the heap using</span></span><br><span class="line"><span class="string">                            realloc()</span></span><br><span class="line"><span class="string">      --bigheap-growth N    grow heap by N bytes per iteration</span></span><br><span class="line"><span class="string">      --bigheap-ops N       stop after N bogo bigheap operations</span></span><br><span class="line"><span class="string">      --bind-mount N        start N workers exercising bind mounts</span></span><br><span class="line"><span class="string">      --bind-mount-ops N    stop after N bogo bind mount operations</span></span><br><span class="line"><span class="string">      --binderfs N          start N workers exercising binderfs</span></span><br><span class="line"><span class="string">      --binderfs-ops N      stop after N bogo binderfs operations</span></span><br><span class="line"><span class="string">      --branch N            start N workers that force branch misprediction</span></span><br><span class="line"><span class="string">      --branch-ops N        stop after N branch misprediction branches</span></span><br><span class="line"><span class="string">      --brk N               start N workers performing rapid brk calls</span></span><br><span class="line"><span class="string">      --brk-mlock           attempt to mlock newly mapped brk pages</span></span><br><span class="line"><span class="string">      --brk-notouch         don&#x27;</span>t <span class="built_in">touch</span> (page <span class="keyword">in</span>) new data segment page</span><br><span class="line">      --brk-ops N           stop after N brk bogo operations</span><br><span class="line">      --bsearch N           start N workers that exercise a binary search</span><br><span class="line">      --bsearch-ops N       stop after N binary search bogo operations</span><br><span class="line">      --bsearch-size N      number of 32 bit integers to bsearch</span><br><span class="line">-C N, --cache N             start N CPU cache thrashing workers</span><br><span class="line">      --cache-cldemote      cache line demote (x86 only)</span><br><span class="line">      --cache-clflushopt    optimized cache line flush (x86 only)</span><br><span class="line">      --cache-enable-all    <span class="built_in">enable</span> all cache options</span><br><span class="line">                            (fence,flush,sfence,etc..)</span><br><span class="line">      --cache-fence         serialize stores</span><br><span class="line">      --cache-flush         flush cache after every memory write (x86 only)</span><br><span class="line">      --cache-level N       only exercise specified cache</span><br><span class="line">      --cache-no-affinity   <span class="keyword">do</span> not change CPU affinity</span><br><span class="line">      --cache-ops N         stop after N cache bogo operations</span><br><span class="line">      --cache-prefetch      prefetch on memory reads/writes</span><br><span class="line">      --cache-sfence        serialize stores with sfence</span><br><span class="line">      --cache-ways N        only fill specified number of cache ways</span><br><span class="line">      --cache-wb            cache line writeback (x86 only)</span><br><span class="line">      --cacheline N         start N workers that exercise cachelines</span><br><span class="line">      --cacheline-affinity  modify CPU affinity</span><br><span class="line">      --cacheline-method M  use cacheline stressing method M</span><br><span class="line">      --cacheline-ops N     stop after N cacheline bogo operations</span><br><span class="line">      --<span class="built_in">cap</span> N               start N workers exercising capget</span><br><span class="line">      --cap-ops N           stop <span class="built_in">cap</span> workers after N bogo capget operations</span><br><span class="line">      --chattr N            start N workers thrashing chattr file mode bits </span><br><span class="line">      --chattr-ops N        stop chattr workers after N bogo operations</span><br><span class="line">      --<span class="built_in">chdir</span> N             start N workers thrashing <span class="built_in">chdir</span> on many paths</span><br><span class="line">      --chdir-dirs N        select number of directories to exercise <span class="built_in">chdir</span> on</span><br><span class="line">      --chdir-ops N         stop <span class="built_in">chdir</span> workers after N bogo <span class="built_in">chdir</span> operations</span><br><span class="line">      --<span class="built_in">chmod</span> N             start N workers thrashing <span class="built_in">chmod</span> file mode bits </span><br><span class="line">      --chmod-ops N         stop <span class="built_in">chmod</span> workers after N bogo operations</span><br><span class="line">      --<span class="built_in">chown</span> N             start N workers thrashing <span class="built_in">chown</span> file ownership</span><br><span class="line">      --chown-ops N         stop <span class="built_in">chown</span> workers after N bogo operations</span><br><span class="line">      --<span class="built_in">chroot</span> N            start N workers thrashing <span class="built_in">chroot</span></span><br><span class="line">      --chroot-ops N        stop <span class="built_in">chroot</span> workers after N bogo operations</span><br><span class="line">      --clock N             start N workers thrashing clocks and POSIX timers</span><br><span class="line">      --clock-ops N         stop clock workers after N bogo operations</span><br><span class="line">      --<span class="built_in">clone</span> N             start N workers that rapidly create and reap</span><br><span class="line">                            clones</span><br><span class="line">      --clone-max N         <span class="built_in">set</span> upper <span class="built_in">limit</span> of N clones per worker</span><br><span class="line">      --clone-ops N         stop after N bogo <span class="built_in">clone</span> operations</span><br><span class="line">      --close N             start N workers that exercise races on close</span><br><span class="line">      --close-ops N         stop after N bogo close operations</span><br><span class="line">      --context N           start N workers exercising user context</span><br><span class="line">      --context-ops N       stop context workers after N bogo operations</span><br><span class="line">      --copy-file N         start N workers that copy file data</span><br><span class="line">      --copy-file-bytes N   specify size of file to be copied</span><br><span class="line">      --copy-file-ops N     stop after N copy bogo operations</span><br><span class="line">-c N, --cpu N               start N workers that perform CPU only loading</span><br><span class="line">-l P, --cpu-load P          load CPU by P %, 0=<span class="built_in">sleep</span>, 100=full load (see -c)</span><br><span class="line">      --cpu-load-slice S    specify time slice during busy load</span><br><span class="line">      --cpu-method M        specify stress cpu method M, default is all</span><br><span class="line">      --cpu-old-metrics     use old CPU metrics instead of normalized metrics</span><br><span class="line">      --cpu-ops N           stop after N cpu bogo operations</span><br><span class="line">      --cpu-online N        start N workers offlining/onlining the CPUs</span><br><span class="line">      --cpu-online-ops N    stop after N offline/online operations</span><br><span class="line">      --crypt N             start N workers performing password encryption</span><br><span class="line">      --crypt-ops N         stop after N bogo crypt operations</span><br><span class="line">      --cyclic N            start N cyclic real time benchmark stressors</span><br><span class="line">      --cyclic-dist N       calculate distribution of interval N nanosecs</span><br><span class="line">      --cyclic-method M     specify cyclic method M, default is clock_ns</span><br><span class="line">      --cyclic-ops N        stop after N cyclic timing cycles</span><br><span class="line">      --cyclic-policy P     used rr or fifo scheduling policy</span><br><span class="line">      --cyclic-prio N       real time scheduling priority 1..100</span><br><span class="line">      --cyclic-samples N    number of latency samples to take</span><br><span class="line">      --cyclic-sleep N      <span class="built_in">sleep</span> time of real time timer <span class="keyword">in</span> nanosecs</span><br><span class="line">      --daemon N            start N workers creating multiple daemons</span><br><span class="line">      --daemon-ops N        stop when N daemons have been created</span><br><span class="line">      --dccp N              start N workers exercising network DCCP I/O</span><br><span class="line">      --dccp-domain D       specify DCCP domain, default is ipv4</span><br><span class="line">      --dccp-if I           use network interface I, e.g. lo, eth0, etc.</span><br><span class="line">      --dccp-ops N          stop after N DCCP  bogo operations</span><br><span class="line">      --dccp-opts option    DCCP data send options [send|sendmsg|sendmmsg]</span><br><span class="line">      --dccp-port P         use DCCP ports P to P + number of workers - 1</span><br><span class="line">      --dekker N            start N workers that exercise ther Dekker</span><br><span class="line">                            algorithm</span><br><span class="line">      --dekker-ops N        stop after N dekker mutex bogo operations</span><br><span class="line">-D N, --dentry N            start N dentry thrashing stressors</span><br><span class="line">      --dentry-ops N        stop after N dentry bogo operations</span><br><span class="line">      --dentry-order O      specify <span class="built_in">unlink</span> order (reverse, forward, stride)</span><br><span class="line">      --dentries N          create N dentries per iteration</span><br><span class="line">      --dev N               start N device entry thrashing stressors</span><br><span class="line">      --dev-file name       specify the /dev/ file to exercise</span><br><span class="line">      --dev-ops N           stop after N device thrashing bogo ops</span><br><span class="line">      --dev-shm N           start N /dev/shm file and mmap stressors</span><br><span class="line">      --dev-shm-ops N       stop after N /dev/shm bogo ops</span><br><span class="line">      --<span class="built_in">dir</span> N               start N directory thrashing stressors</span><br><span class="line">      --dir-dirs N          select number of directories to exercise <span class="built_in">dir</span> on</span><br><span class="line">      --dir-ops N           stop after N directory bogo operations</span><br><span class="line">      --dirdeep N           start N directory depth stressors</span><br><span class="line">      --dirdeep-bytes N     size of files to create per level (see</span><br><span class="line">                            --dirdeep-files)</span><br><span class="line">      --dirdeep-dirs N      create N directories per level</span><br><span class="line">      --dirdeep-files N     create N files per level (see --dirdeep-bytes) </span><br><span class="line">      --dirdeep-inodes N    create a maximum N inodes (N can also be %)</span><br><span class="line">      --dirdeep-ops N       stop after N directory depth bogo operations</span><br><span class="line">      --dirmany N           start N directory file populating stressors</span><br><span class="line">      --dirmany-filsize     specify size of files (default 0</span><br><span class="line">      --dirmany-ops N       stop after N directory file bogo operations</span><br><span class="line">      --dnotify N           start N workers exercising dnotify events</span><br><span class="line">      --dnotify-ops N       stop dnotify workers after N bogo operations</span><br><span class="line">      --dup N               start N workers exercising dup/close</span><br><span class="line">      --dup-ops N           stop after N dup/close bogo operations</span><br><span class="line">      --dynlib N            start N workers exercising dlopen/dlclose</span><br><span class="line">      --dynlib-ops N        stop after N dlopen/dlclose bogo operations</span><br><span class="line">      --efivar N            start N workers that <span class="built_in">read</span> EFI variables</span><br><span class="line">      --efivar-ops N        stop after N EFI variable bogo <span class="built_in">read</span> operations</span><br><span class="line">      --enosys N            start N workers that call non-existent system</span><br><span class="line">                            calls</span><br><span class="line">      --enosys-ops N        stop after N enosys bogo operations</span><br><span class="line">      --<span class="built_in">env</span> N               start N workers setting environment vars</span><br><span class="line">      --env-ops N           stop after N <span class="built_in">env</span> bogo operations</span><br><span class="line">      --epoll N             start N workers doing epoll handled socket</span><br><span class="line">                            activity</span><br><span class="line">      --epoll-domain D      specify socket domain, default is unix</span><br><span class="line">      --epoll-ops N         stop after N epoll bogo operations</span><br><span class="line">      --epoll-port P        use socket ports P upwards</span><br><span class="line">      --epoll-sockets N     specify maximum number of open sockets</span><br><span class="line">      --eventfd N           start N workers stressing eventfd <span class="built_in">read</span>/writes</span><br><span class="line">      --eventfs-nonblock    poll with non-blocking I/O on eventfd fd</span><br><span class="line">      --eventfd-ops N       stop eventfd workers after N bogo operations</span><br><span class="line">      --<span class="built_in">exec</span> N              start N workers spinning on fork() and <span class="built_in">exec</span>()</span><br><span class="line">      --exec-fork-method M  select <span class="built_in">exec</span> fork method: <span class="built_in">clone</span> fork spawn vfork</span><br><span class="line">      --exec-max P          create P workers per iteration, default is 4096</span><br><span class="line">      --exec-method M       select <span class="built_in">exec</span> method: all, execve, execveat</span><br><span class="line">      --exec-no-pthread     <span class="keyword">do</span> not use pthread_create</span><br><span class="line">      --exec-ops N          stop after N <span class="built_in">exec</span> bogo operations</span><br><span class="line">      --exit-group N        start N workers that exercise exit_group</span><br><span class="line">      --exit-group-ops N    stop exit_group workers after N bogo exit_group</span><br><span class="line">                            loops</span><br><span class="line">      --fallocate N         start N workers fallocating 16MB files</span><br><span class="line">      --fallocate-bytes N   specify size of file to allocate</span><br><span class="line">      --fallocate-ops N     stop after N fallocate bogo operations</span><br><span class="line">      --fanotify N          start N workers exercising fanotify events</span><br><span class="line">      --fanotify-ops N      stop fanotify workers after N bogo operations</span><br><span class="line">      --far-branch N        start N far branching workers</span><br><span class="line">      --far-branch-ops N    stop after N far branching bogo operations</span><br><span class="line">      --fault N             start N workers producing page faults</span><br><span class="line">      --fault-ops N         stop after N page fault bogo operations</span><br><span class="line">      --fcntl N             start N workers exercising fcntl commands</span><br><span class="line">      --fcntl-ops N         stop after N fcntl bogo operations</span><br><span class="line">      --fiemap N            start N workers exercising the FIEMAP ioctl</span><br><span class="line">      --fiemap-bytes N      specify size of file to fiemap</span><br><span class="line">      --fiemap-ops N        stop after N FIEMAP ioctl bogo operations</span><br><span class="line">      --fifo N              start N workers exercising fifo I/O</span><br><span class="line">      --fifo-ops N          stop after N fifo bogo operations</span><br><span class="line">      --fifo-readers N      number of fifo reader stressors to start</span><br><span class="line">      --file-ioctl N        start N workers exercising file specific ioctls</span><br><span class="line">      --file-ioctl-ops N    stop after N file ioctl bogo operations</span><br><span class="line">      --filename N          start N workers exercising filenames</span><br><span class="line">      --filename-ops N      stop after N filename bogo operations</span><br><span class="line">      --filename-opts opt   specify allowed filename options</span><br><span class="line">      --flock N             start N workers locking a single file</span><br><span class="line">      --flock-ops N         stop after N flock bogo operations</span><br><span class="line">      --flushcache N        start N CPU instruction + data cache flush</span><br><span class="line">                            workers</span><br><span class="line">      --flushcache-ops N    stop after N flush cache bogo operations</span><br><span class="line">-f N, --fork N              start N workers spinning on fork() and <span class="built_in">exit</span>()</span><br><span class="line">      --fork-max P          create P workers per iteration, default is 1</span><br><span class="line">      --fork-ops N          stop after N fork bogo operations</span><br><span class="line">      --fork-vm             <span class="built_in">enable</span> extra virtual memory pressure</span><br><span class="line">      --fp-error N          start N workers exercising floating point errors</span><br><span class="line">      --fp-error-ops N      stop after N fp-error bogo operations</span><br><span class="line">      --fpunch N            start N workers punching holes <span class="keyword">in</span> a 16MB file</span><br><span class="line">      --fpunch-ops N        stop after N punch bogo operations</span><br><span class="line">      --fsize N             start N workers exercising file size limits</span><br><span class="line">      --fsize-ops N         stop after N fsize bogo operations</span><br><span class="line">      --fstat N             start N workers exercising fstat on files</span><br><span class="line">      --fstat-dir path      fstat files <span class="keyword">in</span> the specified directory</span><br><span class="line">      --fstat-ops N         stop after N fstat bogo operations</span><br><span class="line">      --full N              start N workers exercising /dev/full</span><br><span class="line">      --full-ops N          stop after N /dev/full bogo I/O operations</span><br><span class="line">      --funccall N          start N workers exercising 1 to 9 arg <span class="built_in">functions</span></span><br><span class="line">      --funccall-method M   select <span class="keyword">function</span> call method M</span><br><span class="line">      --funccall-ops N      stop after N <span class="keyword">function</span> call bogo operations</span><br><span class="line">      --funcret N           start N workers exercising <span class="keyword">function</span> <span class="built_in">return</span></span><br><span class="line">                            copying</span><br><span class="line">      --funcret-method M    select method of exercising a <span class="keyword">function</span> <span class="built_in">return</span></span><br><span class="line">                            <span class="built_in">type</span></span><br><span class="line">      --funcret-ops N       stop after N <span class="keyword">function</span> <span class="built_in">return</span> bogo operations</span><br><span class="line">      --futex N             start N workers exercising a fast mutex</span><br><span class="line">      --futex-ops N         stop after N fast mutex bogo operations</span><br><span class="line">      --get N               start N workers exercising the get*() system</span><br><span class="line">                            calls</span><br><span class="line">      --get-ops N           stop after N get bogo operations</span><br><span class="line">      --getdent N           start N workers reading directories using</span><br><span class="line">                            getdents</span><br><span class="line">      --getdent-ops N       stop after N getdents bogo operations</span><br><span class="line">      --getrandom N         start N workers fetching random data via</span><br><span class="line">                            getrandom()</span><br><span class="line">      --getrandom-ops N     stop after N getrandom bogo operations</span><br><span class="line">      --goto N              start N workers that exercise heavy branching</span><br><span class="line">      --goto-direction D    select goto direction forward, backward, random</span><br><span class="line">      --goto-ops N          stop after 1024 x N goto bogo operations</span><br><span class="line">      --gpu N               start N GPU worker</span><br><span class="line">      --gpu-devnode name    specify CPU device node name</span><br><span class="line">      --gpu-frag N          specify shader core usage per pixel</span><br><span class="line">      --gpu-ops N           stop after N gpu render bogo operations</span><br><span class="line">      --gpu-tex-size N      specify upload texture NxN</span><br><span class="line">      --gpu-upload N        specify upload texture N <span class="built_in">times</span> per frame</span><br><span class="line">      --gpu-xsize X         specify framebuffer size x</span><br><span class="line">      --gpu-ysize Y         specify framebuffer size y</span><br><span class="line">      --handle N            start N workers exercising name_to_handle_at</span><br><span class="line">      --handle-ops N        stop after N handle bogo operations</span><br><span class="line">      --<span class="built_in">hash</span> N              start N workers that exercise various <span class="built_in">hash</span></span><br><span class="line">                            <span class="built_in">functions</span></span><br><span class="line">      --hash-method M       specify stress <span class="built_in">hash</span> method M, default is all</span><br><span class="line">      --hash-ops N          stop after N <span class="built_in">hash</span> bogo operations</span><br><span class="line">-d N, --hdd N               start N workers spinning on write()/unlink()</span><br><span class="line">      --hdd-bytes N         write N bytes per hdd worker (default is 1GB)</span><br><span class="line">      --hdd-ops N           stop after N hdd bogo operations</span><br><span class="line">      --hdd-opts list       specify list of various stressor options</span><br><span class="line">      --hdd-write-size N    <span class="built_in">set</span> the default write size to N bytes</span><br><span class="line">      --heapsort N          start N workers heap sorting 32 bit random</span><br><span class="line">                            integers</span><br><span class="line">      --heapsort-ops N      stop after N heap <span class="built_in">sort</span> bogo operations</span><br><span class="line">      --heapsort-size N     number of 32 bit integers to <span class="built_in">sort</span></span><br><span class="line">      --hrtimers N          start N workers that exercise high resolution</span><br><span class="line">                            timers</span><br><span class="line">      --hrtimers-adjust     adjust rate to try and maximum timer rate</span><br><span class="line">      --hrtimers-ops N      stop after N bogo high-res timer bogo operations</span><br><span class="line">      --hsearch N           start N workers that exercise a <span class="built_in">hash</span> table search</span><br><span class="line">      --hsearch-ops N       stop after N <span class="built_in">hash</span> search bogo operations</span><br><span class="line">      --hsearch-size N      number of integers to insert into <span class="built_in">hash</span> table</span><br><span class="line">      --icache N            start N CPU instruction cache thrashing workers</span><br><span class="line">      --icache-ops N        stop after N icache bogo operations</span><br><span class="line">      --icmp-flood N        start N ICMP packet flood workers</span><br><span class="line">      --icmp-flood-ops N    stop after N ICMP bogo operations (ICMP packets)</span><br><span class="line">      --idle-page N         start N idle page scanning workers</span><br><span class="line">      --idle-page-ops N     stop after N idle page scan bogo operations</span><br><span class="line">      --inode-flags N       start N workers exercising various inode flags</span><br><span class="line">      --inode-flags-ops N   stop inode-flags workers after N bogo operations</span><br><span class="line">      --inotify N           start N workers exercising inotify events</span><br><span class="line">      --inotify-ops N       stop inotify workers after N bogo operations</span><br><span class="line">-i N, --io N                start N workers spinning on <span class="built_in">sync</span>()</span><br><span class="line">      --io-ops N            stop <span class="built_in">sync</span> I/O after N io bogo operations</span><br><span class="line">      --iomix N             start N workers that have a mix of I/O operations</span><br><span class="line">      --iomix-bytes N       write N bytes per iomix worker (default is 1GB)</span><br><span class="line">      --iomix-ops N         stop iomix workers after N iomix bogo operations</span><br><span class="line">      --ioport N            start N workers exercising port I/O</span><br><span class="line">      --ioport-ops N        stop ioport workers after N port bogo operations</span><br><span class="line">      --ioprio N            start N workers exercising <span class="built_in">set</span>/get iopriority</span><br><span class="line">      --ioprio-ops N        stop after N io bogo iopriority operations</span><br><span class="line">      --io-uring N          start N workers that issue io-uring I/O requests</span><br><span class="line">      --io-uring-ops N      stop after N bogo io-uring I/O requests</span><br><span class="line">      --ipsec-mb N          start N workers exercising the IPSec MB encoding</span><br><span class="line">      --ipsec-mb-feature F  specify CPU feature F</span><br><span class="line">      --ipsec-mb-jobs N     specify number of <span class="built_in">jobs</span> to run per round (default</span><br><span class="line">                            1)</span><br><span class="line">      --ipsec-mb-ops N      stop after N ipsec bogo encoding operations</span><br><span class="line">      --itimer N            start N workers exercising interval timers</span><br><span class="line">      --itimer-ops N        stop after N interval timer bogo operations</span><br><span class="line">      --itimer-rand         <span class="built_in">enable</span> random interval timer frequency</span><br><span class="line">      --jpeg N              start N workers that burn cycles with no-ops</span><br><span class="line">      --jpeg-height N       image height <span class="keyword">in</span> pixels </span><br><span class="line">      --jpeg-image <span class="built_in">type</span>     image <span class="built_in">type</span>: one of brown, flat, gradient, noise,</span><br><span class="line">                            plasma or xstripes</span><br><span class="line">      --jpeg-ops N          stop after N jpeg bogo no-op operations</span><br><span class="line">      --jpeg-quality Q      compression quality 1 (low) .. 100 (high)</span><br><span class="line">      --jpeg-width N        image width  <span class="keyword">in</span> pixels </span><br><span class="line">      --judy N              start N workers that exercise a judy array search</span><br><span class="line">      --judy-ops N          stop after N judy array search bogo operations</span><br><span class="line">      --judy-size N         number of 32 bit integers to insert into judy</span><br><span class="line">                            array</span><br><span class="line">      --kcmp N              start N workers exercising kcmp</span><br><span class="line">      --kcmp-ops N          stop after N kcmp bogo operations</span><br><span class="line">      --key N               start N workers exercising key operations</span><br><span class="line">      --key-ops N           stop after N key bogo operations</span><br><span class="line">      --<span class="built_in">kill</span> N              start N workers killing with SIGUSR1</span><br><span class="line">      --kill-ops N          stop after N <span class="built_in">kill</span> bogo operations</span><br><span class="line">      --klog N              start N workers exercising kernel syslog</span><br><span class="line">                            interface</span><br><span class="line">      --klog-ops N          stop after N klog bogo operations</span><br><span class="line">      --kvm N               start N workers exercising /dev/kvm</span><br><span class="line">      --kvm-ops N           stop after N kvm create/run/destroy operations</span><br><span class="line">      --l1cache N           start N CPU level 1 cache thrashing workers</span><br><span class="line">      --l1cache-line-size N specify level 1 cache line size</span><br><span class="line">      --l1cache-sets N      specify level 1 cache sets</span><br><span class="line">      --l1cache-size N      specify level 1 cache size</span><br><span class="line">      --l1cache-ways N      only fill specified number of cache ways</span><br><span class="line">      --landlock N          start N workers stressing landlock file</span><br><span class="line">                            operations</span><br><span class="line">      --landlock-ops N      stop after N landlock bogo operations</span><br><span class="line">      --lease N             start N workers holding and breaking a lease</span><br><span class="line">      --lease-breakers N    number of lease breaking workers to start</span><br><span class="line">      --lease-ops N         stop after N lease bogo operations</span><br><span class="line">      --<span class="built_in">link</span> N              start N workers creating hard links</span><br><span class="line">      --link-ops N          stop after N <span class="built_in">link</span> bogo operations</span><br><span class="line">      --link-sync           <span class="built_in">enable</span> <span class="built_in">sync</span><span class="string">&#x27;ing after linking/unlinking</span></span><br><span class="line"><span class="string">      --list N              start N workers that exercise list structures</span></span><br><span class="line"><span class="string">      --list-method M       select list method: all, circleq, list, slist,</span></span><br><span class="line"><span class="string">                            slistt, stailq, tailq</span></span><br><span class="line"><span class="string">      --list-ops N          stop after N bogo list operations</span></span><br><span class="line"><span class="string">      --list-size N         N is the number of items in the list</span></span><br><span class="line"><span class="string">      --llc-affinity N      start N workers exercising low level cache over</span></span><br><span class="line"><span class="string">                            all CPUs</span></span><br><span class="line"><span class="string">      --llc-affinity-ops N  stop after N low-level-cache bogo operations</span></span><br><span class="line"><span class="string">      --loadavg N           start N workers that create a large load average</span></span><br><span class="line"><span class="string">      --loadavg-ops N       stop load average workers after N bogo operations</span></span><br><span class="line"><span class="string">      --loadavg-max N       set upper limit on number of pthreads to create</span></span><br><span class="line"><span class="string">      --locka N             start N workers locking a file via advisory locks</span></span><br><span class="line"><span class="string">      --locka-ops N         stop after N locka bogo operations</span></span><br><span class="line"><span class="string">      --lockbus N           start N workers locking a memory increment</span></span><br><span class="line"><span class="string">      --lockbus-nosplit     disable split locks</span></span><br><span class="line"><span class="string">      --lockbus-ops N       stop after N lockbus bogo operations</span></span><br><span class="line"><span class="string">      --lockf N             start N workers locking a single file via lockf</span></span><br><span class="line"><span class="string">      --lockf-nonblock      don&#x27;</span>t block <span class="keyword">if</span> lock cannot be obtained, re-try</span><br><span class="line">      --lockf-ops N         stop after N lockf bogo operations</span><br><span class="line">      --lockofd N           start N workers using open file description</span><br><span class="line">                            locking</span><br><span class="line">      --lockofd-ops N       stop after N lockofd bogo operations</span><br><span class="line">      --longjmp N           start N workers exercising setjmp/longjmp</span><br><span class="line">      --longjmp-ops N       stop after N longjmp bogo operations</span><br><span class="line">      --loop N              start N workers exercising loopback devices</span><br><span class="line">      --loop-ops N          stop after N bogo loopback operations</span><br><span class="line">      --lsearch N           start N workers that exercise a linear search</span><br><span class="line">      --lsearch-ops N       stop after N linear search bogo operations</span><br><span class="line">      --lsearch-size N      number of 32 bit integers to lsearch</span><br><span class="line">      --madvise N           start N workers exercising madvise on memory</span><br><span class="line">      --madvise-ops N       stop after N bogo madvise operations</span><br><span class="line">      --malloc N            start N workers exercising malloc/realloc/free</span><br><span class="line">      --malloc-bytes N      allocate up to N bytes per allocation</span><br><span class="line">      --malloc-max N        keep up to N allocations at a time</span><br><span class="line">      --malloc-ops N        stop after N malloc bogo operations</span><br><span class="line">      --malloc-pthreads N   number of pthreads to run concurrently</span><br><span class="line">      --malloc-thresh N     threshold <span class="built_in">where</span> malloc uses mmap instead of sbrk</span><br><span class="line">      --malloc-touch        <span class="built_in">touch</span> pages force pages to be populated</span><br><span class="line">      --malloc-zerofree     zero free<span class="string">&#x27;d memory</span></span><br><span class="line"><span class="string">      --matrix N            start N workers exercising matrix operations</span></span><br><span class="line"><span class="string">      --matrix-method M     specify matrix stress method M, default is all</span></span><br><span class="line"><span class="string">      --matrix-ops N        stop after N maxtrix bogo operations</span></span><br><span class="line"><span class="string">      --matrix-size N       specify the size of the N x N matrix</span></span><br><span class="line"><span class="string">      --matrix-yx           matrix operation is y by x instead of x by y</span></span><br><span class="line"><span class="string">      --matrix-3d N         start N workers exercising 3D matrix operations</span></span><br><span class="line"><span class="string">      --matrix-3d-method M  specify 3D matrix stress method M, default is all</span></span><br><span class="line"><span class="string">      --matrix-3d-ops N     stop after N 3D maxtrix bogo operations</span></span><br><span class="line"><span class="string">      --matrix-3d-size N    specify the size of the N x N x N matrix</span></span><br><span class="line"><span class="string">      --matrix-3d-zyx       matrix operation is z by y by x instead of x by y</span></span><br><span class="line"><span class="string">                            by z</span></span><br><span class="line"><span class="string">      --mcontend N          start N workers that produce memory contention</span></span><br><span class="line"><span class="string">      --mcontend-ops N      stop memory contention workers after N bogo-ops</span></span><br><span class="line"><span class="string">      --membarrier N        start N workers performing membarrier system</span></span><br><span class="line"><span class="string">                            calls</span></span><br><span class="line"><span class="string">      --membarrier-ops N    stop after N membarrier bogo operations</span></span><br><span class="line"><span class="string">      --memcpy N            start N workers performing memory copies</span></span><br><span class="line"><span class="string">      --memcpy-method M     set memcpy method (M = all, libc, builtin,</span></span><br><span class="line"><span class="string">                            naive..)</span></span><br><span class="line"><span class="string">      --memcpy-ops N        stop after N memcpy bogo operations</span></span><br><span class="line"><span class="string">      --memfd N             start N workers allocating memory with</span></span><br><span class="line"><span class="string">                            memfd_create</span></span><br><span class="line"><span class="string">      --memfd-bytes N       allocate N bytes for each stress iteration</span></span><br><span class="line"><span class="string">      --memfd-fds N         number of memory fds to open per stressors</span></span><br><span class="line"><span class="string">      --memfd-ops N         stop after N memfd bogo operations</span></span><br><span class="line"><span class="string">      --memhotplug N        start N workers that exercise memory hotplug</span></span><br><span class="line"><span class="string">      --memhotplug-ops N    stop after N memory hotplug operations</span></span><br><span class="line"><span class="string">      --memrate N           start N workers exercised memory read/writes</span></span><br><span class="line"><span class="string">      --memrate-bytes N     size of memory buffer being exercised</span></span><br><span class="line"><span class="string">      --memrate-ops N       stop after N memrate bogo operations</span></span><br><span class="line"><span class="string">      --memrate-rd-mbs N    read rate from buffer in megabytes per second</span></span><br><span class="line"><span class="string">      --memrate-wr-mbs N    write rate to buffer in megabytes per second</span></span><br><span class="line"><span class="string">      --memthrash N         start N workers thrashing a 16MB memory buffer</span></span><br><span class="line"><span class="string">      --memthrash-method M  specify memthrash method M, default is all</span></span><br><span class="line"><span class="string">      --memthrash-ops N     stop after N memthrash bogo operations</span></span><br><span class="line"><span class="string">      --mergesort N         start N workers merge sorting 32 bit random</span></span><br><span class="line"><span class="string">                            integers</span></span><br><span class="line"><span class="string">      --mergesort-ops N     stop after N merge sort bogo operations</span></span><br><span class="line"><span class="string">      --mergesort-size N    number of 32 bit integers to sort</span></span><br><span class="line"><span class="string">      --mincore N           start N workers exercising mincore</span></span><br><span class="line"><span class="string">      --mincore-ops N       stop after N mincore bogo operations</span></span><br><span class="line"><span class="string">      --mincore-random      randomly select pages rather than linear scan</span></span><br><span class="line"><span class="string">      --misaligned N        start N workers performing misaligned read/writes</span></span><br><span class="line"><span class="string">      --misaligned-method M use misaligned memory read/write method</span></span><br><span class="line"><span class="string">      --misaligned-ops N    stop after N misaligned bogo operations</span></span><br><span class="line"><span class="string">      --mknod N             start N workers that exercise mknod</span></span><br><span class="line"><span class="string">      --mknod-ops N         stop after N mknod bogo operations</span></span><br><span class="line"><span class="string">      --mlock N             start N workers exercising mlock/munlock</span></span><br><span class="line"><span class="string">      --mlock-ops N         stop after N mlock bogo operations</span></span><br><span class="line"><span class="string">      --mlockmany N         start N workers exercising many mlock/munlock</span></span><br><span class="line"><span class="string">                            processes</span></span><br><span class="line"><span class="string">      --mlockmany-ops N     stop after N mlockmany bogo operations</span></span><br><span class="line"><span class="string">      --mlockmany-procs N   use N child processes to mlock regions</span></span><br><span class="line"><span class="string">      --mmap N              start N workers stressing mmap and munmap</span></span><br><span class="line"><span class="string">      --mmap-async          using asynchronous msyncs for file based mmap</span></span><br><span class="line"><span class="string">      --mmap-bytes N        mmap and munmap N bytes for each stress iteration</span></span><br><span class="line"><span class="string">      --mmap-file           mmap onto a file using synchronous msyncs</span></span><br><span class="line"><span class="string">      --mmap-mprotect       enable mmap mprotect stressing</span></span><br><span class="line"><span class="string">      --mmap-odirect        enable O_DIRECT on file</span></span><br><span class="line"><span class="string">      --mmap-ops N          stop after N mmap bogo operations</span></span><br><span class="line"><span class="string">      --mmap-osync          enable O_SYNC on file</span></span><br><span class="line"><span class="string">      --mmapaddr N          start N workers stressing mmap with random</span></span><br><span class="line"><span class="string">                            addresses</span></span><br><span class="line"><span class="string">      --mmapaddr-ops N      stop after N mmapaddr bogo operations</span></span><br><span class="line"><span class="string">      --mmapfixed N         start N workers stressing mmap with fixed</span></span><br><span class="line"><span class="string">                            mappings</span></span><br><span class="line"><span class="string">      --mmapfixed-ops N     stop after N mmapfixed bogo operations</span></span><br><span class="line"><span class="string">      --mmapfork N          start N workers stressing many forked</span></span><br><span class="line"><span class="string">                            mmaps/munmaps</span></span><br><span class="line"><span class="string">      --mmapfork-ops N      stop after N mmapfork bogo operations</span></span><br><span class="line"><span class="string">      --mmaphuge N          start N workers stressing mmap with huge mappings</span></span><br><span class="line"><span class="string">      --mmaphuge-mmaps N    select number of memory mappings per iteration</span></span><br><span class="line"><span class="string">      --mmaphuge-ops N      stop after N mmaphuge bogo operations</span></span><br><span class="line"><span class="string">      --mmapmany N          start N workers stressing many mmaps and munmaps</span></span><br><span class="line"><span class="string">      --mmapmany-ops N      stop after N mmapmany bogo operations</span></span><br><span class="line"><span class="string">      --mprotect N          start N workers exercising mprotect on memory</span></span><br><span class="line"><span class="string">      --mprotect-ops N      stop after N bogo mprotect operations</span></span><br><span class="line"><span class="string">      --mq N                start N workers passing messages using POSIX</span></span><br><span class="line"><span class="string">                            messages</span></span><br><span class="line"><span class="string">      --mq-ops N            stop mq workers after N bogo messages</span></span><br><span class="line"><span class="string">      --mq-size N           specify the size of the POSIX message queue</span></span><br><span class="line"><span class="string">      --mremap N            start N workers stressing mremap</span></span><br><span class="line"><span class="string">      --mremap-bytes N      mremap N bytes maximum for each stress iteration</span></span><br><span class="line"><span class="string">      --mremap-lock         mlock remap pages, force pages to be unswappable</span></span><br><span class="line"><span class="string">      --mremap-ops N        stop after N mremap bogo operations</span></span><br><span class="line"><span class="string">      --msg N               start N workers stressing System V messages</span></span><br><span class="line"><span class="string">      --msg-ops N           stop msg workers after N bogo messages</span></span><br><span class="line"><span class="string">      --msg-types N         enable N different message types</span></span><br><span class="line"><span class="string">      --msync N             start N workers syncing mmap&#x27;</span>d data with msync</span><br><span class="line">      --msync-bytes N       size of file and memory mapped region to msync</span><br><span class="line">      --msync-ops N         stop msync workers after N bogo msyncs</span><br><span class="line">      --msyncmany N         start N workers stressing msync on many mapped</span><br><span class="line">                            pages</span><br><span class="line">      --msyncmany-ops N     stop after N msyncmany bogo operations</span><br><span class="line">      --munmap N            start N workers stressing munmap</span><br><span class="line">      --munmap-ops N        stop after N munmap bogo operations</span><br><span class="line">      --mutex N             start N workers exercising mutex operations</span><br><span class="line">      --mutex-affinity      change CPU affinity randomly across locks</span><br><span class="line">      --mutex-ops N         stop after N mutex bogo operations</span><br><span class="line">      --mutex-procs N       select the number of concurrent processes</span><br><span class="line">      --nanosleep N         start N workers performing short sleeps</span><br><span class="line">      --nanosleep-ops N     stop after N bogo <span class="built_in">sleep</span> operations</span><br><span class="line">      --netdev N            start N workers exercising netdevice ioctls</span><br><span class="line">      --netdev-ops N        stop netdev workers after N bogo operations</span><br><span class="line">      --netlink-proc N      start N workers exercising netlink process events</span><br><span class="line">      --netlink-proc-ops N  stop netlink-proc workers after N bogo events</span><br><span class="line">      --netlink-task N      start N workers exercising netlink tasks events</span><br><span class="line">      --netlink-task-ops N  stop netlink-task workers after N bogo events</span><br><span class="line">      --<span class="built_in">nice</span> N              start N workers that randomly re-adjust <span class="built_in">nice</span></span><br><span class="line">                            levels</span><br><span class="line">      --nice-ops N          stop after N <span class="built_in">nice</span> bogo operations</span><br><span class="line">      --nop N               start N workers that burn cycles with no-ops</span><br><span class="line">      --nop-instr INSTR     specify nop instruction to use</span><br><span class="line">      --nop-ops N           stop after N nop bogo no-op operations</span><br><span class="line">      --null N              start N workers writing to /dev/null</span><br><span class="line">      --null-ops N          stop after N /dev/null bogo write operations</span><br><span class="line">      --numa N              start N workers stressing NUMA interfaces</span><br><span class="line">      --numa-ops N          stop after N NUMA bogo operations</span><br><span class="line">      --oom-pipe N          start N workers exercising large pipes</span><br><span class="line">      --oom-pipe-ops N      stop after N oom-pipe bogo operations</span><br><span class="line">      --opcode N            start N workers exercising random opcodes</span><br><span class="line">      --opcode-method M     <span class="built_in">set</span> opcode stress method (M = random, inc, mixed,</span><br><span class="line">                            text)</span><br><span class="line">      --opcode-ops N        stop after N opcode bogo operations</span><br><span class="line">-o N, --open N              start N workers exercising open/close</span><br><span class="line">      --open-fd             open files <span class="keyword">in</span> /proc/<span class="variable">$pid</span>/fd</span><br><span class="line">      --open-max N          specficify maximum number of files to open</span><br><span class="line">      --open-ops N          stop after N open/close bogo operations</span><br><span class="line">      --pagemove N          start N workers that shuffle move pages</span><br><span class="line">      --pagemove-bytes N    size of mmap<span class="string">&#x27;d region to exercise page moving in</span></span><br><span class="line"><span class="string">                            bytes</span></span><br><span class="line"><span class="string">      --pagemove-ops N      stop after N page move bogo operations</span></span><br><span class="line"><span class="string">      --pageswap N          start N workers that swap pages out and in</span></span><br><span class="line"><span class="string">      --pageswap-ops N      stop after N page swap bogo operations</span></span><br><span class="line"><span class="string">      --pci N               start N workers that read and mmap PCI regions</span></span><br><span class="line"><span class="string">      --pci-ops N           stop after N PCI bogo operations</span></span><br><span class="line"><span class="string">      --personality N       start N workers that change their personality</span></span><br><span class="line"><span class="string">      --personality-ops N   stop after N bogo personality calls</span></span><br><span class="line"><span class="string">      --peterson N          start N workers that exercise Peterson&#x27;</span>s</span><br><span class="line">                            algorithm</span><br><span class="line">      --peterson-ops N      stop after N peterson mutex bogo operations</span><br><span class="line">      --physpage N          start N workers performing physical page lookup</span><br><span class="line">      --physpage-ops N      stop after N physical page bogo operations</span><br><span class="line">      --pidfd N             start N workers exercising pidfd system call</span><br><span class="line">      --pidfd-ops N         stop after N pidfd bogo operations</span><br><span class="line">      --ping-sock N         start N workers that exercises a ping socket</span><br><span class="line">      --ping-sock-ops N     stop after N ping sendto messages</span><br><span class="line">-p N, --pipe N              start N workers exercising pipe I/O</span><br><span class="line">      --pipe-data-size N    <span class="built_in">set</span> pipe size of each pipe write to N bytes</span><br><span class="line">      --pipe-ops N          stop after N pipe I/O bogo operations</span><br><span class="line">      --pipe-size N         <span class="built_in">set</span> pipe size to N bytes</span><br><span class="line">-p N, --pipeherd N          start N multi-process workers exercising pipes</span><br><span class="line">                            I/O</span><br><span class="line">      --pipeherd-ops N      stop after N pipeherd I/O bogo operations</span><br><span class="line">      --pipeherd-yield      force processes to yield after each write</span><br><span class="line">      --pkey N              start N workers exercising pkey_mprotect</span><br><span class="line">      --pkey-ops N          stop after N bogo pkey_mprotect bogo operations</span><br><span class="line">      --plugin N            start N workers exercising random plugins</span><br><span class="line">      --plugin-method M     <span class="built_in">set</span> plugin stress method</span><br><span class="line">      --plugin-ops N        stop after N plugin bogo operations</span><br><span class="line">      --plugin-so file      specify plugin shared object file</span><br><span class="line">-P N, --poll N              start N workers exercising zero <span class="built_in">timeout</span> polling</span><br><span class="line">      --poll-fds N          use N file descriptors</span><br><span class="line">      --poll-ops N          stop after N poll bogo operations</span><br><span class="line">      --procfs N            start N workers reading portions of /proc</span><br><span class="line">      --procfs-ops N        stop procfs workers after N bogo <span class="built_in">read</span> operations</span><br><span class="line">      --prefetch N          start N workers exercising memory prefetching </span><br><span class="line">      --prefetch-l3-size N  specify the L3 cache size of the CPU</span><br><span class="line">      --prefetch-ops N      stop after N bogo prefetching operations</span><br><span class="line">      --procfs N            start N workers reading portions of /proc</span><br><span class="line">      --procfs-ops N        stop procfs workers after N bogo <span class="built_in">read</span> operations</span><br><span class="line">      --pthread N           start N workers that create multiple threads</span><br><span class="line">      --pthread-max P       create P threads at a time by each worker</span><br><span class="line">      --pthread-ops N       stop pthread workers after N bogo threads created</span><br><span class="line">      --ptrace N            start N workers that trace a child using ptrace</span><br><span class="line">      --ptrace-ops N        stop ptrace workers after N system calls are</span><br><span class="line">                            traced</span><br><span class="line">      --pty N               start N workers that exercise pseudoterminals</span><br><span class="line">      --pty-max N           attempt to open a maximum of N ptys</span><br><span class="line">      --pty-ops N           stop pty workers after N pty bogo operations</span><br><span class="line">-Q N, --qsort N             start N workers qsorting 32 bit random integers</span><br><span class="line">      --qsort-ops N         stop after N qsort bogo operations</span><br><span class="line">      --qsort-size N        number of 32 bit integers to <span class="built_in">sort</span></span><br><span class="line">      --quota N             start N workers exercising quotactl commands</span><br><span class="line">      --quota-ops N         stop after N quotactl bogo operations</span><br><span class="line">      --race-sched N        start N workers that race cpu affinity</span><br><span class="line">      --race-sched-ops N    stop after N bogo race operations</span><br><span class="line">      --race-sched-method M method M: all, rand, next, prev, yoyo, randinc</span><br><span class="line">      --radixsort N         start N workers radix sorting random strings</span><br><span class="line">      --radixsort-ops N     stop after N radixsort bogo operations</span><br><span class="line">      --radixsort-size N    number of strings to <span class="built_in">sort</span></span><br><span class="line">      --randlist N          start N workers that exercise random ordered list</span><br><span class="line">      --randlist-compact    reduce mmap and malloc overheads</span><br><span class="line">      --randlist-items N    number of items <span class="keyword">in</span> the random ordered list</span><br><span class="line">      --randlist-ops N      stop after N randlist bogo no-op operations</span><br><span class="line">      --randlist-size N     size of data <span class="keyword">in</span> each item <span class="keyword">in</span> the list</span><br><span class="line">      --ramfs N             start N workers exercising ramfs mounts</span><br><span class="line">      --ramfs-size N        <span class="built_in">set</span> the ramfs size <span class="keyword">in</span> bytes, e.g. 2M is 2MB</span><br><span class="line">      --ramfs-fill          attempt to fill ramfs</span><br><span class="line">      --ramfs-ops N         stop after N bogo ramfs mount operations</span><br><span class="line">      --rawdev N            start N workers that <span class="built_in">read</span> a raw device</span><br><span class="line">      --rawdev-method M     specify the rawdev <span class="built_in">read</span> method to use</span><br><span class="line">      --rawdev-ops N        stop after N rawdev <span class="built_in">read</span> operations</span><br><span class="line">      --rawpkt N            start N workers exercising raw packets</span><br><span class="line">      --rawpkt-ops N        stop after N raw packet bogo operations</span><br><span class="line">      --rawpkt-port P       use raw packet ports P to P + number of workers -</span><br><span class="line">                            1</span><br><span class="line">      --rawsock N           start N workers performing raw socket</span><br><span class="line">                            send/receives </span><br><span class="line">      --rawsock-ops N       stop after N raw socket bogo operations</span><br><span class="line">      --rawsock-port P      use socket P to P + number of workers - 1</span><br><span class="line">      --rawudp N            start N workers exercising raw UDP socket I/O</span><br><span class="line">      --rawudp-if I         use network interface I, e.g. lo, eth0, etc.</span><br><span class="line">      --rawudp-ops N        stop after N raw socket UDP bogo operations</span><br><span class="line">      --rawudp-port P       use raw socket ports P to P + number of workers -</span><br><span class="line">                            1</span><br><span class="line">      --rdrand N            start N workers exercising rdrand (x86 only)</span><br><span class="line">      --rdrand-ops N        stop after N rdrand bogo operations</span><br><span class="line">      --rdrand-seed         use rdseed instead of rdrand</span><br><span class="line">      --readahead N         start N workers exercising file readahead</span><br><span class="line">      --readahead-bytes N   size of file to readahead on (default is 1GB)</span><br><span class="line">      --readahead-ops N     stop after N readahead bogo operations</span><br><span class="line">      --reboot N            start N workers that exercise bad reboot calls</span><br><span class="line">      --reboot-ops N        stop after N bogo reboot operations</span><br><span class="line">      --regs N              start N workers exercising CPU generic registers</span><br><span class="line">      --regs-ops N          stop after N x 1000 rounds of register shuffling</span><br><span class="line">      --remap N             start N workers exercising page remappings</span><br><span class="line">      --remap-ops N         stop after N remapping bogo operations</span><br><span class="line">-R,   --rename N            start N workers exercising file renames</span><br><span class="line">      --rename-ops N        stop after N rename bogo operations</span><br><span class="line">      --resched N           start N workers that spawn renicing child</span><br><span class="line">                            processes</span><br><span class="line">      --resched-ops N       stop after N <span class="built_in">nice</span> bogo <span class="built_in">nice</span><span class="string">&#x27;d yield operations</span></span><br><span class="line"><span class="string">      --resources N         start N workers consuming system resources</span></span><br><span class="line"><span class="string">      --resources-ops N     stop after N resource bogo operations</span></span><br><span class="line"><span class="string">      --revio N             start N workers performing reverse I/O</span></span><br><span class="line"><span class="string">      --revio-ops N         stop after N revio bogo operations</span></span><br><span class="line"><span class="string">      --ring-pipe N         start N workers exercising a ring of pipes</span></span><br><span class="line"><span class="string">      --ring-pipe-num       number of pipes to use</span></span><br><span class="line"><span class="string">      --ring-pipe-ops N     stop after N ring pipe I/O bogo operations</span></span><br><span class="line"><span class="string">      --ring-pipe-size      size of data to be written and read</span></span><br><span class="line"><span class="string">      --ring-pipe-splice    use splice instread of read+write</span></span><br><span class="line"><span class="string">      --rmap N              start N workers that stress reverse mappings</span></span><br><span class="line"><span class="string">      --rmap-ops N          stop after N rmap bogo operations</span></span><br><span class="line"><span class="string">      --rmap N              start N workers that stress reverse mappings</span></span><br><span class="line"><span class="string">      --rmap-ops N          stop after N rmap bogo operations</span></span><br><span class="line"><span class="string">      --rseq N              start N workers that exercise restartable</span></span><br><span class="line"><span class="string">                            sequences</span></span><br><span class="line"><span class="string">      --rseq-ops N          stop after N bogo restartable sequence operations</span></span><br><span class="line"><span class="string">      --rtc N               start N workers that exercise the RTC interfaces</span></span><br><span class="line"><span class="string">      --rtc-ops N           stop after N RTC bogo operations</span></span><br><span class="line"><span class="string">      --schedpolicy N       start N workers that exercise scheduling policy</span></span><br><span class="line"><span class="string">      --schedpolicy-ops N   stop after N scheduling policy bogo operations</span></span><br><span class="line"><span class="string">      --sctp N              start N workers performing SCTP send/receives </span></span><br><span class="line"><span class="string">      --sctp-domain D       specify sctp domain, default is ipv4</span></span><br><span class="line"><span class="string">      --sctp-if I           use network interface I, e.g. lo, eth0, etc.</span></span><br><span class="line"><span class="string">      --sctp-ops N          stop after N SCTP bogo operations</span></span><br><span class="line"><span class="string">      --sctp-port P         use SCTP ports P to P + number of workers - 1</span></span><br><span class="line"><span class="string">      --sctp-sched S        specify sctp scheduler</span></span><br><span class="line"><span class="string">      --seal N              start N workers performing fcntl SEAL commands</span></span><br><span class="line"><span class="string">      --seal-ops N          stop after N SEAL bogo operations</span></span><br><span class="line"><span class="string">      --seccomp N           start N workers performing seccomp call filtering</span></span><br><span class="line"><span class="string">      --seccomp-ops N       stop after N seccomp bogo operations</span></span><br><span class="line"><span class="string">      --secretmem N         start N workers that use secretmem mappings</span></span><br><span class="line"><span class="string">      --secretmem-ops N     stop after N secretmem bogo operations</span></span><br><span class="line"><span class="string">      --seek N              start N workers performing random seek r/w IO</span></span><br><span class="line"><span class="string">      --seek-ops N          stop after N seek bogo operations</span></span><br><span class="line"><span class="string">      --seek-punch          punch random holes in file to stress extents</span></span><br><span class="line"><span class="string">      --seek-size N         length of file to do random I/O upon</span></span><br><span class="line"><span class="string">      --sem N               start N workers doing semaphore operations</span></span><br><span class="line"><span class="string">      --sem-ops N           stop after N semaphore bogo operations</span></span><br><span class="line"><span class="string">      --sem-procs N         number of processes to start per worker</span></span><br><span class="line"><span class="string">      --sem-sysv N          start N workers doing System V semaphore</span></span><br><span class="line"><span class="string">                            operations</span></span><br><span class="line"><span class="string">      --sem-sysv-ops N      stop after N System V sem bogo operations</span></span><br><span class="line"><span class="string">      --sem-sysv-procs N    number of processes to start per worker</span></span><br><span class="line"><span class="string">      --sendfile N          start N workers exercising sendfile</span></span><br><span class="line"><span class="string">      --sendfile-ops N      stop after N bogo sendfile operations</span></span><br><span class="line"><span class="string">      --sendfile-size N     size of data to be sent with sendfile</span></span><br><span class="line"><span class="string">-f N, --session N           start N workers that exercise new sessions</span></span><br><span class="line"><span class="string">      --session-ops N       stop after N session bogo operations</span></span><br><span class="line"><span class="string">      --set N               start N workers exercising the set*() system</span></span><br><span class="line"><span class="string">                            calls</span></span><br><span class="line"><span class="string">      --set-ops N           stop after N set bogo operations</span></span><br><span class="line"><span class="string">      --shellsort N         start N workers shell sorting 32 bit random</span></span><br><span class="line"><span class="string">                            integers</span></span><br><span class="line"><span class="string">      --shellsort-ops N     stop after N shell sort bogo operations</span></span><br><span class="line"><span class="string">      --shellsort-size N    number of 32 bit integers to sort</span></span><br><span class="line"><span class="string">      --shm N               start N workers that exercise POSIX shared memory</span></span><br><span class="line"><span class="string">      --shm-bytes N         allocate/free N bytes of POSIX shared memory</span></span><br><span class="line"><span class="string">      --shm-ops N           stop after N POSIX shared memory bogo operations</span></span><br><span class="line"><span class="string">      --shm-segs N          allocate N POSIX shared memory segments per</span></span><br><span class="line"><span class="string">                            iteration</span></span><br><span class="line"><span class="string">      --shm-sysv N          start N workers that exercise System V shared</span></span><br><span class="line"><span class="string">                            memory</span></span><br><span class="line"><span class="string">      --shm-sysv-bytes N    allocate and free N bytes of shared memory per</span></span><br><span class="line"><span class="string">                            loop</span></span><br><span class="line"><span class="string">      --shm-sysv-ops N      stop after N shared memory bogo operations</span></span><br><span class="line"><span class="string">      --shm-sysv-segs N     allocate N shared memory segments per iteration</span></span><br><span class="line"><span class="string">      --sigabrt N           start N workers generating segmentation faults</span></span><br><span class="line"><span class="string">      --sigabrt-ops N       stop after N bogo segmentation faults</span></span><br><span class="line"><span class="string">      --sigchld N           start N workers that handle SIGCHLD</span></span><br><span class="line"><span class="string">      --sigchld-ops N       stop after N bogo SIGCHLD signals</span></span><br><span class="line"><span class="string">      --sigfd N             start N workers reading signals via signalfd</span></span><br><span class="line"><span class="string">                            reads </span></span><br><span class="line"><span class="string">      --sigfd-ops N         stop after N bogo signalfd reads</span></span><br><span class="line"><span class="string">      --sigfpe N            start N workers generating floating point math</span></span><br><span class="line"><span class="string">                            faults</span></span><br><span class="line"><span class="string">      --sigfpe-ops N        stop after N bogo floating point math faults</span></span><br><span class="line"><span class="string">      --sigio N             start N workers that exercise SIGIO signals</span></span><br><span class="line"><span class="string">      --sigio-ops N         stop after N bogo sigio signals</span></span><br><span class="line"><span class="string">      --signal N            start N workers that exercise signal</span></span><br><span class="line"><span class="string">      --signal-ops N        stop after N bogo signals</span></span><br><span class="line"><span class="string">      --signest N           start N workers generating nested signals</span></span><br><span class="line"><span class="string">      --signest-ops N       stop after N bogo nested signals</span></span><br><span class="line"><span class="string">      --sigpending N        start N workers exercising sigpending</span></span><br><span class="line"><span class="string">      --sigpending-ops N    stop after N sigpending bogo operations</span></span><br><span class="line"><span class="string">      --sigpipe N           start N workers exercising SIGPIPE</span></span><br><span class="line"><span class="string">      --sigpipe-ops N       stop after N SIGPIPE bogo operations</span></span><br><span class="line"><span class="string">      --sigq N              start N workers sending sigqueue signals</span></span><br><span class="line"><span class="string">      --sigq-ops N          stop after N sigqueue bogo operations</span></span><br><span class="line"><span class="string">      --sigrt N             start N workers sending real time signals</span></span><br><span class="line"><span class="string">      --sigrt-ops N         stop after N real time signal bogo operations</span></span><br><span class="line"><span class="string">      --sigsegv N           start N workers generating segmentation faults</span></span><br><span class="line"><span class="string">      --sigsegv-ops N       stop after N bogo segmentation faults</span></span><br><span class="line"><span class="string">      --sigsuspend N        start N workers exercising sigsuspend</span></span><br><span class="line"><span class="string">      --sigsuspend-ops N    stop after N bogo sigsuspend wakes</span></span><br><span class="line"><span class="string">      --sigtrap N           start N workers generating segmentation faults</span></span><br><span class="line"><span class="string">      --sigtrap-ops N       stop after N bogo segmentation faults</span></span><br><span class="line"><span class="string">      --skiplist N          start N workers that exercise a skiplist search</span></span><br><span class="line"><span class="string">      --skiplist-ops N      stop after N skiplist search bogo operations</span></span><br><span class="line"><span class="string">      --skiplist-size N     number of 32 bit integers to add to skiplist</span></span><br><span class="line"><span class="string">      --sleep N             start N workers performing various duration</span></span><br><span class="line"><span class="string">                            sleeps</span></span><br><span class="line"><span class="string">      --sleep-max P         create P threads at a time by each worker</span></span><br><span class="line"><span class="string">      --sleep-ops N         stop after N bogo sleep operations</span></span><br><span class="line"><span class="string">      --smi N               start N workers that trigger SMIs</span></span><br><span class="line"><span class="string">      --smi-ops N           stop after N SMIs have been triggered</span></span><br><span class="line"><span class="string">-S N, --sock N              start N workers exercising socket I/O</span></span><br><span class="line"><span class="string">      --sock-domain D       specify socket domain, default is ipv4</span></span><br><span class="line"><span class="string">      --sock-if I           use network interface I, e.g. lo, eth0, etc.</span></span><br><span class="line"><span class="string">      --sock-nodelay        disable Nagle algorithm, send data immediately</span></span><br><span class="line"><span class="string">      --sock-ops N          stop after N socket bogo operations</span></span><br><span class="line"><span class="string">      --sock-opts option    socket options [send|sendmsg|sendmmsg]</span></span><br><span class="line"><span class="string">      --sock-port P         use socket ports P to P + number of workers - 1</span></span><br><span class="line"><span class="string">      --sock-protocol       use socket protocol P, default is tcp, can be</span></span><br><span class="line"><span class="string">                            mptcp</span></span><br><span class="line"><span class="string">      --sock-type T         socket type (stream, seqpacket)</span></span><br><span class="line"><span class="string">      --sock-zerocopy       enable zero copy sends</span></span><br><span class="line"><span class="string">      --sockabuse N         start N workers abusing socket I/O</span></span><br><span class="line"><span class="string">      --sockabuse-ops N     stop after N socket abusing bogo operations</span></span><br><span class="line"><span class="string">      --sockabuse-port P    use socket ports P to P + number of workers - 1</span></span><br><span class="line"><span class="string">      --sockdiag N          start N workers exercising sockdiag netlink</span></span><br><span class="line"><span class="string">      --sockdiag-ops N      stop sockdiag workers after N bogo messages</span></span><br><span class="line"><span class="string">      --sockfd N            start N workers sending file descriptors over</span></span><br><span class="line"><span class="string">                            sockets</span></span><br><span class="line"><span class="string">      --sockfd-ops N        stop after N sockfd bogo operations</span></span><br><span class="line"><span class="string">      --sockfd-port P       use socket fd ports P to P + number of workers -</span></span><br><span class="line"><span class="string">                            1</span></span><br><span class="line"><span class="string">      --sockpair N          start N workers exercising socket pair I/O</span></span><br><span class="line"><span class="string">                            activity</span></span><br><span class="line"><span class="string">      --sockpair-ops N      stop after N socket pair bogo operations</span></span><br><span class="line"><span class="string">      --sockmany N          start N workers exercising many socket</span></span><br><span class="line"><span class="string">                            connections</span></span><br><span class="line"><span class="string">      --sockmany-if I       use network interface I, e.g. lo, eth0, etc.</span></span><br><span class="line"><span class="string">      --sockmany-ops N      stop after N sockmany bogo operations</span></span><br><span class="line"><span class="string">      --sockmany-port       use socket ports P to P + number of workers - 1</span></span><br><span class="line"><span class="string">      --softlockup N        start N workers that cause softlockups</span></span><br><span class="line"><span class="string">      --softlockup-ops N    stop after N softlockup bogo operations</span></span><br><span class="line"><span class="string">      --spawn N             start N workers spawning stress-ng using</span></span><br><span class="line"><span class="string">                            posix_spawn</span></span><br><span class="line"><span class="string">      --spawn-ops N         stop after N spawn bogo operations</span></span><br><span class="line"><span class="string">      --sparsematrix N      start N workers that exercise a sparse matrix</span></span><br><span class="line"><span class="string">      --sparsematrix-items NN is the number of items in the spare matrix</span></span><br><span class="line"><span class="string">      --sparsematrix-method Mselect storage method: all, hash, judy, list or</span></span><br><span class="line"><span class="string">                            rb</span></span><br><span class="line"><span class="string">      --sparsematrix-ops N  stop after N bogo sparse matrix operations</span></span><br><span class="line"><span class="string">      --sparsematrix-size N M is the width and height X x Y of the matrix</span></span><br><span class="line"><span class="string">      --splice N            start N workers reading/writing using splice</span></span><br><span class="line"><span class="string">      --splice-bytes N      number of bytes to transfer per splice call</span></span><br><span class="line"><span class="string">      --splice-ops N        stop after N bogo splice operations</span></span><br><span class="line"><span class="string">      --stack N             start N workers generating stack overflows</span></span><br><span class="line"><span class="string">      --stack-fill          fill stack, touches all new pages </span></span><br><span class="line"><span class="string">      --stack-mlock         mlock stack, force pages to be unswappable</span></span><br><span class="line"><span class="string">      --stack-ops N         stop after N bogo stack overflows</span></span><br><span class="line"><span class="string">      --stack-pageout       use madvise to try to swap out stack</span></span><br><span class="line"><span class="string">      --stackmmap N         start N workers exercising a filebacked stack</span></span><br><span class="line"><span class="string">      --stackmmap-ops N     stop after N bogo stackmmap operations</span></span><br><span class="line"><span class="string">      --str N               start N workers exercising lib C string functions</span></span><br><span class="line"><span class="string">      --str-method func     specify the string function to stress</span></span><br><span class="line"><span class="string">      --str-ops N           stop after N bogo string operations</span></span><br><span class="line"><span class="string">      --stream N            start N workers exercising memory bandwidth</span></span><br><span class="line"><span class="string">      --stream-index        specify number of indices into the data (0..3)</span></span><br><span class="line"><span class="string">      --stream-l3-size N    specify the L3 cache size of the CPU</span></span><br><span class="line"><span class="string">      --stream-madvise M    specify mmap&#x27;</span>d stream buffer madvise advice</span><br><span class="line">      --stream-ops N        stop after N bogo stream operations</span><br><span class="line">      --swap N              start N workers exercising swapon/swapoff</span><br><span class="line">      --swap-ops N          stop after N swapon/swapoff operations</span><br><span class="line">-s N, --switch N            start N workers doing rapid context switches</span><br><span class="line">      --switch-freq N       <span class="built_in">set</span> frequency of context switches</span><br><span class="line">      --switch-method M     mq | pipe | sem-sysv</span><br><span class="line">      --switch-ops N        stop after N context switch bogo operations</span><br><span class="line">      --symlink N           start N workers creating symbolic links</span><br><span class="line">      --symlink-ops N       stop after N symbolic <span class="built_in">link</span> bogo operations</span><br><span class="line">      --symlink-sync        <span class="built_in">enable</span> <span class="built_in">sync</span><span class="string">&#x27;ing after symlinking/unsymlinking</span></span><br><span class="line"><span class="string">      --sync-file N         start N workers exercise sync_file_range</span></span><br><span class="line"><span class="string">      --sync-file-bytes N   size of file to be sync&#x27;</span>d</span><br><span class="line">      --sync-file-ops N     stop after N sync_file_range bogo operations</span><br><span class="line">      --syncload N          start N workers that synchronize load spikes</span><br><span class="line">      --syncload-msbusy M   maximum busy duration <span class="keyword">in</span> milliseconds</span><br><span class="line">      --syncload-mssleep M  maximum <span class="built_in">sleep</span> duration <span class="keyword">in</span> milliseconds</span><br><span class="line">      --syncload-ops N      stop after N syncload bogo operations</span><br><span class="line">      --sysbadaddr N        start N workers that pass bad addresses to</span><br><span class="line">                            syscalls</span><br><span class="line">      --sysbadaddr-ops N    stop after N sysbadaddr bogo syscalls</span><br><span class="line">      --syscall N           start N workers that exercise a wide range of</span><br><span class="line">                            system calls</span><br><span class="line">      --syscall-ops N       stop after N syscall bogo operations</span><br><span class="line">      --sysinfo N           start N workers reading system information</span><br><span class="line">      --sysinfo-ops N       stop after sysinfo bogo operations</span><br><span class="line">      --sysinval N          start N workers that pass invalid args to</span><br><span class="line">                            syscalls</span><br><span class="line">      --sysinval-ops N      stop after N sysinval bogo syscalls</span><br><span class="line">      --sysfs N             start N workers reading files from /sys</span><br><span class="line">      --sysfs-ops N         stop after sysfs bogo operations</span><br><span class="line">      --<span class="built_in">tee</span> N               start N workers exercising the <span class="built_in">tee</span> system call</span><br><span class="line">      --tee-ops N           stop after N <span class="built_in">tee</span> bogo operations</span><br><span class="line">-T N, --timer N             start N workers producing timer events</span><br><span class="line">      --timer-freq F        run timer(s) at F Hz, range 1 to 1000000000</span><br><span class="line">      --timer-ops N         stop after N timer bogo events</span><br><span class="line">      --timer-rand          <span class="built_in">enable</span> random timer frequency</span><br><span class="line">      --timerfd N           start N workers producing timerfd events</span><br><span class="line">      --timerfd-fds N       number of timerfd file descriptors to open</span><br><span class="line">      --timerfd-freq F      run timer(s) at F Hz, range 1 to 1000000000</span><br><span class="line">      --timerfd-ops N       stop after N timerfd bogo events</span><br><span class="line">      --timerfd-rand        <span class="built_in">enable</span> random timerfd frequency</span><br><span class="line">      --tlb-shootdown N     start N workers that force TLB shootdowns</span><br><span class="line">      --tlb-shootdown-ops N stop after N TLB shootdown bogo ops</span><br><span class="line">      --tmpfs N             start N workers mmap<span class="string">&#x27;ing a file on tmpfs</span></span><br><span class="line"><span class="string">      --tmpfs-mmap-async    using asynchronous msyncs for tmpfs file based</span></span><br><span class="line"><span class="string">                            mmap</span></span><br><span class="line"><span class="string">      --tmpfs-mmap-file     mmap onto a tmpfs file using synchronous msyncs</span></span><br><span class="line"><span class="string">      --tmpfs-ops N         stop after N tmpfs bogo ops</span></span><br><span class="line"><span class="string">      --touch N             start N stressors that touch and remove files</span></span><br><span class="line"><span class="string">      --touch-method        specify method to touch tile file, open | create</span></span><br><span class="line"><span class="string">      --touch-ops N         stop after N touch bogo operations</span></span><br><span class="line"><span class="string">      --touch-opts          touch open options</span></span><br><span class="line"><span class="string">                            all,direct,dsync,excl,noatime,sync,trunc</span></span><br><span class="line"><span class="string">      --tree N              start N workers that exercise tree structures</span></span><br><span class="line"><span class="string">      --tree-method M       select tree method: all,avl,binary,btree,rb,splay</span></span><br><span class="line"><span class="string">      --tree-ops N          stop after N bogo tree operations</span></span><br><span class="line"><span class="string">      --tree-size N         N is the number of items in the tree</span></span><br><span class="line"><span class="string">      --tsc N               start N workers reading the time stamp counter</span></span><br><span class="line"><span class="string">      --tsc-ops N           stop after N TSC bogo operations</span></span><br><span class="line"><span class="string">      --tsearch N           start N workers that exercise a tree search</span></span><br><span class="line"><span class="string">      --tsearch-ops N       stop after N tree search bogo operations</span></span><br><span class="line"><span class="string">      --tsearch-size N      number of 32 bit integers to tsearch</span></span><br><span class="line"><span class="string">      --tun N               start N workers exercising tun interface</span></span><br><span class="line"><span class="string">      --tun-ops N           stop after N tun bogo operations</span></span><br><span class="line"><span class="string">      --tun-tap             use TAP interface instead of TUN</span></span><br><span class="line"><span class="string">      --udp N               start N workers performing UDP send/receives </span></span><br><span class="line"><span class="string">      --udp-domain D        specify domain, default is ipv4</span></span><br><span class="line"><span class="string">      --udp-gro             enable UDP-GRO</span></span><br><span class="line"><span class="string">      --udp-if I            use network interface I, e.g. lo, eth0, etc.</span></span><br><span class="line"><span class="string">      --udp-lite            use the UDP-Lite (RFC 3828) protocol</span></span><br><span class="line"><span class="string">      --udp-ops N           stop after N udp bogo operations</span></span><br><span class="line"><span class="string">      --udp-port P          use ports P to P + number of workers - 1</span></span><br><span class="line"><span class="string">      --udp-flood N         start N workers that performs a UDP flood attack</span></span><br><span class="line"><span class="string">      --udp-flood-domain D  specify domain, default is ipv4</span></span><br><span class="line"><span class="string">      --udp-flood-if I      use network interface I, e.g. lo, eth0, etc.</span></span><br><span class="line"><span class="string">      --udp-flood-ops N     stop after N udp flood bogo operations</span></span><br><span class="line"><span class="string">      --unshare N           start N workers exercising resource unsharing</span></span><br><span class="line"><span class="string">      --unshare-ops N       stop after N bogo unshare operations</span></span><br><span class="line"><span class="string">      --uprobe N            start N workers that generate uprobe events</span></span><br><span class="line"><span class="string">      --uprobe-ops N        stop after N uprobe events</span></span><br><span class="line"><span class="string">-u N, --urandom N           start N workers reading /dev/urandom</span></span><br><span class="line"><span class="string">      --urandom-ops N       stop after N urandom bogo read operations</span></span><br><span class="line"><span class="string">      --userfaultfd N       start N page faulting workers with userspace</span></span><br><span class="line"><span class="string">                            handling</span></span><br><span class="line"><span class="string">      --userfaultfd-ops N   stop after N page faults have been handled</span></span><br><span class="line"><span class="string">      --usersyscall N       start N workers exercising a userspace system</span></span><br><span class="line"><span class="string">                            call handler</span></span><br><span class="line"><span class="string">      --usersyscall-ops N   stop after N successful SIGSYS system callls</span></span><br><span class="line"><span class="string">      --utime N             start N workers updating file timestamps</span></span><br><span class="line"><span class="string">      --utime-fsync         force utime meta data sync to the file system</span></span><br><span class="line"><span class="string">      --utime-ops N         stop after N utime bogo operations</span></span><br><span class="line"><span class="string">      --vdso N              start N workers exercising functions in the VDSO</span></span><br><span class="line"><span class="string">      --vdso-func F         use just vDSO function F</span></span><br><span class="line"><span class="string">      --vdso-ops N          stop after N vDSO function calls</span></span><br><span class="line"><span class="string">      --vecfp N             start N workers performing vector math ops</span></span><br><span class="line"><span class="string">      --vecfp-ops N         stop after N vector math bogo operations</span></span><br><span class="line"><span class="string">      --vecmath N           start N workers performing vector math ops</span></span><br><span class="line"><span class="string">      --vecmath-ops N       stop after N vector math bogo operations</span></span><br><span class="line"><span class="string">      --vecshuf N           start N workers performing vector shuffle ops</span></span><br><span class="line"><span class="string">      --vecshuf-method M    select vector shuffling method</span></span><br><span class="line"><span class="string">      --vecshuf-ops N       stop after N vector shuffle bogo operations</span></span><br><span class="line"><span class="string">      --vecwide N           start N workers performing vector math ops</span></span><br><span class="line"><span class="string">      --vecwide-ops N       stop after N vector math bogo operations</span></span><br><span class="line"><span class="string">      --verity N            start N workers exercising file verity ioctls</span></span><br><span class="line"><span class="string">      --verity-ops N        stop after N file verity bogo operations</span></span><br><span class="line"><span class="string">      --vfork N             start N workers spinning on vfork() and exit()</span></span><br><span class="line"><span class="string">      --vfork-ops N         stop after N vfork bogo operations</span></span><br><span class="line"><span class="string">      --vfork-max P         create P processes per iteration, default is 1</span></span><br><span class="line"><span class="string">      --vforkmany N         start N workers spawning many vfork children</span></span><br><span class="line"><span class="string">      --vforkmany-ops N     stop after spawning N vfork children</span></span><br><span class="line"><span class="string">      --vforkmany-vm        enable extra virtual memory pressure</span></span><br><span class="line"><span class="string">-m N, --vm N                start N workers spinning on anonymous mmap</span></span><br><span class="line"><span class="string">      --vm-bytes N          allocate N bytes per vm worker (default 256MB)</span></span><br><span class="line"><span class="string">      --vm-hang N           sleep N seconds before freeing memory</span></span><br><span class="line"><span class="string">      --vm-keep             redirty memory instead of reallocating</span></span><br><span class="line"><span class="string">      --vm-locked           lock the pages of the mapped region into memory</span></span><br><span class="line"><span class="string">      --vm-madvise M        specify mmap&#x27;</span>d vm buffer madvise advice</span><br><span class="line">      --vm-method M         specify stress vm method M, default is all</span><br><span class="line">      --vm-ops N            stop after N vm bogo operations</span><br><span class="line">      --vm-populate         populate (prefault) page tables <span class="keyword">for</span> a mapping</span><br><span class="line">      --vm-addr N           start N vm address exercising workers</span><br><span class="line">      --vm-addr-ops N       stop after N vm address bogo operations</span><br><span class="line">      --vm-rw N             start N vm <span class="built_in">read</span>/write process_vm* copy workers</span><br><span class="line">      --vm-rw-bytes N       transfer N bytes of memory per bogo operation</span><br><span class="line">      --vm-rw-ops N         stop after N vm process_vm* copy bogo operations</span><br><span class="line">      --vm-segv N           start N workers that unmap their address space</span><br><span class="line">      --vm-segv-ops N       stop after N vm-segv unmap<span class="string">&#x27;d SEGV faults</span></span><br><span class="line"><span class="string">      --vm-splice N         start N workers reading/writing using vmsplice</span></span><br><span class="line"><span class="string">      --vm-splice-bytes N   number of bytes to transfer per vmsplice call</span></span><br><span class="line"><span class="string">      --vm-splice-ops N     stop after N bogo splice operations</span></span><br><span class="line"><span class="string">      --wait N              start N workers waiting on child being</span></span><br><span class="line"><span class="string">                            stop/resumed</span></span><br><span class="line"><span class="string">      --wait-ops N          stop after N bogo wait operations</span></span><br><span class="line"><span class="string">      --watchdog N          start N workers that exercise /dev/watchdog</span></span><br><span class="line"><span class="string">      --watchdog-ops N      stop after N bogo watchdog operations</span></span><br><span class="line"><span class="string">      --wcs N               start N workers on lib C wide char string</span></span><br><span class="line"><span class="string">                            functions</span></span><br><span class="line"><span class="string">      --wcs-method func     specify the wide character string function to</span></span><br><span class="line"><span class="string">                            stress</span></span><br><span class="line"><span class="string">      --wcs-ops N           stop after N bogo wide character string</span></span><br><span class="line"><span class="string">                            operations</span></span><br><span class="line"><span class="string">      --x86syscall N        start N workers exercising functions using</span></span><br><span class="line"><span class="string">                            syscall</span></span><br><span class="line"><span class="string">      --x86syscall-func F   use just syscall function F</span></span><br><span class="line"><span class="string">      --x86syscall-ops N    stop after N syscall function calls</span></span><br><span class="line"><span class="string">      --xattr N             start N workers stressing file extended</span></span><br><span class="line"><span class="string">                            attributes</span></span><br><span class="line"><span class="string">      --xattr-ops N         stop after N bogo xattr operations</span></span><br><span class="line"><span class="string">-y N, --yield N             start N workers doing sched_yield() calls</span></span><br><span class="line"><span class="string">      --yield-ops N         stop after N bogo yield operations</span></span><br><span class="line"><span class="string">      --zero N              start N workers reading /dev/zero</span></span><br><span class="line"><span class="string">      --zero-ops N          stop after N /dev/zero bogo read operations</span></span><br><span class="line"><span class="string">      --zlib N              start N workers compressing data with zlib</span></span><br><span class="line"><span class="string">      --zlib-level L        specify zlib compression level 0=fast, 9=best</span></span><br><span class="line"><span class="string">      --zlib-mem-level L    specify zlib compression state memory usage</span></span><br><span class="line"><span class="string">                            1=minimum, 9=maximum</span></span><br><span class="line"><span class="string">      --zlib-method M       specify zlib random data generation method M</span></span><br><span class="line"><span class="string">      --zlib-ops N          stop after N zlib bogo compression operations</span></span><br><span class="line"><span class="string">      --zlib-strategy S     specify zlib strategy 0=default, 1=filtered,</span></span><br><span class="line"><span class="string">                            2=huffman only, 3=rle, 4=fixed</span></span><br><span class="line"><span class="string">      --zlib-stream-bytes S specify the number of bytes to deflate until the</span></span><br><span class="line"><span class="string">                            current stream will be closed</span></span><br><span class="line"><span class="string">      --zlib-window-bits W  specify zlib window bits -8-(-15) | 8-15 | 24-31</span></span><br><span class="line"><span class="string">                            | 40-47</span></span><br><span class="line"><span class="string">      --zombie N            start N workers that rapidly create and reap</span></span><br><span class="line"><span class="string">                            zombies</span></span><br><span class="line"><span class="string">      --zombie-max N        set upper limit of N zombies per worker</span></span><br><span class="line"><span class="string">      --zombie-ops N        stop after N bogo zombie fork operations</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Example: stress-ng --cpu 8 --io 4 --vm 2 --vm-bytes 128M --fork 4 --timeout 10s</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Note: Sizes can be suffixed with B,K,M,G and times with s,m,h,d,y</span></span><br></pre></td></tr></table></figure>

<h2 id="容器的内存限制"><a href="#容器的内存限制" class="headerlink" title="容器的内存限制"></a>容器的内存限制</h2><p>Docker 可以强制执行硬性内存限制，即只允许容器使用给定的内存大小。 </p>
<p>Docker 也可以执行非硬性内存限制，即容器可以使用尽可能多的内存，除非内核检测到主机上的内存不够用了</p>
<h3 id="内存相关选项"><a href="#内存相关选项" class="headerlink" title="内存相关选项"></a>内存相关选项</h3><p>官文文档: <a target="_blank" rel="noopener" href="https://docs.docker.com/config/containers/resource_constraints/">https://docs.docker.com/config/containers/resource_constraints/</a> </p>
<p>以下设置大部分的选项取正整数，跟着一个后缀 b ， k ， m ， g ，表示字节，千字节，兆字节或千兆字节</p>
<table>
<thead>
<tr>
<th>选项</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>-m ， –memory=</td>
<td>容器可以使用的最大物理内存量，硬限制，此选项最小允许值为 4m （4 MB），此项较常用</td>
</tr>
<tr>
<td>–memory-swap</td>
<td>允许此容器交换到磁盘的内存量,必须先用-m 对内存限制才可以使用,详细说明如下</td>
</tr>
<tr>
<td>–memory-swappiness</td>
<td>设置容器使用交换分区的倾向性，值越高表示越倾向于使用swap分区，范围为0-100，0为能不用就不用，100为能用就用，N表示内存使用率达到N%时，就会使用swap空间</td>
</tr>
<tr>
<td>–memory-reservation</td>
<td>允许指定小于 –memory 的软限制 ，当 Docker 检测到主机上的争用或内存不足时会激活该限制，如果使– memory-reservation，则必须将其设置为低于 –memory 才能使其优先生效。 因为它是软限制，所以不能保证容器不超过限制</td>
</tr>
<tr>
<td>–kernel-memory</td>
<td>容器可以使用的最大内核内存量，最小为 4m，由于内核内存与用户空间内存隔离，因此无法与用户空间内存直接交换，因此内核内存不足的容器可能会阻塞宿主机资源，这会对主机和其他容器或者其他服务进程产生影响，因此不建议设置内核内存大小</td>
</tr>
<tr>
<td>–oom-kill-disable</td>
<td>默认情况下，如果发生内存不足（OOM）错误，则内核将终止容器中的进程。要更改此行为，请使用该 –oom-kill-disable 选项。建议仅在设置了该 -m/–memory 选项的容器上禁用OOM。如果 -m 未设置该标志，则主机可能会用完内存，内核可能需要终止主机系统的进程以释放内存</td>
</tr>
</tbody></table>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@ubuntu1804 ~]<span class="comment"># docker run -e MYSQL_ROOT_PASSWORD=123456 -it --rm -m 1g --oom-kill-disable mysql:5.7.30</span></span><br><span class="line">2020-02-04 13:11:54+00:00 [Note] [Entrypoint]: Entrypoint script <span class="keyword">for</span> MySQL Server 5.7.29-1debian9 started.</span><br><span class="line">2020-02-04 13:11:54+00:00 [Note] [Entrypoint]: Switching to dedicated user <span class="string">&#x27;mysql&#x27;</span></span><br><span class="line">2020-02-04 13:11:54+00:00 [Note] [Entrypoint]: Entrypoint script <span class="keyword">for</span> MySQL Server 5.7.29-1debian9 started.</span><br><span class="line">2020-02-04 13:11:54+00:00 [Note] [Entrypoint]: Initializing database files</span><br><span class="line">......</span><br><span class="line">Version: <span class="string">&#x27;5.7.29&#x27;</span> socket: <span class="string">&#x27;/var/run/mysqld/mysqld.sock&#x27;</span> port: 3306 MySQL </span><br><span class="line">Community Server (GPL)</span><br></pre></td></tr></table></figure>

<p>范例:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@ubuntu1804 ~]<span class="comment"># sysctl -a |grep swappiness</span></span><br><span class="line">sysctl: reading key <span class="string">&quot;net.ipv6.conf.all.stable_secret&quot;</span></span><br><span class="line">sysctl: reading key <span class="string">&quot;net.ipv6.conf.default.stable_secret&quot;</span></span><br><span class="line">sysctl: reading key <span class="string">&quot;net.ipv6.conf.docker0.stable_secret&quot;</span></span><br><span class="line">sysctl: reading key <span class="string">&quot;net.ipv6.conf.eth0.stable_secret&quot;</span></span><br><span class="line">sysctl: reading key <span class="string">&quot;net.ipv6.conf.lo.stable_secret&quot;</span></span><br><span class="line">vm.swappiness = 60</span><br></pre></td></tr></table></figure>

<h3 id="swap限制"><a href="#swap限制" class="headerlink" title="swap限制"></a>swap限制</h3><p><strong>kubernets 对swap的要求</strong></p>
<p>K8s 1.8.3更新日志:  宿主机开启交换分区，会在安装之前的预检查环节提示相应错误信息: <a target="_blank" rel="noopener" href="https://github.com/kubernetes/kubernetes/blob/release-.8/CHANGELOG-1.8.md">https://github.com/kubernetes/kubernetes/blob/release-.8/CHANGELOG-1.8.md</a></p>
<p><img src="../../../../images/SRE/day46/143.jpg" alt="143"></p>
<p>docker run 命令可以使用–memory-swap 选项控制swap的使用</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">--memory-swap <span class="comment">#只有在设置了 --memory 后才会有意义。使用 Swap,可以让容器将超出限制部分的内存置换到磁盘上，WARNING: 经常将内存交换到磁盘的应用程序会降低性能</span></span><br></pre></td></tr></table></figure>

<p>**不同的–memory-swap 设置会产生不同的效果: **</p>
<table>
<thead>
<tr>
<th>–memory-swap</th>
<th>–memory</th>
<th>功能</th>
</tr>
</thead>
<tbody><tr>
<td>正数S</td>
<td>正数M</td>
<td>容器可用内存总空间为S,其中ram为M,swap为 S-M,若S=M,则无可用swap资源</td>
</tr>
<tr>
<td>0</td>
<td>正数M</td>
<td>相当于未设置swap(unset)</td>
</tr>
<tr>
<td>unset</td>
<td>正数M</td>
<td>若主机(Docker Host) 启用于swap , 则容器的可用swap 为2*M</td>
</tr>
<tr>
<td>-1</td>
<td>正数M</td>
<td>若主机(Docker Host)启用了swap ,则容器可使用最大至主机上所有swap空间</td>
</tr>
</tbody></table>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">-memory-swap     <span class="comment">#值为正数， 那么--memory 和--memory-swap 都必须要设置，--memory-swap 表示</span></span><br><span class="line">                  你能使用的内存和 swap 分区大小的总和，例如:   --memory=300m, --memory-swap=1g,</span><br><span class="line">                  那么该容器能够使用 300m 物理内存和 700m swap，即--memory 是实际物理内存大小值不变，</span><br><span class="line">                  而 swap 的实际大小计算方式为(--memory-swap)-(--memory)=容器可用 swap</span><br><span class="line">--memory-swap    <span class="comment">#如果设置为 0，则忽略该设置，并将该值视为未设置，即未设置交换分区</span></span><br><span class="line">--memory-swap    <span class="comment">#如果等于--memory 的值，并且--memory 设置为正整数，容器无权访问 swap </span></span><br><span class="line">-memory-swap     <span class="comment">#如果未设置，如果宿主机开启了 swap，则实际容器的swap 值最大为 2x( --memory)，</span></span><br><span class="line">                  即两倍于物理内存大小，例如，如果--memory=<span class="string">&quot;300m&quot;</span>与--memory-swap没有设置，该容器可</span><br><span class="line">                  以使用300m总的内存和600m交撒空间,但是并不准确(在容器中使用free 命令所看到的 swap 空间 </span><br><span class="line">                  并不精确，毕竟每个容器都可以看到具体大小，宿主机的 swap 是有上限的，而且不是所有容器看到</span><br><span class="line">                  的累计大小)</span><br><span class="line">--memory-swap    <span class="comment">#如果设置为-1，如果宿主机开启了 swap，则容器可以使用主机上 swap 的最大空间</span></span><br></pre></td></tr></table></figure>

<p><strong>注意: 在容器中执行free命令看到的是宿主机的内存和swap使用，而非容器自身的swap使用情况</strong></p>
<p>范例: 在容器中查看内存</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root@ubuntu1804 ~]<span class="comment"># free </span></span><br><span class="line">             total       used       free     shared buff/cache   available</span><br><span class="line">Mem:        3049484      278484     1352932       10384     1418068     2598932</span><br><span class="line">Swap:       1951740           0     1951740</span><br><span class="line"></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment"># docker run -it --rm -m 2G centos:centos7.7.1908 bash</span></span><br><span class="line">[root@f5d387b5022f /]<span class="comment"># free </span></span><br><span class="line">             total       used       free     shared buff/cache   available</span><br><span class="line">Mem:        3049484      310312     1320884       10544     1418288     2566872</span><br><span class="line">Swap:       1951740           0     1951740</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="使用stress-ng测试内存限制"><a href="#使用stress-ng测试内存限制" class="headerlink" title="使用stress-ng测试内存限制"></a>使用stress-ng测试内存限制</h3><p>假如一个容器未做内存使用限制，则该容器可以利用到系统内存最大空间，默认创建的容器没有做内存资源限制。 </p>
<p>范例: 默认一个workers 分配256M内存，2个即占512M内存</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@ubuntu1804 ~]<span class="comment"># docker run --name c1 -it --rm lorel/docker-stress-ng --vm 2 </span></span><br><span class="line"></span><br><span class="line"><span class="comment">#因上一个命令是前台执行，下面在另一个终端窗口中执行，可以看到占用512M左右内存</span></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment">#docker stats </span></span><br><span class="line">CONTAINER ID       NAME               CPU %               MEM USAGE / LIMIT   </span><br><span class="line">MEM %               NET I/O             BLOCK I/O           PIDS</span><br><span class="line">fd184869ff7e       c1                  91.00%              524.3MiB / 962MiB   </span><br><span class="line">54.50%             766B / 0B           860kB / 0B          5</span><br></pre></td></tr></table></figure>

<p>范例: 指定内存最大值</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">[root@ubuntu1804 ~]<span class="comment"># docker run --name c1 -it --rm -m 300m lorel/docker-stress-ng --vm 2 </span></span><br><span class="line"></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment"># vim /etc/default/grub</span></span><br><span class="line">GRUB_CMDLINE_LINUX=<span class="string">&quot;cgroup_enable=memory swapaccount=1 net.ifnames=0&quot;</span></span><br><span class="line"></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment"># update-grub</span></span><br><span class="line">Generating grub configuration file ...</span><br><span class="line">Found linux image: /boot/vmlinuz-4.15.0-29-generic</span><br><span class="line">Found initrd image: /boot/initrd.img-4.15.0-29-generic</span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment"># reboot</span></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment"># docker run --name c1 -it --rm -m 300m lorel/docker-stress-ng --vm 2 </span></span><br><span class="line"></span><br><span class="line"><span class="comment">#在另一个终端窗口执行</span></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment"># docker stats --no-stream</span></span><br><span class="line">CONTAINER ID       NAME               CPU %               MEM USAGE / LIMIT   </span><br><span class="line">MEM %               NET I/O             BLOCK I/O           PIDS</span><br><span class="line">6a93f6b22034       c1                  27.06%              297.2MiB / 300MiB   </span><br><span class="line">99.07%              1.45kB / 0B         4.98GB / 5.44GB     5</span><br></pre></td></tr></table></figure>

<p>范例: </p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[root@ubuntu1804 ~]<span class="comment"># docker run --name c2 -it --rm lorel/docker-stress-ng --vm 4 </span></span><br><span class="line">stress-ng: info: [1] defaulting to a 86400 second run per stressor</span><br><span class="line">stress-ng: info: [1] dispatching hogs: 4 vm</span><br><span class="line"></span><br><span class="line"><span class="comment">#一次性查看资源使用情况</span></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment"># docker stats --no-stream</span></span><br><span class="line">CONTAINER ID       NAME               CPU %               MEM USAGE / LIMIT   </span><br><span class="line">MEM %               NET I/O             BLOCK I/O           PIDS</span><br><span class="line">fd5fff3c04f7       c2                  21.20%              591.1MiB / 962MiB   </span><br><span class="line">61.45%              1.31kB / 0B         1.07GB / 46.6MB     9</span><br></pre></td></tr></table></figure>

<p>范例: 容器占用内存造成OOM</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">[root@ubuntu1804 ~]<span class="comment"># docker run -it --rm --name c1 lorel/docker-stress-ng --vm 6 </span></span><br><span class="line">stress-ng: info: [1] defaulting to a 86400 second run per stressor</span><br><span class="line">stress-ng: info: [1] dispatching hogs: 6 vm</span><br><span class="line"></span><br><span class="line"><span class="comment">#另一个终端窗中同时执行下面命令</span></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment"># docker run -it --rm --name c2 lorel/docker-stress-ng --vm 6</span></span><br><span class="line">stress-ng: info: [1] defaulting to a 86400 second run per stressor</span><br><span class="line">stress-ng: info: [1] dispatching hogs: 6 vm</span><br><span class="line"></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment"># docker stats </span></span><br><span class="line">CONTAINER ID       NAME               CPU %               MEM USAGE / LIMIT   </span><br><span class="line">MEM %               NET I/O             BLOCK I/O           PIDS</span><br><span class="line">f33cebf5b55d       c2                  --                  -- / --             </span><br><span class="line">--                  --                  --                  --</span><br><span class="line">b14b597c5a4f       cool_banach         --                  -- / --             </span><br><span class="line">--                  --                  --                  --</span><br><span class="line"></span><br><span class="line"><span class="comment">#观察日志出现OOM现象</span></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment"># tail /var/log/syslog</span></span><br><span class="line">Feb  4 22:59:40 ubuntu1804 kernel: [  785.928842] Out of memory: Kill process 2570 (stress-ng-vm) score 1090 or sacrifice child</span><br><span class="line">Feb  4 22:59:40 ubuntu1804 kernel: [  785.929493] Killed process 2570 (stress-ng-vm) total-vm:268416kB, anon-rss:170352kB, file-rss:632kB, shmem-rss:28kB</span><br><span class="line">Feb  4 22:59:40 ubuntu1804 kernel: [  786.018319] oom_reaper: reaped process 2570 (stress-ng-vm), now anon-rss:0kB, file-rss:0kB, shmem-rss:28kB</span><br></pre></td></tr></table></figure>

<p>范例: 查看内存限制</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#启动两个工作进程，每个工作进程最大允许使用内存 256M，且宿主机不限制当前容器最大内存</span></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment"># docker run -it --name c1 --rm lorel/docker-stress-ng --vm 2</span></span><br><span class="line">stress-ng: info: [1] defaulting to a 86400 second run per stressor</span><br><span class="line">stress-ng: info: [1] dispatching hogs: 2 vm</span><br><span class="line"></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment"># docker ps -a</span></span><br><span class="line">CONTAINER ID       IMAGE                    COMMAND                 CREATED     </span><br><span class="line">        STATUS             PORTS               NAMES</span><br><span class="line">13e46172e1ae       lorel/docker-stress-ng   <span class="string">&quot;/usr/bin/stress-ng …&quot;</span>   24 seconds </span><br><span class="line">ago     Up 22 seconds                           gallant_moore</span><br><span class="line"></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment"># ls /sys/fs/cgroup/memory/docker/</span></span><br><span class="line">13e46172e1ae8593569f05a3bebc7b41b7839da44369d43b29102661364ac2cd </span><br><span class="line">memory.kmem.tcp.limit_in_bytes     memory.numa_stat</span><br><span class="line">cgroup.clone_children </span><br><span class="line">memory.kmem.tcp.max_usage_in_bytes memory.oom_control</span><br><span class="line">cgroup.event_control </span><br><span class="line">memory.kmem.tcp.usage_in_bytes     memory.pressure_level</span><br><span class="line">cgroup.procs </span><br><span class="line">memory.kmem.usage_in_bytes         memory.soft_limit_in_bytes</span><br><span class="line">memory.failcnt </span><br><span class="line">memory.limit_in_bytes               memory.stat</span><br><span class="line">memory.force_empty </span><br><span class="line">memory.max_usage_in_bytes           memory.swappiness</span><br><span class="line">memory.kmem.failcnt </span><br><span class="line">memory.memsw.failcnt               memory.usage_in_bytes</span><br><span class="line">memory.kmem.limit_in_bytes </span><br><span class="line">memory.memsw.limit_in_bytes         memory.use_hierarchy</span><br><span class="line">memory.kmem.max_usage_in_bytes </span><br><span class="line">memory.memsw.max_usage_in_bytes     notify_on_release</span><br><span class="line">memory.kmem.slabinfo </span><br><span class="line">memory.memsw.usage_in_bytes         tasks</span><br><span class="line">memory.kmem.tcp.failcnt </span><br><span class="line">memory.move_charge_at_immigrate    </span><br><span class="line"></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment"># cat /sys/fs/cgroup/memory/docker/13e46172e1ae8593569f05a3bebc7b41b7839da44369d43b29102661364ac2cd/memory.limit_in_bytes</span></span><br><span class="line">9223372036854771712</span><br><span class="line"></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment"># echo 2^63|bc</span></span><br><span class="line">9223372036854775808</span><br></pre></td></tr></table></figure>

<p>范例: 内存限制200m</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#宿主机限制容器最大内存使用:   </span></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment"># docker run -it --rm --name c1 -m 200M lorel/docker-stress-ng --vm 2 --vm-bytes 256M </span></span><br><span class="line"></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment"># docker stats --no-stream </span></span><br><span class="line">CONTAINER ID       NAME               CPU %               MEM USAGE / LIMIT   </span><br><span class="line">MEM %               NET I/O             BLOCK I/O           PIDS</span><br><span class="line">f69729b2acc1       sleepy_haibt        85.71%             198MiB / 200MiB     </span><br><span class="line">98.98%              1.05kB / 0B         697MB / 60.4GB      5</span><br><span class="line"></span><br><span class="line"><span class="comment">#查看宿主机基于 cgroup 对容器进行内存资源的大小限制</span></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment"># cat /sys/fs/cgroup/memory/docker/f69729b2acc16e032658a4efdab64d21ff97dcb6746d1cef451ed82d5c98a81f/memory.limit_in_bytes</span></span><br><span class="line">209715200</span><br><span class="line"></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment"># echo 209715200/1024/1024|bc</span></span><br><span class="line">200</span><br><span class="line"></span><br><span class="line"><span class="comment">#动态修改内存限制</span></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment"># echo 300*1024*1024|bc</span></span><br><span class="line">314572800</span><br><span class="line"></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment"># echo 314572800 &gt; /sys/fs/cgroup/memory/docker/f69729b2acc16e032658a4efdab64d21ff97dcb6746d1cef451ed82d5c98a81f/memory.limit_in_bytes</span></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment"># cat /sys/fs/cgroup/memory/docker/f69729b2acc16e032658a4efdab64d21ff97dcb6746d1cef451ed82d5c98a81f/memory.limit_in_bytes</span></span><br><span class="line">314572800</span><br><span class="line"></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment"># docker stats --no-stream </span></span><br><span class="line">CONTAINER ID       NAME               CPU %               MEM USAGE / LIMIT   </span><br><span class="line">MEM %               NET I/O             BLOCK I/O           PIDS</span><br><span class="line">f69729b2acc1       sleepy_haibt        76.69%              297.9MiB / 300MiB   </span><br><span class="line">99.31%              1.05kB / 0B         1.11GB / 89.1GB     5</span><br><span class="line"></span><br><span class="line"><span class="comment">#通过echo 命令可以改内存限制的值，但是可以在原基础之上增大内存限制，缩小内存限制会报错write </span></span><br><span class="line">error: Device or resource busy </span><br><span class="line"></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment"># echo 209715200 &gt; /sys/fs/cgroup/memory/docker/f69729b2acc16e032658a4efdab64d21ff97dcb6746d1cef451ed82d5c98a81f/memory.limit_in_bytes</span></span><br><span class="line">-bash: <span class="built_in">echo</span>: write error: Device or resource busy</span><br><span class="line"></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment"># cat /sys/fs/cgroup/memory/docker/f69729b2acc16e032658a4efdab64d21ff97dcb6746d1cef451ed82d5c98a81f/memory.limit_in_bytes</span></span><br><span class="line">314572800</span><br></pre></td></tr></table></figure>

<p>范例: 内存大小软限制</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">[root@ubuntu1804 ~]<span class="comment"># docker run -it --rm -m 256m --memory-reservation 128m --name c1 lorel/docker-stress-ng --vm 2 --vm-bytes 256M </span></span><br><span class="line">stress-ng: info: [1] defaulting to a 86400 second run per stressor</span><br><span class="line">stress-ng: info: [1] dispatching hogs: 2 vm</span><br><span class="line"></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment"># docker stats --no-stream </span></span><br><span class="line">CONTAINER ID       NAME               CPU %               MEM USAGE / LIMIT   </span><br><span class="line">MEM %               NET I/O             BLOCK I/O           PIDS</span><br><span class="line">aeb38acde581       c1           72.45%              253.9MiB / 256MiB   99.20% </span><br><span class="line">            976B / 0B           9.47GB / 39.4GB     5</span><br><span class="line"></span><br><span class="line"><span class="comment">#查看硬限制</span></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment"># cat /sys/fs/cgroup/memory/docker/aeb38acde58155d421f998a54e9a99ab60635fe00c9070da050cc49a2f62d274/memory.limit_in_bytes </span></span><br><span class="line">268435456</span><br><span class="line"></span><br><span class="line"><span class="comment">#查看软限制</span></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment"># cat /sys/fs/cgroup/memory/docker/aeb38acde58155d421f998a54e9a99ab60635fe00c9070da050cc49a2f62d274/memory.soft_limit_in_bytes </span></span><br><span class="line">134217728</span><br><span class="line"></span><br><span class="line"><span class="comment">#软限制不能高于硬限制</span></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment"># docker run -it --rm --name c1 -m 256m --memory-reservation 257m --name c1 lorel/docker-stress-ng --vm 2 --vm-bytes 256M </span></span><br><span class="line">docker: Error response from daemon: Minimum memory <span class="built_in">limit</span> can not be less than memory reservation <span class="built_in">limit</span>, see usage.</span><br><span class="line">See <span class="string">&#x27;docker run --help&#x27;</span>.</span><br></pre></td></tr></table></figure>

<p><strong>关闭OOM 机制:</strong></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># docker run -it --rm -m 256m --oom-kill-disable --name c1 lorel/docker-stress-ng --vm 2 --vm-bytes 256M </span></span><br><span class="line"><span class="comment"># cat /sys/fs/cgroup/memory/docker/容器 ID/memory.oom_control </span></span><br><span class="line">oom_kill_disable 1</span><br><span class="line">under_oom 1</span><br><span class="line">oom_kill 0</span><br></pre></td></tr></table></figure>

<p>范例: 关闭OOM机制</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#查看docker OOM机制默认值</span></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment"># cat /sys/fs/cgroup/memory/docker/memory.oom_control </span></span><br><span class="line">oom_kill_disable 0</span><br><span class="line">under_oom 0</span><br><span class="line">oom_kill 0</span><br><span class="line"></span><br><span class="line"><span class="comment">#启动容器时关闭OOM机制</span></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment"># docker run -it --rm -m 200m --name c1 --oom-kill-disable   lorel/docker-stress-ng --vm 2 --vm-bytes 256M </span></span><br><span class="line">stress-ng: info: [1] defaulting to a 86400 second run per stressor</span><br><span class="line">stress-ng: info: [1] dispatching hogs: 2 vm</span><br><span class="line"></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment"># docker stats --no-stream </span></span><br><span class="line">CONTAINER ID       NAME               CPU %               MEM USAGE / LIMIT   </span><br><span class="line">MEM %               NET I/O             BLOCK I/O           PIDS</span><br><span class="line">b655d88228c0       silly_borg          0.00%               197.2MiB / 200MiB   </span><br><span class="line">98.58%              1.31kB / 0B         1.84MB / 484MB      5</span><br><span class="line"></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment"># cat /sys/fs/cgroup/memory/docker/b655d88228c04d7db6a6ad833ed3d05d4cd596ef09834382e17942db0295dc0c/memory.oom_control </span></span><br><span class="line">oom_kill_disable 1</span><br><span class="line">under_oom 1</span><br><span class="line">oom_kill 0</span><br></pre></td></tr></table></figure>

<p>**交换分区限制: **</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># docker run -it --rm -m 256m --memory-swap 512m --name c1 centos bash </span></span><br><span class="line"></span><br><span class="line"><span class="comment"># cat /sys/fs/cgroup/memory/docker/容器 ID/memory.memsw.limit_in_bytes </span></span><br><span class="line">536870912 <span class="comment">#返回值</span></span><br></pre></td></tr></table></figure>

<p>范例: </p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@ubuntu1804 ~]<span class="comment">#docker run -it --rm --name c1 -m 200m --memory-swap 512m lorel/docker-stress-ng --vm 2 </span></span><br><span class="line">stress-ng: info: [1] defaulting to a 86400 second run per stressor</span><br><span class="line">stress-ng: info: [1] dispatching hogs: 2 vm</span><br><span class="line"></span><br><span class="line"><span class="comment">#宿主机cgroup验证:   </span></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment">#cat /sys/fs/cgroup/memory/docker/23733a0cafa21f3e94ca8c96110978b12e53076261f1b92fd2052bafe659c8ab/memory.memsw.limit_in_bytes </span></span><br><span class="line">536870912</span><br></pre></td></tr></table></figure>

<h2 id="容器的-CPU-限制"><a href="#容器的-CPU-限制" class="headerlink" title="容器的 CPU 限制"></a>容器的 CPU 限制</h2><h3 id="容器的-CPU-限制介绍"><a href="#容器的-CPU-限制介绍" class="headerlink" title="容器的 CPU 限制介绍"></a>容器的 CPU 限制介绍</h3><p>官方文档说明: <a target="_blank" rel="noopener" href="https://docs.docker.com/config/containers/resource_constraints/">https://docs.docker.com/config/containers/resource_constraints/</a> </p>
<p>一个宿主机，有几十个核心的CPU，但是宿主机上可以同时运行成百上千个不同的进程用以处理不同的任务，多进程共用一个 CPU 的核心为可压缩资源，即一个核心的 CPU 可以通过调度而运行多个进程，但是同一个单位时间内只能有一个进程在 CPU 上运行，那么这么多的进程怎么在 CPU 上执行和调度的呢？</p>
<p>Linux kernel 进程的调度基于CFS(Completely Fair Scheduler)，完全公平调度</p>
<p><strong>服务器资源密集型</strong></p>
<ul>
<li>CPU 密集型的场景: 计算密集型任务的特点是要进行大量的计算，消耗CPU 资源，比如计算圆周率、数据处理、对视频进行高清解码等等，全靠CPU 的运算能力。</li>
<li>IO 密集型的场景: 涉及到网络、磁盘IO 的任务都是IO 密集型任务，这类任务的特点是 CPU 消耗很少，任务的大部分时间都在等待 IO 操作完成（因为 IO 的速度远远低于 CPU 和内存的速度），比如 Web 应用，高并发，数据量大的动态网站来说，数据库应该为IO 密集型</li>
</ul>
<p><strong>CFS原理</strong></p>
<p>cfs定义了进程调度的新模型，它给cfs_rq（cfs的run queue）中的每一个进程安排一个虚拟时钟vruntime。如果一个进程得以执行，随着时间的增长，其vruntime将不断增大。没有得到执行的进程vruntime不变, 而调度器总是选择vruntime跑得最慢的那个进程来执行。这就是所谓的“完全公平”。为了区别不同优先级的进程，优先级高的进程vruntime增长得慢，以至于它可能得到更多的运行机会。CFS的意义在于， 在一个混杂着大量计算型进程和IO交互进程的系统中，CFS调度器相对其它调度器在对待IO交互进程要更加友善和公平。</p>
<h3 id="配置默认的CFS调度程序"><a href="#配置默认的CFS调度程序" class="headerlink" title="配置默认的CFS调度程序"></a>配置默认的CFS调度程序</h3><p>默认情况下，每个容器对主机的CPU周期的访问都是不受限制的。可以设置各种约束，以限制给定容器对主机CPU周期的访问。大多数用户使用并配置默认的CFS调度程序。在Docker 1.13及更高版本中，还可以配置 realtime scheduler。</p>
<p>CFS是用于常规Linux进程的Linux内核CPU调度程序。通过几个运行时标志,可以配置对容器拥有的CPU资源的访问量。使用这些设置时，Docker会在主机上修改容器cgroup的设置。</p>
<table>
<thead>
<tr>
<th>选项</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>–cpus=</td>
<td>指定一个容器可以使用多少个可用的CPU核心资源。例如，如果主机有两个CPU，如果设置了 –cpus=”1.5” ，则可以保证容器最多使用1.5个的CPU(如果是4核CPU，那么还可以是4核心上每核用一点，但是总计是1.5核心的CPU)。这相当于设置 –cpu-period=”100000” 和 –cpu-quota=”150000” 。此设置可在Docker 1.13及更高版本中可用，目的是替代–cpu-period和–cpu-quota两个参数，从而使配置更简单，但是最大不能超出宿主机的CPU总核心数(在操作系统看到的CPU超线程后的数值)，此项较常用</td>
</tr>
<tr>
<td>–cpu-period=</td>
<td>过时选项,指定CPU CFS调度程序周期，必须与 –cpu-quota 一起使用 。默认为100微秒。大多数用户不会更改默认设置。如果使用Docker 1.13或更高版本，请改用 –cpus</td>
</tr>
<tr>
<td>–cpu-quota=</td>
<td>过时选项,在容器上添加 CPU CFS 配额，计算方式为 cpu-quota / cpu-period的结果值，docker1.13 及以上版本通常使用–cpus 设置此值</td>
</tr>
<tr>
<td>–cpuset-cpus</td>
<td>用于指定容器运行的 CPU 编号，也就是所谓的CPU绑定。如果一个或多个CPU，则容器可以使用逗号分隔的列表或用连字符分隔的CPU范围。第一个CPU的编号为0。有效值可能是 0-3 （使用第一，第二，第三和第四CPU）或 1,3（使用第二和第四CPU）</td>
</tr>
<tr>
<td>–cpu-shares</td>
<td>用于设置 cfs 中调度的相对最大比例权重,cpu-share 的值越高的容器，将会分得更多的时间片(宿主机多核 CPU 总数为 100%，假如容器 A 为1024，容器 B为 2048，那么容器 B 将最大是容器 A 的可用 CPU 的两倍 )，默认的时间片1024，最大 262144。这是一个软限制。注意:进程数要多个CPU的核数才能看到效果，此值不能设置太小</td>
</tr>
</tbody></table>
<h3 id="使用-Stress-ng-测试-Cpu-配置"><a href="#使用-Stress-ng-测试-Cpu-配置" class="headerlink" title="使用 Stress-ng 测试 Cpu 配置"></a>使用 Stress-ng 测试 Cpu 配置</h3><p>范例: 查看 stress-n 关于cpu的帮助</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@ubuntu1804 ~]<span class="comment">#docker run -it --rm --name c1 lorel/docker-stress-ng |grep cpu</span></span><br><span class="line">-c N, --cpu N            start N workers spinning on sqrt(rand())</span><br><span class="line">       --cpu-ops N        stop when N cpu bogo operations completed</span><br><span class="line">-l P, --cpu-load P       load CPU by P %%, 0=<span class="built_in">sleep</span>, 100=full load (see -c)</span><br><span class="line">       --cpu-method m     specify stress cpu method m, default is all</span><br><span class="line">Example: stress-ng --cpu 8 --io 4 --vm 2 --vm-bytes 128M --fork 4 --<span class="built_in">timeout</span> 10s</span><br></pre></td></tr></table></figure>

<p>范例: 不限制容器CPU</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">[root@ubuntu1804 ~]<span class="comment"># lscpu |grep CPU</span></span><br><span class="line">CPU op-mode(s):      32-bit, 64-bit</span><br><span class="line">CPU(s):              6</span><br><span class="line">On-line CPU(s) list: 0-5</span><br><span class="line">CPU family:          6</span><br><span class="line">Model name:         Intel(R) Core(TM) i7-4710HQ CPU @ 2.50GHz</span><br><span class="line">CPU MHz:             2494.236</span><br><span class="line">NUMA node0 CPU(s):   0-5</span><br><span class="line"></span><br><span class="line"><span class="comment">#占用4个CPU资源.但只是平均的使用CPU资源</span></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment"># docker run -it --rm --name c1 lorel/docker-stress-ng --cpu 4 </span></span><br><span class="line">stress-ng: info: [1] defaulting to a 86400 second run per stressor</span><br><span class="line">stress-ng: info: [1] dispatching hogs: 4 cpu, 4 vm</span><br><span class="line"></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment"># docker stats --no-stream </span></span><br><span class="line">CONTAINER ID       NAME               CPU %               MEM USAGE / LIMIT     </span><br><span class="line">MEM %               NET I/O             BLOCK I/O           PIDS</span><br><span class="line">818a85e1da2f       frosty_taussig      595.57%             1.037GiB / 2.908GiB </span><br><span class="line">  35.64%              1.12kB / 0B         0B / 0B             13</span><br><span class="line">  </span><br><span class="line">[root@ubuntu1804 ~]<span class="comment"># cat /sys/fs/cgroup/cpuset/docker/818a85e1da2f9a4ef297178a9dc09b338b2308108195ad8d4197a1c47febcbff/cpuset.cpus</span></span><br><span class="line">0-5</span><br><span class="line"></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment"># top</span></span><br></pre></td></tr></table></figure>

<p><img src="../../../../images/SRE/day46/144.jpg" alt="144"></p>
<p>范例: 限制使用CPU</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root@ubuntu1804 ~]<span class="comment"># docker run -it --rm --name c1 --cpus 1.5 lorel/docker-stress-ng --cpu 4 </span></span><br><span class="line">stress-ng: info: [1] defaulting to a 86400 second run per stressor</span><br><span class="line">stress-ng: info: [1] dispatching hogs: 4 cpu, 4 vm</span><br><span class="line"></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment"># docker stats --no-stream </span></span><br><span class="line">CONTAINER ID       NAME               CPU %               MEM USAGE / LIMIT     </span><br><span class="line">MEM %               NET I/O             BLOCK I/O           PIDS</span><br><span class="line">9f8b2e693113       busy_hodgkin        147.71%             786.8MiB / 2.908GiB </span><br><span class="line">  26.42%             836B / 0B           0B / 0B             13</span><br><span class="line">  </span><br><span class="line">[root@ubuntu1804 ~]<span class="comment"># top</span></span><br></pre></td></tr></table></figure>

<p><img src="../../../../images/SRE/day46/145.jpg" alt="145"></p>
<p>范例: 限制CPU</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@ubuntu1804 ~]<span class="comment"># docker run -it --rm --name c1 --cpu-quota 2000 --cpu-period 1000 lorel/docker-stress-ng --cpu 4 </span></span><br><span class="line">stress-ng: info: [1] defaulting to a 86400 second run per stressor</span><br><span class="line">stress-ng: info: [1] dispatching hogs: 4 cpu, 4 vm</span><br><span class="line"></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment"># docker stats --no-stream </span></span><br><span class="line">CONTAINER ID       NAME                     CPU %               MEM USAGE / </span><br><span class="line">LIMIT     MEM %               NET I/O             BLOCK I/O           PIDS</span><br><span class="line">bd949bb6698e       affectionate_chebyshev   185.03%             1.037GiB / </span><br><span class="line">2.908GiB   35.64%             836B / 0B           0B / 0B             13</span><br></pre></td></tr></table></figure>

<p>范例: 绑定CPU</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#一般不建议绑在0号CPU上，因0号CPU一般会较忙</span></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment"># docker run -it --rm --name c1 --cpus 1.5 --cpuset-cpus 2,4-5 lorel/docker-stress-ng --cpu 4 </span></span><br><span class="line">stress-ng: info: [1] defaulting to a 86400 second run per stressor</span><br><span class="line">stress-ng: info: [1] dispatching hogs: 4 cpu, 4 vm</span><br><span class="line"></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment"># ps axo pid,cmd,psr |grep stress</span></span><br><span class="line">   1964 /usr/bin/stress-ng --cpu 4    2</span><br><span class="line">   1996 /usr/bin/stress-ng --cpu 4    5</span><br><span class="line">   1997 /usr/bin/stress-ng --cpu 4    2</span><br><span class="line">   1998 /usr/bin/stress-ng --cpu 4    4</span><br><span class="line">   1999 /usr/bin/stress-ng --cpu 4    2</span><br><span class="line">   2002 grep --color=auto stress      1</span><br><span class="line"></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment"># docker stats --no-stream </span></span><br><span class="line">CONTAINER ID       NAME               CPU %               MEM USAGE / LIMIT     </span><br><span class="line">MEM %               NET I/O             BLOCK I/O           PIDS</span><br><span class="line">585879094e73       hungry_albattani    154.35%             1.099GiB / 2.908GiB </span><br><span class="line">  37.79%             906B / 0B           0B / 0B             13</span><br><span class="line">  </span><br><span class="line">[root@ubuntu1804 ~]<span class="comment"># cat /sys/fs/cgroup/cpuset/docker/585879094e7382d2ef700947b4454426eee7f943f8d1438fe42ce34df789227b/cpuset.cpus </span></span><br><span class="line">2,4-5</span><br><span class="line"></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment"># top</span></span><br></pre></td></tr></table></figure>

<p><img src="../../../../images/SRE/day46/146.jpg" alt="146"></p>
<p>范例: 多个容器的CPU利用率比例</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#同时开两个容器</span></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment"># docker run -it --rm --name c1 --cpu-shares 1000 lorel/docker-stress-ng --cpu 4 </span></span><br><span class="line">stress-ng: info: [1] defaulting to a 86400 second run per stressor</span><br><span class="line">stress-ng: info: [1] dispatching hogs: 4 cpu, 4 vm</span><br><span class="line"></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment"># docker run -it --rm --name c2 --cpu-shares 500 lorel/docker-stress-ng --cpu 4 </span></span><br><span class="line">stress-ng: info: [1] defaulting to a 86400 second run per stressor</span><br><span class="line">stress-ng: info: [1] dispatching hogs: 4 cpu, 4 vm</span><br><span class="line"></span><br><span class="line"><span class="comment">#注意:进程数要多于CPU的核数才能看到效果,如果两个容器使用的CPU总数不超过CPU实际的核心数，两个容器都显示400%</span></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment"># docker stats --no-stream </span></span><br><span class="line">CONTAINER ID       NAME               CPU %               MEM USAGE / LIMIT     </span><br><span class="line">MEM %               NET I/O             BLOCK I/O           PIDS</span><br><span class="line">a1d4c6e6802d       c2                  195.88%             925.3MiB / 2.908GiB </span><br><span class="line">  31.07%             726B / 0B           0B / 0B             13</span><br><span class="line">d5944104aff4       c1                  398.20%             1.036GiB / 2.908GiB </span><br><span class="line">  35.64%             906B / 0B           0B / 0B             13</span><br><span class="line"></span><br><span class="line"><span class="comment">#查看c1容器的cpu利用比例</span></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment"># cat /sys/fs/cgroup/cpu,cpuacct/docker/d5944104aff40b7b76f536c45a68cd4b98ce466a73416b68819b9643e3f49da7/cpu.shares </span></span><br><span class="line">1000</span><br><span class="line"></span><br><span class="line"><span class="comment">#查看c2容器的cpu利用比例</span></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment"># cat /sys/fs/cgroup/cpu,cpuacct/docker/a1d4c6e6802d1b846b33075f3c1e1696376009e85d9ff8756f9a8d93d3da3ca6/cpu.shares </span></span><br><span class="line">500</span><br><span class="line"></span><br><span class="line"><span class="comment">#再打开新的容器，cpu分配比例会动态调整</span></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment"># docker run -it --rm --name c3 --cpu-shares 2000 lorel/docker-stress-ng --cpu 4 </span></span><br><span class="line"></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment"># docker stats --no-stream </span></span><br><span class="line">CONTAINER ID       NAME               CPU %               MEM USAGE / LIMIT     </span><br><span class="line">MEM %               NET I/O             BLOCK I/O           PIDS</span><br><span class="line">c2d54818e1fe       c3                  360.15%             664.5MiB / 2.908GiB </span><br><span class="line">  22.31%             726B / 0B           1.64GB / 150MB      13</span><br><span class="line">a1d4c6e6802d       c2                  82.94%              845.2MiB / 2.908GiB </span><br><span class="line">  28.38%             936B / 0B           103MB / 4.54MB      13</span><br><span class="line">d5944104aff4       c1                  181.18%             930.1MiB / 2.908GiB </span><br><span class="line">  31.23%              1.12kB / 0B         303MB / 19.8MB      13</span><br></pre></td></tr></table></figure>

<p>范例: 动态调整cpu shares值</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@ubuntu1804 ~]<span class="comment"># echo 2000 &gt; /sys/fs/cgroup/cpu,cpuacct/docker/a1d4c6e6802d1b846b33075f3c1e1696376009e85d9ff8756f9a8d93d3da3ca6/cpu.shares</span></span><br><span class="line"></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment"># docker stats --no-stream </span></span><br><span class="line">CONTAINER ID       NAME               CPU %               MEM USAGE / LIMIT     </span><br><span class="line">MEM %               NET I/O             BLOCK I/O           PIDS</span><br><span class="line">a1d4c6e6802d       c2                  389.31%             1.037GiB / 2.908GiB </span><br><span class="line">  35.64%              1.01kB / 0B         1.16GB / 14MB       13</span><br><span class="line">d5944104aff4       c1                  200.28%             1.036GiB / 2.908GiB </span><br><span class="line">  35.63%              1.19kB / 0B         2.66GB / 26.7MB     13</span><br></pre></td></tr></table></figure>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="http://example.com">૮(˶ᵔ ᵕ ᵔ˶)ა</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="http://example.com/2025/04/13/SRE-docker/">http://example.com/2025/04/13/SRE-docker/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="http://example.com" target="_blank">૮(˶ᵔ ᵕ ᵔ˶)ა</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/Docker/">Docker</a><a class="post-meta__tags" href="/tags/SRE/">SRE</a></div><div class="post_share"><div class="social-share" data-image="/../images/SRE/day46/1.jpg" data-sites="wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2025/04/01/SRE-kvm/" title="企业级Linux虚拟化KVM"><img class="cover" src="/../images/SRE/day41/21.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">企业级Linux虚拟化KVM</div></div></a></div><div class="next-post pull-right"><a href="/2025/04/15/SRE-HAProxy/" title="高可用性集群HAProxy"><img class="cover" src="/../images/SRE/day47/1.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">高可用性集群HAProxy</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><div><a href="/2023/06/29/DN-Docker/" title="Docker"><img class="cover" src="/../images/TITLE/docker.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-06-29</div><div class="title">Docker</div></div></a></div><div><a href="/2024/10/12/ST-docker-push/" title="一键 docker 打标签 &amp; 上传到 Harbor"><img class="cover" src="/../images/TITLE/docker-sh.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-10-12</div><div class="title">一键 docker 打标签 &amp; 上传到 Harbor</div></div></a></div><div><a href="/2025/04/15/SRE-HAProxy/" title="高可用性集群HAProxy"><img class="cover" src="/../images/SRE/day47/1.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2025-04-15</div><div class="title">高可用性集群HAProxy</div></div></a></div><div><a href="/2025/04/16/SRE-Keepalived/" title="高可用性集群Keepalived"><img class="cover" src="/../images/SRE/day48/1.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2025-04-16</div><div class="title">高可用性集群Keepalived</div></div></a></div><div><a href="/2025/02/21/SRE-LVS/" title="企业级调度器LVS"><img class="cover" src="/../images/SRE/day27/3.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2025-02-21</div><div class="title">企业级调度器LVS</div></div></a></div><div><a href="/2024/08/27/SRE-Linux%E6%96%87%E4%BB%B6%E7%AE%A1%E7%90%86%E5%92%8CIO%E9%87%8D%E5%AE%9A%E5%90%91/" title="Linux文件管理和IO重定向"><img class="cover" src="/../images/TITLE/linux3.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-08-27</div><div class="title">Linux文件管理和IO重定向</div></div></a></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="/../images/TITLE/user.webp" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">૮(˶ᵔ ᵕ ᵔ˶)ა</div><div class="author-info__description">这家伙很勤奋，什么都留下了</div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">97</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">37</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">30</div></a></div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content is-expand"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Docker-%E4%BB%8B%E7%BB%8D%E5%92%8C%E5%9F%BA%E7%A1%80%E6%93%8D%E4%BD%9C"><span class="toc-number">1.</span> <span class="toc-text">Docker 介绍和基础操作</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Docker-%E4%BB%8B%E7%BB%8D"><span class="toc-number">1.1.</span> <span class="toc-text">Docker 介绍</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%B9%E5%99%A8%E5%8E%86%E5%8F%B2"><span class="toc-number">1.1.1.</span> <span class="toc-text">容器历史</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Docker-%E6%98%AF%E4%BB%80%E4%B9%88"><span class="toc-number">1.1.2.</span> <span class="toc-text">Docker 是什么</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Docker-%E5%92%8C%E8%99%9A%E6%8B%9F%E6%9C%BA%EF%BC%8C%E7%89%A9%E7%90%86%E4%B8%BB%E6%9C%BA"><span class="toc-number">1.1.3.</span> <span class="toc-text">Docker 和虚拟机，物理主机</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Docker-%E7%9A%84%E7%BB%84%E6%88%90"><span class="toc-number">1.1.4.</span> <span class="toc-text">Docker 的组成</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Namespace"><span class="toc-number">1.1.5.</span> <span class="toc-text">Namespace</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Control-groups"><span class="toc-number">1.1.6.</span> <span class="toc-text">Control groups</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%B9%E5%99%A8%E7%AE%A1%E7%90%86%E5%B7%A5%E5%85%B7"><span class="toc-number">1.1.7.</span> <span class="toc-text">容器管理工具</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#LXC"><span class="toc-number">1.1.7.1.</span> <span class="toc-text">LXC</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#docker"><span class="toc-number">1.1.7.2.</span> <span class="toc-text">docker</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#pouch"><span class="toc-number">1.1.7.3.</span> <span class="toc-text">pouch</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Podman"><span class="toc-number">1.1.7.4.</span> <span class="toc-text">Podman</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Docker-%E7%9A%84%E4%BC%98%E5%8A%BF"><span class="toc-number">1.1.8.</span> <span class="toc-text">Docker 的优势</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Docker-%E7%9A%84%E7%BC%BA%E7%82%B9"><span class="toc-number">1.1.9.</span> <span class="toc-text">Docker 的缺点</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%B9%E5%99%A8%E7%9A%84%E7%9B%B8%E5%85%B3%E6%8A%80%E6%9C%AF"><span class="toc-number">1.1.10.</span> <span class="toc-text">容器的相关技术</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%B9%E5%99%A8%E8%A7%84%E8%8C%83"><span class="toc-number">1.1.10.1.</span> <span class="toc-text">容器规范</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%B9%E5%99%A8-runtime"><span class="toc-number">1.1.10.2.</span> <span class="toc-text">容器 runtime</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%B9%E5%99%A8%E7%AE%A1%E7%90%86%E5%B7%A5%E5%85%B7-1"><span class="toc-number">1.1.10.3.</span> <span class="toc-text">容器管理工具</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%95%9C%E5%83%8F%E4%BB%93%E5%BA%93-Registry"><span class="toc-number">1.1.10.4.</span> <span class="toc-text">镜像仓库 Registry</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%B9%E5%99%A8%E7%BC%96%E6%8E%92%E5%B7%A5%E5%85%B7"><span class="toc-number">1.1.10.5.</span> <span class="toc-text">容器编排工具</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Docker-%E5%AE%89%E8%A3%85%E5%8F%8A%E5%9F%BA%E7%A1%80%E5%91%BD%E4%BB%A4%E4%BB%8B%E7%BB%8D"><span class="toc-number">1.2.</span> <span class="toc-text">Docker 安装及基础命令介绍</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Docker-%E5%AE%89%E8%A3%85%E5%87%86%E5%A4%87"><span class="toc-number">1.2.1.</span> <span class="toc-text">Docker 安装准备</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%89%E8%A3%85%E5%92%8C%E5%88%A0%E9%99%A4%E6%96%B9%E6%B3%95"><span class="toc-number">1.2.2.</span> <span class="toc-text">安装和删除方法</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Ubuntu-%E5%AE%89%E8%A3%85%E5%92%8C%E5%88%A0%E9%99%A4Docker"><span class="toc-number">1.2.2.1.</span> <span class="toc-text">Ubuntu 安装和删除Docker</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#CentOS-%E5%AE%89%E8%A3%85%E5%92%8C%E5%88%A0%E9%99%A4Docker"><span class="toc-number">1.2.2.2.</span> <span class="toc-text">CentOS 安装和删除Docker</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Linux-%E4%BA%8C%E8%BF%9B%E5%88%B6%E5%AE%89%E8%A3%85"><span class="toc-number">1.2.2.3.</span> <span class="toc-text">Linux 二进制安装</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%89%E8%A3%85-podman"><span class="toc-number">1.2.2.4.</span> <span class="toc-text">安装 podman</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%9C%A8%E4%B8%8D%E5%90%8C%E7%B3%BB%E7%BB%9F%E4%B8%8A%E5%AE%9E%E7%8E%B0%E4%B8%80%E9%94%AE%E5%AE%89%E8%A3%85-docker-%E8%84%9A%E6%9C%AC"><span class="toc-number">1.2.2.5.</span> <span class="toc-text">在不同系统上实现一键安装 docker 脚本</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%9F%BA%E4%BA%8E-ubuntu-18-04%E5%92%8C20-04-%E7%9A%84-%E4%B8%80%E9%94%AE%E5%AE%89%E8%A3%85-docker-%E8%84%9A%E6%9C%AC"><span class="toc-number">1.2.2.5.1.</span> <span class="toc-text">基于 ubuntu 18.04和20.04 的 一键安装 docker 脚本</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%9F%BA%E4%BA%8E-CentOS-8-%E5%AE%9E%E7%8E%B0%E4%B8%80%E9%94%AE%E5%AE%89%E8%A3%85-docker-%E8%84%9A%E6%9C%AC"><span class="toc-number">1.2.2.5.2.</span> <span class="toc-text">基于 CentOS 8 实现一键安装 docker 脚本</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E8%84%9A%E6%9C%AC-1"><span class="toc-number">1.2.2.5.2.1.</span> <span class="toc-text">脚本 1</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E8%84%9A%E6%9C%AC-2"><span class="toc-number">1.2.2.5.2.2.</span> <span class="toc-text">脚本 2</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%9F%BA%E4%BA%8E-CentOS-7-%E5%AE%9E%E7%8E%B0%E4%B8%80%E9%94%AE%E5%AE%89%E8%A3%85docker-%E8%84%9A%E6%9C%AC"><span class="toc-number">1.2.2.5.3.</span> <span class="toc-text">基于 CentOS 7 实现一键安装docker 脚本</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E9%80%9A%E7%94%A8%E5%AE%89%E8%A3%85Docker%E8%84%9A%E6%9C%AC"><span class="toc-number">1.2.2.5.4.</span> <span class="toc-text">通用安装Docker脚本</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Docker-%E7%A8%8B%E5%BA%8F%E7%8E%AF%E5%A2%83"><span class="toc-number">1.2.3.</span> <span class="toc-text">Docker 程序环境</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Docker-%E5%91%BD%E4%BB%A4%E5%B8%AE%E5%8A%A9"><span class="toc-number">1.2.4.</span> <span class="toc-text">Docker 命令帮助</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9F%A5%E7%9C%8B-Docker-%E7%9B%B8%E5%85%B3%E4%BF%A1%E6%81%AF"><span class="toc-number">1.2.5.</span> <span class="toc-text">查看 Docker 相关信息</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%9F%A5%E7%9C%8B-docker-%E7%89%88%E6%9C%AC"><span class="toc-number">1.2.5.1.</span> <span class="toc-text">查看 docker 版本</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%9F%A5%E7%9C%8B-docker-%E8%AF%A6%E8%A7%A3%E4%BF%A1%E6%81%AF"><span class="toc-number">1.2.5.2.</span> <span class="toc-text">查看 docker 详解信息</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%9F%A5%E7%9C%8B-docker0-%E7%BD%91%E5%8D%A1"><span class="toc-number">1.2.5.3.</span> <span class="toc-text">查看 docker0 网卡</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#docker-%E5%AD%98%E5%82%A8%E5%BC%95%E6%93%8E"><span class="toc-number">1.2.5.4.</span> <span class="toc-text">docker 存储引擎</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%95%9C%E5%83%8F%E7%AE%A1%E7%90%86"><span class="toc-number">1.3.</span> <span class="toc-text">镜像管理</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%95%9C%E5%83%8F%E7%BB%93%E6%9E%84%E5%92%8C%E5%8E%9F%E7%90%86"><span class="toc-number">1.3.1.</span> <span class="toc-text">镜像结构和原理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%90%9C%E7%B4%A2%E9%95%9C%E5%83%8F"><span class="toc-number">1.3.2.</span> <span class="toc-text">搜索镜像</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%90%9C%E7%B4%A2%E9%95%9C%E5%83%8F-1"><span class="toc-number">1.3.2.1.</span> <span class="toc-text">搜索镜像</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%AE%98%E6%96%B9%E7%BD%91%E7%AB%99%E8%BF%9B%E8%A1%8C%E9%95%9C%E5%83%8F%E7%9A%84%E6%90%9C%E7%B4%A2"><span class="toc-number">1.3.2.1.1.</span> <span class="toc-text">官方网站进行镜像的搜索</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%89%A7%E8%A1%8Cdocker-search%E5%91%BD%E4%BB%A4%E8%BF%9B%E8%A1%8C%E6%90%9C%E7%B4%A2"><span class="toc-number">1.3.2.1.2.</span> <span class="toc-text">执行docker search命令进行搜索</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#alpine-%E4%BB%8B%E7%BB%8D"><span class="toc-number">1.3.2.2.</span> <span class="toc-text">alpine 介绍</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Debian-ubuntu-%E7%B3%BB%E7%BB%9F%E5%BB%BA%E8%AE%AE%E5%AE%89%E8%A3%85%E7%9A%84%E5%9F%BA%E7%A1%80%E5%8C%85"><span class="toc-number">1.3.2.3.</span> <span class="toc-text">Debian(ubuntu)系统建议安装的基础包</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%8B%E8%BD%BD%E9%95%9C%E5%83%8F"><span class="toc-number">1.3.3.</span> <span class="toc-text">下载镜像</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%95%9C%E5%83%8F%E5%8A%A0%E9%80%9F%E9%85%8D%E7%BD%AE%E5%92%8C%E4%BC%98%E5%8C%96"><span class="toc-number">1.3.4.</span> <span class="toc-text">镜像加速配置和优化</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%98%BF%E9%87%8C%E4%BA%91%E8%8E%B7%E5%8F%96%E5%8A%A0%E9%80%9F%E5%9C%B0%E5%9D%80"><span class="toc-number">1.3.4.1.</span> <span class="toc-text">阿里云获取加速地址</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#docker-%E9%95%9C%E5%83%8F%E5%8A%A0%E9%80%9F%E9%85%8D%E7%BD%AE"><span class="toc-number">1.3.4.2.</span> <span class="toc-text">docker 镜像加速配置</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9F%A5%E7%9C%8B%E6%9C%AC%E5%9C%B0%E9%95%9C%E5%83%8F"><span class="toc-number">1.3.5.</span> <span class="toc-text">查看本地镜像</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%95%9C%E5%83%8F%E5%AF%BC%E5%87%BA"><span class="toc-number">1.3.6.</span> <span class="toc-text">镜像导出</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%95%9C%E5%83%8F%E5%AF%BC%E5%85%A5"><span class="toc-number">1.3.7.</span> <span class="toc-text">镜像导入</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%A0%E9%99%A4%E9%95%9C%E5%83%8F"><span class="toc-number">1.3.8.</span> <span class="toc-text">删除镜像</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%95%9C%E5%83%8F%E6%89%93%E6%A0%87%E7%AD%BE"><span class="toc-number">1.3.9.</span> <span class="toc-text">镜像打标签</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%B9%E5%99%A8%E6%93%8D%E4%BD%9C%E5%9F%BA%E7%A1%80%E5%91%BD%E4%BB%A4"><span class="toc-number">1.4.</span> <span class="toc-text">容器操作基础命令</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%90%AF%E5%8A%A8%E5%AE%B9%E5%99%A8"><span class="toc-number">1.4.1.</span> <span class="toc-text">启动容器</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%90%AF%E5%8A%A8%E7%AC%AC%E4%B8%80%E4%B8%AA%E5%AE%B9%E5%99%A8"><span class="toc-number">1.4.1.1.</span> <span class="toc-text">启动第一个容器</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%90%AF%E5%8A%A8%E5%AE%B9%E5%99%A8%E7%9A%84%E6%B5%81%E7%A8%8B"><span class="toc-number">1.4.1.2.</span> <span class="toc-text">启动容器的流程</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%90%AF%E5%8A%A8%E5%AE%B9%E5%99%A8%E7%94%A8%E6%B3%95"><span class="toc-number">1.4.1.3.</span> <span class="toc-text">启动容器用法</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9F%A5%E7%9C%8B%E5%AE%B9%E5%99%A8%E4%BF%A1%E6%81%AF"><span class="toc-number">1.4.2.</span> <span class="toc-text">查看容器信息</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%98%BE%E7%A4%BA%E5%BD%93%E5%89%8D%E5%AD%98%E5%9C%A8%E5%AE%B9%E5%99%A8"><span class="toc-number">1.4.2.1.</span> <span class="toc-text">显示当前存在容器</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%9F%A5%E7%9C%8B%E5%AE%B9%E5%99%A8%E5%86%85%E7%9A%84%E8%BF%9B%E7%A8%8B"><span class="toc-number">1.4.2.2.</span> <span class="toc-text">查看容器内的进程</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%9F%A5%E7%9C%8B%E5%AE%B9%E5%99%A8%E8%B5%84%E6%BA%90%E4%BD%BF%E7%94%A8%E6%83%85%E5%86%B5"><span class="toc-number">1.4.2.3.</span> <span class="toc-text">查看容器资源使用情况</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%9F%A5%E7%9C%8B%E5%AE%B9%E5%99%A8%E7%9A%84%E8%AF%A6%E7%BB%86%E4%BF%A1%E6%81%AF"><span class="toc-number">1.4.2.4.</span> <span class="toc-text">查看容器的详细信息</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%A0%E9%99%A4%E5%AE%B9%E5%99%A8"><span class="toc-number">1.4.3.</span> <span class="toc-text">删除容器</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%B9%E5%99%A8%E7%9A%84%E5%90%AF%E5%8A%A8%E5%92%8C%E5%81%9C%E6%AD%A2"><span class="toc-number">1.4.4.</span> <span class="toc-text">容器的启动和停止</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BB%99%E6%AD%A3%E5%9C%A8%E8%BF%90%E8%A1%8C%E7%9A%84%E5%AE%B9%E5%99%A8%E5%8F%91%E4%BF%A1%E5%8F%B7"><span class="toc-number">1.4.5.</span> <span class="toc-text">给正在运行的容器发信号</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%BF%9B%E5%85%A5%E6%AD%A3%E5%9C%A8%E8%BF%90%E8%A1%8C%E7%9A%84%E5%AE%B9%E5%99%A8"><span class="toc-number">1.4.6.</span> <span class="toc-text">进入正在运行的容器</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8attach%E5%91%BD%E4%BB%A4"><span class="toc-number">1.4.6.1.</span> <span class="toc-text">使用attach命令</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8exec%E5%91%BD%E4%BB%A4"><span class="toc-number">1.4.6.2.</span> <span class="toc-text">使用exec命令</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9A%B4%E9%9C%B2%E6%89%80%E6%9C%89%E5%AE%B9%E5%99%A8%E7%AB%AF%E5%8F%A3"><span class="toc-number">1.4.7.</span> <span class="toc-text">暴露所有容器端口</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%8C%87%E5%AE%9A%E7%AB%AF%E5%8F%A3%E6%98%A0%E5%B0%84"><span class="toc-number">1.4.8.</span> <span class="toc-text">指定端口映射</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9F%A5%E7%9C%8B%E5%AE%B9%E5%99%A8%E7%9A%84%E6%97%A5%E5%BF%97"><span class="toc-number">1.4.9.</span> <span class="toc-text">查看容器的日志</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BC%A0%E9%80%92%E8%BF%90%E8%A1%8C%E5%91%BD%E4%BB%A4"><span class="toc-number">1.4.10.</span> <span class="toc-text">传递运行命令</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%B9%E5%99%A8%E5%86%85%E9%83%A8%E7%9A%84hosts%E6%96%87%E4%BB%B6"><span class="toc-number">1.4.11.</span> <span class="toc-text">容器内部的hosts文件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%8C%87%E5%AE%9A%E5%AE%B9%E5%99%A8DNS"><span class="toc-number">1.4.12.</span> <span class="toc-text">指定容器DNS</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%B9%E5%99%A8%E5%86%85%E5%92%8C%E5%AE%BF%E4%B8%BB%E6%9C%BA%E4%B9%8B%E9%97%B4%E5%A4%8D%E5%88%B6%E6%96%87%E4%BB%B6"><span class="toc-number">1.4.13.</span> <span class="toc-text">容器内和宿主机之间复制文件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8-systemd-%E6%8E%A7%E5%88%B6%E5%AE%B9%E5%99%A8%E8%BF%90%E8%A1%8C"><span class="toc-number">1.4.14.</span> <span class="toc-text">使用 systemd 控制容器运行</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BC%A0%E9%80%92%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8F"><span class="toc-number">1.4.15.</span> <span class="toc-text">传递环境变量</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%9E%E6%88%98%E6%A1%88%E4%BE%8B-%E5%88%A9%E7%94%A8-docker-%E5%BF%AB%E9%80%9F%E9%83%A8%E7%BD%B2%E8%87%AA%E5%8A%A8%E5%8C%96%E8%BF%90%E7%BB%B4%E5%B9%B3%E5%8F%B0"><span class="toc-number">1.5.</span> <span class="toc-text">实战案例: 利用 docker 快速部署自动化运维平台</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%A1%B9%E7%9B%AE%E8%AF%B4%E6%98%8E"><span class="toc-number">1.5.1.</span> <span class="toc-text">项目说明</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%83%A8%E7%BD%B2%E8%BF%87%E7%A8%8B"><span class="toc-number">1.5.2.</span> <span class="toc-text">部署过程</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%89%E8%A3%85docker"><span class="toc-number">1.5.2.1.</span> <span class="toc-text">安装docker</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%8B%89%E5%8F%96%E9%95%9C%E5%83%8F"><span class="toc-number">1.5.2.2.</span> <span class="toc-text">拉取镜像</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%90%AF%E5%8A%A8%E5%AE%B9%E5%99%A8-1"><span class="toc-number">1.5.2.3.</span> <span class="toc-text">启动容器</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%9D%E5%A7%8B%E5%8C%96"><span class="toc-number">1.5.2.4.</span> <span class="toc-text">初始化</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%AE%BF%E9%97%AE%E6%B5%8B%E8%AF%95"><span class="toc-number">1.5.2.5.</span> <span class="toc-text">访问测试</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Docker-%E9%95%9C%E5%83%8F%E5%88%B6%E4%BD%9C%E5%92%8C%E7%AE%A1%E7%90%86"><span class="toc-number">2.</span> <span class="toc-text">Docker 镜像制作和管理</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Docker-%E9%95%9C%E5%83%8F%E8%AF%B4%E6%98%8E"><span class="toc-number">2.1.</span> <span class="toc-text">Docker 镜像说明</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Docker-%E9%95%9C%E5%83%8F%E4%B8%AD%E6%9C%89%E6%B2%A1%E6%9C%89%E5%86%85%E6%A0%B8"><span class="toc-number">2.1.1.</span> <span class="toc-text">Docker 镜像中有没有内核</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%BA%E4%BB%80%E4%B9%88%E6%B2%A1%E6%9C%89%E5%86%85%E6%A0%B8"><span class="toc-number">2.1.2.</span> <span class="toc-text">为什么没有内核</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%B9%E5%99%A8%E4%B8%AD%E7%9A%84%E7%A8%8B%E5%BA%8F%E5%90%8E%E5%8F%B0%E8%BF%90%E8%A1%8C%E4%BC%9A%E5%AF%BC%E8%87%B4%E6%AD%A4%E5%AE%B9%E5%99%A8%E5%90%AF%E5%8A%A8%E5%90%8E%E7%AB%8B%E5%8D%B3%E9%80%80%E5%87%BA"><span class="toc-number">2.1.3.</span> <span class="toc-text">容器中的程序后台运行会导致此容器启动后立即退出</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#docker-%E9%95%9C%E5%83%8F%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F"><span class="toc-number">2.1.4.</span> <span class="toc-text">docker 镜像生命周期</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%B6%E4%BD%9C%E9%95%9C%E5%83%8F%E6%96%B9%E5%BC%8F"><span class="toc-number">2.1.5.</span> <span class="toc-text">制作镜像方式</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%B0%86%E7%8E%B0%E6%9C%89%E5%AE%B9%E5%99%A8%E9%80%9A%E8%BF%87-docker-commit-%E6%89%8B%E5%8A%A8%E6%9E%84%E5%BB%BA%E9%95%9C%E5%83%8F"><span class="toc-number">2.2.</span> <span class="toc-text">将现有容器通过 docker commit 手动构建镜像</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9F%BA%E4%BA%8E%E5%AE%B9%E5%99%A8%E6%89%8B%E5%8A%A8%E5%88%B6%E4%BD%9C%E9%95%9C%E5%83%8F%E6%AD%A5%E9%AA%A4"><span class="toc-number">2.2.1.</span> <span class="toc-text">基于容器手动制作镜像步骤</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9E%E6%88%98%E6%A1%88%E4%BE%8B-%E5%9F%BA%E4%BA%8E-busybox-%E5%88%B6%E4%BD%9C-httpd-%E9%95%9C%E5%83%8F"><span class="toc-number">2.2.2.</span> <span class="toc-text">实战案例: 基于 busybox 制作 httpd 镜像</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9E%E6%88%98%E6%A1%88%E4%BE%8B-%E5%9F%BA%E4%BA%8E%E5%AE%98%E6%96%B9%E9%95%9C%E5%83%8F%E7%94%9F%E6%88%90%E7%9A%84%E5%AE%B9%E5%99%A8%E5%88%B6%E4%BD%9C-tomcat-%E9%95%9C%E5%83%8F"><span class="toc-number">2.2.3.</span> <span class="toc-text">实战案例: 基于官方镜像生成的容器制作 tomcat 镜像</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%8B%E8%BD%BD%E5%AE%98%E6%96%B9%E7%9A%84tomcat%E9%95%9C%E5%83%8F%E5%B9%B6%E8%BF%90%E8%A1%8C"><span class="toc-number">2.2.3.1.</span> <span class="toc-text">下载官方的tomcat镜像并运行</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BF%AE%E6%94%B9%E5%AE%B9%E5%99%A8"><span class="toc-number">2.2.3.2.</span> <span class="toc-text">修改容器</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%8F%90%E4%BA%A4%E6%96%B0%E9%95%9C%E5%83%8F"><span class="toc-number">2.2.3.3.</span> <span class="toc-text">提交新镜像</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%A9%E7%94%A8%E6%96%B0%E9%95%9C%E5%83%8F%E5%90%AF%E5%8A%A8%E5%AE%B9%E5%99%A8"><span class="toc-number">2.2.3.4.</span> <span class="toc-text">利用新镜像启动容器</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%B5%8B%E8%AF%95%E6%96%B0%E9%95%9C%E5%83%8F%E5%90%AF%E5%8A%A8%E7%9A%84%E5%AE%B9%E5%99%A8"><span class="toc-number">2.2.3.5.</span> <span class="toc-text">测试新镜像启动的容器</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9E%E6%88%98%E6%A1%88%E4%BE%8B-%E5%9F%BA%E4%BA%8EUbuntu%E7%9A%84%E5%9F%BA%E7%A1%80%E9%95%9C%E5%83%8F%E5%88%A9%E7%94%A8-apt-%E5%AE%89%E8%A3%85%E6%89%8B%E5%8A%A8%E5%88%B6%E4%BD%9C-nginx-%E7%9A%84%E9%95%9C%E5%83%8F"><span class="toc-number">2.2.4.</span> <span class="toc-text">实战案例: 基于Ubuntu的基础镜像利用 apt 安装手动制作 nginx 的镜像</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%90%AF%E5%8A%A8Ubuntu%E5%9F%BA%E7%A1%80%E9%95%9C%E5%83%8F%E5%B9%B6%E5%AE%9E%E7%8E%B0%E7%9B%B8%E5%85%B3%E7%9A%84%E9%85%8D%E7%BD%AE"><span class="toc-number">2.2.4.1.</span> <span class="toc-text">启动Ubuntu基础镜像并实现相关的配置</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%8F%90%E4%BA%A4%E4%B8%BA%E9%95%9C%E5%83%8F"><span class="toc-number">2.2.4.2.</span> <span class="toc-text">提交为镜像</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BB%8E%E5%88%B6%E4%BD%9C%E7%9A%84%E6%96%B0%E9%95%9C%E5%83%8F%E5%90%AF%E5%8A%A8%E5%AE%B9%E5%99%A8%E5%B9%B6%E6%B5%8B%E8%AF%95%E8%AE%BF%E9%97%AE"><span class="toc-number">2.2.4.3.</span> <span class="toc-text">从制作的新镜像启动容器并测试访问</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9E%E6%88%98%E6%A1%88%E4%BE%8B-%E5%9F%BA%E4%BA%8ECentOS%E7%9A%84%E5%9F%BA%E7%A1%80%E9%95%9C%E5%83%8F%E5%88%A9%E7%94%A8-yum-%E5%AE%89%E8%A3%85%E6%89%8B%E5%8A%A8%E5%88%B6%E4%BD%9C-nginx-%E7%9A%84%E9%95%9C%E5%83%8F"><span class="toc-number">2.2.5.</span> <span class="toc-text">实战案例: 基于CentOS的基础镜像利用 yum 安装手动制作 nginx 的镜像</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%8B%E8%BD%BD%E5%9F%BA%E7%A1%80%E9%95%9C%E5%83%8F%E5%B9%B6%E5%88%9D%E5%A7%8B%E5%8C%96%E7%B3%BB%E7%BB%9F"><span class="toc-number">2.2.5.1.</span> <span class="toc-text">下载基础镜像并初始化系统</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%89%E8%A3%85%E7%9B%B8%E5%85%B3%E8%BD%AF%E4%BB%B6%E5%92%8C%E5%B7%A5%E5%85%B7"><span class="toc-number">2.2.5.2.</span> <span class="toc-text">安装相关软件和工具</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BF%AE%E6%94%B9%E6%9C%8D%E5%8A%A1%E7%9A%84%E9%85%8D%E7%BD%AE%E4%BF%A1%E6%81%AF%E5%85%B3%E9%97%AD%E6%9C%8D%E5%8A%A1%E5%90%8E%E5%8F%B0%E8%BF%90%E8%A1%8C"><span class="toc-number">2.2.5.3.</span> <span class="toc-text">修改服务的配置信息关闭服务后台运行</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%87%86%E5%A4%87%E7%A8%8B%E5%BA%8F%E5%92%8C%E6%95%B0%E6%8D%AE"><span class="toc-number">2.2.5.4.</span> <span class="toc-text">准备程序和数据</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%8F%90%E4%BA%A4%E4%B8%BA%E9%95%9C%E5%83%8F-1"><span class="toc-number">2.2.5.5.</span> <span class="toc-text">提交为镜像</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BB%8E%E5%88%B6%E4%BD%9C%E7%9A%84%E9%95%9C%E5%83%8F%E5%90%AF%E5%8A%A8%E5%AE%B9%E5%99%A8"><span class="toc-number">2.2.5.6.</span> <span class="toc-text">从制作的镜像启动容器</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%AE%BF%E9%97%AE%E6%B5%8B%E8%AF%95%E9%95%9C%E5%83%8F"><span class="toc-number">2.2.5.7.</span> <span class="toc-text">访问测试镜像</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9E%E6%88%98%E6%A1%88%E4%BE%8B-%E5%9F%BA%E4%BA%8ECentOS-%E5%9F%BA%E7%A1%80%E9%95%9C%E5%83%8F%E6%89%8B%E5%8A%A8%E5%88%B6%E4%BD%9C%E7%BC%96%E8%AF%91%E7%89%88%E6%9C%AC-nginx-%E9%95%9C%E5%83%8F"><span class="toc-number">2.2.6.</span> <span class="toc-text">实战案例: 基于CentOS 基础镜像手动制作编译版本 nginx 镜像</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%8B%E8%BD%BD%E9%95%9C%E5%83%8F%E5%B9%B6%E5%88%9D%E5%A7%8B%E5%8C%96%E7%B3%BB%E7%BB%9F"><span class="toc-number">2.2.6.1.</span> <span class="toc-text">下载镜像并初始化系统</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%BC%96%E8%AF%91%E5%AE%89%E8%A3%85-nginx"><span class="toc-number">2.2.6.2.</span> <span class="toc-text">编译安装 nginx</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%85%B3%E9%97%AD-nginx-%E5%90%8E%E5%8F%B0%E8%BF%90%E8%A1%8C"><span class="toc-number">2.2.6.3.</span> <span class="toc-text">关闭 nginx 后台运行</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%87%86%E5%A4%87%E7%9B%B8%E5%85%B3%E6%95%B0%E6%8D%AE%E8%87%AA%E5%AE%9A%E4%B9%89web%E7%95%8C%E9%9D%A2"><span class="toc-number">2.2.6.4.</span> <span class="toc-text">准备相关数据自定义web界面</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%8F%90%E4%BA%A4%E4%B8%BA%E9%95%9C%E5%83%8F-2"><span class="toc-number">2.2.6.5.</span> <span class="toc-text">提交为镜像</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BB%8E%E8%87%AA%E5%B7%B1%E7%9A%84%E9%95%9C%E5%83%8F%E5%90%AF%E5%8A%A8%E5%AE%B9%E5%99%A8"><span class="toc-number">2.2.6.6.</span> <span class="toc-text">从自己的镜像启动容器</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%AE%BF%E9%97%AE%E6%B5%8B%E8%AF%95-1"><span class="toc-number">2.2.6.7.</span> <span class="toc-text">访问测试</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%9F%A5%E7%9C%8BNginx%E8%AE%BF%E9%97%AE%E6%97%A5%E5%BF%97%E5%92%8C%E8%BF%9B%E7%A8%8B"><span class="toc-number">2.2.6.8.</span> <span class="toc-text">查看Nginx访问日志和进程</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%A9%E7%94%A8-DockerFile-%E6%96%87%E4%BB%B6%E6%89%A7%E8%A1%8C-docker-build-%E8%87%AA%E5%8A%A8%E6%9E%84%E5%BB%BA%E9%95%9C%E5%83%8F"><span class="toc-number">2.3.</span> <span class="toc-text">利用 DockerFile 文件执行 docker build 自动构建镜像</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Dockfile-%E4%BD%BF%E7%94%A8%E8%AF%A6%E8%A7%A3"><span class="toc-number">2.3.1.</span> <span class="toc-text">Dockfile 使用详解</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Dockerfile-%E4%BB%8B%E7%BB%8D"><span class="toc-number">2.3.1.1.</span> <span class="toc-text">Dockerfile 介绍</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Dockerfile-%E9%95%9C%E5%83%8F%E5%88%B6%E4%BD%9C%E5%92%8C%E4%BD%BF%E7%94%A8%E6%B5%81%E7%A8%8B"><span class="toc-number">2.3.1.2.</span> <span class="toc-text">Dockerfile 镜像制作和使用流程</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Dockerfile%E6%96%87%E4%BB%B6%E7%9A%84%E5%88%B6%E4%BD%9C%E9%95%9C%E5%83%8F%E7%9A%84%E5%88%86%E5%B1%82%E7%BB%93%E6%9E%84"><span class="toc-number">2.3.1.3.</span> <span class="toc-text">Dockerfile文件的制作镜像的分层结构</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Dockerfile-%E6%96%87%E4%BB%B6%E6%A0%BC%E5%BC%8F"><span class="toc-number">2.3.1.4.</span> <span class="toc-text">Dockerfile 文件格式</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Dockerfile-%E7%9B%B8%E5%85%B3%E6%8C%87%E4%BB%A4"><span class="toc-number">2.3.1.5.</span> <span class="toc-text">Dockerfile 相关指令</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#FROM-%E6%8C%87%E5%AE%9A%E5%9F%BA%E7%A1%80%E9%95%9C%E5%83%8F"><span class="toc-number">2.3.1.5.1.</span> <span class="toc-text">FROM: 指定基础镜像</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#LABEL-%E6%8C%87%E5%AE%9A%E9%95%9C%E5%83%8F%E5%85%83%E6%95%B0%E6%8D%AE"><span class="toc-number">2.3.1.5.2.</span> <span class="toc-text">LABEL: 指定镜像元数据</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#RUN-%E6%89%A7%E8%A1%8C-shell%E5%91%BD%E4%BB%A4"><span class="toc-number">2.3.1.5.3.</span> <span class="toc-text">RUN: 执行 shell命令</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#ENV-%E8%AE%BE%E7%BD%AE%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8F"><span class="toc-number">2.3.1.5.4.</span> <span class="toc-text">ENV: 设置环境变量</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#COPY-%E5%A4%8D%E5%88%B6%E6%96%87%E6%9C%AC"><span class="toc-number">2.3.1.5.5.</span> <span class="toc-text">COPY: 复制文本</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#ADD-%E5%A4%8D%E5%88%B6%E5%92%8C%E8%A7%A3%E5%8C%85%E6%96%87%E4%BB%B6"><span class="toc-number">2.3.1.5.6.</span> <span class="toc-text">ADD: 复制和解包文件</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#CMD-%E5%AE%B9%E5%99%A8%E5%90%AF%E5%8A%A8%E5%91%BD%E4%BB%A4"><span class="toc-number">2.3.1.5.7.</span> <span class="toc-text">CMD: 容器启动命令</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#ENTRYPOINT-%E5%85%A5%E5%8F%A3%E7%82%B9"><span class="toc-number">2.3.1.5.8.</span> <span class="toc-text">ENTRYPOINT: 入口点</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#ARG-%E6%9E%84%E5%BB%BA%E5%8F%82%E6%95%B0"><span class="toc-number">2.3.1.5.9.</span> <span class="toc-text">ARG: 构建参数</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#VOLUME-%E5%8C%BF%E5%90%8D%E5%8D%B7"><span class="toc-number">2.3.1.5.10.</span> <span class="toc-text">VOLUME: 匿名卷</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#EXPOSE-%E6%9A%B4%E9%9C%B2%E7%AB%AF%E5%8F%A3"><span class="toc-number">2.3.1.5.11.</span> <span class="toc-text">EXPOSE: 暴露端口</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#WORKDIR-%E6%8C%87%E5%AE%9A%E5%B7%A5%E4%BD%9C%E7%9B%AE%E5%BD%95"><span class="toc-number">2.3.1.5.12.</span> <span class="toc-text">WORKDIR: 指定工作目录</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#ONBUILD-%E5%AD%90%E9%95%9C%E5%83%8F%E5%BC%95%E7%94%A8%E7%88%B6%E9%95%9C%E5%83%8F%E7%9A%84%E6%8C%87%E4%BB%A4"><span class="toc-number">2.3.1.5.13.</span> <span class="toc-text">ONBUILD: 子镜像引用父镜像的指令</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#USER-%E6%8C%87%E5%AE%9A%E5%BD%93%E5%89%8D%E7%94%A8%E6%88%B7"><span class="toc-number">2.3.1.5.14.</span> <span class="toc-text">USER: 指定当前用户</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#HEALTHCHECK-%E5%81%A5%E5%BA%B7%E6%A3%80%E6%9F%A5"><span class="toc-number">2.3.1.5.15.</span> <span class="toc-text">HEALTHCHECK: 健康检查</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#dockerignore%E6%96%87%E4%BB%B6"><span class="toc-number">2.3.1.5.16.</span> <span class="toc-text">.dockerignore文件</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#Dockerfile-%E6%9E%84%E5%BB%BA%E8%BF%87%E7%A8%8B%E5%92%8C%E6%8C%87%E4%BB%A4%E6%80%BB%E7%BB%93"><span class="toc-number">2.3.1.5.17.</span> <span class="toc-text">Dockerfile 构建过程和指令总结</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%9E%84%E5%BB%BA%E9%95%9C%E5%83%8Fdocker-build-%E5%91%BD%E4%BB%A4"><span class="toc-number">2.3.1.6.</span> <span class="toc-text">构建镜像docker build 命令</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9E%E6%88%98%E6%A1%88%E4%BE%8B-Dockerfile-%E5%88%B6%E4%BD%9C%E5%9F%BA%E4%BA%8E%E5%9F%BA%E7%A1%80%E9%95%9C%E5%83%8F%E7%9A%84Base%E9%95%9C%E5%83%8F"><span class="toc-number">2.3.2.</span> <span class="toc-text">实战案例: Dockerfile 制作基于基础镜像的Base镜像</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%87%86%E5%A4%87%E7%9B%AE%E5%BD%95%E7%BB%93%E6%9E%84%EF%BC%8C%E4%B8%8B%E8%BD%BD%E9%95%9C%E5%83%8F%E5%B9%B6%E5%88%9D%E5%A7%8B%E5%8C%96%E7%B3%BB%E7%BB%9F"><span class="toc-number">2.3.2.1.</span> <span class="toc-text">准备目录结构，下载镜像并初始化系统</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%85%88%E5%88%B6%E4%BD%9C%E5%9F%BA%E4%BA%8E%E5%9F%BA%E7%A1%80%E9%95%9C%E5%83%8F%E7%9A%84%E7%B3%BB%E7%BB%9FBase%E9%95%9C%E5%83%8F"><span class="toc-number">2.3.2.2.</span> <span class="toc-text">先制作基于基础镜像的系统Base镜像</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9E%E6%88%98%E6%A1%88%E4%BE%8B-Dockerfile-%E5%88%B6%E4%BD%9C%E5%9F%BA%E4%BA%8EBase%E9%95%9C%E5%83%8F%E7%9A%84-nginx-%E9%95%9C%E5%83%8F"><span class="toc-number">2.3.3.</span> <span class="toc-text">实战案例: Dockerfile 制作基于Base镜像的 nginx 镜像</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%9C%A8Dockerfile%E7%9B%AE%E5%BD%95%E4%B8%8B%E5%87%86%E5%A4%87%E7%BC%96%E8%AF%91%E5%AE%89%E8%A3%85%E7%9A%84%E7%9B%B8%E5%85%B3%E6%96%87%E4%BB%B6"><span class="toc-number">2.3.3.1.</span> <span class="toc-text">在Dockerfile目录下准备编译安装的相关文件</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%9C%A8%E4%B8%80%E5%8F%B0%E6%B5%8B%E8%AF%95%E6%9C%BA%E8%BF%9B%E8%A1%8C%E7%BC%96%E8%AF%91%E5%AE%89%E8%A3%85%E5%90%8C%E4%B8%80%E7%89%88%E6%9C%AC%E7%9A%84nginx-%E7%94%9F%E6%88%90%E6%A8%A1%E7%89%88%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6"><span class="toc-number">2.3.3.2.</span> <span class="toc-text">在一台测试机进行编译安装同一版本的nginx 生成模版配置文件</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%BC%96%E5%86%99Dockerfile%E6%96%87%E4%BB%B6"><span class="toc-number">2.3.3.3.</span> <span class="toc-text">编写Dockerfile文件</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%94%9F%E6%88%90nginx%E9%95%9C%E5%83%8F"><span class="toc-number">2.3.3.4.</span> <span class="toc-text">生成nginx镜像</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%94%9F%E6%88%90%E7%9A%84%E5%AE%B9%E5%99%A8%E6%B5%8B%E8%AF%95%E9%95%9C%E5%83%8F"><span class="toc-number">2.3.3.5.</span> <span class="toc-text">生成的容器测试镜像</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9E%E6%88%98%E6%A1%88%E4%BE%8B-Dockerfile-%E7%9B%B4%E6%8E%A5%E5%88%B6%E4%BD%9C-nginx-%E9%95%9C%E5%83%8F"><span class="toc-number">2.3.4.</span> <span class="toc-text">实战案例: Dockerfile 直接制作 nginx 镜像</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%9C%A8Dockerfile%E7%9B%AE%E5%BD%95%E4%B8%8B%E5%87%86%E5%A4%87%E7%BC%96%E8%AF%91%E5%AE%89%E8%A3%85%E7%9A%84%E7%9B%B8%E5%85%B3%E6%96%87%E4%BB%B6-1"><span class="toc-number">2.3.4.1.</span> <span class="toc-text">在Dockerfile目录下准备编译安装的相关文件</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%BC%96%E5%86%99Dockerfile%E6%96%87%E4%BB%B6-1"><span class="toc-number">2.3.4.2.</span> <span class="toc-text">编写Dockerfile文件</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%94%9F%E6%88%90nginx%E9%95%9C%E5%83%8F-1"><span class="toc-number">2.3.4.3.</span> <span class="toc-text">生成nginx镜像</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%94%9F%E6%88%90%E5%AE%B9%E5%99%A8%E6%B5%8B%E8%AF%95%E9%95%9C%E5%83%8F"><span class="toc-number">2.3.4.4.</span> <span class="toc-text">生成容器测试镜像</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9E%E6%88%98%E6%A1%88%E4%BE%8B-%E5%A4%9A%E9%98%B6%E6%AE%B5%E6%9E%84%E5%BB%BA"><span class="toc-number">2.3.5.</span> <span class="toc-text">实战案例: 多阶段构建</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%94%9F%E4%BA%A7%E6%A1%88%E4%BE%8B-%E5%88%B6%E4%BD%9C%E8%87%AA%E5%AE%9A%E4%B9%89tomcat%E4%B8%9A%E5%8A%A1%E9%95%9C%E5%83%8F"><span class="toc-number">2.3.6.</span> <span class="toc-text">生产案例: 制作自定义tomcat业务镜像</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%9E%84%E5%BB%BAJDK-%E9%95%9C%E5%83%8F"><span class="toc-number">2.3.6.1.</span> <span class="toc-text">构建JDK 镜像</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%B8%8A%E4%BC%A0JDK%E5%8E%8B%E7%BC%A9%E5%8C%85%E5%92%8Cprofile%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E5%88%B0Dockerfile%E5%BD%93%E5%89%8D%E7%9B%AE%E5%BD%95"><span class="toc-number">2.3.6.1.1.</span> <span class="toc-text">上传JDK压缩包和profile文件上传到Dockerfile当前目录</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%87%86%E5%A4%87Dockerfile%E6%96%87%E4%BB%B6"><span class="toc-number">2.3.6.1.2.</span> <span class="toc-text">准备Dockerfile文件</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%89%A7%E8%A1%8C%E6%9E%84%E5%BB%BA%E8%84%9A%E6%9C%AC%E5%88%B6%E4%BD%9C%E9%95%9C%E5%83%8F"><span class="toc-number">2.3.6.2.</span> <span class="toc-text">执行构建脚本制作镜像</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BB%8E%E9%95%9C%E5%83%8F%E5%90%AF%E5%8A%A8%E5%AE%B9%E5%99%A8%E6%B5%8B%E8%AF%95"><span class="toc-number">2.3.6.3.</span> <span class="toc-text">从镜像启动容器测试</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BB%8EJDK%E9%95%9C%E5%83%8F%E6%9E%84%E5%BB%BAtomcat-8-Base%E9%95%9C%E5%83%8F"><span class="toc-number">2.3.6.4.</span> <span class="toc-text">从JDK镜像构建tomcat 8 Base镜像</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%B8%8A%E4%BC%A0tomcat-%E5%8E%8B%E7%BC%A9%E5%8C%85"><span class="toc-number">2.3.6.4.1.</span> <span class="toc-text">上传tomcat 压缩包</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E7%BC%96%E8%BE%91Dockerfile"><span class="toc-number">2.3.6.4.2.</span> <span class="toc-text">编辑Dockerfile</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E9%80%9A%E8%BF%87%E8%84%9A%E6%9C%AC%E6%9E%84%E5%BB%BAtomcat-%E5%9F%BA%E7%A1%80%E9%95%9C%E5%83%8F"><span class="toc-number">2.3.6.4.3.</span> <span class="toc-text">通过脚本构建tomcat 基础镜像</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E9%AA%8C%E8%AF%81%E9%95%9C%E5%83%8F%E6%9E%84%E5%BB%BA%E5%AE%8C%E6%88%90"><span class="toc-number">2.3.6.4.4.</span> <span class="toc-text">验证镜像构建完成</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%9E%84%E5%BB%BA%E4%B8%9A%E5%8A%A1%E9%95%9C%E5%83%8F1"><span class="toc-number">2.3.6.5.</span> <span class="toc-text">构建业务镜像1</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%87%86%E5%A4%87tomcat%E7%9A%84%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6"><span class="toc-number">2.3.6.5.1.</span> <span class="toc-text">准备tomcat的配置文件</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%87%86%E5%A4%87%E8%87%AA%E5%AE%9A%E4%B9%89%E9%A1%B5%E9%9D%A2"><span class="toc-number">2.3.6.5.2.</span> <span class="toc-text">准备自定义页面</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%87%86%E5%A4%87%E5%AE%B9%E5%99%A8%E5%90%AF%E5%8A%A8%E6%89%A7%E8%A1%8C%E8%84%9A%E6%9C%AC"><span class="toc-number">2.3.6.5.3.</span> <span class="toc-text">准备容器启动执行脚本</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%87%86%E5%A4%87Dockerfile"><span class="toc-number">2.3.6.5.4.</span> <span class="toc-text">准备Dockerfile</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%89%A7%E8%A1%8C%E6%9E%84%E5%BB%BA%E8%84%9A%E6%9C%AC%E5%88%B6%E4%BD%9C%E9%95%9C%E5%83%8F-1"><span class="toc-number">2.3.6.5.5.</span> <span class="toc-text">执行构建脚本制作镜像</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%BB%8E%E9%95%9C%E5%83%8F%E5%90%AF%E5%8A%A8%E6%B5%8B%E8%AF%95%E5%AE%B9%E5%99%A8"><span class="toc-number">2.3.6.5.6.</span> <span class="toc-text">从镜像启动测试容器</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E8%AE%BF%E9%97%AE%E6%B5%8B%E8%AF%95-2"><span class="toc-number">2.3.6.5.7.</span> <span class="toc-text">访问测试</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%9E%84%E5%BB%BA%E4%B8%9A%E5%8A%A1%E9%95%9C%E5%83%8F2"><span class="toc-number">2.3.6.6.</span> <span class="toc-text">构建业务镜像2</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%87%86%E5%A4%87%E8%87%AA%E5%AE%9A%E4%B9%89%E9%A1%B5%E9%9D%A2%E5%92%8C%E5%85%B6%E5%AE%83%E6%95%B0%E6%8D%AE"><span class="toc-number">2.3.6.6.1.</span> <span class="toc-text">准备自定义页面和其它数据</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%87%86%E5%A4%87%E5%AE%B9%E5%99%A8%E5%90%AF%E5%8A%A8%E8%84%9A%E6%9C%ACrun-tomcat-sh"><span class="toc-number">2.3.6.6.2.</span> <span class="toc-text">准备容器启动脚本run_tomcat.sh</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%87%86%E5%A4%87Dockerfile-1"><span class="toc-number">2.3.6.6.3.</span> <span class="toc-text">准备Dockerfile</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%89%A7%E8%A1%8C%E6%9E%84%E5%BB%BA%E8%84%9A%E6%9C%AC%E5%88%B6%E4%BD%9C%E9%95%9C%E5%83%8F-2"><span class="toc-number">2.3.6.6.4.</span> <span class="toc-text">执行构建脚本制作镜像</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%BB%8E%E9%95%9C%E5%83%8F%E5%90%AF%E5%8A%A8%E5%AE%B9%E5%99%A8%E6%B5%8B%E8%AF%95-1"><span class="toc-number">2.3.6.6.5.</span> <span class="toc-text">从镜像启动容器测试</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E8%AE%BF%E9%97%AE%E6%B5%8B%E8%AF%95-3"><span class="toc-number">2.3.6.6.6.</span> <span class="toc-text">访问测试</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%87%86%E5%A4%87%E7%9B%B8%E5%85%B3%E6%96%87%E4%BB%B6"><span class="toc-number">2.3.6.7.</span> <span class="toc-text">准备相关文件</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%87%86%E5%A4%87haproxy%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6"><span class="toc-number">2.3.6.8.</span> <span class="toc-text">准备haproxy配置文件</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%87%86%E5%A4%87Dockerfile-2"><span class="toc-number">2.3.6.9.</span> <span class="toc-text">准备Dockerfile</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%87%86%E5%A4%87%E6%9E%84%E5%BB%BA%E8%84%9A%E6%9C%AC%E6%9E%84%E5%BB%BAhaproxy%E9%95%9C%E5%83%8F"><span class="toc-number">2.3.6.10.</span> <span class="toc-text">准备构建脚本构建haproxy镜像</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BB%8E%E9%95%9C%E5%83%8F%E5%90%AF%E5%8A%A8%E5%AE%B9%E5%99%A8"><span class="toc-number">2.3.6.11.</span> <span class="toc-text">从镜像启动容器</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%9C%A8%E5%8F%A6%E5%A4%96%E4%B8%A4%E5%8F%B0%E4%B8%BB%E6%9C%BA%E5%90%AF%E5%8A%A8%E5%AE%B9%E5%99%A8"><span class="toc-number">2.3.6.12.</span> <span class="toc-text">在另外两台主机启动容器</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#web%E8%AE%BF%E9%97%AE%E9%AA%8C%E8%AF%81"><span class="toc-number">2.3.6.13.</span> <span class="toc-text">web访问验证</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%94%9F%E4%BA%A7%E6%A1%88%E4%BE%8B-%E5%9F%BA%E4%BA%8E-Alpine-%E5%9F%BA%E7%A1%80%E9%95%9C%E5%83%8F%E5%88%B6%E4%BD%9C-Nginx-%E9%95%9C%E5%83%8F"><span class="toc-number">2.3.7.</span> <span class="toc-text">生产案例: 基于 Alpine 基础镜像制作 Nginx 镜像</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%B6%E4%BD%9C-Alpine-%E7%9A%84%E8%87%AA%E5%AE%9A%E4%B9%89%E7%B3%BB%E7%BB%9F%E9%95%9C%E5%83%8F"><span class="toc-number">2.3.7.1.</span> <span class="toc-text">制作 Alpine 的自定义系统镜像</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%B6%E4%BD%9C%E5%9F%BA%E4%BA%8E-Alpine-%E8%87%AA%E5%AE%9A%E4%B9%89%E9%95%9C%E5%83%8F%E7%9A%84-Nginx-%E9%95%9C%E5%83%8F"><span class="toc-number">2.3.7.2.</span> <span class="toc-text">制作基于 Alpine 自定义镜像的 Nginx 镜像</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%94%9F%E4%BA%A7%E6%A1%88%E4%BE%8B-%E5%9F%BA%E4%BA%8E-Ubuntu-%E5%9F%BA%E7%A1%80%E9%95%9C%E5%83%8F%E5%88%B6%E4%BD%9C-Nginx-%E9%95%9C%E5%83%8F"><span class="toc-number">2.3.8.</span> <span class="toc-text">生产案例: 基于 Ubuntu 基础镜像制作 Nginx 镜像</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Docker-%E6%95%B0%E6%8D%AE%E7%AE%A1%E7%90%86"><span class="toc-number">3.</span> <span class="toc-text">Docker 数据管理</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%B9%E5%99%A8%E7%9A%84%E6%95%B0%E6%8D%AE%E7%AE%A1%E7%90%86%E4%BB%8B%E7%BB%8D"><span class="toc-number">3.1.</span> <span class="toc-text">容器的数据管理介绍</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Docker%E5%AE%B9%E5%99%A8%E7%9A%84%E5%88%86%E5%B1%82"><span class="toc-number">3.1.1.</span> <span class="toc-text">Docker容器的分层</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%93%AA%E4%BA%9B%E6%95%B0%E6%8D%AE%E9%9C%80%E8%A6%81%E6%8C%81%E4%B9%85%E5%8C%96"><span class="toc-number">3.1.2.</span> <span class="toc-text">哪些数据需要持久化</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%B9%E5%99%A8%E6%95%B0%E6%8D%AE%E6%8C%81%E4%B9%85%E4%BF%9D%E5%AD%98%E6%96%B9%E5%BC%8F"><span class="toc-number">3.1.3.</span> <span class="toc-text">容器数据持久保存方式</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%95%B0%E6%8D%AE%E5%8D%B7-data-volume"><span class="toc-number">3.2.</span> <span class="toc-text">数据卷(data volume)</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%95%B0%E6%8D%AE%E5%8D%B7%E7%89%B9%E7%82%B9%E5%92%8C%E4%BD%BF%E7%94%A8"><span class="toc-number">3.2.1.</span> <span class="toc-text">数据卷特点和使用</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%95%B0%E6%8D%AE%E5%8D%B7%E4%BD%BF%E7%94%A8%E5%9C%BA%E6%99%AF"><span class="toc-number">3.2.1.1.</span> <span class="toc-text">数据卷使用场景</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%95%B0%E6%8D%AE%E5%8D%B7%E7%9A%84%E7%89%B9%E7%82%B9"><span class="toc-number">3.2.1.2.</span> <span class="toc-text">数据卷的特点</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%95%B0%E6%8D%AE%E5%8D%B7%E5%88%86%E7%B1%BB"><span class="toc-number">3.2.1.3.</span> <span class="toc-text">数据卷分类</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%95%B0%E6%8D%AE%E5%8D%B7%E4%BD%BF%E7%94%A8%E6%96%B9%E6%B3%95"><span class="toc-number">3.2.1.4.</span> <span class="toc-text">数据卷使用方法</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9E%E6%88%98%E6%A1%88%E4%BE%8B-%E7%9B%AE%E5%BD%95%E6%95%B0%E6%8D%AE%E5%8D%B7"><span class="toc-number">3.2.2.</span> <span class="toc-text">实战案例: 目录数据卷</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%9C%A8%E5%AE%BF%E4%B8%BB%E6%9C%BA%E5%88%9B%E5%BB%BA%E5%AE%B9%E5%99%A8%E6%89%80%E4%BD%BF%E7%94%A8%E7%9A%84%E7%9B%AE%E5%BD%95"><span class="toc-number">3.2.2.1.</span> <span class="toc-text">在宿主机创建容器所使用的目录</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%9F%A5%E7%9C%8B%E5%AE%B9%E5%99%A8%E7%9B%B8%E5%85%B3%E7%9B%AE%E5%BD%95%E8%B7%AF%E5%BE%84"><span class="toc-number">3.2.2.2.</span> <span class="toc-text">查看容器相关目录路径</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%BC%95%E7%94%A8%E5%AE%BF%E4%B8%BB%E6%9C%BA%E7%9A%84%E6%95%B0%E6%8D%AE%E5%8D%B7%E5%90%AF%E5%8A%A8%E5%AE%B9%E5%99%A8"><span class="toc-number">3.2.2.3.</span> <span class="toc-text">引用宿主机的数据卷启动容器</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%BF%9B%E5%85%A5%E5%88%B0%E5%AE%B9%E5%99%A8%E5%86%85%E6%B5%8B%E8%AF%95%E5%86%99%E5%85%A5%E6%95%B0%E6%8D%AE"><span class="toc-number">3.2.2.4.</span> <span class="toc-text">进入到容器内测试写入数据</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%9C%A8%E5%AE%BF%E4%B8%BB%E6%9C%BA%E4%BF%AE%E6%94%B9%E6%95%B0%E6%8D%AE"><span class="toc-number">3.2.2.5.</span> <span class="toc-text">在宿主机修改数据</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8F%AA%E8%AF%BB%E6%96%B9%E6%B3%95%E6%8C%82%E8%BD%BD%E6%95%B0%E6%8D%AE%E5%8D%B7"><span class="toc-number">3.2.2.6.</span> <span class="toc-text">只读方法挂载数据卷</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%A0%E9%99%A4%E5%AE%B9%E5%99%A8-1"><span class="toc-number">3.2.2.7.</span> <span class="toc-text">删除容器</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9E%E6%88%98%E6%A1%88%E4%BE%8B-MySQL%E4%BD%BF%E7%94%A8%E7%9A%84%E6%95%B0%E6%8D%AE%E5%8D%B7"><span class="toc-number">3.2.3.</span> <span class="toc-text">实战案例: MySQL使用的数据卷</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9E%E6%88%98%E6%A1%88%E4%BE%8B-%E6%96%87%E4%BB%B6%E6%95%B0%E6%8D%AE%E5%8D%B7"><span class="toc-number">3.2.4.</span> <span class="toc-text">实战案例: 文件数据卷</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%87%86%E5%A4%87%E7%9B%B8%E5%85%B3%E6%96%87%E4%BB%B6-1"><span class="toc-number">3.2.4.1.</span> <span class="toc-text">准备相关文件</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%BC%95%E7%94%A8%E6%96%87%E4%BB%B6%E6%95%B0%E6%8D%AE%E5%8D%B7%E5%90%AF%E5%8A%A8%E5%AE%B9%E5%99%A8"><span class="toc-number">3.2.4.2.</span> <span class="toc-text">引用文件数据卷启动容器</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%AA%8C%E8%AF%81%E5%AE%B9%E5%99%A8%E5%8F%AF%E4%BB%A5%E8%AE%BF%E9%97%AE"><span class="toc-number">3.2.4.3.</span> <span class="toc-text">验证容器可以访问</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%9B%B4%E6%8E%A5%E4%BF%AE%E6%94%B9%E5%AE%BF%E4%B8%BB%E6%9C%BA%E7%9A%84%E6%95%B0%E6%8D%AE"><span class="toc-number">3.2.4.4.</span> <span class="toc-text">直接修改宿主机的数据</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%BF%9B%E5%85%A5%E5%AE%B9%E5%99%A8%E4%BF%AE%E6%94%B9%E6%95%B0%E6%8D%AE"><span class="toc-number">3.2.4.5.</span> <span class="toc-text">进入容器修改数据</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%9F%A5%E7%9C%8B%E5%AE%B9%E5%99%A8%E4%B8%AD%E6%8C%82%E8%BD%BD%E5%92%8C%E8%BF%9B%E7%A8%8B%E4%BF%A1%E6%81%AF"><span class="toc-number">3.2.4.6.</span> <span class="toc-text">查看容器中挂载和进程信息</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9E%E6%88%98%E6%A1%88%E4%BE%8B-%E5%8C%BF%E5%90%8D%E6%95%B0%E6%8D%AE%E5%8D%B7"><span class="toc-number">3.2.5.</span> <span class="toc-text">实战案例: 匿名数据卷</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9E%E6%88%98%E6%A1%88%E4%BE%8B-%E5%91%BD%E5%90%8D%E6%95%B0%E6%8D%AE%E5%8D%B7"><span class="toc-number">3.2.6.</span> <span class="toc-text">实战案例: 命名数据卷</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E5%91%BD%E5%90%8D%E6%95%B0%E6%8D%AE%E5%8D%B7"><span class="toc-number">3.2.6.1.</span> <span class="toc-text">创建命名数据卷</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8%E5%91%BD%E5%90%8D%E6%95%B0%E6%8D%AE%E5%8D%B7%E5%88%9B%E5%BB%BA%E5%AE%B9%E5%99%A8"><span class="toc-number">3.2.6.2.</span> <span class="toc-text">使用命名数据卷创建容器</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E5%AE%B9%E5%99%A8%E6%97%B6%E8%87%AA%E5%8A%A8%E5%88%9B%E5%BB%BA%E5%91%BD%E5%90%8D%E6%95%B0%E6%8D%AE%E5%8D%B7"><span class="toc-number">3.2.6.3.</span> <span class="toc-text">创建容器时自动创建命名数据卷</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%A0%E9%99%A4%E6%95%B0%E6%8D%AE%E5%8D%B7"><span class="toc-number">3.2.6.4.</span> <span class="toc-text">删除数据卷</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9E%E6%88%98%E6%A1%88%E4%BE%8B%EF%BC%9A%E5%AE%9E%E7%8E%B0-wordpress-%E6%8C%81%E4%B9%85%E5%8C%96"><span class="toc-number">3.2.7.</span> <span class="toc-text">实战案例：实现 wordpress 持久化</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%95%B0%E6%8D%AE%E5%8D%B7%E5%AE%B9%E5%99%A8"><span class="toc-number">3.3.</span> <span class="toc-text">数据卷容器</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%95%B0%E6%8D%AE%E5%8D%B7%E5%AE%B9%E5%99%A8%E4%BB%8B%E7%BB%8D"><span class="toc-number">3.3.1.</span> <span class="toc-text">数据卷容器介绍</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8%E6%95%B0%E6%8D%AE%E5%8D%B7%E5%AE%B9%E5%99%A8"><span class="toc-number">3.3.2.</span> <span class="toc-text">使用数据卷容器</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9E%E6%88%98%E6%A1%88%E4%BE%8B-%E6%95%B0%E6%8D%AE%E5%8D%B7%E5%AE%B9%E5%99%A8"><span class="toc-number">3.3.3.</span> <span class="toc-text">实战案例: 数据卷容器</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E4%B8%80%E4%B8%AA%E6%95%B0%E6%8D%AE%E5%8D%B7%E5%AE%B9%E5%99%A8-Server"><span class="toc-number">3.3.3.1.</span> <span class="toc-text">创建一个数据卷容器 Server</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%90%AF%E5%8A%A8%E5%A4%9A%E4%B8%AA%E6%95%B0%E6%8D%AE%E5%8D%B7%E5%AE%B9%E5%99%A8-Client"><span class="toc-number">3.3.3.2.</span> <span class="toc-text">启动多个数据卷容器 Client</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%AA%8C%E8%AF%81%E8%AE%BF%E9%97%AE"><span class="toc-number">3.3.3.3.</span> <span class="toc-text">验证访问</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%BF%9B%E5%85%A5%E5%AE%B9%E5%99%A8%E6%B5%8B%E8%AF%95%E8%AF%BB%E5%86%99"><span class="toc-number">3.3.3.4.</span> <span class="toc-text">进入容器测试读写</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%9C%A8%E5%AE%BF%E4%B8%BB%E6%9C%BA%E7%9B%B4%E6%8E%A5%E4%BF%AE%E6%94%B9"><span class="toc-number">3.3.3.5.</span> <span class="toc-text">在宿主机直接修改</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%85%B3%E9%97%AD%E5%8D%B7%E5%AE%B9%E5%99%A8Server%E6%B5%8B%E8%AF%95%E8%83%BD%E5%90%A6%E5%90%AF%E5%8A%A8%E6%96%B0%E5%AE%B9%E5%99%A8"><span class="toc-number">3.3.3.6.</span> <span class="toc-text">关闭卷容器Server测试能否启动新容器</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%A0%E9%99%A4%E6%BA%90%E5%8D%B7%E5%AE%B9%E5%99%A8Server%EF%BC%8C%E8%AE%BF%E9%97%AEclient%E5%92%8C%E5%88%9B%E5%BB%BA%E6%96%B0%E7%9A%84client%E5%AE%B9%E5%99%A8"><span class="toc-number">3.3.3.7.</span> <span class="toc-text">删除源卷容器Server，访问client和创建新的client容器</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%87%8D%E6%96%B0%E5%88%9B%E5%BB%BA%E5%AE%B9%E5%99%A8%E5%8D%B7-Server"><span class="toc-number">3.3.3.8.</span> <span class="toc-text">重新创建容器卷 Server</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%A9%E7%94%A8%E6%95%B0%E6%8D%AE%E5%8D%B7%E5%AE%B9%E5%99%A8%E5%A4%87%E4%BB%BD%E6%8C%87%E5%AE%9A%E5%AE%B9%E5%99%A8%E7%9A%84%E6%95%B0%E6%8D%AE%E5%8D%B7%E5%AE%9E%E7%8E%B0"><span class="toc-number">3.3.4.</span> <span class="toc-text">利用数据卷容器备份指定容器的数据卷实现</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%95%B0%E6%8D%AE%E5%8D%B7%E5%AE%B9%E5%99%A8%E6%80%BB%E7%BB%93"><span class="toc-number">3.3.5.</span> <span class="toc-text">数据卷容器总结</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Docker-%E7%BD%91%E7%BB%9C%E7%AE%A1%E7%90%86"><span class="toc-number">4.</span> <span class="toc-text">Docker 网络管理</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Docker%E7%9A%84%E9%BB%98%E8%AE%A4%E7%9A%84%E7%BD%91%E7%BB%9C%E9%80%9A%E4%BF%A1"><span class="toc-number">4.1.</span> <span class="toc-text">Docker的默认的网络通信</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Docker%E5%AE%89%E8%A3%85%E5%90%8E%E9%BB%98%E8%AE%A4%E7%9A%84%E7%BD%91%E7%BB%9C%E8%AE%BE%E7%BD%AE"><span class="toc-number">4.1.1.</span> <span class="toc-text">Docker安装后默认的网络设置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E5%AE%B9%E5%99%A8%E5%90%8E%E7%9A%84%E7%BD%91%E7%BB%9C%E9%85%8D%E7%BD%AE"><span class="toc-number">4.1.2.</span> <span class="toc-text">创建容器后的网络配置</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E7%AC%AC%E4%B8%80%E4%B8%AA%E5%AE%B9%E5%99%A8%E5%90%8E%E7%9A%84%E7%BD%91%E7%BB%9C%E7%8A%B6%E6%80%81"><span class="toc-number">4.1.2.1.</span> <span class="toc-text">创建第一个容器后的网络状态</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E7%AC%AC%E4%BA%8C%E4%B8%AA%E5%AE%B9%E5%99%A8%E5%90%8E%E9%9D%A2%E7%9A%84%E7%BD%91%E7%BB%9C%E7%8A%B6%E6%80%81"><span class="toc-number">4.1.2.2.</span> <span class="toc-text">创建第二个容器后面的网络状态</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%B9%E5%99%A8%E9%97%B4%E7%9A%84%E9%80%9A%E4%BF%A1"><span class="toc-number">4.1.3.</span> <span class="toc-text">容器间的通信</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%90%8C%E4%B8%80%E4%B8%AA%E5%AE%BF%E4%B8%BB%E6%9C%BA%E7%9A%84%E4%B8%8D%E5%90%8C%E5%AE%B9%E5%99%A8%E5%8F%AF%E7%9B%B8%E4%BA%92%E9%80%9A%E4%BF%A1"><span class="toc-number">4.1.3.1.</span> <span class="toc-text">同一个宿主机的不同容器可相互通信</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%A6%81%E6%AD%A2%E5%90%8C%E4%B8%80%E4%B8%AA%E5%AE%BF%E4%B8%BB%E6%9C%BA%E7%9A%84%E4%B8%8D%E5%90%8C%E5%AE%B9%E5%99%A8%E9%97%B4%E9%80%9A%E4%BF%A1"><span class="toc-number">4.1.3.2.</span> <span class="toc-text">禁止同一个宿主机的不同容器间通信</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BF%AE%E6%94%B9%E9%BB%98%E8%AE%A4docker0%E7%BD%91%E6%A1%A5%E7%9A%84%E7%BD%91%E7%BB%9C%E9%85%8D%E7%BD%AE"><span class="toc-number">4.1.4.</span> <span class="toc-text">修改默认docker0网桥的网络配置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BF%AE%E6%94%B9%E9%BB%98%E8%AE%A4%E7%BD%91%E7%BB%9C%E8%AE%BE%E7%BD%AE%E4%BD%BF%E7%94%A8%E8%87%AA%E5%AE%9A%E4%B9%89%E7%BD%91%E6%A1%A5"><span class="toc-number">4.1.5.</span> <span class="toc-text">修改默认网络设置使用自定义网桥</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%B9%E5%99%A8%E5%90%8D%E7%A7%B0%E4%BA%92%E8%81%94"><span class="toc-number">4.2.</span> <span class="toc-text">容器名称互联</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%80%9A%E8%BF%87%E5%AE%B9%E5%99%A8%E5%90%8D%E7%A7%B0%E4%BA%92%E8%81%94"><span class="toc-number">4.2.1.</span> <span class="toc-text">通过容器名称互联</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%B9%E5%99%A8%E5%90%8D%E7%A7%B0%E4%BB%8B%E7%BB%8D"><span class="toc-number">4.2.1.1.</span> <span class="toc-text">容器名称介绍</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%B9%E5%99%A8%E5%90%8D%E7%A7%B0%E5%AE%9E%E7%8E%B0"><span class="toc-number">4.2.1.2.</span> <span class="toc-text">容器名称实现</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%9E%E6%88%98%E6%A1%88%E4%BE%8B1-%E4%BD%BF%E7%94%A8%E5%AE%B9%E5%99%A8%E5%90%8D%E7%A7%B0%E8%BF%9B%E8%A1%8C%E5%AE%B9%E5%99%A8%E9%97%B4%E9%80%9A%E4%BF%A1"><span class="toc-number">4.2.1.3.</span> <span class="toc-text">实战案例1: 使用容器名称进行容器间通信</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%9E%E6%88%98%E6%A1%88%E4%BE%8B2-%E5%AE%9E%E7%8E%B0-wordpress-%E5%92%8C-MySQL-%E4%B8%A4%E4%B8%AA%E5%AE%B9%E5%99%A8%E4%BA%92%E8%BF%9E"><span class="toc-number">4.2.1.4.</span> <span class="toc-text">实战案例2: 实现 wordpress 和 MySQL 两个容器互连</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%80%9A%E8%BF%87%E8%87%AA%E5%AE%9A%E4%B9%89%E5%AE%B9%E5%99%A8%E5%88%AB%E5%90%8D%E4%BA%92%E8%81%94"><span class="toc-number">4.2.2.</span> <span class="toc-text">通过自定义容器别名互联</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%B9%E5%99%A8%E5%88%AB%E5%90%8D%E4%BB%8B%E7%BB%8D"><span class="toc-number">4.2.2.1.</span> <span class="toc-text">容器别名介绍</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%B9%E5%99%A8%E5%88%AB%E5%90%8D%E5%AE%9E%E7%8E%B0"><span class="toc-number">4.2.2.2.</span> <span class="toc-text">容器别名实现</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%9E%E6%88%98%E6%A1%88%E4%BE%8B-%E4%BD%BF%E7%94%A8%E5%AE%B9%E5%99%A8%E5%88%AB%E5%90%8D"><span class="toc-number">4.2.2.3.</span> <span class="toc-text">实战案例: 使用容器别名</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Docker-%E7%BD%91%E7%BB%9C%E8%BF%9E%E6%8E%A5%E6%A8%A1%E5%BC%8F"><span class="toc-number">4.3.</span> <span class="toc-text">Docker 网络连接模式</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BD%91%E7%BB%9C%E6%A8%A1%E5%BC%8F%E4%BB%8B%E7%BB%8D"><span class="toc-number">4.3.1.</span> <span class="toc-text">网络模式介绍</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BD%91%E7%BB%9C%E6%A8%A1%E5%BC%8F%E6%8C%87%E5%AE%9A"><span class="toc-number">4.3.2.</span> <span class="toc-text">网络模式指定</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#bridge%E7%BD%91%E7%BB%9C%E6%A8%A1%E5%BC%8F"><span class="toc-number">4.3.3.</span> <span class="toc-text">bridge网络模式</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#bridge-%E7%BD%91%E7%BB%9C%E6%A8%A1%E5%BC%8F%E6%9E%B6%E6%9E%84"><span class="toc-number">4.3.3.1.</span> <span class="toc-text">bridge 网络模式架构</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#bridge-%E6%A8%A1%E5%BC%8F%E7%9A%84%E9%BB%98%E8%AE%A4%E8%AE%BE%E7%BD%AE"><span class="toc-number">4.3.3.2.</span> <span class="toc-text">bridge 模式的默认设置</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BF%AE%E6%94%B9%E9%BB%98%E8%AE%A4%E7%9A%84-bridge-%E6%A8%A1%E5%BC%8F%E7%BD%91%E7%BB%9C%E9%85%8D%E7%BD%AE"><span class="toc-number">4.3.3.3.</span> <span class="toc-text">修改默认的 bridge 模式网络配置</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Host-%E6%A8%A1%E5%BC%8F"><span class="toc-number">4.3.4.</span> <span class="toc-text">Host 模式</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#none-%E6%A8%A1%E5%BC%8F"><span class="toc-number">4.3.5.</span> <span class="toc-text">none 模式</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Container-%E6%A8%A1%E5%BC%8F"><span class="toc-number">4.3.6.</span> <span class="toc-text">Container 模式</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89%E7%BD%91%E7%BB%9C%E6%A8%A1%E5%BC%8F"><span class="toc-number">4.3.7.</span> <span class="toc-text">自定义网络模式</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89%E7%BD%91%E7%BB%9C%E5%AE%9E%E7%8E%B0"><span class="toc-number">4.3.7.1.</span> <span class="toc-text">自定义网络实现</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%9E%E6%88%98%E6%A1%88%E4%BE%8B-%E8%87%AA%E5%AE%9A%E4%B9%89%E7%BD%91%E7%BB%9C"><span class="toc-number">4.3.7.2.</span> <span class="toc-text">实战案例: 自定义网络</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E8%87%AA%E5%AE%9A%E4%B9%89%E7%9A%84%E7%BD%91%E7%BB%9C"><span class="toc-number">4.3.7.2.1.</span> <span class="toc-text">创建自定义的网络</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%88%A9%E7%94%A8%E8%87%AA%E5%AE%9A%E4%B9%89%E7%9A%84%E7%BD%91%E7%BB%9C%E5%88%9B%E5%BB%BA%E5%AE%B9%E5%99%A8"><span class="toc-number">4.3.7.2.2.</span> <span class="toc-text">利用自定义的网络创建容器</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%9E%E6%88%98%E6%A1%88%E4%BE%8B-%E8%87%AA%E5%AE%9A%E4%B9%89%E7%BD%91%E7%BB%9C%E4%B8%AD%E7%9A%84%E5%AE%B9%E5%99%A8%E4%B9%8B%E9%97%B4%E9%80%9A%E4%BF%A1"><span class="toc-number">4.3.7.3.</span> <span class="toc-text">实战案例: 自定义网络中的容器之间通信</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%9E%E6%88%98%E6%A1%88%E4%BE%8B-%E5%88%A9%E7%94%A8%E8%87%AA%E5%AE%9A%E4%B9%89%E7%BD%91%E7%BB%9C%E5%AE%9E%E7%8E%B0-wordpress"><span class="toc-number">4.3.7.4.</span> <span class="toc-text">实战案例: 利用自定义网络实现 wordpress</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%9E%E6%88%98%E6%A1%88%E4%BE%8B-%E5%88%A9%E7%94%A8%E8%87%AA%E5%AE%9A%E4%B9%89%E7%BD%91%E7%BB%9C%E5%AE%9E%E7%8E%B0-Redis-Cluster"><span class="toc-number">4.3.7.5.</span> <span class="toc-text">实战案例: 利用自定义网络实现 Redis Cluster</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E8%87%AA%E5%AE%9A%E4%B9%89%E7%BD%91%E7%BB%9C"><span class="toc-number">4.3.7.5.1.</span> <span class="toc-text">创建自定义网络</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA6%E4%B8%AAredis%E5%AE%B9%E5%99%A8%E9%85%8D%E7%BD%AE"><span class="toc-number">4.3.7.5.2.</span> <span class="toc-text">创建6个redis容器配置</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA6%E4%B8%AA-redis-%E5%AE%B9%E5%99%A8"><span class="toc-number">4.3.7.5.3.</span> <span class="toc-text">创建6个 redis 容器</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA-redis-cluster"><span class="toc-number">4.3.7.5.4.</span> <span class="toc-text">创建 redis cluster</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%B5%8B%E8%AF%95%E8%AE%BF%E9%97%AE-redis-cluster"><span class="toc-number">4.3.7.5.5.</span> <span class="toc-text">测试访问 redis cluster</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%B5%8B%E8%AF%95%E6%95%85%E9%9A%9C%E5%AE%9E%E7%8E%B0-redis-cluster-%E9%AB%98%E5%8F%AF%E7%94%A8%E6%80%A7"><span class="toc-number">4.3.7.5.6.</span> <span class="toc-text">测试故障实现 redis cluster 高可用性</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%90%8C%E4%B8%80%E4%B8%AA%E5%AE%BF%E4%B8%BB%E6%9C%BA%E4%B9%8B%E9%97%B4%E4%B8%8D%E5%90%8C%E7%BD%91%E7%BB%9C%E7%9A%84%E5%AE%B9%E5%99%A8%E9%80%9A%E4%BF%A1"><span class="toc-number">4.3.8.</span> <span class="toc-text">同一个宿主机之间不同网络的容器通信</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%9E%E6%88%98%E6%A1%88%E4%BE%8B-1-%E4%BF%AE%E6%94%B9iptables%E5%AE%9E%E7%8E%B0%E5%90%8C%E4%B8%80%E5%AE%BF%E4%B8%BB%E6%9C%BA%E4%B8%8A%E7%9A%84%E4%B8%8D%E5%90%8C%E7%BD%91%E7%BB%9C%E7%9A%84%E5%AE%B9%E5%99%A8%E9%97%B4%E9%80%9A%E4%BF%A1"><span class="toc-number">4.3.8.1.</span> <span class="toc-text">实战案例 1: 修改iptables实现同一宿主机上的不同网络的容器间通信</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%9E%E6%88%98%E6%A1%88%E4%BE%8B-2-%E9%80%9A%E8%BF%87%E8%A7%A3%E5%86%B3docker-network-connect-%E5%AE%9E%E7%8E%B0%E5%90%8C%E4%B8%80%E4%B8%AA%E5%AE%BF%E4%B8%BB%E6%9C%BA%E4%B8%8D%E5%90%8C%E7%BD%91%E7%BB%9C%E7%9A%84%E5%AE%B9%E5%99%A8%E9%97%B4%E9%80%9A%E4%BF%A1"><span class="toc-number">4.3.8.2.</span> <span class="toc-text">实战案例 2: 通过解决docker network connect 实现同一个宿主机不同网络的容器间通信</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%B8%8A%E9%9D%A2%E6%A1%88%E4%BE%8B%E4%B8%ADtest1%E5%92%8Ctest2%E7%9A%84%E5%AE%B9%E5%99%A8%E9%97%B4%E9%BB%98%E8%AE%A4%E6%97%A0%E6%B3%95%E9%80%9A%E4%BF%A1"><span class="toc-number">4.3.8.2.1.</span> <span class="toc-text">上面案例中test1和test2的容器间默认无法通信</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E8%AE%A9%E9%BB%98%E8%AE%A4%E7%BD%91%E7%BB%9C%E4%B8%AD%E5%AE%B9%E5%99%A8test1%E5%8F%AF%E4%BB%A5%E8%BF%9E%E9%80%9A%E8%87%AA%E5%AE%9A%E4%B9%89%E7%BD%91%E7%BB%9Ctest-net%E7%9A%84%E5%AE%B9%E5%99%A8test2"><span class="toc-number">4.3.8.2.2.</span> <span class="toc-text">让默认网络中容器test1可以连通自定义网络test-net的容器test2</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E8%AE%A9%E8%87%AA%E5%AE%9A%E4%B9%89%E7%BD%91%E7%BB%9C%E4%B8%AD%E5%AE%B9%E5%99%A8test2%E5%8F%AF%E4%BB%A5%E8%BF%9E%E9%80%9A%E9%BB%98%E8%AE%A4%E7%BD%91%E7%BB%9C%E7%9A%84%E5%AE%B9%E5%99%A8test1"><span class="toc-number">4.3.8.2.3.</span> <span class="toc-text">让自定义网络中容器test2可以连通默认网络的容器test1</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%96%AD%E5%BC%80%E4%B8%8D%E5%90%8C%E7%BD%91%E7%BB%9C%E4%B8%AD%E5%AE%B9%E5%99%A8%E7%9A%84%E9%80%9A%E4%BF%A1"><span class="toc-number">4.3.8.2.4.</span> <span class="toc-text">断开不同网络中容器的通信</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0%E8%B7%A8%E5%AE%BF%E4%B8%BB%E6%9C%BA%E7%9A%84%E5%AE%B9%E5%99%A8%E4%B9%8B%E9%97%B4%E7%BD%91%E7%BB%9C%E4%BA%92%E8%81%94"><span class="toc-number">4.4.</span> <span class="toc-text">实现跨宿主机的容器之间网络互联</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%96%B9%E5%BC%8F1-%E5%88%A9%E7%94%A8%E6%A1%A5%E6%8E%A5%E5%AE%9E%E7%8E%B0%E8%B7%A8%E5%AE%BF%E4%B8%BB%E6%9C%BA%E7%9A%84%E5%AE%B9%E5%99%A8%E9%97%B4%E4%BA%92%E8%81%94"><span class="toc-number">4.4.1.</span> <span class="toc-text">方式1: 利用桥接实现跨宿主机的容器间互联</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%96%B9%E5%BC%8F2-%E5%88%A9%E7%94%A8NAT%E5%AE%9E%E7%8E%B0%E8%B7%A8%E4%B8%BB%E6%9C%BA%E7%9A%84%E5%AE%B9%E5%99%A8%E9%97%B4%E4%BA%92%E8%81%94"><span class="toc-number">4.4.2.</span> <span class="toc-text">方式2: 利用NAT实现跨主机的容器间互联</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#docker%E8%B7%A8%E4%B8%BB%E6%9C%BA%E4%BA%92%E8%81%94%E5%AE%9E%E7%8E%B0%E8%AF%B4%E6%98%8E"><span class="toc-number">4.4.2.1.</span> <span class="toc-text">docker跨主机互联实现说明</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BF%AE%E6%94%B9%E5%90%84%E5%AE%BF%E4%B8%BB%E6%9C%BA%E7%BD%91%E6%AE%B5"><span class="toc-number">4.4.2.2.</span> <span class="toc-text">修改各宿主机网段</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E7%AC%AC%E4%B8%80%E4%B8%AA%E5%AE%BF%E4%B8%BB%E6%9C%BAA%E4%B8%8A%E6%9B%B4%E6%94%B9%E7%BD%91%E6%AE%B5"><span class="toc-number">4.4.2.2.1.</span> <span class="toc-text">第一个宿主机A上更改网段</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E7%AC%AC%E4%BA%8C%E4%B8%AA%E5%AE%BF%E4%B8%BB%E6%9C%BAB%E6%9B%B4%E6%94%B9%E7%BD%91%E6%AE%B5"><span class="toc-number">4.4.2.2.2.</span> <span class="toc-text">第二个宿主机B更改网段</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%9C%A8%E4%B8%A4%E4%B8%AA%E5%AE%BF%E4%B8%BB%E6%9C%BA%E5%88%86%E5%88%AB%E5%90%AF%E5%8A%A8%E4%B8%80%E4%B8%AA%E5%AE%B9%E5%99%A8"><span class="toc-number">4.4.2.3.</span> <span class="toc-text">在两个宿主机分别启动一个容器</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%B7%BB%E5%8A%A0%E9%9D%99%E6%80%81%E8%B7%AF%E7%94%B1%E5%92%8Ciptables%E8%A7%84%E5%88%99"><span class="toc-number">4.4.2.4.</span> <span class="toc-text">添加静态路由和iptables规则</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%9C%A8%E7%AC%AC%E4%B8%80%E5%8F%B0%E5%AE%BF%E4%B8%BB%E6%9C%BA%E6%B7%BB%E5%8A%A0%E9%9D%99%E6%80%81%E8%B7%AF%E7%94%B1%E5%92%8Ciptables%E8%A7%84%E5%88%99"><span class="toc-number">4.4.2.4.1.</span> <span class="toc-text">在第一台宿主机添加静态路由和iptables规则</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%9C%A8%E7%AC%AC%E4%BA%8C%E5%8F%B0%E5%AE%BF%E4%B8%BB%E6%9C%BA%E6%B7%BB%E5%8A%A0%E9%9D%99%E6%80%81%E8%B7%AF%E7%94%B1%E5%92%8Ciptables%E8%A7%84%E5%88%99"><span class="toc-number">4.4.2.4.2.</span> <span class="toc-text">在第二台宿主机添加静态路由和iptables规则</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%B5%8B%E8%AF%95%E8%B7%A8%E5%AE%BF%E4%B8%BB%E6%9C%BA%E4%B9%8B%E9%97%B4%E5%AE%B9%E5%99%A8%E4%BA%92%E8%81%94"><span class="toc-number">4.4.2.5.</span> <span class="toc-text">测试跨宿主机之间容器互联</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E7%AC%AC%E4%B8%89%E4%B8%AA%E5%AE%B9%E5%99%A8%E6%B5%8B%E8%AF%95"><span class="toc-number">4.4.2.6.</span> <span class="toc-text">创建第三个容器测试</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%AE%B9%E5%99%A8%E5%8D%95%E6%9C%BA%E7%BC%96%E6%8E%92%E5%B7%A5%E5%85%B7-Docker-Compose"><span class="toc-number">5.</span> <span class="toc-text">容器单机编排工具 Docker Compose</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Docker-Compose%E4%BB%8B%E7%BB%8D"><span class="toc-number">5.1.</span> <span class="toc-text">Docker Compose介绍</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%89%E8%A3%85%E5%92%8C%E5%87%86%E5%A4%87"><span class="toc-number">5.2.</span> <span class="toc-text">安装和准备</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%89%E8%A3%85Docker-Compose"><span class="toc-number">5.2.1.</span> <span class="toc-text">安装Docker Compose</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%96%B9%E6%B3%951-%E5%9C%A8%E7%BA%BF%E5%AE%89%E8%A3%85%EF%BC%8C%E9%80%9A%E8%BF%87pip%E5%AE%89%E8%A3%85"><span class="toc-number">5.2.1.1.</span> <span class="toc-text">方法1: 在线安装，通过pip安装</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%96%B9%E6%B3%952-%E5%9C%A8%E7%BA%BF%E7%9B%B4%E6%8E%A5%E4%BB%8E%E5%8C%85%E4%BB%93%E5%BA%93%E5%AE%89%E8%A3%85"><span class="toc-number">5.2.1.2.</span> <span class="toc-text">方法2: 在线直接从包仓库安装</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%96%B9%E6%B3%953-%E7%A6%BB%E7%BA%BF%E5%AE%89%E8%A3%85%EF%BC%8C%E7%9B%B4%E6%8E%A5%E4%BB%8Egithub%E6%88%96%E5%9B%BD%E5%86%85%E9%95%9C%E5%83%8F%E7%AB%99%E4%B8%8B%E8%BD%BD%E5%AE%89%E8%A3%85%E5%AF%B9%E5%BA%94%E7%89%88%E6%9C%AC"><span class="toc-number">5.2.1.3.</span> <span class="toc-text">方法3: 离线安装，直接从github或国内镜像站下载安装对应版本</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9F%A5%E7%9C%8B%E5%91%BD%E4%BB%A4%E6%A0%BC%E5%BC%8F"><span class="toc-number">5.2.2.</span> <span class="toc-text">查看命令格式</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#docker-compose-%E6%96%87%E4%BB%B6%E6%A0%BC%E5%BC%8F"><span class="toc-number">5.2.3.</span> <span class="toc-text">docker compose 文件格式</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BB%8E-docker-compose-%E5%90%AF%E5%8A%A8%E5%8D%95%E4%B8%AA%E5%AE%B9%E5%99%A8"><span class="toc-number">5.3.</span> <span class="toc-text">从 docker compose 启动单个容器</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA-docker-compose%E6%96%87%E4%BB%B6"><span class="toc-number">5.3.1.</span> <span class="toc-text">创建 docker compose文件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9F%A5%E7%9C%8B%E9%85%8D%E7%BD%AE%E5%92%8C%E6%A0%BC%E5%BC%8F%E6%A3%80%E6%9F%A5"><span class="toc-number">5.3.2.</span> <span class="toc-text">查看配置和格式检查</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%90%AF%E5%8A%A8%E5%AE%B9%E5%99%A8-2"><span class="toc-number">5.3.3.</span> <span class="toc-text">启动容器</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%AA%8C%E8%AF%81docker-compose%E6%89%A7%E8%A1%8C%E7%BB%93%E6%9E%9C"><span class="toc-number">5.3.4.</span> <span class="toc-text">验证docker compose执行结果</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BB%93%E6%9D%9F%E5%89%8D%E5%8F%B0%E6%89%A7%E8%A1%8C"><span class="toc-number">5.3.5.</span> <span class="toc-text">结束前台执行</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%A0%E9%99%A4%E5%AE%B9%E5%99%A8-2"><span class="toc-number">5.3.6.</span> <span class="toc-text">删除容器</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%90%8E%E5%8F%B0%E6%89%A7%E8%A1%8C"><span class="toc-number">5.3.7.</span> <span class="toc-text">后台执行</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%81%9C%E6%AD%A2%E5%92%8C%E5%90%AF%E5%8A%A8%E4%B8%8E%E6%97%A5%E5%BF%97%E6%9F%A5%E7%9C%8B"><span class="toc-number">5.3.8.</span> <span class="toc-text">停止和启动与日志查看</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9A%82%E5%81%9C%E5%92%8C%E6%81%A2%E5%A4%8D"><span class="toc-number">5.3.9.</span> <span class="toc-text">暂停和恢复</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BB%8E-docker-compose-%E5%90%AF%E5%8A%A8%E5%A4%9A%E4%B8%AA%E5%AE%B9%E5%99%A8"><span class="toc-number">5.4.</span> <span class="toc-text">从 docker compose 启动多个容器</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BC%96%E8%BE%91-docker-compose-%E6%96%87%E4%BB%B6%E5%B9%B6%E4%BD%BF%E7%94%A8%E6%95%B0%E6%8D%AE%E5%8D%B7"><span class="toc-number">5.4.1.</span> <span class="toc-text">编辑 docker-compose 文件并使用数据卷</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%90%AF%E5%8A%A8%E5%AE%B9%E5%99%A8%E5%B9%B6%E9%AA%8C%E8%AF%81%E7%BB%93%E6%9E%9C"><span class="toc-number">5.4.2.</span> <span class="toc-text">启动容器并验证结果</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%8C%87%E5%AE%9A%E5%90%8C%E6%97%B6%E5%90%AF%E5%8A%A8%E5%AE%B9%E5%99%A8%E7%9A%84%E6%95%B0%E9%87%8F"><span class="toc-number">5.4.3.</span> <span class="toc-text">指定同时启动容器的数量</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%89%A9%E5%AE%B9%E5%92%8C%E7%BC%A9%E5%AE%B9"><span class="toc-number">5.4.4.</span> <span class="toc-text">扩容和缩容</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%9E%E6%88%98%E6%A1%88%E4%BE%8B-%E5%AE%9E%E7%8E%B0-Wordpress-%E5%BA%94%E7%94%A8"><span class="toc-number">5.5.</span> <span class="toc-text">实战案例: 实现 Wordpress 应用</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%9E%E6%88%98%E6%A1%88%E4%BE%8B-%E6%90%AD%E5%BB%BA%E8%BF%90%E7%BB%B4%E5%B9%B3%E5%8F%B0-Spug"><span class="toc-number">5.6.</span> <span class="toc-text">实战案例: 搭建运维平台 Spug</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%A1%88%E4%BE%8B-%E4%B8%80%E9%94%AE%E7%94%9F%E6%88%90-Docker-Compose"><span class="toc-number">5.7.</span> <span class="toc-text">案例: 一键生成 Docker Compose</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Docker-%E4%BB%93%E5%BA%93%E7%AE%A1%E7%90%86"><span class="toc-number">6.</span> <span class="toc-text">Docker 仓库管理</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%98%E6%96%B9-Docker-%E4%BB%93%E5%BA%93"><span class="toc-number">6.1.</span> <span class="toc-text">官方 Docker 仓库</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B3%A8%E5%86%8C%E8%B4%A6%E6%88%B7"><span class="toc-number">6.1.1.</span> <span class="toc-text">注册账户</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8%E7%94%A8%E6%88%B7%E4%BB%93%E5%BA%93%E7%AE%A1%E7%90%86%E9%95%9C%E5%83%8F"><span class="toc-number">6.1.2.</span> <span class="toc-text">使用用户仓库管理镜像</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%94%A8%E6%88%B7%E7%99%BB%E5%BD%95"><span class="toc-number">6.1.2.1.</span> <span class="toc-text">用户登录</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%BB%99%E6%9C%AC%E5%9C%B0%E9%95%9C%E5%83%8F%E6%89%93%E6%A0%87%E7%AD%BE"><span class="toc-number">6.1.2.2.</span> <span class="toc-text">给本地镜像打标签</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%8A%E4%BC%A0%E6%9C%AC%E5%9C%B0%E9%95%9C%E5%83%8F%E8%87%B3%E5%AE%98%E7%BD%91"><span class="toc-number">6.1.2.3.</span> <span class="toc-text">上传本地镜像至官网</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%9C%A8%E5%AE%98%E7%BD%91%E9%AA%8C%E8%AF%81%E4%B8%8A%E4%BC%A0%E7%9A%84%E9%95%9C%E5%83%8F"><span class="toc-number">6.1.2.4.</span> <span class="toc-text">在官网验证上传的镜像</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%8B%E8%BD%BD%E4%B8%8A%E4%BC%A0%E7%9A%84%E9%95%9C%E5%83%8F%E5%B9%B6%E5%88%9B%E5%BB%BA%E5%AE%B9%E5%99%A8"><span class="toc-number">6.1.2.5.</span> <span class="toc-text">下载上传的镜像并创建容器</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8%E7%BB%84%E7%BB%87%E7%AE%A1%E7%90%86%E9%95%9C%E5%83%8F"><span class="toc-number">6.1.3.</span> <span class="toc-text">使用组织管理镜像</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E7%BB%84%E7%BB%87"><span class="toc-number">6.1.3.1.</span> <span class="toc-text">创建组织</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E7%BB%84%E7%BB%87%E5%86%85%E7%9A%84%E5%9B%A2%E9%98%9F%EF%BC%8C%E5%B9%B6%E5%88%86%E9%85%8D%E6%9D%83%E9%99%90"><span class="toc-number">6.1.3.2.</span> <span class="toc-text">创建组织内的团队，并分配权限</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%8A%E4%BC%A0%E9%95%9C%E5%83%8F%E5%89%8D%E7%99%BB%E5%BD%95%E5%B8%90%E5%8F%B7"><span class="toc-number">6.1.3.3.</span> <span class="toc-text">上传镜像前登录帐号</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%BB%99%E6%9C%AC%E5%9C%B0%E9%95%9C%E5%83%8F%E6%89%93%E6%A0%87%E7%AD%BE-1"><span class="toc-number">6.1.3.4.</span> <span class="toc-text">给本地镜像打标签</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%8A%E4%BC%A0%E9%95%9C%E5%83%8F%E5%88%B0%E6%8C%87%E5%AE%9A%E7%9A%84%E7%BB%84%E7%BB%87"><span class="toc-number">6.1.3.5.</span> <span class="toc-text">上传镜像到指定的组织</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%9C%A8%E7%BD%91%E7%AB%99%E7%9C%8B%E6%9F%A5%E7%9C%8B%E4%B8%8A%E4%BC%A0%E7%9A%84%E9%95%9C%E5%83%8F"><span class="toc-number">6.1.3.6.</span> <span class="toc-text">在网站看查看上传的镜像</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%8B%E8%BD%BD%E4%B8%8A%E4%BC%A0%E7%9A%84%E9%95%9C%E5%83%8F%E5%B9%B6%E8%BF%90%E8%A1%8C%E5%AE%B9%E5%99%A8"><span class="toc-number">6.1.3.7.</span> <span class="toc-text">下载上传的镜像并运行容器</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%98%BF%E9%87%8C%E4%BA%91Docker%E4%BB%93%E5%BA%93"><span class="toc-number">6.2.</span> <span class="toc-text">阿里云Docker仓库</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B3%A8%E5%86%8C%E5%92%8C%E7%99%BB%E5%BD%95%E9%98%BF%E9%87%8C%E4%BA%91%E4%BB%93%E5%BA%93"><span class="toc-number">6.2.1.</span> <span class="toc-text">注册和登录阿里云仓库</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%AE%BE%E7%BD%AE%E4%BB%93%E5%BA%93%E4%B8%93%E7%94%A8%E7%AE%A1%E7%90%86%E5%AF%86%E7%A0%81"><span class="toc-number">6.2.2.</span> <span class="toc-text">设置仓库专用管理密码</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E4%BB%93%E5%BA%93"><span class="toc-number">6.2.3.</span> <span class="toc-text">创建仓库</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%8A%E4%BC%A0%E9%95%9C%E5%83%8F%E5%89%8D%E5%85%88%E7%99%BB%E5%BD%95%E9%98%BF%E9%87%8C%E4%BA%91"><span class="toc-number">6.2.4.</span> <span class="toc-text">上传镜像前先登录阿里云</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BB%99%E4%B8%8A%E4%BC%A0%E7%9A%84%E9%95%9C%E5%83%8F%E6%89%93%E6%A0%87%E7%AD%BE"><span class="toc-number">6.2.5.</span> <span class="toc-text">给上传的镜像打标签</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%8A%E4%BC%A0%E9%95%9C%E5%83%8F%E8%87%B3%E9%98%BF%E9%87%8C%E4%BA%91"><span class="toc-number">6.2.6.</span> <span class="toc-text">上传镜像至阿里云</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9C%A8%E7%BD%91%E7%AB%99%E6%9F%A5%E7%9C%8B%E4%B8%8A%E4%BC%A0%E7%9A%84%E9%95%9C%E5%83%8F"><span class="toc-number">6.2.7.</span> <span class="toc-text">在网站查看上传的镜像</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BB%8E%E5%8F%A6%E4%B8%80%E5%8F%B0%E4%B8%BB%E6%9C%BA%E4%B8%8A%E4%B8%8B%E8%BD%BD%E5%88%9A%E4%B8%8A%E4%BC%A0%E7%9A%84%E9%95%9C%E5%83%8F%E5%B9%B6%E8%BF%90%E8%A1%8C%E5%AE%B9%E5%99%A8"><span class="toc-number">6.2.8.</span> <span class="toc-text">从另一台主机上下载刚上传的镜像并运行容器</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%A7%81%E6%9C%89%E4%BA%91%E5%8D%95%E6%9C%BA%E4%BB%93%E5%BA%93Docker-Registry"><span class="toc-number">6.3.</span> <span class="toc-text">私有云单机仓库Docker Registry</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Docker-Registry-%E4%BB%8B%E7%BB%8D"><span class="toc-number">6.3.1.</span> <span class="toc-text">Docker Registry 介绍</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%8B%E8%BD%BD-docker-registry-%E9%95%9C%E5%83%8F"><span class="toc-number">6.3.2.</span> <span class="toc-text">下载 docker registry 镜像</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%90%AD%E5%BB%BA%E5%8D%95%E6%9C%BA%E4%BB%93%E5%BA%93"><span class="toc-number">6.3.3.</span> <span class="toc-text">搭建单机仓库</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E6%8E%88%E6%9D%83%E7%94%A8%E6%88%B7%E5%AF%86%E7%A0%81%E4%BD%BF%E7%94%A8%E7%9B%AE%E5%BD%95"><span class="toc-number">6.3.3.1.</span> <span class="toc-text">创建授权用户密码使用目录</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E6%8E%88%E6%9D%83%E7%9A%84registry%E7%94%A8%E6%88%B7%E5%92%8C%E5%AF%86%E7%A0%81"><span class="toc-number">6.3.3.2.</span> <span class="toc-text">创建授权的registry用户和密码</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%90%AF%E5%8A%A8docker-registry-%E5%AE%B9%E5%99%A8"><span class="toc-number">6.3.3.3.</span> <span class="toc-text">启动docker registry 容器</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%AA%8C%E8%AF%81%E7%AB%AF%E5%8F%A3%E5%92%8C%E5%AE%B9%E5%99%A8"><span class="toc-number">6.3.3.4.</span> <span class="toc-text">验证端口和容器</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%99%BB%E5%BD%95%E4%BB%93%E5%BA%93"><span class="toc-number">6.3.4.</span> <span class="toc-text">登录仓库</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%9B%B4%E6%8E%A5%E7%99%BB%E5%BD%95%E6%8A%A5%E9%94%99"><span class="toc-number">6.3.4.1.</span> <span class="toc-text">直接登录报错</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%B0%86registry%E4%BB%93%E5%BA%93%E6%9C%8D%E5%8A%A1%E5%99%A8%E5%9C%B0%E5%9D%80%E5%8A%A0%E5%85%A5service-%E5%8D%95%E5%85%83%E6%96%87%E4%BB%B6"><span class="toc-number">6.3.4.2.</span> <span class="toc-text">将registry仓库服务器地址加入service 单元文件</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%86%8D%E6%AC%A1%E7%99%BB%E5%BD%95%E9%AA%8C%E8%AF%81%E6%88%90%E5%8A%9F"><span class="toc-number">6.3.4.3.</span> <span class="toc-text">再次登录验证成功</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%89%93%E6%A0%87%E7%AD%BE%E5%B9%B6%E4%B8%8A%E4%BC%A0%E9%95%9C%E5%83%8F"><span class="toc-number">6.3.5.</span> <span class="toc-text">打标签并上传镜像</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%8B%E8%BD%BD%E9%95%9C%E5%83%8F%E5%B9%B6%E5%90%AF%E5%8A%A8%E5%AE%B9%E5%99%A8"><span class="toc-number">6.3.6.</span> <span class="toc-text">下载镜像并启动容器</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%85%88%E4%BF%AE%E6%94%B9docker%E7%9A%84service-%E6%96%87%E4%BB%B6"><span class="toc-number">6.3.6.1.</span> <span class="toc-text">先修改docker的service 文件</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%99%BB%E5%BD%95registry%E4%BB%93%E5%BA%93%E6%9C%8D%E5%8A%A1%E5%99%A8"><span class="toc-number">6.3.6.2.</span> <span class="toc-text">登录registry仓库服务器</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%8B%E8%BD%BD%E9%95%9C%E5%83%8F%E5%B9%B6%E5%90%AF%E5%8A%A8%E5%AE%B9%E5%99%A8-1"><span class="toc-number">6.3.6.3.</span> <span class="toc-text">下载镜像并启动容器</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Docker-%E4%B9%8B%E5%88%86%E5%B8%83%E5%BC%8F%E4%BB%93%E5%BA%93-Harbor"><span class="toc-number">6.4.</span> <span class="toc-text">Docker 之分布式仓库 Harbor</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Harbor-%E4%BB%8B%E7%BB%8D%E5%92%8C%E6%9E%B6%E6%9E%84"><span class="toc-number">6.4.1.</span> <span class="toc-text">Harbor 介绍和架构</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Harbor-%E4%BB%8B%E7%BB%8D"><span class="toc-number">6.4.1.1.</span> <span class="toc-text">Harbor 介绍</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Harbor%E5%8A%9F%E8%83%BD%E5%AE%98%E6%96%B9%E4%BB%8B%E7%BB%8D"><span class="toc-number">6.4.1.2.</span> <span class="toc-text">Harbor功能官方介绍</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Harbor-%E7%BB%84%E6%88%90"><span class="toc-number">6.4.1.3.</span> <span class="toc-text">Harbor 组成</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%89%E8%A3%85-Harbor"><span class="toc-number">6.4.2.</span> <span class="toc-text">安装 Harbor</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%8B%E8%BD%BDHarbor%E5%AE%89%E8%A3%85%E5%8C%85%E5%B9%B6%E8%A7%A3%E5%8E%8B%E7%BC%A9"><span class="toc-number">6.4.2.1.</span> <span class="toc-text">下载Harbor安装包并解压缩</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%BC%96%E8%BE%91-harbor-%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6"><span class="toc-number">6.4.2.2.</span> <span class="toc-text">编辑 harbor 配置文件</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%BF%90%E8%A1%8C-harbor-%E5%AE%89%E8%A3%85%E8%84%9A%E6%9C%AC"><span class="toc-number">6.4.2.3.</span> <span class="toc-text">运行 harbor 安装脚本</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0%E5%BC%80%E6%9C%BA%E8%87%AA%E5%8A%A8%E5%90%AF%E5%8A%A8-harbor"><span class="toc-number">6.4.2.4.</span> <span class="toc-text">实现开机自动启动 harbor</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%96%B9%E6%B3%951-%E9%80%9A%E8%BF%87service%E6%96%87%E4%BB%B6%E5%AE%9E%E7%8E%B0"><span class="toc-number">6.4.2.4.1.</span> <span class="toc-text">方法1: 通过service文件实现</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%96%B9%E6%B3%952-%E9%80%9A%E8%BF%87-rc-local%E5%AE%9E%E7%8E%B0"><span class="toc-number">6.4.2.4.2.</span> <span class="toc-text">方法2: 通过 rc.local实现</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%99%BB%E5%BD%95-harbor-%E4%B8%BB%E6%9C%BA%E7%BD%91%E7%AB%99"><span class="toc-number">6.4.2.5.</span> <span class="toc-text">登录 harbor 主机网站</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%9E%E6%88%98%E6%A1%88%E4%BE%8B-%E4%B8%80%E9%94%AE%E5%AE%89%E8%A3%85Harbor%E8%84%9A%E6%9C%AC"><span class="toc-number">6.4.2.6.</span> <span class="toc-text">实战案例: 一键安装Harbor脚本</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%AE%89%E8%A3%85harbor-1-7-6"><span class="toc-number">6.4.2.6.1.</span> <span class="toc-text">安装harbor 1.7.6</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8%E5%8D%95%E4%B8%BB%E6%9C%BA-Harbor"><span class="toc-number">6.4.3.</span> <span class="toc-text">使用单主机 Harbor</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%BB%BA%E7%AB%8B%E9%A1%B9%E7%9B%AE"><span class="toc-number">6.4.3.1.</span> <span class="toc-text">建立项目</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%91%BD%E4%BB%A4%E8%A1%8C%E7%99%BB%E5%BD%95-harbor"><span class="toc-number">6.4.3.2.</span> <span class="toc-text">命令行登录 harbor</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%BB%99%E6%9C%AC%E5%9C%B0%E9%95%9C%E5%83%8F%E6%89%93%E6%A0%87%E7%AD%BE%E5%B9%B6%E4%B8%8A%E4%BC%A0%E5%88%B0-Harbor"><span class="toc-number">6.4.3.3.</span> <span class="toc-text">给本地镜像打标签并上传到 Harbor</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%8B%E8%BD%BD-Harbor-%E7%9A%84%E9%95%9C%E5%83%8F"><span class="toc-number">6.4.3.4.</span> <span class="toc-text">下载 Harbor 的镜像</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E8%87%AA%E5%8A%A8%E6%89%93%E6%A0%87%E7%AD%BE%E4%B8%8A%E4%BC%A0%E9%95%9C%E5%83%8F%E8%84%9A%E6%9C%AC"><span class="toc-number">6.4.3.5.</span> <span class="toc-text">创建自动打标签上传镜像脚本</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BF%AE%E6%94%B9-Harbor-%E9%85%8D%E7%BD%AE"><span class="toc-number">6.4.3.6.</span> <span class="toc-text">修改 Harbor 配置</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%89%E8%A3%85%E7%AC%AC%E4%BA%8C%E5%8F%B0-harbor%E4%B8%BB%E6%9C%BA"><span class="toc-number">6.4.3.7.</span> <span class="toc-text">安装第二台 harbor主机</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%AC%AC%E4%BA%8C%E5%8F%B0harbor%E4%B8%8A%E6%96%B0%E5%BB%BA%E9%A1%B9%E7%9B%AE"><span class="toc-number">6.4.3.8.</span> <span class="toc-text">第二台harbor上新建项目</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%AC%AC%E4%BA%8C%E5%8F%B0harbor%E4%B8%8A%E4%BB%93%E5%BA%93%E7%AE%A1%E7%90%86%E4%B8%AD%E6%96%B0%E5%BB%BA%E7%9B%AE%E6%A0%87"><span class="toc-number">6.4.3.9.</span> <span class="toc-text">第二台harbor上仓库管理中新建目标</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%AC%AC%E4%BA%8C%E5%8F%B0harbor%E4%B8%8A%E6%96%B0%E5%BB%BA%E5%A4%8D%E5%88%B6%E8%A7%84%E5%88%99%E5%AE%9E%E7%8E%B0%E5%88%B0%E7%AC%AC%E4%B8%80%E5%8F%B0harbor%E7%9A%84%E5%8D%95%E5%90%91%E5%A4%8D%E5%88%B6"><span class="toc-number">6.4.3.10.</span> <span class="toc-text">第二台harbor上新建复制规则实现到第一台harbor的单向复制</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%9C%A8%E7%AC%AC%E4%B8%80%E5%8F%B0harbor%E4%B8%BB%E6%9C%BA%E4%B8%8A%E9%87%8D%E5%A4%8D%E4%B8%8A%E9%9D%A2%E6%93%8D%E4%BD%9C"><span class="toc-number">6.4.3.11.</span> <span class="toc-text">在第一台harbor主机上重复上面操作</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%A1%AE%E8%AE%A4%E5%90%8C%E6%AD%A5%E6%88%90%E5%8A%9F"><span class="toc-number">6.4.3.12.</span> <span class="toc-text">确认同步成功</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%8A%E4%BC%A0%E9%95%9C%E5%83%8F%E8%A7%82%E5%AF%9F%E6%98%AF%E5%90%A6%E5%8F%AF%E4%BB%A5%E5%8F%8C%E9%AB%98%E5%90%8C%E6%AD%A5"><span class="toc-number">6.4.3.13.</span> <span class="toc-text">上传镜像观察是否可以双高同步</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%A0%E9%99%A4%E9%95%9C%E5%83%8F%E8%A7%82%E5%AF%9F%E6%98%AF%E5%90%A6%E5%8F%AF%E8%87%AA%E5%8A%A8%E5%90%8C%E6%AD%A5"><span class="toc-number">6.4.3.14.</span> <span class="toc-text">删除镜像观察是否可自动同步</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE-Nginx-%E5%81%9A%E4%B8%BA%E5%8F%8D%E5%90%91%E4%BB%A3%E7%90%86"><span class="toc-number">6.4.3.15.</span> <span class="toc-text">配置 Nginx 做为反向代理</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Harbor-%E5%AE%89%E5%85%A8-Https-%E9%85%8D%E7%BD%AE"><span class="toc-number">6.4.4.</span> <span class="toc-text">Harbor 安全 Https 配置</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%96%B0%E7%89%88%E5%AE%9E%E7%8E%B0%E5%AE%9E%E7%8E%B0-Harbor-%E7%9A%84-Https-%E8%AE%A4%E8%AF%81"><span class="toc-number">6.4.4.1.</span> <span class="toc-text">新版实现实现 Harbor 的 Https 认证</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E7%94%9F%E6%88%90-Harbor-%E6%9C%8D%E5%8A%A1%E5%99%A8%E8%AF%81%E4%B9%A6"><span class="toc-number">6.4.4.1.1.</span> <span class="toc-text">生成 Harbor 服务器证书</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE-Harbor-%E6%9C%8D%E5%8A%A1%E5%99%A8%E4%BD%BF%E7%94%A8%E8%AF%81%E4%B9%A6"><span class="toc-number">6.4.4.1.2.</span> <span class="toc-text">配置 Harbor 服务器使用证书</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE-Docker-%E5%AE%A2%E6%88%B7%E7%AB%AF%E4%BD%BF%E7%94%A8%E8%AF%81%E4%B9%A6%E6%96%87%E4%BB%B6"><span class="toc-number">6.4.4.1.3.</span> <span class="toc-text">配置 Docker 客户端使用证书文件</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#Docker-%E5%AE%A2%E6%88%B7%E7%AB%AF%E6%B5%8B%E8%AF%95%E6%8E%A8%E9%80%81%E5%92%8C%E6%8B%89%E5%8F%96%E9%95%9C%E5%83%8F"><span class="toc-number">6.4.4.1.4.</span> <span class="toc-text">Docker 客户端测试推送和拉取镜像</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%97%A7%E7%89%88%E5%AE%9E%E7%8E%B0-Harbor-%E7%9A%84-Https-%E8%AE%A4%E8%AF%81"><span class="toc-number">6.4.4.2.</span> <span class="toc-text">旧版实现 Harbor 的 Https 认证</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0Harbor-%E7%9A%84-https-%E8%AE%A4%E8%AF%81"><span class="toc-number">6.4.4.2.1.</span> <span class="toc-text">实现Harbor 的 https 认证</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E7%94%A8https%E6%96%B9%E5%BC%8F%E8%AE%BF%E9%97%AEharbor%E7%BD%91%E7%AB%99"><span class="toc-number">6.4.4.2.2.</span> <span class="toc-text">用https方式访问harbor网站</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%9C%A8harbor%E7%BD%91%E7%AB%99%E6%96%B0%E5%BB%BA%E9%A1%B9%E7%9B%AE"><span class="toc-number">6.4.4.2.3.</span> <span class="toc-text">在harbor网站新建项目</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%9C%A8%E5%AE%A2%E6%88%B7%E7%AB%AF%E4%B8%8B%E8%BD%BDCA%E7%9A%84%E8%AF%81%E4%B9%A6"><span class="toc-number">6.4.4.2.4.</span> <span class="toc-text">在客户端下载CA的证书</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%BB%8E%E5%AE%A2%E6%88%B7%E7%AB%AF%E4%B8%8A%E4%BC%A0%E9%95%9C%E5%83%8F"><span class="toc-number">6.4.4.2.5.</span> <span class="toc-text">从客户端上传镜像</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%9C%A8%E5%AE%A2%E6%88%B7%E7%AB%AF%E4%B8%8B%E8%BD%BD%E9%95%9C%E5%83%8F"><span class="toc-number">6.4.4.2.6.</span> <span class="toc-text">在客户端下载镜像</span></a></li></ol></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Docker-%E7%9A%84%E8%B5%84%E6%BA%90%E9%99%90%E5%88%B6"><span class="toc-number">7.</span> <span class="toc-text">Docker 的资源限制</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Docker-%E8%B5%84%E6%BA%90%E9%99%90%E5%88%B6"><span class="toc-number">7.1.</span> <span class="toc-text">Docker 资源限制</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%B9%E5%99%A8%E8%B5%84%E6%BA%90%E9%99%90%E5%88%B6%E4%BB%8B%E7%BB%8D"><span class="toc-number">7.1.1.</span> <span class="toc-text">容器资源限制介绍</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#OOM-%EF%BC%88Out-of-Memory-Exception%EF%BC%89"><span class="toc-number">7.1.2.</span> <span class="toc-text">OOM （Out of Memory Exception）</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Stress-ng-%E5%8E%8B%E5%8A%9B%E6%B5%8B%E8%AF%95%E5%B7%A5%E5%85%B7"><span class="toc-number">7.2.</span> <span class="toc-text">Stress-ng 压力测试工具</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Stress-ng-%E5%B7%A5%E5%85%B7%E4%BB%8B%E7%BB%8D"><span class="toc-number">7.2.1.</span> <span class="toc-text">Stress-ng 工具介绍</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#stress-ng-%E5%AE%89%E8%A3%85"><span class="toc-number">7.2.2.</span> <span class="toc-text">stress-ng 安装</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Stress-ng-%E4%BD%BF%E7%94%A8"><span class="toc-number">7.2.3.</span> <span class="toc-text">Stress-ng 使用</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%B9%E5%99%A8%E7%9A%84%E5%86%85%E5%AD%98%E9%99%90%E5%88%B6"><span class="toc-number">7.3.</span> <span class="toc-text">容器的内存限制</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%86%85%E5%AD%98%E7%9B%B8%E5%85%B3%E9%80%89%E9%A1%B9"><span class="toc-number">7.3.1.</span> <span class="toc-text">内存相关选项</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#swap%E9%99%90%E5%88%B6"><span class="toc-number">7.3.2.</span> <span class="toc-text">swap限制</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8stress-ng%E6%B5%8B%E8%AF%95%E5%86%85%E5%AD%98%E9%99%90%E5%88%B6"><span class="toc-number">7.3.3.</span> <span class="toc-text">使用stress-ng测试内存限制</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%B9%E5%99%A8%E7%9A%84-CPU-%E9%99%90%E5%88%B6"><span class="toc-number">7.4.</span> <span class="toc-text">容器的 CPU 限制</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%B9%E5%99%A8%E7%9A%84-CPU-%E9%99%90%E5%88%B6%E4%BB%8B%E7%BB%8D"><span class="toc-number">7.4.1.</span> <span class="toc-text">容器的 CPU 限制介绍</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE%E9%BB%98%E8%AE%A4%E7%9A%84CFS%E8%B0%83%E5%BA%A6%E7%A8%8B%E5%BA%8F"><span class="toc-number">7.4.2.</span> <span class="toc-text">配置默认的CFS调度程序</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8-Stress-ng-%E6%B5%8B%E8%AF%95-Cpu-%E9%85%8D%E7%BD%AE"><span class="toc-number">7.4.3.</span> <span class="toc-text">使用 Stress-ng 测试 Cpu 配置</span></a></li></ol></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2025/04/16/SRE-Keepalived/" title="高可用性集群Keepalived"><img src="/../images/SRE/day48/1.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="高可用性集群Keepalived"/></a><div class="content"><a class="title" href="/2025/04/16/SRE-Keepalived/" title="高可用性集群Keepalived">高可用性集群Keepalived</a><time datetime="2025-04-16T09:15:13.000Z" title="发表于 2025-04-16 17:15:13">2025-04-16</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2025/04/15/SRE-HAProxy/" title="高可用性集群HAProxy"><img src="/../images/SRE/day47/1.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="高可用性集群HAProxy"/></a><div class="content"><a class="title" href="/2025/04/15/SRE-HAProxy/" title="高可用性集群HAProxy">高可用性集群HAProxy</a><time datetime="2025-04-15T15:51:45.000Z" title="发表于 2025-04-15 23:51:45">2025-04-15</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2025/04/13/SRE-docker/" title="企业级容器技术Docker"><img src="/../images/SRE/day46/1.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="企业级容器技术Docker"/></a><div class="content"><a class="title" href="/2025/04/13/SRE-docker/" title="企业级容器技术Docker">企业级容器技术Docker</a><time datetime="2025-04-13T09:39:38.000Z" title="发表于 2025-04-13 17:39:38">2025-04-13</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2025/04/01/SRE-kvm/" title="企业级Linux虚拟化KVM"><img src="/../images/SRE/day41/21.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="企业级Linux虚拟化KVM"/></a><div class="content"><a class="title" href="/2025/04/01/SRE-kvm/" title="企业级Linux虚拟化KVM">企业级Linux虚拟化KVM</a><time datetime="2025-04-01T09:21:21.000Z" title="发表于 2025-04-01 17:21:21">2025-04-01</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2023 - 2025 By ૮(˶ᵔ ᵕ ᵔ˶)ა</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div><div class="footer_custom_text"><a target="_blank" rel="noopener" href="https://beian.miit.gov.cn/#/Integrated/index"><img src="../images/BEIAN/icp.png" width="15" height="15">豫ICP备2023009931号</a></br><a href="http://www.beian.gov.cn/portal/registerSystemInfo?recordcode=41162702000178" target="_blank"><img src="../images/BEIAN/beian.png" width="15" height="15">豫公网安备 41162702000178号</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.umd.min.js"></script><script src="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.js"></script><script>function panguFn () {
  if (typeof pangu === 'object') pangu.autoSpacingPage()
  else {
    getScript('https://cdn.jsdelivr.net/npm/pangu/dist/browser/pangu.min.js')
      .then(() => {
        pangu.autoSpacingPage()
      })
  }
}

function panguInit () {
  if (true){
    GLOBAL_CONFIG_SITE.isPost && panguFn()
  } else {
    panguFn()
  }
}

document.addEventListener('DOMContentLoaded', panguInit)</script><div class="js-pjax"></div><canvas id="universe"></canvas><script src="/js/universe.js"></script><canvas class="fireworks" mobile="true"></canvas><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/fireworks.min.js"></script><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/activate-power-mode.min.js"></script><script>POWERMODE.colorful = true;
POWERMODE.shake = false;
POWERMODE.mobile = false;
document.body.addEventListener('input', POWERMODE);
</script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>