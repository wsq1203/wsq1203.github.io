<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>消息队列和微服务 | ૮(˶ᵔ ᵕ ᵔ˶)ა</title><meta name="author" content="૮(˶ᵔ ᵕ ᵔ˶)ა"><meta name="copyright" content="૮(˶ᵔ ᵕ ᵔ˶)ა"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="ffffff"><meta name="description" content="Site Reliability Engineering">
<meta property="og:type" content="article">
<meta property="og:title" content="消息队列和微服务">
<meta property="og:url" content="http://example.com/2025/04/21/SRE-kafka/index.html">
<meta property="og:site_name" content="૮(˶ᵔ ᵕ ᵔ˶)ა">
<meta property="og:description" content="Site Reliability Engineering">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://example.com/images/SRE/day52/30.jpg">
<meta property="article:published_time" content="2025-04-21T15:34:02.000Z">
<meta property="article:modified_time" content="2025-04-21T15:34:56.185Z">
<meta property="article:author" content="૮(˶ᵔ ᵕ ᵔ˶)ა">
<meta property="article:tag" content="SRE">
<meta property="article:tag" content="zookeeper">
<meta property="article:tag" content="kafka">
<meta property="article:tag" content="Dubbo">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://example.com/images/SRE/day52/30.jpg"><link rel="shortcut icon" href="/../images/TITLE/user.webp"><link rel="canonical" href="http://example.com/2025/04/21/SRE-kafka/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//fonts.googleapis.com" crossorigin=""/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Titillium+Web&amp;display=swap" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":false,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: true,
    post: true
  },
  runtime: '天',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: {"chs_to_cht":"你已切换为繁体","cht_to_chs":"你已切换为简体","day_to_night":"你已切换为深色模式","night_to_day":"你已切换为浅色模式","bgLight":"#49b1f5","bgDark":"#1f1f1f","position":"top-center"},
  source: {
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: true,
  }
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: '消息队列和微服务',
  isPost: true,
  isHome: false,
  isHighlightShrink: undefined,
  isToc: true,
  postUpdate: '2025-04-21 23:34:56'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
    win.getCSS = (url,id = false) => new Promise((resolve, reject) => {
      const link = document.createElement('link')
      link.rel = 'stylesheet'
      link.href = url
      if (id) link.id = id
      link.onerror = reject
      link.onload = link.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        link.onload = link.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(link)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', 'ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><link rel="stylesheet" href="/css/custom.css"  media="defer" onload="this.media='all'"><meta name="generator" content="Hexo 5.4.2"></head><body><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="/../images/TITLE/user.webp" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">102</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">41</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">34</div></a></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间线</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('/../images/SRE/day52/30.jpg')"><nav id="nav"><span id="blog-info"><a href="/" title="૮(˶ᵔ ᵕ ᵔ˶)ა"><span class="site-name">૮(˶ᵔ ᵕ ᵔ˶)ა</span></a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间线</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">消息队列和微服务</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2025-04-21T15:34:02.000Z" title="发表于 2025-04-21 23:34:02">2025-04-21</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2025-04-21T15:34:56.185Z" title="更新于 2025-04-21 23:34:56">2025-04-21</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/zookeeper/">zookeeper</a><i class="fas fa-angle-right post-meta-separator"></i><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/kafka/">kafka</a><i class="fas fa-angle-right post-meta-separator"></i><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/Dubbo/">Dubbo</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">字数总计:</span><span class="word-count">20.6k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>82分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="消息队列和微服务"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="微服务"><a href="#微服务" class="headerlink" title="微服务"></a>微服务</h1><h2 id="服务架构演变"><a href="#服务架构演变" class="headerlink" title="服务架构演变"></a>服务架构演变</h2><p><img src="../../../../images/SRE/day52/1.jpg" alt="1"></p>
<p><img src="../../../../images/SRE/day52/2.jpg" alt="2"></p>
<h2 id="单体架构"><a href="#单体架构" class="headerlink" title="单体架构"></a>单体架构</h2><ul>
<li>传统架构（单机系统），一个项目一个工程：比如商品、订单、支付、库存、登录、注册等等，统一部署，一个进程</li>
<li>all in one的架构方式，把所有的功能单元放在一个应用里。然后把整个应用部署到一台服务器上。如果负载能力不行，将整个应用进行水平复制，进行扩展，然后通过负载均衡实现访问。</li>
<li>Java实现：JSP、Servlet，打包成一个jar、war部署</li>
<li>易于开发和测试:也十分方便部署;当需要扩展时，只需要将war复制多份，然后放到多个服务器上，再做个负载均衡就可以了。</li>
<li>如果某个功能模块出问题，有可能全站不可访问，修改Bug后、某模块功能修改或升级后，需要停掉整个服务，重新整体重新打包、部署这个应用war包，功能模块相互之间耦合度高,相互影响,不适 合当今互联网业务功能的快速迭代。</li>
<li>特别是对于一个大型应用，我们不可能吧所有内容都放在一个应用里面，我们如何维护、如何分工合作都是问题。如果项目庞大，管理难度大</li>
<li>Web应用服务器：开源的tomcat、jetty、glassfish。商用的有weblogic、websphere、Jboss</li>
</ul>
<h2 id="微服务-1"><a href="#微服务-1" class="headerlink" title="微服务"></a>微服务</h2><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://www.martinfowler.com/microservices/</span><br></pre></td></tr></table></figure>

<p><img src="../../../../images/SRE/day52/3.jpg" alt="3"></p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">In short, the microservice architectural style is an approach to developing a </span><br><span class="line">single application as a suite of small services, each running in its own process </span><br><span class="line">and communicating with lightweight mechanisms, often an HTTP resource API. These </span><br><span class="line">services are built around business capabilities and independently deployable by </span><br><span class="line">fully automated deployment machinery. There is a bare minimum of centralized </span><br><span class="line">management of these services, which may be written in different programming </span><br><span class="line">languages and use different data storage technologies.</span><br><span class="line"></span><br><span class="line">简而言之，微服务架构风格是一种将单个应用程序开发为一套小型服务的方法，每个服务都在自己的进程中运</span><br><span class="line">行并与轻量级机制（通常是 HTTP 资源 API）进行通信。这些服务围绕业务功能构建，并可通过全自动部署</span><br><span class="line">机制独立部署。对这些服务进行最低限度的集中管理，这些服务可能用不同的编程语言编写并使用不同的数据</span><br><span class="line">存储技术。</span><br><span class="line">                                    -- James Lewis and Martin Fowler (2014)</span><br><span class="line">                                    </span><br><span class="line">亚马逊创始人 Jeff Bezos 说过一句话：“一个最好的团队用两个披萨可以喂饱”。</span><br><span class="line">一个团队控制到6-10人左右</span><br></pre></td></tr></table></figure>

<p><strong>SOA 和微服务</strong></p>
<ul>
<li><p>SOA（Service Oriented Architecture）是由多个服务组成的分布式系统</p>
<p>各个子系统之间没有采用统一的通信标准,导致系统间通信与数据交互间变得异常复杂</p>
<p>各个服务之间通过ESB(Enterprise Service Bus)进行通信,ESB是一个由大量规则和原则集成的软件架构，可以将一系列不同的应用程序集成到单个基础架构中，但ESB成本超级高，没有好用的开源，被大厂绑架，此外ESB属于重量级产品，部署规划异常笨重</p>
<p>导致ESB的单点依赖和商业ESB的费用问题反而成为了所有服务的瓶颈</p>
</li>
</ul>
<p><img src="../../../../images/SRE/day52/4.jpg" alt="4"></p>
<ul>
<li><p>微服务属于SOA的子集,SOA可以认为面向服务的1.0版本,微服务可以认为是面向服务的2.0版本</p>
</li>
<li><p>微服务化的核心就是将传统的一站式应用，根据业务拆分成一个一个的服务，彻底去掉耦合，每一个微服务提供单个业务功能，一个服务只做一件事。每个服务都围绕着具体业务进行构建，并且能够被独立地部署到生产环境、类生产环境等</p>
</li>
<li><p>从技术角度讲就是一种小而独立的处理过程，类似与进程的概念，能够自行单独启动或销毁</p>
</li>
<li><p>微服务架构（分布式系统），各个模块/服务，各自独立出来，”让专业的人干专业的事”，独立部署。分布式系统中，不同的服务可以使用各自独立的数据库。</p>
</li>
<li><p>服务之间采用轻量级的通信机制（通常是基于HTTP的RESTful API）。 </p>
</li>
<li><p>微服务设计的思想改变了原有的企业研发团队组织架构。传统的研发组织架构是水平架构，前端、后端、DBA、测试分别有自己对应的团队，属于水平团队组织架构。而微服务的设计思想对团队的划分有着一定的影响，使得团队组织架构的划分更倾向于垂直架构，比如用户业务是一个团队来负责，支付业务是一个团队来负责。但实际上在企业中并不会把团队组织架构拆分得这么绝对，垂直架构只是一种理想的架构</p>
</li>
<li><p>微服务的实现框架有多种，不同的应用架构，部署方式也有不同</p>
</li>
</ul>
<h2 id="单体架构和微服务比较"><a href="#单体架构和微服务比较" class="headerlink" title="单体架构和微服务比较"></a>单体架构和微服务比较</h2><p><img src="../../../../images/SRE/day52/5.jpg" alt="5"></p>
<p><img src="../../../../images/SRE/day52/6.jpg" alt="6"></p>
<h2 id="微服务的优缺点"><a href="#微服务的优缺点" class="headerlink" title="微服务的优缺点"></a>微服务的优缺点</h2><p><strong>微服务优点：</strong></p>
<ul>
<li>每个服务足够内聚，足够小，代码容易理解。这样能聚焦一个简单唯一的业务功能或业务需求。</li>
<li>开发简单、开发效率提高，一个服务可能就是专业的只干一件事，微服务能够被小团队单独开发，这个小团队可以是2到5人的开发人员组成</li>
<li>微服务是松耦合的，是有功能意义的服务，无论是在开发阶段或部署阶段都是独立的。</li>
<li>微服务能使用不同的语言开发</li>
<li>易于和第三方集成，微服务运行容易且灵活的方式集成自动部署，通过持续集成工具，如: Jenkins、Hudson、Bamboo</li>
<li>微服务易于被一个开发人员理解、修改和维护，这样小团队能够更关注自己的工作成果，无需通过合作才能体现价值</li>
<li>微服务允许你利用融合最新技术。微服务只是业务逻辑的代码，不会和HTML/CSS或其他界面组件混合，即前后端分离</li>
<li>每个微服务都有自己的存储能力，一般都有自己的独立的数据库，也可以有统一数据库</li>
</ul>
<p><strong>微服务缺点：</strong></p>
<ul>
<li>微服务把原有的一个项目拆分成多个独立工程，增加了开发、测试、运维、监控等的复杂度</li>
<li>微服务架构需要保证不同服务之间的数据一致性，引入了分布式事务和异步补偿机制，为设计和开发带来一定挑战</li>
<li>开发人员和运维需要处理分布式系统的复杂性，需要更强的技术能力</li>
<li>微服务适用于复杂的大系统，对于小型应用使用微服务，进行盲目的拆分只会增加其维护和开发成本</li>
</ul>
<h2 id="微服务技术栈"><a href="#微服务技术栈" class="headerlink" title="微服务技术栈"></a>微服务技术栈</h2><p><img src="../../../../images/SRE/day52/7.jpg" alt="7"></p>
<h2 id="常见的微服务框架"><a href="#常见的微服务框架" class="headerlink" title="常见的微服务框架"></a>常见的微服务框架</h2><p>Dubbo</p>
<ul>
<li>阿里开源贡献给了ASF，目前已经是Apache的顶级项目</li>
<li>一款高性能的Java RPC服务框架，微服务生态体系中的一个重要组件</li>
<li>将单体程序分解成多个功能服务模块，模块间使用Dubbo框架提供的高性能RPC通信</li>
<li>内部协调使用 Zookeeper，实现服务注册、服务发现和服务治理</li>
</ul>
<p>Spring cloud</p>
<ul>
<li>一个完整的微服务解决方案，相当于Dubbo的超集</li>
<li>微服务框架，将单体应用拆分为粒度更小的单一功能服务</li>
<li>基于HTTP协议的REST(Representational State Transfer 表述性状态转移）风格实现模块间通信</li>
</ul>
<h2 id="微服务还是单体？"><a href="#微服务还是单体？" class="headerlink" title="微服务还是单体？"></a>微服务还是单体？</h2><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">https://martinfowler.com/bliki/MonolithFirst.html</span><br><span class="line">https://www.toutiao.com/article/7173261841408360990/?log_from=c8d3dfbf573b3_1670416613668</span><br></pre></td></tr></table></figure>

<p>单体在绝大部分时候是更好的选择，即单体优先</p>
<p>在微服务大行其道的今天，其实已经有很多大师或者有务实的研发者已经意识到微服务在研发过程中，可能不是你想要的银弹，很多时候起到了反作用。</p>
<p><img src="../../../../images/SRE/day52/8.jpg" alt="8"></p>
<p>软件大师“Martin Fowler”在2015年就提出的“单体优先”（Monolith First）的思想。</p>
<p>Martin Fowler发现所有成功的微服务都遵循了通用的模式：</p>
<ul>
<li>几乎所有成功的微服务故事，都是从一个变得太大而被分解的单体开始的。 </li>
<li>几乎所有我听说过的从头开始构建为微服务系统的系统都以严重的麻烦告终。</li>
</ul>
<p>这种模式导致Martin Fowler的许多同事认为：“你不应该用微服务开始一个新的项目，即使你确信你的应用程序将足够大，值得这么做…”</p>
<p><img src="../../../../images/SRE/day52/9.jpg" alt="9"></p>
<p>单体优先：</p>
<blockquote>
<p>单体允许你探索系统的复杂性和组件的边界；</p>
<p>当复杂性增加时裂变出微服务；</p>
<p>当你边界和服务管理的业务知识增加时裂变出更多的微服务。</p>
<p>直接微服务:</p>
<p>直接使用微服务架构风险太大。</p>
</blockquote>
<p>微服务是一种有用的架构，但即使是它们的拥护者也说使用它们会产生显著的“微服务附加费”，这意味着它们只对更复杂的系统有用。</p>
<p>这种附加费，本质上是管理一套服务的成本，将拖慢团队的速度，让使用单体应用成为更简单的选择。</p>
<p>这成为了“单体优先”策略的有力论证，即使你认为它可能会在以后从微服务架构中受益，你也应该在最初使用单体来构建应用。</p>
<p>通过先建立一个单体，你可以在使用微服务设计之前弄清楚什么是正确的边界。这也给了你时间来开发更好粒度的微服务。 </p>
<p>单体优先策略一：模块化单体</p>
<p>合乎逻辑的方法是仔细设计一个单体应用，注意软件内部的模块化，包括 API 边界和数据存储方式。</p>
<p>做好这一点之后，从单体应用转向微服务是一件相对简单的事情。</p>
<p>单体优先策略二：边缘剥离</p>
<p>一种更常见的方法是从单体开始，逐渐剥离边缘的微服务。</p>
<p>这种方法可以在微服务架构的核心留下一个实质性的单体。</p>
<p>大多数新的开发都发生在微服务中，而单体是相对静止的。</p>
<p>单体优先策略三：整体替换</p>
<p>很少有人把这种做法看成是一种值得骄傲的做法，然而把单体作为一种牺牲性的架构来建造是有好处的。</p>
<p>不要害怕建造一个你会丢弃的单体应用，特别是如果一个单体应用能让你快速进入市场。</p>
<p>单体优先策略四：粗粒度服务</p>
<p>从几个粗粒度的服务开始，这些服务比你最终得到的微服务要大。</p>
<p>使用这些粗粒度的服务来习惯与多个服务一起工作。</p>
<p>同时享受这样一个事实，即这种粗粒度减少了你必须做的服务间重构的数量。</p>
<p>然后，随着边界的稳定，分解为更细粒度的服务。</p>
<p>“单体优先”的思想，目前已逐渐开始成为是业界普遍共识。现在已经属于后微服务时代!</p>
<p>在一个人数不多、资金不是无限充裕，需要快速将产品推向市场的团队，建议使用“单体优先”的实现方式。</p>
<p>在很多团队中，使用微服务其实是一种Hype Driven Development（炒作/简历驱动开发），不是为了真正为了解决业务问题。</p>
<p>使用“单体优先”，是一个务实的选择！试想如果是你自己创业，你会是选择“单体”还是“微服务”，那么请为你的企业进行务实的选择。</p>
<h1 id="ZooKeeper"><a href="#ZooKeeper" class="headerlink" title="ZooKeeper"></a>ZooKeeper</h1><h2 id="ZooKeeper-介绍"><a href="#ZooKeeper-介绍" class="headerlink" title="ZooKeeper 介绍"></a>ZooKeeper 介绍</h2><p><img src="../../../../images/SRE/day52/10.jpg" alt="10"></p>
<p>ZooKeeper 的由来</p>
<p>下面这段内容摘自《从Paxos到Zookeeper 》第四章第一节的某段内容：</p>
<blockquote>
<p>Zookeeper最早起源于雅虎研究院的一个研究小组。在当时，研究人员发现，在雅虎内部很多大型系统基本都需要依赖一个类似的系统来进行分布式协调，但是这些系统往往都存在分布式单点问题。所以，雅虎的开发人员就试图开发一个通用的无单点问题的分布式协调框架，以便让开发人员 将精力集中在处理业务逻辑上。</p>
<p>关于“ZooKeeper”这个项目的名字，其实也有一段趣闻。在立项初期，考虑到之前内部很多项目都是使用动物的名字来命名的（例如著名的Pig项目),雅虎的工程师希望给这个项目也取一个动物的名字。时任研究院的首席科学家RaghuRamakrishnan开玩笑地说：“在这样下去，我们这儿就变成动物园了！”此话一出，大家纷纷表示就叫动物园管理员吧——因为各个以动物命名的分布式组件放在一起，雅虎的整个分布式系统看上去就像一个大型的动物园了，而Zookeeper正好要用来进行分布式环境的协调——于是，Zookeeper的名字也就由此诞生了。</p>
</blockquote>
<p>ZooKeeper 是一个开源的分布式协调服务，ZooKeeper框架最初是在“Yahoo!”上构建的，用于以简单而稳健的方式访问他们的应用程序。 后来，Apache ZooKeeper成为Hadoop，HBase和其他分布式框架使用的有组织服务的标准。 例如，Apache HBase使用ZooKeeper跟踪分布式数据的状态。ZooKeeper 的设计目标是将那些复杂且容易出错的分布式一致性服务封装起来，构成一个高效可靠的原语集，并以一系列简单易用的接口提供给用户使用。</p>
<p>ZooKeeper 是一个典型的分布式数据一致性解决方案，分布式应用程序可以基于 ZooKeeper 实现诸如数据发布/订阅、负载均衡、命名服务、分布式协调/通知、集群管理、Master 选举、分布式锁和分布式队列等功能。</p>
<p>Zookeeper 一个最常用的使用场景就是用于担任服务生产者和服务消费者的注册中心(提供发布订阅服务)。 服务生产者将自己提供的服务注册到Zookeeper中心，服务的消费者在进行服务调用的时候先到Zookeeper中查找服务，获取到服务生产者的详细信息之后，再去调用服务生产者的内容与数据。在Dubbo架构中 Zookeeper 就担任了注册中心这一角色。</p>
<p>官网: </p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://zookeeper.apache.org/</span><br></pre></td></tr></table></figure>

<p>官方文档: </p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://zookeeper.apache.org/doc/</span><br></pre></td></tr></table></figure>

<h2 id="ZooKeeper-工作原理"><a href="#ZooKeeper-工作原理" class="headerlink" title="ZooKeeper 工作原理"></a>ZooKeeper 工作原理</h2><p>ZooKeeper 是一个分布式服务框架，它主要是用来解决分布式应用中经常遇到的一些数据管理问题，如：命名服务、状态同步、配置中心、集群管理等。</p>
<h3 id="ZooKeeper-功能"><a href="#ZooKeeper-功能" class="headerlink" title="ZooKeeper 功能"></a>ZooKeeper 功能</h3><h4 id="命名服务"><a href="#命名服务" class="headerlink" title="命名服务"></a>命名服务</h4><p>命名服务是分布式系统中比较常见的一类场景。命名服务是分布式系统最基本的公共服务之一。在分布式系统中，被命名的实体通常可以是集群中的机器、提供的服务地址或远程对象等——这些我们都可以统称它们为名字（Name），其中较为常见的就是一些分布式服务框架（如RPC、RMI）中的服务地址列表，通过使用命名服务，客户端应用能够根据指定名字来获取资源的实体、服务地址和提供者的信息等。</p>
<p><strong>Zookeeper 数据模型</strong></p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">在 Zookeeper 中，节点分为两类</span><br><span class="line">第一类是指构成Zookeeper集群的主机，称之为主机节点</span><br><span class="line">第二类则是指内存中zookeeper数据模型中的数据单元，用来存储各种数据内容，称之为数据节点 ZNode。</span><br><span class="line">Zookeeper内部维护了一个层次关系(树状结构)的数据模型，它的表现形式类似于Linux的文件系统，甚至操</span><br><span class="line">作的种类都一致。</span><br><span class="line">Zookeeper数据模型中有自己的根目录(/)，根目录下有多个子目录，每个子目录后面有若干个文件,由斜杠</span><br><span class="line">(/)进行分割的路径，就是一个ZNode,每个 ZNode上都会保存自己的数据内容和一系列属性信息.</span><br></pre></td></tr></table></figure>

<p><img src="../../../../images/SRE/day52/11.jpg" alt="11"></p>
<h4 id="状态同步"><a href="#状态同步" class="headerlink" title="状态同步"></a>状态同步</h4><p>每个节点除了存储数据内容和 node 节点状态信息之外，还存储了已经注册的APP 的状态信息，当有些节点或APP不可用，就将当前状态同步给其他服务。</p>
<h4 id="配置中心"><a href="#配置中心" class="headerlink" title="配置中心"></a>配置中心</h4><p>现在我们大多数应用都是采用的是分布式开发的应用，搭建到不同的服务器上，我们的配置文件，同一个应用程序的配置文件一样，还有就是多个程序存在相同的配置，当我们配置文件中有个配置属性需要改变，需要改变每个程序的配置属性，这样会很麻烦的去修改配置，那么可用使用ZooKeeper 来实现配置中心</p>
<p>ZooKeeper 采用的是推拉相结合的方式：客户端向服务端注册自己需要关注的节点，一旦该节点的数据发生变更，那么服务端就会向相应的客户端发送Watcher事件通知，客户端接收到这个消息通知后，需要主动到服务端获取最新的数据。 </p>
<p>Apollo（阿波罗）是携程框架部门研发的开源配置管理中心,此应用比较流行</p>
<h4 id="集群管理"><a href="#集群管理" class="headerlink" title="集群管理"></a>集群管理</h4><p>所谓集群管理，包括集群监控与集群控制两大块，前者侧重对集群运行时状态的收集，后者则是对集群进行操作与控制，在日常开发和运维过程中，我们经常会有类似于如下的需求：</p>
<ul>
<li>希望知道当前集群中究竟有多少机器在工作。</li>
<li>对集群中每台机器的运行时状态进行数据收集。对集群中机器进行上下线操作。</li>
</ul>
<p>ZooKeeper 具有以下两大特性:</p>
<ul>
<li>客户端如果对ZooKeeper 的一个数据节点注册 Watcher监听，那么当该数据节点的内容或是其子节点列表发生变更时，ZooKeeper 服务器就会向已注册订阅的客户端发送变更通知。</li>
<li>对在ZooKeeper上创建的临时节点，一旦客户端与服务器之间的会话失效，那么该临时节点也就被自动清除。</li>
</ul>
<p>Watcher（事件监听器）是 Zookeeper 中的一个很重要的特性。Zookeeper 允许用户在指定节点上注册一些Watcher，并且在一些特定事件触发的时候， ZooKeeper 服务端会将事件通知到感兴趣的客户端上去，该机制是 Zookeeper 实现分布式协调服务的重要特性。</p>
<h3 id="ZooKeeper-服务流程"><a href="#ZooKeeper-服务流程" class="headerlink" title="ZooKeeper 服务流程"></a>ZooKeeper 服务流程</h3><p><img src="../../../../images/SRE/day52/12.jpg" alt="12"></p>
<p><img src="../../../../images/SRE/day52/13.jpg" alt="13"></p>
<ol>
<li>生产者启动</li>
<li>生产者注册至zookeeper</li>
<li>消费者启动并订阅频道</li>
<li>zookeeper 通知消费者事件</li>
<li>消费者调用生产者</li>
<li>监控中心负责统计和监控服务状态</li>
</ol>
<h2 id="ZooKeeper-单机部署"><a href="#ZooKeeper-单机部署" class="headerlink" title="ZooKeeper 单机部署"></a>ZooKeeper 单机部署</h2><p>单机版的 ZooKeeper 安装</p>
<p>官方文档:</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://zookeeper.apache.org/doc/r3.6.2/zookeeperStarted.html#sc_InstallingSingleMode</span><br></pre></td></tr></table></figure>

<h3 id="配置-Java-环境"><a href="#配置-Java-环境" class="headerlink" title="配置 Java 环境"></a>配置 Java 环境</h3><p>官方依赖介绍</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">https://zookeeper.apache.org/doc/r3.8.0/zookeeperAdmin.html#sc_systemReq</span><br><span class="line">https://zookeeper.apache.org/doc/r3.6.2/zookeeperAdmin.html#sc_requiredSoftware</span><br></pre></td></tr></table></figure>

<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@ubuntu1804 ~]<span class="comment"># apt -y install openjdk-8-jdk </span></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment"># Java -version</span></span><br><span class="line">openjdk version <span class="string">&quot;1.8.0_282&quot;</span></span><br><span class="line">OpenJDK Runtime Environment (build 1.8.0_282-8u282-b08-0ubuntu1~18.04-b08)</span><br><span class="line">OpenJDK 64-Bit Server VM (build 25.282-b08, mixed mode)</span><br></pre></td></tr></table></figure>

<h3 id="部署-ZooKeeper"><a href="#部署-ZooKeeper" class="headerlink" title="部署 ZooKeeper"></a>部署 ZooKeeper</h3><h4 id="包安装"><a href="#包安装" class="headerlink" title="包安装"></a>包安装</h4><p>范例：包安装</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">[root@ubuntu2204 ~]<span class="comment"># apt list zookeeper</span></span><br><span class="line">正在列表... 完成</span><br><span class="line">zookeeper/jammy 3.4.13-6ubuntu4 all</span><br><span class="line"></span><br><span class="line">[root@ubuntu2204 ~]<span class="comment"># apt -y install zookeeper</span></span><br><span class="line">[root@ubuntu2204 ~]<span class="comment"># grep -Ev &quot;#|^$&quot; /etc/zookeeper/conf/zoo.cfg</span></span><br><span class="line">tickTime=2000</span><br><span class="line">initLimit=10</span><br><span class="line">syncLimit=5</span><br><span class="line">dataDir=/var/lib/zookeeper</span><br><span class="line">clientPort=2181</span><br><span class="line"></span><br><span class="line">[root@ubuntu2204 ~]<span class="comment"># ls /usr/share/zookeeper/bin/</span></span><br><span class="line">zkCleanup.sh zkCli.sh zkEnv.sh zkServer.sh</span><br><span class="line"></span><br><span class="line">[root@ubuntu2204 ~]<span class="comment"># /usr/share/zookeeper/bin/zkServer.sh start</span></span><br><span class="line">ZooKeeper JMX enabled by default</span><br><span class="line">Using config: /etc/zookeeper/conf/zoo.cfg</span><br><span class="line">Starting zookeeper ... STARTED</span><br><span class="line"></span><br><span class="line">[root@ubuntu2204 ~]<span class="comment"># /usr/share/zookeeper/bin/zkServer.sh status</span></span><br><span class="line">ZooKeeper JMX enabled by default</span><br><span class="line">Using config: /etc/zookeeper/conf/zoo.cfg</span><br><span class="line">Mode: standalone</span><br></pre></td></tr></table></figure>

<h4 id="二进制安装"><a href="#二进制安装" class="headerlink" title="二进制安装"></a>二进制安装</h4><p>历史版本下载</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://archive.apache.org/dist/zookeeper/</span><br></pre></td></tr></table></figure>

<p>范例: 安装单机 zookeeper</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#官方下载</span></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment"># wget -P /usr/local/src https://downloads.apache.org/zookeeper/stable/apache-zookeeper-3.6.3-bin.tar.gz</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#国内镜像下载</span></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment"># wget -P /usr/local/src https://mirrors.tuna.tsinghua.edu.cn/apache/zookeeper/stable/apache-zookeeper-3.6.3-bin.tar.gz</span></span><br><span class="line"></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment"># tar xf /usr/local/src/apache-zookeeper-3.6.3-bin.tar.gz -C /usr/local/</span></span><br><span class="line"></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment"># ln -s /usr/local/apache-zookeeper-3.6.3-bin /usr/local/zookeeper</span></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment"># echo &#x27;PATH=/usr/local/zookeeper/bin:$PATH&#x27; &gt; /etc/profile.d/zookeeper.sh</span></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment"># . /etc/profile.d/zookeeper.sh</span></span><br><span class="line"></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment">#cp /usr/local/zookeeper/conf/zoo_sample.cfg /usr/local/zookeeper/conf/zoo.cfg</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#默认配置可不做修改</span></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment"># grep -v &quot;#&quot; /usr/local/zookeeper/conf/zoo.cfg</span></span><br><span class="line">tickTime=2000  <span class="comment">#&quot;滴答时间&quot;，用于配置Zookeeper中最小的时间单元长度，单位毫秒，是其它时间配置的基础</span></span><br><span class="line">initLimit=10   <span class="comment">#初始化时间，包含启动和数据同步，其值是tickTime的倍数</span></span><br><span class="line">syncLimit=5    <span class="comment">#正常工作，心跳监测的时间间隔，其值是tickTime的倍数</span></span><br><span class="line">dataDir=/tmp/zookeeper <span class="comment">#配置Zookeeper服务存储数据的目录,基于安全,可以修改为dataDir=/usr/local/zookeeper/data </span></span><br><span class="line"><span class="comment">#dataLogdir=/usr/local/zookeeper/logs #可以指定日志路径</span></span><br><span class="line">clientPort=2181 <span class="comment">#配置当前Zookeeper服务对外暴露的端口，用户客户端和服务端建立连接会话</span></span><br><span class="line">autopurge.snapRetainCount=3 <span class="comment">#3.4.0中的新增功能：启用后，ZooKeeper 自动清除功能,会将只保留此最新3个快照和相应的事务日志,并分别保留在dataDir 和dataLogDir中，删除其余部分，默认值为3,最小值为3</span></span><br><span class="line">autopurge.purgeInterval=24  <span class="comment">#3.4.0及之后版本，ZK提供了自动清理日志和快照文件的功能，这个参数指定了清理频率，单位是小时，需要配置一个1或更大的整数，默认是 0，表示不开启自动清理功能</span></span><br></pre></td></tr></table></figure>

<h3 id="启动-ZooKeeper"><a href="#启动-ZooKeeper" class="headerlink" title="启动 ZooKeeper"></a>启动 ZooKeeper</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#查看选项</span></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment"># zkServer.sh --help</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#前台启动观察启动过程</span></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment"># zkServer.sh start-foreground</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#后台启动</span></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment"># zkServer.sh start</span></span><br><span class="line">/usr/bin/java</span><br><span class="line">ZooKeeper JMX enabled by default</span><br><span class="line">Using config: /usr/local/zookeeper/bin/../conf/zoo.cfg</span><br><span class="line">Starting zookeeper ... STARTED</span><br><span class="line"><span class="comment">#注意:如果配置service,zkServer.sh和systemctl不要混用,否则无法启动</span></span><br></pre></td></tr></table></figure>

<h3 id="验证-ZooKeeper"><a href="#验证-ZooKeeper" class="headerlink" title="验证 ZooKeeper"></a>验证 ZooKeeper</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">[root@ubuntu1804 ~]<span class="comment"># zkServer.sh status</span></span><br><span class="line">/usr/bin/java</span><br><span class="line">ZooKeeper JMX enabled by default</span><br><span class="line">Using config: /usr/local/zookeeper/bin/../conf/zoo.cfg</span><br><span class="line">Client port found: 2181. Client address: localhost. Client SSL: <span class="literal">false</span>.</span><br><span class="line">Mode: standalone</span><br><span class="line"></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment"># ss -ntpl|grep 2181</span></span><br><span class="line">LISTEN   0    50       *:2181       *:*     <span class="built_in">users</span>:((&quot;java&quot;,pid=<span class="number">1041</span>,fd=<span class="number">70</span>))</span><br><span class="line"></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment"># pstree -p 1041</span></span><br><span class="line">java(1041)─┬─&#123;java&#125;(1044)</span><br><span class="line">           ├─&#123;java&#125;(1045)</span><br><span class="line">           ├─&#123;java&#125;(1046)</span><br><span class="line">           ├─&#123;java&#125;(1047)</span><br><span class="line">           ├─&#123;java&#125;(1048)</span><br><span class="line">           ├─&#123;java&#125;(1049)</span><br><span class="line">           ├─&#123;java&#125;(1050)</span><br><span class="line">           ├─&#123;java&#125;(1051)</span><br><span class="line">           ├─&#123;java&#125;(1052)</span><br><span class="line">           ├─&#123;java&#125;(1053)</span><br><span class="line">           ├─&#123;java&#125;(1054)</span><br><span class="line">           ├─&#123;java&#125;(1055)</span><br></pre></td></tr></table></figure>

<h3 id="一键安装-ZooKeeper-脚本"><a href="#一键安装-ZooKeeper-脚本" class="headerlink" title="一键安装 ZooKeeper 脚本"></a>一键安装 ZooKeeper 脚本</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line">ZK_VERSION=3.8.1</span><br><span class="line"><span class="comment">#ZK_VERSION=3.8.0</span></span><br><span class="line"><span class="comment">#ZK_VERSION=3.6.3</span></span><br><span class="line"><span class="comment">#ZK_VERSION=3.7.1</span></span><br><span class="line">ZK_URL=https://archive.apache.org/dist/zookeeper/zookeeper-<span class="variable">$&#123;ZK_VERSION&#125;</span>/apache-zookeeper-<span class="variable">$&#123;ZK_VERSION&#125;</span>-bin.tar.gz</span><br><span class="line"><span class="comment">#ZK_URL=https://mirrors.tuna.tsinghua.edu.cn/apache/zookeeper/zookeeper-$&#123;ZK_VERSION&#125;/apache-zookeeper-$&#123;ZK_VERSION&#125;-bin.tar.gz</span></span><br><span class="line"><span class="comment">#ZK_URL=&quot;https://mirrors.tuna.tsinghua.edu.cn/apache/zookeeper/stable/apache-zookeeper-$&#123;ZK_VERSION&#125;-bin.tar.gz&quot;</span></span><br><span class="line"><span class="comment">#ZK_URL=&quot;https://downloads.apache.org/zookeeper/stable/apache-zookeeper-$&#123;ZK_VERSION&#125;-bin.tar.gz&quot;</span></span><br><span class="line"></span><br><span class="line">INSTALL_DIR=/usr/local/zookeeper</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">HOST=`hostname -I|awk <span class="string">&#x27;&#123;print $1&#125;&#x27;</span>`</span><br><span class="line"></span><br><span class="line">.  /etc/os-release</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">color</span></span> () &#123;</span><br><span class="line">    RES_COL=60</span><br><span class="line">    MOVE_TO_COL=<span class="string">&quot;echo -en \\033[<span class="variable">$&#123;RES_COL&#125;</span>G&quot;</span></span><br><span class="line">    SETCOLOR_SUCCESS=<span class="string">&quot;echo -en \\033[1;32m&quot;</span></span><br><span class="line">    SETCOLOR_FAILURE=<span class="string">&quot;echo -en \\033[1;31m&quot;</span></span><br><span class="line">    SETCOLOR_WARNING=<span class="string">&quot;echo -en \\033[1;33m&quot;</span></span><br><span class="line">    SETCOLOR_NORMAL=<span class="string">&quot;echo -en \E[0m&quot;</span></span><br><span class="line">    <span class="built_in">echo</span> -n <span class="string">&quot;<span class="variable">$1</span>&quot;</span> &amp;&amp; <span class="variable">$MOVE_TO_COL</span></span><br><span class="line">    <span class="built_in">echo</span> -n <span class="string">&quot;[&quot;</span></span><br><span class="line">    <span class="keyword">if</span> [ <span class="variable">$2</span> = <span class="string">&quot;success&quot;</span> -o <span class="variable">$2</span> = <span class="string">&quot;0&quot;</span> ] ;<span class="keyword">then</span></span><br><span class="line">        <span class="variable">$&#123;SETCOLOR_SUCCESS&#125;</span></span><br><span class="line">        <span class="built_in">echo</span> -n $<span class="string">&quot;  OK  &quot;</span>    </span><br><span class="line">    <span class="keyword">elif</span> [ <span class="variable">$2</span> = <span class="string">&quot;failure&quot;</span> -o <span class="variable">$2</span> = <span class="string">&quot;1&quot;</span>  ] ;<span class="keyword">then</span> </span><br><span class="line">        <span class="variable">$&#123;SETCOLOR_FAILURE&#125;</span></span><br><span class="line">        <span class="built_in">echo</span> -n $<span class="string">&quot;FAILED&quot;</span></span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="variable">$&#123;SETCOLOR_WARNING&#125;</span></span><br><span class="line">        <span class="built_in">echo</span> -n $<span class="string">&quot;WARNING&quot;</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line">    <span class="variable">$&#123;SETCOLOR_NORMAL&#125;</span></span><br><span class="line">    <span class="built_in">echo</span> -n <span class="string">&quot;]&quot;</span></span><br><span class="line">    <span class="built_in">echo</span> </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">install_jdk</span></span>() &#123;</span><br><span class="line">    <span class="keyword">if</span> [ <span class="variable">$ID</span> = <span class="string">&#x27;centos&#x27;</span> -o  <span class="variable">$ID</span> = <span class="string">&#x27;rocky&#x27;</span> ];<span class="keyword">then</span></span><br><span class="line">        yum -y install java-1.8.0-openjdk-devel || &#123; color <span class="string">&quot;安装JDK失败!&quot;</span> 1; <span class="built_in">exit</span> 1; &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        apt update</span><br><span class="line">        apt install openjdk-11-jdk -y || &#123; color <span class="string">&quot;安装JDK失败!&quot;</span> 1; <span class="built_in">exit</span> 1; &#125; </span><br><span class="line">        <span class="comment">#apt install openjdk-8-jdk -y || &#123; color &quot;安装JDK失败!&quot; 1; exit 1; &#125; </span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line">    java -version</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">install_zookeeper</span></span>() &#123;</span><br><span class="line">    <span class="keyword">if</span> [ -f apache-zookeeper-<span class="variable">$&#123;ZK_VERSION&#125;</span>-bin.tar.gz ] ;<span class="keyword">then</span></span><br><span class="line">        <span class="built_in">cp</span> apache-zookeeper-<span class="variable">$&#123;ZK_VERSION&#125;</span>-bin.tar.gz /usr/local/src/</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        wget -P /usr/local/src/ --no-check-certificate <span class="variable">$ZK_URL</span> || &#123; color  <span class="string">&quot;下载失败!&quot;</span> 1 ;<span class="built_in">exit</span> ; &#125;</span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line">    tar xf /usr/local/src/<span class="variable">$&#123;ZK_URL##*/&#125;</span> -C /usr/local</span><br><span class="line">    <span class="built_in">ln</span> -s /usr/local/apache-zookeeper-*-bin/ <span class="variable">$&#123;INSTALL_DIR&#125;</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;PATH=<span class="variable">$&#123;INSTALL_DIR&#125;</span>/bin:<span class="variable">$PATH</span>&quot;</span> &gt;  /etc/profile.d/zookeeper.sh</span><br><span class="line">    .  /etc/profile.d/zookeeper.sh</span><br><span class="line">    <span class="built_in">mkdir</span> -p <span class="variable">$&#123;INSTALL_DIR&#125;</span>/data </span><br><span class="line">    <span class="built_in">cat</span> &gt; <span class="variable">$&#123;INSTALL_DIR&#125;</span>/conf/zoo.cfg &lt;&lt;<span class="string">EOF</span></span><br><span class="line"><span class="string">tickTime=2000</span></span><br><span class="line"><span class="string">initLimit=10</span></span><br><span class="line"><span class="string">syncLimit=5</span></span><br><span class="line"><span class="string">dataDir=$&#123;INSTALL_DIR&#125;/data</span></span><br><span class="line"><span class="string">clientPort=2181</span></span><br><span class="line"><span class="string">maxClientCnxns=128</span></span><br><span class="line"><span class="string">autopurge.snapRetainCount=3</span></span><br><span class="line"><span class="string">autopurge.purgeInterval=24</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line">	<span class="built_in">cat</span> &gt; /lib/systemd/system/zookeeper.service &lt;&lt;<span class="string">EOF</span></span><br><span class="line"><span class="string">[Unit]</span></span><br><span class="line"><span class="string">Description=zookeeper.service</span></span><br><span class="line"><span class="string">After=network.target</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">[Service]</span></span><br><span class="line"><span class="string">Type=forking</span></span><br><span class="line"><span class="string">#Environment=$&#123;INSTALL_DIR&#125;</span></span><br><span class="line"><span class="string">ExecStart=$&#123;INSTALL_DIR&#125;/bin/zkServer.sh start</span></span><br><span class="line"><span class="string">ExecStop=$&#123;INSTALL_DIR&#125;/bin/zkServer.sh stop</span></span><br><span class="line"><span class="string">ExecReload=$&#123;INSTALL_DIR&#125;/bin/zkServer.sh restart</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">[Install]</span></span><br><span class="line"><span class="string">WantedBy=multi-user.target</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line">    systemctl daemon-reload</span><br><span class="line">    systemctl <span class="built_in">enable</span> --now  zookeeper.service</span><br><span class="line">    systemctl is-active zookeeper.service</span><br><span class="line">	<span class="keyword">if</span> [ $? -eq 0 ] ;<span class="keyword">then</span> </span><br><span class="line">        color <span class="string">&quot;zookeeper 安装成功!&quot;</span> 0  </span><br><span class="line">    <span class="keyword">else</span> </span><br><span class="line">        color <span class="string">&quot;zookeeper 安装失败!&quot;</span> 1</span><br><span class="line">        <span class="built_in">exit</span> 1</span><br><span class="line">    <span class="keyword">fi</span>   </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">install_jdk</span><br><span class="line"></span><br><span class="line">install_zookeeper</span><br></pre></td></tr></table></figure>

<h2 id="ZooKeeper-集群部署"><a href="#ZooKeeper-集群部署" class="headerlink" title="ZooKeeper 集群部署"></a>ZooKeeper 集群部署</h2><h3 id="ZooKeeper-集群介绍"><a href="#ZooKeeper-集群介绍" class="headerlink" title="ZooKeeper 集群介绍"></a>ZooKeeper 集群介绍</h3><p>ZooKeeper集群用于解决单点和单机性能及数据高可用等问题。</p>
<h4 id="集群结构"><a href="#集群结构" class="headerlink" title="集群结构"></a>集群结构</h4><p><img src="../../../../images/SRE/day52/14.jpg" alt="14"><br><img src="../../../../images/SRE/day52/15.jpg" alt="15"></p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">zookeeper集群基于Master/Slave的模型，处于主要地位(处理写操作)的主机称为Master(Leader)节</span><br><span class="line">点，处于次要地位(处理读操作)的主机称为 slave节点，生产中读取的方式一般是以异步复制方式来实现的。</span><br><span class="line">对于n台server,每个server都知道彼此的存在。只要有&gt;n/2台server节点可用，整个zookeeper系统保持可用。</span><br><span class="line">因此zookeeper集群通常由奇数台Server节点组成</span><br><span class="line">当进行写操作时,由Master(leader)完成,并且同步到其它Slave(follower)节点,当在保证写操作在所有</span><br><span class="line">节点的总数过半后,才会认为写操作成功</span><br></pre></td></tr></table></figure>

<p>官方链接: 下图表示读的比例越高,性能越好</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://zookeeper.apache.org/doc/r3.7.0/zookeeperOver.html</span><br></pre></td></tr></table></figure>

<p><img src="../../../../images/SRE/day52/16.jpg" alt="16"></p>
<h4 id="集群角色"><a href="#集群角色" class="headerlink" title="集群角色"></a>集群角色</h4><p><img src="../../../../images/SRE/day52/17.jpg" alt="17"></p>
<table>
<thead>
<tr>
<th>序号</th>
<th>角色</th>
<th>职责描述</th>
</tr>
</thead>
<tbody><tr>
<td>1</td>
<td>领导者 (Leader)</td>
<td>负责处理写入请求的，事务请求的唯一调度和处理者,负责进行投票发起和决议，更新系统状态</td>
</tr>
<tr>
<td>2</td>
<td>跟随者 (Follower)</td>
<td>接收客户请求并向客户端返回结果，在选Leader过程中参与投票</td>
</tr>
<tr>
<td>3</td>
<td>观察者 (Observer)</td>
<td>转交客户端写请求给leader节点，和同步leader状态和Follower唯一区别就是不参与Leader投票,也不参与写操作的”过半写成功”策略</td>
</tr>
<tr>
<td>4</td>
<td>学习者 (Learner)</td>
<td>和leader进行状态同步的节点统称Learner，包括:Follower和Observer</td>
</tr>
<tr>
<td>5</td>
<td>客户端 (client)</td>
<td>请求发起方</td>
</tr>
</tbody></table>
<h4 id="选举过程"><a href="#选举过程" class="headerlink" title="选举过程"></a>选举过程</h4><p><strong>节点角色状态：</strong> </p>
<ul>
<li>LOOKING：寻找 Leader 状态，处于该状态需要进入选举流程 </li>
<li>LEADING：领导者状态，处于该状态的节点说明是角色已经是Leader </li>
<li>FOLLOWING：跟随者状态，表示 Leader已经选举出来，当前节点角色是follower  </li>
<li>OBSERVER：观察者状态，表明当前节点角色是 observer </li>
</ul>
<p><strong>选举 ID：</strong> </p>
<ul>
<li>ZXID（zookeeper transaction id）：每个改变 Zookeeper状态的操作都会形成一个对应的zxid。ZXID最大的节点优先选为Leader</li>
<li>myid：服务器的唯一标识(SID)，通过配置 myid 文件指定，集群中唯一,当ZXID一样时,myid大的节 点优先选为Leader </li>
</ul>
<p><strong>ZooKeeper 集群选举过程：</strong></p>
<p>当集群中的 zookeeper 节点启动以后，会根据配置文件中指定的 zookeeper节点地址进行leader 选择操作，过程如下：</p>
<ul>
<li><p>每个zookeeper 都会发出投票，由于是第一次选举leader，因此每个节点都会把自己当做leader角色进行选举，每个zookeeper 的投票中都会包含自己的myid和zxid，此时zookeeper 1 的投票为myid为 1，初始zxid有一个初始值0x0，后期会随着数据更新而自动变化，zookeeper2 的投票为myid为2，初始zxid 为初始生成的值。</p>
</li>
<li><p>每个节点接受并检查对方的投票信息，比如投票时间、是否状态为LOOKING状态的投票。</p>
</li>
<li><p>对比投票，优先检查zxid，如果zxid 不一样则 zxid 大的为leader，如果zxid相同则继续对比myid，myid 大的一方为 leader</p>
<p>成为 Leader 的必要条件： Leader 要具有最高的zxid；当集群的规模是 n 时，集群中大多数的机器（至少n/2+1）得到响应并follower 选出的 Leader。</p>
</li>
</ul>
<p>心跳机制：Leader 与 Follower 利用 PING 来感知对方的是否存活，当 Leader无法响应PING 时，将重新发起 Leader 选举。</p>
<p>当 Leader 服务器出现网络中断、崩溃退出与重启等异常情况时，ZAB(Zookeeper Atomic Broadcast)协议就会进入恢复模式并选举产生新的Leader服务器。这个过程大致如下：</p>
<ul>
<li>Leader Election（选举阶段）：节点在一开始都处于选举阶段，只要有一个节点得到超半数节点的票数，它就可以当选准 leader。</li>
<li>Discovery（发现阶段）：在这个阶段，followers 跟准 leader 进行通信，同步 followers 最近接收的事务提议。</li>
<li>Synchronization（同步阶段）:同步阶段主要是利用 leader 前一阶段获得的最新提议历史，同步集群中所有的副本。同步完成之后 准 leader 才会成为真正的 leader。</li>
<li>Broadcast（广播阶段） ：到了这个阶段，Zookeeper 集群才能正式对外提供事务服务，并且leader 可以进行消息广播。同时如果有新的节点加入，还需要对新节点进行同步 </li>
</ul>
<p><strong>ZAB 协议介绍</strong></p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ZAB（ZooKeeper Atomic Broadcast 原子广播） 协议是为分布式协调服务 ZooKeeper 专门设计的一</span><br><span class="line">种支持崩溃恢复的原子广播协议。 在 ZooKeeper 中，主要依赖 ZAB 协议来实现分布式数据一致性，基于</span><br><span class="line">该协议，ZooKeeper 实现了一种主备模式的系统架构来保持集群中各个副本之间的数据一致性。</span><br></pre></td></tr></table></figure>

<h4 id="ZooKeeper-集群特性"><a href="#ZooKeeper-集群特性" class="headerlink" title="ZooKeeper 集群特性"></a>ZooKeeper 集群特性</h4><p>整个集群中只要有超过集群数量一半的 zookeeper工作是正常的，那么整个集群对外就是可用的</p>
<p>假如有 2 台服务器做了一个 Zookeeper 集群，只要有任何一台故障或宕机，那么这个 ZooKeeper集群就不可用了，因为剩下的一台没有超过集群一半的数量，但是假如有三台zookeeper 组成一个集群， 那么损坏一台就还剩两台，大于 3台的一半，所以损坏一台还是可以正常运行的，但是再损坏一台就只剩一台集群就不可用了。那么要是 4 台组成一个zookeeper集群，损坏一台集群肯定是正常的，那么损坏两台就还剩两台，那么2台不大于集群数量的一半，所以 3 台的 zookeeper 集群和 4 台的 zookeeper集群损坏两台的结果都是集群不可用，以此类推 5 台和 6 台以及 7 台和 8台都是同理</p>
<p>另外偶数节点可以会造成”脑裂”现象,所以这也就是为什么集群一般都是奇数的原因。</p>
<h3 id="ZooKeeper-集群部署-1"><a href="#ZooKeeper-集群部署-1" class="headerlink" title="ZooKeeper 集群部署"></a>ZooKeeper 集群部署</h3><p>官方文档:</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://zookeeper.apache.org/doc/r3.6.2/zookeeperAdmin.html#sc_zkMulitServerSetup</span><br></pre></td></tr></table></figure>

<h4 id="环境准备"><a href="#环境准备" class="headerlink" title="环境准备"></a>环境准备</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#三台ubuntu18.04</span></span><br><span class="line">zookeeper-node1.wang.org 10.0.0.101</span><br><span class="line">zookeeper-node2.wang.org 10.0.0.102</span><br><span class="line">zookeeper-node3.wang.org 10.0.0.103</span><br><span class="line"></span><br><span class="line"><span class="comment">#在三个节点都安装JDK</span></span><br><span class="line">[root@zookeeper-node1 ~]<span class="comment"># apt -y install openjdk-8-jdk</span></span><br><span class="line">[root@zookeeper-node2 ~]<span class="comment"># apt -y install openjdk-8-jdk</span></span><br><span class="line">[root@zookeeper-node3 ~]<span class="comment"># apt -y install openjdk-8-jdk</span></span><br></pre></td></tr></table></figure>

<h4 id="在所有节点下载并解压缩-ZooKeeper-包文件"><a href="#在所有节点下载并解压缩-ZooKeeper-包文件" class="headerlink" title="在所有节点下载并解压缩 ZooKeeper 包文件"></a>在所有节点下载并解压缩 ZooKeeper 包文件</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@zookeeper-node1 ~]<span class="comment"># wget -P /usr/local/src https://downloads.apache.org/zookeeper/stable/apache-zookeeper-3.6.3-bin.tar.gz</span></span><br><span class="line"></span><br><span class="line">[root@zookeeper-node1 ~]<span class="comment"># tar xf /usr/local/src/apache-zookeeper-3.6.3-bin.tar.gz -C /usr/local/</span></span><br><span class="line"></span><br><span class="line">[root@zookeeper-node1 ~]<span class="comment"># ln -s /usr/local/apache-zookeeper-3.6.3-bin /usr/local/zookeeper</span></span><br><span class="line"></span><br><span class="line">[root@zookeeper-node1 ~]<span class="comment"># echo &#x27;PATH=/usr/local/zookeeper/bin:$PATH&#x27; &gt; /etc/profile.d/zookeeper.sh</span></span><br><span class="line"></span><br><span class="line">[root@zookeeper-node1 ~]<span class="comment"># . /etc/profile.d/zookeeper.sh</span></span><br></pre></td></tr></table></figure>

<h4 id="准备配置文件"><a href="#准备配置文件" class="headerlink" title="准备配置文件"></a>准备配置文件</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#三个节点都要创建数据目录</span></span><br><span class="line">[root@zookeeper-node1 ~]<span class="comment"># mkdir /usr/local/zookeeper/data</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#基于模板配置文件生成配置文件</span></span><br><span class="line">[root@zookeeper-node1 ~]<span class="comment"># cp /usr/local/zookeeper/conf/zoo_sample.cfg /usr/local/zookeeper/conf/zoo.cfg</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#修改配置文件</span></span><br><span class="line">[root@zookeeper-node1 ~]<span class="comment"># vim /usr/local/zookeeper/conf/zoo.cfg</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#配置文件内容</span></span><br><span class="line">[root@zookeeper-node1 ~]<span class="comment"># grep -v &quot;\^\#&quot; /usr/local/zookeeper/conf/zoo.cfg </span></span><br><span class="line">tickTime=2000  <span class="comment">#服务器与服务器之间的单次心跳检测时间间隔，单位为毫秒</span></span><br><span class="line">initLimit=10  <span class="comment">#集群中leader 服务器与follower服务器初始连接心跳次数，即多少个 2000 毫秒</span></span><br><span class="line">syncLimit=5  <span class="comment">#leader 与follower之间连接完成之后，后期检测发送和应答的心跳次数，如果该follower在设置的时间内(5*2000)不能与 leader 进行通信，那么此 follower将被视为不可用。</span></span><br><span class="line">dataDir=/usr/local/zookeeper/data <span class="comment">#自定义的zookeeper保存数据的目录</span></span><br><span class="line">clientPort=2181 <span class="comment">#客户端连接 Zookeeper 服务器的端口，Zookeeper会监听这个端口，接受客户端的访问请求</span></span><br><span class="line">maxClientCnxns=128 <span class="comment">#单个客户端IP 可以和zookeeper保持的连接数</span></span><br><span class="line">autopurge.snapRetainCount=3 <span class="comment">#3.4.0中的新增功能：启用后，ZooKeeper 自动清除功能,会将只保留此最新3个快照和相应的事务日志,并分别保留在dataDir 和dataLogDir中，删除其余部分，默认值为3,最小值为3</span></span><br><span class="line">autopurge.purgeInterval=24  <span class="comment">#3.4.0及之后版本，ZK提供了自动清理日志和快照文件的功能，这个参数指定了清理频率，单位是小时，需要配置一个1或更大的整数，默认是 0，表示不开启自动清理功能</span></span><br><span class="line"><span class="comment">#格式: server.MyID服务器唯一编号=服务器IP:Leader和Follower的数据同步端口(只有leader才会打开):Leader和Follower选举端口(L和F都有)</span></span><br><span class="line">server.1=10.0.0.101:2888:3888</span><br><span class="line">server.2=10.0.0.102:2888:3888</span><br><span class="line">server.3=10.0.0.103:2888:3888</span><br><span class="line"><span class="comment">#如果添加节点,只需要在所有节点上添加新节点的上面形式的配置行,在新节点创建myid文件,并重启所有节点服务即可</span></span><br><span class="line"></span><br><span class="line">[root@zookeeper-node1 ~]<span class="comment"># scp /usr/local/zookeeper/conf/zoo.cfg 10.0.0.102:/usr/local/zookeeper/conf/</span></span><br><span class="line">[root@zookeeper-node1 ~]<span class="comment"># scp /usr/local/zookeeper/conf/zoo.cfg 10.0.0.103:/usr/local/zookeeper/conf/</span></span><br></pre></td></tr></table></figure>

<h4 id="在各个节点生成ID文件"><a href="#在各个节点生成ID文件" class="headerlink" title="在各个节点生成ID文件"></a>在各个节点生成ID文件</h4><p>注意: 各个myid文件的内容要和zoo.cfg文件相匹配</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@zookeeper-node1 ~]<span class="comment"># echo 1 &gt; /usr/local/zookeeper/data/myid</span></span><br><span class="line">[root@zookeeper-node2 ~]<span class="comment"># echo 2 &gt; /usr/local/zookeeper/data/myid</span></span><br><span class="line">[root@zookeeper-node3 ~]<span class="comment"># echo 3 &gt; /usr/local/zookeeper/data/myid</span></span><br></pre></td></tr></table></figure>

<h4 id="各服务器启动-zookeeper"><a href="#各服务器启动-zookeeper" class="headerlink" title="各服务器启动 zookeeper"></a>各服务器启动 zookeeper</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#注意:在所有三个节点快速启动服务,否则会造成集群失败</span></span><br><span class="line">[root@zookeeper-node1 ~]<span class="comment"># zkServer.sh start</span></span><br><span class="line">[root@zookeeper-node2 ~]<span class="comment"># zkServer.sh start</span></span><br><span class="line">[root@zookeeper-node3 ~]<span class="comment"># zkServer.sh start</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#注意:如果无法启动查看日志</span></span><br><span class="line">[root@zookeeper-node1 ~]<span class="comment">#cat /usr/local/zookeeper/logs/zookeeper-root-server-zookeeper-node1.wang.org.out </span></span><br></pre></td></tr></table></figure>

<h4 id="查看集群状态"><a href="#查看集群状态" class="headerlink" title="查看集群状态"></a>查看集群状态</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#follower会监听3888/tcp端口</span></span><br><span class="line">[root@zookeeper-node1 ~]<span class="comment"># zkServer.sh status</span></span><br><span class="line">/usr/bin/java</span><br><span class="line">ZooKeeper JMX enabled by default</span><br><span class="line">Using config: /usr/local/zookeeper/bin/../conf/zoo.cfg</span><br><span class="line">Client port found: 2181. Client address: localhost. Client SSL: <span class="literal">false</span>.</span><br><span class="line">Mode: follower</span><br><span class="line"></span><br><span class="line">[root@zookeeper-node1 ~]<span class="comment"># ss -ntl |grep 888</span></span><br><span class="line">LISTEN  0        50         [::ffff:10.0.0.101]:3888                 *:*   </span><br><span class="line"></span><br><span class="line"><span class="comment">#只有leader监听2888/tcp端口</span></span><br><span class="line">[root@zookeeper-node2 ~]<span class="comment"># zkServer.sh status</span></span><br><span class="line">/usr/bin/java</span><br><span class="line">ZooKeeper JMX enabled by default</span><br><span class="line">Using config: /usr/local/zookeeper/bin/../conf/zoo.cfg</span><br><span class="line">Client port found: 2181. Client address: localhost. Client SSL: <span class="literal">false</span>.</span><br><span class="line">Mode: leader</span><br><span class="line"></span><br><span class="line">[root@zookeeper-node2 ~]<span class="comment"># ss -ntl|grep 888</span></span><br><span class="line">LISTEN  0        50         [::ffff:10.0.0.102]:3888                 *:*      </span><br><span class="line">LISTEN  0        50         [::ffff:10.0.0.102]:2888                 *:*   </span><br><span class="line"></span><br><span class="line">[root@zookeeper-node3 ~]<span class="comment"># zkServer.sh status</span></span><br><span class="line">/usr/bin/java</span><br><span class="line">ZooKeeper JMX enabled by default</span><br><span class="line">Using config: /usr/local/zookeeper/bin/../conf/zoo.cfg</span><br><span class="line">Client port found: 2181. Client address: localhost. Client SSL: <span class="literal">false</span>.</span><br><span class="line">Mode: follower</span><br><span class="line"></span><br><span class="line">[root@zookeeper-node3 ~]<span class="comment"># ss -ntl|grep 888</span></span><br><span class="line">LISTEN  0        50         [::ffff:10.0.0.103:3888                 *:* </span><br></pre></td></tr></table></figure>

<h2 id="客户端访问"><a href="#客户端访问" class="headerlink" title="客户端访问"></a>客户端访问</h2><h3 id="命令行客户端访问-ZooKeeper"><a href="#命令行客户端访问-ZooKeeper" class="headerlink" title="命令行客户端访问 ZooKeeper"></a>命令行客户端访问 ZooKeeper</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#可连接至zookeeper 集群中的任意一台zookeeper 节点进行以下操作,zkCli.sh 默认连接本机</span></span><br><span class="line">[root@zookeeper-node1 ~]<span class="comment"># zkCli.sh -server 10.0.0.103:2181</span></span><br><span class="line">[zk: 10.0.0.103:2181(CONNECTED) 0] <span class="built_in">ls</span> /</span><br><span class="line">[zookeeper]</span><br><span class="line"></span><br><span class="line">[zk: 10.0.0.103:2181(CONNECTED) 1] <span class="comment">#两个TAB 可以列出所有支持命令</span></span><br><span class="line">addWatch       addauth   close           config   connect       create</span><br><span class="line">delete         deleteall delquota        get      getAcl         </span><br><span class="line">getAllChildrenNumber     getEphemerals   <span class="built_in">history</span>  listquota     <span class="built_in">ls</span>     </span><br><span class="line">printwatches   quit      reconfig        redo     removewatches <span class="built_in">set</span>     </span><br><span class="line">setAcl         setquota  <span class="built_in">stat</span>            <span class="built_in">sync</span>     version</span><br><span class="line"></span><br><span class="line">[zk: 10.0.0.103:2181(CONNECTED) 1] version</span><br><span class="line">ZooKeeper CLI version: 3.6.2--803c7f1a12f85978cb049af5e4ef23bd8b688715, built on 09/04/2020 12:44 GMT</span><br><span class="line"></span><br><span class="line"><span class="comment">#默认创建持久节点,即退出不丢失,create -e 可以创建临时节点(退出就丢失)</span></span><br><span class="line"><span class="comment">#持久节点才支持创建子节点,临时节点不支持,如: create /app1/subapp1 &quot;subdata&quot; ，不能递归创建</span></span><br><span class="line">[zk: 10.0.0.103:2181(CONNECTED) 2] create /app1 <span class="string">&quot;hello,zookeeper&quot;</span></span><br><span class="line">Created /app1</span><br><span class="line">[zk: 10.0.0.103:2181(CONNECTED) 3] <span class="built_in">ls</span> /</span><br><span class="line">[app1, zookeeper]</span><br><span class="line"></span><br><span class="line"><span class="comment">#get -s /app1可以查看更详细的信息</span></span><br><span class="line">[zk: 10.0.0.103:2181(CONNECTED) 4] get /app1</span><br><span class="line">hello,zookeeper</span><br><span class="line"></span><br><span class="line"><span class="comment">#修改已有节点的值</span></span><br><span class="line">[zk: 10.0.0.103:2181(CONNECTED) 5] <span class="built_in">set</span> /app1 <span class="string">&quot;hello,linux&quot;</span></span><br><span class="line">[zk: 10.0.0.103:2181(CONNECTED) 6] get /app1 </span><br><span class="line">hello,linux</span><br><span class="line"></span><br><span class="line"><span class="comment">#删除不包含子节点的节点(相当于rmdir),如果想删除所有节点内的数据,使用deleteall /path(相当于rm -rf)</span></span><br><span class="line">[zk: 10.0.0.103:2181(CONNECTED) 7] delete /app1</span><br><span class="line">[zk: 10.0.0.103:2181(CONNECTED) 8] <span class="built_in">ls</span> /</span><br><span class="line">[zookeeper]</span><br><span class="line"></span><br><span class="line"><span class="comment">#查看已知节点元数据</span></span><br><span class="line">[zk: 10.0.0.103:2181(CONNECTED) 9] <span class="built_in">stat</span> /zookeeper</span><br><span class="line">zxid = Ox0                              <span class="comment">#节点创建时的zxid</span></span><br><span class="line">ctime = Thu Jan 01 08:00:00 CST 1970    <span class="comment">#节点创建时间</span></span><br><span class="line">mzxid = Ox0                             <span class="comment">#节点最近一次更新时的zxid</span></span><br><span class="line">mtime = Thu Jan 01 08:00:00 cST 1970    <span class="comment">#节点最近一次更新的时间</span></span><br><span class="line">pzxid = Ox0                             <span class="comment">#父节点创建时的zxid</span></span><br><span class="line">cversion = -1                           <span class="comment">#子节点数据更新次数</span></span><br><span class="line">dataversion = 0                         <span class="comment">#本节点数据更新次数</span></span><br><span class="line">aclversion = o                          <span class="comment">#节点ACL(授权信息)的更新次数</span></span><br><span class="line">ephemera10wner = Ox0                    <span class="comment">#持久节点值为0，临时节点值为sessionid</span></span><br><span class="line">dataLength = 0                          <span class="comment">#节点数据长度</span></span><br><span class="line">numchi1dren = 1                         <span class="comment">#子节点个数</span></span><br><span class="line"></span><br><span class="line">[zk: 10.0.0.103:2181(CONNECTED) 10] quit</span><br></pre></td></tr></table></figure>

<h3 id="nc-访问-ZooKeeper"><a href="#nc-访问-ZooKeeper" class="headerlink" title="nc 访问 ZooKeeper"></a>nc 访问 ZooKeeper</h3><p>ZooKeeper支持某些特定的四字命令字母与其的交互。它们大多是查询命令，用来获取 ZooKeeper服务的当前状态及相关信息。用户在客户端可以通过 netcat 或telnet向zookeeper发送下面命令</p>
<p><strong>常见命令列表</strong></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">conf    <span class="comment">#输出相关服务配置的详细信息</span></span><br><span class="line">cons    <span class="comment">#列出所有连接到服务器的客户端的完全的连接/会话的详细信息</span></span><br><span class="line">envi    <span class="comment">#输出关于服务环境的详细信息</span></span><br><span class="line">dump    <span class="comment">#列出未经处理的会话和临时节点</span></span><br><span class="line"><span class="built_in">stat</span>    <span class="comment">#查看哪个节点被选择作为Follower或者Leader</span></span><br><span class="line">ruok    <span class="comment">#测试是否启动了该Server，若回复imok表示已经启动</span></span><br><span class="line">mntr    <span class="comment">#输出一些运行时信息</span></span><br><span class="line">reqs    <span class="comment">#列出未经处理的请求</span></span><br><span class="line">wchs    <span class="comment">#列出服务器watch的简要信息</span></span><br><span class="line">wchc    <span class="comment">#通过session列出服务器watch的详细信息</span></span><br><span class="line">wchp    <span class="comment">#通过路径列出服务器watch的详细信息</span></span><br><span class="line">srvr    <span class="comment">#输出服务的所有信息</span></span><br><span class="line">srst    <span class="comment">#重置服务器统计信息</span></span><br><span class="line"><span class="built_in">kill</span>    <span class="comment">#关掉Server</span></span><br><span class="line">isro    <span class="comment">#查看该服务的节点权限信息</span></span><br></pre></td></tr></table></figure>

<p><strong>命令的安全限制</strong></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#默认情况下，这些4字命令有可能会被拒绝，发送如下报错</span></span><br><span class="line">xxx is not executed because it is not <span class="keyword">in</span> the whitelist.</span><br><span class="line"></span><br><span class="line"><span class="comment">#解决办法:在 zoo.cfg文件中添加如下配置,如果是集群需要在所有节点上添加下面配置</span></span><br><span class="line"><span class="comment"># vim conf/zoo.cfg</span></span><br><span class="line">4lw.commands.whitelist=*</span><br><span class="line"></span><br><span class="line"><span class="comment">#在服务状态查看命令中有很多存在隐患的命令，所以为了避免生产中因为这些命令的安全隐患，所以我们要对这些命令进行一些安全限制，只需要编辑服务的zoo.cfg文件即可</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># vim conf/zoo.cfg</span></span><br><span class="line">4lw.commands.whitelist=<span class="built_in">stat</span>，ruok，conf，isro</span><br></pre></td></tr></table></figure>

<p>范例:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">ubuntu18.04安装netcat</span><br><span class="line"><span class="comment">#apt -y install netcat-traditional</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#查看节点服务状态</span></span><br><span class="line"><span class="built_in">echo</span> <span class="built_in">stat</span> | nc 127.0.0.1 2181</span><br><span class="line"></span><br><span class="line"><span class="comment">#查看节点服务配置</span></span><br><span class="line"><span class="built_in">echo</span> conf | nc 127.0.0.1 2181</span><br><span class="line"></span><br><span class="line"><span class="comment">#查看节点服务环境</span></span><br><span class="line"><span class="built_in">echo</span> envi | nc 127.0.0.1 2181</span><br><span class="line"></span><br><span class="line"><span class="comment">#查看节点服务会话</span></span><br><span class="line"><span class="built_in">echo</span> cons | nc 127.0.0.1 2181</span><br><span class="line"><span class="built_in">echo</span> dump | nc 127.0.0.1 2181</span><br><span class="line"></span><br><span class="line"><span class="comment">#也支持 telnet,但不能用 | telnet 形式</span></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment"># telnet 127.0.0.1 2181</span></span><br><span class="line">Trying 10.0.0.8...</span><br><span class="line">Connected to 10.0.0.8.</span><br><span class="line">Escape character is <span class="string">&#x27;^]&#x27;</span>.</span><br><span class="line">cons</span><br><span class="line"> /10.0.0.100:52154[0](queued=0,recved=1,sent=0)</span><br><span class="line"> /127.0.0.1:59566[1]</span><br><span class="line">(queued=0,recved=8,sent=8,sid=0x100004b74080001,lop=PING,est=1635560454029,to=30000,lcxid=0x0,lzxid=0x9,lresp=5205692,llat=0,minlat=0,avglat=0,maxlat=2)</span><br><span class="line"></span><br><span class="line">Connection closed by foreign host.</span><br></pre></td></tr></table></figure>

<h3 id="图形化客户端-ZooInspector"><a href="#图形化客户端-ZooInspector" class="headerlink" title="图形化客户端 ZooInspector"></a>图形化客户端 ZooInspector</h3><p>github链接</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">https://github.com/zzhang5/zooinspector</span><br><span class="line">https://gitee.com/lbtooth/zooinspector.git</span><br></pre></td></tr></table></figure>

<h4 id="Linux-客户端"><a href="#Linux-客户端" class="headerlink" title="Linux 客户端"></a>Linux 客户端</h4><h5 id="编译-zooinspector"><a href="#编译-zooinspector" class="headerlink" title="编译 zooinspector"></a>编译 zooinspector</h5><p>注意：此软件因年代久远不再更新，当前只支持在Ubuntu18.04和Rocky8编译安装,不支持更高版本，如Ubuntu20.04等</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#https://github.com/zzhang5/zooinspector</span></span><br><span class="line">Build</span><br><span class="line"></span><br><span class="line"><span class="variable">$git</span> <span class="built_in">clone</span> https://github.com/zzhang5/zooinspector.git</span><br><span class="line"><span class="variable">$cd</span> zooinspector/</span><br><span class="line"><span class="variable">$mvn</span> clean package -Dmaven.test.skip=<span class="literal">true</span></span><br><span class="line"></span><br><span class="line">Run</span><br><span class="line"><span class="variable">$chmod</span> +x target/zooinspector-pkg/bin/zooinspector.sh</span><br><span class="line"><span class="variable">$target</span>/zooinspector-pkg/bin/zooinspector.sh</span><br></pre></td></tr></table></figure>

<p><img src="../../../../images/SRE/day52/18.jpg" alt="18"></p>
<p>范例: 编译 zooinspector</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#注意：在Ubuntu18.04或Rocky8上编译，不支持Ubuntu20.04以上版本</span></span><br><span class="line"><span class="comment">#github</span></span><br><span class="line">[root@zookeeper-node1 ~]<span class="comment"># git clone https://github.com/zzhang5/zooinspector.git</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#国内镜像</span></span><br><span class="line">[root@zookeeper-node1 ~]<span class="comment"># git clone https://gitee.com/lbtooth/zooinspector.git</span></span><br><span class="line">[root@zookeeper-node1 ~]<span class="comment"># cd zooinspector/</span></span><br><span class="line">[root@zookeeper-node1 zooinspector]<span class="comment"># apt install maven -y</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#镜像加速</span></span><br><span class="line">[root@zookeeper-node1 zooinspector]<span class="comment"># vim /etc/maven/settings.xml</span></span><br><span class="line"> &lt;mirrors&gt;</span><br><span class="line">   &lt;!--阿里云镜像--&gt;</span><br><span class="line">   &lt;mirror&gt;</span><br><span class="line">       &lt;<span class="built_in">id</span>&gt;nexus-aliyun&lt;/id&gt;</span><br><span class="line">       &lt;mirrorOf&gt;*&lt;/mirrorOf&gt;</span><br><span class="line">       &lt;name&gt;Nexus aliyun&lt;/name&gt;</span><br><span class="line">       &lt;url&gt;http://maven.aliyun.com/nexus/content/groups/public&lt;/url&gt;</span><br><span class="line">   &lt;/mirror&gt;          </span><br><span class="line"> &lt;/mirrors&gt;</span><br><span class="line"><span class="comment">#编译,此步骤需要较长时间下载,可能数分钟</span></span><br><span class="line">[root@zookeeper-node1 zooinspector]<span class="comment"># mvn clean package -Dmaven.test.skip=true  </span></span><br></pre></td></tr></table></figure>

<p><img src="../../../../images/SRE/day52/19.jpg" alt="19"><br><img src="../../../../images/SRE/day52/20.jpg" alt="20"></p>
<h5 id="客户端使用"><a href="#客户端使用" class="headerlink" title="客户端使用"></a>客户端使用</h5><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[root@zookeeper-node1 zooinspector]<span class="comment"># ls</span></span><br><span class="line">pom.xml README.md src target</span><br><span class="line"></span><br><span class="line">[root@zookeeper-node1 zooinspector]<span class="comment"># du -sh .</span></span><br><span class="line">7.3M .</span><br><span class="line"></span><br><span class="line">[root@zookeeper-node1 zooinspector]<span class="comment"># chmod +x target/zooinspector-pkg/bin/zooinspector.sh</span></span><br><span class="line">[root@zookeeper-node1 zooinspector]<span class="comment"># target/zooinspector-pkg/bin/zooinspector.sh</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#自动打开下面图形界面</span></span><br></pre></td></tr></table></figure>

<p><img src="../../../../images/SRE/day52/21.jpg" alt="21"><br><img src="../../../../images/SRE/day52/22.jpg" alt="22"></p>
<h4 id="Windows-客户端使用"><a href="#Windows-客户端使用" class="headerlink" title="Windows 客户端使用"></a>Windows 客户端使用</h4><p>先下载并安装 JDK</p>
<p>注意: Oracle官网需要登录才能下载</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://www.oracle.com/java/technologies/javase/javase-jdk8-downloads.html</span><br></pre></td></tr></table></figure>

<p>运行下面命令</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">D:\&gt;java -jar zookeeper-dev-ZooInspector.jar</span><br><span class="line"></span><br><span class="line"><span class="comment">#或者直接使用Linux上面编译生成的文件zookinspector-1.0-SNAPSHOT-pkg.tar在Windows中解压缩,直接运行里的zooinspector.bat即可</span></span><br></pre></td></tr></table></figure>

<p><img src="../../../../images/SRE/day52/23.jpg" alt="23"><br><img src="../../../../images/SRE/day52/24.jpg" alt="24"><br><img src="../../../../images/SRE/day52/25.jpg" alt="25"><br><img src="../../../../images/SRE/day52/26.jpg" alt="26"><br><img src="../../../../images/SRE/day52/27.jpg" alt="27"></p>
<h3 id="Python-访问-ZooKeeper"><a href="#Python-访问-ZooKeeper" class="headerlink" title="Python 访问 ZooKeeper"></a>Python 访问 ZooKeeper</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[root@zookeeper-node1 ~]<span class="comment"># apt -y install python3 python3-kazoo</span></span><br><span class="line">[root@zookeeper-node1 ~]<span class="comment"># cat zookeepe_test.py </span></span><br><span class="line"><span class="comment">#!/usr/bin/python3</span></span><br><span class="line">from kazoo.client import KazooClient</span><br><span class="line">zk = KazooClient(hosts=<span class="string">&#x27;10.0.0.101:2181&#x27;</span>)</span><br><span class="line">zk.start()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建节点：makepath 设置为 True ，父节点不存在则创建，其他参数不填均为默认</span></span><br><span class="line">zk.create(<span class="string">&#x27;/zkapp/test&#x27;</span>,b<span class="string">&#x27;this is a test&#x27;</span>,makepath=True)</span><br><span class="line"><span class="comment"># 操作完后关闭zk连接</span></span><br><span class="line">data=zk.get(<span class="string">&#x27;/zkapp/test&#x27;</span>)</span><br><span class="line"><span class="built_in">print</span>(data)</span><br><span class="line">zk.stop()</span><br><span class="line"></span><br><span class="line">[root@zookeeper-node1 ~]<span class="comment"># chmod +x ./zookeepe_test.py</span></span><br><span class="line">[root@zookeeper-node1 ~]<span class="comment"># ./zookeepe_test.py</span></span><br></pre></td></tr></table></figure>

<h1 id="Kafka"><a href="#Kafka" class="headerlink" title="Kafka"></a>Kafka</h1><h2 id="消息队列简介"><a href="#消息队列简介" class="headerlink" title="消息队列简介"></a>消息队列简介</h2><h3 id="MQ-定义"><a href="#MQ-定义" class="headerlink" title="MQ 定义"></a>MQ 定义</h3><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">#阿里云消息队列</span><br><span class="line">https://www.aliyun.com/product/ons?spm=5176.234368.h2v3icoap.427.2620db25lcHi1Q&amp;amp;aly_as=Tz_Lue_o</span><br></pre></td></tr></table></figure>

<p>在分布式场景中，相对于大量的用户请求来说，内部的功能主机之间、功能模块之间等，数据传递的数据量是无法想象的，因为一个用户请求，会涉及到各种内部的业务逻辑跳转等操作。那么，在大量用户的业务场景中，如何保证所有的内部业务逻辑请求都处于稳定而且快捷的数据传递呢? 消息队列(Message Queue)技术可以满足此需求</p>
<p>消息队列（Message Queue，简称 MQ）是构建分布式互联网应用的基础设施，通过 MQ 实现的松耦合架构设计可以提高系统可用性以及可扩展性，是适用于现代应用的最佳设计方案。</p>
<p>消息队列是一种异步的服务间通信方式，适用于无服务器和微服务架构。消息在被处理和删除之前一直存储在队列上。每条消息仅可被一位用户处理一次。消息队列可被用于分离重量级处理、缓冲或批处理工作以及缓解高峰期工作负载。</p>
<h3 id="MQ-使用场合"><a href="#MQ-使用场合" class="headerlink" title="MQ 使用场合"></a>MQ 使用场合</h3><p><img src="../../../../images/SRE/day52/28.jpg" alt="28"></p>
<p>消息队列作为高并发系统的核心组件之一，能够帮助业务系统结构提升开发效率和系统稳定性</p>
<p>消息队列主要有以下应用场景</p>
<ul>
<li><p>削峰填谷</p>
<p>诸如电商业务中的秒杀、抢红包、企业开门红等大型活动时皆会带来较高的流量脉冲，或因没做相应的保护而导致系统超负荷甚至崩溃，或因限制太过导致请求大量失败而影响用户体验，消息队列可提供削峰填谷的服务来解决该问题。</p>
</li>
<li><p>异步解耦</p>
<p>交易系统作为淘宝等电商的最核心的系统，每笔交易订单数据的产生会引起几百个下游业务系统的关注，包括物流、购物车、积分、流计算分析等等，整体业务系统庞大而且复杂，消息队列可实现异步通信和应用解耦，确保主站业务的连续性。</p>
</li>
<li><p>顺序收发</p>
<p>细数日常中需要保证顺序的应用场景非常多，例如证券交易过程时间优先原则，交易系统中的订单创建、支付、退款等流程，航班中的旅客登机消息处理等等。与先进先出FIFO（First In First Out）原理类似，消息队列提供的顺序消息即保证消息FIFO。</p>
</li>
<li><p>分布式事务一致性</p>
<p>交易系统、支付红包等场景需要确保数据的最终一致性，大量引入消息队列的分布式事务，既可以实现系统之间的解耦，又可以保证最终的数据一致性。</p>
</li>
<li><p>大数据分析</p>
<p>数据在“流动”中产生价值，传统数据分析大多是基于批量计算模型，而无法做到实时的数据分析，利用消息队列与流式计算引擎相结合，可以很方便的实现业务数据的实时分析。</p>
</li>
<li><p>分布式缓存同步</p>
<p>电商的大促，各个分会场琳琅满目的商品需要实时感知价格变化，大量并发访问数据库导致会场页面响应时间长，集中式缓存因带宽瓶颈，限制了商品变更的访问流量，通过消息队列构建分布式缓存，实时通知商品数据的变化</p>
</li>
<li><p>蓄流压测</p>
<p>线上有些链路不方便做压力测试，可以通过堆积一定量消息再放开来压测</p>
</li>
</ul>
<h3 id="主流-MQ"><a href="#主流-MQ" class="headerlink" title="主流 MQ"></a>主流 MQ</h3><p>目前主流的消息队列软件有 Kafka、RabbitMQ、ActiveMQ、RocketMQ等，还有相对小众的消息队列软件如ZeroMQ、Apache Qpid 等。</p>
<p><img src="../../../../images/SRE/day52/29.jpg" alt="29"></p>
<h2 id="Kafka-介绍"><a href="#Kafka-介绍" class="headerlink" title="Kafka 介绍"></a>Kafka 介绍</h2><p><img src="../../../../images/SRE/day52/30.jpg" alt="30"></p>
<p>阿里云消息队列</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://www.aliyun.com/product/ons?spm=5176.234368.h2v3icoap.427.2620db25lcHi1Q&amp;amp;aly_as=Tz_Lue_o</span><br></pre></td></tr></table></figure>

<p>Kafka 被称为下一代分布式消息系统，由 Scala 和 Java编写，是非营利性组织ASF(Apache Software Foundation)基金会中的一个开源项目，比如:HTTP Server、Tomcat、Hadoop、ActiveMQ等开源软件都属于 Apache基金会的开源软件，类似的消息系统还有RabbitMQ、ActiveMQ、ZeroMQ。</p>
<p>Kafka用于构建实时数据管道和流应用程序。 它具有水平可伸缩性，容错性，快速性，可在数千家组织中同时投入生产协同工作。</p>
<p>官网: <a target="_blank" rel="noopener" href="http://kafka.apache.org/">http://kafka.apache.org/</a></p>
<h2 id="常用消息队列对比"><a href="#常用消息队列对比" class="headerlink" title="常用消息队列对比"></a>常用消息队列对比</h2><p>kafka 最主要的优势是其具备分布式功能、并可以结合 zookeeper 可以实现动态扩容，Kafka 是一种高吞吐量的分布式发布订阅消息系统。</p>
<p><img src="../../../../images/SRE/day52/31.jpg" alt="31"></p>
<h2 id="Kafka-特点和优势"><a href="#Kafka-特点和优势" class="headerlink" title="Kafka 特点和优势"></a>Kafka 特点和优势</h2><p><img src="../../../../images/SRE/day52/32.jpg" alt="32"></p>
<p>特点</p>
<ul>
<li>分布式: 多机实现,不允许单机</li>
<li>分区: 一个消息.可以拆分出多个，分别存储在多个位置</li>
<li>多副本: 防止信息丢失，可以多来几个备份</li>
<li>多订阅者: 可以有很多应用连接kafka</li>
<li>Zookeeper: 早期版本的Kafka依赖于zookeeper， 2021年4月19日Kafka 2.8.0正式发布，此版本包括了很多重要改动，最主要的是kafka通过自我管理的仲裁来替代ZooKeeper，即Kafka将不再需要ZooKeeper！ </li>
</ul>
<p>优势</p>
<ul>
<li>Kafka通过 O(1)的磁盘数据结构提供消息的持久化，这种结构对于即使数以 TB 级别以上的消息存储也能够保持长时间的稳定性能。</li>
<li>高吞吐量：即使是非常普通的硬件Kafka也可以支持每秒数百万的消息。支持通过Kafka 服务器分区消息。</li>
<li>分布式： Kafka 基于分布式集群实现高可用的容错机制，可以实现自动的故障转移</li>
<li>顺序保证：在大多数使用场景下，数据处理的顺序都很重要。大部分消息队列本来就是排序的，并且能保证数据会按照特定的顺序来处理。 Kafka保证一个Partiton内的消息的有序性（分区间数据是无序的，如果对数据的顺序有要求，应将在创建主题时将分区数partitions设置为1）</li>
<li>支持 Hadoop 并行数据加载</li>
<li>通常用于大数据场合,传递单条消息比较大，而Rabbitmq 消息主要是传输业务的指令数据,单条数据较小</li>
</ul>
<p><strong>随机和顺序IO比较</strong></p>
<p><img src="../../../../images/SRE/day52/33.jpg" alt="33"></p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">O(1)就是最低的时空复杂度，也就是耗时/耗空间与输入数据大小无关，无论输入数据增大多少倍，耗时/耗空</span><br><span class="line">间都不变，哈希算法就是典型的O(1)时间复杂度，无论数据规模多大，都可以在一次计算后找到目标</span><br></pre></td></tr></table></figure>

<h2 id="Kafka-角色和流程"><a href="#Kafka-角色和流程" class="headerlink" title="Kafka 角色和流程"></a>Kafka 角色和流程</h2><h3 id="Kafka-角色"><a href="#Kafka-角色" class="headerlink" title="Kafka 角色"></a>Kafka 角色</h3><p><img src="../../../../images/SRE/day52/34.jpg" alt="34"></p>
<p>Producer：Producer即生产者，消息的产生者，是消息的入口。负责发布消息到Kafka broker。</p>
<p>Consumer：消费者，用于消费消息，即处理消息</p>
<p>Consumer group: 每个consumer 属于一个特定的consumer group（可为每个consumer 指定 group name，若不指定 group name 则属于默认的group），使用 consumer high level API 时，同一topic的一条消息只能被同一个consumer group 内的一个consumer 消费，但多个consumer group 可同时消费这一消息。</p>
<p>Broker：Broker是kafka实例，每个服务器上可以有一个或多个kafka的实例，假设每个broker对应一台服务器。每个kafka集群内的broker都有一个不重复的编号，如: broker-0、broker-1等……</p>
<p>Topic ：消息的主题，可以理解为消息的分类，相当于Redis的Key和ES中的索引，kafka的数据就保存在topic。在每个broker上都可以创建多个topic。物理上不同 topic 的消息分开存储在不同的文件夹，逻辑上一个 topic的消息虽然保存于一个或多个broker 上, 但用户只需指定消息的topic即可生产或消费数据而不必关心数据存于何处，topic 在逻辑上对record(记录、日志)进行分组保存，消费者需要订阅相应的topic 才能消费topic中的消息。</p>
<p><img src="../../../../images/SRE/day52/35.jpg" alt="35"></p>
<p>Replication: 同样数据的副本，包括leader和follower的副本数,基本于数据安全,建议至少2个,是Kafka的高可靠性的保障，和ES不同的，ES中的副本数不包括主分片数</p>
<p>Partition ：是物理上的概念，每个topic 分割为一个或多个partition，即一个topic切分为多份.创建topic时可指定 parition 数量，partition的表现形式就是一个一个的文件夹,该文件夹下存储该partition的数据和索引文件，分区的作用还可以实现负载均衡，提高kafka的吞吐量。同一个topic在不同的分区的数据是不重复的,一般Partition数不要超过节点数，注意同一个partition数据是有顺序的，但不同的 partition则是无序的。</p>
<p>为了实现数据的高可用，比如将分区 0 的数据分散到不同的kafka 节点，每一个分区都有一个 broker 作为 Leader 和一个 broker 作为Follower，类似于ES中的主分片和副本分片，</p>
<p>AR： Assigned Replicas，分区中的所有副本的统称，AR= lSR+ OSR</p>
<p>lSR：ln Sync Replicas，所有与leader副本保持同步的副本 follower和leader本身组成的集合，是AR的子集</p>
<p>OSR：out-of-Sync Replied，所有与leader副本同步不能同步的 follower的集合，是AR的子集</p>
<p>分区的优势：</p>
<ul>
<li>实现存储空间的横向扩容，即将多个kafka服务器的空间结合利用</li>
<li>提升性能，多服务器读写</li>
<li>实现高可用，分区leader 分布在不同的kafka 服务器，假设分区因子为 3, 分区 0 的leader为服务器A，则服务器 B 和服务器 C 为 A 的follower，而分区 1 的leader为服务器B，则服务器 A 和C 为服务器B 的follower，而分区 2 的leader 为C，则服务器A 和 B 为C 的follower。</li>
</ul>
<p><img src="../../../../images/SRE/day52/36.jpg" alt="36"></p>
<h3 id="Kafka-写入消息的流程"><a href="#Kafka-写入消息的流程" class="headerlink" title="Kafka 写入消息的流程"></a>Kafka 写入消息的流程</h3><p><img src="../../../../images/SRE/day52/37.jpg" alt="37"></p>
<h2 id="Kafka-部署"><a href="#Kafka-部署" class="headerlink" title="Kafka 部署"></a>Kafka 部署</h2><p>官方文档: </p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://kafka.apache.org/quickstart</span><br></pre></td></tr></table></figure>

<p><img src="../../../../images/SRE/day52/38.jpg" alt="38"></p>
<h3 id="环境准备-ZooKeeper"><a href="#环境准备-ZooKeeper" class="headerlink" title="环境准备 ZooKeeper"></a>环境准备 ZooKeeper</h3><p>当前版本 Kafka 依赖 Zookeeper 服务,但以后将不再依赖</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">http://kafka.apache.org/quickstart</span><br><span class="line"># Note: Soon, ZooKeeper will no longer be required by Apache Kafka.</span><br></pre></td></tr></table></figure>

<p>环境说明</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#在三个Ubuntu18.04节点提前部署zookeeper和kafka三个节点复用</span></span><br><span class="line">node1:10.0.0.101 </span><br><span class="line">node2:10.0.0.102 </span><br><span class="line">node3:10.0.0.103</span><br><span class="line"></span><br><span class="line"><span class="comment">#注意:生产中zookeeper和kafka一般是分开独立部署的,kafka安装前需要安装java环境</span></span><br></pre></td></tr></table></figure>

<p>确保三个节点的zookeeper启动</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">[root@node1 ~]<span class="comment"># zkServer.sh status</span></span><br><span class="line">/usr/bin/java</span><br><span class="line">ZooKeeper JMX enabled by default</span><br><span class="line">Using config: /usr/local/zookeeper/bin/../conf/zoo.cfg</span><br><span class="line">Client port found: 2181. Client address: localhost. Client SSL: <span class="literal">false</span>.</span><br><span class="line">Mode: follower</span><br><span class="line"></span><br><span class="line">[root@node2 ~]<span class="comment"># zkServer.sh status</span></span><br><span class="line">/usr/bin/java</span><br><span class="line">ZooKeeper JMX enabled by default</span><br><span class="line">Using config: /usr/local/zookeeper/bin/../conf/zoo.cfg</span><br><span class="line">Client port found: 2181. Client address: localhost. Client SSL: <span class="literal">false</span>.</span><br><span class="line">Mode: leader</span><br><span class="line"></span><br><span class="line">[root@node3 ~]<span class="comment"># zkServer.sh status</span></span><br><span class="line">/usr/bin/java</span><br><span class="line">ZooKeeper JMX enabled by default</span><br><span class="line">Using config: /usr/local/zookeeper/bin/../conf/zoo.cfg</span><br><span class="line">Client port fou</span><br></pre></td></tr></table></figure>

<h3 id="版本选择"><a href="#版本选择" class="headerlink" title="版本选择"></a>版本选择</h3><p>kafka 基于scala语言实现,所以使用kafka需要指定scala的相应的版本.kafka 为多个版本的Scala构建。这仅在使用 Scala 时才重要，并且希望为使用的相同 Scala 版本构建一个版本。否则，任何版本都可以</p>
<p>kafka下载链接</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://kafka.apache.org/downloads</span><br></pre></td></tr></table></figure>

<p>kafka版本格式</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kafka_&lt;scala 版本&gt;_&lt;kafka 版本&gt;</span><br><span class="line"><span class="comment">#示例:kafka_2.13-2.7.0.tgz</span></span><br></pre></td></tr></table></figure>

<p>scala 语言官网: <a target="_blank" rel="noopener" href="https://www.scala-lang.org/">https://www.scala-lang.org/</a> </p>
<p>scale 与 java关系:<a target="_blank" rel="noopener" href="https://baike.baidu.com/item/Scala/2462287?fr=aladdin">https://baike.baidu.com/item/Scala/2462287?fr=aladdin</a></p>
<h3 id="各节点部署-Kafka"><a href="#各节点部署-Kafka" class="headerlink" title="各节点部署 Kafka"></a>各节点部署 Kafka</h3><h4 id="Kafka-节点配置"><a href="#Kafka-节点配置" class="headerlink" title="Kafka 节点配置"></a>Kafka 节点配置</h4><p>配置文件说明</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#配置文件 ./conf/server.properties内容说明</span></span><br><span class="line"></span><br><span class="line"><span class="comment">############################# Server Basics###############################</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># broker的id，值为整数，且必须唯一，在一个集群中不能重复</span></span><br><span class="line">broker.id=1</span><br><span class="line"></span><br><span class="line"><span class="comment">############################# Socket ServerSettings ######################</span></span><br><span class="line"><span class="comment"># kafka监听端口，默认9092</span></span><br><span class="line">listeners=PLAINTEXT://10.0.0.101:9092</span><br><span class="line"></span><br><span class="line"><span class="comment"># 处理网络请求的线程数量，默认为3个</span></span><br><span class="line">num.network.threads=3</span><br><span class="line"></span><br><span class="line"><span class="comment"># 执行磁盘IO操作的线程数量，默认为8个</span></span><br><span class="line">num.io.threads=8</span><br><span class="line"></span><br><span class="line"><span class="comment"># socket服务发送数据的缓冲区大小，默认100KB</span></span><br><span class="line">socket.send.buffer.bytes=102400</span><br><span class="line"></span><br><span class="line"><span class="comment"># socket服务接受数据的缓冲区大小，默认100KB</span></span><br><span class="line">socket.receive.buffer.bytes=102400</span><br><span class="line"></span><br><span class="line"><span class="comment"># socket服务所能接受的一个请求的最大大小，默认为100M</span></span><br><span class="line">socket.request.max.bytes=104857600</span><br><span class="line"></span><br><span class="line"><span class="comment">############################# Log Basics###################################</span></span><br><span class="line"><span class="comment"># kafka存储消息数据的目录</span></span><br><span class="line">log.dirs=../data</span><br><span class="line"></span><br><span class="line"><span class="comment"># 每个topic默认的partition</span></span><br><span class="line">num.partitions=1</span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置副本数量为3,当Leader的Replication故障，会进行故障自动转移。</span></span><br><span class="line">default.replication.factor=3</span><br><span class="line"></span><br><span class="line"><span class="comment"># 在启动时恢复数据和关闭时刷新数据时每个数据目录的线程数量</span></span><br><span class="line">num.recovery.threads.per.data.dir=1</span><br><span class="line"></span><br><span class="line"><span class="comment">############################# Log FlushPolicy #############################</span></span><br><span class="line"><span class="comment"># 消息刷新到磁盘中的消息条数阈值</span></span><br><span class="line">log.flush.interval.messages=10000</span><br><span class="line"></span><br><span class="line"><span class="comment"># 消息刷新到磁盘中的最大时间间隔,1s</span></span><br><span class="line">log.flush.interval.ms=1000</span><br><span class="line"></span><br><span class="line"><span class="comment">############################# Log RetentionPolicy #########################</span></span><br><span class="line"><span class="comment"># 日志保留小时数，超时会自动删除，默认为7天</span></span><br><span class="line">log.retention.hours=168</span><br><span class="line"></span><br><span class="line"><span class="comment"># 日志保留大小，超出大小会自动删除，默认为1G</span></span><br><span class="line"><span class="comment">#log.retention.bytes=1073741824</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 日志分片策略，单个日志文件的大小最大为1G，超出后则创建一个新的日志文件</span></span><br><span class="line">log.segment.bytes=1073741824</span><br><span class="line"></span><br><span class="line"><span class="comment"># 每隔多长时间检测数据是否达到删除条件,300s</span></span><br><span class="line">log.retention.check.interval.ms=300000</span><br><span class="line"></span><br><span class="line"><span class="comment">############################# Zookeeper ####################################</span></span><br><span class="line"><span class="comment"># Zookeeper连接信息，如果是zookeeper集群，则以逗号隔开</span></span><br><span class="line">zookeeper.connect=10.0.0.101:2181,10.0.0.102:2181,10.0.0.103:2181</span><br><span class="line"></span><br><span class="line"><span class="comment"># 连接zookeeper的超时时间,6s</span></span><br><span class="line">zookeeper.connection.timeout.ms=6000</span><br></pre></td></tr></table></figure>

<p>范例：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#在所有节点上执行安装java</span></span><br><span class="line">[root@node1 ~]<span class="comment"># apt install openjdk-8-jdk -y</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#在所有节点上执行下载，官方下载</span></span><br><span class="line">[root@node1 ~]<span class="comment"># wget https://archive.apache.org/dist/kafka/2.7.0/kafka_2.13-2.7.0.tgz</span></span><br><span class="line"></span><br><span class="line">[root@node1 ~]<span class="comment"># wget https://downloads.apache.org/kafka/3.3.1/kafka_2.13-3.3.1.tgz</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#国内镜像下载</span></span><br><span class="line">[root@node1 ~]<span class="comment"># wget https://mirrors.tuna.tsinghua.edu.cn/apache/kafka/3.3.1/kafka_2.13-3.3.1.tgz</span></span><br><span class="line">[root@node1 ~]<span class="comment"># wget https://mirrors.tuna.tsinghua.edu.cn/apache/kafka/3.0.0/kafka_2.13-3.0.0.tgz</span></span><br><span class="line">[root@node1 ~]<span class="comment"># wget https://mirror.bit.edu.cn/apache/kafka/2.7.0/kafka_2.13-2.7.0.tgz</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#解压缩</span></span><br><span class="line">[root@node1 ~]<span class="comment"># tar xf kafka_2.13-2.7.0.tgz -C /usr/local/</span></span><br><span class="line">[root@node1 ~]<span class="comment"># ln -s /usr/local/kafka_2.13-2.7.0/ /usr/local/kafka</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#配置PATH变量</span></span><br><span class="line">[root@node1 ~]<span class="comment"># echo &#x27;PATH=/usr/local/kafka/bin:$PATH&#x27; &gt; /etc/profile.d/kafka.sh</span></span><br><span class="line">[root@node1 ~]<span class="comment"># . /etc/profile.d/kafka.sh</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#修改配置文件</span></span><br><span class="line">[root@node1 ~]<span class="comment"># vim /usr/local/kafka/config/server.properties</span></span><br><span class="line">broker.id=1 <span class="comment">#每个broker在集群中每个节点的正整数唯一标识，此值保存在log.dirs下的meta.properties文件</span></span><br><span class="line">listeners=PLAINTEXT://10.0.0.101:9092 <span class="comment">#指定当前主机的IP做为监听地址,注意:不支持0.0.0.0</span></span><br><span class="line">log.dirs=/usr/local/kafka/data <span class="comment">#kakfa用于保存数据的目录，所有的消息都会存储在该目录当中</span></span><br><span class="line">num.partitions=1 <span class="comment">#设置创建新的topic时默认分区数量,建议和kafka的节点数量一致</span></span><br><span class="line">default.replication.factor=3 <span class="comment">#指定默认的副本数为3，可以实现故障的自动转移</span></span><br><span class="line">log.retention.hours=168 <span class="comment">#设置kafka中消息保留时间，默认为168小时即7天</span></span><br><span class="line">zookeeper.connect=10.0.0.101:2181,10.0.0.102:2181,10.0.0.103:2181 <span class="comment">#指定连接的zk的地址,zk中存储了broker的元数据信息</span></span><br><span class="line">zookeeper.connection.timeout.ms=6000 <span class="comment">#设置连接zookeeper的超时时间，单位为ms,默认6秒钟</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#准备数据目录</span></span><br><span class="line">[root@node1 ~]<span class="comment"># mkdir /usr/local/kafka/data</span></span><br><span class="line"></span><br><span class="line">[root@node1 ~]<span class="comment"># scp /usr/local/kafka/config/server.properties 10.0.0.102:/usr/local/kafka/config</span></span><br><span class="line">[root@node1 ~]<span class="comment"># scp /usr/local/kafka/config/server.properties 10.0.0.103:/usr/local/kafka/config</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#修改第2个节点配置</span></span><br><span class="line">[root@node2 ~]<span class="comment"># vim /usr/local/kafka/config/server.properties</span></span><br><span class="line">broker.id=2 <span class="comment">#每个broker 在集群中的唯一标识，正整数。</span></span><br><span class="line">listeners=PLAINTEXT://10.0.0.102:9092 <span class="comment">#指定当前主机的IP做为监听地址,注意:不支持0.0.0.0</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#修改第3个节点配置</span></span><br><span class="line">[root@node3 ~]<span class="comment"># vim /usr/local/kafka/config/server.properties</span></span><br><span class="line">broker.id=31 <span class="comment">#每个broker 在集群中的唯一标识，正整数。</span></span><br><span class="line">listeners=PLAINTEXT://10.0.0.103:9092 <span class="comment">#指定当前主机的IP做为监听地址,注意:不支持0.0.0.0</span></span><br></pre></td></tr></table></figure>

<h4 id="启动服务"><a href="#启动服务" class="headerlink" title="启动服务"></a>启动服务</h4><p>在所有kafka节点执行下面操作</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@node1 ~]<span class="comment"># vim vim /usr/local/kafka/bin/kafka-server-start.sh</span></span><br><span class="line"><span class="keyword">if</span>[ <span class="string">&quot; x<span class="variable">$KAFKA_HEAP_OPTS</span>&quot;</span>=<span class="string">&quot;x&quot;</span>] ; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">export</span> KAFKA_HEAP_OPTS=<span class="string">&quot; -Xmx1G-Xms1G&quot;</span>  <span class="comment">#可以调整内存</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line">[root@node1 ~]<span class="comment"># kafka-server-start.sh -daemon /usr/local/kafka/config/server.properties</span></span><br></pre></td></tr></table></figure>

<h4 id="确保服务启动状态"><a href="#确保服务启动状态" class="headerlink" title="确保服务启动状态"></a>确保服务启动状态</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">[root@node1 ~]<span class="comment"># ss -ntl|grep 9092</span></span><br><span class="line">LISTEN  0        50         [::ffff:10.0.0.101]:9092                 *:* </span><br><span class="line"></span><br><span class="line">[root@node1 ~]<span class="comment"># tail /usr/local/kafka/logs/server.log</span></span><br><span class="line">[2021-02-16 12:10:01,276] INFO [ExpirationReaper-1-AlterAcls]: Starting </span><br><span class="line">(kafka.server.DelayedOperationPurgatory<span class="variable">$ExpiredOperationReaper</span>)</span><br><span class="line">[2021-02-16 12:10:01,311] INFO [/config/changes-event-process-thread]: Starting </span><br><span class="line">(kafka.common.ZkNodeChangeNotificationListener<span class="variable">$ChangeEventProcessThread</span>)</span><br><span class="line">[2021-02-16 12:10:01,332] INFO [SocketServer brokerId=1] Starting socket server </span><br><span class="line">acceptors and processors (kafka.network.SocketServer)</span><br><span class="line">[2021-02-16 12:10:01,339] INFO [SocketServer brokerId=1] Started data-plane </span><br><span class="line">acceptor and processor(s) <span class="keyword">for</span> endpoint : ListenerName(PLAINTEXT) </span><br><span class="line">(kafka.network.SocketServer)</span><br><span class="line">[2021-02-16 12:10:01,340] INFO [SocketServer brokerId=1] Started socket server </span><br><span class="line">acceptors and processors (kafka.network.SocketServer)</span><br><span class="line">[2021-02-16 12:10:01,344] INFO Kafka version: 2.7.0 </span><br><span class="line">(org.apache.kafka.common.utils.AppInfoParser)</span><br><span class="line">[2021-02-16 12:10:01,344] INFO Kafka commitId: 448719dc99a19793 </span><br><span class="line">(org.apache.kafka.common.utils.AppInfoParser)</span><br><span class="line">[2021-02-16 12:10:01,344] INFO Kafka startTimeMs: 1613448601340</span><br><span class="line">(org.apache.kafka.common.utils.AppInfoParser)</span><br><span class="line">[2021-02-16 12:10:01,346] INFO [KafkaServer <span class="built_in">id</span>=1] started </span><br><span class="line">(kafka.server.KafkaServer)</span><br><span class="line">[2021-02-16 12:10:01,391] INFO [broker-1-to-controller-send-thread]: Recorded </span><br><span class="line">new controller, from now on will use broker 1</span><br><span class="line">(kafka.server.BrokerToControllerRequestThread)</span><br><span class="line"></span><br><span class="line"><span class="comment">#如果使用id,还需要修改/usr/local/kafka/data/meta.properties</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#打开zooinspector可以看到三个id</span></span><br></pre></td></tr></table></figure>

<p><img src="../../../../images/SRE/day52/39.jpg" alt="39"></p>
<ul>
<li>Broker 依赖于 Zookeeper，每个Broker 的id 和 Topic、Partition这些元数据信息都会写入Zookeeper 的 ZNode 节点中</li>
<li>consumer 依赖于Zookeeper，Consumer 在消费消息时，每消费完一条消息，会将产生的offset保存到 Zookeeper 中，下次消费在当前offset往后继续消费.kafka0.9 之前Consumer 的offset 存储在 Zookeeper 中，kafka0.9 以后offset存储在本地。</li>
<li>Partition 依赖于 Zookeeper，Partition 完成Replication 备份后，选举出一个Leader，这个是依托于 Zookeeper 的选举机制实现的</li>
</ul>
<h4 id="准备Kafka的service文件"><a href="#准备Kafka的service文件" class="headerlink" title="准备Kafka的service文件"></a>准备Kafka的service文件</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">[root@node1 ~]<span class="comment"># cat /lib/systemd/system/kafka.service</span></span><br><span class="line">[unit]</span><br><span class="line">Description=Apache kafka</span><br><span class="line">After=network.target</span><br><span class="line"></span><br><span class="line">[service]</span><br><span class="line">Type=simple</span><br><span class="line"><span class="comment">#Environment=JAVA_HOME=/data/server/java</span></span><br><span class="line">PIDFile=/usr/local/kafka/kafka.pid</span><br><span class="line">Execstart=/usr/local/kafka/bin/kafka-server-start.sh /usr/local/kafka/config/server. properties</span><br><span class="line">Execstop=/bin/kill  -TERM <span class="variable">$&#123;MAINPID&#125;</span></span><br><span class="line">Restart=always</span><br><span class="line">RestartSec=20</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">wantedBy=multi-user.target</span><br><span class="line"></span><br><span class="line">[root@node1 ~]<span class="comment"># systemctl daemon-load</span></span><br><span class="line">[root@node1 ~]<span class="comment"># systemctl restart kafka.service</span></span><br></pre></td></tr></table></figure>

<h2 id="Kafka-读写数据"><a href="#Kafka-读写数据" class="headerlink" title="Kafka 读写数据"></a>Kafka 读写数据</h2><p>参考文档</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://kafka.apache.org/quickstart</span><br></pre></td></tr></table></figure>

<p>常见命令</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">kafka-topics.sh              <span class="comment">#消息的管理命令</span></span><br><span class="line">kafka-console-producer.sh    <span class="comment">#生产者的模拟命令</span></span><br><span class="line">kafka-console-consumer.sh    <span class="comment">#消费者的模拟命令</span></span><br></pre></td></tr></table></figure>

<h3 id="创建-Topic"><a href="#创建-Topic" class="headerlink" title="创建 Topic"></a>创建 Topic</h3><p>创建名为 wang，partitions(分区)为3，replication(每个分区的副本数/每个分区的分区因子)为 2 的 topic(主题)</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#新版命令</span></span><br><span class="line">[root@node1 ~]<span class="comment"># /usr/local/kafka/bin/kafka-topics.sh --create --topic wang --bootstrap-server 10.0.0.101:9092 --partitions 3 --replication-factor 2</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#在各节点上观察生成的相关数据</span></span><br><span class="line">[root@node1 ~]<span class="comment"># ls /usr/local/kafka/data/</span></span><br><span class="line">[root@node2 ~]<span class="comment"># ls /usr/local/kafka/data/</span></span><br><span class="line">[root@node3 ~]<span class="comment"># ls /usr/local/kafka/data/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#旧版命令</span></span><br><span class="line">[root@node1 ~]<span class="comment"># /usr/local/kafka/bin/kafka-topics.sh --create --zookeeper 10.0.0.101:2181,10.0.0.102:2181,10.0.0.103:2181 --partitions 3 --replication-factor 2 --topic wang</span></span><br><span class="line">Created topic wang.</span><br></pre></td></tr></table></figure>

<h3 id="获取所有-Topic"><a href="#获取所有-Topic" class="headerlink" title="获取所有 Topic"></a>获取所有 Topic</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#新版命令</span></span><br><span class="line">[root@node1 ~]<span class="comment"># /usr/local/kafka/bin/kafka-topics.sh --list --bootstrap-server 10.0.0.101:9092 </span></span><br><span class="line"></span><br><span class="line"><span class="comment">#旧版命令</span></span><br><span class="line">[root@node1 ~]<span class="comment"># /usr/local/kafka/bin/kafka-topics.sh --list --zookeeper 10.0.0.101:2181,10.0.0.102:2181,10.0.0.103:2181</span></span><br><span class="line">wang</span><br></pre></td></tr></table></figure>

<p><img src="../../../../images/SRE/day52/40.jpg" alt="40"></p>
<h3 id="验证-Topic-详情"><a href="#验证-Topic-详情" class="headerlink" title="验证 Topic 详情"></a>验证 Topic 详情</h3><p>状态说明：wang 有三个分区分别为0、1、2，分区0的leader是3 （broker.id），分区 0 有2 个副本，并且状态都为 lsr（ln-sync，表示可以参加选举成为 leader）。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#新版命令</span></span><br><span class="line">[root@node1 ~]<span class="comment"># /usr/local/kafka/bin/kafka-topics.sh --describe --bootstrap-server 10.0.0.101:9092 --topic wang</span></span><br><span class="line">Topic: wang TopicId: beg6bPXwToW1yp7cuv7F8w PartitionCount: 3 </span><br><span class="line">ReplicationFactor: 2 Configs: </span><br><span class="line"> Topic: wang Partition: 0 Leader: 3 Replicas: 3,1 Isr: 3,1</span><br><span class="line"> Topic: wang Partition: 1 Leader: 1 Replicas: 1,2 Isr: 1,2</span><br><span class="line"> Topic: wang Partition: 2 Leader: 2 Replicas: 2,3 Isr: 2,3</span><br><span class="line"> </span><br><span class="line"><span class="comment">#旧版命令</span></span><br><span class="line">[root@node1 ~]<span class="comment"># /usr/local/kafka/bin/kafka-topics.sh --describe --zookeeper 10.0.0.101:2181,10.0.0.102:2181,10.0.0.103:2181 --topic wang</span></span><br><span class="line">Topic: wang PartitionCount: 3 ReplicationFactor: 2 Configs: </span><br><span class="line"> Topic: wang Partition: 0 Leader: 3 Replicas: 3,2 Isr: 3,2</span><br><span class="line"> Topic: wang Partition: 1 Leader: 1 Replicas: 1,3 Isr: 1,3</span><br><span class="line"> Topic: wang Partition: 2 Leader: 2 Replicas: 2,1 Isr: 2,1</span><br></pre></td></tr></table></figure>

<h3 id="生产-Topic"><a href="#生产-Topic" class="headerlink" title="生产 Topic"></a>生产 Topic</h3><p>kafka-console-producer.sh 格式</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#发送消息命令格式:</span></span><br><span class="line">kafka-console-producer.sh --broker-list &lt;kafkaIP1&gt;:&lt;端口&gt;,&lt;kafkaIP2&gt;:&lt;端口&gt; --topic &lt;topic名称&gt;</span><br></pre></td></tr></table></figure>

<p>范例：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#交互式输入消息,按Ctrl+C退出</span></span><br><span class="line">[root@node1 ~]<span class="comment"># /usr/local/kafka/bin/kafka-console-producer.sh --broker-list 10.0.0.101:9092,10.0.0.102:9092,10.0.0.103:9092 --topic wang</span></span><br><span class="line">&gt;message1</span><br><span class="line">&gt;message2</span><br><span class="line">&gt;message3</span><br><span class="line">&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment">#或者下面方式</span></span><br><span class="line">[root@node1 ~]<span class="comment"># /usr/local/kafka/bin/kafka-console-producer.sh --topic wang --bootstrap-server 10.0.0.101:9092</span></span><br></pre></td></tr></table></figure>

<h3 id="消费-Topic"><a href="#消费-Topic" class="headerlink" title="消费 Topic"></a>消费 Topic</h3><p>kafka-console-consumer.sh 格式</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#接收消息命令格式:</span></span><br><span class="line">kafka-console-consumer.sh --bootstrap-server &lt;host&gt;:&lt;post&gt; --topic &lt;topic名称&gt; --from-beginning --consumer-property group.id=&lt;组名称&gt;</span><br></pre></td></tr></table></figure>

<p>注意：</p>
<ul>
<li>消息者先生产消息，消费都后续才启动，也能收到之前生产的消息</li>
<li>同一个消息在同一个group内的消费者只有被一个消费者消费，比如：共100条消息，在一个group内有A，B两个消费者，其中A消费50条，B消费另外的50条消息。从而实现负载均衡，不同group内的消费者则可以同时消费同一个消息</li>
</ul>
<p>范例：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#交互式持续接收消息,按Ctrl+C退出</span></span><br><span class="line">[root@node2 ~]<span class="comment"># /usr/local/kafka/bin/kafka-console-consumer.sh --topic wang --bootstrap-server 10.0.0.102:9092 --from-beginning</span></span><br><span class="line">message1</span><br><span class="line">message3</span><br><span class="line">message2</span><br><span class="line"></span><br><span class="line"><span class="comment">#支持多个生产者和消费者</span></span><br></pre></td></tr></table></figure>

<h3 id="删除-Topic"><a href="#删除-Topic" class="headerlink" title="删除 Topic"></a>删除 Topic</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#新版本</span></span><br><span class="line">[root@node3 ~]<span class="comment"># /usr/local/kafka/bin/kafka-topics.sh --delete --bootstrap-server 10.0.0.101:2181,10.0.0.102:2181,10.0.0.103:2181 --topic wang</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#旧版本</span></span><br><span class="line">[root@node3 ~]<span class="comment"># /usr/local/kafka/bin/kafka-topics.sh --delete --zookeeper 10.0.0.101:2181,10.0.0.102:2181,10.0.0.103:2181 --topic wang</span></span><br><span class="line">Topic wang is marked <span class="keyword">for</span> deletion.</span><br><span class="line">Note: This will have no impact <span class="keyword">if</span> delete.topic.enable is not <span class="built_in">set</span> to <span class="literal">true</span>.</span><br></pre></td></tr></table></figure>

<h2 id="Kafka-在-ZooKeeper-里面的存储结构"><a href="#Kafka-在-ZooKeeper-里面的存储结构" class="headerlink" title="Kafka 在 ZooKeeper 里面的存储结构"></a>Kafka 在 ZooKeeper 里面的存储结构</h2><p><img src="../../../../images/SRE/day52/41.jpg" alt="41"></p>
<p>topic 结构</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/brokers/topics/[topic]</span><br></pre></td></tr></table></figure>

<p>partition结构</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/brokers/topics/[topic]/partitions/[partitionId]/state</span><br></pre></td></tr></table></figure>

<p>broker信息</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/brokers/ids/[o...N]</span><br></pre></td></tr></table></figure>

<p>控制器</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">/controller</span><br><span class="line">存储center controller中央控制器所在kafka broker的信息</span><br></pre></td></tr></table></figure>

<p>消费者</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">消费者信息:</span><br><span class="line">/consumers/[groupId]/ids /[consumerIdstring]</span><br><span class="line">每个consumer都有一个唯一的ID,此id用来标记消费者信息</span><br><span class="line">消费者管理者:</span><br><span class="line">/consumers/[groupId]/owners/[topic]/[partitionid]</span><br></pre></td></tr></table></figure>

<h2 id="图形工具-Offset-Explorer-Kafka-Tool"><a href="#图形工具-Offset-Explorer-Kafka-Tool" class="headerlink" title="图形工具 Offset Explorer (Kafka Tool)"></a>图形工具 Offset Explorer (Kafka Tool)</h2><p><img src="../../../../images/SRE/day52/42.jpg" alt="42"></p>
<p>Offset Explorer ，旧称Kafka Tool，工具是一个 GUI 应用程序，用于管理和使用 Apache Kafka 群集。它提供了一个直观的 UI，允许人们快速查看 Kafka 群集中的对象以及存储在群集主题中的消息。它包含面向开发人员和管理员的功能。一些关键功能包括</p>
<ul>
<li>快速查看您的所有 Kafka 集群，包括其经纪人、主题和消费者</li>
<li>查看分区中邮件的内容并添加新邮件</li>
<li>查看消费者的偏移量，包括阿帕奇风暴卡夫卡喷口消费者</li>
<li>以漂亮的打印格式显示 JSON和 XML 消息</li>
<li>添加和删除主题以及其他管理功能</li>
<li>将单个邮件从分区保存到本地硬盘驱动器</li>
<li>编写自己的插件，允许您查看自定义数据格式</li>
<li>Kafka 工具在Windows、Linux 和 Mac 操作系统上运行</li>
</ul>
<p>官网:</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://www.kafkatool.com/</span><br></pre></td></tr></table></figure>

<p>下载链接: </p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://www.kafkatool.com/download.html</span><br></pre></td></tr></table></figure>

<p><img src="../../../../images/SRE/day52/43.jpg" alt="43"><br><img src="../../../../images/SRE/day52/44.jpg" alt="44"><br><img src="../../../../images/SRE/day52/45.jpg" alt="45"><br><img src="../../../../images/SRE/day52/46.jpg" alt="46"></p>
<p>修改类型</p>
<p><img src="../../../../images/SRE/day52/47.jpg" alt="47"></p>
<p>查看数据</p>
<p><img src="../../../../images/SRE/day52/48.jpg" alt="48"></p>
<h2 id="基于-Web-的-kafka-eagle"><a href="#基于-Web-的-kafka-eagle" class="headerlink" title="基于 Web 的 kafka-eagle"></a>基于 Web 的 kafka-eagle</h2><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://github.com/smartloli/kafka-eagle-bin</span><br></pre></td></tr></table></figure>

<p><img src="../../../../images/SRE/day52/49.jpg" alt="49"></p>
<h1 id="Dubbo"><a href="#Dubbo" class="headerlink" title="Dubbo"></a>Dubbo</h1><h2 id="Dubbo-介绍"><a href="#Dubbo-介绍" class="headerlink" title="Dubbo 介绍"></a>Dubbo 介绍</h2><p><img src="../../../../images/SRE/day52/50.jpg" alt="50"></p>
<p>Apache Dubbo 是一款高性能、轻量级的开源RPC服务框架</p>
<p>Apache Dubbo 提供了六大核心能力：面向接口代理的高性能RPC调用，智能容错和负载均衡，服务自动注册和发现，高度可扩展能力，运行期流量调度，可视化的服务治理与运维。</p>
<p>SpringCloud 提供了微服务的全家桶的整套解决方案,Dubbo只是实现了微服务中RPC部分的功能,基本相当于SpringCloud中的Feign,还需要组合其它服务才能实现全部功能</p>
<p>阿里云微服务</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://promotion.aliyun.com/ntms/act/edasdubbo.html</span><br></pre></td></tr></table></figure>

<p>Dubbo 官网</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://dubbo.apache.org/zh/</span><br></pre></td></tr></table></figure>

<p>Dubbo 架构</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://dubbo.apache.org/zh/docs/v2.7/user/preface/architecture/</span><br></pre></td></tr></table></figure>

<p>Dubbo 运维</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://dubbo.apache.org/zh/docs/v2.7/admin/</span><br></pre></td></tr></table></figure>

<p>Dubbo 简介</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://help.aliyun.com/document_detail/99299.html</span><br></pre></td></tr></table></figure>

<p><img src="../../../../images/SRE/day52/51.jpg" alt="51"></p>
<p><strong>节点角色说明</strong></p>
<table>
<thead>
<tr>
<th>节点</th>
<th>角色说明</th>
</tr>
</thead>
<tbody><tr>
<td>Provider</td>
<td>暴露服务的服务提供方</td>
</tr>
<tr>
<td>Consumer</td>
<td>调用远程服务的服务消费方</td>
</tr>
<tr>
<td>Registry</td>
<td>服务注册与发现的注册中心</td>
</tr>
<tr>
<td>Monitor</td>
<td>统计服务的调用次数和调用时间的监控中心</td>
</tr>
<tr>
<td>Container</td>
<td>服务运行容器</td>
</tr>
</tbody></table>
<p> <strong>调用关系说明</strong></p>
<ol>
<li>服务容器负责启动，加载，运行服务提供者。</li>
<li>服务提供者在启动时，向注册中心注册自己提供的服务。</li>
<li>服务消费者在启动时，向注册中心订阅自己所需的服务。</li>
<li>注册中心返回服务提供者地址列表给消费者，如果有变更，注册中心将基于长连接推送变更数据给消费者。</li>
<li>服务消费者，从提供者地址列表中，基于软负载均衡算法，选一台提供者进行调用，如果调用失败，再选另一台调用。</li>
<li>服务消费者和提供者，在内存中累计调用次数和调用时间，定时每分钟发送一次统计数据到监控中心。</li>
</ol>
<p><img src="../../../../images/SRE/day52/52.jpg" alt="52"><br><img src="../../../../images/SRE/day52/53.jpg" alt="53"><br><img src="../../../../images/SRE/day52/54.jpg" alt="54"></p>
<table>
<thead>
<tr>
<th>中心类型</th>
<th>开源组件</th>
<th>EDAS(Enterprise Distributed Application Service)组件</th>
<th>托管说明</th>
</tr>
</thead>
<tbody><tr>
<td>注册中心</td>
<td>Nacos（推荐）、<br /> ZooKeeper（推荐）、 <br />etcd、Consul、Eureka</td>
<td>Nacos（推荐）、EDAS注册中心</td>
<td>只需将应用部署到 EDAS中，即可默认接入注册中心</td>
</tr>
<tr>
<td>配置中心</td>
<td>Nacos（推荐）、 <br />ZooKeeper（推荐）、 <br />Apollo</td>
<td>Nacos（推荐）</td>
<td>只需将应用部署到EDAS中，即可默认接入配置中心</td>
</tr>
<tr>
<td>元数据中心</td>
<td>Nacos（推荐）、<br />Redis（推 荐）、<br />ZooKeeper</td>
<td>Nacos（推荐）</td>
<td>您只需将应用部署到EDAS中，即可默认接入元数据中心。</td>
</tr>
</tbody></table>
<p>Dubbo服务框架的工作流程如下：</p>
<ol>
<li>提供者在启动时，在注册中心注册服务。</li>
<li>消费者在启动时，在注册中心订阅所需的服务。</li>
<li>注册中心返回提供者地址列表给消费者。如果提供者发生变更，注册中心将推送变更数据给消费者。</li>
<li>消费者基于软负载均衡算法，从提供者地址列表中选一个提供者进行调用。</li>
</ol>
<p>Nacos 介绍</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Nacos 致力于帮助您发现、配置和管理微服务。Nacos 提供了一组简单易用的特性集，帮助您快速实现动态</span><br><span class="line">服务发现、服务配置、服务元数据及流量管理。</span><br><span class="line">Nacos 帮助您更敏捷和容易地构建、交付和管理微服务平台。 Nacos 是构建以“服务”为中心的现代应用架</span><br><span class="line">构 (例如微服务范式、云原生范式) 的服务基础设施。</span><br></pre></td></tr></table></figure>

<p>Nacos 官网</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://nacos.io/zh-cn/</span><br></pre></td></tr></table></figure>

<h2 id="实战案例：实现-Dubbo-架构"><a href="#实战案例：实现-Dubbo-架构" class="headerlink" title="实战案例：实现 Dubbo 架构"></a>实战案例：实现 Dubbo 架构</h2><p><img src="../../../../images/SRE/day52/55.jpg" alt="55"></p>
<p>环境说明</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#准备三台zookeeper集群</span></span><br><span class="line"><span class="comment">#10.0.0.101 node1</span></span><br><span class="line"><span class="comment">#10.0.0.102 node2</span></span><br><span class="line"><span class="comment">#10.0.0.103 node3</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#准备两台主机充当provider</span></span><br><span class="line"><span class="comment">#10.0.0.104 provider1</span></span><br><span class="line"><span class="comment">#10.0.0.105 provider2</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#准备两台主机充当consumer</span></span><br><span class="line"><span class="comment">#10.0.0.106 consumer1</span></span><br><span class="line"><span class="comment">#10.0.0.107 consumer2</span></span><br></pre></td></tr></table></figure>

<p>官方 Demo</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://github.com/apache/dubbo/tree/master/dubbo-demo</span><br></pre></td></tr></table></figure>

<h3 id="准备-ZooKeeper-提供注册中心"><a href="#准备-ZooKeeper-提供注册中心" class="headerlink" title="准备 ZooKeeper 提供注册中心"></a>准备 ZooKeeper 提供注册中心</h3><p>基于 ZooKeeper 发现并管理 provider 和consumer准备环境</p>
<p>官方说明: <a target="_blank" rel="noopener" href="https://dubbo.apache.org/zh/docs/references/registry/zookeeper/">https://dubbo.apache.org/zh/docs/references/registry/zookeeper/</a> </p>
<p>Zookeeper 是 Apache Hadoop 的子项目，是一个树型的目录服务，支持变更推送，适合作为 Dubbo 服务的注册中心，工业强度较高，可用于生产环境，并推荐使用</p>
<p><img src="../../../../images/SRE/day52/56.jpg" alt="56"></p>
<p>流程说明：</p>
<ul>
<li>服务提供者启动时: 向 /dubbo/com.foo.BarService/providers 目录下写入自己的 URL 地址</li>
<li>服务消费者启动时: 订阅 /dubbo/com.foo.BarService/providers 目录下的提供者 URL 地址。并向 /dubbo/com.foo.BarService/consumers 目录下写入自己的 URL 地址</li>
<li>监控中心启动时: 订阅 /dubbo/com.foo.BarService 目录下的所有提供者和消费者 URL 地址。</li>
</ul>
<p>支持以下功能：</p>
<ul>
<li>当提供者出现断电等异常停机时，注册中心能自动删除提供者信息</li>
<li>当注册中心重启时，能自动恢复注册数据，以及订阅请求</li>
<li>当会话过期时，能自动恢复注册数据，以及订阅请求</li>
<li>当设置<code>&lt;dubbo:registry check=&quot;false&quot; /&gt;</code>时，记录失败注册和订阅请求，后台定时重试</li>
<li>可通过 <code>&lt;dubbo:registry username=&quot;admin&quot; password=&quot;1234&quot; /&gt;</code> 设置 zookeeper 登录信息</li>
<li>可通过 <code>&lt;dubbo:registry group=&quot;dubbo&quot; /&gt;</code> 设置 zookeeper 的根节点，不配置将使用默认的根节点。</li>
<li>支持 * 号通配符 <code>&lt;dubbo:reference group=&quot;*&quot; version=&quot;*&quot; /&gt;</code> ，可订阅服务的所有分组和 所有版本的提供者</li>
</ul>
<p>ZooKeeper 配置说明</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://dubbo.apache.org/zh/docs/v2.7/user/references/registry/zookeeper/</span><br></pre></td></tr></table></figure>

<p><strong>ZooKeeper 环境准备</strong></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#准备三台 ZooKeeper 集群</span></span><br><span class="line"><span class="comment">#10.0.0.101 node1</span></span><br><span class="line"><span class="comment">#10.0.0.102 node2</span></span><br><span class="line"><span class="comment">#10.0.0.103 node3</span></span><br><span class="line"></span><br><span class="line">[root@node1 ~]<span class="comment"># zkServer.sh status</span></span><br><span class="line">/usr/bin/java</span><br><span class="line">ZooKeeper JMX enabled by default</span><br><span class="line">Using config: /usr/local/zookeeper/bin/../conf/zoo.cfg</span><br><span class="line">Client port found: 2181. Client address: localhost. Client SSL: <span class="literal">false</span>.</span><br><span class="line">Mode: follower</span><br><span class="line"></span><br><span class="line">[root@node2 ~]<span class="comment"># zkServer.sh status</span></span><br><span class="line">/usr/bin/java</span><br><span class="line">ZooKeeper JMX enabled by default</span><br><span class="line">Using config: /usr/local/zookeeper/bin/../conf/zoo.cfg</span><br><span class="line">Client port found: 2181. Client address: localhost. Client SSL: <span class="literal">false</span>.</span><br><span class="line">Mode: leader</span><br><span class="line"></span><br><span class="line">[root@node3 ~]<span class="comment"># zkServer.sh status</span></span><br><span class="line">/usr/bin/java</span><br><span class="line">ZooKeeper JMX enabled by default</span><br><span class="line">Using config: /usr/local/zookeeper/bin/../conf/zoo.cfg</span><br><span class="line">Client port found: 2181. Client address: localhost. Client SSL: <span class="literal">false</span>.</span><br><span class="line">Mode: follower</span><br></pre></td></tr></table></figure>

<h3 id="生产者示例"><a href="#生产者示例" class="headerlink" title="生产者示例"></a>生产者示例</h3><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">https://github.com/apache/dubbo/tree/dubbo-2.1.5</span><br><span class="line">https://github.com/apache/dubbo/tree/dubbo-2.1.5/dubbo-demo-provider</span><br></pre></td></tr></table></figure>

<p>在10.0.0.104 和 10.0.0.105 主机在启动 provider</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#Ubuntu系统</span></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment"># apt -y install openjdk-8-jdk net-tools</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#红帽系统</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># yum -y install java-1.8.0-openjdk-devel nc</span></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment"># tar xf dubbo-demo-provider-2.1.5-assembly.tar.gz -C /usr/local/</span></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment"># ln -s /usr/local/dubbo-demo-provider-2.1.5/ /usr/local/dubbo-demo-provider</span></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment"># vim /usr/local/dubbo-demo-provider/conf/dubbo.properties</span></span><br><span class="line"><span class="comment">#dubbo.registry.address=multicast://224.5.6.7:1234 #注释此行,不使用默认的组播注册中心,添加下面行使用zk做为注册中心</span></span><br><span class="line">dubbo.registry.address=zookeeper://10.0.0.101:2181 | zookeeper://10.0.0.102:2181 | zookeeper://10.0.0.103:2181   <span class="comment">#修改此行, zk集群配置</span></span><br><span class="line"><span class="comment">#dubbo.registry.address=zookeeper://10.0.0.101:2181 #单zk节点使用此配置</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#启动provider</span></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment"># /usr/local/dubbo-demo-provider/bin/start.sh </span></span><br><span class="line">Starting the demo-provider ....</span><br><span class="line">OK!</span><br><span class="line">PID: 20846</span><br><span class="line">STDOUT: logs/stdout.log</span><br><span class="line"></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment"># cat /usr/local/dubbo-demo-provider/logs/stdout.log </span></span><br><span class="line">OpenJDK 64-Bit Server VM warning: ignoring option PermSize=128m; support was </span><br><span class="line">removed <span class="keyword">in</span> 8.0</span><br><span class="line">log4j:WARN No appenders could be found <span class="keyword">for</span> logger </span><br><span class="line">(com.alibaba.dubbo.common.logger.LoggerFactory).</span><br><span class="line">log4j:WARN Please initialize the log4j system properly.</span><br><span class="line">log4j:WARN See http://logging.apache.org/log4j/1.2/faq.html<span class="comment">#noconfig for more info.</span></span><br><span class="line">[2021-02-17 21:10:55] Dubbo service server started!</span><br><span class="line"></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment"># ss -ntlp|grep java</span></span><br><span class="line">LISTEN   0   50     0.0.0.0:20880    0.0.0.0:* <span class="built_in">users</span>:((&quot;java&quot;,pid=<span class="number">20846</span>,fd=<span class="number">51</span>))</span><br><span class="line"></span><br><span class="line"><span class="comment">#当消费者主机启动后,可以观察到下面日志</span></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment"># tail -f /usr/local/dubbo-demo-provider/logs/*</span></span><br><span class="line">==&gt; /usr/local/dubbo-demo-provider/logs/stdout.log &lt;==</span><br><span class="line">[16:49:58] Hello world150, request from consumer: /10.0.0.107:48872</span><br><span class="line">[16:49:58] Hello world180, request from consumer: /10.0.0.106:53872</span><br><span class="line">[16:50:02] Hello world152, request from consumer: /10.0.0.107:48872</span><br><span class="line">[16:50:02] Hello world182, request from consumer: /10.0.0.106:53872</span><br><span class="line">[16:50:06] Hello world154, request from consumer: /10.0.0.107:48872</span><br><span class="line"><span class="comment">#使用zk工具查看注册信息</span></span><br></pre></td></tr></table></figure>

<p><img src="../../../../images/SRE/day52/57.jpg" alt="57"></p>
<h3 id="消费者示例"><a href="#消费者示例" class="headerlink" title="消费者示例"></a>消费者示例</h3><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">https://github.com/apache/dubbo/tree/dubbo-2.1.5</span><br><span class="line">https://github.com/apache/dubbo/tree/dubbo-2.1.5/dubbo-demo-consumer</span><br></pre></td></tr></table></figure>

<p>在 10.0.0.106 和 10.0.0.107 主机在启动 consumer</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">[root@ubuntu1804 ~]<span class="comment"># apt -y install openjdk-8-jdk</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># yum -y install java-1.8.0-openjdk nc</span></span><br><span class="line"></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment"># tar xf dubbo-demo-consumer-2.1.5-assembly.tar.gz -C /usr/local/</span></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment"># ln -s /usr/local/dubbo-demo-consumer-2.1.5/ /usr/local/dubbo-demo-consumer</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#和provider一样的zk配置信息</span></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment"># vim /usr/local/dubbo-demo-consumer/conf/dubbo.properties </span></span><br><span class="line"><span class="comment">#dubbo.registry.address=multicast://224.5.6.7:1234 #注释此行,不使用默认的组播注册中心,添加下面行使用zk做为注册中心</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#修改下面行指定zk集群配置</span></span><br><span class="line">dubbo.registry.address=zookeeper://10.0.0.101:2181 | zookeeper://10.0.0.102:2181 | zookeeper://10.0.0.103:2181</span><br><span class="line"></span><br><span class="line"><span class="comment">#启动consumer</span></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment"># /usr/local/dubbo-demo-consumer/bin/start.sh </span></span><br><span class="line">Starting the demo-consumer ....OK!</span><br><span class="line">PID: 20804</span><br><span class="line">STDOUT: logs/stdout.log</span><br><span class="line"></span><br><span class="line"><span class="comment">#注意: 如果有多个生产者.则消费会轮询多个消费都进行服务</span></span><br><span class="line"><span class="comment">#观察消费者consumer日志</span></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment"># tail -f /usr/local/dubbo-demo-consumer/logs/stdout.log</span></span><br><span class="line">==&gt; /usr/local/dubbo-demo-consumer/logs/stdout.log &lt;==</span><br><span class="line">[16:50:58] Hello world210, response form provider: 10.0.0.104:20880</span><br><span class="line">[16:51:00] Hello world211, response form provider: 10.0.0.105:20880</span><br><span class="line">[16:51:02] Hello world212, response form provider: 10.0.0.104:20880</span><br><span class="line">[16:51:04] Hello world213, response form provider: 10.0.0.105:20880</span><br><span class="line">[16:51:06] Hello world214, response form provider: 10.0.0.104:20880</span><br><span class="line"></span><br><span class="line"><span class="comment">#观察生产者provider日志</span></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment"># tail -f /usr/local/dubbo-demo-provider/logs/stdout.log</span></span><br><span class="line">OpenJDK 64-Bit Server VM warning: ignoring option PermSize=128m; support was </span><br><span class="line">removed <span class="keyword">in</span> 8.0</span><br><span class="line">log4j:WARN No appenders could be found <span class="keyword">for</span> logger </span><br><span class="line">(com.alibaba.dubbo.common.logger.LoggerFactory).</span><br><span class="line">log4j:WARN Please initialize the log4j system properly.</span><br><span class="line">log4j:WARN See http://logging.apache.org/log4j/1.2/faq.html<span class="comment">#noconfig for more info.</span></span><br><span class="line">[2021-02-17 21:10:55] Dubbo service server started!</span><br><span class="line">[16:51:58] Hello world210, request from consumer: /10.0.0.107:48872</span><br><span class="line">[16:51:59] Hello world240, request from consumer: /10.0.0.106:53872</span><br><span class="line">[16:52:02] Hello world212, request from consumer: /10.0.0.107:48872</span><br><span class="line">[16:52:03] Hello world242, request from consumer: /10.0.0.106:53872</span><br><span class="line">[16:52:06] Hello world214, request from consumer: /10.0.0.107:48872</span><br><span class="line">[16:52:07] Hello world244, request from consumer: /10.0.0.106:53872</span><br></pre></td></tr></table></figure>

<h2 id="实战案例：编译安装-Dubbo的-Web-管理-Dubbo-Admin（新版）"><a href="#实战案例：编译安装-Dubbo的-Web-管理-Dubbo-Admin（新版）" class="headerlink" title="实战案例：编译安装 Dubbo的 Web 管理 Dubbo Admin（新版）"></a>实战案例：编译安装 Dubbo的 Web 管理 Dubbo Admin（新版）</h2><p>官方说明</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://github.com/apache/dubbo-admin</span><br></pre></td></tr></table></figure>

<p><img src="../../../../images/SRE/day52/58.jpg" alt="58"></p>
<p>注意: 内存建议4G以上</p>
<h3 id="编译-dubbo-admin"><a href="#编译-dubbo-admin" class="headerlink" title="编译 dubbo admin"></a>编译 dubbo admin</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">[root@ubuntu1804 ~]<span class="comment"># cd /usr/local/src/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#git方式下载,此方法很慢</span></span><br><span class="line">[root@ubuntu1804 src]<span class="comment"># git clone https://github.com/apache/dubbo-admin.git</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#直接下载zip文件,再解压缩</span></span><br><span class="line">[root@ubuntu1804 src]<span class="comment"># ll dubbo-admin-develop.zip -h</span></span><br><span class="line">-rw-r--r-- 1 root root 1.2M Feb 18 16:08 dubbo-admin-develop.zip</span><br><span class="line"></span><br><span class="line">[root@ubuntu1804 src]<span class="comment"># unzip dubbo-admin-develop.zip</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#进入到源码目录</span></span><br><span class="line">[root@ubuntu1804 src]<span class="comment"># cd dubbo-admin-develop/</span></span><br><span class="line">[root@ubuntu1804 dubbo-admin-develop]<span class="comment"># pwd</span></span><br><span class="line">/usr/local/src/dubbo-admin-develop</span><br><span class="line"></span><br><span class="line">[root@ubuntu1804 dubbo-admin-develop]<span class="comment"># ls</span></span><br><span class="line">codestyle   doc     dubbo-admin-distribution dubbo-admin-test LICENSE mvnw.cmd </span><br><span class="line">pom.xml   README_ZH.md</span><br><span class="line">DISCLAIMER docker dubbo-admin-server       dubbo-admin-ui   mvnw     NOTICE   </span><br><span class="line">README.md</span><br><span class="line"></span><br><span class="line"><span class="comment">#修改zookeeper 地址为实际IP</span></span><br><span class="line">[root@ubuntu1804 dubbo-admin-develop]<span class="comment"># vim dubbo-admin-server/src/main/resources/application.properties</span></span><br><span class="line">admin.registry.address=zookeeper://10.0.0.101:2181,10.0.0.102:2181,10.0.0.103:2181</span><br><span class="line">admin.config-center=zookeeper://10.0.0.101:2181,10.0.0.102:2181,10.0.0.103:2181</span><br><span class="line">admin.metadata-report.address=zookeeper://10.0.0.101:2181,10.0.0.102:2181,10.0.0.103:2181</span><br><span class="line"></span><br><span class="line"><span class="comment">#优化maven配置</span></span><br><span class="line">[root@ubuntu1804 dubbo-admin-develop]<span class="comment"># echo &#x27;export MAVEN_OPTS=&quot;-Xmx2g -Xms2g&quot;&#x27; &gt;&gt; /etc/profile.d/maven.sh</span></span><br><span class="line">[root@ubuntu1804 dubbo-admin-develop]<span class="comment"># source /etc/profile.d/maven.sh</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#因为此项目中使用了nodejs,建议用下面方式加速</span></span><br><span class="line">[root@ubuntu1804 dubbo-admin-develop]<span class="comment"># apt -y install npm</span></span><br><span class="line">[root@ubuntu1804 dubbo-admin-develop]<span class="comment"># npm config get registry  </span></span><br><span class="line">https://registry.npmjs.org/</span><br><span class="line"></span><br><span class="line">[root@ubuntu1804 dubbo-admin-develop]<span class="comment"># npm config set registry https://registry.npm.taobao.org</span></span><br><span class="line">[root@ubuntu1804 dubbo-admin-develop]<span class="comment"># npm config get registry</span></span><br><span class="line">https://registry.npm.taobao.org/</span><br><span class="line"></span><br><span class="line"><span class="comment">#编译方法1:执行java编译</span></span><br><span class="line"></span><br><span class="line">[root@ubuntu1804 dubbo-admin-develop]<span class="comment"># mvn clean package </span></span><br><span class="line"></span><br><span class="line"><span class="comment">#编译方法2:执行java源码编译并跳过测试单元,推荐此方式</span></span><br><span class="line">[root@ubuntu1804 dubbo-admin-develop]<span class="comment"># mvn clean install package -Dmaven.test.skip=true </span></span><br></pre></td></tr></table></figure>

<p><img src="../../../../images/SRE/day52/59.jpg" alt="59"></p>
<p>如果报错：</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[ERROR] Killed</span><br><span class="line">[ERROR] npm ERR! code ELIFECYCLE</span><br><span class="line">[ERROR] npm ERR! errno 137</span><br><span class="line">[ERROR] npm ERR! [dubbo-admin-ui@1.0.0](mailto:dubbo-admin-ui@1.0.0) build:`node </span><br><span class="line">build/build.js` </span><br><span class="line">[ERROR] npm ERR! Exit status 137</span><br><span class="line">[ERROR] npm ERR!</span><br><span class="line">[ERROR] npm ERR! Failed at the [dubbo-admin-ui@1.0.0](mailto:dubbo-admin-ui@1.0.0) build script.</span><br></pre></td></tr></table></figure>

<p>解决办法：</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">服务器增加内存(推荐 4G 或以上)，避免被内核OOM</span><br></pre></td></tr></table></figure>

<h3 id="编译完成"><a href="#编译完成" class="headerlink" title="编译完成"></a>编译完成</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[INFO] --- maven-site-plugin:3.7:attach-descriptor (attach-descriptor) @ dubbo-admin-test ---</span><br><span class="line">[INFO] Skipping because packaging <span class="string">&#x27;jar&#x27;</span> is not pom.</span><br><span class="line">[INFO] ------------------------------------------------------------------------</span><br><span class="line">[INFO] Reactor Summary <span class="keyword">for</span> dubbo-admin 0.3.0-SNAPSHOT:</span><br><span class="line">[INFO] </span><br><span class="line">[INFO] dubbo-admin ........................................ SUCCESS [  2.800 s]</span><br><span class="line">[INFO] dubbo-admin-ui ..................................... SUCCESS [01:43 min]</span><br><span class="line">[INFO] dubbo-admin-server ................................. SUCCESS [01:13 min]</span><br><span class="line">[INFO] dubbo-admin-distribution ........................... SUCCESS [  1.330 s]</span><br><span class="line">[INFO] dubbo-admin-test ................................... SUCCESS [ 27.633 s]</span><br><span class="line">[INFO] ------------------------------------------------------------------------</span><br><span class="line">[INFO] BUILD SUCCESS</span><br><span class="line">[INFO] ------------------------------------------------------------------------</span><br><span class="line">[INFO] Total time:  03:28 min</span><br><span class="line">[INFO] Finished at: 2021-02-18T18:29:56+08:00</span><br><span class="line">[INFO] ------------------------------------------------------------------------</span><br></pre></td></tr></table></figure>

<p><img src="../../../../images/SRE/day52/60.jpg" alt="60"></p>
<h3 id="启动服务-1"><a href="#启动服务-1" class="headerlink" title="启动服务"></a>启动服务</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#确保zookeeper已启动</span></span><br><span class="line">[root@node1 ~]<span class="comment"># zkServer.sh status</span></span><br><span class="line">/usr/bin/java</span><br><span class="line">ZooKeeper JMX enabled by default</span><br><span class="line">Using config: /usr/local/zookeeper/bin/../conf/zoo.cfg</span><br><span class="line">Client port found: 2181. Client address: localhost. Client SSL: <span class="literal">false</span>.</span><br><span class="line">Mode: follower</span><br><span class="line"></span><br><span class="line"><span class="comment">#启动dubbo admin方法1</span></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment"># cd /usr/local/src/dubbo-admin-develop;mvn --projects dubbo-admin-server spring-boot:run</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#启动dubbo admin方法2</span></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment"># java -jar /usr/local/src/dubbo-admin-develop/dubbo-admin-distribution/target/dubbo-admin-0.3.0-SNAPSHOT.jar</span></span><br><span class="line">--server.port=8888</span><br></pre></td></tr></table></figure>

<p><img src="../../../../images/SRE/day52/61.jpg" alt="61"></p>
<h3 id="登录-Web-界面验证"><a href="#登录-Web-界面验证" class="headerlink" title="登录 Web 界面验证"></a>登录 Web 界面验证</h3><p>浏览器访问下面地址,用登录名和密码为root登录</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://dubbo-admin主机:8080/</span><br></pre></td></tr></table></figure>

<p><img src="../../../../images/SRE/day52/62.jpg" alt="62"><br><img src="../../../../images/SRE/day52/63.jpg" alt="63"></p>
<h2 id="实战案例：编译安装-Dubbo的-Web-管理-dubbo-admin（旧版）"><a href="#实战案例：编译安装-Dubbo的-Web-管理-dubbo-admin（旧版）" class="headerlink" title="实战案例：编译安装 Dubbo的 Web 管理 dubbo admin（旧版）"></a>实战案例：编译安装 Dubbo的 Web 管理 dubbo admin（旧版）</h2><p>Dubbo 提供了 Web 管理管理界面</p>
<p>说明文档:</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://github.com/apache/dubbo-admin/blob/develop/README_ZH.md</span><br></pre></td></tr></table></figure>

<p><img src="../../../../images/SRE/day52/64.jpg" alt="64"></p>
<p>下载 dubbo-admin 链接如下</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">https://github.com/apache/dubbo-admin</span><br><span class="line">https://github.com/apache/dubbo/tree/dubbo-2.6.0</span><br><span class="line">#注意：dubbo-2.6.1以后的版本不再集成dubbo-admin,成为独立的项目dubbo-admin</span><br></pre></td></tr></table></figure>

<h3 id="下载-dubbo-admin-的-Web-管理源码"><a href="#下载-dubbo-admin-的-Web-管理源码" class="headerlink" title="下载 dubbo-admin 的 Web 管理源码"></a>下载 dubbo-admin 的 Web 管理源码</h3><p><img src="../../../../images/SRE/day52/65.jpg" alt="65"></p>
<h3 id="编译-Dubbo-Admin-生成-war-包文件"><a href="#编译-Dubbo-Admin-生成-war-包文件" class="headerlink" title="编译 Dubbo Admin 生成 war 包文件"></a>编译 Dubbo Admin 生成 war 包文件</h3><p>在10.0.0.104主机上编译dubbo admin的java源码</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#在10.0.0.104事先已安装JDK</span></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment"># apt -y install maven</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#镜像加速</span></span><br><span class="line">root@ubuntu1804 ~]<span class="comment"># vim /etc/maven/settings.xml</span></span><br><span class="line">&lt;mirrors&gt;   </span><br><span class="line">   &lt;!--阿里云镜像--&gt;</span><br><span class="line">   &lt;mirror&gt;</span><br><span class="line">   &lt;<span class="built_in">id</span>&gt;nexus-aliyun&lt;/id&gt;</span><br><span class="line">     &lt;mirrorOf&gt;*&lt;/mirrorOf&gt;</span><br><span class="line">       &lt;name&gt;Nexus aliyun&lt;/name&gt;</span><br><span class="line">       &lt;url&gt;http://maven.aliyun.com/nexus/content/groups/public&lt;/url&gt;</span><br><span class="line">   &lt;/mirror&gt;</span><br><span class="line"> &lt;/mirrors&gt;</span><br><span class="line"> </span><br><span class="line"><span class="comment">#新版</span></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment"># git clone https://github.com/apache/dubbo-admin.git</span></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment"># cd dubbo-admin/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#旧版</span></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment"># ll -h dubbo-dubbo-2.6.0.zip </span></span><br><span class="line">-rw-r--r-- 1 root root 3.3M Feb 17 22:32 dubbo-dubbo-2.6.0.zip</span><br><span class="line"></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment"># unzip dubbo-dubbo-2.6.0.zip -d /usr/local/</span></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment"># cd /usr/local/dubbo-dubbo-2.6.0/dubbo-admin/</span></span><br><span class="line">[root@ubuntu1804 dubbo-admin]<span class="comment"># du -sh .</span></span><br><span class="line">2.9M .</span><br><span class="line">[root@ubuntu1804 dubbo-admin]<span class="comment"># ls</span></span><br><span class="line">pom.xml src</span><br><span class="line"></span><br><span class="line"><span class="comment">#编译</span></span><br><span class="line">[root@ubuntu1804 dubbo-admin]<span class="comment"># mvn package -Dmaven.skip.test=true</span></span><br><span class="line">.......</span><br><span class="line">[INFO] Packaging webapp</span><br><span class="line">[INFO] Assembling webapp [dubbo-admin] <span class="keyword">in</span> [/usr/local/dubbo-dubbo-2.6.0/dubbo-admin/target/dubbo-admin-2.6.0]</span><br><span class="line">[INFO] Processing war project</span><br><span class="line">[INFO] Copying webapp resources [/usr/local/dubbo-dubbo-2.6.0/dubbo-admin/src/main/webapp]</span><br><span class="line">[INFO] Webapp assembled <span class="keyword">in</span> [180 msecs]</span><br><span class="line">[INFO] Building war: /usr/local/dubbo-dubbo-2.6.0/dubbo-admin/target/dubbo-admin-2.6.0.war</span><br><span class="line">[INFO] WEB-INF/web.xml already added, skipping</span><br><span class="line">[INFO] ------------------------------------------------------------------------</span><br><span class="line">[INFO] BUILD SUCCESS</span><br><span class="line">[INFO] ------------------------------------------------------------------------</span><br><span class="line">[INFO] Total time:  01:08 min</span><br><span class="line">[INFO] Finished at: 2021-02-17T23:21:23+08:00</span><br><span class="line">[INFO] ------------------------------------------------------------------------</span><br><span class="line"></span><br><span class="line">[root@ubuntu1804 dubbo-admin]<span class="comment"># du -sh .</span></span><br><span class="line">72M .</span><br><span class="line"></span><br><span class="line">[root@ubuntu1804 dubbo-admin]<span class="comment"># ls</span></span><br><span class="line">pom.xml src target</span><br><span class="line"></span><br><span class="line">[root@ubuntu1804 dubbo-admin]<span class="comment"># ls target/</span></span><br><span class="line">classes dubbo-admin-2.6.0 dubbo-admin-2.6.0.war generated-sources generated-test-sources maven-archiver maven-status surefire-reports test-classes</span><br><span class="line"></span><br><span class="line">[root@ubuntu1804 dubbo-admin]<span class="comment"># cp target/dubbo-admin-2.6.0.war /root/</span></span><br></pre></td></tr></table></figure>

<p><img src="../../../../images/SRE/day52/66.jpg" alt="66"></p>
<h3 id="在-Tomcat-中部署-Dubbo-Admin"><a href="#在-Tomcat-中部署-Dubbo-Admin" class="headerlink" title="在 Tomcat 中部署 Dubbo Admin"></a>在 Tomcat 中部署 Dubbo Admin</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">[root@ubuntu1804 ~]<span class="comment"># ll apache-tomcat-8.5.61.tar.gz dubbo-admin-2.6.0.war </span></span><br><span class="line">-rw-r--r-- 1 root root 10492067 Jan  3 17:47 apache-tomcat-8.5.61.tar.gz</span><br><span class="line">-rw-r--r-- 1 root root 32099502 Feb 17 23:25 dubbo-admin-2.6.0.war</span><br><span class="line"></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment"># tar xvf apache-tomcat-8.5.61.tar.gz -C /usr/local/</span></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment"># ln -s /usr/local/apache-tomcat-8.5.61/ /usr/local/tomcat</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#将war包文件解包到tomcat目录下</span></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment"># unzip dubbo-admin-2.6.0.war -d /usr/local/tomcat/webapps/dubbo-admin</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#或者直接复制前面编译完的目录</span></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment"># cp -r /usr/local/dubbo-dubbo-2.6.0/dubbo-admin/target/dubbo-admin-2.6.0/ /usr/local/tomcat/dubbo-admin</span></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment"># vim /usr/local/tomcat/webapps/dubbo-admin/WEB-INF/dubbo.properties </span></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment"># cat /usr/local/tomcat/webapps/dubbo-admin/WEB-INF/dubbo.properties</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#修改下面一行指定zk地址</span></span><br><span class="line">dubbo.registry.address=zookeeper://10.0.0.101:2181 | zookeeper://10.0.0.102:2181 | zookeeper://10.0.0.103:2181</span><br><span class="line">dubbo.admin.root.password=root   <span class="comment">#可保留默认密码</span></span><br><span class="line">dubbo.admin.guest.password=guest <span class="comment">#可保留默认密码</span></span><br><span class="line"></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment"># /usr/local/tomcat/bin/startup.sh </span></span><br><span class="line">Using CATALINA_BASE:   /usr/local/tomcat</span><br><span class="line">Using CATALINA_HOME:   /usr/local/tomcat</span><br><span class="line">Using CATALINA_TMPDIR: /usr/local/tomcat/temp</span><br><span class="line">Using JRE_HOME:        /usr</span><br><span class="line">Using CLASSPATH:       </span><br><span class="line">/usr/local/tomcat/bin/bootstrap.jar:/usr/local/tomcat/bin/tomcat-juli.jar</span><br><span class="line">Using CATALINA_OPTS:   </span><br><span class="line">Tomcat started.</span><br></pre></td></tr></table></figure>

<h3 id="验证登录-Dubbo-的-Web-管理页面"><a href="#验证登录-Dubbo-的-Web-管理页面" class="headerlink" title="验证登录 Dubbo 的 Web 管理页面"></a>验证登录 Dubbo 的 Web 管理页面</h3><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">#打开浏览器访问登录下面地址, 使用用户名/密码:root/root登录,也可以用用户名/密码: guest/guest 登录</span><br><span class="line">http://dubboadmin主机:8080/dubbo-admin/ </span><br></pre></td></tr></table></figure>

<p><img src="../../../../images/SRE/day52/67.jpg" alt="67"><br><img src="../../../../images/SRE/day52/68.jpg" alt="68"><br><img src="../../../../images/SRE/day52/69.jpg" alt="69"><br><img src="../../../../images/SRE/day52/70.jpg" alt="70"><br><img src="../../../../images/SRE/day52/71.jpg" alt="71"></p>
<h2 id="实战案例：Dubbo-微服务"><a href="#实战案例：Dubbo-微服务" class="headerlink" title="实战案例：Dubbo 微服务"></a>实战案例：Dubbo 微服务</h2><h3 id="环境准备-1"><a href="#环境准备-1" class="headerlink" title="环境准备"></a>环境准备</h3><p>准备三台主机，分别主机名为zookeeper,provider,consumer</p>
<p><strong>Provider 主机名解析问题</strong></p>
<p>默认provider会利用DNS解析自已的主机名为IP，导致provider地址错误，可以想方法让DNS无法解析本机主机名或者为本机IP解决此问题，可以如下方法解决</p>
<ul>
<li>将provider主机名修改为localhost.localdomain或都任意无法解析的主机名，确保本机主机名无法解析</li>
<li>修改provider主机的/etc/hosts文件，加 主机名，确保本机主机名正确解析为本机IP</li>
<li>修改网卡配置文件/etc/netplan/01-netcfg.yaml，删除此行search: [wang.org, wang.com]，确保本机主机名无法解析</li>
</ul>
<p><strong>Provider和Consumer主机解析 Zookeeper 地址</strong></p>
<p>在Provider和Consumer主机上都修改 Provider主机的 /etc/hosts 加一行</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;zookeeper服务器地址&gt; zk1.wang.org zk1.wang.org zk1.wang.org</span><br></pre></td></tr></table></figure>

<h3 id="在-Zookeeper-主机安装-Zookeeper"><a href="#在-Zookeeper-主机安装-Zookeeper" class="headerlink" title="在 Zookeeper 主机安装 Zookeeper"></a>在 Zookeeper 主机安装 Zookeeper</h3><p>略</p>
<h3 id="在Provider和Consumer安装-maven-并镜像加速"><a href="#在Provider和Consumer安装-maven-并镜像加速" class="headerlink" title="在Provider和Consumer安装 maven 并镜像加速"></a>在Provider和Consumer安装 maven 并镜像加速</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[root@ubuntu2004 ~]<span class="comment"># apt update;apt -y install maven</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#镜像加速</span></span><br><span class="line">[root@ubuntu2004 ~]<span class="comment"># vim /etc/maven/settings.xml</span></span><br><span class="line"> &lt;mirrors&gt;</span><br><span class="line">   &lt;!--阿里云镜像--&gt;</span><br><span class="line">   &lt;mirror&gt;</span><br><span class="line">       &lt;<span class="built_in">id</span>&gt;nexus-aliyun&lt;/id&gt;</span><br><span class="line">       &lt;mirrorOf&gt;*&lt;/mirrorOf&gt;</span><br><span class="line">       &lt;name&gt;Nexus aliyun&lt;/name&gt;</span><br><span class="line">       &lt;url&gt;http://maven.aliyun.com/nexus/content/groups/public&lt;/url&gt;</span><br><span class="line">   &lt;/mirror&gt; </span><br><span class="line"> &lt;/mirrors&gt;</span><br></pre></td></tr></table></figure>

<h3 id="编译-Dubbo-Provider和-Consumer"><a href="#编译-Dubbo-Provider和-Consumer" class="headerlink" title="编译 Dubbo Provider和 Consumer"></a>编译 Dubbo Provider和 Consumer</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@provider dubbo-demo-provider]<span class="comment"># mvn clean package -Dmaven.test.skip=true</span></span><br><span class="line">[root@consumer dubbo-demo-consumer]<span class="comment"># mvn clean package -Dmaven.test.skip=true</span></span><br></pre></td></tr></table></figure>

<h3 id="启动-Dubbo-Provider和-Consumer"><a href="#启动-Dubbo-Provider和-Consumer" class="headerlink" title="启动 Dubbo Provider和 Consumer"></a>启动 Dubbo Provider和 Consumer</h3><p>注意：先启动 Provider，再启动 Consumer</p>
<p>注意：运行时Provider和Consumer时，对应dubbo-api项目是不需要，但编译时依赖dubbo-api的</p>
<h4 id="先启动-Dubbo-Provider"><a href="#先启动-Dubbo-Provider" class="headerlink" title="先启动 Dubbo Provider"></a>先启动 Dubbo Provider</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@provider dubbo-demo-provider]<span class="comment">#java -jar dubbo-server/target/dubbo-server.jar </span></span><br><span class="line">......</span><br><span class="line">Dubbo server started</span><br><span class="line">Dubbo 服务端已经启动</span><br></pre></td></tr></table></figure>

<h4 id="后启动-Dubbo-Consumer"><a href="#后启动-Dubbo-Consumer" class="headerlink" title="后启动 Dubbo Consumer"></a>后启动 Dubbo Consumer</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@consumer dubbo-demo-consumer]<span class="comment">#java -jar dubbo-client/target/dubbo-client.jar</span></span><br><span class="line">......</span><br></pre></td></tr></table></figure>

<h3 id="浏览器访问-Dubbo-Consumer"><a href="#浏览器访问-Dubbo-Consumer" class="headerlink" title="浏览器访问 Dubbo Consumer"></a>浏览器访问 Dubbo Consumer</h3><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">http://&lt;consumer主机IP&gt;:8080/hello?name=wang</span><br><span class="line">http://&lt;consumer主机IP&gt;:8080/test?name=wang</span><br></pre></td></tr></table></figure>

<p><img src="../../../../images/SRE/day52/72.jpg" alt="72"></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#consumer显示下面日志</span></span><br><span class="line">HelloAction接收到请求:wang</span><br><span class="line">HelloService返回到结果:&lt;h1&gt;这是Dubbo 消费者端(springboot)&lt;/h1&gt;&lt;h2&gt;Dubbo微服务!&lt;/h2&gt;hello wang</span><br><span class="line"></span><br><span class="line"><span class="comment">#provider显示下面日志</span></span><br><span class="line">HelloService接收到消息:wang</span><br></pre></td></tr></table></figure>

</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="http://example.com">૮(˶ᵔ ᵕ ᵔ˶)ა</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="http://example.com/2025/04/21/SRE-kafka/">http://example.com/2025/04/21/SRE-kafka/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="http://example.com" target="_blank">૮(˶ᵔ ᵕ ᵔ˶)ა</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/SRE/">SRE</a><a class="post-meta__tags" href="/tags/zookeeper/">zookeeper</a><a class="post-meta__tags" href="/tags/kafka/">kafka</a><a class="post-meta__tags" href="/tags/Dubbo/">Dubbo</a></div><div class="post_share"><div class="social-share" data-image="/../images/SRE/day52/30.jpg" data-sites="wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2025/04/19/SRE-redis/" title="企业级NoSQL数据库Redis"><img class="cover" src="/../images/SRE/day49/1.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">企业级NoSQL数据库Redis</div></div></a></div><div class="next-post pull-right"><a href="/2025/04/24/SRE-git/" title="版本管理系统Git和GitLab"><img class="cover" src="/../images/SRE/day53/77.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">版本管理系统Git和GitLab</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><div><a href="/2025/04/15/SRE-HAProxy/" title="高可用性集群HAProxy"><img class="cover" src="/../images/SRE/day47/1.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2025-04-15</div><div class="title">高可用性集群HAProxy</div></div></a></div><div><a href="/2025/04/16/SRE-Keepalived/" title="高可用性集群Keepalived"><img class="cover" src="/../images/SRE/day48/1.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2025-04-16</div><div class="title">高可用性集群Keepalived</div></div></a></div><div><a href="/2024/04/24/SRE-Linux%E5%9F%BA%E6%9C%AC%E6%93%8D%E4%BD%9C%E5%92%8C%E5%B8%AE%E5%8A%A9/" title="Linux基本操作和帮助"><img class="cover" src="/../images/TITLE/linux2.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-04-24</div><div class="title">Linux基本操作和帮助</div></div></a></div><div><a href="/2025/02/21/SRE-LVS/" title="企业级调度器LVS"><img class="cover" src="/../images/SRE/day27/3.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2025-02-21</div><div class="title">企业级调度器LVS</div></div></a></div><div><a href="/2024/08/27/SRE-Linux%E6%96%87%E4%BB%B6%E7%AE%A1%E7%90%86%E5%92%8CIO%E9%87%8D%E5%AE%9A%E5%90%91/" title="Linux文件管理和IO重定向"><img class="cover" src="/../images/TITLE/linux3.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-08-27</div><div class="title">Linux文件管理和IO重定向</div></div></a></div><div><a href="/2024/12/08/SRE-Linux%E9%98%B2%E7%81%AB%E5%A2%99/" title="Linux防火墙"><img class="cover" src="/../images/SRE/day17/12.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-12-08</div><div class="title">Linux防火墙</div></div></a></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="/../images/TITLE/user.webp" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">૮(˶ᵔ ᵕ ᵔ˶)ა</div><div class="author-info__description">这家伙很勤奋，什么都留下了</div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">102</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">41</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">34</div></a></div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content is-expand"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%BE%AE%E6%9C%8D%E5%8A%A1"><span class="toc-number">1.</span> <span class="toc-text">微服务</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9C%8D%E5%8A%A1%E6%9E%B6%E6%9E%84%E6%BC%94%E5%8F%98"><span class="toc-number">1.1.</span> <span class="toc-text">服务架构演变</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8D%95%E4%BD%93%E6%9E%B6%E6%9E%84"><span class="toc-number">1.2.</span> <span class="toc-text">单体架构</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%BE%AE%E6%9C%8D%E5%8A%A1-1"><span class="toc-number">1.3.</span> <span class="toc-text">微服务</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8D%95%E4%BD%93%E6%9E%B6%E6%9E%84%E5%92%8C%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%AF%94%E8%BE%83"><span class="toc-number">1.4.</span> <span class="toc-text">单体架构和微服务比较</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%BE%AE%E6%9C%8D%E5%8A%A1%E7%9A%84%E4%BC%98%E7%BC%BA%E7%82%B9"><span class="toc-number">1.5.</span> <span class="toc-text">微服务的优缺点</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%8A%80%E6%9C%AF%E6%A0%88"><span class="toc-number">1.6.</span> <span class="toc-text">微服务技术栈</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%B8%B8%E8%A7%81%E7%9A%84%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%A1%86%E6%9E%B6"><span class="toc-number">1.7.</span> <span class="toc-text">常见的微服务框架</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%BE%AE%E6%9C%8D%E5%8A%A1%E8%BF%98%E6%98%AF%E5%8D%95%E4%BD%93%EF%BC%9F"><span class="toc-number">1.8.</span> <span class="toc-text">微服务还是单体？</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#ZooKeeper"><span class="toc-number">2.</span> <span class="toc-text">ZooKeeper</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#ZooKeeper-%E4%BB%8B%E7%BB%8D"><span class="toc-number">2.1.</span> <span class="toc-text">ZooKeeper 介绍</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ZooKeeper-%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86"><span class="toc-number">2.2.</span> <span class="toc-text">ZooKeeper 工作原理</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#ZooKeeper-%E5%8A%9F%E8%83%BD"><span class="toc-number">2.2.1.</span> <span class="toc-text">ZooKeeper 功能</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%91%BD%E5%90%8D%E6%9C%8D%E5%8A%A1"><span class="toc-number">2.2.1.1.</span> <span class="toc-text">命名服务</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%8A%B6%E6%80%81%E5%90%8C%E6%AD%A5"><span class="toc-number">2.2.1.2.</span> <span class="toc-text">状态同步</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE%E4%B8%AD%E5%BF%83"><span class="toc-number">2.2.1.3.</span> <span class="toc-text">配置中心</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%9B%86%E7%BE%A4%E7%AE%A1%E7%90%86"><span class="toc-number">2.2.1.4.</span> <span class="toc-text">集群管理</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ZooKeeper-%E6%9C%8D%E5%8A%A1%E6%B5%81%E7%A8%8B"><span class="toc-number">2.2.2.</span> <span class="toc-text">ZooKeeper 服务流程</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ZooKeeper-%E5%8D%95%E6%9C%BA%E9%83%A8%E7%BD%B2"><span class="toc-number">2.3.</span> <span class="toc-text">ZooKeeper 单机部署</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE-Java-%E7%8E%AF%E5%A2%83"><span class="toc-number">2.3.1.</span> <span class="toc-text">配置 Java 环境</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%83%A8%E7%BD%B2-ZooKeeper"><span class="toc-number">2.3.2.</span> <span class="toc-text">部署 ZooKeeper</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8C%85%E5%AE%89%E8%A3%85"><span class="toc-number">2.3.2.1.</span> <span class="toc-text">包安装</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BA%8C%E8%BF%9B%E5%88%B6%E5%AE%89%E8%A3%85"><span class="toc-number">2.3.2.2.</span> <span class="toc-text">二进制安装</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%90%AF%E5%8A%A8-ZooKeeper"><span class="toc-number">2.3.3.</span> <span class="toc-text">启动 ZooKeeper</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%AA%8C%E8%AF%81-ZooKeeper"><span class="toc-number">2.3.4.</span> <span class="toc-text">验证 ZooKeeper</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%80%E9%94%AE%E5%AE%89%E8%A3%85-ZooKeeper-%E8%84%9A%E6%9C%AC"><span class="toc-number">2.3.5.</span> <span class="toc-text">一键安装 ZooKeeper 脚本</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ZooKeeper-%E9%9B%86%E7%BE%A4%E9%83%A8%E7%BD%B2"><span class="toc-number">2.4.</span> <span class="toc-text">ZooKeeper 集群部署</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#ZooKeeper-%E9%9B%86%E7%BE%A4%E4%BB%8B%E7%BB%8D"><span class="toc-number">2.4.1.</span> <span class="toc-text">ZooKeeper 集群介绍</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%9B%86%E7%BE%A4%E7%BB%93%E6%9E%84"><span class="toc-number">2.4.1.1.</span> <span class="toc-text">集群结构</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%9B%86%E7%BE%A4%E8%A7%92%E8%89%B2"><span class="toc-number">2.4.1.2.</span> <span class="toc-text">集群角色</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%80%89%E4%B8%BE%E8%BF%87%E7%A8%8B"><span class="toc-number">2.4.1.3.</span> <span class="toc-text">选举过程</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#ZooKeeper-%E9%9B%86%E7%BE%A4%E7%89%B9%E6%80%A7"><span class="toc-number">2.4.1.4.</span> <span class="toc-text">ZooKeeper 集群特性</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ZooKeeper-%E9%9B%86%E7%BE%A4%E9%83%A8%E7%BD%B2-1"><span class="toc-number">2.4.2.</span> <span class="toc-text">ZooKeeper 集群部署</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%8E%AF%E5%A2%83%E5%87%86%E5%A4%87"><span class="toc-number">2.4.2.1.</span> <span class="toc-text">环境准备</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%9C%A8%E6%89%80%E6%9C%89%E8%8A%82%E7%82%B9%E4%B8%8B%E8%BD%BD%E5%B9%B6%E8%A7%A3%E5%8E%8B%E7%BC%A9-ZooKeeper-%E5%8C%85%E6%96%87%E4%BB%B6"><span class="toc-number">2.4.2.2.</span> <span class="toc-text">在所有节点下载并解压缩 ZooKeeper 包文件</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%87%86%E5%A4%87%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6"><span class="toc-number">2.4.2.3.</span> <span class="toc-text">准备配置文件</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%9C%A8%E5%90%84%E4%B8%AA%E8%8A%82%E7%82%B9%E7%94%9F%E6%88%90ID%E6%96%87%E4%BB%B6"><span class="toc-number">2.4.2.4.</span> <span class="toc-text">在各个节点生成ID文件</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%90%84%E6%9C%8D%E5%8A%A1%E5%99%A8%E5%90%AF%E5%8A%A8-zookeeper"><span class="toc-number">2.4.2.5.</span> <span class="toc-text">各服务器启动 zookeeper</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%9F%A5%E7%9C%8B%E9%9B%86%E7%BE%A4%E7%8A%B6%E6%80%81"><span class="toc-number">2.4.2.6.</span> <span class="toc-text">查看集群状态</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%A2%E6%88%B7%E7%AB%AF%E8%AE%BF%E9%97%AE"><span class="toc-number">2.5.</span> <span class="toc-text">客户端访问</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%91%BD%E4%BB%A4%E8%A1%8C%E5%AE%A2%E6%88%B7%E7%AB%AF%E8%AE%BF%E9%97%AE-ZooKeeper"><span class="toc-number">2.5.1.</span> <span class="toc-text">命令行客户端访问 ZooKeeper</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#nc-%E8%AE%BF%E9%97%AE-ZooKeeper"><span class="toc-number">2.5.2.</span> <span class="toc-text">nc 访问 ZooKeeper</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9B%BE%E5%BD%A2%E5%8C%96%E5%AE%A2%E6%88%B7%E7%AB%AF-ZooInspector"><span class="toc-number">2.5.3.</span> <span class="toc-text">图形化客户端 ZooInspector</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Linux-%E5%AE%A2%E6%88%B7%E7%AB%AF"><span class="toc-number">2.5.3.1.</span> <span class="toc-text">Linux 客户端</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E7%BC%96%E8%AF%91-zooinspector"><span class="toc-number">2.5.3.1.1.</span> <span class="toc-text">编译 zooinspector</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%AE%A2%E6%88%B7%E7%AB%AF%E4%BD%BF%E7%94%A8"><span class="toc-number">2.5.3.1.2.</span> <span class="toc-text">客户端使用</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Windows-%E5%AE%A2%E6%88%B7%E7%AB%AF%E4%BD%BF%E7%94%A8"><span class="toc-number">2.5.3.2.</span> <span class="toc-text">Windows 客户端使用</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Python-%E8%AE%BF%E9%97%AE-ZooKeeper"><span class="toc-number">2.5.4.</span> <span class="toc-text">Python 访问 ZooKeeper</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Kafka"><span class="toc-number">3.</span> <span class="toc-text">Kafka</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97%E7%AE%80%E4%BB%8B"><span class="toc-number">3.1.</span> <span class="toc-text">消息队列简介</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#MQ-%E5%AE%9A%E4%B9%89"><span class="toc-number">3.1.1.</span> <span class="toc-text">MQ 定义</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#MQ-%E4%BD%BF%E7%94%A8%E5%9C%BA%E5%90%88"><span class="toc-number">3.1.2.</span> <span class="toc-text">MQ 使用场合</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%BB%E6%B5%81-MQ"><span class="toc-number">3.1.3.</span> <span class="toc-text">主流 MQ</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Kafka-%E4%BB%8B%E7%BB%8D"><span class="toc-number">3.2.</span> <span class="toc-text">Kafka 介绍</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%B8%B8%E7%94%A8%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97%E5%AF%B9%E6%AF%94"><span class="toc-number">3.3.</span> <span class="toc-text">常用消息队列对比</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Kafka-%E7%89%B9%E7%82%B9%E5%92%8C%E4%BC%98%E5%8A%BF"><span class="toc-number">3.4.</span> <span class="toc-text">Kafka 特点和优势</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Kafka-%E8%A7%92%E8%89%B2%E5%92%8C%E6%B5%81%E7%A8%8B"><span class="toc-number">3.5.</span> <span class="toc-text">Kafka 角色和流程</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Kafka-%E8%A7%92%E8%89%B2"><span class="toc-number">3.5.1.</span> <span class="toc-text">Kafka 角色</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Kafka-%E5%86%99%E5%85%A5%E6%B6%88%E6%81%AF%E7%9A%84%E6%B5%81%E7%A8%8B"><span class="toc-number">3.5.2.</span> <span class="toc-text">Kafka 写入消息的流程</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Kafka-%E9%83%A8%E7%BD%B2"><span class="toc-number">3.6.</span> <span class="toc-text">Kafka 部署</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%8E%AF%E5%A2%83%E5%87%86%E5%A4%87-ZooKeeper"><span class="toc-number">3.6.1.</span> <span class="toc-text">环境准备 ZooKeeper</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%89%88%E6%9C%AC%E9%80%89%E6%8B%A9"><span class="toc-number">3.6.2.</span> <span class="toc-text">版本选择</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%90%84%E8%8A%82%E7%82%B9%E9%83%A8%E7%BD%B2-Kafka"><span class="toc-number">3.6.3.</span> <span class="toc-text">各节点部署 Kafka</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Kafka-%E8%8A%82%E7%82%B9%E9%85%8D%E7%BD%AE"><span class="toc-number">3.6.3.1.</span> <span class="toc-text">Kafka 节点配置</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%90%AF%E5%8A%A8%E6%9C%8D%E5%8A%A1"><span class="toc-number">3.6.3.2.</span> <span class="toc-text">启动服务</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%A1%AE%E4%BF%9D%E6%9C%8D%E5%8A%A1%E5%90%AF%E5%8A%A8%E7%8A%B6%E6%80%81"><span class="toc-number">3.6.3.3.</span> <span class="toc-text">确保服务启动状态</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%87%86%E5%A4%87Kafka%E7%9A%84service%E6%96%87%E4%BB%B6"><span class="toc-number">3.6.3.4.</span> <span class="toc-text">准备Kafka的service文件</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Kafka-%E8%AF%BB%E5%86%99%E6%95%B0%E6%8D%AE"><span class="toc-number">3.7.</span> <span class="toc-text">Kafka 读写数据</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA-Topic"><span class="toc-number">3.7.1.</span> <span class="toc-text">创建 Topic</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%8E%B7%E5%8F%96%E6%89%80%E6%9C%89-Topic"><span class="toc-number">3.7.2.</span> <span class="toc-text">获取所有 Topic</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%AA%8C%E8%AF%81-Topic-%E8%AF%A6%E6%83%85"><span class="toc-number">3.7.3.</span> <span class="toc-text">验证 Topic 详情</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%94%9F%E4%BA%A7-Topic"><span class="toc-number">3.7.4.</span> <span class="toc-text">生产 Topic</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B6%88%E8%B4%B9-Topic"><span class="toc-number">3.7.5.</span> <span class="toc-text">消费 Topic</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%A0%E9%99%A4-Topic"><span class="toc-number">3.7.6.</span> <span class="toc-text">删除 Topic</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Kafka-%E5%9C%A8-ZooKeeper-%E9%87%8C%E9%9D%A2%E7%9A%84%E5%AD%98%E5%82%A8%E7%BB%93%E6%9E%84"><span class="toc-number">3.8.</span> <span class="toc-text">Kafka 在 ZooKeeper 里面的存储结构</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9B%BE%E5%BD%A2%E5%B7%A5%E5%85%B7-Offset-Explorer-Kafka-Tool"><span class="toc-number">3.9.</span> <span class="toc-text">图形工具 Offset Explorer (Kafka Tool)</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9F%BA%E4%BA%8E-Web-%E7%9A%84-kafka-eagle"><span class="toc-number">3.10.</span> <span class="toc-text">基于 Web 的 kafka-eagle</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Dubbo"><span class="toc-number">4.</span> <span class="toc-text">Dubbo</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Dubbo-%E4%BB%8B%E7%BB%8D"><span class="toc-number">4.1.</span> <span class="toc-text">Dubbo 介绍</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%9E%E6%88%98%E6%A1%88%E4%BE%8B%EF%BC%9A%E5%AE%9E%E7%8E%B0-Dubbo-%E6%9E%B6%E6%9E%84"><span class="toc-number">4.2.</span> <span class="toc-text">实战案例：实现 Dubbo 架构</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%87%86%E5%A4%87-ZooKeeper-%E6%8F%90%E4%BE%9B%E6%B3%A8%E5%86%8C%E4%B8%AD%E5%BF%83"><span class="toc-number">4.2.1.</span> <span class="toc-text">准备 ZooKeeper 提供注册中心</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%94%9F%E4%BA%A7%E8%80%85%E7%A4%BA%E4%BE%8B"><span class="toc-number">4.2.2.</span> <span class="toc-text">生产者示例</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B6%88%E8%B4%B9%E8%80%85%E7%A4%BA%E4%BE%8B"><span class="toc-number">4.2.3.</span> <span class="toc-text">消费者示例</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%9E%E6%88%98%E6%A1%88%E4%BE%8B%EF%BC%9A%E7%BC%96%E8%AF%91%E5%AE%89%E8%A3%85-Dubbo%E7%9A%84-Web-%E7%AE%A1%E7%90%86-Dubbo-Admin%EF%BC%88%E6%96%B0%E7%89%88%EF%BC%89"><span class="toc-number">4.3.</span> <span class="toc-text">实战案例：编译安装 Dubbo的 Web 管理 Dubbo Admin（新版）</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BC%96%E8%AF%91-dubbo-admin"><span class="toc-number">4.3.1.</span> <span class="toc-text">编译 dubbo admin</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BC%96%E8%AF%91%E5%AE%8C%E6%88%90"><span class="toc-number">4.3.2.</span> <span class="toc-text">编译完成</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%90%AF%E5%8A%A8%E6%9C%8D%E5%8A%A1-1"><span class="toc-number">4.3.3.</span> <span class="toc-text">启动服务</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%99%BB%E5%BD%95-Web-%E7%95%8C%E9%9D%A2%E9%AA%8C%E8%AF%81"><span class="toc-number">4.3.4.</span> <span class="toc-text">登录 Web 界面验证</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%9E%E6%88%98%E6%A1%88%E4%BE%8B%EF%BC%9A%E7%BC%96%E8%AF%91%E5%AE%89%E8%A3%85-Dubbo%E7%9A%84-Web-%E7%AE%A1%E7%90%86-dubbo-admin%EF%BC%88%E6%97%A7%E7%89%88%EF%BC%89"><span class="toc-number">4.4.</span> <span class="toc-text">实战案例：编译安装 Dubbo的 Web 管理 dubbo admin（旧版）</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%8B%E8%BD%BD-dubbo-admin-%E7%9A%84-Web-%E7%AE%A1%E7%90%86%E6%BA%90%E7%A0%81"><span class="toc-number">4.4.1.</span> <span class="toc-text">下载 dubbo-admin 的 Web 管理源码</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BC%96%E8%AF%91-Dubbo-Admin-%E7%94%9F%E6%88%90-war-%E5%8C%85%E6%96%87%E4%BB%B6"><span class="toc-number">4.4.2.</span> <span class="toc-text">编译 Dubbo Admin 生成 war 包文件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9C%A8-Tomcat-%E4%B8%AD%E9%83%A8%E7%BD%B2-Dubbo-Admin"><span class="toc-number">4.4.3.</span> <span class="toc-text">在 Tomcat 中部署 Dubbo Admin</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%AA%8C%E8%AF%81%E7%99%BB%E5%BD%95-Dubbo-%E7%9A%84-Web-%E7%AE%A1%E7%90%86%E9%A1%B5%E9%9D%A2"><span class="toc-number">4.4.4.</span> <span class="toc-text">验证登录 Dubbo 的 Web 管理页面</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%9E%E6%88%98%E6%A1%88%E4%BE%8B%EF%BC%9ADubbo-%E5%BE%AE%E6%9C%8D%E5%8A%A1"><span class="toc-number">4.5.</span> <span class="toc-text">实战案例：Dubbo 微服务</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%8E%AF%E5%A2%83%E5%87%86%E5%A4%87-1"><span class="toc-number">4.5.1.</span> <span class="toc-text">环境准备</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9C%A8-Zookeeper-%E4%B8%BB%E6%9C%BA%E5%AE%89%E8%A3%85-Zookeeper"><span class="toc-number">4.5.2.</span> <span class="toc-text">在 Zookeeper 主机安装 Zookeeper</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9C%A8Provider%E5%92%8CConsumer%E5%AE%89%E8%A3%85-maven-%E5%B9%B6%E9%95%9C%E5%83%8F%E5%8A%A0%E9%80%9F"><span class="toc-number">4.5.3.</span> <span class="toc-text">在Provider和Consumer安装 maven 并镜像加速</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BC%96%E8%AF%91-Dubbo-Provider%E5%92%8C-Consumer"><span class="toc-number">4.5.4.</span> <span class="toc-text">编译 Dubbo Provider和 Consumer</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%90%AF%E5%8A%A8-Dubbo-Provider%E5%92%8C-Consumer"><span class="toc-number">4.5.5.</span> <span class="toc-text">启动 Dubbo Provider和 Consumer</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%85%88%E5%90%AF%E5%8A%A8-Dubbo-Provider"><span class="toc-number">4.5.5.1.</span> <span class="toc-text">先启动 Dubbo Provider</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%90%8E%E5%90%AF%E5%8A%A8-Dubbo-Consumer"><span class="toc-number">4.5.5.2.</span> <span class="toc-text">后启动 Dubbo Consumer</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B5%8F%E8%A7%88%E5%99%A8%E8%AE%BF%E9%97%AE-Dubbo-Consumer"><span class="toc-number">4.5.6.</span> <span class="toc-text">浏览器访问 Dubbo Consumer</span></a></li></ol></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2025/07/30/MY-k8s1.29/" title="K8S 1.29.2"><img src="/../images/SRE/day46/1.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="K8S 1.29.2"/></a><div class="content"><a class="title" href="/2025/07/30/MY-k8s1.29/" title="K8S 1.29.2">K8S 1.29.2</a><time datetime="2025-07-30T07:17:21.000Z" title="发表于 2025-07-30 15:17:21">2025-07-30</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2025/05/09/SRE-jenkins/" title="DevOps之CICD工具Jenkins"><img src="/../images/SRE/day55/1.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="DevOps之CICD工具Jenkins"/></a><div class="content"><a class="title" href="/2025/05/09/SRE-jenkins/" title="DevOps之CICD工具Jenkins">DevOps之CICD工具Jenkins</a><time datetime="2025-05-09T09:30:43.000Z" title="发表于 2025-05-09 17:30:43">2025-05-09</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2025/04/24/SRE-git/" title="版本管理系统Git和GitLab"><img src="/../images/SRE/day53/77.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="版本管理系统Git和GitLab"/></a><div class="content"><a class="title" href="/2025/04/24/SRE-git/" title="版本管理系统Git和GitLab">版本管理系统Git和GitLab</a><time datetime="2025-04-24T01:21:27.000Z" title="发表于 2025-04-24 09:21:27">2025-04-24</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2025/04/21/SRE-kafka/" title="消息队列和微服务"><img src="/../images/SRE/day52/30.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="消息队列和微服务"/></a><div class="content"><a class="title" href="/2025/04/21/SRE-kafka/" title="消息队列和微服务">消息队列和微服务</a><time datetime="2025-04-21T15:34:02.000Z" title="发表于 2025-04-21 23:34:02">2025-04-21</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2023 - 2025 By ૮(˶ᵔ ᵕ ᵔ˶)ა</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div><div class="footer_custom_text"><a target="_blank" rel="noopener" href="https://beian.miit.gov.cn/#/Integrated/index"><img src="../images/BEIAN/icp.png" width="15" height="15">豫ICP备2023009931号</a></br><a href="http://www.beian.gov.cn/portal/registerSystemInfo?recordcode=41162702000178" target="_blank"><img src="../images/BEIAN/beian.png" width="15" height="15">豫公网安备 41162702000178号</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.umd.min.js"></script><script src="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.js"></script><script>function panguFn () {
  if (typeof pangu === 'object') pangu.autoSpacingPage()
  else {
    getScript('https://cdn.jsdelivr.net/npm/pangu/dist/browser/pangu.min.js')
      .then(() => {
        pangu.autoSpacingPage()
      })
  }
}

function panguInit () {
  if (true){
    GLOBAL_CONFIG_SITE.isPost && panguFn()
  } else {
    panguFn()
  }
}

document.addEventListener('DOMContentLoaded', panguInit)</script><div class="js-pjax"></div><canvas id="universe"></canvas><script src="/js/universe.js"></script><canvas class="fireworks" mobile="true"></canvas><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/fireworks.min.js"></script><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/activate-power-mode.min.js"></script><script>POWERMODE.colorful = true;
POWERMODE.shake = false;
POWERMODE.mobile = false;
document.body.addEventListener('input', POWERMODE);
</script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>