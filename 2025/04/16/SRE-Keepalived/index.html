<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>高可用性集群Keepalived | ૮(˶ᵔ ᵕ ᵔ˶)ა</title><meta name="author" content="૮(˶ᵔ ᵕ ᵔ˶)ა"><meta name="copyright" content="૮(˶ᵔ ᵕ ᵔ˶)ა"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="ffffff"><meta name="description" content="Site Reliability Engineering">
<meta property="og:type" content="article">
<meta property="og:title" content="高可用性集群Keepalived">
<meta property="og:url" content="http://example.com/2025/04/16/SRE-Keepalived/index.html">
<meta property="og:site_name" content="૮(˶ᵔ ᵕ ᵔ˶)ა">
<meta property="og:description" content="Site Reliability Engineering">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://example.com/images/SRE/day48/1.jpg">
<meta property="article:published_time" content="2025-04-16T09:15:13.000Z">
<meta property="article:modified_time" content="2025-04-16T09:17:31.550Z">
<meta property="article:author" content="૮(˶ᵔ ᵕ ᵔ˶)ა">
<meta property="article:tag" content="Keepalived">
<meta property="article:tag" content="SRE">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://example.com/images/SRE/day48/1.jpg"><link rel="shortcut icon" href="/../images/TITLE/user.webp"><link rel="canonical" href="http://example.com/2025/04/16/SRE-Keepalived/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//fonts.googleapis.com" crossorigin=""/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Titillium+Web&amp;display=swap" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":false,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: true,
    post: true
  },
  runtime: '天',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: {"chs_to_cht":"你已切换为繁体","cht_to_chs":"你已切换为简体","day_to_night":"你已切换为深色模式","night_to_day":"你已切换为浅色模式","bgLight":"#49b1f5","bgDark":"#1f1f1f","position":"top-center"},
  source: {
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: true,
  }
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: '高可用性集群Keepalived',
  isPost: true,
  isHome: false,
  isHighlightShrink: undefined,
  isToc: true,
  postUpdate: '2025-04-16 17:17:31'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
    win.getCSS = (url,id = false) => new Promise((resolve, reject) => {
      const link = document.createElement('link')
      link.rel = 'stylesheet'
      link.href = url
      if (id) link.id = id
      link.onerror = reject
      link.onload = link.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        link.onload = link.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(link)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', 'ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><link rel="stylesheet" href="/css/custom.css"  media="defer" onload="this.media='all'"><meta name="generator" content="Hexo 5.4.2"></head><body><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="/../images/TITLE/user.webp" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">105</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">42</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">35</div></a></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间线</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('/../images/SRE/day48/1.jpg')"><nav id="nav"><span id="blog-info"><a href="/" title="૮(˶ᵔ ᵕ ᵔ˶)ა"><span class="site-name">૮(˶ᵔ ᵕ ᵔ˶)ა</span></a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间线</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">高可用性集群Keepalived</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2025-04-16T09:15:13.000Z" title="发表于 2025-04-16 17:15:13">2025-04-16</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2025-04-16T09:17:31.550Z" title="更新于 2025-04-16 17:17:31">2025-04-16</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/Keepalived/">Keepalived</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">字数总计:</span><span class="word-count">14.8k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>75分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="高可用性集群Keepalived"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="Keepalived-架构和安装"><a href="#Keepalived-架构和安装" class="headerlink" title="Keepalived 架构和安装"></a>Keepalived 架构和安装</h1><h2 id="Keepalived-介绍"><a href="#Keepalived-介绍" class="headerlink" title="Keepalived 介绍"></a>Keepalived 介绍</h2><p>vrrp 协议的软件实现，原生设计目的为了高可用 ipvs服务</p>
<p>keepalived 是高可用集群的通用无状态应用解决方案</p>
<p>官网：<a target="_blank" rel="noopener" href="http://keepalived.org/">http://keepalived.org/</a></p>
<p>功能：</p>
<ul>
<li>基于vrrp协议完成地址流动</li>
<li>为vip地址所在的节点生成ipvs规则(在配置文件中预先定义)</li>
<li>为ipvs集群的各RS做健康状态检测</li>
<li>基于脚本调用接口完成脚本中定义的功能，进而影响集群事务，以此支持nginx、haproxy等服务</li>
</ul>
<h2 id="Keepalived-架构"><a href="#Keepalived-架构" class="headerlink" title="Keepalived 架构"></a>Keepalived 架构</h2><p>官方文档：</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">https://keepalived.org/doc/</span><br><span class="line">http://keepalived.org/documentation.html</span><br></pre></td></tr></table></figure>

<p><img src="../../../../images/SRE/day48/2.jpg" alt="2"></p>
<ul>
<li><p>用户空间核心组件：</p>
<ul>
<li>vrrp stack：VIP消息通告</li>
<li>checkers：监测 Real Server</li>
<li>system call：实现 vrrp 协议状态转换时调用脚本的功能</li>
<li>SMTP：邮件组件</li>
<li>IPVS wrapper：生成 IPVS 规则</li>
<li>Netlink Reflector：网络接口</li>
<li>WatchDog：监控进程</li>
</ul>
</li>
<li><p>控制组件：提供keepalived.conf 的解析器，完成Keepalived配置</p>
</li>
<li><p>IO复用器：针对网络目的而优化的自己的线程抽象</p>
</li>
<li><p>内存管理组件：为某些通用的内存管理功能（例如分配，重新分配，发布等）提供访问权限</p>
</li>
</ul>
<p><strong>Keepalived进程树</strong></p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Keepalived &lt;-- Parent process monitoring children</span><br><span class="line">\_ Keepalived &lt;-- VRRP child</span><br><span class="line">\_ Keepalived &lt;-- Healthchecking child</span><br></pre></td></tr></table></figure>

<h2 id="Keepalived-环境准备"><a href="#Keepalived-环境准备" class="headerlink" title="Keepalived 环境准备"></a>Keepalived 环境准备</h2><p><img src="../../../../images/SRE/day48/3.jpg" alt="3"></p>
<ul>
<li>各节点时间必须同步：ntp, chrony</li>
<li>关闭防火墙及SELinux</li>
<li>各节点之间可通过主机名互相通信：非必须</li>
<li>建议使用/etc/hosts文件实现：非必须</li>
<li>各节点之间的root用户可以基于密钥认证的ssh服务完成互相通信：非必须</li>
</ul>
<h2 id="Keepalived-相关文件"><a href="#Keepalived-相关文件" class="headerlink" title="Keepalived 相关文件"></a>Keepalived 相关文件</h2><ul>
<li>软件包名：keepalived </li>
<li>主程序文件：/usr/sbin/keepalived</li>
<li>主配置文件：/etc/keepalived/keepalived.conf</li>
<li>配置文件示例：/usr/share/doc/keepalived/</li>
<li>Unit File：/lib/systemd/system/keepalived.service</li>
<li>Unit File的环境配置文件：<ul>
<li>/etc/sysconfig/keepalived CentOS</li>
<li>/etc/default/keepalived Ubuntu </li>
</ul>
</li>
</ul>
<p><strong>注意：CentOS 7 上有 bug，可能有下面情况出现</strong></p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">systemctl restart keepalived #新配置可能无法生效</span><br><span class="line">systemctl stop keepalived;systemctl start keepalived #无法停止进程，需要 kill 停止</span><br></pre></td></tr></table></figure>

<h2 id="Keepalived-安装"><a href="#Keepalived-安装" class="headerlink" title="Keepalived 安装"></a>Keepalived 安装</h2><h3 id="包安装"><a href="#包安装" class="headerlink" title="包安装"></a>包安装</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#CentOS</span></span><br><span class="line">[root@centos ~]<span class="comment"># yum -y install keepalived</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#ubuntu</span></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment"># apt update;apt -y install keepalived</span></span><br></pre></td></tr></table></figure>

<h4 id="CentOS-安装-keepalived"><a href="#CentOS-安装-keepalived" class="headerlink" title="CentOS 安装 keepalived"></a>CentOS 安装 keepalived</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ~]<span class="comment"># dnf -y install keepalived</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># dnf info keepalived</span></span><br><span class="line"></span><br><span class="line">[root@centos8 ~]<span class="comment"># systemctl start keepalived.service </span></span><br><span class="line">[root@centos8 ~]<span class="comment"># ps auxf |grep keepalived</span></span><br><span class="line"></span><br><span class="line">[root@centos8 ~]<span class="comment"># pstree -p</span></span><br><span class="line">......</span><br><span class="line">           ├─keepalived(12835)─┬─keepalived(12836)</span><br><span class="line">           │                   └─keepalived(12837)</span><br><span class="line">......</span><br></pre></td></tr></table></figure>

<h4 id="Ubuntu-安装-keepalived"><a href="#Ubuntu-安装-keepalived" class="headerlink" title="Ubuntu 安装 keepalived"></a>Ubuntu 安装 keepalived</h4><p>范例：Ubuntu22.04</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">[root@ubuntu2204 ~]<span class="comment"># apt list keepalived</span></span><br><span class="line">[root@ubuntu2204 ~]<span class="comment"># apt update;apt -y install keepalived</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#默认缺少配置，服务无法启动，提示/etc/keepalived/keepalived.conf 不存在</span></span><br><span class="line">[root@ubuntu2204 ~]<span class="comment"># systemctl status keepalived.service</span></span><br><span class="line">○ keepalived.service - Keepalive Daemon (LVS and VRRP)</span><br><span class="line">     Loaded: loaded (/lib/systemd/system/keepalived.service; enabled; vendor preset: enabled)</span><br><span class="line">     Active: inactive (dead)</span><br><span class="line"> Condition: start condition failed at Thu 2023-01-12 15:28:42 CST; 4s ago</span><br><span class="line">             └─ ConditionFileNotEmpty=/etc/keepalived/keepalived.conf was not met</span><br><span class="line">1月 12 15:26:47 ubuntu2204.wang.org systemd[1]: Condition check resulted <span class="keyword">in</span></span><br><span class="line">Keepalive Daemon (LVS and VRRP) being skipped.</span><br><span class="line">1月 12 15:28:42 ubuntu2204.wang.org systemd[1]: Condition check resulted <span class="keyword">in</span></span><br><span class="line">Keepalive Daemon (LVS and VRRP) being skipped.</span><br><span class="line"></span><br><span class="line"><span class="comment">#利用模板生成生配置文件</span></span><br><span class="line">[root@ubuntu2204 ~]<span class="comment"># cp /usr/share/doc/keepalived/samples/keepalived.conf.sample /etc/keepalived/keepalived.conf</span></span><br><span class="line">[root@ubuntu2204 ~]<span class="comment"># systemctl start keepalived.service</span></span><br><span class="line">[root@ubuntu2204 ~]<span class="comment"># systemctl status keepalived.service</span></span><br></pre></td></tr></table></figure>

<h3 id="编译安装"><a href="#编译安装" class="headerlink" title="编译安装"></a>编译安装</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#Ubuntu20.04安装相关包</span></span><br><span class="line">[root@ubuntu2004 ~]<span class="comment"># apt update </span></span><br><span class="line">[root@ubuntu2004 ~]<span class="comment"># apt -y install make gcc ipvsadm build-essential pkg-config automake autoconf libipset-dev \</span></span><br><span class="line">   libnl-3-dev libnl-genl-3-dev libssl-dev libxtables-dev libip4tc-dev libip6tc-dev libipset-dev libmagic-dev \</span><br><span class="line">   libsnmp-dev libglib2.0-dev libpcre2-dev libnftnl-dev libmnl-dev libsystemd-dev</span><br><span class="line"></span><br><span class="line"><span class="comment">#Ubuntu18.04安装相关包</span></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment"># apt update </span></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment"># apt -y install gcc curl openssl libssl-dev libpopt-dev daemon build-essential</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#红帽系统安装相关包</span></span><br><span class="line">[root@centos7 ~]<span class="comment"># yum install gcc curl openssl-devel libnl3-devel net-snmp-devel</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#下载解压</span></span><br><span class="line">[root@centos7 ~]<span class="comment"># wget https://keepalived.org/software/keepalived-2.0.20.tar.gz</span></span><br><span class="line">[root@centos7 ~]<span class="comment"># tar xvf keepalived-2.0.20.tar.gz -C /usr/local/src</span></span><br><span class="line">[root@centos7 ~]<span class="comment"># cd /usr/local/src/keepalived-2.0.20/</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#选项--disable-fwmark 可用于禁用iptables规则,可防止VIP无法访问,无此选项默认会启用iptables规则</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@centos7 keepalived-2.0.20]<span class="comment"># ./configure --prefix=/usr/local/keepalived #--disable-fwmark</span></span><br><span class="line"></span><br><span class="line">[root@centos7 keepalived-2.0.20]<span class="comment"># make &amp;&amp; make install</span></span><br><span class="line">[root@centos7 keepalived-2.0.20]<span class="comment"># cd</span></span><br><span class="line">[root@centos7 ~]<span class="comment"># /usr/local/keepalived/sbin/keepalived -v</span></span><br><span class="line">Keepalived v2.0.20 (01/22,2020)</span><br><span class="line"></span><br><span class="line"><span class="comment">#默认会自动生成unit文件</span></span><br><span class="line">[root@centos7 ~]<span class="comment"># cp ./keepalived/keepalived.service /lib/systemd/system/</span></span><br><span class="line">[root@centos7 ~]<span class="comment"># cat /usr/lib/systemd/system/keepalived.service</span></span><br><span class="line">[Unit]</span><br><span class="line">Description=LVS and VRRP High Availability Monitor</span><br><span class="line">After=network-online.target syslog.target </span><br><span class="line">Wants=network-online.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">Type=forking</span><br><span class="line">PIDFile=/run/keepalived.pid</span><br><span class="line">KillMode=process</span><br><span class="line">EnvironmentFile=-/usr/local/keepalived/etc/sysconfig/keepalived</span><br><span class="line">ExecStart=/usr/local/keepalived/sbin/keepalived <span class="variable">$KEEPALIVED_OPTIONS</span></span><br><span class="line">ExecReload=/bin/kill -HUP <span class="variable">$MAINPID</span></span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@centos7 ~]<span class="comment"># cat /usr/local/keepalived/etc/sysconfig/keepalived</span></span><br><span class="line"><span class="comment"># Options for keepalived. See `keepalived --help&#x27; output and keepalived(8) and</span></span><br><span class="line"><span class="comment"># keepalived.conf(5) man pages for a list of all options. Here are the most</span></span><br><span class="line"><span class="comment"># common ones :</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># --vrrp               -P   Only run with VRRP subsystem.</span></span><br><span class="line"><span class="comment"># --check             -C   Only run with Health-checker subsystem.</span></span><br><span class="line"><span class="comment"># --dont-release-vrrp -V   Dont remove VRRP VIPs &amp; VROUTEs on daemon stop.</span></span><br><span class="line"><span class="comment"># --dont-release-ipvs -I   Dont remove IPVS topology on daemon stop.</span></span><br><span class="line"><span class="comment"># --dump-conf         -d   Dump the configuration data.</span></span><br><span class="line"><span class="comment"># --log-detail         -D   Detailed log messages.</span></span><br><span class="line"><span class="comment"># --log-facility       -S   0-7 Set local syslog facility (default=LOG_DAEMON)</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line">KEEPALIVED_OPTIONS=<span class="string">&quot;-D&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#默认无法启动</span></span><br><span class="line">[root@centos7 ~]<span class="comment"># systemctl start keepalived.service </span></span><br><span class="line">Job <span class="keyword">for</span> keepalived.service failed because the control process exited with error </span><br><span class="line">code. See <span class="string">&quot;systemctl status keepalived.service&quot;</span> and <span class="string">&quot;journalctl -xe&quot;</span> <span class="keyword">for</span></span><br><span class="line">details.</span><br><span class="line"></span><br><span class="line"><span class="comment">#查看日志，可以看到是因为缺少配置文件导致无法启动</span></span><br><span class="line">[root@centos7 ~]<span class="comment"># journalctl -xe</span></span><br><span class="line">-- Subject: Unit keepalived.service has begun start-up</span><br><span class="line">-- Defined-By: systemd</span><br><span class="line">-- Support: http://lists.freedesktop.org/mailman/listinfo/systemd-devel</span><br><span class="line">--</span><br><span class="line">-- Unit keepalived.service has begun starting up.</span><br><span class="line">Mar 29 00:38:17 centos7.wang.org Keepalived[1123]: Starting Keepalived v2.0.20 </span><br><span class="line">(01/22,2020)</span><br><span class="line">Mar 29 00:38:17 centos7.wang.org Keepalived[1123]: Running on Linux 3.10.0-</span><br><span class="line">1062.el7.x86_64 <span class="comment">#1 SMP Wed Aug 7 </span></span><br><span class="line">Mar 29 00:38:17 centos7.wang.org Keepalived[1123]: Command line: </span><br><span class="line"><span class="string">&#x27;/usr/local/keepalived/sbin/keepalived&#x27;</span> <span class="string">&#x27;-D</span></span><br><span class="line"><span class="string">Mar 29 00:38:17 centos7.wang.org Keepalived[1123]: Unable to find configuration </span></span><br><span class="line"><span class="string">file /etc/keepalived/keepali   #默认配置文件路径</span></span><br><span class="line"><span class="string">Mar 29 00:38:17 centos7.wang.org Keepalived[1123]: Stopped Keepalived v2.0.20 </span></span><br><span class="line"><span class="string">(01/22,2020)</span></span><br><span class="line"><span class="string">Mar 29 00:38:17 centos7.wang.org systemd[1]: keepalived.service: control process </span></span><br><span class="line"><span class="string">exited, code=exited status=</span></span><br><span class="line"><span class="string">Mar 29 00:38:17 centos7.wang.org systemd[1]: Failed to start LVS and VRRP High </span></span><br><span class="line"><span class="string">Availability Monitor.</span></span><br><span class="line"><span class="string">-- Subject: Unit keepalived.service has failed</span></span><br><span class="line"><span class="string">-- Defined-By: systemd</span></span><br><span class="line"><span class="string">-- Support: http://lists.freedesktop.org/mailman/listinfo/systemd-devel</span></span><br><span class="line"><span class="string">--</span></span><br><span class="line"><span class="string">-- Unit keepalived.service has failed.</span></span><br><span class="line"><span class="string">--</span></span><br><span class="line"><span class="string">-- The result is failed.</span></span><br><span class="line"><span class="string">Mar 29 00:38:17 centos7.wang.org systemd[1]: Unit keepalived.service entered </span></span><br><span class="line"><span class="string">failed state.</span></span><br><span class="line"><span class="string">Mar 29 00:38:17 centos7.wang.org systemd[1]: keepalived.service failed.</span></span><br><span class="line"><span class="string">Mar 29 00:38:17 centos7.wang.org polkitd[565]: Unregistered Authentication Agent </span></span><br><span class="line"><span class="string">for unix-process:1117:11546</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">#创建配置文件</span></span><br><span class="line"><span class="string">[root@centos7 ~]# mkdir /etc/keepalived</span></span><br><span class="line"><span class="string">[root@centos7 ~]# cp /usr/local/keepalived/etc/keepalived/keepalived.conf.sample /etc/keepalived/keepalived.conf</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">#再次启动成功</span></span><br><span class="line"><span class="string">[root@centos7 ~]# systemctl enable --now keepalived.service </span></span><br><span class="line"><span class="string">Created symlink from /etc/systemd/system/multi-user.target.wants/keepalived.service to </span></span><br><span class="line"><span class="string">/usr/lib/systemd/system/keepalived.service.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">[root@centos7 ~]# ip a</span></span><br><span class="line"><span class="string">1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group </span></span><br><span class="line"><span class="string">default qlen 1000</span></span><br><span class="line"><span class="string">   link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00</span></span><br><span class="line"><span class="string">   inet 127.0.0.1/8 scope host lo</span></span><br><span class="line"><span class="string">       valid_lft forever preferred_lft forever</span></span><br><span class="line"><span class="string">   inet6 ::1/128 scope host </span></span><br><span class="line"><span class="string">       valid_lft forever preferred_lft forever</span></span><br><span class="line"><span class="string">2: eth0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc pfifo_fast state UP </span></span><br><span class="line"><span class="string">group default qlen 1000</span></span><br><span class="line"><span class="string">   link/ether 00:0c:29:32:80:38 brd ff:ff:ff:ff:ff:ff</span></span><br><span class="line"><span class="string">   inet 10.0.0.7/24 brd 10.0.0.255 scope global noprefixroute eth0</span></span><br><span class="line"><span class="string">       valid_lft forever preferred_lft forever</span></span><br><span class="line"><span class="string">   inet 192.168.200.16/32 scope global eth0</span></span><br><span class="line"><span class="string">       valid_lft forever preferred_lft forever</span></span><br><span class="line"><span class="string">   inet 192.168.200.17/32 scope global eth0</span></span><br><span class="line"><span class="string">       valid_lft forever preferred_lft forever</span></span><br><span class="line"><span class="string">   inet 192.168.200.18/32 scope global eth0</span></span><br><span class="line"><span class="string">       valid_lft forever preferred_lft forever</span></span><br><span class="line"><span class="string">   inet6 fe80::20c:29ff:fe32:8038/64 scope link </span></span><br><span class="line"><span class="string">       valid_lft forever preferred_lft forever</span></span><br><span class="line"><span class="string">       </span></span><br><span class="line"><span class="string">[root@centos7 ~]# hostname -I</span></span><br><span class="line"><span class="string">10.0.0.7 192.168.200.16 192.168.200.17 192.168.200.18 </span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">[root@centos7 ~]# ping 192.168.200.16</span></span><br><span class="line"><span class="string">PING 192.168.200.16 (192.168.200.16) 56(84) bytes of data.</span></span><br><span class="line"><span class="string">ping: sendmsg: Operation not permitted</span></span><br><span class="line"><span class="string">ping: sendmsg: Operation not permitted</span></span><br><span class="line"><span class="string">^C</span></span><br><span class="line"><span class="string">--- 192.168.200.16 ping statistics ---</span></span><br><span class="line"><span class="string">2 packets transmitted, 0 received, 100% packet loss, time 1000ms</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">#默认生成iptables规则,无法访问VIP,编译时可以加--disable-fwmark禁用生成iptables规则</span></span><br><span class="line"><span class="string">[root@centos7 ~]# iptables -vnL</span></span><br><span class="line"><span class="string">Chain INPUT (policy ACCEPT 860 packets, 46129 bytes)</span></span><br><span class="line"><span class="string"> pkts bytes target     prot opt in     out     source               destination </span></span><br><span class="line"><span class="string">    0     0 DROP       all  -- *     *       0.0.0.0/0       </span></span><br><span class="line"><span class="string">192.168.200.18      </span></span><br><span class="line"><span class="string">    0     0 DROP       all  -- *     *       0.0.0.0/0       </span></span><br><span class="line"><span class="string">192.168.200.17      </span></span><br><span class="line"><span class="string">    0     0 DROP       all  -- *     *       0.0.0.0/0       </span></span><br><span class="line"><span class="string">192.168.200.16      </span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Chain FORWARD (policy ACCEPT 0 packets, 0 bytes)</span></span><br><span class="line"><span class="string"> pkts bytes target     prot opt in     out     source               destination </span></span><br><span class="line"><span class="string">        </span></span><br><span class="line"><span class="string">Chain OUTPUT (policy ACCEPT 1737 packets, 1188K bytes)</span></span><br><span class="line"><span class="string"> pkts bytes target     prot opt in     out     source               destination </span></span><br><span class="line"><span class="string">        </span></span><br><span class="line"><span class="string">    4   336 DROP       all  -- *     *       192.168.200.18       0.0.0.0/0   </span></span><br><span class="line"><span class="string">    0     0 DROP       all  -- *     *       192.168.200.17       0.0.0.0/0   </span></span><br><span class="line"><span class="string">    0     0 DROP       all  -- *     *       192.168.200.16       0.0.0.0/0  </span></span><br><span class="line"><span class="string">    </span></span><br><span class="line"><span class="string">[root@centos7 ~]# vim /etc/keepalived/keepalived.conf</span></span><br><span class="line"><span class="string">#注释下面一行</span></span><br><span class="line"><span class="string">#vrrp_strict</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">#重启动不生效，有bug</span></span><br><span class="line"><span class="string">[root@centos7 ~]# systemctl restart keepalived.service </span></span><br><span class="line"><span class="string">[root@centos7 ~]# ping 192.168.200.16</span></span><br><span class="line"><span class="string">PING 192.168.200.16 (192.168.200.16) 56(84) bytes of data.</span></span><br><span class="line"><span class="string">ping: sendmsg: Operation not permitted</span></span><br><span class="line"><span class="string">ping: sendmsg: Operation not permitted</span></span><br><span class="line"><span class="string">^C</span></span><br><span class="line"><span class="string">--- 192.168.200.16 ping statistics ---</span></span><br><span class="line"><span class="string">2 packets transmitted, 0 received, 100% packet loss, time 999ms</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">#无法关闭进程</span></span><br><span class="line"><span class="string">[root@centos7 ~]# systemctl stop keepalived.service </span></span><br><span class="line"><span class="string">[root@centos7 ~]# ps aux|grep keepalived</span></span><br><span class="line"><span class="string">root       1383  0.0  0.1  69672  1020 ?       Ss   00:57   0:00 /usr/local/keepalived/sbin/keepalived -D</span></span><br><span class="line"><span class="string">root       1384  0.0  0.2  69804  2308 ?       S    00:57   0:00 /usr/local/keepalived/sbin/keepalived -D</span></span><br><span class="line"><span class="string">root       1385  0.0  0.1  69672  1308 ?       S    00:57   0:00 /usr/local/keepalived/sbin/keepalived -D</span></span><br><span class="line"><span class="string">root       1392  0.0  0.0 112712   964 pts/0   R+   00:59   0:00 grep --color=auto keepalived</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">[root@centos7 ~]# killall keepalived</span></span><br><span class="line"><span class="string">[root@centos7 ~]# systemctl start keepalived.service </span></span><br><span class="line"><span class="string">[root@centos7 ~]# ping 192.168.200.16</span></span><br><span class="line"><span class="string">PING 192.168.200.16 (192.168.200.16) 56(84) bytes of data.</span></span><br><span class="line"><span class="string">64 bytes from 192.168.200.16: icmp_seq=1 ttl=64 time=0.093 ms</span></span><br><span class="line"><span class="string">^C</span></span><br><span class="line"><span class="string">--- 192.168.200.16 ping statistics ---</span></span><br><span class="line"><span class="string">1 packets transmitted, 1 received, 0% packet loss, time 0ms</span></span><br><span class="line"><span class="string">rtt min/avg/max/mdev = 0.093/0.093/0.093/0.000 ms</span></span><br></pre></td></tr></table></figure>

<h2 id="KeepAlived-配置说明"><a href="#KeepAlived-配置说明" class="headerlink" title="KeepAlived 配置说明"></a>KeepAlived 配置说明</h2><h3 id="配置文件组成部分"><a href="#配置文件组成部分" class="headerlink" title="配置文件组成部分"></a>配置文件组成部分</h3><p>配置文件</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/etc/keepalived/keepalived.conf</span><br></pre></td></tr></table></figure>

<p>配置文件组成</p>
<ul>
<li><p>GLOBAL CONFIGURATION</p>
<p>Global definitions：定义邮件配置，route_id，vrrp配置，多播地址等</p>
</li>
<li><p>VRRP CONFIGURATION</p>
<p>VRRP instance(s)：定义每个vrrp虚拟路由器</p>
</li>
<li><p>LVS CONFIGURATION</p>
<p>Virtual server group(s)</p>
<p>Virtual server(s)：LVS集群的VS和RS</p>
</li>
</ul>
<h3 id="配置语法说明"><a href="#配置语法说明" class="headerlink" title="配置语法说明"></a>配置语法说明</h3><p>帮助</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">man keepalived.conf</span><br></pre></td></tr></table></figure>

<h4 id="全局配置"><a href="#全局配置" class="headerlink" title="全局配置"></a>全局配置</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#/etc/keepalived/keepalived.conf </span></span><br><span class="line">global_defs &#123;</span><br><span class="line">    notification_email &#123;</span><br><span class="line">    	root@localhost <span class="comment">#keepalived 发生故障切换时邮件发送的目标邮箱，可以按行区分写多个</span></span><br><span class="line">    	root@wangxiaochun.com </span><br><span class="line">     	29308620@qq.com </span><br><span class="line">    &#125;</span><br><span class="line">    notification_email_from keepalived@localhost  <span class="comment">#发邮件的地址</span></span><br><span class="line">    smtp_server 127.0.0.1     <span class="comment">#邮件服务器地址</span></span><br><span class="line">    smtp_connect_timeout 30   <span class="comment">#邮件服务器连接timeout</span></span><br><span class="line">    router_id ka1.example.com <span class="comment">#每个keepalived主机唯一标识，建议使用当前主机名，如果多节点重名可能会影响切换脚本执行</span></span><br><span class="line">    vrrp_skip_check_adv_addr  <span class="comment">#对所有通告报文都检查，会比较消耗性能，启用此配置后，如果收到的通告报文和上一个报文是同一个路由器，则跳过检查，默认值为全检查</span></span><br><span class="line">    vrrp_strict <span class="comment">#严格遵守VRRP协议,启用此项后以下状况将无法启动服务:1.无VIP地址 2.配置了单播邻居 3.在VRRP版本2中有IPv6地址，开启动此项并且没有配置vrrp_iptables时会自动开启iptables防火墙规则，默认导致VIP无法访问,建议不加此项配置</span></span><br><span class="line">    vrrp_garp_interval 0 <span class="comment">#gratuitous ARP messages 报文发送延迟，0表示不延迟</span></span><br><span class="line">    vrrp_gna_interval 0  <span class="comment">#unsolicited NA messages （不请自来）消息发送延迟</span></span><br><span class="line">    vrrp_mcast_group4 224.0.0.18 <span class="comment">#指定组播IP地址范围：224.0.0.0到239.255.255.255,默认值：224.0.0.18 </span></span><br><span class="line">    vrrp_iptables   <span class="comment">#此项和vrrp_strict同时开启时，则不会添加防火墙规则,如果无配置vrrp_strict项,则无需启用此项配置，注意：新版加此项仍有iptables规则</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="配置虚拟路由器"><a href="#配置虚拟路由器" class="headerlink" title="配置虚拟路由器"></a>配置虚拟路由器</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">vrrp_instance &lt;STRING&gt; &#123; <span class="comment">#&lt;String&gt;为vrrp的实例名,一般为业务名称</span></span><br><span class="line">	配置参数</span><br><span class="line">	......</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">#配置参数：</span></span><br><span class="line">state MASTER|BACKUP		<span class="comment">#当前节点在此虚拟路由器上的初始状态，状态为MASTER或者BACKUP，当priority相同时，Master节点优先获取VIP</span></span><br><span class="line">interface IFACE_NAME 	<span class="comment">#绑定为当前VRRP虚拟路由器使用的物理接口，如：eth0,bond0,br0,可以和VIP不在一个网卡</span></span><br><span class="line"></span><br><span class="line">virtual_router_id VRID	 <span class="comment">#每个虚拟路由器唯一标识，范围：0-255，每个虚拟路由器此值必须唯一，否则服务无法启动，同属一个虚拟路由器的多个keepalived节点必须相同,务必要确认在同一网络中此值必须唯一</span></span><br><span class="line">priority 100             <span class="comment">#当前物理节点在此虚拟路由器的优先级，范围：1-254，每个keepalived主机节点此值不同</span></span><br><span class="line">advert_int 1             <span class="comment">#vrrp通告的时间间隔，默认1s</span></span><br><span class="line">authentication &#123;         <span class="comment">#认证机制</span></span><br><span class="line"> 	auth_type AH|PASS    <span class="comment">#AH为IPSEC认证(不推荐),PASS为简单密码(建议使用)</span></span><br><span class="line">	auth_pass &lt;PASSWORD&gt; <span class="comment">#预共享密钥，仅前8位有效，同一个虚拟路由器的多个keepalived节点必须一样</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">virtual_ipaddress &#123; <span class="comment">#虚拟IP,生产环境可能指定几十上百个VIP地址</span></span><br><span class="line">	&lt;IPADDR&gt;/&lt;MASK&gt; brd &lt;IPADDR&gt; dev &lt;STRING&gt; scope &lt;SCOPE&gt; label &lt;LABEL&gt;</span><br><span class="line"> 	192.168.200.100 <span class="comment">#指定VIP，不指定网卡，默认为eth0,注意：不指定/prefix,默认为/32</span></span><br><span class="line"> 	192.168.200.101/24 dev eth1   <span class="comment">#指定VIP的网卡，建议和interface指令指定的网卡不在一个网卡</span></span><br><span class="line">     192.168.200.102/24 dev eth2 label eth2:1 <span class="comment">#指定VIP的网卡label </span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">track_interface &#123; <span class="comment">#配置监控网络接口，一旦出现故障，则转为FAULT状态实现地址转移</span></span><br><span class="line">	eth0</span><br><span class="line">	eth1</span><br><span class="line">	…</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>范例：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line">[root@centos7 ~]<span class="comment"># cat /etc/keepalived/keepalived.conf</span></span><br><span class="line">! Configuration File <span class="keyword">for</span> keepalived</span><br><span class="line">global_defs &#123;</span><br><span class="line">   notification_email &#123;</span><br><span class="line">     acassen@firewall.loc</span><br><span class="line">     failover@firewall.loc</span><br><span class="line">     sysadmin@firewall.loc</span><br><span class="line">   &#125;</span><br><span class="line">   notification_email_from Alexandre.Cassen@firewall.loc</span><br><span class="line">   smtp_server 192.168.200.1</span><br><span class="line">   smtp_connect_timeout 30</span><br><span class="line">   router_id LVS_DEVEL</span><br><span class="line">   vrrp_skip_check_adv_addr</span><br><span class="line">   vrrp_strict <span class="comment">#开启限制，会自动生效防火墙设置，导致无访问VIP</span></span><br><span class="line">   vrrp_garp_interval 0</span><br><span class="line">   vrrp_gna_interval 0</span><br><span class="line">&#125;</span><br><span class="line">vrrp_instance VI_1 &#123;</span><br><span class="line">   state MASTER</span><br><span class="line">   interface eth0</span><br><span class="line">   virtual_router_id 80 <span class="comment">#修改此行</span></span><br><span class="line">   priority 100</span><br><span class="line">   advert_int 1</span><br><span class="line">   authentication &#123;</span><br><span class="line">       auth_type PASS</span><br><span class="line">       auth_pass 1111</span><br><span class="line">   &#125;</span><br><span class="line">   virtual_ipaddress &#123;</span><br><span class="line">        192.168.200.16</span><br><span class="line">        192.168.200.17</span><br><span class="line">        192.168.200.18</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@centos7 ~]<span class="comment"># systemctl start keepalived.service </span></span><br><span class="line">[root@centos7 ~]<span class="comment"># ip a</span></span><br><span class="line">1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group </span><br><span class="line">default qlen 1000</span><br><span class="line">   <span class="built_in">link</span>/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00</span><br><span class="line">   inet 127.0.0.1/8 scope host lo</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">   inet6 ::1/128 scope host </span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">2: eth0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc pfifo_fast state UP </span><br><span class="line">group default qlen 1000</span><br><span class="line">   <span class="built_in">link</span>/ether 00:0c:29:33:b4:1a brd ff:ff:ff:ff:ff:ff</span><br><span class="line">   inet 10.0.0.17/24 brd 10.0.0.255 scope global noprefixroute eth0</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">   inet 192.168.200.16/32 scope global eth0</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">   inet 192.168.200.17/32 scope global eth0</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">   inet 192.168.200.18/32 scope global eth0</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">   inet6 fe80::20c:29ff:fe33:b41a/64 scope <span class="built_in">link</span> </span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line"></span><br><span class="line">[root@centos7 ~]<span class="comment"># ping 192.168.200.16</span></span><br><span class="line">PING 192.168.200.16 (192.168.200.16) 56(84) bytes of data.</span><br><span class="line">^C</span><br><span class="line">--- 192.168.200.16 ping statistics ---</span><br><span class="line">6 packets transmitted, 0 received, 100% packet loss, time 5002ms</span><br><span class="line"></span><br><span class="line"><span class="comment"># 如果是CentOS 8 ，会显示以下warning </span></span><br><span class="line">[root@centos8 ~]<span class="comment">#iptables -vnL</span></span><br><span class="line">Chain INPUT (policy ACCEPT 0 packets, 0 bytes)</span><br><span class="line"> pkts bytes target     prot opt <span class="keyword">in</span>     out     <span class="built_in">source</span>               destination </span><br><span class="line">        </span><br><span class="line">Chain FORWARD (policy ACCEPT 0 packets, 0 bytes)</span><br><span class="line"> pkts bytes target     prot opt <span class="keyword">in</span>     out     <span class="built_in">source</span>               destination </span><br><span class="line">        </span><br><span class="line">Chain OUTPUT (policy ACCEPT 0 packets, 0 bytes)</span><br><span class="line"> pkts bytes target     prot opt <span class="keyword">in</span>     out     <span class="built_in">source</span>               destination </span><br><span class="line">        </span><br><span class="line"><span class="comment"># Warning: iptables-legacy tables present, use iptables-legacy to see them</span></span><br><span class="line"><span class="comment">#无法访问VIP</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># ping 192.168.200.16</span></span><br><span class="line">PING 192.168.200.16 (192.168.200.16) 56(84) bytes of data.</span><br><span class="line">^C</span><br><span class="line">--- 192.168.200.16 ping statistics ---</span><br><span class="line">6 packets transmitted, 0 received, 100% packet loss, time 143ms</span><br></pre></td></tr></table></figure>

<h2 id="启用-Keepalived-日志功能"><a href="#启用-Keepalived-日志功能" class="headerlink" title="启用 Keepalived 日志功能"></a>启用 Keepalived 日志功能</h2><p>范例：包安装实现日志功能,注意: 编译安装可能有问题</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">[root@ka1 ~]<span class="comment"># vim /etc/sysconfig/keepalived</span></span><br><span class="line">KEEPALIVED_OPTIONS=<span class="string">&quot;-D -S 6&quot;</span></span><br><span class="line"></span><br><span class="line">[root@ka1 ~]<span class="comment"># vim /etc/rsyslog.conf</span></span><br><span class="line">local6.*             /var/log/keepalived.log  </span><br><span class="line"></span><br><span class="line">[root@ka1 ~]<span class="comment"># systemctl restart keepalived.service rsyslog.service </span></span><br><span class="line">[root@ka1 ~]<span class="comment"># tail -f /var/log/keepalived.log </span></span><br><span class="line">Apr 14 09:25:51 ka1 Keepalived_vrrp[1263]: Sending gratuitous ARP on eth0 <span class="keyword">for</span> 10.0.0.10</span><br><span class="line">Apr 14 09:25:51 ka1 Keepalived_vrrp[1263]: Sending gratuitous ARP on eth0 <span class="keyword">for</span> 10.0.0.10</span><br><span class="line">Apr 14 09:25:51 ka1 Keepalived_vrrp[1263]: Sending gratuitous ARP on eth0 <span class="keyword">for</span> 10.0.0.10</span><br><span class="line">Apr 14 09:25:51 ka1 Keepalived_vrrp[1263]: Sending gratuitous ARP on eth0 <span class="keyword">for</span> 10.0.0.10</span><br><span class="line">Apr 14 09:25:56 ka1 Keepalived_vrrp[1263]: Sending gratuitous ARP on eth0 <span class="keyword">for</span> 10.0.0.10</span><br><span class="line">Apr 14 09:25:56 ka1 Keepalived_vrrp[1263]: (VI_1) Sending/queueing gratuitous ARPs on eth0 <span class="keyword">for</span> 10.0.0.10</span><br><span class="line">Apr 14 09:25:56 ka1 Keepalived_vrrp[1263]: Sending gratuitous ARP on eth0 <span class="keyword">for</span> 10.0.0.10</span><br><span class="line">Apr 14 09:25:56 ka1 Keepalived_vrrp[1263]: Sending gratuitous ARP on eth0 <span class="keyword">for</span> 10.0.0.10</span><br><span class="line">Apr 14 09:25:56 ka1 Keepalived_vrrp[1263]: Sending gratuitous ARP on eth0 <span class="keyword">for</span> 10.0.0.10</span><br><span class="line">Apr 14 09:25:56 ka1 Keepalived_vrrp[1263]: Sending gratuitous ARP on eth0 <span class="keyword">for</span> 10.0.0.10</span><br></pre></td></tr></table></figure>

<h2 id="实现-Keepalived-独立子配置文件"><a href="#实现-Keepalived-独立子配置文件" class="headerlink" title="实现 Keepalived 独立子配置文件"></a>实现 Keepalived 独立子配置文件</h2><p>当生产环境复杂时， /etc/keepalived/keepalived.conf 文件中保存所有集群的配置会导致内容过多，不易管理</p>
<p>可以将不同集群的配置，比如：不同集群的VIP配置放在独立的子配置文件中</p>
<p>利用include 指令可以实现包含子配置文件</p>
<p>格式:</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">include /path/file</span><br></pre></td></tr></table></figure>

<p>范例:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">[root@ka1-centos8 ~]<span class="comment"># mkdir /etc/keepalived/conf.d/</span></span><br><span class="line">[root@ka1-centos8 ~]<span class="comment"># vim /etc/keepalived/keepalived.conf</span></span><br><span class="line">global_defs &#123;</span><br><span class="line">   notification_email &#123;</span><br><span class="line">        29308620@qq.com</span><br><span class="line">   &#125;</span><br><span class="line">   notification_email_from 29308620@qq.com </span><br><span class="line">   smtp_server 127.0.0.1</span><br><span class="line">   smtp_connect_timeout 30</span><br><span class="line">   router_id ka1.wang.org </span><br><span class="line">   vrrp_skip_check_adv_addr</span><br><span class="line">   vrrp_garp_interval 0</span><br><span class="line">   vrrp_gna_interval 0</span><br><span class="line">&#125;</span><br><span class="line">include /etc/keepalived/conf.d/*.conf   <span class="comment">#将VRRP相关配置放在子配置文件中</span></span><br><span class="line"></span><br><span class="line">[root@ka1-centos8 ~]<span class="comment"># vim /etc/keepalived/conf.d/cluster1.conf</span></span><br></pre></td></tr></table></figure>

<h1 id="Keepalived-实现-VRRP"><a href="#Keepalived-实现-VRRP" class="headerlink" title="Keepalived 实现 VRRP"></a>Keepalived 实现 VRRP</h1><h2 id="实现master-slave的-Keepalived-单主架构"><a href="#实现master-slave的-Keepalived-单主架构" class="headerlink" title="实现master/slave的 Keepalived 单主架构"></a>实现master/slave的 Keepalived 单主架构</h2><h3 id="MASTER配置"><a href="#MASTER配置" class="headerlink" title="MASTER配置"></a>MASTER配置</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">[root@ka1-centos8 ~]<span class="comment"># vim /etc/keepalived/keepalived.conf </span></span><br><span class="line">global_defs &#123;</span><br><span class="line">	notification_email &#123;</span><br><span class="line">		root@localhost <span class="comment">#keepalived 发生故障切换时邮件发送的对象，可以按行区分写多个</span></span><br><span class="line">	&#125;</span><br><span class="line">	notification_email_from keepalived@localhost</span><br><span class="line">	smtp_server 127.0.0.1</span><br><span class="line">	smtp_connect_timeout 30</span><br><span class="line">	router_id ka1.example.com</span><br><span class="line">	vrrp_skip_check_adv_addr  <span class="comment">#所有报文都检查比较消耗性能，此配置为如果收到的报文和上一个报文是同一个路由器则跳过检查报文中的源地址</span></span><br><span class="line">    <span class="comment">#vrrp_strict #严格遵守VRRP协议,禁止状况:1.无VIP地址,2.配置了单播邻居,3.在VRRP版本2中有IPv6地址</span></span><br><span class="line">	vrrp_garp_interval 0     <span class="comment">#ARP报文发送延迟</span></span><br><span class="line">	vrrp_gna_interval 0      <span class="comment">#消息发送延迟</span></span><br><span class="line">	vrrp_mcast_group4 224.0.0.18  <span class="comment">#默认组播IP地址，可指定组播范围：224.0.0.0到239.255.255.255</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">vrrp_instance VI_1 &#123;</span><br><span class="line">	state MASTER            <span class="comment">#在另一个节点上为BACKUP,如果当priority 相同时,Master节点优先获取VIP</span></span><br><span class="line">	interface eth0</span><br><span class="line">	virtual_router_id 66    <span class="comment">#每个虚拟路由器必须唯一，同属一个虚拟路由器的多个keepalived节点必须相同</span></span><br><span class="line">	priority 100            <span class="comment">#在另一个结点上为80</span></span><br><span class="line">	advert_int 1</span><br><span class="line">	authentication &#123;</span><br><span class="line">  		auth_type PASS      <span class="comment">#预共享密钥认证，同一个虚拟路由器的keepalived节点必须一样</span></span><br><span class="line">  		auth_pass 12345678</span><br><span class="line"> &#125;</span><br><span class="line"> </span><br><span class="line">	virtual_ipaddress &#123;</span><br><span class="line"> 		10.0.0.10 dev eth0 label eth0:0</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="BACKUP配置"><a href="#BACKUP配置" class="headerlink" title="BACKUP配置"></a>BACKUP配置</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#配置文件和master基本一致，只需修改三行</span></span><br><span class="line">[root@ka2-centos8 ~]<span class="comment"># vim /etc/keepalived/keepalived.conf </span></span><br><span class="line">global_defs &#123;</span><br><span class="line">	notification_email &#123;</span><br><span class="line">		root@localhost</span><br><span class="line">	&#125;</span><br><span class="line">	notification_email_from keepalived@localhost</span><br><span class="line">	smtp_server 127.0.0.1</span><br><span class="line">	smtp_connect_timeout 30</span><br><span class="line">	router_id ka2.example.com         <span class="comment">#修改此行</span></span><br><span class="line">	vrrp_skip_check_adv_addr </span><br><span class="line">	<span class="comment">#vrrp_strict </span></span><br><span class="line">	vrrp_garp_interval 0</span><br><span class="line">	vrrp_gna_interval 0</span><br><span class="line">	vrrp_mcast_group4 224.0.0.18</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">vrrp_instance VI_1 &#123;</span><br><span class="line">	state BACKUP <span class="comment">#修改此行</span></span><br><span class="line">	interface eth0</span><br><span class="line">	virtual_router_id 66 </span><br><span class="line">	priority 80 <span class="comment">#修改此行</span></span><br><span class="line">	advert_int 1</span><br><span class="line">	authentication &#123;</span><br><span class="line">		auth_type PASS</span><br><span class="line">		auth_pass 12345678</span><br><span class="line">	&#125;</span><br><span class="line">	virtual_ipaddress &#123;</span><br><span class="line">    	10.0.0.10 dev eth0 label eth0:0</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>抓包观察</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tcpdump -i eth0 -nn host 224.0.0.18</span><br></pre></td></tr></table></figure>

<p>VRRP 协议包</p>
<p><img src="../../../../images/SRE/day48/6.jpg" alt="6"></p>
<h3 id="脑裂"><a href="#脑裂" class="headerlink" title="脑裂"></a>脑裂</h3><p>主备节点同时拥有同一个VIP，此时为脑裂理象</p>
<p>注意：脑裂现象原因</p>
<ul>
<li>心跳线故障： 通过修改网卡的工作模式实现模拟，断开网卡方式无法模拟 </li>
<li>防火墙错误配置：在从节点服务器执行iptables -A INPUT -s 主服务心跳网卡IP -j DROP 进行模拟</li>
<li>Keepalived 配置错误：interface错误，virtual_router_id不一致，密码不一致，优先级相同</li>
</ul>
<p>范例: 发现脑裂</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@centos7 ~]<span class="comment"># arping -I eth1 -c1 10.0.0.100</span></span><br><span class="line">ARPING 10.0.0.100 from 192.168.10.130 eth1</span><br><span class="line">Unicast reply from 10.0.0.100 [00:0C:29:7E:DA:E6]  0.801ms</span><br><span class="line">Unicast reply from 10.0.0.100 [00:0C:29:97:AF:4F]  0.814ms</span><br><span class="line">Sent 1 probes (1 broadcast(s))</span><br><span class="line">Received 2 response(s)</span><br></pre></td></tr></table></figure>

<h2 id="抢占模式和非抢占模式"><a href="#抢占模式和非抢占模式" class="headerlink" title="抢占模式和非抢占模式"></a>抢占模式和非抢占模式</h2><h3 id="非抢占模式-nopreempt"><a href="#非抢占模式-nopreempt" class="headerlink" title="非抢占模式 nopreempt"></a>非抢占模式 nopreempt</h3><p>默认为抢占模式 preempt，即当高优先级的主机恢复在线后，会抢占低先级的主机的master角色，造成网络抖动，建议设置为非抢占模式 nopreempt ，即高优先级主机恢复后，并不会抢占低优先级主机的 master 角色</p>
<p>注意: 非抢占模式下,如果原主机down机, VIP迁移至的新主机, 后续新主机也发生down（（keepalived 服务down））时,VIP还会迁移回修复好的原主机</p>
<p>但如果新主机的服务down掉（keepalived服务正常），原主机也不会接管VIP，仍会由新主机拥有VIP即非抢占式模式，只是适合当主节点宕机，切换到从节点的一次性的高可用性，后续即使当原主节点修复好，仍无法再次起到高用功能</p>
<p><strong>注意：要关闭 VIP抢占，必须将各 Keepalived 服务器 state 配置为 BACKUP</strong></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#ha1主机配置</span></span><br><span class="line">vrrp_instance VI_1 &#123;</span><br><span class="line">	state BACKUP          <span class="comment">#都为BACKUP</span></span><br><span class="line">	interface eth0</span><br><span class="line">	virtual_router_id 66</span><br><span class="line">	priority 100          <span class="comment">#优先级高</span></span><br><span class="line">	advert_int 1</span><br><span class="line">	nopreempt             <span class="comment">#添加此行，设为nopreempt</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#ha2主机配置</span></span><br><span class="line">vrrp_instance VI_1 &#123;</span><br><span class="line">    state BACKUP          <span class="comment">#都为BACKUP</span></span><br><span class="line">    interface eth0</span><br><span class="line">    virtual_router_id 66</span><br><span class="line">    priority 80           <span class="comment">#优先级低</span></span><br><span class="line">    advert_int 1</span><br><span class="line">    <span class="comment">#nopreempt            #注意：如果ka2主机也是非抢占式，会导致ka1即使优先级降低于ka2，VIP也不会切换至ka2</span></span><br></pre></td></tr></table></figure>

<h3 id="抢占延迟模式-preempt-delay"><a href="#抢占延迟模式-preempt-delay" class="headerlink" title="抢占延迟模式 preempt_delay"></a>抢占延迟模式 preempt_delay</h3><p>抢占延迟模式，即优先级高的主机恢复后，不会立即抢回VIP，而是延迟一段时间（默认300s）再抢回 VIP</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">preempt_delay <span class="comment">#     #指定抢占延迟时间为#s，默认延迟300s</span></span><br></pre></td></tr></table></figure>

<p><strong>注意：需要各keepalived服务器state为BACKUP,并且不要启用 vrrp_strict</strong></p>
<p>范例：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#ka1主机配置</span></span><br><span class="line">vrrp_instance VI_1 &#123;</span><br><span class="line">	state BACKUP     <span class="comment">#都为BACKUP</span></span><br><span class="line">    interface eth0</span><br><span class="line">    virtual_router_id 66</span><br><span class="line">    priority 100 <span class="comment">#优先级高</span></span><br><span class="line">    advert_int 1</span><br><span class="line">    preempt_delay 60    <span class="comment">#抢占延迟模式，默认延迟300s</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#ka2主机配置</span></span><br><span class="line">vrrp_instance VI_1 &#123;</span><br><span class="line">    state BACKUP       <span class="comment">#都为BACKUP</span></span><br><span class="line">    interface eth0</span><br><span class="line">    virtual_router_id 66</span><br><span class="line">    priority 80 <span class="comment">#优先级低</span></span><br><span class="line">    advert_int 1</span><br></pre></td></tr></table></figure>

<h2 id="VIP-单播配置"><a href="#VIP-单播配置" class="headerlink" title="VIP 单播配置"></a>VIP 单播配置</h2><p>默认keepalived主机之间利用多播相互通告消息，会造成网络拥塞，可以替换成单播，减少网络流量</p>
<p>另外：有些公有云不支持多播，可以利用单播实现</p>
<p><strong>注意：启用 vrrp_strict 时，不能启用单播</strong></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#在所有节点vrrp_instance语句块中设置对方主机的IP，建议设置为专用于对应心跳线网络的地址，而非使用业务网络</span></span><br><span class="line">unicast_src_ip &lt;IPADDR&gt;    <span class="comment">#指定发送单播的源IP</span></span><br><span class="line">unicast_peer &#123;</span><br><span class="line">	&lt;IPADDR&gt;               <span class="comment">#指定接收单播的对方目标主机IP</span></span><br><span class="line">	......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>范例：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#master 主机配置</span></span><br><span class="line">[root@ka1-centos8 ~]<span class="comment"># cat /etc/keepalived/keepalived.conf</span></span><br><span class="line">! Configuration File <span class="keyword">for</span> keepalived</span><br><span class="line"></span><br><span class="line">global_defs &#123;</span><br><span class="line">    notification_email &#123;</span><br><span class="line">    	acassen@firewall.loc</span><br><span class="line">    	failover@firewall.loc</span><br><span class="line">    	sysadmin@firewall.loc</span><br><span class="line">    &#125;</span><br><span class="line">    notification_email_from Alexandre.Cassen@firewall.loc</span><br><span class="line">    smtp_server 192.168.200.1</span><br><span class="line">    smtp_connect_timeout 30</span><br><span class="line">    router_id ka1.wang.org</span><br><span class="line">    vrrp_skip_check_adv_addr</span><br><span class="line">    <span class="comment">#vrrp_strict</span></span><br><span class="line">    vrrp_garp_interval 0</span><br><span class="line">    vrrp_gna_interval 0</span><br><span class="line">    vrrp_mcast_group4 239.0.0.0  <span class="comment">#单播优先于多播,即配置了单播后，多播将失效</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">vrrp_instance VI_1 &#123;</span><br><span class="line">    state MASTER</span><br><span class="line">    interface eth0</span><br><span class="line">    virtual_router_id 66</span><br><span class="line">    priority 100</span><br><span class="line">    advert_int 1</span><br><span class="line">    authentication &#123;</span><br><span class="line">        auth_type PASS</span><br><span class="line">        auth_pass 123456</span><br><span class="line">    &#125;</span><br><span class="line">    virtual_ipaddress &#123;</span><br><span class="line">        10.0.0.10/24 dev eth0 label eth0:1</span><br><span class="line">    &#125;</span><br><span class="line">    unicast_src_ip 10.0.0.8     <span class="comment">#本机IP</span></span><br><span class="line">    unicast_peer&#123;</span><br><span class="line">    	10.0.0.18 <span class="comment">#指向对方主机IP</span></span><br><span class="line">    	10.0.0.28 <span class="comment">#如果有多个keepalived,再加其它节点的IP</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">[root@ha1-centos8 ~]<span class="comment"># hostname -I</span></span><br><span class="line">10.0.0.8 10.0.0.10</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#slave 主机配置</span></span><br><span class="line">[root@ka2-centos8 ~]<span class="comment"># cat /etc/keepalived/keepalived.conf</span></span><br><span class="line">! Configuration File <span class="keyword">for</span> keepalived</span><br><span class="line"></span><br><span class="line">global_defs &#123;</span><br><span class="line">    notification_email &#123;</span><br><span class="line">    	acassen@firewall.loc</span><br><span class="line">    	failover@firewall.loc</span><br><span class="line">    	sysadmin@firewall.loc</span><br><span class="line">    &#125;</span><br><span class="line">    notification_email_from Alexandre.Cassen@firewall.loc</span><br><span class="line">    smtp_server 192.168.200.1</span><br><span class="line">    smtp_connect_timeout 30</span><br><span class="line">    router_id ka2.wang.org</span><br><span class="line">    vrrp_skip_check_adv_addr</span><br><span class="line">    <span class="comment">#vrrp_strict</span></span><br><span class="line">    vrrp_garp_interval 0</span><br><span class="line">    vrrp_gna_interval 0</span><br><span class="line">    vrrp_mcast_group4 239.0.0.0  <span class="comment">#单播优先于多播</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">vrrp_instance VI_1 &#123;</span><br><span class="line">    state SLAVE</span><br><span class="line">    interface eth0</span><br><span class="line">    virtual_router_id 66</span><br><span class="line">    priority 80</span><br><span class="line">    advert_int 1</span><br><span class="line">    authentication &#123;</span><br><span class="line">        auth_type PASS</span><br><span class="line">        auth_pass 123456</span><br><span class="line">    &#125;</span><br><span class="line">    virtual_ipaddress &#123;</span><br><span class="line">        10.0.0.10/24 dev eth0 label eth0:1</span><br><span class="line">    &#125;</span><br><span class="line">    unicast_src_ip 10.0.0.18       <span class="comment">#本机IP</span></span><br><span class="line">    unicast_peer &#123;</span><br><span class="line">    	10.0.0.8 <span class="comment">#指向对方主机IP</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">[root@ka2-centos8 ~]<span class="comment"># hostname -I</span></span><br><span class="line">10.0.0.18 </span><br></pre></td></tr></table></figure>

<p>范例: 抓包观察</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">root@centos6 ~]<span class="comment">#tcpdump -i eth0 -nn src host 10.0.0.8 and dst host 10.0.0.18</span></span><br><span class="line">tcpdump: verbose output suppressed, use -v or -vv <span class="keyword">for</span> full protocol decode</span><br><span class="line">listening on eth0, link-type EN10MB (Ethernet), capture size 65535 bytes</span><br><span class="line">23:37:48.069158 IP 10.0.0.8 &gt; 10.0.0.18: VRRPv2, Advertisement, vrid 66, prio 100, authtype simple, intvl 1s, length 20</span><br><span class="line">23:37:49.070013 IP 10.0.0.8 &gt; 10.0.0.18: VRRPv2, Advertisement, vrid 66, prio 100, authtype simple, intvl 1s, length 20</span><br><span class="line">23:37:50.071144 IP 10.0.0.8 &gt; 10.0.0.18: VRRPv2, Advertisement, vrid 66, prio 100, authtype simple, intvl 1s, length 20</span><br></pre></td></tr></table></figure>

<h2 id="Keepalived-通知脚本配置"><a href="#Keepalived-通知脚本配置" class="headerlink" title="Keepalived 通知脚本配置"></a>Keepalived 通知脚本配置</h2><p>当keepalived的状态变化时，可以自动触发脚本的执行，比如：发邮件通知用户</p>
<p>默认以用户keepalived_script身份执行脚本，如果此用户不存在，以root执行脚本 </p>
<p>可以用下面指令指定脚本执行用户的身份</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">global_defs &#123;</span><br><span class="line">	......</span><br><span class="line">	script_user &lt;USER&gt;</span><br><span class="line">	......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="通知脚本类型"><a href="#通知脚本类型" class="headerlink" title="通知脚本类型"></a>通知脚本类型</h3><ul>
<li>当前节点成为主节点时触发的脚本</li>
</ul>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">notify_master &lt;STRING&gt;|&lt;QUOTED-STRING&gt;</span><br></pre></td></tr></table></figure>

<ul>
<li>当前节点转为备节点时触发的脚本</li>
</ul>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">notify_backup &lt;STRING&gt;|&lt;QUOTED-STRING&gt;</span><br></pre></td></tr></table></figure>

<ul>
<li>当前节点转为“失败”状态时触发的脚本</li>
</ul>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">notify_fault &lt;STRING&gt;|&lt;QUOTED-STRING&gt;</span><br></pre></td></tr></table></figure>

<ul>
<li>通用格式的通知触发机制，一个脚本可完成以上三种状态的转换时的通知</li>
</ul>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">notify &lt;STRING&gt;|&lt;QUOTED-STRING&gt;</span><br></pre></td></tr></table></figure>

<ul>
<li>当停止VRRP时触发的脚本</li>
</ul>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">notify_stop &lt;STRING&gt;|&lt;QUOTED-STRING&gt;</span><br></pre></td></tr></table></figure>

<h3 id="脚本的调用方法"><a href="#脚本的调用方法" class="headerlink" title="脚本的调用方法"></a>脚本的调用方法</h3><p>在 vrrp_instance VI_1 语句块的末尾加下面行</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">notify_master &quot;/etc/keepalived/notify.sh master&quot;</span><br><span class="line">notify_backup &quot;/etc/keepalived/notify.sh backup&quot;</span><br><span class="line">notify_fault &quot;/etc/keepalived/notify.sh fault&quot;</span><br></pre></td></tr></table></figure>

<h3 id="实战案例1：实现-Keepalived-状态切换的通知脚本"><a href="#实战案例1：实现-Keepalived-状态切换的通知脚本" class="headerlink" title="实战案例1：实现 Keepalived 状态切换的通知脚本"></a>实战案例1：实现 Keepalived 状态切换的通知脚本</h3><p>以下脚本支持RHEL和Ubuntu系统</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#在所有 keepalived节点配置如下</span></span><br><span class="line">[root@ka1 ~]<span class="comment"># cat /etc/keepalived/notify.sh </span></span><br><span class="line"><span class="comment">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line">contact=<span class="string">&#x27;root@wangxiaochun.com&#x27;</span></span><br><span class="line">email_send=<span class="string">&#x27;29308620@qq.com&#x27;</span></span><br><span class="line">email_passwd=<span class="string">&#x27;dgezyimkdswwbhea&#x27;</span></span><br><span class="line">email_smtp_server=<span class="string">&#x27;smtp.qq.com&#x27;</span></span><br><span class="line"></span><br><span class="line">. /etc/os-release</span><br><span class="line"><span class="function"><span class="title">msg_error</span></span>() &#123;</span><br><span class="line">  <span class="built_in">echo</span> -e <span class="string">&quot;\033[1;31m<span class="variable">$1</span>\033[0m&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="title">msg_info</span></span>() &#123;</span><br><span class="line">  <span class="built_in">echo</span> -e <span class="string">&quot;\033[1;32m<span class="variable">$1</span>\033[0m&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="title">msg_warn</span></span>() &#123;</span><br><span class="line">  <span class="built_in">echo</span> -e <span class="string">&quot;\033[1;33m<span class="variable">$1</span>\033[0m&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">color</span></span> () &#123;</span><br><span class="line">    RES_COL=60</span><br><span class="line">    MOVE_TO_COL=<span class="string">&quot;echo -en \\033[<span class="variable">$&#123;RES_COL&#125;</span>G&quot;</span></span><br><span class="line">    SETCOLOR_SUCCESS=<span class="string">&quot;echo -en \\033[1;32m&quot;</span></span><br><span class="line">    SETCOLOR_FAILURE=<span class="string">&quot;echo -en \\033[1;31m&quot;</span></span><br><span class="line">    SETCOLOR_WARNING=<span class="string">&quot;echo -en \\033[1;33m&quot;</span></span><br><span class="line">    SETCOLOR_NORMAL=<span class="string">&quot;echo -en \E[0m&quot;</span></span><br><span class="line">    <span class="built_in">echo</span> -n <span class="string">&quot;<span class="variable">$1</span>&quot;</span> &amp;&amp; <span class="variable">$MOVE_TO_COL</span></span><br><span class="line">    <span class="built_in">echo</span> -n <span class="string">&quot;[&quot;</span></span><br><span class="line">    <span class="keyword">if</span> [ <span class="variable">$2</span> = <span class="string">&quot;success&quot;</span> -o <span class="variable">$2</span> = <span class="string">&quot;0&quot;</span> ] ;<span class="keyword">then</span></span><br><span class="line">        <span class="variable">$&#123;SETCOLOR_SUCCESS&#125;</span></span><br><span class="line">        <span class="built_in">echo</span> -n $<span class="string">&quot; OK &quot;</span>    </span><br><span class="line">    <span class="keyword">elif</span> [ <span class="variable">$2</span> = <span class="string">&quot;failure&quot;</span> -o <span class="variable">$2</span> = <span class="string">&quot;1&quot;</span> ] ;<span class="keyword">then</span> </span><br><span class="line">        <span class="variable">$&#123;SETCOLOR_FAILURE&#125;</span></span><br><span class="line">        <span class="built_in">echo</span> -n $<span class="string">&quot;FAILED&quot;</span></span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="variable">$&#123;SETCOLOR_WARNING&#125;</span></span><br><span class="line">        <span class="built_in">echo</span> -n $<span class="string">&quot;WARNING&quot;</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line">    <span class="variable">$&#123;SETCOLOR_NORMAL&#125;</span></span><br><span class="line">    <span class="built_in">echo</span> -n <span class="string">&quot;]&quot;</span></span><br><span class="line">    <span class="built_in">echo</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">install_sendemail</span></span> () &#123;</span><br><span class="line">    <span class="keyword">if</span> [[ <span class="variable">$ID</span> =~ rhel|centos|rocky ]];<span class="keyword">then</span></span><br><span class="line">       rpm -q sendemail &amp;&gt; /dev/null || yum install -y sendemail</span><br><span class="line">    <span class="keyword">elif</span> [ <span class="variable">$ID</span> = <span class="string">&#x27;ubuntu&#x27;</span> ];<span class="keyword">then</span></span><br><span class="line">       dpkg -l |grep -q sendemail || &#123; apt update; apt install -y libio-socket-ssl-perl libnet-ssleay-perl sendemail ; &#125; </span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">       color <span class="string">&quot;不支持此操作系统，退出!&quot;</span> 1</span><br><span class="line">        <span class="built_in">exit</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">send_email</span></span> () &#123;</span><br><span class="line">   <span class="built_in">local</span> email_receive=<span class="string">&quot;<span class="variable">$1</span>&quot;</span></span><br><span class="line">   <span class="built_in">local</span> email_subject=<span class="string">&quot;<span class="variable">$2</span>&quot;</span></span><br><span class="line">   <span class="built_in">local</span> email_message=<span class="string">&quot;<span class="variable">$3</span>&quot;</span></span><br><span class="line">   sendemail -f <span class="variable">$email_send</span> -t <span class="variable">$email_receive</span> -u <span class="variable">$email_subject</span> -m</span><br><span class="line"><span class="variable">$email_message</span> -s <span class="variable">$email_smtp_server</span> -o message-charset=utf-8 -o tls=<span class="built_in">yes</span> -xu</span><br><span class="line"><span class="variable">$email_send</span> -xp <span class="variable">$email_passwd</span></span><br><span class="line">   [ $? -eq 0 ] &amp;&amp; color <span class="string">&quot;邮件发送成功!&quot;</span> 0 || color <span class="string">&quot;邮件发送失败!&quot;</span> 1</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">notify</span></span>() &#123;</span><br><span class="line">    <span class="keyword">if</span> [[ <span class="variable">$1</span> =~ ^(master|backup|fault)$ ]];<span class="keyword">then</span></span><br><span class="line">        mailsubject=<span class="string">&quot;<span class="subst">$(hostname)</span> to be <span class="variable">$1</span>, vip floating&quot;</span></span><br><span class="line">        mailbody=<span class="string">&quot;<span class="subst">$(date +&#x27;%F %T&#x27;)</span>: vrrp transition, <span class="subst">$(hostname)</span> changed to be </span></span><br><span class="line"><span class="string"><span class="variable">$1</span>&quot;</span></span><br><span class="line">       send_email <span class="string">&quot;<span class="variable">$contact</span>&quot;</span> <span class="string">&quot;<span class="variable">$mailsubject</span>&quot;</span> <span class="string">&quot;<span class="variable">$mailbody</span>&quot;</span></span><br><span class="line">   <span class="keyword">else</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;Usage: <span class="subst">$(basename $0)</span> &#123;master|backup|fault&#125;&quot;</span></span><br><span class="line">        <span class="built_in">exit</span> 1</span><br><span class="line">   <span class="keyword">fi</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">install_sendemail </span><br><span class="line">notify <span class="variable">$1</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@ka1 ~]<span class="comment"># chmod a+x /etc/keepalived/notify.sh </span></span><br><span class="line">[root@ka1 ~]<span class="comment"># vim /etc/keepalived/keepalived.conf</span></span><br><span class="line">vrrp_instance VI_1 &#123;</span><br><span class="line">	......</span><br><span class="line">	virtual_ipaddress &#123;</span><br><span class="line">		10.0.0.10 dev eth0 label eth0:1</span><br><span class="line">	&#125;</span><br><span class="line">	notify_master <span class="string">&quot;/etc/keepalived/notify.sh master&quot;</span></span><br><span class="line">	notify_backup <span class="string">&quot;/etc/keepalived/notify.sh backup&quot;</span></span><br><span class="line">	notify_fault <span class="string">&quot;/etc/keepalived/notify.sh fault&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">#模拟master故障</span></span><br><span class="line">[root@ka1-centos8 ~]<span class="comment"># killall keepalived</span></span><br></pre></td></tr></table></figure>

<h3 id="实战案例2：实现-Keepalived-状态切换的通知脚本"><a href="#实战案例2：实现-Keepalived-状态切换的通知脚本" class="headerlink" title="实战案例2：实现 Keepalived 状态切换的通知脚本"></a>实战案例2：实现 Keepalived 状态切换的通知脚本</h3><p>下面仅支持RHEL系统</p>
<h4 id="邮件配置"><a href="#邮件配置" class="headerlink" title="邮件配置"></a>邮件配置</h4><p>案例：QQ邮箱配置</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ~]<span class="comment"># vim /etc/mail.rc</span></span><br><span class="line"><span class="comment">#在最后面添加下面行</span></span><br><span class="line"><span class="built_in">set</span> from=29308620@qq.com</span><br><span class="line"><span class="built_in">set</span> smtp=smtp.qq.com</span><br><span class="line"><span class="built_in">set</span> smtp-auth-user=29308620@qq.com</span><br><span class="line"><span class="built_in">set</span> smtp-auth-password=esvnhbnqocirbicf</span><br><span class="line"><span class="built_in">set</span> smtp-auth=login</span><br><span class="line"><span class="built_in">set</span> ssl-verify=ignore</span><br></pre></td></tr></table></figure>

<p>范例：163 邮箱配置</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ~]<span class="comment"># vi /etc/mail.rc</span></span><br><span class="line"><span class="built_in">set</span> from=xxx@163.com <span class="comment">#之前设置好的邮箱地址</span></span><br><span class="line"><span class="built_in">set</span> smtp=smtp.163.com <span class="comment">#邮件服务器</span></span><br><span class="line"><span class="built_in">set</span> smtp-auth-user=xxx@163.com <span class="comment">#之前设置好的邮箱地址</span></span><br><span class="line"><span class="built_in">set</span> smtp-auth-password=QXFIOQXEJNSVSDM <span class="comment">#授权码</span></span><br><span class="line"><span class="built_in">set</span> smtp-auth=login <span class="comment">#默认login即可</span></span><br></pre></td></tr></table></figure>

<p>范例：发送测试邮件</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ~]<span class="comment"># yum -y install mailx </span></span><br><span class="line">[root@centos8 ~]<span class="comment"># echo &quot;Test Mail&quot;| mail -s Warning root@wangxiaochun.com</span></span><br></pre></td></tr></table></figure>

<h4 id="创建通知脚本"><a href="#创建通知脚本" class="headerlink" title="创建通知脚本"></a>创建通知脚本</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#在所有 keepalived节点配置如下</span></span><br><span class="line">[root@ka1-centos8 ~]<span class="comment">#cat /etc/keepalived/notify.sh </span></span><br><span class="line"><span class="comment">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line">contact=<span class="string">&#x27;root@wangxiaochun.com&#x27;</span></span><br><span class="line"><span class="function"><span class="title">notify</span></span>() &#123;</span><br><span class="line">	mailsubject=<span class="string">&quot;<span class="subst">$(hostname)</span> to be <span class="variable">$1</span>, vip floating&quot;</span></span><br><span class="line">	mailbody=<span class="string">&quot;<span class="subst">$(date +&#x27;%F %T&#x27;)</span>: vrrp transition, <span class="subst">$(hostname)</span> changed to be <span class="variable">$1</span>&quot;</span></span><br><span class="line">	<span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$mailbody</span>&quot;</span> | mail -s <span class="string">&quot;<span class="variable">$mailsubject</span>&quot;</span> <span class="variable">$contact</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">case</span> <span class="variable">$1</span> <span class="keyword">in</span></span><br><span class="line">master)</span><br><span class="line">	notify master</span><br><span class="line">	;;</span><br><span class="line">backup)</span><br><span class="line">	notify backup</span><br><span class="line"> 	;;</span><br><span class="line">fault)</span><br><span class="line"> 	notify fault</span><br><span class="line"> 	;;</span><br><span class="line">*)</span><br><span class="line"> 	<span class="built_in">echo</span> <span class="string">&quot;Usage: <span class="subst">$(basename $0)</span> &#123;master|backup|fault&#125;&quot;</span></span><br><span class="line"> 	<span class="built_in">exit</span> 1</span><br><span class="line">	;;</span><br><span class="line"><span class="keyword">esac</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@ka1-centos8 ~]<span class="comment"># chmod a+x /etc/keepalived/notify.sh </span></span><br><span class="line">[root@ka1-centos8 ~]<span class="comment"># vim /etc/keepalived/keepalived.conf</span></span><br><span class="line">vrrp_instance VI_1 &#123;</span><br><span class="line"> ......</span><br><span class="line"> virtual_ipaddress &#123;</span><br><span class="line">   10.0.0.10 dev eth0 label eth0:1</span><br><span class="line"> &#125;</span><br><span class="line"> notify_master <span class="string">&quot;/etc/keepalived/notify.sh master&quot;</span></span><br><span class="line"> notify_backup <span class="string">&quot;/etc/keepalived/notify.sh backup&quot;</span></span><br><span class="line"> notify_fault <span class="string">&quot;/etc/keepalived/notify.sh fault&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">#模拟master故障</span></span><br><span class="line">[root@ka1-centos8 ~]<span class="comment"># killall keepalived</span></span><br></pre></td></tr></table></figure>

<p><strong>查看邮箱收到邮件如下：</strong></p>
<p><img src="../../../../images/SRE/day48/7.jpg" alt="7"></p>
<h2 id="实现-Master-Master-的-Keepalived-双主架构"><a href="#实现-Master-Master-的-Keepalived-双主架构" class="headerlink" title="实现 Master/Master 的 Keepalived 双主架构"></a>实现 Master/Master 的 Keepalived 双主架构</h2><p>master/slave的单主架构，同一时间只有一个Keepalived对外提供服务，此主机繁忙，而另一台主机却很空闲，利用率低下，可以使用master/master的双主架构，解决此问题。</p>
<p><strong>Master/Master 的双主架构：</strong></p>
<p>即将两个或以上VIP分别运行在不同的keepalived服务器，以实现服务器并行提供web访问的目的，提高服务器资源利用率</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#ha1主机配置</span></span><br><span class="line">[root@ka1-centos8 ~]<span class="comment">#vim /etc/keepalived/keepalived.conf </span></span><br><span class="line">! Configuration File <span class="keyword">for</span> keepalived</span><br><span class="line">global_defs &#123;</span><br><span class="line">	notification_email &#123;</span><br><span class="line">		root@wangxiaochun.com</span><br><span class="line">	&#125;</span><br><span class="line">	notification_email_from keepalived@localhost</span><br><span class="line">	smtp_server 127.0.0.1</span><br><span class="line">	smtp_connect_timeout 30</span><br><span class="line">	router_id ka1.wang.org</span><br><span class="line">	vrrp_mcast_group4 224.0.100.100</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">vrrp_instance VI_1 &#123;</span><br><span class="line">	state MASTER   <span class="comment">#在另一个主机上为BACKUP</span></span><br><span class="line">	interface eth0</span><br><span class="line">	virtual_router_id 66 <span class="comment">#每个vrrp_instance唯一</span></span><br><span class="line">	priority 100   <span class="comment">#在另一个主机上为80</span></span><br><span class="line">	advert_int 1</span><br><span class="line">	authentication &#123;</span><br><span class="line">		auth_type PASS</span><br><span class="line">		auth_pass 12345678</span><br><span class="line"> 	&#125;</span><br><span class="line"> 	virtual_ipaddress &#123;</span><br><span class="line">		10.0.0.10/24 dev eth0 label eth0:1 <span class="comment">#指定vrrp_instance各自的VIP</span></span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">vrrp_instance VI_2 &#123;            <span class="comment">#添加 VI_2 实例</span></span><br><span class="line">	state BACKUP   <span class="comment">#在另一个主机上为MASTER</span></span><br><span class="line">	interface eth0</span><br><span class="line">	virtual_router_id 88 <span class="comment">#每个vrrp_instance唯一</span></span><br><span class="line">	priority 80     <span class="comment">#在另一个主机上为100</span></span><br><span class="line">	advert_int 1</span><br><span class="line">	authentication &#123;</span><br><span class="line">		auth_type PASS</span><br><span class="line">		auth_pass 12345678</span><br><span class="line">	&#125;</span><br><span class="line">	virtual_ipaddress &#123;</span><br><span class="line">		10.0.0.20/24 dev eth0 label eth0:1  <span class="comment">#指定vrrp_instance各自的VIP</span></span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">#ka2主机配置,和ka1配置只需五行不同</span></span><br><span class="line">[root@ka2-centos8 ~]<span class="comment"># vim /etc/keepalived/keepalived.conf </span></span><br><span class="line">! Configuration File <span class="keyword">for</span> keepalived</span><br><span class="line">global_defs &#123;</span><br><span class="line">	notification_email &#123;</span><br><span class="line">		root@wangxiaochun.com</span><br><span class="line">	&#125;</span><br><span class="line">	notification_email_from keepalived@localhost</span><br><span class="line"> 	smtp_server 127.0.0.1</span><br><span class="line">	smtp_connect_timeout 30</span><br><span class="line">	router_id ka2.wang.org        <span class="comment">#修改此行</span></span><br><span class="line">	vrrp_mcast_group4 224.0.100.100</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">vrrp_instance VI_1 &#123;</span><br><span class="line">	state BACKUP <span class="comment">#此修改行为BACKUP</span></span><br><span class="line">	interface eth0</span><br><span class="line">	virtual_router_id 66 </span><br><span class="line">	priority 80   <span class="comment">#此修改行为80</span></span><br><span class="line">	advert_int 1</span><br><span class="line">	authentication &#123;</span><br><span class="line">		auth_type PASS</span><br><span class="line">		auth_pass 12345678</span><br><span class="line">	&#125;</span><br><span class="line">	virtual_ipaddress &#123;</span><br><span class="line">		10.0.0.10/24 dev eth0 label eth0:1</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line">vrrp_instance VI_2 &#123;</span><br><span class="line">    state MASTER   <span class="comment">#修改此行为MASTER</span></span><br><span class="line">    interface eth0</span><br><span class="line">    virtual_router_id 88 </span><br><span class="line">    priority 100   <span class="comment">#修改此行为100</span></span><br><span class="line">    advert_int 1</span><br><span class="line">    authentication &#123;</span><br><span class="line">        auth_type PASS</span><br><span class="line">        auth_pass 12345678</span><br><span class="line">    &#125;</span><br><span class="line">    virtual_ipaddress &#123;</span><br><span class="line">        10.0.0.20/24 dev eth0 label eth0:1  </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>实战案例：利用子配置文件实现master/master的Keepalived双主架构</strong></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br></pre></td><td class="code"><pre><span class="line">[root@ka1-centos8 ~]<span class="comment"># cat /etc/keepalived/keepalived.conf</span></span><br><span class="line">! Configuration File <span class="keyword">for</span> keepalived</span><br><span class="line">global_defs &#123;</span><br><span class="line">	notification_email &#123;</span><br><span class="line">    	acassen@firewall.loc</span><br><span class="line">    	failover@firewall.loc</span><br><span class="line">    	sysadmin@firewall.loc</span><br><span class="line">	&#125;</span><br><span class="line">	notification_email_from Alexandre.Cassen@firewall.loc</span><br><span class="line">    smtp_server 192.168.200.1</span><br><span class="line">    smtp_connect_timeout 30</span><br><span class="line">    router_id ha1.wang.org</span><br><span class="line">    vrrp_skip_check_adv_addr</span><br><span class="line">    <span class="comment">#vrrp_strict</span></span><br><span class="line">    vrrp_garp_interval 0</span><br><span class="line">    vrrp_gna_interval 0</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">include /etc/keepalived/conf.d/*.conf</span><br><span class="line"></span><br><span class="line">[root@ka1-centos8 ~]<span class="comment"># mkdir /etc/keepalived/conf.d/</span></span><br><span class="line">[root@ka1-centos8 ~]<span class="comment"># cat /etc/keepalived/conf.d/cluster1.conf </span></span><br><span class="line">vrrp_instance VI_1 &#123;</span><br><span class="line">    state MASTER</span><br><span class="line">    interface eth0</span><br><span class="line">    virtual_router_id 66</span><br><span class="line">    priority 100</span><br><span class="line">    advert_int 1</span><br><span class="line">    authentication &#123;</span><br><span class="line">        auth_type PASS</span><br><span class="line">        auth_pass 123456</span><br><span class="line">    &#125;</span><br><span class="line">    virtual_ipaddress &#123;</span><br><span class="line">        10.0.0.10/24 dev eth0 label eth0:1</span><br><span class="line">    &#125;</span><br><span class="line">    unicast_src_ip 10.0.0.8</span><br><span class="line">    unicast_peer&#123;</span><br><span class="line">    	10.0.0.18</span><br><span class="line">    &#125;</span><br><span class="line">    notify_master <span class="string">&quot;/etc/keepalived/notify.sh master&quot;</span></span><br><span class="line">    notify_backup <span class="string">&quot;/etc/keepalived/notify.sh backup&quot;</span></span><br><span class="line">    notify_fault <span class="string">&quot;/etc/keepalived/notify.sh fault&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">[root@ka1-centos8 ~]<span class="comment"># cat /etc/keepalived/conf.d/cluster2.conf </span></span><br><span class="line">vrrp_instance VI_2 &#123;</span><br><span class="line">    state BACKUP</span><br><span class="line">    interface eth0</span><br><span class="line">    virtual_router_id 88</span><br><span class="line">    priority 80</span><br><span class="line">    advert_int 1</span><br><span class="line">    authentication &#123;</span><br><span class="line">        auth_type PASS</span><br><span class="line">        auth_pass 123456</span><br><span class="line">    &#125; </span><br><span class="line">    virtual_ipaddress &#123;</span><br><span class="line">        10.0.0.20/24 dev eth0 label eth0:1</span><br><span class="line">    &#125;</span><br><span class="line">    unicast_src_ip 10.0.0.8</span><br><span class="line">    unicast_peer&#123;</span><br><span class="line">        10.0.0.18</span><br><span class="line">    &#125;</span><br><span class="line">    notify_master <span class="string">&quot;/etc/keepalived/notify.sh master&quot;</span></span><br><span class="line">    notify_backup <span class="string">&quot;/etc/keepalived/notify.sh backup&quot;</span></span><br><span class="line">    notify_fault <span class="string">&quot;/etc/keepalived/notify.sh fault&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">[root@ka1-centos8 ~]<span class="comment"># tree /etc/keepalived/</span></span><br><span class="line">/etc/keepalived/</span><br><span class="line">├── conf.d</span><br><span class="line">│   ├── cluster1.conf</span><br><span class="line">│   └── cluster2.conf</span><br><span class="line">├── keepalived.conf</span><br><span class="line">├── keepalived.conf.bak</span><br><span class="line">└── notify.sh</span><br><span class="line"></span><br><span class="line">1 directory, 5 files</span><br><span class="line"></span><br><span class="line"><span class="comment">#ka2主机的配置</span></span><br><span class="line">[root@ka2-centos8 ~]<span class="comment"># cat /etc/keepalived/keepalived.conf</span></span><br><span class="line">! Configuration File <span class="keyword">for</span> keepalived</span><br><span class="line">global_defs &#123;</span><br><span class="line">    notification_email &#123;</span><br><span class="line">    	acassen@firewall.loc</span><br><span class="line">    	failover@firewall.loc</span><br><span class="line">    	sysadmin@firewall.loc</span><br><span class="line">    &#125;</span><br><span class="line">    notification_email_from Alexandre.Cassen@firewall.loc</span><br><span class="line">    smtp_server 192.168.200.1</span><br><span class="line">    smtp_connect_timeout 30</span><br><span class="line">    router_id ha2.wang.org</span><br><span class="line">    vrrp_skip_check_adv_addr</span><br><span class="line">    <span class="comment">#vrrp_strict</span></span><br><span class="line">    vrrp_garp_interval 0</span><br><span class="line">    vrrp_gna_interval 0</span><br><span class="line">&#125;</span><br><span class="line">include /etc/keepalived/conf.d/*.conf</span><br><span class="line"></span><br><span class="line">[root@ka2-centos8 ~]<span class="comment"># cat /etc/keepalived/conf.d/cluster1.conf </span></span><br><span class="line">vrrp_instance VI_1 &#123;</span><br><span class="line">    state BACKUP </span><br><span class="line">    interface eth0</span><br><span class="line">    virtual_router_id 66</span><br><span class="line">    priority 80</span><br><span class="line">    advert_int 1</span><br><span class="line">    authentication &#123;</span><br><span class="line">        auth_type PASS</span><br><span class="line">        auth_pass 123456</span><br><span class="line">    &#125;</span><br><span class="line">    virtual_ipaddress &#123;</span><br><span class="line">        10.0.0.10/24 dev eth0 label eth0:1</span><br><span class="line">    &#125;</span><br><span class="line">    unicast_src_ip 10.0.0.18</span><br><span class="line">    unicast_peer &#123;</span><br><span class="line">        10.0.0.8 </span><br><span class="line">    &#125;</span><br><span class="line">    notify_master <span class="string">&quot;/etc/keepalived/notify.sh master&quot;</span></span><br><span class="line">    notify_backup <span class="string">&quot;/etc/keepalived/notify.sh backup&quot;</span></span><br><span class="line">    notify_fault <span class="string">&quot;/etc/keepalived/notify.sh fault&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">[root@ka2-centos8 ~]<span class="comment"># cat /etc/keepalived/conf.d/cluster2.conf </span></span><br><span class="line">vrrp_instance VI_2 &#123;</span><br><span class="line">    state MASTER</span><br><span class="line">    interface eth0</span><br><span class="line">    virtual_router_id 88</span><br><span class="line">    priority 100</span><br><span class="line">    advert_int 1</span><br><span class="line">    authentication &#123;</span><br><span class="line">        auth_type PASS</span><br><span class="line">        auth_pass 123456</span><br><span class="line">    &#125;</span><br><span class="line">    virtual_ipaddress &#123;</span><br><span class="line">        10.0.0.20/24 dev eth0 label eth0:1</span><br><span class="line">    &#125;</span><br><span class="line">    unicast_src_ip 10.0.0.18</span><br><span class="line">    unicast_peer&#123;</span><br><span class="line">    	10.0.0.8</span><br><span class="line">   	&#125;</span><br><span class="line">    notify_master <span class="string">&quot;/etc/keepalived/notify.sh master&quot;</span></span><br><span class="line">    notify_backup <span class="string">&quot;/etc/keepalived/notify.sh backup&quot;</span></span><br><span class="line">    notify_fault <span class="string">&quot;/etc/keepalived/notify.sh fault&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">#查看IP</span></span><br><span class="line">[root@ka1-centos8 ~]<span class="comment"># hostname -I</span></span><br><span class="line">10.0.0.8 10.0.0.10 </span><br><span class="line"></span><br><span class="line">[root@ka2-centos8 ~]<span class="comment"># hostname -I</span></span><br><span class="line">10.0.0.18 10.0.0.20</span><br><span class="line"></span><br><span class="line"><span class="comment">#ka1主机故障，测试VIP漂移至ka2主机</span></span><br><span class="line">[root@ka1-centos8 ~]<span class="comment"># killall keepalived</span></span><br><span class="line">[root@ka1-centos8 ~]<span class="comment"># hostname -I</span></span><br><span class="line">10.0.0.8</span><br><span class="line"></span><br><span class="line">[root@ka2-centos8 ~]<span class="comment"># hostname -I</span></span><br><span class="line">10.0.0.18 10.0.0.20 10.0.0.10</span><br><span class="line"></span><br><span class="line"><span class="comment">#恢复ka1主机</span></span><br><span class="line">[root@ka1-centos8 ~]<span class="comment"># systemctl start keepalived.service </span></span><br><span class="line">[root@ka1-centos8 ~]<span class="comment"># hostname -I</span></span><br><span class="line">10.0.0.8 10.0.0.10 </span><br><span class="line"></span><br><span class="line">[root@ka2-centos8 ~]<span class="comment"># hostname -I</span></span><br><span class="line">10.0.0.18 10.0.0.20 </span><br><span class="line"></span><br><span class="line"><span class="comment">#脑裂现象</span></span><br><span class="line">[root@ka1-centos8 ~]<span class="comment"># hostname -I</span></span><br><span class="line">10.0.0.8 10.0.0.10</span><br><span class="line">[root@ka1-centos8 ~]<span class="comment"># iptables -A INPUT -s10.0.0.18 -j DROP</span></span><br><span class="line">[root@ka1-centos8 ~]<span class="comment"># hostname -I</span></span><br><span class="line">10.0.0.8 10.0.0.10 10.0.0.20</span><br><span class="line"></span><br><span class="line">[root@ka2-centos8 ~]<span class="comment"># hostname -I</span></span><br><span class="line">10.0.0.18 10.0.0.20 </span><br><span class="line"></span><br><span class="line">[root@ka2-centos8 ~]<span class="comment"># iptables -A INPUT -s 10.0.0.8 -j REJECT </span></span><br><span class="line">[root@ka2-centos8 ~]<span class="comment"># hostname -I</span></span><br><span class="line">10.0.0.18 10.0.0.20 10.0.0.10 </span><br></pre></td></tr></table></figure>

<h2 id="实现多主模架构"><a href="#实现多主模架构" class="headerlink" title="实现多主模架构"></a>实现多主模架构</h2><h3 id="案例：三个节点的三主三从架构实现"><a href="#案例：三个节点的三主三从架构实现" class="headerlink" title="案例：三个节点的三主三从架构实现"></a>案例：三个节点的三主三从架构实现</h3><p><img src="../../../../images/SRE/day48/8.jpg" alt="8"></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#第一个节点ka1配置：</span></span><br><span class="line">virtual_router_id 1 , Vrrp instance 1 , MASTER，优先级 100</span><br><span class="line">virtual_router_id 3 , Vrrp instance 2 , BACKUP，优先级 80</span><br><span class="line"></span><br><span class="line"><span class="comment">#第二个节点ka2配置：</span></span><br><span class="line">virtual_router_id 2 , Vrrp instance 1 , MASTER，优先级 100</span><br><span class="line">virtual_router_id 1 , Vrrp instance 2 , BACKUP，优先级 80\</span><br><span class="line"></span><br><span class="line"><span class="comment">#第三个节点ka3配置：</span></span><br><span class="line">virtual_router_id 3 , Vrrp instance 1 , MASTER，优先级 100</span><br><span class="line">virtual_router_id 2 , Vrrp instance 2 , BACKUP，优先级 80</span><br></pre></td></tr></table></figure>

<h3 id="案例：三个节点的三主六从架构实现"><a href="#案例：三个节点的三主六从架构实现" class="headerlink" title="案例：三个节点的三主六从架构实现"></a>案例：三个节点的三主六从架构实现</h3><p><img src="../../../../images/SRE/day48/9.jpg" alt="9"></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#第一个节点ka1配置：</span></span><br><span class="line">virtual_router_id 1 , Vrrp instance 1 , MASTER，优先级100</span><br><span class="line">virtual_router_id 2 , Vrrp instance 2 , BACKUP，优先级80</span><br><span class="line">virtual_router_id 3 , Vrrp instance 3 , BACKUP，优先级60</span><br><span class="line"></span><br><span class="line"><span class="comment">#第二个节点ka2配置：</span></span><br><span class="line">virtual_router_id 1 , Vrrp instance 1 , BACKUP，优先级60</span><br><span class="line">virtual_router_id 2 , Vrrp instance 2 , MASTER，优先级100</span><br><span class="line">virtual_router_id 3 , Vrrp instance 3 , BACKUP，优先级80</span><br><span class="line"></span><br><span class="line"><span class="comment">#第三个节点ka3配置：</span></span><br><span class="line">virtual_router_id 1 , Vrrp instance 1 , BACKUP，优先级80</span><br><span class="line">virtual_router_id 2 , Vrrp instance 2 , BACKUP，优先级60</span><br><span class="line">virtual_router_id 3 , Vrrp instance 3 , MASTER，优先级100</span><br></pre></td></tr></table></figure>

<h2 id="同步组"><a href="#同步组" class="headerlink" title="同步组"></a>同步组</h2><p>LVS NAT 模型VIP和DIP需要同步，需要同步组</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">vrrp_sync_group VG_1 &#123;</span><br><span class="line">	group &#123;</span><br><span class="line">		VI_1  <span class="comment"># name of vrrp_instance (below)</span></span><br><span class="line">		VI_2  <span class="comment"># One for each moveable IP</span></span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">vrrp_instance VI_1 &#123;</span><br><span class="line">	eth0</span><br><span class="line">	vip</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">vrrp_instance VI_2 &#123;</span><br><span class="line">	eth1</span><br><span class="line">	dip</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="实现-IPVS-的高可用性"><a href="#实现-IPVS-的高可用性" class="headerlink" title="实现 IPVS 的高可用性"></a>实现 IPVS 的高可用性</h1><h2 id="IPVS-相关配置"><a href="#IPVS-相关配置" class="headerlink" title="IPVS 相关配置"></a>IPVS 相关配置</h2><h3 id="虚拟服务器配置结构"><a href="#虚拟服务器配置结构" class="headerlink" title="虚拟服务器配置结构"></a>虚拟服务器配置结构</h3><p>每一个虚拟服务器即一个IPVS集群</p>
<p>可以通过下面语法实现</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">virtual_server IP port &#123;</span><br><span class="line">	...</span><br><span class="line">	real_server &#123;</span><br><span class="line">		...</span><br><span class="line">	&#125;</span><br><span class="line">	real_server &#123;</span><br><span class="line">		...</span><br><span class="line">	&#125;</span><br><span class="line">	…</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Virtual-Server-（虚拟服务器）的定义格式"><a href="#Virtual-Server-（虚拟服务器）的定义格式" class="headerlink" title="Virtual Server （虚拟服务器）的定义格式"></a>Virtual Server （虚拟服务器）的定义格式</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">virtual_server IP port        <span class="comment">#定义虚拟主机IP地址及其端口</span></span><br><span class="line">virtual_server fwmark int     <span class="comment">#ipvs的防火墙打标，实现基于防火墙的负载均衡集群</span></span><br><span class="line">virtual_server group string   <span class="comment">#使用虚拟服务器组</span></span><br></pre></td></tr></table></figure>

<h3 id="虚拟服务器组"><a href="#虚拟服务器组" class="headerlink" title="虚拟服务器组"></a>虚拟服务器组</h3><p>将多个虚拟服务器定义成一个组，统一对外服务，如：http和https定义成一个虚拟服务器组</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#参考文档：/usr/share/doc/keepalived/keepalived.conf.virtual_server_group</span></span><br><span class="line">virtual_server_group &lt;STRING&gt; &#123;</span><br><span class="line">           <span class="comment"># Virtual IP Address and Port</span></span><br><span class="line">           &lt;IPADDR&gt; &lt;PORT&gt;</span><br><span class="line">           &lt;IPADDR&gt; &lt;PORT&gt;</span><br><span class="line">           ...</span><br><span class="line">           <span class="comment"># &lt;IPADDR RANGE&gt; has the form</span></span><br><span class="line">           <span class="comment"># XXX.YYY.ZZZ.WWW-VVV eg 192.168.200.1-10</span></span><br><span class="line">           <span class="comment"># range includes both .1 and .10 address</span></span><br><span class="line">           &lt;IPADDR RANGE&gt; &lt;PORT&gt;<span class="comment"># VIP range VPORT</span></span><br><span class="line">           &lt;IPADDR RANGE&gt; &lt;PORT&gt;</span><br><span class="line">           ...</span><br><span class="line">           <span class="comment"># Firewall Mark (fwmark)</span></span><br><span class="line">           fwmark &lt;INTEGER&gt;</span><br><span class="line">           fwmark &lt;INTEGER&gt;</span><br><span class="line">           ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="虚拟服务器配置"><a href="#虚拟服务器配置" class="headerlink" title="虚拟服务器配置"></a>虚拟服务器配置</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">virtual_server IP port &#123;               <span class="comment">#VIP和PORT</span></span><br><span class="line">     delay_loop &lt;INT&gt;                      <span class="comment">#检查后端服务器的时间间隔</span></span><br><span class="line">     lb_algo rr|wrr|lc|wlc|lblc|sh|dh      <span class="comment">#定义调度方法</span></span><br><span class="line">     lb_kind NAT|DR|TUN                    <span class="comment">#集群的类型,注意要大写</span></span><br><span class="line">     persistence_timeout &lt;INT&gt;             <span class="comment">#持久连接时长</span></span><br><span class="line">     protocol TCP|UDP|SCTP                 <span class="comment">#指定服务协议,一般为TCP</span></span><br><span class="line">     sorry_server &lt;IPADDR&gt; &lt;PORT&gt;          <span class="comment">#所有RS故障时，备用服务器地址</span></span><br><span class="line">     real_server &lt;IPADDR&gt; &lt;PORT&gt; &#123;         <span class="comment">#RS的IP和PORT</span></span><br><span class="line">         weight &lt;INT&gt;                          <span class="comment">#RS权重</span></span><br><span class="line">         notify_up &lt;STRING&gt;|&lt;QUOTED-STRING&gt;    <span class="comment">#RS上线通知脚本</span></span><br><span class="line">         notify_down &lt;STRING&gt;|&lt;QUOTED-STRING&gt;  <span class="comment">#RS下线通知脚本</span></span><br><span class="line">         HTTP_GET|SSL_GET|TCP_CHECK|SMTP_CHECK|MISC_CHECK &#123; ... &#125; <span class="comment">#定义当前主机健康状态检测方法</span></span><br><span class="line">     &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">#注意:括号必须分行写,两个括号写在同一行,如: &#125;&#125; 会出错</span></span><br></pre></td></tr></table></figure>

<h3 id="应用层监测"><a href="#应用层监测" class="headerlink" title="应用层监测"></a>应用层监测</h3><p>应用层检测：HTTP_GET|SSL_GET</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">HTTP_GET|SSL_GET &#123;</span><br><span class="line">	url &#123;</span><br><span class="line">		path &lt;URL_PATH&gt;         <span class="comment">#定义要监控的URL</span></span><br><span class="line">		status_code &lt;INT&gt;       <span class="comment">#判断上述检测机制为健康状态的响应码，一般为 200</span></span><br><span class="line">	&#125;</span><br><span class="line">	connect_timeout &lt;INTEGER&gt;   <span class="comment">#客户端请求的超时时长, 相当于haproxy的timeout server</span></span><br><span class="line">	nb_get_retry &lt;INT&gt;          <span class="comment">#重试次数</span></span><br><span class="line"> 	delay_before_retry &lt;INT&gt;    <span class="comment">#重试之前的延迟时长</span></span><br><span class="line"> 	connect_ip &lt;IP ADDRESS&gt;     <span class="comment">#向当前RS哪个IP地址发起健康状态检测请求</span></span><br><span class="line">	connect_port &lt;PORT&gt;         <span class="comment">#向当前RS的哪个PORT发起健康状态检测请求</span></span><br><span class="line"> 	bindto &lt;IP ADDRESS&gt;         <span class="comment">#向当前RS发出健康状态检测请求时使用的源地址</span></span><br><span class="line"> 	bind_port &lt;PORT&gt;            <span class="comment">#向当前RS发出健康状态检测请求时使用的源端口</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>范例：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">virtual_server 10.0.0.10 80 &#123;</span><br><span class="line">    delay_loop 3</span><br><span class="line">    lb_algo rr</span><br><span class="line">    lb_kind DR</span><br><span class="line">    protocol TCP</span><br><span class="line">    sorry_server 127.0.0.1 80</span><br><span class="line">    real_server 10.0.0.7 80 &#123;</span><br><span class="line">        weight 1</span><br><span class="line">        HTTP_GET &#123;</span><br><span class="line">            url &#123;</span><br><span class="line">                path /monitor.html</span><br><span class="line">                status_code 200</span><br><span class="line">            &#125;</span><br><span class="line">        connect_timeout 1</span><br><span class="line">        nb_get_retry 3</span><br><span class="line">        delay_before_retry 1</span><br><span class="line">   		&#125;</span><br><span class="line">    &#125;</span><br><span class="line">    real_server 10.0.0.17 80 &#123;</span><br><span class="line">        weight 1   </span><br><span class="line">        HTTP_GET &#123;</span><br><span class="line">            url &#123;</span><br><span class="line">                path /</span><br><span class="line">                status_code 200</span><br><span class="line">            &#125;</span><br><span class="line">        connect_timeout 1</span><br><span class="line">        nb_get_retry 3</span><br><span class="line">        delay_before_retry 1</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="TCP监测"><a href="#TCP监测" class="headerlink" title="TCP监测"></a>TCP监测</h3><p>传输层检测：TCP_CHECK</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">TCP_CHECK &#123;</span><br><span class="line">     connect_ip &lt;IP ADDRESS&gt;  <span class="comment">#向当前RS的哪个IP地址发起健康状态检测请求</span></span><br><span class="line">     connect_port &lt;PORT&gt;      <span class="comment">#向当前RS的哪个PORT发起健康状态检测请求</span></span><br><span class="line">     bindto &lt;IP ADDRESS&gt;      <span class="comment">#发出健康状态检测请求时使用的源地址</span></span><br><span class="line">     bind_port &lt;PORT&gt;         <span class="comment">#发出健康状态检测请求时使用的源端口</span></span><br><span class="line">     connect_timeout &lt;INTEGER&gt; <span class="comment">#客户端请求的超时时长, 等于haproxy的timeout server   </span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>范例：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">virtual_server 10.0.0.10 80 &#123;</span><br><span class="line">    delay_loop 6</span><br><span class="line">    lb_algo wrr</span><br><span class="line">    lb_kind DR</span><br><span class="line">    <span class="comment">#persistence_timeout 120   #会话保持时间</span></span><br><span class="line">    protocol TCP</span><br><span class="line">    sorry_server 127.0.0.1 80</span><br><span class="line">    real_server 10.0.0.7 80 &#123;</span><br><span class="line">        weight 1</span><br><span class="line">        TCP_CHECK &#123;</span><br><span class="line">        	connect_timeout 5</span><br><span class="line">       		nb_get_retry 3</span><br><span class="line">        	delay_before_retry 3</span><br><span class="line">          	connect_port 80</span><br><span class="line">       	&#125;</span><br><span class="line">    &#125;</span><br><span class="line">    real_server 10.0.0.17 80 &#123;</span><br><span class="line">        weight 1</span><br><span class="line">        TCP_CHECK &#123;</span><br><span class="line">       		connect_timeout 5</span><br><span class="line">        	nb_get_retry 3</span><br><span class="line">       		delay_before_retry 3</span><br><span class="line">         	connect_port 80</span><br><span class="line">       	&#125; </span><br><span class="line">   	&#125; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="实战案例"><a href="#实战案例" class="headerlink" title="实战案例"></a>实战案例</h2><h3 id="实战案例：实现单主的-LVS-DR-模式"><a href="#实战案例：实现单主的-LVS-DR-模式" class="headerlink" title="实战案例：实现单主的 LVS-DR 模式"></a>实战案例：实现单主的 LVS-DR 模式</h3><p><strong>准备web服务器并使用脚本绑定VIP至web服务器lo网卡</strong></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#准备两台后端RS主机</span></span><br><span class="line">[root@rs1 ~]<span class="comment"># cat lvs_dr_rs.sh</span></span><br><span class="line"><span class="comment">#!/bin/bash</span></span><br><span class="line"><span class="comment">#Author:wangxiaochun</span></span><br><span class="line"><span class="comment">#Date:2017-08-13</span></span><br><span class="line">vip=10.0.0.10</span><br><span class="line">mask=<span class="string">&#x27;255.255.255.255&#x27;</span></span><br><span class="line">dev=lo:1</span><br><span class="line">rpm -q httpd &amp;&gt; /dev/null || yum -y install httpd &amp;&gt;/dev/null</span><br><span class="line">service httpd start &amp;&gt; /dev/null &amp;&amp; <span class="built_in">echo</span> <span class="string">&quot;The httpd Server is Ready!&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;&lt;h1&gt;`hostname`&lt;/h1&gt;&quot;</span> &gt; /var/www/html/index.html</span><br><span class="line"><span class="keyword">case</span> <span class="variable">$1</span> <span class="keyword">in</span></span><br><span class="line">start)</span><br><span class="line">    <span class="built_in">echo</span> 1 &gt; /proc/sys/net/ipv4/conf/all/arp_ignore</span><br><span class="line">    <span class="built_in">echo</span> 1 &gt; /proc/sys/net/ipv4/conf/lo/arp_ignore</span><br><span class="line">    <span class="built_in">echo</span> 2 &gt; /proc/sys/net/ipv4/conf/all/arp_announce</span><br><span class="line">    <span class="built_in">echo</span> 2 &gt; /proc/sys/net/ipv4/conf/lo/arp_announce</span><br><span class="line">   ifconfig <span class="variable">$dev</span> <span class="variable">$vip</span> netmask <span class="variable">$mask</span> <span class="comment">#broadcast $vip up</span></span><br><span class="line">    <span class="comment">#route add -host $vip dev $dev</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;The RS Server is Ready!&quot;</span></span><br><span class="line">   ;;</span><br><span class="line">stop)</span><br><span class="line">   ifconfig <span class="variable">$dev</span> down</span><br><span class="line">    <span class="built_in">echo</span> 0 &gt; /proc/sys/net/ipv4/conf/all/arp_ignore</span><br><span class="line">    <span class="built_in">echo</span> 0 &gt; /proc/sys/net/ipv4/conf/lo/arp_ignore</span><br><span class="line">    <span class="built_in">echo</span> 0 &gt; /proc/sys/net/ipv4/conf/all/arp_announce</span><br><span class="line">    <span class="built_in">echo</span> 0 &gt; /proc/sys/net/ipv4/conf/lo/arp_announce</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;The RS Server is Canceled!&quot;</span></span><br><span class="line">   ;;</span><br><span class="line">*) </span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;Usage: <span class="subst">$(basename $0)</span> start|stop&quot;</span></span><br><span class="line">    <span class="built_in">exit</span> 1</span><br><span class="line">   ;;</span><br><span class="line"><span class="keyword">esac</span></span><br><span class="line"></span><br><span class="line">[root@rs1 ~]<span class="comment"># bash lvs_dr_rs.sh start </span></span><br><span class="line">The httpd Server is Ready!</span><br><span class="line">The RS Server is Ready!</span><br><span class="line"></span><br><span class="line">[root@rs1 ~]<span class="comment"># ip a</span></span><br><span class="line">1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group </span><br><span class="line">default qlen 1000</span><br><span class="line">   <span class="built_in">link</span>/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00</span><br><span class="line">   inet 127.0.0.1/8 scope host lo</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">   inet 10.0.0.10/32 scope global lo:1</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">   inet6 ::1/128 scope host </span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">2: eth0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc pfifo_fast state UP </span><br><span class="line">group default qlen 1000</span><br><span class="line">   <span class="built_in">link</span>/ether 00:0c:29:32:80:38 brd ff:ff:ff:ff:ff:ff</span><br><span class="line">   inet 10.0.0.7/24 brd 10.0.0.255 scope global noprefixroute eth0</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">   inet6 fe80::20c:29ff:fe32:8038/64 scope <span class="built_in">link</span> </span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">       </span><br><span class="line">[root@rs2 ~]<span class="comment"># bash lvs_dr_rs.sh start </span></span><br><span class="line">The httpd Server is Ready!</span><br><span class="line">The RS Server is Ready!</span><br><span class="line"></span><br><span class="line">[root@rs2 ~]<span class="comment"># ip a</span></span><br><span class="line">1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group </span><br><span class="line">default qlen 1000</span><br><span class="line">   <span class="built_in">link</span>/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00</span><br><span class="line">   inet 127.0.0.1/8 scope host lo</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">   inet 10.0.0.10/32 scope global lo:1</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">   inet6 ::1/128 scope host </span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">2: eth0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc pfifo_fast state UP </span><br><span class="line">group default qlen 1000</span><br><span class="line">   <span class="built_in">link</span>/ether 00:0c:29:33:b4:1a brd ff:ff:ff:ff:ff:ff</span><br><span class="line">   inet 10.0.0.17/24 brd 10.0.0.255 scope global noprefixroute eth0</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">   inet6 fe80::20c:29ff:fe33:b41a/64 scope <span class="built_in">link</span> </span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">       </span><br><span class="line"><span class="comment">#测试直接访问两台RS</span></span><br><span class="line">[root@centos6 ~]<span class="comment"># curl 10.0.0.7</span></span><br><span class="line">&lt;h1&gt;rs1.wang.org&lt;/h1&gt;</span><br><span class="line">[root@centos6 ~]<span class="comment"># curl 10.0.0.17</span></span><br><span class="line">&lt;h1&gt;rs2.wang.org&lt;/h1&gt;</span><br></pre></td></tr></table></figure>

<p><strong>配置keepalived</strong></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#ka1节点的配置</span></span><br><span class="line">[root@ka1-centos8 ~]<span class="comment"># cat  /etc/keepalived/keepalived.conf</span></span><br><span class="line">! Configuration File <span class="keyword">for</span> keepalived</span><br><span class="line"></span><br><span class="line">global_defs &#123;</span><br><span class="line">	notification_email &#123;</span><br><span class="line">		root@localhost</span><br><span class="line">	&#125;</span><br><span class="line">	notification_email_from keepalived@localhost</span><br><span class="line">	smtp_server 127.0.0.1</span><br><span class="line">	smtp_connect_timeout 30</span><br><span class="line">	router_id ka1.wang.org</span><br><span class="line">	vrrp_mcast_group4 224.0.100.10</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">vrrp_instance VI_1 &#123;</span><br><span class="line">	state MASTER</span><br><span class="line">	interface eth0</span><br><span class="line">	virtual_router_id 66</span><br><span class="line">	priority 100</span><br><span class="line">	advert_int 1</span><br><span class="line">	authentication &#123;</span><br><span class="line">		auth_type PASS</span><br><span class="line">		auth_pass 123456</span><br><span class="line">	&#125;</span><br><span class="line">	virtual_ipaddress &#123;</span><br><span class="line">		10.0.0.10/24 dev eth0 label eth0:1</span><br><span class="line">	&#125;	</span><br><span class="line"> 	notify_master <span class="string">&quot;/etc/keepalived/notify.sh master&quot;</span></span><br><span class="line"> 	notify_backup <span class="string">&quot;/etc/keepalived/notify.sh backup&quot;</span></span><br><span class="line"> 	notify_fault <span class="string">&quot;/etc/keepalived/notify.sh fault&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">virtual_server 10.0.0.10 80 &#123;</span><br><span class="line">	delay_loop 3</span><br><span class="line">	lb_algo rr</span><br><span class="line">	lb_kind DR</span><br><span class="line">	protocol TCP</span><br><span class="line">	sorry_server 127.0.0.1 80</span><br><span class="line">	real_server 10.0.0.7 80 &#123;</span><br><span class="line">        weight 1</span><br><span class="line">        HTTP_GET &#123;               <span class="comment">#应用层检测</span></span><br><span class="line">            url &#123;</span><br><span class="line">                path /</span><br><span class="line">                status_code 200</span><br><span class="line">            &#125;</span><br><span class="line">            connect_timeout 1</span><br><span class="line">            nb_get_retry 3</span><br><span class="line">            delay_before_retry 1</span><br><span class="line">        &#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">    real_server 10.0.0.17 80 &#123;</span><br><span class="line">        weight 1</span><br><span class="line">        TCP_CHECK &#123;              <span class="comment">#另一台主机使用TCP检测</span></span><br><span class="line">            connect_timeout 5</span><br><span class="line">            nb_get_retry 3</span><br><span class="line">            delay_before_retry 3</span><br><span class="line">            connect_port 80</span><br><span class="line">        &#125;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#ka2节点的配置，配置和ka1基本相同，只需修改三行</span></span><br><span class="line">[root@ka2-centos8 ~]<span class="comment"># cat /etc/keepalived/keepalived.conf</span></span><br><span class="line">! Configuration File <span class="keyword">for</span> keepalived</span><br><span class="line"></span><br><span class="line">global_defs &#123;</span><br><span class="line">	notification_email &#123;</span><br><span class="line">		root@localhost</span><br><span class="line">	&#125;</span><br><span class="line">	notification_email_from keepalived@localhost</span><br><span class="line">	smtp_server 127.0.0.1</span><br><span class="line">	smtp_connect_timeout 30</span><br><span class="line">	router_id ka1.wang.org             <span class="comment">#修改此行</span></span><br><span class="line">	vrrp_mcast_group4 224.0.100.10</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">vrrp_instance VI_1 &#123;</span><br><span class="line">	state BACKUP <span class="comment">#修改此行</span></span><br><span class="line">	interface eth0</span><br><span class="line">	virtual_router_id 66</span><br><span class="line">	priority 80 <span class="comment">#修改此行</span></span><br><span class="line">	advert_int 1</span><br><span class="line">	authentication &#123;</span><br><span class="line">		auth_type PASS</span><br><span class="line">		auth_pass 123456</span><br><span class="line">	&#125;</span><br><span class="line">	virtual_ipaddress &#123;</span><br><span class="line">		10.0.0.10/24 dev eth0 label eth0:1</span><br><span class="line">	&#125;</span><br><span class="line">	notify_master <span class="string">&quot;/etc/keepalived/notify.sh master&quot;</span></span><br><span class="line">	notify_backup <span class="string">&quot;/etc/keepalived/notify.sh backup&quot;</span></span><br><span class="line">	notify_fault <span class="string">&quot;/etc/keepalived/notify.sh fault&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">virtual_server 10.0.0.10 80 &#123;</span><br><span class="line">	delay_loop 3</span><br><span class="line">	lb_algo rr</span><br><span class="line">	lb_kind DR</span><br><span class="line">	protocol TCP</span><br><span class="line">	sorry_server 127.0.0.1 80</span><br><span class="line">	real_server 10.0.0.7 80 &#123;</span><br><span class="line">		weight 1</span><br><span class="line">			HTTP_GET &#123;</span><br><span class="line">				url &#123;</span><br><span class="line">					path /</span><br><span class="line">					status_code 200</span><br><span class="line">				&#125;</span><br><span class="line">				connect_timeout 1</span><br><span class="line">				nb_get_retry 3</span><br><span class="line">				delay_before_retry 1</span><br><span class="line">			&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	real_server 10.0.0.17 80 &#123;</span><br><span class="line">		weight 1</span><br><span class="line">    	TCP_CHECK &#123;</span><br><span class="line">    		connect_timeout 5</span><br><span class="line">       		nb_get_retry 3</span><br><span class="line">       		delay_before_retry 3</span><br><span class="line">            connect_port 80</span><br><span class="line">		&#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>访问测试结果</strong></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[root@centos6 ~]<span class="comment"># curl 10.0.0.10</span></span><br><span class="line">&lt;h1&gt;rs1.wang.org&lt;/h1&gt;</span><br><span class="line"></span><br><span class="line">[root@centos6 ~]<span class="comment"># curl 10.0.0.10</span></span><br><span class="line">&lt;h1&gt;rs2.wang.org&lt;/h1&gt;</span><br><span class="line"></span><br><span class="line">[root@ka1-centos8 ~]<span class="comment"># dnf -y install ipvsadm</span></span><br><span class="line">[root@ka1-centos8 ~]<span class="comment"># ipvsadm -Ln</span></span><br><span class="line">IP Virtual Server version 1.2.1 (size=4096)</span><br><span class="line">Prot LocalAddress:Port Scheduler Flags</span><br><span class="line">  -&gt; RemoteAddress:Port           Forward Weight ActiveConn InActConn</span><br><span class="line">TCP  10.0.0.10:80 rr</span><br><span class="line">  -&gt; 10.0.0.7:80                  Route   1      0          0 </span><br><span class="line">  -&gt; 10.0.0.17:80                 Route   1      0          0 </span><br></pre></td></tr></table></figure>

<p><strong>模拟故障</strong></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#第一台RS1故障，自动切换至RS2</span></span><br><span class="line">[root@rs1 ~]<span class="comment"># chmod 0 /var/www/html/index.html </span></span><br><span class="line">[root@centos6 ~]<span class="comment"># curl 10.0.0.10</span></span><br><span class="line">&lt;h1&gt;rs2.wang.org&lt;/h1&gt;</span><br><span class="line"></span><br><span class="line">[root@centos6 ~]<span class="comment"># curl 10.0.0.10</span></span><br><span class="line">&lt;h1&gt;rs2.wang.org&lt;/h1&gt;</span><br><span class="line"></span><br><span class="line">[root@ka1-centos8 ~]<span class="comment"># dnf -y install ipvsadm</span></span><br><span class="line">[root@ka1-centos8 ~]<span class="comment"># ipvsadm -Ln</span></span><br><span class="line">IP Virtual Server version 1.2.1 (size=4096)</span><br><span class="line">Prot LocalAddress:Port Scheduler Flags</span><br><span class="line">  -&gt; RemoteAddress:Port           Forward Weight ActiveConn InActConn</span><br><span class="line">TCP  10.0.0.10:80 rr</span><br><span class="line">  -&gt; 10.0.0.17:80                 Route   1      0          3  </span><br><span class="line">  </span><br><span class="line"><span class="comment">#后端RS服务器都故障，启动Sorry Server</span></span><br><span class="line">[root@rs2 ~]<span class="comment"># systemctl stop httpd</span></span><br><span class="line">[root@centos6 ~]<span class="comment"># curl 10.0.0.10</span></span><br><span class="line">Sorry Server on ka1</span><br><span class="line"></span><br><span class="line">[root@ka1-centos8 ~]<span class="comment"># ipvsadm -Ln</span></span><br><span class="line">IP Virtual Server version 1.2.1 (size=4096)</span><br><span class="line">Prot LocalAddress:Port Scheduler Flags</span><br><span class="line">  -&gt; RemoteAddress:Port           Forward Weight ActiveConn InActConn</span><br><span class="line">TCP  10.0.0.10:80 rr</span><br><span class="line">  -&gt; 127.0.0.1:80                 Route   1      0          0  </span><br><span class="line"><span class="comment">#ka1故障，自动切换至ka2</span></span><br><span class="line">[root@ka1-centos8 ~]<span class="comment"># killall keepalived</span></span><br><span class="line">[root@centos6 ~]<span class="comment"># curl 10.0.0.10</span></span><br><span class="line">Sorry Server on ka2</span><br><span class="line"></span><br><span class="line"><span class="comment">#恢复都有后端 RS</span></span><br><span class="line">[root@rs1 ~]<span class="comment"># chmod 644 /var/www/html/index.html</span></span><br><span class="line">[root@rs2 ~]<span class="comment"># systemctl start httpd</span></span><br><span class="line">[root@centos6 ~]<span class="comment"># curl 10.0.0.10</span></span><br><span class="line">&lt;h1&gt;rs1.wang.org&lt;/h1&gt;</span><br><span class="line"></span><br><span class="line">[root@centos6 ~]<span class="comment"># curl 10.0.0.10</span></span><br><span class="line">&lt;h1&gt;rs2.wang.org&lt;/h1&gt;</span><br><span class="line"></span><br><span class="line">[root@ka1-centos8 ~]<span class="comment"># hostname -I</span></span><br><span class="line">10.0.0.8 </span><br><span class="line"></span><br><span class="line">[root@ka2-centos8 ~]<span class="comment"># hostname -I</span></span><br><span class="line">10.0.0.18 10.0.0.10 </span><br><span class="line"></span><br><span class="line"><span class="comment">#恢复ka1服务器，又抢占回原来的VIP</span></span><br><span class="line">[root@ka1-centos8 ~]<span class="comment"># systemctl start keepalived.service </span></span><br><span class="line">[root@ka1-centos8 ~]<span class="comment"># hostname -I</span></span><br><span class="line">10.0.0.8 10.0.0.10 </span><br><span class="line"></span><br><span class="line">[root@ka2-centos8 ~]<span class="comment"># hostname -I</span></span><br><span class="line">10.0.0.18 </span><br><span class="line"></span><br><span class="line">[root@centos6 ~]<span class="comment"># curl 10.0.0.10</span></span><br><span class="line">&lt;h1&gt;rs1.wang.org&lt;/h1&gt;</span><br><span class="line"></span><br><span class="line">[root@centos6 ~]<span class="comment"># curl 10.0.0.10</span></span><br><span class="line">&lt;h1&gt;rs2.wang.org&lt;/h1&gt;</span><br></pre></td></tr></table></figure>

<h3 id="实战案例：实现双主的-LVS-DR-模式"><a href="#实战案例：实现双主的-LVS-DR-模式" class="headerlink" title="实战案例：实现双主的 LVS-DR 模式"></a>实战案例：实现双主的 LVS-DR 模式</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br></pre></td><td class="code"><pre><span class="line">[root@ka1-centos8 ~]<span class="comment">#vim /etc/keepalived/keepalived.conf</span></span><br><span class="line">! Configuration File <span class="keyword">for</span> keepalived</span><br><span class="line">global_defs &#123;</span><br><span class="line">	notification_email &#123;</span><br><span class="line">		root@localhost</span><br><span class="line">	&#125;</span><br><span class="line">	notification_email_from keepalived@localhost</span><br><span class="line">	smtp_server 127.0.0.1</span><br><span class="line">	smtp_connect_timeout 30</span><br><span class="line">	router_id ka1.wang.org   <span class="comment">#另一个节点为ka2.wang.org</span></span><br><span class="line">	vrrp_mcast_group4 224.0.100.10</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line">vrrp_instance VI_1 &#123;</span><br><span class="line">	state MASTER     <span class="comment">#在另一个结点上为BACKUP</span></span><br><span class="line">	interface eth0</span><br><span class="line">	virtual_router_id 66</span><br><span class="line">	priority 100         <span class="comment">#在另一个结点上为80</span></span><br><span class="line">	advert_int 1</span><br><span class="line">	authentication &#123;</span><br><span class="line">		auth_type PASS</span><br><span class="line">		auth_pass 123456</span><br><span class="line">	&#125;</span><br><span class="line">	virtual_ipaddress &#123;</span><br><span class="line">		10.0.0.10/24 dev eth0 label eth0:1 <span class="comment">#指定VIP</span></span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">vrrp_instance VI_2 &#123;</span><br><span class="line">	state BACKUP     <span class="comment">#在另一个结点上为MASTER</span></span><br><span class="line">	interface eth0</span><br><span class="line">	virtual_router_id  88</span><br><span class="line">	priority 80         <span class="comment">#在另一个结点上为100</span></span><br><span class="line">	advert_int 1</span><br><span class="line">	authentication &#123;</span><br><span class="line">		auth_type PASS</span><br><span class="line">		auth_pass 123456</span><br><span class="line">	&#125;</span><br><span class="line"> 	virtual_ipaddress &#123;</span><br><span class="line">		10.0.0.20/24 dev eth0 label eth0:2 <span class="comment">#指定VIP2</span></span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">virtual_server 10.0.0.10 80 &#123;  </span><br><span class="line">    delay_loop 6</span><br><span class="line">    lb_algo rr</span><br><span class="line">    lb_kind DR</span><br><span class="line">    protocol TCP</span><br><span class="line">    sorry_server 127.0.0.1 80</span><br><span class="line">    real_server 10.0.0.7 80 &#123;  <span class="comment">#指定RS1地址</span></span><br><span class="line">        weight 1</span><br><span class="line">        HTTP_GET &#123;</span><br><span class="line">            url &#123;</span><br><span class="line">            	path /</span><br><span class="line">                status_code 200</span><br><span class="line">            &#125;</span><br><span class="line">            connect_timeout 3</span><br><span class="line">            nb_get_retry 3</span><br><span class="line">            delay_before_retry 3</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    real_server 10.0.0.17 80 &#123;   <span class="comment">#指定RS2地址</span></span><br><span class="line">        weight 1</span><br><span class="line">        HTTP_GET &#123;</span><br><span class="line">            url &#123;</span><br><span class="line">                path /</span><br><span class="line">                status_code 200</span><br><span class="line">            &#125;</span><br><span class="line">            connect_timeout 3</span><br><span class="line">            nb_get_retry 3</span><br><span class="line">            delay_before_retry 3</span><br><span class="line">        &#125;</span><br><span class="line">   &#125; </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">virtual_server 10.0.0.20 80 &#123; <span class="comment">#指定VIP2</span></span><br><span class="line">	delay_loop 6</span><br><span class="line">	lb_algo rr</span><br><span class="line">	lb_kind DR</span><br><span class="line">	protocol TCP</span><br><span class="line">	sorry_server 127.0.0.1 80</span><br><span class="line">	real_server 10.0.0.27 80 &#123; <span class="comment">#指定RS3地址</span></span><br><span class="line">		weight 1</span><br><span class="line">		HTTP_GET &#123;</span><br><span class="line">			url &#123;</span><br><span class="line">				path /</span><br><span class="line">				status_code 200</span><br><span class="line">			&#125;</span><br><span class="line">			connect_timeout 3</span><br><span class="line">			nb_get_retry 3</span><br><span class="line">			delay_before_retry 3</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	real_server 10.0.0.37 80 &#123;   <span class="comment">#指定RS4地址</span></span><br><span class="line">		weight 1</span><br><span class="line">		HTTP_GET &#123;</span><br><span class="line">			url &#123;</span><br><span class="line">				path /</span><br><span class="line">				status_code 200</span><br><span class="line">			&#125;</span><br><span class="line">			connect_timeout 3</span><br><span class="line">			nb_get_retry 3</span><br><span class="line">			delay_before_retry 3</span><br><span class="line">		&#125;</span><br><span class="line">	&#125; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>范例: 双主分别实现httpd和mysql服务的调度</p>
<p><img src="../../../../images/SRE/day48/10.jpg" alt="10"></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br></pre></td><td class="code"><pre><span class="line">[root@ka1 conf.d]<span class="comment"># cat web1.conf </span></span><br><span class="line">vrrp_instance web1 &#123;</span><br><span class="line">    state MASTER</span><br><span class="line">    interface eth0</span><br><span class="line">    virtual_router_id 66</span><br><span class="line">    priority 100</span><br><span class="line">    advert_int 1</span><br><span class="line">    authentication &#123;</span><br><span class="line">        auth_type PASS</span><br><span class="line">        auth_pass 123456</span><br><span class="line">    &#125;</span><br><span class="line">    virtual_ipaddress &#123;</span><br><span class="line">		10.0.0.100/24 dev eth0 label eth0:100</span><br><span class="line">	&#125;</span><br><span class="line">	notify_master <span class="string">&quot;/etc/keepalived/notify.sh master&quot;</span>             notify_backup <span class="string">&quot;/etc/keepalived/notify.sh backup&quot;</span></span><br><span class="line">	notify_fault <span class="string">&quot;/etc/keepalived/notify.sh fault&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">[root@ka1 conf.d]<span class="comment"># cat lvs_.conf </span></span><br><span class="line">lvs_mysql.conf lvs_web1.conf</span><br><span class="line"></span><br><span class="line">[root@ka1 conf.d]<span class="comment"># cat lvs_web1.conf </span></span><br><span class="line">virtual_server 10.0.0.100 80 &#123;</span><br><span class="line">	delay_loop 3</span><br><span class="line">	lb_algo rr</span><br><span class="line">	lb_kind DR</span><br><span class="line">	protocol TCP</span><br><span class="line">	sorry_server 127.0.0.1 80</span><br><span class="line">	real_server 10.0.0.7 80 &#123;</span><br><span class="line">		weight 1</span><br><span class="line">		HTTP_GET &#123;</span><br><span class="line">			url &#123;</span><br><span class="line">				path /monitor.html</span><br><span class="line"> 				status_code 200</span><br><span class="line">			&#125;</span><br><span class="line">			connect_timeout 1</span><br><span class="line">			nb_get_retry 3</span><br><span class="line">			delay_before_retry 1</span><br><span class="line">		&#125;</span><br><span class="line"> 	&#125;</span><br><span class="line">	real_server 10.0.0.17 80 &#123;</span><br><span class="line">		weight 1</span><br><span class="line">		TCP_CHECK &#123;</span><br><span class="line">        	connect_timeout 5</span><br><span class="line">        	nb_get_retry 3</span><br><span class="line">        	delay_before_retry 3</span><br><span class="line">            connect_port 80</span><br><span class="line">		&#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">[root@ka1 conf.d]<span class="comment"># cat mysql_vip.conf</span></span><br><span class="line">vrrp_instance mysql&#123;</span><br><span class="line">	state BACKUP</span><br><span class="line">    interface eth0</span><br><span class="line">    virtual_router_id 88</span><br><span class="line">    priority 80</span><br><span class="line">    advert_int 1</span><br><span class="line">    authentication &#123;</span><br><span class="line">        auth_type PASS</span><br><span class="line">        auth_pass 123456</span><br><span class="line">    &#125;</span><br><span class="line">    virtual_ipaddress &#123;</span><br><span class="line"> 		10.0.0.200/24 dev eth0 label eth0:200</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">[root@ka1 conf.d]<span class="comment"># cat lvs_mysql.conf</span></span><br><span class="line">virtual_server 10.0.0.200 3306 &#123;</span><br><span class="line">	delay_loop 3</span><br><span class="line">	lb_algo rr</span><br><span class="line">	lb_kind DR</span><br><span class="line">	protocol TCP</span><br><span class="line">	real_server 10.0.0.7 3306 &#123;</span><br><span class="line">		weight 1</span><br><span class="line">		TCP_CHECK &#123;</span><br><span class="line">			connect_timeout 5</span><br><span class="line">			nb_get_retry 3</span><br><span class="line">			delay_before_retry 3</span><br><span class="line">            connect_port 3306</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	real_server 10.0.0.17 3306 &#123;</span><br><span class="line">		weight 1</span><br><span class="line">		TCP_CHECK &#123;</span><br><span class="line"> 			connect_timeout 5</span><br><span class="line">        	nb_get_retry 3</span><br><span class="line">        	delay_before_retry 3</span><br><span class="line">            connect_port 3306</span><br><span class="line"> 		&#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">#注意:在后端服务器要实现两个VIP的配置</span></span><br><span class="line">[root@web1 ~]<span class="comment"># ip a show lo</span></span><br><span class="line">1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group </span><br><span class="line">default qlen 1000</span><br><span class="line">   <span class="built_in">link</span>/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00</span><br><span class="line">   inet 127.0.0.1/8 scope host lo</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">   inet 10.0.0.100/32 scope global lo:1</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">   inet 10.0.0.200/32 scope global lo:2</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">   inet6 ::1/128 scope host </span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">       </span><br><span class="line">       </span><br><span class="line">[root@ka1 ~]<span class="comment"># ipvsadm -Ln</span></span><br><span class="line">IP Virtual Server version 1.2.1 (size=4096)</span><br><span class="line">Prot LocalAddress:Port Scheduler Flags</span><br><span class="line">  -&gt; RemoteAddress:Port           Forward Weight ActiveConn InActConn</span><br><span class="line">TCP  10.0.0.100:80 rr</span><br><span class="line">  -&gt; 10.0.0.7:80                 Route   1      0          0         </span><br><span class="line">  -&gt; 10.0.0.17:80                 Route   1      0          0         </span><br><span class="line">TCP  10.0.0.200:3306 rr</span><br><span class="line">  -&gt; 10.0.0.7:3306               Route   1      0          0         </span><br><span class="line">  -&gt; 10.0.0.17:3306               Route   1      0          0    </span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line"><span class="comment">#测试</span></span><br><span class="line">[root@client ~]<span class="comment"># while true;do mysql -utest -p123456 -h10.0.0.200 -e &#x27;show variables like &quot;%hostname%&quot;&#x27;;curl 10.0.0.100;sleep 0.5;done</span></span><br><span class="line">+---------------+-----------------+</span><br><span class="line">| Variable_name | Value           |</span><br><span class="line">+---------------+-----------------+</span><br><span class="line">| hostname      | web1.wang.org   |</span><br><span class="line">+---------------+-----------------+</span><br><span class="line">10.0.0.17 </span><br><span class="line">+---------------+-----------------+</span><br><span class="line">| Variable_name | Value           |</span><br><span class="line">+---------------+-----------------+</span><br><span class="line">| hostname      | web2.wang.org   |</span><br><span class="line">+---------------+-----------------+</span><br><span class="line">10.0.0.7 </span><br></pre></td></tr></table></figure>

<h3 id="实战案例：实现单主的-LVS-DR-模式，利用FWM绑定成多个服-务为一个集群服务"><a href="#实战案例：实现单主的-LVS-DR-模式，利用FWM绑定成多个服-务为一个集群服务" class="headerlink" title="实战案例：实现单主的 LVS-DR 模式，利用FWM绑定成多个服 务为一个集群服务"></a>实战案例：实现单主的 LVS-DR 模式，利用FWM绑定成多个服 务为一个集群服务</h3><p>参考文档： 注意有bug</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/usr/share/doc/keepalived/keepalived.conf.fwmark</span><br></pre></td></tr></table></figure>

<p>范例：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#两个节点都执行以下操作</span></span><br><span class="line">[root@ka1-centos8 ~]<span class="comment"># iptables -t mangle -A PREROUTING -d 10.0.0.10   -p tcp -m multiport --dports 80,443 -j MARK --set-mark 6</span></span><br><span class="line">[root@ka1-centos8 ~]<span class="comment"># vim /etc/keepalived/keepalived.conf</span></span><br><span class="line">! Configuration File <span class="keyword">for</span> keepalived</span><br><span class="line">global_defs &#123;</span><br><span class="line">	notification_email &#123;</span><br><span class="line">		root@localhost</span><br><span class="line">	&#125;</span><br><span class="line">	notification_email_from kaadmin@localhost</span><br><span class="line">	smtp_server 127.0.0.1</span><br><span class="line">	smtp_connect_timeout 30</span><br><span class="line">	router_id ka1.wang.org <span class="comment">#在另一个节点为ka2.wang.org</span></span><br><span class="line">	vrrp_mcast_group4 224.100.100.100</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line">vrrp_instance VI_1 &#123;</span><br><span class="line">	state MASTER <span class="comment">#在另一个节点为BACKUP</span></span><br><span class="line">	interface eth0</span><br><span class="line">	virtual_router_id 66</span><br><span class="line">	priority 100 <span class="comment">#在另一个节点为80</span></span><br><span class="line">	advert_int 1</span><br><span class="line">	authentication &#123;</span><br><span class="line">		auth_type PASS</span><br><span class="line">		auth_pass 123456</span><br><span class="line">	&#125;</span><br><span class="line">	virtual_ipaddress &#123;</span><br><span class="line"> 		10.0.0.10/24 dev eth0 label eth0:1</span><br><span class="line">	&#125;</span><br><span class="line">	track_interface &#123;</span><br><span class="line">		eth0</span><br><span class="line">	&#125;</span><br><span class="line">	notify_master <span class="string">&quot;/etc/keepalived/notify.sh master&quot;</span></span><br><span class="line">	notify_backup <span class="string">&quot;/etc/keepalived/notify.sh backup&quot;</span></span><br><span class="line">	notify_fault <span class="string">&quot;/etc/keepalived/notify.sh fault&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">virtual_server fwmark 6 &#123;   <span class="comment">#指定FWM为6 </span></span><br><span class="line">	delay_loop 2</span><br><span class="line">	lb_algo rr</span><br><span class="line">	lb_kind DR</span><br><span class="line">	sorry_server 127.0.0.1 80  <span class="comment">#注意端口必须指定</span></span><br><span class="line">	real_server 10.0.0.7 80 &#123;  <span class="comment">#注意端口必须指定</span></span><br><span class="line">		weight 1</span><br><span class="line">		HTTP_GET &#123;</span><br><span class="line">			url &#123;</span><br><span class="line">				path /</span><br><span class="line">				status_code 200</span><br><span class="line">			&#125;</span><br><span class="line">			connect_timeout 2</span><br><span class="line">			nb_get_retry 3</span><br><span class="line">			delay_before_retry 3</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	real_server 10.0.0.17 80 &#123; <span class="comment">#注意端口必须指定,只用于健康性检查,而非通信</span></span><br><span class="line">		weight 1</span><br><span class="line">		HTTP_GET &#123;</span><br><span class="line">			url &#123;</span><br><span class="line">				path /</span><br><span class="line">				status_code 200</span><br><span class="line">			&#125;</span><br><span class="line">			connect_timeout 2</span><br><span class="line">			nb_get_retry 3</span><br><span class="line">			delay_before_retry 3</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">#在RS1和RS2运行下面脚本</span></span><br><span class="line">[root@rs1 ~]<span class="comment"># cat lvs_dr_rs.sh </span></span><br><span class="line"><span class="comment">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line">vip=10.0.0.10</span><br><span class="line">vip2=10.0.0.20</span><br><span class="line">mask=<span class="string">&#x27;255.255.255.255&#x27;</span></span><br><span class="line">dev=lo:1</span><br><span class="line">dev2=lo:2</span><br><span class="line">rpm -q httpd &amp;&gt; /dev/null || yum -y install httpd &amp;&gt;/dev/null</span><br><span class="line">service httpd start &amp;&gt; /dev/null &amp;&amp; <span class="built_in">echo</span> <span class="string">&quot;The httpd Server is Ready!&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;&lt;h1&gt;`hostname`&lt;/h1&gt;&quot;</span> &gt; /var/www/html/index.html</span><br><span class="line"></span><br><span class="line"><span class="keyword">case</span> <span class="variable">$1</span> <span class="keyword">in</span></span><br><span class="line">start)</span><br><span class="line">    <span class="built_in">echo</span> 1 &gt; /proc/sys/net/ipv4/conf/all/arp_ignore</span><br><span class="line">    <span class="built_in">echo</span> 1 &gt; /proc/sys/net/ipv4/conf/lo/arp_ignore</span><br><span class="line">    <span class="built_in">echo</span> 2 &gt; /proc/sys/net/ipv4/conf/all/arp_announce</span><br><span class="line">    <span class="built_in">echo</span> 2 &gt; /proc/sys/net/ipv4/conf/lo/arp_announce</span><br><span class="line">   ifconfig <span class="variable">$dev</span> <span class="variable">$vip</span> netmask <span class="variable">$mask</span> <span class="comment">#broadcast $vip up</span></span><br><span class="line">   ifconfig <span class="variable">$dev2</span> <span class="variable">$vip2</span> netmask <span class="variable">$mask</span> <span class="comment">#broadcast $vip up</span></span><br><span class="line">    <span class="comment">#route add -host $vip dev $dev</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;The RS Server is Ready!&quot;</span></span><br><span class="line">   ;;</span><br><span class="line">stop)</span><br><span class="line">   ifconfig <span class="variable">$dev</span> down</span><br><span class="line">   ifconfig <span class="variable">$dev2</span> down</span><br><span class="line">    <span class="built_in">echo</span> 0 &gt; /proc/sys/net/ipv4/conf/all/arp_ignore</span><br><span class="line">    <span class="built_in">echo</span> 0 &gt; /proc/sys/net/ipv4/conf/lo/arp_ignore</span><br><span class="line">    <span class="built_in">echo</span> 0 &gt; /proc/sys/net/ipv4/conf/all/arp_announce</span><br><span class="line">    <span class="built_in">echo</span> 0 &gt; /proc/sys/net/ipv4/conf/lo/arp_announce</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;The RS Server is Canceled!&quot;</span></span><br><span class="line">   ;;</span><br><span class="line">*) </span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;Usage: <span class="subst">$(basename $0)</span> start|stop&quot;</span></span><br><span class="line">    <span class="built_in">exit</span> 1</span><br><span class="line">   ;;</span><br><span class="line"><span class="keyword">esac</span></span><br><span class="line"></span><br><span class="line">[root@rs1 ~]<span class="comment"># bash lvs_dr_rs.sh start</span></span><br><span class="line">[root@rs2 ~]<span class="comment"># bash lvs_dr_rs.sh start</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#访问测试</span></span><br><span class="line">[root@centos6 ~]<span class="comment"># curl 10.0.0.10;curl -k https://10.0.0.20</span></span><br><span class="line">&lt;h1&gt;rs1.wang.org&lt;/h1&gt;</span><br><span class="line">&lt;h1&gt;rs2.wang.org&lt;/h1&gt;</span><br></pre></td></tr></table></figure>

<h1 id="基于-VRRP-Script-实现其它应用的高可用性"><a href="#基于-VRRP-Script-实现其它应用的高可用性" class="headerlink" title="基于 VRRP Script 实现其它应用的高可用性"></a>基于 VRRP Script 实现其它应用的高可用性</h1><p>keepalived利用 VRRP Script 技术，可以调用外部的辅助脚本进行资源监控，并根据监控的结果实现优先动态调整，从而实现其它应用的高可用性功能</p>
<p>参考配置文件：</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/usr/share/doc/keepalived/keepalived.conf.vrrp.localcheck</span><br></pre></td></tr></table></figure>

<h2 id="VRRP-Script-配置"><a href="#VRRP-Script-配置" class="headerlink" title="VRRP Script 配置"></a>VRRP Script 配置</h2><p><strong>分两步实现</strong>：</p>
<ul>
<li><p>定义脚本</p>
<p>vrrp_script：自定义资源监控脚本，vrrp实例根据脚本返回值，公共定义，可被多个实例调用，定义在vrrp实例之外的独立配置块，一般放在global_defs设置块之后,是和global_defs平级的语句块</p>
<p>通常此脚本用于监控指定应用的状态。一旦发现应用的状态异常，则触发对MASTER节点的权重减至低于SLAVE节点，从而实现 VIP 切换到 SLAVE 节点</p>
<p>当 keepalived_script 用户存在时,会以此用户身份运行脚本,否则默认以root运行脚本</p>
<p>注意: 此定义脚本的语句块一定要放在下面调用此语句vrrp_instance语句块的前面</p>
</li>
</ul>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">vrrp_script &lt;SCRIPT_NAME&gt; &#123;</span><br><span class="line">	script &lt;STRING&gt;|&lt;QUOTED-STRING&gt;   #此脚本返回值为非0时，会触发下面OPTIONS执行</span><br><span class="line">	OPTIONS </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><p>调用脚本</p>
<p>track_script：调用vrrp_script定义的脚本去监控资源，定义在VRRP实例之内，调用事先定义的vrrp_script</p>
</li>
</ul>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">track_script &#123;</span><br><span class="line">	SCRIPT_NAME_1</span><br><span class="line">	SCRIPT_NAME_2</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="定义-VRRP-script"><a href="#定义-VRRP-script" class="headerlink" title="定义 VRRP script"></a>定义 VRRP script</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">vrrp_script &lt;SCRIPT_NAME&gt; &#123; <span class="comment">#定义一个检测脚本，在global_defs 之外配置</span></span><br><span class="line">     script &lt;STRING&gt;|&lt;QUOTED-STRING&gt;  <span class="comment">#shell命令或脚本路径</span></span><br><span class="line">     interval &lt;INTEGER&gt;               <span class="comment">#间隔时间，单位为秒，默认1秒</span></span><br><span class="line">     <span class="built_in">timeout</span> &lt;INTEGER&gt;                <span class="comment">#超时时间</span></span><br><span class="line">     weight &lt;INTEGER:-254..254&gt;       <span class="comment">#默认为0,如果设置此值为负数，当上面脚本返回值为非0时，会将此值与本节点权重相加可以降低本节点权重，即表示fall. 如果是正数，当脚本返回值为0，会将此值与本节点权重相加可以提高本节点权重，即表示 rise.通常使用负值</span></span><br><span class="line">     fall &lt;INTEGER&gt;                   <span class="comment">#执行脚本连续几次都失败,则转换为失败，建议设为2以上</span></span><br><span class="line">     rise &lt;INTEGER&gt;                   <span class="comment">#执行脚本连续几次都成功，把服务器从失败标记为成功</span></span><br><span class="line">     user USERNAME [GROUPNAME]        <span class="comment">#执行监测脚本的用户或组</span></span><br><span class="line">     init_fail                        <span class="comment">#设置默认标记为失败状态，监测成功之后再转换为成功状态</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="调用-VRRP-script"><a href="#调用-VRRP-script" class="headerlink" title="调用 VRRP script"></a>调用 VRRP script</h3><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">vrrp_instance VI_1 &#123;</span><br><span class="line">	…</span><br><span class="line">	track_script &#123;</span><br><span class="line">		&lt;SCRIPT_NAME&gt;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="实战案例：利用脚本实现主从角色切换"><a href="#实战案例：利用脚本实现主从角色切换" class="headerlink" title="实战案例：利用脚本实现主从角色切换"></a>实战案例：利用脚本实现主从角色切换</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line">[root@ka1-centos8 ~]<span class="comment"># cat /etc/keepalived/keepalived.conf</span></span><br><span class="line">! Configuration File <span class="keyword">for</span> keepalived</span><br><span class="line">global_defs &#123;</span><br><span class="line">	notification_email &#123;</span><br><span class="line">		root@localhost</span><br><span class="line">	&#125;</span><br><span class="line">	notification_email_from kaadmin@localhost</span><br><span class="line">	smtp_server 127.0.0.1</span><br><span class="line">	smtp_connect_timeout 30</span><br><span class="line">	router_id ka1.wang.org <span class="comment">#在另一个节点为ka2.wang.org</span></span><br><span class="line">	vrrp_mcast_group4 224.0.100.100</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">vrrp_script check_down &#123;</span><br><span class="line">    script <span class="string">&quot;[ ! -f /etc/keepalived/down ]&quot;</span> <span class="comment">#/etc/keepalived/down存在时返回非0，触发权重-30</span></span><br><span class="line">    interval 1</span><br><span class="line">    weight -30</span><br><span class="line">    fall 3</span><br><span class="line">    rise 2</span><br><span class="line">    <span class="built_in">timeout</span> 2</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">vrrp_instance VI_1 &#123;</span><br><span class="line">	state MASTER <span class="comment">#在另一个节点为BACKUP</span></span><br><span class="line">	interface eth0</span><br><span class="line">	virtual_router_id 66</span><br><span class="line">	priority 100 <span class="comment">#在另一个节点为80</span></span><br><span class="line">	advert_int 1</span><br><span class="line">	authentication &#123;</span><br><span class="line">		auth_type PASS</span><br><span class="line">		auth_pass 123456</span><br><span class="line">	&#125;</span><br><span class="line">	virtual_ipaddress &#123;</span><br><span class="line">		10.0.0.10/24 dev eth0 label eth0:1</span><br><span class="line">	&#125;</span><br><span class="line">	track_interface &#123;</span><br><span class="line">		eth0</span><br><span class="line">	&#125;</span><br><span class="line">	notify_master <span class="string">&quot;/etc/keepalived/notify.sh master&quot;</span></span><br><span class="line">	notify_backup <span class="string">&quot;/etc/keepalived/notify.sh backup&quot;</span></span><br><span class="line">	notify_fault <span class="string">&quot;/etc/keepalived/notify.sh fault&quot;</span></span><br><span class="line">  	track_script &#123;</span><br><span class="line">        check_down           <span class="comment">#调用前面定义的脚本</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">[root@ka1-centos8 ~]<span class="comment"># touch /etc/keepalived/down</span></span><br><span class="line">[root@ka1-centos8 ~]<span class="comment"># tail -f /var/log/messages </span></span><br><span class="line">Mar 28 19:47:03 ka1-centos8 Keepalived_vrrp[7200]: Script `check_down` now returning 1</span><br><span class="line">Mar 28 19:47:05 ka1-centos8 Keepalived_vrrp[7200]: VRRP_Script(chk_down) failed (exited with status 1)</span><br><span class="line">Mar 28 19:47:05 ka1-centos8 Keepalived_vrrp[7200]: (VI_1) Changing effective priority from 100 to 70</span><br><span class="line">Mar 28 19:47:07 ka1-centos8 Keepalived_vrrp[7200]: (VI_1) Master received advert </span><br><span class="line">from 10.0.0.18 with higher priority 80, ours 70</span><br><span class="line">Mar 28 19:47:07 ka1-centos8 Keepalived_vrrp[7200]: (VI_1) Entering BACKUP STATE</span><br><span class="line">Mar 28 19:47:07 ka1-centos8 Keepalived_vrrp[7200]: (VI_1) removing VIPs.</span><br><span class="line"></span><br><span class="line">[root@rs1 ~]<span class="comment"># tcpdump -i eth0 -nn 224.0.100.100</span></span><br><span class="line">19:42:09.578203 IP 10.0.0.8 &gt; 224.0.100.100: VRRPv2, Advertisement, vrid 66, </span><br><span class="line">prio 100, authtype simple, intvl 1s, length 20</span><br><span class="line">19:42:10.579304 IP 10.0.0.8 &gt; 224.0.100.100: VRRPv2, Advertisement, vrid 66, </span><br><span class="line">prio 70, authtype simple, intvl 1s, length 20</span><br><span class="line"></span><br><span class="line">[root@ka1-centos8 ~]<span class="comment"># rm -f /etc/keepalived/down</span></span><br><span class="line">[root@ka1-centos8 ~]<span class="comment"># tail -f /var/log/messages </span></span><br><span class="line">Mar 28 19:47:45 ka1-centos8 Keepalived_vrrp[7200]: Script `check_down` now returning 0</span><br><span class="line">Mar 28 19:47:46 ka1-centos8 Keepalived_vrrp[7200]: VRRP_Script(check_down) succeeded</span><br><span class="line">Mar 28 19:47:46 ka1-centos8 Keepalived_vrrp[7200]: (VI_1) Changing effective priority from 70 to 100</span><br><span class="line">Mar 28 19:47:46 ka1-centos8 Keepalived_vrrp[7200]: (VI_1) received lower priority (80) advert from 10.0.0.18 - discarding</span><br><span class="line">Mar 28 19:47:47 ka1-centos8 Keepalived_vrrp[7200]: (VI_1) received lower priority (80) advert from 10.0.0.18 - discarding</span><br><span class="line">Mar 28 19:47:48 ka1-centos8 Keepalived_vrrp[7200]: (VI_1) received lower priority (80) advert from 10.0.0.18 - discarding</span><br><span class="line">Mar 28 19:47:49 ka1-centos8 Keepalived_vrrp[7200]: (VI_1) Receive advertisement <span class="built_in">timeout</span></span><br><span class="line">Mar 28 19:47:49 ka1-centos8 Keepalived_vrrp[7200]: (VI_1) Entering MASTER STATE</span><br><span class="line">Mar 28 19:47:49 ka1-centos8 Keepalived_vrrp[7200]: (VI_1) setting VIPs.</span><br><span class="line">Mar 28 19:47:49 ka1-centos8 Keepalived_vrrp[7200]: Sending gratuitous ARP on eth0 <span class="keyword">for</span> 10.0.0.10</span><br><span class="line">Mar 28 19:47:49 ka1-centos8 Keepalived_vrrp[7200]: (VI_1) Sending/queueing gratuitous ARPs on eth0 <span class="keyword">for</span> 10.0.0.10</span><br><span class="line">Mar 28 19:47:49 ka1-centos8 Keepalived_vrrp[7200]: Sending gratuitous ARP on eth0 <span class="keyword">for</span> 10.0.0.10</span><br><span class="line">Mar 28 19:47:49 ka1-centos8 Keepalived_vrrp[7200]: Sending gratuitous ARP on eth0 <span class="keyword">for</span> 10.0.0.10</span><br><span class="line"></span><br><span class="line">[root@rs1 ~]<span class="comment"># tcpdump -i eth0 -nn 224.0.100.100</span></span><br><span class="line">19:49:16.199462 IP 10.0.0.18 &gt; 224.0.100.100: VRRPv2, Advertisement, vrid 66, prio 80, authtype simple, intvl 1s, length 20</span><br><span class="line">19:49:17.199897 IP 10.0.0.18 &gt; 224.0.100.100: VRRPv2, Advertisement, vrid 66, prio 80, authtype simple, intvl 1s, length 20</span><br><span class="line">19:49:17.810376 IP 10.0.0.8 &gt; 224.0.100.100: VRRPv2, Advertisement, vrid 66, prio 100, authtype simple, intvl 1s, length 20</span><br><span class="line">19:49:18.811048 IP 10.0.0.8 &gt; 224.0.100.100: VRRPv2, Advertisement, vrid 66, prio 100, authtype simple, intvl 1s, length 20</span><br></pre></td></tr></table></figure>

<h2 id="实战案例：实现单主模式的-Nginx-反向代理的高可用"><a href="#实战案例：实现单主模式的-Nginx-反向代理的高可用" class="headerlink" title="实战案例：实现单主模式的 Nginx 反向代理的高可用"></a>实战案例：实现单主模式的 Nginx 反向代理的高可用</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#在两个节点都配置nginx反向代理</span></span><br><span class="line">[root@ka1-centos8 ~]<span class="comment">#vim /etc/nginx/nginx.conf</span></span><br><span class="line">http &#123;</span><br><span class="line">	upstream websrvs &#123;</span><br><span class="line">		server 10.0.0.7:80 weight=1;</span><br><span class="line">		server 10.0.0.17:80 weight=1;</span><br><span class="line">	&#125;</span><br><span class="line">	server &#123;</span><br><span class="line">		listen 80;</span><br><span class="line">		location /&#123;</span><br><span class="line">			proxy_pass http://websrvs/;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">#在两个节点都配置实现nginx反向代理高可用</span></span><br><span class="line">[root@ka1-centos8 ~]<span class="comment"># cat /etc/keepalived/keepalived.conf</span></span><br><span class="line">! Configuration File <span class="keyword">for</span> keepalived</span><br><span class="line">global_defs &#123;</span><br><span class="line">	notification_email &#123;</span><br><span class="line">		root@localhost</span><br><span class="line">	&#125;</span><br><span class="line">	notification_email_from kaadmin@localhost</span><br><span class="line">	smtp_server 127.0.0.1</span><br><span class="line">	smtp_connect_timeout 30</span><br><span class="line">	router_id ka1.wang.org <span class="comment">#在另一个节点为ka2.wang.org</span></span><br><span class="line">	vrrp_mcast_group4 224.0.100.100</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">vrrp_script check_nginx &#123;</span><br><span class="line">    script <span class="string">&quot;/etc/keepalived/check_nginx.sh&quot;</span></span><br><span class="line">    <span class="comment">#script &quot;/usr/bin/killall -0 nginx&quot;   此写法支持</span></span><br><span class="line">    <span class="comment">#script &quot;/usr/bin/killall -0 nginx &amp;&gt;/dev/null&quot; 不支持&amp;&gt;此写法</span></span><br><span class="line">    interval 1</span><br><span class="line">    weight -30</span><br><span class="line">    fall 3</span><br><span class="line">    rise 5</span><br><span class="line">    <span class="built_in">timeout</span> 2</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">vrrp_instance VI_1 &#123;</span><br><span class="line">	state MASTER <span class="comment">#在另一个节点为BACKUP</span></span><br><span class="line">	interface eth0</span><br><span class="line">	virtual_router_id 66</span><br><span class="line">	priority 100 <span class="comment">#在另一个节点为80</span></span><br><span class="line">	advert_int 1</span><br><span class="line">	authentication &#123;</span><br><span class="line">		auth_type PASS</span><br><span class="line">		auth_pass 123456</span><br><span class="line">	&#125;</span><br><span class="line">	virtual_ipaddress &#123;</span><br><span class="line">		10.0.0.10/24 dev eth0 label eth0:1</span><br><span class="line">	&#125;</span><br><span class="line">	track_interface &#123;</span><br><span class="line">		eth0</span><br><span class="line">	&#125;</span><br><span class="line">	notify_master <span class="string">&quot;/etc/keepalived/notify.sh master&quot;</span></span><br><span class="line">	notify_backup <span class="string">&quot;/etc/keepalived/notify.sh backup&quot;</span></span><br><span class="line">	notify_fault <span class="string">&quot;/etc/keepalived/notify.sh fault&quot;</span></span><br><span class="line">	track_script &#123;</span><br><span class="line">		check_nginx</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">[root@ka1-centos8 ~]<span class="comment"># yum install psmisc -y</span></span><br><span class="line">[root@ka1-centos8 ~]<span class="comment"># cat /etc/keepalived/check_nginx.sh</span></span><br><span class="line"><span class="comment">#!/bin/bash</span></span><br><span class="line">/usr/bin/killall -0 nginx || systemctl restart nginx</span><br><span class="line"></span><br><span class="line">[root@ka1-centos8 ~]<span class="comment"># chmod a+x /etc/keepalived/check_nginx.sh</span></span><br></pre></td></tr></table></figure>

<p>范例: 利用通知脚本,实现切换时，自动重启服务</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/keepalived/notify.sh</span><br><span class="line">!/bin/bash</span><br><span class="line">contact=<span class="string">&#x27;root@localhost&#x27;</span></span><br><span class="line"><span class="function"><span class="title">notify</span></span>() &#123;</span><br><span class="line">	mailsubject=<span class="string">&quot;<span class="subst">$(hostname)</span> to be  <span class="variable">$1</span>:vip floating&quot;</span></span><br><span class="line">	mailbody=<span class="string">&quot;<span class="subst">$(date +&#x27;%F %T&#x27;)</span>:vrrp transition,<span class="subst">$(hostname)</span> change to be <span class="variable">$1</span>&quot;</span></span><br><span class="line">	<span class="built_in">echo</span> <span class="variable">$mailbody</span> | mail -s <span class="string">&quot;<span class="variable">$mailsubject</span>&quot;</span> <span class="variable">$contract</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">case</span> <span class="variable">$1</span> <span class="keyword">in</span></span><br><span class="line">master)</span><br><span class="line">	notify master</span><br><span class="line">	systemctl start nginx</span><br><span class="line">	;;</span><br><span class="line">backup)</span><br><span class="line">	notify backup</span><br><span class="line">	systemctl restart nginx </span><br><span class="line">	;;</span><br><span class="line">fault)</span><br><span class="line">	notify fault</span><br><span class="line">	;;</span><br><span class="line">*)</span><br><span class="line">	<span class="built_in">echo</span> <span class="string">&quot;Usage: <span class="subst">$(basename $0)</span> &#123;master|backup|fault&#125;&quot;</span></span><br><span class="line"><span class="keyword">esac</span></span><br></pre></td></tr></table></figure>

<h2 id="实战案例：实现双主模式-Nginx-反向代理的高可用"><a href="#实战案例：实现双主模式-Nginx-反向代理的高可用" class="headerlink" title="实战案例：实现双主模式 Nginx 反向代理的高可用"></a>实战案例：实现双主模式 Nginx 反向代理的高可用</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#在两个节点都配置nginx反向代理</span></span><br><span class="line">[root@ka1-centos8 ~]<span class="comment"># vim /etc/nginx/nginx.conf</span></span><br><span class="line">http &#123;</span><br><span class="line">	upstream websrvs &#123;</span><br><span class="line">		server 10.0.0.7:80 weight=1;</span><br><span class="line">		server 10.0.0.17:80 weight-1;</span><br><span class="line">	&#125;</span><br><span class="line">	upstream websrvs2 &#123;</span><br><span class="line">		server 10.0.0.27:80 weight=1;</span><br><span class="line">		server 10.0.0.37:80 weight-1;</span><br><span class="line">	&#125;</span><br><span class="line">	server &#123;</span><br><span class="line">		listen 80;</span><br><span class="line">		server_name www.a.com;</span><br><span class="line">		location /&#123;</span><br><span class="line">			proxy_pass http://webservs/;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	server &#123;</span><br><span class="line">		listen 80;</span><br><span class="line">		server_name www.b.com;</span><br><span class="line">		location /&#123;</span><br><span class="line">			proxy_pass http://webservs2/;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">#在两个节点都配置实现双主模式的nginx反向代理高可用</span></span><br><span class="line">[root@ka1-centos8 ~]<span class="comment"># cat /etc/keepalived/keepalived.conf</span></span><br><span class="line">! Configuration File <span class="keyword">for</span> keepalived</span><br><span class="line">global_defs &#123;</span><br><span class="line">	notification_email &#123;</span><br><span class="line">		root@localhost</span><br><span class="line"> 	&#125;</span><br><span class="line">	notification_email_from kaadmin@localhost</span><br><span class="line">	smtp_server 127.0.0.1</span><br><span class="line">	smtp_connect_timeout 30</span><br><span class="line"> 	router_id ka1.wang.org <span class="comment">#在另一个节点为ka2.wang.org</span></span><br><span class="line">	vrrp_mcast_group4 224.100.100.100</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">vrrp_script check_nginx &#123;</span><br><span class="line">    script <span class="string">&quot;/etc/keepalived/check_nginx.sh&quot;</span></span><br><span class="line">    <span class="comment">#script &quot;/usr/bin/killall -0 nginx&quot;</span></span><br><span class="line">    interval 1</span><br><span class="line">    weight -30</span><br><span class="line">    fall 3</span><br><span class="line">    rise 5</span><br><span class="line">    <span class="built_in">timeout</span> 2</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">vrrp_instance VI_1 &#123;</span><br><span class="line">	state MASTER <span class="comment">#在另一个节点为BACKUP</span></span><br><span class="line"> 	interface eth0</span><br><span class="line"> 	virtual_router_id 66</span><br><span class="line"> 	priority 100 <span class="comment">#在另一个节点为80</span></span><br><span class="line"> 	advert_int 1</span><br><span class="line"> 	authentication &#123;</span><br><span class="line"> 		auth_type PASS</span><br><span class="line"> 		auth_pass 123456</span><br><span class="line"> 	&#125;</span><br><span class="line"> 	virtual_ipaddress &#123;</span><br><span class="line">		10.0.0.10/24 dev eth0 label eth0:1</span><br><span class="line"> 	&#125;</span><br><span class="line"> 	track_interface &#123;</span><br><span class="line"> 		eth0</span><br><span class="line"> 	&#125;</span><br><span class="line"> 	notify_master <span class="string">&quot;/etc/keepalived/notify.sh master&quot;</span></span><br><span class="line"> 	notify_backup <span class="string">&quot;/etc/keepalived/notify.sh backup&quot;</span></span><br><span class="line"> 	notify_fault <span class="string">&quot;/etc/keepalived/notify.sh fault&quot;</span></span><br><span class="line"> 	track_script &#123;</span><br><span class="line"> 		check_nginx</span><br><span class="line"> 	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">vrrp_instance VI_2 &#123;</span><br><span class="line">	state BACKUP <span class="comment">#在另一个节点为MASTER</span></span><br><span class="line"> 	interface eth0</span><br><span class="line"> 	virtual_router_id 88</span><br><span class="line"> 	priority 80 <span class="comment">#在另一个节点为100</span></span><br><span class="line"> 	advert_int 1</span><br><span class="line"> 	authentication &#123;</span><br><span class="line"> 		auth_type PASS</span><br><span class="line"> 		auth_pass 123456</span><br><span class="line"> 	&#125;</span><br><span class="line"> 	virtual_ipaddress &#123;</span><br><span class="line"> 		10.0.0.20/24 dev eth0 label eth0:2</span><br><span class="line"> 	&#125;</span><br><span class="line"> 	track_interface &#123;</span><br><span class="line"> 		eth0</span><br><span class="line"> 	&#125;</span><br><span class="line"> 	notify_master <span class="string">&quot;/etc/keepalived/notify.sh master&quot;</span></span><br><span class="line"> 	notify_backup <span class="string">&quot;/etc/keepalived/notify.sh backup&quot;</span></span><br><span class="line"> 	notify_fault <span class="string">&quot;/etc/keepalived/notify.sh fault&quot;</span></span><br><span class="line"> 	track_script &#123;</span><br><span class="line"> 		check_nginx</span><br><span class="line"> 	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">[root@ka1-centos8 ~]<span class="comment"># yum install psmisc -y</span></span><br><span class="line">[root@ka1-centos8 ~]<span class="comment"># cat /etc/keepalived/check_nginx.sh</span></span><br><span class="line"><span class="comment">#!/bin/bash</span></span><br><span class="line">/usr/bin/killall -0 nginx</span><br><span class="line">[root@ka1-centos8 ~]<span class="comment"># chmod a+x /etc/keepalived/check_nginx.sh</span></span><br></pre></td></tr></table></figure>

<h2 id="实战案例：实现-HAProxy-高可用"><a href="#实战案例：实现-HAProxy-高可用" class="headerlink" title="实战案例：实现 HAProxy 高可用"></a>实战案例：实现 HAProxy 高可用</h2><p><img src="../../../../images/SRE/day48/11.jpg" alt="11"></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#先实现MySQL的双主架构</span></span><br><span class="line">[root@ka1-centos8 ~]<span class="comment"># vim /etc/my.cnf.d/mariadb-server.cnf </span></span><br><span class="line">[mysqld]</span><br><span class="line">server-id=8</span><br><span class="line">log-bin</span><br><span class="line">auto_increment_offset=1         <span class="comment">#开始点</span></span><br><span class="line">auto_increment_increment=2      <span class="comment">#增长幅度 </span></span><br><span class="line"></span><br><span class="line"><span class="comment">#在ka2第二个节点创建连接MySQL查看同步状态的授权用户</span></span><br><span class="line">[root@ka2-centos8 ~]<span class="comment"># mysql -uroot -p123456</span></span><br><span class="line">MariaDB [(none)]&gt; grant replication slave on *.* to repluser@<span class="string">&#x27;10.0.0.%&#x27;</span> </span><br><span class="line">identified by <span class="string">&#x27;123456&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">#实现MySQL的健康性检测脚本1</span></span><br><span class="line">[root@ka1-centos8 ~]<span class="comment"># vi /etc/keepalived/check_mysql.sh</span></span><br><span class="line"><span class="comment">#!/bin/bash</span></span><br><span class="line">slave_is=( $(mysql -uroot -p123456 -h10.0.0.18 -e <span class="string">&quot;show slave status\G&quot;</span> | grep <span class="string">&quot;Slave_.*_Running:&quot;</span> | awk <span class="string">&#x27;&#123;print $2&#125;&#x27;</span>) )</span><br><span class="line"><span class="keyword">if</span> [ <span class="string">&quot;<span class="variable">$&#123;slave_is[0]&#125;</span>&quot;</span> = <span class="string">&quot;Yes&quot;</span> -a <span class="string">&quot;<span class="variable">$&#123;slave_is[1]&#125;</span>&quot;</span> = <span class="string">&quot;Yes&quot;</span> ];<span class="keyword">then</span></span><br><span class="line">	<span class="built_in">exit</span> 0</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">	<span class="built_in">exit</span> 1</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#实现MySQL的健康性检测脚本2</span></span><br><span class="line">[root@ka1-centos8 ~]<span class="comment"># vi /etc/keepalived/check_mysql.sh</span></span><br><span class="line">mysqladmin -uroot -p123456  ping &amp;&gt; /dev/null</span><br><span class="line"></span><br><span class="line"><span class="comment">#实现MySQL的健康性检测脚本3</span></span><br><span class="line">[root@ka1-centos8 ~]<span class="comment"># vi /etc/keepalived/check_mysql.sh</span></span><br><span class="line">mysql  -uroot -p123456 -e <span class="string">&#x27;status&#x27;</span> &amp;&gt; /dev/null</span><br><span class="line"></span><br><span class="line"><span class="comment">#实现MySQL的健康性检测脚本4</span></span><br><span class="line">[root@ka1-centos8 ~]<span class="comment"># vi /etc/keepalived/check_mysql.sh</span></span><br><span class="line">systemctl is-active mariadb &amp;&gt; /dev/null</span><br><span class="line"></span><br><span class="line"><span class="comment">#配置keepalived调用上面脚本</span></span><br><span class="line">[root@ka1-centos8 ~]<span class="comment"># cat /etc/keepalived/keepalived.conf</span></span><br><span class="line">! Configuration File <span class="keyword">for</span> keepalived</span><br><span class="line">global_defs &#123;</span><br><span class="line">	notification_email &#123;</span><br><span class="line">		root@localhost</span><br><span class="line">	&#125;</span><br><span class="line">	notification_email_from kaadmin@localhost</span><br><span class="line">	smtp_server 127.0.0.1</span><br><span class="line">	smtp_connect_timeout 30</span><br><span class="line">	router_id ka1.wang.org <span class="comment">#在另一个节点为ka2.wang.org</span></span><br><span class="line">	vrrp_mcast_group4 224.0.100.100</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">vrrp_script check_mysql &#123; <span class="comment">#只需在第一个节点上实现脚本</span></span><br><span class="line">    script <span class="string">&quot;/etc/keepalived/check_mysql.sh&quot;</span></span><br><span class="line">    interval 1</span><br><span class="line">    weight -30</span><br><span class="line">    fall 3</span><br><span class="line">    rise 2</span><br><span class="line">    <span class="built_in">timeout</span> 2</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">vrrp_instance VI_1 &#123;</span><br><span class="line">	state MASTER <span class="comment">#在另一个节点为BACKUP</span></span><br><span class="line">	interface eth0</span><br><span class="line">	virtual_router_id 66</span><br><span class="line">	priority 100 <span class="comment">#在另一个节点为80</span></span><br><span class="line">	advert_int 1</span><br><span class="line">	authentication &#123;</span><br><span class="line">		auth_type PASS</span><br><span class="line">		auth_pass 123456</span><br><span class="line">	&#125;</span><br><span class="line">	virtual_ipaddress &#123;</span><br><span class="line">		10.0.0.10/24 dev eth0 label eth0:1</span><br><span class="line"> 	&#125;</span><br><span class="line"> 	track_interface &#123;</span><br><span class="line"> 		eth0</span><br><span class="line"> 	&#125;</span><br><span class="line"> 	notify_master <span class="string">&quot;/etc/keepalived/notify.sh master&quot;</span></span><br><span class="line"> 	notify_backup <span class="string">&quot;/etc/keepalived/notify.sh backup&quot;</span></span><br><span class="line"> 	notify_fault <span class="string">&quot;/etc/keepalived/notify.sh fault&quot;</span></span><br><span class="line">   	track_script &#123;</span><br><span class="line">    	check_mysql <span class="comment">#只需在第一个节点上实现脚本</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="实战案例：实现-Zabbix-Server-的高可用"><a href="#实战案例：实现-Zabbix-Server-的高可用" class="headerlink" title="实战案例：实现 Zabbix Server 的高可用"></a>实战案例：实现 Zabbix Server 的高可用</h2><p><img src="../../../../images/SRE/day48/12.jpg" alt="12"></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#在两个Zabbix Server 使用下面相同的配置</span></span><br><span class="line">[root@ka1 ~]<span class="comment"># grep -i SourceIP= /etc/zabbix/zabbix_server.conf </span></span><br><span class="line">SourceIP=10.0.0.10</span><br><span class="line"></span><br><span class="line">[root@ka1 ~]<span class="comment"># grep -i &#x27;^server=&#x27; /etc/zabbix/zabbix_agentd.conf </span></span><br><span class="line">Server=127.0.0.1,10.0.0.10</span><br><span class="line"></span><br><span class="line">[root@ka1 ~]<span class="comment"># systemctl enable zabbix-server.service</span></span><br><span class="line">[root@ka2 ~]<span class="comment"># systemctl disable zabbix-server.service</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#keepalived相关配置</span></span><br><span class="line"><span class="comment">#ka1节点配置</span></span><br><span class="line">[root@ka1 ~]<span class="comment"># cat /etc/keepalived/keepalived.conf</span></span><br><span class="line">! Configuration File <span class="keyword">for</span> keepalived</span><br><span class="line">global_defs &#123;</span><br><span class="line">    notification_email &#123;</span><br><span class="line">        root@wangxiaochun.com</span><br><span class="line">    &#125;</span><br><span class="line">    notification_email_from 29308620@qq.com</span><br><span class="line">    smtp_server 127.0.0.1</span><br><span class="line">    smtp_connect_timeout 30</span><br><span class="line">    router_id ka1.wang.org</span><br><span class="line">    vrrp_skip_check_adv_addr</span><br><span class="line">    <span class="comment">#vrrp_strict</span></span><br><span class="line">    vrrp_garp_interval 0</span><br><span class="line">    vrrp_gna_interval 0</span><br><span class="line">    vrrp_mcast_group4 230.6.6.6</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">#指定检测脚本</span></span><br><span class="line">vrrp_script check_zabbix_server&#123;</span><br><span class="line">    script <span class="string">&quot;/usr/bin/killall -0 zabbix_server&quot;</span></span><br><span class="line">    interval 1</span><br><span class="line">    weight -30</span><br><span class="line">    fall 2</span><br><span class="line">    rise 2</span><br><span class="line">    <span class="built_in">timeout</span> 2</span><br><span class="line">&#125;</span><br><span class="line">include /etc/keepalived/conf.d/*.conf</span><br><span class="line"></span><br><span class="line">[root@ka1 ~]<span class="comment"># cat /etc/keepalived/conf.d/vip_zabbix.conf </span></span><br><span class="line">vrrp_instance VI_1 &#123;</span><br><span class="line">    state MASTER</span><br><span class="line">    interface eth0</span><br><span class="line">    virtual_router_id 66</span><br><span class="line">    priority 100</span><br><span class="line">    advert_int 1</span><br><span class="line">    authentication &#123;</span><br><span class="line">        auth_type PASS</span><br><span class="line">        auth_pass 123456</span><br><span class="line">    &#125;</span><br><span class="line">    virtual_ipaddress &#123;</span><br><span class="line">        10.0.0.10/24 dev eth0 label eth0:1</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">#notify_master &quot;systemctl start zabbix-server&quot;</span></span><br><span class="line">    <span class="comment">#notify_backup &quot;systemctl stop zabbix-server&quot;</span></span><br><span class="line">    track_script &#123;</span><br><span class="line">        check_zabbix_server</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">#ka2节点框配置</span></span><br><span class="line">[root@ka2 ~]<span class="comment"># cat /etc/keepalived/conf.d/vip_zabbix.conf </span></span><br><span class="line">vrrp_instance VI_1 &#123;</span><br><span class="line">    state BACKUP</span><br><span class="line">    interface eth0</span><br><span class="line">    virtual_router_id 66</span><br><span class="line">    priority 80</span><br><span class="line">    advert_int 1</span><br><span class="line">    authentication &#123;</span><br><span class="line">        auth_type PASS</span><br><span class="line">        auth_pass 123456</span><br><span class="line">    &#125;</span><br><span class="line">    virtual_ipaddress &#123;</span><br><span class="line">        10.0.0.10/24 dev eth0 label eth0:1</span><br><span class="line">    &#125;</span><br><span class="line">    notify_master <span class="string">&quot;systemctl start zabbix-server&quot;</span></span><br><span class="line">    notify_backup <span class="string">&quot;systemctl stop zabbix-server&quot;</span></span><br><span class="line">    track_script &#123;</span><br><span class="line">    <span class="comment">#   check_zabbix_server #在ka2节点不能启用脚本,否则会导致ka2节点也降低优先级,从而切换失败</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="综合实战案例"><a href="#综合实战案例" class="headerlink" title="综合实战案例"></a>综合实战案例</h1><p><img src="../../../../images/SRE/day48/13.jpg" alt="13"></p>
<ul>
<li>编译安装 HAProxy 新版 LTS 版本，编译安装 Keepalived</li>
<li>开启HAProxy多线程，线程数与CPU核心数保持一致,并绑定CPU核心</li>
<li>因业务较多避免配置文件误操作，需要按每业务一个配置文件并统一保存至/etc/haproxy/conf.d 目录中</li>
<li>基于ACL实现单IP多域名负载功能,两个域名的业务: <a target="_blank" rel="noopener" href="http://www.wang.org/">www.wang.org</a> 和 <a target="_blank" rel="noopener" href="http://www.wang.net/">www.wang.net</a></li>
<li>实现MySQL主从复制，并通过HAProxy对MySQL进行四层反向代理</li>
<li>对 <a target="_blank" rel="noopener" href="http://www.wang.net/">www.wang.net</a> 域名基于HAProxy+Nginx+PHP+MySQL+Redis，实现phpMyadmin的PHP应用,并实现Session会话保持统一保存到Redis</li>
<li>对 <a target="_blank" rel="noopener" href="http://www.wang.org/">www.wang.org</a> 域名基于HAProxy+Nginx+Tomcat+MySQL，并实现Jpress的JAVA应用</li>
</ul>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="http://example.com">૮(˶ᵔ ᵕ ᵔ˶)ა</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="http://example.com/2025/04/16/SRE-Keepalived/">http://example.com/2025/04/16/SRE-Keepalived/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="http://example.com" target="_blank">૮(˶ᵔ ᵕ ᵔ˶)ა</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/Keepalived/">Keepalived</a><a class="post-meta__tags" href="/tags/SRE/">SRE</a></div><div class="post_share"><div class="social-share" data-image="/../images/SRE/day48/1.jpg" data-sites="wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2025/04/15/SRE-HAProxy/" title="高可用性集群HAProxy"><img class="cover" src="/../images/SRE/day47/1.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">高可用性集群HAProxy</div></div></a></div><div class="next-post pull-right"><a href="/2025/04/19/SRE-redis/" title="企业级NoSQL数据库Redis"><img class="cover" src="/../images/SRE/day49/1.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">企业级NoSQL数据库Redis</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><div><a href="/2023/04/11/DN-Keepalived/" title="Keepalived"><img class="cover" src="/../images/TITLE/keepalived.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-04-11</div><div class="title">Keepalived</div></div></a></div><div><a href="/2025/04/15/SRE-HAProxy/" title="高可用性集群HAProxy"><img class="cover" src="/../images/SRE/day47/1.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2025-04-15</div><div class="title">高可用性集群HAProxy</div></div></a></div><div><a href="/2025/02/21/SRE-LVS/" title="企业级调度器LVS"><img class="cover" src="/../images/SRE/day27/3.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2025-02-21</div><div class="title">企业级调度器LVS</div></div></a></div><div><a href="/2024/04/24/SRE-Linux%E5%9F%BA%E6%9C%AC%E6%93%8D%E4%BD%9C%E5%92%8C%E5%B8%AE%E5%8A%A9/" title="Linux基本操作和帮助"><img class="cover" src="/../images/TITLE/linux2.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-04-24</div><div class="title">Linux基本操作和帮助</div></div></a></div><div><a href="/2024/08/27/SRE-Linux%E6%96%87%E4%BB%B6%E7%AE%A1%E7%90%86%E5%92%8CIO%E9%87%8D%E5%AE%9A%E5%90%91/" title="Linux文件管理和IO重定向"><img class="cover" src="/../images/TITLE/linux3.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-08-27</div><div class="title">Linux文件管理和IO重定向</div></div></a></div><div><a href="/2024/12/08/SRE-Linux%E9%98%B2%E7%81%AB%E5%A2%99/" title="Linux防火墙"><img class="cover" src="/../images/SRE/day17/12.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-12-08</div><div class="title">Linux防火墙</div></div></a></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="/../images/TITLE/user.webp" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">૮(˶ᵔ ᵕ ᵔ˶)ა</div><div class="author-info__description">这家伙很勤奋，什么都留下了</div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">105</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">42</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">35</div></a></div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content is-expand"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Keepalived-%E6%9E%B6%E6%9E%84%E5%92%8C%E5%AE%89%E8%A3%85"><span class="toc-number">1.</span> <span class="toc-text">Keepalived 架构和安装</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Keepalived-%E4%BB%8B%E7%BB%8D"><span class="toc-number">1.1.</span> <span class="toc-text">Keepalived 介绍</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Keepalived-%E6%9E%B6%E6%9E%84"><span class="toc-number">1.2.</span> <span class="toc-text">Keepalived 架构</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Keepalived-%E7%8E%AF%E5%A2%83%E5%87%86%E5%A4%87"><span class="toc-number">1.3.</span> <span class="toc-text">Keepalived 环境准备</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Keepalived-%E7%9B%B8%E5%85%B3%E6%96%87%E4%BB%B6"><span class="toc-number">1.4.</span> <span class="toc-text">Keepalived 相关文件</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Keepalived-%E5%AE%89%E8%A3%85"><span class="toc-number">1.5.</span> <span class="toc-text">Keepalived 安装</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8C%85%E5%AE%89%E8%A3%85"><span class="toc-number">1.5.1.</span> <span class="toc-text">包安装</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#CentOS-%E5%AE%89%E8%A3%85-keepalived"><span class="toc-number">1.5.1.1.</span> <span class="toc-text">CentOS 安装 keepalived</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Ubuntu-%E5%AE%89%E8%A3%85-keepalived"><span class="toc-number">1.5.1.2.</span> <span class="toc-text">Ubuntu 安装 keepalived</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BC%96%E8%AF%91%E5%AE%89%E8%A3%85"><span class="toc-number">1.5.2.</span> <span class="toc-text">编译安装</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#KeepAlived-%E9%85%8D%E7%BD%AE%E8%AF%B4%E6%98%8E"><span class="toc-number">1.6.</span> <span class="toc-text">KeepAlived 配置说明</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%E7%BB%84%E6%88%90%E9%83%A8%E5%88%86"><span class="toc-number">1.6.1.</span> <span class="toc-text">配置文件组成部分</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE%E8%AF%AD%E6%B3%95%E8%AF%B4%E6%98%8E"><span class="toc-number">1.6.2.</span> <span class="toc-text">配置语法说明</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%85%A8%E5%B1%80%E9%85%8D%E7%BD%AE"><span class="toc-number">1.6.2.1.</span> <span class="toc-text">全局配置</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE%E8%99%9A%E6%8B%9F%E8%B7%AF%E7%94%B1%E5%99%A8"><span class="toc-number">1.6.2.2.</span> <span class="toc-text">配置虚拟路由器</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%90%AF%E7%94%A8-Keepalived-%E6%97%A5%E5%BF%97%E5%8A%9F%E8%83%BD"><span class="toc-number">1.7.</span> <span class="toc-text">启用 Keepalived 日志功能</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0-Keepalived-%E7%8B%AC%E7%AB%8B%E5%AD%90%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6"><span class="toc-number">1.8.</span> <span class="toc-text">实现 Keepalived 独立子配置文件</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Keepalived-%E5%AE%9E%E7%8E%B0-VRRP"><span class="toc-number">2.</span> <span class="toc-text">Keepalived 实现 VRRP</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0master-slave%E7%9A%84-Keepalived-%E5%8D%95%E4%B8%BB%E6%9E%B6%E6%9E%84"><span class="toc-number">2.1.</span> <span class="toc-text">实现master&#x2F;slave的 Keepalived 单主架构</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#MASTER%E9%85%8D%E7%BD%AE"><span class="toc-number">2.1.1.</span> <span class="toc-text">MASTER配置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#BACKUP%E9%85%8D%E7%BD%AE"><span class="toc-number">2.1.2.</span> <span class="toc-text">BACKUP配置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%84%91%E8%A3%82"><span class="toc-number">2.1.3.</span> <span class="toc-text">脑裂</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%8A%A2%E5%8D%A0%E6%A8%A1%E5%BC%8F%E5%92%8C%E9%9D%9E%E6%8A%A2%E5%8D%A0%E6%A8%A1%E5%BC%8F"><span class="toc-number">2.2.</span> <span class="toc-text">抢占模式和非抢占模式</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%9D%9E%E6%8A%A2%E5%8D%A0%E6%A8%A1%E5%BC%8F-nopreempt"><span class="toc-number">2.2.1.</span> <span class="toc-text">非抢占模式 nopreempt</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%8A%A2%E5%8D%A0%E5%BB%B6%E8%BF%9F%E6%A8%A1%E5%BC%8F-preempt-delay"><span class="toc-number">2.2.2.</span> <span class="toc-text">抢占延迟模式 preempt_delay</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#VIP-%E5%8D%95%E6%92%AD%E9%85%8D%E7%BD%AE"><span class="toc-number">2.3.</span> <span class="toc-text">VIP 单播配置</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Keepalived-%E9%80%9A%E7%9F%A5%E8%84%9A%E6%9C%AC%E9%85%8D%E7%BD%AE"><span class="toc-number">2.4.</span> <span class="toc-text">Keepalived 通知脚本配置</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%80%9A%E7%9F%A5%E8%84%9A%E6%9C%AC%E7%B1%BB%E5%9E%8B"><span class="toc-number">2.4.1.</span> <span class="toc-text">通知脚本类型</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%84%9A%E6%9C%AC%E7%9A%84%E8%B0%83%E7%94%A8%E6%96%B9%E6%B3%95"><span class="toc-number">2.4.2.</span> <span class="toc-text">脚本的调用方法</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9E%E6%88%98%E6%A1%88%E4%BE%8B1%EF%BC%9A%E5%AE%9E%E7%8E%B0-Keepalived-%E7%8A%B6%E6%80%81%E5%88%87%E6%8D%A2%E7%9A%84%E9%80%9A%E7%9F%A5%E8%84%9A%E6%9C%AC"><span class="toc-number">2.4.3.</span> <span class="toc-text">实战案例1：实现 Keepalived 状态切换的通知脚本</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9E%E6%88%98%E6%A1%88%E4%BE%8B2%EF%BC%9A%E5%AE%9E%E7%8E%B0-Keepalived-%E7%8A%B6%E6%80%81%E5%88%87%E6%8D%A2%E7%9A%84%E9%80%9A%E7%9F%A5%E8%84%9A%E6%9C%AC"><span class="toc-number">2.4.4.</span> <span class="toc-text">实战案例2：实现 Keepalived 状态切换的通知脚本</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%82%AE%E4%BB%B6%E9%85%8D%E7%BD%AE"><span class="toc-number">2.4.4.1.</span> <span class="toc-text">邮件配置</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E9%80%9A%E7%9F%A5%E8%84%9A%E6%9C%AC"><span class="toc-number">2.4.4.2.</span> <span class="toc-text">创建通知脚本</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0-Master-Master-%E7%9A%84-Keepalived-%E5%8F%8C%E4%B8%BB%E6%9E%B6%E6%9E%84"><span class="toc-number">2.5.</span> <span class="toc-text">实现 Master&#x2F;Master 的 Keepalived 双主架构</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0%E5%A4%9A%E4%B8%BB%E6%A8%A1%E6%9E%B6%E6%9E%84"><span class="toc-number">2.6.</span> <span class="toc-text">实现多主模架构</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%A1%88%E4%BE%8B%EF%BC%9A%E4%B8%89%E4%B8%AA%E8%8A%82%E7%82%B9%E7%9A%84%E4%B8%89%E4%B8%BB%E4%B8%89%E4%BB%8E%E6%9E%B6%E6%9E%84%E5%AE%9E%E7%8E%B0"><span class="toc-number">2.6.1.</span> <span class="toc-text">案例：三个节点的三主三从架构实现</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%A1%88%E4%BE%8B%EF%BC%9A%E4%B8%89%E4%B8%AA%E8%8A%82%E7%82%B9%E7%9A%84%E4%B8%89%E4%B8%BB%E5%85%AD%E4%BB%8E%E6%9E%B6%E6%9E%84%E5%AE%9E%E7%8E%B0"><span class="toc-number">2.6.2.</span> <span class="toc-text">案例：三个节点的三主六从架构实现</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%90%8C%E6%AD%A5%E7%BB%84"><span class="toc-number">2.7.</span> <span class="toc-text">同步组</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0-IPVS-%E7%9A%84%E9%AB%98%E5%8F%AF%E7%94%A8%E6%80%A7"><span class="toc-number">3.</span> <span class="toc-text">实现 IPVS 的高可用性</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#IPVS-%E7%9B%B8%E5%85%B3%E9%85%8D%E7%BD%AE"><span class="toc-number">3.1.</span> <span class="toc-text">IPVS 相关配置</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%99%9A%E6%8B%9F%E6%9C%8D%E5%8A%A1%E5%99%A8%E9%85%8D%E7%BD%AE%E7%BB%93%E6%9E%84"><span class="toc-number">3.1.1.</span> <span class="toc-text">虚拟服务器配置结构</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Virtual-Server-%EF%BC%88%E8%99%9A%E6%8B%9F%E6%9C%8D%E5%8A%A1%E5%99%A8%EF%BC%89%E7%9A%84%E5%AE%9A%E4%B9%89%E6%A0%BC%E5%BC%8F"><span class="toc-number">3.1.2.</span> <span class="toc-text">Virtual Server （虚拟服务器）的定义格式</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%99%9A%E6%8B%9F%E6%9C%8D%E5%8A%A1%E5%99%A8%E7%BB%84"><span class="toc-number">3.1.3.</span> <span class="toc-text">虚拟服务器组</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%99%9A%E6%8B%9F%E6%9C%8D%E5%8A%A1%E5%99%A8%E9%85%8D%E7%BD%AE"><span class="toc-number">3.1.4.</span> <span class="toc-text">虚拟服务器配置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%BA%94%E7%94%A8%E5%B1%82%E7%9B%91%E6%B5%8B"><span class="toc-number">3.1.5.</span> <span class="toc-text">应用层监测</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#TCP%E7%9B%91%E6%B5%8B"><span class="toc-number">3.1.6.</span> <span class="toc-text">TCP监测</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%9E%E6%88%98%E6%A1%88%E4%BE%8B"><span class="toc-number">3.2.</span> <span class="toc-text">实战案例</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9E%E6%88%98%E6%A1%88%E4%BE%8B%EF%BC%9A%E5%AE%9E%E7%8E%B0%E5%8D%95%E4%B8%BB%E7%9A%84-LVS-DR-%E6%A8%A1%E5%BC%8F"><span class="toc-number">3.2.1.</span> <span class="toc-text">实战案例：实现单主的 LVS-DR 模式</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9E%E6%88%98%E6%A1%88%E4%BE%8B%EF%BC%9A%E5%AE%9E%E7%8E%B0%E5%8F%8C%E4%B8%BB%E7%9A%84-LVS-DR-%E6%A8%A1%E5%BC%8F"><span class="toc-number">3.2.2.</span> <span class="toc-text">实战案例：实现双主的 LVS-DR 模式</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9E%E6%88%98%E6%A1%88%E4%BE%8B%EF%BC%9A%E5%AE%9E%E7%8E%B0%E5%8D%95%E4%B8%BB%E7%9A%84-LVS-DR-%E6%A8%A1%E5%BC%8F%EF%BC%8C%E5%88%A9%E7%94%A8FWM%E7%BB%91%E5%AE%9A%E6%88%90%E5%A4%9A%E4%B8%AA%E6%9C%8D-%E5%8A%A1%E4%B8%BA%E4%B8%80%E4%B8%AA%E9%9B%86%E7%BE%A4%E6%9C%8D%E5%8A%A1"><span class="toc-number">3.2.3.</span> <span class="toc-text">实战案例：实现单主的 LVS-DR 模式，利用FWM绑定成多个服 务为一个集群服务</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%9F%BA%E4%BA%8E-VRRP-Script-%E5%AE%9E%E7%8E%B0%E5%85%B6%E5%AE%83%E5%BA%94%E7%94%A8%E7%9A%84%E9%AB%98%E5%8F%AF%E7%94%A8%E6%80%A7"><span class="toc-number">4.</span> <span class="toc-text">基于 VRRP Script 实现其它应用的高可用性</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#VRRP-Script-%E9%85%8D%E7%BD%AE"><span class="toc-number">4.1.</span> <span class="toc-text">VRRP Script 配置</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9A%E4%B9%89-VRRP-script"><span class="toc-number">4.1.1.</span> <span class="toc-text">定义 VRRP script</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%B0%83%E7%94%A8-VRRP-script"><span class="toc-number">4.1.2.</span> <span class="toc-text">调用 VRRP script</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%9E%E6%88%98%E6%A1%88%E4%BE%8B%EF%BC%9A%E5%88%A9%E7%94%A8%E8%84%9A%E6%9C%AC%E5%AE%9E%E7%8E%B0%E4%B8%BB%E4%BB%8E%E8%A7%92%E8%89%B2%E5%88%87%E6%8D%A2"><span class="toc-number">4.2.</span> <span class="toc-text">实战案例：利用脚本实现主从角色切换</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%9E%E6%88%98%E6%A1%88%E4%BE%8B%EF%BC%9A%E5%AE%9E%E7%8E%B0%E5%8D%95%E4%B8%BB%E6%A8%A1%E5%BC%8F%E7%9A%84-Nginx-%E5%8F%8D%E5%90%91%E4%BB%A3%E7%90%86%E7%9A%84%E9%AB%98%E5%8F%AF%E7%94%A8"><span class="toc-number">4.3.</span> <span class="toc-text">实战案例：实现单主模式的 Nginx 反向代理的高可用</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%9E%E6%88%98%E6%A1%88%E4%BE%8B%EF%BC%9A%E5%AE%9E%E7%8E%B0%E5%8F%8C%E4%B8%BB%E6%A8%A1%E5%BC%8F-Nginx-%E5%8F%8D%E5%90%91%E4%BB%A3%E7%90%86%E7%9A%84%E9%AB%98%E5%8F%AF%E7%94%A8"><span class="toc-number">4.4.</span> <span class="toc-text">实战案例：实现双主模式 Nginx 反向代理的高可用</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%9E%E6%88%98%E6%A1%88%E4%BE%8B%EF%BC%9A%E5%AE%9E%E7%8E%B0-HAProxy-%E9%AB%98%E5%8F%AF%E7%94%A8"><span class="toc-number">4.5.</span> <span class="toc-text">实战案例：实现 HAProxy 高可用</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%9E%E6%88%98%E6%A1%88%E4%BE%8B%EF%BC%9A%E5%AE%9E%E7%8E%B0-Zabbix-Server-%E7%9A%84%E9%AB%98%E5%8F%AF%E7%94%A8"><span class="toc-number">4.6.</span> <span class="toc-text">实战案例：实现 Zabbix Server 的高可用</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%BB%BC%E5%90%88%E5%AE%9E%E6%88%98%E6%A1%88%E4%BE%8B"><span class="toc-number">5.</span> <span class="toc-text">综合实战案例</span></a></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2025/08/21/XM-CICD/" title="利用CICD自动更新组件"><img src="/../images/SRE/day55/1.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="利用CICD自动更新组件"/></a><div class="content"><a class="title" href="/2025/08/21/XM-CICD/" title="利用CICD自动更新组件">利用CICD自动更新组件</a><time datetime="2025-08-21T09:34:09.000Z" title="发表于 2025-08-21 17:34:09">2025-08-21</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2025/08/10/MY-k8s%E5%AE%B9%E5%BF%8D%E6%B1%A1%E7%82%B9%E4%BA%B2%E5%92%8CHPA/" title="容忍/污点/亲和/HPA"><img src="/../images/SRE/day46/1.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="容忍/污点/亲和/HPA"/></a><div class="content"><a class="title" href="/2025/08/10/MY-k8s%E5%AE%B9%E5%BF%8D%E6%B1%A1%E7%82%B9%E4%BA%B2%E5%92%8CHPA/" title="容忍/污点/亲和/HPA">容忍/污点/亲和/HPA</a><time datetime="2025-08-10T09:35:57.000Z" title="发表于 2025-08-10 17:35:57">2025-08-10</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2025/08/01/MY-Proxy/" title="Proxy 代理"><img src="/../images/MY/clash.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Proxy 代理"/></a><div class="content"><a class="title" href="/2025/08/01/MY-Proxy/" title="Proxy 代理">Proxy 代理</a><time datetime="2025-08-01T11:05:46.000Z" title="发表于 2025-08-01 19:05:46">2025-08-01</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2025/07/30/MY-k8s1.29/" title="K8S 1.29.2"><img src="/../images/SRE/day46/1.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="K8S 1.29.2"/></a><div class="content"><a class="title" href="/2025/07/30/MY-k8s1.29/" title="K8S 1.29.2">K8S 1.29.2</a><time datetime="2025-07-30T07:17:21.000Z" title="发表于 2025-07-30 15:17:21">2025-07-30</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2023 - 2025 By ૮(˶ᵔ ᵕ ᵔ˶)ა</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div><div class="footer_custom_text"><a target="_blank" rel="noopener" href="https://beian.miit.gov.cn/#/Integrated/index"><img src="../images/BEIAN/icp.png" width="15" height="15">豫ICP备2023009931号</a></br><a href="http://www.beian.gov.cn/portal/registerSystemInfo?recordcode=41162702000178" target="_blank"><img src="../images/BEIAN/beian.png" width="15" height="15">豫公网安备 41162702000178号</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.umd.min.js"></script><script src="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.js"></script><script>function panguFn () {
  if (typeof pangu === 'object') pangu.autoSpacingPage()
  else {
    getScript('https://cdn.jsdelivr.net/npm/pangu/dist/browser/pangu.min.js')
      .then(() => {
        pangu.autoSpacingPage()
      })
  }
}

function panguInit () {
  if (true){
    GLOBAL_CONFIG_SITE.isPost && panguFn()
  } else {
    panguFn()
  }
}

document.addEventListener('DOMContentLoaded', panguInit)</script><div class="js-pjax"></div><canvas id="universe"></canvas><script src="/js/universe.js"></script><canvas class="fireworks" mobile="true"></canvas><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/fireworks.min.js"></script><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/activate-power-mode.min.js"></script><script>POWERMODE.colorful = true;
POWERMODE.shake = false;
POWERMODE.mobile = false;
document.body.addEventListener('input', POWERMODE);
</script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>