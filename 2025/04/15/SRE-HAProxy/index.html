<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>高可用性集群HAProxy | ૮(˶ᵔ ᵕ ᵔ˶)ა</title><meta name="author" content="૮(˶ᵔ ᵕ ᵔ˶)ა"><meta name="copyright" content="૮(˶ᵔ ᵕ ᵔ˶)ა"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="ffffff"><meta name="description" content="Site Reliability Engineering">
<meta property="og:type" content="article">
<meta property="og:title" content="高可用性集群HAProxy">
<meta property="og:url" content="http://example.com/2025/04/15/SRE-HAProxy/index.html">
<meta property="og:site_name" content="૮(˶ᵔ ᵕ ᵔ˶)ა">
<meta property="og:description" content="Site Reliability Engineering">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://example.com/images/SRE/day47/1.jpg">
<meta property="article:published_time" content="2025-04-15T15:51:45.000Z">
<meta property="article:modified_time" content="2025-04-15T15:52:11.646Z">
<meta property="article:author" content="૮(˶ᵔ ᵕ ᵔ˶)ა">
<meta property="article:tag" content="SRE">
<meta property="article:tag" content="HAProxy">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://example.com/images/SRE/day47/1.jpg"><link rel="shortcut icon" href="/../images/TITLE/user.webp"><link rel="canonical" href="http://example.com/2025/04/15/SRE-HAProxy/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//fonts.googleapis.com" crossorigin=""/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Titillium+Web&amp;display=swap" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":false,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: true,
    post: true
  },
  runtime: '天',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: {"chs_to_cht":"你已切换为繁体","cht_to_chs":"你已切换为简体","day_to_night":"你已切换为深色模式","night_to_day":"你已切换为浅色模式","bgLight":"#49b1f5","bgDark":"#1f1f1f","position":"top-center"},
  source: {
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: true,
  }
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: '高可用性集群HAProxy',
  isPost: true,
  isHome: false,
  isHighlightShrink: undefined,
  isToc: true,
  postUpdate: '2025-04-15 23:52:11'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
    win.getCSS = (url,id = false) => new Promise((resolve, reject) => {
      const link = document.createElement('link')
      link.rel = 'stylesheet'
      link.href = url
      if (id) link.id = id
      link.onerror = reject
      link.onload = link.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        link.onload = link.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(link)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', 'ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><link rel="stylesheet" href="/css/custom.css"  media="defer" onload="this.media='all'"><meta name="generator" content="Hexo 5.4.2"></head><body><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="/../images/TITLE/user.webp" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">104</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">42</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">35</div></a></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间线</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('/../images/SRE/day47/1.jpg')"><nav id="nav"><span id="blog-info"><a href="/" title="૮(˶ᵔ ᵕ ᵔ˶)ა"><span class="site-name">૮(˶ᵔ ᵕ ᵔ˶)ა</span></a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间线</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">高可用性集群HAProxy</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2025-04-15T15:51:45.000Z" title="发表于 2025-04-15 23:51:45">2025-04-15</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2025-04-15T15:52:11.646Z" title="更新于 2025-04-15 23:52:11">2025-04-15</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/HAProxy/">HAProxy</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">字数总计:</span><span class="word-count">17.7k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>84分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="高可用性集群HAProxy"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="HAProxy安装"><a href="#HAProxy安装" class="headerlink" title="HAProxy安装"></a>HAProxy安装</h1><p><strong>介绍HAProxy的基础安装以及基础配置</strong></p>
<p>官方帮助手册：<a target="_blank" rel="noopener" href="https://docs.haproxy.org/">https://docs.haproxy.org/</a></p>
<p><img src="../../../../images/SRE/day47/2.jpg" alt="2"></p>
<p>内网IP地址划分</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#外部网段</span></span><br><span class="line">192.168.10.0/24</span><br><span class="line"></span><br><span class="line"><span class="comment">#内部网段</span></span><br><span class="line">10.0.0.0/24</span><br></pre></td></tr></table></figure>

<h2 id="Ubuntu包安装"><a href="#Ubuntu包安装" class="headerlink" title="Ubuntu包安装"></a>Ubuntu包安装</h2><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://haproxy.debian.net/#distribution=Ubuntu&amp;release=noble&amp;version=3.0</span><br></pre></td></tr></table></figure>

<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># apt-get install --no-install-recommends software-properties-common</span></span><br><span class="line"><span class="comment"># add-apt-repository ppa:vbernat/haproxy-3.0</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># apt-get install haproxy=3.0.\*</span></span><br></pre></td></tr></table></figure>

<h2 id="Rocky编译安装"><a href="#Rocky编译安装" class="headerlink" title="Rocky编译安装"></a>Rocky编译安装</h2><h3 id="CentOS-基础环境"><a href="#CentOS-基础环境" class="headerlink" title="CentOS 基础环境"></a>CentOS 基础环境</h3><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://www.lua.org/start.html</span><br></pre></td></tr></table></figure>

<p><strong>lua版本太低，不能编译安装</strong></p>
<p><img src="../../../../images/SRE/day47/3.jpg" alt="3"></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@rocky8 ~]<span class="comment"># yum install gcc readline-devel -y</span></span><br><span class="line">[root@rocky8 ~]<span class="comment"># curl -L -R -O https://www.lua.org/ftp/lua-5.4.7.tar.gz</span></span><br><span class="line">[root@rocky8 ~]<span class="comment"># tar zxf lua-5.4.7.tar.gz</span></span><br><span class="line">[root@rocky8 ~]<span class="comment"># cd lua-5.4.7/</span></span><br><span class="line">[root@rocky8 lua-5.4.7]<span class="comment"># make all test</span></span><br><span class="line"></span><br><span class="line">[root@rocky8 ~]<span class="comment"># cd lua-5.4.7/src/</span></span><br><span class="line">[root@rocky8 src]<span class="comment"># ./lua -v</span></span><br><span class="line">Lua 5.4.7  Copyright (C) 1994-2024 Lua.org, PUC-Rio</span><br></pre></td></tr></table></figure>

<h3 id="Ubuntu-基础环境"><a href="#Ubuntu-基础环境" class="headerlink" title="Ubuntu 基础环境"></a>Ubuntu 基础环境</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">apt install gcc make libssl-dev libpcre3 libpcre3-dev zlib1g-dev libreadline-dev libsystemd-dev</span><br><span class="line"></span><br><span class="line">wget https://www.lua.org/ftp/lua-5.4.7.tar.gz</span><br><span class="line">tar zxf lua-5.4.7.tar.gz</span><br><span class="line"><span class="built_in">cd</span> lua-5.4.7/</span><br><span class="line">make all <span class="built_in">test</span></span><br></pre></td></tr></table></figure>

<h3 id="编译安装-HAProxy"><a href="#编译安装-HAProxy" class="headerlink" title="编译安装 HAProxy"></a>编译安装 HAProxy</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br></pre></td><td class="code"><pre><span class="line">yum install -y wget gcc readline-devel libtermcap-devel ncurses-devel libevent-devel</span><br><span class="line">yum install -y openssl-devel pcre-devel systemd-devel gcc gcc-c++ glibc glibc-devel </span><br><span class="line">yum install -y pcre pcre-devel openssl openssl-devel systemd-devel make</span><br><span class="line"></span><br><span class="line"><span class="built_in">cd</span> /usr/local/src &amp;&amp; wget https://www.haproxy.org/download/1.9/src/haproxy-1.9.16.tar.gz</span><br><span class="line"></span><br><span class="line">useradd -s /sbin/nologin haproxy</span><br><span class="line"></span><br><span class="line">tar xf haproxy-1.9.16.tar.gz &amp;&amp; <span class="built_in">cd</span> haproxy-1.9.16</span><br><span class="line"></span><br><span class="line">make -j 4 ARCH=x86_64 TARGET=linux2628 USE_PCRE=1 USE_OPENSSL=1 USE_ZLIB=1 USE_SYSTEMD=1 USE_CPU_AFFINITY=1 PREFIX=/usr/local/haproxy -s</span><br><span class="line"></span><br><span class="line">make install PREFIX=/usr/local/haproxy -s</span><br><span class="line"></span><br><span class="line"><span class="built_in">ln</span> -s /usr/local/haproxy/sbin/haproxy /usr/local/bin/haproxy</span><br><span class="line"></span><br><span class="line"><span class="built_in">mkdir</span> /etc/haproxy/conf.d/ -p</span><br><span class="line">sysctl -w net.ipv4.ip_nonlocal_bind=1</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;sysctl -w net.ipv4.ip_nonlocal_bind=1&quot;</span> &gt; /etc/rc.d/rc.local</span><br><span class="line"><span class="built_in">chmod</span> +x /etc/rc.d/rc.local</span><br><span class="line"></span><br><span class="line"><span class="built_in">cat</span> &gt; /usr/lib/systemd/system/haproxy.service &lt;&lt;-<span class="string">EOF</span></span><br><span class="line"><span class="string">[Unit]</span></span><br><span class="line"><span class="string">Description=HAProxy Load Balancer</span></span><br><span class="line"><span class="string">After=syslog.target network.target</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">[Service]</span></span><br><span class="line"><span class="string">ExecStartPre=/usr/local/bin/haproxy -f /etc/haproxy/haproxy.cfg -f /etc/haproxy/conf.d/ -c -q</span></span><br><span class="line"><span class="string">ExecStart=/usr/local/bin/haproxy -Ws -f /etc/haproxy/haproxy.cfg -f /etc/haproxy/conf.d/ -p /var/lib/haproxy/haproxy.pid</span></span><br><span class="line"><span class="string">ExecReload=/bin/kill -USR2 \$MAINPID</span></span><br><span class="line"><span class="string">LimitNOFILE=100000</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">[Install]</span></span><br><span class="line"><span class="string">WantedBy=multi-user.target</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">cat</span> &gt; /etc/haproxy/haproxy.cfg &lt;&lt;-<span class="string">EOF</span></span><br><span class="line"><span class="string">global</span></span><br><span class="line"><span class="string">maxconn 100000</span></span><br><span class="line"><span class="string">chroot /usr/local/haproxy</span></span><br><span class="line"><span class="string">stats socket /var/lib/haproxy/haproxy.sock mode 600 level admin</span></span><br><span class="line"><span class="string">#uid 99</span></span><br><span class="line"><span class="string">#gid 99</span></span><br><span class="line"><span class="string">user haproxy</span></span><br><span class="line"><span class="string">group haproxy</span></span><br><span class="line"><span class="string">daemon</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">#nbproc 4</span></span><br><span class="line"><span class="string">#cpu-map 1 0</span></span><br><span class="line"><span class="string">#cpu-map 2 1</span></span><br><span class="line"><span class="string">#cpu-map 3 2</span></span><br><span class="line"><span class="string">#cpu-map 4 3</span></span><br><span class="line"><span class="string">pidfile /var/lib/haproxy/haproxy.pid</span></span><br><span class="line"><span class="string">log 127.0.0.1 local2 info</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">defaults</span></span><br><span class="line"><span class="string">option http-keep-alive</span></span><br><span class="line"><span class="string">option forwardfor</span></span><br><span class="line"><span class="string">maxconn 100000</span></span><br><span class="line"><span class="string">mode http</span></span><br><span class="line"><span class="string">timeout connect 300000ms</span></span><br><span class="line"><span class="string">timeout client 300000ms</span></span><br><span class="line"><span class="string">timeout server 300000ms</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">listen stats</span></span><br><span class="line"><span class="string">mode http</span></span><br><span class="line"><span class="string">bind 0.0.0.0:9999</span></span><br><span class="line"><span class="string">stats enable</span></span><br><span class="line"><span class="string">log global</span></span><br><span class="line"><span class="string">#stats refresh 10</span></span><br><span class="line"><span class="string">stats realm HAProxy\ </span></span><br><span class="line"><span class="string">stats uri /status</span></span><br><span class="line"><span class="string">stats auth admin:000000</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">#listen web_port</span></span><br><span class="line"><span class="string">#bind 10.0.0.10:80</span></span><br><span class="line"><span class="string">#mode tcp</span></span><br><span class="line"><span class="string">#log global</span></span><br><span class="line"><span class="string">#server web1 127.0.0.1:8080 check inter 3000 fall 2 rise5</span></span><br><span class="line"><span class="string">#server web1 127.0.0.1:8080 check inter 3000 fall 2 rise5</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">mkdir</span> /var/lib/haproxy &amp;&gt; /dev/null</span><br><span class="line"><span class="built_in">chown</span> haproxy:haproxy /var/lib/haproxy/ -R &amp;&gt; /dev/null</span><br><span class="line">systemctl start haproxy</span><br><span class="line">systemctl <span class="built_in">enable</span> haproxy</span><br><span class="line"></span><br><span class="line">ss -ntlp|grep -wq 9999</span><br><span class="line"></span><br><span class="line"><span class="comment"># HAProxy状态页：http://localhost:9999/status</span></span><br><span class="line"><span class="comment"># 用户名/密码：admin:000000</span></span><br><span class="line"></span><br><span class="line">[root@rocky8 ~]<span class="comment"># haproxy -v</span></span><br><span class="line">HA-Proxy version 1.9.16 2020/07/31 - https://haproxy.org/</span><br><span class="line">No more fixes <span class="keyword">for</span> branch 1.9 past this version, please upgrade to branch 2.0!</span><br><span class="line"></span><br><span class="line">[root@rocky8 ~]<span class="comment"># haproxy -vv</span></span><br><span class="line">HA-Proxy version 1.9.16 2020/07/31 - https://haproxy.org/</span><br><span class="line">No more fixes <span class="keyword">for</span> branch 1.9 past this version, please upgrade to branch 2.0!</span><br><span class="line">Build options :</span><br><span class="line">  TARGET  = linux2628</span><br><span class="line">  CPU     = generic</span><br><span class="line">  CC      = gcc</span><br><span class="line">  CFLAGS  = -m64 -march=x86-64 -O2 -g -fno-strict-aliasing -Wdeclaration-after-statement -fwrapv -Wno-unused-label -Wno-sign-compare -Wno-unused-parameter -Wno-old-style-declaration -Wno-ignored-qualifiers -Wno-clobbered -Wno-missing-field-initializers -Wno-implicit-fallthrough -Wno-stringop-overflow -Wno-cast-function-type -Wtype-limits -Wshift-negative-value -Wshift-overflow=2 -Wduplicated-cond -Wnull-dereference</span><br><span class="line">  OPTIONS = USE_ZLIB=1 USE_CPU_AFFINITY=1 USE_OPENSSL=1 USE_SYSTEMD=1 USE_PCRE=1</span><br><span class="line"></span><br><span class="line">Default settings :</span><br><span class="line">  maxconn = 2000, bufsize = 16384, maxrewrite = 1024, maxpollevents = 200</span><br><span class="line"></span><br><span class="line">Built with OpenSSL version : OpenSSL 1.1.1k  FIPS 25 Mar 2021</span><br><span class="line">Running on OpenSSL version : OpenSSL 1.1.1k  FIPS 25 Mar 2021</span><br><span class="line">OpenSSL library supports TLS extensions : <span class="built_in">yes</span></span><br><span class="line">OpenSSL library supports SNI : <span class="built_in">yes</span></span><br><span class="line">OpenSSL library supports : TLSv1.0 TLSv1.1 TLSv1.2 TLSv1.3</span><br><span class="line">Built with transparent proxy support using: IP_TRANSPARENT IPV6_TRANSPARENT IP_FREEBIND</span><br><span class="line">Built with zlib version : 1.2.11</span><br><span class="line">Running on zlib version : 1.2.11</span><br><span class="line">Compression algorithms supported : identity(<span class="string">&quot;identity&quot;</span>), deflate(<span class="string">&quot;deflate&quot;</span>), raw-deflate(<span class="string">&quot;deflate&quot;</span>), gzip(<span class="string">&quot;gzip&quot;</span>)</span><br><span class="line">Built with PCRE version : 8.42 2018-03-20</span><br><span class="line">Running on PCRE version : 8.42 2018-03-20</span><br><span class="line">PCRE library supports JIT : no (USE_PCRE_JIT not <span class="built_in">set</span>)</span><br><span class="line">Encrypted password support via crypt(3): <span class="built_in">yes</span></span><br><span class="line">Built with multi-threading support.</span><br><span class="line"></span><br><span class="line">Available polling systems :</span><br><span class="line">      epoll : pref=300,  <span class="built_in">test</span> result OK</span><br><span class="line">       poll : pref=200,  <span class="built_in">test</span> result OK</span><br><span class="line">     select : pref=150,  <span class="built_in">test</span> result OK</span><br><span class="line">Total: 3 (3 usable), will use epoll.</span><br><span class="line"></span><br><span class="line">Available multiplexer protocols :</span><br><span class="line">(protocols marked as &lt;default&gt; cannot be specified using <span class="string">&#x27;proto&#x27;</span> keyword)</span><br><span class="line">              h2 : mode=HTX        side=FE|BE</span><br><span class="line">              h2 : mode=HTTP       side=FE</span><br><span class="line">       &lt;default&gt; : mode=HTX        side=FE|BE</span><br><span class="line">       &lt;default&gt; : mode=TCP|HTTP   side=FE|BE</span><br><span class="line"></span><br><span class="line">Available filters :</span><br><span class="line">	[SPOE] spoe</span><br><span class="line">	[COMP] compression</span><br><span class="line">	[CACHE] cache</span><br><span class="line">	[TRACE] trace</span><br></pre></td></tr></table></figure>

<h2 id="Docker-安装"><a href="#Docker-安装" class="headerlink" title="Docker 安装"></a>Docker 安装</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">docker run -d --name my-running-haproxy \</span><br><span class="line">-v /etc/haproxy/haproxy.cfg:/usr/local/etc/haproxy/haproxy.cfg:ro \</span><br><span class="line">-p 9999:9999 --sysctl net.ipv4.ip_unprivileged_port_start=0 \</span><br><span class="line">haproxy:2.6.0-alpine3.16</span><br></pre></td></tr></table></figure>

<h1 id="HAProxy-基础配置"><a href="#HAProxy-基础配置" class="headerlink" title="HAProxy 基础配置"></a>HAProxy 基础配置</h1><p>HAProxy 的配置文件 haproxy.cfg 由两大部分组成，分别是 global 和 proxies 部分</p>
<ul>
<li>global：全局配置段</li>
</ul>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">进程及安全配置相关的参数</span><br><span class="line">性能调整相关参数</span><br><span class="line">Debug参数</span><br></pre></td></tr></table></figure>

<ul>
<li>proxies：代理配置段</li>
</ul>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">defaults</span><span class="punctuation">: </span>为frontend, backend, listen提供默认配置</span><br><span class="line"><span class="attribute">frontend</span><span class="punctuation">: </span>前端，相当于nginx中的server &#123;&#125;</span><br><span class="line"><span class="attribute">backend</span><span class="punctuation">: </span>后端，相当于ngingx中的upstream &#123;&#125;</span><br><span class="line"><span class="attribute">listen</span><span class="punctuation">: </span>同时拥有前端和后端配置，配置简单，生产推荐使用</span><br></pre></td></tr></table></figure>

<h2 id="Global配置"><a href="#Global配置" class="headerlink" title="Global配置"></a>Global配置</h2><ul>
<li>官方文档：<a target="_blank" rel="noopener" href="http://cbonte.github.io/haproxy-dconv/2.4/configuration.html/#3">http://cbonte.github.io/haproxy-dconv/2.4/configuration.html/#3</a></li>
<li><a target="_blank" rel="noopener" href="https://docs.haproxy.org/1.9/configuration.html">https://docs.haproxy.org/1.9/configuration.html</a></li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">global</span><br><span class="line">    <span class="built_in">chroot</span> /apps/haproxy              <span class="comment"># 指定根运行目录</span></span><br><span class="line">    stats socket /var/lib/haproxy/haproxy.sock mode 600 level admin process 1  <span class="comment"># Socket文件（管理权限）</span></span><br><span class="line">    user haproxy                       <span class="comment"># 运行用户</span></span><br><span class="line">    group haproxy                      <span class="comment"># 运行用户组</span></span><br><span class="line">    <span class="comment">#uid 99                           # 用户ID（可选）</span></span><br><span class="line">    <span class="comment">#gid 99                           # 用户组ID（可选）</span></span><br><span class="line">    daemon                            <span class="comment"># 以守护进程模式运行</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">#nbproc 4                         # Worker进程数（默认1，多进程需谨慎）2.5版本不再支持</span></span><br><span class="line">    nbthread 4                        <span class="comment"># 线程数 默认1</span></span><br><span class="line">    <span class="comment">#cpu-map 1 0                      # 绑定第1个Worker进程到0号CPU</span></span><br><span class="line">    <span class="comment">#cpu-map 2 1                      # 绑定第2个Worker进程到1号CPU</span></span><br><span class="line">    cpu-map auto:1/1-8 0-7            <span class="comment"># 线程与CPU绑定（每个进程1-8线程绑定0-7号CPU）</span></span><br><span class="line"></span><br><span class="line">    maxconn 100000                    <span class="comment"># 单进程最大并发连接数</span></span><br><span class="line">    maxconnrate 100                   <span class="comment"># 每秒最大新建连接数（证书场景适用）</span></span><br><span class="line">    maxsessrate 100                   <span class="comment"># 每秒最大会话数</span></span><br><span class="line">    maxsslconn 100                    <span class="comment"># 最大SSL连接数</span></span><br><span class="line">    spread-checks 2                   <span class="comment"># 状态检查延迟分散（0-50%，建议2-5）</span></span><br><span class="line">    pidfile /var/lib/haproxy/haproxy.pid  <span class="comment"># PID文件路径</span></span><br><span class="line">    <span class="built_in">log</span> 127.0.0.1 local2 info <span class="comment">#日志发送到本地syslog（local2设备，info级别）</span></span><br></pre></td></tr></table></figure>

<h2 id="多线程绑定CPU"><a href="#多线程绑定CPU" class="headerlink" title="多线程绑定CPU"></a>多线程绑定CPU</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">[root@rocky8 ~]<span class="comment"># vim /etc/haproxy/haproxy.cfg </span></span><br><span class="line">vim /etc/haproxy/haproxy.cfg</span><br><span class="line">nbthread 4</span><br><span class="line">cpu-map auto:1/1-4 0-3</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@rocky8 ~]<span class="comment"># pstree -p</span></span><br><span class="line">           ├─haproxy(4830)───haproxy(4831)─┬─&#123;haproxy&#125;(4832)</span><br><span class="line">           │                               ├─&#123;haproxy&#125;(4833)</span><br><span class="line">           │                               └─&#123;haproxy&#125;(4834)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@rocky8 ~]<span class="comment"># ps axo pid,cmd,psr -L | grep haproxy</span></span><br><span class="line">   4845 /usr/local/bin/haproxy -Ws    3</span><br><span class="line">   4846 /usr/local/bin/haproxy -Ws    0</span><br><span class="line">   4846 /usr/local/bin/haproxy -Ws    1</span><br><span class="line">   4846 /usr/local/bin/haproxy -Ws    2</span><br><span class="line">   4846 /usr/local/bin/haproxy -Ws    3</span><br><span class="line">   4853 grep --color=auto haproxy     0</span><br></pre></td></tr></table></figure>

<h2 id="日志配置"><a href="#日志配置" class="headerlink" title="日志配置"></a>日志配置</h2><ul>
<li>不建议开启HAProxy日志，会增加HAProxy压力</li>
</ul>
<h3 id="HAProxy配置"><a href="#HAProxy配置" class="headerlink" title="HAProxy配置"></a>HAProxy配置</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># global配置定义</span></span><br><span class="line"><span class="built_in">log</span> 127.0.0.1 <span class="built_in">local</span>&#123;1-7&#125; info <span class="comment"># 基于syslog记录日志到指定设备，级别包括err、warning、info、debug</span></span><br><span class="line"></span><br><span class="line">listen web_port</span><br><span class="line">	<span class="built_in">bind</span> 127.0.0.1:80</span><br><span class="line">	mode http</span><br><span class="line">	<span class="built_in">log</span> global</span><br><span class="line">	server web1 127.0.0.1:8080 check inter 3000 fall 2 rise 5</span><br><span class="line">	</span><br><span class="line"><span class="comment"># systemctl restart haproxy</span></span><br></pre></td></tr></table></figure>

<h3 id="Rsyslog配置"><a href="#Rsyslog配置" class="headerlink" title="Rsyslog配置"></a>Rsyslog配置</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">yum install rsyslog -y</span><br><span class="line"></span><br><span class="line">vim /etc/rsyslog.conf</span><br><span class="line">module(load=<span class="string">&quot;imudp&quot;</span>) </span><br><span class="line">input(<span class="built_in">type</span>=<span class="string">&quot;imudp&quot;</span> port=<span class="string">&quot;514&quot;</span>)</span><br><span class="line">......</span><br><span class="line">local3.* /var/log/haproxy.log</span><br><span class="line">......</span><br><span class="line"></span><br><span class="line"><span class="comment"># systemctl restart rsyslog</span></span><br></pre></td></tr></table></figure>

<h2 id="Proxies-配置"><a href="#Proxies-配置" class="headerlink" title="Proxies 配置"></a>Proxies 配置</h2><h3 id="default"><a href="#default" class="headerlink" title="default"></a>default</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">option redispatch        <span class="comment">#当server Id对应的服务器挂掉后，强制定向到其他健康的服务器，重新派发</span></span><br><span class="line">option abortonclose      <span class="comment">#当服务器负载很高时，自动结束掉当前队列处理比较久的连接，针对业务情况选择开启</span></span><br><span class="line">option http-keep-alive   <span class="comment">#开启与客户端的会话保持</span></span><br><span class="line">option forwardfor        <span class="comment">#传递客户端真实IP至后端web服务器</span></span><br><span class="line">mode http|tcp            <span class="comment">#设置默认工作类型，使用TCP服务器性能更好，减少压力</span></span><br><span class="line"><span class="built_in">timeout</span> http-keep-alive 120s     <span class="comment">#session 会话保持超时时间，此时间段内会转发到相同的后端服务器</span></span><br><span class="line"><span class="built_in">timeout</span> connect 120s     <span class="comment">#客户端请求从haproxy到后端server最长连接等待时间(TCP连接之前)，默认单位ms</span></span><br><span class="line"><span class="built_in">timeout</span> server 600s      <span class="comment">#客户端请求从haproxy到后端服务端的请求处理超时时间长(TCP连接之后)，默认单位ms，如果超时，会出现502错误，此值建议设置较大些，防止出现502错误</span></span><br><span class="line"><span class="built_in">timeout</span> client 600s      <span class="comment">#设置haproxy与客户端的最长非活动时间，默认单位ms，建议和timeout server相同</span></span><br><span class="line"><span class="built_in">timeout</span> check 5s         <span class="comment">#对后端服务器的健康检测超时时间</span></span><br><span class="line">default-server inter 1000 weight 3    <span class="comment">#指定后端服务器的默认设置</span></span><br></pre></td></tr></table></figure>

<h3 id="listen"><a href="#listen" class="headerlink" title="listen"></a>listen</h3><p>使用listen替换frontend和backend的配置方式，可以简化设置，常用于TCP协议的应用</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#官网业务访问入口</span></span><br><span class="line">listen WEB_PORT_80</span><br><span class="line">    <span class="built_in">bind</span> 192.168.10.100:80</span><br><span class="line">    mode http</span><br><span class="line">    option forwardfor</span><br><span class="line">    server web1 10.0.0.17:8080 check inter 3000 fall 3 rise 5</span><br><span class="line">    server web2 10.0.0.27:8080 check inter 3000 fall 3 rise 5</span><br><span class="line"></span><br><span class="line"><span class="comment">#检查语法</span></span><br><span class="line">[root@ubuntu2004 ~]<span class="comment"># haproxy -c -f /etc/haproxy/haproxy.cfg</span></span><br><span class="line">Configuration file is valid</span><br></pre></td></tr></table></figure>

<h3 id="frontend"><a href="#frontend" class="headerlink" title="frontend"></a>frontend</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">bind</span>: <span class="comment"># 指定HAProxy的监听地址，可以是IPV4或者IPV6，可以同时监听多个IP或端口，可同时用于listen字段中</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 格式：</span></span><br><span class="line"><span class="built_in">bind</span> [&lt;address&gt;]:&lt;port_range&gt; [, ...] [param*]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 注意：如果需要绑定在非本机的IP，需要开启内核参数：net.ipv4.ip_nonlocal_bind=1</span></span><br><span class="line"></span><br><span class="line">backlog &lt;backlog&gt; <span class="comment"># 针对多有server配置，当前端服务器的连接数达到上限后的后援队列长度，注意，不支持backend</span></span><br></pre></td></tr></table></figure>

<p>范例：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">frontend http_proxy</span><br><span class="line">    <span class="built_in">bind</span> :80,:443,:8801-8810  <span class="comment">#监听http的多个IP的多个端口和sock文件</span></span><br><span class="line">    <span class="built_in">bind</span> 10.0.0.1:10080,10.0.0.1:10443</span><br><span class="line">    <span class="built_in">bind</span> /var/run/ssl-frontend.sock user root mode 600 accept-proxy</span><br><span class="line"></span><br><span class="line">frontend http_https_proxy</span><br><span class="line">    <span class="built_in">bind</span> :80  <span class="comment">#https监听</span></span><br><span class="line">    <span class="built_in">bind</span> :443 ssl crt /etc/haproxy/site.pem  <span class="comment">#公钥和私钥公共文件</span></span><br><span class="line"></span><br><span class="line">frontend http_https_proxy_explicit</span><br><span class="line">    <span class="built_in">bind</span> ipv6@:80  <span class="comment">#监听ipv6、ipv4和unix sock文件</span></span><br><span class="line">    <span class="built_in">bind</span> ipv4@public_ssl:443 ssl crt /etc/haproxy/site.pem</span><br><span class="line">    <span class="built_in">bind</span> unix@ssl-frontend.sock user root mode 600 accept-proxy</span><br><span class="line"></span><br><span class="line">listen external_bind_app1</span><br><span class="line">    <span class="built_in">bind</span> <span class="string">&quot;fd@$<span class="variable">$&#123;FD_APP1&#125;</span>&quot;</span>  <span class="comment">#监听file descriptor</span></span><br></pre></td></tr></table></figure>

<p>生产示例:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">frontend wang_web_port</span><br><span class="line">    <span class="built_in">bind</span> :80,:8080  <span class="comment">#建议采用后面形式命名：业务+服务+端口号</span></span><br><span class="line">    <span class="built_in">bind</span> 10.0.0.7:10080,:8501-8810,10.0.0.17:9001-9010</span><br><span class="line">    mode http/tcp  <span class="comment">#指定负载协议类型</span></span><br><span class="line">    use_backend &lt;backend_name&gt;  <span class="comment">#调用的后端服务器组名称</span></span><br></pre></td></tr></table></figure>

<h3 id="backend"><a href="#backend" class="headerlink" title="backend"></a>backend</h3><p>定义一组后端服务器，backend服务器将被frontend进行调用。</p>
<p>注意: backend 的名称必须唯一，并且必须在listen或frontend中事先定义才可以使用，否则服务无法启动</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mode http|tcp  <span class="comment">#指定负载协议类型，和对应的frontend必须一致</span></span><br><span class="line">option         <span class="comment">#配置选项</span></span><br><span class="line">server         <span class="comment">#定义后端real server，必须指定IP和端口</span></span><br></pre></td></tr></table></figure>

<p><strong>注意：option后面加httpchk, smtpchk, mysql-check, pgsql-check, ssl-hello-chk方法，可用于实现更多应用层检测功能。</strong></p>
<p>server 配置</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#针对一个server配置</span></span><br><span class="line">check           <span class="comment">#对指定real进行健康状态检查，如果不加此设置，默认不开启检查，只有check后面没有其它配置也可以启用检查功能</span></span><br><span class="line">                <span class="comment">#默认对相应的后端服务器IP和端口，利用TCP连接进行周期性健康性检查，注意必须指定端口才能实现健康性检查</span></span><br><span class="line">addr &lt;IP&gt;       <span class="comment">#可指定的健康状态监测IP，可以是专门的数据网段，减少业务网络的流量</span></span><br><span class="line">port &lt;num&gt;      <span class="comment">#指定的健康状态监测端口</span></span><br><span class="line">inter &lt;num&gt;     <span class="comment">#健康状态检查间隔时间，默认2000 ms</span></span><br><span class="line">fall &lt;num&gt;      <span class="comment">#后端服务器从线上转为线下的检查的连续失效次数，默认为3</span></span><br><span class="line">rise &lt;num&gt;      <span class="comment">#后端服务器从线下恢复上线的检查的连续有效次数，默认为2</span></span><br><span class="line">weight &lt;weight&gt; <span class="comment">#默认为1，最大值为256，0(状态为蓝色)表示不参与负载均衡，但仍接受持久连接</span></span><br><span class="line">backup          <span class="comment">#将后端服务器标记为备份状态，只在所有非备份主机down机时提供服务，类似Sorry Server</span></span><br><span class="line">disabled        <span class="comment">#将后端服务器标记为不可用状态，即维护状态，除了持久模式，将不再接受连接，状态为深黄色，优雅下线，不再接受新用户的请求</span></span><br><span class="line">maxconn &lt;maxconn&gt; <span class="comment">#当前后端server的最大并发连接数，放在，在server 指令后面</span></span><br><span class="line">redir http://www.baidu.com <span class="comment">#将请求临时(302)重定向至其它URL，只适用于http模式，放在server 指令后面</span></span><br></pre></td></tr></table></figure>

<p><strong>redirect 配置</strong></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 注意: 此指令和redir功能相似，但不属于server指令后面，是独立存放在listen, frontend, backend语句块</span></span><br><span class="line">redirect prefix http://www.baidu.com/  <span class="comment"># 将请求临时(302)重定向至其它URL，只适用于http模式</span></span><br></pre></td></tr></table></figure>

<h3 id="frontend-backend案例"><a href="#frontend-backend案例" class="headerlink" title="frontend+backend案例"></a>frontend+backend案例</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 官网业务访问入口</span></span><br><span class="line"></span><br><span class="line">frontend web_http_80</span><br><span class="line">    <span class="built_in">bind</span> 10.0.0.7:80</span><br><span class="line">    mode http</span><br><span class="line">    use_backend web_http_nodes</span><br><span class="line"></span><br><span class="line">backend web_http_nodes</span><br><span class="line">    mode http</span><br><span class="line">    option forwardfor</span><br><span class="line">    server 10.0.0.17 10.0.0.17:8080 check inter 3000 fall 3 rise 5</span><br><span class="line">    server 10.0.0.27 10.0.0.27:8080 check inter 3000 fall 3 rise 5</span><br></pre></td></tr></table></figure>

<h2 id="使用-HAProxy-子配置文件"><a href="#使用-HAProxy-子配置文件" class="headerlink" title="使用 HAProxy 子配置文件"></a>使用 HAProxy 子配置文件</h2><p>当业务众多时，将所有配置都放在一个配置文件中，会造成维护困难。<br>可以考虑按业务分类，将配置信息拆分，放在不同的子配置文件中，从而达到方便维护的目的。</p>
<p><strong>注意: 子配置文件的文件后缀必须为.cfg</strong></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建子配置目录</span></span><br><span class="line">[root@centos7 ~]<span class="comment"># mkdir /etc/haproxy/conf.d/</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 添加子配置目录到unit文件中</span></span><br><span class="line">[root@centos7 ~]<span class="comment"># vim /lib/systemd/system/haproxy.service</span></span><br><span class="line">[Unit]</span><br><span class="line">Description=HAProxy Load Balancer</span><br><span class="line">After=syslog.target network.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line"><span class="comment"># 修改下面两行</span></span><br><span class="line">ExecStartPre=/usr/sbin/haproxy -f /etc/haproxy/haproxy.cfg -f /etc/haproxy/conf.d/*.cfg -c -q</span><br><span class="line">ExecStart=/usr/sbin/haproxy -Ws -f /etc/haproxy/haproxy.cfg -f /etc/haproxy/conf.d/*.cfg -p /var/lib/haproxy/haproxy.pid</span><br><span class="line">ExecReload=/bin/kill -USR2 <span class="variable">$MAINPID</span></span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建子配置文件，注意：必须为cfg后缀非.开头的配置文件</span></span><br><span class="line">[root@centos7 ~]<span class="comment"># vim /etc/haproxy/conf.d/test.cfg</span></span><br><span class="line">listen WEB_PORT_80</span><br><span class="line">    <span class="built_in">bind</span> 10.0.0.7:80</span><br><span class="line">    mode http</span><br><span class="line">    balance roundrobin</span><br><span class="line">    server web1 10.0.0.17:80 check inter 3000 fall 2 rise 5</span><br><span class="line">    server web2 10.0.0.27:80 check inter 3000 fall 2 rise 5</span><br><span class="line"></span><br><span class="line">[root@centos7 ~]<span class="comment"># systemctl daemon-reload</span></span><br><span class="line">[root@centos7 ~]<span class="comment"># systemctl restart haproxy</span></span><br></pre></td></tr></table></figure>

<h1 id="HAProxy-调度算法"><a href="#HAProxy-调度算法" class="headerlink" title="HAProxy 调度算法"></a>HAProxy 调度算法</h1><p>HAProxy通过固定参数 <code>balance</code> 指明对后端服务器的调度算法，该参数可以配置在listen或backend选项中。</p>
<p>HAProxy的调度算法分为静态和动态调度算法，但是有些算法可以根据参数在静态和动态算法中相互转换。</p>
<p>官方文档: <a target="_blank" rel="noopener" href="http://cbonte.github.io/haproxy-dconv/2.4/configuration.html#4-balance">http://cbonte.github.io/haproxy-dconv/2.4/configuration.html#4-balance</a></p>
<h2 id="静态算法"><a href="#静态算法" class="headerlink" title="静态算法"></a>静态算法</h2><p>静态算法：按照事先定义好的规则轮询进行调度，不关心后端服务器的当前负载、连接数和响应速度等，且无法实时动态修改权重（只能为0和1，不支持其它值）或者修改后不生效，如果需要修改只能靠重启HAProxy生效。</p>
<h3 id="Socat-工具"><a href="#Socat-工具" class="headerlink" title="Socat 工具"></a>Socat 工具</h3><p>对服务器动态权重和其它状态可以利用socat工具进行调整。Socat是Linux下的一个多能的网络工具，名字来由是Socket CAT，相当于netCAT的增强版。Socat的主要特点就是在两个数据流之间建立双向通道，且支持众多协议和链接方式。如IP、TCP、UDP、IPv6、Socket文件等。</p>
<p>范例：利用工具socat 对服务器动态权重调整</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#安装socat</span></span><br><span class="line">[root@rocky8 ~]<span class="comment"># yum install socat -y </span></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment"># apt install socat -y </span></span><br><span class="line"></span><br><span class="line"><span class="comment">#查看帮助</span></span><br><span class="line">[root@rocky8 ~]<span class="comment"># socat -h</span></span><br><span class="line">[root@rocky8 ~]<span class="comment"># echo &quot;help&quot; | socat stdio /var/lib/haproxy/haproxy.sock</span></span><br><span class="line">Unknown <span class="built_in">command</span>. Please enter one of the following commands only :</span><br><span class="line">  <span class="built_in">help</span>           : this message</span><br><span class="line">  prompt         : toggle interactive mode with prompt</span><br><span class="line">  quit           : disconnect</span><br><span class="line">  show tls-keys [<span class="built_in">id</span>|*]: show tls keys references or dump tls ticket keys when <span class="built_in">id</span> specified</span><br><span class="line">  <span class="built_in">set</span> ssl tls-key [<span class="built_in">id</span>|keyfile] &lt;tlskey&gt;: <span class="built_in">set</span> the next TLS key <span class="keyword">for</span> the &lt;<span class="built_in">id</span>&gt; or &lt;keyfile&gt; listener to &lt;tlskey&gt;</span><br><span class="line">  show sess [<span class="built_in">id</span>] : report the list of current sessions or dump this session</span><br><span class="line">  shutdown session : <span class="built_in">kill</span> a specific session</span><br><span class="line">  shutdown sessions server : <span class="built_in">kill</span> sessions on a server</span><br><span class="line">  clear counters : clear max statistics counters (add <span class="string">&#x27;all&#x27;</span> <span class="keyword">for</span> all counters)</span><br><span class="line">  show info      : report information about the running process [json|typed]</span><br><span class="line">  show <span class="built_in">stat</span>      : report counters <span class="keyword">for</span> each proxy and server [json|typed]</span><br><span class="line">  show schema json : report schema used <span class="keyword">for</span> stats</span><br><span class="line">  <span class="built_in">disable</span> agent  : <span class="built_in">disable</span> agent checks (use <span class="string">&#x27;set server&#x27;</span> instead)</span><br><span class="line">  <span class="built_in">disable</span> health : <span class="built_in">disable</span> health checks (use <span class="string">&#x27;set server&#x27;</span> instead)</span><br><span class="line">  <span class="built_in">disable</span> server : <span class="built_in">disable</span> a server <span class="keyword">for</span> maintenance (use <span class="string">&#x27;set server&#x27;</span> instead)</span><br><span class="line">  <span class="built_in">enable</span> agent   : <span class="built_in">enable</span> agent checks (use <span class="string">&#x27;set server&#x27;</span> instead)</span><br><span class="line">  <span class="built_in">enable</span> health  : <span class="built_in">enable</span> health checks (use <span class="string">&#x27;set server&#x27;</span> instead)</span><br><span class="line">  <span class="built_in">enable</span> server  : <span class="built_in">enable</span> a disabled server (use <span class="string">&#x27;set server&#x27;</span> instead)</span><br><span class="line">  <span class="built_in">set</span> maxconn server : change a server<span class="string">&#x27;s maxconn setting</span></span><br><span class="line"><span class="string">  set server     : change a server&#x27;</span>s state, weight or address</span><br><span class="line">  get weight     : report a server<span class="string">&#x27;s current weight</span></span><br><span class="line"><span class="string">  set weight     : change a server&#x27;</span>s weight (deprecated)</span><br><span class="line">  show resolvers [<span class="built_in">id</span>]: dumps counters from all resolvers section and</span><br><span class="line">                     associated name servers</span><br><span class="line">  clear table    : remove an entry from a table</span><br><span class="line">  <span class="built_in">set</span> table [<span class="built_in">id</span>] : update or create a table entry<span class="string">&#x27;s data</span></span><br><span class="line"><span class="string">  show table [id]: report table usage stats or dump this table&#x27;</span>s contents</span><br><span class="line">  show peers [peers section]: dump some information about all the peers or this peers section</span><br><span class="line">  <span class="built_in">disable</span> frontend : temporarily <span class="built_in">disable</span> specific frontend</span><br><span class="line">  <span class="built_in">enable</span> frontend : re-enable specific frontend</span><br><span class="line">  <span class="built_in">set</span> maxconn frontend : change a frontend<span class="string">&#x27;s maxconn setting</span></span><br><span class="line"><span class="string">  show servers state [id]: dump volatile server information (for backend &lt;id&gt;)</span></span><br><span class="line"><span class="string">  show backend   : list backends in the current running config</span></span><br><span class="line"><span class="string">  shutdown frontend : stop a specific frontend</span></span><br><span class="line"><span class="string">  set dynamic-cookie-key backend : change a backend secret key for dynamic cookies</span></span><br><span class="line"><span class="string">  enable dynamic-cookie backend : enable dynamic cookies on a specific backend</span></span><br><span class="line"><span class="string">  disable dynamic-cookie backend : disable dynamic cookies on a specific backend</span></span><br><span class="line"><span class="string">  show errors    : report last request and response errors for each proxy</span></span><br><span class="line"><span class="string">  set maxconn global : change the per-process maxconn setting</span></span><br><span class="line"><span class="string">  set rate-limit : change a rate limiting value</span></span><br><span class="line"><span class="string">  set severity-output [none|number|string] : set presence of severity level in feedback information</span></span><br><span class="line"><span class="string">  set timeout    : change a timeout setting</span></span><br><span class="line"><span class="string">  show env [var] : dump environment variables known to the process</span></span><br><span class="line"><span class="string">  show cli sockets : dump list of cli sockets</span></span><br><span class="line"><span class="string">  show cli level   : display the level of the current CLI session</span></span><br><span class="line"><span class="string">  show fd [num] : dump list of file descriptors in use</span></span><br><span class="line"><span class="string">  show activity : show per-thread activity stats (for support/developers)</span></span><br><span class="line"><span class="string">  operator       : lower the level of the current CLI session to operator</span></span><br><span class="line"><span class="string">  user           : lower the level of the current CLI session to user</span></span><br><span class="line"><span class="string">  show startup-logs : report logs emitted during HAProxy startup</span></span><br><span class="line"><span class="string">  show cache     : show cache status</span></span><br><span class="line"><span class="string">  add acl        : add acl entry</span></span><br><span class="line"><span class="string">  clear acl &lt;id&gt; : clear the content of this acl</span></span><br><span class="line"><span class="string">  del acl        : delete acl entry</span></span><br><span class="line"><span class="string">  get acl        : report the patterns matching a sample for an ACL</span></span><br><span class="line"><span class="string">  show acl [id]  : report available acls or dump an acl&#x27;</span>s contents</span><br><span class="line">  add map        : add map entry</span><br><span class="line">  clear map &lt;<span class="built_in">id</span>&gt; : clear the content of this map</span><br><span class="line">  del map        : delete map entry</span><br><span class="line">  get map        : report the keys and values matching a sample <span class="keyword">for</span> a map</span><br><span class="line">  <span class="built_in">set</span> map        : modify map entry</span><br><span class="line">  show map [<span class="built_in">id</span>]  : report available maps or dump a map<span class="string">&#x27;s contents</span></span><br><span class="line"><span class="string">  show pools     : report information about the memory pools usage</span></span><br><span class="line"><span class="string">  show profiling : show CPU profiling options</span></span><br><span class="line"><span class="string">  set  profiling : enable/disable CPU profiling</span></span><br><span class="line"><span class="string">  </span></span><br><span class="line"><span class="string">  </span></span><br><span class="line"><span class="string">[root@centos7 ~]# echo &quot;get weight wang-test-80/web2&quot; | socat stdio /var/lib/haproxy/haproxy.sock</span></span><br><span class="line"><span class="string">3 (initial 3)</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"># 修改weight，注意只针对单进程有效</span></span><br><span class="line"><span class="string">[root@centos7 ~]# echo &quot;set weight wang-test-80/web2 2&quot; | socat stdio /var/lib/haproxy/haproxy.sock</span></span><br><span class="line"><span class="string">[root@centos7 ~]# echo &quot;get weight wang-test-80/web2&quot; | socat stdio /var/lib/haproxy/haproxy.sock</span></span><br><span class="line"><span class="string">2 (initial 3)</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"># 将后端服务器禁用，注意只针对单进程有效</span></span><br><span class="line"><span class="string">[root@centos7 ~]# echo &quot;disable server wang-test-80/web2&quot; | socat stdio /var/lib/haproxy/haproxy.sock</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"># 启用后端服务器</span></span><br><span class="line"><span class="string">[root@centos7 ~]# echo &quot;enable server wang-test-80/web2&quot; | socat stdio /var/lib/haproxy/haproxy.sock</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"># 将后端服务器软下线，即weight设为0</span></span><br><span class="line"><span class="string">[root@centos7 ~]# echo &quot;set weight wang-test-80/web1 0&quot; | socat stdio /var/lib/haproxy/haproxy.sock</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"># 针对haproxy的多进程,将后端服务器禁用</span></span><br><span class="line"><span class="string">[root@centos7 ~]# vim /etc/haproxy/haproxy.cfg</span></span><br><span class="line"><span class="string">stats socket /var/lib/haproxy/haproxy1.sock mode 600 level admin process 1 #绑定第1个进程和socket文件</span></span><br><span class="line"><span class="string">stats socket /var/lib/haproxy/haproxy2.sock mode 600 level admin process 2 #绑定第2个进程和socket文件</span></span><br><span class="line"><span class="string">nbproc 2</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">[root@centos7 ~]# echo &quot;disable server wang-test-80/web2&quot; | socat stdio /var/lib/haproxy/haproxy1.sock</span></span><br><span class="line"><span class="string">[root@centos7 ~]# echo &quot;disable server wang-test-80/web2&quot; | socat stdio /var/lib/haproxy/haproxy2.sock</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">[root@haproxy ~]# for i in &#123;1..2&#125;; do echo &quot;set weight wang-test-80/web$i 10&quot; | socat stdio /var/lib/haproxy/haproxy$i.sock; done</span></span><br><span class="line"><span class="string">3311987957</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"># 如果静态算法，如:static-rr，可以更改weight为0或1，但不支持动态更改weight为其它值，否则会提示下面信息</span></span><br><span class="line"><span class="string">[root@centos7 ~]# echo &quot;set weight wang-test-80/web1 0&quot; | socat stdio /var/lib/haproxy/haproxy.sock</span></span><br><span class="line"><span class="string">[root@centos7 ~]# echo &quot;set weight wang-test-80/web1 1&quot; | socat stdio /var/lib/haproxy/haproxy.sock</span></span><br><span class="line"><span class="string">[root@centos7 ~]# echo &quot;set weight wang-test-80/web1 2&quot; | socat stdio /var/lib/haproxy/haproxy.sock</span></span><br><span class="line"><span class="string">Backend is using a static LB algorithm and only accepts weights &#x27;</span>0%<span class="string">&#x27; and &#x27;</span>100%<span class="string">&#x27;.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"># 新的写法</span></span><br><span class="line"><span class="string"># 相当于disable server</span></span><br><span class="line"><span class="string">[root@ubuntu2004 ~]# echo &quot;set server www.wang.org_nginx/web1 state maint&quot; | socat stdio /var/lib/haproxy/haproxy.sock</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"># 相当于enable server</span></span><br><span class="line"><span class="string">[root@ubuntu2004 ~]# echo &quot;set server www.wang.org_nginx/web1 state ready&quot; | socat stdio /var/lib/haproxy/haproxy.sock</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">[root@ubuntu2004 ~]# echo &quot;set server www.wang.org_nginx/web1 state drain&quot; | socat stdio /var/lib/haproxy/haproxy.sock</span></span><br></pre></td></tr></table></figure>

<p>范例：上线和下线后段服务器脚本</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/etc/init.d/functions</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">case</span> <span class="variable">$1</span> <span class="keyword">in</span></span><br><span class="line">up)</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;enable server wang-web-80/<span class="variable">$2</span>&quot;</span> | socat stdio /var/lib/haproxy/haproxy.sock</span><br><span class="line">    [ $? -eq 0 ] &amp;&amp; action <span class="string">&quot;<span class="variable">$2</span> is up&quot;</span></span><br><span class="line">    ;;</span><br><span class="line">down)</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;disable server wang-web-80/<span class="variable">$2</span>&quot;</span> | socat stdio /var/lib/haproxy/haproxy.sock</span><br><span class="line">    [ $? -eq 0 ] &amp;&amp; action <span class="string">&quot;<span class="variable">$2</span> is down&quot;</span></span><br><span class="line">    ;;</span><br><span class="line">*)</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;Usage: `basename <span class="variable">$0</span>` up|down IP&quot;</span></span><br><span class="line">    ;;</span><br><span class="line"><span class="keyword">esac</span></span><br></pre></td></tr></table></figure>

<p>范例：实现容器服务的上线和下线</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line">WEB_SERVERS=<span class="string">&quot;</span></span><br><span class="line"><span class="string">10.0.0.101</span></span><br><span class="line"><span class="string">10.0.0.102</span></span><br><span class="line"><span class="string">&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="variable">$WEB_SERVERS</span>; <span class="keyword">do</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;set server www.wang.org_nginx/<span class="variable">$i</span> state maint&quot;</span> | socat stdio /var/lib/haproxy/haproxy.sock</span><br><span class="line">    ssh <span class="variable">$i</span> docker <span class="built_in">rm</span> -f nginx</span><br><span class="line">    ssh <span class="variable">$i</span> <span class="string">&quot;echo DOCKER <span class="variable">$i</span> WEBSITE <span class="variable">$1</span> &gt; /data/www/index.html&quot;</span></span><br><span class="line">    ssh <span class="variable">$i</span> docker run -d -p 80:80 -v /data/www:/usr/share/nginx/html --name nginx nginx</span><br><span class="line">    <span class="built_in">sleep</span> 10</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;set server www.wang.org_nginx/<span class="variable">$i</span> state ready&quot;</span> | socat stdio /var/lib/haproxy/haproxy.sock</span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></table></figure>

<h3 id="static-rr-算法"><a href="#static-rr-算法" class="headerlink" title="static-rr 算法"></a>static-rr 算法</h3><p><strong>static-rr</strong>: 基于权重的轮询调度，不支持运行时利用 <code>socat</code> 进行权重的动态调整（只支持0和1，不支持其它值）及后端服务器慢启动。其后端主机数量没有限制，相当于 LVS 中的 wrr。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">listen web_host</span><br><span class="line"><span class="built_in">bind</span> 10.0.0.7:80,:8801-8810,10.0.0.7:9001-9010</span><br><span class="line">mode http</span><br><span class="line"><span class="built_in">log</span> global</span><br><span class="line">balance static-rr</span><br><span class="line">server web1 10.0.0.17:80 weight 1 check inter 3000 fall 2 rise 5</span><br><span class="line">server web2 10.0.0.27:80 weight 2 check inter 3000 fall 2 rise 5</span><br></pre></td></tr></table></figure>

<p><strong><strong>范例：调整权重</strong></strong></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@haproxy ~]<span class="comment"># echo &quot;set weight www.wang.org_nginx/10.0.0.101 0&quot; | socat stdio /var/lib/haproxy/haproxy.sock</span></span><br><span class="line">[root@haproxy ~]<span class="comment"># echo &quot;get weight www.wang.org_nginx/10.0.0.101&quot; | socat stdio /var/lib/haproxy/haproxy.sock</span></span><br><span class="line">0 (initial 3)</span><br><span class="line"></span><br><span class="line">[root@haproxy ~]<span class="comment"># echo &quot;set weight www.wang.org_nginx/10.0.0.101 1&quot; | socat stdio /var/lib/haproxy/haproxy.sock</span></span><br><span class="line">Backend is using a static LB algorithm and only accepts weights <span class="string">&#x27;0%&#x27;</span> and <span class="string">&#x27;100%&#x27;</span>.</span><br><span class="line"></span><br><span class="line">[root@haproxy ~]<span class="comment"># echo &quot;set weight www.wang.org_nginx/10.0.0.101 100%&quot; | socat stdio /var/lib/haproxy/haproxy.sock</span></span><br></pre></td></tr></table></figure>

<h3 id="first-算法"><a href="#first-算法" class="headerlink" title="first 算法"></a>first 算法</h3><p><strong>first</strong>: 根据服务器在列表中的位置，自上而下进行调度，但是其只会当第一台服务器的连接数达到上限，新请求才会分配给下一台服务，因此会忽略服务器的权重设置，此方式使用较少。</p>
<p><strong>不支持用 <code>socat</code> 进行动态修改权重，可以设置0和1，可以设置其它值但无效</strong></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">listen web_host</span><br><span class="line"><span class="built_in">bind</span> 10.0.0.7:80,:8801-8810,10.0.0.7:9001-9010</span><br><span class="line">mode http</span><br><span class="line"><span class="built_in">log</span> global</span><br><span class="line">balance first</span><br><span class="line">server web1 10.0.0.17:80 maxconn 2 weight 1 check inter 3000 fall 2 rise 5</span><br><span class="line">server web2 10.0.0.27:80 weight 1 check inter 3000 fall 2 rise 5</span><br></pre></td></tr></table></figure>

<p><strong>测试访问效果</strong></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 同时运行下面命令，观察结果</span></span><br><span class="line"><span class="comment"># 在后端服务器上限速</span></span><br><span class="line">server &#123;</span><br><span class="line">	listen 80 default_server;</span><br><span class="line">	listen [::]:80 default_server;</span><br><span class="line">	limit_rate 10;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 用 wget 下载文件测试才能看到效果</span></span><br><span class="line">wget --limit-rate 1k http://192.168.10.100/test.img</span><br><span class="line"></span><br><span class="line"><span class="comment"># curl 测试不成功</span></span><br><span class="line"><span class="comment"># while true; do curl http://10.0.0.7/index.html ; sleep 0.1; done</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 动态修改权重，不报错，但不生效</span></span><br><span class="line">[root@haproxy ~]<span class="comment"># echo &quot;set weight www.wang.org_nginx/10.0.0.102 10&quot; | socat stdio /var/lib/haproxy/haproxy.sock</span></span><br></pre></td></tr></table></figure>

<h2 id="动态算法"><a href="#动态算法" class="headerlink" title="动态算法"></a>动态算法</h2><p><strong>动态算法</strong>: 基于后端服务器状态进行调度适当调整，新请求将优先调度至当前负载较低的服务器，且权重可以在 HAProxy 运行时动态调整无需重启。</p>
<h3 id="roundrobin-算法"><a href="#roundrobin-算法" class="headerlink" title="roundrobin 算法"></a>roundrobin 算法</h3><p><strong>roundrobin</strong>: 基于权重的轮询动态调度算法，支持权重的运行时调整，不同于 LVS 中的 rr 轮询模式，HAProxy 中的 roundrobin 支持慢启动（新加的服务器会逐渐增加转发数），其每个后端 backend 中最多支持 4095 个 real server，支持对 real server 权重动态调整，roundrobin 为默认调度算法，此算法使用广泛。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">listen web_host</span><br><span class="line"><span class="built_in">bind</span> 10.0.0.7:80,:8801-8810,10.0.0.7:9001-9010</span><br><span class="line">mode http</span><br><span class="line"><span class="built_in">log</span> global</span><br><span class="line">balance roundrobin</span><br><span class="line">server web1 10.0.0.17:80 weight 1 check inter 3000 fall 2 rise 5</span><br><span class="line">server web2 10.0.0.27:80 weight 2 check inter 3000 fall 2 rise 5</span><br></pre></td></tr></table></figure>

<p><strong>支持动态调整权重</strong>:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># echo &quot;get weight web_host/web1&quot; | socat stdio /var/lib/haproxy/haproxy.sock</span></span><br><span class="line">1 (initial 1)</span><br><span class="line"></span><br><span class="line"><span class="comment"># echo &quot;set weight web_host/web1 3&quot; | socat stdio /var/lib/haproxy/haproxy.sock</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># echo &quot;get weight web_host/web1&quot; | socat stdio /var/lib/haproxy/haproxy.sock</span></span><br><span class="line">3 (initial 1)</span><br></pre></td></tr></table></figure>

<h3 id="leastconn-算法"><a href="#leastconn-算法" class="headerlink" title="leastconn 算法"></a>leastconn 算法</h3><p><strong>leastconn</strong>: 加权的最少连接的动态，支持权重的运行时调整和慢启动，即根据当前连接最少的后端服务器而非权重进行优先调度（新客户端连接），比较适合长连接的场景使用，比如 MySQL 等场景。</p>
<p>相当于LVS中的WLC算法</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">listen web_host</span><br><span class="line"><span class="built_in">bind</span> 10.0.0.7:80,:8801-8810,10.0.0.7:9001-9010</span><br><span class="line">mode http</span><br><span class="line"><span class="built_in">log</span> global</span><br><span class="line">balance leastconn</span><br><span class="line">server web1 10.0.0.17:80 weight 1 check inter 3000 fall 2 rise 5</span><br><span class="line">server web2 10.0.0.27:80 weight 1 check inter 3000 fall 2 rise 5</span><br></pre></td></tr></table></figure>

<h3 id="random-算法"><a href="#random-算法" class="headerlink" title="random 算法"></a>random 算法</h3><p>在1.9版本开始增加 random 的负载平衡算法，其基于随机数作为一致性 hash 的 key。随机负载平衡对于大型服务器场或经常添加或删除服务器非常有用，支持 weight 的动态调整，weight 较大的主机有更大概率获取新请求。</p>
<p>random配置实例</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">listen web_host</span><br><span class="line"><span class="built_in">bind</span> 10.0.0.7:80,:8801-8810,10.0.0.7:9001-9010</span><br><span class="line">mode http</span><br><span class="line"><span class="built_in">log</span> global</span><br><span class="line">balance random</span><br><span class="line">server web1 10.0.0.17:80 weight 1 check inter 3000 fall 2 rise 5</span><br><span class="line">server web2 10.0.0.27:80 weight 1 check inter 3000 fall 2 rise 5</span><br></pre></td></tr></table></figure>

<h2 id="其他算法"><a href="#其他算法" class="headerlink" title="其他算法"></a>其他算法</h2><p>其它算法即可作为静态算法，又可以通过选项成为动态算法。</p>
<h3 id="source-算法"><a href="#source-算法" class="headerlink" title="source 算法"></a>source 算法</h3><p>源地址 hash，基于用户源地址 hash 并将请求转发到后端服务器，后续同一个源地址请求将被转发至同一个后端 web 服务器。此方式当后端服务器数据量发生变化时，会导致很多用户的请求转发至新的后端服务器，默认为静态方式，但是可以通过 <code>hash-type</code> 选项进行更改。</p>
<p>这个算法一般是在不插入 Cookie 的 TCP 模式下使用，也可给不支持会话 cookie 的客户提供会话粘性，适用于需要 session 会话保持但不支持 cookie 和缓存的场景。</p>
<p>源地址有两种转发客户端请求到后端服务器的服务器选取计算方式，分别是取模法和一致性 hash。</p>
<h4 id="map-based-取模法"><a href="#map-based-取模法" class="headerlink" title="map-based 取模法"></a>map-based 取模法</h4><p>map-based：取模法，对 source 地址进行 hash 计算，再基于服务器总权重的取模，最终结果决定将此请求转发至对应的后端服务器。此方法是静态的，即不支持在线调整权重，不支持慢启动，可实现对后端服务器均衡调度。缺点是当服务器的总权重发生变化时，即有服务器上线或下线，都会因总权重发生变化而导致调度结果整体改变，<code>hash-type</code> 指定的默认值为此算法。</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">所谓取模运算，就是计算两个数相除之后的余数，10%7=3，7%4=3。</span><br><span class="line">map-based 算法：基于权重取模，hash(source_ip)%所有后端服务器相加的总权重</span><br></pre></td></tr></table></figure>

<p><strong>取模法配置示例：</strong></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">listen web_host</span><br><span class="line"><span class="built_in">bind</span> 10.0.0.7:80,:8801-8810,10.0.0.7:9001-9010</span><br><span class="line">mode tcp</span><br><span class="line"><span class="built_in">log</span> global</span><br><span class="line">balance <span class="built_in">source</span></span><br><span class="line">hash-type map-based</span><br><span class="line">server web1 10.0.0.17:80 weight 1 check inter 3000 fall 2 rise 3</span><br><span class="line">server web2 10.0.0.27:80 weight 1 check inter 3000 fall 2 rise 3</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#不支持动态调整权重值</span></span><br><span class="line">[root@haproxy ~]<span class="comment"># echo &quot;set weight web_host/10.0.0.27 10&quot; | socat stdio /var/lib/haproxy/haproxy.sock</span></span><br><span class="line">Backend is using a static LB algorithm and only accepts weights <span class="string">&#x27;0%&#x27;</span> and <span class="string">&#x27;100%&#x27;</span>.</span><br><span class="line"></span><br><span class="line"><span class="comment">#只能动态上线和下线</span></span><br><span class="line">[root@haproxy ~]<span class="comment"># echo &quot;set weight web_host/10.0.0.27 0&quot; | socat stdio /var/lib/haproxy/haproxy.sock</span></span><br><span class="line">[root@haproxy conf.d]<span class="comment"># echo &quot;get weight web_host/10.0.0.27&quot; | socat stdio /var/lib/haproxy/haproxy.sock</span></span><br><span class="line">0 (initial 1)</span><br></pre></td></tr></table></figure>

<h4 id="一致性-hash"><a href="#一致性-hash" class="headerlink" title="一致性 hash"></a>一致性 hash</h4><p>一致性哈希，当服务器的总权重发生变化时，对调度结果影响是局部的，不会引起大的变动。hash (o) mod n，该 hash 算法是动态的，支持使用 <code>socat</code> 等工具进行在线权重调整，支持慢启动。</p>
<h4 id="算法："><a href="#算法：" class="headerlink" title="算法："></a>算法：</h4><ol>
<li>key1 = hash(source_ip) % (2^32) [0—4294967295]</li>
<li>keyA = hash(后端服务器虚拟 ip) % (2^32)</li>
<li>将 key1 和 keyA 都放在 hash 环上，将用户请求调度到离 key1 最近的 keyA 对应的后端服务器</li>
</ol>
<p><strong>hash 环偏斜问题</strong></p>
<p>增加虚拟服务器 IP 数量，比如：一个后端服务器根据权重为 1 生成 1000 个虚拟 IP，再 hash。而后端服务器权重为 2 则生成 2000 个虚拟 IP，再进行 hash 运算，最终在 hash 环上生成 3000 个节点，从而解决 hash 环偏斜问题。</p>
<h5 id="hash-对象"><a href="#hash-对象" class="headerlink" title="hash 对象"></a>hash 对象</h5><p>Hash 对象到后端服务器的映射关系：</p>
<p>这些配置展示了如何使用 HAProxy 的不同调度算法，并通过 <code>socat</code> 工具动态调整权重。</p>
<p><img src="../../../../images/SRE/day47/4.jpg" alt="4"></p>
<h5 id="一致性hash示意图"><a href="#一致性hash示意图" class="headerlink" title="一致性hash示意图"></a>一致性hash示意图</h5><p>后端服务器在线与离线的调度方式</p>
<p><img src="../../../../images/SRE/day47/5.jpg" alt="5"></p>
<h5 id="一致性hash配置示例"><a href="#一致性hash配置示例" class="headerlink" title="一致性hash配置示例"></a>一致性hash配置示例</h5><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">listen web_host</span><br><span class="line"><span class="built_in">bind</span> 10.0.0.7:80,:8801-8810,10.0.0.7:9001-9010</span><br><span class="line">mode tcp</span><br><span class="line"><span class="built_in">log</span> global</span><br><span class="line">balance <span class="built_in">source</span></span><br><span class="line">hash-type consistent   <span class="comment"># 决定source是静态还是动态</span></span><br><span class="line">server web1 10.0.0.17:80 weight 1 check inter 3000 fall 2 rise 5</span><br><span class="line">server web2 10.0.0.27:80 weight 1 check inter 3000 fall 2 rise 5</span><br></pre></td></tr></table></figure>

<h3 id="uri-算法"><a href="#uri-算法" class="headerlink" title="uri 算法"></a>uri 算法</h3><p>基于对用户请求的 URI 的左半部分或整个 URI 做 hash，再将 hash 结果对总权重进行取模后，根据最终结果将请求转发到后端指定服务器。适用于后端是缓存服务器场景，默认为静态算法，也可以通过 <code>hash-type</code> 指定 <code>map-based</code> 和 <code>consistent</code>，来定义使用取模法还是一致性 hash。</p>
<p><strong>注意：此算法基于应用层，所以只支持 mode http，不支持 mode tcp</strong></p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;scheme&gt;://&lt;username&gt;:&lt;password&gt;@&lt;host&gt;:&lt;port&gt;/&lt;path&gt;;params?query#frag</span><br><span class="line">左半部分: /path;params</span><br><span class="line">整个 URI: /path;params?query#frag</span><br></pre></td></tr></table></figure>

<p><img src="../../../../images/SRE/day47/6.jpg" alt="6"></p>
<h4 id="uri-取模法配置示例"><a href="#uri-取模法配置示例" class="headerlink" title="uri 取模法配置示例"></a>uri 取模法配置示例</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">listen web_host</span><br><span class="line"><span class="built_in">bind</span> 10.0.0.7:80,:8801-8810,10.0.0.7:9001-9010</span><br><span class="line">mode http</span><br><span class="line"><span class="built_in">log</span> global</span><br><span class="line">balance uri</span><br><span class="line">server web1 10.0.0.17:80 weight 1 check inter 3000 fall 2 rise 5</span><br><span class="line">server web2 10.0.0.27:80 weight 1 check inter 3000 fall 2 rise 5</span><br></pre></td></tr></table></figure>

<h4 id="uri-一致性-hash-配置示例"><a href="#uri-一致性-hash-配置示例" class="headerlink" title="uri 一致性 hash 配置示例"></a>uri 一致性 hash 配置示例</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">listen web_host</span><br><span class="line"><span class="built_in">bind</span> 10.0.0.7:80,:8801-8810,10.0.0.7:9001-9010</span><br><span class="line">mode http</span><br><span class="line"><span class="built_in">log</span> global</span><br><span class="line">balance uri</span><br><span class="line">hash-type consistent</span><br><span class="line">server web1 10.0.0.17:80 weight 1 check inter 3000 fall 2 rise 5</span><br><span class="line">server web2 10.0.0.27:80 weight 1 check inter 3000 fall 2 rise 5</span><br></pre></td></tr></table></figure>

<h4 id="访问测试"><a href="#访问测试" class="headerlink" title="访问测试"></a>访问测试</h4><p>访问不同的url，确认可以将用户同样的请求转发至相同的服务器</p>
<h3 id="url-param-算法"><a href="#url-param-算法" class="headerlink" title="url_param 算法"></a>url_param 算法</h3><p>url_param对用户请求的url中的params部分中的一个参数key对应的value值作hash计算，并由服务器总权重相除以后派发至某挑出的服务器；通常用于追踪用户，以确保来自同一个用户的请求始终发往同一个real server。如果无该key，将按roundrobin算法。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#假设</span></span><br><span class="line">url = http://www.wang.com/foo/bar/index.php?key=value</span><br><span class="line"></span><br><span class="line"><span class="comment">#则：</span></span><br><span class="line">host = <span class="string">&quot;www.wang.com&quot;</span></span><br><span class="line">url_param = <span class="string">&quot;key=value&quot;</span></span><br></pre></td></tr></table></figure>

<h4 id="url-param取模法配置示例"><a href="#url-param取模法配置示例" class="headerlink" title="url_param取模法配置示例"></a>url_param取模法配置示例</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">listen web_host</span><br><span class="line"><span class="built_in">bind</span> 10.0.0.7:80,:8801-8810,10.0.0.7:9001-9010</span><br><span class="line">mode http</span><br><span class="line"><span class="built_in">log</span> global</span><br><span class="line">balance url_param userid <span class="comment">#url_param hash</span></span><br><span class="line">server web1 10.0.0.17:80 weight 1 check inter 3000 fall 2 rise 5</span><br><span class="line">server web2 10.0.0.27:80 weight 1 check inter 3000 fall 2 rise 5</span><br></pre></td></tr></table></figure>

<h4 id="url-param一致性hash配置示例"><a href="#url-param一致性hash配置示例" class="headerlink" title="url_param一致性hash配置示例"></a>url_param一致性hash配置示例</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">listen web_host</span><br><span class="line"><span class="built_in">bind</span> 10.0.0.7:80,:8801-8810,10.0.0.7:9001-9010</span><br><span class="line">mode http</span><br><span class="line"><span class="built_in">log</span> global</span><br><span class="line">balance url_param userid <span class="comment">#对url_param的值取hash</span></span><br><span class="line">hash-type consistent</span><br><span class="line">server web1 10.0.0.17:80 weight 1 check inter 3000 fall 2 rise 5</span><br><span class="line">server web2 10.0.0.27:80 weight 1 check inter 3000 fall 2 rise 5</span><br></pre></td></tr></table></figure>

<h4 id="测试访问"><a href="#测试访问" class="headerlink" title="测试访问"></a>测试访问</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># curl http://10.0.0.7/index.html?userid=&lt;NAME_ID&gt;</span></span><br><span class="line"><span class="comment"># curl &quot;http://10.0.0.7/index.html?userid=&lt;NAME_ID&gt;&amp;typeid=&lt;TYPE_ID&gt;&quot;</span></span><br></pre></td></tr></table></figure>

<h3 id="hdr-算法"><a href="#hdr-算法" class="headerlink" title="hdr 算法"></a>hdr 算法</h3><p>针对用户每个HTTP头部(header)请求中的指定信息做hash，此处由name指定的HTTP首部将会被取出并做hash计算，然后由服务器总权重取模以后派发至某挑出的服务器。如果无有效值，则会使用默认的轮询调度。</p>
<h4 id="hdr取模法配置示例"><a href="#hdr取模法配置示例" class="headerlink" title="hdr取模法配置示例"></a>hdr取模法配置示例</h4><p>针对不同的浏览器进行调度：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">listen web_host</span><br><span class="line"><span class="built_in">bind</span> 10.0.0.7:80,:8801-8810,10.0.0.7:9001-9010</span><br><span class="line">mode http</span><br><span class="line"><span class="built_in">log</span> global</span><br><span class="line">balance hdr(User-Agent)</span><br><span class="line"><span class="comment">#balance hdr(host)</span></span><br><span class="line"></span><br><span class="line">server web1 10.0.0.17:80 weight 1 check inter 3000 fall 2 rise 5</span><br><span class="line">server web2 10.0.0.27:80 weight 1 check inter 3000 fall 2 rise 5</span><br></pre></td></tr></table></figure>

<h4 id="一致性hash配置示例-1"><a href="#一致性hash配置示例-1" class="headerlink" title="一致性hash配置示例"></a>一致性hash配置示例</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">listen web_host</span><br><span class="line"><span class="built_in">bind</span> 10.0.0.7:80,:8801-8810,10.0.0.7:9001-9010</span><br><span class="line">mode http</span><br><span class="line"><span class="built_in">log</span> global</span><br><span class="line">balance hdr(User-Agent)</span><br><span class="line">hash-type consistent</span><br><span class="line"></span><br><span class="line">server web1 10.0.0.17:80 weight 1 check inter 3000 fall 2 rise 5</span><br><span class="line">server web2 10.0.0.27:80 weight 1 check inter 3000 fall 2 rise 5</span><br></pre></td></tr></table></figure>

<h4 id="测试访问-1"><a href="#测试访问-1" class="headerlink" title="测试访问"></a>测试访问</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@centos6 ~]<span class="comment"># curl -v http://10.0.0.7/index.html</span></span><br><span class="line">[root@centos6 ~]<span class="comment"># curl -VA &#x27;firefox&#x27; http://10.0.0.7/index.html</span></span><br><span class="line">[root@centos6 ~]<span class="comment"># curl -VA &#x27;chrome&#x27; http://10.0.0.7/index.html</span></span><br></pre></td></tr></table></figure>

<h3 id="rdp-cookie-算法"><a href="#rdp-cookie-算法" class="headerlink" title="rdp-cookie 算法"></a>rdp-cookie 算法</h3><p>rdp-cookie对远windows远程桌面的负载，使用cookie保持会话，默认是静态，也可以通过hash-type指定map-based和consistent，来定义使用取模法还是一致性hash。</p>
<h4 id="rdp-cookie-取模法配置示例"><a href="#rdp-cookie-取模法配置示例" class="headerlink" title="rdp-cookie 取模法配置示例"></a>rdp-cookie 取模法配置示例</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">listen RDP</span><br><span class="line"><span class="built_in">bind</span> 10.0.0.7:3389</span><br><span class="line">balance rdp-cookie</span><br><span class="line">mode tcp</span><br><span class="line">server rdp0 10.0.0.17:3389 check fall 3 rise 5 inter 2000 weight 1</span><br></pre></td></tr></table></figure>

<h4 id="dp-cookie-一致性hash配置示例"><a href="#dp-cookie-一致性hash配置示例" class="headerlink" title="dp-cookie 一致性hash配置示例"></a>dp-cookie 一致性hash配置示例</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@haproxy ~]<span class="comment"># cat /etc/haproxy/conf.d/windows_rdp.cfg</span></span><br><span class="line">listen wang_RDP_3389</span><br><span class="line">mode tcp</span><br><span class="line"><span class="built_in">bind</span> 172.16.0.100:3389</span><br><span class="line">balance rdp-cookie</span><br><span class="line">hash-type consistent</span><br><span class="line">server rdp0 10.0.0.200:3389 check fall 3 rise 5 inter 2000 weight 1</span><br></pre></td></tr></table></figure>

<p><strong>测试命令</strong></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@haproxy ~]<span class="comment"># hostname -I</span></span><br><span class="line">10.0.0.7 172.16.0.100</span><br></pre></td></tr></table></figure>

<h3 id="算法总结"><a href="#算法总结" class="headerlink" title="算法总结"></a>算法总结</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#静态</span></span><br><span class="line">static-rr----------&gt;tcp/http</span><br><span class="line">first--------------&gt;tcp/http</span><br><span class="line"></span><br><span class="line"><span class="comment">#动态</span></span><br><span class="line">roundrobin---------&gt;tcp/http</span><br><span class="line">leastconn----------&gt;tcp/http</span><br><span class="line">random-------------&gt;tcp/http</span><br><span class="line"></span><br><span class="line"><span class="comment">#以下静态和动态取决于hash_type是否consistent</span></span><br><span class="line">source-------------tcp/http</span><br><span class="line">Uri----------------http</span><br><span class="line">url_param----------http</span><br><span class="line">hdr---------------http</span><br><span class="line">rdp-cookie---------&gt;tcp</span><br><span class="line"></span><br><span class="line"><span class="comment">#各种算法使用场景</span></span><br><span class="line">first             <span class="comment">#使用较少</span></span><br><span class="line">static-rr         <span class="comment">#做了session共享的 web 集群</span></span><br><span class="line">roundrobin</span><br><span class="line">random</span><br><span class="line">leastconn        <span class="comment">#数据库</span></span><br><span class="line"><span class="built_in">source</span>           <span class="comment">#基于客户端公网 IP 的会话保持</span></span><br><span class="line">Uri--------------http    <span class="comment">#缓存服务器，CDN服务商，蓝汛、百度、阿里云、腾讯</span></span><br><span class="line">url_param--------http   <span class="comment">#可以实现session保持</span></span><br><span class="line">hdr              <span class="comment">#基于客户端请求报文头部做下一步处理</span></span><br><span class="line">rdp-cookie       <span class="comment">#基于windows主机,很少使用</span></span><br></pre></td></tr></table></figure>

<h1 id="HAProxy-高级功能"><a href="#HAProxy-高级功能" class="headerlink" title="HAProxy 高级功能"></a>HAProxy 高级功能</h1><p>介绍 HAProxy 高级配置及实用案例</p>
<h2 id="基于-Cookie-的会话保持"><a href="#基于-Cookie-的会话保持" class="headerlink" title="基于 Cookie 的会话保持"></a>基于 Cookie 的会话保持</h2><p>cookie value: 为当前 server 指定 cookie 值，实现基于 cookie 的会话黏性。相对于基于 source 地址 hash 调度算法对客户端的粒度更精准，但同时也加重了 haproxy 负载。目前此模式使用较少，已经被 session 共享服务器代替。</p>
<p>注意：不支持 tcp mode，使用 http mode</p>
<h3 id="配置选项"><a href="#配置选项" class="headerlink" title="配置选项"></a>配置选项</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">cookie name [ rewrite | insert | prefix ] [ indirect ] [ nocache ] [ postonly ] [ preserve ] [ httponly ] [ secure ] [ domain ]* [ maxidle &lt;idle&gt; ] [ maxlife ]</span><br><span class="line"></span><br><span class="line">name:        <span class="comment">#cookie 的 key 名称，用于实现持久连接</span></span><br><span class="line">insert:      <span class="comment">#插入新的 cookie，默认不插入 cookie</span></span><br><span class="line">indirect:    <span class="comment">#如果客户端已经有 cookie，则不会再发送 cookie 信息</span></span><br><span class="line">nocache:     <span class="comment">#当 client 和 hapoxy 之间有缓存服务器（如：CDN）时，不允许中间缓存器缓存 cookie，因为这会导致很多经过同一个 CDN 的请求都发送到同一台后端服务器</span></span><br></pre></td></tr></table></figure>

<h3 id="配置示例"><a href="#配置示例" class="headerlink" title="配置示例"></a>配置示例</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">listen web_port</span><br><span class="line"><span class="built_in">bind</span> 10.0.0.7:80</span><br><span class="line">balance roundrobin</span><br><span class="line">mode http</span><br><span class="line"><span class="built_in">log</span> global</span><br><span class="line">cookie WEBSRV insert nocache indirect</span><br><span class="line">server web1 10.0.0.17:80 check inter 3000 fall 2 rise 5 cookie web1</span><br><span class="line">server web2 10.0.0.27:80 check inter 3000 fall 2 rise 5 cookie web2</span><br></pre></td></tr></table></figure>

<h3 id="验证-Cookie-信息"><a href="#验证-Cookie-信息" class="headerlink" title="验证 Cookie 信息"></a>验证 Cookie 信息</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">curl -c cookie.txt http://www.wang.org/</span><br><span class="line">10.0.0.17</span><br><span class="line"></span><br><span class="line">curl -b cookie.txt http://www.wang.org/</span><br><span class="line">10.0.0.17</span><br><span class="line">curl -b cookie.txt http://www.wang.org/</span><br><span class="line">10.0.0.17</span><br><span class="line">curl -b cookie.txt http://www.wang.org/</span><br><span class="line">10.0.0.17</span><br></pre></td></tr></table></figure>

<h2 id="HAProxy-状态页"><a href="#HAProxy-状态页" class="headerlink" title="HAProxy 状态页"></a>HAProxy 状态页</h2><p>通过Web界面，显示当前HAProxy的运行状态。</p>
<p>官方帮助：</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">http://cbonte.github.io/haproxy-dconv/2.4/configuration.html#4-stats%20admin</span><br><span class="line">http://cbonte.github.io/haproxy-dconv/2.0/configuration.html#4-stats%20admin</span><br></pre></td></tr></table></figure>

<h3 id="状态页配置项"><a href="#状态页配置项" class="headerlink" title="状态页配置项"></a>状态页配置项</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">stats <span class="built_in">enable</span>	         <span class="comment">#基于默认的参数启用stats page</span></span><br><span class="line">stats hide-version	     <span class="comment">#将状态页中haproxy版本隐藏</span></span><br><span class="line">stats refresh &lt;delay&gt;	 <span class="comment">#设定自动刷新时间间隔，默认不自动刷新，以秒为单位</span></span><br><span class="line">stats uri &lt;prefix&gt;	     <span class="comment">#自定义stats page uri，默认值：/haproxy/stats</span></span><br><span class="line">stats realm &lt;realm&gt;	     <span class="comment">#账户认证时的提示信息，示例：stats realm HAProxy Statistics</span></span><br><span class="line">stats auth &lt;user&gt;:&lt;passwd&gt;	<span class="comment">#认证时的账号和密码，可定义多个用户，每行指定一个用户，默认：no authentication</span></span><br><span class="line">stats admin &#123; <span class="keyword">if</span> | unless &#125; &lt;cond&gt;  <span class="comment">#启用 stats page中的管理功能</span></span><br></pre></td></tr></table></figure>

<h3 id="启用状态页示例"><a href="#启用状态页示例" class="headerlink" title="启用状态页示例"></a>启用状态页示例</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">listen haproxy-status</span><br><span class="line">    <span class="built_in">bind</span> :9999</span><br><span class="line">    stats <span class="built_in">enable</span></span><br><span class="line">    <span class="comment">#stats hide-version</span></span><br><span class="line">    stats uri /haproxy-status         <span class="comment">#自定义stats page uri</span></span><br><span class="line">    stats realm HAProxy\ Stats\ Page  <span class="comment">#账户认证时的提示信息</span></span><br><span class="line">    stats auth haadmin:123456         <span class="comment">#支持多个用户</span></span><br><span class="line">    stats auth admin:123456</span><br><span class="line">    <span class="comment">#stats refresh 30</span></span><br><span class="line">    stats admin <span class="keyword">if</span> TRUE               <span class="comment">#开启管理功能，基于安全原因，不建议开启</span></span><br></pre></td></tr></table></figure>

<h3 id="登录状态页说明"><a href="#登录状态页说明" class="headerlink" title="登录状态页说明"></a>登录状态页说明</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">pid = 27134 (process <span class="comment">#1, nbproc = 1, nbthread = 1)  # pid为当前pid号，process为当前进程号，nbproc和nbthread为一共多少进程和每个进程多少个线程</span></span><br><span class="line"><span class="built_in">uptime</span> = 0d 0h00m04s   <span class="comment">#启动了多长时间</span></span><br><span class="line">system limits: memmax = unlimited; ulimit-n = 200029 <span class="comment">#系统资源限制：内存/最大打开文件数/</span></span><br><span class="line">maxsock = 200029; maxconn = 100000; maxpipes = 0 <span class="comment">#最大socket连接数/单进程最大连接数/最大管道数maxpipes</span></span><br><span class="line">current conns = 2; current pipes = 0/0; conn rate = 2/sec; bit rate = 0.000 kbps <span class="comment">#当前连接数/当前管道数/当前连接速率</span></span><br><span class="line">Running tasks: 1/14; idle = 100 % <span class="comment">#运行的任务/当前空闲率</span></span><br><span class="line"></span><br><span class="line">active UP:</span><br><span class="line"><span class="comment">#在线服务器</span></span><br><span class="line"></span><br><span class="line">backup UP:</span><br><span class="line"><span class="comment">#标记为backup的服务器</span></span><br><span class="line"></span><br><span class="line">active UP, going down:</span><br><span class="line"><span class="comment">#监测未通过正在进入down过程</span></span><br><span class="line"></span><br><span class="line">backup UP, going down:</span><br><span class="line"><span class="comment">#备份服务器正在进入down过程</span></span><br><span class="line"></span><br><span class="line">active DOWN, going up:</span><br><span class="line"><span class="comment">#down的服务器正在进入up过程</span></span><br><span class="line"></span><br><span class="line">backup DOWN, going up:</span><br><span class="line"><span class="comment">#备份服务器正在进入up过程</span></span><br><span class="line"></span><br><span class="line">active or backup DOWN:</span><br><span class="line"><span class="comment">#在线的服务器或者是backup的服务器已经转换成了down状态</span></span><br><span class="line"></span><br><span class="line">not checked:</span><br><span class="line"><span class="comment">#标记为不监测的服务器</span></span><br><span class="line"></span><br><span class="line">active or backup DOWN <span class="keyword">for</span> maintenance (MAINT)</span><br><span class="line"><span class="comment">#active或者backup服务器人为下线的</span></span><br><span class="line"></span><br><span class="line">active or backup SOFT STOPPED <span class="keyword">for</span> maintenance</span><br><span class="line"><span class="comment">#active或者backup被人为软下线(人为将weight改成0)</span></span><br></pre></td></tr></table></figure>

<h2 id="IP-透传"><a href="#IP-透传" class="headerlink" title="IP 透传"></a>IP 透传</h2><p>web服务器中需要记录客户端的真实IP地址，用于做访问统计、安全防护、行为分析、区域排行等场景。</p>
<h3 id="Layer-4-与-Layer-7"><a href="#Layer-4-与-Layer-7" class="headerlink" title="Layer 4 与 Layer 7"></a>Layer 4 与 Layer 7</h3><ul>
<li>四层：IP+PORT转发</li>
<li>七层：协议+内容交换</li>
</ul>
<p><img src="C:\Users\Lenovo\AppData\Roaming\Typora\typora-user-images\image-20250415150506786.png" alt="image-20250415150506786"></p>
<h4 id="四层负载"><a href="#四层负载" class="headerlink" title="四层负载"></a>四层负载</h4><p>在LVS传统的四层负载设备中，把client发送的报文目标地址（原来是负载均衡设备的IP地址），根据均衡设备设置的选择web服务器的规则选择对应的web服务器IP地址，这样client就可以直接跟此服务器建立TCP连接并发送数据，而四层负载自身不参与建立连接。</p>
<p>而和LVS不同，haproxy是伪四层负载均衡，因为haproxy需要分别和前端客户端及后端服务器建立连接。</p>
<h4 id="七层代理"><a href="#七层代理" class="headerlink" title="七层代理"></a>七层代理</h4><p>七层负载均衡服务器起了一个反向代理服务器的作用，服务器建立一次TCP连接要三次握手，而client要访问Web Server要先与七层负载设备进行三次握手后建立TCP连接，把要访问的报文信息发送给七层负载均衡；然后七层负载均衡再根据设置的均衡规则选择特定的Web Server，然后通过三次握手与此台Web Server建立TCP连接，然后Web Server把需要的数据发送给七层负载均衡设备，负载均衡设备再把数据发送给client；所以，七层负载均衡设备起到了代理服务器的作用，七层代理需要和Client和后端服务器分别建立连接。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@haproxy ~]<span class="comment"># tcpdump tcp -i eth0 -nn port ! 22 -w dump-tcp.pcap -v</span></span><br><span class="line">[root@haproxy ~]<span class="comment"># tcpdump tcp -i eth1 -nn port ! 22 -w dump-tcp2.pcap -v</span></span><br></pre></td></tr></table></figure>

<h3 id="四层IP透传"><a href="#四层IP透传" class="headerlink" title="四层IP透传"></a>四层IP透传</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#haproxy 配置:</span></span><br><span class="line">listen web_http_nodes</span><br><span class="line">    <span class="built_in">bind</span> 172.16.0.100:80 <span class="comment">#因下面wangxiaochun.com的站点建立在阿里云有防火墙，此处必须用80端口，如无防火墙可以使用其它端口</span></span><br><span class="line">    mode tcp <span class="comment">#不支持http协议</span></span><br><span class="line">    balance roundrobin</span><br><span class="line">    server web1 www.wangxiaochun.com:80 send-proxy check inter 3000 fall 3 rise 5 <span class="comment">#添加send-proxy</span></span><br><span class="line">    </span><br><span class="line"><span class="comment">#nginx 配置: 在访问日志中通过变量$proxy_protocol_addr 记录透传过来的客户端IP</span></span><br><span class="line">http &#123;</span><br><span class="line">    log_format main <span class="string">&#x27;$remote_addr - $remote_user [$time_local] &quot;$request&quot; &quot;$proxy_protocol_addr&quot;&#x27;</span>;</span><br><span class="line">    server &#123;</span><br><span class="line">        listen 80 proxy_protocol; <span class="comment">#启用此项，将无法直接访问此网站，只能通过四层代理访问</span></span><br><span class="line">        server_name www.wangxiaochun.com;</span><br><span class="line">        ......</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>抓包可以看到 continuation 信息中带有客户端的源IP</p>
<p><img src="C:\Users\Lenovo\AppData\Roaming\Typora\typora-user-images\image-20250415150814497.png" alt="image-20250415150814497"></p>
<h3 id="七层IP透传"><a href="#七层IP透传" class="headerlink" title="七层IP透传"></a>七层IP透传</h3><p>当haproxy工作在七层的时候，也可以透传客户端真实IP至后端服务器。</p>
<h4 id="HAProxy配置-1"><a href="#HAProxy配置-1" class="headerlink" title="HAProxy配置"></a>HAProxy配置</h4><p>在由haproxy发往后端主机的请求报文中添加“X-Forwarded-For”首部，其值为前端客户端的地址；用于向后端主发送真实的客户端IP。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">option forwardfor [ except &lt;network&gt; ] [ header &lt;name&gt; ] [ if-none ]</span><br><span class="line"></span><br><span class="line">[ except &lt;network&gt; ]: <span class="comment"># 请求报请来自此处指定的网络时不予添加此首部，如haproxy自身所在网络</span></span><br><span class="line">[ header &lt;name&gt; ]:    <span class="comment"># 使用自定义的首部名称，而非“X-Forwarded-For”，示例：X-client</span></span><br><span class="line">[ if-none ]           <span class="comment"># 如果没有首部才添加首部，如果有使用默认值</span></span><br></pre></td></tr></table></figure>

<p><strong>范例:</strong></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#haproxy 配置</span></span><br><span class="line">defaults</span><br><span class="line"></span><br><span class="line"><span class="comment">#此为默认值,首部字段默认为: X-Forwarded-For</span></span><br><span class="line">option forwardfor</span><br><span class="line"></span><br><span class="line"><span class="comment">#或者自定义首部,如:X-client</span></span><br><span class="line">option forwardfor except 127.0.0.0/8 header X-client</span><br><span class="line"></span><br><span class="line"><span class="comment">#listen配置</span></span><br><span class="line">listen web_host</span><br><span class="line">    <span class="built_in">bind</span> 10.0.0.7:80</span><br><span class="line">    mode http <span class="comment">#一定是http模式,tcp 模式不会传递客户端IP</span></span><br><span class="line">    <span class="built_in">log</span> global</span><br><span class="line">    balance random</span><br><span class="line">    server web1 10.0.0.17:80 weight 1 check inter 3000 fall 2 rise 5</span><br><span class="line">    server web2 10.0.0.27:80 weight 1 check inter 3000 fall 2 rise 5</span><br></pre></td></tr></table></figure>

<h4 id="后端web服务器日志格式配置"><a href="#后端web服务器日志格式配置" class="headerlink" title="后端web服务器日志格式配置"></a>后端web服务器日志格式配置</h4><p>配置web服务器，记录负载均衡透传的客户端IP地址</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#apache 配置：需要修改才支持</span></span><br><span class="line">LogFormat <span class="string">&quot;%&#123;X-Forwarded-For&#125;i %a %l %u %t \&quot;%r\&quot; %&gt;s %b \&quot;%&#123;Referer&#125;i\&quot; \&quot;%&#123;User-Agent&#125;i\&quot;&quot;</span> combined</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#nginx 日志格式：默认就支持</span></span><br><span class="line"><span class="variable">$proxy_add_x_forwarded_for</span>: 包括客户端IP和中间经过的所有代理的IP</span><br><span class="line"><span class="variable">$http_x_forwarded_for</span>: 只有客户端IP</span><br><span class="line"></span><br><span class="line">log_format main <span class="string">&#x27;$proxy_add_x_forwarded_for - $remote_user [$time_local] &quot;$request&quot; &#x27;</span></span><br><span class="line">                 <span class="string">&#x27;$status $body_bytes_sent &quot;$http_referer&quot; &#x27;</span></span><br><span class="line">                 <span class="string">&#x27;&quot;$http_user_agent&quot; $http_x_forwarded_for&#x27;</span>;</span><br><span class="line"></span><br><span class="line">[root@centos8 ~]<span class="comment"># tail /var/log/nginx/access.log</span></span><br><span class="line"><span class="string">&quot;172.16.0.200, 10.0.0.7 10.0.0.7 - - [09/Apr/2020:10:10:16 +0800] &quot;</span>GET / HTTP/1.1<span class="string">&quot; 200 4057 &quot;</span>-<span class="string">&quot; &quot;</span>curl/7.19.7 (x86_64-redhat-linux-gnu) libcurl/7.19.7 NSS/3.27.1 zlib/1.2.3 libidn/1.18 libssh2/1.4.2<span class="string">&quot; &quot;</span>172.16.0.200<span class="string">&quot;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">#tomcat 配置：conf目录下的server.xml</span></span><br><span class="line"><span class="string">&lt;Valve className=&quot;</span>org.apache.catalina.valves.AccessLogValve<span class="string">&quot; directory=&quot;</span>logs<span class="string">&quot;</span></span><br><span class="line"><span class="string">       prefix=&quot;</span>localhost_access_log<span class="string">&quot; suffix=&quot;</span>.txt<span class="string">&quot;</span></span><br><span class="line"><span class="string">       pattern=&quot;</span>%&#123;X-Forwarded-For&#125;i %h %l %u %t &amp;quot;%r&amp;quot; %s %b<span class="string">&quot; /&gt;</span></span><br></pre></td></tr></table></figure>

<h4 id="验证客户端IP地址"><a href="#验证客户端IP地址" class="headerlink" title="验证客户端IP地址"></a>验证客户端IP地址</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#apache日志</span></span><br><span class="line">[root@centos7 ~]<span class="comment"># vim /etc/httpd/conf/httpd.conf</span></span><br><span class="line">LogFormat <span class="string">&quot;%&#123;X-Forwarded-For&#125;i %h %l %u %t \&quot;%r\&quot; %&gt;s %b \&quot;%&#123;Referer&#125;i\&quot; \&quot;%&#123;User-Agent&#125;i\&quot;&quot;</span> combined</span><br><span class="line"></span><br><span class="line">[root@centos7 ~]<span class="comment"># systemctl restart httpd</span></span><br><span class="line"></span><br><span class="line">[root@centos6 ~]<span class="comment"># hostname -I</span></span><br><span class="line">10.0.0.6</span><br><span class="line"></span><br><span class="line">[root@centos6 ~]<span class="comment"># curl http://10.0.0.7</span></span><br><span class="line">10.0.0.17</span><br><span class="line"></span><br><span class="line">[root@centos7 ~]<span class="comment"># tail -f /var/log/httpd/access_log</span></span><br><span class="line">10.0.0.6 10.0.0.7 - - [01/Apr/2020:01:08:31 +0800] <span class="string">&quot;GET / HTTP/1.1&quot;</span> 200 10 <span class="string">&quot;-&quot;</span> <span class="string">&quot;curl/7.19.7 (x86_64-redhat-linux-gnu) libcurl/7.19.7 NSS/3.27.1 zlib/1.2.3 libidn/1.18 libssh2/1.4.2&quot;</span></span><br><span class="line">10.0.0.6 10.0.0.7 - - [01/Apr/2020:01:08:33 +0800] <span class="string">&quot;GET / HTTP/1.1&quot;</span> 200 10 <span class="string">&quot;-&quot;</span> <span class="string">&quot;curl/7.19.7 (x86_64-redhat-linux-gnu) libcurl/7.19.7 NSS/3.27.1 zlib/1.2.3 libidn/1.18 libssh2/1.4.2&quot;</span></span><br></pre></td></tr></table></figure>

<h2 id="报文修改"><a href="#报文修改" class="headerlink" title="报文修改"></a>报文修改</h2><p>在http模式下，基于实际需求修改客户端的请求报文与响应报文，通过reqadd和reqdel在请求报文添加删除字段，通过rspadd与rspdel在响应报文中添加与删除字段。</p>
<p><strong>注意：此功能的以下相关指令在2.1以上版本中已经取消</strong></p>
<p>官方文档：参看2.0的帮助文档</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://cbonte.github.io/haproxy-dconv/2.0/configuration.html#4-rspadd</span><br></pre></td></tr></table></figure>

<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#在向后端服务器转发的请求报文尾部添加指定首部</span></span><br><span class="line">reqadd &lt;string&gt; [[<span class="keyword">if</span> | unless] &lt;cond&gt;]</span><br><span class="line">示例: reqadd X-Via:\ HAproxy    <span class="comment">#注意只能有一个空格，并需要转义</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#在向后端服务器转发的请求报文中删除匹配正则表达式的首部</span></span><br><span class="line">reqdel &lt;search&gt; [[<span class="keyword">if</span> | unless] &lt;cond&gt;]</span><br><span class="line">reqidel &lt;search&gt; [[<span class="keyword">if</span> | unless] &lt;cond&gt;]   <span class="comment">#忽略大小写</span></span><br><span class="line"></span><br><span class="line">示例:</span><br><span class="line">reqdel user-agent</span><br><span class="line">reqdel X-Forwarded-For  <span class="comment">#无法删除</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#在向前端客户端转发的响应报文尾部添加指定首部</span></span><br><span class="line">rspadd &lt;string&gt; [[<span class="keyword">if</span> | unless] &lt;cond&gt;]</span><br><span class="line"></span><br><span class="line">示例:</span><br><span class="line">rspadd X-Via:\ HAproxy</span><br><span class="line">rspadd Server:\ wanginx</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#从向前端客户端转发的响应报文中删除匹配正则表达式的首部</span></span><br><span class="line">rspdel &lt;search&gt; [[<span class="keyword">if</span> | unless] &lt;cond&gt;]</span><br><span class="line">rspidel &lt;search&gt; [[<span class="keyword">if</span> | unless] &lt;cond&gt;]   <span class="comment">#忽略大小写</span></span><br><span class="line">示例:</span><br><span class="line">rspdel ^server:.*       <span class="comment">#从响应报文删除server信息</span></span><br><span class="line">rspdel X-Powered-By:.*  <span class="comment">#从响应报文删除X-Powered-By信息，一般此首部字段报错php版本信息</span></span><br></pre></td></tr></table></figure>

<p><strong>2.1 版本以上用下面指令http-request和http-response代替</strong></p>
<p>官方文档：参看2.4的帮助文档</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">http://cbonte.github.io/haproxy-dconv/2.4/configuration.html#4-http-request</span><br><span class="line">http://cbonte.github.io/haproxy-dconv/2.4/configuration.html#4-http-response</span><br></pre></td></tr></table></figure>

<p><strong>配置说明：</strong></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 修改请求host首部，默认host首部会保留客户端原首部haproxy不会修改</span></span><br><span class="line">http-request set-header host www.wangxiaochun.com</span><br><span class="line"></span><br><span class="line"><span class="comment"># 添加向后端服务器发送的请求报文首部</span></span><br><span class="line">http-request add-header &lt;name&gt; &lt;<span class="built_in">fmt</span>&gt; [ &#123; <span class="keyword">if</span> | unless &#125; &lt;condition&gt; ]</span><br><span class="line"><span class="comment"># 示例: http-request add-header X-Haproxy-Current-Date %T</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 删除向后端服务器发送的请求报文首部</span></span><br><span class="line">http-request del-header &lt;name&gt; [ &#123; <span class="keyword">if</span> | unless &#125; &lt;condition&gt; ]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 修改响应首部</span></span><br><span class="line">http-response set-header server wangserver</span><br><span class="line"></span><br><span class="line"><span class="comment"># 添加向客户端发送的响应报文首部</span></span><br><span class="line">http-response add-header &lt;name&gt; &lt;<span class="built_in">fmt</span>&gt; [ &#123; <span class="keyword">if</span> | unless &#125; &lt;condition&gt; ]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 删除向客户端发送的响应报文首部</span></span><br><span class="line">http-response del-header &lt;name&gt;</span><br><span class="line"><span class="comment"># 示例: http-response del-header Server</span></span><br></pre></td></tr></table></figure>

<p><strong>范例: 添加向后端服务器发送的请求报文首部</strong></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[root@haproxy ~]<span class="comment"># vim /etc/haproxy/conf.d/test.cfg</span></span><br><span class="line">frontend wang_web_80</span><br><span class="line">    <span class="built_in">bind</span> 10.0.0.100:80</span><br><span class="line">    use_backend wang_webservers1</span><br><span class="line">    http-request add-header X-Haproxy-Current-Date %T</span><br><span class="line">    </span><br><span class="line">[root@haproxy ~]<span class="comment"># systemctl restart haproxy.service</span></span><br><span class="line"></span><br><span class="line">[root@rs1 ~]<span class="comment"># vim /etc/httpd/conf/httpd.conf</span></span><br><span class="line">LogFormat <span class="string">&quot;%h %l %u %t \&quot;%r\&quot; %&gt;s %b \&quot;%&#123;Referer&#125;i\&quot; \&quot;%&#123;User-Agent&#125;i\&quot; \&quot;%&#123;X-Forwarded-For&#125;i\&quot; \&quot;%&#123;X-Haproxy-Current-Date&#125;i\&quot;&quot;</span> combined</span><br><span class="line"></span><br><span class="line">[root@rs1 ~]<span class="comment"># tail /var/log/httpd/access_log</span></span><br><span class="line">10.0.0.100 - - [21/Jun/2021:15:43:29 +0800] <span class="string">&quot;GET / HTTP/1.1&quot;</span> 200 11 <span class="string">&quot;-&quot;</span> <span class="string">&quot;curl/7.29.0&quot;</span> <span class="string">&quot;10.0.0.7&quot;</span> <span class="string">&quot;21/Jun/2021:07:43:29 +0800&quot;</span></span><br></pre></td></tr></table></figure>

<h2 id="自定义日志格式"><a href="#自定义日志格式" class="headerlink" title="自定义日志格式"></a>自定义日志格式</h2><p>log global 开启日志功能，默认只会在记录下面格式的日志</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@haproxy ~]<span class="comment"># tail /var/log/haproxy.log</span></span><br><span class="line">Apr  9 19:38:46 localhost haproxy[60049]: Connect from 172.16.0.200:54628 to 172.16.0.100:80 (web_prot_http_nodes/HTTP)</span><br></pre></td></tr></table></figure>

<p>option httplog 可以采用 http 格式记录下来，并且可以使用相关指令将特定信息记录在haproxy的日志中</p>
<p>但一般不建议开启，这会加重 HAProxy 负载</p>
<h3 id="配置选项-1"><a href="#配置选项-1" class="headerlink" title="配置选项"></a>配置选项</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">log</span> global:              <span class="comment">#开启日志功能。</span></span><br><span class="line">option httplog:          <span class="comment">#启用HTTP日志格式。</span></span><br><span class="line">capture cookie &lt;name&gt; len &lt;length&gt;: <span class="comment">#记录指定长度的cookie信息。</span></span><br><span class="line">capture request header &lt;name&gt; len &lt;length&gt;: <span class="comment">#捕获并记录指定长度的请求头信息。</span></span><br><span class="line">capture response header &lt;name&gt; len &lt;length&gt;: <span class="comment">#捕获并记录指定长度的响应头信息。</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 示例:</span></span><br><span class="line"><span class="built_in">log</span> global</span><br><span class="line">option httplog</span><br><span class="line">capture request header Host len 256</span><br><span class="line">capture request header User-Agent len 512</span><br><span class="line">capture request header Referer len 15</span><br><span class="line">capture request header X-Forwarded-For len 15</span><br></pre></td></tr></table></figure>

<h3 id="配置示例-1"><a href="#配置示例-1" class="headerlink" title="配置示例"></a>配置示例</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">listen web_host</span><br><span class="line">    <span class="built_in">bind</span> 10.0.0.7:80</span><br><span class="line">    mode http</span><br><span class="line">    balance roundrobin</span><br><span class="line">    <span class="built_in">log</span> global               <span class="comment">#开启日志功能</span></span><br><span class="line">    option httplog           <span class="comment">#开启httplog日志格式选项</span></span><br><span class="line">    capture request header User-Agent len 512   <span class="comment">#记录日志信息，记录User-Agent首部值的前512个字符</span></span><br><span class="line">    capture request header Host len 256         <span class="comment">#记录日志信息，记录Host首部值</span></span><br><span class="line">    cookie SERVER-COOKIE insert indirect nocache</span><br><span class="line">    server web1 10.0.0.17:80 cookie web1 check inter 3000 fall 3 rise 5</span><br><span class="line">    server web2 10.0.0.27:80 cookie web2 check inter 3000 fall 3 rise 5</span><br></pre></td></tr></table></figure>

<h3 id="验证日志格式"><a href="#验证日志格式" class="headerlink" title="验证日志格式"></a>验证日志格式</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@centos7 ~]<span class="comment"># tail -n3 /var/log/haproxy.log</span></span><br><span class="line">Apr  2 12:44:26 localhost haproxy[27637]: 10.0.0.6:50004 [02/Apr/2020:12:44:26.817] web_port web_port/web1 0/0/0/2/3 200 42484 - --NI 1/1/0/0 0/0 &#123;curl/7.19.7 (x86_64-redhat-linux-gnu) libcurl/7.19.7 NSS/3.27.1 zlib/1.2.3 libidn/1.18 libssh2/1.4.2&#125;[10.0.0.7] <span class="string">&quot;GET /test.php HTTP/1.1&quot;</span></span><br><span class="line">Apr  2 12:44:27 localhost haproxy[27637]: 10.0.0.6:50006 [02/Apr/2020:12:44:27.294] web_port web_port/web2 0/0/0/1/1 404 370 - --NI 1/1/0/0 0/0 &#123;curl/7.19.7 (x86_64-redhat-linux-gnu) libcurl/7.19.7 NSS/3.27.1 zlib/1.2.3 libidn/1.18 libssh2/1.4.2&#125;[10.0.0.7] <span class="string">&quot;GET /test.php HTTP/1.1&quot;</span></span><br><span class="line">Apr  2 12:44:27 localhost haproxy[27637]: 10.0.0.6:50008 [02/Apr/2020:12:44:27.840] web_port web_port/web1 0/0/0/3/4 200 42484 - --NI 1/1/0/0 0/0 &#123;curl/7.19.7 (x86_64-redhat-linux-gnu) libcurl/7.19.7 NSS/3.27.1 zlib/1.2.3 libidn/1.18 libssh2/1.4.2&#125;[10.0.0.7] <span class="string">&quot;GET /test.php HTTP/1.1&quot;</span></span><br></pre></td></tr></table></figure>

<h2 id="压缩功能"><a href="#压缩功能" class="headerlink" title="压缩功能"></a>压缩功能</h2><p>对响应给客户端的报文进行压缩，以节省网络带宽，但是会占用部分CPU性能。</p>
<p>建议在后端服务器开启压缩功能，而非在HAProxy上开启压缩。</p>
<h3 id="配置选项-2"><a href="#配置选项-2" class="headerlink" title="配置选项"></a>配置选项</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">compression algo &lt;algorithm&gt; ...  <span class="comment">#启用http协议中的压缩机制，常用算法有gzip, deflate</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#压缩算法&lt;algorithm&gt;支持下面类型:</span></span><br><span class="line">identity  <span class="comment">#debug调试使用的压缩方式</span></span><br><span class="line">gzip      <span class="comment">#常用的压缩方式，与各浏览器兼容较好</span></span><br><span class="line">deflate   <span class="comment">#有些浏览器不支持</span></span><br><span class="line">raw-deflate  <span class="comment">#新式的压缩方式</span></span><br><span class="line"></span><br><span class="line">compression <span class="built_in">type</span> &lt;mime <span class="built_in">type</span>&gt; ...  <span class="comment">#要压缩的文件类型MIME</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#示例:</span></span><br><span class="line">compression algo gzip deflate</span><br><span class="line">compression <span class="built_in">type</span> text/html text/css text/plain</span><br></pre></td></tr></table></figure>

<h3 id="配置示例-2"><a href="#配置示例-2" class="headerlink" title="配置示例"></a>配置示例</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">listen web_host</span><br><span class="line">    <span class="built_in">bind</span> 10.0.0.7:80</span><br><span class="line">    mode http</span><br><span class="line">    balance roundrobin</span><br><span class="line">    <span class="built_in">log</span> global</span><br><span class="line">    option httplog</span><br><span class="line">    compression algo gzip deflate  <span class="comment">#启用压缩和指定算法</span></span><br><span class="line">    compression <span class="built_in">type</span> text/plain text/html text/css text/xml text/javascript application/javascript  <span class="comment">#指定压缩文件类型</span></span><br><span class="line">    server web1 10.0.0.17:80 cookie web1 check inter 3000 fall 3 rise 5</span><br><span class="line">    server web2 10.0.0.27:80 cookie web2 check inter 3000 fall 3 rise 5</span><br><span class="line">    </span><br><span class="line"><span class="comment">#后端服务器准备一个文本文件</span></span><br><span class="line">[root@centos7 ~]<span class="comment"># ll /var/www/html/m.txt -h</span></span><br></pre></td></tr></table></figure>

<h3 id="验证压缩功能"><a href="#验证压缩功能" class="headerlink" title="验证压缩功能"></a>验证压缩功能</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">[root@centos6 ~]<span class="comment"># curl -is --compressed 10.0.0.7/m.txt | less</span></span><br><span class="line">HTTP/1.1 200 OK</span><br><span class="line"><span class="built_in">date</span>: Thu, 02 Apr 2020 05:00:26 GMT</span><br><span class="line">server: Apache/2.4.6 (CentOS) PHP/5.4.16</span><br><span class="line">last-modified: Thu, 02 Apr 2020 04:56:25 GMT</span><br><span class="line">etag: W/<span class="string">&quot;c0ef6-5a2479f7aee68&quot;</span></span><br><span class="line">accept-ranges: bytes</span><br><span class="line">content-type: text/plain; charset=UTF-8</span><br><span class="line">set-cookie: WEBSRV=web1; path=/</span><br><span class="line">cache-control: private</span><br><span class="line">content-encoding: deflate</span><br><span class="line">transfer-encoding: chunked</span><br><span class="line">vary: Accept-Encoding</span><br><span class="line"></span><br><span class="line">Feb  2 18:49:27 centos7 journal: Runtime journal is using 6.0M (max allowed 48.6M, trying to leave 72.9M free of 480.1M available -&gt; current <span class="built_in">limit</span> 48.6M).</span><br><span class="line">Feb  2 18:49:27 centos7 kernel: Initializing cgroup subsys cpuset</span><br><span class="line">Feb  2 18:49:27 centos7 kernel: Initializing cgroup subsys cpu</span><br><span class="line">Feb  2 18:49:27 centos7 kernel: Initializing cgroup subsys cpuacct</span><br><span class="line">......</span><br></pre></td></tr></table></figure>

<h2 id="后端服务器健康性监测"><a href="#后端服务器健康性监测" class="headerlink" title="后端服务器健康性监测"></a>后端服务器健康性监测</h2><h3 id="三种状态监测方式"><a href="#三种状态监测方式" class="headerlink" title="三种状态监测方式"></a>三种状态监测方式</h3><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">基于四层的传输端口做状态监测，此为默认方式</span><br><span class="line">基于指定 URI 做状态监测，需要访问整个页面资源，占用更多带宽</span><br><span class="line">基于指定 URI 的 request 请求头部内容做状态监测，占用较少带宽，建议使用此方式</span><br></pre></td></tr></table></figure>

<h3 id="基于应用层http协议进行健康性检测"><a href="#基于应用层http协议进行健康性检测" class="headerlink" title="基于应用层http协议进行健康性检测"></a>基于应用层http协议进行健康性检测</h3><p>基于应用层HTTP协议，有不同的监测方式，对后端real server进行状态监测。</p>
<p>注意：此方式会导致在后端服务器生成很多的HAProxy发起的访问日志。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">option httpchk               <span class="comment">#启用七层健康性检测，对tcp 和 http 模式都支持，默认为: OPTIONS / HTTP/1.0</span></span><br><span class="line">option httpchk &lt;uri&gt;</span><br><span class="line">option httpchk &lt;method&gt; &lt;uri&gt;</span><br><span class="line">option httpchk &lt;method&gt; &lt;uri&gt; &lt;version&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment">#期望以上检查得到的响应码</span></span><br><span class="line">http-check expect [!] &lt;match&gt; &lt;pattern&gt;</span><br><span class="line"><span class="comment">#示例:</span></span><br><span class="line">http-check expect status 200</span><br><span class="line">http-check expect ! rstatus ^5  <span class="comment">#支持正则表达式</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#关于HTTP/1.1的说明</span></span><br><span class="line">&lt;version&gt; is the optional HTTP version string. It defaults to <span class="string">&quot;HTTP/1.0&quot;</span> but some servers might behave incorrectly <span class="keyword">in</span> HTTP 1.0, so turning it to HTTP/1.1 may sometimes <span class="built_in">help</span>. Note that the Host field is mandatory <span class="keyword">in</span> HTTP/1.1, and as a trick, it is possible to pass it after <span class="string">&quot;\r\n&quot;</span> following the version string.</span><br></pre></td></tr></table></figure>

<h3 id="配置示例-3"><a href="#配置示例-3" class="headerlink" title="配置示例"></a>配置示例</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">listen web_host</span><br><span class="line">    <span class="built_in">bind</span> 10.0.0.7:80</span><br><span class="line">    mode http</span><br><span class="line">    balance roundrobin</span><br><span class="line">    <span class="comment">#option httpchk GET /monitor/check.html               #默认HTTP/1.0</span></span><br><span class="line">    <span class="comment">#option httpchk GET /monitor/check.html HTTP/1.0</span></span><br><span class="line">    <span class="comment">#option httpchk GET /monitor/check.html HTTP/1.1      #注意：HTTP/1.1强制要求必须有Host字段</span></span><br><span class="line">    option httpchk HEAD /monitor/check.html HTTP/1.1\r\nHost:\ www.wang.org  <span class="comment">#使用HEAD减少网络流量</span></span><br><span class="line">    cookie SERVER-COOKIE insert indirect nocache</span><br><span class="line">    server web1 10.0.0.17:80 cookie web1 check inter 3000 fall 3 rise 5</span><br><span class="line">    server web2 10.0.0.27:80 cookie web2 check inter 3000 fall 3 rise 5</span><br><span class="line">    </span><br><span class="line"><span class="comment">#创建检测页面</span></span><br><span class="line"><span class="comment"># 在所有后端服务建立检测页面</span></span><br><span class="line">[root@backend ~]<span class="comment"># mkdir /var/www/html/monitor/</span></span><br><span class="line">[root@backend ~]<span class="comment"># echo monitor &gt; /var/www/html/monitor/check.html</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#关闭一台 Backend 服务器</span></span><br><span class="line"><span class="comment"># 关闭一台Backend服务器</span></span><br><span class="line">[root@backend1 ~]<span class="comment"># systemctl stop httpd</span></span><br></pre></td></tr></table></figure>

<h2 id="ACL"><a href="#ACL" class="headerlink" title="ACL"></a>ACL</h2><p>访问控制列表（ACL, Access Control Lists）是一种基于包过滤的访问控制技术，它可以根据设定的条件对经过服务器传输的数据包进行过滤（条件匹配），即对接收到的报文进行匹配和过滤。基于请求报文头部中的源地址、源端口、目标地址、目标端口、请求方法、URL、文件后缀等信息内容进行匹配并执行进一步操作，比如允许其通过或丢弃。</p>
<p>官方帮助：</p>
<ul>
<li><a target="_blank" rel="noopener" href="http://cbonte.github.io/haproxy-dconv/2.1/configuration.html#7">http://cbonte.github.io/haproxy-dconv/2.1/configuration.html#7</a></li>
<li><a target="_blank" rel="noopener" href="http://cbonte.github.io/haproxy-dconv/2.0/configuration.html#7">http://cbonte.github.io/haproxy-dconv/2.0/configuration.html#7</a></li>
</ul>
<h3 id="定义ACL配置选项"><a href="#定义ACL配置选项" class="headerlink" title="定义ACL配置选项"></a>定义ACL配置选项</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">acl   &lt;aclname&gt; &lt;criterion&gt; [flags] [operator] [value]</span><br><span class="line">acl       名称     匹配规范   匹配模式  具体操作符 操作对象类型</span><br></pre></td></tr></table></figure>

<h4 id="ACL-Name"><a href="#ACL-Name" class="headerlink" title="ACL-Name"></a>ACL-Name</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">acl image_service hdr_dom(host) -i img.wang.com</span><br><span class="line"></span><br><span class="line">ACL名称，可以使用大字母A-Z、小写字母a-z、数字0-9、冒号:、点.、中横线和下划线，并且严格区分大小写，比如: my_acl 和 My_Acl 就是两个完全不同的 acl</span><br></pre></td></tr></table></figure>

<h4 id="ACL-criterion"><a href="#ACL-criterion" class="headerlink" title="ACL-criterion"></a>ACL-criterion</h4><p>定义ACL匹配规范，即：判断条件</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line">hdr string, 提取在一个HTTP请求报文的首部</span><br><span class="line">hdr ([&lt;name&gt; [, &lt;occ&gt;]]): 完全匹配字符串, header 的指定信息, &lt;occ&gt; 表示在多值中使用的值的出现次数</span><br><span class="line">hdr_beg ([&lt;name&gt; [, &lt;occ&gt;]]): 前缀匹配, header 中指定匹配内容的 begin</span><br><span class="line">hdr_end ([&lt;name&gt; [, &lt;occ&gt;]]): 后缀匹配, header 中指定匹配内容 end</span><br><span class="line">hdr_dom ([&lt;name&gt; [, &lt;occ&gt;]]): 域匹配, header 中的 domain name</span><br><span class="line">hdr_dir ([&lt;name&gt; [, &lt;occ&gt;]]): 路径匹配, header 的 uri 路径</span><br><span class="line">hdr_len ([&lt;name&gt; [, &lt;occ&gt;]]): 长度匹配, header 的长度匹配</span><br><span class="line">hdr_reg ([&lt;name&gt; [, &lt;occ&gt;]]): 正则表达式匹配, 自定义表达式 (regex) 模糊匹配</span><br><span class="line">hdr_sub ([&lt;name&gt; [, &lt;occ&gt;]]): 子串匹配, header 中的 uri 模糊匹配</span><br><span class="line"></span><br><span class="line"><span class="comment">#示例：</span></span><br><span class="line">hdr (&lt;string&gt;) 用于测试请求头部首部指定内容</span><br><span class="line">hdr_dom(host) 请求的 host 名称，如 www.wang.com, m.wang.com</span><br><span class="line">hdr_beg(host) 请求的 host 开头，如 www., img., video., download., ftp.</span><br><span class="line">hdr_end(host) 请求的 host 结尾，如 .com, .net, .cn</span><br><span class="line"></span><br><span class="line"><span class="comment">#示例：</span></span><br><span class="line">hdr (&lt;string&gt;) 用于测试请求头部首部指定内容</span><br><span class="line">hdr_dom(host) 请求的host名称，如 www.wang.com,m.wang.com</span><br><span class="line">hdr_beg(host) 请求的host开头，如 www., img., video., download., ftp.</span><br><span class="line">hdr_end(host) 请求的host结尾，如 .com, .net, .cn</span><br><span class="line"></span><br><span class="line"><span class="comment">#示例：</span></span><br><span class="line">acl bad_agent hdr_sub(User-Agent) -i curl wget</span><br><span class="line">http-request deny <span class="keyword">if</span> bad_agent</span><br><span class="line"><span class="comment">#block if bad_agent 2.1版本后不再支持，用上面替代</span></span><br><span class="line"></span><br><span class="line">hdr(host) ==www.wang.org:8080</span><br><span class="line">hdr_domain(host) ==&gt; www.wang.org</span><br><span class="line"></span><br><span class="line"><span class="comment">#有些功能是类似的，比如以下几个都是匹配用户请求报文中host的开头是不是www</span></span><br><span class="line">acl short_form hdr_beg(host) www.</span><br><span class="line">acl alternate1 hdr_beg(host) -m beg www.</span><br><span class="line">acl alternate2 hdr_dom(host) -m beg www.</span><br><span class="line">acl alternate3 hdr(host) -m beg www.</span><br><span class="line"></span><br><span class="line">base : string</span><br><span class="line"><span class="comment">#返回第一个主机头和请求的路径部分的连接，该请求从主机名开始，并在问号之前结束，对虚拟主机有用，下面的例子中是两个#中间的内容，实际#是没有的</span></span><br><span class="line">&lt;scheme&gt;://&lt;user&gt;:&lt;password&gt;@&lt;host&gt;:&lt;port&gt;/&lt;path&gt;; &lt;params&gt;<span class="comment">#?&lt;query&gt;#&lt;frag&gt;</span></span><br><span class="line">    base : exact string match</span><br><span class="line">    base_beg : prefix match</span><br><span class="line">    base_dir : subdir match</span><br><span class="line">    base_dom : domain match</span><br><span class="line">    base_end : suffix match</span><br><span class="line">    base_len : length match</span><br><span class="line">    base_reg : regex match</span><br><span class="line">    base_sub : substring match</span><br><span class="line"></span><br><span class="line">path : string</span><br><span class="line"><span class="comment">#提取请求的URL路径，该路径从第一个斜杠开始，并在问号之前结束（无主机部分）</span></span><br><span class="line">&lt;scheme&gt;://&lt;user&gt;:&lt;password&gt;@&lt;host&gt;:&lt;port&gt;/&lt;path&gt;; &lt;params&gt;<span class="comment">#?&lt;query&gt;#&lt;frag&gt;</span></span><br><span class="line">    path : exact string match</span><br><span class="line">    path_beg : prefix match <span class="comment">#请求的URL开头，如/static/, /images/, /img/, /css</span></span><br><span class="line">    path_end : suffix match <span class="comment">#请求的URL中资源的结尾，如 .gif, .png, .css, .js, .jpg, .jpeg</span></span><br><span class="line">    path_dom : domain match</span><br><span class="line">    path_dir : subdir match</span><br><span class="line">    path_len : length match</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">src          <span class="comment">#源IP</span></span><br><span class="line">src_port     <span class="comment">#源PORT</span></span><br><span class="line"></span><br><span class="line">dst          <span class="comment">#目标IP</span></span><br><span class="line">dst_port     <span class="comment">#目标PORT</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#示例:</span></span><br><span class="line">acl invalid_src src 10.0.0.7 192.168.1.0/24</span><br><span class="line">acl invalid_src src 172.16.0.0/24</span><br><span class="line"></span><br><span class="line">acl invalid_port src_port 0:1023</span><br><span class="line"></span><br><span class="line">status : <span class="built_in">integer</span>    <span class="comment">#返回在响应报文中的状态码</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#七层协议</span></span><br><span class="line">acl valid_method method GET HEAD</span><br><span class="line">http-request deny <span class="keyword">if</span> ! valid_method</span><br></pre></td></tr></table></figure>

<h4 id="ACL-flags"><a href="#ACL-flags" class="headerlink" title="ACL-flags"></a>ACL-flags</h4><p>ACL匹配模式</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">-i 不区分大小写</span><br><span class="line">-m 使用指定的pattern匹配方法</span><br><span class="line">-n 不做DNS解析</span><br><span class="line">-u 禁止acl重名，否则多个同名ACL匹配或关联</span><br></pre></td></tr></table></figure>

<h4 id="ACL-operator"><a href="#ACL-operator" class="headerlink" title="ACL-operator"></a>ACL-operator</h4><p>ACL操作符</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">整数比较: eq, ge, gt, le, lt</span><br><span class="line">字符串比较:</span><br><span class="line">exact match       (-m str): 字符串必须完全匹配模式</span><br><span class="line">substring match   (-m sub): 在提取的字符串中查找模式，如果其中任何一个被发现，ACL将匹配</span><br><span class="line">prefix match      (-m beg): 在提取的字符串首部中查找模式，如果其中任何一个被发现，ACL将匹配</span><br><span class="line">suffix match      (-m end): 将模式与提取字符串的尾部进行比较，如果其中任何一个匹配，则ACL进行匹配</span><br><span class="line">subdir match      (-m dir): 查看提取出来的用斜线分隔（“/”）的字符串，如其中任一个匹配，则ACL进行匹配</span><br><span class="line">domain match      (-m dom): 查找提取的用点（“.”）分隔字符串，如果其中任何一个匹配，则ACL进行匹配</span><br></pre></td></tr></table></figure>

<h4 id="ACL-value"><a href="#ACL-value" class="headerlink" title="ACL-value"></a>ACL-value</h4><p>value的类型</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">The ACL engine can match these types against patterns of the following types:</span><br><span class="line"></span><br><span class="line">Boolean                        <span class="comment">#布尔值</span></span><br><span class="line"><span class="built_in">integer</span> or <span class="built_in">integer</span> range       <span class="comment">#整数或整数范围，比如用于匹配端口范围</span></span><br><span class="line">IP address / network           <span class="comment">#IP地址或IP范围，192.168.0.1, 192.168.0.1/24</span></span><br><span class="line">string-&gt; www.wang.com</span><br><span class="line">exact     <span class="comment">#精确比较</span></span><br><span class="line">substring <span class="comment">#子串</span></span><br><span class="line">suffix    <span class="comment">#后缀比较</span></span><br><span class="line">prefix    <span class="comment">#前缀比较</span></span><br><span class="line">subdir    <span class="comment">#路径，/wp-includes/js/jquery/jquery.js</span></span><br><span class="line">domain    <span class="comment">#域名，www.wang.com</span></span><br><span class="line">regular expression   <span class="comment">#正则表达式</span></span><br><span class="line">hex block            <span class="comment">#16进制</span></span><br></pre></td></tr></table></figure>

<h3 id="ACL示例：域名匹配"><a href="#ACL示例：域名匹配" class="headerlink" title="ACL示例：域名匹配"></a>ACL示例：域名匹配</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">[root@centos7 ~]<span class="comment"># cat /etc/haproxy/conf.d/test.cfg</span></span><br><span class="line">frontend wang_http_port</span><br><span class="line">    <span class="built_in">bind</span> 10.0.0.7:80</span><br><span class="line">    mode http</span><br><span class="line">    balance roundrobin</span><br><span class="line">    <span class="built_in">log</span> global</span><br><span class="line">    option httplog</span><br><span class="line"></span><br><span class="line"><span class="comment">###################### acl setting ########################</span></span><br><span class="line">    acl pc_domain hdr_dom(host) -i www.wang.org</span><br><span class="line">    acl mobile_domain hdr_dom(host) -i mobile.wang.org</span><br><span class="line"></span><br><span class="line"><span class="comment">###################### acl hosts ##########################</span></span><br><span class="line">    use_backend pc_hosts <span class="keyword">if</span> pc_domain</span><br><span class="line">    use_backend mobile_hosts <span class="keyword">if</span> mobile_domain</span><br><span class="line">    default_backend pc_hosts <span class="comment">#所有都不匹配，使用默认</span></span><br><span class="line"></span><br><span class="line"><span class="comment">###################### backend hosts #######################</span></span><br><span class="line">backend mobile_hosts</span><br><span class="line">    mode http</span><br><span class="line">    server web1 10.0.0.17 check inter 2000 fall 3 rise 5</span><br><span class="line"></span><br><span class="line">backend pc_hosts</span><br><span class="line">    mode http</span><br><span class="line">    server web2 10.0.0.27:80 check inter 2000 fall 3 rise 5</span><br></pre></td></tr></table></figure>

<p><strong>测试结果</strong></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[root@centos6 ~]<span class="comment"># cat /etc/hosts</span></span><br><span class="line">127.0.0.1   localhost localhost.localdomain localhost4 localhost4.localdomain4 centos6.localdomain</span><br><span class="line">::1         localhost localhost.localdomain localhost6 localhost6.localdomain6</span><br><span class="line">10.0.0.7    mobile.wang.org www.wang.org wang.org</span><br><span class="line"></span><br><span class="line">[root@centos6 ~]<span class="comment"># curl www.wang.org</span></span><br><span class="line">10.0.0.27</span><br><span class="line"></span><br><span class="line">[root@centos6 ~]<span class="comment"># curl mobile.wang.org</span></span><br><span class="line">10.0.0.17</span><br><span class="line"></span><br><span class="line">[root@centos6 ~]<span class="comment"># curl wang.org</span></span><br><span class="line">10.0.0.27</span><br></pre></td></tr></table></figure>

<h3 id="ACL示例：基于源IP或子网调度访问"><a href="#ACL示例：基于源IP或子网调度访问" class="headerlink" title="ACL示例：基于源IP或子网调度访问"></a>ACL示例：基于源IP或子网调度访问</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">[root@centos7 ~]<span class="comment"># cat /etc/haproxy/conf.d/test.cfg</span></span><br><span class="line">frontend wang_http_port</span><br><span class="line">    <span class="built_in">bind</span> 10.0.0.7:80</span><br><span class="line">    mode http</span><br><span class="line">    balance roundrobin</span><br><span class="line">    <span class="built_in">log</span> global</span><br><span class="line">    option httplog</span><br><span class="line"></span><br><span class="line"><span class="comment">########################## acl setting #####################</span></span><br><span class="line">    acl pc_domain hdr_dom(host) -i www.wang.org</span><br><span class="line">    acl mobile_domain hdr_dom(host) -i mobile.wang.org</span><br><span class="line">    acl ip_range_test src 172.18.0.0/16 10.0.0.6  <span class="comment">#基于源地址的ACL，定义多个ACL的顺序无关</span></span><br><span class="line">    acl ip_range_test2 src 172.18.0.200</span><br><span class="line"></span><br><span class="line"><span class="comment">########################## acl hosts #######################</span></span><br><span class="line">    use_backend pc_hosts <span class="keyword">if</span> ip_range_test  <span class="comment">#放在前面的ACL规则优先生效，引用ACL时，严格的ACL应放在前面</span></span><br><span class="line">    use_backend pc_hosts <span class="keyword">if</span> pc_domain</span><br><span class="line">    use_backend mobile_hosts <span class="keyword">if</span> mobile_domain</span><br><span class="line">    default_backend pc_hosts</span><br><span class="line"></span><br><span class="line"><span class="comment">###################### backend hosts #######################</span></span><br><span class="line">backend mobile_hosts</span><br><span class="line">    mode http</span><br><span class="line">    server web1 10.0.0.17 check inter 2000 fall 3 rise 5</span><br><span class="line"></span><br><span class="line">backend pc_hosts</span><br><span class="line">    mode http</span><br><span class="line">    server web2 10.0.0.27:80 check inter 2000 fall 3 rise 5</span><br></pre></td></tr></table></figure>

<p>测试结果</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root@centos6 ~]<span class="comment"># hostname -I</span></span><br><span class="line">10.0.0.6</span><br><span class="line"></span><br><span class="line">[root@centos6 ~]<span class="comment"># curl www.wang.org</span></span><br><span class="line">10.0.0.27</span><br><span class="line"></span><br><span class="line">[root@internet ~]<span class="comment"># curl -H &quot;HOST: www.wang.org&quot; 10.0.0.7</span></span><br><span class="line">10.0.0.27</span><br><span class="line"></span><br><span class="line">[root@centos6 ~]<span class="comment"># curl mobile.wang.org</span></span><br><span class="line">10.0.0.27</span><br></pre></td></tr></table></figure>

<h3 id="ACL示例：基于源地址的访问控制"><a href="#ACL示例：基于源地址的访问控制" class="headerlink" title="ACL示例：基于源地址的访问控制"></a>ACL示例：基于源地址的访问控制</h3><p>拒绝指定IP或者IP范围访问</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">listen web_host</span><br><span class="line">    <span class="built_in">bind</span> 10.0.0.7:80</span><br><span class="line">    mode http</span><br><span class="line">    balance roundrobin</span><br><span class="line">    <span class="built_in">log</span> global</span><br><span class="line">    option httplog</span><br><span class="line"></span><br><span class="line"><span class="comment">########################## acl setting #####################</span></span><br><span class="line">    acl acl_deny_src src 10.0.0.6 192.168.0.0/24</span><br><span class="line"></span><br><span class="line"><span class="comment">########################## acl hosts #######################</span></span><br><span class="line">    http-request deny <span class="keyword">if</span> acl_deny_src  <span class="comment">#2.1版本后，不再支持block</span></span><br><span class="line">    <span class="comment">#block if acl_deny_src</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">#http-request allow</span></span><br><span class="line">    default_backend default_web</span><br><span class="line"></span><br><span class="line"><span class="comment">###################### backend hosts #######################</span></span><br><span class="line">backend wang_host</span><br><span class="line">    mode http</span><br><span class="line">    server web1 10.0.0.17 check inter 2000 fall 3 rise 5</span><br><span class="line"></span><br><span class="line">backend default_web</span><br><span class="line">    mode http</span><br><span class="line">    server web1 10.0.0.27:80 check inter 2000 fall 3 rise 5</span><br></pre></td></tr></table></figure>

<h3 id="ACL示例：匹配浏览器类型"><a href="#ACL示例：匹配浏览器类型" class="headerlink" title="ACL示例：匹配浏览器类型"></a>ACL示例：匹配浏览器类型</h3><p>匹配客户端浏览器，将不同类型的浏览器调度至不同的服务器组</p>
<p>范例: 163 网易拒绝curl和wget的访问</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">[root@ubuntu2004 ~]<span class="comment"># curl -I www.163.com</span></span><br><span class="line">HTTP/1.1 403 Forbidden</span><br><span class="line">Date: Fri, 01 Jan 2021 06:57:22 GMT</span><br><span class="line">Content-Type: text/html</span><br><span class="line">Content-Length: 237</span><br><span class="line">Connection: keep-alive</span><br><span class="line">Server: web cache</span><br><span class="line">Expires: Fri, 01 Jan 2021 06:57:22 GMT</span><br><span class="line">X-Ser: BC17_lt-shandong-zaozhuang-6-cache-1</span><br><span class="line">Cache-Control: no-cache,no-store,private</span><br><span class="line">cdn-user-ip: 111.199.184.218</span><br><span class="line">cdn-ip: 124.132.138.17</span><br><span class="line">X-Cache-Remote: HIT</span><br><span class="line">cdn-source: baishan</span><br><span class="line"></span><br><span class="line">[root@ubuntu2004 ~]<span class="comment"># curl -I -A &quot;wget&quot; www.163.com</span></span><br><span class="line">HTTP/1.1 403 Forbidden</span><br><span class="line">Date: Fri, 01 Jan 2021 06:58:13 GMT</span><br><span class="line">Content-Type: text/html</span><br><span class="line">Content-Length: 237</span><br><span class="line">Connection: keep-alive</span><br><span class="line">Server: web cache</span><br><span class="line">Expires: Fri, 01 Jan 2021 06:58:13 GMT</span><br><span class="line">X-Ser: BC17_lt-shandong-zaozhuang-6-cache-1</span><br><span class="line">Cache-Control: no-cache,no-store,private</span><br><span class="line">cdn-user-ip: 111.199.184.218</span><br><span class="line">cdn-ip: 124.132.138.17</span><br><span class="line">X-Cache-Remote: HIT</span><br><span class="line">cdn-source: baishan</span><br><span class="line"></span><br><span class="line"><span class="comment">#不拒绝其它浏览器的访问</span></span><br><span class="line">[root@ubuntu2004 ~]<span class="comment"># curl -I -A &quot;ApacheBench&quot; www.163.com</span></span><br><span class="line">HTTP/1.1 301 Moved Permanently</span><br><span class="line">Date: Fri, 01 Jan 2021 06:58:41 GMT</span><br><span class="line">Content-Length: 0</span><br><span class="line">Location: https://www.163.com/</span><br><span class="line">Cache-Control: no-cache,no-store,private</span><br><span class="line">cdn-user-ip: 111.199.184.218</span><br><span class="line">cdn-ip: 124.132.138.17</span><br><span class="line">X-Cache-Remote: HIT</span><br><span class="line">cdn-source: baishan</span><br></pre></td></tr></table></figure>

<p>范例：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">[root@centos7 ~]<span class="comment"># cat /etc/haproxy/conf.d/test.cfg</span></span><br><span class="line">frontend wang_http_port</span><br><span class="line">    <span class="built_in">bind</span> 10.0.0.7:80</span><br><span class="line">    mode http</span><br><span class="line">    balance roundrobin</span><br><span class="line">    <span class="built_in">log</span> global</span><br><span class="line">    option httplog</span><br><span class="line"></span><br><span class="line"><span class="comment">########################## acl setting #####################</span></span><br><span class="line">    acl acl_user_agent hdr_sub(User-Agent) -i curl wget  <span class="comment">#基于浏览器的ACL</span></span><br><span class="line">    acl acl_user_agent_ab hdr_sub(User-Agent) -i ApacheBench</span><br><span class="line"></span><br><span class="line"><span class="comment">########################## acl hosts #######################</span></span><br><span class="line">    redirect prefix http://www.baidu.com <span class="keyword">if</span> acl_user_agent  <span class="comment">#302 临时重定向至新URL</span></span><br><span class="line">    http-request deny <span class="keyword">if</span> acl_user_agent_ab  <span class="comment">#拒绝ab</span></span><br><span class="line"></span><br><span class="line">    default_backend pc_hosts</span><br><span class="line"></span><br><span class="line"><span class="comment">###################### backend hosts #######################</span></span><br><span class="line">backend mobile_hosts</span><br><span class="line">    mode http</span><br><span class="line">    server web1 10.0.0.17 check inter 2000 fall 3 rise 5</span><br><span class="line"></span><br><span class="line">backend pc_hosts</span><br><span class="line">    mode http</span><br><span class="line">    server web2 10.0.0.27:80 check inter 2000 fall 3 rise 5</span><br></pre></td></tr></table></figure>

<h3 id="ACL示例：基于文件后缀名实现动静分离"><a href="#ACL示例：基于文件后缀名实现动静分离" class="headerlink" title="ACL示例：基于文件后缀名实现动静分离"></a>ACL示例：基于文件后缀名实现动静分离</h3><p><strong>配置文件内容</strong></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">[root@centos7 ~]<span class="comment"># cat /etc/haproxy/conf.d/test.cfg</span></span><br><span class="line">frontend wang_http_port</span><br><span class="line">    <span class="built_in">bind</span> 10.0.0.7:80</span><br><span class="line">    mode http</span><br><span class="line">    balance roundrobin</span><br><span class="line">    <span class="built_in">log</span> global</span><br><span class="line">    option httplog</span><br><span class="line">    </span><br><span class="line"><span class="comment">########################## acl setting #####################</span></span><br><span class="line">    acl acl_static path_end -i .jpg .jpeg .png .gif .css .js .html  <span class="comment">#基于文件后缀名的ACL</span></span><br><span class="line">    acl acl_php path_end -i .php</span><br><span class="line"></span><br><span class="line"><span class="comment">########################## acl hosts #######################</span></span><br><span class="line">    use_backend mobile_hosts <span class="keyword">if</span> acl_static</span><br><span class="line">    use_backend app_hosts <span class="keyword">if</span> acl_php</span><br><span class="line">    default_backend pc_hosts</span><br><span class="line"></span><br><span class="line"><span class="comment">###################### backend hosts #######################</span></span><br><span class="line">backend mobile_hosts</span><br><span class="line">    mode http</span><br><span class="line">    server web1 10.0.0.17 check inter 2000 fall 3 rise 5</span><br><span class="line"></span><br><span class="line">backend pc_hosts</span><br><span class="line">    mode http</span><br><span class="line">    server web2 10.0.0.27:80 check inter 2000 fall 3 rise 5</span><br><span class="line"></span><br><span class="line">backend app_hosts</span><br><span class="line">    mode http</span><br><span class="line">    server web2 10.0.0.27:80 check inter 2000 fall 3 rise 5</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 分别在后端两台主机准备相关文件</span></span><br><span class="line">[root@centos17 ~]<span class="comment"># ls /var/www/html</span></span><br><span class="line">index.html  wang.jpg</span><br><span class="line"></span><br><span class="line">[root@centos27 ~]<span class="comment"># cat /var/www/html/test.php</span></span><br><span class="line">&lt;?php</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;&lt;h1&gt;http://10.0.0.27/test.php&lt;/h1&gt;\n&quot;</span>;</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>

<h3 id="ACL示例：匹配访问路径实现动静分离"><a href="#ACL示例：匹配访问路径实现动静分离" class="headerlink" title="ACL示例：匹配访问路径实现动静分离"></a>ACL示例：匹配访问路径实现动静分离</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">[root@centos7 ~]<span class="comment"># cat /etc/haproxy/conf.d/test.cfg</span></span><br><span class="line">frontend wang_http_port</span><br><span class="line">    <span class="built_in">bind</span> 10.0.0.7:80</span><br><span class="line">    mode http</span><br><span class="line">    balance roundrobin</span><br><span class="line">    <span class="built_in">log</span> global</span><br><span class="line">    option httplog</span><br><span class="line"></span><br><span class="line">    acl acl_static path_beg -i /static /images /javascript  <span class="comment">#基于路径的ACL</span></span><br><span class="line">    acl acl_static path_end -i .jpg .jpeg .png .gif .css .js .html .htm  <span class="comment">#ACL同名为或关系</span></span><br><span class="line">    acl acl_app path_beg -i /api</span><br><span class="line"></span><br><span class="line">    use_backend static_hosts <span class="keyword">if</span> acl_static</span><br><span class="line">    use_backend app_hosts <span class="keyword">if</span> acl_app</span><br><span class="line">    default_backend app_hosts</span><br><span class="line"></span><br><span class="line">backend static_hosts</span><br><span class="line">    mode http</span><br><span class="line">    server web1 10.0.0.17 check inter 2000 fall 3 rise 5</span><br><span class="line"></span><br><span class="line">backend app_hosts</span><br><span class="line">    mode http</span><br><span class="line">    server web2 10.0.0.27:80 check inter 2000 fall 3 rise 5</span><br><span class="line"></span><br><span class="line"><span class="comment">#创建相关文件</span></span><br><span class="line">[root@centos17 ~]<span class="comment"># mkdir /var/www/html/static</span></span><br><span class="line">[root@centos17 ~]<span class="comment"># echo 10.0.0.17 &gt; /var/www/html/static/test.html</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#测试访问</span></span><br><span class="line">[root@centos6 ~]<span class="comment"># curl 10.0.0.7/static/test.html</span></span><br><span class="line">10.0.0.17</span><br></pre></td></tr></table></figure>

<h3 id="ACL示例：预定义ACL使用"><a href="#ACL示例：预定义ACL使用" class="headerlink" title="ACL示例：预定义ACL使用"></a>ACL示例：预定义ACL使用</h3><p>官方帮助文档：<a target="_blank" rel="noopener" href="http://cbonte.github.io/haproxy-dconv/2.1/configuration.html#7.4">http://cbonte.github.io/haproxy-dconv/2.1/configuration.html#7.4</a></p>
<h4 id="预定义ACL"><a href="#预定义ACL" class="headerlink" title="预定义ACL"></a>预定义ACL</h4><table>
<thead>
<tr>
<th align="left">ACL name</th>
<th align="left">Equivalent to</th>
<th align="left">Usage</th>
</tr>
</thead>
<tbody><tr>
<td align="left">FALSE</td>
<td align="left">always_false</td>
<td align="left">never match</td>
</tr>
<tr>
<td align="left">HTTP</td>
<td align="left">req_proto_http</td>
<td align="left">match if protocol is valid HTTP</td>
</tr>
<tr>
<td align="left">HTTP_1.0</td>
<td align="left">req_ver 1.0</td>
<td align="left">match HTTP version 1.0</td>
</tr>
<tr>
<td align="left">HTTP_1.1</td>
<td align="left">req_ver 1.1</td>
<td align="left">match HTTP version 1.1</td>
</tr>
<tr>
<td align="left">HTTP_CONTENT</td>
<td align="left">hdr_val(content-length) gt 0</td>
<td align="left">match an existing content-length</td>
</tr>
<tr>
<td align="left">HTTP_URL_ABS</td>
<td align="left">url_reg ^[^/:]*://</td>
<td align="left">match absolute URL with scheme</td>
</tr>
<tr>
<td align="left">HTTP_URL_SLASH</td>
<td align="left">url_beg /</td>
<td align="left">match URL beginning with “/“</td>
</tr>
<tr>
<td align="left">HTTP_URL_STAR</td>
<td align="left">url *</td>
<td align="left">match URL equal to “*”</td>
</tr>
<tr>
<td align="left">LOCALHOST</td>
<td align="left">src 127.0.0.1/8</td>
<td align="left">match connection from local host</td>
</tr>
<tr>
<td align="left">METH_CONNECT</td>
<td align="left">method CONNECT</td>
<td align="left">match HTTP CONNECT method</td>
</tr>
<tr>
<td align="left">METH_DELETE</td>
<td align="left">method DELETE</td>
<td align="left">match HTTP DELETE method</td>
</tr>
<tr>
<td align="left">METH_GET</td>
<td align="left">method GET HEAD</td>
<td align="left">match HTTP GET or HEAD method</td>
</tr>
<tr>
<td align="left">METH_HEAD</td>
<td align="left">method HEAD</td>
<td align="left">match HTTP HEAD method</td>
</tr>
<tr>
<td align="left">METH_OPTIONS</td>
<td align="left">method OPTIONS</td>
<td align="left">match HTTP OPTIONS method</td>
</tr>
<tr>
<td align="left">METH_POST</td>
<td align="left">method POST</td>
<td align="left">match HTTP POST method</td>
</tr>
<tr>
<td align="left">METH_PUT</td>
<td align="left">method PUT</td>
<td align="left">match HTTP PUT method</td>
</tr>
<tr>
<td align="left">METH_TRACE</td>
<td align="left">method TRACE</td>
<td align="left">match HTTP TRACE method</td>
</tr>
<tr>
<td align="left">RDP_COOKIE</td>
<td align="left">req_rdp_cookie_cnt gt 0</td>
<td align="left">match presence of an RDP cookie</td>
</tr>
<tr>
<td align="left">REQ_CONTENT</td>
<td align="left">req_len gt 0</td>
<td align="left">match data in the request buffer</td>
</tr>
<tr>
<td align="left">TRUE</td>
<td align="left">always_true</td>
<td align="left">always match</td>
</tr>
<tr>
<td align="left">WAIT_END</td>
<td align="left">wait_end</td>
<td align="left">wait for end of content analysis</td>
</tr>
</tbody></table>
<h4 id="预定义ACL使用"><a href="#预定义ACL使用" class="headerlink" title="预定义ACL使用"></a>预定义ACL使用</h4><p>范例：禁止TRACE方法和HTTP/1.1协议</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line">[root@centos6 ~]<span class="comment"># curl -I -XTRACE 10.0.0.7/static/test.html</span></span><br><span class="line">HTTP/1.1 200 OK</span><br><span class="line"><span class="built_in">date</span>: Sat, 04 Apr 2020 02:04:01 GMT</span><br><span class="line">server: Apache/2.4.6 (CentOS) PHP/5.4.16</span><br><span class="line">transfer-encoding: chunked</span><br><span class="line">content-type: message/http</span><br><span class="line"></span><br><span class="line">[root@centos7 ~]<span class="comment"># cat /etc/haproxy/conf.d/test.cfg</span></span><br><span class="line">frontend wang_http_port</span><br><span class="line">    <span class="built_in">bind</span> 10.0.0.7:80</span><br><span class="line">    mode http</span><br><span class="line">    balance roundrobin</span><br><span class="line">    <span class="built_in">log</span> global</span><br><span class="line">    option httplog</span><br><span class="line"></span><br><span class="line">    acl acl_static_path path_beg -i /static /images /javascript  <span class="comment">#基于路径的ACL</span></span><br><span class="line"></span><br><span class="line">    use_backend static_path_hosts <span class="keyword">if</span> acl_static_path</span><br><span class="line">    http-request deny <span class="keyword">if</span> METH_TRACE HTTP_1.1  <span class="comment">#引用预定义的ACL，多个ACL默认为与关系</span></span><br><span class="line">    default_backend pc_hosts</span><br><span class="line"></span><br><span class="line">backend static_path_hosts</span><br><span class="line">    mode http</span><br><span class="line">    server web1 10.0.0.17 check inter 2000 fall 3 rise 5</span><br><span class="line"></span><br><span class="line">backend mobile_hosts</span><br><span class="line">    mode http</span><br><span class="line">    server web1 10.0.0.17 check inter 2000 fall 3 rise 5</span><br><span class="line"></span><br><span class="line">backend pc_hosts</span><br><span class="line">    mode http</span><br><span class="line">    server web2 10.0.0.27:80 check inter 2000 fall 3 rise</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@centos6 ~]<span class="comment"># curl -I -XTRACE 10.0.0.7/static/test.html</span></span><br><span class="line">HTTP/1.1 403 Forbidden</span><br><span class="line">content-length: 93</span><br><span class="line">cache-control: no-cache</span><br><span class="line">content-type: text/html</span><br><span class="line">connection: close</span><br><span class="line"></span><br><span class="line">[root@centos6 ~]<span class="comment"># curl -I -O -XTRACE 10.0.0.7/static/test.html</span></span><br><span class="line">HTTP/1.1 200 OK</span><br><span class="line"><span class="built_in">date</span>: Sat, 04 Apr 2020 02:10:13 GMT</span><br><span class="line">server: Apache/2.4.6 (CentOS) PHP/5.4.16</span><br><span class="line">content-type: message/http</span><br><span class="line">connection: close</span><br><span class="line"></span><br><span class="line"><span class="comment">#查看日志，观察协议版本</span></span><br><span class="line">[root@centos17 ~]<span class="comment"># tail /var/log/httpd/access_log</span></span><br><span class="line">10.0.0.7 - - [04/Apr/2020:10:11:41 +0800] <span class="string">&quot;TRACE /static/test.html HTTP/1.0&quot;</span> 200 230 <span class="string">&quot;-&quot;</span> <span class="string">&quot;curl/7.19.7 (x86_64-redhat-linux-gnu) libcurl/7.19.7 NSS/3.27.1 zlib/1.2.3 libidn/1.18 libssh2/1.4.2&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@centos6 ~]<span class="comment"># curl -i 10.0.0.7/static/test.html</span></span><br><span class="line">HTTP/1.1 200 OK</span><br><span class="line"><span class="built_in">date</span>: Sat, 04 Apr 2020 02:07:58 GMT</span><br><span class="line">server: Apache/2.4.6 (CentOS) PHP/5.4.16</span><br><span class="line">last-modified: Sat, 04 Apr 2020 01:27:45 GMT</span><br><span class="line">etag: <span class="string">&quot;a-5a26cf0ed4913&quot;</span></span><br><span class="line">accept-ranges: bytes</span><br><span class="line">content-length: 10</span><br><span class="line">content-type: text/html; charset=UTF-8</span><br><span class="line">10.0.0.17</span><br></pre></td></tr></table></figure>

<h2 id="自定义HAProxy错误界面"><a href="#自定义HAProxy错误界面" class="headerlink" title="自定义HAProxy错误界面"></a>自定义HAProxy错误界面</h2><p>对指定错误进行重定向，进行优雅的显示错误页面</p>
<p>使用errofile和errorloc指令的两种方法，可以实现自定义各种错误页面</p>
<h3 id="基于自定义的错误页面文件"><a href="#基于自定义的错误页面文件" class="headerlink" title="基于自定义的错误页面文件"></a>基于自定义的错误页面文件</h3><h3 id="自定义错误页"><a href="#自定义错误页" class="headerlink" title="自定义错误页"></a>自定义错误页</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">errorfile &lt;code&gt; &lt;file&gt;</span><br><span class="line">&lt;code&gt; <span class="comment">#HTTP status code. 支持200, 400, 403, 405, 408, 425, 429, 500, 502, 503, 504</span></span><br><span class="line">&lt;file&gt; <span class="comment">#包含完整HTTP响应头的错误页文件的绝对路径。建议后缀为&quot;.http&quot;，以和一般的html文件相区分</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#示例</span></span><br><span class="line">errorfile 400 /etc/haproxy/errorfiles/400badreq.http</span><br><span class="line">errorfile 403 /etc/haproxy/errorfiles/403forbid.http</span><br><span class="line">errorfile 503 /etc/haproxy/errorfiles/503sorry.http</span><br></pre></td></tr></table></figure>

<p><strong>范例</strong></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">defaults</span><br><span class="line"><span class="comment">#option forwardfor</span></span><br><span class="line"><span class="comment">#no option http-use-htx   支持html文件,此设置和版本有关，2.1不支持</span></span><br><span class="line"><span class="comment">#......</span></span><br><span class="line"><span class="comment">#加下面行</span></span><br><span class="line"></span><br><span class="line">errorfile 500 /usr/local/haproxy/html/500.http</span><br><span class="line">errorfile 502 /usr/local/haproxy/html/502.http</span><br><span class="line">errorfile 503 /usr/local/haproxy/html/503.http</span><br></pre></td></tr></table></figure>

<p><strong>范例</strong></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">[root@centos7 ~]<span class="comment"># vim /etc/haproxy/haproxy.cfg</span></span><br><span class="line">defaults</span><br><span class="line">option http-keep-alive</span><br><span class="line">option forwardfor</span><br><span class="line">maxconn 100000</span><br><span class="line">mode http</span><br><span class="line"><span class="built_in">timeout</span> connect 300000ms</span><br><span class="line"><span class="built_in">timeout</span> client 300000ms</span><br><span class="line"><span class="built_in">timeout</span> server 300000ms</span><br><span class="line">errorfile 503 /apps/haproxy/html/503.http</span><br><span class="line">listen</span><br><span class="line">......</span><br><span class="line"></span><br><span class="line">[root@centos7 ~]<span class="comment"># vim /apps/haproxy/html/503.http</span></span><br><span class="line">HTTP/1.1 503 Service Unavailable</span><br><span class="line">Content-Type:text/html;charset=utf-8</span><br><span class="line"></span><br><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html lang=<span class="string">&quot;en&quot;</span>&gt;</span><br><span class="line">&lt;<span class="built_in">head</span>&gt;</span><br><span class="line">&lt;meta charset=<span class="string">&quot;UTF-8&quot;</span>&gt;</span><br><span class="line">&lt;title&gt;报错页面&lt;/title&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">&lt;center&gt;&lt;h1&gt;网站维护中……请稍候再试&lt;/h1&gt;&lt;/center&gt;</span><br><span class="line">&lt;center&gt;&lt;h2&gt;联系电话：400-123-4567&lt;/h2&gt;&lt;/center&gt;</span><br><span class="line">&lt;center&gt;&lt;h3&gt;503 Service Unavailable&lt;/h3&gt;&lt;/center&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br><span class="line"></span><br><span class="line">[root@centos7 ~]<span class="comment"># systemctl restart haproxy</span></span><br></pre></td></tr></table></figure>

<p>启用 <code>no option http-use-htx</code> 示例</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">[root@haproxy ~]<span class="comment"># vi /etc/haproxy/haproxy.cfg</span></span><br><span class="line">defaults</span><br><span class="line">    option http-keep-alive</span><br><span class="line">    no option http-use-htx  <span class="comment"># 在 defaults 块中添加</span></span><br><span class="line">    errorfile 503 /apps/haproxy/errorfiles/503.html</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">[root@haproxy ~]<span class="comment"># cat /apps/haproxy/errorfiles/503.html</span></span><br><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html lang=<span class="string">&quot;en&quot;</span>&gt;</span><br><span class="line">&lt;<span class="built_in">head</span>&gt;</span><br><span class="line">&lt;meta charset=<span class="string">&quot;UTF-8&quot;</span>&gt;</span><br><span class="line">&lt;title&gt;报错页面&lt;/title&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">&lt;center&gt;&lt;h1&gt;网站维护中……请稍候再试&lt;/h1&gt;&lt;/center&gt;</span><br><span class="line">&lt;center&gt;&lt;h2&gt;联系电话：400-123-8888&lt;/h2&gt;&lt;/center&gt;</span><br><span class="line">&lt;center&gt;&lt;h3&gt;503 Service Unavailable&lt;/h3&gt;&lt;/center&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment">#注意没有响应头信息</span></span><br><span class="line">[root@internet ~]<span class="comment"># curl -I 172.16.0.100</span></span><br><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html lang=<span class="string">&quot;en&quot;</span>&gt;</span><br><span class="line">&lt;<span class="built_in">head</span>&gt;</span><br><span class="line">&lt;meta charset=<span class="string">&quot;UTF-8&quot;</span>&gt;</span><br><span class="line">&lt;title&gt;报错页面&lt;/title&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">&lt;center&gt;&lt;h1&gt;网站维护中……请稍候再试&lt;/h1&gt;&lt;/center&gt;</span><br><span class="line">&lt;center&gt;&lt;h2&gt;联系电话：400-123-8888&lt;/h2&gt;&lt;/center&gt;</span><br><span class="line">&lt;center&gt;&lt;h3&gt;503 Service Unavailable&lt;/h3&gt;&lt;/center&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment">#Ubuntu 客户端提示错误</span></span><br><span class="line">root@ubuntu2004:~<span class="comment"># curl 172.16.0.100</span></span><br><span class="line">curl: (1) Received HTTP/0.9 when not allowed</span><br></pre></td></tr></table></figure>

<h3 id="基于-HTTP-重定向错误页面"><a href="#基于-HTTP-重定向错误页面" class="headerlink" title="基于 HTTP 重定向错误页面"></a>基于 HTTP 重定向错误页面</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#错误页面重定向</span></span><br><span class="line">errorloc &lt;code&gt; &lt;url&gt;</span><br><span class="line"><span class="comment">#相当于 errorloc302 &lt;code&gt; &lt;url&gt;, 利用302重定向至指URL</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#示例</span></span><br><span class="line">errorloc 503 http://www.wang.com/error_pages/503.html</span><br><span class="line">errorloc 503 http://www.wang.com/</span><br></pre></td></tr></table></figure>

<p><strong>范例</strong></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">[root@centos7 ~]<span class="comment"># vim /etc/haproxy/haproxy.cfg</span></span><br><span class="line">defaults</span><br><span class="line">    option http-keep-alive</span><br><span class="line">    option forwardfor</span><br><span class="line">    <span class="comment">#no option http-use-htx</span></span><br><span class="line">    <span class="comment">#...... 加以下一行</span></span><br><span class="line">    <span class="comment">#errorfile 503 /apps/haproxy/html/503.http</span></span><br><span class="line">    errorloc 503 http://10.0.0.8/error_page/503.html</span><br><span class="line"></span><br><span class="line">[root@haproxy ~]<span class="comment"># cat /apps/haproxy/errorfiles/503.html</span></span><br><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html lang=<span class="string">&quot;en&quot;</span>&gt;</span><br><span class="line">&lt;<span class="built_in">head</span>&gt;</span><br><span class="line">&lt;meta charset=<span class="string">&quot;UTF-8&quot;</span>&gt;</span><br><span class="line">&lt;title&gt;报错页面&lt;/title&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">&lt;center&gt;&lt;h1&gt;网站维护中……请稍候再试&lt;/h1&gt;&lt;/center&gt;</span><br><span class="line">&lt;center&gt;&lt;h2&gt;联系电话：400-123-8888&lt;/h2&gt;&lt;/center&gt;</span><br><span class="line">&lt;center&gt;&lt;h3&gt;503 Service Unavailable&lt;/h3&gt;&lt;/center&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment">#浏览器访问http://haproxy/ 302子自动跳转</span></span><br></pre></td></tr></table></figure>

<h2 id="HAProxy-四层负载"><a href="#HAProxy-四层负载" class="headerlink" title="HAProxy 四层负载"></a>HAProxy 四层负载</h2><p><strong>针对除 HTTP 以外的 TCP 协议应用服务访问的应用场景</strong></p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">MySQL</span><br><span class="line">Redis</span><br><span class="line">Memcached</span><br><span class="line">RabbitMQ</span><br></pre></td></tr></table></figure>

<p>问题: 后端服务器到底是与 haproxy 还是和客户端建立三次握手呢？</p>
<h3 id="四层负载示例"><a href="#四层负载示例" class="headerlink" title="四层负载示例"></a>四层负载示例</h3><p><strong>注意</strong>: 如果使用 frontend 和 backend，一定在 frontend 和 backend 段中都指定 mode tcp。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">listen redis-port</span><br><span class="line">    <span class="built_in">bind</span> 10.0.0.7:6379</span><br><span class="line">    mode tcp</span><br><span class="line">    balance leastconn</span><br><span class="line">    server server1 10.0.0.17:6379 check</span><br><span class="line">    server server2 10.0.0.27:6379 check backup</span><br></pre></td></tr></table></figure>

<p>范例：对 MySQL 服务实现四层负载</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">[root@centos7 ~]<span class="comment"># vim /etc/haproxy/haproxy.cfg</span></span><br><span class="line">listen wang_mysql</span><br><span class="line">    <span class="built_in">bind</span> 10.0.0.7:3306</span><br><span class="line">    mode tcp</span><br><span class="line">    balance leastconn</span><br><span class="line">    server mysql1 10.0.0.17:3306 check</span><br><span class="line">    server mysql2 10.0.0.27:3306 check    <span class="comment"># 如果不写端口号，可以转发，但无法check状态</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#或者使用 frontend 和 backend 实现</span></span><br><span class="line">frontend mysql</span><br><span class="line">    <span class="built_in">bind</span> :3306</span><br><span class="line">    mode tcp        <span class="comment"># 必须指定tcp</span></span><br><span class="line">    default_backend mysqlsrvs</span><br><span class="line"></span><br><span class="line">backend mysqlsrvs</span><br><span class="line">    mode tcp       <span class="comment"># 必须指定tcp</span></span><br><span class="line">    balance leastconn</span><br><span class="line">    server mysql1 10.0.0.17:3306 check</span><br><span class="line">    server mysql2 10.0.0.27:3306 check</span><br><span class="line">    </span><br><span class="line">[root@centos7 ~]<span class="comment"># systemctl restart haproxy</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#在后端服务器安装和配置 MariaDB 服务</span></span><br><span class="line">[root@centos7 ~]<span class="comment"># yum -y install mariadb-server</span></span><br><span class="line">[root@centos7 ~]<span class="comment"># mysql -e &quot;grant all on *.* to test@&#x27;10.0.0.%&#x27; identified by &#x27;123456&#x27;&quot;</span></span><br><span class="line">[root@centos7 ~]<span class="comment"># vim /etc/my.cnf</span></span><br><span class="line">[mysqld]</span><br><span class="line">server-id=17  <span class="comment"># 在另一台主机为27</span></span><br><span class="line"></span><br><span class="line">[root@centos7 ~]<span class="comment"># systemctl start mariadb</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#测试</span></span><br><span class="line">[root@centos6 ~]<span class="comment"># mysql -utest -p123456 -e &quot;show variables like &#x27;hostname&#x27;&quot;</span></span><br><span class="line">+-----------------+--------------------------------------+</span><br><span class="line">| Variable_name   | Value                                |</span><br><span class="line">+-----------------+--------------------------------------+</span><br><span class="line">| hostname        | centos17.wangxiaochu.com             |</span><br><span class="line">+-----------------+--------------------------------------+</span><br><span class="line"></span><br><span class="line">[root@centos6 ~]<span class="comment"># mysql -utest -p123456 -e &quot;show variables like &#x27;hostname&#x27;&quot;</span></span><br><span class="line">+-----------------+--------------------------------------+</span><br><span class="line">| Variable_name   | Value                                |</span><br><span class="line">+-----------------+--------------------------------------+</span><br><span class="line">| hostname        | centos27.wangxiaochu.com             |</span><br><span class="line">+-----------------+--------------------------------------+</span><br><span class="line"></span><br><span class="line">[root@centos6 ~]<span class="comment"># mysql -utest -p123456 -h10.0.0.7 -e &#x27;select @@server_id&#x27;</span></span><br><span class="line">+-------------+</span><br><span class="line">| @@server_id |</span><br><span class="line">+-------------+</span><br></pre></td></tr></table></figure>

<h2 id="HAProxy-HTTPS-实现"><a href="#HAProxy-HTTPS-实现" class="headerlink" title="HAProxy HTTPS 实现"></a>HAProxy HTTPS 实现</h2><p>HAProxy 支持 HTTPS。基于性能考虑，证书通常在后端服务器（如 Nginx）上实现，即用户到 HAProxy 使用 TCP 模式再到后端服务器。</p>
<p>范例: 基于 TCP 模式实现</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">listen web_http</span><br><span class="line">    <span class="built_in">bind</span> 192.168.10.100:80</span><br><span class="line">    redirect scheme https <span class="keyword">if</span> !&#123; ssl_fc &#125;</span><br><span class="line">    mode http</span><br><span class="line">    <span class="built_in">log</span> global</span><br><span class="line">    server web1 10.0.0.8:80 check</span><br><span class="line">    server web2 10.0.0.18:80 check</span><br><span class="line"></span><br><span class="line">listen web_https</span><br><span class="line">    <span class="built_in">bind</span> 192.168.10.100:443</span><br><span class="line">    mode tcp</span><br><span class="line">    <span class="built_in">log</span> global</span><br><span class="line">    server web1 10.0.0.8:443 check</span><br><span class="line">    server web2 10.0.0.18:443 check</span><br></pre></td></tr></table></figure>

<p>HAProxy 可以实现 HTTPS 的证书安全。即从用户到 HAProxy 为 HTTPS，从 HAProxy 到后端服务器用 HTTP 通信。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 配置 HAProxy 支持 HTTPS 协议，支持 SSL 会话</span></span><br><span class="line"><span class="built_in">bind</span> *:443 ssl crt /PATH/TO/SOME_PEM_FILE</span><br><span class="line"></span><br><span class="line"><span class="comment"># 指令 `crt` 后证书文件为 PEM 格式，需要同时包含证书和所有私钥</span></span><br><span class="line"><span class="built_in">cat</span> demo.key demo.crt &gt; demo.pem</span><br><span class="line"></span><br><span class="line"><span class="comment"># 把 80 端口的请求利用 302 重定向到 443</span></span><br><span class="line"><span class="built_in">bind</span> *:80</span><br><span class="line">redirect scheme https <span class="keyword">if</span> !&#123; ssl_fc &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 向后端传递用户请求的协议和端口 (frontend 或 backend)</span></span><br><span class="line">http_request set-header X-Forwarded-Port %[dst_port]</span><br><span class="line">http_request add-header X-Forwarded-Proto https <span class="keyword">if</span> &#123; ssl_fc &#125;</span><br></pre></td></tr></table></figure>

<h3 id="证书制作"><a href="#证书制作" class="headerlink" title="证书制作"></a>证书制作</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#方法1</span></span><br><span class="line">[root@centos7 ~]<span class="comment"># mkdir /etc/haproxy/certs/</span></span><br><span class="line">[root@centos7 ~]<span class="comment"># cd /etc/haproxy/certs/</span></span><br><span class="line">[root@centos7 certs]<span class="comment"># openssl genrsa -out haproxy.key 2048</span></span><br><span class="line">[root@centos7 certs]<span class="comment"># openssl req -new -x509 -key haproxy.key -out haproxy.crt -subj &quot;/CN=www.wang.org&quot; -days 365</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#或者用下一条命令实现：</span></span><br><span class="line">[root@centos7 certs]<span class="comment"># openssl req -x509 -newkey rsa:2048 -nodes -days 365 -out haproxy.pem -subj &quot;/CN=www.wang.org&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#方法2</span></span><br><span class="line">[root@centos7 ~]<span class="comment"># mkdir /etc/haproxy/certs/</span></span><br><span class="line">[root@centos7 ~]<span class="comment"># cd /etc/pki/tls/certs</span></span><br><span class="line">[root@centos7 certs]<span class="comment"># make /etc/haproxy/certs/haproxy.pem</span></span><br><span class="line"><span class="built_in">umask</span> 77 ; \</span><br><span class="line">PEM1=<span class="string">&#x27;/bin/mktemp /tmp/openssl.XXXXXX&#x27;</span> ; \</span><br><span class="line">PEM2=<span class="string">&#x27;/bin/mktemp /tmp/openssl.XXXXXX&#x27;</span> ; \</span><br><span class="line">/usr/bin/openssl req -utf8 -newkey rsa:2048 -keyout <span class="variable">$PEM1</span> -nodes -x509 -days 365 -out <span class="variable">$PEM2</span> ; \</span><br><span class="line"><span class="built_in">cat</span> <span class="variable">$PEM1</span> &gt; /etc/haproxy/certs/haproxy.pem ; \</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;&quot;</span> &gt;&gt; /etc/haproxy/certs/haproxy.pem ; \</span><br><span class="line"><span class="built_in">cat</span> <span class="variable">$PEM2</span> &gt;&gt; /etc/haproxy/certs/haproxy.pem ; \</span><br><span class="line"><span class="built_in">rm</span> -f <span class="variable">$PEM1</span> <span class="variable">$PEM2</span></span><br><span class="line"></span><br><span class="line">[root@centos7 certs]<span class="comment"># ls /etc/haproxy/certs/</span></span><br><span class="line">haproxy.pem</span><br></pre></td></tr></table></figure>

<h3 id="HTTPS-配置示例"><a href="#HTTPS-配置示例" class="headerlink" title="HTTPS 配置示例"></a>HTTPS 配置示例</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">[root@centos7 ~]<span class="comment"># cat /etc/haproxy/conf.d/test.cfg</span></span><br><span class="line">frontend wang_http_port</span><br><span class="line">    <span class="built_in">bind</span> 10.0.0.7:80</span><br><span class="line"></span><br><span class="line"><span class="comment">############## https setting #################</span></span><br><span class="line"><span class="built_in">bind</span> 10.0.0.7:443 ssl crt /etc/haproxy/certs/haproxy.pem</span><br><span class="line">redirect scheme https <span class="keyword">if</span> !&#123; ssl_fc &#125; <span class="comment"># 注意 &#123; &#125; 内的空格</span></span><br><span class="line">http-request set-header X-forwarded-Port %[dst_port]</span><br><span class="line">http-request add-header X-forwarded-Proto https <span class="keyword">if</span> &#123; ssl_fc &#125;</span><br><span class="line"></span><br><span class="line">mode http</span><br><span class="line">balance roundrobin</span><br><span class="line"><span class="built_in">log</span> global</span><br><span class="line">option httplog</span><br><span class="line"></span><br><span class="line"><span class="comment">############## acl setting ###################</span></span><br><span class="line">acl mobile_domain hdr_dom(host) -i mobile.wang.org</span><br><span class="line"></span><br><span class="line"><span class="comment">############## acl hosts #####################</span></span><br><span class="line">default_backend pc_hosts</span><br><span class="line"></span><br><span class="line">backend mobile_hosts</span><br><span class="line">    mode http</span><br><span class="line">    server web1 10.0.0.17:80 check inter 2000 fall 3 rise 5</span><br><span class="line"></span><br><span class="line">backend pc_hosts</span><br><span class="line">    mode http</span><br><span class="line">    <span class="comment">#http-request set-header X-forwarded-Port %[dst_port] 也可加在此处</span></span><br><span class="line">    <span class="comment">#http-request add-header X-forwarded-Proto https if &#123; ssl_fc &#125;</span></span><br><span class="line">    server web2 10.0.0.27:80 check inter 2000 fall 3 rise 5</span><br></pre></td></tr></table></figure>

<h3 id="修改后端服务器的日志格式"><a href="#修改后端服务器的日志格式" class="headerlink" title="修改后端服务器的日志格式"></a>修改后端服务器的日志格式</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@centos27 ~]<span class="comment"># vim /etc/httpd/conf/httpd.conf</span></span><br><span class="line">LogFormat <span class="string">&quot;%h %l %u %t \&quot;%r\&quot; %&gt;s %b \&quot;%&#123;Referer&#125;i\&quot; \&quot;%&#123;User-Agent&#125;i\&quot; \&quot;%&#123;X-Forwarded-Port&#125;i\&quot; \&quot;%&#123;X-Forwarded-Proto&#125;i\&quot;&quot;</span> combined</span><br></pre></td></tr></table></figure>

<h3 id="验证-HTTPS"><a href="#验证-HTTPS" class="headerlink" title="验证 HTTPS"></a>验证 HTTPS</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">[root@centos6 ~]<span class="comment"># curl -IkL http://www.wang.org</span></span><br><span class="line">HTTP/1.1 302 Found</span><br><span class="line">content-length: 0</span><br><span class="line">location: https://www.wang.org/</span><br><span class="line">cache-control: no-cache</span><br><span class="line"></span><br><span class="line">HTTP/1.1 200 OK</span><br><span class="line"><span class="built_in">date</span>: Sat, 04 Apr 2020 02:31:31 GMT</span><br><span class="line">server: Apache/2.4.6 (CentOS) PHP/5.4.16</span><br><span class="line">last-modified: Thu, 02 Apr 2020 01:44:13 GMT</span><br><span class="line">etag: <span class="string">&quot;a-5a244f01f8adc&quot;</span></span><br><span class="line">accept-ranges: bytes</span><br><span class="line">content-length: 10</span><br><span class="line">content-type: text/html; charset=UTF-8</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@centos6 ~]<span class="comment"># curl -Ik https://www.wang.org</span></span><br><span class="line">HTTP/1.1 200 OK</span><br><span class="line"><span class="built_in">date</span>: Sat, 04 Apr 2020 02:31:50 GMT</span><br><span class="line">server: Apache/2.4.6 (CentOS) PHP/5.4.16</span><br><span class="line">last-modified: Thu, 02 Apr 2020 01:44:28 GMT</span><br><span class="line">etag: <span class="string">&quot;a-5a244f0fd5175&quot;</span></span><br><span class="line">accept-ranges: bytes</span><br><span class="line">content-length: 10</span><br><span class="line">content-type: text/html; charset=UTF-8</span><br><span class="line"></span><br><span class="line"><span class="comment">#查看后端服务器的访问日志</span></span><br><span class="line">[root@centos27 ~]<span class="comment"># tail /var/log/httpd/access_log</span></span><br><span class="line">10.0.0.7 - - [04/Apr/2020:10:40:17 +0800] <span class="string">&quot;HEAD / HTTP/1.1&quot;</span> 200 - <span class="string">&quot;-&quot;</span> <span class="string">&quot;curl/7.19.7 (x86_64-redhat-linux-gnu) libcurl/7.19.7 NSS/3.27.1 zlib/1.2.3 libidn/1.18 libssh2/1.4.2&quot;</span> <span class="string">&quot;443&quot;</span> <span class="string">&quot;https&quot;</span></span><br></pre></td></tr></table></figure>

</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="http://example.com">૮(˶ᵔ ᵕ ᵔ˶)ა</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="http://example.com/2025/04/15/SRE-HAProxy/">http://example.com/2025/04/15/SRE-HAProxy/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="http://example.com" target="_blank">૮(˶ᵔ ᵕ ᵔ˶)ა</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/SRE/">SRE</a><a class="post-meta__tags" href="/tags/HAProxy/">HAProxy</a></div><div class="post_share"><div class="social-share" data-image="/../images/SRE/day47/1.jpg" data-sites="wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2025/04/13/SRE-docker/" title="企业级容器技术Docker"><img class="cover" src="/../images/SRE/day46/1.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">企业级容器技术Docker</div></div></a></div><div class="next-post pull-right"><a href="/2025/04/16/SRE-Keepalived/" title="高可用性集群Keepalived"><img class="cover" src="/../images/SRE/day48/1.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">高可用性集群Keepalived</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><div><a href="/2025/02/21/SRE-LVS/" title="企业级调度器LVS"><img class="cover" src="/../images/SRE/day27/3.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2025-02-21</div><div class="title">企业级调度器LVS</div></div></a></div><div><a href="/2025/04/16/SRE-Keepalived/" title="高可用性集群Keepalived"><img class="cover" src="/../images/SRE/day48/1.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2025-04-16</div><div class="title">高可用性集群Keepalived</div></div></a></div><div><a href="/2024/08/27/SRE-Linux%E6%96%87%E4%BB%B6%E7%AE%A1%E7%90%86%E5%92%8CIO%E9%87%8D%E5%AE%9A%E5%90%91/" title="Linux文件管理和IO重定向"><img class="cover" src="/../images/TITLE/linux3.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-08-27</div><div class="title">Linux文件管理和IO重定向</div></div></a></div><div><a href="/2024/04/24/SRE-Linux%E5%9F%BA%E6%9C%AC%E6%93%8D%E4%BD%9C%E5%92%8C%E5%B8%AE%E5%8A%A9/" title="Linux基本操作和帮助"><img class="cover" src="/../images/TITLE/linux2.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-04-24</div><div class="title">Linux基本操作和帮助</div></div></a></div><div><a href="/2024/12/08/SRE-Linux%E9%98%B2%E7%81%AB%E5%A2%99/" title="Linux防火墙"><img class="cover" src="/../images/SRE/day17/12.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-12-08</div><div class="title">Linux防火墙</div></div></a></div><div><a href="/2025/03/03/SRE-Nginx/" title="企业级高性能WEB服务Nginx"><img class="cover" src="/../images/TITLE/nginx_logo.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2025-03-03</div><div class="title">企业级高性能WEB服务Nginx</div></div></a></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="/../images/TITLE/user.webp" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">૮(˶ᵔ ᵕ ᵔ˶)ა</div><div class="author-info__description">这家伙很勤奋，什么都留下了</div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">104</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">42</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">35</div></a></div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content is-expand"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#HAProxy%E5%AE%89%E8%A3%85"><span class="toc-number">1.</span> <span class="toc-text">HAProxy安装</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Ubuntu%E5%8C%85%E5%AE%89%E8%A3%85"><span class="toc-number">1.1.</span> <span class="toc-text">Ubuntu包安装</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Rocky%E7%BC%96%E8%AF%91%E5%AE%89%E8%A3%85"><span class="toc-number">1.2.</span> <span class="toc-text">Rocky编译安装</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#CentOS-%E5%9F%BA%E7%A1%80%E7%8E%AF%E5%A2%83"><span class="toc-number">1.2.1.</span> <span class="toc-text">CentOS 基础环境</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Ubuntu-%E5%9F%BA%E7%A1%80%E7%8E%AF%E5%A2%83"><span class="toc-number">1.2.2.</span> <span class="toc-text">Ubuntu 基础环境</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BC%96%E8%AF%91%E5%AE%89%E8%A3%85-HAProxy"><span class="toc-number">1.2.3.</span> <span class="toc-text">编译安装 HAProxy</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Docker-%E5%AE%89%E8%A3%85"><span class="toc-number">1.3.</span> <span class="toc-text">Docker 安装</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#HAProxy-%E5%9F%BA%E7%A1%80%E9%85%8D%E7%BD%AE"><span class="toc-number">2.</span> <span class="toc-text">HAProxy 基础配置</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Global%E9%85%8D%E7%BD%AE"><span class="toc-number">2.1.</span> <span class="toc-text">Global配置</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%A4%9A%E7%BA%BF%E7%A8%8B%E7%BB%91%E5%AE%9ACPU"><span class="toc-number">2.2.</span> <span class="toc-text">多线程绑定CPU</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%97%A5%E5%BF%97%E9%85%8D%E7%BD%AE"><span class="toc-number">2.3.</span> <span class="toc-text">日志配置</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#HAProxy%E9%85%8D%E7%BD%AE"><span class="toc-number">2.3.1.</span> <span class="toc-text">HAProxy配置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Rsyslog%E9%85%8D%E7%BD%AE"><span class="toc-number">2.3.2.</span> <span class="toc-text">Rsyslog配置</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Proxies-%E9%85%8D%E7%BD%AE"><span class="toc-number">2.4.</span> <span class="toc-text">Proxies 配置</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#default"><span class="toc-number">2.4.1.</span> <span class="toc-text">default</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#listen"><span class="toc-number">2.4.2.</span> <span class="toc-text">listen</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#frontend"><span class="toc-number">2.4.3.</span> <span class="toc-text">frontend</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#backend"><span class="toc-number">2.4.4.</span> <span class="toc-text">backend</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#frontend-backend%E6%A1%88%E4%BE%8B"><span class="toc-number">2.4.5.</span> <span class="toc-text">frontend+backend案例</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8-HAProxy-%E5%AD%90%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6"><span class="toc-number">2.5.</span> <span class="toc-text">使用 HAProxy 子配置文件</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#HAProxy-%E8%B0%83%E5%BA%A6%E7%AE%97%E6%B3%95"><span class="toc-number">3.</span> <span class="toc-text">HAProxy 调度算法</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%9D%99%E6%80%81%E7%AE%97%E6%B3%95"><span class="toc-number">3.1.</span> <span class="toc-text">静态算法</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Socat-%E5%B7%A5%E5%85%B7"><span class="toc-number">3.1.1.</span> <span class="toc-text">Socat 工具</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#static-rr-%E7%AE%97%E6%B3%95"><span class="toc-number">3.1.2.</span> <span class="toc-text">static-rr 算法</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#first-%E7%AE%97%E6%B3%95"><span class="toc-number">3.1.3.</span> <span class="toc-text">first 算法</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8A%A8%E6%80%81%E7%AE%97%E6%B3%95"><span class="toc-number">3.2.</span> <span class="toc-text">动态算法</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#roundrobin-%E7%AE%97%E6%B3%95"><span class="toc-number">3.2.1.</span> <span class="toc-text">roundrobin 算法</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#leastconn-%E7%AE%97%E6%B3%95"><span class="toc-number">3.2.2.</span> <span class="toc-text">leastconn 算法</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#random-%E7%AE%97%E6%B3%95"><span class="toc-number">3.2.3.</span> <span class="toc-text">random 算法</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%B6%E4%BB%96%E7%AE%97%E6%B3%95"><span class="toc-number">3.3.</span> <span class="toc-text">其他算法</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#source-%E7%AE%97%E6%B3%95"><span class="toc-number">3.3.1.</span> <span class="toc-text">source 算法</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#map-based-%E5%8F%96%E6%A8%A1%E6%B3%95"><span class="toc-number">3.3.1.1.</span> <span class="toc-text">map-based 取模法</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%80%E8%87%B4%E6%80%A7-hash"><span class="toc-number">3.3.1.2.</span> <span class="toc-text">一致性 hash</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%AE%97%E6%B3%95%EF%BC%9A"><span class="toc-number">3.3.1.3.</span> <span class="toc-text">算法：</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#hash-%E5%AF%B9%E8%B1%A1"><span class="toc-number">3.3.1.3.1.</span> <span class="toc-text">hash 对象</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%B8%80%E8%87%B4%E6%80%A7hash%E7%A4%BA%E6%84%8F%E5%9B%BE"><span class="toc-number">3.3.1.3.2.</span> <span class="toc-text">一致性hash示意图</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%B8%80%E8%87%B4%E6%80%A7hash%E9%85%8D%E7%BD%AE%E7%A4%BA%E4%BE%8B"><span class="toc-number">3.3.1.3.3.</span> <span class="toc-text">一致性hash配置示例</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#uri-%E7%AE%97%E6%B3%95"><span class="toc-number">3.3.2.</span> <span class="toc-text">uri 算法</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#uri-%E5%8F%96%E6%A8%A1%E6%B3%95%E9%85%8D%E7%BD%AE%E7%A4%BA%E4%BE%8B"><span class="toc-number">3.3.2.1.</span> <span class="toc-text">uri 取模法配置示例</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#uri-%E4%B8%80%E8%87%B4%E6%80%A7-hash-%E9%85%8D%E7%BD%AE%E7%A4%BA%E4%BE%8B"><span class="toc-number">3.3.2.2.</span> <span class="toc-text">uri 一致性 hash 配置示例</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%AE%BF%E9%97%AE%E6%B5%8B%E8%AF%95"><span class="toc-number">3.3.2.3.</span> <span class="toc-text">访问测试</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#url-param-%E7%AE%97%E6%B3%95"><span class="toc-number">3.3.3.</span> <span class="toc-text">url_param 算法</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#url-param%E5%8F%96%E6%A8%A1%E6%B3%95%E9%85%8D%E7%BD%AE%E7%A4%BA%E4%BE%8B"><span class="toc-number">3.3.3.1.</span> <span class="toc-text">url_param取模法配置示例</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#url-param%E4%B8%80%E8%87%B4%E6%80%A7hash%E9%85%8D%E7%BD%AE%E7%A4%BA%E4%BE%8B"><span class="toc-number">3.3.3.2.</span> <span class="toc-text">url_param一致性hash配置示例</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%B5%8B%E8%AF%95%E8%AE%BF%E9%97%AE"><span class="toc-number">3.3.3.3.</span> <span class="toc-text">测试访问</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#hdr-%E7%AE%97%E6%B3%95"><span class="toc-number">3.3.4.</span> <span class="toc-text">hdr 算法</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#hdr%E5%8F%96%E6%A8%A1%E6%B3%95%E9%85%8D%E7%BD%AE%E7%A4%BA%E4%BE%8B"><span class="toc-number">3.3.4.1.</span> <span class="toc-text">hdr取模法配置示例</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%80%E8%87%B4%E6%80%A7hash%E9%85%8D%E7%BD%AE%E7%A4%BA%E4%BE%8B-1"><span class="toc-number">3.3.4.2.</span> <span class="toc-text">一致性hash配置示例</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%B5%8B%E8%AF%95%E8%AE%BF%E9%97%AE-1"><span class="toc-number">3.3.4.3.</span> <span class="toc-text">测试访问</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#rdp-cookie-%E7%AE%97%E6%B3%95"><span class="toc-number">3.3.5.</span> <span class="toc-text">rdp-cookie 算法</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#rdp-cookie-%E5%8F%96%E6%A8%A1%E6%B3%95%E9%85%8D%E7%BD%AE%E7%A4%BA%E4%BE%8B"><span class="toc-number">3.3.5.1.</span> <span class="toc-text">rdp-cookie 取模法配置示例</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#dp-cookie-%E4%B8%80%E8%87%B4%E6%80%A7hash%E9%85%8D%E7%BD%AE%E7%A4%BA%E4%BE%8B"><span class="toc-number">3.3.5.2.</span> <span class="toc-text">dp-cookie 一致性hash配置示例</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%AE%97%E6%B3%95%E6%80%BB%E7%BB%93"><span class="toc-number">3.3.6.</span> <span class="toc-text">算法总结</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#HAProxy-%E9%AB%98%E7%BA%A7%E5%8A%9F%E8%83%BD"><span class="toc-number">4.</span> <span class="toc-text">HAProxy 高级功能</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9F%BA%E4%BA%8E-Cookie-%E7%9A%84%E4%BC%9A%E8%AF%9D%E4%BF%9D%E6%8C%81"><span class="toc-number">4.1.</span> <span class="toc-text">基于 Cookie 的会话保持</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE%E9%80%89%E9%A1%B9"><span class="toc-number">4.1.1.</span> <span class="toc-text">配置选项</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE%E7%A4%BA%E4%BE%8B"><span class="toc-number">4.1.2.</span> <span class="toc-text">配置示例</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%AA%8C%E8%AF%81-Cookie-%E4%BF%A1%E6%81%AF"><span class="toc-number">4.1.3.</span> <span class="toc-text">验证 Cookie 信息</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#HAProxy-%E7%8A%B6%E6%80%81%E9%A1%B5"><span class="toc-number">4.2.</span> <span class="toc-text">HAProxy 状态页</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%8A%B6%E6%80%81%E9%A1%B5%E9%85%8D%E7%BD%AE%E9%A1%B9"><span class="toc-number">4.2.1.</span> <span class="toc-text">状态页配置项</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%90%AF%E7%94%A8%E7%8A%B6%E6%80%81%E9%A1%B5%E7%A4%BA%E4%BE%8B"><span class="toc-number">4.2.2.</span> <span class="toc-text">启用状态页示例</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%99%BB%E5%BD%95%E7%8A%B6%E6%80%81%E9%A1%B5%E8%AF%B4%E6%98%8E"><span class="toc-number">4.2.3.</span> <span class="toc-text">登录状态页说明</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#IP-%E9%80%8F%E4%BC%A0"><span class="toc-number">4.3.</span> <span class="toc-text">IP 透传</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Layer-4-%E4%B8%8E-Layer-7"><span class="toc-number">4.3.1.</span> <span class="toc-text">Layer 4 与 Layer 7</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%9B%9B%E5%B1%82%E8%B4%9F%E8%BD%BD"><span class="toc-number">4.3.1.1.</span> <span class="toc-text">四层负载</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%83%E5%B1%82%E4%BB%A3%E7%90%86"><span class="toc-number">4.3.1.2.</span> <span class="toc-text">七层代理</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9B%9B%E5%B1%82IP%E9%80%8F%E4%BC%A0"><span class="toc-number">4.3.2.</span> <span class="toc-text">四层IP透传</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%83%E5%B1%82IP%E9%80%8F%E4%BC%A0"><span class="toc-number">4.3.3.</span> <span class="toc-text">七层IP透传</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#HAProxy%E9%85%8D%E7%BD%AE-1"><span class="toc-number">4.3.3.1.</span> <span class="toc-text">HAProxy配置</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%90%8E%E7%AB%AFweb%E6%9C%8D%E5%8A%A1%E5%99%A8%E6%97%A5%E5%BF%97%E6%A0%BC%E5%BC%8F%E9%85%8D%E7%BD%AE"><span class="toc-number">4.3.3.2.</span> <span class="toc-text">后端web服务器日志格式配置</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%AA%8C%E8%AF%81%E5%AE%A2%E6%88%B7%E7%AB%AFIP%E5%9C%B0%E5%9D%80"><span class="toc-number">4.3.3.3.</span> <span class="toc-text">验证客户端IP地址</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%8A%A5%E6%96%87%E4%BF%AE%E6%94%B9"><span class="toc-number">4.4.</span> <span class="toc-text">报文修改</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89%E6%97%A5%E5%BF%97%E6%A0%BC%E5%BC%8F"><span class="toc-number">4.5.</span> <span class="toc-text">自定义日志格式</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE%E9%80%89%E9%A1%B9-1"><span class="toc-number">4.5.1.</span> <span class="toc-text">配置选项</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE%E7%A4%BA%E4%BE%8B-1"><span class="toc-number">4.5.2.</span> <span class="toc-text">配置示例</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%AA%8C%E8%AF%81%E6%97%A5%E5%BF%97%E6%A0%BC%E5%BC%8F"><span class="toc-number">4.5.3.</span> <span class="toc-text">验证日志格式</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8E%8B%E7%BC%A9%E5%8A%9F%E8%83%BD"><span class="toc-number">4.6.</span> <span class="toc-text">压缩功能</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE%E9%80%89%E9%A1%B9-2"><span class="toc-number">4.6.1.</span> <span class="toc-text">配置选项</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE%E7%A4%BA%E4%BE%8B-2"><span class="toc-number">4.6.2.</span> <span class="toc-text">配置示例</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%AA%8C%E8%AF%81%E5%8E%8B%E7%BC%A9%E5%8A%9F%E8%83%BD"><span class="toc-number">4.6.3.</span> <span class="toc-text">验证压缩功能</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%90%8E%E7%AB%AF%E6%9C%8D%E5%8A%A1%E5%99%A8%E5%81%A5%E5%BA%B7%E6%80%A7%E7%9B%91%E6%B5%8B"><span class="toc-number">4.7.</span> <span class="toc-text">后端服务器健康性监测</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%89%E7%A7%8D%E7%8A%B6%E6%80%81%E7%9B%91%E6%B5%8B%E6%96%B9%E5%BC%8F"><span class="toc-number">4.7.1.</span> <span class="toc-text">三种状态监测方式</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9F%BA%E4%BA%8E%E5%BA%94%E7%94%A8%E5%B1%82http%E5%8D%8F%E8%AE%AE%E8%BF%9B%E8%A1%8C%E5%81%A5%E5%BA%B7%E6%80%A7%E6%A3%80%E6%B5%8B"><span class="toc-number">4.7.2.</span> <span class="toc-text">基于应用层http协议进行健康性检测</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE%E7%A4%BA%E4%BE%8B-3"><span class="toc-number">4.7.3.</span> <span class="toc-text">配置示例</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ACL"><span class="toc-number">4.8.</span> <span class="toc-text">ACL</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9A%E4%B9%89ACL%E9%85%8D%E7%BD%AE%E9%80%89%E9%A1%B9"><span class="toc-number">4.8.1.</span> <span class="toc-text">定义ACL配置选项</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#ACL-Name"><span class="toc-number">4.8.1.1.</span> <span class="toc-text">ACL-Name</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#ACL-criterion"><span class="toc-number">4.8.1.2.</span> <span class="toc-text">ACL-criterion</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#ACL-flags"><span class="toc-number">4.8.1.3.</span> <span class="toc-text">ACL-flags</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#ACL-operator"><span class="toc-number">4.8.1.4.</span> <span class="toc-text">ACL-operator</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#ACL-value"><span class="toc-number">4.8.1.5.</span> <span class="toc-text">ACL-value</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ACL%E7%A4%BA%E4%BE%8B%EF%BC%9A%E5%9F%9F%E5%90%8D%E5%8C%B9%E9%85%8D"><span class="toc-number">4.8.2.</span> <span class="toc-text">ACL示例：域名匹配</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ACL%E7%A4%BA%E4%BE%8B%EF%BC%9A%E5%9F%BA%E4%BA%8E%E6%BA%90IP%E6%88%96%E5%AD%90%E7%BD%91%E8%B0%83%E5%BA%A6%E8%AE%BF%E9%97%AE"><span class="toc-number">4.8.3.</span> <span class="toc-text">ACL示例：基于源IP或子网调度访问</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ACL%E7%A4%BA%E4%BE%8B%EF%BC%9A%E5%9F%BA%E4%BA%8E%E6%BA%90%E5%9C%B0%E5%9D%80%E7%9A%84%E8%AE%BF%E9%97%AE%E6%8E%A7%E5%88%B6"><span class="toc-number">4.8.4.</span> <span class="toc-text">ACL示例：基于源地址的访问控制</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ACL%E7%A4%BA%E4%BE%8B%EF%BC%9A%E5%8C%B9%E9%85%8D%E6%B5%8F%E8%A7%88%E5%99%A8%E7%B1%BB%E5%9E%8B"><span class="toc-number">4.8.5.</span> <span class="toc-text">ACL示例：匹配浏览器类型</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ACL%E7%A4%BA%E4%BE%8B%EF%BC%9A%E5%9F%BA%E4%BA%8E%E6%96%87%E4%BB%B6%E5%90%8E%E7%BC%80%E5%90%8D%E5%AE%9E%E7%8E%B0%E5%8A%A8%E9%9D%99%E5%88%86%E7%A6%BB"><span class="toc-number">4.8.6.</span> <span class="toc-text">ACL示例：基于文件后缀名实现动静分离</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ACL%E7%A4%BA%E4%BE%8B%EF%BC%9A%E5%8C%B9%E9%85%8D%E8%AE%BF%E9%97%AE%E8%B7%AF%E5%BE%84%E5%AE%9E%E7%8E%B0%E5%8A%A8%E9%9D%99%E5%88%86%E7%A6%BB"><span class="toc-number">4.8.7.</span> <span class="toc-text">ACL示例：匹配访问路径实现动静分离</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ACL%E7%A4%BA%E4%BE%8B%EF%BC%9A%E9%A2%84%E5%AE%9A%E4%B9%89ACL%E4%BD%BF%E7%94%A8"><span class="toc-number">4.8.8.</span> <span class="toc-text">ACL示例：预定义ACL使用</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%A2%84%E5%AE%9A%E4%B9%89ACL"><span class="toc-number">4.8.8.1.</span> <span class="toc-text">预定义ACL</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%A2%84%E5%AE%9A%E4%B9%89ACL%E4%BD%BF%E7%94%A8"><span class="toc-number">4.8.8.2.</span> <span class="toc-text">预定义ACL使用</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89HAProxy%E9%94%99%E8%AF%AF%E7%95%8C%E9%9D%A2"><span class="toc-number">4.9.</span> <span class="toc-text">自定义HAProxy错误界面</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9F%BA%E4%BA%8E%E8%87%AA%E5%AE%9A%E4%B9%89%E7%9A%84%E9%94%99%E8%AF%AF%E9%A1%B5%E9%9D%A2%E6%96%87%E4%BB%B6"><span class="toc-number">4.9.1.</span> <span class="toc-text">基于自定义的错误页面文件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89%E9%94%99%E8%AF%AF%E9%A1%B5"><span class="toc-number">4.9.2.</span> <span class="toc-text">自定义错误页</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9F%BA%E4%BA%8E-HTTP-%E9%87%8D%E5%AE%9A%E5%90%91%E9%94%99%E8%AF%AF%E9%A1%B5%E9%9D%A2"><span class="toc-number">4.9.3.</span> <span class="toc-text">基于 HTTP 重定向错误页面</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#HAProxy-%E5%9B%9B%E5%B1%82%E8%B4%9F%E8%BD%BD"><span class="toc-number">4.10.</span> <span class="toc-text">HAProxy 四层负载</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9B%9B%E5%B1%82%E8%B4%9F%E8%BD%BD%E7%A4%BA%E4%BE%8B"><span class="toc-number">4.10.1.</span> <span class="toc-text">四层负载示例</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#HAProxy-HTTPS-%E5%AE%9E%E7%8E%B0"><span class="toc-number">4.11.</span> <span class="toc-text">HAProxy HTTPS 实现</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%AF%81%E4%B9%A6%E5%88%B6%E4%BD%9C"><span class="toc-number">4.11.1.</span> <span class="toc-text">证书制作</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#HTTPS-%E9%85%8D%E7%BD%AE%E7%A4%BA%E4%BE%8B"><span class="toc-number">4.11.2.</span> <span class="toc-text">HTTPS 配置示例</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BF%AE%E6%94%B9%E5%90%8E%E7%AB%AF%E6%9C%8D%E5%8A%A1%E5%99%A8%E7%9A%84%E6%97%A5%E5%BF%97%E6%A0%BC%E5%BC%8F"><span class="toc-number">4.11.3.</span> <span class="toc-text">修改后端服务器的日志格式</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%AA%8C%E8%AF%81-HTTPS"><span class="toc-number">4.11.4.</span> <span class="toc-text">验证 HTTPS</span></a></li></ol></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2025/08/10/MY-k8s%E5%AE%B9%E5%BF%8D%E6%B1%A1%E7%82%B9%E4%BA%B2%E5%92%8CHPA/" title="容忍/污点/亲和/HPA"><img src="/../images/SRE/day46/1.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="容忍/污点/亲和/HPA"/></a><div class="content"><a class="title" href="/2025/08/10/MY-k8s%E5%AE%B9%E5%BF%8D%E6%B1%A1%E7%82%B9%E4%BA%B2%E5%92%8CHPA/" title="容忍/污点/亲和/HPA">容忍/污点/亲和/HPA</a><time datetime="2025-08-10T09:35:57.000Z" title="发表于 2025-08-10 17:35:57">2025-08-10</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2025/08/01/MY-Proxy/" title="Proxy 代理"><img src="/../images/MY/clash.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Proxy 代理"/></a><div class="content"><a class="title" href="/2025/08/01/MY-Proxy/" title="Proxy 代理">Proxy 代理</a><time datetime="2025-08-01T11:05:46.000Z" title="发表于 2025-08-01 19:05:46">2025-08-01</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2025/07/30/MY-k8s1.29/" title="K8S 1.29.2"><img src="/../images/SRE/day46/1.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="K8S 1.29.2"/></a><div class="content"><a class="title" href="/2025/07/30/MY-k8s1.29/" title="K8S 1.29.2">K8S 1.29.2</a><time datetime="2025-07-30T07:17:21.000Z" title="发表于 2025-07-30 15:17:21">2025-07-30</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2025/05/09/SRE-jenkins/" title="DevOps之CICD工具Jenkins"><img src="/../images/SRE/day55/1.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="DevOps之CICD工具Jenkins"/></a><div class="content"><a class="title" href="/2025/05/09/SRE-jenkins/" title="DevOps之CICD工具Jenkins">DevOps之CICD工具Jenkins</a><time datetime="2025-05-09T09:30:43.000Z" title="发表于 2025-05-09 17:30:43">2025-05-09</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2023 - 2025 By ૮(˶ᵔ ᵕ ᵔ˶)ა</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div><div class="footer_custom_text"><a target="_blank" rel="noopener" href="https://beian.miit.gov.cn/#/Integrated/index"><img src="../images/BEIAN/icp.png" width="15" height="15">豫ICP备2023009931号</a></br><a href="http://www.beian.gov.cn/portal/registerSystemInfo?recordcode=41162702000178" target="_blank"><img src="../images/BEIAN/beian.png" width="15" height="15">豫公网安备 41162702000178号</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.umd.min.js"></script><script src="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.js"></script><script>function panguFn () {
  if (typeof pangu === 'object') pangu.autoSpacingPage()
  else {
    getScript('https://cdn.jsdelivr.net/npm/pangu/dist/browser/pangu.min.js')
      .then(() => {
        pangu.autoSpacingPage()
      })
  }
}

function panguInit () {
  if (true){
    GLOBAL_CONFIG_SITE.isPost && panguFn()
  } else {
    panguFn()
  }
}

document.addEventListener('DOMContentLoaded', panguInit)</script><div class="js-pjax"></div><canvas id="universe"></canvas><script src="/js/universe.js"></script><canvas class="fireworks" mobile="true"></canvas><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/fireworks.min.js"></script><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/activate-power-mode.min.js"></script><script>POWERMODE.colorful = true;
POWERMODE.shake = false;
POWERMODE.mobile = false;
document.body.addEventListener('input', POWERMODE);
</script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>