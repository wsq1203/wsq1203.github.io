<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>企业级Linux虚拟化KVM | ૮(˶ᵔ ᵕ ᵔ˶)ა</title><meta name="author" content="૮(˶ᵔ ᵕ ᵔ˶)ა"><meta name="copyright" content="૮(˶ᵔ ᵕ ᵔ˶)ა"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="ffffff"><meta name="description" content="Site Reliability Engineering">
<meta property="og:type" content="article">
<meta property="og:title" content="企业级Linux虚拟化KVM">
<meta property="og:url" content="http://example.com/2025/04/01/SRE-kvm/index.html">
<meta property="og:site_name" content="૮(˶ᵔ ᵕ ᵔ˶)ა">
<meta property="og:description" content="Site Reliability Engineering">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://example.com/images/SRE/day41/21.jpg">
<meta property="article:published_time" content="2025-04-01T09:21:21.000Z">
<meta property="article:modified_time" content="2025-04-01T11:34:55.903Z">
<meta property="article:author" content="૮(˶ᵔ ᵕ ᵔ˶)ა">
<meta property="article:tag" content="SRE">
<meta property="article:tag" content="kvm">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://example.com/images/SRE/day41/21.jpg"><link rel="shortcut icon" href="/../images/TITLE/user.webp"><link rel="canonical" href="http://example.com/2025/04/01/SRE-kvm/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//fonts.googleapis.com" crossorigin=""/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Titillium+Web&amp;display=swap" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":false,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: true,
    post: true
  },
  runtime: '天',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: {"chs_to_cht":"你已切换为繁体","cht_to_chs":"你已切换为简体","day_to_night":"你已切换为深色模式","night_to_day":"你已切换为浅色模式","bgLight":"#49b1f5","bgDark":"#1f1f1f","position":"top-center"},
  source: {
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: true,
  }
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: '企业级Linux虚拟化KVM',
  isPost: true,
  isHome: false,
  isHighlightShrink: undefined,
  isToc: true,
  postUpdate: '2025-04-01 19:34:55'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
    win.getCSS = (url,id = false) => new Promise((resolve, reject) => {
      const link = document.createElement('link')
      link.rel = 'stylesheet'
      link.href = url
      if (id) link.id = id
      link.onerror = reject
      link.onload = link.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        link.onload = link.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(link)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', 'ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><link rel="stylesheet" href="/css/custom.css"  media="defer" onload="this.media='all'"><meta name="generator" content="Hexo 5.4.2"></head><body><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="/../images/TITLE/user.webp" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">94</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">36</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">29</div></a></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间线</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('/../images/SRE/day41/21.jpg')"><nav id="nav"><span id="blog-info"><a href="/" title="૮(˶ᵔ ᵕ ᵔ˶)ა"><span class="site-name">૮(˶ᵔ ᵕ ᵔ˶)ა</span></a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间线</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">企业级Linux虚拟化KVM</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2025-04-01T09:21:21.000Z" title="发表于 2025-04-01 17:21:21">2025-04-01</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2025-04-01T11:34:55.903Z" title="更新于 2025-04-01 19:34:55">2025-04-01</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/kvm/">kvm</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">字数总计:</span><span class="word-count">24.9k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>114分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="企业级Linux虚拟化KVM"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="虚拟化基础"><a href="#虚拟化基础" class="headerlink" title="虚拟化基础"></a>虚拟化基础</h1><h2 id="传统的物理机部署方案"><a href="#传统的物理机部署方案" class="headerlink" title="传统的物理机部署方案"></a>传统的物理机部署方案</h2><p><img src="../../../../images/SRE/day41/1.jpg" alt="1"></p>
<ul>
<li>IDC选择，如:联通，电信，世纪互联，鹏博士等</li>
<li>网络和存储规划</li>
<li>服务器选型及采购</li>
<li>服务器系统选择、系统安装、上架、配置网络</li>
<li>应用规划及部署</li>
<li>域名选择及注册，DNS配置名称解析</li>
<li>测试外网访问</li>
</ul>
<p><strong>传统数据中心面临的问题：</strong> </p>
<ul>
<li><p>服务器和网络设备资源利用率过低，并且无法共享，导致资源浪费</p>
<p>据统计大部分数据中心中的服务器和网络设备的利用率仅在24%～30%之间，有的CPU利用率、硬盘利用率都在10%以下</p>
</li>
<li><p>资源分配后进行调整困难</p>
<p>资源分配不合理也是传统网络架构存在的问题，因为资源不能动态调配，分配出去的资源是固定的，不能随意添加或删除。</p>
</li>
<li><p>难以实现自动化</p>
<p>初始化成本高，服务器迁移和升级很繁琐，无法实现自动化</p>
</li>
<li><p>成本高昂</p>
<p>集群环境需要大量的服务器主机，硬件投入和后期维护管理成本巨大</p>
</li>
</ul>
<h2 id="虚拟化"><a href="#虚拟化" class="headerlink" title="虚拟化"></a>虚拟化</h2><h3 id="什么是虚拟化"><a href="#什么是虚拟化" class="headerlink" title="什么是虚拟化"></a>什么是虚拟化</h3><p>虚拟化（Virtualization）是一种资源分配和管理技术，是将计算机的各种实体资源，比如CPU、内存、磁盘空间、网络适配器等，进行抽象转换后虚拟的设备，可以实现灵活地分割、组合为一个或多个计算机配置环境，并还支持重新分割、重新组合，以达到最大化合理利用物理资源的目的。</p>
<p>参考资料: <a target="_blank" rel="noopener" href="https://www.vmware.com/cn/solutions/virtualization.html">https://www.vmware.com/cn/solutions/virtualization.html</a></p>
<h3 id="虚拟化优势"><a href="#虚拟化优势" class="headerlink" title="虚拟化优势"></a>虚拟化优势</h3><p>虚拟化可以提高 IT 敏捷性、灵活性和可扩展性，同时大幅节约成本。更高的工作负载移动性、更高的性能和资源可用性、自动化运维 - 这些都是虚拟化的优势，虚拟化技术可以使 IT 部门更轻松地进行管理以及降低拥有成本和运维成本。其优势包括：</p>
<ul>
<li>资源超分，如实际的物理内存只有128G，可以给虚拟机分配200G内存</li>
<li>降低资金成本和运维成本</li>
<li>最大限度减少或消除停机</li>
<li>提高 IT 部门的工作效率和响应能力</li>
<li>加快应用和资源的调配速度</li>
<li>提高业务连续性和灾难恢复能力</li>
<li>简化数据中心管理</li>
<li>减少资源，比如IP和端口的冲突</li>
</ul>
<h3 id="虚拟化的发展史"><a href="#虚拟化的发展史" class="headerlink" title="虚拟化的发展史"></a>虚拟化的发展史</h3><p><img src="../../../../images/SRE/day41/2.jpg" alt="2"></p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">1959年，计算机科学家Christopher Strachey发表了一篇名为《大型高速计算机中的时间共享》（Time Sharing in Large Fast Computers）的学术报告，他在文中首次提出了虚拟化的基本概念，被认为是虚拟化技术的最早论述</span><br><span class="line">1964年，IBM推出了专为 System/360 Mainframe 量身订造的操作系统 CP-40，首次实现了虚拟内存和虚拟机。</span><br><span class="line">1967年，第一个管理程序(hypervisor)诞生，5年之后，IBM 发布用于创建灵活大型主机的虚拟机(VM)技术，该技术可根据动态的需求快速而有效地使用各种资源。从此，虚拟化这一词汇正式被引入了IT的现实世界。</span><br><span class="line">20世纪70年代的 System 370 系列中通过虚拟机监控器（Virtual Machine Monitor，VMM）的程序在物理硬件之上生成多个可以独立运行操作系统软件的虚拟机实例</span><br><span class="line">20世纪 90 年代 Windows 的广泛使用以及 Linux 作为服务器系统的出现奠定了 x86 服务器的行业标准地位。</span><br><span class="line">1998年VMware公司在美国成立，1999年VMware发布了它的第一款产品VMware Workstation、 2001年发布VMware GSX Server和VMware ESXi Server宣布进入服务器虚拟化市场， 2003年VMware推出了VMware Virtual Center， 2004年推出了64位支持版本，同年被EMC收购，2013年收入52.1亿美元。</span><br><span class="line">2015年10月12日，戴尔与数据存储公司EMC的并购宣布完成，最终戴尔以670亿美元收购了EMC</span><br><span class="line">2003年，Xen实现半虚拟化</span><br><span class="line">2005年，HVM硬件辅助的虚拟化，Intel VT-x，AMD-V</span><br><span class="line">2005年，openVZ出现，在Linux平台上的容器化技术实现</span><br><span class="line">2006年，QEMU</span><br><span class="line">2007年，KVM（Kernel-based Virtual Machine）基于内核Linux 2.6.20</span><br><span class="line">2007年8月21日，思杰宣布5亿美元收购XenSource公司，并推出服务器虚拟化XenServer、桌面虚拟化XenDesktop和应用虚拟化XenApp，2013年收入29亿美元。</span><br><span class="line">2008年，LXC发布</span><br><span class="line">2008年3月13日微软在北京发布Windows Server 2008，内置虚拟化技术hyper-v。</span><br><span class="line">2008年9月，红帽以1.07亿美元的价格收购KVM的以色列母公司Qumranet，并推出企业级虚拟化解决方案RHEV，目前最新版本3.3，2013年收入超过13亿美元</span><br><span class="line">2013年，docker发布</span><br><span class="line">2017年11月全球最大公有云厂商AWS宣布了全新的C5实例，该实例完全基于新的虚拟机监控程序（Hypervisor）：KVM。在之前的11年里，AWS的所有虚拟化实例都是基于XEN技术实现的。也就是说AWS也开始转向了KVM之路而不再坚持使用从其诞生之日起一直使用的XEN技术，事实上国内的阿里云早在2015年就开始从XEN切换到KVM</span><br></pre></td></tr></table></figure>

<h2 id="虚拟化类型"><a href="#虚拟化类型" class="headerlink" title="虚拟化类型"></a>虚拟化类型</h2><h3 id="服务器虚拟化"><a href="#服务器虚拟化" class="headerlink" title="服务器虚拟化"></a>服务器虚拟化</h3><p>服务器虚拟化支持在单个物理服务器上运行多个操作系统，每个操作系统作为虚拟机独立运行。</p>
<h3 id="网络虚拟化"><a href="#网络虚拟化" class="headerlink" title="网络虚拟化"></a>网络虚拟化</h3><p>通过软件定义网络(Software Defined Network，SDN)，即网络的创建不再依赖于物理设备，如公有云厂商支持用户自己通过配置界面创建新的网络，在 KVM、docker、kubernetes、openstack等虚拟化技术中都使用到了网络虚拟化。</p>
<h3 id="桌面虚拟化"><a href="#桌面虚拟化" class="headerlink" title="桌面虚拟化"></a>桌面虚拟化</h3><p>将桌面部署为托管的服务，使 IT 组织能够更快地响应不断变化的工作场所需求和新出现的机会。还可以将虚拟化桌面和应用快速、轻松地交付给分支机构、外包和远程员工以及使用 iPad 和 Android 平板电脑的移动员工。</p>
<p>Citrix 思杰公司在云计算虚拟化、虚拟桌面和远程接入技术领域的处于优势地位</p>
<h3 id="应用虚拟化"><a href="#应用虚拟化" class="headerlink" title="应用虚拟化"></a>应用虚拟化</h3><p>将软件应用通过网络实现虚拟化，比如 office 365，钉钉，企业微信</p>
<h3 id="存储虚拟化"><a href="#存储虚拟化" class="headerlink" title="存储虚拟化"></a>存储虚拟化</h3><p>将存储用软件虚拟化实现， 如 SAN/NAS(NFS/Samba)/GlusterFS/ceph等</p>
<h3 id="库虚拟化"><a href="#库虚拟化" class="headerlink" title="库虚拟化"></a>库虚拟化</h3><p>在Linux上使用 wine来运行Windows 程序，在Mac系统使用CrossOver来运行Windows程序</p>
<h3 id="容器虚技术"><a href="#容器虚技术" class="headerlink" title="容器虚技术"></a>容器虚技术</h3><p>当前比较火的虚拟化技术，典型代表: Docker、Podman、Linux Container(LXC)、Pouch</p>
<h2 id="虚拟机"><a href="#虚拟机" class="headerlink" title="虚拟机"></a>虚拟机</h2><h3 id="虚拟机-1"><a href="#虚拟机-1" class="headerlink" title="虚拟机"></a>虚拟机</h3><p>虚拟计算机称为“虚拟机”(VM，Virtual Machine)，它是一种严密隔离且内含操作系统和应用的软件容器。每个虚拟机都是完全独立的。通过将多台虚拟机放置在一台物理计算机上，可仅在一台物理服务器或“主机”上运行多个操作系统和应用，名为“hypervisor”的精简软件层可将虚拟机与主机分离开来，并根据需要为每个虚拟机动态分配计算资源。</p>
<h3 id="虚拟机的主要特性"><a href="#虚拟机的主要特性" class="headerlink" title="虚拟机的主要特性"></a>虚拟机的主要特性</h3><p>虚拟机具有以下特征，这些特征可提供多项优势</p>
<p><strong>分区</strong></p>
<p>可在一台物理机上运行多个操作系统</p>
<p>可在虚拟机之间分配系统资源。</p>
<p><strong>隔离</strong></p>
<p>可在硬件级别进行故障和安全隔离。</p>
<p>可利用高级资源控制功能保持性能</p>
<p><strong>封装</strong></p>
<p>可将虚拟机的完整状态保存到文件中。</p>
<p>移动和复制虚拟机就像移动和复制文件一样轻松</p>
<p><strong>独立于硬件</strong></p>
<p>可将任意虚拟机调配或迁移到任意物理服务器上</p>
<p>安装系统不会受硬件兼容性的影响</p>
<h2 id="Hypervisor类型"><a href="#Hypervisor类型" class="headerlink" title="Hypervisor类型"></a>Hypervisor类型</h2><h3 id="Hypervisor-介绍"><a href="#Hypervisor-介绍" class="headerlink" title="Hypervisor 介绍"></a>Hypervisor 介绍</h3><p><img src="../../../../images/SRE/day41/3.jpg" alt="3"></p>
<ul>
<li>Hypervisor是一种运行在基础物理服务器和操作系统之间的中间软件层，其可以允许多个操作系统和应用共享底层的内存、CPU、磁盘等物理硬件，也可叫做VMM（ virtual machine monitor），即虚拟机监视器。 </li>
<li>Hypervisor是所有虚拟化技术的核心，非中断地支持多工作负载迁移的能力是Hypervisor的基本功能，当服务器启动并执行Hypervisor时，它会给每一台虚拟机分配适量的内存、CPU、网络和磁盘，并加载所有虚拟机的客户操作系统。</li>
<li>Hypervisor 允许多种操作系统在相同的物理系统中运行</li>
<li>Hypervisor 控制硬件并向来宾操作系统提供访问底层硬件的途径</li>
<li>Hypervisor 向来宾操作系统提供虚拟化的硬件 </li>
</ul>
<p><strong>X86 CPU 的保护环</strong></p>
<p><img src="../../../../images/SRE/day41/4.jpg" alt="4"></p>
<p><strong>注意</strong>：CPU为了保证程序代码执行的安全性、多用户的独立性、保护OS的正常运行，提出了CPU执行状态的概念。这样能够限制不同程序之间的访问能力，避免一个程序获取另一个程序的内存数据造成数据混乱，同时也避免了程序错误的操作物理硬件。一般CPU都会划分为用户态和内核态 ，x86的CPU架构更是细分为了Ring3~0四种状态。</p>
<p><img src="../../../../images/SRE/day41/5.jpg" alt="5"></p>
<p><strong>Ring3 用户态(User Mode)：</strong>运行在用户态的程序代码需要受到CPU的检查，用户态程序代码只能访问内存页表项中规定能被用户态程序代码访问的页面虚拟地址(受限的内存访问)，而且还只能访问任务描述符TSS中的I/O Permission Bitmap中规定能被用户态程序代码访问的端口。甚至不能直接访问外围硬件设备、不能抢占CPU。所有的应用程序都运行在用户态上。当运行在用户态的Application需要调用只能被核心态代码直接访问的硬件设备时，CPU会通过特别的接口去调用核心态的代码，以此来实现Application对硬件设备的调用。如果用户态的Application直接调用硬件设备时，就会被Host OS捕捉到并触发异常，弹出警告窗口。</p>
<p><strong>Ring0 核心态(Kernel Mode)：</strong>是Host OS Kernel运行的模式，运行在核心态的代码可以无限制的对系统内存、设备驱动程序、网卡接口、显卡接口等外围硬件设备进行访问。只有Host OS能够无限制的访问磁盘、键盘等外围硬件设备的数据，但是首先需要在Host OS上安装驱动程序</p>
<h3 id="Hypervisor-分类"><a href="#Hypervisor-分类" class="headerlink" title="Hypervisor 分类"></a>Hypervisor 分类</h3><p>1974年Gerald J.Popek和Robert P.Goldberg的文章“Formal Requirements forVirtualizable Third Generation Architectures” 将Hypervisor分为两类:</p>
<p><img src="../../../../images/SRE/day41/6.jpg" alt="6"><br><img src="../../../../images/SRE/day41/7.jpg" alt="7"></p>
<h4 id="类型-I-裸金属型"><a href="#类型-I-裸金属型" class="headerlink" title="类型 I : 裸金属型"></a>类型 I : 裸金属型</h4><p>直接运行到物理机的Hypervisor上，这种架构搭建的虚拟化环境称为裸机虚拟化环境(Bare-Metal Hardware)</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">KVM</span><br><span class="line">XEN</span><br><span class="line">vmware esxi</span><br><span class="line">rhev hypervisor</span><br><span class="line">Hyper-v Server</span><br><span class="line"></span><br><span class="line"><span class="comment">#Redhat将KVM划分到类型I即裸机型：</span></span><br><span class="line">https://www.redhat.com/zh/topics/virtualization/what-is-KVM</span><br></pre></td></tr></table></figure>

<h4 id="类型-II-宿主型"><a href="#类型-II-宿主型" class="headerlink" title="类型 II : 宿主型"></a>类型 II : 宿主型</h4><p>即需要运行在具有虚拟化功能的操作系统上的Hypervisor，构建的是主机虚拟化环境(Hosted Virtualization)</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">vmware workstation</span><br><span class="line">Microsoft Hyper-V</span><br><span class="line">VirtualBox</span><br><span class="line">paralles desktop <span class="comment">#Mac系统最强虚拟机技术</span></span><br></pre></td></tr></table></figure>

<h2 id="虚拟化技术分类"><a href="#虚拟化技术分类" class="headerlink" title="虚拟化技术分类"></a>虚拟化技术分类</h2><h3 id="模拟器-软件仿真"><a href="#模拟器-软件仿真" class="headerlink" title="模拟器/软件仿真"></a>模拟器/软件仿真</h3><p><img src="../../../../images/SRE/day41/8.jpg" alt="8"></p>
<ul>
<li>通过软件模拟完整的硬件环境来虚拟化来宾平台。</li>
<li>可以模拟X86、ARM 、PowerPC等多种CPU</li>
<li>效率比较低</li>
<li>产品或方案:QEMU、Bochs、PearPC</li>
</ul>
<p>模拟器</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://yuzu-emu.org/</span><br></pre></td></tr></table></figure>

<h3 id="全虚拟机化-full-virtualization-本地虚拟化-native-virtualization"><a href="#全虚拟机化-full-virtualization-本地虚拟化-native-virtualization" class="headerlink" title="全虚拟机化 full virtualization / 本地虚拟化 native virtualization"></a>全虚拟机化 full virtualization / 本地虚拟化 native virtualization</h3><p><strong>不需要对GuestOS操作系统软件的源代码做任何的修改，就可以运行在这样的VMM中</strong></p>
<p>在全虚拟化的虚拟平台中，GuestOS并不知道自己是一台虚拟机，它会认为自己就是运行在计算机物理硬件设备上的HostOS。全虚拟化的GuestOS具有完全的物理机特性。因为全虚拟化的VMM会将一个OS所能够操作的CPU、内存、外设等物理设备逻辑抽象成为虚拟CPU、虚拟内存、虚拟外设等虚拟设备后，再交由GuestOS来操作使用。这样的GuestOS会将底层硬件平台视为自己所有的，但是实际上，这些都是VMM为GuestOS制造了这种假象。</p>
<p>全虚拟化/本地虚拟化不做CPU和内存模拟，只对CPU和内存做相应的分配等操作</p>
<p>全虚拟化又分为：<strong>软件辅助的全虚拟化 &amp; 硬件辅助的全虚拟化</strong></p>
<h4 id="软件辅助的全虚拟化"><a href="#软件辅助的全虚拟化" class="headerlink" title="软件辅助的全虚拟化"></a>软件辅助的全虚拟化</h4><p><img src="../../../../images/SRE/day41/9.jpg" alt="9"></p>
<p>在Intel等CPU厂商还没有发布x86 CPU虚拟化技术之前，完全虚拟化都是通过软件辅助的方式来实现的。</p>
<p>代表技术: Vmware Workstation，QEMU，Virtual PC</p>
<p>当使用GuestOS的时候，不可避免的会调用GuestOS中的虚拟设备驱动程序 和核心调度程序来操作硬件设备。与HostOS的不同在于，HostOS运行在CPU的核心态中，这就表示HostOS可以直接对硬件设备进行操作。但GuestOS作为一个运行在CPU用户态中应用程序，不能够直接的操作硬件设备。</p>
<p>简而言之，软件辅助虚拟化能够成功的将所有在GuestOS中执行的系统内核特权指令进行捕获、翻译，使之成为只能对GuestOS生效的虚拟特权指令。之所以需要这么做的前提是因为CPU并不能准确的去判断一个特权指令到底是由GuestOS发出的还是由HostOS发出的，这样也就无法针对一个正确的OS去将这一个特权指令执行。</p>
<p>由于全虚拟化VMM会频繁的捕获这些核心态的和敏感的指令，将这些指令进行转换之后，再交给CPU执行。所以经过了转换，导致其效率低，但全虚拟化VMM应用程序的好处在于其不需要对GuestOS的核心源码做修改，所以全虚拟化的VMM可以安装绝大部分的OS(暂时来说只有已Linux、open soralis、BSD等几种OS开源了内核代码)。</p>
<p>直到后来CPU厂商们发布了能够判断特权指令归属的标准x86 CPU之后，迎来了硬件辅助全虚拟化。</p>
<h4 id="硬件辅助的全虚拟化-HVM-Hardware-Virtual-Machine"><a href="#硬件辅助的全虚拟化-HVM-Hardware-Virtual-Machine" class="headerlink" title="硬件辅助的全虚拟化 HVM(Hardware Virtual Machine)"></a>硬件辅助的全虚拟化 HVM(Hardware Virtual Machine)</h4><p><img src="../../../../images/SRE/day41/10.jpg" alt="10"></p>
<p>2005年Intel提出并开发了由CPU直接支持的虚拟化技术。这种虚拟化技术引入新的CPU运行模式和新的指令集，使得VMM和GuestOS运行于不同的模式下(VMM=Root Mode;GuestOS=Non-Root Mode)，GuestOS运行于受控模式，原来的一些敏感指令在受控模式下会全部陷入VMM，由VMM来实现模拟，这样就解决了部分非内核态敏感指令的陷入——模拟难题，而且模式切换时上下文的保存恢复由硬件来完成，这样就大大提高了陷入——模拟时上下文切换的效率 。该技术的引入使x86 CPU可以很容易地实现完全虚拟化。故皆被几乎所有之前分歧的各大流派所采用，包括KVM-x86，VMWare ESX Server 3，Xen 3.0。</p>
<p>虚拟化CPU形成了新的CPU执行状态 Non-Root Mode 和 Root Mode .GuestOS运行在Non-Root Mode 的Ring 0核心态中，这意味着GuestOS能够直接执行特权指令，而不再需要特权解除和陷入模拟机制。并且在硬件层上面紧接的就是虚拟化层的VMM，而不需要HostOS。这是因为在硬件辅助全虚拟化的VMM会以一种更具协作性的方式来实现虚拟化 —— 将虚拟化模块加载到HostOS的内核中，例如：KVM，KVM通过在HostOS内核中加载<strong>KVM Kernel Module</strong>来将HostOS转换成为一个VMM。所以此时VMM可以看作是HostOS，反之亦然。</p>
<p>硬件辅助全虚拟化主要使用了支持虚拟化功能的CPU进行支撑，CPU可以明确的分辨出来自GuestOS的特权指令，并针对GuestOS进行特权操作，而不会影响到HostOS。</p>
<p>硬件辅助全虚拟化需要物理硬件的支持，比如需要CPU必须支持并且打开虚拟化功能，例如Intel的 Intel VT-X/EPT，AMD的AMD-V/RVI，以在CPU 层面支持虚拟化功能和内存虚拟化技术</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">全虚拟化软件(硬件辅助全虚拟化)：</span><br><span class="line">vmware esxi</span><br><span class="line">Xen3.0</span><br><span class="line">KVM</span><br><span class="line">Microsoft Hyper-V</span><br><span class="line">vmware workstation #https://www.vmware.com/cn/products/workstation-pro.html</span><br><span class="line">VirtualBox</span><br><span class="line">paralles desktop </span><br></pre></td></tr></table></figure>

<p><strong>KVM 是硬件辅助的虚拟化技术</strong></p>
<p>主要负责比较繁琐的 CPU 和内存虚拟化，而 Qemu 则负责 I/O 虚拟化，两者合作各自发挥自身的功能</p>
<h3 id="半虚拟化-para-virtualization"><a href="#半虚拟化-para-virtualization" class="headerlink" title="半虚拟化 para virtualization"></a>半虚拟化 para virtualization</h3><p><img src="../../../../images/SRE/day41/11.jpg" alt="11"></p>
<p>半虚拟化是需要GuestOS协助的虚拟化。因为在半虚拟化VMM中运行的GuestOS，都需要将其内核源码进行都进过了特别的修改。</p>
<p>通过修改客户操作系统代码，将原来在物理机上执行的一些特权指令(主要是修改GuestOS指令集中的敏感指令和核心态指令)，修改成可以和VMM直接交互的方式，实现操作系统的定制化。这样，就不会有捕获异常、翻译和模拟的过程，性能损耗比较少。</p>
<p>半虚拟化VMM在处理敏感指令和内核态指令的流程上相对更简单一些。让HostOS在捕抓到GuestOS内核态指令或敏感指令时，HostOS也能够准确的判断出该指令是否属于GuestOS(GuestOS知道自己是虚拟机)。这样就可以高效的避免了上述问题。典型的半虚拟化软件有——Xen、KVM-PowerPC(简易指令集)</p>
<p>半虚拟化除了修改内核外还有另外一种实现方法——在每一个GuestOS中安装半虚拟化软件，如: VMTools、RHEVTools。</p>
<p><strong>注意：</strong>若使用KVM运行Windows时，一定要安装半虚拟化驱动Tools，否则无法工作。现在主流的半虚拟化驱动是由IBM和redhat联合开发一个通用半虚拟机驱动virtio 。</p>
<p>半虚拟化要求guest OS 的内核是知道自己运行在虚拟化环境当中的，因此guest OS的系统架构必须和宿主机的系统架构相同，并且要求对guest OS的内核做相应的修改，因此半虚拟化只支持开源内核的系统，不支持闭源的系统，比较常见的半虚拟化就是早期版本的XEN，但是Xen 从其3.0 版本开始，可以支持利用硬件辅助虚拟化技术</p>
<h1 id="KVM架构和部署"><a href="#KVM架构和部署" class="headerlink" title="KVM架构和部署"></a>KVM架构和部署</h1><h2 id="KVM-概述"><a href="#KVM-概述" class="headerlink" title="KVM 概述"></a>KVM 概述</h2><h3 id="KVM-介绍"><a href="#KVM-介绍" class="headerlink" title="KVM 介绍"></a>KVM 介绍</h3><p><img src="../../../../images/SRE/day41/12.jpg" alt="12"></p>
<p>KVM（ Kernel-based Virtual Machine）是一个完整的虚拟化解决方案，适用于包含虚拟化扩展（Intel VT或AMD-V）的x86硬件上的Linux。目前也支持ARM等其它硬件平台. 它由可加载的内核模块kvm.ko组成，它提供核心虚拟化基础架构和处理器特定模块，kvm-intel.ko或kvm-amd.ko，KVM的用户空间组件包含在QEMU1.3后续版本中，KVM目前已成为学术界的主流 VMM (virtual machine monitor，虚拟机监视器，也称为 hypervisor)之一</p>
<p>KVM是开源软件，可运行多个运行未修改的Linux或Windows映像的虚拟机</p>
<p>依赖于HVM；Intel VT-x， AMD AMD-V</p>
<p>官网： <a target="_blank" rel="noopener" href="https://www.linux-kvm.org/">https://www.Linux-kvm.org</a></p>
<p>2006年10月，以色列 Qumranet 公司发布 KVM，早期开发者 Avi Kivity</p>
<p>2007年2月，KVM内核组件收录至Linux 2.6.20及后续版本中</p>
<p>2008年9月，Redhat 1.7亿美元收购</p>
<p>2009年9月， RHEL5.4 中在集成XEN的同时，也将KVM添加进来</p>
<p>2011年11月，RHEL6使用KVM代替XEN</p>
<p><img src="../../../../images/SRE/day41/13.jpg" alt="13"></p>
<p><strong>红帽 kvm 介绍</strong></p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://www.redhat.com/zh/topics/virtualization/what-is-KVM</span><br></pre></td></tr></table></figure>

<p><strong>RedHat虚拟化指南</strong></p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://access.redhat.com/documentation/zh-cn/red_hat_enterprise_Linux/7/html/virtualization_getting_started_guide/index</span><br></pre></td></tr></table></figure>

<p><strong>RedHat创建虚拟机数量限制：</strong></p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://access.redhat.com/articles/rhel-kvm-limits</span><br></pre></td></tr></table></figure>

<p><img src="../../../../images/SRE/day41/14.jpg" alt="14"></p>
<h3 id="KVM架构"><a href="#KVM架构" class="headerlink" title="KVM架构"></a>KVM架构</h3><p>KVM 是基于虚拟化扩展（Intel VT 或者 AMD-V）的 X86 硬件的开源的 Linux 原生的全虚拟化解决方案。KVM 中，虚拟机被实现为常规的 Linux 进程，由标准 Linux 调度程序进行调度；虚机的每个虚拟CPU被实现为一个常规的 Linux 进程。这使得 KVM 能够使用 Linux 内核的已有功能。</p>
<p>但是，KVM 本身不执行任何硬件模拟，需要客户空间程序通过 /dev/kvm 接口设置一个客户机虚拟服务器的地址空间，向它提供模拟的 I/O，并将它的视频显示映射回宿主的显示屏。目前这个应用程序使用QEMU。</p>
<h4 id="KVM-体系结构"><a href="#KVM-体系结构" class="headerlink" title="KVM 体系结构"></a>KVM 体系结构</h4><p><img src="../../../../images/SRE/day41/15.jpg" alt="15"></p>
<ul>
<li>KVM： 初始化CPU硬件，打开虚拟机模式，负责CPU，内存，中断控制器，时钟. 由内核模块kvm_xxx.ko实现，工作于hypervisor，设备/dev/kvm，是一个字符设备，在用户空间可通过ioctl()系统调用来完成VM创建、启动，为VM分配内存、读写VCPU的寄存器、向VCPU注入中断、时钟等管理功能 </li>
<li>QEMU进程：工作于用户空间，主要用于实现模拟IO设备，如显卡，网卡，硬盘等， qemu-kvm进程：工作于用户空间，用于实现一个虚拟机实例 </li>
<li>Libvirt：提供统一API，守护进程libvirtd和相关工具，如:virsh，virt-manager等</li>
</ul>
<h4 id="KVM-模块载入后的系统的运行模式"><a href="#KVM-模块载入后的系统的运行模式" class="headerlink" title="KVM 模块载入后的系统的运行模式"></a>KVM 模块载入后的系统的运行模式</h4><p><img src="../../../../images/SRE/day41/16.jpg" alt="16"></p>
<p>内核模式：HostOS执行I/O类操作，或其它的特殊指令的操作；称作内核模式</p>
<p>用户模式：GuestOS的I/O类操作</p>
<p>来宾模式：GuestOS非I/O类操作，称作虚拟机的用户模式更贴切</p>
<h3 id="KVM-集中管理与控制"><a href="#KVM-集中管理与控制" class="headerlink" title="KVM 集中管理与控制"></a>KVM 集中管理与控制</h3><p>KVM是运行在单机的系统，需要其它软件实现跨主机的统一的管理。常见的虚拟化管理平台如下： </p>
<p><a target="_blank" rel="noopener" href="http://www.linux-kvm.org/page/Management_Tools">http://www.Linux-kvm.org/page/Management_Tools</a></p>
<p><img src="../../../../images/SRE/day41/17.jpg" alt="17"></p>
<ul>
<li><p>oVirt</p>
<p>功能强大，是Redhat虚拟化管理平台RHEV的开源版本。</p>
<p><a target="_blank" rel="noopener" href="http://www.ovirt.org/">http://www.ovirt.org/</a></p>
</li>
<li><p>WebVirtMgr</p>
<p><a target="_blank" rel="noopener" href="https://www.webvirtmgr.net/">https://www.webvirtmgr.net</a></p>
<p>virt-manager的Web模式的替代品</p>
</li>
<li><p>OpenStack</p>
<p>最主流的开源虚拟化管理平台</p>
</li>
<li><p>Proxmox virtualization environment</p>
<p>简称PVE，是一个开源免费的基于Linux的企业级虚拟化方案，功能不输专业收费的VMware。是一个完整的企业虚拟化开源平台。借助内置的Web界面，您可以轻松管理VM和容器，软件定义的存储和网络，高可用性集群以及单个解决方案上的多个开箱即用工具。</p>
</li>
</ul>
<h2 id="宿主机环境准备"><a href="#宿主机环境准备" class="headerlink" title="宿主机环境准备"></a>宿主机环境准备</h2><p>KVM需要宿主机CPU必须支持虚拟化功能，因此如果是在vmware workstation上使用虚拟机做宿主机，那么必须要在虚拟机配置界面的处理器选项中开启虚拟机化功能。</p>
<h3 id="CPU开启虚拟化"><a href="#CPU开启虚拟化" class="headerlink" title="CPU开启虚拟化"></a>CPU开启虚拟化</h3><p>注意： 给宿主机的CPU和内存分配足够多的配置</p>
<p><img src="../../../../images/SRE/day41/18.jpg" alt="18"></p>
<h3 id="验证开启虚拟化"><a href="#验证开启虚拟化" class="headerlink" title="验证开启虚拟化"></a>验证开启虚拟化</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">grep -Em 1  <span class="string">&quot;vmx|svm&quot;</span> /proc/cpuinfo </span><br><span class="line"></span><br><span class="line"><span class="comment">#Intel CPU 对应 vmx</span></span><br><span class="line"><span class="comment">#AMD CPU 对应 svm </span></span><br></pre></td></tr></table></figure>

<p>范例: 验证是否开启虚拟化支持</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ~]<span class="comment"># grep -Em 1 &quot;vmx|svm&quot; /proc/cpuinfo </span></span><br><span class="line">flags : fpu vme de pse tsc msr pae mce cx8 apic sep mtrr pge mca cmov pat </span><br><span class="line">pse36 clflush mmx fxsr sse sse2 syscall nx mmxext fxsr_opt pdpe1gb rdtscp lm </span><br><span class="line">constant_tsc rep_good nopl tsc_reliable nonstop_tsc cpuid extd_apicid pni </span><br><span class="line">pclmulqdq ssse3 fma cx16 sse4_1 sse4_2 x2apic movbe popcnt aes xsave avx f16c </span><br><span class="line">rdrand hypervisor lahf_lm svm extapic cr8_legacy abm sse4a misalignsse </span><br><span class="line">3dnowprefetch osvw ssbd ibpb vmmcall fsgsbase bmi1 avx2 smep bmi2 rdseed adx smap </span><br><span class="line">clflushopt clwb sha_ni xsaveopt xsavec xsaves clzero arat npt svm_lock nrip_save </span><br><span class="line">vmcb_clean flushbyasid decodeassists overflow_recov succor</span><br></pre></td></tr></table></figure>

<p><img src="../../../../images/SRE/day41/19.jpg" alt="19"><br><img src="../../../../images/SRE/day41/20.jpg" alt="20"></p>
<p>范例: 查看AMD主机的内核模块</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ~]<span class="comment"># lscpu|grep svm</span></span><br><span class="line">Flags:               fpu vme de pse tsc msr pae mce cx8 apic sep mtrr pge mca </span><br><span class="line">cmov pat pse36 clflush mmx fxsr sse sse2 syscall nx mmxext fxsr_opt pdpe1gb </span><br><span class="line">rdtscp lm constant_tsc rep_good nopl tsc_reliable nonstop_tsc cpuid extd_apicid </span><br><span class="line">pni pclmulqdq ssse3 fma cx16 sse4_1 sse4_2 x2apic movbe popcnt aes xsave avx f16c </span><br><span class="line">rdrand hypervisor lahf_lm svm extapic cr8_legacy abm sse4a misalignsse </span><br><span class="line">3dnowprefetch osvw ssbd ibpb vmmcall fsgsbase bmi1 avx2 smep bmi2 rdseed adx smap </span><br><span class="line">clflushopt clwb sha_ni xsaveopt xsavec xsaves clzero arat npt svm_lock nrip_save </span><br><span class="line">vmcb_clean flushbyasid decodeassists overflow_recov succor</span><br><span class="line"></span><br><span class="line">[root@centos8 ~]<span class="comment"># lsmod |grep kvm</span></span><br><span class="line">kvm_amd               110592  0</span><br><span class="line">ccp                    98304  1 kvm_amd</span><br><span class="line">kvm                   786432  1 kvm_amd</span><br><span class="line">irqbypass              16384  1 kvm</span><br><span class="line"></span><br><span class="line">[root@centos8 ~]<span class="comment"># ll /dev/kvm</span></span><br><span class="line">crw-rw-rw- 1 root kvm 10, 232 Sep 13 21:21 /dev/kvm </span><br></pre></td></tr></table></figure>

<h2 id="安装KVM工具包"><a href="#安装KVM工具包" class="headerlink" title="安装KVM工具包"></a>安装KVM工具包</h2><h3 id="KVM-相关工具包介绍"><a href="#KVM-相关工具包介绍" class="headerlink" title="KVM 相关工具包介绍"></a>KVM 相关工具包介绍</h3><ul>
<li>qemu-kvm: 为kvm提供底层仿真支持</li>
<li>libvirt-daemon: libvirtd守护进程，管理虚拟机</li>
<li>libvirt-client: 用户端软件，提供客户端管理命令</li>
<li>libvirt-daemon-driver-qemu: libvirtd连接qemu的驱动</li>
<li>libvirt: 使用最多的KVM虚拟化管理工具和应用程序接口，即通过libvirt调用KVM创建虚拟机，libvirt是KVM通用的访问API，其不但能管理KVM，还能管理VMware、Xen、Hyper-V、virtualBox等虚拟化方案。</li>
<li>virt-manager: 图形界面管理工具，其底层也是调用libvirt API来完成对虚拟机的操作，包括虚拟机的创建、删除、启动、停止以及一些简单的监控功能等。</li>
<li>virt-install: 虚拟机命令行安装工具</li>
<li>virsh: 命令行工具是基于 libvirt API 创建的命令行工具，它可以作为图形化的 virt-manager 应用的备选工具。virsh 命令可以被用来创建虚拟化任务管理脚本，如安装、启动和停止虚拟机</li>
<li>virt-viewer: 通过 VNC 和 SPICE 协议显示虚拟机器图形控制台的最小工具。该工具在其同名软件包中：virtviewer</li>
<li>cockpit: CentOS8 专门提供的基于Web的虚拟机管理界面</li>
</ul>
<h3 id="libvirt-包功能"><a href="#libvirt-包功能" class="headerlink" title="libvirt 包功能"></a>libvirt 包功能</h3><h4 id="libvirt-介绍"><a href="#libvirt-介绍" class="headerlink" title="libvirt 介绍"></a>libvirt 介绍</h4><p><img src="../../../../images/SRE/day41/21.jpg" alt="21"></p>
<p>libvirt 程序包是一个与虚拟机监控程序相独立的虚拟化应用程序接口，它可以与操作系统的一系列虚拟化性能进行交互</p>
<p>libvirt 程序包提供：</p>
<ul>
<li>一个稳定的通用层来安全地管理主机上的虚拟机。</li>
<li>一个管理本地系统和连网主机的通用接口。</li>
</ul>
<p>在虚拟机监控程序支持的情况下，部署、创建、修改、监测、控制、迁移以及停止虚拟机操作都需要这些API。尽管 libvirt 可同时访问多个主机，但 API 只限于单节点操作</p>
<p>libvirt 程序包被设计为用来构建高级管理工具和应用程序，例如 virt-manager 与 virsh 命令行管理工具。libvirt 主要的功能是管理单节点主机，并提供 API 来列举、监测和使用管理节点上的可用资源，其中包括CPU、内存、储存、网络和非一致性内存访问（NUMA）分区。管理工具可以位于独立于主机的物理机上，并通过安全协议和主机进行交流</p>
<h4 id="libvirt-结构图"><a href="#libvirt-结构图" class="headerlink" title="libvirt 结构图"></a>libvirt 结构图</h4><p><img src="../../../../images/SRE/day41/22.jpg" alt="22"></p>
<h3 id="安装KVM相关包"><a href="#安装KVM相关包" class="headerlink" title="安装KVM相关包"></a>安装KVM相关包</h3><h4 id="Ubuntu-安装-KVM"><a href="#Ubuntu-安装-KVM" class="headerlink" title="Ubuntu 安装 KVM"></a>Ubuntu 安装 KVM</h4><p>Ubuntu 18.04：</p>
<p>官方文档: <a target="_blank" rel="noopener" href="https://ubuntu.com/server/docs/virtualization-libvirt">https://ubuntu.com/server/docs/virtualization-libvirt</a></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[root@ubuntu2204 ~]<span class="comment"># apt -y install cpu-checker</span></span><br><span class="line">[root@ubuntu2004 ~]<span class="comment"># apt -y install cpu-checker</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#如果CPU不支持会如下提示</span></span><br><span class="line">[root@ubuntu2004 ~]<span class="comment"># kvm-ok</span></span><br><span class="line">INFO: Your CPU does not support KVM extensions</span><br><span class="line">KVM acceleration can NOT be used</span><br><span class="line"></span><br><span class="line"><span class="comment"># apt install qemu-kvm virt-manager libvirt-daemon-system</span></span><br><span class="line"><span class="comment"># kvm-ok #验证是否支持kvm，只有Ubuntu支持，CentOS 不支持</span></span><br><span class="line"><span class="comment">#如果CPU支持，如下提示</span></span><br><span class="line">INFO: /dev/kvm exists</span><br><span class="line">KVM acceleration can be used</span><br></pre></td></tr></table></figure>

<p>范例:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">[root@ubuntu2004 ~]<span class="comment"># apt update</span></span><br><span class="line">[root@ubuntu2204 ~]<span class="comment"># apt -y install qemu-kvm virt-manager libvirt-daemon-system</span></span><br><span class="line">[root@ubuntu2004 ~]<span class="comment"># apt -y install qemu-kvm virt-manager libvirt-daemon-system</span></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment"># apt -y install qemu-kvm virt-manager libvirt-daemon-system</span></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment"># ip a</span></span><br><span class="line">1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group </span><br><span class="line">default qlen 1000</span><br><span class="line">   <span class="built_in">link</span>/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00</span><br><span class="line">   inet 127.0.0.1/8 scope host lo</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">   inet6 ::1/128 scope host </span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">2: eth0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc fq_codel state UP </span><br><span class="line">group default qlen 1000</span><br><span class="line">   <span class="built_in">link</span>/ether 00:0c:29:40:27:06 brd ff:ff:ff:ff:ff:ff</span><br><span class="line">   inet 10.0.0.100/24 brd 10.0.0.255 scope global eth0</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">   inet6 fe80::20c:29ff:fe40:2706/64 scope <span class="built_in">link</span> </span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">3: virbr0: &lt;NO-CARRIER,BROADCAST,MULTICAST,UP&gt; mtu 1500 qdisc noqueue state DOWN </span><br><span class="line">group default qlen 1000</span><br><span class="line">   <span class="built_in">link</span>/ether 52:54:00:8d:a6:fe brd ff:ff:ff:ff:ff:ff</span><br><span class="line">   inet 192.168.122.1/24 brd 192.168.122.255 scope global virbr0</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">4: virbr0-nic: &lt;BROADCAST,MULTICAST&gt; mtu 1500 qdisc fq_codel master virbr0 state </span><br><span class="line">DOWN group default qlen 1000</span><br><span class="line">   <span class="built_in">link</span>/ether 52:54:00:8d:a6:fe brd ff:ff:ff:ff:ff:ff</span><br><span class="line"></span><br><span class="line">[root@ubuntu2204 ~]<span class="comment"># apt -y install bridge-utils</span></span><br><span class="line">[root@ubuntu2204 ~]<span class="comment"># brctl show </span></span><br><span class="line">bridge name bridge <span class="built_in">id</span> STP enabled interfaces</span><br><span class="line">virbr0 8000.5254005655f6 <span class="built_in">yes</span> </span><br><span class="line"></span><br><span class="line"><span class="comment">#如果没有开启CPU虚拟化功能会提示以下信息</span></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment"># kvm-ok</span></span><br><span class="line">INFO: Your CPU does not support KVM extensions</span><br><span class="line">KVM acceleration can NOT be used</span><br><span class="line"></span><br><span class="line"><span class="comment">#添加CPU的虚拟化支持再执行</span></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment"># kvm-ok</span></span><br><span class="line">INFO: /dev/kvm exists</span><br><span class="line">KVM acceleration can be used</span><br></pre></td></tr></table></figure>

<h4 id="CentOS-安装-KVM"><a href="#CentOS-安装-KVM" class="headerlink" title="CentOS 安装 KVM"></a>CentOS 安装 KVM</h4><p>使用虚拟化，需要至少 qemu-kvm 和 qemu-img(安装qemu-kvm会自动安装) 软件包</p>
<p>建议安装：<code>yum install qemu-kvm libvirt virt-manager virt-install</code></p>
<p>范例: CentOS 8 安装 KVM相关工具</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ~]<span class="comment"># yum -y install qemu-kvm libvirt   virt-manager virt-install virt-viewer</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># systemctl enable --now libvirtd</span></span><br></pre></td></tr></table></figure>

<p>范例: CentOS 8 还提供基于Web的虚拟机管理方式</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ~]<span class="comment"># yum -y install cockpit cockpit-machines</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># systemctl enable --now cockpit.socket </span></span><br><span class="line">Created symlink /etc/systemd/system/sockets.target.wants/cockpit.socket → </span><br><span class="line">/usr/lib/systemd/system/cockpit.socket.</span><br><span class="line"></span><br><span class="line"><span class="comment">#打开浏览器，访问以下地址：</span></span><br><span class="line">https://centos8主机:9090</span><br></pre></td></tr></table></figure>

<p><img src="../../../../images/SRE/day41/23.jpg" alt="23"></p>
<h3 id="图形化工具-virt-manager"><a href="#图形化工具-virt-manager" class="headerlink" title="图形化工具 virt-manager"></a>图形化工具 virt-manager</h3><p>范例: CentOS 上管理工具 virt-manager</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ~]<span class="comment"># export DISPLAY=10.0.0.1:0.0</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># virt-manager </span></span><br><span class="line">libGL error: No matching fbConfigs or visuals found</span><br><span class="line">libGL error: failed to load driver: swrast</span><br><span class="line"></span><br><span class="line"><span class="comment">#如果出现乱码，设置语言</span></span><br><span class="line">[root@ubuntu2204 ~]<span class="comment"># localectl set-locale LANG=en_US.UTF-8;exit</span></span><br></pre></td></tr></table></figure>

<p><img src="../../../../images/SRE/day41/24.jpg" alt="24"></p>
<p>范例: Ubuntu 上管理工具 virt-manager</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@ubuntu1804 ~]<span class="comment"># virt-manager</span></span><br></pre></td></tr></table></figure>

<p><img src="../../../../images/SRE/day41/25.jpg" alt="25"></p>
<h3 id="默认网络配置"><a href="#默认网络配置" class="headerlink" title="默认网络配置"></a>默认网络配置</h3><p>安装完虚拟工具后，会自动生成一个 virbr0 网卡，类似于Vmware workstation 生成的VMnet8 网卡，充当虚拟机的 NAT 网卡</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ~]<span class="comment"># ip a</span></span><br><span class="line">1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group </span><br><span class="line">default qlen 1000</span><br><span class="line">   <span class="built_in">link</span>/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00</span><br><span class="line">   inet 127.0.0.1/8 scope host lo</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">   inet6 ::1/128 scope host </span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">2: eth0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc fq_codel state UP </span><br><span class="line">group default qlen 1000</span><br><span class="line">   <span class="built_in">link</span>/ether 00:0c:29:8a:51:21 brd ff:ff:ff:ff:ff:ff</span><br><span class="line">   inet 10.0.0.8/24 brd 10.0.0.255 scope global noprefixroute eth0</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">   inet6 fe80::20c:29ff:fe8a:5121/64 scope <span class="built_in">link</span> </span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">3: virbr0: &lt;NO-CARRIER,BROADCAST,MULTICAST,UP&gt; mtu 1500 qdisc noqueue state DOWN </span><br><span class="line">group default qlen 1000</span><br><span class="line">   <span class="built_in">link</span>/ether 52:54:00:97:eb:e3 brd ff:ff:ff:ff:ff:ff</span><br><span class="line">   inet 192.168.122.1/24 brd 192.168.122.255 scope global virbr0</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">4: virbr0-nic: &lt;BROADCAST,MULTICAST&gt; mtu 1500 qdisc fq_codel master virbr0 state </span><br><span class="line">DOWN group default qlen 1000</span><br><span class="line">   <span class="built_in">link</span>/ether 52:54:00:97:eb:e3 brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    </span><br><span class="line">[root@centos8 ~]<span class="comment"># grep -R 192.168.122.1 /etc/libvirt/*</span></span><br><span class="line">/etc/libvirt/qemu/networks/autostart/default.xml: &lt;ip address=<span class="string">&#x27;192.168.122.1&#x27;</span> netmask=<span class="string">&#x27;255.255.255.0&#x27;</span>&gt;</span><br><span class="line">/etc/libvirt/qemu/networks/default.xml: &lt;ip address=<span class="string">&#x27;192.168.122.1&#x27;</span> netmask=<span class="string">&#x27;255.255.255.0&#x27;</span>&gt;</span><br><span class="line"></span><br><span class="line">[root@centos8 ~]<span class="comment"># ip a show virbr0</span></span><br><span class="line">3: virbr0: &lt;NO-CARRIER,BROADCAST,MULTICAST,UP&gt; mtu 1500 qdisc noqueue state DOWN </span><br><span class="line">group default qlen 1000</span><br><span class="line">   <span class="built_in">link</span>/ether 52:54:00:97:eb:e3 brd ff:ff:ff:ff:ff:ff</span><br><span class="line">   inet 192.168.122.1/24 brd 192.168.122.255 scope global virbr0</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line"></span><br><span class="line">[root@centos8 ~]<span class="comment"># cat /etc/libvirt/qemu/networks/default.xml</span></span><br><span class="line">&lt;network&gt;</span><br><span class="line"> &lt;name&gt;default&lt;/name&gt;</span><br><span class="line"> &lt;uuid&gt;1ebc4504-5da9-4b7e-b367-90b8cb20029b&lt;/uuid&gt;</span><br><span class="line"> &lt;forward mode=<span class="string">&#x27;nat&#x27;</span>/&gt;</span><br><span class="line"> &lt;bridge name=<span class="string">&#x27;virbr0&#x27;</span> stp=<span class="string">&#x27;on&#x27;</span> delay=<span class="string">&#x27;0&#x27;</span>/&gt;</span><br><span class="line"> &lt;mac address=<span class="string">&#x27;52:54:00:97:eb:e3&#x27;</span>/&gt;</span><br><span class="line"> &lt;ip address=<span class="string">&#x27;192.168.122.1&#x27;</span> netmask=<span class="string">&#x27;255.255.255.0&#x27;</span>&gt;</span><br><span class="line">   &lt;dhcp&gt;</span><br><span class="line">     &lt;range start=<span class="string">&#x27;192.168.122.2&#x27;</span> end=<span class="string">&#x27;192.168.122.254&#x27;</span>/&gt;</span><br><span class="line">   &lt;/dhcp&gt;</span><br><span class="line"> &lt;/ip&gt;</span><br><span class="line">&lt;/network&gt;</span><br><span class="line"></span><br><span class="line">[root@centos8 ~]<span class="comment"># nmcli connection show virbr0 </span></span><br><span class="line">connection.id:                          virbr0</span><br><span class="line">connection.uuid:                        54c671c1-28be-4ce7-8a0e-30ee0ecdca64</span><br><span class="line">connection.stable-id:                   --</span><br><span class="line">connection.type:                        bridge</span><br><span class="line">connection.interface-name:              virbr0</span><br><span class="line">connection.autoconnect:                 no</span><br><span class="line">connection.autoconnect-priority:        0</span><br><span class="line">connection.autoconnect-retries:         -1 (default)</span><br><span class="line">connection.multi-connect:               0 (default)</span><br><span class="line">connection.auth-retries:                -1</span><br><span class="line">connection.timestamp:                   1596945412</span><br><span class="line">connection.read-only:                   no</span><br><span class="line">connection.permissions:                 --</span><br><span class="line">connection.zone:                        --</span><br><span class="line">connection.master:                      --</span><br><span class="line">connection.slave-type:                  --</span><br><span class="line">connection.autoconnect-slaves:          -1 (default)</span><br><span class="line">connection.secondaries:                 --</span><br><span class="line">connection.gateway-ping-timeout:        0</span><br><span class="line">connection.metered:                     unknown</span><br><span class="line">connection.lldp:                        default</span><br><span class="line">connection.mdns:                        -1 (default)</span><br><span class="line">connection.llmnr:                       -1 (default)</span><br><span class="line">connection.wait-device-timeout:         -1</span><br><span class="line">ipv4.method:                            manual</span><br><span class="line">ipv4.dns:                               --</span><br><span class="line">ipv4.dns-search:                        --</span><br><span class="line">ipv4.dns-options:                       --</span><br><span class="line">ipv4.dns-priority:                      100</span><br><span class="line">ipv4.addresses:                         192.168.122.1/24</span><br><span class="line">ipv4.gateway:                           --</span><br><span class="line">ipv4.routes:                            --</span><br><span class="line">ipv4.route-metric:                      -1</span><br><span class="line">ipv4.route-table:                       0 (unspec)</span><br><span class="line">ipv4.routing-rules:                     --</span><br><span class="line">ipv4.ignore-auto-routes:                no</span><br><span class="line">ipv4.ignore-auto-dns:                   no</span><br><span class="line">ipv4.dhcp-client-id:                    --</span><br><span class="line">ipv4.dhcp-iaid:                         --</span><br><span class="line">ipv4.dhcp-timeout:                      0 (default)</span><br><span class="line">ipv4.dhcp-send-hostname:                <span class="built_in">yes</span></span><br><span class="line">ipv4.dhcp-hostname:                     --</span><br><span class="line">ipv4.dhcp-fqdn:                         --</span><br><span class="line">ipv4.dhcp-hostname-flags:               0x0 (none)</span><br><span class="line">ipv4.never-default:                     no</span><br><span class="line">ipv4.may-fail:                          <span class="built_in">yes</span></span><br><span class="line">ipv4.dad-timeout:                       -1 (default)</span><br><span class="line">ipv6.method:                            ignore</span><br><span class="line">ipv6.dns:                               --</span><br><span class="line">ipv6.dns-search:                        --</span><br><span class="line">ipv6.dns-options:                       --</span><br><span class="line">ipv6.dns-priority:                      100</span><br><span class="line">ipv6.addresses:                         --</span><br><span class="line">ipv6.gateway:                           --</span><br><span class="line">ipv6.routes:                            --</span><br><span class="line">ipv6.route-metric:                      -1</span><br><span class="line">ipv6.route-table:                       0 (unspec)</span><br><span class="line">ipv6.routing-rules:                     --</span><br><span class="line">ipv6.ignore-auto-routes:                no</span><br><span class="line">ipv6.ignore-auto-dns:                   no</span><br><span class="line">ipv6.never-default:                     no</span><br><span class="line">ipv6.may-fail:                          <span class="built_in">yes</span></span><br><span class="line">ipv6.ip6-privacy:                       -1 (unknown)</span><br><span class="line">ipv6.addr-gen-mode:                     stable-privacy</span><br><span class="line">ipv6.ra-timeout:                        0 (default)</span><br><span class="line">ipv6.dhcp-duid:                         --</span><br><span class="line">ipv6.dhcp-iaid:                         --</span><br><span class="line">ipv6.dhcp-timeout:                      0 (default)</span><br><span class="line">ipv6.dhcp-send-hostname:                <span class="built_in">yes</span></span><br><span class="line">ipv6.dhcp-hostname:                     --</span><br><span class="line">ipv6.dhcp-hostname-flags:               0x0 (none)</span><br><span class="line">ipv6.token:                             --</span><br><span class="line">bridge.mac-address:                     --</span><br><span class="line">bridge.stp:                             <span class="built_in">yes</span></span><br><span class="line">bridge.priority:                        32768</span><br><span class="line">bridge.forward-delay:                   2</span><br><span class="line">bridge.hello-time:                      2</span><br><span class="line">bridge.max-age:                         20</span><br><span class="line">bridge.ageing-time:                     300</span><br><span class="line">bridge.group-forward-mask:              0</span><br><span class="line">bridge.multicast-snooping:              <span class="built_in">yes</span></span><br><span class="line">bridge.vlan-filtering:                  no</span><br><span class="line">bridge.vlan-default-pvid:               1</span><br><span class="line">bridge.vlans:                           --</span><br><span class="line">proxy.method:                           none</span><br><span class="line">proxy.browser-only:                     no</span><br><span class="line">proxy.pac-url:                          --</span><br><span class="line">proxy.pac-script:                       --</span><br><span class="line">GENERAL.NAME:                           virbr0</span><br><span class="line">GENERAL.UUID:                           54c671c1-28be-4ce7-8a0e-30ee0ecdca64</span><br><span class="line">GENERAL.DEVICES:                        virbr0</span><br><span class="line">GENERAL.IP-IFACE:                       virbr0</span><br><span class="line">GENERAL.STATE:                          activated</span><br><span class="line">GENERAL.DEFAULT:                        no</span><br><span class="line">GENERAL.DEFAULT6:                       no</span><br><span class="line">GENERAL.SPEC-OBJECT:                    --</span><br><span class="line">GENERAL.VPN:                            no</span><br><span class="line">GENERAL.DBUS-PATH:                      /org/freedesktop/NetworkManager/ActiveConnection/3</span><br><span class="line">GENERAL.CON-PATH:                       /org/freedesktop/NetworkManager/Settings/2</span><br><span class="line">GENERAL.ZONE:                           --</span><br><span class="line">GENERAL.MASTER-PATH:                    --</span><br><span class="line">IP4.ADDRESS[1]:                         192.168.122.1/24</span><br><span class="line">IP4.GATEWAY:                            --</span><br><span class="line">IP4.ROUTE[1]:                           dst = 192.168.122.0/24, nh = 0.0.0.0, mt = 0</span><br><span class="line">IP6.GATEWAY:                            --</span><br></pre></td></tr></table></figure>

<p>范例: Ubuntu 网络配置</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">[root@ubuntu1804 ~]<span class="comment"># ip a</span></span><br><span class="line">1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group </span><br><span class="line">default qlen 1000</span><br><span class="line">   <span class="built_in">link</span>/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00</span><br><span class="line">   inet 127.0.0.1/8 scope host lo</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">   inet6 ::1/128 scope host </span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">2: eth0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc fq_codel state UP </span><br><span class="line">group default qlen 1000</span><br><span class="line">   <span class="built_in">link</span>/ether 00:0c:29:40:27:06 brd ff:ff:ff:ff:ff:ff</span><br><span class="line">   inet 10.0.0.100/24 brd 10.0.0.255 scope global eth0</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">   inet6 fe80::20c:29ff:fe40:2706/64 scope <span class="built_in">link</span> </span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">3: virbr0: &lt;NO-CARRIER,BROADCAST,MULTICAST,UP&gt; mtu 1500 qdisc noqueue state DOWN </span><br><span class="line">group default qlen 1000</span><br><span class="line">   <span class="built_in">link</span>/ether 52:54:00:8d:a6:fe brd ff:ff:ff:ff:ff:ff</span><br><span class="line">   inet 192.168.122.1/24 brd 192.168.122.255 scope global virbr0</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">4: virbr0-nic: &lt;BROADCAST,MULTICAST&gt; mtu 1500 qdisc fq_codel master virbr0 state </span><br><span class="line">DOWN group default qlen 1000</span><br><span class="line">   <span class="built_in">link</span>/ether 52:54:00:8d:a6:fe brd ff:ff:ff:ff:ff:ff</span><br><span class="line">   </span><br><span class="line">[root@ubuntu1804 ~]<span class="comment"># brctl show</span></span><br><span class="line">bridge name bridge <span class="built_in">id</span> STP enabled interfaces</span><br><span class="line">virbr0 8000.5254008da6fe <span class="built_in">yes</span> virbr0-nic</span><br><span class="line"></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment"># cat /etc/libvirt/qemu/networks/default.xml </span></span><br><span class="line">&lt;network&gt;</span><br><span class="line"> &lt;name&gt;default&lt;/name&gt;</span><br><span class="line"> &lt;uuid&gt;a3235b68-6dc0-4951-8a35-7a60a567f1a7&lt;/uuid&gt;</span><br><span class="line"> &lt;forward mode=<span class="string">&#x27;nat&#x27;</span>/&gt;</span><br><span class="line"> &lt;bridge name=<span class="string">&#x27;virbr0&#x27;</span> stp=<span class="string">&#x27;on&#x27;</span> delay=<span class="string">&#x27;0&#x27;</span>/&gt;</span><br><span class="line"> &lt;mac address=<span class="string">&#x27;52:54:00:8d:a6:fe&#x27;</span>/&gt;</span><br><span class="line"> &lt;ip address=<span class="string">&#x27;192.168.122.1&#x27;</span> netmask=<span class="string">&#x27;255.255.255.0&#x27;</span>&gt;</span><br><span class="line">   &lt;dhcp&gt;</span><br><span class="line">     &lt;range start=<span class="string">&#x27;192.168.122.2&#x27;</span> end=<span class="string">&#x27;192.168.122.254&#x27;</span>/&gt;</span><br><span class="line">   &lt;/dhcp&gt;</span><br><span class="line"> &lt;/ip&gt;</span><br><span class="line">&lt;/network&gt;</span><br></pre></td></tr></table></figure>

<h2 id="准备安装系统的ISO相关文件"><a href="#准备安装系统的ISO相关文件" class="headerlink" title="准备安装系统的ISO相关文件"></a>准备安装系统的ISO相关文件</h2><p>将需要安装的系统的ISO文件上传到宿主机</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ~]<span class="comment"># mkdir -pv /data/isos/</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># ls /data/isos/</span></span><br><span class="line">CentOS-7-x86_64-Minimal-2009.iso</span><br><span class="line">CentOS-8.2.2004-x86_64-minimal.iso</span><br><span class="line">cn_Windows_server_2008_r2_standard_enterprise_datacenter_and_web_with_sp1_vl_build_x64_dvd_617396.iso</span><br></pre></td></tr></table></figure>

<h2 id="AMD-CPU-创建虚拟机时的故障排错"><a href="#AMD-CPU-创建虚拟机时的故障排错" class="headerlink" title="AMD CPU 创建虚拟机时的故障排错"></a>AMD CPU 创建虚拟机时的故障排错</h2><p>AMD CPU 使用virt-manager 或 virt-install 在创建虚拟机可能会出错，用下面方法解决</p>
<h3 id="AMD-CPU-使用virt-manager创建虚拟机出错提示"><a href="#AMD-CPU-使用virt-manager创建虚拟机出错提示" class="headerlink" title="AMD CPU 使用virt-manager创建虚拟机出错提示"></a>AMD CPU 使用virt-manager创建虚拟机出错提示</h3><p><img src="../../../../images/SRE/day41/26.jpg" alt="26"></p>
<h3 id="AMD-CPU-使用virt-install创建虚拟机出错提示"><a href="#AMD-CPU-使用virt-install创建虚拟机出错提示" class="headerlink" title="AMD CPU 使用virt-install创建虚拟机出错提示"></a>AMD CPU 使用virt-install创建虚拟机出错提示</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ~]<span class="comment"># virt-install --virt-type kvm --name centos7 --ram 1024 --vcpus 2 \</span></span><br><span class="line">--cdrom=/data/isos/CentOS-7-x86_64-Minimal-2009.iso --disk path=/var/lib/libvirt/images/centos7.qcow2 \</span><br><span class="line">--network network=default --graphics vnc,listen=0.0.0.0 --noautoconsole</span><br><span class="line"></span><br><span class="line">WARNING No operating system detected, VM performance may suffer. Specify an OS </span><br><span class="line">with --os-variant <span class="keyword">for</span> optimal results.</span><br><span class="line"></span><br><span class="line">Starting install...</span><br><span class="line">ERROR   internal error: qemu unexpectedly closed the monitor: 2020-08-09T15:57:08.872365Z qemu-kvm: error: failed to <span class="built_in">set</span> MSR 0xe1 to 0x0</span><br><span class="line">qemu-kvm: /builddir/build/BUILD/qemu-2.12.0/target/i386/kvm.c:2119: </span><br><span class="line">kvm_buf_set_msrs: Assertion `ret == cpu-&gt;kvm_msr_buf-&gt;nmsrs<span class="string">&#x27; failed.</span></span><br><span class="line"><span class="string">Domain installation does not appear to have been successful.</span></span><br><span class="line"><span class="string">If it was, you can restart your domain by running:</span></span><br><span class="line"><span class="string"> virsh --connect qemu:///system start centos7</span></span><br><span class="line"><span class="string">otherwise, please restart your installation.</span></span><br></pre></td></tr></table></figure>

<h3 id="AMD-CPU-创建虚拟机故障修复方法"><a href="#AMD-CPU-创建虚拟机故障修复方法" class="headerlink" title="AMD CPU 创建虚拟机故障修复方法"></a>AMD CPU 创建虚拟机故障修复方法</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#修复以上故障</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># tee /etc/modprobe.d/qemu-system-x86.conf &lt;&lt; EOF</span></span><br><span class="line">&gt; options kvm ignore_msrs=1</span><br><span class="line">&gt; EOF</span><br><span class="line">options kvm ignore_msrs=1</span><br><span class="line"></span><br><span class="line">[root@centos8 ~]<span class="comment"># reboot</span></span><br></pre></td></tr></table></figure>

<h1 id="创建虚拟机"><a href="#创建虚拟机" class="headerlink" title="创建虚拟机"></a>创建虚拟机</h1><h2 id="使用-virt-manager-创建虚拟机"><a href="#使用-virt-manager-创建虚拟机" class="headerlink" title="使用 virt-manager 创建虚拟机"></a>使用 virt-manager 创建虚拟机</h2><p>virt-manager 是一个图形化虚拟机管理工具，方便管理和查看虚拟机</p>
<p>注意:此方式创建虚拟机的磁盘空间为立即分配，所以不要分太大!</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ~]<span class="comment"># export DISPLAY=10.0.0.1:0.0</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># virt-manager </span></span><br><span class="line">libGL error: No matching fbConfigs or visuals found</span><br><span class="line">libGL error: failed to load driver: swrast</span><br></pre></td></tr></table></figure>

<p><img src="../../../../images/SRE/day41/27.jpg" alt="27"><br><img src="../../../../images/SRE/day41/28.jpg" alt="28"><br><img src="../../../../images/SRE/day41/29.jpg" alt="29"><br><img src="../../../../images/SRE/day41/30.jpg" alt="30"><br><img src="../../../../images/SRE/day41/31.jpg" alt="31"><br><img src="../../../../images/SRE/day41/32.jpg" alt="32"><br><img src="../../../../images/SRE/day41/33.jpg" alt="33"><br><img src="../../../../images/SRE/day41/34.jpg" alt="34"><br><img src="../../../../images/SRE/day41/35.jpg" alt="35"></p>
<p>此处指定的磁盘会生成一个qcow2的稀疏格式文件，此处可以指定文件最大容量，但实际只占用实际的空间大小，使用du -sh 文件可以观察到实际大小，使用ls -l 命令看到是此处指定的大小</p>
<p><img src="../../../../images/SRE/day41/36.jpg" alt="36"><br><img src="../../../../images/SRE/day41/37.jpg" alt="37"><br><img src="../../../../images/SRE/day41/38.jpg" alt="38"><br><img src="../../../../images/SRE/day41/39.jpg" alt="39"><br><img src="../../../../images/SRE/day41/40.jpg" alt="40"><br><img src="../../../../images/SRE/day41/41.jpg" alt="41"><br><img src="../../../../images/SRE/day41/42.jpg" alt="42"><br><img src="../../../../images/SRE/day41/43.jpg" alt="43"><br><img src="../../../../images/SRE/day41/44.jpg" alt="44"></p>
<p>范例: 生成的虚拟机相关文件</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#保存虚拟机磁盘</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># ll /var/lib/libvirt/images/centos8.qcow2 -h</span></span><br><span class="line">-rw------- 1 qemu qemu 21G Sep 13 20:08 /var/lib/libvirt/images/centos8.qcow2</span><br><span class="line"></span><br><span class="line"><span class="comment">#保存虚拟机配置</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># ll /etc/libvirt/qemu/centos8.xml</span></span><br></pre></td></tr></table></figure>

<h2 id="使用-virt-install-创建虚拟机"><a href="#使用-virt-install-创建虚拟机" class="headerlink" title="使用 virt-install 创建虚拟机"></a>使用 virt-install 创建虚拟机</h2><p>虽然使用virt-manager 可以方便的管理虚拟机，但如果需要批量进行虚拟机的创建管理，命令行工具virt-install 更加方便和适合</p>
<h3 id="virt-install-使用说明"><a href="#virt-install-使用说明" class="headerlink" title="virt-install 使用说明"></a>virt-install 使用说明</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># virt-install --help</span></span><br><span class="line">usage: virt-install --name NAME --ram RAM STORAGE INSTALL [options]</span><br><span class="line"></span><br><span class="line">使用 <span class="string">&#x27;--option=?&#x27;</span> 或者 <span class="string">&#x27;--option help&#x27;</span> 查看可用子选项</span><br><span class="line">有关示例及完整选项语法，请查看 man page。</span><br><span class="line"></span><br><span class="line">使用指定安装介质新建虚拟机</span><br><span class="line">optional arguments:</span><br><span class="line">-h, --<span class="built_in">help</span> show this <span class="built_in">help</span> message and <span class="built_in">exit</span></span><br><span class="line">--version show program<span class="string">&#x27;s version number and exit</span></span><br><span class="line"><span class="string">--connect URI 使用 libvirt URI 连接到 hypervisor</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">通用选项:</span></span><br><span class="line"><span class="string">-n NAME, --name NAME 客户端虚拟机的名称</span></span><br><span class="line"><span class="string">--memory MEMORY 配置虚拟机内存分配</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">例如：</span></span><br><span class="line"><span class="string">--memory 1024 (in MiB) </span></span><br><span class="line"><span class="string">--memory 512,maxmemory=1024</span></span><br><span class="line"><span class="string">--vcpus VCPUS 为虚拟机配置的 vcpus 数。</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">例如：</span></span><br><span class="line"><span class="string">--vcpus 5</span></span><br><span class="line"><span class="string">--vcpus 5,maxcpus=10,cpuset=1-4,6,8</span></span><br><span class="line"><span class="string">--vcpus sockets=2,cores=4,threads=2</span></span><br><span class="line"><span class="string">--cpu CPU CPU 型号及功能。</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">例如：</span></span><br><span class="line"><span class="string">--cpu coreduo,+x2apic</span></span><br><span class="line"><span class="string">--cpu host</span></span><br><span class="line"><span class="string">--metadata METADATA 配置虚拟机元数据</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">例如：</span></span><br><span class="line"><span class="string">--metadata name=foo,title=&quot;My pretty title&quot;,uuid=...</span></span><br><span class="line"><span class="string">--metadata description=&quot;My nice long description&quot;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">安装方法选项:</span></span><br><span class="line"><span class="string">--cdrom CDROM 光驱安装介质</span></span><br><span class="line"><span class="string">-l LOCATION, --location LOCATION 安装源</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">例如：</span></span><br><span class="line"><span class="string">nfs:host:/path</span></span><br><span class="line"><span class="string">http://host/path</span></span><br><span class="line"><span class="string">ftp://host/path</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">--pxe 使用 PXE 协议从网络引导</span></span><br><span class="line"><span class="string">--import 在磁盘映像中构建虚拟机</span></span><br><span class="line"><span class="string">--livecd 将光驱介质视为 Live CD</span></span><br><span class="line"><span class="string">-x EXTRA_ARGS, --extra-args EXTRA_ARGS 附加到使用 --location 引导的内核的参数</span></span><br><span class="line"><span class="string">--initrd-inject INITRD_INJECT 使用 --location 为 initrd 的 root 添加给定文件</span></span><br><span class="line"><span class="string">--os-variant DISTRO_VARIANT 在其中安装 OS 变体的虚拟机，比</span></span><br><span class="line"><span class="string">如:&#x27;</span>fedora18<span class="string">&#x27;、&#x27;</span>rhel6<span class="string">&#x27;、&#x27;</span>winxp<span class="string">&#x27; 等等</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">--boot BOOT 配置虚拟机引导设置。</span></span><br><span class="line"><span class="string">例如：</span></span><br><span class="line"><span class="string">--boot hd,cdrom,menu=on</span></span><br><span class="line"><span class="string">--boot init=/sbin/init (for containers)</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">--idmap IDMAP 为 LXC 容器启用用户名称空间。</span></span><br><span class="line"><span class="string">例如：</span></span><br><span class="line"><span class="string">--idmap uid_start=0,uid_target=1000,uid_count=10</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">设备选项:</span></span><br><span class="line"><span class="string">--disk DISK 使用不同选项指定存储。例如：</span></span><br><span class="line"><span class="string">--disk size=10 (new 10GiB image in default location)</span></span><br><span class="line"><span class="string">--disk /my/existing/disk,cache=none</span></span><br><span class="line"><span class="string">--disk device=cdrom,bus=scsi</span></span><br><span class="line"><span class="string">--disk=?</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">-w NETWORK, --network NETWORK 配置虚拟机网络接口。</span></span><br><span class="line"><span class="string">例如：</span></span><br><span class="line"><span class="string">--network bridge=mybr0</span></span><br><span class="line"><span class="string">--network network=my_libvirt_virtual_net</span></span><br><span class="line"><span class="string">--network network=mynet,model=virtio,mac=00:11...</span></span><br><span class="line"><span class="string">--network none</span></span><br><span class="line"><span class="string">--network help</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">--graphics GRAPHICS 配置虚拟机显示设置。</span></span><br><span class="line"><span class="string">例如：</span></span><br><span class="line"><span class="string">--graphics vnc</span></span><br><span class="line"><span class="string">--graphics spice,port=5901,tlsport=5902</span></span><br><span class="line"><span class="string">--graphics none</span></span><br><span class="line"><span class="string">--graphics vnc,password=foobar,port=5910,keymap=ja</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">--controller CONTROLLER 配置虚拟机控制程序设备。</span></span><br><span class="line"><span class="string">例如：</span></span><br><span class="line"><span class="string">--controller type=usb,model=ich9-ehci1</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">--input INPUT 配置虚拟机输入设备。</span></span><br><span class="line"><span class="string">例如：</span></span><br><span class="line"><span class="string">--input tablet</span></span><br><span class="line"><span class="string">--input keyboard,bus=usb</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">--serial SERIAL 配置虚拟机串口设备</span></span><br><span class="line"><span class="string">--parallel PARALLEL 配置虚拟机并口设备</span></span><br><span class="line"><span class="string">--channel CHANNEL 配置虚拟机沟通频道</span></span><br><span class="line"><span class="string">--console CONSOLE 配置虚拟机与主机之间的文本控制台连接</span></span><br><span class="line"><span class="string">--hostdev HOSTDEV 将物理 USB/PCI/etc 主机设备配置为与虚拟机共享</span></span><br><span class="line"><span class="string">--filesystem FILESYSTEM 将主机目录传递给虚拟机。</span></span><br><span class="line"><span class="string">例如：</span></span><br><span class="line"><span class="string">--filesystem /my/source/dir,/dir/in/guest</span></span><br><span class="line"><span class="string">--filesystem template_name,/,type=template</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">--sound [SOUND] 配置虚拟机声音设备模拟</span></span><br><span class="line"><span class="string">--watchdog WATCHDOG 配置虚拟机 watchdog 设备</span></span><br><span class="line"><span class="string">--video VIDEO 配置虚拟机视频硬件。</span></span><br><span class="line"><span class="string">--smartcard SMARTCARD 配置虚拟机智能卡设备。例如：--smartcard mode=passthrough</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">--redirdev REDIRDEV 配置虚拟机重定向设备。例如：--redirdev usb,type=tcp,server=192.168.1.1:4000</span></span><br><span class="line"><span class="string">--memballoon MEMBALLOON 配置虚拟机 memballoon 设备。例如：--memballoon model=virtio</span></span><br><span class="line"><span class="string">--tpm TPM 配置虚拟机 TPM 设备。例如：--tpm /dev/tpm</span></span><br><span class="line"><span class="string">--rng RNG 配置虚拟机 RNG 设备。例如：--rng /dev/random</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">--panic PANIC 配置虚拟机 panic 设备。例如：--panic default</span></span><br><span class="line"><span class="string">虚拟机配置选项:</span></span><br><span class="line"><span class="string">--security SECURITY 设定域安全驱动器配置。</span></span><br><span class="line"><span class="string">--numatune NUMATUNE 为域进程调整 NUMA 策略。</span></span><br><span class="line"><span class="string">--memtune MEMTUNE 为域进程调整内粗策略。</span></span><br><span class="line"><span class="string">--blkiotune BLKIOTUNE为域进程调整 blkio 策略。</span></span><br><span class="line"><span class="string">--memorybacking MEMORYBACKING 为域进程设置内存后备策略。例如：</span></span><br><span class="line"><span class="string">--memorybacking hugepages=on</span></span><br><span class="line"><span class="string">--features FEATURES 设置域 &lt;features&gt; XML。</span></span><br><span class="line"><span class="string">例如：</span></span><br><span class="line"><span class="string">--features acpi=off</span></span><br><span class="line"><span class="string">--features apic=on,eoi=on</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">--clock CLOCK 设置域 &lt;clock&gt; XML。例如：--clock </span></span><br><span class="line"><span class="string">offset=localtime,rtc_tickpolicy=catchup</span></span><br><span class="line"><span class="string">--pm PM 配置 VM 电源管理功能</span></span><br><span class="line"><span class="string">--events EVENTS 配置 VM 生命周期管理策略</span></span><br><span class="line"><span class="string">--resource RESOURCE 配置 VM 资源分区（cgroups）</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">虚拟化平台选项:</span></span><br><span class="line"><span class="string">-v, --hvm 客户端应该是一个全虚拟客户端</span></span><br><span class="line"><span class="string">-p, --paravirt 这个客户端一个是一个半虚拟客户端</span></span><br><span class="line"><span class="string">--container 这台虚拟机需要一个容器客户端</span></span><br><span class="line"><span class="string">--virt-type HV_TYPE 要使用的管理程序名称(kvm、qemu、xen等等)</span></span><br><span class="line"><span class="string">--arch ARCH 模拟的 CPU 构架</span></span><br><span class="line"><span class="string">--machine MACHINE 要模拟的机器类型</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">其它选项:</span></span><br><span class="line"><span class="string">--autostart 引导主机时自动启动域。</span></span><br><span class="line"><span class="string">--wait WAIT 等待安装完成的分钟数。</span></span><br><span class="line"><span class="string">--noautoconsole 不要自动尝试连接到客户端控制台</span></span><br><span class="line"><span class="string">--noreboot 完成安装后不要引导虚拟机。</span></span><br><span class="line"><span class="string">--print-xml [XMLONLY] 输出所生成域 XML，而不是创建虚拟机。</span></span><br><span class="line"><span class="string">--dry-run 完成安装步骤，但不要创建设备或者定义虚拟机。</span></span><br><span class="line"><span class="string">--check CHECK 启用或禁用验证检查。例如：</span></span><br><span class="line"><span class="string">--check path_in_use=off</span></span><br><span class="line"><span class="string">--check all=off</span></span><br><span class="line"><span class="string">-q, --quiet 禁止无错误输出</span></span><br><span class="line"><span class="string">-d, --debug 输入故障排除信息</span></span><br></pre></td></tr></table></figure>

<h3 id="virt-install-命令创建虚拟机"><a href="#virt-install-命令创建虚拟机" class="headerlink" title="virt-install 命令创建虚拟机"></a>virt-install 命令创建虚拟机</h3><h4 id="利用-qemu-img命令创建虚拟磁盘"><a href="#利用-qemu-img命令创建虚拟磁盘" class="headerlink" title="利用 qemu-img命令创建虚拟磁盘"></a>利用 qemu-img命令创建虚拟磁盘</h4><p><strong>注意: qemu-img create 一定要确认对应路径下没有此文件，如果存在将覆盖原文件</strong></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ~]<span class="comment"># qemu-img create -f qcow2 /var/lib/libvirt/images/centos7.qcow2 20G</span></span><br><span class="line">Formatting <span class="string">&#x27;/var/lib/libvirt/images/centos7.qcow2&#x27;</span>, <span class="built_in">fmt</span>=qcow2 size=21474836480</span><br><span class="line">cluster_size=65536 lazy_refcounts=off refcount_bits=16</span><br><span class="line"></span><br><span class="line"><span class="comment">#观察文件虚拟磁盘大小，比较用virt-manager创建的虚拟机磁盘文件大小</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># ll -h /var/lib/libvirt/images/centos7.qcow2 </span></span><br><span class="line">-rw-r--r-- 1 root root 193K Sep 13 21:25 /var/lib/libvirt/images/centos7.qcow2</span><br></pre></td></tr></table></figure>

<h4 id="利用-osinfo-query命令查看支持的OS版本"><a href="#利用-osinfo-query命令查看支持的OS版本" class="headerlink" title="利用 osinfo-query命令查看支持的OS版本"></a>利用 osinfo-query命令查看支持的OS版本</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">[root@ubuntu2004 ~]<span class="comment"># apt install libosinfo-bin</span></span><br><span class="line">[root@ubuntu2004 ~]<span class="comment"># osinfo-query os |grep -i rhel</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#查看支持的OS</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># osinfo-query os | grep centos</span></span><br><span class="line"> centos-stream8       | CentOS Stream 8                                    | 8        | http://centos.org/centos-stream/8       </span><br><span class="line"> centos-stream9       | CentOS Stream 9                                    | 9        | http://centos.org/centos-stream/9       </span><br><span class="line"> centos5.0            | CentOS 5.0                                         | 5.0      | http://centos.org/centos/5.0            </span><br><span class="line"> centos5.1            | CentOS 5.1                                         | 5.1      | http://centos.org/centos/5.1            </span><br><span class="line"> centos5.10           | CentOS 5.10                                        | 5.10     | http://centos.org/centos/5.10           </span><br><span class="line"> centos5.11           | CentOS 5.11                                        | 5.11     | http://centos.org/centos/5.11           </span><br><span class="line"> centos5.2            | CentOS 5.2                                         | 5.2      | http://centos.org/centos/5.2            </span><br><span class="line"> centos5.3            | CentOS 5.3                                         | 5.3      | http://centos.org/centos/5.3            </span><br><span class="line"> centos5.4            | CentOS 5.4                                         | 5.4      | http://centos.org/centos/5.4            </span><br><span class="line"> centos5.5            | CentOS 5.5                                         | 5.5      | http://centos.org/centos/5.5            </span><br><span class="line"> centos5.6            | CentOS 5.6                                         | 5.6      | http://centos.org/centos/5.6            </span><br><span class="line"> centos5.7            | CentOS 5.7                                         | 5.7      | http://centos.org/centos/5.7            </span><br><span class="line"> centos5.8            | CentOS 5.8                                         | 5.8      | http://centos.org/centos/5.8            </span><br><span class="line"> centos5.9            | CentOS 5.9                                         | 5.9      | http://centos.org/centos/5.9            </span><br><span class="line"> centos6.0            | CentOS 6.0                                         | 6.0      | http://centos.org/centos/6.0            </span><br><span class="line"> centos6.1            | CentOS 6.1                                         | 6.1      | http://centos.org/centos/6.1            </span><br><span class="line"> centos6.10           | CentOS 6.10                                        | 6.10     | http://centos.org/centos/6.10           </span><br><span class="line"> centos6.2            | CentOS 6.2                                         | 6.2      | http://centos.org/centos/6.2            </span><br><span class="line"> centos6.3            | CentOS 6.3                                         | 6.3      | http://centos.org/centos/6.3            </span><br><span class="line"> centos6.4            | CentOS 6.4                                         | 6.4      | http://centos.org/centos/6.4            </span><br><span class="line"> centos6.5            | CentOS 6.5                                         | 6.5      | http://centos.org/centos/6.5            </span><br><span class="line"> centos6.6            | CentOS 6.6                                         | 6.6      | http://centos.org/centos/6.6            </span><br><span class="line"> centos6.7            | CentOS 6.7                                         | 6.7      | http://centos.org/centos/6.7            </span><br><span class="line"> centos6.8            | CentOS 6.8                                         | 6.8      | http://centos.org/centos/6.8            </span><br><span class="line"> centos6.9            | CentOS 6.9                                         | 6.9      | http://centos.org/centos/6.9            </span><br><span class="line"> centos7.0            | CentOS 7                                           | 7        | http://centos.org/centos/7.0            </span><br><span class="line"> centos8              | CentOS 8                                           | 8        | http://centos.org/centos/8</span><br></pre></td></tr></table></figure>

<h4 id="创建虚拟机使用光盘启动并手动安装"><a href="#创建虚拟机使用光盘启动并手动安装" class="headerlink" title="创建虚拟机使用光盘启动并手动安装"></a>创建虚拟机使用光盘启动并手动安装</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#创建默认NAT模式的虚拟机，并不自动打开virt-viewer连接console，需要手动打开virt-manager 连接，并手动安装系统</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># virt-install --virt-type kvm --name centos7 --ram 1024 --vcpus 2 \</span></span><br><span class="line">--cdrom=/data/isos/CentOS-7-x86_64-Minimal-2009.iso --disk \</span><br><span class="line">path=/var/lib/libvirt/images/centos7.qcow2 --network network=default \</span><br><span class="line">--graphics vnc,listen=0.0.0.0 --noautoconsole --os-variant=centos7.0</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Starting install...</span><br><span class="line">Domain installation still <span class="keyword">in</span> progress. You can reconnect to </span><br><span class="line">the console to complete the installation process</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@centos8 ~]<span class="comment"># export DISPLAY=10.0.0.1:0.0</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># virt-manager</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#查看虚拟硬盘大小，注意到只要正在运行的虚拟对应的硬盘文件所有者和组为qemu，而虚拟机关机的为root</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># ll /var/lib/libvirt/images/ -h</span></span><br><span class="line">total 22G</span><br><span class="line">-rw-r--r-- 1 qemu qemu 1.6G Sep 13 22:05 centos7.qcow2</span><br><span class="line">-rw------- 1 root root 21G Sep 13 22:05 centos8.qcow2</span><br><span class="line"></span><br><span class="line"><span class="comment">#安装过程略</span></span><br><span class="line"><span class="comment">#示例：使用桥接网络</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># virt-install --virt-type kvm --name centos7 --ram 1024 --vcpus 2 \</span></span><br><span class="line">--cdrom=/data/isos/CentOS-7-x86_64-Minimal-2009.iso --disk \</span><br><span class="line">path=/var/lib/libvirt/images/centos7.qcow2 --network \</span><br><span class="line">--network=bridge:virbr0,model=virtio --graphics vnc,listen=0.0.0.0 --noautoconsole \</span><br><span class="line">--os-variant=centos7.0</span><br></pre></td></tr></table></figure>

<p><img src="../../../../images/SRE/day41/45.jpg" alt="45"></p>
<p>范例：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@ubuntu2204 ~]<span class="comment"># qemu-img create -f qcow2 </span></span><br><span class="line">/var/lib/libvirt/images/rocky8.qcow2 20G</span><br><span class="line"></span><br><span class="line">[root@ubuntu2204 ~]<span class="comment"># virt-install --virt-type kvm --name rocky8 --ram 2048 --vcpus 2 \</span></span><br><span class="line">--cdrom=/data/isos/Rocky-8.5-x86_64-minimal.iso --disk \</span><br><span class="line">path=/var/lib/libvirt/images/rocky8.qcow2 --network network=default \</span><br><span class="line">--graphics vnc,listen=0.0.0.0 --noautoconsole --os-variant=rocky8.5</span><br></pre></td></tr></table></figure>

<h4 id="验证宿主机进程"><a href="#验证宿主机进程" class="headerlink" title="验证宿主机进程"></a>验证宿主机进程</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ~]<span class="comment"># ps aux|grep qemu-kvm</span></span><br><span class="line">qemu        6696  1.4  8.5 4021940 698296 ?     Sl   Sep21   0:45 /usr/libexec/qemu-kvm</span><br><span class="line">......</span><br><span class="line"></span><br><span class="line">[root@centos8 ~]<span class="comment"># pstree -p |grep kvm</span></span><br><span class="line">           |-qemu-kvm(6696)-+-&#123;qemu-kvm&#125;(6709)</span><br><span class="line">           |               |-&#123;qemu-kvm&#125;(6717)</span><br><span class="line">           |               |-&#123;qemu-kvm&#125;(6718)</span><br><span class="line">           |               |-&#123;qemu-kvm&#125;(6719)</span><br><span class="line">           |               |-&#123;qemu-kvm&#125;(6721)</span><br><span class="line">           |                `-&#123;qemu-kvm&#125;(6722)</span><br><span class="line">           |-qemu-kvm(7591)-+-&#123;qemu-kvm&#125;(7605)</span><br><span class="line">           |               |-&#123;qemu-kvm&#125;(7611)</span><br><span class="line">           |               |-&#123;qemu-kvm&#125;(7612)</span><br><span class="line">           |               |-&#123;qemu-kvm&#125;(7613)</span><br><span class="line">           |               |-&#123;qemu-kvm&#125;(7615)</span><br><span class="line">           |                `-&#123;qemu-kvm&#125;(7616)</span><br></pre></td></tr></table></figure>

<h2 id="基于现有虚拟机磁盘为模版创建新的虚拟机"><a href="#基于现有虚拟机磁盘为模版创建新的虚拟机" class="headerlink" title="基于现有虚拟机磁盘为模版创建新的虚拟机"></a>基于现有虚拟机磁盘为模版创建新的虚拟机</h2><h3 id="利用virt-manager实现"><a href="#利用virt-manager实现" class="headerlink" title="利用virt-manager实现"></a>利用virt-manager实现</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#基于已经安装好虚拟机磁盘文件，创建新的磁盘文件</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># cp -a /var/lib/libvirt/images/centos7.qcow2 /var/lib/libvirt/images/centos7-2.qcow2</span></span><br></pre></td></tr></table></figure>

<p><img src="../../../../images/SRE/day41/46.jpg" alt="46"><br><img src="../../../../images/SRE/day41/47.jpg" alt="47"></p>
<h3 id="利用virt-install实现"><a href="#利用virt-install实现" class="headerlink" title="利用virt-install实现"></a>利用virt-install实现</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 images]<span class="comment"># pwd</span></span><br><span class="line">/var/lib/libvirt/images</span><br><span class="line"></span><br><span class="line">[root@centos8 images]<span class="comment"># cp centos8.qcow2 centos8-2.qcow2</span></span><br><span class="line">[root@centos8 images]<span class="comment"># virt-install --virt-type kvm --name centos8-2 --ram 2048 --vcpus 2 \</span></span><br><span class="line">--disk bus=virtio,path=/var/lib/libvirt/images/centos8-2.qcow2 --network \</span><br><span class="line">network=default,model=virtio --graphics vnc,listen=0.0.0.0 --noautoconsole --autostart --boot hd</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">WARNING No operating system detected, VM performance may suffer. Specify an OS </span><br><span class="line">with --os-variant <span class="keyword">for</span> optimal results.</span><br><span class="line">Starting install...</span><br><span class="line">Domain creation completed.</span><br><span class="line"></span><br><span class="line"><span class="comment">#运行工具，可以看到下面出现新的虚拟机</span></span><br><span class="line">[root@centos8 images]<span class="comment"># virt-manager </span></span><br></pre></td></tr></table></figure>

<h3 id="利用virt-clone克隆实现"><a href="#利用virt-clone克隆实现" class="headerlink" title="利用virt-clone克隆实现"></a>利用virt-clone克隆实现</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#基于已有的虚拟机克隆生成新的虚拟机</span></span><br><span class="line">[root@ubuntu2004 ~]<span class="comment"># virt-clone -o rocky8 -f /var/lib/libvirt/images/rocky8-3.qcow2 -n rocky8-3</span></span><br><span class="line">-o rocky8                                 <span class="comment">#指已存在的虚拟机的名称</span></span><br><span class="line">-f /var/lib/libvirt/images/rocky8-3.qcow2 <span class="comment">#新虚拟机磁盘文件路径，此文件自动生成，不需要事先创建</span></span><br><span class="line">-n rocky8-3                               <span class="comment">#新虚拟机的名称</span></span><br></pre></td></tr></table></figure>

<h1 id="管理虚拟机"><a href="#管理虚拟机" class="headerlink" title="管理虚拟机"></a>管理虚拟机</h1><h2 id="使用半虚拟化驱动-virtio"><a href="#使用半虚拟化驱动-virtio" class="headerlink" title="使用半虚拟化驱动 virtio"></a>使用半虚拟化驱动 virtio</h2><h3 id="半虚拟化驱动virtio的工作原理"><a href="#半虚拟化驱动virtio的工作原理" class="headerlink" title="半虚拟化驱动virtio的工作原理"></a>半虚拟化驱动virtio的工作原理</h3><p>为了提高内存、硬盘、网络的性能，需要支持半虚拟化</p>
<p><img src="../../../../images/SRE/day41/48.jpg" alt="48"><br><img src="../../../../images/SRE/day41/49.jpg" alt="49"></p>
<p>virtio 是一种 I/O 半虚拟化解决方案，是一套通用 I/O 设备虚拟化的程序，是对半虚拟化 Hypervisor 中的一组通用 I/O 设备的抽象，提供了一套上层应用与各 Hypervisor 虚拟化设备（KVM，Xen，VMware等）之间的通信框架和编程接口，减少跨平台所带来的兼容性问题，大大提高驱动程序开发效率，Windows 系统需要单独安装virtio驱 动，Linux系统自带virtio驱动。</p>
<p><img src="../../../../images/SRE/day41/50.jpg" alt="50"></p>
<p>实现IO虚拟化主要有三种方式：全虚拟化、半虚拟化和透传，全虚拟化Guest OS不会感知到自己是虚拟机，也无需修改Guest OS，但是它的效率比较低，半虚拟化Guest OS知道自己是虚拟机，通过Frontend/Backend驱动模拟实现IO虚拟化，透传就是直接分配物理设备给VM用，但是需要解决单个硬件在多个虚拟机共享使用的问题。</p>
<p><strong>性能比较</strong></p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://www.ilsistemista.net/index.php/virtualization/42-kvm-virtio-paravirtualized-drivers-why-they-matter.html?start=2</span><br></pre></td></tr></table></figure>

<p><img src="../../../../images/SRE/day41/51.jpg" alt="51"></p>
<p><img src="../../../../images/SRE/day41/52.jpg" alt="52"></p>
<h3 id="半虚拟化设备统一接口virtio"><a href="#半虚拟化设备统一接口virtio" class="headerlink" title="半虚拟化设备统一接口virtio"></a>半虚拟化设备统一接口virtio</h3><p><img src="../../../../images/SRE/day41/53.jpg" alt="53"></p>
<p>通过统一的接口virtio以支持的多种硬件设备</p>
<ul>
<li>不同的虚拟设备和不同的虚拟机可以有不同的前端驱动</li>
<li>不同的硬件设备可以有不同的后端驱动</li>
<li>两者之间的交互遵循virtio的标准</li>
</ul>
<h3 id="驱动获取"><a href="#驱动获取" class="headerlink" title="驱动获取"></a>驱动获取</h3><h4 id="Linux-的-VirtIO-驱动"><a href="#Linux-的-VirtIO-驱动" class="headerlink" title="Linux 的 VirtIO 驱动"></a>Linux 的 VirtIO 驱动</h4><p>红帽RHEL 4.8之后的虚拟机会自动加载和安装virtio驱动</p>
<p><img src="../../../../images/SRE/day41/54.jpg" alt="54"></p>
<h4 id="Windows-操作系统需要额外安装-virtio-的驱动"><a href="#Windows-操作系统需要额外安装-virtio-的驱动" class="headerlink" title="Windows 操作系统需要额外安装 virtio 的驱动"></a>Windows 操作系统需要额外安装 virtio 的驱动</h4><p>方法1∶如果有红帽的RHN订阅，可以从以下位置下载virtio-win包</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://rhn.redhat.com/rhn/software/packages/details/Overview.do?pid=868414</span><br></pre></td></tr></table></figure>

<p>方法2∶从社区获得</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">http://www.Linux-kvm.org/page/Downloads</span><br><span class="line">https://fedorapeople.org/groups/virt/virtio-win/direct-downloads/</span><br><span class="line">https://fedorapeople.org/groups/virt/virtio-win/direct-downloads/archive-virtio/</span><br><span class="line">https://docs.fedoraproject.org/en-US/quick-docs/creating-Windows-virtual-machines-using-virtio-drivers/index.html</span><br></pre></td></tr></table></figure>

<p><img src="../../../../images/SRE/day41/55.jpg" alt="55"><br><img src="../../../../images/SRE/day41/56.jpg" alt="56"><br><img src="../../../../images/SRE/day41/57.jpg" alt="57"><br><img src="../../../../images/SRE/day41/58.jpg" alt="58"></p>
<h3 id="Linux-测试安装virtio驱动前后的虚拟机性能变化"><a href="#Linux-测试安装virtio驱动前后的虚拟机性能变化" class="headerlink" title="Linux 测试安装virtio驱动前后的虚拟机性能变化"></a>Linux 测试安装virtio驱动前后的虚拟机性能变化</h3><p>默认虚拟机使用的是全虚拟化IDE磁盘，以下测试性能</p>
<p>使用dd 或 hdparm测试</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ~]<span class="comment"># dd | hdparm -t /dev/vda</span></span><br></pre></td></tr></table></figure>

<p><img src="../../../../images/SRE/day41/59.jpg" alt="59"></p>
<p>将硬盘默认的总线IDE修改为VirtIO</p>
<p><img src="../../../../images/SRE/day41/60.jpg" alt="60"></p>
<p><strong>重新启动后，执行相同的操作，比较性能</strong></p>
<p><img src="../../../../images/SRE/day41/61.jpg" alt="61"></p>
<p>默认网卡为e1000，将之修改网卡驱动为virtIO</p>
<p><img src="../../../../images/SRE/day41/62.jpg" alt="62"></p>
<h3 id="安装-Windows-Server-虚拟机"><a href="#安装-Windows-Server-虚拟机" class="headerlink" title="安装 Windows Server 虚拟机"></a>安装 Windows Server 虚拟机</h3><h4 id="下载并准备相关文件"><a href="#下载并准备相关文件" class="headerlink" title="下载并准备相关文件"></a>下载并准备相关文件</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># virtio下载地址：</span></span><br><span class="line">https://fedorapeople.org/groups/virt/virtio-win/direct-downloads/</span><br><span class="line"></span><br><span class="line"><span class="comment"># virtio 历史版本下载地址：</span></span><br><span class="line">https://fedorapeople.org/groups/virt/virtio-win/direct-downloads/archive-virtio/</span><br></pre></td></tr></table></figure>

<p><img src="../../../../images/SRE/day41/63.jpg" alt="63"></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ~]<span class="comment"># ll /data/isos/</span></span><br><span class="line">total 6031060</span><br><span class="line">-rw-r--r-- 1 qemu qemu 1085276160 Aug  9 16:38 CentOS-7-x86_64-Minimal-2009.iso</span><br><span class="line">-rw-r--r-- 1 qemu qemu 1718616064 Aug  9 16:31 CentOS-8.2.2004-x86_64-minimal.iso</span><br><span class="line">-rw-r--r-- 1 root root 3368962048 Aug 11 12:00 cn_Windows_server_2008_r2_standard_enterprise_datacenter_and_web_with_sp1_vl_build_x64_dvd_617396.iso</span><br><span class="line">-rw-r--r-- 1 root root    2949120 Aug 11 12:01 virtio-win-0.1.141_amd64.vfd</span><br></pre></td></tr></table></figure>

<h4 id="创建-Windows-Server-2008-虚拟机"><a href="#创建-Windows-Server-2008-虚拟机" class="headerlink" title="创建 Windows Server 2008 虚拟机"></a>创建 Windows Server 2008 虚拟机</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#创建磁盘文件</span></span><br><span class="line">[root@centos8 ~]<span class="comment">#qemu-img create -f qcow2 /var/lib/libvirt/images/Windows-2008_r2-x86_64.qcow2 20G</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#查看支持的Windows版本</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># osinfo-query os| grep win</span></span><br><span class="line"> win1.0               | Microsoft Windows 1.0                              | 1.0      | http://microsoft.com/win/1.0            </span><br><span class="line"> win10                | Microsoft Windows 10                               | 10.0     | http://microsoft.com/win/10             </span><br><span class="line"> win11                | Microsoft Windows 11                               | 11.0     | http://microsoft.com/win/11             </span><br><span class="line"> win2.0               | Microsoft Windows 2.0                              | 2.0      | http://microsoft.com/win/2.0            </span><br><span class="line"> win2.1               | Microsoft Windows 2.1                              | 2.1      | http://microsoft.com/win/2.1            </span><br><span class="line"> win2k                | Microsoft Windows 2000                             | 5.0      | http://microsoft.com/win/2k             </span><br><span class="line"> win2k12              | Microsoft Windows Server 2012                      | 6.3      | http://microsoft.com/win/2k12           </span><br><span class="line"> win2k12r2            | Microsoft Windows Server 2012 R2                   | 6.3      | http://microsoft.com/win/2k12r2         </span><br><span class="line"> win2k16              | Microsoft Windows Server 2016                      | 10.0     | http://microsoft.com/win/2k16           </span><br><span class="line"> win2k19              | Microsoft Windows Server 2019                      | 10.0     | http://microsoft.com/win/2k19           </span><br><span class="line"> win2k22              | Microsoft Windows Server 2022                      | 10.0     | http://microsoft.com/win/2k22           </span><br><span class="line"> win2k3               | Microsoft Windows Server 2003                      | 5.2      | http://microsoft.com/win/2k3            </span><br><span class="line"> win2k3r2             | Microsoft Windows Server 2003 R2                   | 5.2      | http://microsoft.com/win/2k3r2          </span><br><span class="line"> win2k8               | Microsoft Windows Server 2008                      | 6.0      | http://microsoft.com/win/2k8            </span><br><span class="line"> win2k8r2             | Microsoft Windows Server 2008 R2                   | 6.1      | http://microsoft.com/win/2k8r2          </span><br><span class="line"> win3.1               | Microsoft Windows 3.1                              | 3.1      | http://microsoft.com/win/3.1            </span><br><span class="line"> win7                 | Microsoft Windows 7                                | 6.1      | http://microsoft.com/win/7              </span><br><span class="line"> win8                 | Microsoft Windows 8                                | 6.2      | http://microsoft.com/win/8              </span><br><span class="line"> win8.1               | Microsoft Windows 8.1                              | 6.3      | http://microsoft.com/win/8.1            </span><br><span class="line"> win95                | Microsoft Windows 95                               | 4.0      | http://microsoft.com/win/95             </span><br><span class="line"> win98                | Microsoft Windows 98                               | 4.1      | http://microsoft.com/win/98             </span><br><span class="line"> winme                | Microsoft Windows Millennium Edition               | 4.9      | http://microsoft.com/win/me             </span><br><span class="line"> winnt3.1             | Microsoft Windows NT Server 3.1                    | 3.1      | http://microsoft.com/winnt/3.1          </span><br><span class="line"> winnt3.5             | Microsoft Windows NT Server 3.5                    | 3.5      | http://microsoft.com/winnt/3.5          </span><br><span class="line"> winnt3.51            | Microsoft Windows NT Server 3.51                   | 3.51     | http://microsoft.com/winnt/3.51         </span><br><span class="line"> winnt4.0             | Microsoft Windows NT Server 4.0                    | 4.0      | http://microsoft.com/winnt/4.0          </span><br><span class="line"> winvista             | Microsoft Windows Vista                            | 6.0      | http://microsoft.com/win/vista          </span><br><span class="line"> winxp                | Microsoft Windows XP                               | 5.1      | http://microsoft.com/win/xp</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"></span><br><span class="line"><span class="comment">#下面版本成功</span></span><br><span class="line">[root@ubuntu2004 ~]<span class="comment"># virt-install --virt-type kvm --name Win2008 --memory 3072 --vcpus=2 \</span></span><br><span class="line">--os-variant=win2k8r2 --cdrom=/data/isos/cn_windows_server_2008_r2_standard_enterprise_datacenter_and_we</span><br><span class="line">b_with_sp1.iso \</span><br><span class="line">--disk path=/var/lib/libvirt/images/Windows-2008_r2-x86_64.qcow2,format=qcow2,bus=virtio \</span><br><span class="line">--disk path=/data/isos/virtio-win-0.1.141_amd64.vfd,device=floppy --network bridge=virbr0,model=virtio \</span><br><span class="line">--graphics vnc,listen=0.0.0.0 --noautoconsole --autostart</span><br><span class="line"></span><br><span class="line"><span class="comment">#创建 Windows 虚拟机，新版不支持下面格式，可以通过virt-manager进行安装</span></span><br><span class="line">[root@cetos8 ~]<span class="comment"># virt-install --virt-type kvm --name Win2008 --memory 3072 --vcpus=2 \</span></span><br><span class="line">--os-variant=win2k8r2 --cdrom=/data/isos/cn_Windows_server_2008_r2_standard_enterprise_datacenter_and_we</span><br><span class="line">b_with_sp1_vl_build_x64_dvd_617396.iso \</span><br><span class="line">--disk path=/var/lib/libvirt/images/Windows-2008_r2-x86_64.qcow2,format=qcow2,bus=virtio \</span><br><span class="line">--disk path=/data/isos/virtio-win-0.1.141_amd64.vfd,device=floppy --network \</span><br><span class="line">bridge=virbr0,model=virtio --graphics vnc,listen=0.0.0.0 --noautoconsole --autostart</span><br><span class="line"></span><br><span class="line">Starting install...</span><br><span class="line">Domain installation still <span class="keyword">in</span> progress. You can reconnect to </span><br><span class="line">the console to complete the installation process.</span><br><span class="line"></span><br><span class="line">[root@centos8 ~]<span class="comment"># virt-manager</span></span><br></pre></td></tr></table></figure>

<h4 id="安装-Windows-Server-2008"><a href="#安装-Windows-Server-2008" class="headerlink" title="安装 Windows Server 2008"></a>安装 Windows Server 2008</h4><p><img src="../../../../images/SRE/day41/64.jpg" alt="64"><br><img src="../../../../images/SRE/day41/65.jpg" alt="65"><br><img src="../../../../images/SRE/day41/66.jpg" alt="66"><br><img src="../../../../images/SRE/day41/67.jpg" alt="67"><br><img src="../../../../images/SRE/day41/68.jpg" alt="68"><br><img src="../../../../images/SRE/day41/69.jpg" alt="69"><br><img src="../../../../images/SRE/day41/70.jpg" alt="70"><br><img src="../../../../images/SRE/day41/71.jpg" alt="71"><br><img src="../../../../images/SRE/day41/72.jpg" alt="72"></p>
<p><strong>注意: 不要选中 GPU</strong></p>
<p><img src="../../../../images/SRE/day41/73.jpg" alt="73"><br><img src="../../../../images/SRE/day41/74.jpg" alt="74"><br><img src="../../../../images/SRE/day41/75.jpg" alt="75"><br><img src="../../../../images/SRE/day41/76.jpg" alt="76"><br><img src="../../../../images/SRE/day41/77.jpg" alt="77"><br><img src="../../../../images/SRE/day41/78.jpg" alt="78"><br><img src="../../../../images/SRE/day41/79.jpg" alt="79"></p>
<h4 id="验证-Windows-virtio-驱动"><a href="#验证-Windows-virtio-驱动" class="headerlink" title="验证 Windows virtio 驱动"></a>验证 Windows virtio 驱动</h4><p><img src="../../../../images/SRE/day41/80.jpg" alt="80"></p>
<h4 id="安装PCI-内存管理驱动"><a href="#安装PCI-内存管理驱动" class="headerlink" title="安装PCI 内存管理驱动"></a>安装PCI 内存管理驱动</h4><p>挂载virtio-win的141的ISO光盘文件virtio-win-0.1.141.iso进行安装驱动</p>
<p>注意:不要安装其它版本，比如189版本会蓝屏死机，185安装后显示黄色，工作不正常</p>
<p><img src="../../../../images/SRE/day41/81.jpg" alt="81"><br><img src="../../../../images/SRE/day41/82.jpg" alt="82"><br><img src="../../../../images/SRE/day41/83.jpg" alt="83"><br><img src="../../../../images/SRE/day41/84.jpg" alt="84"><br><img src="../../../../images/SRE/day41/85.jpg" alt="85"><br><img src="../../../../images/SRE/day41/86.jpg" alt="86"></p>
<h4 id="生成Windows-Server-2008-镜像模版"><a href="#生成Windows-Server-2008-镜像模版" class="headerlink" title="生成Windows Server 2008 镜像模版"></a>生成Windows Server 2008 镜像模版</h4><p>利用sysprep工具，清除个性信息，下次Windows开机时， 会自动生成初始化个性信息</p>
<p><img src="../../../../images/SRE/day41/87.jpg" alt="87"></p>
<p><strong>下次开机需要重新初始化</strong></p>
<p><img src="../../../../images/SRE/day41/88.jpg" alt="88"></p>
<h4 id="基于模版创建新的Windows的虚拟机"><a href="#基于模版创建新的Windows的虚拟机" class="headerlink" title="基于模版创建新的Windows的虚拟机"></a>基于模版创建新的Windows的虚拟机</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@centos7 images]<span class="comment"># pwd</span></span><br><span class="line">/var/lib/libvirt/images</span><br><span class="line"></span><br><span class="line">[root@centos7 images]<span class="comment"># cp windows2008.qcow2 windows2008-2.qcow2</span></span><br><span class="line">[root@centos7 ~]<span class="comment"># virt-install --virt-type kvm --name Win2008-2 --memory 3072 --vcpus=2 \</span></span><br><span class="line">--os-variant=win2k8r2 --disk path=/var/lib/libvirt/images/windows2008-2.qcow2,format=qcow2,bus=virtio \</span><br><span class="line">--network bridge=virbr0,model=virtio --graphics vnc,listen=0.0.0.0 --noautoconsole --autostart --boot hd</span><br></pre></td></tr></table></figure>

<h2 id="libvirt-架构"><a href="#libvirt-架构" class="headerlink" title="libvirt 架构"></a>libvirt 架构</h2><p><img src="../../../../images/SRE/day41/89.jpg" alt="89"></p>
<p><strong>注意: 如果libvirtd服务意外关闭，将导致相关工具，如:virt-manager等无法和虚拟机连接，但虚拟机仍会正常运行</strong></p>
<p>范例: libvirtd 服务功能</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ~]<span class="comment"># virsh list</span></span><br><span class="line"> Id   Name                           State</span><br><span class="line">----------------------------------------------------</span><br><span class="line">2     centos8                        running</span><br><span class="line">3     Win_2008_r2-x86_64             running</span><br><span class="line"></span><br><span class="line">[root@ubuntu2004 ~]<span class="comment"># systemctl stop libvirtd libvirtd.socket libvirtd-admin.socket libvirtd-ro.socket</span></span><br><span class="line"></span><br><span class="line">[root@centos8 ~]<span class="comment"># systemctl stop libvirtd</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># virsh list</span></span><br><span class="line">error: failed to connect to the hypervisor</span><br><span class="line">error: Failed to connect socket to <span class="string">&#x27;/var/run/libvirt/libvirt-sock&#x27;</span>: No such file or directory</span><br><span class="line"><span class="comment">#virt-manager工具也无法连接虚拟机</span></span><br></pre></td></tr></table></figure>

<p><img src="../../../../images/SRE/day41/90.jpg" alt="90"></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ~]<span class="comment"># systemctl start libvirtd</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># virsh list</span></span><br><span class="line"> Id   Name                           State</span><br><span class="line">----------------------------------------------------</span><br><span class="line">2     centos8                        running</span><br><span class="line">3     Win_2008_r2-x86_64             running</span><br><span class="line"></span><br><span class="line"><span class="comment">#virt-manager工具也恢复连接虚拟机</span></span><br></pre></td></tr></table></figure>

<p><img src="../../../../images/SRE/day41/91.jpg" alt="91"></p>
<h2 id="virt-manager-管理虚拟机"><a href="#virt-manager-管理虚拟机" class="headerlink" title="virt-manager 管理虚拟机"></a>virt-manager 管理虚拟机</h2><p>virt-manager是一个图形化工具，主要功能:</p>
<ul>
<li>定义和创建虚拟机</li>
<li>硬件管理</li>
<li>性能监视</li>
<li>控制台</li>
<li>在线和离线迁移</li>
<li>虚拟机的保存和恢复、暂停和继续、关闭和启动</li>
</ul>
<h3 id="启动菜单"><a href="#启动菜单" class="headerlink" title="启动菜单"></a>启动菜单</h3><p><img src="../../../../images/SRE/day41/92.jpg" alt="92"></p>
<p>开机后，按提示按ESC键，会出下面启动菜单</p>
<p><img src="../../../../images/SRE/day41/93.jpg" alt="93"></p>
<h3 id="远程管理KVM宿主机"><a href="#远程管理KVM宿主机" class="headerlink" title="远程管理KVM宿主机"></a>远程管理KVM宿主机</h3><p>Ubuntu20.04和Rocky8相互支持远程连接</p>
<p>可以连接到远程的宿主机进行虚拟机的管理</p>
<p><img src="../../../../images/SRE/day41/94.jpg" alt="94"><br><img src="../../../../images/SRE/day41/95.jpg" alt="95"><br><img src="../../../../images/SRE/day41/96.jpg" alt="96"></p>
<p>解决上面问题的方法</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#方法1:在本机安装openssh-askpass包</span></span><br><span class="line">[root@ubuntu2004 ~]<span class="comment"># apt install -y ssh-askpass</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># yum -y install openssh-askpass</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#方法2:实现基于本机到远程主机的key验证</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># ssh-copy-id 10.0.0.18</span></span><br><span class="line">/usr/bin/ssh-copy-id: INFO: Source of key(s) to be installed: </span><br><span class="line"><span class="string">&quot;/root/.ssh/id_rsa.pub&quot;</span></span><br><span class="line">The authenticity of host <span class="string">&#x27;10.0.0.18 (10.0.0.18)&#x27;</span> can<span class="string">&#x27;t be established.</span></span><br><span class="line"><span class="string">ECDSA key fingerprint is SHA256:divKS+okAaeOzwWk/rHnrmZXWo3DUBPkkAnbofk+rbA.</span></span><br><span class="line"><span class="string">Are you sure you want to continue connecting (yes/no/[fingerprint])? yes</span></span><br><span class="line"><span class="string">/usr/bin/ssh-copy-id: INFO: attempting to log in with the new key(s), to filter </span></span><br><span class="line"><span class="string">out any that are already installed</span></span><br><span class="line"><span class="string">/usr/bin/ssh-copy-id: INFO: 1 key(s) remain to be installed -- if you are </span></span><br><span class="line"><span class="string">prompted now it is to install the new keys</span></span><br><span class="line"><span class="string">root@10.0.0.18&#x27;</span>s password: </span><br><span class="line"></span><br><span class="line">Number of key(s) added: 1</span><br><span class="line"></span><br><span class="line">Now try logging into the machine, with:   <span class="string">&quot;ssh &#x27;10.0.0.18&#x27;&quot;</span></span><br><span class="line">and check to make sure that only the key(s) you wanted were added.</span><br></pre></td></tr></table></figure>

<p>再次连接成功</p>
<p><img src="../../../../images/SRE/day41/97.jpg" alt="97"><br><img src="../../../../images/SRE/day41/98.jpg" alt="98"><br><img src="../../../../images/SRE/day41/99.jpg" alt="99"></p>
<h3 id="虚拟机的性能监控"><a href="#虚拟机的性能监控" class="headerlink" title="虚拟机的性能监控"></a>虚拟机的性能监控</h3><p>先选择需要监控的项目</p>
<p><img src="../../../../images/SRE/day41/100.jpg" alt="100"></p>
<p>根据上面的项目，选择对应显示的项目(可选项由前一页的项目决定)</p>
<p><img src="../../../../images/SRE/day41/101.jpg" alt="101"></p>
<h3 id="管理快照"><a href="#管理快照" class="headerlink" title="管理快照"></a>管理快照</h3><p><img src="../../../../images/SRE/day41/102.jpg" alt="102"><br><img src="../../../../images/SRE/day41/103.jpg" alt="103"><br><img src="../../../../images/SRE/day41/104.jpg" alt="104"></p>
<h2 id="virsh-命令行工具"><a href="#virsh-命令行工具" class="headerlink" title="virsh 命令行工具"></a>virsh 命令行工具</h2><h3 id="virsh-命令说明"><a href="#virsh-命令说明" class="headerlink" title="virsh 命令说明"></a>virsh 命令说明</h3><p>virsh是使用libvirt managementAPI构建的管理工具，相比virt-manager可以提高效率</p>
<p>virsh的名称的含义是virtualization shell</p>
<h4 id="两种工作模式"><a href="#两种工作模式" class="headerlink" title="两种工作模式"></a>两种工作模式</h4><ul>
<li>交互模式</li>
<li>非交互模式</li>
</ul>
<p><img src="../../../../images/SRE/day41/105.jpg" alt="105"><br><img src="../../../../images/SRE/day41/106.jpg" alt="106"></p>
<h4 id="virsh-主要功能"><a href="#virsh-主要功能" class="headerlink" title="virsh 主要功能"></a>virsh 主要功能</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ~]<span class="comment"># virsh help</span></span><br><span class="line"> Domain Management (<span class="built_in">help</span> keyword <span class="string">&#x27;domain&#x27;</span>):</span><br><span class="line"> Domain Monitoring (<span class="built_in">help</span> keyword <span class="string">&#x27;monitor&#x27;</span>):</span><br><span class="line"> Host and Hypervisor (<span class="built_in">help</span> keyword <span class="string">&#x27;host&#x27;</span>):</span><br><span class="line"> Interface (<span class="built_in">help</span> keyword <span class="string">&#x27;interface&#x27;</span>):</span><br><span class="line"> Network Filter (<span class="built_in">help</span> keyword <span class="string">&#x27;filter&#x27;</span>):</span><br><span class="line"> Networking (<span class="built_in">help</span> keyword <span class="string">&#x27;network&#x27;</span>):</span><br><span class="line"> Node Device (<span class="built_in">help</span> keyword <span class="string">&#x27;nodedev&#x27;</span>):</span><br><span class="line"> Secret (<span class="built_in">help</span> keyword <span class="string">&#x27;secret&#x27;</span>):</span><br><span class="line"> Snapshot (<span class="built_in">help</span> keyword <span class="string">&#x27;snapshot&#x27;</span>):</span><br><span class="line"> Storage Pool (<span class="built_in">help</span> keyword <span class="string">&#x27;pool&#x27;</span>):</span><br><span class="line"> Storage Volume (<span class="built_in">help</span> keyword <span class="string">&#x27;volume&#x27;</span>):</span><br><span class="line"> Virsh itself (<span class="built_in">help</span> keyword <span class="string">&#x27;virsh&#x27;</span>):</span><br></pre></td></tr></table></figure>

<h4 id="virsh-命令格式"><a href="#virsh-命令格式" class="headerlink" title="virsh 命令格式"></a>virsh 命令格式</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ~]<span class="comment"># virsh --help</span></span><br><span class="line"></span><br><span class="line">virsh [options]... [&lt;command_string&gt;]</span><br><span class="line">virsh [options]... &lt;<span class="built_in">command</span>&gt; [args...]</span><br><span class="line"></span><br><span class="line"> options:</span><br><span class="line">    -c | --connect=URI     hypervisor connection URI</span><br><span class="line">    -d | --debug=NUM       debug level [0-4]</span><br><span class="line">    -e | --escape &lt;char&gt;    <span class="built_in">set</span> escape sequence <span class="keyword">for</span> console</span><br><span class="line">    -h | --<span class="built_in">help</span>             this <span class="built_in">help</span></span><br><span class="line">    -k | --keepalive-interval=NUM</span><br><span class="line">                           keepalive interval <span class="keyword">in</span> seconds, 0 <span class="keyword">for</span> <span class="built_in">disable</span></span><br><span class="line">    -K | --keepalive-count=NUM</span><br><span class="line">                           number of possible missed keepalive messages</span><br><span class="line">    -l | --<span class="built_in">log</span>=FILE         output logging to file</span><br><span class="line">    -q | --quiet           quiet mode</span><br><span class="line">    -r | --<span class="built_in">readonly</span>         connect <span class="built_in">readonly</span></span><br><span class="line">    -t | --timing           <span class="built_in">print</span> timing information</span><br><span class="line">    -v                     short version</span><br><span class="line">    -V                     long version</span><br><span class="line">         --version[=TYPE]   version, TYPE is short or long (default short)</span><br></pre></td></tr></table></figure>

<h4 id="virsh-子命令说明"><a href="#virsh-子命令说明" class="headerlink" title="virsh 子命令说明"></a>virsh 子命令说明</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">help</span>                     <span class="comment">#打印基本帮助信息</span></span><br><span class="line">attach-device            <span class="comment">#使用XML文件中的设备定义在虚拟机中添加设备</span></span><br><span class="line">attach-disk <span class="comment">#在虚拟机中附加新磁盘设备</span></span><br><span class="line">attach-interface <span class="comment">#在虚拟机中附加新网络接口</span></span><br><span class="line">create                   <span class="comment">#从 XML 配置文件生成虚拟机并启动新虚拟机</span></span><br><span class="line">define                   <span class="comment">#为虚拟机输出XML配置文件</span></span><br><span class="line">destroy <span class="comment">#强制虚拟机停止</span></span><br><span class="line">detach-device            <span class="comment">#从虚拟机中分离设备，使用同样的XML 描述作为命令attach-device</span></span><br><span class="line">detach-disk              <span class="comment">#从虚拟机中分离磁盘设备</span></span><br><span class="line">detach-interface         <span class="comment">#从虚拟机中分离网络接口</span></span><br><span class="line">domblkstat               <span class="comment">#显示正在运行的虚拟机的块设备统计</span></span><br><span class="line">domid                    <span class="comment">#显示虚拟机ID</span></span><br><span class="line">domifstat                <span class="comment">#显示正在运行的虚拟机的网络接口统计</span></span><br><span class="line">dominfo                  <span class="comment">#显示虚拟机信息</span></span><br><span class="line">domname                  <span class="comment">#显示虚拟机名称</span></span><br><span class="line">domstate                 <span class="comment">#显示虚以机状态</span></span><br><span class="line">domuuid                  <span class="comment">#显示虚拟机UUID</span></span><br><span class="line">dumpxml                  <span class="comment">#输出虚拟机 XML配置文件</span></span><br><span class="line">list                     <span class="comment">#列出所有虚拟机</span></span><br><span class="line">migrate                  <span class="comment">#将虚拟机迁移到另一台主机中</span></span><br><span class="line">nodeinfo                 <span class="comment">#有关管理程序的输出信息</span></span><br><span class="line">quit                     <span class="comment">#退出这个互动终端</span></span><br><span class="line">reboot                   <span class="comment">#重新启动虚拟机</span></span><br><span class="line">restore                  <span class="comment">#恢复以前保存在文件中的虚拟机</span></span><br><span class="line">resume                   <span class="comment">#恢复暂停的虚拟机</span></span><br><span class="line">save                     <span class="comment">#将虚拟机当前状态保存到某个文件中</span></span><br><span class="line">setmaxmem                <span class="comment">#为管理程序设定内存上限</span></span><br><span class="line">setmem                   <span class="comment">#为虚拟机设定分配的内存</span></span><br><span class="line">setvcpus                 <span class="comment">#修改为虚拟机分配的虚拟CPU数目</span></span><br><span class="line">shutdown                 <span class="comment">#关闭某个虚拟机</span></span><br><span class="line">start                    <span class="comment">#启动未激活的虚拟机</span></span><br><span class="line"><span class="built_in">suspend</span>                  <span class="comment">#暂停虚拟机</span></span><br><span class="line">undefine                 <span class="comment">#删除与虚拟机关联的所有文件</span></span><br><span class="line">vepuinfo                 <span class="comment">#显示虚以机的虚拟CPU信息</span></span><br><span class="line">vcpupin                  <span class="comment">#控制虚拟机的虚拟CPU亲和性</span></span><br><span class="line">version                  <span class="comment">#显示virsh版本</span></span><br></pre></td></tr></table></figure>

<h4 id="查看子命令帮助"><a href="#查看子命令帮助" class="headerlink" title="查看子命令帮助"></a>查看子命令帮助</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">virsh <span class="built_in">help</span> COMMAND</span><br></pre></td></tr></table></figure>

<p>范例: 查看子命令 list 命令用法</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ~]<span class="comment"># virsh help list</span></span><br><span class="line"> NAME</span><br><span class="line">   list - list domains</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"> OPTIONS</span><br><span class="line">    --inactive       list inactive domains</span><br><span class="line">    --all            list inactive &amp; active domains</span><br><span class="line">    --transient      list transient domains</span><br><span class="line">    --persistent     list persistent domains</span><br><span class="line">    --with-snapshot  list domains with existing snapshot</span><br><span class="line">    --without-snapshot list domains without a snapshot</span><br><span class="line">    --state-running  list domains <span class="keyword">in</span> running state</span><br><span class="line">    --state-paused   list domains <span class="keyword">in</span> paused state</span><br><span class="line">    --state-shutoff  list domains <span class="keyword">in</span> shutoff state</span><br><span class="line">    --state-other    list domains <span class="keyword">in</span> other states</span><br><span class="line">    --autostart      list domains with autostart enabled</span><br><span class="line">    --no-autostart   list domains with autostart disabled</span><br><span class="line">    --with-managed-save list domains with managed save state</span><br><span class="line">    --without-managed-save list domains without managed save</span><br><span class="line">    --uuid           list uuid<span class="string">&#x27;s only</span></span><br><span class="line"><span class="string">    --name           list domain names only</span></span><br><span class="line"><span class="string">    --table          list table (default)</span></span><br><span class="line"><span class="string">    --managed-save   mark inactive domains with managed save state</span></span><br><span class="line"><span class="string">    --title         show domain title</span></span><br></pre></td></tr></table></figure>

<h3 id="启动和关闭虚拟机"><a href="#启动和关闭虚拟机" class="headerlink" title="启动和关闭虚拟机"></a>启动和关闭虚拟机</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#查看当前启动的虚拟机</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># virsh list </span></span><br><span class="line"> Id   Name                           State</span><br><span class="line">----------------------------------------------------</span><br><span class="line">1     Win_2008_r2-x86_64             running</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#查看所有虚拟机</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># virsh list --all</span></span><br><span class="line"> Id   Name                           State</span><br><span class="line">----------------------------------------------------</span><br><span class="line">1     Win_2008_r2-x86_64             running</span><br><span class="line">-     centos7                        shut off</span><br><span class="line">-     centos8                        shut off</span><br><span class="line">-     centos8-vm2                    shut off</span><br><span class="line">-     centos8-vm3                    shut off</span><br><span class="line">-     centos8-vm4                    shut off</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#启动</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># virsh start centos8</span></span><br><span class="line">Domain centos8 started</span><br><span class="line"></span><br><span class="line">[root@centos8 ~]<span class="comment"># virsh list </span></span><br><span class="line"> Id   Name                           State</span><br><span class="line">----------------------------------------------------</span><br><span class="line">1     Win_2008_r2-x86_64             running</span><br><span class="line">2     centos8                        running</span><br><span class="line"></span><br><span class="line"><span class="comment">#正常关机</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># virsh shutdown 1</span></span><br><span class="line">Domain 1 is being shutdown</span><br><span class="line"></span><br><span class="line">[root@centos8 ~]<span class="comment"># virsh list </span></span><br><span class="line"> Id   Name                           State</span><br><span class="line">----------------------------------------------------</span><br><span class="line">1     Win_2008_r2-x86_64             running</span><br><span class="line">2     centos8                        running</span><br><span class="line"></span><br><span class="line"><span class="comment">#强制关机，慎重使用</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># virsh destroy 1</span></span><br><span class="line">Domain 1 destroyed</span><br><span class="line"></span><br><span class="line">[root@centos8 ~]<span class="comment"># virsh list </span></span><br><span class="line"> Id   Name                           State</span><br><span class="line">----------------------------------------------------</span><br><span class="line">2     centos8                        running</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@centos8 ~]<span class="comment"># virsh shutdown 2</span></span><br><span class="line">Domain 2 is being shutdown</span><br><span class="line"></span><br><span class="line"><span class="comment">#列出开机状态虚拟机的UUID和名称</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># virsh list --uuid --name</span></span><br><span class="line"> Id   Name                           State</span><br><span class="line">----------------------------------------------------</span><br><span class="line">fee16012-fee9-4348-8cf3-8bb4e1af4a28 centos7.9</span><br><span class="line">5c7b4e61-5f9f-4334-a304-4f9ce79afa01 rocky8-2</span><br><span class="line">c58c587c-5595-4f2c-9ace-66d4c8b246dd k8s-node-03</span><br><span class="line">5ebc9d1e-24f5-4cc4-a396-327f040f29e3 k8s-node-04</span><br><span class="line">8cb644a3-3135-4603-8075-e65c38cc23ad rocky8-4</span><br><span class="line">f0f91ab8-45e4-4bf5-97a3-1ae24de21809 k8s-node-05</span><br><span class="line">37e82325-7ae9-46e2-8457-476b95de8aec k8s-node-06</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#列出所有虚拟机的UUID和name</span></span><br><span class="line">[root@ubuntu2004 ~]<span class="comment"># virsh list --uuid --all --name</span></span><br><span class="line">fee16012-fee9-4348-8cf3-8bb4e1af4a28 centos7.9</span><br><span class="line">5c7b4e61-5f9f-4334-a304-4f9ce79afa01 rocky8-2</span><br><span class="line">c58c587c-5595-4f2c-9ace-66d4c8b246dd k8s-node-03</span><br><span class="line">5ebc9d1e-24f5-4cc4-a396-327f040f29e3 k8s-node-04</span><br><span class="line">8cb644a3-3135-4603-8075-e65c38cc23ad rocky8-4</span><br><span class="line">f0f91ab8-45e4-4bf5-97a3-1ae24de21809 k8s-node-05</span><br><span class="line">37e82325-7ae9-46e2-8457-476b95de8aec k8s-node-06</span><br><span class="line">92ef41cc-ca99-4828-a219-1a62179be37d k8s-node-01</span><br><span class="line">87ae11e9-0847-4644-9146-0fe89e8348d2 k8s-node-02</span><br><span class="line">e9bbdd61-238e-4986-a6a5-26de4d4703aa rocky8</span><br><span class="line">840487ec-0dae-491b-88e0-68d446cdcc15 rocky8-3</span><br><span class="line">6ae2e917-9ad9-4364-8b56-7fb2da46650b rocky8-template</span><br><span class="line">33b4be03-92bb-457f-a50e-6cfff0c7edb4 Win2008-2</span><br><span class="line">d4687970-a9fb-4c74-8c81-410dd04425dc Win2008-template</span><br></pre></td></tr></table></figure>

<p>在virt-manager 中可以看到关机状态</p>
<p><img src="../../../../images/SRE/day41/107.jpg" alt="107"><br><img src="../../../../images/SRE/day41/108.jpg" alt="108"></p>
<p><strong>查看虚拟机UUID，通过UUID启动关闭虚拟机</strong></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ~]<span class="comment"># virsh list</span></span><br><span class="line"> Id   Name                           State</span><br><span class="line">----------------------------------------------------</span><br><span class="line">1     centos8                        running</span><br><span class="line"></span><br><span class="line"><span class="comment">#查看虚拟机的UUID</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># virsh domuuid 1</span></span><br><span class="line">99765478-cfb1-4164-b038-f62004ccab9e</span><br><span class="line"></span><br><span class="line">[root@centos8 ~]<span class="comment"># virsh destroy 99765478-cfb1-4164-b038-f62004ccab9e</span></span><br><span class="line">Domain 99765478-cfb1-4164-b038-f62004ccab9e destroyed</span><br><span class="line"></span><br><span class="line">[root@centos8 ~]<span class="comment"># virsh list</span></span><br><span class="line"> Id   Name                           State</span><br><span class="line">----------------------------------------------------</span><br><span class="line"></span><br><span class="line">[root@centos8 ~]<span class="comment"># virsh list --all</span></span><br><span class="line"> Id   Name                           State</span><br><span class="line">----------------------------------------------------</span><br><span class="line">-     centos7                        shut off</span><br><span class="line">-     centos8                        shut off</span><br><span class="line">-     centos8-vm2                    shut off</span><br><span class="line">-     centos8-vm3                    shut off</span><br><span class="line">-     centos8-vm4                    shut off</span><br><span class="line">-     Win_2008_r2-x86_64              shut off</span><br><span class="line"></span><br><span class="line">[root@centos8 ~]<span class="comment"># virsh domuuid centos8</span></span><br><span class="line">99765478-cfb1-4164-b038-f62004ccab9e</span><br><span class="line"></span><br><span class="line">[root@centos8 ~]<span class="comment"># virsh start 99765478-cfb1-4164-b038-f62004ccab9e</span></span><br><span class="line">Domain centos8 started</span><br><span class="line"></span><br><span class="line">[root@centos8 ~]<span class="comment"># virsh list </span></span><br><span class="line"> Id   Name                           State</span><br><span class="line">----------------------------------------------------</span><br><span class="line">2     centos8                        running</span><br><span class="line"></span><br><span class="line">[root@centos8 ~]<span class="comment"># virsh domuuid centos8</span></span><br><span class="line">99765478-cfb1-4164-b038-f62004ccab9e</span><br></pre></td></tr></table></figure>

<h3 id="暂停和恢复虚拟机"><a href="#暂停和恢复虚拟机" class="headerlink" title="暂停和恢复虚拟机"></a>暂停和恢复虚拟机</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ~]<span class="comment"># virsh list</span></span><br><span class="line"> Id   Name                           State</span><br><span class="line">----------------------------------------------------</span><br><span class="line">1     centos8                        running</span><br><span class="line"></span><br><span class="line">[root@centos8 ~]<span class="comment"># virsh suspend centos8</span></span><br><span class="line">Domain centos8 suspended</span><br><span class="line"></span><br><span class="line">[root@centos8 ~]<span class="comment"># virsh list</span></span><br><span class="line"> Id   Name                           State</span><br><span class="line">----------------------------------------------------</span><br><span class="line">1     centos8                        paused</span><br><span class="line"></span><br><span class="line"><span class="comment">#虚拟机暂停后，宿主机中还存有相关的进程</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># ps aux|grep kvm</span></span><br><span class="line">qemu        1699 36.9 16.0 4439296 1309300 ?     Sl   10:10   5:28 /usr/libexec/qemu-kvm -name guest=centos8,debug-threads=on -S -object</span><br><span class="line">secret,<span class="built_in">id</span>=masterKey0,format=raw,file=/var/lib/libvirt/qemu/domain</span><br><span class="line">......</span><br><span class="line"></span><br><span class="line">[root@centos8 ~]<span class="comment"># virsh resume 1</span></span><br><span class="line">Domain 1 resumed</span><br><span class="line"></span><br><span class="line">[root@centos8 ~]<span class="comment"># virsh list</span></span><br><span class="line"> Id   Name                           State</span><br><span class="line">----------------------------------------------------</span><br><span class="line">1     centos8                        running</span><br></pre></td></tr></table></figure>

<h3 id="配置虚拟机开机自动启动"><a href="#配置虚拟机开机自动启动" class="headerlink" title="配置虚拟机开机自动启动"></a>配置虚拟机开机自动启动</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ~]<span class="comment"># virsh list --all</span></span><br><span class="line"> Id   Name                           State</span><br><span class="line">----------------------------------------------------</span><br><span class="line">1     Win_2008_r2-x86_64             running</span><br><span class="line">-     centos7                        shut off</span><br><span class="line">-     centos8                        shut off</span><br><span class="line">-     centos8-vm2                    shut off</span><br><span class="line">-     centos8-vm3                    shut off</span><br><span class="line">-     centos8-vm4                    shut off</span><br><span class="line"></span><br><span class="line">[root@centos8 ~]<span class="comment"># virsh autostart centos8 </span></span><br><span class="line">Domain centos8 marked as autostarted</span><br><span class="line"></span><br><span class="line"><span class="comment">#设置虚拟机随宿主机启动而自动启动，本质就是在下面目录生成软链接</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># ll /etc/libvirt/qemu/autostart/</span></span><br><span class="line">total 0</span><br><span class="line">lrwxrwxrwx 1 root root 29 Sep 17 18:53 centos8.xml -&gt; /etc/libvirt/qemu/centos8.xml</span><br><span class="line">lrwxrwxrwx 1 root root 40 Sep 17 09:18 Win_2008_r2-x86_64.xml -&gt; /etc/libvirt/qemu/Win_2008_r2-x86_64.xml</span><br><span class="line"></span><br><span class="line">[root@centos8 ~]<span class="comment"># virsh list </span></span><br><span class="line"> Id   Name                           State</span><br><span class="line">----------------------------------------------------</span><br><span class="line">1     Win_2008_r2-x86_64             running</span><br><span class="line"></span><br><span class="line">[root@centos8 ~]<span class="comment"># virsh autostart 1 --disable </span></span><br><span class="line">Domain 1 unmarked as autostarted</span><br><span class="line"></span><br><span class="line">[root@centos8 ~]<span class="comment"># ll /etc/libvirt/qemu/autostart/</span></span><br><span class="line">total 0</span><br><span class="line">lrwxrwxrwx 1 root root 29 Sep 17 18:53 centos8.xml -&gt; /etc/libvirt/qemu/centos8.xml</span><br><span class="line"></span><br><span class="line">[root@centos8 ~]<span class="comment"># reboot</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># virsh list </span></span><br><span class="line"> Id   Name                           State</span><br><span class="line">----------------------------------------------------</span><br><span class="line">1     centos8                        running</span><br></pre></td></tr></table></figure>

<p>在virt-manager工具中也可以配置开机自启动</p>
<p><img src="../../../../images/SRE/day41/109.jpg" alt="109"></p>
<h3 id="查看虚拟机配置"><a href="#查看虚拟机配置" class="headerlink" title="查看虚拟机配置"></a>查看虚拟机配置</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ~]<span class="comment"># virsh list --all</span></span><br><span class="line"> Id   Name                           State</span><br><span class="line">----------------------------------------------------</span><br><span class="line">2     centos8                        running</span><br><span class="line">-     centos7                        shut off</span><br><span class="line">-     centos8-vm2                    shut off</span><br><span class="line">-     centos8-vm3                    shut off</span><br><span class="line">-     centos8-vm4                    shut off</span><br><span class="line">-     Win_2008_r2-x86_64             shut off</span><br><span class="line"></span><br><span class="line"><span class="comment">#每个虚拟机配置都存放在/etc/libvirt/qemu目录下的xml文件中</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># ls /etc/libvirt/qemu/ -l</span></span><br><span class="line">total 32</span><br><span class="line">drwxr-xr-x 2 root root   25 Sep 17 18:54 autostart</span><br><span class="line">-rw------- 1 root root 3618 Sep 17 15:14 centos7.xml</span><br><span class="line">-rw------- 1 root root 3673 Sep 13 22:43 centos8-vm2.xml</span><br><span class="line">-rw------- 1 root root 3601 Sep 13 22:42 centos8-vm3.xml</span><br><span class="line">-rw------- 1 root root 3379 Sep 14 00:15 centos8-vm4.xml</span><br><span class="line">-rw------- 1 root root 6024 Sep 17 15:47 centos8.xml</span><br><span class="line">drwx------ 3 root root   42 Sep 13 19:03 networks</span><br><span class="line">-rw------- 1 root root 5369 Sep 17 11:31 Win_2008_r2-x86_64.xml</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#查看指定虚拟机的配置，以下命令相当于查看 /etc/libvirt/qemu/centos8.xml</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># virsh dumpxml centos8</span></span><br><span class="line">......</span><br></pre></td></tr></table></figure>

<h3 id="删除虚拟机配置"><a href="#删除虚拟机配置" class="headerlink" title="删除虚拟机配置"></a>删除虚拟机配置</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ~]<span class="comment"># virsh list --all</span></span><br><span class="line"> Id   Name                           State</span><br><span class="line">----------------------------------------------------</span><br><span class="line">2     centos8                        running</span><br><span class="line">-     centos7                        shut off</span><br><span class="line">-     centos8-vm2                    shut off</span><br><span class="line">-     centos8-vm3                    shut off</span><br><span class="line">-     centos8-vm4                    shut off</span><br><span class="line">-     Win_2008_r2-x86_64             shut off</span><br><span class="line"></span><br><span class="line"><span class="comment">#删除虚拟机配置，但不删除磁盘文件</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># virsh undefine centos8-vm4</span></span><br><span class="line">Domain centos8-vm4 has been undefined</span><br><span class="line"></span><br><span class="line">[root@centos8 ~]<span class="comment"># virsh list --all</span></span><br><span class="line"> Id   Name                           State</span><br><span class="line">----------------------------------------------------</span><br><span class="line">2     centos8                        running</span><br><span class="line">-     centos7                        shut off</span><br><span class="line">-     centos8-vm2                    shut off</span><br><span class="line">-     centos8-vm3                    shut off</span><br><span class="line">-     Win_2008_r2-x86_64             shut off</span><br><span class="line"></span><br><span class="line"><span class="comment">#对应虚拟机xml的配置文件被删除</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># ll /etc/libvirt/qemu/</span></span><br><span class="line">total 28</span><br><span class="line">drwxr-xr-x 2 root root   25 Sep 17 18:54 autostart</span><br><span class="line">-rw------- 1 root root 3618 Sep 17 15:14 centos7.xml</span><br><span class="line">-rw------- 1 root root 3673 Sep 13 22:43 centos8-vm2.xml</span><br><span class="line">-rw------- 1 root root 3601 Sep 13 22:42 centos8-vm3.xml</span><br><span class="line">-rw------- 1 root root 6024 Sep 17 15:47 centos8.xml</span><br><span class="line">drwx------ 3 root root   42 Sep 13 19:03 networks</span><br><span class="line">-rw------- 1 root root 5369 Sep 17 11:31 Win_2008_r2-x86_64.xml</span><br><span class="line"></span><br><span class="line"><span class="comment">#对应的磁盘文件并没有删除</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># ls /var/lib/libvirt/images/</span></span><br><span class="line">centos7.qcow2 centos8.qcow2 centos8-vm2.qcow2 centos8-vm3.qcow2 centos8-vm4.qcow2 Windows-2008_r2-x86_64.qcow2</span><br><span class="line"></span><br><span class="line"><span class="comment">#删除虚拟机包括磁盘文件</span></span><br><span class="line">[root@ubuntu2004 ~]<span class="comment"># virsh undefine k8s-node-05 --remove-all-storage</span></span><br><span class="line">Domain k8s-node-05 has been undefined</span><br><span class="line">Volume <span class="string">&#x27;vda&#x27;</span>(/var/lib/libvirt/images/k8s-node-05.qcow2) removed.</span><br></pre></td></tr></table></figure>

<h3 id="迁移虚拟机"><a href="#迁移虚拟机" class="headerlink" title="迁移虚拟机"></a>迁移虚拟机</h3><p>将一个宿主机的虚拟机迁移到另一台宿主机，注意: 不支持Ubuntu和Rocky8宿主机之间迁移</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#在一台目标宿主机安装相关虚拟化软件</span></span><br><span class="line">[root@ubuntu2004 ~]<span class="comment"># apt update</span></span><br><span class="line">[root@ubuntu2004 ~]<span class="comment"># apt -y install qemu-kvm virt-manager libvirt-daemon-system</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#在源宿主机查看虚拟机的相关文件</span></span><br><span class="line">[root@ubuntu2004 ~]<span class="comment"># virsh dumpxml --domain rocky8-template</span></span><br><span class="line">......</span><br><span class="line">   &lt;disk <span class="built_in">type</span>=<span class="string">&#x27;file&#x27;</span> device=<span class="string">&#x27;disk&#x27;</span>&gt;</span><br><span class="line">     &lt;driver name=<span class="string">&#x27;qemu&#x27;</span> <span class="built_in">type</span>=<span class="string">&#x27;qcow2&#x27;</span>/&gt;</span><br><span class="line">     &lt;<span class="built_in">source</span> file=<span class="string">&#x27;/var/lib/libvirt/images/rocky8-template.qcow2&#x27;</span>/&gt;</span><br><span class="line">.....</span><br><span class="line"></span><br><span class="line"><span class="comment">#或者#查看块设备</span></span><br><span class="line">[root@ubuntu2004 ~]<span class="comment"># virsh domblklist rocky8-template</span></span><br><span class="line">Target     Source</span><br><span class="line">------------------------------------------------</span><br><span class="line">vda       /var/lib/libvirt/images/rocky8-template.qcow2</span><br><span class="line">vdb        -</span><br><span class="line"></span><br><span class="line"><span class="comment">#复制源宿主机上的虚拟机的两个文件到目标宿主机</span></span><br><span class="line">[root@ubuntu2004 ~]<span class="comment"># scp /etc/libvirt/qemu/rocky8-template.xml 10.0.0.101:/etc/libvirt/qemu/</span></span><br><span class="line">[root@ubuntu2004 ~]<span class="comment"># scp /var/lib/libvirt/images/rocky8-template.qcow2 10.0.0.101:/var/lib/libvirt/images</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#在目标宿主机不重启服务无法看到新的虚拟机</span></span><br><span class="line">[root@ubuntu2004 ~]<span class="comment"># virsh list --all</span></span><br><span class="line">[root@ubuntu2004 ~]<span class="comment"># systemctl restart libvirtd</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#在目标宿主机重启服务后看到新的虚拟机</span></span><br><span class="line">[root@ubuntu2004 ~]<span class="comment"># virsh list --all</span></span><br><span class="line"> Id   Name             State</span><br><span class="line">----------------------------------</span><br><span class="line">     rocky8-template   shut off</span><br></pre></td></tr></table></figure>

<h1 id="存储管理"><a href="#存储管理" class="headerlink" title="存储管理"></a>存储管理</h1><h2 id="KVM存储模式"><a href="#KVM存储模式" class="headerlink" title="KVM存储模式"></a>KVM存储模式</h2><p><strong>基于文件系统的存储</strong></p>
<ul>
<li>dir: Filesystem Directory 需要有挂载点的文件系统</li>
<li>fs: Pre-Formatted Block Device 无需挂载的文件系统，如:位于SAN存储的文件系统，可支持多个主机同时访问，而本地文件系统不支持</li>
<li>netfs: Network Exported Directory 网络文件系统，比如:NFS，SAMBA等</li>
</ul>
<p><strong>基于设备的存储</strong></p>
<p>无需文件系统，性能更好，但可管理性差，无法实现快照</p>
<ul>
<li>Disk: Physical Disk Device</li>
<li>Iscsi: isCSI Target</li>
<li>logical:LVM Volume Group</li>
</ul>
<h2 id="虚拟磁盘类型"><a href="#虚拟磁盘类型" class="headerlink" title="虚拟磁盘类型"></a>虚拟磁盘类型</h2><ul>
<li><p>固定Fixed</p>
<p>在配置时，指定磁盘大小</p>
<p>不管在虚拟磁盘上实际存储多少数据，都将占用相同大小宿主机的磁盘空间</p>
</li>
<li><p>动态Dynamic</p>
<p>初始空间占用小</p>
<p>随着空间的使用逐渐增长到最大容量，但是只根据需求使用更多的空间</p>
</li>
<li><p>差异Differencing</p>
<p>因为创建是差异磁盘，所以只保存变更的数据</p>
<p>例如，将操作系统安装在父盘，然后创建差异化磁盘来执行进一步配置</p>
</li>
</ul>
<h2 id="虚拟镜像文件格式"><a href="#虚拟镜像文件格式" class="headerlink" title="虚拟镜像文件格式"></a>虚拟镜像文件格式</h2><p>镜像文件储存在主机文件系统中。它可以储存在本地文件系统中，如 ext4 或 xfs；或网络文件系统中，如 NFS 。例如 libguestfs 这样的工具，能管理、备份及监控文件。KVM 上的磁盘镜像格式包括：</p>
<ul>
<li><p>raw</p>
<p>此为默认磁盘格式，但并是一种真正的磁盘格式，而是代表虚拟机所使用的原始镜像，它并不存储元数据，因此可作为保证虚拟机兼容性的候选方案。然而，也正因为它不存储元数据，因此不支持某些高级特往，比如快照和压缩等格式简单，容易转换为其他的格式。</p>
<p>如果主机文件系统允许，raw 文件可以是预分配（pre-allocated）或 稀疏（sparse）。稀疏文件根据需求分配主机磁盘空间，因此它是一种精简配置形式（thin provisioning）。预分配文件的所有空间需要被预先分配，但它比稀疏文件性能好。当对磁盘 I/O 性能要求非常高，而且通常不需要通过网络传输镜像文件时，可以使用 raw文件</p>
<p>优点 : 性能好</p>
<p>缺点 : 空间占用大，功能较少，生产不推荐使用</p>
</li>
<li><p>cow : copy-on-write格式，昙花一现</p>
</li>
<li><p>qcow : QEMU早期的copy-on-write格式，过渡性方案</p>
</li>
<li><p>qcow2</p>
<p>qcow2 镜像文件提供许多高级磁盘镜像特征，如快照、压缩及加密。它们可以用来代表通过模板镜像创建的虚拟机。因为只有虚拟机写入的扇区部分才会分配在镜像中，所以 qcow2 文件的网络传输效率较高。RHEL 7.0 及更新版本支持 qcow2 v3 镜像文件格式</p>
<p>按需进行分配磁盘空间，不管文件系统是否支持</p>
<p>支持快照</p>
<p>支持zlib的磁盘压缩</p>
<p>支持AES的加密</p>
<p>优点 : 空间节约，功能丰富</p>
<p>缺点 : 性能较差，生产推荐使用</p>
</li>
<li><p>vmdk( Virtual Machine Disk ): VMware环境当中默认使用的磁盘格式</p>
</li>
<li><p>vhd \ vhdx ( Virtual Hard Disk ):微软默认采用的文件格式</p>
</li>
<li><p>vdi : VirtualBox 采用的文件格式</p>
</li>
</ul>
<p><strong>查看支持格式</strong></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">qemu-img --<span class="built_in">help</span></span><br></pre></td></tr></table></figure>

<p>范例: 查看KVM支持的磁盘格式</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ~]<span class="comment"># qemu-img --help|grep Support</span></span><br><span class="line">Supported formats: blkdebug blkreplay blkverify copy-on-read file ftp ftps </span><br><span class="line">gluster host_cdrom host_device http https iscsi iser luks nbd null-aio null-co </span><br><span class="line">nvme qcow2 quorum raw rbd ssh throttle vhdx vmdk vpc</span><br></pre></td></tr></table></figure>

<h2 id="使用qemu-img管理虚拟磁盘文件"><a href="#使用qemu-img管理虚拟磁盘文件" class="headerlink" title="使用qemu-img管理虚拟磁盘文件"></a>使用qemu-img管理虚拟磁盘文件</h2><h3 id="qemu-img-概述"><a href="#qemu-img-概述" class="headerlink" title="qemu-img 概述"></a>qemu-img 概述</h3><p>qemu-img 是一个功能强大的磁盘镜像管理工具</p>
<p>查看帮助: qemu-img –help</p>
<p>qemu-img 包括以下子命令</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">check          <span class="comment">#检查完整性</span></span><br><span class="line">create         <span class="comment">#创建镜像</span></span><br><span class="line">commit         <span class="comment">#提交更改</span></span><br><span class="line">compare        <span class="comment">#比较</span></span><br><span class="line">convert        <span class="comment">#转换</span></span><br><span class="line">info           <span class="comment">#获得信息</span></span><br><span class="line">map            <span class="comment">#映射</span></span><br><span class="line">snapshot       <span class="comment">#快照管理</span></span><br><span class="line">rebase         <span class="comment">#在已有的镜像的基础上创建新的镜像</span></span><br><span class="line">resize         <span class="comment">#调整大小</span></span><br><span class="line">amend          <span class="comment">#修订镜像格式选项</span></span><br></pre></td></tr></table></figure>

<h3 id="创建虚拟磁盘文件"><a href="#创建虚拟磁盘文件" class="headerlink" title="创建虚拟磁盘文件"></a>创建虚拟磁盘文件</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">qemu-img create [-q] [--object objectdef] [-f <span class="built_in">fmt</span>] [-b backing_file] [-F backing_fmt] [-u] [-o options] filename [size]</span><br></pre></td></tr></table></figure>

<h4 id="创建默认稀疏格式的磁盘"><a href="#创建默认稀疏格式的磁盘" class="headerlink" title="创建默认稀疏格式的磁盘"></a>创建默认稀疏格式的磁盘</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#默认为raw格式稀疏文件</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># qemu-img create vm1.img 1g</span></span><br><span class="line">Formatting <span class="string">&#x27;vm1.img&#x27;</span>, <span class="built_in">fmt</span>=raw size=1073741824</span><br><span class="line"></span><br><span class="line">[root@centos8 ~]<span class="comment"># file vm1.img </span></span><br><span class="line">vm1.img: data</span><br><span class="line"></span><br><span class="line"><span class="comment">#显示文件大小</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># ll -h vm1.img</span></span><br><span class="line">-rw-r--r-- 1 root root 1.0G Sep 20 12:17 vm1.img</span><br><span class="line"></span><br><span class="line"><span class="comment">#实际文件只占4k空间</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># du -h vm1.img </span></span><br><span class="line">4.0K vm1.img</span><br><span class="line"></span><br><span class="line"><span class="comment">#显示文件信息</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># qemu-img info vm1.img </span></span><br><span class="line">image: vm1.img</span><br><span class="line">file format: raw</span><br><span class="line">virtual size: 1.0G (1073741824 bytes)</span><br><span class="line">disk size: 4.0K</span><br></pre></td></tr></table></figure>

<h4 id="查看不同磁盘文件格式支持选项"><a href="#查看不同磁盘文件格式支持选项" class="headerlink" title="查看不同磁盘文件格式支持选项"></a>查看不同磁盘文件格式支持选项</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ~]<span class="comment"># qemu-img create -f raw -o ?</span></span><br><span class="line">Supported options:</span><br><span class="line">size             Virtual disk size</span><br><span class="line"></span><br><span class="line">[root@centos8 ~]<span class="comment"># qemu-img create -f qcow2 -o ?</span></span><br><span class="line">Supported options:</span><br><span class="line">size             Virtual disk size</span><br><span class="line">compat           Compatibility level (0.10 or 1.1)</span><br><span class="line">backing_file     File name of a base image</span><br><span class="line">backing_fmt      Image format of the base image</span><br><span class="line">encryption       Encrypt the image with format <span class="string">&#x27;aes&#x27;</span>. (Deprecated <span class="keyword">in</span> favor of encrypt.format=aes)</span><br><span class="line">encrypt.format   Encrypt the image, format choices: <span class="string">&#x27;aes&#x27;</span>, <span class="string">&#x27;luks&#x27;</span></span><br><span class="line">encrypt.key-secret ID of secret providing qcow AES key or LUKS passphrase</span><br><span class="line">encrypt.cipher-alg Name of encryption cipher algorithm</span><br><span class="line">encrypt.cipher-mode Name of encryption cipher mode</span><br><span class="line">encrypt.ivgen-alg Name of IV generator algorithm</span><br><span class="line">encrypt.ivgen-hash-alg Name of IV generator <span class="built_in">hash</span> algorithm</span><br><span class="line">encrypt.hash-alg Name of encryption <span class="built_in">hash</span> algorithm</span><br><span class="line">encrypt.iter-time Time to spend <span class="keyword">in</span> PBKDF <span class="keyword">in</span> milliseconds</span><br><span class="line">cluster_size     qcow2 cluster size</span><br><span class="line">preallocation    Preallocation mode (allowed values: off, metadata, falloc, full)</span><br><span class="line">lazy_refcounts   Postpone refcount updates</span><br><span class="line">refcount_bits    Width of a reference count entry <span class="keyword">in</span> bits</span><br></pre></td></tr></table></figure>

<h4 id="qcow2-格式选项"><a href="#qcow2-格式选项" class="headerlink" title="qcow2 格式选项"></a>qcow2 格式选项</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">backing_file          <span class="comment">#指定后端镜像文件</span></span><br><span class="line">backing_fmt           <span class="comment">#设置后端镜像的镜像格式</span></span><br><span class="line">cluster_size          <span class="comment">#设置镜像中的簇大小，取值在512到2M之间，默认值为64K</span></span><br><span class="line">preallocation         <span class="comment">#设置镜像文件空间的预分配模式</span></span><br><span class="line">encryption            <span class="comment">#用于设置加密</span></span><br></pre></td></tr></table></figure>

<h4 id="创建raw格式非稀疏文件"><a href="#创建raw格式非稀疏文件" class="headerlink" title="创建raw格式非稀疏文件"></a>创建raw格式非稀疏文件</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ~]<span class="comment"># dd if=/dev/zero of=vm2.img bs=1M count=1024</span></span><br><span class="line">1024+0 records <span class="keyword">in</span></span><br><span class="line">1024+0 records out</span><br><span class="line">1073741824 bytes (1.1 GB, 1.0 GiB) copied, 3.20332 s, 335 MB/s</span><br><span class="line"></span><br><span class="line">[root@centos8 ~]<span class="comment"># qemu-img info vm2.img </span></span><br><span class="line">image: vm2.img</span><br><span class="line">file format: raw</span><br><span class="line">virtual size: 1.0G (1073741824 bytes)</span><br><span class="line">disk size: 1.0G</span><br><span class="line"></span><br><span class="line">[root@centos8 ~]<span class="comment"># ls -hl vm2.img</span></span><br><span class="line">-rw-r--r-- 1 root root 1.0G Sep 20 12:31 vm2.img</span><br><span class="line"></span><br><span class="line">[root@centos8 ~]<span class="comment"># du -h vm2.img</span></span><br><span class="line">1.0G vm2.img</span><br></pre></td></tr></table></figure>

<h4 id="创建raw格式稀疏文件"><a href="#创建raw格式稀疏文件" class="headerlink" title="创建raw格式稀疏文件"></a>创建raw格式稀疏文件</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ~]<span class="comment"># dd if=/dev/zero of=vm3.img bs=1M count=0 seek=1024</span></span><br><span class="line">0+0 records <span class="keyword">in</span></span><br><span class="line">0+0 records out</span><br><span class="line">0 bytes copied, 9.2173e-05 s, 0.0 kB/s</span><br><span class="line"></span><br><span class="line">[root@centos8 ~]<span class="comment"># qemu-img info vm3.img </span></span><br><span class="line">image: vm3.img</span><br><span class="line">file format: raw</span><br><span class="line">virtual size: 1.0G (1073741824 bytes)</span><br><span class="line">disk size: 0</span><br><span class="line"></span><br><span class="line">[root@centos8 ~]<span class="comment"># ll -h vm3.img </span></span><br><span class="line">-rw-r--r-- 1 root root 1.0G Sep 20 12:34 vm3.img</span><br><span class="line"></span><br><span class="line">[root@centos8 ~]<span class="comment"># du -h vm3.img</span></span><br><span class="line">0 vm3.img</span><br></pre></td></tr></table></figure>

<h4 id="raw文件复制的格式控制"><a href="#raw文件复制的格式控制" class="headerlink" title="raw文件复制的格式控制"></a>raw文件复制的格式控制</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#复制非稀疏文件，默认也为非稀疏文件</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># cp vm2.img vm2.img.bak</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># du -h vm2.img.bak</span></span><br><span class="line">1.0G vm2.img.bak</span><br><span class="line"></span><br><span class="line">[root@centos8 ~]<span class="comment"># ll -h vm2.img.bak</span></span><br><span class="line">-rw-r--r-- 1 root root 1.0G Sep 20 12:38 vm2.img.bak</span><br><span class="line"></span><br><span class="line">[root@centos8 ~]<span class="comment"># qemu-img info vm2.img.bak</span></span><br><span class="line">image: vm2.img.bak</span><br><span class="line">file format: raw</span><br><span class="line">virtual size: 1.0G (1073741824 bytes)</span><br><span class="line">disk size: 1.0G</span><br><span class="line"></span><br><span class="line"><span class="comment">#复制稀疏文件，默认仍为稀疏文件</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># cp vm3.img vm3.img.bak</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># ll -h vm3.img.bak</span></span><br><span class="line">-rw-r--r-- 1 root root 1.0G Sep 20 12:36 vm3.img.bak</span><br><span class="line"></span><br><span class="line">[root@centos8 ~]<span class="comment"># du -h vm3.img.bak</span></span><br><span class="line">0 vm3.img.bak</span><br><span class="line"></span><br><span class="line">[root@centos8 ~]<span class="comment"># qemu-img info vm3.img.bak </span></span><br><span class="line">image: vm3.img.bak</span><br><span class="line">file format: raw</span><br><span class="line">virtual size: 1.0G (1073741824 bytes)</span><br><span class="line">disk size: 0</span><br><span class="line"></span><br><span class="line"><span class="comment">#指定将非稀疏文件复制为稀疏格式格式</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># cp --sparse=always vm2.img vm2.img.bak2</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># qemu-img info vm2.img</span></span><br><span class="line">image: vm2.img</span><br><span class="line">file format: raw</span><br><span class="line">virtual size: 1.0G (1073741824 bytes)</span><br><span class="line">disk size: 1.0G</span><br><span class="line"></span><br><span class="line">[root@centos8 ~]<span class="comment"># qemu-img info vm2.img.bak2</span></span><br><span class="line">image: vm2.img.bak2</span><br><span class="line">file format: raw</span><br><span class="line">virtual size: 1.0G (1073741824 bytes)</span><br><span class="line">disk size: 0</span><br><span class="line"></span><br><span class="line"><span class="comment">#指定将稀疏文件复制为非稀疏格式格式</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># cp --sparse=never vm3.img vm3.img.bak2</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># qemu-img info vm3.img</span></span><br><span class="line">image: vm3.img</span><br><span class="line">file format: raw</span><br><span class="line">virtual size: 1.0G (1073741824 bytes)</span><br><span class="line">disk size: 0</span><br><span class="line"></span><br><span class="line">[root@centos8 ~]<span class="comment"># qemu-img info vm3.img.bak2</span></span><br><span class="line">image: vm3.img.bak2</span><br><span class="line">file format: raw</span><br><span class="line">virtual size: 1.0G (1073741824 bytes)</span><br><span class="line">disk size: 1.0G</span><br></pre></td></tr></table></figure>

<h3 id="检查虚拟磁盘"><a href="#检查虚拟磁盘" class="headerlink" title="检查虚拟磁盘"></a>检查虚拟磁盘</h3><p>对于关机状态的虚拟机磁盘，可以检查文件错误</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ~]<span class="comment"># virsh list</span></span><br><span class="line"> Id   Name                           State</span><br><span class="line">----------------------------------------------------</span><br><span class="line">2     centos8                        running</span><br><span class="line"></span><br><span class="line">[root@centos8 ~]<span class="comment"># qemu-img check /var/lib/libvirt/images/centos8.qcow2 </span></span><br><span class="line">qemu-img: Could not open <span class="string">&#x27;/var/lib/libvirt/images/centos8.qcow2&#x27;</span>: Failed to get shared <span class="string">&quot;write&quot;</span> lock</span><br><span class="line">Is another process using the image [/var/lib/libvirt/images/centos8.qcow2]?</span><br><span class="line"></span><br><span class="line">[root@centos8 ~]<span class="comment"># virsh suspend centos8</span></span><br><span class="line">Domain centos8 suspended</span><br><span class="line"></span><br><span class="line">[root@centos8 ~]<span class="comment"># virsh list</span></span><br><span class="line"> Id   Name                           State</span><br><span class="line">----------------------------------------------------</span><br><span class="line">2     centos8                        paused</span><br><span class="line"></span><br><span class="line">[root@centos8 ~]<span class="comment"># qemu-img check /var/lib/libvirt/images/centos8.qcow2 </span></span><br><span class="line">qemu-img: Could not open <span class="string">&#x27;/var/lib/libvirt/images/centos8.qcow2&#x27;</span>: Failed to get shared <span class="string">&quot;write&quot;</span> lock</span><br><span class="line">Is another process using the image [/var/lib/libvirt/images/centos8.qcow2]?</span><br><span class="line"></span><br><span class="line">[root@centos8 ~]<span class="comment"># qemu-img check /var/lib/libvirt/images/centos7.qcow2 </span></span><br><span class="line">No errors were found on the image.</span><br><span class="line">25572/327680 = 7.80% allocated, 1.44% fragmented, 0.00% compressed clusters</span><br><span class="line">Image end offset: 1676869632</span><br></pre></td></tr></table></figure>

<h3 id="磁盘预分配策略"><a href="#磁盘预分配策略" class="headerlink" title="磁盘预分配策略"></a>磁盘预分配策略</h3><p>raw 文件的预分配策略和文件系统是否支持有关，而qcow2则无关</p>
<p>预分配策略</p>
<ul>
<li><p>off</p>
<p>此为缺省策略，即不使用预分配策略，预分配后的虚拟磁盘占用空间很小，不属于稀疏映像类型</p>
<p>生成的磁盘文件占用空间很小</p>
</li>
<li><p>metadata</p>
<p>只预分配元数据(metadata)，预分配后的磁盘文件属于稀疏映像类型，相当于vmware中的磁盘置备</p>
<p>选项: Thin Provision(精简配置)</p>
<p>生成的磁盘文件为稀疏格式，实际占用的空间比off策略稍大一些</p>
</li>
<li><p>falloc</p>
<p>分配文件的块并标识它们的状态为未初始化，即只分配空间，但不置零. 预分配后的虚拟磁盘属于非稀疏映像类型，相对full模式来说，创建虚拟磁盘的速度要快很多，相当于vmware中的磁盘置备选项: 厚置备延迟置零</p>
<p>生成的磁盘文件实际占用的空间和分配的空间相同大小</p>
</li>
<li><p>full</p>
<p>分配所有磁盘空间并置零，预分配后的虚拟磁盘属于非稀疏映像类型，创建最慢，相当于vmware中的磁盘置备选项: 厚置备置零</p>
<p>生成的磁盘文件实际占用的空间和分配的空间相同大小</p>
</li>
</ul>
<p>范例: 创建预分配置策略</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ~]<span class="comment"># qemu-img create -f qcow2 test1.qcow2 1g</span></span><br><span class="line">Formatting <span class="string">&#x27;test1.qcow2&#x27;</span>, <span class="built_in">fmt</span>=qcow2 size=1073741824 cluster_size=65536</span><br><span class="line">lazy_refcounts=off refcount_bits=16</span><br><span class="line"></span><br><span class="line">[root@centos8 ~]<span class="comment"># qemu-img info test1.qcow2 </span></span><br><span class="line">image: test1.qcow2</span><br><span class="line">file format: qcow2</span><br><span class="line">virtual size: 1.0G (1073741824 bytes)</span><br><span class="line">disk size: 196K</span><br><span class="line">cluster_size: 65536</span><br><span class="line">Format specific information:</span><br><span class="line">   compat: 1.1</span><br><span class="line">   lazy refcounts: <span class="literal">false</span></span><br><span class="line">   refcount bits: 16</span><br><span class="line">   corrupt: <span class="literal">false</span></span><br><span class="line">    </span><br><span class="line"><span class="comment">#指定关闭预分配</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># qemu-img create -f qcow2 test2.qcow2 1g -o preallocation=off</span></span><br><span class="line">Formatting <span class="string">&#x27;test2.qcow2&#x27;</span>, <span class="built_in">fmt</span>=qcow2 size=1073741824 cluster_size=65536</span><br><span class="line">preallocation=off lazy_refcounts=off refcount_bits=16</span><br><span class="line"></span><br><span class="line">[root@centos8 ~]<span class="comment"># qemu-img info test2.qcow2 </span></span><br><span class="line">image: test2.qcow2</span><br><span class="line">file format: qcow2</span><br><span class="line">virtual size: 1.0G (1073741824 bytes)</span><br><span class="line">disk size: 196K</span><br><span class="line">cluster_size: 65536</span><br><span class="line">Format specific information:</span><br><span class="line">   compat: 1.1</span><br><span class="line">   lazy refcounts: <span class="literal">false</span></span><br><span class="line">   refcount bits: 16</span><br><span class="line">   corrupt: <span class="literal">false</span></span><br><span class="line">   </span><br><span class="line"><span class="comment">#指定预分配metadata</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># qemu-img create -f qcow2 test3.qcow2 1g -o preallocation=metadata</span></span><br><span class="line">Formatting <span class="string">&#x27;test3.qcow2&#x27;</span>, <span class="built_in">fmt</span>=qcow2 size=1073741824 cluster_size=65536</span><br><span class="line">preallocation=metadata lazy_refcounts=off refcount_bits=16</span><br><span class="line"></span><br><span class="line">[root@centos8 ~]<span class="comment"># qemu-img info test3.qcow2 </span></span><br><span class="line">image: test3.qcow2</span><br><span class="line">file format: qcow2</span><br><span class="line">virtual size: 1.0G (1073741824 bytes)</span><br><span class="line">disk size: 836K</span><br><span class="line">cluster_size: 65536</span><br><span class="line">Format specific information:</span><br><span class="line">   compat: 1.1</span><br><span class="line">   lazy refcounts: <span class="literal">false</span></span><br><span class="line">   refcount bits: 16</span><br><span class="line">   corrupt: <span class="literal">false</span></span><br><span class="line">   </span><br><span class="line"><span class="comment">#指定预分配falloc</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># qemu-img create -f qcow2 test4.qcow2 1g -o preallocation=falloc</span></span><br><span class="line">Formatting <span class="string">&#x27;test4.qcow2&#x27;</span>, <span class="built_in">fmt</span>=qcow2 size=1073741824 cluster_size=65536</span><br><span class="line">preallocation=falloc lazy_refcounts=off refcount_bits=16</span><br><span class="line"></span><br><span class="line">[root@centos8 ~]<span class="comment"># qemu-img info test4.qcow2 </span></span><br><span class="line">image: test4.qcow2</span><br><span class="line">file format: qcow2</span><br><span class="line">virtual size: 1.0G (1073741824 bytes)</span><br><span class="line">disk size: 1.0G</span><br><span class="line">cluster_size: 65536</span><br><span class="line">Format specific information:</span><br><span class="line">   compat: 1.1</span><br><span class="line">   lazy refcounts: <span class="literal">false</span></span><br><span class="line">   refcount bits: 16</span><br><span class="line">   corrupt: <span class="literal">false</span></span><br><span class="line">   </span><br><span class="line"><span class="comment">#指定预分配full</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># qemu-img create -f qcow2 test5.qcow2 1g -o preallocation=full</span></span><br><span class="line">Formatting <span class="string">&#x27;test5.qcow2&#x27;</span>, <span class="built_in">fmt</span>=qcow2 size=1073741824 cluster_size=65536</span><br><span class="line">preallocation=full lazy_refcounts=off refcount_bits=16</span><br><span class="line"></span><br><span class="line">[root@centos8 ~]<span class="comment"># qemu-img info test5.qcow2 </span></span><br><span class="line">image: test5.qcow2</span><br><span class="line">file format: qcow2</span><br><span class="line">virtual size: 1.0G (1073741824 bytes)</span><br><span class="line">disk size: 1.0G</span><br><span class="line">cluster_size: 65536</span><br><span class="line">Format specific information:</span><br><span class="line">   compat: 1.1</span><br><span class="line">   lazy refcounts: <span class="literal">false</span></span><br><span class="line">   refcount bits: 16</span><br><span class="line">   corrupt: <span class="literal">false</span></span><br><span class="line">   </span><br><span class="line"><span class="comment">#文件系统显示大小</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># ll -h test*.qcow2</span></span><br><span class="line">-rw-r--r-- 1 root root 193K Sep 20 13:31 test1.qcow2</span><br><span class="line">-rw-r--r-- 1 root root 193K Sep 20 13:32 test2.qcow2</span><br><span class="line">-rw-r--r-- 1 root root 1.1G Sep 20 13:35 test3.qcow2</span><br><span class="line">-rw-r--r-- 1 root root 1.1G Sep 20 13:36 test4.qcow2</span><br><span class="line">-rw-r--r-- 1 root root 1.1G Sep 20 13:37 test5.qcow2</span><br><span class="line"></span><br><span class="line"><span class="comment">#查看真实大小</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># du -h test*.qcow2</span></span><br><span class="line">196K test1.qcow2</span><br><span class="line">196K test2.qcow2</span><br><span class="line">836K test3.qcow2</span><br><span class="line">1.1G test4.qcow2</span><br><span class="line">1.1G test5.qcow2</span><br></pre></td></tr></table></figure>

<h3 id="虚拟磁盘格式转换"><a href="#虚拟磁盘格式转换" class="headerlink" title="虚拟磁盘格式转换"></a>虚拟磁盘格式转换</h3><p>qemu-img 可以将不同格式的虚拟磁盘文件进行格式转化</p>
<p><strong>语法格式</strong></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">qemu-img convert [--object objectdef] [--image-opts] [--target-image-opts] [-U] </span><br><span class="line">[-C] [-c] [-p] [-q] [-n] [-f <span class="built_in">fmt</span>] [-t cache] [-T src_cache] [-O output_fmt] [-B </span><br><span class="line">backing_file] [-o options] [-s snapshot_id_or_name] [-l snapshot_param] [-S </span><br><span class="line">sparse_size] [-m num_coroutines] [-W] filename [filename2 [...]] output_filename</span><br></pre></td></tr></table></figure>

<p><strong>范例: 将vmdk转化为raw 和qcow2格式</strong></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ~]<span class="comment"># qemu-img info CentOS8.2.vmdk</span></span><br><span class="line">image: CentOS8.2.vmdk</span><br><span class="line">file format: vmdk</span><br><span class="line">virtual size: 200G (214748364800 bytes)</span><br><span class="line">disk size: 1.6G</span><br><span class="line">cluster_size: 65536</span><br><span class="line">Format specific information:</span><br><span class="line">   cid: 2898578192</span><br><span class="line">   parent cid: 4294967295</span><br><span class="line">   create <span class="built_in">type</span>: monolithicSparse</span><br><span class="line">   extents:</span><br><span class="line">       [0]:</span><br><span class="line">           virtual size: 214748364800</span><br><span class="line">           filename: CentOS8.2.vmdk</span><br><span class="line">           cluster size: 65536</span><br><span class="line">           format:</span><br><span class="line">           </span><br><span class="line"><span class="comment">#默认转化为raw格式</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># qemu-img convert CentOS8.2.vmdk CentOS8.2.img</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#比较大小</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># ll -h CentOS8.2.vmdk CentOS8.2.img </span></span><br><span class="line">-rw-r--r-- 1 root root 1.6G Sep 20 16:00 CentOS8.2.vmdk</span><br><span class="line">-rw-r--r-- 1 root root 200G Sep 20 16:10 CentOS8.2.img</span><br><span class="line"></span><br><span class="line">[root@centos8 ~]<span class="comment"># du -h CentOS8.2.vmdk CentOS8.2.img</span></span><br><span class="line">1.6G CentOS8.2.vmdk</span><br><span class="line">1.5G CentOS8.2.img</span><br><span class="line"></span><br><span class="line">[root@centos8 ~]<span class="comment"># qemu-img info CentOS8.2.img</span></span><br><span class="line">image: CentOS8.2.img</span><br><span class="line">file format: raw</span><br><span class="line">virtual size: 200G (214748364800 bytes)</span><br><span class="line">disk size: 1.4G</span><br><span class="line"></span><br><span class="line">[root@centos8 ~]<span class="comment"># mv CentOS8.2.img /var/lib/libvirt/images/</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># virt-install --import --name=centos8-test2 --vcpus=1 --ram=2048 \</span></span><br><span class="line">--disk bus=scsi,path=/var/lib/libvirt/images/CentOS8.2.img --network \</span><br><span class="line">network=default --graphics vnc,listen=0.0.0.0 --os-type=Linux --os-variant=centos8 --noautoconsole --boot hd</span><br><span class="line"></span><br><span class="line"><span class="comment">#转化为qcow2格式</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># qemu-img convert -f vmdk -O qcow2 CentOS8.2.vmdk </span></span><br><span class="line">CentOS8.2.qcow2</span><br><span class="line"></span><br><span class="line"><span class="comment">#比较大小</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># ll -h CentOS8.2.vmdk CentOS8.2.qcow2 </span></span><br><span class="line">-rw-r--r-- 1 root root 1.6G Sep 20 16:00 CentOS8.2.vmdk</span><br><span class="line">-rw-r--r-- 1 root root 1.6G Sep 20 16:12 CentOS8.2.qcow2</span><br><span class="line"></span><br><span class="line">[root@centos8 ~]<span class="comment"># du -h CentOS8.2.vmdk CentOS8.2.qcow2 </span></span><br><span class="line">1.6G CentOS8.2.vmdk</span><br><span class="line">1.6G CentOS8.2.qcow2</span><br><span class="line"></span><br><span class="line">[root@centos8 ~]<span class="comment"># qemu-img info CentOS8.2.qcow2 </span></span><br><span class="line">image: CentOS8.2.qcow2</span><br><span class="line">file format: qcow2</span><br><span class="line">virtual size: 200G (214748364800 bytes)</span><br><span class="line">disk size: 1.5G</span><br><span class="line">cluster_size: 65536</span><br><span class="line">Format specific information:</span><br><span class="line">   compat: 1.1</span><br><span class="line">   lazy refcounts: <span class="literal">false</span></span><br><span class="line">   refcount bits: 16</span><br><span class="line">   corrupt: <span class="literal">false</span></span><br><span class="line">    </span><br><span class="line">[root@centos8 ~]<span class="comment"># mv CentOS8.2.qcow2 /var/lib/libvirt/images/</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># virt-install --import --name=centos8-test3 --vcpus=1 --ram=2048 \</span></span><br><span class="line">--disk bus=scsi,path=/var/lib/libvirt/images/CentOS8.2.qcow2 --network \</span><br><span class="line">network=default --graphics vnc,listen=0.0.0.0 --os-type=Linux --os-variant=centos8 --noautoconsole --boot hd</span><br></pre></td></tr></table></figure>

<h3 id="调整虚拟磁盘大小"><a href="#调整虚拟磁盘大小" class="headerlink" title="调整虚拟磁盘大小"></a>调整虚拟磁盘大小</h3><p>虚拟磁盘文件创建后，还可以调整虚拟磁盘大小</p>
<p>语法格式</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">qemu-img resize [--shrink] filename [+l -]size</span><br></pre></td></tr></table></figure>

<ul>
<li>操作之前，一定要做好数据备份</li>
<li>增加文件大小后，需要在客户机中使用fdisk、parted等分区工具进行相应的操作才能真正让客户机使用到增加后的镜像空间。</li>
<li>缩小镜像之前，要在客户机中保证里面的文件系统有空余空间，否则会数据丢失。另外xfs文件系统不支持缩减</li>
<li>qcow2不支持缩小镜像的操作</li>
</ul>
<p>范例: 扩展虚拟磁盘</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ~]<span class="comment"># qemu-img info /var/lib/libvirt/images/centos8.qcow2 </span></span><br><span class="line">image: /var/lib/libvirt/images/centos8.qcow2</span><br><span class="line">file format: qcow2</span><br><span class="line">virtual size: 20G (21474836480 bytes)</span><br><span class="line">disk size: 20G</span><br><span class="line">cluster_size: 65536</span><br><span class="line">Format specific information:</span><br><span class="line">   compat: 1.1</span><br><span class="line">   lazy refcounts: <span class="literal">true</span></span><br><span class="line">   refcount bits: 16</span><br><span class="line">   corrupt: <span class="literal">false</span></span><br><span class="line">    </span><br><span class="line"><span class="comment">#增加10G空间</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># qemu-img resize /var/lib/libvirt/images/centos8.qcow2 +10G</span></span><br><span class="line">Image resized.</span><br><span class="line">[root@centos8 ~]<span class="comment"># qemu-img info /var/lib/libvirt/images/centos8.qcow2 </span></span><br><span class="line">image: /var/lib/libvirt/images/centos8.qcow2</span><br><span class="line">file format: qcow2</span><br><span class="line">virtual size: 30G (32212254720 bytes)</span><br><span class="line">disk size: 20G</span><br><span class="line">cluster_size: 65536</span><br><span class="line">Format specific information:</span><br><span class="line">   compat: 1.1</span><br><span class="line">   lazy refcounts: <span class="literal">true</span></span><br><span class="line">   refcount bits: 16</span><br><span class="line">   corrupt: <span class="literal">false</span></span><br><span class="line">   </span><br><span class="line"><span class="comment">#启动虚拟机后，还需要使用fdisk等工具进行空间的继续管理才能使用</span></span><br></pre></td></tr></table></figure>

<p><img src="../../../../images/SRE/day41/110.jpg" alt="110"></p>
<p>范例: 缩减虚拟磁盘</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 images]<span class="comment"># qemu-img info centos7.qcow2</span></span><br><span class="line">image: centos7.qcow2</span><br><span class="line">file format: qcow2</span><br><span class="line">virtual size: 20G (21474836480 bytes)</span><br><span class="line">disk size: 1.6G</span><br><span class="line">cluster_size: 65536</span><br><span class="line">Format specific information:</span><br><span class="line">   compat: 1.1</span><br><span class="line">   lazy refcounts: <span class="literal">false</span></span><br><span class="line">   refcount bits: 16</span><br><span class="line">   corrupt: <span class="literal">false</span></span><br><span class="line">   </span><br><span class="line">[root@centos8 images]<span class="comment"># qemu-img resize --shrink </span></span><br><span class="line">/var/lib/libvirt/images/centos7.qcow2 -2G</span><br><span class="line">Image resized.</span><br><span class="line"></span><br><span class="line">[root@centos8 images]<span class="comment"># qemu-img info centos7.qcow2</span></span><br><span class="line">image: centos7.qcow2</span><br><span class="line">file format: qcow2</span><br><span class="line">virtual size: 18G (19327352832 bytes)</span><br><span class="line">disk size: 1.6G</span><br><span class="line">cluster_size: 65536</span><br><span class="line">Format specific information:</span><br><span class="line">   compat: 1.1</span><br><span class="line">   lazy refcounts: <span class="literal">false</span></span><br><span class="line">   refcount bits: 16</span><br><span class="line">   corrupt: <span class="literal">false</span></span><br></pre></td></tr></table></figure>

<h2 id="磁盘快照管理"><a href="#磁盘快照管理" class="headerlink" title="磁盘快照管理"></a>磁盘快照管理</h2><h3 id="快照Snapshot介绍"><a href="#快照Snapshot介绍" class="headerlink" title="快照Snapshot介绍"></a>快照Snapshot介绍</h3><p>磁盘快照，对磁盘数据进行快照，主要用于虚拟机备份等场合</p>
<p>磁盘快照分类</p>
<ul>
<li><p>按快照信息保存分为:</p>
<p>内置快照∶快照数据和base磁盘数据放在同一个qcow2文件中</p>
<p>外置快照︰快照数据单独的另一个qcow2文件存放</p>
</li>
<li><p>按虚拟机状态可以分为:</p>
<p>关机态快照︰数据可以保证一致性</p>
<p>运行态快照∶数据无法保证一致性，类似与系统crash后的磁盘数据。使用是可能需要fsck等操作。</p>
</li>
<li><p>按磁盘数量可以分为:</p>
<p>单盘:单盘快照不涉及原子性</p>
<p>多盘:涉及原子性。主要分两个方面:1.是所有盘快照点相同2.所有盘要么都快照成功，要么都快照失败。主要依赖于qemu的transaction实现</p>
</li>
</ul>
<h3 id="qemu-img-管理磁盘快照"><a href="#qemu-img-管理磁盘快照" class="headerlink" title="qemu-img 管理磁盘快照"></a>qemu-img 管理磁盘快照</h3><p>命令格式</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">qemu-img snapshot [--object objectdef] [--image-opts] [-U] [-q] [-l | -a snapshot | -c snapshot | -d snapshot] filename</span><br><span class="line"></span><br><span class="line">snapshot is the name of the snapshot to create, apply or delete</span><br><span class="line">    -a applies a snapshot (revert disk to saved state)</span><br><span class="line">    -c creates a snapshot</span><br><span class="line">    -d deletes a snapshot</span><br><span class="line">    -l lists all snapshots <span class="keyword">in</span> the given image</span><br></pre></td></tr></table></figure>

<p>范例: </p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#查看块设备</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># virsh domblklist centos7</span></span><br><span class="line">Target     Source</span><br><span class="line">------------------------------------------------</span><br><span class="line">hda       /var/lib/libvirt/images/centos7.qcow2</span><br><span class="line">hdb        -</span><br><span class="line"></span><br><span class="line"><span class="comment">#查看快照，如果没有快照，则无显示信息</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># qemu-img snapshot -l /var/lib/libvirt/images/centos7.qcow2</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#创建快照</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># qemu-img snapshot -c centos7-s1 /var/lib/libvirt/images/centos7.qcow2</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#查看快照</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># qemu-img snapshot -l /var/lib/libvirt/images/centos7.qcow2</span></span><br><span class="line">Snapshot list:</span><br><span class="line">ID       TAG                 VM SIZE               DATE       VM CLOCK</span><br><span class="line">1         centos7-s1                0 2020-09-20 17:39:59   00:00:00.000</span><br><span class="line"></span><br><span class="line"><span class="comment">#查看快照信息</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># qemu-img info /var/lib/libvirt/images/centos7.qcow2</span></span><br><span class="line">image: /var/lib/libvirt/images/centos7.qcow2</span><br><span class="line">file format: qcow2</span><br><span class="line">virtual size: 20G (21474836480 bytes)</span><br><span class="line">disk size: 1.6G</span><br><span class="line">cluster_size: 65536</span><br><span class="line">Snapshot list:</span><br><span class="line">ID       TAG                 VM SIZE               DATE       VM CLOCK</span><br><span class="line">1         centos7-s1                0 2020-09-20 17:39:59   00:00:00.000</span><br><span class="line">Format specific information:</span><br><span class="line">   compat: 1.1</span><br><span class="line">   lazy refcounts: <span class="literal">false</span></span><br><span class="line">   refcount bits: 16</span><br><span class="line">   corrupt: <span class="literal">false</span></span><br><span class="line">   </span><br><span class="line"><span class="comment">#删除文件，模拟破坏</span></span><br></pre></td></tr></table></figure>

<p><img src="../../../../images/SRE/day41/111.jpg" alt="111"></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#关机后才能还原快照修复故障</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># qemu-img snapshot -a centos7-s1 </span></span><br><span class="line">/var/lib/libvirt/images/centos7.qcow2</span><br></pre></td></tr></table></figure>

<p>查看文件恢复</p>
<p><img src="../../../../images/SRE/day41/112.jpg" alt="112"></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#关机后才能删除快照</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># qemu-img snapshot -d centos7-s1 /var/lib/libvirt/images/centos7.qcow2</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># qemu-img snapshot -l /var/lib/libvirt/images/centos7.qcow2</span></span><br></pre></td></tr></table></figure>

<h3 id="virsh-管理虚拟机快照"><a href="#virsh-管理虚拟机快照" class="headerlink" title="virsh 管理虚拟机快照"></a>virsh 管理虚拟机快照</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ~]<span class="comment"># virsh snapshot-list centos8</span></span><br><span class="line"> Name                 Creation Time             State</span><br><span class="line">------------------------------------------------------------</span><br><span class="line"></span><br><span class="line"><span class="comment">#创建虚拟机快照</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># virsh snapshot-create centos8</span></span><br><span class="line">Domain snapshot 1600593611 created</span><br><span class="line"></span><br><span class="line">[root@centos8 ~]<span class="comment"># virsh snapshot-list centos8</span></span><br><span class="line"> Name                 Creation Time             State</span><br><span class="line">------------------------------------------------------------</span><br><span class="line">1600593611            2020-09-20 17:20:11 +0800 shutoff</span><br></pre></td></tr></table></figure>

<p><img src="../../../../images/SRE/day41/113.jpg" alt="113"></p>
<p><strong>使用virsh 命令还原快照</strong></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ~]<span class="comment"># virsh list</span></span><br><span class="line"> Id   Name                           State</span><br><span class="line">----------------------------------------------------</span><br><span class="line"></span><br><span class="line"><span class="comment">#无需关机，即可还原快照</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># virsh snapshot-revert centos8 --snapshotname 1600593611 --running</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># virsh list</span></span><br><span class="line"> Id   Name                           State</span><br><span class="line">----------------------------------------------------</span><br><span class="line">23   centos7                         running</span><br></pre></td></tr></table></figure>

<p><img src="../../../../images/SRE/day41/114.jpg" alt="114"></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#删除快照</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># virsh snapshot-delete centos8 --snapshotname 1600593611</span></span><br><span class="line">Domain snapshot 1600593611 deleted</span><br><span class="line"></span><br><span class="line">[root@centos8 ~]<span class="comment"># virsh snapshot-list centos8</span></span><br><span class="line"> Name                 Creation Time             State</span><br><span class="line">------------------------------------------------------------</span><br></pre></td></tr></table></figure>

<h1 id="网络管理"><a href="#网络管理" class="headerlink" title="网络管理"></a>网络管理</h1><p>官方文档:</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://wiki.libvirt.org/page/VirtualNetworking</span><br></pre></td></tr></table></figure>

<h2 id="Linux-网桥实现"><a href="#Linux-网桥实现" class="headerlink" title="Linux 网桥实现"></a>Linux 网桥实现</h2><p>范例: Ubuntu 配置网桥</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line">root@ubuntu1804:~<span class="comment"># apt install -y bridge-utils</span></span><br><span class="line">root@ubuntu1804:~<span class="comment"># dpkg -L bridge-utils</span></span><br><span class="line">/sbin/brctl</span><br><span class="line">......</span><br><span class="line"><span class="comment">#三个网卡配置使用一个配置文件</span></span><br><span class="line">root@ubuntu1804:~<span class="comment"># cat /etc/netplan/01-netcfg.yaml </span></span><br><span class="line"><span class="comment"># This file describes the network interfaces available on your system</span></span><br><span class="line"><span class="comment"># For more information, see netplan(5).</span></span><br><span class="line">network:</span><br><span class="line"> version: 2</span><br><span class="line"> renderer: networkd</span><br><span class="line"> ethernets:</span><br><span class="line">   eth0:</span><br><span class="line">     dhcp4: <span class="built_in">yes</span></span><br><span class="line">   eth1:</span><br><span class="line">     dhcp4: no</span><br><span class="line">     dhcp6: no</span><br><span class="line">   eth2:</span><br><span class="line">     dhcp4: no     </span><br><span class="line"> bridges:</span><br><span class="line">   br0:</span><br><span class="line">     dhcp4: no</span><br><span class="line">     dhcp6: no</span><br><span class="line">     addresses: [10.0.0.18/16]</span><br><span class="line">     gateway4: 10.0.0.2</span><br><span class="line">     nameservers:</span><br><span class="line">       addresses: [223.6.6.6]</span><br><span class="line">     interfaces:</span><br><span class="line">      - eth1</span><br><span class="line">      - eth2</span><br><span class="line">      </span><br><span class="line"><span class="comment">#桥接配置单独一个文件</span></span><br><span class="line">[root@ubuntu1804 netplan]<span class="comment">#cat br0.yaml</span></span><br><span class="line">network:</span><br><span class="line"> version: 2</span><br><span class="line"> renderer: networkd</span><br><span class="line"> ethernets:</span><br><span class="line">   eth1:</span><br><span class="line">     dhcp4: no</span><br><span class="line">     dhcp6: no</span><br><span class="line">   eth2:</span><br><span class="line">     dhcp4: no     </span><br><span class="line"> bridges:</span><br><span class="line">   br0:</span><br><span class="line">     dhcp4: no</span><br><span class="line">     dhcp6: no</span><br><span class="line">     addresses: [10.0.0.10/16]</span><br><span class="line">     gateway4: 10.0.0.2</span><br><span class="line">     nameservers:</span><br><span class="line">       addresses: [223.6.6.6]</span><br><span class="line">     interfaces:</span><br><span class="line">      - eth1</span><br><span class="line">      - eth2</span><br><span class="line">      </span><br><span class="line">root@ubuntu1804:~<span class="comment"># netplan apply</span></span><br><span class="line">root@ubuntu1804:~<span class="comment"># ifconfig br0</span></span><br><span class="line">br0: flags=4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt; mtu 1500</span><br><span class="line">       inet 10.0.0.18 netmask 255.255.0.0 broadcast 10.0.255.255</span><br><span class="line">       inet6 fe80::9cbe:1dff:fe85:6601 prefixlen 64 scopeid 0x20&lt;<span class="built_in">link</span>&gt;</span><br><span class="line">       ether 9e:be:1d:85:66:01 txqueuelen 1000 (Ethernet)</span><br><span class="line">       RX packets 158 bytes 19534 (19.5 KB)</span><br><span class="line">       RX errors 0 dropped 0 overruns 0 frame 0</span><br><span class="line">       TX packets 10 bytes 796 (796.0 B)</span><br><span class="line">       TX errors 0 dropped 0 overruns 0 carrier 0 collisions 0</span><br><span class="line">       </span><br><span class="line">root@ubuntu1804:~<span class="comment"># brctl show</span></span><br><span class="line">bridge name bridge <span class="built_in">id</span> STP enabled interfaces</span><br><span class="line">br0 8000.9ebe1d856601 no eth1</span><br><span class="line"> eth2</span><br></pre></td></tr></table></figure>

<p>范例: CentOS 配置网桥</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#创建网桥</span></span><br><span class="line">nmcli con add <span class="built_in">type</span> bridge con-name br0 ifname br0</span><br><span class="line">nmcli connection modify br0 ipv4.addresses 10.0.0.100/24 ipv4.method manual</span><br><span class="line">nmcli con up br0</span><br><span class="line"></span><br><span class="line"><span class="comment">#加入物理网卡</span></span><br><span class="line">nmcli con add <span class="built_in">type</span> bridge-slave con-name br0-port0 ifname eth0 master br0</span><br><span class="line">nmcli con add <span class="built_in">type</span> bridge-slave con-name br0-port1 ifname eth1 master br0</span><br><span class="line">nmcli con up br0-port0</span><br><span class="line">nmcli con up br0-port1</span><br><span class="line"></span><br><span class="line"><span class="comment">#查看网桥配置文件</span></span><br><span class="line"><span class="built_in">cat</span> /etc/sysconfig/network-scripts/ifcfg-br0</span><br><span class="line">DEVICE=br0</span><br><span class="line">NAME=br0</span><br><span class="line">STP=<span class="built_in">yes</span></span><br><span class="line">TYPE=Bridge</span><br><span class="line">BOOTPROTO=static</span><br><span class="line">IPADDR=10.0.0.100</span><br><span class="line">PREFIX=24</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="built_in">cat</span> /etc/sysconfig/network-scripts/ifcfg-br0-port0</span><br><span class="line">TYPE=Ethernet</span><br><span class="line">NAME=br0-port0</span><br><span class="line">DEVICE=eth0</span><br><span class="line">ONBOOT=<span class="built_in">yes</span></span><br><span class="line">BRIDGE=br0</span><br><span class="line">UUID=23f41d3b-b57c-4e26-9b17-d5f02dafd12d</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#安装管理软件包，注意:CentOS8取消了此包</span></span><br><span class="line">yum install bridge-utils</span><br><span class="line"></span><br><span class="line"><span class="comment">#查看网桥</span></span><br><span class="line">brctl show</span><br><span class="line">ip <span class="built_in">link</span> show master br0</span><br><span class="line">bridge <span class="built_in">link</span> show</span><br><span class="line"></span><br><span class="line"><span class="comment">#删除br0</span></span><br><span class="line">nmcli con down br0</span><br><span class="line"><span class="built_in">rm</span> /etc/sysconfig/network-scripts/ifcfg-br0*</span><br><span class="line">nmcli con reload</span><br></pre></td></tr></table></figure>

<h2 id="qemu-kvm支持的网络"><a href="#qemu-kvm支持的网络" class="headerlink" title="qemu-kvm支持的网络"></a>qemu-kvm支持的网络</h2><p>虚拟机的网络模式: </p>
<ul>
<li>基于NAT ( Network Addresss Translation)的虚拟网络，此为virt-install的默认模式</li>
<li>基于自定义网桥（Bridge ）的虚拟网络</li>
<li>用户自定义的隔离的虚拟网络</li>
<li>直接分配物理网络设备（包括VT-d和SR-IOV)，性能最好</li>
</ul>
<p>虚拟机的网卡设备:</p>
<ul>
<li>RTL8139、e1000、….</li>
<li>virtio 生产建议使用</li>
</ul>
<p>注意: 桥接物理网卡，会自动生成macvtap网卡，并且会导致本宿主机无法访问虚拟机，但其它物理机可以访问当前宿主机上面的虚拟机</p>
<p>范例: 查看qemu-kvm支持的网卡型号</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#Ubuntu20.04没有此命令</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># /usr/libexec/qemu-kvm -net nic,model=?</span></span><br><span class="line">qemu: Supported NIC models: e1000,e1000-82540em,e1000e,rtl8139,virtio-net-pci</span><br></pre></td></tr></table></figure>

<h2 id="默认的网络配置NAT模式"><a href="#默认的网络配置NAT模式" class="headerlink" title="默认的网络配置NAT模式"></a>默认的网络配置NAT模式</h2><h3 id="默认网络连接的架构图"><a href="#默认网络连接的架构图" class="headerlink" title="默认网络连接的架构图"></a>默认网络连接的架构图</h3><p>默认虚拟机网络配置为NAT模式，相当于vmware的NAT模式的Vmnet8</p>
<p><img src="../../../../images/SRE/day41/115.jpg" alt="115"></p>
<h3 id="宿主机默认网络相关服务和信息"><a href="#宿主机默认网络相关服务和信息" class="headerlink" title="宿主机默认网络相关服务和信息"></a>宿主机默认网络相关服务和信息</h3><p>默认宿主机安装dnsmasq包指供DHCP服务</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#Ubuntu20.04</span></span><br><span class="line">[root@ubuntu2004 ~]<span class="comment"># dpkg -l dnsmasq-base</span></span><br><span class="line">Desired=Unknown/Install/Remove/Purge/Hold</span><br><span class="line">| Status=Not/Inst/Conf-files/Unpacked/halF-conf/Half-inst/trig-aWait/Trig-pend</span><br><span class="line">|/ Err?=(none)/Reinst-required (Status,Err: uppercase=bad)</span><br><span class="line">||/ Name           Version           Architecture Description</span><br><span class="line">+++-==============-=================-============-</span><br><span class="line">============================================</span><br><span class="line">ii dnsmasq-base   2.80-1.1ubuntu1.5 amd64       Small caching DNS proxy and DHCP/TFTP server</span><br><span class="line"></span><br><span class="line">[root@ubuntu2004 ~]<span class="comment"># systemctl status libvirtd</span></span><br><span class="line">● libvirtd.service - Virtualization daemon</span><br><span class="line">     Loaded: loaded (/lib/systemd/system/libvirtd.service; enabled; vendor </span><br><span class="line">preset: enabled)</span><br><span class="line">     Active: active (running) since Fri 2022-10-14 08:28:10 CST; 7min ago</span><br><span class="line">TriggeredBy: ● libvirtd-admin.socket</span><br><span class="line">             ● libvirtd.socket</span><br><span class="line">             ● libvirtd-ro.socket</span><br><span class="line">       Docs: man:libvirtd(8)</span><br><span class="line">             https://libvirt.org</span><br><span class="line">   Main PID: 909 (libvirtd)</span><br><span class="line">      Tasks: 20 (<span class="built_in">limit</span>: 32768)</span><br><span class="line">     Memory: 50.7M</span><br><span class="line">     CGroup: /system.slice/libvirtd.service</span><br><span class="line">             ├─ 909 /usr/sbin/libvirtd</span><br><span class="line">             ├─1034 /usr/sbin/dnsmasq --conf-file=/var/lib/libvirt/dnsmasq/default.conf --leasefile-ro --dhcp-script=/usr/lib/libvirt/libvirt_leaseshelper</span><br><span class="line">             └─1035 /usr/sbin/dnsmasq --conf-file=/var/lib/libvirt/dnsmasq/default.conf --leasefile-ro --dhcp-script=/usr/lib/libvirt/libvirt_leaseshelpe</span><br><span class="line">             </span><br><span class="line">[root@ubuntu2004 ~]<span class="comment"># cat /var/lib/libvirt/dnsmasq/default.conf</span></span><br><span class="line"><span class="comment">##WARNING: THIS IS AN AUTO-GENERATED FILE. CHANGES TO IT ARE LIKELY TO BE</span></span><br><span class="line"><span class="comment">##OVERWRITTEN AND LOST. Changes to this configuration should be made using:</span></span><br><span class="line"><span class="comment">##   virsh net-edit default</span></span><br><span class="line"><span class="comment">## or other application using the libvirt API.</span></span><br><span class="line"><span class="comment">##</span></span><br><span class="line"><span class="comment">## dnsmasq conf file created by libvirt</span></span><br><span class="line">strict-order</span><br><span class="line">user=libvirt-dnsmasq</span><br><span class="line">pid-file=/run/libvirt/network/default.pid</span><br><span class="line">except-interface=lo</span><br><span class="line">bind-dynamic</span><br><span class="line">interface=virbr0</span><br><span class="line">dhcp-range=192.168.122.2,192.168.122.254,255.255.255.0</span><br><span class="line">dhcp-no-override</span><br><span class="line">dhcp-authoritative</span><br><span class="line">dhcp-lease-max=253</span><br><span class="line">dhcp-hostsfile=/var/lib/libvirt/dnsmasq/default.hostsfile</span><br><span class="line">addn-hosts=/var/lib/libvirt/dnsmasq/default.addnhosts</span><br><span class="line"></span><br><span class="line"><span class="comment">#CentOS</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># rpm -q dnsmasq </span></span><br><span class="line">dnsmasq-2.79-11.el8.x86_64</span><br><span class="line"></span><br><span class="line">[root@centos8 ~]<span class="comment"># cat /var/lib/libvirt/dnsmasq/default.conf </span></span><br><span class="line"><span class="comment">##WARNING: THIS IS AN AUTO-GENERATED FILE. CHANGES TO IT ARE LIKELY TO BE</span></span><br><span class="line"><span class="comment">##OVERWRITTEN AND LOST. Changes to this configuration should be made using:</span></span><br><span class="line"><span class="comment">##   virsh net-edit default</span></span><br><span class="line"><span class="comment">## or other application using the libvirt API.</span></span><br><span class="line"><span class="comment">##</span></span><br><span class="line"><span class="comment">## dnsmasq conf file created by libvirt</span></span><br><span class="line">strict-order</span><br><span class="line">pid-file=/var/run/libvirt/network/default.pid</span><br><span class="line">except-interface=lo</span><br><span class="line">bind-dynamic</span><br><span class="line">interface=virbr0</span><br><span class="line">dhcp-range=192.168.122.2,192.168.122.254</span><br><span class="line">dhcp-no-override</span><br><span class="line">dhcp-authoritative</span><br><span class="line">dhcp-lease-max=253</span><br><span class="line">dhcp-hostsfile=/var/lib/libvirt/dnsmasq/default.hostsfile</span><br><span class="line">addn-hosts=/var/lib/libvirt/dnsmasq/default.addnhosts</span><br></pre></td></tr></table></figure>

<p>范例：查看宿主机的网桥信息</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line">[root@ubuntu2004 ~]<span class="comment"># virsh list</span></span><br><span class="line"> Id   Name       State</span><br><span class="line">---------------------------</span><br><span class="line">1   centos7.9    running</span><br><span class="line">2   Win2008-2    running</span><br><span class="line"></span><br><span class="line">[root@ubuntu2004 ~]<span class="comment"># ip a</span></span><br><span class="line">1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group </span><br><span class="line">default qlen 1000</span><br><span class="line">   <span class="built_in">link</span>/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00</span><br><span class="line">   inet 127.0.0.1/8 scope host lo</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">   inet6 ::1/128 scope host</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">2: eth0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc fq_codel state UP </span><br><span class="line">group default qlen 1000</span><br><span class="line">   <span class="built_in">link</span>/ether 00:0c:29:90:c0:f3 brd ff:ff:ff:ff:ff:ff</span><br><span class="line">   inet 10.0.0.100/24 brd 10.0.0.255 scope global eth0</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">   inet6 fe80::20c:29ff:fe90:c0f3/64 scope <span class="built_in">link</span></span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">3: virbr0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue state UP </span><br><span class="line">group default qlen 1000</span><br><span class="line">   <span class="built_in">link</span>/ether 52:54:00:b3:39:58 brd ff:ff:ff:ff:ff:ff</span><br><span class="line">   inet 192.168.122.1/24 brd 192.168.122.255 scope global virbr0</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">4: virbr0-nic: &lt;BROADCAST,MULTICAST&gt; mtu 1500 qdisc fq_codel master virbr0 state </span><br><span class="line">DOWN group default qlen 1000</span><br><span class="line">   <span class="built_in">link</span>/ether 52:54:00:b3:39:58 brd ff:ff:ff:ff:ff:ff</span><br><span class="line">5: vnet0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc fq_codel master </span><br><span class="line">virbr0 state UNKNOWN group default qlen 1000</span><br><span class="line">   <span class="built_in">link</span>/ether fe:54:00:a7:80:b7 brd ff:ff:ff:ff:ff:ff</span><br><span class="line">   inet6 fe80::fc54:ff:fea7:80b7/64 scope <span class="built_in">link</span></span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">6: vnet1: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc fq_codel master </span><br><span class="line">virbr0 state UNKNOWN group default qlen 1000</span><br><span class="line">   <span class="built_in">link</span>/ether fe:54:00:64:13:db brd ff:ff:ff:ff:ff:ff</span><br><span class="line">   inet6 fe80::fc54:ff:fe64:13db/64 scope <span class="built_in">link</span></span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">       </span><br><span class="line">[root@ubuntu2004 ~]<span class="comment"># apt -y install bridge-utils</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#查看桥接信息</span></span><br><span class="line">[root@ubuntu2004 ~]<span class="comment"># brctl show</span></span><br><span class="line">bridge name bridge <span class="built_in">id</span> STP enabled interfaces</span><br><span class="line">virbr0 8000.525400b33958  <span class="built_in">yes</span> virbr0-nic</span><br><span class="line">                          vnet0</span><br><span class="line">                          vnet1</span><br><span class="line">                          </span><br><span class="line"><span class="comment">#查看virbr0网络的情况</span></span><br><span class="line">[root@ubuntu2004 ~]<span class="comment"># ip link show master virbr0</span></span><br><span class="line">4: virbr0-nic: &lt;BROADCAST,MULTICAST&gt; mtu 1500 qdisc fq_codel master virbr0 state </span><br><span class="line">DOWN mode DEFAULT group default qlen 1000</span><br><span class="line">   <span class="built_in">link</span>/ether 52:54:00:b3:39:58 brd ff:ff:ff:ff:ff:ff</span><br><span class="line">5: vnet0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc fq_codel master </span><br><span class="line">virbr0 state UNKNOWN mode DEFAULT group default qlen 1000</span><br><span class="line">   <span class="built_in">link</span>/ether fe:54:00:a7:80:b7 brd ff:ff:ff:ff:ff:ff</span><br><span class="line">6: vnet1: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc fq_codel master </span><br><span class="line">virbr0 state UNKNOWN mode DEFAULT group default qlen 1000</span><br><span class="line">   <span class="built_in">link</span>/ether fe:54:00:64:13:db brd ff:ff:ff:ff:ff:ff</span><br><span class="line">   </span><br><span class="line"><span class="comment">#查看所有桥接网卡信息及对应网桥</span></span><br><span class="line">[root@ubuntu2004 ~]<span class="comment"># bridge link show</span></span><br><span class="line">4: virbr0-nic: &lt;BROADCAST,MULTICAST&gt; mtu 1500 master virbr0 state disabled </span><br><span class="line">priority 32 cost 100</span><br><span class="line">5: vnet0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 master virbr0 state </span><br><span class="line">forwarding priority 32 cost 100</span><br><span class="line">6: vnet1: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 master virbr0 state </span><br><span class="line">forwarding priority 32 cost 100</span><br></pre></td></tr></table></figure>

<p>范例: 查看宿主机的网桥信息</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ~]<span class="comment"># virsh list --all</span></span><br><span class="line"> Id   Name                           State</span><br><span class="line">----------------------------------------------------</span><br><span class="line">-     centos7                        shut off</span><br><span class="line">-     centos7-2                      shut off</span><br><span class="line">-     centos8                        shut off</span><br><span class="line">-     Win_2008_r2-x86_64             shut off</span><br><span class="line"></span><br><span class="line">[root@centos8 ~]<span class="comment"># ip a</span></span><br><span class="line">1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group </span><br><span class="line">default qlen 1000</span><br><span class="line">   <span class="built_in">link</span>/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00</span><br><span class="line">   inet 127.0.0.1/8 scope host lo</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">   inet6 ::1/128 scope host </span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">2: eth0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc fq_codel state UP </span><br><span class="line">group default qlen 1000</span><br><span class="line">   <span class="built_in">link</span>/ether 00:0c:29:44:c3:fe brd ff:ff:ff:ff:ff:ff</span><br><span class="line">   inet 10.0.0.8/24 brd 10.0.0.255 scope global noprefixroute eth0</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">   inet6 fe80::20c:29ff:fe44:c3fe/64 scope <span class="built_in">link</span> </span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">3: virbr0: &lt;NO-CARRIER,BROADCAST,MULTICAST,UP&gt; mtu 1500 qdisc noqueue state DOWN </span><br><span class="line">group default qlen 1000</span><br><span class="line">   <span class="built_in">link</span>/ether 52:54:00:52:f2:5c brd ff:ff:ff:ff:ff:ff</span><br><span class="line">   inet 192.168.122.1/24 brd 192.168.122.255 scope global virbr0</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">4: virbr0-nic: &lt;BROADCAST,MULTICAST&gt; mtu 1500 qdisc fq_codel master virbr0 state </span><br><span class="line">DOWN group default qlen 1000</span><br><span class="line">   <span class="built_in">link</span>/ether 52:54:00:52:f2:5c brd ff:ff:ff:ff:ff:ff</span><br><span class="line">   </span><br><span class="line">[root@centos8 ~]<span class="comment"># virsh list</span></span><br><span class="line"> Id   Name                           State</span><br><span class="line">----------------------------------------------------</span><br><span class="line">2     centos7                        running</span><br><span class="line">3     centos8                        running</span><br><span class="line"></span><br><span class="line">[root@centos8 ~]<span class="comment"># virsh start centos7 </span></span><br><span class="line">Domain centos7 started</span><br><span class="line"></span><br><span class="line">[root@centos8 ~]<span class="comment"># virsh start centos8</span></span><br><span class="line">Domain centos8 started</span><br><span class="line"></span><br><span class="line">[root@centos8 ~]<span class="comment"># ip a</span></span><br><span class="line">1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group </span><br><span class="line">default qlen 1000</span><br><span class="line">   <span class="built_in">link</span>/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00</span><br><span class="line">   inet 127.0.0.1/8 scope host lo</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">   inet6 ::1/128 scope host </span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">2: eth0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc fq_codel state UP </span><br><span class="line">group default qlen 1000</span><br><span class="line">   <span class="built_in">link</span>/ether 00:0c:29:44:c3:fe brd ff:ff:ff:ff:ff:ff</span><br><span class="line">   inet 10.0.0.8/24 brd 10.0.0.255 scope global noprefixroute eth0</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">   inet6 fe80::20c:29ff:fe44:c3fe/64 scope <span class="built_in">link</span> </span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">3: virbr0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue state UP </span><br><span class="line">group default qlen 1000</span><br><span class="line">   <span class="built_in">link</span>/ether 52:54:00:52:f2:5c brd ff:ff:ff:ff:ff:ff</span><br><span class="line">   inet 192.168.122.1/24 brd 192.168.122.255 scope global virbr0</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">4: virbr0-nic: &lt;BROADCAST,MULTICAST&gt; mtu 1500 qdisc fq_codel master virbr0 state </span><br><span class="line">DOWN group default qlen 1000</span><br><span class="line">   <span class="built_in">link</span>/ether 52:54:00:52:f2:5c brd ff:ff:ff:ff:ff:ff</span><br><span class="line">6: vnet0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc fq_codel master </span><br><span class="line">virbr0 state UNKNOWN group default qlen 1000</span><br><span class="line">   <span class="built_in">link</span>/ether fe:54:00:95:25:fb brd ff:ff:ff:ff:ff:ff</span><br><span class="line">   inet6 fe80::fc54:ff:fe95:25fb/64 scope <span class="built_in">link</span> </span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">7: vnet1: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc fq_codel master </span><br><span class="line">virbr0 state UNKNOWN group default qlen 1000</span><br><span class="line">   <span class="built_in">link</span>/ether fe:54:00:83:9d:51 brd ff:ff:ff:ff:ff:ff</span><br><span class="line">   inet6 fe80::fc54:ff:fe83:9d51/64 scope <span class="built_in">link</span> </span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">       </span><br><span class="line"><span class="comment">#查看virbr0网络的情况</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># ip link show master virbr0</span></span><br><span class="line">4: virbr0-nic: &lt;BROADCAST,MULTICAST&gt; mtu 1500 qdisc fq_codel master virbr0 state </span><br><span class="line">DOWN mode DEFAULT group default qlen 1000</span><br><span class="line">   <span class="built_in">link</span>/ether 52:54:00:52:f2:5c brd ff:ff:ff:ff:ff:ff</span><br><span class="line">8: vnet0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc fq_codel master </span><br><span class="line">virbr0 state UNKNOWN mode DEFAULT group default qlen 1000</span><br><span class="line">   <span class="built_in">link</span>/ether fe:54:00:95:25:fb brd ff:ff:ff:ff:ff:ff</span><br><span class="line">9: vnet1: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc fq_codel master </span><br><span class="line">virbr0 state UNKNOWN mode DEFAULT group default qlen 1000</span><br><span class="line">   <span class="built_in">link</span>/ether fe:54:00:83:9d:51 brd ff:ff:ff:ff:ff:ff</span><br><span class="line">   </span><br><span class="line"><span class="comment">#查看所有桥接网卡信息及对应网桥</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># bridge link show</span></span><br><span class="line">4: virbr0-nic: &lt;BROADCAST,MULTICAST&gt; mtu 1500 master virbr0 state disabled </span><br><span class="line">priority 32 cost 100</span><br><span class="line">8: vnet0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 master virbr0 state </span><br><span class="line">forwarding priority 32 cost 100</span><br><span class="line">9: vnet1: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 master virbr0 state </span><br><span class="line">forwarding priority 32 cost 100</span><br><span class="line"></span><br><span class="line">[root@centos8 ~]<span class="comment"># nmtui</span></span><br></pre></td></tr></table></figure>

<p><img src="../../../../images/SRE/day41/116.jpg" alt="116"><br><img src="../../../../images/SRE/day41/117.jpg" alt="117"><br><img src="../../../../images/SRE/day41/118.jpg" alt="118"><br><img src="../../../../images/SRE/day41/119.jpg" alt="119"><br><img src="../../../../images/SRE/day41/120.jpg" alt="120"></p>
<p><img src="../../../../images/SRE/day41/121.jpg" alt="121"></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ~]<span class="comment"># virsh net-list</span></span><br><span class="line"> Name                 State     Autostart     Persistent</span><br><span class="line">----------------------------------------------------------</span><br><span class="line"> default             active     <span class="built_in">yes</span>           <span class="built_in">yes</span></span><br><span class="line"> </span><br><span class="line">[root@centos8 ~]<span class="comment"># cat /etc/libvirt/qemu/networks/default.xml</span></span><br><span class="line">&lt;network&gt;</span><br><span class="line"> &lt;name&gt;default&lt;/name&gt;</span><br><span class="line"> &lt;uuid&gt;5962db15-2851-4825-b516-9bc2eb4d9ee0&lt;/uuid&gt;</span><br><span class="line"> &lt;forward mode=<span class="string">&#x27;nat&#x27;</span>/&gt;</span><br><span class="line"> &lt;bridge name=<span class="string">&#x27;virbr0&#x27;</span> stp=<span class="string">&#x27;on&#x27;</span> delay=<span class="string">&#x27;0&#x27;</span>/&gt;</span><br><span class="line"> &lt;mac address=<span class="string">&#x27;52:54:00:52:f2:5c&#x27;</span>/&gt;</span><br><span class="line"> &lt;ip address=<span class="string">&#x27;192.168.122.1&#x27;</span> netmask=<span class="string">&#x27;255.255.255.0&#x27;</span>&gt;</span><br><span class="line">   &lt;dhcp&gt;</span><br><span class="line">     &lt;range start=<span class="string">&#x27;192.168.122.2&#x27;</span> end=<span class="string">&#x27;192.168.122.254&#x27;</span>/&gt;</span><br><span class="line">   &lt;/dhcp&gt;</span><br><span class="line"> &lt;/ip&gt;</span><br><span class="line">&lt;/network&gt;</span><br><span class="line"></span><br><span class="line">[root@centos8 ~]<span class="comment"># virsh net-dumpxml default </span></span><br><span class="line">&lt;network connections=<span class="string">&#x27;1&#x27;</span>&gt;</span><br><span class="line"> &lt;name&gt;default&lt;/name&gt;</span><br><span class="line"> &lt;uuid&gt;5962db15-2851-4825-b516-9bc2eb4d9ee0&lt;/uuid&gt;</span><br><span class="line"> &lt;forward mode=<span class="string">&#x27;nat&#x27;</span>&gt;</span><br><span class="line">   &lt;nat&gt;</span><br><span class="line">     &lt;port start=<span class="string">&#x27;1024&#x27;</span> end=<span class="string">&#x27;65535&#x27;</span>/&gt;</span><br><span class="line">   &lt;/nat&gt;</span><br><span class="line"> &lt;/forward&gt;</span><br><span class="line"> &lt;bridge name=<span class="string">&#x27;virbr0&#x27;</span> stp=<span class="string">&#x27;on&#x27;</span> delay=<span class="string">&#x27;0&#x27;</span>/&gt;</span><br><span class="line"> &lt;mac address=<span class="string">&#x27;52:54:00:52:f2:5c&#x27;</span>/&gt;</span><br><span class="line"> &lt;ip address=<span class="string">&#x27;192.168.122.1&#x27;</span> netmask=<span class="string">&#x27;255.255.255.0&#x27;</span>&gt;</span><br><span class="line">   &lt;dhcp&gt;</span><br><span class="line">     &lt;range start=<span class="string">&#x27;192.168.122.2&#x27;</span> end=<span class="string">&#x27;192.168.122.254&#x27;</span>/&gt;</span><br><span class="line">   &lt;/dhcp&gt;</span><br><span class="line"> &lt;/ip&gt;</span><br><span class="line">&lt;/network&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment">#查看NAT策略实现从虚拟机可以访问外部网络，反之不通，此策略由libvirtd服务启动时自动加载到NAT表</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># iptables -vnL -t nat</span></span><br><span class="line">Chain PREROUTING (policy ACCEPT 0 packets, 0 bytes)</span><br><span class="line"> pkts bytes target     prot opt <span class="keyword">in</span>     out     <span class="built_in">source</span>               destination</span><br><span class="line">Chain INPUT (policy ACCEPT 0 packets, 0 bytes)</span><br><span class="line"> pkts bytes target     prot opt <span class="keyword">in</span>     out     <span class="built_in">source</span>               destination</span><br><span class="line">Chain POSTROUTING (policy ACCEPT 0 packets, 0 bytes)</span><br><span class="line"> pkts bytes target     prot opt <span class="keyword">in</span>     out     <span class="built_in">source</span>               destination </span><br><span class="line">    0     0 RETURN     all  -- *     *       192.168.122.0/24     224.0.0.0/24</span><br><span class="line">    0     0 RETURN     all  -- *     *       192.168.122.0/24     255.255.255.255     </span><br><span class="line">    0     0 MASQUERADE tcp  -- *     *       192.168.122.0/24     !192.168.122.0/24     masq ports: 1024-65535</span><br><span class="line">    8   608 MASQUERADE udp  -- *     *       192.168.122.0/24     !192.168.122.0/24     masq ports: 1024-65535</span><br><span class="line">    1    84 MASQUERADE all  -- *     *       192.168.122.0/24     !192.168.122.0/24    </span><br><span class="line">Chain OUTPUT (policy ACCEPT 0 packets, 0 bytes)</span><br><span class="line"> pkts bytes target     prot opt <span class="keyword">in</span>     out     <span class="built_in">source</span>               destination</span><br></pre></td></tr></table></figure>

<h3 id="虚拟机网卡默认设置"><a href="#虚拟机网卡默认设置" class="headerlink" title="虚拟机网卡默认设置"></a>虚拟机网卡默认设置</h3><p>Ubutun20.04的虚拟机默认网卡设置</p>
<p><img src="../../../../images/SRE/day41/122.jpg" alt="122"></p>
<p>Rocky8的虚拟机默认网卡设置</p>
<p><img src="../../../../images/SRE/day41/123.jpg" alt="123"><br><img src="../../../../images/SRE/day41/124.jpg" alt="124"><br><img src="../../../../images/SRE/day41/125.jpg" alt="125"><br><img src="../../../../images/SRE/day41/126.jpg" alt="126"><br><img src="../../../../images/SRE/day41/127.jpg" alt="127"></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ~]<span class="comment"># virsh dumpxml centos7 |sed -n &#x27;/interface/,/interface/p&#x27; </span></span><br><span class="line">  &lt;interface <span class="built_in">type</span>=<span class="string">&#x27;network&#x27;</span>&gt;</span><br><span class="line">     &lt;mac address=<span class="string">&#x27;52:54:00:95:25:fb&#x27;</span>/&gt;</span><br><span class="line">     &lt;<span class="built_in">source</span> network=<span class="string">&#x27;default&#x27;</span> bridge=<span class="string">&#x27;virbr0&#x27;</span>/&gt;</span><br><span class="line">     &lt;target dev=<span class="string">&#x27;vnet0&#x27;</span>/&gt;</span><br><span class="line">     &lt;model <span class="built_in">type</span>=<span class="string">&#x27;virtio&#x27;</span>/&gt;</span><br><span class="line">     &lt;<span class="built_in">alias</span> name=<span class="string">&#x27;net0&#x27;</span>/&gt;</span><br><span class="line">     &lt;address <span class="built_in">type</span>=<span class="string">&#x27;pci&#x27;</span> domain=<span class="string">&#x27;0x0000&#x27;</span> bus=<span class="string">&#x27;0x00&#x27;</span> slot=<span class="string">&#x27;0x03&#x27;</span> <span class="keyword">function</span>=<span class="string">&#x27;0x0&#x27;</span>/&gt;</span><br><span class="line">   &lt;/interface&gt;</span><br></pre></td></tr></table></figure>

<h3 id="virsh-查看虚拟机网络配置"><a href="#virsh-查看虚拟机网络配置" class="headerlink" title="virsh 查看虚拟机网络配置"></a>virsh 查看虚拟机网络配置</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#查看虚拟机的网卡配置</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># virsh domiflist centos8</span></span><br><span class="line">Interface Type       Source     Model       MAC</span><br><span class="line">-------------------------------------------------------</span><br><span class="line">vnet0     network   default   virtio      52:54:00:83:9d:51</span><br><span class="line"></span><br><span class="line"><span class="comment">#查看虚拟机的网卡地址信息</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># virsh domifaddr centos8</span></span><br><span class="line"> Name       MAC address         Protocol     Address</span><br><span class="line">-------------------------------------------------------------------------------</span><br><span class="line"> vnet0      52:54:00:83:9d:51   ipv4         192.168.122.94/24</span><br><span class="line"> </span><br><span class="line"><span class="comment">#查看虚拟机的指定网卡的状态</span></span><br><span class="line">[root@centos8 ~]<span class="comment">#virsh domifstat centos8 vnet0</span></span><br><span class="line">vnet0 rx_bytes 39672</span><br><span class="line">vnet0 rx_packets 739</span><br><span class="line">vnet0 rx_errs 0</span><br><span class="line">vnet0 rx_drop 0</span><br><span class="line">vnet0 tx_bytes 1742</span><br><span class="line">vnet0 tx_packets 19</span><br><span class="line">vnet0 tx_errs 0</span><br><span class="line">vnet0 tx_drop 0</span><br></pre></td></tr></table></figure>

<h2 id="配置虚拟机网卡桥接到宿主机的物理网卡"><a href="#配置虚拟机网卡桥接到宿主机的物理网卡" class="headerlink" title="配置虚拟机网卡桥接到宿主机的物理网卡"></a>配置虚拟机网卡桥接到宿主机的物理网卡</h2><p>相当于vmware的桥接模式的Vmnet0</p>
<p><strong>Ubuntu20.04 宿主机的虚拟机界面如下</strong></p>
<p>选择Network source 为 Host deivce eth0: macvtap</p>
<p><img src="../../../../images/SRE/day41/128.jpg" alt="128"></p>
<p><strong>Rocky8 宿主机的虚拟机界面如下</strong></p>
<p>需要手动输入device name 为 eth0</p>
<p><img src="../../../../images/SRE/day41/129.jpg" alt="129"></p>
<p><strong>CentOS 7 界面如下</strong></p>
<p><img src="../../../../images/SRE/day41/130.jpg" alt="130"><br><img src="../../../../images/SRE/day41/131.jpg" alt="131"></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ~]<span class="comment"># virsh domiflist centos7</span></span><br><span class="line">Interface Type       Source     Model       MAC</span><br><span class="line">-------------------------------------------------------</span><br><span class="line">macvtap0   direct     eth0       virtio      52:54:00:95:25:fb</span><br><span class="line"></span><br><span class="line">[root@centos8 ~]<span class="comment"># virsh domifaddr centos7</span></span><br><span class="line"> Name       MAC address         Protocol     Address</span><br><span class="line">-------------------------------------------------------------------------------</span><br></pre></td></tr></table></figure>

<p><img src="../../../../images/SRE/day41/132.jpg" alt="132"></p>
<p>在宿主机上自动生成虚拟网卡macvtap0@eth0</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ~]<span class="comment"># ip a</span></span><br><span class="line">1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group </span><br><span class="line">default qlen 1000</span><br><span class="line">   <span class="built_in">link</span>/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00</span><br><span class="line">   inet 127.0.0.1/8 scope host lo</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">   inet6 ::1/128 scope host </span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">2: eth0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc fq_codel state UP </span><br><span class="line">group default qlen 1000</span><br><span class="line">   <span class="built_in">link</span>/ether 00:0c:29:e1:0e:53 brd ff:ff:ff:ff:ff:ff</span><br><span class="line">   inet 10.0.0.8/24 brd 10.0.0.255 scope global noprefixroute eth0</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">   inet6 fe80::20c:29ff:fee1:e53/64 scope <span class="built_in">link</span> </span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">3: virbr0: &lt;NO-CARRIER,BROADCAST,MULTICAST,UP&gt; mtu 1500 qdisc noqueue state DOWN </span><br><span class="line">group default qlen 1000</span><br><span class="line">   <span class="built_in">link</span>/ether 52:54:00:8b:be:ee brd ff:ff:ff:ff:ff:ff</span><br><span class="line">   inet 192.168.122.1/24 brd 192.168.122.255 scope global virbr0</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">4: virbr0-nic: &lt;BROADCAST,MULTICAST&gt; mtu 1500 qdisc fq_codel master virbr0 state </span><br><span class="line">DOWN group default qlen 1000</span><br><span class="line">   <span class="built_in">link</span>/ether 52:54:00:8b:be:ee brd ff:ff:ff:ff:ff:ff</span><br><span class="line">6: macvtap0@eth0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc fq_codel </span><br><span class="line">state UP group default qlen 500</span><br><span class="line">   <span class="built_in">link</span>/ether 52:54:00:0d:8a:0e brd ff:ff:ff:ff:ff:ff</span><br><span class="line">   inet6 fe80::5054:ff:fe0d:8a0e/64 scope <span class="built_in">link</span> </span><br><span class="line">       valid_lft forever preferred_lft forever</span><br></pre></td></tr></table></figure>

<h2 id="基于自定义网桥的虚拟网络"><a href="#基于自定义网桥的虚拟网络" class="headerlink" title="基于自定义网桥的虚拟网络"></a>基于自定义网桥的虚拟网络</h2><h3 id="自定义网桥架构"><a href="#自定义网桥架构" class="headerlink" title="自定义网桥架构"></a>自定义网桥架构</h3><p>桥接网络可以让运行在宿主机上的虚拟机使用和宿主机相同网段的IP，并且可以从外部直接访问到虚拟机，目前企业中大部分场景都使用桥接网络。</p>
<p><img src="../../../../images/SRE/day41/133.jpg" alt="133"></p>
<h3 id="在宿主机创建网桥"><a href="#在宿主机创建网桥" class="headerlink" title="在宿主机创建网桥"></a>在宿主机创建网桥</h3><h4 id="CentOS-创建桥接网卡"><a href="#CentOS-创建桥接网卡" class="headerlink" title="CentOS 创建桥接网卡"></a>CentOS 创建桥接网卡</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 network-scripts]<span class="comment"># pwd</span></span><br><span class="line">/etc/sysconfig/network-scripts</span><br><span class="line"></span><br><span class="line"><span class="comment">#创建网桥配置文件</span></span><br><span class="line">[root@centos8 network-scripts]<span class="comment"># cat ifcfg-virbr1 </span></span><br><span class="line">TYPE=Bridge</span><br><span class="line">NAME=virbr1</span><br><span class="line">DEVICE=virbr1</span><br><span class="line">ONBOOT=<span class="built_in">yes</span></span><br><span class="line">BOOTPROTO=static</span><br><span class="line">IPADDR=10.0.0.8</span><br><span class="line">NETMASK=255.255.255.0</span><br><span class="line">GATEWAY=10.0.0.2</span><br><span class="line">DNS1=180.76.76.76</span><br><span class="line">DNS2=223.6.6.6</span><br><span class="line"></span><br><span class="line"><span class="comment">#将物理网卡eth0加入网桥</span></span><br><span class="line">[root@centos8 network-scripts]<span class="comment"># cat ifcfg-eth0 </span></span><br><span class="line">TYPE=Ethernet</span><br><span class="line">NAME=eth0</span><br><span class="line">DEVICE=eth0</span><br><span class="line">ONBOOT=<span class="built_in">yes</span></span><br><span class="line">BRIDGE=virbr1</span><br><span class="line"></span><br><span class="line">[root@centos8 network-scripts]<span class="comment"># nmcli connection reload</span></span><br><span class="line">[root@centos8 network-scripts]<span class="comment"># nmcli connection up eth0 virbr1</span></span><br><span class="line">      </span><br><span class="line">[root@centos8 ~]<span class="comment"># ip a</span></span><br><span class="line">1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group </span><br><span class="line">default qlen 1000</span><br><span class="line">   <span class="built_in">link</span>/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00</span><br><span class="line">   inet 127.0.0.1/8 scope host lo</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">   inet6 ::1/128 scope host </span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">2: eth0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc fq_codel master virbr1 </span><br><span class="line">state UP group default qlen 1000</span><br><span class="line">   <span class="built_in">link</span>/ether 00:0c:29:44:c3:fe brd ff:ff:ff:ff:ff:ff</span><br><span class="line">4: virbr0: &lt;NO-CARRIER,BROADCAST,MULTICAST,UP&gt; mtu 1500 qdisc noqueue state DOWN </span><br><span class="line">group default qlen 1000</span><br><span class="line">   <span class="built_in">link</span>/ether 52:54:00:52:f2:5c brd ff:ff:ff:ff:ff:ff</span><br><span class="line">   inet 192.168.122.1/24 brd 192.168.122.255 scope global virbr0</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">5: virbr0-nic: &lt;BROADCAST,MULTICAST&gt; mtu 1500 qdisc fq_codel master virbr0 state </span><br><span class="line">DOWN group default qlen 1000</span><br><span class="line">   <span class="built_in">link</span>/ether 52:54:00:52:f2:5c brd ff:ff:ff:ff:ff:ff</span><br><span class="line">18: virbr1: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue state UP </span><br><span class="line">group default qlen 1000</span><br><span class="line">   <span class="built_in">link</span>/ether 00:0c:29:44:c3:fe brd ff:ff:ff:ff:ff:ff</span><br><span class="line">   inet 10.0.0.8/24 brd 10.0.0.255 scope global noprefixroute virbr1</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">   inet6 fe80::8055:c0ff:fe4e:411e/64 scope <span class="built_in">link</span> </span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">       </span><br><span class="line">[root@centos8 ~]<span class="comment"># bridge link show</span></span><br><span class="line">2: eth0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 master virbr1 state </span><br><span class="line">forwarding priority 32 cost 100</span><br><span class="line">5: virbr0-nic: &lt;BROADCAST,MULTICAST&gt; mtu 1500 master virbr0 state disabled </span><br><span class="line">priority 32 cost 100</span><br><span class="line"></span><br><span class="line">[root@centos8 ~]<span class="comment"># ip link show master virbr1</span></span><br><span class="line">2: eth0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc fq_codel master virbr1 </span><br><span class="line">state UP mode DEFAULT group default qlen 1000</span><br><span class="line">   <span class="built_in">link</span>/ether 00:0c:29:44:c3:fe brd ff:ff:ff:ff:ff:ff</span><br></pre></td></tr></table></figure>

<h4 id="Ubuntu-创建桥接网卡"><a href="#Ubuntu-创建桥接网卡" class="headerlink" title="Ubuntu 创建桥接网卡"></a>Ubuntu 创建桥接网卡</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">[root@ubuntu2004 ~]<span class="comment"># cat /etc/netplan/01-netcfg.yaml</span></span><br><span class="line"><span class="comment"># This file describes the network interfaces available on your system</span></span><br><span class="line"><span class="comment"># For more information, see netplan(5).</span></span><br><span class="line">network:</span><br><span class="line"> version: 2</span><br><span class="line"> renderer: networkd</span><br><span class="line"> ethernets:</span><br><span class="line">   eth0:</span><br><span class="line">     dhcp4: no</span><br><span class="line">     dhcp6: no</span><br><span class="line">   bridges:</span><br><span class="line">     br0:</span><br><span class="line">     dhcp4: no</span><br><span class="line">     dhcp6: no</span><br><span class="line">     addresses: [10.0.0.100/16]</span><br><span class="line">     gateway4: 10.0.0.2</span><br><span class="line">     nameservers:</span><br><span class="line">       addresses: [223.6.6.6]</span><br><span class="line">     interfaces:</span><br><span class="line">       - eth0</span><br></pre></td></tr></table></figure>

<h3 id="基于现有虚拟机镜像批量创建新虚拟机"><a href="#基于现有虚拟机镜像批量创建新虚拟机" class="headerlink" title="基于现有虚拟机镜像批量创建新虚拟机"></a>基于现有虚拟机镜像批量创建新虚拟机</h3><p>将前面生成的虚拟机做为模版，生成新的虚拟机</p>
<p><strong>注意:先在前面的模版虚拟机修改配置，如:关闭firewalld和SELinux，禁用NetworkManager(CentOS 7 )等，安装常用包等</strong></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 images]<span class="comment"># pwd</span></span><br><span class="line">/var/lib/libvirt/images</span><br><span class="line"></span><br><span class="line">[root@centos8 images]<span class="comment"># cp centos8.qcow2 centos8-2.qcow2</span></span><br><span class="line">[root@centos8 images]<span class="comment"># virt-install --virt-type kvm --name centos8-2 --ram 2048 --vcpus 2 \</span></span><br><span class="line">--disk bus=virtio,path=/var/lib/libvirt/images/centos8-2.qcow2 --network \</span><br><span class="line">bridge=virbr1,model=virtio --graphics vnc,listen=0.0.0.0 --noautoconsole --autostart --boot hd</span><br><span class="line"></span><br><span class="line">WARNING No operating system detected, VM performance may suffer. Specify an OS </span><br><span class="line">with --os-variant <span class="keyword">for</span> optimal results.</span><br><span class="line">Starting install...</span><br><span class="line">Domain creation completed.</span><br><span class="line"></span><br><span class="line"><span class="comment">#运行工具，可以看到下面出现新的虚拟机</span></span><br><span class="line">[root@centos8 images]<span class="comment"># virt-manager</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#开启的虚拟机磁盘文件所有者为qemu，关闭后为root</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># ll /var/lib/libvirt/images</span></span><br><span class="line">total 9977352</span><br><span class="line">-rw-r--r-- 1 qemu qemu 2029518848 Sep 21 23:37 centos8-2.qcow2</span><br><span class="line">-rw------- 1 root root 1929183232 Sep 21 23:33 centos8-clone.qcow2</span><br><span class="line">-rw-r--r-- 1 root root 2004221952 Sep 21 23:32 centos8.qcow2</span><br></pre></td></tr></table></figure>

<p><img src="../../../../images/SRE/day41/134.jpg" alt="134"></p>
<h3 id="查看新虚拟机设置"><a href="#查看新虚拟机设置" class="headerlink" title="查看新虚拟机设置"></a>查看新虚拟机设置</h3><p><img src="../../../../images/SRE/day41/135.jpg" alt="135"><br><img src="../../../../images/SRE/day41/136.jpg" alt="136"><br><img src="../../../../images/SRE/day41/137.jpg" alt="137"><br><img src="../../../../images/SRE/day41/138.jpg" alt="138"></p>
<h2 id="内外网络隔离综合案例"><a href="#内外网络隔离综合案例" class="headerlink" title="内外网络隔离综合案例"></a>内外网络隔离综合案例</h2><p><strong>注意：vm2和vm3的虚拟机的IP需要静态配置，用 ip a a 添加的IP不稳定可能会丢失</strong> </p>
<p>实现一个外网的web服务和内网的数据库相互隔离的环境</p>
<p>两台宿主机host1和host2</p>
<p>每个宿主机上面各有两个虚拟机，分别连接外网和内网交换机</p>
<p><img src="../../../../images/SRE/day41/139.jpg" alt="139"></p>
<p>范例: 多网卡绑定</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line">root@ubuntu1804:~<span class="comment"># vim /etc/netplan/01-netcfg.yaml</span></span><br><span class="line"><span class="comment"># This file describes the network interfaces available on your system</span></span><br><span class="line"><span class="comment"># For more information, see netplan(5).</span></span><br><span class="line">network:</span><br><span class="line"> version: 2</span><br><span class="line"> renderer: networkd</span><br><span class="line"> ethernets:</span><br><span class="line">   eth0:</span><br><span class="line">     dhcp4: no</span><br><span class="line">     dhcp6: no</span><br><span class="line">   eth1:</span><br><span class="line">     dhcp4: no</span><br><span class="line">     dhcp6: no</span><br><span class="line"> bonds:</span><br><span class="line">   bond0:</span><br><span class="line">     interfaces:</span><br><span class="line">        - eth0</span><br><span class="line">        - eth1</span><br><span class="line">     addresses: [10.0.0.18/16]</span><br><span class="line">     gateway4: 10.0.0.1</span><br><span class="line">     nameservers:</span><br><span class="line">       addresses: [223.6.6.6,223.5.5.5]</span><br><span class="line">     parameters:</span><br><span class="line">       mode: active-backup</span><br><span class="line">       mii-monitor-interval: 100</span><br><span class="line">       fail-over-mac-policy: active</span><br><span class="line">       </span><br><span class="line">root@ubuntu1804:~<span class="comment"># netplan apply</span></span><br><span class="line">root@ubuntu1804:~<span class="comment"># ifconfig bond0</span></span><br><span class="line">bond0: flags=5187&lt;UP,BROADCAST,RUNNING,MASTER,MULTICAST&gt; mtu 1500</span><br><span class="line">       inet 10.0.0.18 netmask 255.255.0.0 broadcast 10.0.255.255</span><br><span class="line">       inet6 fe80::2820:b7ff:fea8:5837 prefixlen 64 scopeid 0x20&lt;<span class="built_in">link</span>&gt;</span><br><span class="line">       ether 2a:20:b7:a8:58:37 txqueuelen 1000 (Ethernet)</span><br><span class="line">       RX packets 296 bytes 25327 (25.3 KB)</span><br><span class="line">       RX errors 0 dropped 0 overruns 0 frame 0</span><br><span class="line">       TX packets 295 bytes 34876 (34.8 KB)</span><br><span class="line">       TX errors 0 dropped 0 overruns 0 carrier 0 collisions 0</span><br><span class="line">       </span><br><span class="line">root@ubuntu1804:~<span class="comment"># ifconfig eth0</span></span><br><span class="line">eth0: flags=6211&lt;UP,BROADCAST,RUNNING,SLAVE,MULTICAST&gt; mtu 1500</span><br><span class="line">       ether 2a:20:b7:a8:58:37 txqueuelen 1000 (Ethernet)</span><br><span class="line">       RX packets 3 bytes 180 (180.0 B)</span><br><span class="line">       RX errors 0 dropped 0 overruns 0 frame 0</span><br><span class="line">       TX packets 0 bytes 0 (0.0 B)</span><br><span class="line">       TX errors 0 dropped 0 overruns 0 carrier 0 collisions 0</span><br><span class="line">       </span><br><span class="line">root@ubuntu1804:~<span class="comment"># ifconfig eth1</span></span><br><span class="line">eth1: flags=6211&lt;UP,BROADCAST,RUNNING,SLAVE,MULTICAST&gt; mtu 1500</span><br><span class="line">       ether 2a:20:b7:a8:58:37 txqueuelen 1000 (Ethernet)</span><br><span class="line">       RX packets 340 bytes 28893 (28.8 KB)</span><br><span class="line">       RX errors 0 dropped 0 overruns 0 frame 0</span><br><span class="line">       TX packets 336 bytes 39940 (39.9 KB)</span><br><span class="line">       TX errors 0 dropped 0 overruns 0 carrier 0 collisions 0</span><br><span class="line">       </span><br><span class="line">root@ubuntu1804:~<span class="comment"># cat /proc/net/bonding/bond0 </span></span><br><span class="line">Ethernet Channel Bonding Driver: v3.7.1 (April 27, 2011)</span><br><span class="line">Bonding Mode: fault-tolerance (active-backup)</span><br><span class="line">Primary Slave: None</span><br><span class="line">Currently Active Slave: eth1</span><br><span class="line">MII Status: up</span><br><span class="line">MII Polling Interval (ms): 100</span><br><span class="line">Up Delay (ms): 0</span><br><span class="line">Down Delay (ms): 0</span><br><span class="line">Slave Interface: eth1</span><br><span class="line">MII Status: up</span><br><span class="line">Speed: 1000 Mbps</span><br><span class="line">Duplex: full</span><br><span class="line">Link Failure Count: 0</span><br><span class="line">Permanent HW addr: 00:0c:29:34:<span class="built_in">df</span>:9b</span><br><span class="line">Slave queue ID: 0</span><br><span class="line">Slave Interface: eth0</span><br><span class="line">MII Status: up</span><br><span class="line">Speed: 1000 Mbps</span><br><span class="line">Duplex: full</span><br><span class="line">Link Failure Count: 0</span><br><span class="line">Permanent HW addr: 00:0c:29:34:<span class="built_in">df</span>:91</span><br><span class="line">Slave queue ID: 0</span><br><span class="line">root@ubuntu1804:~</span><br></pre></td></tr></table></figure>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="http://example.com">૮(˶ᵔ ᵕ ᵔ˶)ა</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="http://example.com/2025/04/01/SRE-kvm/">http://example.com/2025/04/01/SRE-kvm/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="http://example.com" target="_blank">૮(˶ᵔ ᵕ ᵔ˶)ა</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/SRE/">SRE</a><a class="post-meta__tags" href="/tags/kvm/">kvm</a></div><div class="post_share"><div class="social-share" data-image="/../images/SRE/day41/21.jpg" data-sites="wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-full"><a href="/2025/03/26/SRE-zabbix/" title="企业级监控系统ZABBIX"><img class="cover" src="/../images/SRE/day38/9.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">企业级监控系统ZABBIX</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><div><a href="/2024/04/24/SRE-Linux%E5%9F%BA%E6%9C%AC%E6%93%8D%E4%BD%9C%E5%92%8C%E5%B8%AE%E5%8A%A9/" title="Linux基本操作和帮助"><img class="cover" src="/../images/TITLE/linux2.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-04-24</div><div class="title">Linux基本操作和帮助</div></div></a></div><div><a href="/2025/02/21/SRE-LVS/" title="企业级调度器LVS"><img class="cover" src="/../images/SRE/day27/3.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2025-02-21</div><div class="title">企业级调度器LVS</div></div></a></div><div><a href="/2024/08/27/SRE-Linux%E6%96%87%E4%BB%B6%E7%AE%A1%E7%90%86%E5%92%8CIO%E9%87%8D%E5%AE%9A%E5%90%91/" title="Linux文件管理和IO重定向"><img class="cover" src="/../images/TITLE/linux3.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-08-27</div><div class="title">Linux文件管理和IO重定向</div></div></a></div><div><a href="/2024/12/08/SRE-Linux%E9%98%B2%E7%81%AB%E5%A2%99/" title="Linux防火墙"><img class="cover" src="/../images/SRE/day17/12.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-12-08</div><div class="title">Linux防火墙</div></div></a></div><div><a href="/2025/02/18/SRE-OpenVPN/" title="OpenVPN"><img class="cover" src="/../images/SRE/day25/5.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2025-02-18</div><div class="title">OpenVPN</div></div></a></div><div><a href="/2024/11/05/SRE-Shell%E8%84%9A%E6%9C%AC%E7%BC%96%E7%A8%8B/" title="shell脚本编程"><img class="cover" src="/../images/TITLE/linux2.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-11-05</div><div class="title">shell脚本编程</div></div></a></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="/../images/TITLE/user.webp" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">૮(˶ᵔ ᵕ ᵔ˶)ა</div><div class="author-info__description">这家伙很勤奋，什么都留下了</div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">94</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">36</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">29</div></a></div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content is-expand"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E8%99%9A%E6%8B%9F%E5%8C%96%E5%9F%BA%E7%A1%80"><span class="toc-number">1.</span> <span class="toc-text">虚拟化基础</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BC%A0%E7%BB%9F%E7%9A%84%E7%89%A9%E7%90%86%E6%9C%BA%E9%83%A8%E7%BD%B2%E6%96%B9%E6%A1%88"><span class="toc-number">1.1.</span> <span class="toc-text">传统的物理机部署方案</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%99%9A%E6%8B%9F%E5%8C%96"><span class="toc-number">1.2.</span> <span class="toc-text">虚拟化</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BB%80%E4%B9%88%E6%98%AF%E8%99%9A%E6%8B%9F%E5%8C%96"><span class="toc-number">1.2.1.</span> <span class="toc-text">什么是虚拟化</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%99%9A%E6%8B%9F%E5%8C%96%E4%BC%98%E5%8A%BF"><span class="toc-number">1.2.2.</span> <span class="toc-text">虚拟化优势</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%99%9A%E6%8B%9F%E5%8C%96%E7%9A%84%E5%8F%91%E5%B1%95%E5%8F%B2"><span class="toc-number">1.2.3.</span> <span class="toc-text">虚拟化的发展史</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%99%9A%E6%8B%9F%E5%8C%96%E7%B1%BB%E5%9E%8B"><span class="toc-number">1.3.</span> <span class="toc-text">虚拟化类型</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9C%8D%E5%8A%A1%E5%99%A8%E8%99%9A%E6%8B%9F%E5%8C%96"><span class="toc-number">1.3.1.</span> <span class="toc-text">服务器虚拟化</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BD%91%E7%BB%9C%E8%99%9A%E6%8B%9F%E5%8C%96"><span class="toc-number">1.3.2.</span> <span class="toc-text">网络虚拟化</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%A1%8C%E9%9D%A2%E8%99%9A%E6%8B%9F%E5%8C%96"><span class="toc-number">1.3.3.</span> <span class="toc-text">桌面虚拟化</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%BA%94%E7%94%A8%E8%99%9A%E6%8B%9F%E5%8C%96"><span class="toc-number">1.3.4.</span> <span class="toc-text">应用虚拟化</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AD%98%E5%82%A8%E8%99%9A%E6%8B%9F%E5%8C%96"><span class="toc-number">1.3.5.</span> <span class="toc-text">存储虚拟化</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%BA%93%E8%99%9A%E6%8B%9F%E5%8C%96"><span class="toc-number">1.3.6.</span> <span class="toc-text">库虚拟化</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%B9%E5%99%A8%E8%99%9A%E6%8A%80%E6%9C%AF"><span class="toc-number">1.3.7.</span> <span class="toc-text">容器虚技术</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%99%9A%E6%8B%9F%E6%9C%BA"><span class="toc-number">1.4.</span> <span class="toc-text">虚拟机</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%99%9A%E6%8B%9F%E6%9C%BA-1"><span class="toc-number">1.4.1.</span> <span class="toc-text">虚拟机</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%99%9A%E6%8B%9F%E6%9C%BA%E7%9A%84%E4%B8%BB%E8%A6%81%E7%89%B9%E6%80%A7"><span class="toc-number">1.4.2.</span> <span class="toc-text">虚拟机的主要特性</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Hypervisor%E7%B1%BB%E5%9E%8B"><span class="toc-number">1.5.</span> <span class="toc-text">Hypervisor类型</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Hypervisor-%E4%BB%8B%E7%BB%8D"><span class="toc-number">1.5.1.</span> <span class="toc-text">Hypervisor 介绍</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Hypervisor-%E5%88%86%E7%B1%BB"><span class="toc-number">1.5.2.</span> <span class="toc-text">Hypervisor 分类</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%B1%BB%E5%9E%8B-I-%E8%A3%B8%E9%87%91%E5%B1%9E%E5%9E%8B"><span class="toc-number">1.5.2.1.</span> <span class="toc-text">类型 I : 裸金属型</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%B1%BB%E5%9E%8B-II-%E5%AE%BF%E4%B8%BB%E5%9E%8B"><span class="toc-number">1.5.2.2.</span> <span class="toc-text">类型 II : 宿主型</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%99%9A%E6%8B%9F%E5%8C%96%E6%8A%80%E6%9C%AF%E5%88%86%E7%B1%BB"><span class="toc-number">1.6.</span> <span class="toc-text">虚拟化技术分类</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%A8%A1%E6%8B%9F%E5%99%A8-%E8%BD%AF%E4%BB%B6%E4%BB%BF%E7%9C%9F"><span class="toc-number">1.6.1.</span> <span class="toc-text">模拟器&#x2F;软件仿真</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%85%A8%E8%99%9A%E6%8B%9F%E6%9C%BA%E5%8C%96-full-virtualization-%E6%9C%AC%E5%9C%B0%E8%99%9A%E6%8B%9F%E5%8C%96-native-virtualization"><span class="toc-number">1.6.2.</span> <span class="toc-text">全虚拟机化 full virtualization &#x2F; 本地虚拟化 native virtualization</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%BD%AF%E4%BB%B6%E8%BE%85%E5%8A%A9%E7%9A%84%E5%85%A8%E8%99%9A%E6%8B%9F%E5%8C%96"><span class="toc-number">1.6.2.1.</span> <span class="toc-text">软件辅助的全虚拟化</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%A1%AC%E4%BB%B6%E8%BE%85%E5%8A%A9%E7%9A%84%E5%85%A8%E8%99%9A%E6%8B%9F%E5%8C%96-HVM-Hardware-Virtual-Machine"><span class="toc-number">1.6.2.2.</span> <span class="toc-text">硬件辅助的全虚拟化 HVM(Hardware Virtual Machine)</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8D%8A%E8%99%9A%E6%8B%9F%E5%8C%96-para-virtualization"><span class="toc-number">1.6.3.</span> <span class="toc-text">半虚拟化 para virtualization</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#KVM%E6%9E%B6%E6%9E%84%E5%92%8C%E9%83%A8%E7%BD%B2"><span class="toc-number">2.</span> <span class="toc-text">KVM架构和部署</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#KVM-%E6%A6%82%E8%BF%B0"><span class="toc-number">2.1.</span> <span class="toc-text">KVM 概述</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#KVM-%E4%BB%8B%E7%BB%8D"><span class="toc-number">2.1.1.</span> <span class="toc-text">KVM 介绍</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#KVM%E6%9E%B6%E6%9E%84"><span class="toc-number">2.1.2.</span> <span class="toc-text">KVM架构</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#KVM-%E4%BD%93%E7%B3%BB%E7%BB%93%E6%9E%84"><span class="toc-number">2.1.2.1.</span> <span class="toc-text">KVM 体系结构</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#KVM-%E6%A8%A1%E5%9D%97%E8%BD%BD%E5%85%A5%E5%90%8E%E7%9A%84%E7%B3%BB%E7%BB%9F%E7%9A%84%E8%BF%90%E8%A1%8C%E6%A8%A1%E5%BC%8F"><span class="toc-number">2.1.2.2.</span> <span class="toc-text">KVM 模块载入后的系统的运行模式</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#KVM-%E9%9B%86%E4%B8%AD%E7%AE%A1%E7%90%86%E4%B8%8E%E6%8E%A7%E5%88%B6"><span class="toc-number">2.1.3.</span> <span class="toc-text">KVM 集中管理与控制</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%BF%E4%B8%BB%E6%9C%BA%E7%8E%AF%E5%A2%83%E5%87%86%E5%A4%87"><span class="toc-number">2.2.</span> <span class="toc-text">宿主机环境准备</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#CPU%E5%BC%80%E5%90%AF%E8%99%9A%E6%8B%9F%E5%8C%96"><span class="toc-number">2.2.1.</span> <span class="toc-text">CPU开启虚拟化</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%AA%8C%E8%AF%81%E5%BC%80%E5%90%AF%E8%99%9A%E6%8B%9F%E5%8C%96"><span class="toc-number">2.2.2.</span> <span class="toc-text">验证开启虚拟化</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%89%E8%A3%85KVM%E5%B7%A5%E5%85%B7%E5%8C%85"><span class="toc-number">2.3.</span> <span class="toc-text">安装KVM工具包</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#KVM-%E7%9B%B8%E5%85%B3%E5%B7%A5%E5%85%B7%E5%8C%85%E4%BB%8B%E7%BB%8D"><span class="toc-number">2.3.1.</span> <span class="toc-text">KVM 相关工具包介绍</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#libvirt-%E5%8C%85%E5%8A%9F%E8%83%BD"><span class="toc-number">2.3.2.</span> <span class="toc-text">libvirt 包功能</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#libvirt-%E4%BB%8B%E7%BB%8D"><span class="toc-number">2.3.2.1.</span> <span class="toc-text">libvirt 介绍</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#libvirt-%E7%BB%93%E6%9E%84%E5%9B%BE"><span class="toc-number">2.3.2.2.</span> <span class="toc-text">libvirt 结构图</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%89%E8%A3%85KVM%E7%9B%B8%E5%85%B3%E5%8C%85"><span class="toc-number">2.3.3.</span> <span class="toc-text">安装KVM相关包</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Ubuntu-%E5%AE%89%E8%A3%85-KVM"><span class="toc-number">2.3.3.1.</span> <span class="toc-text">Ubuntu 安装 KVM</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#CentOS-%E5%AE%89%E8%A3%85-KVM"><span class="toc-number">2.3.3.2.</span> <span class="toc-text">CentOS 安装 KVM</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9B%BE%E5%BD%A2%E5%8C%96%E5%B7%A5%E5%85%B7-virt-manager"><span class="toc-number">2.3.4.</span> <span class="toc-text">图形化工具 virt-manager</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%BB%98%E8%AE%A4%E7%BD%91%E7%BB%9C%E9%85%8D%E7%BD%AE"><span class="toc-number">2.3.5.</span> <span class="toc-text">默认网络配置</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%87%86%E5%A4%87%E5%AE%89%E8%A3%85%E7%B3%BB%E7%BB%9F%E7%9A%84ISO%E7%9B%B8%E5%85%B3%E6%96%87%E4%BB%B6"><span class="toc-number">2.4.</span> <span class="toc-text">准备安装系统的ISO相关文件</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#AMD-CPU-%E5%88%9B%E5%BB%BA%E8%99%9A%E6%8B%9F%E6%9C%BA%E6%97%B6%E7%9A%84%E6%95%85%E9%9A%9C%E6%8E%92%E9%94%99"><span class="toc-number">2.5.</span> <span class="toc-text">AMD CPU 创建虚拟机时的故障排错</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#AMD-CPU-%E4%BD%BF%E7%94%A8virt-manager%E5%88%9B%E5%BB%BA%E8%99%9A%E6%8B%9F%E6%9C%BA%E5%87%BA%E9%94%99%E6%8F%90%E7%A4%BA"><span class="toc-number">2.5.1.</span> <span class="toc-text">AMD CPU 使用virt-manager创建虚拟机出错提示</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#AMD-CPU-%E4%BD%BF%E7%94%A8virt-install%E5%88%9B%E5%BB%BA%E8%99%9A%E6%8B%9F%E6%9C%BA%E5%87%BA%E9%94%99%E6%8F%90%E7%A4%BA"><span class="toc-number">2.5.2.</span> <span class="toc-text">AMD CPU 使用virt-install创建虚拟机出错提示</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#AMD-CPU-%E5%88%9B%E5%BB%BA%E8%99%9A%E6%8B%9F%E6%9C%BA%E6%95%85%E9%9A%9C%E4%BF%AE%E5%A4%8D%E6%96%B9%E6%B3%95"><span class="toc-number">2.5.3.</span> <span class="toc-text">AMD CPU 创建虚拟机故障修复方法</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E8%99%9A%E6%8B%9F%E6%9C%BA"><span class="toc-number">3.</span> <span class="toc-text">创建虚拟机</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8-virt-manager-%E5%88%9B%E5%BB%BA%E8%99%9A%E6%8B%9F%E6%9C%BA"><span class="toc-number">3.1.</span> <span class="toc-text">使用 virt-manager 创建虚拟机</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8-virt-install-%E5%88%9B%E5%BB%BA%E8%99%9A%E6%8B%9F%E6%9C%BA"><span class="toc-number">3.2.</span> <span class="toc-text">使用 virt-install 创建虚拟机</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#virt-install-%E4%BD%BF%E7%94%A8%E8%AF%B4%E6%98%8E"><span class="toc-number">3.2.1.</span> <span class="toc-text">virt-install 使用说明</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#virt-install-%E5%91%BD%E4%BB%A4%E5%88%9B%E5%BB%BA%E8%99%9A%E6%8B%9F%E6%9C%BA"><span class="toc-number">3.2.2.</span> <span class="toc-text">virt-install 命令创建虚拟机</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%A9%E7%94%A8-qemu-img%E5%91%BD%E4%BB%A4%E5%88%9B%E5%BB%BA%E8%99%9A%E6%8B%9F%E7%A3%81%E7%9B%98"><span class="toc-number">3.2.2.1.</span> <span class="toc-text">利用 qemu-img命令创建虚拟磁盘</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%A9%E7%94%A8-osinfo-query%E5%91%BD%E4%BB%A4%E6%9F%A5%E7%9C%8B%E6%94%AF%E6%8C%81%E7%9A%84OS%E7%89%88%E6%9C%AC"><span class="toc-number">3.2.2.2.</span> <span class="toc-text">利用 osinfo-query命令查看支持的OS版本</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E8%99%9A%E6%8B%9F%E6%9C%BA%E4%BD%BF%E7%94%A8%E5%85%89%E7%9B%98%E5%90%AF%E5%8A%A8%E5%B9%B6%E6%89%8B%E5%8A%A8%E5%AE%89%E8%A3%85"><span class="toc-number">3.2.2.3.</span> <span class="toc-text">创建虚拟机使用光盘启动并手动安装</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%AA%8C%E8%AF%81%E5%AE%BF%E4%B8%BB%E6%9C%BA%E8%BF%9B%E7%A8%8B"><span class="toc-number">3.2.2.4.</span> <span class="toc-text">验证宿主机进程</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9F%BA%E4%BA%8E%E7%8E%B0%E6%9C%89%E8%99%9A%E6%8B%9F%E6%9C%BA%E7%A3%81%E7%9B%98%E4%B8%BA%E6%A8%A1%E7%89%88%E5%88%9B%E5%BB%BA%E6%96%B0%E7%9A%84%E8%99%9A%E6%8B%9F%E6%9C%BA"><span class="toc-number">3.3.</span> <span class="toc-text">基于现有虚拟机磁盘为模版创建新的虚拟机</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%A9%E7%94%A8virt-manager%E5%AE%9E%E7%8E%B0"><span class="toc-number">3.3.1.</span> <span class="toc-text">利用virt-manager实现</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%A9%E7%94%A8virt-install%E5%AE%9E%E7%8E%B0"><span class="toc-number">3.3.2.</span> <span class="toc-text">利用virt-install实现</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%A9%E7%94%A8virt-clone%E5%85%8B%E9%9A%86%E5%AE%9E%E7%8E%B0"><span class="toc-number">3.3.3.</span> <span class="toc-text">利用virt-clone克隆实现</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%AE%A1%E7%90%86%E8%99%9A%E6%8B%9F%E6%9C%BA"><span class="toc-number">4.</span> <span class="toc-text">管理虚拟机</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8%E5%8D%8A%E8%99%9A%E6%8B%9F%E5%8C%96%E9%A9%B1%E5%8A%A8-virtio"><span class="toc-number">4.1.</span> <span class="toc-text">使用半虚拟化驱动 virtio</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8D%8A%E8%99%9A%E6%8B%9F%E5%8C%96%E9%A9%B1%E5%8A%A8virtio%E7%9A%84%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86"><span class="toc-number">4.1.1.</span> <span class="toc-text">半虚拟化驱动virtio的工作原理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8D%8A%E8%99%9A%E6%8B%9F%E5%8C%96%E8%AE%BE%E5%A4%87%E7%BB%9F%E4%B8%80%E6%8E%A5%E5%8F%A3virtio"><span class="toc-number">4.1.2.</span> <span class="toc-text">半虚拟化设备统一接口virtio</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%A9%B1%E5%8A%A8%E8%8E%B7%E5%8F%96"><span class="toc-number">4.1.3.</span> <span class="toc-text">驱动获取</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Linux-%E7%9A%84-VirtIO-%E9%A9%B1%E5%8A%A8"><span class="toc-number">4.1.3.1.</span> <span class="toc-text">Linux 的 VirtIO 驱动</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Windows-%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%E9%9C%80%E8%A6%81%E9%A2%9D%E5%A4%96%E5%AE%89%E8%A3%85-virtio-%E7%9A%84%E9%A9%B1%E5%8A%A8"><span class="toc-number">4.1.3.2.</span> <span class="toc-text">Windows 操作系统需要额外安装 virtio 的驱动</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Linux-%E6%B5%8B%E8%AF%95%E5%AE%89%E8%A3%85virtio%E9%A9%B1%E5%8A%A8%E5%89%8D%E5%90%8E%E7%9A%84%E8%99%9A%E6%8B%9F%E6%9C%BA%E6%80%A7%E8%83%BD%E5%8F%98%E5%8C%96"><span class="toc-number">4.1.4.</span> <span class="toc-text">Linux 测试安装virtio驱动前后的虚拟机性能变化</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%89%E8%A3%85-Windows-Server-%E8%99%9A%E6%8B%9F%E6%9C%BA"><span class="toc-number">4.1.5.</span> <span class="toc-text">安装 Windows Server 虚拟机</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%8B%E8%BD%BD%E5%B9%B6%E5%87%86%E5%A4%87%E7%9B%B8%E5%85%B3%E6%96%87%E4%BB%B6"><span class="toc-number">4.1.5.1.</span> <span class="toc-text">下载并准备相关文件</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA-Windows-Server-2008-%E8%99%9A%E6%8B%9F%E6%9C%BA"><span class="toc-number">4.1.5.2.</span> <span class="toc-text">创建 Windows Server 2008 虚拟机</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%89%E8%A3%85-Windows-Server-2008"><span class="toc-number">4.1.5.3.</span> <span class="toc-text">安装 Windows Server 2008</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%AA%8C%E8%AF%81-Windows-virtio-%E9%A9%B1%E5%8A%A8"><span class="toc-number">4.1.5.4.</span> <span class="toc-text">验证 Windows virtio 驱动</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%89%E8%A3%85PCI-%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86%E9%A9%B1%E5%8A%A8"><span class="toc-number">4.1.5.5.</span> <span class="toc-text">安装PCI 内存管理驱动</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%94%9F%E6%88%90Windows-Server-2008-%E9%95%9C%E5%83%8F%E6%A8%A1%E7%89%88"><span class="toc-number">4.1.5.6.</span> <span class="toc-text">生成Windows Server 2008 镜像模版</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%9F%BA%E4%BA%8E%E6%A8%A1%E7%89%88%E5%88%9B%E5%BB%BA%E6%96%B0%E7%9A%84Windows%E7%9A%84%E8%99%9A%E6%8B%9F%E6%9C%BA"><span class="toc-number">4.1.5.7.</span> <span class="toc-text">基于模版创建新的Windows的虚拟机</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#libvirt-%E6%9E%B6%E6%9E%84"><span class="toc-number">4.2.</span> <span class="toc-text">libvirt 架构</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#virt-manager-%E7%AE%A1%E7%90%86%E8%99%9A%E6%8B%9F%E6%9C%BA"><span class="toc-number">4.3.</span> <span class="toc-text">virt-manager 管理虚拟机</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%90%AF%E5%8A%A8%E8%8F%9C%E5%8D%95"><span class="toc-number">4.3.1.</span> <span class="toc-text">启动菜单</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%BF%9C%E7%A8%8B%E7%AE%A1%E7%90%86KVM%E5%AE%BF%E4%B8%BB%E6%9C%BA"><span class="toc-number">4.3.2.</span> <span class="toc-text">远程管理KVM宿主机</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%99%9A%E6%8B%9F%E6%9C%BA%E7%9A%84%E6%80%A7%E8%83%BD%E7%9B%91%E6%8E%A7"><span class="toc-number">4.3.3.</span> <span class="toc-text">虚拟机的性能监控</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%AE%A1%E7%90%86%E5%BF%AB%E7%85%A7"><span class="toc-number">4.3.4.</span> <span class="toc-text">管理快照</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#virsh-%E5%91%BD%E4%BB%A4%E8%A1%8C%E5%B7%A5%E5%85%B7"><span class="toc-number">4.4.</span> <span class="toc-text">virsh 命令行工具</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#virsh-%E5%91%BD%E4%BB%A4%E8%AF%B4%E6%98%8E"><span class="toc-number">4.4.1.</span> <span class="toc-text">virsh 命令说明</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%A4%E7%A7%8D%E5%B7%A5%E4%BD%9C%E6%A8%A1%E5%BC%8F"><span class="toc-number">4.4.1.1.</span> <span class="toc-text">两种工作模式</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#virsh-%E4%B8%BB%E8%A6%81%E5%8A%9F%E8%83%BD"><span class="toc-number">4.4.1.2.</span> <span class="toc-text">virsh 主要功能</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#virsh-%E5%91%BD%E4%BB%A4%E6%A0%BC%E5%BC%8F"><span class="toc-number">4.4.1.3.</span> <span class="toc-text">virsh 命令格式</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#virsh-%E5%AD%90%E5%91%BD%E4%BB%A4%E8%AF%B4%E6%98%8E"><span class="toc-number">4.4.1.4.</span> <span class="toc-text">virsh 子命令说明</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%9F%A5%E7%9C%8B%E5%AD%90%E5%91%BD%E4%BB%A4%E5%B8%AE%E5%8A%A9"><span class="toc-number">4.4.1.5.</span> <span class="toc-text">查看子命令帮助</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%90%AF%E5%8A%A8%E5%92%8C%E5%85%B3%E9%97%AD%E8%99%9A%E6%8B%9F%E6%9C%BA"><span class="toc-number">4.4.2.</span> <span class="toc-text">启动和关闭虚拟机</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9A%82%E5%81%9C%E5%92%8C%E6%81%A2%E5%A4%8D%E8%99%9A%E6%8B%9F%E6%9C%BA"><span class="toc-number">4.4.3.</span> <span class="toc-text">暂停和恢复虚拟机</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE%E8%99%9A%E6%8B%9F%E6%9C%BA%E5%BC%80%E6%9C%BA%E8%87%AA%E5%8A%A8%E5%90%AF%E5%8A%A8"><span class="toc-number">4.4.4.</span> <span class="toc-text">配置虚拟机开机自动启动</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9F%A5%E7%9C%8B%E8%99%9A%E6%8B%9F%E6%9C%BA%E9%85%8D%E7%BD%AE"><span class="toc-number">4.4.5.</span> <span class="toc-text">查看虚拟机配置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%A0%E9%99%A4%E8%99%9A%E6%8B%9F%E6%9C%BA%E9%85%8D%E7%BD%AE"><span class="toc-number">4.4.6.</span> <span class="toc-text">删除虚拟机配置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%BF%81%E7%A7%BB%E8%99%9A%E6%8B%9F%E6%9C%BA"><span class="toc-number">4.4.7.</span> <span class="toc-text">迁移虚拟机</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%AD%98%E5%82%A8%E7%AE%A1%E7%90%86"><span class="toc-number">5.</span> <span class="toc-text">存储管理</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#KVM%E5%AD%98%E5%82%A8%E6%A8%A1%E5%BC%8F"><span class="toc-number">5.1.</span> <span class="toc-text">KVM存储模式</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%99%9A%E6%8B%9F%E7%A3%81%E7%9B%98%E7%B1%BB%E5%9E%8B"><span class="toc-number">5.2.</span> <span class="toc-text">虚拟磁盘类型</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%99%9A%E6%8B%9F%E9%95%9C%E5%83%8F%E6%96%87%E4%BB%B6%E6%A0%BC%E5%BC%8F"><span class="toc-number">5.3.</span> <span class="toc-text">虚拟镜像文件格式</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8qemu-img%E7%AE%A1%E7%90%86%E8%99%9A%E6%8B%9F%E7%A3%81%E7%9B%98%E6%96%87%E4%BB%B6"><span class="toc-number">5.4.</span> <span class="toc-text">使用qemu-img管理虚拟磁盘文件</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#qemu-img-%E6%A6%82%E8%BF%B0"><span class="toc-number">5.4.1.</span> <span class="toc-text">qemu-img 概述</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E8%99%9A%E6%8B%9F%E7%A3%81%E7%9B%98%E6%96%87%E4%BB%B6"><span class="toc-number">5.4.2.</span> <span class="toc-text">创建虚拟磁盘文件</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E9%BB%98%E8%AE%A4%E7%A8%80%E7%96%8F%E6%A0%BC%E5%BC%8F%E7%9A%84%E7%A3%81%E7%9B%98"><span class="toc-number">5.4.2.1.</span> <span class="toc-text">创建默认稀疏格式的磁盘</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%9F%A5%E7%9C%8B%E4%B8%8D%E5%90%8C%E7%A3%81%E7%9B%98%E6%96%87%E4%BB%B6%E6%A0%BC%E5%BC%8F%E6%94%AF%E6%8C%81%E9%80%89%E9%A1%B9"><span class="toc-number">5.4.2.2.</span> <span class="toc-text">查看不同磁盘文件格式支持选项</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#qcow2-%E6%A0%BC%E5%BC%8F%E9%80%89%E9%A1%B9"><span class="toc-number">5.4.2.3.</span> <span class="toc-text">qcow2 格式选项</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%9B%E5%BB%BAraw%E6%A0%BC%E5%BC%8F%E9%9D%9E%E7%A8%80%E7%96%8F%E6%96%87%E4%BB%B6"><span class="toc-number">5.4.2.4.</span> <span class="toc-text">创建raw格式非稀疏文件</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%9B%E5%BB%BAraw%E6%A0%BC%E5%BC%8F%E7%A8%80%E7%96%8F%E6%96%87%E4%BB%B6"><span class="toc-number">5.4.2.5.</span> <span class="toc-text">创建raw格式稀疏文件</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#raw%E6%96%87%E4%BB%B6%E5%A4%8D%E5%88%B6%E7%9A%84%E6%A0%BC%E5%BC%8F%E6%8E%A7%E5%88%B6"><span class="toc-number">5.4.2.6.</span> <span class="toc-text">raw文件复制的格式控制</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%A3%80%E6%9F%A5%E8%99%9A%E6%8B%9F%E7%A3%81%E7%9B%98"><span class="toc-number">5.4.3.</span> <span class="toc-text">检查虚拟磁盘</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%A3%81%E7%9B%98%E9%A2%84%E5%88%86%E9%85%8D%E7%AD%96%E7%95%A5"><span class="toc-number">5.4.4.</span> <span class="toc-text">磁盘预分配策略</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%99%9A%E6%8B%9F%E7%A3%81%E7%9B%98%E6%A0%BC%E5%BC%8F%E8%BD%AC%E6%8D%A2"><span class="toc-number">5.4.5.</span> <span class="toc-text">虚拟磁盘格式转换</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%B0%83%E6%95%B4%E8%99%9A%E6%8B%9F%E7%A3%81%E7%9B%98%E5%A4%A7%E5%B0%8F"><span class="toc-number">5.4.6.</span> <span class="toc-text">调整虚拟磁盘大小</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%A3%81%E7%9B%98%E5%BF%AB%E7%85%A7%E7%AE%A1%E7%90%86"><span class="toc-number">5.5.</span> <span class="toc-text">磁盘快照管理</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%BF%AB%E7%85%A7Snapshot%E4%BB%8B%E7%BB%8D"><span class="toc-number">5.5.1.</span> <span class="toc-text">快照Snapshot介绍</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#qemu-img-%E7%AE%A1%E7%90%86%E7%A3%81%E7%9B%98%E5%BF%AB%E7%85%A7"><span class="toc-number">5.5.2.</span> <span class="toc-text">qemu-img 管理磁盘快照</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#virsh-%E7%AE%A1%E7%90%86%E8%99%9A%E6%8B%9F%E6%9C%BA%E5%BF%AB%E7%85%A7"><span class="toc-number">5.5.3.</span> <span class="toc-text">virsh 管理虚拟机快照</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%BD%91%E7%BB%9C%E7%AE%A1%E7%90%86"><span class="toc-number">6.</span> <span class="toc-text">网络管理</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Linux-%E7%BD%91%E6%A1%A5%E5%AE%9E%E7%8E%B0"><span class="toc-number">6.1.</span> <span class="toc-text">Linux 网桥实现</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#qemu-kvm%E6%94%AF%E6%8C%81%E7%9A%84%E7%BD%91%E7%BB%9C"><span class="toc-number">6.2.</span> <span class="toc-text">qemu-kvm支持的网络</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%BB%98%E8%AE%A4%E7%9A%84%E7%BD%91%E7%BB%9C%E9%85%8D%E7%BD%AENAT%E6%A8%A1%E5%BC%8F"><span class="toc-number">6.3.</span> <span class="toc-text">默认的网络配置NAT模式</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%BB%98%E8%AE%A4%E7%BD%91%E7%BB%9C%E8%BF%9E%E6%8E%A5%E7%9A%84%E6%9E%B6%E6%9E%84%E5%9B%BE"><span class="toc-number">6.3.1.</span> <span class="toc-text">默认网络连接的架构图</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%BF%E4%B8%BB%E6%9C%BA%E9%BB%98%E8%AE%A4%E7%BD%91%E7%BB%9C%E7%9B%B8%E5%85%B3%E6%9C%8D%E5%8A%A1%E5%92%8C%E4%BF%A1%E6%81%AF"><span class="toc-number">6.3.2.</span> <span class="toc-text">宿主机默认网络相关服务和信息</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%99%9A%E6%8B%9F%E6%9C%BA%E7%BD%91%E5%8D%A1%E9%BB%98%E8%AE%A4%E8%AE%BE%E7%BD%AE"><span class="toc-number">6.3.3.</span> <span class="toc-text">虚拟机网卡默认设置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#virsh-%E6%9F%A5%E7%9C%8B%E8%99%9A%E6%8B%9F%E6%9C%BA%E7%BD%91%E7%BB%9C%E9%85%8D%E7%BD%AE"><span class="toc-number">6.3.4.</span> <span class="toc-text">virsh 查看虚拟机网络配置</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE%E8%99%9A%E6%8B%9F%E6%9C%BA%E7%BD%91%E5%8D%A1%E6%A1%A5%E6%8E%A5%E5%88%B0%E5%AE%BF%E4%B8%BB%E6%9C%BA%E7%9A%84%E7%89%A9%E7%90%86%E7%BD%91%E5%8D%A1"><span class="toc-number">6.4.</span> <span class="toc-text">配置虚拟机网卡桥接到宿主机的物理网卡</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9F%BA%E4%BA%8E%E8%87%AA%E5%AE%9A%E4%B9%89%E7%BD%91%E6%A1%A5%E7%9A%84%E8%99%9A%E6%8B%9F%E7%BD%91%E7%BB%9C"><span class="toc-number">6.5.</span> <span class="toc-text">基于自定义网桥的虚拟网络</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89%E7%BD%91%E6%A1%A5%E6%9E%B6%E6%9E%84"><span class="toc-number">6.5.1.</span> <span class="toc-text">自定义网桥架构</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9C%A8%E5%AE%BF%E4%B8%BB%E6%9C%BA%E5%88%9B%E5%BB%BA%E7%BD%91%E6%A1%A5"><span class="toc-number">6.5.2.</span> <span class="toc-text">在宿主机创建网桥</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#CentOS-%E5%88%9B%E5%BB%BA%E6%A1%A5%E6%8E%A5%E7%BD%91%E5%8D%A1"><span class="toc-number">6.5.2.1.</span> <span class="toc-text">CentOS 创建桥接网卡</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Ubuntu-%E5%88%9B%E5%BB%BA%E6%A1%A5%E6%8E%A5%E7%BD%91%E5%8D%A1"><span class="toc-number">6.5.2.2.</span> <span class="toc-text">Ubuntu 创建桥接网卡</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9F%BA%E4%BA%8E%E7%8E%B0%E6%9C%89%E8%99%9A%E6%8B%9F%E6%9C%BA%E9%95%9C%E5%83%8F%E6%89%B9%E9%87%8F%E5%88%9B%E5%BB%BA%E6%96%B0%E8%99%9A%E6%8B%9F%E6%9C%BA"><span class="toc-number">6.5.3.</span> <span class="toc-text">基于现有虚拟机镜像批量创建新虚拟机</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9F%A5%E7%9C%8B%E6%96%B0%E8%99%9A%E6%8B%9F%E6%9C%BA%E8%AE%BE%E7%BD%AE"><span class="toc-number">6.5.4.</span> <span class="toc-text">查看新虚拟机设置</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%86%85%E5%A4%96%E7%BD%91%E7%BB%9C%E9%9A%94%E7%A6%BB%E7%BB%BC%E5%90%88%E6%A1%88%E4%BE%8B"><span class="toc-number">6.6.</span> <span class="toc-text">内外网络隔离综合案例</span></a></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2025/04/01/SRE-kvm/" title="企业级Linux虚拟化KVM"><img src="/../images/SRE/day41/21.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="企业级Linux虚拟化KVM"/></a><div class="content"><a class="title" href="/2025/04/01/SRE-kvm/" title="企业级Linux虚拟化KVM">企业级Linux虚拟化KVM</a><time datetime="2025-04-01T09:21:21.000Z" title="发表于 2025-04-01 17:21:21">2025-04-01</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2025/03/26/SRE-zabbix/" title="企业级监控系统ZABBIX"><img src="/../images/SRE/day38/9.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="企业级监控系统ZABBIX"/></a><div class="content"><a class="title" href="/2025/03/26/SRE-zabbix/" title="企业级监控系统ZABBIX">企业级监控系统ZABBIX</a><time datetime="2025-03-26T14:26:34.000Z" title="发表于 2025-03-26 22:26:34">2025-03-26</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2025/03/17/SRE-Tomcat/" title="企业级Web应用服务器TOMCAT"><img src="/../images/SRE/day33/24.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="企业级Web应用服务器TOMCAT"/></a><div class="content"><a class="title" href="/2025/03/17/SRE-Tomcat/" title="企业级Web应用服务器TOMCAT">企业级Web应用服务器TOMCAT</a><time datetime="2025-03-17T09:45:17.000Z" title="发表于 2025-03-17 17:45:17">2025-03-17</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2025/03/03/SRE-jumpserver/" title="企业级堡垒机JumpServer"><img src="https://www.jumpserver.org/images/logo/logo-dark-JumpServer.svg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="企业级堡垒机JumpServer"/></a><div class="content"><a class="title" href="/2025/03/03/SRE-jumpserver/" title="企业级堡垒机JumpServer">企业级堡垒机JumpServer</a><time datetime="2025-03-03T11:41:44.000Z" title="发表于 2025-03-03 19:41:44">2025-03-03</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2023 - 2025 By ૮(˶ᵔ ᵕ ᵔ˶)ა</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div><div class="footer_custom_text"><a target="_blank" rel="noopener" href="https://beian.miit.gov.cn/#/Integrated/index"><img src="../images/BEIAN/icp.png" width="15" height="15">豫ICP备2023009931号</a></br><a href="http://www.beian.gov.cn/portal/registerSystemInfo?recordcode=41162702000178" target="_blank"><img src="../images/BEIAN/beian.png" width="15" height="15">豫公网安备 41162702000178号</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.umd.min.js"></script><script src="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.js"></script><script>function panguFn () {
  if (typeof pangu === 'object') pangu.autoSpacingPage()
  else {
    getScript('https://cdn.jsdelivr.net/npm/pangu/dist/browser/pangu.min.js')
      .then(() => {
        pangu.autoSpacingPage()
      })
  }
}

function panguInit () {
  if (true){
    GLOBAL_CONFIG_SITE.isPost && panguFn()
  } else {
    panguFn()
  }
}

document.addEventListener('DOMContentLoaded', panguInit)</script><div class="js-pjax"></div><canvas id="universe"></canvas><script src="/js/universe.js"></script><canvas class="fireworks" mobile="true"></canvas><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/fireworks.min.js"></script><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/activate-power-mode.min.js"></script><script>POWERMODE.colorful = true;
POWERMODE.shake = false;
POWERMODE.mobile = false;
document.body.addEventListener('input', POWERMODE);
</script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>