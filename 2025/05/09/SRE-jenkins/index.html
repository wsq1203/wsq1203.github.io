<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>DevOps之CICD工具Jenkins | ૮(˶ᵔ ᵕ ᵔ˶)ა</title><meta name="author" content="૮(˶ᵔ ᵕ ᵔ˶)ა"><meta name="copyright" content="૮(˶ᵔ ᵕ ᵔ˶)ა"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="ffffff"><meta name="description" content="Site Reliability Engineering">
<meta property="og:type" content="article">
<meta property="og:title" content="DevOps之CICD工具Jenkins">
<meta property="og:url" content="http://example.com/2025/05/09/SRE-jenkins/index.html">
<meta property="og:site_name" content="૮(˶ᵔ ᵕ ᵔ˶)ა">
<meta property="og:description" content="Site Reliability Engineering">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://example.com/images/SRE/day55/1.jpg">
<meta property="article:published_time" content="2025-05-09T09:30:43.000Z">
<meta property="article:modified_time" content="2025-05-09T09:31:02.544Z">
<meta property="article:author" content="૮(˶ᵔ ᵕ ᵔ˶)ა">
<meta property="article:tag" content="Jenkins">
<meta property="article:tag" content="SRE">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://example.com/images/SRE/day55/1.jpg"><link rel="shortcut icon" href="/../images/TITLE/user.webp"><link rel="canonical" href="http://example.com/2025/05/09/SRE-jenkins/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//fonts.googleapis.com" crossorigin=""/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Titillium+Web&amp;display=swap" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":false,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: true,
    post: true
  },
  runtime: '天',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: {"chs_to_cht":"你已切换为繁体","cht_to_chs":"你已切换为简体","day_to_night":"你已切换为深色模式","night_to_day":"你已切换为浅色模式","bgLight":"#49b1f5","bgDark":"#1f1f1f","position":"top-center"},
  source: {
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: true,
  }
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'DevOps之CICD工具Jenkins',
  isPost: true,
  isHome: false,
  isHighlightShrink: undefined,
  isToc: true,
  postUpdate: '2025-05-09 17:31:02'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
    win.getCSS = (url,id = false) => new Promise((resolve, reject) => {
      const link = document.createElement('link')
      link.rel = 'stylesheet'
      link.href = url
      if (id) link.id = id
      link.onerror = reject
      link.onload = link.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        link.onload = link.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(link)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', 'ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><link rel="stylesheet" href="/css/custom.css"  media="defer" onload="this.media='all'"><meta name="generator" content="Hexo 5.4.2"></head><body><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="/../images/TITLE/user.webp" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">103</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">42</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">35</div></a></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间线</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('/../images/SRE/day55/1.jpg')"><nav id="nav"><span id="blog-info"><a href="/" title="૮(˶ᵔ ᵕ ᵔ˶)ა"><span class="site-name">૮(˶ᵔ ᵕ ᵔ˶)ა</span></a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间线</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">DevOps之CICD工具Jenkins</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2025-05-09T09:30:43.000Z" title="发表于 2025-05-09 17:30:43">2025-05-09</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2025-05-09T09:31:02.544Z" title="更新于 2025-05-09 17:31:02">2025-05-09</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/Jenkins/">Jenkins</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">字数总计:</span><span class="word-count">37.4k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>166分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="DevOps之CICD工具Jenkins"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="Jenkins-部署与基本配置"><a href="#Jenkins-部署与基本配置" class="headerlink" title="Jenkins 部署与基本配置"></a>Jenkins 部署与基本配置</h1><h2 id="Jenkins-介绍"><a href="#Jenkins-介绍" class="headerlink" title="Jenkins 介绍"></a>Jenkins 介绍</h2><p><img src="../../../../images/SRE/day55/1.jpg" alt="1"></p>
<p>官方网站：</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://jenkins.io/zh/</span><br></pre></td></tr></table></figure>

<p><img src="../../../../images/SRE/day55/2.jpg" alt="2"></p>
<p>官方文档</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://www.jenkins.io/zh/doc/</span><br></pre></td></tr></table></figure>

<p>Jenkins 是基于Java开发的一种开源的CI（Continuous integration，持续集成）&amp;CD (Continuous Delivery，持续交付)工具，其前身是商业软件Hudson</p>
<p>Jenkins 用于监控持续重复的工作，旨在提供一个开放易用的软件平台，使软件的持续集成变成可能。可用于自动化各种任务，如构建，测试和部署软件。</p>
<p>Jenkins 作为一个可扩展的自动化服务器，可以用作简单的 CI 服务器，或者变成任何项目的持续交付中心。</p>
<p>Jenkins 只是一个调度平台，其本身并不能完成项目的构建部署</p>
<p>Jenkins 需要安装各种插件，可能还需要编写Shell，python脚本等才能调用和集成众多的组件来实现复杂的构建部署功能</p>
<p><img src="../../../../images/SRE/day55/3.jpg" alt="3"></p>
<p><strong>主要用途：</strong> </p>
<ul>
<li>持续、自动地构建/测试软件项目</li>
<li>监控一些定时执行的任务</li>
</ul>
<p><strong>Jenkins特点：</strong></p>
<ul>
<li>开源免费</li>
<li>跨平台，支持所有的平台</li>
<li>master/slave支持分布式的build</li>
<li>web形式的可视化的管理页面</li>
<li>安装配置简单</li>
<li>及时快速的提示和帮助</li>
<li>已有的1800+插件</li>
</ul>
<p>Jenkins 官方介绍视频</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://v.qq.com/x/page/m0509xul0xk.html</span><br></pre></td></tr></table></figure>

<p><strong>Jenkins 版本</strong></p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">https://www.jenkins.io/download/</span><br><span class="line">https://www.jenkins.io/zh/download/</span><br><span class="line">https://mirrors.tuna.tsinghua.edu.cn/jenkins/</span><br></pre></td></tr></table></figure>

<p>Jenkins 项目产生两个发行线， 长期支持版本 (LTS) 和定期发布版本。</p>
<p><img src="../../../../images/SRE/day55/4.jpg" alt="4"></p>
<ul>
<li><p>稳定版 LTS</p>
<p>LTS (长期支持) 版本每12周从常规版本流中选择，作为该时间段的稳定大版本。 每隔 4 周会更新迭代稳定的小版本，其中包括错误和安全修复反向移植。</p>
<p>下载链接</p>
</li>
</ul>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">https://get.jenkins.io/</span><br><span class="line">https://mirrors.tuna.tsinghua.edu.cn/jenkins/</span><br></pre></td></tr></table></figure>

<p><img src="../../../../images/SRE/day55/5.jpg" alt="5"></p>
<p><img src="../../../../images/SRE/day55/6.jpg" alt="6"></p>
<ul>
<li><p>常规版本</p>
<p>每周都会发布一个新版本，为用户和插件开发人员提供错误修复和功能。</p>
</li>
</ul>
<p><img src="../../../../images/SRE/day55/7.jpg" alt="7"></p>
<h2 id="Jenkins-安装和启动"><a href="#Jenkins-安装和启动" class="headerlink" title="Jenkins 安装和启动"></a>Jenkins 安装和启动</h2><h3 id="Jenkins-的安装"><a href="#Jenkins-的安装" class="headerlink" title="Jenkins 的安装"></a>Jenkins 的安装</h3><p>Jenkins 支持多种部署和运行方式</p>
<p>Jenkins支持多种安装方法</p>
<ul>
<li>包安装</li>
<li>JAVA的WAR文件</li>
<li>容器运行</li>
</ul>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://www.jenkins.io/zh/doc/book/installing/</span><br></pre></td></tr></table></figure>

<h4 id="安装前环境准备"><a href="#安装前环境准备" class="headerlink" title="安装前环境准备"></a>安装前环境准备</h4><h5 id="系统要求"><a href="#系统要求" class="headerlink" title="系统要求"></a>系统要求</h5><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://www.jenkins.io/doc/administration/requirements/java/</span><br></pre></td></tr></table></figure>

<p><strong>系统要求</strong></p>
<p>最低推荐配置：</p>
<ul>
<li>256MB可用内存</li>
<li>1GB可用磁盘空间(作为一个Docker容器运行jenkins的话推荐10GB)</li>
</ul>
<p>为小团队推荐的硬件配置： </p>
<ul>
<li>1GB+可用内存</li>
<li>50 GB+ 可用磁盘空间</li>
</ul>
<p>JAVA 软件配置：</p>
<ul>
<li>Java 8/17/21—无论是Java运行时环境（JRE）还是Java开发工具包（JDK）都可以。</li>
<li>Jenkins requires Java 11 or 17 since Jenkins 2.357 and LTS 2.361.1.</li>
</ul>
<h5 id="系统准备"><a href="#系统准备" class="headerlink" title="系统准备"></a>系统准备</h5><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#关闭防火墙和SELinux</span></span><br><span class="line">略</span><br><span class="line"></span><br><span class="line"><span class="comment">#设置语言环境，防止后期Jenkins汉化出问题</span></span><br><span class="line">[root@jenkins ~]<span class="comment"># localectl set-locale LANG=en_US.UTF-8</span></span><br></pre></td></tr></table></figure>

<h5 id="JAVA-环境"><a href="#JAVA-环境" class="headerlink" title="JAVA 环境"></a>JAVA 环境</h5><p><img src="../../../../images/SRE/day55/8.jpg" alt="8"></p>
<p>jenkins基于JAVA实现，安装jenkins前需要先安装 JDK</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#安装openjdk</span></span><br><span class="line"><span class="comment">#新版要求安装JDK-21版</span></span><br><span class="line">[root@ubuntu2004 ~]<span class="comment"># apt -y install openjdk-21-jdk</span></span><br><span class="line">[root@rocky8 ~]<span class="comment"># yum -y install java-21-openjdk</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#旧版安装JDK-8版</span></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment"># apt update</span></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment"># apt -y install openjdk-8-jdk</span></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment"># java -version</span></span><br><span class="line">openjdk version <span class="string">&quot;1.8.0_242&quot;</span></span><br><span class="line">OpenJDK Runtime Environment (build 1.8.0_242-8u242-b08-0ubuntu3~18.04-b08)</span><br><span class="line">OpenJDK 64-Bit Server VM (build 25.242-b08, mixed mode)</span><br><span class="line"></span><br><span class="line"><span class="comment">#或者安装oracle的jdk</span></span><br><span class="line">[root@ubuntu1804 /usr/local/src]<span class="comment"># tar xvf jdk-8u192-linux-x64.tar.gz</span></span><br><span class="line">[root@ubuntu1804 /usr/local/src]<span class="comment"># ln -sv /usr/local/src/jdk1.8.0_192/ /usr/local/jdk</span></span><br><span class="line">[root@ubuntu1804 /usr/local/src]<span class="comment"># ln -sv /usr/local/jdk/bin/java /usr/bin/ #java命令软连接</span></span><br><span class="line"></span><br><span class="line">[root@ubuntu1804 /usr/local/src]<span class="comment"># vim /etc/profile</span></span><br><span class="line"><span class="built_in">export</span> JAVA_HOME=/usr/local/jdk</span><br><span class="line"><span class="built_in">export</span> PATH=<span class="variable">$JAVA_HOME</span>/bin:<span class="variable">$JAVA_HOME</span>/jre/bin:<span class="variable">$PATH</span></span><br><span class="line"><span class="built_in">export</span> CLASSPATH=.<span class="variable">$CLASSPATH</span>:<span class="variable">$JAVA_HOME</span>/lib:<span class="variable">$JAVA_HOME</span>/jre/lib:<span class="variable">$JAVA_HOME</span>/lib/tools.jar</span><br><span class="line"></span><br><span class="line">[root@ubuntu1804 /usr/local/src]<span class="comment"># source /etc/profile</span></span><br><span class="line">[root@ubuntu1804 /usr/local/src]<span class="comment"># java -version</span></span><br><span class="line">java version <span class="string">&quot;1.8.0_192&quot;</span></span><br><span class="line">Java(TM) SE Runtime Environment (build 1.8.0_192-b12)</span><br><span class="line">Java HotSpot(TM) 64-Bit Server VM (build 25.192-b12, mixed mode)</span><br></pre></td></tr></table></figure>

<h4 id="包安装-Jenkins"><a href="#包安装-Jenkins" class="headerlink" title="包安装 Jenkins"></a>包安装 Jenkins</h4><h5 id="Ubuntu-包安装-Jenkins"><a href="#Ubuntu-包安装-Jenkins" class="headerlink" title="Ubuntu 包安装 Jenkins"></a>Ubuntu 包安装 Jenkins</h5><p>Ubuntu 安装 Jenkins 官方说明</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://pkg.jenkins.io/debian-stable/</span><br></pre></td></tr></table></figure>

<p>安装过程</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#需要手动安装JDK</span></span><br><span class="line">apt -y install openjdk-11-jdk</span><br><span class="line">wget -q -O - https://pkg.jenkins.io/debian-stable/jenkins.io.key | sudo apt-key add -</span><br><span class="line">  </span><br><span class="line">Then add the following entry <span class="keyword">in</span> your /etc/apt/sources.list:</span><br><span class="line">    </span><br><span class="line"> deb https://pkg.jenkins.io/debian-stable binary/</span><br><span class="line">  </span><br><span class="line">Update your <span class="built_in">local</span> package index, <span class="keyword">then</span> finally install Jenkins:</span><br><span class="line"></span><br><span class="line">  sudo apt-get update</span><br><span class="line">  sudo apt-get install jenkins</span><br><span class="line">  </span><br><span class="line"><span class="comment">#默认安装最新版本</span></span><br><span class="line">[root@ubuntu2204 ~]<span class="comment"># apt list jenkins -a</span></span><br><span class="line">正在列表... 完成</span><br><span class="line">jenkins/binary,now 2.375.2 all [已安装]</span><br><span class="line">jenkins/binary 2.375.1 all</span><br><span class="line">jenkins/binary 2.361.4 all</span><br><span class="line">jenkins/binary 2.361.3 all</span><br><span class="line">jenkins/binary 2.361.2 all</span><br><span class="line">jenkins/binary 2.361.1 all</span><br></pre></td></tr></table></figure>

<p>deb 包下载地址国内镜像站点</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">https://mirrors.aliyun.com/jenkins/debian-stable/</span><br><span class="line">https://mirror.tuna.tsinghua.edu.cn/jenkins/debian-stable/</span><br></pre></td></tr></table></figure>

<p>范例：包仓库安装</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#https://www.jenkins.io/doc/book/installing/linux/#debianubuntu</span></span><br><span class="line">curl -fsSL https://pkg.jenkins.io/debian-stable/jenkins.io.key | sudo <span class="built_in">tee</span> \</span><br><span class="line">  /usr/share/keyrings/jenkins-keyring.asc &gt; /dev/null</span><br><span class="line"><span class="built_in">echo</span> deb [signed-by=/usr/share/keyrings/jenkins-keyring.asc] \</span><br><span class="line">  https://pkg.jenkins.io/debian-stable binary/ | sudo <span class="built_in">tee</span> \</span><br><span class="line">  /etc/apt/sources.list.d/jenkins.list &gt; /dev/null</span><br><span class="line">  </span><br><span class="line">sudo apt-get update</span><br><span class="line">sudo apt-get install jenkins</span><br></pre></td></tr></table></figure>

<p>范例： Ubuntu二进制包安装jenkins </p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@ubuntu1804 ~]<span class="comment"># apt update</span></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment"># apt -y install openjdk-8-jdk daemon</span></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment"># wget https://mirror.tuna.tsinghua.edu.cn/jenkins/debian-stable/jenkins_2.289.2_all.deb</span></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment"># dpkg -i jenkins_2.289.2_all.deb</span></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment"># systemctl status jenkins.service</span></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment"># cat /var/log/jenkins/jenkins.log</span></span><br><span class="line">8bdf8b1805cf451084ebebd9083823b1</span><br></pre></td></tr></table></figure>

<p>范例： Ubuntu二进制包安装jenkins 旧版</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[root@ubuntu1804 ~]<span class="comment"># wget https://pkg.jenkins.io/debian-stable/binary/jenkins_2.204.4_all.deb</span></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment"># apt install daemon</span></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment"># dpkg -i jenkins_2.204.4_all.deb</span></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment"># systemctl status jenkins</span></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment"># ps aux|grep jenkins</span></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment"># ss -ntlp |grep java</span></span><br><span class="line">LISTEN   0         50                       *:8080                   *:*       <span class="built_in">users</span>:((&quot;java&quot;,pid=<span class="number">11709</span>,fd=<span class="number">164</span>))</span><br><span class="line"></span><br><span class="line"><span class="comment">#查看日志</span></span><br><span class="line">[root@jenkins-ubunutu1804 ~]<span class="comment"># cat /var/log/jenkins/jenkins.log</span></span><br></pre></td></tr></table></figure>

<h5 id="CentOS-包安装-Jenkins"><a href="#CentOS-包安装-Jenkins" class="headerlink" title="CentOS 包安装 Jenkins"></a>CentOS 包安装 Jenkins</h5><p>CentOS 安装jenkins官方说明</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://pkg.jenkins.io/redhat-stable/</span><br></pre></td></tr></table></figure>

<p>包仓库安装过程</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">wget -O /etc/yum.repos.d/jenkins.repo https://pkg.jenkins.io/redhat-stable/jenkins.repo</span><br><span class="line">rpm --import https://pkg.jenkins.io/redhat-stable/jenkins.io.key</span><br><span class="line">yum install jenkins</span><br></pre></td></tr></table></figure>

<p>rpm包国内镜像下载链接</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">https://mirrors.aliyun.com/jenkins/redhat-stable/</span><br><span class="line">https://mirrors.tuna.tsinghua.edu.cn/jenkins/redhat-stable/</span><br></pre></td></tr></table></figure>

<p>范例： CentOS二进制包安装jenkins </p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ~]<span class="comment"># yum install java</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># wget https://mirrors.aliyun.com/jenkins/redhat-stable/jenkins-2.289.2-1.1.noarch.rpm</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># yum -y install jenkins-2.289.2-1.1.noarch.rpm</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># rpm -ql jenkins </span></span><br><span class="line">/etc/init.d/jenkins</span><br><span class="line">/etc/logrotate.d/jenkins</span><br><span class="line">/etc/sysconfig/jenkins</span><br><span class="line">/usr/lib/jenkins</span><br><span class="line">/usr/lib/jenkins/jenkins.war</span><br><span class="line">/usr/sbin/rcjenkins</span><br><span class="line">/var/cache/jenkins</span><br><span class="line">/var/lib/jenkins</span><br><span class="line">/var/log/jenkins</span><br><span class="line"></span><br><span class="line">[root@centos8 ~]<span class="comment"># systemctl start jenkins.service </span></span><br><span class="line"></span><br><span class="line"><span class="comment">#查看第一次的登录密码</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># grep -A2 password /var/log/jenkins/jenkins.log</span></span><br><span class="line">cf4cd0d45e6041a3ba0dcaec345b105a</span><br><span class="line"></span><br><span class="line"><span class="comment">#查看第一次的登录密码</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># cat /var/lib/jenkins/secrets/initialAdminPassword </span></span><br><span class="line">cf4cd0d45e6041a3ba0dcaec345b105a</span><br><span class="line"></span><br><span class="line"><span class="comment">#默认配置</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># grep -v &quot;#&quot; /etc/sysconfig/jenkins | grep -v &quot;^$&quot;</span></span><br><span class="line">JENKINS_HOME=<span class="string">&quot;/var/lib/jenkins&quot;</span></span><br><span class="line">JENKINS_JAVA_CMD=<span class="string">&quot;&quot;</span></span><br><span class="line">JENKINS_USER=<span class="string">&quot;jenkins&quot;</span></span><br><span class="line">JENKINS_JAVA_OPTIONS=<span class="string">&quot;-Djava.awt.headless=true&quot;</span></span><br><span class="line">JENKINS_PORT=<span class="string">&quot;8080&quot;</span></span><br><span class="line">JENKINS_LISTEN_ADDRESS=<span class="string">&quot;&quot;</span></span><br><span class="line">JENKINS_HTTPS_PORT=<span class="string">&quot;&quot;</span></span><br><span class="line">JENKINS_HTTPS_KEYSTORE=<span class="string">&quot;&quot;</span></span><br><span class="line">JENKINS_HTTPS_KEYSTORE_PASSWORD=<span class="string">&quot;&quot;</span></span><br><span class="line">JENKINS_HTTPS_LISTEN_ADDRESS=<span class="string">&quot;&quot;</span></span><br><span class="line">JENKINS_HTTP2_PORT=<span class="string">&quot;&quot;</span></span><br><span class="line">JENKINS_HTTP2_LISTEN_ADDRESS=<span class="string">&quot;&quot;</span></span><br><span class="line">JENKINS_DEBUG_LEVEL=<span class="string">&quot;5&quot;</span></span><br><span class="line">JENKINS_ENABLE_ACCESS_LOG=<span class="string">&quot;no&quot;</span></span><br><span class="line">JENKINS_HANDLER_MAX=<span class="string">&quot;100&quot;</span></span><br><span class="line">JENKINS_HANDLER_IDLE=<span class="string">&quot;20&quot;</span></span><br><span class="line">JENKINS_EXTRA_LIB_FOLDER=<span class="string">&quot;&quot;</span></span><br><span class="line">JENKINS_ARGS=<span class="string">&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#修改配置</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># grep -v &quot;#&quot; /etc/sysconfig/jenkins | grep -v &quot;^$&quot;</span></span><br><span class="line">JENKINS_HOME=<span class="string">&quot;/var/lib/jenkins&quot;</span></span><br><span class="line">JENKINS_JAVA_CMD=<span class="string">&quot;&quot;</span></span><br><span class="line">JENKINS_USER=<span class="string">&quot;jenkins&quot;</span></span><br><span class="line">JENKINS_JAVA_OPTIONS=<span class="string">&quot;-Djava.awt.headless=true \</span></span><br><span class="line"><span class="string">-Dcom.sun.management.jmxremote \</span></span><br><span class="line"><span class="string">-Dcom.sun.management.jmxremote.port=12345 \</span></span><br><span class="line"><span class="string">-Dcom.sun.management.jmxremote.authenticate=false \</span></span><br><span class="line"><span class="string">-Dcom.sun.management.jmxremote.ssl=false \</span></span><br><span class="line"><span class="string">-Djava.rmi.server.hostname=&quot;</span>10.0.0.101<span class="string">&quot; \&quot;</span></span><br><span class="line"><span class="string">JENKINS_PORT=&quot;</span>8080<span class="string">&quot;</span></span><br><span class="line"><span class="string">JENKINS_LISTEN_ADDRESS=&quot;</span><span class="string">&quot;</span></span><br><span class="line"><span class="string">JENKINS_HTTPS_PORT=&quot;</span><span class="string">&quot;</span></span><br><span class="line"><span class="string">JENKINS_HTTPS_KEYSTORE=&quot;</span><span class="string">&quot;</span></span><br><span class="line"><span class="string">JENKINS_HTTPS_KEYSTORE_PASSWORD=&quot;</span><span class="string">&quot;</span></span><br><span class="line"><span class="string">JENKINS_HTTPS_LISTEN_ADDRESS=&quot;</span><span class="string">&quot;</span></span><br><span class="line"><span class="string">JENKINS_DEBUG_LEVEL=&quot;</span>5<span class="string">&quot;</span></span><br><span class="line"><span class="string">JENKINS_ENABLE_ACCESS_LOG=&quot;</span>no<span class="string">&quot;</span></span><br><span class="line"><span class="string">JENKINS_HANDLER_MAX=&quot;</span>100<span class="string">&quot;</span></span><br><span class="line"><span class="string">JENKINS_HANDLER_IDLE=&quot;</span>20<span class="string">&quot;</span></span><br><span class="line"><span class="string">JENKINS_ARGS=&quot;</span><span class="string">&quot;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">#可选启动参数：</span></span><br><span class="line"><span class="string">JENKINS_JAVA_OPTIONS=&quot;</span>-server -Xms1g -Xmx1g -Xss512k -Xmn1g</span><br><span class="line">-XX:CMSInitiatingOccupancyFraction=65</span><br><span class="line">-XX:+UseFastAccessorMethods</span><br><span class="line">-XX:+AggressiveOpts -XX:+UseBiasedLocking</span><br><span class="line">-XX:+DisableExplicitGC -XX:MaxTenuringThreshold=10</span><br><span class="line">-XX:NewSize=2048M -XX:MaxNewSize=2048M -XX:NewRatio=2</span><br><span class="line">-XX:PermSize=128m -XX:MaxPermSize=512m -XX:CMSFullGCsBeforeCompaction=5</span><br><span class="line">-XX:+ExplicitGCInvokesConcurrent -XX:+UseConcMarkSweepGC -XX:+UseParNewGC</span><br><span class="line">-XX:+CMSParallelRemarkEnabled -Djava.awt.headless=<span class="literal">true</span></span><br><span class="line">-Dcom.sun.management.jmxremote</span><br><span class="line">-Dcom.sun.management.jmxremote.port=12345</span><br><span class="line">-Dcom.sun.management.jmxremote.authenticate=<span class="literal">false</span></span><br><span class="line">-Dcom.sun.management.jmxremote.ssl=<span class="literal">false</span></span><br><span class="line">-Djava.rmi.server.hostname=<span class="string">&quot;10.0.0.101&quot;</span> <span class="string">&quot;</span></span><br></pre></td></tr></table></figure>

<h5 id="修改-jenkins-服务的用户"><a href="#修改-jenkins-服务的用户" class="headerlink" title="修改 jenkins 服务的用户"></a>修改 jenkins 服务的用户</h5><p>默认jenkins服务使用jenkins 帐号启动，将文件复制到生产服务器可能会遇到权限问题，因此修改为root用户</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@jenkins-ubunutu1804 ~]<span class="comment"># vim /etc/default/jenkins</span></span><br><span class="line">JENKINS_USER=root</span><br><span class="line">JENKINS_GROUP=root</span><br><span class="line"></span><br><span class="line">[root@jenkins-ubunutu1804 ~]<span class="comment"># systemctl restart jenkins</span></span><br><span class="line">[root@jenkins-ubunutu1804 ~]<span class="comment"># ps aux|grep jenkins</span></span><br><span class="line">root 121354  0.0  0.0  20388   188 ?       S    18:22   0:00 </span><br><span class="line">......</span><br></pre></td></tr></table></figure>

<h5 id="一键安装-Jenkins-脚本"><a href="#一键安装-Jenkins-脚本" class="headerlink" title="一键安装 Jenkins 脚本"></a>一键安装 Jenkins 脚本</h5><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line">URL=<span class="string">&quot;https://mirrors.tuna.tsinghua.edu.cn/jenkins/redhat-stable/jenkins-2.289.3-1.1.noarch.rpm&quot;</span></span><br><span class="line"><span class="comment">#URL=&quot;https://mirrors.tuna.tsinghua.edu.cn/jenkins/debian-stable/jenkins_2.289.3_all.deb&quot;</span></span><br><span class="line"><span class="comment">#URL=&quot;https://mirrors.aliyun.com/jenkins/debian-stable/jenkins_2.289.3_all.deb&quot;</span></span><br><span class="line"></span><br><span class="line">GREEN=<span class="string">&quot;echo -e \E[32;1m&quot;</span></span><br><span class="line">END=<span class="string">&quot;\E[0m&quot;</span></span><br><span class="line">HOST=`hostname -I|awk <span class="string">&#x27;&#123;print $1&#125;&#x27;</span>`</span><br><span class="line">. /etc/os-release</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">color</span></span> () &#123;</span><br><span class="line">    RES_COL=60</span><br><span class="line">    MOVE_TO_COL=<span class="string">&quot;echo -en \\033[<span class="variable">$&#123;RES_COL&#125;</span>G&quot;</span></span><br><span class="line">    SETCOLOR_SUCCESS=<span class="string">&quot;echo -en \\033[1;32m&quot;</span></span><br><span class="line">    SETCOLOR_FAILURE=<span class="string">&quot;echo -en \\033[1;31m&quot;</span></span><br><span class="line">    SETCOLOR_WARNING=<span class="string">&quot;echo -en \\033[1;33m&quot;</span></span><br><span class="line">    SETCOLOR_NORMAL=<span class="string">&quot;echo -en \E[0m&quot;</span></span><br><span class="line">    <span class="built_in">echo</span> -n <span class="string">&quot;<span class="variable">$1</span>&quot;</span> &amp;&amp; <span class="variable">$MOVE_TO_COL</span></span><br><span class="line">    <span class="built_in">echo</span> -n <span class="string">&quot;[&quot;</span></span><br><span class="line">    <span class="keyword">if</span> [ <span class="variable">$2</span> = <span class="string">&quot;success&quot;</span> -o <span class="variable">$2</span> = <span class="string">&quot;0&quot;</span> ] ;<span class="keyword">then</span></span><br><span class="line">        <span class="variable">$&#123;SETCOLOR_SUCCESS&#125;</span></span><br><span class="line">        <span class="built_in">echo</span> -n $<span class="string">&quot; OK &quot;</span>    </span><br><span class="line">    <span class="keyword">elif</span> [ <span class="variable">$2</span> = <span class="string">&quot;failure&quot;</span> -o <span class="variable">$2</span> = <span class="string">&quot;1&quot;</span> ] ;<span class="keyword">then</span> </span><br><span class="line">        <span class="variable">$&#123;SETCOLOR_FAILURE&#125;</span></span><br><span class="line">        <span class="built_in">echo</span> -n $<span class="string">&quot;FAILED&quot;</span></span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="variable">$&#123;SETCOLOR_WARNING&#125;</span></span><br><span class="line">        <span class="built_in">echo</span> -n $<span class="string">&quot;WARNING&quot;</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line">    <span class="variable">$&#123;SETCOLOR_NORMAL&#125;</span></span><br><span class="line">    <span class="built_in">echo</span> -n <span class="string">&quot;]&quot;</span></span><br><span class="line">    <span class="built_in">echo</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="title">install_java</span></span>()&#123;</span><br><span class="line">    <span class="keyword">if</span> [ <span class="variable">$ID</span> = <span class="string">&quot;centos&quot;</span> -o <span class="variable">$ID</span> = <span class="string">&quot;rocky&quot;</span> ];<span class="keyword">then</span></span><br><span class="line">       yum -y install java-1.8.0-openjdk</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">   apt update</span><br><span class="line">   apt -y install openjdk-8-jdk</span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line"> <span class="keyword">if</span> [ $? -eq 0 ];<span class="keyword">then</span></span><br><span class="line">       color <span class="string">&quot;安装java完成!&quot;</span> 0</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">       color <span class="string">&quot;安装java失败!&quot;</span> 1</span><br><span class="line">       <span class="built_in">exit</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="title">install_jenkins</span></span>() &#123;</span><br><span class="line">    wget -P /usr/local/src/ <span class="variable">$URL</span> || &#123; color  <span class="string">&quot;下载失败!&quot;</span> 1 ;<span class="built_in">exit</span> ; &#125;</span><br><span class="line">    <span class="keyword">if</span> [ <span class="variable">$ID</span> = <span class="string">&quot;centos&quot;</span> -o <span class="variable">$ID</span> = <span class="string">&quot;rocky&quot;</span> ];<span class="keyword">then</span></span><br><span class="line">       yum -y install /usr/local/src/<span class="variable">$&#123;URL##*/&#125;</span></span><br><span class="line">       systemctl <span class="built_in">enable</span> jenkins</span><br><span class="line">       systemctl start jenkins</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">   apt -y install daemon net-tools || &#123; color  <span class="string">&quot;安装依赖包失败!&quot;</span> 1 ;<span class="built_in">exit</span> ; &#125;</span><br><span class="line"> dpkg -i /usr/local/src/<span class="variable">$&#123;URL##*/&#125;</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line"> <span class="keyword">if</span> [ $? -eq 0 ];<span class="keyword">then</span></span><br><span class="line">       color <span class="string">&quot;安装Jenkins完成!&quot;</span> 0</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">       color <span class="string">&quot;安装Jenkins失败!&quot;</span> 1</span><br><span class="line">       <span class="built_in">exit</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="title">start_jenkins</span></span>() &#123; </span><br><span class="line">   systemctl is-active jenkins</span><br><span class="line">    <span class="keyword">if</span> [ $?  -eq 0 ];<span class="keyword">then</span>  </span><br><span class="line">        <span class="built_in">echo</span></span><br><span class="line">       color <span class="string">&quot;Jenkins安装完成!&quot;</span> 0</span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;-------------------------------------------------------------------&quot;</span></span><br><span class="line">        <span class="built_in">echo</span> -e <span class="string">&quot;访问链接: \c&quot;</span></span><br><span class="line"> <span class="variable">$&#123;GREEN&#125;</span><span class="string">&quot;http://<span class="variable">$HOST</span>:8080/&quot;</span><span class="variable">$&#123;END&#125;</span></span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">       color <span class="string">&quot;Jenkins安装失败!&quot;</span> 1</span><br><span class="line">        <span class="built_in">exit</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line"> <span class="keyword">while</span> :;<span class="keyword">do</span></span><br><span class="line"> [ -f /var/lib/jenkins/secrets/initialAdminPassword ] &amp;&amp; &#123; key=`<span class="built_in">cat</span> /var/lib/jenkins/secrets/initialAdminPassword` ; <span class="built_in">break</span>; &#125;</span><br><span class="line"> <span class="built_in">sleep</span> 1</span><br><span class="line"> <span class="keyword">done</span></span><br><span class="line"> <span class="built_in">echo</span> -e <span class="string">&quot;登录秘钥: \c&quot;</span></span><br><span class="line"> <span class="variable">$&#123;GREEN&#125;</span>$key<span class="variable">$&#123;END&#125;</span></span><br><span class="line">&#125;</span><br><span class="line">install_java</span><br><span class="line">install_jenkins</span><br><span class="line">start_jenkins</span><br></pre></td></tr></table></figure>

<h4 id="基于-WAR-包直接部署"><a href="#基于-WAR-包直接部署" class="headerlink" title="基于 WAR 包直接部署"></a>基于 WAR 包直接部署</h4><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://www.jenkins.io/zh/doc/book/installing/#war%E6%96%87%E4%BB%B6</span><br></pre></td></tr></table></figure>

<p><img src="../../../../images/SRE/day55/9.jpg" alt="9"></p>
<p>可以直接下载 war 包，相当于绿色软件，就可以直接使用</p>
<p>下载链接</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">https://get.jenkins.io/war-stable/</span><br><span class="line">https://mirrors.tuna.tsinghua.edu.cn/jenkins/war-stable/</span><br></pre></td></tr></table></figure>

<p><img src="../../../../images/SRE/day55/10.jpg" alt="10"><br><img src="../../../../images/SRE/day55/11.jpg" alt="11"></p>
<p>范例： 下载最新版</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#官网下载比较慢</span></span><br><span class="line">[root@ubuntu2204 ~]<span class="comment"># wget http://mirrors.jenkins.io/war-stable/latest/jenkins.war</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#国内镜像下载</span></span><br><span class="line">root@ubuntu2204 ~]<span class="comment"># wget https://mirrors.tuna.tsinghua.edu.cn/jenkins/war-stable/latest/jenkins.war</span></span><br><span class="line">[root@ubuntu2204 ~]<span class="comment"># ll -h jenkins.war </span></span><br><span class="line">-rw-r--r-- 1 root root 91M  1月 11 17:54 jenkins.war</span><br></pre></td></tr></table></figure>

<h4 id="基于-Docker-部署-Jenkins"><a href="#基于-Docker-部署-Jenkins" class="headerlink" title="基于 Docker 部署 Jenkins"></a>基于 Docker 部署 Jenkins</h4><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">https://www.jenkins.io/doc/book/installing/docker/</span><br><span class="line">https://www.jenkins.io/zh/doc/book/installing/#%E5%9C%A8docker%E4%B8%AD%E4%B8%8B%E8%BD%BD%E5%B9%B6%E8%BF%90%E8%A1%8Cjenkins</span><br></pre></td></tr></table></figure>

<p>范例</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">docker network create jenkins</span><br><span class="line">docker run \</span><br><span class="line">  --name jenkins-docker \</span><br><span class="line">  --<span class="built_in">rm</span> \</span><br><span class="line">  --detach \</span><br><span class="line">  --privileged \</span><br><span class="line">  --network jenkins \</span><br><span class="line">  --network-alias docker \</span><br><span class="line">  --<span class="built_in">env</span> DOCKER_TLS_CERTDIR=/certs \</span><br><span class="line">  --volume jenkins-docker-certs:/certs/client \</span><br><span class="line">  --volume jenkins-data:/var/jenkins_home \</span><br><span class="line">  --publish 2376:2376 \</span><br><span class="line">  docker:dind \</span><br><span class="line">  --storage-driver overlay2</span><br></pre></td></tr></table></figure>

<p>范例</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#docker run -u root \</span></span><br><span class="line">           -d -p 8080:8080 \</span><br><span class="line">           -p 50000:50000 \</span><br><span class="line">           -v jenkins-data:/var/jenkins_home \</span><br><span class="line">           -v /etc/localtime:/etc/localtime:ro \</span><br><span class="line">           -v /var/run/docker.sock:/var/run/docekr.sock \</span><br><span class="line">           --restart=always \</span><br><span class="line">           jenkinsci/blueocean</span><br><span class="line">           </span><br><span class="line"><span class="comment">#镜像jenkinsci/jenkins 是没有blueocean插件的，得自己装</span></span><br><span class="line"><span class="comment">#镜像jenkinsci/blueocean:内置bluecocean插件</span></span><br><span class="line"><span class="comment">#/var/run/docker.sock 表示Docker守护程序通过其监听的基于Unix的套接字。该映射允许</span></span><br><span class="line">jenkinsci/blueocean容器与Docker守护进程通信，如果jenkinsci/blueocean容器需要实例化其他</span><br><span class="line">Docker容器，则该守护进程是必需的。如果运行声明式管道，其语法包含agent部分用docker;例如，agent </span><br><span class="line">&#123; docker &#123;... &#125;&#125;此选项是必需的。</span><br></pre></td></tr></table></figure>

<h3 id="启动-Jenkins"><a href="#启动-Jenkins" class="headerlink" title="启动 Jenkins"></a>启动 Jenkins</h3><p>启动 Jenkins 可以通过下面三种方式实现</p>
<ul>
<li>利用 service 文件启动</li>
<li>利用 jar 命令直接启动</li>
<li>利用 tomcat 启动</li>
</ul>
<h4 id="通过脚本或service启动"><a href="#通过脚本或service启动" class="headerlink" title="通过脚本或service启动"></a>通过脚本或service启动</h4><p>安装和下载相关文件后，可以通过init脚本或service方式直接启动，</p>
<p>包安装后，直接内置service，可以直接启动</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@jenkins ~]<span class="comment"># systemctl start jenkins</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#查看日志</span></span><br><span class="line">[root@jenkins ~]<span class="comment"># tail -n1 /var/log/jenkins/jenkins.log </span></span><br><span class="line">2020-02-11 06:16:25.540+0000 [<span class="built_in">id</span>=20] INFO hudson.WebAppMain<span class="variable">$3</span><span class="comment">#run: Jenkins is fully up and running</span></span><br></pre></td></tr></table></figure>

<h4 id="通过-Java-命令直接启动-Jenkins"><a href="#通过-Java-命令直接启动-Jenkins" class="headerlink" title="通过 Java 命令直接启动 Jenkins"></a>通过 Java 命令直接启动 Jenkins</h4><p>如果是下载WAR包文件，可以直接使用 java 命令启动</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#查看帮助</span></span><br><span class="line"><span class="comment">#java -jar jenkins.war --help</span></span><br><span class="line"></span><br><span class="line">Running from: /usr/share/jenkins/jenkins.war</span><br><span class="line">webroot: <span class="variable">$user</span>.home/.jenkins</span><br><span class="line">Jenkins Automation Server Engine 2.289.2</span><br><span class="line">Usage: java -jar jenkins.war [--option=value] [--option=value]</span><br><span class="line"></span><br><span class="line">Options:</span><br><span class="line">   --webroot                = folder <span class="built_in">where</span> the WAR file is expanded into. Default is <span class="variable">$&#123;JENKINS_HOME&#125;</span>/war</span><br><span class="line">   --pluginroot             = folder <span class="built_in">where</span> the plugin archives are expanded into. Default is <span class="variable">$&#123;JENKINS_HOME&#125;</span>/plugins</span><br><span class="line">                             (NOTE: this option does not change the directory <span class="built_in">where</span> the plugin archives are stored)</span><br><span class="line">   --extractedFilesFolder   = folder <span class="built_in">where</span> extracted files are to be located. Default is the temp folder</span><br><span class="line">   --daemon                 = fork into background and run as daemon (Unix only)</span><br><span class="line">   </span><br><span class="line">   </span><br><span class="line"><span class="comment">#用户 java 命令直接启动jenkins</span></span><br><span class="line"><span class="comment"># java \</span></span><br><span class="line">-Dcom.sun.management.jmxremote \</span><br><span class="line">-Djava.rmi.server.hostname=<span class="string">&quot;10.0.0.101 &quot;</span> \</span><br><span class="line">-Dcom.sun.management.jmxremote.port=12345 \</span><br><span class="line">-Dcom.sun.management.jmxremote.authenticate=<span class="literal">false</span> \</span><br><span class="line">-Dcom.sun.management.jmxremote.ssl=<span class="literal">false</span> \</span><br><span class="line">-jar jenkins-2.138.3.war &amp;</span><br></pre></td></tr></table></figure>

<h4 id="将-WAR-文件放在tomcat进行运行"><a href="#将-WAR-文件放在tomcat进行运行" class="headerlink" title="将 WAR 文件放在tomcat进行运行"></a>将 WAR 文件放在tomcat进行运行</h4><p>如果是下载WAR包文件，也可以通过Tomcat 启动。</p>
<p>先安装tomcat，将 jenkins.war配置tomcat的应用目录即可</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@rocky8 ~]<span class="comment"># mkdir /home/tomcat/.jenkins -pv</span></span><br><span class="line"><span class="built_in">mkdir</span>: created directory <span class="string">&#x27;/home/tomcat&#x27;</span></span><br><span class="line"><span class="built_in">mkdir</span>: created directory <span class="string">&#x27;/home/tomcat/.jenkins&#x27;</span></span><br><span class="line"></span><br><span class="line">[root@rocky8 ~]<span class="comment"># chown -R tomcat.tomcat /home/tomcat/</span></span><br><span class="line">[root@rocky8 ~]<span class="comment"># systemctl restart tomcat</span></span><br><span class="line">[root@rocky8 ~]<span class="comment"># cat /home/tomcat/.jenkins/secrets/initialAdminPassword</span></span><br><span class="line">dbbff06091f1436e8ada27b26b108856</span><br></pre></td></tr></table></figure>

<p><img src="../../../../images/SRE/day55/12.jpg" alt="12"></p>
<h3 id="首次登录-Jenkins页面初始化"><a href="#首次登录-Jenkins页面初始化" class="headerlink" title="首次登录 Jenkins页面初始化"></a>首次登录 Jenkins页面初始化</h3><h4 id="首次登录-Jenkins-页面"><a href="#首次登录-Jenkins-页面" class="headerlink" title="首次登录 Jenkins 页面"></a>首次登录 Jenkins 页面</h4><p>用浏览器访问： <code>http://jenkins.wang.org:8080/</code> </p>
<p>默认内置用户<code>admin</code>，其密码为随机字符，可以从如下文件中查到密码</p>
<p><img src="../../../../images/SRE/day55/13.jpg" alt="13"></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@ubuntu1804 ~]<span class="comment"># cat /var/lib/jenkins/secrets/initialAdminPassword</span></span><br><span class="line">7d19df2dd74b48a9a48e9534456d0c92</span><br></pre></td></tr></table></figure>

<p>输入文件中的密码：</p>
<p><img src="../../../../images/SRE/day55/14.jpg" alt="14"></p>
<h4 id="选择安装-Jenkins-插件"><a href="#选择安装-Jenkins-插件" class="headerlink" title="选择安装 Jenkins 插件"></a>选择安装 Jenkins 插件</h4><p>因为默认安装插件需要连接国外的网站，会很慢，所以建议选择插件安装，先不安装任何插件，后续做优化配置后再安装会快很多.</p>
<p><img src="../../../../images/SRE/day55/15.jpg" alt="15"></p>
<p><strong>选择安装推荐的插件</strong>会安装很慢，可以选择不安装，直接点右上角的X直接完成安装过程，后续再用离线方式安装插件</p>
<p><img src="../../../../images/SRE/day55/16.jpg" alt="16"></p>
<p><strong>离线状态</strong></p>
<p><img src="../../../../images/SRE/day55/17.jpg" alt="17"></p>
<p>如果显示 jenkins 已离线 ，将/var/lib/jenkins/hudson.model.UpdateCenter.xml文件中的更新检查地址改成国内镜像地址，如清华大学地址，然后重启 jenkins 即可：</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">https://mirrors.tuna.tsinghua.edu.cn/jenkins/updates/update-center.json</span><br><span class="line">https://mirrors.aliyun.com/jenkins/updates/update-center.json</span><br><span class="line">https://jenkins-zh.gitee.io/update-center-mirror/tsinghua/update-center.json</span><br></pre></td></tr></table></figure>

<p><strong>范例： 解决离线问题</strong></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@ubuntu1804 ~]<span class="comment"># vim /var/lib/jenkins/hudson.model.UpdateCenter.xml</span></span><br><span class="line">&lt;?xml version=<span class="string">&#x27;1.1&#x27;</span> encoding=<span class="string">&#x27;UTF-8&#x27;</span>?&gt;</span><br><span class="line">&lt;sites&gt;</span><br><span class="line"> &lt;site&gt;</span><br><span class="line">   &lt;<span class="built_in">id</span>&gt;default&lt;/id&gt;</span><br><span class="line"><span class="comment">#修改此行为下面行 &lt;url&gt;https://updates.jenkins.io/update-center.json&lt;/url&gt;</span></span><br><span class="line">   &lt;url&gt;https://jenkins-zh.gitee.io/update-center-mirror/tsinghua/update-center.json&lt;/url&gt;</span><br><span class="line"> &lt;/site&gt;</span><br><span class="line">&lt;/sites&gt;</span><br></pre></td></tr></table></figure>

<h4 id="插件安装"><a href="#插件安装" class="headerlink" title="插件安装"></a>插件安装</h4><p>选无 ，不安装任何插件</p>
<p><img src="../../../../images/SRE/day55/18.jpg" alt="18"></p>
<p>如果是选择安装推荐的插件，进入下面页面，安装插件很慢，可以通过下面方法解决</p>
<p><img src="../../../../images/SRE/day55/19.jpg" alt="19"></p>
<p>为了解决插件安装慢的解决方式 ，利用清华的jenkins源通过 Nginx 进行 rewrite 或者反向代理，如下：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#此方式只支持http</span></span><br><span class="line"><span class="comment">#在jenkins服务器上修改/etc/hosts 指向新安装的nginx服务器：10.0.0.102</span></span><br><span class="line">[root@jenkins-ubuntu ~]<span class="comment"># vim /etc/hosts</span></span><br><span class="line">10.0.0.102 updates.jenkins-ci.org updates.jenkins.io</span><br><span class="line"></span><br><span class="line"><span class="comment">#在另一台主机安装nginx，并修改配置</span></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment"># apt -y install nginx</span></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment"># vim /etc/nginx/sites-enabled/default</span></span><br><span class="line"><span class="comment">#加下面行</span></span><br><span class="line">location /download/plugins &#123;</span><br><span class="line">  proxy_set_header Host mirrors.tuna.tsinghua.edu.cn;</span><br><span class="line">  proxy_set_header X-Real-IP <span class="variable">$remote_addr</span>;</span><br><span class="line">  proxy_set_header X-Forwarded-For <span class="variable">$proxy_add_x_forwarded_for</span>;</span><br><span class="line">  rewrite /download/plugins(.*) /jenkins/plugins/<span class="variable">$1</span> <span class="built_in">break</span>;</span><br><span class="line">  proxy_pass http://mirrors.tuna.tsinghua.edu.cn;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment"># systemctl restart nginx</span></span><br></pre></td></tr></table></figure>

<p>对于 https 可以将上面的update-center.json 文件中updates.jenkins.io 替换为国内镜像站点即可解决</p>
<h4 id="创建-Jenkins-管理员-可选"><a href="#创建-Jenkins-管理员-可选" class="headerlink" title="创建 Jenkins 管理员(可选)"></a>创建 Jenkins 管理员(可选)</h4><p>用户信息保存在下面目录</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@jenkins ~]<span class="comment"># ls /var/lib/jenkins/users/</span></span><br></pre></td></tr></table></figure>

<p>系统默认有一个管理员帐号admin，继续即可</p>
<p><img src="../../../../images/SRE/day55/20.jpg" alt="20"></p>
<p>也可以新创建一个管理员帐号</p>
<p><img src="../../../../images/SRE/day55/21.jpg" alt="21"></p>
<p>也可以选项下面的 使用<code>admin帐号继续</code></p>
<h4 id="配置-Jenkins-URL"><a href="#配置-Jenkins-URL" class="headerlink" title="配置 Jenkins URL"></a>配置 Jenkins URL</h4><p>保存完成即可</p>
<p><img src="../../../../images/SRE/day55/22.jpg" alt="22"></p>
<h4 id="配置完成并登陆-Jenkins"><a href="#配置完成并登陆-Jenkins" class="headerlink" title="配置完成并登陆 Jenkins"></a>配置完成并登陆 Jenkins</h4><p>如果没有创建新管理员帐号，界面如下</p>
<p><img src="../../../../images/SRE/day55/23.jpg" alt="23"></p>
<p>如果创建新管理员，界面如下</p>
<p><img src="../../../../images/SRE/day55/24.jpg" alt="24"></p>
<h4 id="登陆-Jenkins界面"><a href="#登陆-Jenkins界面" class="headerlink" title="登陆 Jenkins界面"></a>登陆 Jenkins界面</h4><p>如果没有创建管理员，可以直接使用内置用户 admin 登录</p>
<p><img src="../../../../images/SRE/day55/25.jpg" alt="25"></p>
<p>如果创建新的管理员，直接用新管理员登录</p>
<p><img src="../../../../images/SRE/day55/26.jpg" alt="26"></p>
<h2 id="Jenkins-基础配置"><a href="#Jenkins-基础配置" class="headerlink" title="Jenkins 基础配置"></a>Jenkins 基础配置</h2><h3 id="修改管理员密码"><a href="#修改管理员密码" class="headerlink" title="修改管理员密码"></a>修改管理员密码</h3><p><img src="../../../../images/SRE/day55/27.jpg" alt="27"><br><img src="../../../../images/SRE/day55/28.jpg" alt="28"></p>
<h3 id="Jenkins-管理工具"><a href="#Jenkins-管理工具" class="headerlink" title="Jenkins 管理工具"></a>Jenkins 管理工具</h3><p>jenkins 指供了Web 管理界面，也提供了命令行管理工具</p>
<p><img src="../../../../images/SRE/day55/29.jpg" alt="29"></p>
<p>先下载jenkins.cli.jar文件，可以执行下面操作进行管理jenkins</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@jenkins ~]<span class="comment"># wget http://jenkins.wang.org:8080/jnlpJars/jenkins-cli.jar</span></span><br><span class="line"></span><br><span class="line">[root@jenkins ~]<span class="comment"># ll -h jenkins-cli.jar </span></span><br><span class="line">-rw-r--r-- 1 root root 3.4M Oct 16 11:02 jenkins-cli.jar</span><br><span class="line"></span><br><span class="line">[root@jenkins ~]<span class="comment"># java -jar jenkins-cli.jar -s http://admin:123456@jenkins.wang.org:8080/ -webSocket help</span></span><br><span class="line">[root@jenkins ~]<span class="comment"># java -jar jenkins-cli.jar -s http://admin:123456@jenkins.wang.org:8080/ -webSocket list-jobs</span></span><br><span class="line">[root@jenkins ~]<span class="comment"># java -jar jenkins-cli.jar -s http://admin:123456@jenkins.wang.org:8080/ -webSocket restart</span></span><br></pre></td></tr></table></figure>

<h3 id="Jenkins-插件管理及安装"><a href="#Jenkins-插件管理及安装" class="headerlink" title="Jenkins 插件管理及安装"></a>Jenkins 插件管理及安装</h3><p>jenkins 本身的功能有限，但是插件丰富，大大扩展了jenkins的功能，当前已有1800+的插件. </p>
<p>要想使用jenkins实现生产需求，就必须安装相应的插件才能实现特定的功能</p>
<p><img src="../../../../images/SRE/day55/30.jpg" alt="30"></p>
<h4 id="插件安装目录"><a href="#插件安装目录" class="headerlink" title="插件安装目录"></a>插件安装目录</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">[root@ubuntu1804 ~]<span class="comment"># ls /var/lib/jenkins/plugins/</span></span><br><span class="line">ace-editor                              momentjs</span><br><span class="line">ace-editor.jpi                          momentjs.jpi</span><br><span class="line">ant                                     pam-auth</span><br><span class="line">antisamy-markup-formatter               pam-auth.jpi</span><br><span class="line">antisamy-markup-formatter.jpi           pipeline-build-step</span><br><span class="line">ant.jpi                                 pipeline-build-step.jpi</span><br><span class="line">apache-httpcomponents-client-4-api      pipeline-github-lib</span><br><span class="line">apache-httpcomponents-client-4-api.jpi  pipeline-github-lib.jpi</span><br><span class="line">authentication-tokens                   pipeline-graph-analysis</span><br><span class="line">authentication-tokens.jpi               pipeline-graph-analysis.jpi</span><br><span class="line">bouncycastle-api                        pipeline-input-step</span><br><span class="line">bouncycastle-api.jpi                    pipeline-input-step.jpi</span><br><span class="line">branch-api                              pipeline-milestone-step</span><br><span class="line">branch-api.jpi                          pipeline-milestone-step.jpi</span><br><span class="line">build-timeout                           pipeline-model-api</span><br><span class="line">build-timeout.jpi                       pipeline-model-api.jpi</span><br></pre></td></tr></table></figure>

<h4 id="插件管理"><a href="#插件管理" class="headerlink" title="插件管理"></a>插件管理</h4><p>插件安装过程中，如果因为某种原因导致有安装失败的插件，没有关系，可以后期再单独安装</p>
<p><img src="../../../../images/SRE/day55/31.jpg" alt="31"></p>
<p>如果因为防火墙等原因导致安装插件失败或者安装插件缓慢，可以通过下面方式配置</p>
<h5 id="方法1-更改-Jenkins-的镜像源为国内镜像站"><a href="#方法1-更改-Jenkins-的镜像源为国内镜像站" class="headerlink" title="方法1: 更改 Jenkins 的镜像源为国内镜像站"></a>方法1: 更改 Jenkins 的镜像源为国内镜像站</h5><p>修改指向国内的网址</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@jenkins ~]<span class="comment"># sed -i.bak &#x27;s#updates.jenkins.io/download#mirror.tuna.tsinghua.edu.cn/jenkins#g&#x27; /var/lib/jenkins/updates/default.json</span></span><br><span class="line">[root@jenkins ~]<span class="comment"># sed -i &#x27;s#www.google.com#www.baidu.com#g&#x27; /var/lib/jenkins/updates/default.json</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#注意：如果是tomcat运行war包方式需要下面路径</span></span><br><span class="line">[root@jenkins ~]<span class="comment"># sed -i.bak &#x27;s#https://updates.jenkins.io/download#https://mirror.tuna.tsinghua.edu.cn/jenkins#g&#x27; /root/.jenkins/updates/default.json</span></span><br></pre></td></tr></table></figure>

<p>将升级站点URL替换成下面国内镜像地址</p>
<p><img src="../../../../images/SRE/day55/32.jpg" alt="32"></p>
<p><img src="../../../../images/SRE/day55/33.jpg" alt="33"></p>
<p>将升级站点URL替换成下面国内镜像地址，提交后再次安装插件即可</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">#查看镜像源</span><br><span class="line">http://mirrors.jenkins-ci.org/status.html</span><br><span class="line">#默认镜像源</span><br><span class="line">https://updates.jenkins.io/update-center.json</span><br><span class="line">#国内镜像源</span><br><span class="line">https://mirror.tuna.tsinghua.edu.cn/jenkins/updates/update-center.json</span><br><span class="line">https://mirrors.aliyun.com/jenkins/updates/update-center.json</span><br></pre></td></tr></table></figure>

<p>查看镜像状态</p>
<p><img src="../../../../images/SRE/day55/34.jpg" alt="34"></p>
<p>修改update site 为</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://mirror.tuna.tsinghua.edu.cn/jenkins/updates/update-center.json</span><br></pre></td></tr></table></figure>

<p><img src="../../../../images/SRE/day55/35.jpg" alt="35"></p>
<p>在浏览器地址栏输入，点击yes 重启jenkins</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://jenkins服务器:8080/restart</span><br></pre></td></tr></table></figure>

<p><img src="../../../../images/SRE/day55/36.jpg" alt="36"></p>
<h5 id="方法2-Jenkins-官网或镜像网站下载想要的插件文件，再导入到-Jenkins-中"><a href="#方法2-Jenkins-官网或镜像网站下载想要的插件文件，再导入到-Jenkins-中" class="headerlink" title="方法2: Jenkins 官网或镜像网站下载想要的插件文件，再导入到 Jenkins 中"></a>方法2: Jenkins 官网或镜像网站下载想要的插件文件，再导入到 Jenkins 中</h5><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://plugins.jenkins.io/</span><br></pre></td></tr></table></figure>

<p><img src="../../../../images/SRE/day55/37.jpg" alt="37"></p>
<p>国内镜像站点插件下载地址：</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">http://updates.jenkins-ci.org/download/plugins/</span><br><span class="line">https://updates.jenkins.io/download/plugins/</span><br><span class="line">https://mirrors.aliyun.com/jenkins/plugins/</span><br><span class="line">https://mirrors.tuna.tsinghua.edu.cn/jenkins/plugins/</span><br></pre></td></tr></table></figure>

<p><img src="../../../../images/SRE/day55/38.jpg" alt="38"><br><img src="../../../../images/SRE/day55/39.jpg" alt="39"><br><img src="../../../../images/SRE/day55/40.jpg" alt="40"><br><img src="../../../../images/SRE/day55/41.jpg" alt="41"></p>
<h5 id="方法3-离线插件包复制至插件安装目录"><a href="#方法3-离线插件包复制至插件安装目录" class="headerlink" title="方法3: 离线插件包复制至插件安装目录"></a>方法3: 离线插件包复制至插件安装目录</h5><p>可以将其它主机的已安装好的插件打包后，再将之导入到安装插件目录即可</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@jenkins ~]<span class="comment"># systemctl stop jenkins</span></span><br><span class="line">[root@jenkins ~]<span class="comment"># tar jenkins_plugins.tar.gz -C /var/lib/jenkins/plugins/</span></span><br><span class="line">[root@jenkins ~]<span class="comment"># chown -R jenkins.jenkins /var/lib/jenkins/plugins/</span></span><br><span class="line">[root@jenkins ~]<span class="comment"># systemctl start jenkins</span></span><br></pre></td></tr></table></figure>

<h4 id="安装中文插件"><a href="#安装中文插件" class="headerlink" title="安装中文插件"></a>安装中文插件</h4><p>插件管理–搜索 chinese – 选中 Location: Chinese (simplified) 进行安装</p>
<p><img src="../../../../images/SRE/day55/42.jpg" alt="42"><br><img src="../../../../images/SRE/day55/43.jpg" alt="43"><br><img src="../../../../images/SRE/day55/44.jpg" alt="44"><br><img src="../../../../images/SRE/day55/45.jpg" alt="45"></p>
<h3 id="修改-Jenkins-的启动用户为-root"><a href="#修改-Jenkins-的启动用户为-root" class="headerlink" title="修改 Jenkins 的启动用户为 root"></a>修改 Jenkins 的启动用户为 root</h3><p>默认Jenkins以jenkins的用户身份运行，会导致权限受限，可以修改service文件设为root身份运行解决此问题</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#基于 Ubuntu安装修改下面文件</span></span><br><span class="line">[root@jenkins ~]<span class="comment"># vim /lib/systemd/system/jenkins.service</span></span><br><span class="line"><span class="comment">#User=jenkins</span></span><br><span class="line"><span class="comment">#Group=jenkins</span></span><br><span class="line">User=root</span><br><span class="line">Group=root</span><br><span class="line"></span><br><span class="line">[root@jenkins ~]<span class="comment"># systemctl daemon-reload </span></span><br><span class="line">[root@jenkins ~]<span class="comment"># systemctl restart jenkins.service</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#基于RHEL系统安装修改下面文件</span></span><br><span class="line">[root@jenkins ~]<span class="comment"># vim /etc/sysconfig/jenkins</span></span><br><span class="line"><span class="comment">#JENKINS_USER=&quot;jenkins&quot;</span></span><br><span class="line">JENKINS_USER=<span class="string">&quot;root&quot;</span></span><br></pre></td></tr></table></figure>

<h3 id="优化配置"><a href="#优化配置" class="headerlink" title="优化配置"></a>优化配置</h3><p>默认只能并行2个任务，建议根据CPU核心数，将执行者数量修改为CPU的核数</p>
<p>管理 jenkins – Configure System</p>
<p><img src="../../../../images/SRE/day55/46.jpg" alt="46"></p>
<p>修改为如下</p>
<p><img src="../../../../images/SRE/day55/47.jpg" alt="47"></p>
<h3 id="Jenkins-的备份还原"><a href="#Jenkins-的备份还原" class="headerlink" title="Jenkins 的备份还原"></a>Jenkins 的备份还原</h3><p>Jenkins的相关数据都是放在主目录中， 将主目录备份即可实现Jenkins的备份，必要时用于还原</p>
<p>另外如果有相关脚本等，也需要进行备份</p>
<p>可以如下查看目录位置</p>
<p>管理Jenkins— Configure System </p>
<p><img src="../../../../images/SRE/day55/48.jpg" alt="48"></p>
<p>jenkins 主目录包含以下文件和目录：</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">*.xml               需要备份</span><br><span class="line">config-history      需要备份</span><br><span class="line">fingerprints        需要备份</span><br><span class="line">global-build-stats  需要备份</span><br><span class="line">*.key*              需要备份</span><br><span class="line">jobs                jobs配置需要备份（config.xml， nextBuildNumber）， builds目录（build logs等）根据需求而定</span><br><span class="line">nodes               需要备份</span><br><span class="line">plugins             需要备份 *.jpi及 *.hpi，可以不备份每个插件子目录，jenkins启动后会更新插件子目录</span><br><span class="line">secrets             需要备份</span><br><span class="line">updates             需要备份</span><br><span class="line">userContent         用户上传内容，可以根据需要备份</span><br><span class="line">users               用户缓存信息，最好备份</span><br><span class="line">logs                插件logs，根据需求而定，可以不备份</span><br><span class="line">monitoring          可以不备份，插件会实时生成监控数据</span><br></pre></td></tr></table></figure>

<h1 id="Jenkins-实现-CICD"><a href="#Jenkins-实现-CICD" class="headerlink" title="Jenkins 实现 CICD"></a>Jenkins 实现 CICD</h1><h2 id="Jenkins-实现-CICD-说明"><a href="#Jenkins-实现-CICD-说明" class="headerlink" title="Jenkins 实现 CICD 说明"></a>Jenkins 实现 CICD 说明</h2><p>任务中构建将程序源码转换成一个可用的目标(target）的过程，该过程可能会包括获取下载源码，解决依赖、编译和打包等环节</p>
<p>目标可以包括库、可执行文件及生成的脚本等，该类文件即是所谓的“制品”，它们通常应该存储于制品库，Nexus就是著名的制品库服务之一</p>
<p>程序员可以在本地进行构建，但基于有标准、统一构建环境的构建系统完成应用程序的构建，能有效确保制品质量</p>
<p>Jenkins虽然可以为构建服务器，但自身并未提供构建工具</p>
<p>Jenkins可以集成用户所需要的大部分主流构建工具</p>
<p>构建工具与源程序的编程语言及工程工具有密切关系，因而，在Jenkins服务器中具体需要安装和集成的构建工具，取决于用户的实际需要</p>
<ul>
<li>Maven: Java</li>
<li>SBT: Scala</li>
<li>Babel、Browserify、Weboack、Grunt及Gulp等： javascript</li>
<li>Gradle: Java，Groovey和Kotlin等</li>
</ul>
<p>Jenkins 实现CICD 流程</p>
<p><img src="../../../../images/SRE/day55/49.jpg" alt="49"><br><img src="../../../../images/SRE/day55/50.jpg" alt="50"></p>
<p>Jenkins根据业务场景的不同，提供了多种风格的任务，默认是自由风格任务，通过安装插件，还可以支持其它风格的插件</p>
<p>Job的风格分类</p>
<ul>
<li>自由风格freestyle: 根据内部的配置属性，实现各种场景的风格</li>
<li>流水线 pipeline</li>
<li>Maven 项目</li>
</ul>
<h2 id="创建-Freestyle-风格的任务-Job"><a href="#创建-Freestyle-风格的任务-Job" class="headerlink" title="创建 Freestyle 风格的任务 Job"></a>创建 Freestyle 风格的任务 Job</h2><h3 id="Freestyle-风格任务说明"><a href="#Freestyle-风格任务说明" class="headerlink" title="Freestyle 风格任务说明"></a>Freestyle 风格任务说明</h3><p><img src="../../../../images/SRE/day55/51.jpg" alt="51"></p>
<p>自由风格的任务提供了下面的组成</p>
<ul>
<li>通用配置：当前任务的基本配置，历史记录、存储数据、认证、存储目录等</li>
<li>源码管理：指定当前任务依赖的代码仓库地址(仓库的分支)</li>
<li>构建触发器：在什么情况下，才会自动执行当前的任务</li>
<li>构建环境：构建过程中，依赖的环境变量等</li>
<li>构建：当前的代码后续操作</li>
<li>构建后动作：构建任务成功后，我们可以做的事情，发送邮件、提交代码标签、触发其他任务、等等</li>
</ul>
<p>构建支持变量</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://jenkins-server:8080/env-vars.html/</span><br></pre></td></tr></table></figure>

<p><strong>构建状态</strong></p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">晴雨表主要是针对一个任务的整体执行成功比例来算的。80%成功表示太阳。</span><br></pre></td></tr></table></figure>

<p><img src="../../../../images/SRE/day55/52.jpg" alt="52"></p>
<h3 id="Freestyle-风格任务构建流程"><a href="#Freestyle-风格任务构建流程" class="headerlink" title="Freestyle 风格任务构建流程"></a>Freestyle 风格任务构建流程</h3><p><img src="../../../../images/SRE/day55/53.jpg" alt="53"></p>
<ul>
<li><p>新建任务</p>
<p>输入任务名</p>
<p>选择自由风格的软件项目</p>
<p>描述该任务的作用</p>
</li>
<li><p>设置丢弃旧的构建</p>
<p>丢弃旧的构建：构建后的产物，保留多久</p>
<p>条件1：保持构建的天数：当前项目构建的产物最多保留多少天</p>
<p>条件2：保持构建的最大个数：当前项目最多保留多少构建产物，多出的自动删除 </p>
</li>
<li><p>源码管理</p>
<p>从gitlab等仓库下载源码</p>
</li>
<li><p>构建触发器</p>
<p>定义自动构建的触发器</p>
</li>
<li><p>构建</p>
<p>构建项目的具体过程，比如： 编译，打包，部署等</p>
</li>
<li><p>构建后操作</p>
<p>构建完成后可以执行的操作，比如，通知或执行其它任务</p>
</li>
</ul>
<h3 id="Jenkins-构建的环境变量"><a href="#Jenkins-构建的环境变量" class="headerlink" title="Jenkins 构建的环境变量"></a>Jenkins 构建的环境变量</h3><p>构建时，Jenkins中内置很多变量，可以直接在脚本中灵活调用</p>
<p>环境变量有内置和自定义两种</p>
<p>注意：自定义环境变量与全局环境变量同名时，全局环境变量将被覆盖；这可能会引起错误，必要时，可为自定义环境变量使用固定的前缀，例如“_ _”等</p>
<p>Jenkins提供了多个内置的变量</p>
<ul>
<li>Jenkins内置的全局环境变量可被所有的pipeline引用，它们以“env.”为前缀</li>
<li>引用全局环境变量格式有三种： ${env.}、$env.和${ENV_VAR_NAME}</li>
</ul>
<p>自定义变量可以在系统管理–配置系统–全局属性– 环境变量 定义</p>
<p>下面是Jenkins内置的几个常用的环境变量</p>
<ul>
<li>JENKINS_HOME：Jenkins的家目录</li>
<li>JENKINS_URL：Jenkins服务的URL</li>
<li>JOB_NAME：当前作业的名称</li>
<li>BUILD_NUMBER：构建号，递增的整数值；打包时，经常用作制品名称的一部分</li>
<li>BRANCH_NAME：在多分支pipeline中，需要根据不同的分支施加不同的操作时较为常用</li>
<li>BUILD_URL：当前构建页面的URL，常用于邮件通知中</li>
<li>GIT_BRANCH：基于git拉取的源码进行构建时使用该变量</li>
</ul>
<p>可以在Jenkins的管理页面查看到内置变量</p>
<p><img src="../../../../images/SRE/day55/54.jpg" alt="54"><br><img src="../../../../images/SRE/day55/55.jpg" alt="55"><br><img src="../../../../images/SRE/day55/56.jpg" alt="56"></p>
<h3 id="案例：-创建简单的-Freestyle-任务"><a href="#案例：-创建简单的-Freestyle-任务" class="headerlink" title="案例： 创建简单的 Freestyle 任务"></a>案例： 创建简单的 Freestyle 任务</h3><p><img src="../../../../images/SRE/day55/57.jpg" alt="57"></p>
<p>如果没有安装相关插件，只有一种”自由风格的任务软件项目可选</p>
<p><img src="../../../../images/SRE/day55/58.jpg" alt="58"><br><img src="../../../../images/SRE/day55/59.jpg" alt="59"><br><img src="../../../../images/SRE/day55/60.jpg" alt="60"><br><img src="../../../../images/SRE/day55/61.jpg" alt="61"><br><img src="../../../../images/SRE/day55/62.jpg" alt="62"></p>
<p>查看输出信息，可以看到很多变量</p>
<p><img src="../../../../images/SRE/day55/63.jpg" alt="63"></p>
<p>重复上面过程创建多个任务，如下显示</p>
<p><img src="../../../../images/SRE/day55/64.jpg" alt="64"></p>
<h2 id="Jenkins-结合-GitLab-实现代码下载"><a href="#Jenkins-结合-GitLab-实现代码下载" class="headerlink" title="Jenkins 结合 GitLab 实现代码下载"></a>Jenkins 结合 GitLab 实现代码下载</h2><h3 id="GitLab-创建项目"><a href="#GitLab-创建项目" class="headerlink" title="GitLab 创建项目"></a>GitLab 创建项目</h3><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://gitee.com/lbtooth/wheel_of_fortune.git</span><br></pre></td></tr></table></figure>

<p>导入项目</p>
<p><img src="../../../../images/SRE/day55/65.jpg" alt="65"><br><img src="../../../../images/SRE/day55/66.jpg" alt="66"><br><img src="../../../../images/SRE/day55/67.jpg" alt="67"><br><img src="../../../../images/SRE/day55/68.jpg" alt="68"></p>
<h3 id="Jenkins-安装和-Gitlab-相关的插件"><a href="#Jenkins-安装和-Gitlab-相关的插件" class="headerlink" title="Jenkins 安装和 Gitlab 相关的插件"></a>Jenkins 安装和 Gitlab 相关的插件</h3><p>只有安装GitLab相关的插件，才能让Jenkins和GitLab相连</p>
<p>在管理插件中搜索需要gitlab的相关插件并安装</p>
<p><img src="../../../../images/SRE/day55/69.jpg" alt="69"><br><img src="../../../../images/SRE/day55/70.jpg" alt="70"></p>
<p>选中下面“安装完成后重启Jenkins(空闲时)，自动重启jenkins</p>
<p><img src="../../../../images/SRE/day55/71.jpg" alt="71"><br><img src="../../../../images/SRE/day55/72.jpg" alt="72"><br><img src="../../../../images/SRE/day55/73.jpg" alt="73"></p>
<h3 id="Jenkins-服务器创建访问GitLab的凭据"><a href="#Jenkins-服务器创建访问GitLab的凭据" class="headerlink" title="Jenkins 服务器创建访问GitLab的凭据"></a>Jenkins 服务器创建访问GitLab的凭据</h3><p><strong>Jenkins 凭证概述</strong></p>
<p>凭证就是认证到某个系统中的认证信息，用于提供对受限资源的访问; </p>
<p>Jenkins所支持的凭证类型如下</p>
<ul>
<li>用户名和密码(Username with password)</li>
<li>SSH用户名和私钥日(SSH Username with private key)</li>
<li>Github App Secret file: 需要保密的文本文件，保存有Token等信息</li>
<li>Secret text:Token，串需要保密的文本，例如Github的API Token等 </li>
<li>Certificate</li>
<li>其它凭证类型还有二进制数据，或者更复杂形式的项目，例如OAuth凭证等;</li>
</ul>
<p>凭证的作用域决定了它可用的目标范围</p>
<ul>
<li>系统：作用于Jenkins系统自身，仅可用于系统和后台任务，且一般用于连接到agent节点之上</li>
<li>全局：作用于Jenkins上的所有任务，以确保任务的正常执行</li>
<li>用户：作用于用户级别，仅生效于Jenkins中的线程代表该用户进行身份验证之时; </li>
</ul>
<p>注意：在Jenkins内部，凭证被存放在JENKINS_ HOME目录下的secrets目录中，请务必确保该目录的访问权限进行了正确的设置</p>
<h4 id="添加基于用户名和密码类型的凭据"><a href="#添加基于用户名和密码类型的凭据" class="headerlink" title="添加基于用户名和密码类型的凭据"></a>添加基于用户名和密码类型的凭据</h4><p>如果基于http协议则无需实现ssh key 凭证，而选择添加gitlab用户名和密码的形式</p>
<p><img src="../../../../images/SRE/day55/74.jpg" alt="74"></p>
<h4 id="创建基于-ssh-key-的凭据"><a href="#创建基于-ssh-key-的凭据" class="headerlink" title="创建基于 ssh key 的凭据"></a>创建基于 ssh key 的凭据</h4><p>实现jenkins服务器到gitlab服务器的基于密钥的验证，可以让jenkins连接到gitlab执行操作，比如拉取代码</p>
<h5 id="在-Jenkins-服务器上生成-ssh-key"><a href="#在-Jenkins-服务器上生成-ssh-key" class="headerlink" title="在 Jenkins 服务器上生成 ssh key"></a>在 Jenkins 服务器上生成 ssh key</h5><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#在jenkins服务器上生成密钥对</span></span><br><span class="line">[root@jenkins-ubunutu1804 ~]<span class="comment"># ssh-keygen</span></span><br><span class="line">[root@jenkins-ubunutu1804 ~]<span class="comment"># cat .ssh/id_rsa.pub</span></span><br><span class="line">ssh-rsa </span><br><span class="line">AAAAB3NzaC1yc2EAAAADAQABAAABAQC/LAA5tcFrSLye3QE9a+RH8LSYzwewJ4MBSBvVP7pImKMqg21W</span><br><span class="line">ozWw56RKqiSsj9ewO8zL43yfAwOjetrKr2Ovbxw9bOaxj0r1CobpXsD5H7pS4Cq0lLJxSmFwCLroz1C9</span><br><span class="line">ecGhBWBmaCbkOaJ0Q6JLTO830w7noTFYZq4/NWTGtE4xpVDDNUFTAS4j4T/0QQF6YvXIqw0EzdKKkuZL</span><br><span class="line">w9Rl9f2j7D1eNJX3QyY2LSgxPsXE77PzlKeJue0FKa0JwzNeKNS01rM9ztoc0VQVhxjOgjY+rhoUtBFY</span><br><span class="line">wxXQLmwtBq82dh6qVBKrCDpNIPE+XaXFZVMyZ0Ahs3vD2iIP9Xz/ root@jenkins-ubunutu1804</span><br></pre></td></tr></table></figure>

<h5 id="在-Gitlab服务器上用户中关联-Jenkins-生成的ssh-公钥key"><a href="#在-Gitlab服务器上用户中关联-Jenkins-生成的ssh-公钥key" class="headerlink" title="在 Gitlab服务器上用户中关联 Jenkins 生成的ssh 公钥key"></a>在 Gitlab服务器上用户中关联 Jenkins 生成的ssh 公钥key</h5><p>新版界面</p>
<p>在GitLab中项目具有访问权限的用户帐号的profile中导入Jenkins的公钥</p>
<p><img src="../../../../images/SRE/day55/75.jpg" alt="75"><br><img src="../../../../images/SRE/day55/76.jpg" alt="76"></p>
<p>旧版界面</p>
<p><img src="../../../../images/SRE/day55/77.jpg" alt="77"></p>
<p><img src="../../../../images/SRE/day55/78.jpg" alt="78"></p>
<h5 id="在-Jenkins服务器上测试-ssh-key"><a href="#在-Jenkins服务器上测试-ssh-key" class="headerlink" title="在 Jenkins服务器上测试 ssh key"></a>在 Jenkins服务器上测试 ssh key</h5><p>测试可以不使用用户名密码后直接获取代码</p>
<p>先在gitlab查看项目的下载地址： <code>git@gitlab.wang.org:testgroup/testproject.git</code></p>
<p><img src="../../../../images/SRE/day55/79.jpg" alt="79"></p>
<p>在jenkins服务器上执行克隆，不再需要用户和密码</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">[root@jenkins-ubunutu1804 ~]<span class="comment"># git clone git@gitlab.wang.org:testgroup/testproject.git</span></span><br><span class="line">Cloning into <span class="string">&#x27;testproject&#x27;</span>...</span><br><span class="line">remote: Enumerating objects: 9, <span class="keyword">done</span>.</span><br><span class="line">remote: Counting objects: 100% (9/9), <span class="keyword">done</span>.</span><br><span class="line">remote: Compressing objects: 100% (5/5), <span class="keyword">done</span>.</span><br><span class="line">remote: Total 9 (delta 0), reused 9 (delta 0)</span><br><span class="line">Receiving objects: 100% (9/9), <span class="keyword">done</span>.</span><br><span class="line"></span><br><span class="line">[root@jenkins-ubunutu1804 ~]<span class="comment"># ls</span></span><br><span class="line">testproject</span><br><span class="line"></span><br><span class="line">[root@jenkins-ubunutu1804 ~]<span class="comment"># tree testproject/</span></span><br><span class="line">testproject/</span><br><span class="line">├── index.html</span><br><span class="line">└── README.md</span><br><span class="line"></span><br><span class="line">0 directories, 2 files</span><br></pre></td></tr></table></figure>

<h5 id="在-Jenkins-添加用户名和-private-key-类型凭据"><a href="#在-Jenkins-添加用户名和-private-key-类型凭据" class="headerlink" title="在 Jenkins 添加用户名和 private key 类型凭据"></a>在 Jenkins 添加用户名和 private key 类型凭据</h5><p>虽然 Jenkins 将root用户公钥传给gitlab可以实现从GitLab服务器基于ssh key 克隆项目，但是Jenkins 无法自动获取root用户的私钥，也就无法在直接在Jenkins的项目中直接连接GitLab的仓库</p>
<p>还需要在Jenkins通过将Jenkins的root对应的私钥创建为Jenkins的凭证，以方便后续的连接GitLab使用</p>
<p>新版界面</p>
<p>系统管理 -- 凭据</p>
<p><img src="../../../../images/SRE/day55/80.jpg" alt="80"><br><img src="../../../../images/SRE/day55/81.jpg" alt="81"></p>
<p>复制Jenkins服务器root用户之前生成的私钥</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@jenkins-ubuntu ~]<span class="comment"># cat .ssh/id_rsa</span></span><br><span class="line">MIIEowIBAAKCAQEA7i2eeMfdhILDKU9GlNpi9CAH5OAp98wP0/77EfFvHqB7AGCi</span><br><span class="line">7/5jhyT1hUUlP+CS1cw+3bkD+RzBlIh55mKrgBXGBmnea2IfZDtPsQTtiwdDDJkv</span><br><span class="line">acgRdQ2rxWet3l7uFSH0wUxjTkKG8ABUSNW1gp9lGTryhsbXZOZRJfKNtjMgKrkE</span><br><span class="line">......</span><br></pre></td></tr></table></figure>

<p><img src="../../../../images/SRE/day55/82.jpg" alt="82"><br><img src="../../../../images/SRE/day55/83.jpg" alt="83"></p>
<p><strong>旧版界面</strong></p>
<p>Jenkins-凭据-jenkins-全局凭据-添加凭据</p>
<p><img src="../../../../images/SRE/day55/84.jpg" alt="84"><br><img src="../../../../images/SRE/day55/85.jpg" alt="85"></p>
<p>复制root的私钥</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@jenkins-ubunutu1804 ~]<span class="comment"># cat .ssh/id_rsa</span></span><br><span class="line">MIIEpAIBAAKCAQEAvywAObXBa0i8nt0BPWvkR/C0mM8HsCeDAUgb1T+6SJijKoNt</span><br><span class="line">VqM1sOekSqokrI/XsDvMy+N8nwMDo3rayq9jr28cPWzmsY9K9QqG6V7A+R+6UuAq</span><br><span class="line">tJSycUphcAi66M9QvXnBoQVgZmgm5DmidEOiS0zvN9MO56ExWGauPzVkxrROMaVQ</span><br></pre></td></tr></table></figure>

<p><strong>添加私钥</strong></p>
<p><img src="../../../../images/SRE/day55/86.jpg" alt="86"></p>
<h3 id="Jenkins-任务中使用凭据"><a href="#Jenkins-任务中使用凭据" class="headerlink" title="Jenkins 任务中使用凭据"></a>Jenkins 任务中使用凭据</h3><h4 id="创建-Jenkins-任务"><a href="#创建-Jenkins-任务" class="headerlink" title="创建 Jenkins 任务"></a>创建 Jenkins 任务</h4><p><img src="../../../../images/SRE/day55/87.jpg" alt="87"></p>
<h4 id="使用凭据"><a href="#使用凭据" class="headerlink" title="使用凭据"></a>使用凭据</h4><h5 id="使用基于用户和密码的凭据"><a href="#使用基于用户和密码的凭据" class="headerlink" title="使用基于用户和密码的凭据"></a>使用基于用户和密码的凭据</h5><p>注意： URL 使用 http 协议</p>
<p><img src="../../../../images/SRE/day55/88.jpg" alt="88"></p>
<h5 id="使用基于-SSH-Key-的凭据"><a href="#使用基于-SSH-Key-的凭据" class="headerlink" title="使用基于 SSH Key 的凭据"></a>使用基于 SSH Key 的凭据</h5><p>注意： URL 使用 git 协议，选择上面创建的基于ssh key的凭证</p>
<p>默认会提示下面出错，是因为Jenkins以Jenkins用户身份运行，首次连接Gitlab服务器会弹出未知主机的警告，需要手动添加信任</p>
<p><img src="../../../../images/SRE/day55/89.jpg" alt="89"></p>
<p>解决方法：</p>
<p>方法1：在Jenkins服务器上，以切换至jenkins用户，用ssh连接gitlab服务，加入信任主机即可</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@jenkins ~]<span class="comment"># su - jenkins </span></span><br><span class="line">jenkins@ubuntu2204:~$ ssh gitlab.wang.org</span><br><span class="line">The authenticity of host <span class="string">&#x27;gitlab.wang.org (10.0.0.200)&#x27;</span> can<span class="string">&#x27;t be established.</span></span><br><span class="line"><span class="string">ED25519 key fingerprint is SHA256:dbmZIUN5Aux8Mc7wJwd++Mmu83UxBdYKjpAlDLx2nuk.</span></span><br><span class="line"><span class="string">This key is not known by any other names</span></span><br><span class="line"><span class="string">Are you sure you want to continue connecting (yes/no/[fingerprint])? yes</span></span><br><span class="line"><span class="string">Warning: Permanently added &#x27;</span>gitlab.wang.org<span class="string">&#x27; (ED25519) to the list of known hosts.</span></span><br><span class="line"><span class="string">jenkins@gitlab.wang.org&#x27;</span>s password: 无需再输入后面内容直接退出</span><br></pre></td></tr></table></figure>

<p>方法2：将Jenkins服务的启动用修改为root，因为root 之前连接过并信任gitlab服务器</p>
<p>在Jenkins刷新页面后，再次连接后此问题解决</p>
<p><img src="../../../../images/SRE/day55/90.jpg" alt="90"></p>
<h3 id="执行任务验证"><a href="#执行任务验证" class="headerlink" title="执行任务验证"></a>执行任务验证</h3><p><img src="../../../../images/SRE/day55/91.jpg" alt="91"></p>
<p>查看Jenkins工作目录下代码是否拉取成功</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@jenkins ~]<span class="comment"># ls /var/lib/jenkins/workspace/wheel-gitlab/</span></span><br><span class="line">images index.html js</span><br></pre></td></tr></table></figure>

<h2 id="配置-Jenkins-结合-GitLab-实现自动化前端项目的部署-和回滚"><a href="#配置-Jenkins-结合-GitLab-实现自动化前端项目的部署-和回滚" class="headerlink" title="配置 Jenkins 结合 GitLab 实现自动化前端项目的部署 和回滚"></a>配置 Jenkins 结合 GitLab 实现自动化前端项目的部署 和回滚</h2><p><strong>环境准备: 基于前面的 2.3.1 小节在GitLab 提前创建wheel 项目</strong></p>
<h3 id="Jenkins-创建任务"><a href="#Jenkins-创建任务" class="headerlink" title="Jenkins 创建任务"></a>Jenkins 创建任务</h3><p><img src="../../../../images/SRE/day55/92.jpg" alt="92"></p>
<h3 id="配置-Git-项目地址和凭证"><a href="#配置-Git-项目地址和凭证" class="headerlink" title="配置 Git 项目地址和凭证"></a>配置 Git 项目地址和凭证</h3><p>先确认安装gitlab插件</p>
<p><img src="../../../../images/SRE/day55/93.jpg" alt="93"></p>
<p>先在gitlab上确认git地址和分支名称</p>
<p><img src="../../../../images/SRE/day55/94.jpg" alt="94"></p>
<p>按上面的信息填定Git路径等信息</p>
<p><img src="../../../../images/SRE/day55/95.jpg" alt="95"></p>
<p>添加完成的证书没有报错表示认证通过</p>
<h3 id="准备脚本并加入构建任务"><a href="#准备脚本并加入构建任务" class="headerlink" title="准备脚本并加入构建任务"></a>准备脚本并加入构建任务</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">[root@jenkins ~]<span class="comment"># cat /data/jenkins-scripts/wheel-html-gitlab-deploy-rollback.sh</span></span><br><span class="line"><span class="comment">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line">HOST_LIST=<span class="string">&quot;10.0.0.102&quot;</span></span><br><span class="line">APP=wheel</span><br><span class="line">APP_PATH=/var/www/html</span><br><span class="line">DATA_PATH=/opt</span><br><span class="line">DATE=`<span class="built_in">date</span> +%F_%T`</span><br><span class="line"><span class="comment">#date +%F_%H-%M-%S</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">deploy</span></span> () &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="variable">$&#123;HOST_LIST&#125;</span>;<span class="keyword">do</span></span><br><span class="line">                ssh <span class="variable">$&#123;i&#125;</span> <span class="string">&quot;rm -rf <span class="variable">$&#123;APP_PATH&#125;</span> &amp;&amp; mkdir <span class="variable">$&#123;DATA_PATH&#125;</span>/<span class="variable">$&#123;APP&#125;</span>-<span class="variable">$&#123;DATE&#125;</span>&quot;</span></span><br><span class="line">                scp -r * <span class="variable">$&#123;i&#125;</span>:<span class="variable">$&#123;DATA_PATH&#125;</span>/<span class="variable">$&#123;APP&#125;</span>-<span class="variable">$&#123;DATE&#125;</span></span><br><span class="line">                ssh <span class="variable">$&#123;i&#125;</span> <span class="string">&quot;ln -sv <span class="variable">$&#123;DATA_PATH&#125;</span>/<span class="variable">$&#123;APP&#125;</span>-<span class="variable">$&#123;DATE&#125;</span> <span class="variable">$&#123;APP_PATH&#125;</span>&quot;</span></span><br><span class="line">        <span class="keyword">done</span>    </span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">rollback</span></span> () &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="variable">$&#123;HOST_LIST&#125;</span>;<span class="keyword">do</span></span><br><span class="line">                CURRENT_VERSION=$(ssh <span class="variable">$&#123;i&#125;</span> <span class="string">&quot;readlink <span class="variable">$&#123;APP_PATH&#125;</span>&quot;</span>)</span><br><span class="line">                CURRENT_VERSION=$(<span class="built_in">basename</span> <span class="variable">$&#123;CURRENT_VERSION&#125;</span>)</span><br><span class="line">                <span class="built_in">echo</span> <span class="variable">$&#123;CURRENT_VERSION&#125;</span></span><br><span class="line">                PRE_VERSION=$(ssh <span class="variable">$i</span> <span class="string">&quot;ls -1 <span class="variable">$&#123;DATA_PATH&#125;</span> | grep -B1 <span class="variable">$&#123;CURRENT_VERSION&#125;</span> | head -n1&quot;</span>)</span><br><span class="line">                <span class="built_in">echo</span> <span class="variable">$&#123;PRE_VERSION&#125;</span></span><br><span class="line">                ssh <span class="variable">$&#123;i&#125;</span> <span class="string">&quot;rm -rf <span class="variable">$&#123;APP_PATH&#125;</span> &amp;&amp; ln -sv <span class="variable">$&#123;DATA_PATH&#125;</span>/<span class="variable">$&#123;PRE_VERSION&#125;</span> <span class="variable">$&#123;APP_PATH&#125;</span>&quot;</span></span><br><span class="line">        <span class="keyword">done</span>    </span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">case</span> <span class="variable">$1</span> <span class="keyword">in</span></span><br><span class="line">deploy) </span><br><span class="line">        deploy</span><br><span class="line">        ;;</span><br><span class="line">rollback)</span><br><span class="line">        rollback</span><br><span class="line">        ;;</span><br><span class="line">*)</span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;Use <span class="variable">$0</span> deploy or rollback&quot;</span></span><br><span class="line">        <span class="built_in">exit</span></span><br><span class="line">        ;;</span><br><span class="line"><span class="keyword">esac</span></span><br></pre></td></tr></table></figure>

<p>在Jenkins中引用脚本</p>
<p><img src="../../../../images/SRE/day55/96.jpg" alt="96"></p>
<h3 id="实现部署任务"><a href="#实现部署任务" class="headerlink" title="实现部署任务"></a>实现部署任务</h3><p>立即构建</p>
<p><img src="../../../../images/SRE/day55/97.jpg" alt="97"><br><img src="../../../../images/SRE/day55/98.jpg" alt="98"></p>
<h4 id="服务器验证数据"><a href="#服务器验证数据" class="headerlink" title="服务器验证数据"></a>服务器验证数据</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@ubuntu2004 ~]<span class="comment"># ls /data/html</span></span><br><span class="line">images index.html js</span><br><span class="line"></span><br><span class="line">[root@ubuntu2004 ~]<span class="comment"># ll /opt/</span></span><br><span class="line">total 12</span><br><span class="line">drwxr-xr-x  3 root root 4096 Jul 26 11:33 ./</span><br><span class="line">drwxr-xr-x 21 root root 4096 Jul 21 14:34 ../</span><br><span class="line">drwxr-xr-x  4 root root 4096 Jul 26 11:33 wheel-2022-07-26_11-33-22/</span><br></pre></td></tr></table></figure>

<h4 id="将代码部署至后端-Web-服务器"><a href="#将代码部署至后端-Web-服务器" class="headerlink" title="将代码部署至后端 Web 服务器"></a>将代码部署至后端 Web 服务器</h4><p>先和后端 Web服务器实现基于key验证</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#并在后端服务器安装nginx服务</span></span><br><span class="line">[root@ubuntu2004 ~]<span class="comment"># apt -y install nginx</span></span><br><span class="line">[root@ubuntu2004 ~]<span class="comment"># vim /etc/nginx/sites-enabled/default</span></span><br><span class="line"> 		<span class="comment">#root /var/www/html; #注释此行</span></span><br><span class="line"> 		root /data/html;  <span class="comment">#加下面行</span></span><br><span class="line"> 		</span><br><span class="line">[root@ubuntu2004 ~]<span class="comment"># systemctl restart nginx</span></span><br></pre></td></tr></table></figure>

<h4 id="访问-Web-服务"><a href="#访问-Web-服务" class="headerlink" title="访问 Web 服务"></a>访问 Web 服务</h4><p><img src="../../../../images/SRE/day55/99.jpg" alt="99"></p>
<h4 id="修改代码再上传重新构建"><a href="#修改代码再上传重新构建" class="headerlink" title="修改代码再上传重新构建"></a>修改代码再上传重新构建</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">git <span class="built_in">clone</span> git@gitlab.wang.org:dev/wheel_of_fortune.git</span><br><span class="line"><span class="built_in">cd</span> wheel_of_fortune/</span><br><span class="line">vi index.html </span><br><span class="line">git add .;git commit -m <span class="string">&#x27;500w&#x27;</span>;git push</span><br></pre></td></tr></table></figure>

<p>重新执行任务，可以看到如下修改后的显示</p>
<p><img src="../../../../images/SRE/day55/100.jpg" alt="100"></p>
<h3 id="实现版本回滚任务"><a href="#实现版本回滚任务" class="headerlink" title="实现版本回滚任务"></a>实现版本回滚任务</h3><p>新建任务如下，实现回滚功能</p>
<p><img src="../../../../images/SRE/day55/101.jpg" alt="101"></p>
<p>只修改构建的shell部分，基它不变</p>
<p><img src="../../../../images/SRE/day55/102.jpg" alt="102"></p>
<p>执行任务后，可以查看到 Web页面是否还原为上一个版本</p>
<p><img src="../../../../images/SRE/day55/103.jpg" alt="103"></p>
<h2 id="参数化构建"><a href="#参数化构建" class="headerlink" title="参数化构建"></a>参数化构建</h2><p>jenkins支持参数化构建，类似于脚本中的参数，可以实现灵活的构建任务</p>
<p>Jenkins 支持多种参数类型，比如:Boolean，Choice选项，Multi_line字符串，字符串，文件类型等</p>
<h3 id="参数类型说明"><a href="#参数类型说明" class="headerlink" title="参数类型说明"></a>参数类型说明</h3><p>参数化构建的目标在于为流水线提供基于参数值的灵活构建机制，从而让一个流水线的定义可以适用于多种需求情形</p>
<ul>
<li>其功能与引用方式与环境变量类似</li>
<li>在触发作业运行之时，需要向各参数赋值</li>
</ul>
<p>常用的参数类型</p>
<ul>
<li>凭据参数</li>
<li>字符参数</li>
<li>密码参数</li>
<li>布尔值参数</li>
<li>文件参数</li>
<li>文本参数</li>
<li>运行时参数</li>
<li>选项参数 </li>
</ul>
<p>参数在使用时实际上也表现为变量，可以通过变量的调用方式使用参数</p>
<h4 id="创建包含各种类型参数的任务"><a href="#创建包含各种类型参数的任务" class="headerlink" title="创建包含各种类型参数的任务"></a>创建包含各种类型参数的任务</h4><p><img src="../../../../images/SRE/day55/104.jpg" alt="104"></p>
<p><strong>文本参数Multi-line String Parameter</strong></p>
<p><img src="../../../../images/SRE/day55/105.jpg" alt="105"></p>
<p><strong>字符参数 String Parameter</strong></p>
<p><img src="../../../../images/SRE/day55/106.jpg" alt="106"></p>
<p>构建任务执行 shell</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> var_boolean=<span class="variable">$var_boolean</span></span><br><span class="line"><span class="built_in">echo</span> var_choice=<span class="variable">$var_choice</span></span><br><span class="line"><span class="built_in">echo</span> var_string=<span class="variable">$var_string</span></span><br><span class="line"><span class="built_in">echo</span> var_multi_string=<span class="variable">$var_multi_string</span></span><br></pre></td></tr></table></figure>

<p><img src="../../../../images/SRE/day55/107.jpg" alt="107"></p>
<h4 id="构建"><a href="#构建" class="headerlink" title="构建"></a>构建</h4><p><img src="../../../../images/SRE/day55/108.jpg" alt="108"></p>
<h4 id="执行结果"><a href="#执行结果" class="headerlink" title="执行结果"></a>执行结果</h4><p><img src="../../../../images/SRE/day55/109.jpg" alt="109"></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@jenkins test-parameter]<span class="comment"># pwd</span></span><br><span class="line">/var/lib/jenkins/workspace/test-parameter</span><br><span class="line"></span><br><span class="line">[root@jenkins test-parameter]<span class="comment"># ls</span></span><br><span class="line">test.txt</span><br><span class="line"></span><br><span class="line">[root@jenkins test-parameter]<span class="comment"># cat test.txt </span></span><br><span class="line">upload</span><br></pre></td></tr></table></figure>

<h3 id="字符参数实现实现不同分支的部署"><a href="#字符参数实现实现不同分支的部署" class="headerlink" title="字符参数实现实现不同分支的部署"></a>字符参数实现实现不同分支的部署</h3><p><img src="../../../../images/SRE/day55/110.jpg" alt="110"><br><img src="../../../../images/SRE/day55/111.jpg" alt="111"><br><img src="../../../../images/SRE/day55/112.jpg" alt="112"><br><img src="../../../../images/SRE/day55/113.jpg" alt="113"></p>
<p>范例：脚本</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">[root@jenkins ~]<span class="comment"># cat /data/jenkins/scripts/hello_world_war_job1.sh</span></span><br><span class="line"><span class="comment">#!/bin/bash</span></span><br><span class="line">DATE=`<span class="built_in">date</span> +%F_%T`</span><br><span class="line">HOST_LIST=<span class="string">&quot;10.0.0.102&quot;</span></span><br><span class="line">DATA_APP_PATH=/data/tomcat/appdir</span><br><span class="line">DATA_WEB_PATH=/data/tomcat/webdir</span><br><span class="line">TOMCAT_PATH=/var/lib/tomcat9/webapps/hello</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">tar -C <span class="variable">$WORKSPACE</span>/src/main/webapp/ -cf hello.tar .</span><br><span class="line"><span class="keyword">for</span> host <span class="keyword">in</span> <span class="variable">$HOST_LIST</span>;<span class="keyword">do</span></span><br><span class="line">    scp hello.tar <span class="variable">$host</span>:<span class="variable">$&#123;DATA_APP_PATH&#125;</span>/hello-<span class="variable">$&#123;DATE&#125;</span>.tar</span><br><span class="line">    ssh <span class="variable">$host</span> <span class="string">&quot;systemctl stop tomcat9 &amp;&amp; \</span></span><br><span class="line"><span class="string">        mkdir <span class="variable">$&#123;DATA_WEB_PATH&#125;</span>/hello-<span class="variable">$&#123;DATE&#125;</span> &amp;&amp; \</span></span><br><span class="line"><span class="string">        tar xf <span class="variable">$&#123;DATA_APP_PATH&#125;</span>/hello-<span class="variable">$&#123;DATE&#125;</span>.tar -C <span class="variable">$&#123;DATA_WEB_PATH&#125;</span>/hello-<span class="variable">$&#123;DATE&#125;</span> &amp;&amp; \</span></span><br><span class="line"><span class="string">        rm -f <span class="variable">$&#123;TOMCAT_PATH&#125;</span> &amp;&amp; \</span></span><br><span class="line"><span class="string">        ln -s <span class="variable">$&#123;DATA_WEB_PATH&#125;</span>/hello-<span class="variable">$&#123;DATE&#125;</span> <span class="variable">$&#123;TOMCAT_PATH&#125;</span> &amp;&amp; \</span></span><br><span class="line"><span class="string">        systemctl start tomcat9&quot;</span></span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></table></figure>

<p><img src="../../../../images/SRE/day55/114.jpg" alt="114"></p>
<h3 id="选项参数实现实现不同分支的部署"><a href="#选项参数实现实现不同分支的部署" class="headerlink" title="选项参数实现实现不同分支的部署"></a>选项参数实现实现不同分支的部署</h3><p>创建新分支</p>
<p><img src="../../../../images/SRE/day55/115.jpg" alt="115"><br><img src="../../../../images/SRE/day55/116.jpg" alt="116"></p>
<p>确认分支创建成功</p>
<p><img src="../../../../images/SRE/day55/117.jpg" alt="117"></p>
<p>准备脚本</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">[root@jenkins-ubuntu ~]<span class="comment"># mkdir /data/git/scripts/ -pv</span></span><br><span class="line">[root@jenkins-ubuntu ~]<span class="comment"># cat /data/git/scripts/deploy.sh</span></span><br><span class="line"><span class="comment">#!/bin/bash</span></span><br><span class="line">BRANCH=<span class="variable">$1</span></span><br><span class="line"><span class="built_in">cd</span> /data/git &amp;&amp; <span class="built_in">rm</span> -rf testproject</span><br><span class="line">git <span class="built_in">clone</span> -b <span class="variable">$BRANCH</span> git@10.0.0.100:testgroup/testproject.git</span><br><span class="line"><span class="built_in">cd</span> testproject </span><br><span class="line"></span><br><span class="line"><span class="keyword">case</span>  <span class="variable">$BRANCH</span> <span class="keyword">in</span></span><br><span class="line">main)</span><br><span class="line">   scp -r * 10.0.0.102:/var/www/html/</span><br><span class="line">   ;;</span><br><span class="line">devel)</span><br><span class="line">   scp -r * 10.0.0.103:/var/www/html/</span><br><span class="line">   ;;</span><br><span class="line">*)</span><br><span class="line">    <span class="built_in">echo</span> <span class="variable">$BRANCH</span> is error </span><br><span class="line">   ;;</span><br><span class="line"><span class="keyword">esac</span></span><br><span class="line"></span><br><span class="line">[root@jenkins-ubuntu ~]<span class="comment"># chmod +x /data/git/scripts/deploy.sh</span></span><br></pre></td></tr></table></figure>

<p>修改原有构建</p>
<p><img src="../../../../images/SRE/day55/118.jpg" alt="118"><br><img src="../../../../images/SRE/day55/119.jpg" alt="119"><br><img src="../../../../images/SRE/day55/120.jpg" alt="120"></p>
<p><img src="../../../../images/SRE/day55/121.jpg" alt="121"></p>
<p>修改不同分支的代码</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">[root@ubuntu1804 testproject]<span class="comment"># pwd</span></span><br><span class="line">/data/testproject</span><br><span class="line"></span><br><span class="line">[root@ubuntu1804 testproject]<span class="comment"># git branch</span></span><br><span class="line"> devel</span><br><span class="line">* main</span><br><span class="line"></span><br><span class="line">[root@ubuntu1804 testproject]<span class="comment"># vim index.html </span></span><br><span class="line">&lt;h1&gt; index.html v1&lt;/h1&gt;</span><br><span class="line">&lt;h1&gt; index.html v2&lt;/h1&gt;</span><br><span class="line">&lt;h1&gt; index.html v3&lt;/h1&gt;</span><br><span class="line">&lt;h1&gt; index.html v4&lt;/h1&gt;</span><br><span class="line"></span><br><span class="line">[root@ubuntu1804 testproject]<span class="comment"># git add .</span></span><br><span class="line">[root@ubuntu1804 testproject]<span class="comment"># git commit -m v4</span></span><br><span class="line">[root@ubuntu1804 testproject]<span class="comment"># git push</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#切换至devel分支进行修改代码</span></span><br><span class="line">[root@ubuntu1804 testproject]<span class="comment"># git checkout devel</span></span><br><span class="line">Switched to branch <span class="string">&#x27;devel&#x27;</span></span><br><span class="line">Your branch is up to <span class="built_in">date</span> with <span class="string">&#x27;origin/devel&#x27;</span>.</span><br><span class="line"></span><br><span class="line">[root@ubuntu1804 testproject]<span class="comment"># git branch</span></span><br><span class="line">* devel</span><br><span class="line"> main</span><br><span class="line"> </span><br><span class="line">[root@ubuntu1804 testproject]<span class="comment"># vim index.html </span></span><br><span class="line">&lt;h1&gt; index.html v1&lt;/h1&gt;</span><br><span class="line">&lt;h1&gt; index.html v2&lt;/h1&gt;</span><br><span class="line">&lt;h1&gt; index.html v3&lt;/h1&gt;</span><br><span class="line">&lt;h1&gt; index.html v4-devel &lt;h1&gt;</span><br><span class="line"></span><br><span class="line">[root@ubuntu1804 testproject]<span class="comment"># git add .</span></span><br><span class="line">[root@ubuntu1804 testproject]<span class="comment"># git commit -m v4-devel</span></span><br><span class="line">[root@ubuntu1804 testproject]<span class="comment"># git push</span></span><br></pre></td></tr></table></figure>

<p>执行修改过的构建</p>
<p><img src="../../../../images/SRE/day55/122.jpg" alt="122"><br><img src="../../../../images/SRE/day55/123.jpg" alt="123"><br><img src="../../../../images/SRE/day55/124.jpg" alt="124"></p>
<p>执行devel分支的构建</p>
<p><img src="../../../../images/SRE/day55/125.jpg" alt="125"><br><img src="../../../../images/SRE/day55/126.jpg" alt="126"><br><img src="../../../../images/SRE/day55/127.jpg" alt="127"></p>
<h3 id="选项参数实现不同分支的部署和回滚"><a href="#选项参数实现不同分支的部署和回滚" class="headerlink" title="选项参数实现不同分支的部署和回滚"></a>选项参数实现不同分支的部署和回滚</h3><p><img src="../../../../images/SRE/day55/128.jpg" alt="128"></p>
<p>范例： 脚本</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line">PROJECT=<span class="string">&quot;testproject&quot;</span></span><br><span class="line"><span class="comment">#PROJECT=$JOB_NAME</span></span><br><span class="line"></span><br><span class="line">PROJECT_DIR=<span class="string">&quot;/data&quot;</span></span><br><span class="line"><span class="comment">#保存web压缩包</span></span><br><span class="line">APPDIR=<span class="string">&quot;/data/tomcat/appdir&quot;</span></span><br><span class="line"><span class="comment">#保存解压后的web目录</span></span><br><span class="line">WEBDIR=<span class="string">&quot;/data/tomcat/webdir&quot;</span></span><br><span class="line"><span class="comment">#tomcat工作目录，存放上面目录中子目录的软链接</span></span><br><span class="line">WEBAPPS=<span class="string">&quot;/data/tomcat/webapps&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#tomcat服务器列表</span></span><br><span class="line">HOSTS=<span class="string">&quot;10.0.0.8&quot;</span></span><br><span class="line">DATE=`<span class="built_in">date</span> +%F_%H-%M-%S`</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">pull_code</span></span>()&#123;</span><br><span class="line">    <span class="built_in">rm</span> -rf <span class="variable">$WORKSPACE</span></span><br><span class="line">    <span class="comment">#rm -rf /var/lib/jenkins/workspace/$JOB_NAME</span></span><br><span class="line">    <span class="built_in">cd</span> <span class="variable">$&#123;JENKINS_HOME&#125;</span>/workspace</span><br><span class="line">    <span class="comment">#cd /var/lib/jenkins/workspace/ </span></span><br><span class="line">    git <span class="built_in">clone</span> -b <span class="variable">$BRANCH</span> git@gitlab.wang.org:testgroup/<span class="variable">$PROJECT</span>.git   </span><br><span class="line">    <span class="built_in">cd</span> <span class="variable">$&#123;$WORKSPACE&#125;</span> &amp;&amp; \</span><br><span class="line">    tar zcf <span class="variable">$&#123;PROJECT_DIR&#125;</span>/<span class="variable">$&#123;PROJECT&#125;</span>-<span class="variable">$&#123;DATE&#125;</span>.tar.gz ./*</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">push_code_webservers</span></span> () &#123;</span><br><span class="line">    <span class="keyword">for</span> host <span class="keyword">in</span> <span class="variable">$HOSTS</span>;<span class="keyword">do</span></span><br><span class="line">       scp <span class="variable">$&#123;PROJECT_DIR&#125;</span>/<span class="variable">$&#123;PROJECT&#125;</span>-<span class="variable">$&#123;DATE&#125;</span>.tar.gz <span class="variable">$host</span>:<span class="variable">$&#123;APPDIR&#125;</span></span><br><span class="line">        ssh <span class="variable">$host</span> <span class="string">&quot;mkdir <span class="variable">$WEBDIR</span>/<span class="variable">$&#123;PROJECT&#125;</span>-<span class="variable">$&#123;DATE&#125;</span> &amp;&amp; \</span></span><br><span class="line"><span class="string">                 tar xf <span class="variable">$&#123;APPDIR&#125;</span>/<span class="variable">$&#123;PROJECT&#125;</span>-<span class="variable">$&#123;DATE&#125;</span>.tar.gz -C <span class="variable">$WEBDIR</span>/<span class="variable">$&#123;PROJECT&#125;</span>-<span class="variable">$&#123;DATE&#125;</span> &amp;&amp; \</span></span><br><span class="line"><span class="string">                 systemctl stop tomcat &amp;&amp; \</span></span><br><span class="line"><span class="string">                 rm -f <span class="variable">$&#123;WEBAPPS&#125;</span>/ROOT &amp;&amp; \</span></span><br><span class="line"><span class="string">                 ln -s <span class="variable">$&#123;WEBDIR&#125;</span>/<span class="variable">$&#123;PROJECT&#125;</span>-<span class="variable">$&#123;DATE&#125;</span> <span class="variable">$&#123;WEBAPPS&#125;</span>/ROOT &amp;&amp; \</span></span><br><span class="line"><span class="string">                 chown -R tomcat.tomcat <span class="variable">$WEBAPPS</span> &amp;&amp; \</span></span><br><span class="line"><span class="string">                 systemctl start tomcat&quot;</span></span><br><span class="line">    <span class="keyword">done</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">deploy</span></span> ()&#123;</span><br><span class="line">   pull_code </span><br><span class="line">   push_code_webservers</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">rollback</span></span> ()&#123;</span><br><span class="line">    <span class="built_in">local</span> current_version previous_version</span><br><span class="line">    <span class="keyword">for</span> host <span class="keyword">in</span> <span class="variable">$HOSTS</span>;<span class="keyword">do</span></span><br><span class="line">        current_version=$(ssh <span class="variable">$host</span> <span class="string">&quot;readlink /data/tomcat/webapps/ROOT&quot;</span>)</span><br><span class="line">        current_version=`<span class="built_in">basename</span> <span class="variable">$current_version</span>`</span><br><span class="line">        previous_version=`ssh <span class="variable">$host</span> <span class="string">&quot;ls /data/tomcat/webdir/ | grep -B1 <span class="variable">$current_version</span> |head -n1&quot;</span>`</span><br><span class="line">        <span class="built_in">echo</span> <span class="variable">$current_version</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="variable">$before_version</span></span><br><span class="line">        ssh <span class="variable">$host</span> <span class="string">&quot;systemctl stop tomcat &amp;&amp; \</span></span><br><span class="line"><span class="string">                   rm -f <span class="variable">$&#123;WEBAPPS&#125;</span>/ROOT &amp;&amp; \</span></span><br><span class="line"><span class="string">                   ln -s <span class="variable">$&#123;WEBDIR&#125;</span>/<span class="variable">$previous_version</span> <span class="variable">$&#123;WEBAPPS&#125;</span>/ROOT &amp;&amp; \</span></span><br><span class="line"><span class="string">                   systemctl start tomcat&quot;</span></span><br><span class="line">   <span class="keyword">done</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">case</span> <span class="variable">$OPS</span> <span class="keyword">in</span></span><br><span class="line">deploy)</span><br><span class="line">   deploy </span><br><span class="line">   ;;</span><br><span class="line">rollback)</span><br><span class="line">   rollback</span><br><span class="line">   ;;</span><br><span class="line">*)</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;Usage: `basename <span class="variable">$0</span>` deploy|rollback&quot;</span></span><br><span class="line"><span class="keyword">esac</span></span><br></pre></td></tr></table></figure>

<h2 id="利用-Git-Parameter-插件实现拉取指定版本"><a href="#利用-Git-Parameter-插件实现拉取指定版本" class="headerlink" title="利用 Git Parameter 插件实现拉取指定版本"></a>利用 Git Parameter 插件实现拉取指定版本</h2><h3 id="利用-Git-Parameter-插件实现拉取指定-Tag"><a href="#利用-Git-Parameter-插件实现拉取指定-Tag" class="headerlink" title="利用 Git Parameter 插件实现拉取指定 Tag"></a>利用 Git Parameter 插件实现拉取指定 Tag</h3><p>创建多个tag，并同步到仓库</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#git tag v1.0</span></span><br><span class="line"><span class="comment">#git push origin --tags</span></span><br></pre></td></tr></table></figure>

<h4 id="安装Git-Parameter-插件"><a href="#安装Git-Parameter-插件" class="headerlink" title="安装Git Parameter 插件"></a>安装Git Parameter 插件</h4><p><img src="../../../../images/SRE/day55/129.jpg" alt="129"></p>
<h4 id="创建任务"><a href="#创建任务" class="headerlink" title="创建任务"></a>创建任务</h4><p><img src="../../../../images/SRE/day55/130.jpg" alt="130"><br><img src="../../../../images/SRE/day55/131.jpg" alt="131"><br><img src="../../../../images/SRE/day55/132.jpg" alt="132"><br><img src="../../../../images/SRE/day55/133.jpg" alt="133"></p>
<h4 id="准备Shell-脚本"><a href="#准备Shell-脚本" class="headerlink" title="准备Shell 脚本"></a>准备Shell 脚本</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line">DATE=`<span class="built_in">date</span> +%F_%T`</span><br><span class="line">HOST_LIST=<span class="string">&quot;10.0.0.102&quot;</span></span><br><span class="line">DATA_APP_PATH=/data/tomcat/appdir</span><br><span class="line">DATA_WEB_PATH=/data/tomcat/webdir</span><br><span class="line">TOMCAT_PATH=/var/lib/tomcat9/webapps/hello</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">tar -C <span class="variable">$WORKSPACE</span>/src/main/webapp/ -cf hello.tar .</span><br><span class="line"><span class="keyword">for</span> host <span class="keyword">in</span> <span class="variable">$HOST_LIST</span>;<span class="keyword">do</span></span><br><span class="line">    scp hello.tar <span class="variable">$host</span>:<span class="variable">$&#123;DATA_APP_PATH&#125;</span>/hello-<span class="variable">$&#123;DATE&#125;</span>.tar</span><br><span class="line">    ssh <span class="variable">$host</span> <span class="string">&quot;systemctl stop tomcat9 &amp;&amp; \</span></span><br><span class="line"><span class="string">        mkdir <span class="variable">$&#123;DATA_WEB_PATH&#125;</span>/hello-<span class="variable">$&#123;DATE&#125;</span> &amp;&amp; \</span></span><br><span class="line"><span class="string">        tar xf <span class="variable">$&#123;DATA_APP_PATH&#125;</span>/hello-<span class="variable">$&#123;DATE&#125;</span>.tar -C <span class="variable">$&#123;DATA_WEB_PATH&#125;</span>/hello-<span class="variable">$&#123;DATE&#125;</span> &amp;&amp; \</span></span><br><span class="line"><span class="string">        rm -f <span class="variable">$&#123;TOMCAT_PATH&#125;</span> &amp;&amp; \</span></span><br><span class="line"><span class="string">        ln -s <span class="variable">$&#123;DATA_WEB_PATH&#125;</span>/hello-<span class="variable">$&#123;DATE&#125;</span> <span class="variable">$&#123;TOMCAT_PATH&#125;</span> &amp;&amp; \</span></span><br><span class="line"><span class="string">        systemctl start tomcat9&quot;</span></span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></table></figure>

<h4 id="执行构建并验证结果"><a href="#执行构建并验证结果" class="headerlink" title="执行构建并验证结果"></a>执行构建并验证结果</h4><p><img src="../../../../images/SRE/day55/134.jpg" alt="134"></p>
<h3 id="利用-Git-Parameter-插件实现拉取指定-Commit-ID"><a href="#利用-Git-Parameter-插件实现拉取指定-Commit-ID" class="headerlink" title="利用 Git Parameter 插件实现拉取指定 Commit_ID"></a>利用 Git Parameter 插件实现拉取指定 Commit_ID</h3><p>基于 git 提交的指定的 commit id 拉取代码</p>
<h4 id="安装Git-Parameter-插件-1"><a href="#安装Git-Parameter-插件-1" class="headerlink" title="安装Git Parameter 插件"></a>安装Git Parameter 插件</h4><p><img src="../../../../images/SRE/day55/135.jpg" alt="135"></p>
<h4 id="创建任务-1"><a href="#创建任务-1" class="headerlink" title="创建任务"></a>创建任务</h4><p><img src="../../../../images/SRE/day55/136.jpg" alt="136"><br><img src="../../../../images/SRE/day55/137.jpg" alt="137"></p>
<h4 id="执行构建"><a href="#执行构建" class="headerlink" title="执行构建"></a>执行构建</h4><p><img src="../../../../images/SRE/day55/138.jpg" alt="138"></p>
<h4 id="验证结果"><a href="#验证结果" class="headerlink" title="验证结果"></a>验证结果</h4><p><img src="../../../../images/SRE/day55/139.jpg" alt="139"><br><img src="../../../../images/SRE/day55/140.jpg" alt="140"></p>
<h2 id="实现-Java-应用源码编译并部署"><a href="#实现-Java-应用源码编译并部署" class="headerlink" title="实现 Java 应用源码编译并部署"></a>实现 Java 应用源码编译并部署</h2><p>java 程序需要使用构建工具，如: maven，ant，gradle等进行构建打包才能部署，其中maven比较流行</p>
<p>以下以 maven 为例实现 Java 应用部署</p>
<p>部署环境如下</p>
<p><img src="../../../../images/SRE/day55/141.jpg" alt="141"></p>
<h3 id="构建基于-Spring-Boot-的-JAR-包-JAVA-项目"><a href="#构建基于-Spring-Boot-的-JAR-包-JAVA-项目" class="headerlink" title="构建基于 Spring Boot 的 JAR 包 JAVA 项目"></a>构建基于 Spring Boot 的 JAR 包 JAVA 项目</h3><h4 id="Gitlab-导入项目"><a href="#Gitlab-导入项目" class="headerlink" title="Gitlab 导入项目"></a>Gitlab 导入项目</h4><p>项目链接</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://gitee.com/lbtooth/spring-boot-helloworld.git</span><br></pre></td></tr></table></figure>

<p><img src="../../../../images/SRE/day55/142.jpg" alt="142"></p>
<h4 id="Jenkins-服务器上安装-maven-和配置镜像加速"><a href="#Jenkins-服务器上安装-maven-和配置镜像加速" class="headerlink" title="Jenkins 服务器上安装 maven 和配置镜像加速"></a>Jenkins 服务器上安装 maven 和配置镜像加速</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">[root@jenkins ~]<span class="comment"># apt install maven -y</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#镜像加速</span></span><br><span class="line">[root@jenkins ~]<span class="comment"># vim /etc/maven/settings.xml</span></span><br><span class="line"> &lt;mirror&gt;</span><br><span class="line">   &lt;<span class="built_in">id</span>&gt;nexus-aliyun&lt;/id&gt;</span><br><span class="line">   &lt;mirrorOf&gt;*&lt;/mirrorOf&gt;</span><br><span class="line">   &lt;name&gt;Nexus aliyun&lt;/name&gt;</span><br><span class="line">   &lt;url&gt;http://maven.aliyun.com/nexus/content/groups/public&lt;/url&gt;</span><br><span class="line"> &lt;/mirror&gt;</span><br><span class="line">&lt;/mirrors&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment">#查看相关变量值</span></span><br><span class="line">[root@jenkins ~]<span class="comment"># mvn --version</span></span><br><span class="line">Apache Maven 3.6.0</span><br><span class="line">Maven home: /usr/share/maven</span><br><span class="line">Java version: 1.8.0_292, vendor: Private Build, runtime: /usr/lib/jvm/java-8-openjdk-amd64/jre</span><br><span class="line">Default locale: en_HK, platform encoding: UTF-8</span><br><span class="line">OS name: <span class="string">&quot;linux&quot;</span>, version: <span class="string">&quot;4.15.0-112-generic&quot;</span>, <span class="built_in">arch</span>: <span class="string">&quot;amd64&quot;</span>, family: <span class="string">&quot;unix&quot;</span></span><br></pre></td></tr></table></figure>

<h4 id="Jenkins-全局工具配置-JDK-和-Maven"><a href="#Jenkins-全局工具配置-JDK-和-Maven" class="headerlink" title="Jenkins 全局工具配置 JDK 和 Maven"></a>Jenkins 全局工具配置 JDK 和 Maven</h4><p>参考上一步的信息，填写全局工具配置</p>
<p>注意：如果使用Jenkins自动安装指定的版本的相关工具，会将工具安装到$JENKINS_HOME/tools目录下</p>
<p><img src="../../../../images/SRE/day55/143.jpg" alt="143"></p>
<p><img src="../../../../images/SRE/day55/144.jpg" alt="144"></p>
<h4 id="准备相关脚本"><a href="#准备相关脚本" class="headerlink" title="准备相关脚本"></a>准备相关脚本</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">root@ubuntu2004:/data/jenkins/scripts<span class="comment"># cat spring-boot-hello-world.sh </span></span><br><span class="line"><span class="comment">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line">APP_PATH=/data/spring-boot-helloworld</span><br><span class="line"></span><br><span class="line">HOST_LIST=<span class="string">&quot;</span></span><br><span class="line"><span class="string">10.0.0.102</span></span><br><span class="line"><span class="string">10.0.0.103</span></span><br><span class="line"><span class="string">&quot;</span></span><br><span class="line"></span><br><span class="line">mvn clean package -Dmaven.test.skip=<span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> host <span class="keyword">in</span> <span class="variable">$HOST_LIST</span>;<span class="keyword">do</span></span><br><span class="line">	ssh <span class="variable">$host</span> killall -9 java &amp;&gt; /dev/null</span><br><span class="line">	scp target/spring-boot-helloworld-*-SNAPSHOT.jar <span class="variable">$host</span>:<span class="variable">$&#123;APP_PATH&#125;</span>/spring-boot-helloworld.jar</span><br><span class="line">	ssh <span class="variable">$host</span> <span class="string">&quot;nohup java -jar <span class="variable">$&#123;APP_PATH&#125;</span>/spring-boot-helloworld.jar &amp;&gt; /dev/null &amp; &quot;</span> &amp;</span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></table></figure>

<h4 id="在-Jenkins-创建-Jenkins任务"><a href="#在-Jenkins-创建-Jenkins任务" class="headerlink" title="在 Jenkins 创建 Jenkins任务"></a>在 Jenkins 创建 Jenkins任务</h4><p><img src="../../../../images/SRE/day55/145.jpg" alt="145"></p>
<p><img src="../../../../images/SRE/day55/146.jpg" alt="146"></p>
<h4 id="构建并检查结果"><a href="#构建并检查结果" class="headerlink" title="构建并检查结果"></a>构建并检查结果</h4><p><img src="../../../../images/SRE/day55/147.jpg" alt="147"></p>
<p><img src="../../../../images/SRE/day55/148.jpg" alt="148"></p>
<p><img src="../../../../images/SRE/day55/149.jpg" alt="149"></p>
<h3 id="构建基于WAR包运行-Tomcat服务器-JAVA-项目"><a href="#构建基于WAR包运行-Tomcat服务器-JAVA-项目" class="headerlink" title="构建基于WAR包运行 Tomcat服务器 JAVA 项目"></a>构建基于WAR包运行 Tomcat服务器 JAVA 项目</h3><h4 id="Gitlab仓库中准备-Java-代码"><a href="#Gitlab仓库中准备-Java-代码" class="headerlink" title="Gitlab仓库中准备 Java 代码"></a>Gitlab仓库中准备 Java 代码</h4><p><strong>在gitlab新建 java 项目</strong></p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://gitee.com/lbtooth/hello-world-war.git</span><br></pre></td></tr></table></figure>

<p>导入项目</p>
<p><img src="../../../../images/SRE/day55/150.jpg" alt="150"><br><img src="../../../../images/SRE/day55/151.jpg" alt="151"></p>
<p>或者新建项目</p>
<p><img src="../../../../images/SRE/day55/152.jpg" alt="152"></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">[root@gitlab data]<span class="comment"># git clone -b main https://gitee.com/lbtooth/hello-world-war.git</span></span><br><span class="line">[root@gitlab data]<span class="comment"># cd hello-world-war/</span></span><br><span class="line">[root@gitlab hello-world-war]<span class="comment"># git config --global user.name &quot;wangxiaochun&quot;</span></span><br><span class="line">[root@gitlab hello-world-war]<span class="comment"># git config --global user.email &quot;29308620@qq.com&quot;</span></span><br><span class="line">[root@gitlab hello-world-war]<span class="comment"># git branch</span></span><br><span class="line">* main</span><br><span class="line"></span><br><span class="line">[root@gitlab hello-world-war]<span class="comment"># git remote -v</span></span><br><span class="line">origin https://gitee.com/lbtooth/hello-world-war.git (fetch)</span><br><span class="line">origin https://gitee.com/lbtooth/hello-world-war.git (push)</span><br><span class="line"></span><br><span class="line">[root@gitlab hello-world-war]<span class="comment"># git remote remove origin</span></span><br><span class="line">[root@gitlab hello-world-war]<span class="comment"># git remote add origin git@gitlab.wang.org:testgroup/hello-world-war.git</span></span><br><span class="line">[root@gitlab hello-world-war]<span class="comment"># git remote -v</span></span><br><span class="line">origin git@gitlab.wang.org:testgroup/hello-world-war.git (fetch)</span><br><span class="line">origin git@gitlab.wang.org:testgroup/hello-world-war.git (push)</span><br><span class="line"></span><br><span class="line">[root@gitlab hello-world-war]<span class="comment"># git push</span></span><br><span class="line">[root@gitlab hello-world-war]<span class="comment"># git push --set-upstream origin main</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#或者推送所有分支和标签</span></span><br><span class="line">[root@gitlab hello-world-war]<span class="comment"># git push -u origin --all</span></span><br><span class="line">[root@gitlab hello-world-war]<span class="comment"># git push -u origin --tags</span></span><br></pre></td></tr></table></figure>

<h3 id="安装-tomcat-服务器和配置"><a href="#安装-tomcat-服务器和配置" class="headerlink" title="安装 tomcat 服务器和配置"></a>安装 tomcat 服务器和配置</h3><p>部署java应用至tomcat服务器，并需要提前创建用户和授权</p>
<p><strong>web服务为tomcat服务器，目录结构规划如下</strong></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">/data/tomcat/appdir  <span class="comment">#保存web压缩包</span></span><br><span class="line">/data/tomcat/webdir  <span class="comment">#保存解压后的web目录</span></span><br><span class="line">/data/tomcat/webapps <span class="comment">#tomcat工作目录，存放上面目录中子目录的软链接</span></span><br></pre></td></tr></table></figure>

<p>范例：二进制安装tomcat并配置</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#安装tomcat</span></span><br><span class="line">参考tomcat章节，略</span><br><span class="line"></span><br><span class="line"><span class="comment">#配置远程连接权限</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># vim /usr/local/tomcat/webapps/manager/META-INF/context.xml</span></span><br><span class="line"><span class="comment">#注释下面行</span></span><br><span class="line">&lt;!--</span><br><span class="line"> &lt;Valve className=<span class="string">&quot;org.apache.catalina.valves.RemoteAddrValve&quot;</span></span><br><span class="line">         allow=<span class="string">&quot;127\.\d+\.\d+\.\d+|::1|0:0:0:0:0:0:0:1&quot;</span> /&gt;</span><br><span class="line">--&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment">#创建用户和授权</span></span><br><span class="line">[root@centos8 ~]<span class="comment">#vim /usr/local/tomcat/conf/tomcat-users.xml</span></span><br><span class="line">&lt;role rolename=<span class="string">&quot;manager-gui&quot;</span>/&gt;</span><br><span class="line">&lt;role rolename=<span class="string">&quot;manager-script&quot;</span>/&gt;</span><br><span class="line">&lt;user username=<span class="string">&quot;tomcat&quot;</span> password=<span class="string">&quot;tomcat&quot;</span> roles=<span class="string">&quot;manager-gui,manager-script&quot;</span>/&gt;</span><br><span class="line"><span class="comment">#加上面三行</span></span><br><span class="line">&lt;/tomcat-users&gt;</span><br><span class="line"></span><br><span class="line">[root@centos8 ~]<span class="comment"># systemctl restart tomcat</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#添加名称解析</span></span><br><span class="line">[root@jenkins ~]<span class="comment"># vim /etc/hosts</span></span><br><span class="line">10.0.0.8 web01.wang.org</span><br><span class="line">10.0.0.18 web02.wang.org</span><br></pre></td></tr></table></figure>

<p>范例: Ubuntu2004 apt 安装tomat9和配置</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">[root@ubuntu2004 ~]<span class="comment"># apt -y install tomcat9 tomcat9-admin</span></span><br><span class="line">[root@ubuntu2004 ~]<span class="comment"># java -version</span></span><br><span class="line">openjdk version <span class="string">&quot;11.0.15&quot;</span> 2022-04-19</span><br><span class="line">OpenJDK Runtime Environment (build 11.0.15+10-Ubuntu-0ubuntu0.20.04.1)</span><br><span class="line">OpenJDK 64-Bit Server VM (build 11.0.15+10-Ubuntu-0ubuntu0.20.04.1, mixed mode, sharing)</span><br><span class="line"></span><br><span class="line">[root@ubuntu2004 ~]<span class="comment"># cp -a /usr/share/tomcat9-admin/* /var/lib/tomcat9/webapps/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#配置远程连接权限</span></span><br><span class="line">[root@ubuntu2004 ~]<span class="comment"># vim /var/lib/tomcat9/webapps/manager/META-INF/context.xml</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#vim /usr/share/tomcat9-admin/host-manager/META-INF/context.xml</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#注释下面行</span></span><br><span class="line">&lt;!--</span><br><span class="line"> &lt;Valve className=<span class="string">&quot;org.apache.catalina.valves.RemoteAddrValve&quot;</span></span><br><span class="line">         allow=<span class="string">&quot;127\.\d+\.\d+\.\d+|::1|0:0:0:0:0:0:0:1&quot;</span> /&gt;</span><br><span class="line">--&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment">#创建用户和授权</span></span><br><span class="line">[root@ubuntu2004 ~]<span class="comment"># vim /var/lib/tomcat9/conf/tomcat-users.xml</span></span><br><span class="line"><span class="comment">#vim /etc/tomcat9/tomcat-users.xml</span></span><br><span class="line">&lt;role rolename=<span class="string">&quot;manager-gui&quot;</span>/&gt;</span><br><span class="line">&lt;role rolename=<span class="string">&quot;manager-script&quot;</span>/&gt;</span><br><span class="line">&lt;user username=<span class="string">&quot;tomcat&quot;</span> password=<span class="string">&quot;tomcat&quot;</span> roles=<span class="string">&quot;manager-gui,manager-script&quot;</span>/&gt;</span><br><span class="line"><span class="comment">#加上面三行</span></span><br><span class="line">&lt;/tomcat-users&gt;</span><br><span class="line"></span><br><span class="line">[root@ubuntu2004 ~]<span class="comment"># systemctl restart tomcat9</span></span><br></pre></td></tr></table></figure>

<h4 id="Jenkins-安装-Maven-和-Tomcat-插件"><a href="#Jenkins-安装-Maven-和-Tomcat-插件" class="headerlink" title="Jenkins 安装 Maven 和 Tomcat 插件"></a>Jenkins 安装 Maven 和 Tomcat 插件</h4><p>Maven 插件实现Maven风格的任务</p>
<p><img src="../../../../images/SRE/day55/153.jpg" alt="153"></p>
<p>Deploy to container 插件实现连接 tomcat</p>
<p><img src="../../../../images/SRE/day55/154.jpg" alt="154"></p>
<h4 id="Jenkins-服务器上安装-maven-和配置镜像加速-1"><a href="#Jenkins-服务器上安装-maven-和配置镜像加速-1" class="headerlink" title="Jenkins 服务器上安装 maven 和配置镜像加速"></a>Jenkins 服务器上安装 maven 和配置镜像加速</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">[root@jenkins ~]<span class="comment"># apt install maven -y</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#镜像加速</span></span><br><span class="line">[root@jenkins ~]<span class="comment"># vim /etc/maven/settings.xml</span></span><br><span class="line"> &lt;mirror&gt;</span><br><span class="line">   &lt;<span class="built_in">id</span>&gt;nexus-aliyun&lt;/id&gt;</span><br><span class="line">   &lt;mirrorOf&gt;*&lt;/mirrorOf&gt;</span><br><span class="line">   &lt;name&gt;Nexus aliyun&lt;/name&gt;</span><br><span class="line">   &lt;url&gt;http://maven.aliyun.com/nexus/content/groups/public&lt;/url&gt;</span><br><span class="line"> &lt;/mirror&gt;</span><br><span class="line">&lt;/mirrors&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment">#查看相关变量值</span></span><br><span class="line">[root@jenkins ~]<span class="comment"># mvn --version</span></span><br><span class="line">Apache Maven 3.6.0</span><br><span class="line">Maven home: /usr/share/maven</span><br><span class="line">Java version: 1.8.0_292, vendor: Private Build, runtime: /usr/lib/jvm/java-8-openjdk-amd64/jre</span><br><span class="line">Default locale: en_HK, platform encoding: UTF-8</span><br><span class="line">OS name: <span class="string">&quot;linux&quot;</span>, version: <span class="string">&quot;4.15.0-112-generic&quot;</span>, <span class="built_in">arch</span>: <span class="string">&quot;amd64&quot;</span>, family: <span class="string">&quot;unix&quot;</span></span><br></pre></td></tr></table></figure>

<h4 id="Jenkins-全局工具配置-JDK-和-Maven-1"><a href="#Jenkins-全局工具配置-JDK-和-Maven-1" class="headerlink" title="Jenkins 全局工具配置 JDK 和 Maven"></a>Jenkins 全局工具配置 JDK 和 Maven</h4><p>参考上一步的信息，填写全局工具配置</p>
<p>注意：如果使用Jenkins自动安装指定的版本的相关工具，会将工具安装到$JENKINS_HOME/tools目录下</p>
<p><img src="../../../../images/SRE/day55/155.jpg" alt="155"><br><img src="../../../../images/SRE/day55/156.jpg" alt="156"></p>
<h4 id="创建-Tomcat-的全局凭据"><a href="#创建-Tomcat-的全局凭据" class="headerlink" title="创建 Tomcat 的全局凭据"></a>创建 Tomcat 的全局凭据</h4><p>根据tomcat的用户权限配置，创建jenkins连接tomcat的用户和权限</p>
<p><img src="../../../../images/SRE/day55/157.jpg" alt="157"><br><img src="../../../../images/SRE/day55/158.jpg" alt="158"></p>
<h4 id="创建-Maven-风格的任务"><a href="#创建-Maven-风格的任务" class="headerlink" title="创建 Maven 风格的任务"></a>创建 Maven 风格的任务</h4><p><img src="../../../../images/SRE/day55/159.jpg" alt="159"><br><img src="../../../../images/SRE/day55/160.jpg" alt="160"><br><img src="../../../../images/SRE/day55/161.jpg" alt="161"></p>
<p><strong>输入maven的编译选项</strong></p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">clean package -Dmaven.test.skip=true</span><br></pre></td></tr></table></figure>

<p><img src="../../../../images/SRE/day55/162.jpg" alt="162"></p>
<p>Context path 如果不指定，则由war的文件名决定访问目录，可以指定为ROOT，则表示访问路径为网站的根</p>
<p><img src="../../../../images/SRE/day55/163.jpg" alt="163"></p>
<h4 id="构建验证"><a href="#构建验证" class="headerlink" title="构建验证"></a>构建验证</h4><p><img src="../../../../images/SRE/day55/164.jpg" alt="164"><br><img src="../../../../images/SRE/day55/165.jpg" alt="165"><br><img src="../../../../images/SRE/day55/166.jpg" alt="166"></p>
<h2 id="实现-Golang-应用源码编译并部署"><a href="#实现-Golang-应用源码编译并部署" class="headerlink" title="实现 Golang 应用源码编译并部署"></a>实现 Golang 应用源码编译并部署</h2><h3 id="安装-Golang-环境"><a href="#安装-Golang-环境" class="headerlink" title="安装 Golang 环境"></a>安装 Golang 环境</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#基于仓库安装</span></span><br><span class="line">[root@ubuntu2004 ~]<span class="comment"># apt -y install golang</span></span><br><span class="line">[root@ubuntu2004 ~]<span class="comment"># go version</span></span><br><span class="line">go version go1.13.8 linux/amd64</span><br><span class="line"></span><br><span class="line"><span class="comment">#或者从官网下载指定版本</span></span><br></pre></td></tr></table></figure>

<h3 id="准备-Golang-源代码"><a href="#准备-Golang-源代码" class="headerlink" title="准备 Golang 源代码"></a>准备 Golang 源代码</h3><p>下载: <a target="_blank" rel="noopener" href="https://gitee.com/lbtooth/http_demo_go.git">https://gitee.com/lbtooth/http_demo_go.git</a></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[root@ubuntu2004 ~]<span class="comment"># mkdir /data/ ; cd /data</span></span><br><span class="line">[root@ubuntu2004 data]<span class="comment"># git clone https://gitee.com/lbtooth/http_demo_go.git</span></span><br><span class="line">https://gitee.com/lbtooth/ http_server_demo.git</span><br><span class="line"></span><br><span class="line">[root@ubuntu2004 data]<span class="comment"># cd http_server_demo</span></span><br><span class="line">[root@ubuntu2004 http_demo_go]<span class="comment"># pwd</span></span><br><span class="line">/data/http_demo_go</span><br><span class="line"></span><br><span class="line">[root@ubuntu2004 http_demo_go]<span class="comment"># ls</span></span><br><span class="line">go.mod hello.html main.go</span><br></pre></td></tr></table></figure>

<h3 id="Gitlab-创建项目"><a href="#Gitlab-创建项目" class="headerlink" title="Gitlab 创建项目"></a>Gitlab 创建项目</h3><p><img src="../../../../images/SRE/day55/167.jpg" alt="167"><br><img src="../../../../images/SRE/day55/168.jpg" alt="168"></p>
<h3 id="将源码上传到-GitLab"><a href="#将源码上传到-GitLab" class="headerlink" title="将源码上传到 GitLab"></a>将源码上传到 GitLab</h3><h4 id="生成ssh密钥并上传到GitLab"><a href="#生成ssh密钥并上传到GitLab" class="headerlink" title="生成ssh密钥并上传到GitLab"></a>生成ssh密钥并上传到GitLab</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[root@ubuntu2004 ~]<span class="comment"># ssh-keygen</span></span><br><span class="line">[root@ubuntu2004 ~]<span class="comment"># cat .ssh/id_rsa.pub </span></span><br><span class="line">ssh-rsa </span><br><span class="line">AAAAB3NzaC1yc2EAAAADAQABAAABgQDX28R1iOKyGgZmD+OGXRJ//2zxqxYvw8vftHxeQlL8rzNzMV0k</span><br><span class="line">d5CoklpDdS+Xeds+IssV/jApwLKJIqWZoQ/RCYTCPpAVLsSknO9o4yiovGcRHe9NzEYcqnK7LSjwuIvx</span><br><span class="line">JMu6T3TpBDp/EARN16WFeqKRDtUnSDu+U1PLawSUN9Ye7OQv+oADmrAvX8TuOmGRy9QqjflWIzvfJw3B</span><br><span class="line">rDAfP0EAwHYCNUPZbDtfIn1kJvaNTTOjWdqH2TqBmabVnTawN8B+nqwosUJp5h/4Y+B9qdRTlpmzdZtg</span><br><span class="line">ZUiHf2vy/LkVeoNd6i892AxepFnSwMZooUW7ByMA6uKuZRPDrwz0Lo9zQNt4BE5MoikuaqHvfsw408B4</span><br><span class="line">wF9e/l3o2lOu+MQ9im544G4C7Tudo669b/Jva4fzu40L/EORohXOx1r4kzC5i2yywo2SQPB/nZSU/2u6</span><br><span class="line">7TFsMDv+5Fi4vVO0P/Zpl0PEJEcmo87/CnhVqnh00FknXtVJyIAilH2Te+oVojk=</span><br></pre></td></tr></table></figure>

<p>将 ssh 的 公钥上传到 GitLab</p>
<p><img src="../../../../images/SRE/day55/169.jpg" alt="169"></p>
<h4 id="上传代码到-GitLab"><a href="#上传代码到-GitLab" class="headerlink" title="上传代码到 GitLab"></a>上传代码到 GitLab</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@ubuntu2004 http_demo_go]<span class="comment"># git init </span></span><br><span class="line">[root@ubuntu2004 http_demo_go]<span class="comment"># git config --global user.name &quot;wang&quot;</span></span><br><span class="line">[root@ubuntu2004 http_demo_go]<span class="comment"># git config --global user.email &quot;wang@qq.com&quot;</span></span><br><span class="line">[root@ubuntu2004 http_demo_go]<span class="comment"># git checkout -b main</span></span><br><span class="line">[root@ubuntu2004 http_demo_go]<span class="comment"># git add .; git commit -m &#x27;v1.0&#x27;</span></span><br><span class="line">[root@ubuntu2004 http_demo_go]<span class="comment"># git remote add origin git@gitlab.wang.org:dev/http_demo_go.git</span></span><br><span class="line">[root@ubuntu2004 http_demo_go]<span class="comment"># git push -u origin --all</span></span><br></pre></td></tr></table></figure>

<p><img src="../../../../images/SRE/day55/170.jpg" alt="170"></p>
<h3 id="编写-Shell-脚本"><a href="#编写-Shell-脚本" class="headerlink" title="编写 Shell 脚本"></a>编写 Shell 脚本</h3><p>范例: http_demo项目</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">[root@jenkins ~]<span class="comment"># cat /data/scripts/http_hello_go.sh </span></span><br><span class="line"><span class="comment">#!/bin/bash</span></span><br><span class="line">APP=http_server_demo</span><br><span class="line">APP_PATH=/data</span><br><span class="line">DATE=`<span class="built_in">date</span> +%F_%H-%M-%S`</span><br><span class="line">HOST_LIST=<span class="string">&quot;</span></span><br><span class="line"><span class="string">10.0.0.102</span></span><br><span class="line"><span class="string">10.0.0.103</span></span><br><span class="line"><span class="string">&quot;</span></span><br><span class="line"><span class="function"><span class="title">build</span></span> () &#123;</span><br><span class="line">    <span class="comment">#go env 可以查看到下面变量信息</span></span><br><span class="line">    <span class="built_in">export</span> GOCACHE=<span class="string">&quot;/root/.cache/go-build&quot;</span></span><br><span class="line">    <span class="built_in">export</span> GOPATH=<span class="string">&quot;/root/go&quot;</span></span><br><span class="line">    <span class="built_in">export</span> GOPROXY=<span class="string">&quot;https://goproxy.cn,direct&quot;</span></span><br><span class="line">    go build -o <span class="variable">$&#123;APP&#125;</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="title">deloy</span></span> () &#123;</span><br><span class="line">    <span class="keyword">for</span> host <span class="keyword">in</span> <span class="variable">$HOST_LIST</span>;<span class="keyword">do</span></span><br><span class="line">        ssh <span class="variable">$host</span> <span class="string">&quot;mkdir -p <span class="variable">$APP_PATH</span>/<span class="variable">$&#123;APP&#125;</span>-<span class="variable">$&#123;DATE&#125;</span>&quot;</span></span><br><span class="line">       scp -r hello.html <span class="variable">$&#123;APP&#125;</span> <span class="variable">$host</span>:<span class="variable">$APP_PATH</span>/<span class="variable">$&#123;APP&#125;</span>-<span class="variable">$&#123;DATE&#125;</span>/</span><br><span class="line">        ssh <span class="variable">$host</span> <span class="string">&quot;killall -0 <span class="variable">$&#123;APP&#125;</span> &amp;&gt;/dev/null &amp;&amp; killall -9 <span class="variable">$APP</span>;rm -f <span class="variable">$&#123;APP_PATH&#125;</span>/<span class="variable">$&#123;APP&#125;</span> &amp;&amp; \</span></span><br><span class="line"><span class="string">                   ln -s <span class="variable">$&#123;APP_PATH&#125;</span>/<span class="variable">$&#123;APP&#125;</span>-<span class="variable">$&#123;DATE&#125;</span> <span class="variable">$&#123;APP_PATH&#125;</span>/<span class="variable">$&#123;APP&#125;</span>; \</span></span><br><span class="line"><span class="string">                   cd <span class="variable">$&#123;APP_PATH&#125;</span>/<span class="variable">$&#123;APP&#125;</span>/ &amp;&amp; ./<span class="variable">$&#123;APP&#125;</span>&quot;</span> &amp;</span><br><span class="line">    <span class="keyword">done</span></span><br><span class="line">&#125;</span><br><span class="line">build</span><br><span class="line">deloy</span><br></pre></td></tr></table></figure>

<p>范例: ginweb 项目</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line">APP=ginweb</span><br><span class="line">APP_PATH=/data</span><br><span class="line">DATE=`<span class="built_in">date</span> +%F_%H-%M-%S`</span><br><span class="line">HOST_LIST=<span class="string">&quot;</span></span><br><span class="line"><span class="string">10.0.0.102</span></span><br><span class="line"><span class="string">&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">build</span></span> () &#123;</span><br><span class="line">	<span class="comment">#go env 可以查看到下面变量信息</span></span><br><span class="line">    <span class="built_in">export</span> GOCACHE=<span class="string">&quot;/root/.cache/go-build&quot;</span></span><br><span class="line">    <span class="built_in">export</span> GOPATH=<span class="string">&quot;/root/go&quot;</span></span><br><span class="line">    <span class="comment">#go env -w GOPROXY=https://goproxy.cn,direct</span></span><br><span class="line">    <span class="built_in">export</span> GOPROXY=<span class="string">&quot;https://goproxy.cn,direct&quot;</span></span><br><span class="line">    CGO_ENABLED=0 go build -o <span class="variable">$&#123;APP&#125;</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="title">deloy</span></span> () &#123;</span><br><span class="line">   <span class="keyword">for</span> host <span class="keyword">in</span> <span class="variable">$HOST_LIST</span>;<span class="keyword">do</span></span><br><span class="line">       ssh <span class="variable">$host</span> <span class="string">&quot;mkdir -p <span class="variable">$APP_PATH</span>/<span class="variable">$&#123;APP&#125;</span>-<span class="variable">$&#123;DATE&#125;</span>&quot;</span></span><br><span class="line">       scp -r * <span class="variable">$host</span>:<span class="variable">$APP_PATH</span>/<span class="variable">$&#123;APP&#125;</span>-<span class="variable">$&#123;DATE&#125;</span>/</span><br><span class="line">       ssh <span class="variable">$host</span> <span class="string">&quot;killall -0 <span class="variable">$&#123;APP&#125;</span> &amp;&gt; /dev/null &amp;&amp; killall -9 <span class="variable">$&#123;APP&#125;</span>; rm -f <span class="variable">$&#123;APP_PATH&#125;</span>/<span class="variable">$&#123;APP&#125;</span> &amp;&amp; \</span></span><br><span class="line"><span class="string">                   ln -s <span class="variable">$&#123;APP_PATH&#125;</span>/<span class="variable">$&#123;APP&#125;</span>-<span class="variable">$&#123;DATE&#125;</span> <span class="variable">$&#123;APP_PATH&#125;</span>/<span class="variable">$&#123;APP&#125;</span>; \</span></span><br><span class="line"><span class="string">                   cd <span class="variable">$&#123;APP_PATH&#125;</span>/<span class="variable">$&#123;APP&#125;</span>/ &amp;&amp; nohup ./<span class="variable">$&#123;APP&#125;</span>&amp;&gt;/dev/null&quot;</span> &amp;</span><br><span class="line">   <span class="keyword">done</span></span><br><span class="line">&#125;</span><br><span class="line">build</span><br><span class="line">deloy</span><br></pre></td></tr></table></figure>

<h3 id="创建-Jenkins-任务-1"><a href="#创建-Jenkins-任务-1" class="headerlink" title="创建 Jenkins 任务"></a>创建 Jenkins 任务</h3><p><img src="../../../../images/SRE/day55/171.jpg" alt="171"><br><img src="../../../../images/SRE/day55/172.jpg" alt="172"><br><img src="../../../../images/SRE/day55/173.jpg" alt="173"></p>
<h3 id="执行任务"><a href="#执行任务" class="headerlink" title="执行任务"></a>执行任务</h3><p><img src="../../../../images/SRE/day55/174.jpg" alt="174"><br><img src="../../../../images/SRE/day55/175.jpg" alt="175"></p>
<h3 id="验证服务"><a href="#验证服务" class="headerlink" title="验证服务"></a>验证服务</h3><p>访问服务器的链接，验证是否能正常访问</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">http://10.0.0.102:9999/hello</span><br><span class="line">http://10.0.0.102:9999/world</span><br><span class="line">http://10.0.0.102:9999/info</span><br></pre></td></tr></table></figure>

<p><img src="../../../../images/SRE/day55/176.jpg" alt="176"></p>
<h2 id="集成-Ansible-的任务构建"><a href="#集成-Ansible-的任务构建" class="headerlink" title="集成 Ansible 的任务构建"></a>集成 Ansible 的任务构建</h2><p><img src="../../../../images/SRE/day55/177.jpg" alt="177"></p>
<p>官方参考</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://plugins.jenkins.io/ansible/</span><br></pre></td></tr></table></figure>

<h3 id="安装-Ansible-环境"><a href="#安装-Ansible-环境" class="headerlink" title="安装 Ansible 环境"></a>安装 Ansible 环境</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">root@jenkins ~]<span class="comment"># apt -y install ansible -y</span></span><br><span class="line">[root@jenkins ~]<span class="comment"># ansible --version</span></span><br><span class="line">ansible 2.9.6</span><br><span class="line">  config file = /etc/ansible/ansible.cfg</span><br><span class="line">  configured module search path =    [<span class="string">&#x27;/root/.ansible/plugins/modules&#x27;</span>, <span class="string">&#x27;/usr/share/ansible/plugins/modules&#x27;</span>]</span><br><span class="line">  ansible python module location = /usr/lib/python3/dist-packages/ansible</span><br><span class="line">  executable location = /usr/bin/ansible</span><br><span class="line">  python version = 3.8.10 (default, Jun 22 2022, 20:18:18) [GCC 9.4.0]</span><br></pre></td></tr></table></figure>

<h3 id="安装-Ansible-插件"><a href="#安装-Ansible-插件" class="headerlink" title="安装 Ansible 插件"></a>安装 Ansible 插件</h3><p><img src="../../../../images/SRE/day55/178.jpg" alt="178"></p>
<p>安装插件后，添加了ansible的构建步骤</p>
<p><img src="../../../../images/SRE/day55/179.jpg" alt="179"></p>
<h3 id="使用-Ansible-Ad-Hoc-实现任务"><a href="#使用-Ansible-Ad-Hoc-实现任务" class="headerlink" title="使用 Ansible Ad-Hoc 实现任务"></a>使用 Ansible Ad-Hoc 实现任务</h3><p><img src="../../../../images/SRE/day55/180.jpg" alt="180"></p>
<p><img src="../../../../images/SRE/day55/181.jpg" alt="181"></p>
<h3 id="使用-Ansible-Playbook-实现任务"><a href="#使用-Ansible-Playbook-实现任务" class="headerlink" title="使用 Ansible Playbook 实现任务"></a>使用 Ansible Playbook 实现任务</h3><h4 id="准备-Playbook文件"><a href="#准备-Playbook文件" class="headerlink" title="准备 Playbook文件"></a>准备 Playbook文件</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[root@jenkins ~]<span class="comment"># cat /data/ansible/test.yml</span></span><br><span class="line">- hosts: webservers</span><br><span class="line">  remote_user: root</span><br><span class="line">  tasks:</span><br><span class="line">  - name: excute cmd</span><br><span class="line">    shell:</span><br><span class="line">      cmd: hostname -I</span><br><span class="line">    register: result</span><br><span class="line">  </span><br><span class="line">  - name: show result</span><br><span class="line">    debug:</span><br><span class="line">      msg: <span class="string">&quot;&#123;&#123; result &#125;&#125;&quot;</span></span><br></pre></td></tr></table></figure>

<h4 id="创建任务-2"><a href="#创建任务-2" class="headerlink" title="创建任务"></a>创建任务</h4><p><img src="../../../../images/SRE/day55/182.jpg" alt="182"></p>
<h3 id="使用-Ansible-Playbook-实现参数化任务"><a href="#使用-Ansible-Playbook-实现参数化任务" class="headerlink" title="使用 Ansible Playbook 实现参数化任务"></a>使用 Ansible Playbook 实现参数化任务</h3><p>上面的任务是固定的，不灵活，利用参数在同一个任务就可以灵活实现测试和生产多套不同环境的部署</p>
<h4 id="准备Playbook文件"><a href="#准备Playbook文件" class="headerlink" title="准备Playbook文件"></a>准备Playbook文件</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[root@jenkins ~]<span class="comment"># cat /data/ansible/test.yml</span></span><br><span class="line">- hosts: webservers</span><br><span class="line">  remote_user: root</span><br><span class="line">  tasks:</span><br><span class="line">  - name: excute cmd</span><br><span class="line">    shell:</span><br><span class="line">      cmd: hostname -I</span><br><span class="line">    register: result</span><br><span class="line">  </span><br><span class="line">  - name: show result</span><br><span class="line">    debug:</span><br><span class="line">      msg: <span class="string">&quot;&#123;&#123; result &#125;&#125;&quot;</span></span><br></pre></td></tr></table></figure>

<h4 id="准备两个主机清单文件"><a href="#准备两个主机清单文件" class="headerlink" title="准备两个主机清单文件"></a>准备两个主机清单文件</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@jenkins ~]<span class="comment"># cat /etc/ansible/hosts_test</span></span><br><span class="line">[webservers]</span><br><span class="line">10.0.0.102</span><br><span class="line"></span><br><span class="line">[root@jenkins ~]<span class="comment"># cat /etc/ansible/hosts_product</span></span><br><span class="line">[webservers]</span><br><span class="line">10.0.0.103</span><br></pre></td></tr></table></figure>

<h4 id="创建参数化任务"><a href="#创建参数化任务" class="headerlink" title="创建参数化任务"></a>创建参数化任务</h4><p><img src="../../../../images/SRE/day55/183.jpg" alt="183"><br><img src="../../../../images/SRE/day55/184.jpg" alt="184"></p>
<h4 id="执行任务-1"><a href="#执行任务-1" class="headerlink" title="执行任务"></a>执行任务</h4><p><img src="../../../../images/SRE/day55/185.jpg" alt="185"></p>
<h3 id="使用-Ansible-Playbook-实现向-Playbook-中传参功能"><a href="#使用-Ansible-Playbook-实现向-Playbook-中传参功能" class="headerlink" title="使用 Ansible Playbook 实现向 Playbook 中传参功能"></a>使用 Ansible Playbook 实现向 Playbook 中传参功能</h3><h4 id="编写Playbook文件"><a href="#编写Playbook文件" class="headerlink" title="编写Playbook文件"></a>编写Playbook文件</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[root@jenkins ~]<span class="comment"># cat /data/ansible/test-vars.yml </span></span><br><span class="line">- hosts: <span class="string">&quot;&#123;&#123; ansible_hosts &#125;&#125;&quot;</span></span><br><span class="line">  remote_user: root</span><br><span class="line">  </span><br><span class="line">  tasks:</span><br><span class="line">  - name: excute cmd</span><br><span class="line">    shell:</span><br><span class="line">      cmd: hostname -I</span><br><span class="line">    register: result</span><br><span class="line">  </span><br><span class="line">  - name: show result</span><br><span class="line">    debug:</span><br><span class="line">      msg: <span class="string">&quot;&#123;&#123; result &#125;&#125;&quot;</span></span><br></pre></td></tr></table></figure>

<h4 id="创建主机清单文件"><a href="#创建主机清单文件" class="headerlink" title="创建主机清单文件"></a>创建主机清单文件</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[root@jenkins ~]<span class="comment"># cat /etc/ansible/hosts-test</span></span><br><span class="line">[webservers]</span><br><span class="line">10.0.0.104</span><br><span class="line"></span><br><span class="line">[appservers]</span><br><span class="line">10.0.0.106</span><br><span class="line"></span><br><span class="line">[root@jenkins ~]<span class="comment"># cat /etc/ansible/hosts-product</span></span><br><span class="line">[webservers]</span><br><span class="line">10.0.0.105</span><br><span class="line"></span><br><span class="line">[appservers]</span><br><span class="line">10.0.0.107</span><br></pre></td></tr></table></figure>

<h4 id="创建-Ansible-Playbook-的任务"><a href="#创建-Ansible-Playbook-的任务" class="headerlink" title="创建 Ansible Playbook 的任务"></a>创建 Ansible Playbook 的任务</h4><p>创建任务</p>
<p>添加第一个参数选项</p>
<p><img src="../../../../images/SRE/day55/186.jpg" alt="186"></p>
<p>添加第二个参数选项</p>
<p><img src="../../../../images/SRE/day55/187.jpg" alt="187"><br><img src="../../../../images/SRE/day55/188.jpg" alt="188"></p>
<p>点”高级”添加ansible的变量，添加Ansible Playbook的变量</p>
<p><img src="../../../../images/SRE/day55/189.jpg" alt="189"></p>
<p><strong>注意: 此处的Extra Variables 指的是ansible的变量</strong></p>
<p><strong>key为ansible Playbook的变量名</strong></p>
<p><strong>Value可以是固定值，或者是任务中的变量(需要用${变量名}形式)</strong></p>
<p><strong>如下配置相当于: ansible-playbook -e “ansible_hosts=${hosts_list}”</strong></p>
<p><img src="../../../../images/SRE/day55/190.jpg" alt="190"></p>
<h4 id="执行构建-1"><a href="#执行构建-1" class="headerlink" title="执行构建"></a>执行构建</h4><p><img src="../../../../images/SRE/day55/191.jpg" alt="191"></p>
<p><img src="../../../../images/SRE/day55/192.jpg" alt="192"></p>
<h4 id="查看结果"><a href="#查看结果" class="headerlink" title="查看结果"></a>查看结果</h4><p><img src="../../../../images/SRE/day55/193.jpg" alt="193"></p>
<h2 id="构建后通知"><a href="#构建后通知" class="headerlink" title="构建后通知"></a>构建后通知</h2><p>Jenkins通知可以将任务的执行状态、事件或信息推送给相关用户，这些通常发生在pipeline的“构建后处理(post-processing)”时期</p>
<p>Email是 Jenkins 内置支持的通知方式，它也能够通过 webhook 扩展支持其它的即时通信媒介，例如:钉钉，Slack等;</p>
<h3 id="邮件通知"><a href="#邮件通知" class="headerlink" title="邮件通知"></a>邮件通知</h3><p>Mailer 和 Email Extension 插件都可以实现邮件通知功能，以下以mailer插件为例</p>
<h4 id="生成邮箱登录授权码"><a href="#生成邮箱登录授权码" class="headerlink" title="生成邮箱登录授权码"></a>生成邮箱登录授权码</h4><p>可以使用QQ或163邮箱等</p>
<p><img src="../../../../images/SRE/day55/194.jpg" alt="194"><br><img src="../../../../images/SRE/day55/195.jpg" alt="195"></p>
<h4 id="安装-mailer-插件"><a href="#安装-mailer-插件" class="headerlink" title="安装 mailer 插件"></a>安装 mailer 插件</h4><p>先安装mailer插件后才可以显示和配置发件配置信息</p>
<p><img src="../../../../images/SRE/day55/196.jpg" alt="196"></p>
<h4 id="配置-Jenkins管理员邮箱"><a href="#配置-Jenkins管理员邮箱" class="headerlink" title="配置 Jenkins管理员邮箱"></a>配置 Jenkins管理员邮箱</h4><p>注意:必须指定<strong>系统管理员邮件地址</strong>才能实现邮件通知</p>
<p>Jenkins—系统管理—系统设置：</p>
<p>注意：系统管理员邮件地址，必须和下面SMTP的用户名相同</p>
<p><img src="../../../../images/SRE/day55/197.jpg" alt="197"></p>
<h4 id="配置发送邮件的邮件通知"><a href="#配置发送邮件的邮件通知" class="headerlink" title="配置发送邮件的邮件通知"></a>配置发送邮件的邮件通知</h4><p>Jenkins—系统管理—系统设置：</p>
<p>注意:必须安装插件才能出现下面的SMTP配置</p>
<p>配置邮件通知信息如下:</p>
<ul>
<li>用户名必须要和上面的系统管理员邮件地址相同</li>
<li>用户默认邮件后缀可为空</li>
<li>启用”使用SSL协议”</li>
<li>SMTP 端口可以为空，默认为465</li>
<li>Reply-To Address 可以为空</li>
</ul>
<p><img src="../../../../images/SRE/day55/198.jpg" alt="198"></p>
<p>测试配置，确认能否收到邮件</p>
<p><img src="../../../../images/SRE/day55/199.jpg" alt="199"></p>
<h4 id="配置任务的构建后通知"><a href="#配置任务的构建后通知" class="headerlink" title="配置任务的构建后通知"></a>配置任务的构建后通知</h4><p>选中“每次不稳定的构建都发送邮件通知”，表示只有失败构建时才会发邮件通知</p>
<p>默认不选，成功和失败都会发送</p>
<p><img src="../../../../images/SRE/day55/200.jpg" alt="200"></p>
<h4 id="执行任务验证结果"><a href="#执行任务验证结果" class="headerlink" title="执行任务验证结果"></a>执行任务验证结果</h4><p><strong>注意:当任务执行失败时才会收邮件</strong></p>
<p><img src="../../../../images/SRE/day55/201.jpg" alt="201"><br><img src="../../../../images/SRE/day55/202.jpg" alt="202"><br><img src="../../../../images/SRE/day55/203.jpg" alt="203"></p>
<h4 id="在-Pipeline-中也可以添加邮件通知"><a href="#在-Pipeline-中也可以添加邮件通知" class="headerlink" title="在 Pipeline 中也可以添加邮件通知"></a>在 Pipeline 中也可以添加邮件通知</h4><p>范例: </p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">pipeline &#123;</span><br><span class="line">   agent any </span><br><span class="line">   stages &#123;</span><br><span class="line">       stage(<span class="string">&#x27;Source&#x27;</span>) &#123;</span><br><span class="line">   steps &#123;</span><br><span class="line">                git branch: <span class="string">&#x27;main&#x27;</span>, credentialsId: <span class="string">&#x27;95b957c7-d786-46c9-9d76-b767121d1c85&#x27;</span>, url: <span class="string">&#x27;git@10.0.0.100:testgroup/spring-boot-helloworld.git&#x27;</span></span><br><span class="line">           &#125;</span><br><span class="line">   &#125;</span><br><span class="line">       stage(<span class="string">&#x27;Build&#x27;</span>) &#123; </span><br><span class="line">           steps &#123;</span><br><span class="line">               sh <span class="string">&#x27;mvn clean package -Dmaven.test.skip=true&#x27;</span></span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">       stage(<span class="string">&#x27;Test&#x27;</span>) &#123; </span><br><span class="line">           steps &#123;</span><br><span class="line">                <span class="built_in">echo</span> <span class="string">&quot;Test&quot;</span></span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">       stage(<span class="string">&#x27;Deploy&#x27;</span>) &#123; </span><br><span class="line">           steps &#123;</span><br><span class="line">               <span class="built_in">echo</span> <span class="string">&quot;Deploy&quot;</span></span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br><span class="line">   post &#123;</span><br><span class="line">       always &#123;</span><br><span class="line">           mail to:<span class="string">&quot;root@wangxiaochun.com&quot;</span>,</span><br><span class="line">           subject:<span class="string">&quot;Status of pipeline: <span class="variable">$&#123;currentBuild.fullDisplayName&#125;</span>&quot;</span>,</span><br><span class="line">           body:<span class="string">&quot;<span class="variable">$&#123;env.BUILD_URL&#125;</span> has result <span class="variable">$&#123;currentBuild.result&#125;</span>&quot;</span></span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="C:\Users\Lenovo\Desktop\img\204.jpg" alt="204"></p>
<p>邮件内容</p>
<p><img src="C:\Users\Lenovo\Desktop\img\205.jpg" alt="205"></p>
<h3 id="钉钉通知"><a href="#钉钉通知" class="headerlink" title="钉钉通知"></a>钉钉通知</h3><p>插件说明</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">https://jenkinsci.github.io/dingtalk-plugin/</span><br><span class="line">https://jenkinsci.github.io/dingtalk-plugin/guide/getting-started.html</span><br></pre></td></tr></table></figure>

<h4 id="钉钉配置群聊机器人"><a href="#钉钉配置群聊机器人" class="headerlink" title="钉钉配置群聊机器人"></a>钉钉配置群聊机器人</h4><p>注册钉钉，创建群聊</p>
<p><img src="C:\Users\Lenovo\Desktop\img\206.jpg" alt="206"></p>
<p>指定群类型—内部项目群</p>
<p><img src="C:\Users\Lenovo\Desktop\img\207.jpg" alt="207"></p>
<p>选择归属企业和添加相关人员到群里</p>
<p><img src="C:\Users\Lenovo\Desktop\img\208.jpg" alt="208"><br><img src="C:\Users\Lenovo\Desktop\img\209.jpg" alt="209"></p>
<p>指定群助手</p>
<p><img src="C:\Users\Lenovo\Desktop\img\210.jpg" alt="210"></p>
<p>添加机器人</p>
<p><img src="C:\Users\Lenovo\Desktop\img\211.jpg" alt="211"><br><img src="C:\Users\Lenovo\Desktop\img\212.jpg" alt="212"></p>
<p>指定机器人类型为webhook</p>
<p><img src="C:\Users\Lenovo\Desktop\img\213.jpg" alt="213"><br><img src="C:\Users\Lenovo\Desktop\img\214.jpg" alt="214"><br><img src="C:\Users\Lenovo\Desktop\img\215.jpg" alt="215"></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#复制加签内容如下</span></span><br><span class="line">SEC9f06df8a086c4efdb58cb7753e836fcfb638fb0297a57bc2f5d9232a3fc86bc9</span><br></pre></td></tr></table></figure>

<p><img src="C:\Users\Lenovo\Desktop\img\216.jpg" alt="216"></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#复制Webhook信息如下</span></span><br><span class="line">https://oapi.dingtalk.com/robot/send?access_token=3ca57ace4ed34f0803599637c5cd932eb3491a16ef7ace06b99a6e3e465609f5</span><br></pre></td></tr></table></figure>

<p><img src="C:\Users\Lenovo\Desktop\img\217.jpg" alt="217"></p>
<h4 id="Jenkins-安装-DingTalk-插件"><a href="#Jenkins-安装-DingTalk-插件" class="headerlink" title="Jenkins 安装 DingTalk 插件"></a>Jenkins 安装 DingTalk 插件</h4><p><img src="C:\Users\Lenovo\Desktop\img\218.jpg" alt="218"><br><img src="C:\Users\Lenovo\Desktop\img\219.jpg" alt="219"></p>
<h4 id="Jenkins-系统配置"><a href="#Jenkins-系统配置" class="headerlink" title="Jenkins 系统配置"></a>Jenkins 系统配置</h4><p>新版配置</p>
<p>Manage Jenkins –&gt; 钉钉</p>
<p><img src="C:\Users\Lenovo\Desktop\img\220.jpg" alt="220"><br><img src="C:\Users\Lenovo\Desktop\img\221.jpg" alt="221"></p>
<p>旧版配置 管理</p>
<p>Jenkins — configure system</p>
<p><img src="C:\Users\Lenovo\Desktop\img\222.jpg" alt="222"></p>
<p>输入webhook链接和加签信息</p>
<p><img src="C:\Users\Lenovo\Desktop\img\223.jpg" alt="223"></p>
<p>测试查看钉钉收到消息</p>
<p><img src="C:\Users\Lenovo\Desktop\img\224.jpg" alt="224"></p>
<h4 id="配置任务实现钉钉通知"><a href="#配置任务实现钉钉通知" class="headerlink" title="配置任务实现钉钉通知"></a>配置任务实现钉钉通知</h4><p>创建新的任务，使用钉钉通知</p>
<p><img src="C:\Users\Lenovo\Desktop\img\225.jpg" alt="225"><br><img src="C:\Users\Lenovo\Desktop\img\226.jpg" alt="226"></p>
<p>手机号支持多个，每个手机号一行，也可选 atall 即所有群里的人员(不必再输入手机号) </p>
<p>自定义内容需要使用Markdown格式，比如:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">- 构建ID: <span class="variable">$&#123;BUILD_ID&#125;</span></span><br><span class="line">- 部署项目: <span class="variable">$&#123;JOB_NAME&#125;</span></span><br><span class="line">- 部署目录: <span class="variable">$&#123;WORKSPACE&#125;</span></span><br></pre></td></tr></table></figure>

<p><img src="C:\Users\Lenovo\Desktop\img\227.jpg" alt="227"></p>
<p>注意：安装插件后有时会出现以下问题无法正常显示</p>
<p><img src="C:\Users\Lenovo\Desktop\img\228.jpg" alt="228"></p>
<h4 id="执行任务验证钉钉通知"><a href="#执行任务验证钉钉通知" class="headerlink" title="执行任务验证钉钉通知"></a>执行任务验证钉钉通知</h4><p>如果任务成功，显示下面提示</p>
<p>注意： 如果不成功，重启 jenkins服务，再尝试执行构建</p>
<p><img src="C:\Users\Lenovo\Desktop\img\229.jpg" alt="229"></p>
<p>如果失败，显示下面提示</p>
<p><img src="C:\Users\Lenovo\Desktop\img\230.jpg" alt="230"></p>
<h4 id="Pipeline-实现钉钉通知"><a href="#Pipeline-实现钉钉通知" class="headerlink" title="Pipeline 实现钉钉通知"></a>Pipeline 实现钉钉通知</h4><p>官方说明</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://jenkinsci.github.io/dingtalk-plugin/guide/pipeline.html</span><br></pre></td></tr></table></figure>

<p>范例：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">pipeline &#123;</span><br><span class="line">   agent any </span><br><span class="line">   stages &#123;</span><br><span class="line">       stage(<span class="string">&#x27;Source&#x27;</span>) &#123; </span><br><span class="line">           steps &#123;</span><br><span class="line">                <span class="built_in">echo</span> <span class="string">&quot;Source&quot;</span></span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">       stage(<span class="string">&#x27;Build&#x27;</span>) &#123; </span><br><span class="line">           steps &#123;</span><br><span class="line">                <span class="built_in">echo</span> <span class="string">&quot;Build&quot;</span></span><br><span class="line">           &#125;</span><br><span class="line">       &#125;        </span><br><span class="line">       stage(<span class="string">&#x27;Test&#x27;</span>) &#123; </span><br><span class="line">           steps &#123;</span><br><span class="line">                <span class="built_in">echo</span> <span class="string">&quot;Test&quot;</span></span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">       stage(<span class="string">&#x27;Deploy&#x27;</span>) &#123; </span><br><span class="line">           steps &#123;</span><br><span class="line">               <span class="built_in">echo</span> <span class="string">&quot;Deploy&quot;</span></span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br><span class="line">   post &#123;</span><br><span class="line">       always &#123;</span><br><span class="line">           dingtalk(</span><br><span class="line">               robot: <span class="string">&#x27;dingtalk&#x27;</span> ,<span class="built_in">type</span>: <span class="string">&quot;MARKDOWN&quot;</span>,</span><br><span class="line">               text: [</span><br><span class="line">                   <span class="string">&quot;# <span class="variable">$&#123;JOB_NAME&#125;</span> 完成&quot;</span>,</span><br><span class="line">                   <span class="string">&quot;- Status of pipeline: <span class="variable">$&#123;currentBuild.fullDisplayName&#125;</span>&quot;</span> ,</span><br><span class="line">                   <span class="string">&quot;-  <span class="variable">$&#123;env.BUILD_URL&#125;</span> has result <span class="variable">$&#123;currentBuild.result&#125;</span>&quot;</span></span><br><span class="line">               ],</span><br><span class="line">               at: [</span><br><span class="line">                   <span class="string">&#x27;wangxiaochun&#x27;</span></span><br><span class="line">               ]</span><br><span class="line">          )</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>范例: pipeline实现钉钉通知</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">pipeline &#123;</span><br><span class="line">   agent any </span><br><span class="line">   stages &#123;</span><br><span class="line">       stage(<span class="string">&#x27;Source&#x27;</span>) &#123;</span><br><span class="line">   steps &#123;</span><br><span class="line">                git branch: <span class="string">&#x27;main&#x27;</span>, credentialsId: <span class="string">&#x27;95b957c7-d786-46c9-9d76-b767121d1c85&#x27;</span>, url: <span class="string">&#x27;git@10.0.0.100:testgroup/spring-boot-helloworld.git&#x27;</span></span><br><span class="line">           &#125;</span><br><span class="line">   &#125;</span><br><span class="line">       stage(<span class="string">&#x27;Build&#x27;</span>) &#123; </span><br><span class="line">           steps &#123;</span><br><span class="line">               sh <span class="string">&#x27;mvn clean package -Dmaven.test.skip=true&#x27;</span></span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">       stage(<span class="string">&#x27;Test&#x27;</span>) &#123; </span><br><span class="line">           steps &#123;</span><br><span class="line">                <span class="built_in">echo</span> <span class="string">&quot;Test&quot;</span></span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">       stage(<span class="string">&#x27;Deploy&#x27;</span>) &#123; </span><br><span class="line">           steps &#123;</span><br><span class="line">               <span class="built_in">echo</span> <span class="string">&quot;Deploy&quot;</span></span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br><span class="line">   post &#123;</span><br><span class="line">       unsuccessful &#123;</span><br><span class="line">           dingtalk(</span><br><span class="line">               robot: <span class="string">&#x27;dingtalk&#x27;</span>,</span><br><span class="line">               <span class="built_in">type</span>: <span class="string">&#x27;MARKDOWN&#x27;</span>,</span><br><span class="line">               text: [</span><br><span class="line">                   <span class="string">&quot;# <span class="variable">$&#123;JOB_NAME&#125;</span> 有问题&quot;</span>,</span><br><span class="line">                   <span class="string">&quot;- Status of pipeline: <span class="variable">$&#123;currentBuild.fullDisplayName&#125;</span>&quot;</span> ,</span><br><span class="line">                   <span class="string">&quot;-  <span class="variable">$&#123;env.BUILD_URL&#125;</span> has result <span class="variable">$&#123;currentBuild.result&#125;</span>&quot;</span></span><br><span class="line">               ],</span><br><span class="line">               at: [</span><br><span class="line">                   <span class="string">&#x27;18600123680&#x27;</span></span><br><span class="line">               ]</span><br><span class="line">           )</span><br><span class="line">      &#125;</span><br><span class="line">      success &#123;</span><br><span class="line">          mail to:<span class="string">&quot;29308620@qq.com&quot;</span>,</span><br><span class="line">          subject:<span class="string">&quot;Status of pipeline: <span class="variable">$&#123;currentBuild.fullDisplayName&#125;</span>&quot;</span>,</span><br><span class="line">           body:<span class="string">&quot;<span class="variable">$&#123;env.BUILD_URL&#125;</span> has result <span class="variable">$&#123;currentBuild.result&#125;</span>&quot;</span></span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="微信通知"><a href="#微信通知" class="headerlink" title="微信通知"></a>微信通知</h3><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">https://plugins.jenkins.io/qy-wechat-notification</span><br><span class="line">https://github.com/jenkinsci/qy-wechat-notification-plugin</span><br></pre></td></tr></table></figure>

<h4 id="注册企业微信添加WebHook机器"><a href="#注册企业微信添加WebHook机器" class="headerlink" title="注册企业微信添加WebHook机器"></a>注册企业微信添加WebHook机器</h4><p><img src="C:\Users\Lenovo\Desktop\img\231.jpg" alt="231"><br><img src="C:\Users\Lenovo\Desktop\img\232.jpg" alt="232"><br><img src="C:\Users\Lenovo\Desktop\img\233.jpg" alt="233"></p>
<p>复制Webhook地址</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://qyapi.weixin.qq.com/cgi-bin/webhook/send?key=1a4e1e74-e7d6-4376-99f6-048b01a7b7fc</span><br></pre></td></tr></table></figure>

<h4 id="Jenkins-安装-Qy-Wechat-Notification-插件"><a href="#Jenkins-安装-Qy-Wechat-Notification-插件" class="headerlink" title="Jenkins 安装 Qy Wechat Notification 插件"></a>Jenkins 安装 Qy Wechat Notification 插件</h4><p><img src="C:\Users\Lenovo\Desktop\img\234.jpg" alt="234"></p>
<h4 id="创建自由风格任务"><a href="#创建自由风格任务" class="headerlink" title="创建自由风格任务"></a>创建自由风格任务</h4><p><img src="C:\Users\Lenovo\Desktop\img\235.jpg" alt="235"></p>
<p>更多消息定制消息格式</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">- 构建ID: <span class="variable">$&#123;BUILD_ID&#125;</span></span><br><span class="line">- 部署项目: <span class="variable">$&#123;JOB_NAME&#125;</span></span><br><span class="line">- 部署目录: <span class="variable">$&#123;WORKSPACE&#125;</span></span><br></pre></td></tr></table></figure>

<p><img src="C:\Users\Lenovo\Desktop\img\236.jpg" alt="236"></p>
<h4 id="执行任务-2"><a href="#执行任务-2" class="headerlink" title="执行任务"></a>执行任务</h4><p><img src="C:\Users\Lenovo\Desktop\img\237.jpg" alt="237"><br><img src="C:\Users\Lenovo\Desktop\img\238.jpg" alt="238"></p>
<h4 id="创建Pipeline的任务"><a href="#创建Pipeline的任务" class="headerlink" title="创建Pipeline的任务"></a>创建Pipeline的任务</h4><h5 id="创建Pipeline的任务成功执行"><a href="#创建Pipeline的任务成功执行" class="headerlink" title="创建Pipeline的任务成功执行"></a>创建Pipeline的任务成功执行</h5><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">pipeline &#123;</span><br><span class="line">   agent any</span><br><span class="line">   stages &#123;</span><br><span class="line">       stage(<span class="string">&#x27;Test&#x27;</span>) &#123;</span><br><span class="line">           steps &#123;</span><br><span class="line">                <span class="built_in">echo</span> <span class="string">&#x27;wechat test&#x27;</span></span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br><span class="line">   post&#123;</span><br><span class="line">       success&#123;</span><br><span class="line">           qyWechatNotification failNotify: <span class="literal">true</span>, webhookUrl: <span class="string">&#x27;https://qyapi.weixin.qq.com/cgi-bin/webhook/send?key=1a4e1e74-e7d6-4376-99f6-048b01a7b7fc&#x27;</span></span><br><span class="line">       &#125;</span><br><span class="line">       failure&#123;</span><br><span class="line">           qyWechatNotification failNotify: <span class="literal">true</span>, webhookUrl: <span class="string">&#x27;https://qyapi.weixin.qq.com/cgi-bin/webhook/send?key=1a4e1e74-e7d6-4376-99f6-048b01a7b7fc&#x27;</span></span><br><span class="line">       &#125;</span><br><span class="line">   &#125;   </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>执行结果</p>
<p><img src="C:\Users\Lenovo\Desktop\img\239.jpg" alt="239"></p>
<h5 id="创建Pipeline的任务失败执行"><a href="#创建Pipeline的任务失败执行" class="headerlink" title="创建Pipeline的任务失败执行"></a>创建Pipeline的任务失败执行</h5><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">pipeline &#123;</span><br><span class="line">   agent any</span><br><span class="line">   stages &#123;</span><br><span class="line">       stage(<span class="string">&#x27;Test&#x27;</span>) &#123;</span><br><span class="line">           steps &#123;</span><br><span class="line">                <span class="built_in">echo</span> <span class="string">&#x27;wechat test&#x27;</span></span><br><span class="line">                sh <span class="string">&#x27;false&#x27;</span> //加此行</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br><span class="line">   post&#123;</span><br><span class="line">       success&#123;</span><br><span class="line">           qyWechatNotification failNotify: <span class="literal">true</span>, webhookUrl: <span class="string">&#x27;https://qyapi.weixin.qq.com/cgi-bin/webhook/send?key=1a4e1e74-e7d6-4376-99f6-048b01a7b7fc&#x27;</span></span><br><span class="line">       &#125;</span><br><span class="line">       failure&#123;</span><br><span class="line">           qyWechatNotification failNotify: <span class="literal">true</span>, webhookUrl: <span class="string">&#x27;https://qyapi.weixin.qq.com/cgi-bin/webhook/send?key=1a4e1e74-e7d6-4376-99f6-048b01a7b7fc&#x27;</span></span><br><span class="line">       &#125;</span><br><span class="line">   &#125;   </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="C:\Users\Lenovo\Desktop\img\240.jpg" alt="240"></p>
<p>再次执行，查看结果如下</p>
<p><img src="C:\Users\Lenovo\Desktop\img\241.jpg" alt="241"><br><img src="C:\Users\Lenovo\Desktop\img\242.jpg" alt="242"></p>
<h2 id="自动化构建"><a href="#自动化构建" class="headerlink" title="自动化构建"></a>自动化构建</h2><h3 id="定时和-SCM-构建"><a href="#定时和-SCM-构建" class="headerlink" title="定时和 SCM 构建"></a>定时和 SCM 构建</h3><p>周期性构建这是—-种基于 cron 类型的构建机制．按照预定义的时间周期性启动作务</p>
<p>对于期望能够基于代码变更进行触的CI场景来说，周期性构建并非其最佳选项，但对于有些类型的住务，它却也能够通过精心编排的周期性构建来避免资源冲突</p>
<p>周期性构建分为定时构建和轮询构建</p>
<p><img src="C:\Users\Lenovo\Desktop\img\243.jpg" alt="243"></p>
<ul>
<li>定时构建: 按时间周期性的触发构建</li>
<li>轮询SCM(Source Code Management): 指的是定期到代码仓库检查代码是否有变更，存在代码变更时就运行pipeline;为了能够从CI中得到更多的收益，轮询操作越频繁越好；显然，这会给SCM带去无谓的压力，所以构建的触发由SCM负责通知Jenkins最为理想；但在外部的SCM无法通知到局域网中的Jenkins时，可以采轮询SCM方式倒也不失为一种选择</li>
</ul>
<p>Jenkins cron语法遵循Unix cron语法的定义，但在细节上略有差别</p>
<p>一项cron的定义包含由空白字符或Tab分隔的5个字段，用于定义周期性的时间点</p>
<p>H 符号可用于任何字段，且它能够在一个时间范围内对项目名称进行散列值计算出一个唯一的偏移量，以避免所有配置相同cron值的项目在同一时间启动；比如:triggers { cron(H(0,30)) }</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Every fifteen minutes (perhaps at :07, :22, :37, :52):</span></span><br><span class="line">H/15 * * * *</span><br><span class="line"></span><br><span class="line"><span class="comment"># Every ten minutes in the first half of every hour (three times, perhaps at :04, :14, :24):</span></span><br><span class="line">H(0-29)/10 * * * *</span><br><span class="line"></span><br><span class="line"><span class="comment"># Once every two hours at 45 minutes past the hour starting at 9:45 AM and finishing at 3:45 PM every weekday:</span></span><br><span class="line">45 9-16/2 * * 1-5</span><br><span class="line"></span><br><span class="line"><span class="comment"># Once in every two hour slot between 8 AM and 4 PM every weekday (perhaps at 9:38 AM, 11:38 AM, 1:38 PM, 3:38 PM):</span></span><br><span class="line">H H(8-15)/2 * * 1-5</span><br><span class="line"></span><br><span class="line"><span class="comment"># Once a day on the 1st and 15th of every month except December:</span></span><br><span class="line">H H 1,15 1-11 *</span><br></pre></td></tr></table></figure>

<p>范例: 每小时构建</p>
<p><img src="C:\Users\Lenovo\Desktop\img\244.jpg" alt="244"></p>
<p>每3分钟构建一次，如:在2:55，2:58，3:01，3:04时间点进行构建</p>
<p><img src="C:\Users\Lenovo\Desktop\img\245.jpg" alt="245"></p>
<p>范例: 每分钟执行SCM 构建</p>
<p><img src="C:\Users\Lenovo\Desktop\img\246.jpg" alt="246"></p>
<p><strong>注意：SCM任务会在左侧多出一个“Git 轮询日志”，可以看到轮询的记录信息</strong> </p>
<p>观察Git 轮询日志可以看到当有变化时才会构建，否则不会执行构建</p>
<p><img src="C:\Users\Lenovo\Desktop\img\247.jpg" alt="247"><br><img src="C:\Users\Lenovo\Desktop\img\248.jpg" alt="248"></p>
<h3 id="构建-Webhook-触发器"><a href="#构建-Webhook-触发器" class="headerlink" title="构建 Webhook 触发器"></a>构建 Webhook 触发器</h3><p>构建触发器(webhook)，也称为钩子，实际上是一个HTTP回调，其用于在开发人员向gitlab提交代码后能够触发jenkins自动执行代码构建操作。</p>
<p><img src="C:\Users\Lenovo\Desktop\img\249.jpg" alt="249"></p>
<p>常见场景: 只有在开发人员向develop分支提交代码的时候会自动触发代码构建和部署至测试环境，而向主分支提交的代码不会自动构建，需要运维人员手动部署代码到生产环境。</p>
<p><img src="C:\Users\Lenovo\Desktop\img\250.jpg" alt="250"></p>
<p>可以使用下面两种方式实现 Webhook 触发构建</p>
<ul>
<li>触发远程构建: 此方式无需安装插件</li>
<li>Build when a change is pushed to GitLab. GitLab webhook URL: 需要安装插件</li>
</ul>
<h4 id="触发远程构建"><a href="#触发远程构建" class="headerlink" title="触发远程构建"></a>触发远程构建</h4><h5 id="Jenkins配置构建-Webhook-触发器"><a href="#Jenkins配置构建-Webhook-触发器" class="headerlink" title="Jenkins配置构建 Webhook 触发器"></a>Jenkins配置构建 Webhook 触发器</h5><p><img src="C:\Users\Lenovo\Desktop\img\251.jpg" alt="251"></p>
<p>生成WebHook 触发器链接</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://jenkins.wang.org:8080/job/hello-demo-go--auto-freestyle/build?token=666666</span><br></pre></td></tr></table></figure>

<h5 id="Jenkins-配置生成用户的-API-Token"><a href="#Jenkins-配置生成用户的-API-Token" class="headerlink" title="Jenkins 配置生成用户的 API Token"></a>Jenkins 配置生成用户的 API Token</h5><p>可以直接使用用户密码调用webhook，但是有泄露密码风险</p>
<p>可以对用户生成API Token，使用Token调用webhook，这样更加安全</p>
<p>先用创建用户</p>
<p><img src="C:\Users\Lenovo\Desktop\img\252.jpg" alt="252"></p>
<p>用此用户登录后，修改自已用户配置—添加API Token</p>
<p><img src="C:\Users\Lenovo\Desktop\img\253.jpg" alt="253"></p>
<p>注意: 此值是一次性的，所以必须立即复制Token</p>
<p>curl 命令测试触发并验证远程触发构建</p>
<ul>
<li>在任意主机使用图形化浏览器比如:chrome直接访问URL地址</li>
</ul>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://admin:&lt;token&gt;@jenkins.wang.org:8080/job/hello-world-war/build?token=666666</span><br></pre></td></tr></table></figure>

<ul>
<li>使用curl命令访问URL</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">curl http://admin:&lt;token&gt;@jenkins.wang.org:8080/job/hello-world-war/build?token=666666</span><br><span class="line"><span class="comment">#如果执行正常，则无任何显示</span></span><br></pre></td></tr></table></figure>

<h5 id="Jenkins-安装插件-旧版配置，新版不需要"><a href="#Jenkins-安装插件-旧版配置，新版不需要" class="headerlink" title="Jenkins 安装插件(旧版配置，新版不需要)"></a>Jenkins 安装插件(旧版配置，新版不需要)</h5><p>系统管理-管理插件-可选插件-Gitlab和Gitlab Hook 两个插件</p>
<p>注意事项：</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://jenkins.io/security/advisory/2018-05-09/#SECURITY-263</span><br></pre></td></tr></table></figure>

<p><img src="C:\Users\Lenovo\Desktop\img\254.jpg" alt="254"></p>
<ul>
<li>在 jenkins 系统管理–全局安全设置，认证改为登录用户可以做任何事情</li>
<li>取消跨站请求伪造保护</li>
<li>Gitlab Hook Plugin以纯文本形式存储和显示GitLab API令牌</li>
</ul>
<p><img src="C:\Users\Lenovo\Desktop\img\255.jpg" alt="255"><br><img src="C:\Users\Lenovo\Desktop\img\256.jpg" alt="256"></p>
<h5 id="Jenkins-修改相关配置-旧版才需安装，新版不需要"><a href="#Jenkins-修改相关配置-旧版才需安装，新版不需要" class="headerlink" title="Jenkins 修改相关配置(旧版才需安装，新版不需要)"></a>Jenkins 修改相关配置(旧版才需安装，新版不需要)</h5><h6 id="关闭角色授权策略"><a href="#关闭角色授权策略" class="headerlink" title="关闭角色授权策略"></a>关闭角色授权策略</h6><p><strong>注意: 必须不能使用角色授权策略，否则重启jenkins服务后会无法登录Jenkins，如下面错误</strong></p>
<p><img src="C:\Users\Lenovo\Desktop\img\257.jpg" alt="257"></p>
<p><strong>系统管理—全局安全设置</strong></p>
<p>确认选中”登录登录用户可以做任何事“</p>
<p><strong>新版界面</strong></p>
<p><img src="C:\Users\Lenovo\Desktop\img\258.jpg" alt="258"></p>
<p>旧版界面</p>
<p><img src="C:\Users\Lenovo\Desktop\img\259.jpg" alt="259"></p>
<p>保存以上配置</p>
<h6 id="修改CSRF配置"><a href="#修改CSRF配置" class="headerlink" title="修改CSRF配置"></a>修改CSRF配置</h6><p>Jenkins版本自2.204.6以来的重大变更有：删除禁用 CSRF 保护的功能。 从较旧版本的Jenkins 升级的实例将启用 CSRF 保护和设置默认的发行者，如果之前被禁用。则需要做下面配置</p>
<p>官方说明</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://www.jenkins.io/doc/book/security/csrf-protection/</span><br></pre></td></tr></table></figure>

<p>修改 jenkins配置</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@jenkins ~]<span class="comment"># vim /etc/default/jenkins</span></span><br><span class="line">....</span><br><span class="line">JAVA_ARGS=<span class="string">&quot;-Djava.awt.headless=true -Dhudson.security.csrf.GlobalCrumbIssuerConfiguration.DISABLE_CSRF_PROTECTION=true&quot;</span></span><br><span class="line">.....</span><br><span class="line"></span><br><span class="line">[root@jenkins ~]<span class="comment"># systemctl restart jenkins.service</span></span><br></pre></td></tr></table></figure>

<p>如果不配置此项，会有下面提示错误</p>
<p><img src="C:\Users\Lenovo\Desktop\img\260.jpg" alt="260"></p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">&quot;Content-Type&quot;</span> <span class="attr">content</span>=<span class="string">&quot;text/html;charset=utf-8&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">title</span>&gt;</span>Error 403 No valid crumb was included in the request<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span><span class="tag">&lt;<span class="name">h2</span>&gt;</span>HTTP ERROR 403 No valid crumb was included in the request<span class="tag">&lt;/<span class="name">h2</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">table</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">tr</span>&gt;</span><span class="tag">&lt;<span class="name">th</span>&gt;</span>URI:<span class="tag">&lt;/<span class="name">th</span>&gt;</span><span class="tag">&lt;<span class="name">td</span>&gt;</span>/job/testproject/build<span class="tag">&lt;/<span class="name">td</span>&gt;</span><span class="tag">&lt;/<span class="name">tr</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">tr</span>&gt;</span><span class="tag">&lt;<span class="name">th</span>&gt;</span>STATUS:<span class="tag">&lt;/<span class="name">th</span>&gt;</span><span class="tag">&lt;<span class="name">td</span>&gt;</span>403<span class="tag">&lt;/<span class="name">td</span>&gt;</span><span class="tag">&lt;/<span class="name">tr</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">tr</span>&gt;</span><span class="tag">&lt;<span class="name">th</span>&gt;</span>MESSAGE:<span class="tag">&lt;/<span class="name">th</span>&gt;</span><span class="tag">&lt;<span class="name">td</span>&gt;</span>No valid crumb was included in the request<span class="tag">&lt;/<span class="name">td</span>&gt;</span><span class="tag">&lt;/<span class="name">tr</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">tr</span>&gt;</span><span class="tag">&lt;<span class="name">th</span>&gt;</span>SERVLET:<span class="tag">&lt;/<span class="name">th</span>&gt;</span><span class="tag">&lt;<span class="name">td</span>&gt;</span>Stapler<span class="tag">&lt;/<span class="name">td</span>&gt;</span><span class="tag">&lt;/<span class="name">tr</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">table</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">hr</span>&gt;</span><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;https://eclipse.org/jetty&quot;</span>&gt;</span>Powered by Jetty:// 9.4.41.v20210516<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">hr</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><img src="C:\Users\Lenovo\Desktop\img\261.jpg" alt="261"></p>
<h5 id="Gitlab配置-Webhook"><a href="#Gitlab配置-Webhook" class="headerlink" title="Gitlab配置 Webhook"></a>Gitlab配置 Webhook</h5><h6 id="Gitlab配置-Webhook-1"><a href="#Gitlab配置-Webhook-1" class="headerlink" title="Gitlab配置 Webhook"></a>Gitlab配置 Webhook</h6><p>在gitlab服务器指定项目中创建webhook，输入下面网址</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">#方法1</span><br><span class="line">http://jenkins.wang.org:8080/job/hello-world-war/build?token=666666</span><br><span class="line">#方法2</span><br><span class="line">http://jenkins.wang.org:8080/job/hello-world-war/build</span><br><span class="line">在secret token处添写666666</span><br></pre></td></tr></table></figure>

<p><img src="C:\Users\Lenovo\Desktop\img\262.jpg" alt="262"></p>
<p>旧版如下</p>
<p><img src="C:\Users\Lenovo\Desktop\img\263.jpg" alt="263"></p>
<p>测试出现下面提示错误</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Hook execution failed: URL &#x27;http://jenkins.wang.org:8080/job/hello-world-war/build?token=666666&#x27; is blocked: Requests to the local network are not allowed</span><br></pre></td></tr></table></figure>

<p><img src="C:\Users\Lenovo\Desktop\img\264.jpg" alt="264"></p>
<h6 id="Gitlab-打开外发请求"><a href="#Gitlab-打开外发请求" class="headerlink" title="Gitlab 打开外发请求"></a>Gitlab 打开外发请求</h6><p><img src="C:\Users\Lenovo\Desktop\img\265.jpg" alt="265"></p>
<p>再次测试成功</p>
<p><img src="C:\Users\Lenovo\Desktop\img\266.jpg" alt="266"></p>
<p>gitlab配置 webhook</p>
<h5 id="测试调用-webhook"><a href="#测试调用-webhook" class="headerlink" title="测试调用 webhook"></a>测试调用 webhook</h5><p>注意: 需要取消<code>启用SSL验证</code></p>
<p><img src="C:\Users\Lenovo\Desktop\img\267.jpg" alt="267"><br><img src="C:\Users\Lenovo\Desktop\img\268.jpg" alt="268"></p>
<h5 id="提交代码自动触发-webhook执行"><a href="#提交代码自动触发-webhook执行" class="headerlink" title="提交代码自动触发 webhook执行"></a>提交代码自动触发 webhook执行</h5><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@gitlab hello-world-war]<span class="comment"># sed -i &quot;s/v[0-9].0/$ver/&quot; src/main/webapp/index.jsp</span></span><br><span class="line">[root@gitlab hello-world-war]<span class="comment"># ver=v1.0;git add .;git commit -m $ver;git push</span></span><br></pre></td></tr></table></figure>

<p><img src="C:\Users\Lenovo\Desktop\img\269.jpg" alt="269"><br><img src="C:\Users\Lenovo\Desktop\img\270.jpg" alt="270"></p>
<h4 id="GitLab-Webhook-URL"><a href="#GitLab-Webhook-URL" class="headerlink" title="GitLab Webhook URL"></a>GitLab Webhook URL</h4><h5 id="Jenkins-安装-GitLab-插件"><a href="#Jenkins-安装-GitLab-插件" class="headerlink" title="Jenkins 安装 GitLab 插件"></a>Jenkins 安装 GitLab 插件</h5><p>没有安装 GitLab 插件，默认无此选项功能</p>
<p><img src="C:\Users\Lenovo\Desktop\img\271.jpg" alt="271"><br><img src="C:\Users\Lenovo\Desktop\img\272.jpg" alt="272"></p>
<h5 id="Jenkins-创建和配置任务"><a href="#Jenkins-创建和配置任务" class="headerlink" title="Jenkins 创建和配置任务"></a>Jenkins 创建和配置任务</h5><p><img src="C:\Users\Lenovo\Desktop\img\273.jpg" alt="273"></p>
<h5 id="配置-Gitlab-Webhook"><a href="#配置-Gitlab-Webhook" class="headerlink" title="配置 Gitlab Webhook"></a>配置 Gitlab Webhook</h5><p>在gitlab 上对应代码库做以下配置</p>
<p><img src="C:\Users\Lenovo\Desktop\img\274.jpg" alt="274"></p>
<p>测试</p>
<p><img src="C:\Users\Lenovo\Desktop\img\275.jpg" alt="275"></p>
<p>出现下面提示错误</p>
<p><img src="C:\Users\Lenovo\Desktop\img\276.jpg" alt="276"></p>
<h5 id="配置-Gitlab-打开外发请求"><a href="#配置-Gitlab-打开外发请求" class="headerlink" title="配置 Gitlab 打开外发请求"></a>配置 Gitlab 打开外发请求</h5><p><img src="C:\Users\Lenovo\Desktop\img\277.jpg" alt="277"></p>
<p>再次测试成功</p>
<p><img src="C:\Users\Lenovo\Desktop\img\278.jpg" alt="278"></p>
<h5 id="验证结果-1"><a href="#验证结果-1" class="headerlink" title="验证结果"></a>验证结果</h5><p>修改代码并提交仓库</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@gitlab testproject]<span class="comment"># echo $ver &gt; index.html</span></span><br><span class="line">[root@gitlab testproject]<span class="comment"># ver=v6.0;git add .; git commit -m $ver;git push</span></span><br></pre></td></tr></table></figure>

<p><img src="C:\Users\Lenovo\Desktop\img\279.jpg" alt="279"></p>
<h2 id="构建前后多个项目关联自动触发任务执行"><a href="#构建前后多个项目关联自动触发任务执行" class="headerlink" title="构建前后多个项目关联自动触发任务执行"></a>构建前后多个项目关联自动触发任务执行</h2><p>用于多个 Job 相互关联，需要同行执行多个job的场景，比如:如果job1后希望自动构建job2</p>
<p>可以用两种方法实现</p>
<ul>
<li>在前面任务中利用构建后操作关联后续任务</li>
<li>在后面任务中利用构建触发器关联前面任务</li>
</ul>
<p>注意:上面两种方法，都需要在前面任务执行后才能自动关联执行后续任务</p>
<h3 id="在前面任务里配置构建后操作"><a href="#在前面任务里配置构建后操作" class="headerlink" title="在前面任务里配置构建后操作"></a>在前面任务里配置构建后操作</h3><p>在先执行的任务中配置构建后操作实现</p>
<h4 id="创建构建后操作"><a href="#创建构建后操作" class="headerlink" title="创建构建后操作"></a>创建构建后操作</h4><p>在第一个要执行的任务，指定构建后操作，添加第二个任务</p>
<p>要构建的项目可以填写多个项目名，之间用逗号分隔即可</p>
<p><img src="C:\Users\Lenovo\Desktop\img\280.jpg" alt="280"><br><img src="C:\Users\Lenovo\Desktop\img\281.jpg" alt="281"></p>
<h4 id="创建后面的任务"><a href="#创建后面的任务" class="headerlink" title="创建后面的任务"></a>创建后面的任务</h4><p><img src="C:\Users\Lenovo\Desktop\img\282.jpg" alt="282"><br><img src="C:\Users\Lenovo\Desktop\img\283.jpg" alt="283"><br><img src="C:\Users\Lenovo\Desktop\img\284.jpg" alt="284"><br><img src="C:\Users\Lenovo\Desktop\img\285.jpg" alt="285"><br><img src="C:\Users\Lenovo\Desktop\img\286.jpg" alt="286"><br><img src="C:\Users\Lenovo\Desktop\img\287.jpg" alt="287"></p>
<h4 id="验证构建后操作"><a href="#验证构建后操作" class="headerlink" title="验证构建后操作"></a>验证构建后操作</h4><p>执行第一个job，验证后面的job自动执行</p>
<p><img src="C:\Users\Lenovo\Desktop\img\288.jpg" alt="288"></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@jenkins ~]<span class="comment"># cat /tmp/jobs.log </span></span><br><span class="line">test-job1</span><br><span class="line">test-job2</span><br><span class="line">test-job3</span><br></pre></td></tr></table></figure>

<p><img src="C:\Users\Lenovo\Desktop\img\289.jpg" alt="289"><br><img src="C:\Users\Lenovo\Desktop\img\290.jpg" alt="290"><br><img src="C:\Users\Lenovo\Desktop\img\291.jpg" alt="291"></p>
<h3 id="在后面构建的任务里创建"><a href="#在后面构建的任务里创建" class="headerlink" title="在后面构建的任务里创建"></a>在后面构建的任务里创建</h3><h4 id="在后续构建的任务里利用构建触发器实现"><a href="#在后续构建的任务里利用构建触发器实现" class="headerlink" title="在后续构建的任务里利用构建触发器实现"></a>在后续构建的任务里利用构建触发器实现</h4><p>在后面的 job 配置如下</p>
<p>在构建触发器—Build after other project are built — 关注的项目 — 输入前面的 job，如果有多个job 用逗号分隔</p>
<p><img src="C:\Users\Lenovo\Desktop\img\292.jpg" alt="292"><br><img src="C:\Users\Lenovo\Desktop\img\293.jpg" alt="293"><br><img src="C:\Users\Lenovo\Desktop\img\294.jpg" alt="294"><br><img src="C:\Users\Lenovo\Desktop\img\295.jpg" alt="295"><br><img src="C:\Users\Lenovo\Desktop\img\296.jpg" alt="296"></p>
<h4 id="验证结果-2"><a href="#验证结果-2" class="headerlink" title="验证结果"></a>验证结果</h4><p>执行test-job1</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@jenkins ~]<span class="comment"># cat /tmp/jobs.log </span></span><br><span class="line">test-job1</span><br><span class="line">test-job3</span><br></pre></td></tr></table></figure>

<p><img src="C:\Users\Lenovo\Desktop\img\297.jpg" alt="297"></p>
<p>执行 test-job2</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@jenkins ~]<span class="comment"># cat /tmp/jobs.log </span></span><br><span class="line">test-job1</span><br><span class="line">test-job3</span><br><span class="line">test-job2</span><br><span class="line">test-job3</span><br></pre></td></tr></table></figure>

<p><img src="C:\Users\Lenovo\Desktop\img\298.jpg" alt="298"></p>
<h2 id="Blue-Ocean-插件实现可视化"><a href="#Blue-Ocean-插件实现可视化" class="headerlink" title="Blue Ocean 插件实现可视化"></a>Blue Ocean 插件实现可视化</h2><p><img src="C:\Users\Lenovo\Desktop\img\299.jpg" alt="299"></p>
<p>Blue Ocean 插件可以实现更加漂亮的可视化界面，并且可以对指定的步骤进行重启等操作</p>
<h3 id="安装-Blue-Ocean-插件"><a href="#安装-Blue-Ocean-插件" class="headerlink" title="安装 Blue Ocean 插件"></a>安装 Blue Ocean 插件</h3><p>注意: 安装完插件，需要重启Jenkins才能生效</p>
<p><img src="C:\Users\Lenovo\Desktop\img\300.jpg" alt="300"></p>
<h3 id="使用-Blue-Ocean"><a href="#使用-Blue-Ocean" class="headerlink" title="使用 Blue Ocean"></a>使用 Blue Ocean</h3><p><img src="C:\Users\Lenovo\Desktop\img\301.jpg" alt="301"></p>
<p>可以看到每个Job的执过状态，并可以选择构建中的部分步骤进行执行</p>
<p><img src="C:\Users\Lenovo\Desktop\img\302.jpg" alt="302"><br><img src="C:\Users\Lenovo\Desktop\img\303.jpg" alt="303"></p>
<h1 id="Jenkins-的高级功能"><a href="#Jenkins-的高级功能" class="headerlink" title="Jenkins 的高级功能"></a>Jenkins 的高级功能</h1><h2 id="Jenkins-分布式"><a href="#Jenkins-分布式" class="headerlink" title="Jenkins 分布式"></a>Jenkins 分布式</h2><p>Jenkins 分布式即将Jenkins的任务进行分布式处理</p>
<h3 id="Jenkins-分布式说明"><a href="#Jenkins-分布式说明" class="headerlink" title="Jenkins 分布式说明"></a>Jenkins 分布式说明</h3><h4 id="Jenkins-分布式相关概念"><a href="#Jenkins-分布式相关概念" class="headerlink" title="Jenkins 分布式相关概念"></a>Jenkins 分布式相关概念</h4><p><img src="C:\Users\Lenovo\Desktop\img\304.jpg" alt="304"></p>
<p>在众多 Job 的场景下，单台 Jenkins Master 同时执行代码 clone、编译、打包及构建，其性能可能会出现瓶颈从而会影响代码部署效率</p>
<p>Jenkins官方提供了 Jenkins 分布式构建，将众多job分散运行到不同的 Jenkins slave节点，大幅提高并行job的处理能力。除此之外，还可以针对不同的开发环境分配至不同的Slave实现编译部署</p>
<p>比如:Java程序分配至Slave1，Go程序的编译分配给Slave2，Nodejs程序分配给Slave3</p>
<p>在 Jenkins 2 中，节点是一个基础概念，代表了任何可以执行 Jenkins 任务的系统</p>
<p>采用 master/agent 架构，因而其节点可划分主节点(master)和代理节点(agent)两种类型，，代理节点也被称为从节点(slave)</p>
<p>主节点负责提供UI、处理HTTP请求及管理构建环境等，而代理节点则主要负责执行构建任务</p>
<ul>
<li><p>主节点Master/Controller: Jenkins的一个部署实例的核心控制系统，它能够完全访问所有Jenkins配置的选项和任务（job)列表，而且，若不存在其他代理节点，主节点也是默认的任务执行节点</p>
</li>
<li><p>代理节点Slave/Agent:在早先版本的Jenkins中，代理节点 (agent)也被称为从节点(slave)，它代表着所有的非主节点</p>
<p>这类节点由主节点管理，按需分配或指定执行特定的任务，例如不同的构建任务或测试</p>
<p>脚本式流水线中，节点特指一个运行代理节点的系统，而在声明式流水线中，它则是分配的一个作为代理节点的特定节点</p>
<p>可以分为静态和动态两种</p>
<ul>
<li><p>静态Agent：</p>
<p>以daemon形式运行的Jenkins；每个Agent可以存在多个Executor，具体的数量应该根据Agent所在主机的系统资源来设定</p>
<p>(1) Linux Jenkins (2) Windows Jenkins (3) Jenkins Container </p>
<p>注意：很多的构建步骤，有可能会通过运行shell命令进行，于是此时要确保在Container内部有可用的命令；</p>
</li>
<li><p>动态Agent：</p>
<p>由Controller按Job的运行需要临时创建，且Job运行结束后会删除；可以把每个Agent视作一个动态的Executor；</p>
<p>依赖的环境：云，支持由Jenkins Controller通过API调用</p>
<p>(1) Docker Plugin </p>
<p>基于配置的Docker Host，按需要创建容器运行Agent，需要事先配置好容器模板</p>
<p>(2) Kubernetes Plugin </p>
<p>基于配置的Kubernets，按需要创建Pod运行Agent，需要事先配置Pod模板</p>
<p>Jenkins 自身既可以部署在k8s上，也完全可以运行在k8s外</p>
</li>
</ul>
</li>
<li><p>执行器（Executor):简单来说，Executor只是节点或代理节点用于执行任务的一个糟位</p>
<p>Executor的数量定义了该节点可以执行的并发任务量，一个节点上可以有任务数量的糟位，但也允行管理员按节点资源定义合适的数量</p>
<p>在主节点将任务分配给特定节点时，该节点上必须有可用的Executor来立即执行该任务，否则、只能等到有空闲槽位可用</p>
</li>
</ul>
<p><img src="C:\Users\Lenovo\Desktop\img\305.jpg" alt="305"></p>
<h4 id="Jenkins-主从架构图"><a href="#Jenkins-主从架构图" class="headerlink" title="Jenkins 主从架构图"></a>Jenkins 主从架构图</h4><p><img src="C:\Users\Lenovo\Desktop\img\306.jpg" alt="306"></p>
<h4 id="节点标签"><a href="#节点标签" class="headerlink" title="节点标签"></a>节点标签</h4><p>Jenkins中的标签(tag)指的是节点上的标识符，而后可由pipeline中的agent指令等进行过滤和选择节点执行</p>
<p>当Agent节点较多时，基于方便管理的目的，通常应该给这些节点添加能够体现其某种特性或功能的标签，以便于在构建任务中能基于标签过滤出符合条件的agent来</p>
<p>一个 Agent 上可添加多个标签，一个标签也可以添加至多个 Agent</p>
<p>标签名称不允许使用空白字符，也不允许使用标签表达式中预留的关键字，例如: !、&amp;、|、&lt;、&gt;、) 和（等</p>
<p>常用的标签纬度有如下几个</p>
<ul>
<li>操作系统类型: Linux、Windows、MacOS</li>
<li>操作系统位数: 32bit、64bit</li>
<li>集成的工具链: jdk、Go、Python、Nodejs等</li>
</ul>
<p>可以在作业中通过标签表达式实现Agent的过滤</p>
<p>标签表达式（label expressions）支持如下操作符</p>
<ul>
<li><p>!expression：表达式条件取反</p>
</li>
<li><p>a &amp;&amp; b：表达式间“与” 关系</p>
</li>
<li><p>a || b：表达式间“或” 关系</p>
</li>
<li><p>a -&gt;b：等同于 “!a || b”，意味着如果满足a表达式，则同时必须满足b表达式;</p>
<p>例如，linux -&gt; x64，意味着，如果操作系统为linux，则它也必须是x64的系统环境，如果不是linux，则无要求必须是x64</p>
</li>
<li><p>a&lt;-&gt;b：表示两个条件要么同时满足，要么同时都不满足，即等同“a &amp;&amp; b || !a &amp;&amp; !b”</p>
</li>
<li><p>(expression)：表达式分组，常在需要改变操作符间的优先级顺序时使用</p>
</li>
</ul>
<h4 id="Jenkins-与-Agent之间的通信方式"><a href="#Jenkins-与-Agent之间的通信方式" class="headerlink" title="Jenkins 与 Agent之间的通信方式"></a>Jenkins 与 Agent之间的通信方式</h4><p><strong>SSH连接：</strong></p>
<p>Agent端是SSH Server端</p>
<p>认证方式：应该在Controller端保存认证信息为Credential，可以口令认证和密钥认证</p>
<p>运行者身份：普通用户jenkins，/home/jenkins/agent目录，作为Agent端的工作目录</p>
<p>Controller ssh client –&gt; Agent ssh server</p>
<p><strong>JNLP连接：</strong></p>
<p>JNLP-HTTP连接器</p>
<p>在agent上以手动或系统服务的方式经由JNLP协议触发双向连接的建立</p>
<p>要求：Controller端额外提供一个套接字以接收连接请求，默认使用tcp协议的50000端口，也支持使用随机端口（安全，问题是会对服务端在防火墙开放该端口造成困扰），也可以使用websocket，基于默认8080端口建立集群通信连接 </p>
<p>Controller jnlp server &lt;– Agent jnlp client</p>
<p><strong>在Controller上远程运行命令启动Agent(Launch agent via execution of command on the controller)</strong></p>
<h4 id="以Docker-方式运行-Agent"><a href="#以Docker-方式运行-Agent" class="headerlink" title="以Docker 方式运行 Agent"></a>以Docker 方式运行 Agent</h4><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">https://hub.docker.com/r/jenkins/inbound-agent</span><br><span class="line">https://hub.docker.com/r/jenkins/ssh-agent</span><br></pre></td></tr></table></figure>

<h3 id="实战案例-实现-Jenkins-分布式"><a href="#实战案例-实现-Jenkins-分布式" class="headerlink" title="实战案例: 实现 Jenkins 分布式"></a>实战案例: 实现 Jenkins 分布式</h3><p><img src="C:\Users\Lenovo\Desktop\img\307.jpg" alt="307"></p>
<h4 id="Slave-节点安装-Java-等环境确保和-Master-环境一致"><a href="#Slave-节点安装-Java-等环境确保和-Master-环境一致" class="headerlink" title="Slave 节点安装 Java 等环境确保和 Master 环境一致"></a>Slave 节点安装 Java 等环境确保和 Master 环境一致</h4><p>Slave 节点通过从Master节点自动下载的基于 JAVA 的 remoting.jar 程序包实现，所以需要安装JDK</p>
<p>Slave服务器需要创建与Master相同的数据目录，因为脚本中调用的路径只有相对于Master的一个路径，此路径在master与各node节点应该保持一致。任务中执行的脚本存放的路径和master也必须一致.</p>
<p>如果Slave需要执行编译或执行特定的job，则也需要配置Java或其它语言环境，安装 git、maven、go、ansible等与master相同的基础运行环境</p>
<p><strong>注意： Jenkins Agent 和 Master 的环境尽可能一致，包括软件的版本，路径，脚本，ssh key验证等</strong> </p>
<p>范例：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#在两个slave主机上执行下面操作，安装jdk</span></span><br><span class="line"><span class="comment">#新版jenkins安装JDK11</span></span><br><span class="line">[root@jenkins-slave1-ubuntu ~]<span class="comment"># apt -y install openjdk-11-jdk </span></span><br><span class="line">openjdk version <span class="string">&quot;11.0.17&quot;</span> 2022-10-18</span><br><span class="line">OpenJDK Runtime Environment (build 11.0.17+8-post-Ubuntu-1ubuntu222.04)</span><br><span class="line">OpenJDK 64-Bit Server VM (build 11.0.17+8-post-Ubuntu-1ubuntu222.04, mixed mode, sharing)</span><br><span class="line"></span><br><span class="line"><span class="comment">#旧版jenkins安装JDK8</span></span><br><span class="line">[root@jenkins-slave1-ubuntu ~]<span class="comment"># apt -y install openjdk-8-jdk </span></span><br><span class="line">[root@jenkins-slave1-ubuntu ~]<span class="comment"># java -version</span></span><br><span class="line">openjdk version <span class="string">&quot;1.8.0_242&quot;</span></span><br><span class="line">OpenJDK Runtime Environment (build 1.8.0_242-8u242-b08-0ubuntu3~18.04-b08)</span><br><span class="line">OpenJDK 64-Bit Server VM (build 25.242-b08, mixed mode)</span><br><span class="line"></span><br><span class="line"><span class="comment">#创建数据目录，可以不创建，会自动创建</span></span><br><span class="line">[root@jenkins-slave1-ubuntu ~]<span class="comment"># mkdir -p /var/lib/jenkins </span></span><br><span class="line"></span><br><span class="line"><span class="comment">#如果需要执行特定任务，还需要安装相关的工具</span></span><br><span class="line">[root@jenkins-slave1-ubuntu ~]<span class="comment"># apt -y install git maven golang ansible</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#名称解析要和jenkins服务器一致</span></span><br><span class="line">[root@jenkins-slave1-ubuntu ~]<span class="comment"># cat /etc/hosts</span></span><br><span class="line">10.0.0.100 gitlab.wang.org</span><br><span class="line">10.0.0.101 jenkins.wang.org</span><br><span class="line"></span><br><span class="line"><span class="comment">#生成ssh key，并复制公钥到Gitlab的相关联的用户</span></span><br><span class="line">[root@jenkins-slave1-ubuntu ~]<span class="comment"># ssh-keygen</span></span><br><span class="line">[root@jenkins-slave1-ubuntu ~]<span class="comment"># cat .ssh/id_rsa.pub</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#如果需要和其它主机基于SSH key连接，还需复制公钥到其它主机</span></span><br><span class="line">[root@jenkins-slave1-ubuntu ~]<span class="comment"># ssh-copy-id web01</span></span><br><span class="line">[root@jenkins-slave1-ubuntu ~]<span class="comment"># ssh-copy-id web02</span></span><br></pre></td></tr></table></figure>

<p><img src="C:\Users\Lenovo\Desktop\img\308.jpg" alt="308"></p>
<h4 id="Master-节点安装插件"><a href="#Master-节点安装插件" class="headerlink" title="Master 节点安装插件"></a>Master 节点安装插件</h4><p>安装 <strong>SSH Build Agents</strong> 插件，实现 ssh 连接代理</p>
<p><img src="C:\Users\Lenovo\Desktop\img\309.jpg" alt="309"></p>
<h4 id="添加-Master-访问-Slave-认证凭据"><a href="#添加-Master-访问-Slave-认证凭据" class="headerlink" title="添加 Master 访问 Slave 认证凭据"></a>添加 Master 访问 Slave 认证凭据</h4><p>用于 Master 连接 Slave 节点的凭据</p>
<p>可以是用户密码的凭据，也可以配置Master节点到Slave节点SSH key 验证</p>
<p>以root 身份连接 Agent</p>
<p>如果已经实现ssh key 验证，下面可以不配置</p>
<p><img src="C:\Users\Lenovo\Desktop\img\310.jpg" alt="310"></p>
<h4 id="添加-Slave-节点"><a href="#添加-Slave-节点" class="headerlink" title="添加 Slave 节点"></a>添加 Slave 节点</h4><p>注意: 主从节点的时间要同步</p>
<p>Jenkins—系统管理—节点管理—新建节点：</p>
<p>添加slave节点：</p>
<p><img src="C:\Users\Lenovo\Desktop\img\311.jpg" alt="311"><br><img src="C:\Users\Lenovo\Desktop\img\312.jpg" alt="312"><br><img src="C:\Users\Lenovo\Desktop\img\313.jpg" alt="313"></p>
<p><strong>Jenkins Slave 信息</strong> </p>
<p>名称用于唯一的标识Agent</p>
<p>注意: 只有 Jenkins 提前安装SSH Build Agents插件，才能出现Launch agents via SSH选项</p>
<p>Slave节点的远程工作目录建议和Master相同，且此目录不存在也可以自动生成</p>
<p>标签用于过滤Agent，如果有多个标签，则用空格分隔</p>
<p><img src="C:\Users\Lenovo\Desktop\img\314.jpg" alt="314"></p>
<p>如果需要Slave执行相关任务，还需要安装工具，并指定相关工具路径如下</p>
<p><img src="C:\Users\Lenovo\Desktop\img\315.jpg" alt="315"></p>
<h4 id="查看-Jenkins-Slave-创建日志"><a href="#查看-Jenkins-Slave-创建日志" class="headerlink" title="查看 Jenkins Slave 创建日志"></a>查看 Jenkins Slave 创建日志</h4><p><img src="C:\Users\Lenovo\Desktop\img\316.jpg" alt="316"></p>
<h4 id="故障排错"><a href="#故障排错" class="headerlink" title="故障排错"></a>故障排错</h4><p>如果 slave 没有 java 相应的环境则报错</p>
<p><img src="C:\Users\Lenovo\Desktop\img\317.jpg" alt="317"></p>
<p><strong>解决上面错误提示</strong></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@jenkins-slave1-ubuntu ~]<span class="comment"># mkdir -p /var/lib/jenkins/jdk/bin/</span></span><br><span class="line">[root@jenkins-slave1-ubuntu ~]<span class="comment"># ln -s /usr/bin/java /var/lib/jenkins/jdk/bin/</span></span><br></pre></td></tr></table></figure>

<h4 id="验证-Slave-Web-状态"><a href="#验证-Slave-Web-状态" class="headerlink" title="验证 Slave Web 状态"></a>验证 Slave Web 状态</h4><p>正常状态：</p>
<p><img src="C:\Users\Lenovo\Desktop\img\318.jpg" alt="318"></p>
<p>如果Slave节点和Master节点时间不同步会出现如下状态</p>
<p><img src="C:\Users\Lenovo\Desktop\img\319.jpg" alt="319"></p>
<h4 id="验证-Slave-进程状态"><a href="#验证-Slave-进程状态" class="headerlink" title="验证 Slave 进程状态"></a>验证 Slave 进程状态</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root@jenkins-slave1-ubuntu ~]<span class="comment"># ps aux|grep jenkins</span></span><br><span class="line">root      59778  2.1  8.0 2263020 79068 ?       Ssl  21:05   0:11 java -jar remoting.jar -workDir /var/lib/jenkins -jar-cache /var/lib/jenkins/remoting/jarCache</span><br><span class="line">root      59911  0.0  0.1  14428  1012 pts/0   S+   21:13   0:00 grep --color=auto jenkins</span><br><span class="line"></span><br><span class="line">[root@jenkins-slave1-ubuntu ~]<span class="comment"># ls /var/lib/jenkins</span></span><br><span class="line">remoting remoting.jar</span><br><span class="line"></span><br><span class="line">[root@jenkins-ubuntu ~]<span class="comment"># ss -nt</span></span><br><span class="line">State Recv-Q   Send-Q Local Address:Port     Peer Address:Port      </span><br><span class="line">ESTAB  0        0          10.0.0.101:22           10.0.0.1:3307             </span><br><span class="line">ESTAB  0        0          10.0.0.101:48588        10.0.0.102:22</span><br></pre></td></tr></table></figure>

<h4 id="建立后续的其它节点"><a href="#建立后续的其它节点" class="headerlink" title="建立后续的其它节点"></a>建立后续的其它节点</h4><p>重复上面的过程，建立其它的从节点</p>
<p><strong>小技巧</strong>: 可以将复制Slave1节点的/root/.ssh目录到Slave2，从而可以省略 Slave2到其它主机的 Ssh key验证过程</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@jenkins-slave2-ubuntu ~]<span class="comment"># apt -y install openjdk-8.jdk</span></span><br></pre></td></tr></table></figure>

<p><img src="C:\Users\Lenovo\Desktop\img\320.jpg" alt="320"><br><img src="C:\Users\Lenovo\Desktop\img\321.jpg" alt="321"><br><img src="C:\Users\Lenovo\Desktop\img\322.jpg" alt="322"><br><img src="C:\Users\Lenovo\Desktop\img\323.jpg" alt="323"><br><img src="C:\Users\Lenovo\Desktop\img\324.jpg" alt="324"><br><img src="C:\Users\Lenovo\Desktop\img\325.jpg" alt="325"></p>
<h4 id="指定任务运行的节点"><a href="#指定任务运行的节点" class="headerlink" title="指定任务运行的节点"></a>指定任务运行的节点</h4><p>注意事项:</p>
<ul>
<li>指定slave节点运行任务，可能会需要配置到gitlab服务和web服务器的ssh key验证</li>
<li>如果需要执行脚本，还需要复到jenkins服务器的脚本到slave节点</li>
</ul>
<p><img src="C:\Users\Lenovo\Desktop\img\326.jpg" alt="326"></p>
<h2 id="Jenkins-Pipeline"><a href="#Jenkins-Pipeline" class="headerlink" title="Jenkins Pipeline"></a>Jenkins Pipeline</h2><h3 id="Pipeline-介绍"><a href="#Pipeline-介绍" class="headerlink" title="Pipeline 介绍"></a>Pipeline 介绍</h3><p><img src="C:\Users\Lenovo\Desktop\img\327.jpg" alt="327"><br><img src="C:\Users\Lenovo\Desktop\img\328.jpg" alt="328"></p>
<p>官方帮助: </p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">https://www.jenkins.io/zh/doc/book/pipeline/</span><br><span class="line">https://www.jenkins.io/doc/book/pipeline/</span><br><span class="line">https://www.jenkins.io/2.0/</span><br></pre></td></tr></table></figure>

<p>Pipeline基于Groovy DSL(领域特定语言Domain Specific Language )实现，任何发布流程都可以表述为一段Groovy脚本。</p>
<p>Groovy是一种基于JVM虚拟机的敏捷开发语言，它结合了Python、Ruby和Smalltalk的许多强大的特性，Groovy 是用Java写的 ， Groovy语法与Java语法类似，</p>
<p>Groovy 代码不仅能够与 Java 代码很好地结合，也能用于扩展现有代码。由于其运行在 JVM 上的特性，Groovy也可以使用其他非Java语言编写的库</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Groovy官网:http://www.groovy-lang.org/learn.html</span><br><span class="line">Groovy语法:http://groovy-lang.org/syntax.html</span><br></pre></td></tr></table></figure>

<p><img src="C:\Users\Lenovo\Desktop\img\329.jpg" alt="329"></p>
<p><strong>流水线和自由风格任务流程比较</strong></p>
<p><img src="C:\Users\Lenovo\Desktop\img\330.jpg" alt="330"></p>
<h3 id="Pipeline-优势"><a href="#Pipeline-优势" class="headerlink" title="Pipeline 优势"></a>Pipeline 优势</h3><p><img src="C:\Users\Lenovo\Desktop\img\331.jpg" alt="331"></p>
<p>一致性: Pipeline 用统一语法的代码的方式实现各个CICD的阶段的任务，不仅可以被纳入版本控制，还可以通过编辑代码实现目标效果</p>
<p>直观性: 构建过程中每一步都可以直接的图形化显示输出，比如每个阶段的执行时间，直观友好，pipeline 帮助我们快速的定位哪个阶段的任务出现错误</p>
<p>可持续性：Jenkins的重启或者中断后不影响已经执行的pipeline Job</p>
<p>支持暂停：Pipeline可以选择停止并等待人工输入或批准后再继续执行</p>
<p>支持回放: 如果失败，可以使用回放，进行临时性的修改 job ，再调试执行，如果成功，再真正修改任务即可</p>
<p>可扩展：通过Groovy的编程更容易的扩展插件</p>
<p>并行执行：通过Groovy脚本可以实现step，stage间的并行执行，和更复杂的相互依赖关系</p>
<p>多功能：支持复杂CD要求，包括fork/join子进程，条件判断，循环和并行执行工作的能力</p>
<h3 id="Pipeline-语法"><a href="#Pipeline-语法" class="headerlink" title="Pipeline 语法"></a>Pipeline 语法</h3><h4 id="Pipeline-语法介绍和结构"><a href="#Pipeline-语法介绍和结构" class="headerlink" title="Pipeline 语法介绍和结构"></a>Pipeline 语法介绍和结构</h4><p>官方文档</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">https://www.jenkins.io/zh/doc/book/pipeline/syntax/</span><br><span class="line">http://www.jenkins.io/doc/book/pipeline/syntax/</span><br><span class="line">http://www.jenkins.io/doc/pipeline/steps/</span><br></pre></td></tr></table></figure>

<p>当前 Jenkins 2.X 支持两种语法的流水线： 脚本式和声明式</p>
<ul>
<li><p>脚本式Scripted Pipeline语法</p>
<p>此语法是 Jenkins最先支持pipeline语法，采用命令式风格，直接在流水线脚本中定义逻辑和程序流程</p>
</li>
<li><p>声明式Declarative Pipeline语法</p>
<p>后来CloudBees公司为Jenkins引入的一种“流水线即代码”的pipeline语法 </p>
<p>它允许用户在pipeline的定义中将更多的精力关注于期望pipeline的状态和输出之上，而非实现逻辑</p>
</li>
</ul>
<p>声明式和脚本化的流水线从根本上是不同的。 声明式流水线的是 Jenkins 流水线更新一些的特性:</p>
<ul>
<li>相比脚本化的流水线语法，它提供更丰富的语法特性</li>
<li>是为了使编写和读取流水线代码更容易而设计的</li>
</ul>
<p><strong>Pipeline 的基本结构</strong></p>
<ul>
<li><p>pipeline</p>
<p>流水线的最外层结构，代表整条pipeline，包含着pipeline的完整逻辑;是声明式流水线语法的关健特征</p>
</li>
<li><p>node 和 agent</p>
<p>用于定义任务在哪里执行 每个node都是一个 Jenkins 节点，可以是 Jenkins master也可以是 Jenkins agent，node是执行step的具体服务器。</p>
<p>node 代码块也是脚本式pipeline语法的关健特性，声明式pipeline使用 agent 关健字 </p>
</li>
<li><p>stages</p>
<p>用于包含所有stage的定义</p>
</li>
<li><p>stage</p>
<p>属于stages的子语句块</p>
<p>指定 stage 的名称， 用于定义每个阶段 stage 的主要任务</p>
<p>一个pipeline可以划分为若干个stage，每个stage都是一个完整的操作，比如: clone代码、代码编译、代码测试和代码部署，阶段是一个逻辑分组，可以跨多个node执行。</p>
</li>
<li><p>steps</p>
<p>属于stage的子语句块</p>
<p>每个阶段stage中定义完成该阶段功能所需要经历的一系列步骤</p>
<p>步骤 steps 是jenkins pipeline最基本的操作单元，从在服务器创建目录到构建容器镜像，由各类 Jenkins 插件提供实现，例如： sh “make”</p>
<p>能够把这些步骤steps 同该stage中的其它定义（如环境的定义，Post 等）分隔开</p>
</li>
<li><p>post</p>
<p>用在stage 代码块（和steps 同级）或整个pipeline执行完成后的附加步骤，此指令非必须项</p>
</li>
</ul>
<p><strong>Jenkins Pipeline 支持常用指令</strong></p>
<p>无论是脚本式语法还是声明式语法，他们本质上都是执行各种命令，对于不同的命令需要采用专用的语法来实现指定的功能，常见的语法命令及其样式如下:</p>
<ul>
<li><p>echo: 输出信息， <code>echo &quot;Building&quot;</code></p>
</li>
<li><p>sh: 执行命令，<code>sh &#39;command&#39; sh([script: &#39;echo hello&#39;])</code>，用三个单号可以支持多行命令，即：<code>sh  &#39;&#39;&#39; 多行shell命令 &#39;&#39;&#39;</code></p>
</li>
<li><p>git: 克隆代码，<code>git branch: &#39;develop&#39;, credentialsId: &#39;d7e3bd&#39;, url:  &#39;git@10.0.0.100:magedu/app1.git&#39;</code></p>
</li>
<li><p>env: 设置变量， <code>env.PATH=&quot;/usr/local/java/bin:$PATH&quot;</code></p>
</li>
<li><p>environmet:设定环境变量，可用于stage或pipeline代码块中;支持credentialsl)函数，用于通过标识符访问预定义的凭证</p>
</li>
<li><p>tools:指定需要在agent上下载并配置的工具，例如git、maven、jdk等，这些工具可经由PATH环境变量指定的位置访问到;可用于stage或pipeline中</p>
</li>
<li><p>parameters:用户在触发pipeline时应该提供的参数列表;仅可用于pipeline级别</p>
</li>
<li><p>options:仅可用在pipeline级别来配置pipeline自身的选项，支持的参数可由pipelinc自身提供，也可由其它插件(例如timestamps）提供</p>
<p>例如“retry(2)”允许在pipelinc失败时重试两次</p>
</li>
<li><p>triggers:用于指定负责自动启动pipeline的触发器，对于集成了Github或Gitlab等自带触发机制的系统场景，triggers并非必须的指令;仅可用于pipeline级别</p>
</li>
<li><p>libraries:当前pipeline可以导入的共享库，该共享库内部的代码则可被该pipeline调用</p>
</li>
<li><p>input: stagc中的专用指令，用于暂停pipeline并提示用户输入内容后继续 </p>
</li>
<li><p>when: stage中的专用指令，用于设定该stage的运行条件</p>
</li>
</ul>
<p><strong>Jenkins 内置语法帮助</strong></p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">http://jenkins-server:8080/job/&lt;job-name&gt;/pipeline-syntax/</span><br><span class="line">#注意：需要安装pipeline插件并且是pipeline风格的任务</span><br></pre></td></tr></table></figure>

<h4 id="脚本式流水线语法"><a href="#脚本式流水线语法" class="headerlink" title="脚本式流水线语法"></a>脚本式流水线语法</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">node &#123;  </span><br><span class="line">   stage(<span class="string">&#x27;Source&#x27;</span>) &#123;</span><br><span class="line">       // </span><br><span class="line">   &#125;</span><br><span class="line">   stage(<span class="string">&#x27;Build&#x27;</span>) &#123; </span><br><span class="line">       // </span><br><span class="line">   &#125;</span><br><span class="line">   stage(<span class="string">&#x27;Test&#x27;</span>) &#123; </span><br><span class="line">       // </span><br><span class="line">   &#125;</span><br><span class="line">   stage(<span class="string">&#x27;Deploy&#x27;</span>) &#123; </span><br><span class="line">       // </span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">#特点：最外层是node &#123;&#125; </span></span><br></pre></td></tr></table></figure>

<h4 id="声明式流水线语法"><a href="#声明式流水线语法" class="headerlink" title="声明式流水线语法"></a>声明式流水线语法</h4><p>声明式流水线是在”Pipeline plugin”的2.5版本添加到 Jenkins 流水线的 ，它在流水线子系统之上提供了一种更简单，更常见的语法。</p>
<p>所有有效的声明式流水线必须包含在一个 pipeline 块中， 比如:</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">pipeline &#123;</span><br><span class="line">   /* insert Declarative Pipeline here */</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>官方说明</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://www.jenkins.io/zh/doc/book/pipeline/syntax/</span><br></pre></td></tr></table></figure>

<p><strong>Pipeline 的基本结构</strong></p>
<p><img src="C:\Users\Lenovo\Desktop\img\332.jpg" alt="332"></p>
<p><strong>Pipeline 的声明式语法要点</strong></p>
<ul>
<li><p>steps内部的命令，每一条单独的命令都在当前任务的工作目录下执行。</p>
<p>即使A命令切换到了一个新的目录，接下来的B命令并不会在对应的新目录中执行，而是在当前任务的工作目录下执行。如果非要在切换后的目录下执行命令B，那么采用she11中的&amp;&amp;符号将多条命令拼接在一起即可。</p>
</li>
<li><p>默认情况下，不支持shell里面的复杂语法，因为groovy有自己的条件表达式</p>
</li>
<li><p>如果jenkins的工作目录下存在同名目录，则获取失败</p>
</li>
</ul>
<p>基本语法</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">pipeline &#123;</span><br><span class="line">   agent any </span><br><span class="line">   environment&#123;</span><br><span class="line">   url=&#x27;http://www.wangxiaochun.com&#x27;</span><br><span class="line">   &#125;</span><br><span class="line">   stages &#123;</span><br><span class="line">       stage(&#x27;Source&#x27;) &#123;</span><br><span class="line">   steps &#123;</span><br><span class="line">               // </span><br><span class="line">               echo &quot;Access $&#123;url&#125;&quot;</span><br><span class="line">           &#125;</span><br><span class="line">   &#125;</span><br><span class="line">       stage(&#x27;Build&#x27;) &#123; </span><br><span class="line">           steps &#123;</span><br><span class="line">               // </span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">       stage(&#x27;Test&#x27;) &#123; </span><br><span class="line">           steps &#123;</span><br><span class="line">               // </span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">       stage(&#x27;Deploy&#x27;) &#123; </span><br><span class="line">           steps &#123;</span><br><span class="line">               // </span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br><span class="line">#特点：最外层是 pipeline &#123;&#125;</span><br></pre></td></tr></table></figure>

<h4 id="基本案例"><a href="#基本案例" class="headerlink" title="基本案例"></a>基本案例</h4><p>范例: 脚本式</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">node &#123;</span><br><span class="line"> stage(<span class="string">&#x27;Get code&#x27;</span>) &#123;</span><br><span class="line"> <span class="built_in">echo</span> <span class="string">&#x27;获取代码&#x27;</span></span><br><span class="line"> &#125;</span><br><span class="line"> stage(<span class="string">&#x27;Build&#x27;</span>) &#123;</span><br><span class="line"> <span class="built_in">echo</span> <span class="string">&#x27;构建项目代码&#x27;</span></span><br><span class="line"> &#125;</span><br><span class="line"> stage(<span class="string">&#x27;Test&#x27;</span>) &#123;</span><br><span class="line"> <span class="built_in">echo</span> <span class="string">&#x27;测试项目功能&#x27;</span></span><br><span class="line"> &#125;</span><br><span class="line"> stage(<span class="string">&#x27;Deploy&#x27;</span>) &#123;</span><br><span class="line"> <span class="built_in">echo</span> <span class="string">&#x27;部署项目&#x27;</span></span><br><span class="line"> &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>范例: 声明式</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">pipeline &#123;</span><br><span class="line">    agent any</span><br><span class="line">    stages &#123;</span><br><span class="line">        stage(&#x27;获取代码&#x27;) &#123;</span><br><span class="line">            steps &#123;</span><br><span class="line">                echo &#x27;获取代码&#x27;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        stage(&#x27;构建代码&#x27;) &#123;</span><br><span class="line">            steps &#123;</span><br><span class="line">                echo &#x27;构建项目代码&#x27;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        stage(&#x27;代码测试&#x27;) &#123;</span><br><span class="line">            steps &#123;</span><br><span class="line">                echo &#x27;测试项目功能&#x27;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        stage(&#x27;项目部署&#x27;) &#123;</span><br><span class="line">            steps &#123;</span><br><span class="line">                echo &#x27;部署项目&#x27;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="实现一个简单-Pipeline-Job"><a href="#实现一个简单-Pipeline-Job" class="headerlink" title="实现一个简单 Pipeline Job"></a>实现一个简单 Pipeline Job</h3><h4 id="安装-Pipeline-插件"><a href="#安装-Pipeline-插件" class="headerlink" title="安装 Pipeline 插件"></a>安装 Pipeline 插件</h4><p><strong>安装 Pipeline 和 Pipeline Stage View 插件</strong></p>
<p><img src="C:\Users\Lenovo\Desktop\img\333.jpg" alt="333"><br><img src="C:\Users\Lenovo\Desktop\img\334.jpg" alt="334"></p>
<p>注意: 如果不安装插件，虽然可以创建流水线的任务，但在执行任务时会出现下面的错误提示</p>
<p><img src="C:\Users\Lenovo\Desktop\img\335.jpg" alt="335"></p>
<h4 id="创建-Pipeline-Job"><a href="#创建-Pipeline-Job" class="headerlink" title="创建 Pipeline Job"></a>创建 Pipeline Job</h4><p><img src="C:\Users\Lenovo\Desktop\img\336.jpg" alt="336"></p>
<h4 id="测试简单-Pipeline-Job-运行"><a href="#测试简单-Pipeline-Job-运行" class="headerlink" title="测试简单 Pipeline Job 运行"></a>测试简单 Pipeline Job 运行</h4><p>Pipeline 基于脚本式的测试代码</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">node &#123;</span><br><span class="line"> stage(<span class="string">&quot;代码clone&quot;</span>)&#123;</span><br><span class="line">    echo <span class="string">&quot;代码 clone&quot;</span></span><br><span class="line"> &#125;</span><br><span class="line"> stage(<span class="string">&quot;代码构建&quot;</span>)&#123;</span><br><span class="line">    echo <span class="string">&quot;代码构建&quot;</span></span><br><span class="line"> &#125;</span><br><span class="line"> stage(<span class="string">&quot;代码测试&quot;</span>)&#123;</span><br><span class="line">    echo <span class="string">&quot;代码测试&quot;</span></span><br><span class="line"> &#125;</span><br><span class="line"> stage(<span class="string">&quot;代码部署&quot;</span>)&#123;</span><br><span class="line">    echo <span class="string">&quot;代码部署&quot;</span></span><br><span class="line"> &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Jenkins Web 界面配置：</p>
<p><img src="C:\Users\Lenovo\Desktop\img\337.jpg" alt="337"></p>
<h4 id="执行-Pipeline-Job"><a href="#执行-Pipeline-Job" class="headerlink" title="执行 Pipeline Job"></a>执行 Pipeline Job</h4><p><img src="C:\Users\Lenovo\Desktop\img\338.jpg" alt="338"></p>
<p>如果安装Blue Ocean 插件，可以下看如下的显示效果</p>
<p><img src="C:\Users\Lenovo\Desktop\img\339.jpg" alt="339"></p>
<h4 id="自动生成拉取代码的-Pipeline-脚本"><a href="#自动生成拉取代码的-Pipeline-脚本" class="headerlink" title="自动生成拉取代码的 Pipeline 脚本"></a>自动生成拉取代码的 Pipeline 脚本</h4><p>点击”流水线语法”跳转至流水线代码生成链接</p>
<p><img src="C:\Users\Lenovo\Desktop\img\340.jpg" alt="340"></p>
<p>或者如下也会跳转到流水线代码生成链接</p>
<p><img src="C:\Users\Lenovo\Desktop\img\341.jpg" alt="341"></p>
<p>生成流水线脚本</p>
<p><img src="C:\Users\Lenovo\Desktop\img\342.jpg" alt="342"></p>
<h4 id="更改-Pipeline-任务"><a href="#更改-Pipeline-任务" class="headerlink" title="更改 Pipeline 任务"></a>更改 Pipeline 任务</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">node &#123;</span><br><span class="line"> stage(<span class="string">&quot;clone 代码&quot;</span>)&#123;</span><br><span class="line"> 	git branch: <span class="string">&#x27;develop&#x27;</span>, credentialsId: <span class="string">&#x27;d7e3bd0b-fd88-4ffa-b330-2258e93319ed&#x27;</span>, url: <span class="string">&#x27;git@10.0.0.100:dev/app1.git&#x27;</span></span><br><span class="line"> &#125;</span><br><span class="line"> stage(<span class="string">&quot;代码构建&quot;</span>)&#123;</span><br><span class="line"> 	<span class="built_in">echo</span> <span class="string">&quot;代码构建&quot;</span></span><br><span class="line"> &#125;</span><br><span class="line"> stage(<span class="string">&quot;代码测试&quot;</span>)&#123;</span><br><span class="line"> 	<span class="built_in">echo</span> <span class="string">&quot;代码测试&quot;</span></span><br><span class="line"> &#125;</span><br><span class="line"> stage(<span class="string">&quot;代码部署&quot;</span>)&#123;</span><br><span class="line"> 	<span class="built_in">echo</span> <span class="string">&quot;代码部署&quot;</span></span><br><span class="line"> &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="执行-Jenkins-Pipeline-任务"><a href="#执行-Jenkins-Pipeline-任务" class="headerlink" title="执行 Jenkins Pipeline 任务"></a>执行 Jenkins Pipeline 任务</h4><p><img src="C:\Users\Lenovo\Desktop\img\343.jpg" alt="343"></p>
<h4 id="验证结果-3"><a href="#验证结果-3" class="headerlink" title="验证结果"></a>验证结果</h4><p><img src="C:\Users\Lenovo\Desktop\img\344.jpg" alt="344"><br><img src="C:\Users\Lenovo\Desktop\img\345.jpg" alt="345"></p>
<p>Jenkins 服务器验证 clone 代码数据是否成功</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@jenkins-ubuntu ~]<span class="comment"># cat /var/lib/jenkins/workspace/pipeline-test/index.html </span></span><br><span class="line">&lt;h1&gt;magedu/app1 v11 &lt;/h1&gt;</span><br></pre></td></tr></table></figure>

<h4 id="流水线步骤"><a href="#流水线步骤" class="headerlink" title="流水线步骤"></a>流水线步骤</h4><p>Pipeline Job中的流水线步骤可以分解显示每个步骤的执行状态</p>
<p><img src="C:\Users\Lenovo\Desktop\img\346.jpg" alt="346"></p>
<h4 id="回放-Replay"><a href="#回放-Replay" class="headerlink" title="回放 Replay"></a>回放 Replay</h4><p>对于错误的构建任务，Jenkins提供了一种称为“回放”的机制，它允许用户无须改变已保存的原有代码的基础上进行试验和调试</p>
<p><img src="C:\Users\Lenovo\Desktop\img\347.jpg" alt="347"></p>
<h4 id="从指定阶段重新运行"><a href="#从指定阶段重新运行" class="headerlink" title="从指定阶段重新运行"></a>从指定阶段重新运行</h4><p><strong>注意：声明式Pipeline 语法才支持</strong></p>
<p><img src="C:\Users\Lenovo\Desktop\img\348.jpg" alt="348"><br><img src="C:\Users\Lenovo\Desktop\img\349.jpg" alt="349"></p>
<p>通过 Blue Ocean 实现从指定阶段执行</p>
<p><img src="C:\Users\Lenovo\Desktop\img\350.jpg" alt="350"></p>
<h3 id="实战案例-声明式-Pipeline"><a href="#实战案例-声明式-Pipeline" class="headerlink" title="实战案例: 声明式 Pipeline"></a>实战案例: 声明式 Pipeline</h3><h4 id="案例：基本语法"><a href="#案例：基本语法" class="headerlink" title="案例：基本语法"></a>案例：基本语法</h4><p>steps 内部的命令，每一条单独的命令都在当前任务的工作目录下执行。</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">pipeline &#123;</span><br><span class="line">   environment &#123;</span><br><span class="line">       APP = <span class="string">&quot;testapp&quot;</span></span><br><span class="line">   &#125;</span><br><span class="line">   agent any</span><br><span class="line">   stages &#123;</span><br><span class="line">       stage (<span class="string">&#x27;cmd test&#x27;</span>) &#123;</span><br><span class="line">           steps &#123;</span><br><span class="line">                echo <span class="string">&#x27;命令测试&#x27;</span></span><br><span class="line">                sh <span class="string">&#x27;pwd&#x27;</span></span><br><span class="line">                sh <span class="string">&#x27;rm -rf *&#x27;</span></span><br><span class="line">                sh <span class="string">&#x27;mkdir testdir1&#x27;</span></span><br><span class="line">                sh <span class="string">&#x27;cd testdir1 &amp;&amp; pwd &amp;&amp; mkdir testdir2 &amp;&amp; cd testdir2 &amp;&amp; pwd&#x27;</span></span><br><span class="line">                sh <span class="string">&#x27;pwd &amp;&amp; tree&#x27;</span></span><br><span class="line">                sh <span class="string">&#x27;echo $WORKSPACE&#x27;</span></span><br><span class="line">                sh <span class="string">&#x27;echo $JOB_NAME&#x27;</span></span><br><span class="line">                sh <span class="string">&#x27;mkdir $WORKSPACE/$JOB_NAME&#x27;</span></span><br><span class="line">                sh <span class="string">&#x27;touch $WORKSPACE/$JOB_NAME/$APP.log&#x27;</span></span><br><span class="line">                sh <span class="string">&#x27;pwd &amp;&amp; tree&#x27;</span></span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="C:\Users\Lenovo\Desktop\img\357.jpg" alt="357"></p>
<h4 id="案例：Maven-编译-Java-项目"><a href="#案例：Maven-编译-Java-项目" class="headerlink" title="案例：Maven 编译 Java 项目"></a>案例：Maven 编译 Java 项目</h4><p>范例：</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">pipeline &#123;</span><br><span class="line">   agent any</span><br><span class="line">   tools &#123;</span><br><span class="line">       maven <span class="string">&#x27;maven-3.6.3&#x27;</span></span><br><span class="line">   &#125;</span><br><span class="line">   stages &#123;</span><br><span class="line">       stage(<span class="string">&#x27;Source&#x27;</span>) &#123;</span><br><span class="line">           steps &#123;</span><br><span class="line">                git <span class="attr">branch:</span> <span class="string">&#x27;main&#x27;</span>, <span class="attr">credentialsId:</span> <span class="string">&#x27;gitlab-root-password&#x27;</span>, <span class="attr">url:</span> <span class="string">&#x27;http://gitlab.wang.org/ops/spring-boot-helloworld.git&#x27;</span></span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">       stage(<span class="string">&#x27;Build&#x27;</span>) &#123;</span><br><span class="line">           steps &#123;</span><br><span class="line">                sh <span class="string">&#x27;mvn -B -DskipTests clean package&#x27;</span></span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">       stage(<span class="string">&#x27;Test&#x27;</span>) &#123;</span><br><span class="line">           steps &#123;</span><br><span class="line">                sh <span class="string">&#x27;mvn test&#x27;</span></span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>范例:</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">pipeline &#123;</span><br><span class="line">   agent any    </span><br><span class="line">   tools &#123;</span><br><span class="line">       maven <span class="string">&#x27;maven-3.6.3&#x27;</span></span><br><span class="line">   &#125;</span><br><span class="line">    </span><br><span class="line">   stages &#123;</span><br><span class="line">       stage(<span class="string">&#x27;code clone&#x27;</span>) &#123;</span><br><span class="line">           steps &#123;</span><br><span class="line">               git <span class="attr">branch:</span> <span class="string">&#x27;main&#x27;</span>, <span class="attr">credentialsId:</span> <span class="string">&#x27;gitlab-root-password&#x27;</span>, <span class="attr">url:</span> <span class="string">&#x27;http://gitlab.wang.org/ops/spring-boot-helloworld.git&#x27;</span></span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">        </span><br><span class="line">       stage(<span class="string">&#x27;Build&#x27;</span>) &#123;</span><br><span class="line">           steps &#123;</span><br><span class="line">                sh <span class="string">&#x27;mvn clean package -Dmaven.test.skip=true&#x27;</span></span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">       stage(<span class="string">&quot;停止spring boot服务&quot;</span>)&#123;</span><br><span class="line">           steps &#123;</span><br><span class="line">                sh <span class="string">&#x27;ssh 10.0.0.202 &quot;killall -0 java &amp;&amp; killall -9 java|| true&quot;&#x27;</span></span><br><span class="line">                sh <span class="string">&#x27;ssh 10.0.0.203 &quot;killall -0 java &amp;&amp; killall -9 java || true&quot;&#x27;</span></span><br><span class="line">           &#125;  </span><br><span class="line">       &#125;</span><br><span class="line">       stage(<span class="string">&quot;代码复制&quot;</span>)&#123;</span><br><span class="line">           steps &#123;</span><br><span class="line">                sh <span class="string">&#x27;scp target/spring-boot-helloworld-*-SNAPSHOT.jar 10.0.0.202:/data/appdir/&#x27;</span></span><br><span class="line">                sh <span class="string">&#x27;scp target/spring-boot-helloworld-*-SNAPSHOT.jar 10.0.0.203:/data/appdir/&#x27;</span></span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">       stage(<span class="string">&quot;启动spring boot服务&quot;</span>)&#123;</span><br><span class="line">           steps &#123;</span><br><span class="line">            sh <span class="string">&#x27;ssh 10.0.0.202 &quot;nohup java -jar /data/appdir/spring-boot-helloworld-*.jar --server.port=8888 &amp;&gt;/dev/null &amp; &quot;&#x27;</span></span><br><span class="line">            sh <span class="string">&#x27;ssh 10.0.0.203 &quot;nohup java -jar /data/appdir/spring-boot-helloworld-*.jar --server.port=8888 &amp;&gt;/dev/null &amp; &quot;&#x27;</span></span><br><span class="line">           &#125;  </span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>范例:</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">pipeline &#123;</span><br><span class="line">   agent any    </span><br><span class="line">   tools &#123;</span><br><span class="line">       maven <span class="string">&#x27;mvn-3.6.3&#x27;</span>  #指定java编译工具版本</span><br><span class="line">   &#125;</span><br><span class="line">    </span><br><span class="line">   stages &#123;</span><br><span class="line">       stage(<span class="string">&#x27;Checkout&#x27;</span>) &#123;</span><br><span class="line">           steps &#123;</span><br><span class="line">                git <span class="attr">branch:</span> <span class="string">&#x27;master&#x27;</span>, <span class="attr">url:</span> <span class="string">&#x27;http://gitlab.wang.org/magedu/spring-boot-helloworld.git&#x27;</span></span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">        </span><br><span class="line">       stage(<span class="string">&#x27;Build&#x27;</span>) &#123;</span><br><span class="line">           steps &#123;</span><br><span class="line">                sh <span class="string">&#x27;mvn clean package -Dmaven.test.skip=true&#x27;</span></span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">#指定端口运行java应用</span><br><span class="line">#java -jar target/spring-boot-helloworld<span class="number">-0.9</span><span class="number">.0</span>-SNAPSHOT.jar --server.port=<span class="number">8888</span></span><br></pre></td></tr></table></figure>

<h4 id="案例：变量"><a href="#案例：变量" class="headerlink" title="案例：变量"></a>案例：变量</h4><p>Jenkins环境变量可分为内置变量和用户自定义变量两类</p>
<p>pipeline和stage得中用于定义环境变量的指令是environment，但定义位置的不同，也意味着其作用域的不同;</p>
<p>定义在pipeline顶部的环境变量可被其后的各stage所引用;</p>
<p>Jenkins全局环境变量可被所有的pipeline引用，它们以“env.”为前缀;</p>
<p>引用全局环境变量格式有三种:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$&#123;env.&lt;ENV_VAR_NAME&gt;&#125;</span></span><br><span class="line"><span class="variable">$env</span>.&lt;ENV_VAR_NAME&gt;</span><br><span class="line"><span class="variable">$&#123;ENV_VAR_NAME&#125;</span></span><br></pre></td></tr></table></figure>

<p>范例：声明和使用变量</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">pipeline &#123;</span><br><span class="line">   agent any    </span><br><span class="line">   environment &#123;</span><br><span class="line">       NAME = <span class="string">&quot;wangxiaochun&quot;</span></span><br><span class="line">   &#125;</span><br><span class="line">   stages &#123;</span><br><span class="line">       stage(<span class="string">&#x27;declare var&#x27;</span>) &#123;</span><br><span class="line">           steps &#123;</span><br><span class="line">               script &#123;</span><br><span class="line">                   env.LOGIN=sh(<span class="attr">returnStdout:</span> <span class="literal">true</span>, <span class="attr">script:</span> <span class="string">&quot;who|wc -l&quot;</span>) </span><br><span class="line">               &#125;</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">       stage(<span class="string">&#x27;get var&#x27;</span>) &#123;</span><br><span class="line">           steps &#123;</span><br><span class="line">                echo <span class="string">&quot;NAME=$&#123;NAME&#125;&quot;</span></span><br><span class="line">                echo <span class="string">&quot;LOGIN=$&#123;LOGIN&#125;&quot;</span></span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>范例：</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">pipeline &#123;</span><br><span class="line">    agent any    </span><br><span class="line">    environment &#123;</span><br><span class="line">        REPO=<span class="string">&quot;http://gitlab.wang.org/ops/spring-boot-helloworld.git&quot;</span></span><br><span class="line">        CREDENTIAL=<span class="string">&quot;gitlab-root-password&quot;</span></span><br><span class="line">        APP=<span class="string">&quot;spring-boot-helloworld&quot;</span></span><br><span class="line">        APP_PATH=<span class="string">&quot;/data/appdir&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">    tools &#123;</span><br><span class="line">        maven <span class="string">&#x27;maven-3.6.3&#x27;</span> </span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    stages &#123;</span><br><span class="line">        stage(<span class="string">&#x27;code clone&#x27;</span>) &#123;</span><br><span class="line">            steps &#123;</span><br><span class="line">               git <span class="attr">branch:</span> <span class="string">&#x27;main&#x27;</span>, <span class="attr">credentialsId:</span> <span class="string">&quot;$&#123;CREDENTIAL&#125;&quot;</span> ,<span class="attr">url:</span> <span class="string">&quot;$&#123;REPO&#125;&quot;</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        stage(<span class="string">&#x27;Build&#x27;</span>) &#123;</span><br><span class="line">            steps &#123;</span><br><span class="line">                sh <span class="string">&#x27;mvn clean package -Dmaven.test.skip=true&#x27;</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        stage(<span class="string">&quot;停止spring boot服务&quot;</span>)&#123;</span><br><span class="line">            steps &#123;</span><br><span class="line">                sh <span class="string">&#x27;ssh 10.0.0.202 &quot;killall -0  java &amp;&amp; killall -9 java|| true&quot;&#x27;</span></span><br><span class="line">                sh <span class="string">&#x27;ssh 10.0.0.203 &quot;killall -0 java &amp;&amp; killall -9 java || true&quot;&#x27;</span></span><br><span class="line">            &#125;  </span><br><span class="line">        &#125;</span><br><span class="line">        stage(<span class="string">&quot;代码复制&quot;</span>)&#123;</span><br><span class="line">            steps &#123;</span><br><span class="line">                sh <span class="string">&quot;scp target/$&#123;APP&#125;-*-SNAPSHOT.jar 10.0.0.202:$&#123;APP_PATH&#125;&quot;</span></span><br><span class="line">                sh <span class="string">&quot;scp target/$&#123;APP&#125;-*-SNAPSHOT.jar 10.0.0.203:$&#123;APP_PATH&#125;&quot;</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        stage(<span class="string">&quot;启动spring boot服务&quot;</span>)&#123;</span><br><span class="line">            steps &#123;</span><br><span class="line">            sh <span class="string">&#x27;ssh 10.0.0.202 &quot;nohup java -jar  $&#123;APP_PATH&#125;/$&#123;APP&#125;-*.jar --server.port=8888  &amp;&gt;/dev/null &amp; &quot;&#x27;</span></span><br><span class="line">            sh <span class="string">&#x27;ssh 10.0.0.203 &quot;nohup java -jar  $&#123;APP_PATH&#125;/$&#123;APP&#125;-*.jar --server.port=8888  &amp;&gt;/dev/null &amp; &quot;&#x27;</span></span><br><span class="line">            &#125;  </span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>范例：</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">pipeline &#123;</span><br><span class="line">   agent any</span><br><span class="line">   tools &#123;</span><br><span class="line">       maven <span class="string">&#x27;maven-3.8.6&#x27;</span></span><br><span class="line">   &#125;</span><br><span class="line">   environment &#123;</span><br><span class="line">        codeRepo=<span class="string">&quot;http://gitlab.wang.org/root/spring-boot-helloWorld.git&quot;</span></span><br><span class="line">   &#125;</span><br><span class="line">   stages &#123;</span><br><span class="line">       stage(<span class="string">&#x27;Source&#x27;</span>) &#123;</span><br><span class="line">           steps &#123;</span><br><span class="line">                git <span class="attr">branch:</span> <span class="string">&#x27;main&#x27;</span>, <span class="attr">url:</span> <span class="string">&quot;$&#123;codeRepo&#125;&quot;</span></span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">       stage(<span class="string">&#x27;Build&#x27;</span>) &#123;</span><br><span class="line">           steps &#123;</span><br><span class="line">                sh <span class="string">&#x27;mvn -B -DskipTests clean package&#x27;</span></span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">       stage(<span class="string">&#x27;Test&#x27;</span>) &#123;</span><br><span class="line">           steps &#123;</span><br><span class="line">                sh <span class="string">&#x27;mvn test&#x27;</span></span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="案例：使用凭据-Credential"><a href="#案例：使用凭据-Credential" class="headerlink" title="案例：使用凭据 Credential"></a>案例：使用凭据 Credential</h4><p>范例：</p>
<p>先在Jenkins 创建凭据 credential</p>
<p><img src="C:\Users\Lenovo\Desktop\img\358.jpg" alt="358"></p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">pipeline &#123;</span><br><span class="line">   agent any</span><br><span class="line">   tools &#123;</span><br><span class="line">       maven <span class="string">&#x27;maven-3.8.6&#x27;</span></span><br><span class="line">   &#125;</span><br><span class="line">   environment &#123;</span><br><span class="line">        codeRepo=<span class="string">&quot;http://gitlab.wang.org/root/spring-boot-helloWorld.git&quot;</span></span><br><span class="line">   &#125;</span><br><span class="line">   stages &#123;</span><br><span class="line">       stage(<span class="string">&#x27;Source&#x27;</span>) &#123;</span><br><span class="line">           steps &#123;</span><br><span class="line">                git <span class="attr">branch:</span> <span class="string">&#x27;main&#x27;</span>, <span class="attr">credentialsId:</span> <span class="string">&#x27;gitlab-root-credential&#x27;</span>, <span class="attr">url:</span> <span class="string">&quot;$&#123;codeRepo&#125;&quot;</span></span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">       stage(<span class="string">&#x27;Build&#x27;</span>) &#123;</span><br><span class="line">           steps &#123;</span><br><span class="line">                sh <span class="string">&#x27;mvn -B -Dmaven.skip.test=true clean package&#x27;</span></span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">       stage(<span class="string">&#x27;Test&#x27;</span>) &#123;</span><br><span class="line">           steps &#123;</span><br><span class="line">                sh <span class="string">&#x27;mvn test&#x27;</span></span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>范例：构建和推送Docker镜像</p>
<p>准备环境：</p>
<p>Jenkins 主机或 Agent 需要提前安装 Docker</p>
<p>在Jenkins 创建凭据 credential ID为 gitlab-root-password</p>
<p><img src="C:\Users\Lenovo\Desktop\img\359.jpg" alt="359"></p>
<p>范例：</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">pipeline &#123;</span><br><span class="line">   agent any</span><br><span class="line">   tools &#123;</span><br><span class="line">       maven <span class="string">&#x27;maven-3.6.3&#x27;</span></span><br><span class="line">   &#125;</span><br><span class="line">   environment &#123;</span><br><span class="line">        codeRepo=<span class="string">&quot;http://gitlab.wang.org/ops/spring-boot-helloworld.git&quot;</span></span><br><span class="line">        credential=<span class="string">&quot;gitlab-root-password&quot;</span></span><br><span class="line">        harborServer=<span class="string">&#x27;harbor.wang.org&#x27;</span></span><br><span class="line">        projectName=<span class="string">&#x27;spring-boot-helloworld&#x27;</span></span><br><span class="line">        imageUrl=<span class="string">&quot;$&#123;harborServer&#125;/example/$&#123;projectName&#125;&quot;</span></span><br><span class="line">        imageTag=<span class="string">&quot;$&#123;BUILD_ID&#125;&quot;</span></span><br><span class="line">        harborUserName=<span class="string">&quot;admin&quot;</span></span><br><span class="line">        harborPassword=<span class="string">&quot;123456&quot;</span></span><br><span class="line">   &#125;</span><br><span class="line">   stages &#123;</span><br><span class="line">       stage(<span class="string">&#x27;Source&#x27;</span>) &#123;</span><br><span class="line">           steps &#123;</span><br><span class="line">                git <span class="attr">branch:</span> <span class="string">&#x27;main&#x27;</span>, <span class="attr">credentialsId:</span> <span class="string">&quot;$&#123;credential&#125;&quot;</span>, <span class="attr">url:</span> <span class="string">&quot;$&#123;codeRepo&#125;&quot;</span></span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">       stage(<span class="string">&#x27;Build&#x27;</span>) &#123;</span><br><span class="line">           steps &#123;</span><br><span class="line">                sh <span class="string">&#x27;mvn -B -DskipTests clean package&#x27;</span></span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="comment">//stage(&#x27;Test&#x27;) &#123;</span></span><br><span class="line">       <span class="comment">//   steps &#123;</span></span><br><span class="line">       <span class="comment">//        sh &#x27;mvn test&#x27;</span></span><br><span class="line">       <span class="comment">//   &#125;</span></span><br><span class="line">       <span class="comment">//&#125;</span></span><br><span class="line">       stage(<span class="string">&#x27;Build Docker Image&#x27;</span>) &#123;</span><br><span class="line">           steps &#123;</span><br><span class="line">                sh <span class="string">&#x27;docker build . -t &quot;$&#123;imageUrl&#125;:$&#123;imageTag&#125;&quot;&#x27;</span></span><br><span class="line">           &#125;           </span><br><span class="line">       &#125;</span><br><span class="line">       stage(<span class="string">&#x27;Push Docker Image&#x27;</span>) &#123;</span><br><span class="line">           steps &#123;</span><br><span class="line">                sh <span class="string">&quot;echo $&#123;harborPassword&#125; | docker login -u $&#123;harborUserName&#125; --password-stdin $&#123;harborServer&#125;&quot;</span></span><br><span class="line">                sh <span class="string">&quot;docker push $&#123;imageUrl&#125;:$&#123;imageTag&#125;&quot;</span></span><br><span class="line">           &#125;   </span><br><span class="line">       &#125;</span><br><span class="line">       stage(<span class="string">&#x27;Run Docker &#x27;</span>) &#123;</span><br><span class="line">           steps &#123;</span><br><span class="line">                sh <span class="string">&#x27;ssh 10.0.0.202 &quot;docker rm -f $&#123;projectName&#125; &amp;&amp; docker run --name $&#123;projectName&#125; -p 80:80 -d $&#123;imageUrl&#125;:$&#123;imageTag&#125;&quot;&#x27;</span></span><br><span class="line">                sh <span class="string">&#x27;ssh 10.0.0.203 &quot;docker rm -f $&#123;projectName&#125; &amp;&amp; docker run --name $&#123;projectName&#125; -p 80:80 -d $&#123;imageUrl&#125;:$&#123;imageTag&#125;&quot;&#x27;</span></span><br><span class="line">           &#125;   </span><br><span class="line">       &#125; </span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>范例：构建和推送Docker镜像</p>
<p>准备环境：</p>
<p>Jenkins 主机或 Agent 需要提前安装 Docker</p>
<p>创建访问harbor的用户和密码的凭据 ID为 harbor-user-credential</p>
<p><img src="C:\Users\Lenovo\Desktop\img\360.jpg" alt="360"></p>
<p>范例：</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line">pipeline &#123;</span><br><span class="line">    agent any</span><br><span class="line">    parameters &#123;</span><br><span class="line">        booleanParam(<span class="attr">name:</span><span class="string">&#x27;pushImage&#x27;</span>, <span class="attr">defaultValue:</span> <span class="string">&#x27;true&#x27;</span>, <span class="attr">description:</span> <span class="string">&#x27;Push Image to Harbor?&#x27;</span>)</span><br><span class="line">    &#125;    </span><br><span class="line">    tools &#123;</span><br><span class="line">        maven <span class="string">&#x27;maven-3.6.3&#x27;</span></span><br><span class="line">    &#125;</span><br><span class="line">    environment &#123;</span><br><span class="line">        codeRepo=<span class="string">&quot;http://gitlab.wang.org/ops/spring-boot-helloworld.git&quot;</span></span><br><span class="line">        credential=<span class="string">&quot;gitlab-root-password&quot;</span></span><br><span class="line">        harborServer=<span class="string">&#x27;harbor.wang.org&#x27;</span></span><br><span class="line">        projectName=<span class="string">&#x27;spring-boot-helloworld&#x27;</span></span><br><span class="line">        imageUrl=<span class="string">&quot;$&#123;harborServer&#125;/example/$&#123;projectName&#125;&quot;</span></span><br><span class="line">        imageTag=<span class="string">&quot;$&#123;BUILD_ID&#125;&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">    stages &#123;</span><br><span class="line">        stage(<span class="string">&#x27;Source&#x27;</span>) &#123;</span><br><span class="line">            steps &#123;</span><br><span class="line">                git <span class="attr">branch:</span> <span class="string">&#x27;main&#x27;</span>, <span class="attr">credentialsId:</span> <span class="string">&quot;$&#123;credential&#125;&quot;</span>, <span class="attr">url:</span> <span class="string">&quot;$&#123;codeRepo&#125;&quot;</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        stage(<span class="string">&#x27;Build&#x27;</span>) &#123;</span><br><span class="line">            steps &#123;</span><br><span class="line">                sh <span class="string">&#x27;mvn -B -DskipTests clean package&#x27;</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//stage(&#x27;Test&#x27;) &#123;</span></span><br><span class="line">        <span class="comment">//   steps &#123;</span></span><br><span class="line">        <span class="comment">//        sh &#x27;mvn test&#x27;</span></span><br><span class="line">        <span class="comment">//    &#125;</span></span><br><span class="line">        <span class="comment">//&#125;</span></span><br><span class="line">        stage(<span class="string">&#x27;Build Docker Image&#x27;</span>) &#123;</span><br><span class="line">            steps &#123;</span><br><span class="line">                sh <span class="string">&#x27;docker build . -t &quot;$&#123;imageUrl&#125;:$&#123;imageTag&#125;&quot;&#x27;</span></span><br><span class="line">            &#125;           </span><br><span class="line">        &#125;</span><br><span class="line">        stage(<span class="string">&#x27;Push Docker Image&#x27;</span>) &#123;</span><br><span class="line">            when &#123;</span><br><span class="line">                expression &#123; params.pushImage == <span class="string">&#x27;true&#x27;</span> &#125;</span><br><span class="line">                <span class="symbol">beforeAgent:</span> <span class="literal">true</span></span><br><span class="line">            &#125;</span><br><span class="line">            steps &#123;</span><br><span class="line">                withCredentials([usernamePassword(<span class="attr">credentialsId:</span> <span class="string">&#x27;harbor-user-credential&#x27;</span>, \</span><br><span class="line">                        <span class="symbol">passwordVariable:</span> <span class="string">&#x27;harborPassword&#x27;</span>, <span class="attr">usernameVariable:</span> <span class="string">&#x27;harborUserName&#x27;</span>)]) &#123;</span><br><span class="line">                    sh <span class="string">&quot;echo $&#123;harborPassword&#125; | docker login -u $&#123;env.harborUserName&#125; --password-stdin $&#123;harborServer&#125;&quot;</span></span><br><span class="line">                    <span class="comment">//sh &quot;docker login -u $&#123;env.harborUserName&#125; -p $&#123;harborPassword&#125; $&#123;harborServer&#125;&quot;</span></span><br><span class="line">                    sh <span class="string">&quot;docker push $&#123;imageUrl&#125;:$&#123;imageTag&#125;&quot;</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;   </span><br><span class="line">        &#125;</span><br><span class="line">        stage(<span class="string">&#x27;Run Docker &#x27;</span>) &#123;</span><br><span class="line">            steps &#123;</span><br><span class="line">                sh <span class="string">&#x27;ssh 10.0.0.202 &quot;docker rm -f $&#123;projectName&#125; &amp;&amp; docker run --name $&#123;projectName&#125; -p 80:80 -d $&#123;imageUrl&#125;:$&#123;imageTag&#125;&quot;&#x27;</span></span><br><span class="line">                sh <span class="string">&#x27;ssh 10.0.0.203 &quot;docker rm -f $&#123;projectName&#125; &amp;&amp; docker run --name $&#123;projectName&#125; -p 80:80 -d $&#123;imageUrl&#125;:$&#123;imageTag&#125;&quot;&#x27;</span></span><br><span class="line">            &#125;   </span><br><span class="line">        &#125;  		</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>问题：执行任务会提示没有权限访问 unix:///var/run/docker.sock （文件的权限：660， root， docker） </p>
<p>解决方法：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">1) usermod -G docker jenkins </span><br><span class="line">   jenkins相关的Java进程是以jenkins用户身份在运行</span><br><span class="line">   注意：需要重启jenkins进程才能生效；</span><br><span class="line">2) 调整docker.service中的监听的套接字</span><br><span class="line">    -H tcp://127.0.0.1:2376</span><br><span class="line">   pipeline写法: sh <span class="string">&#x27;docker -H tcp://127.0.0.1:2376 build ...&#x27;</span></span><br><span class="line">3) 配置到全局属性：</span><br><span class="line">   安装Docker插件</span><br><span class="line">   系统管理--configure system--Docker BUilder --Docker URL-- 输入：tcp://127.0.0.1:2376</span><br><span class="line">   pipeline写法: sh <span class="string">&#x27;docker build image ...&#x27;</span> </span><br></pre></td></tr></table></figure>

<p>范例：通过Jenkinsfile 实现</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="meta">@gitlab</span> spring-boot-helloworld]# cat Jenkinsfile</span><br><span class="line">pipeline &#123;</span><br><span class="line">    agent any</span><br><span class="line">    parameters &#123;</span><br><span class="line">        booleanParam(<span class="attr">name:</span><span class="string">&#x27;pushImage&#x27;</span>, <span class="attr">defaultValue:</span> <span class="string">&#x27;true&#x27;</span>, <span class="attr">description:</span> <span class="string">&#x27;Push Image to Harbor?&#x27;</span>)</span><br><span class="line">    &#125;    </span><br><span class="line">    tools &#123;</span><br><span class="line">        maven <span class="string">&#x27;maven-3.6.3&#x27;</span></span><br><span class="line">    &#125;</span><br><span class="line">    environment &#123;</span><br><span class="line">        codeRepo=<span class="string">&quot;http://gitlab.wang.org/ops/spring-boot-helloworld.git&quot;</span></span><br><span class="line">        credential=<span class="string">&quot;gitlab-root-password&quot;</span></span><br><span class="line">        harborServer=<span class="string">&#x27;harbor.wang.org&#x27;</span></span><br><span class="line">        projectName=<span class="string">&#x27;spring-boot-helloworld&#x27;</span></span><br><span class="line">        imageUrl=<span class="string">&quot;$&#123;harborServer&#125;/example/$&#123;projectName&#125;&quot;</span></span><br><span class="line">        imageTag=<span class="string">&quot;$&#123;BUILD_ID&#125;&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">    stages &#123;</span><br><span class="line">        stage(<span class="string">&#x27;Source&#x27;</span>) &#123;</span><br><span class="line">            steps &#123;</span><br><span class="line">                git <span class="attr">branch:</span> <span class="string">&#x27;main&#x27;</span>, <span class="attr">credentialsId:</span> <span class="string">&quot;$&#123;credential&#125;&quot;</span>, <span class="attr">url:</span> <span class="string">&quot;$&#123;codeRepo&#125;&quot;</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        stage(<span class="string">&#x27;Build&#x27;</span>) &#123;</span><br><span class="line">            steps &#123;</span><br><span class="line">                sh <span class="string">&#x27;mvn -B -DskipTests clean package&#x27;</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//stage(&#x27;Test&#x27;) &#123;</span></span><br><span class="line">        <span class="comment">//   steps &#123;</span></span><br><span class="line">        <span class="comment">//        sh &#x27;mvn test&#x27;</span></span><br><span class="line">        <span class="comment">//    &#125;</span></span><br><span class="line">        <span class="comment">//&#125;</span></span><br><span class="line">        stage(<span class="string">&#x27;Build Docker Image&#x27;</span>) &#123;</span><br><span class="line">            steps &#123;</span><br><span class="line">                sh <span class="string">&#x27;docker build . -t &quot;$&#123;imageUrl&#125;:$&#123;imageTag&#125;&quot;&#x27;</span></span><br><span class="line">            &#125;           </span><br><span class="line">        &#125;</span><br><span class="line">        stage(<span class="string">&#x27;Push Docker Image&#x27;</span>) &#123;</span><br><span class="line">            when &#123;</span><br><span class="line">                expression &#123; params.pushImage == <span class="string">&#x27;true&#x27;</span> &#125;</span><br><span class="line">                <span class="symbol">beforeAgent:</span> <span class="literal">true</span></span><br><span class="line">            &#125;</span><br><span class="line">            steps &#123;</span><br><span class="line">                withCredentials([usernamePassword(<span class="attr">credentialsId:</span> <span class="string">&#x27;harbor-user-credential&#x27;</span>, \</span><br><span class="line">                        <span class="symbol">passwordVariable:</span> <span class="string">&#x27;harborPassword&#x27;</span>, <span class="attr">usernameVariable:</span> <span class="string">&#x27;harborUserName&#x27;</span>)]) &#123;</span><br><span class="line">                    sh <span class="string">&quot;echo $&#123;harborPassword&#125; | docker login -u $&#123;env.harborUserName&#125; --password-stdin $&#123;harborServer&#125;&quot;</span></span><br><span class="line">                    <span class="comment">//sh &quot;docker login -u $&#123;env.harborUserName&#125; -p $&#123;harborPassword&#125; $&#123;harborServer&#125;&quot;</span></span><br><span class="line">                    sh <span class="string">&quot;docker push $&#123;imageUrl&#125;:$&#123;imageTag&#125;&quot;</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;   </span><br><span class="line">        &#125;</span><br><span class="line">        stage(<span class="string">&#x27;Run Docker &#x27;</span>) &#123;</span><br><span class="line">            steps &#123;</span><br><span class="line">                sh <span class="string">&#x27;ssh 10.0.0.202 &quot;docker rm -f $&#123;projectName&#125; &amp;&amp; docker run --name $&#123;projectName&#125; -p 80:80 -d $&#123;imageUrl&#125;:$&#123;imageTag&#125;&quot;&#x27;</span></span><br><span class="line">                sh <span class="string">&#x27;ssh 10.0.0.203 &quot;docker rm -f $&#123;projectName&#125; &amp;&amp; docker run --name $&#123;projectName&#125; -p 80:80 -d $&#123;imageUrl&#125;:$&#123;imageTag&#125;&quot;&#x27;</span></span><br><span class="line">            &#125;   </span><br><span class="line">        &#125;  		</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="C:\Users\Lenovo\Desktop\img\361.jpg" alt="361"></p>
<h4 id="案例：参数选项和密码"><a href="#案例：参数选项和密码" class="headerlink" title="案例：参数选项和密码"></a>案例：参数选项和密码</h4><p>官方帮助</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://www.jenkins.io/doc/book/pipeline/syntax/#parameters</span><br></pre></td></tr></table></figure>

<p>声明式Pipeline中，parameters指令用于为Pipeline声明参数</p>
<p>该指令用于pipeline之中，且常见于agent指令之后</p>
<p>其功用与Freestyle Job上的参数类似</p>
<p><strong>常用的参数类型有如下这些</strong></p>
<ul>
<li><p>string</p>
<p>字符串类型的参数</p>
<p><code>parameters &#123; string(name: &#39;DEPLOY_ENV&#39;, defaultValue: &#39;staging&#39;, description: &#39;&#39;) &#125;</code>.</p>
</li>
<li><p>text</p>
<p>文本类型的参数，支持多行文本</p>
<p><code>parameters &#123; text(name: &#39;DEPLOY_TEXT&#39;, defaultValue: &#39;One\nTwo\nThree\n&#39;, description: &#39;&#39;) &#125;</code>.</p>
</li>
<li><p>booleanParam</p>
<p>布尔型参数</p>
<p><code>parameters &#123; booleanParam(name: &#39;DEBUG_BUILD&#39;, defaultValue: true, description: &#39;&#39;) &#125;</code>.</p>
</li>
<li><p>choice</p>
<p>选项型参数，第一个选项是默认值</p>
<p><code>parameters &#123; choice(name: &#39;CHOICES&#39;, choices: [&#39;one&#39;, &#39;two&#39;, &#39;three&#39;], description: &#39;&#39;) &#125;</code>. </p>
</li>
<li><p>password</p>
<p><code>parameters &#123; password(name: &#39;PASSWORD&#39;, defaultValue: &#39;SECRET&#39;, description: &#39;A secret password&#39;) &#125;</code>.</p>
</li>
</ul>
<p>范例：</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">pipeline &#123;</span><br><span class="line">    agent any</span><br><span class="line">    parameters &#123;</span><br><span class="line">		string(<span class="attr">defaultValue:</span><span class="string">&quot;Ops&quot;</span>,<span class="attr">description:</span> <span class="string">&quot;Enter user role:&quot;</span>,<span class="attr">name:</span> <span class="string">&#x27;userRole&#x27;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">	stages &#123;</span><br><span class="line">		stage(<span class="string">&#x27;listvalues&#x27;</span>)&#123;</span><br><span class="line">			steps &#123;</span><br><span class="line">				echo <span class="string">&quot;User&#x27;s role = $&#123;params.userRole&#125;&quot;</span></span><br><span class="line">		    &#125;</span><br><span class="line">	    &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>范例:</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">pipeline &#123;</span><br><span class="line">   agent any</span><br><span class="line">   parameters &#123;</span><br><span class="line">       string(<span class="attr">name:</span> <span class="string">&#x27;PERSON&#x27;</span>, <span class="attr">defaultValue:</span> <span class="string">&#x27;Mr Jenkins&#x27;</span>, <span class="attr">description:</span> <span class="string">&#x27;Who should I say hello to?&#x27;</span>)</span><br><span class="line">       text(<span class="attr">name:</span> <span class="string">&#x27;BIOGRAPHY&#x27;</span>, <span class="attr">defaultValue:</span> <span class="string">&#x27;&#x27;</span>, <span class="attr">description:</span> <span class="string">&#x27;Enter some information about the person&#x27;</span>)</span><br><span class="line">       booleanParam(<span class="attr">name:</span> <span class="string">&#x27;TOGGLE&#x27;</span>, <span class="attr">defaultValue:</span> <span class="literal">true</span>, <span class="attr">description:</span> <span class="string">&#x27;Toggle this value&#x27;</span>)</span><br><span class="line">       choice(<span class="attr">name:</span> <span class="string">&#x27;CHOICE&#x27;</span>, <span class="attr">choices:</span> [<span class="string">&#x27;One&#x27;</span>, <span class="string">&#x27;Two&#x27;</span>, <span class="string">&#x27;Three&#x27;</span>], <span class="attr">description:</span> <span class="string">&#x27;Pick something&#x27;</span>)</span><br><span class="line">       password(<span class="attr">name:</span> <span class="string">&#x27;PASSWORD&#x27;</span>, <span class="attr">defaultValue:</span> <span class="string">&#x27;SECRET&#x27;</span>, <span class="attr">description:</span> <span class="string">&#x27;Enter a password&#x27;</span>)</span><br><span class="line">   &#125;</span><br><span class="line">   stages &#123;</span><br><span class="line">       stage(<span class="string">&#x27;Example&#x27;</span>) &#123;</span><br><span class="line">           steps &#123;</span><br><span class="line">                echo <span class="string">&quot;Hello $&#123;params.PERSON&#125;&quot;</span></span><br><span class="line">                echo <span class="string">&quot;Biography: $&#123;params.BIOGRAPHY&#125;&quot;</span></span><br><span class="line">                echo <span class="string">&quot;Toggle: $&#123;params.TOGGLE&#125;&quot;</span></span><br><span class="line">                echo <span class="string">&quot;Choice: $&#123;params.CHOICE&#125;&quot;</span></span><br><span class="line">                echo <span class="string">&quot;Password: $&#123;params.PASSWORD&#125;&quot;</span></span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在下面框中填写相应的内容后开始构建</p>
<p><img src="C:\Users\Lenovo\Desktop\img\362.jpg" alt="362"><br><img src="C:\Users\Lenovo\Desktop\img\363.jpg" alt="363"><br><img src="C:\Users\Lenovo\Desktop\img\364.jpg" alt="364"></p>
<p>范例:</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">pipeline &#123;</span><br><span class="line">    agent any</span><br><span class="line">    stages &#123;</span><br><span class="line">        stage ( <span class="string">&#x27;check&#x27;</span> ) &#123;</span><br><span class="line">            input &#123;</span><br><span class="line">                message <span class="string">&quot;Are you ok ?&quot;</span></span><br><span class="line">                ok <span class="string">&quot;是的&quot;</span></span><br><span class="line">                parameters &#123;</span><br><span class="line">                    choice(<span class="attr">name:</span> <span class="string">&#x27;CHOICE&#x27;</span>,<span class="attr">choices:</span> [ <span class="string">&#x27;Dev&#x27;</span>, <span class="string">&#x27;Test&#x27;</span>, <span class="string">&#x27;Prod&#x27;</span>],<span class="attr">description:</span> <span class="string">&#x27;选择合适的分支&#x27;</span>)</span><br><span class="line">                    password (<span class="attr">name:</span> <span class="string">&#x27;PASSWORD&#x27;</span>,<span class="attr">defaultValue:</span> <span class="string">&#x27;SECRET&#x27;</span>,<span class="attr">description:</span> <span class="string">&#x27;输入密码&#x27;</span>)               </span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            steps &#123;</span><br><span class="line">                echo <span class="string">&quot;分支:$&#123;CHOICE&#125;，密码:$&#123;PASSWORD&#125;&quot;</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="C:\Users\Lenovo\Desktop\img\365.jpg" alt="365"><br><img src="C:\Users\Lenovo\Desktop\img\366.jpg" alt="366"></p>
<p>范例：</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">pipeline &#123;</span><br><span class="line">   agent any</span><br><span class="line">   parameters &#123;</span><br><span class="line">       booleanParam(<span class="attr">name:</span><span class="string">&#x27;pushImage&#x27;</span>, <span class="attr">defaultValue:</span> <span class="string">&#x27;true&#x27;</span>, <span class="attr">description:</span> <span class="string">&#x27;Push Image to Harbor?&#x27;</span>)</span><br><span class="line">   &#125;</span><br><span class="line">   tools &#123;</span><br><span class="line">       maven <span class="string">&#x27;maven-3.8.6&#x27;</span></span><br><span class="line">   &#125;</span><br><span class="line">   environment &#123;</span><br><span class="line">        codeRepo=<span class="string">&quot;http://gitlab.wang.org/root/spring-boot-helloWorld.git&quot;</span></span><br><span class="line">        harborServer=<span class="string">&#x27;hub.wang.org&#x27;</span></span><br><span class="line">        projectName=<span class="string">&#x27;spring-boot-helloworld&#x27;</span></span><br><span class="line">        imageUrl=<span class="string">&quot;$&#123;harborServer&#125;/ikubernetes/$&#123;projectName&#125;&quot;</span></span><br><span class="line">        imageTag=<span class="string">&#x27;latest&#x27;</span></span><br><span class="line">   &#125;</span><br><span class="line">   stages &#123;</span><br><span class="line">       stage(<span class="string">&#x27;Source&#x27;</span>) &#123;</span><br><span class="line">           steps &#123;</span><br><span class="line">                git <span class="attr">branch:</span> <span class="string">&#x27;main&#x27;</span>, <span class="attr">credentialsId:</span> <span class="string">&#x27;gitlab-root-credential&#x27;</span>, <span class="attr">url:</span> <span class="string">&quot;$&#123;codeRepo&#125;&quot;</span></span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">       stage(<span class="string">&#x27;Build&#x27;</span>) &#123;</span><br><span class="line">           steps &#123;</span><br><span class="line">                sh <span class="string">&#x27;mvn -B -DskipTests clean package&#x27;</span></span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">       stage(<span class="string">&#x27;Test&#x27;</span>) &#123;</span><br><span class="line">           steps &#123;</span><br><span class="line">                sh <span class="string">&#x27;mvn test&#x27;</span></span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">       stage(<span class="string">&#x27;Build Docker Image&#x27;</span>) &#123;</span><br><span class="line">           steps &#123;</span><br><span class="line">                sh <span class="string">&#x27;docker image build . -t &quot;$&#123;imageUrl&#125;:$&#123;imageTag&#125;&quot;&#x27;</span></span><br><span class="line">           &#125;           </span><br><span class="line">       &#125;</span><br><span class="line">       stage(<span class="string">&#x27;Push Docker Image&#x27;</span>) &#123;</span><br><span class="line">           steps &#123;</span><br><span class="line">               <span class="comment">// input(message: &#x27;continue?&#x27;)</span></span><br><span class="line">               withCredentials([usernamePassword(<span class="attr">credentialsId:</span> <span class="string">&#x27;harbor-user-credential&#x27;</span>, <span class="attr">passwordVariable:</span> <span class="string">&#x27;harborUserPassword&#x27;</span>, <span class="attr">usernameVariable:</span> <span class="string">&#x27;harborUserName&#x27;</span>)]) &#123;</span><br><span class="line">                    sh <span class="string">&quot;echo $&#123;harborUserPassword&#125; | docker login -u $&#123;env.harborUserName&#125; --password-stdin $&#123;harborServer&#125;&quot;</span></span><br><span class="line">                    sh <span class="string">&quot;docker image push $&#123;imageUrl&#125;:$&#123;imageTag&#125;&quot;</span></span><br><span class="line">               &#125;</span><br><span class="line">           &#125;   </span><br><span class="line">       &#125;        </span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>案例：交互输入实现确认和取消</p>
<p>input 指令支持中断当前任务，以待确认和取消</p>
<p>input步骤是Pipeline与用户交互的接口，用于实现根据用户输入改变pipeline的行为</p>
<p>遇到input步骤时，Pipeline会暂停下来并等待用户的响应</p>
<p>input步骤是特殊的参数化pipeline的方法，它常用于实现简易的审批流程，或者是手动实施后续的步骤等;</p>
<p>为了接收用户输入的不同数据，Jenkins提供了不同类型的参数</p>
<p>input步骤默认打印出的表单是打印一条消息并为用户提供–个选择:Proceed（继续）或者Abort</p>
<p>input步骤中，通过参数接收到的用户输入可以保存在变量中，而后进行调用</p>
<p>变量作用域仅为当前stage，例如，下面示例中的userInput变量仅能于当前步骤中调用</p>
<p>若要跨stage使用变量，则需要在pipeline代码外部先用def声明变量，而后再于stage中使用该变量;</p>
<p>input步骤的可用参数</p>
<ul>
<li><p>message，String类型</p>
<p>其内容将打印给用户，并要求用户选择Proceed或Abort</p>
<p>若input仅提供了该参数时，还可以省略message参数名称</p>
</li>
<li><p>id (optional)，String类型</p>
<p>每个input都有一个惟一的ID标识，用于生成专用的URL，以便于根据用户输入继续或中止pipeline <code>&lt;JENKINS_URL&gt;/job/l[job_name]/[build_id]/input/[input_id]/ </code></p>
<p>该URL可通过POST方法进行请求，后跟proceedEmpty表示空输入并继续，而abort则表示中止未定义ID时，Jenkins将自动为input生成lD;</p>
</li>
<li><p>ok (optional) ，String类型</p>
<p>用于自定义Proceed按钮的标签名称例如，下面的示例中，Proceed按钮的名称为“Yes”</p>
<p>input message: ‘’， ok: ‘Yes’</p>
</li>
<li><p>parameters (optional)</p>
<p>要求用户手动输入一个或多个参数列表</p>
<p>pipeline中，parameters指令支持的参数类型仅是input步骤支持的参数类型的一个子集，因而，那些参数类型都会被input步骤所支持</p>
</li>
<li><p>submitter(optional) ， String类型</p>
<p>可以进行后续操作的用户的ID或用户组列表，彼此间以逗号分隔，且前后不允许出现空格</p>
</li>
<li><p>submitterParameter (optional)，String类型</p>
<p>用于保存input步骤的实际操作者的用户名</p>
</li>
</ul>
<p>范例：</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">input &#123;</span><br><span class="line">   message <span class="string">&quot;should we continue?&quot;</span></span><br><span class="line">   ok <span class="string">&quot;Yes，we should.&quot;</span></span><br><span class="line">   submitter <span class="string">&quot;user1,user2&quot;</span></span><br><span class="line">   parameters i string(参数格式)&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>范例:</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">pipeline&#123;</span><br><span class="line">   agent &#123;</span><br><span class="line">   label <span class="string">&#x27;slave1&#x27;</span>   #指定在linux标签的agent执行任务</span><br><span class="line">   &#125;</span><br><span class="line"> stages&#123;</span><br><span class="line">       stage(<span class="string">&quot;get code&quot;</span>)&#123;</span><br><span class="line">           steps&#123;</span><br><span class="line">                echo <span class="string">&quot;git code from scm&quot;</span></span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">       stage(<span class="string">&quot;build&quot;</span>)&#123;</span><br><span class="line">           steps&#123;</span><br><span class="line">               input <span class="attr">message:</span> <span class="string">&#x27;确定执行吗？&#x27;</span>, <span class="attr">ok:</span> <span class="string">&#x27;确定&#x27;</span></span><br><span class="line">                echo <span class="string">&quot;build code&quot;</span></span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">       stage(<span class="string">&quot;package&quot;</span>)&#123;</span><br><span class="line">           steps&#123;</span><br><span class="line">                echo <span class="string">&quot;packge code&quot;</span></span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">       stage(<span class="string">&quot;deploy&quot;</span>)&#123;</span><br><span class="line">           steps&#123;</span><br><span class="line">                echo <span class="string">&quot;deploy packge to nodes&quot;</span></span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br><span class="line">#执行效果如下</span><br></pre></td></tr></table></figure>

<p><img src="C:\Users\Lenovo\Desktop\img\367.jpg" alt="367"></p>
<p>范例：</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">pipeline &#123;</span><br><span class="line">   agent any</span><br><span class="line">   stages &#123;</span><br><span class="line">       stage(<span class="string">&#x27;Example&#x27;</span>)&#123;</span><br><span class="line">           steps &#123;</span><br><span class="line">                 echo <span class="string">&quot;Example INPUT&quot;</span></span><br><span class="line">                 input <span class="string">&#x27;Continue to next stage?&quot;</span></span><br><span class="line"><span class="string">           &#125;</span></span><br><span class="line"><span class="string">       &#125;</span></span><br><span class="line"><span class="string">   &#125;</span></span><br><span class="line"><span class="string">&#125;</span></span><br></pre></td></tr></table></figure>

<p><img src="C:\Users\Lenovo\Desktop\img\368.jpg" alt="368"></p>
<p>范例：</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">pipeline &#123;</span><br><span class="line">   agent any</span><br><span class="line">   stages &#123;</span><br><span class="line">       stage(<span class="string">&#x27;Example&#x27;</span>) &#123;</span><br><span class="line">           steps &#123;</span><br><span class="line">               script &#123;</span><br><span class="line">                   <span class="keyword">def</span> userInput = input(<span class="attr">submitterParameter:</span> <span class="string">&quot;approver&quot;</span>,</span><br><span class="line">                       <span class="symbol">id:</span> <span class="string">&quot;approve&quot;</span>, <span class="attr">message:</span> <span class="string">&quot;Provide your approval to proceed&quot;</span>,</span><br><span class="line">                       <span class="symbol">parameters:</span> [string(<span class="attr">defaultValue:</span> <span class="string">&quot;approved&quot;</span>,</span><br><span class="line">                       <span class="symbol">description:</span> <span class="string">&#x27;Please provide the message why your are approving&#x27;</span>,<span class="attr">name:</span> <span class="string">&#x27;remarks&#x27;</span>)])</span><br><span class="line">                    echo <span class="string">&quot;Remarks:$&#123;userInput[&#x27;remarks&#x27;]&#125;&quot;</span></span><br><span class="line">                    echo <span class="string">&quot;It was $&#123;userInput.approver&#125; who approved this job&quot;</span></span><br><span class="line">               &#125;</span><br><span class="line">           &#125;</span><br><span class="line">         &#125;</span><br><span class="line">     &#125;    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="C:\Users\Lenovo\Desktop\img\369.jpg" alt="369"></p>
<p>范例：</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">pipeline &#123;</span><br><span class="line">   agent any</span><br><span class="line">   stages &#123;</span><br><span class="line">       stage ( <span class="string">&#x27;check&#x27;</span> ) &#123;</span><br><span class="line">           input &#123;</span><br><span class="line">             message <span class="string">&quot;Are you ok ?&quot;</span></span><br><span class="line">             ok <span class="string">&quot;是的&quot;</span></span><br><span class="line">             parameters &#123;</span><br><span class="line">                 string(<span class="attr">name:</span> <span class="string">&#x27;PERSON&#x27;</span>, <span class="attr">defaultValue:</span> <span class="string">&#x27;王老师&#x27;</span>,<span class="attr">description:</span> <span class="string">&#x27;请输入确认者的身份&#x27;</span>)</span><br><span class="line">           &#125;</span><br><span class="line">         &#125;</span><br><span class="line">         steps &#123;</span><br><span class="line">             echo <span class="string">&quot;经过$&#123;PERSON&#125;的检查，该项目没有问题!&quot;</span></span><br><span class="line">         &#125;</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="C:\Users\Lenovo\Desktop\img\370.jpg" alt="370"><br><img src="C:\Users\Lenovo\Desktop\img\371.jpg" alt="371"></p>
<p>范例：参数化和When条件执行</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">pipeline &#123;</span><br><span class="line">   agent any</span><br><span class="line">   parameters &#123;</span><br><span class="line">       booleanParam(<span class="attr">name:</span><span class="string">&#x27;pushImage&#x27;</span>, <span class="attr">defaultValue:</span> <span class="string">&#x27;true&#x27;</span>, <span class="attr">description:</span> <span class="string">&#x27;Push Image to Harbor?&#x27;</span>)</span><br><span class="line">   &#125;</span><br><span class="line">   tools &#123;</span><br><span class="line">       maven <span class="string">&#x27;maven-3.8.6&#x27;</span></span><br><span class="line">   &#125;</span><br><span class="line">   environment &#123;</span><br><span class="line">        codeRepo=<span class="string">&quot;http://gitlab.wang.org/root/spring-boot-helloWorld.git&quot;</span></span><br><span class="line">        harborServer=<span class="string">&#x27;hub.wang.org&#x27;</span></span><br><span class="line">        projectName=<span class="string">&#x27;spring-boot-helloworld&#x27;</span></span><br><span class="line">        imageUrl=<span class="string">&quot;$&#123;harborServer&#125;/example/$&#123;projectName&#125;&quot;</span></span><br><span class="line">        imageTag=<span class="string">&#x27;latest&#x27;</span></span><br><span class="line">   &#125;</span><br><span class="line">   stages &#123;</span><br><span class="line">       stage(<span class="string">&#x27;Source&#x27;</span>) &#123;</span><br><span class="line">           steps &#123;</span><br><span class="line">                git <span class="attr">branch:</span> <span class="string">&#x27;main&#x27;</span>, <span class="attr">credentialsId:</span> <span class="string">&#x27;gitlab-root-credential&#x27;</span>, <span class="attr">url:</span> <span class="string">&quot;$&#123;codeRepo&#125;&quot;</span></span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">       stage(<span class="string">&#x27;Build&#x27;</span>) &#123;</span><br><span class="line">           steps &#123;</span><br><span class="line">                sh <span class="string">&#x27;mvn -B -DskipTests clean package&#x27;</span></span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">       stage(<span class="string">&#x27;Test&#x27;</span>) &#123;</span><br><span class="line">           steps &#123;</span><br><span class="line">                sh <span class="string">&#x27;mvn test&#x27;</span></span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">       stage(<span class="string">&#x27;Build Docker Image&#x27;</span>) &#123;</span><br><span class="line">           steps &#123;</span><br><span class="line">                sh <span class="string">&#x27;docker image build . -t &quot;$&#123;imageUrl&#125;:$&#123;imageTag&#125;&quot;&#x27;</span></span><br><span class="line">           &#125;           </span><br><span class="line">       &#125;</span><br><span class="line">       stage(<span class="string">&#x27;Push Docker Image&#x27;</span>) &#123;</span><br><span class="line">           agent any </span><br><span class="line">           steps &#123;</span><br><span class="line">               input(<span class="attr">message:</span> <span class="string">&#x27;镜像已经构建完成，是否要推送?&#x27;</span>)</span><br><span class="line">               withCredentials([usernamePassword(<span class="attr">credentialsId:</span> <span class="string">&#x27;harbor-user-credential&#x27;</span>, <span class="attr">passwordVariable:</span> <span class="string">&#x27;harborPassword&#x27;</span>, <span class="attr">usernameVariable:</span> <span class="string">&#x27;harborUserName&#x27;</span>)]) &#123;</span><br><span class="line">                    sh <span class="string">&quot;echo $&#123;harborPassword&#125; | docker login -u $&#123;env.harborUserName&#125; --password-stdin $&#123;harborServer&#125;&quot;</span></span><br><span class="line">                    sh <span class="string">&quot;docker image push $&#123;imageUrl&#125;:$&#123;imageTag&#125;&quot;</span></span><br><span class="line">               &#125;</span><br><span class="line">           &#125;   </span><br><span class="line">       &#125;        </span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="C:\Users\Lenovo\Desktop\img\372.jpg" alt="372"></p>
<h4 id="案例：条件判断"><a href="#案例：条件判断" class="headerlink" title="案例：条件判断"></a>案例：条件判断</h4><p>对于pipeline来说，使用if语句或者try语句，或者when来进行条件的流程控制，这两种方式效果相似</p>
<p>参考资料: </p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">https:</span><span class="comment">//www.jenkins.io/doc/book/pipeline/syntax/#flow-control</span></span><br><span class="line">    </span><br><span class="line">node &#123;</span><br><span class="line">   stage(<span class="string">&#x27;Example&#x27;</span>) &#123;</span><br><span class="line">       <span class="keyword">if</span> (env.BRANCH_NAME == <span class="string">&#x27;master&#x27;</span>) &#123;</span><br><span class="line">           echo <span class="string">&#x27;I only execute on the master branch&#x27;</span></span><br><span class="line">       &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">           echo <span class="string">&#x27;I execute elsewhere&#x27;</span></span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br><span class="line">node &#123;</span><br><span class="line">   stage(<span class="string">&#x27;Example&#x27;</span>) &#123;</span><br><span class="line">       <span class="keyword">try</span> &#123;</span><br><span class="line">           sh <span class="string">&#x27;exit 1&#x27;</span></span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">catch</span> (exc) &#123;</span><br><span class="line">           echo <span class="string">&#x27;Something failed, I should sound the klaxons!&#x27;</span></span><br><span class="line">           <span class="keyword">throw</span></span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>范例: </p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">node &#123;</span><br><span class="line">   stage(<span class="string">&#x27;Example &#x27;</span>) &#123;</span><br><span class="line"> <span class="keyword">if</span>(条件值==<span class="string">&#x27;匹配内容&#x27;</span>）&#123;</span><br><span class="line"> echo <span class="string">&#x27;true&#x27;</span></span><br><span class="line"> &#125; <span class="keyword">else</span> &#123;</span><br><span class="line"> echo <span class="string">&#x27;false&#x27;</span></span><br><span class="line"> &#125;</span><br><span class="line">     &#125;</span><br><span class="line">&#125;</span><br><span class="line">#范例:</span><br><span class="line">node &#123;</span><br><span class="line">   stage(<span class="string">&#x27;Example&#x27;</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (env.BRANCH_NAME == <span class="string">&#x27;master&#x27;</span>) &#123;</span><br><span class="line">            echo <span class="string">&#x27;I only execute on the master branch&#x27;</span></span><br><span class="line">       &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            echo <span class="string">&#x27;I execute elsewhere&#x27;</span></span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#在if中使用的条件值，一般使用she11命令的执行后的状态返回值来进行获取，由于jenkinsfile的特殊</span></span><br><span class="line">性，普通she11命令的状态返回值必须以文件的方式落地，也就是说stdout的内容重定向到文件，在</span><br><span class="line">jenkins的sh语法中，需要开启 <span class="built_in">return</span> status: <span class="literal">true</span>属性</span><br><span class="line"></span><br><span class="line"><span class="comment">#格式如下</span></span><br><span class="line">result = sh returnstdout: <span class="literal">true</span> ,script: <span class="string">&quot;&lt;shell command&gt;&quot;</span></span><br><span class="line">result = sh(script: <span class="string">&quot;&lt;shell command&gt;&quot;</span>，returnstdout: <span class="literal">true</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#默认情况下，sh命令的状态返回值是О或者非0，如果想要指定状态返回值的内容的话，可以使用如下格式:</span></span><br><span class="line">result = sh(script: <span class="string">&quot;&lt;shell command&gt; &amp;&amp; echo &#x27;true&#x27; || echo &#x27;false&#x27; &quot;</span>,returnstdout: <span class="literal">true</span>)</span><br></pre></td></tr></table></figure>

<p>案例: </p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">pipeline &#123;</span><br><span class="line">   agent any</span><br><span class="line">   stages &#123;</span><br><span class="line">       stage( <span class="string">&#x27;test&#x27;</span>) &#123;</span><br><span class="line">           steps&#123;</span><br><span class="line">               script&#123;</span><br><span class="line">                   result = sh(<span class="attr">script:</span> <span class="string">&quot;[ -d hello-world-war ]&quot;</span> , <span class="attr">returnStatus:</span><span class="literal">true</span>)</span><br><span class="line">                    <span class="keyword">if</span>(result == <span class="number">0</span>)&#123;</span><br><span class="line">                        sh <span class="string">&#x27;rm -rf hello-world-war&#x27;</span></span><br><span class="line">                   &#125;</span><br><span class="line">               &#125;</span><br><span class="line">                sh <span class="string">&#x27;git clone -b main git@10.0.0.100:root/hello-world-war.git&#x27;</span></span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>范例：参数化和When条件执行</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">pipeline &#123;</span><br><span class="line">   agent any</span><br><span class="line">   parameters &#123;</span><br><span class="line">       booleanParam(<span class="attr">name:</span><span class="string">&#x27;pushImage&#x27;</span>, <span class="attr">defaultValue:</span> <span class="string">&#x27;true&#x27;</span>, <span class="attr">description:</span> <span class="string">&#x27;Push Image to Harbor?&#x27;</span>)</span><br><span class="line">   &#125;    </span><br><span class="line">   tools &#123;</span><br><span class="line">       maven <span class="string">&#x27;maven-3.6.3&#x27;</span></span><br><span class="line">   &#125;</span><br><span class="line">   stages &#123;</span><br><span class="line">       stage(<span class="string">&#x27;Source&#x27;</span>) &#123;</span><br><span class="line">           steps &#123;</span><br><span class="line">                echo <span class="string">&quot;source&quot;</span></span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">       stage(<span class="string">&#x27;Build&#x27;</span>) &#123;</span><br><span class="line">           steps &#123;</span><br><span class="line">                echo <span class="string">&quot;Build&quot;</span></span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">       stage(<span class="string">&#x27;Build Docker Image&#x27;</span>) &#123;</span><br><span class="line">           steps &#123;</span><br><span class="line">                echo <span class="string">&quot;Build Docker image&quot;</span></span><br><span class="line">           &#125;           </span><br><span class="line">       &#125;</span><br><span class="line">       stage(<span class="string">&#x27;Push Docker Image&#x27;</span>) &#123;</span><br><span class="line">           agent any</span><br><span class="line">           when &#123;</span><br><span class="line">               expression &#123; <span class="string">&quot;$&#123;params.pushImage&#125;&quot;</span> == <span class="string">&#x27;true&#x27;</span> &#125;</span><br><span class="line">           &#125;</span><br><span class="line">           steps &#123;</span><br><span class="line">           echo <span class="string">&quot;Push&quot;</span></span><br><span class="line">           &#125;   </span><br><span class="line">       &#125;</span><br><span class="line">       stage(<span class="string">&#x27;Run Docker &#x27;</span>) &#123;</span><br><span class="line">           steps &#123;</span><br><span class="line"> echo <span class="string">&quot;run docker&quot;</span></span><br><span class="line">           &#125; </span><br><span class="line">       &#125; </span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="C:\Users\Lenovo\Desktop\img\373.jpg" alt="373"><br><img src="C:\Users\Lenovo\Desktop\img\374.jpg" alt="374"></p>
<p>范例：参数化和When条件执行</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">pipeline &#123;</span><br><span class="line">   agent any</span><br><span class="line">   parameters &#123;</span><br><span class="line">       booleanParam(<span class="attr">name:</span><span class="string">&#x27;pushImage&#x27;</span>, <span class="attr">defaultValue:</span> <span class="string">&#x27;true&#x27;</span>, <span class="attr">description:</span> <span class="string">&#x27;Push Image to Harbor?&#x27;</span>)</span><br><span class="line">   &#125;</span><br><span class="line">   tools &#123;</span><br><span class="line">       maven <span class="string">&#x27;maven-3.8.6&#x27;</span></span><br><span class="line">   &#125;</span><br><span class="line">   environment &#123;</span><br><span class="line">        codeRepo=<span class="string">&quot;http://gitlab.wang.org/root/spring-boot-helloWorld.git&quot;</span></span><br><span class="line">        harborServer=<span class="string">&#x27;harbor.wang.org&#x27;</span></span><br><span class="line">        projectName=<span class="string">&#x27;spring-boot-helloworld&#x27;</span></span><br><span class="line">        imageUrl=<span class="string">&quot;$&#123;harborServer&#125;/exaple/$&#123;projectName&#125;&quot;</span></span><br><span class="line">        imageTag=<span class="string">&#x27;latest&#x27;</span></span><br><span class="line">   &#125;</span><br><span class="line">   stages &#123;</span><br><span class="line">       stage(<span class="string">&#x27;Source&#x27;</span>) &#123;</span><br><span class="line">           steps &#123;</span><br><span class="line">                git <span class="attr">branch:</span> <span class="string">&#x27;main&#x27;</span>, <span class="attr">credentialsId:</span> <span class="string">&#x27;gitlab-root-credential&#x27;</span>, <span class="attr">url:</span> <span class="string">&quot;$&#123;codeRepo&#125;&quot;</span></span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">       stage(<span class="string">&#x27;Build&#x27;</span>) &#123;</span><br><span class="line">           steps &#123;</span><br><span class="line">                sh <span class="string">&#x27;mvn -B -DskipTests clean package&#x27;</span></span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">       stage(<span class="string">&#x27;Test&#x27;</span>) &#123;</span><br><span class="line">           steps &#123;</span><br><span class="line">                sh <span class="string">&#x27;mvn test&#x27;</span></span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">       stage(<span class="string">&#x27;Build Docker Image&#x27;</span>) &#123;</span><br><span class="line">           steps &#123;</span><br><span class="line">                sh <span class="string">&#x27;docker image build . -t &quot;$&#123;imageUrl&#125;:$&#123;imageTag&#125;&quot;&#x27;</span></span><br><span class="line">           &#125;           </span><br><span class="line">       &#125;</span><br><span class="line">       stage(<span class="string">&#x27;Push Docker Image&#x27;</span>) &#123;</span><br><span class="line">           agent any </span><br><span class="line">           when &#123;</span><br><span class="line">               expression &#123; <span class="string">&quot;$&#123;params.pushImage&#125;&quot;</span> == <span class="string">&#x27;true&#x27;</span> &#125;</span><br><span class="line">               <span class="symbol">beforeAgent:</span> <span class="literal">true</span></span><br><span class="line">           &#125;</span><br><span class="line">           steps &#123;</span><br><span class="line">               <span class="comment">// input(message: &#x27;continue?&#x27;)</span></span><br><span class="line">               withCredentials([usernamePassword(<span class="attr">credentialsId:</span> <span class="string">&#x27;harbor-user-credential&#x27;</span>, <span class="attr">passwordVariable:</span> <span class="string">&#x27;harborPassword&#x27;</span>, <span class="attr">usernameVariable:</span> <span class="string">&#x27;harborUserName&#x27;</span>)]) &#123;</span><br><span class="line">                    sh <span class="string">&quot;echo $&#123;harborPassword&#125; | docker login -u $&#123;env.harborUserName&#125; --password-stdin $&#123;harborServer&#125;&quot;</span></span><br><span class="line">                    sh <span class="string">&quot;docker image push $&#123;imageUrl&#125;:$&#123;imageTag&#125;&quot;</span></span><br><span class="line">               &#125;</span><br><span class="line">           &#125;   </span><br><span class="line">       &#125;        </span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>注意：第一次执行不会出现提示参数信息，第二次才会出现如下提示</p>
<p><img src="C:\Users\Lenovo\Desktop\img\375.jpg" alt="375"></p>
<h4 id="案例：Java-应用部署"><a href="#案例：Java-应用部署" class="headerlink" title="案例：Java 应用部署"></a>案例：Java 应用部署</h4><p>范例1</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">pipeline&#123; </span><br><span class="line">  agent any </span><br><span class="line">  stages &#123;</span><br><span class="line">   stage(<span class="string">&quot;clone代码&quot;</span>)&#123;</span><br><span class="line">     steps &#123;</span><br><span class="line">            sh <span class="string">&#x27;rm -rf /var/lib/jenkins/workspace/pipeline-test/*&#x27;</span></span><br><span class="line">            git <span class="attr">branch:</span> <span class="string">&#x27;main&#x27;</span>, <span class="attr">credentialsId:</span> <span class="string">&#x27;6f7f2c8b-cc7e-417b-925c-f79dbaa308a3&#x27;</span>, <span class="attr">url:</span> <span class="string">&#x27;git@gitlab.wang.org:magedu/hello-world-war.git&#x27;</span></span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br><span class="line">   stage(<span class="string">&quot;代码打包&quot;</span>)&#123;</span><br><span class="line">       steps &#123;</span><br><span class="line">            sh <span class="string">&#x27;cd /var/lib/jenkins/workspace/pipeline-test/src/main/webapp &amp;&amp; tar czvf /data/code.tar.gz *&#x27;</span></span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br><span class="line">   stage(<span class="string">&quot;代码复制&quot;</span>)&#123;</span><br><span class="line">       steps &#123;</span><br><span class="line">            sh <span class="string">&#x27;scp /data/code.tar.gz 10.0.0.8:/data/tomcat/appdir/&#x27;</span></span><br><span class="line">            sh <span class="string">&#x27;scp /data/code.tar.gz 10.0.0.18:/data/tomcat/appdir/&#x27;</span></span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br><span class="line">   stage(<span class="string">&quot;停止tomcat服务&quot;</span>)&#123;</span><br><span class="line">       steps &#123;</span><br><span class="line">            sh <span class="string">&#x27;ssh 10.0.0.8 &quot;systemctl stop tomcat&quot;&#x27;</span></span><br><span class="line">            sh <span class="string">&#x27;ssh 10.0.0.18 &quot;systemctl stop tomcat&quot;&#x27;</span></span><br><span class="line">       &#125;</span><br><span class="line">   &#125;  </span><br><span class="line">   stage(<span class="string">&quot;代码部署&quot;</span>)&#123;</span><br><span class="line">       steps &#123;</span><br><span class="line">            sh <span class="string">&#x27;ssh 10.0.0.8 &quot;rm -rf /usr/local/tomcat/webapps/myapp/* &amp;&amp; cd /data/tomcat/appdir &amp;&amp; tar xvf code.tar.gz -C /usr/local/tomcat/webapps/myapp/&quot;&#x27;</span></span><br><span class="line">            sh <span class="string">&#x27;ssh 10.0.0.18 &quot;rm -rf /usr/local/tomcat/webapps/myapp/* &amp;&amp; cd /data/tomcat/appdir &amp;&amp; tar xvf code.tar.gz -C /usr/local/tomcat/webapps/myapp/&quot;&#x27;</span></span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br><span class="line">   stage(<span class="string">&quot;启动tomcat服务&quot;</span>)&#123;</span><br><span class="line">       steps &#123;</span><br><span class="line">            sh <span class="string">&#x27;ssh 10.0.0.8 &quot;systemctl start tomcat&quot;&#x27;</span></span><br><span class="line">            sh <span class="string">&#x27;ssh 10.0.0.18 &quot;systemctl start tomcat&quot;&#x27;</span></span><br><span class="line">       &#125;</span><br><span class="line">   &#125; </span><br><span class="line"> &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>范例2</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">pipeline&#123;</span><br><span class="line">    agent &#123; label <span class="string">&quot;jenkins-slave1&quot;</span>&#125; #指定节点label</span><br><span class="line">    stages &#123;</span><br><span class="line">        stage(<span class="string">&quot;clone代码&quot;</span>)&#123;</span><br><span class="line">           <span class="comment">//agent &#123; label &quot;jenkins-slave1&quot;&#125;  #当前stage执行的节点</span></span><br><span class="line">            steps &#123;</span><br><span class="line">                sh <span class="string">&#x27;rm -rf /var/lib/jenkins/workspace/pipeline-test/*&#x27;</span></span><br><span class="line">                git <span class="attr">branch:</span> <span class="string">&#x27;develop&#x27;</span>, <span class="attr">credentialsId:</span> <span class="string">&#x27;d7e3bd0b-fd88-4ffa-b330-2258e93319ed&#x27;</span>, <span class="attr">url:</span> <span class="string">&#x27;git@10.0.0.100:magedu/app1.git&#x27;</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        stage(<span class="string">&quot;代码打包&quot;</span>)&#123;</span><br><span class="line">            steps &#123;</span><br><span class="line">            	sh <span class="string">&#x27;cd /var/lib/jenkins/workspace/pipeline-test/ &amp;&amp; tar czvf /data/code.tar.gz *&#x27;</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        stage(<span class="string">&quot;代码复制&quot;</span>)&#123;</span><br><span class="line">            steps &#123;</span><br><span class="line">                sh <span class="string">&#x27;scp /data/code.tar.gz 10.0.0.104:/data/tomcat/tomcat_appdir/&#x27;</span></span><br><span class="line">                sh <span class="string">&#x27;scp /data/code.tar.gz 10.0.0.105:/data/tomcat/tomcat_appdir/&#x27;</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        stage(<span class="string">&quot;停止tomcat服务&quot;</span>)&#123;</span><br><span class="line">            steps&#123;</span><br><span class="line">                sh <span class="string">&#x27;ssh 10.0.0.104 &quot;systemctl stop tomcat&quot;&#x27;</span></span><br><span class="line">                sh <span class="string">&#x27;ssh 10.0.0.105 &quot;systemctl stop tomcat&quot;&#x27;</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        stage(<span class="string">&quot;代码部署&quot;</span>)&#123;</span><br><span class="line">            steps &#123;</span><br><span class="line">                sh <span class="string">&#x27;ssh 10.0.0.104 &quot;rm -rf /data/tomcat/tomcat_webdir/myapp/* &amp;&amp; cd /data/tomcat/tomcat_appdir &amp;&amp; tar xvf code.tar.gz -C /data/tomcat/tomcat_webdir/myapp/&quot;&#x27;</span></span><br><span class="line">                sh <span class="string">&#x27;ssh 10.0.0.105 &quot;rm -rf /data/tomcat/tomcat_webdir/myapp/* &amp;&amp; cd /data/tomcat/tomcat_appdir &amp;&amp; tar xvf code.tar.gz -C /data/tomcat/tomcat_webdir/myapp/&quot;&#x27;</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        stage(<span class="string">&quot;启动tomcat服务&quot;</span>)&#123;</span><br><span class="line">            steps&#123;</span><br><span class="line">                sh <span class="string">&#x27;ssh 10.0.0.104 &quot;systemctl start tomcat&quot;&#x27;</span></span><br><span class="line">                sh <span class="string">&#x27;ssh 10.0.0.105 &quot;systemctl start tomcat&quot;&#x27;</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125; </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="案例：并行"><a href="#案例：并行" class="headerlink" title="案例：并行"></a>案例：并行</h4><p>并行执行</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">声明性Parallel的代码块中的可以嵌套多个stage，从而让多个stage任务并行执行。</span><br><span class="line">注意:</span><br><span class="line">一个stage有且只能有一个steps，stages或parallel</span><br><span class="line">嵌套的stages本身不能包含其他paralle stage</span><br><span class="line">但在其他方面的行为与stage相同</span><br><span class="line">任何包含parallel的stage都不能包含agent或者tools</span><br></pre></td></tr></table></figure>

<p>案例: 并行执行</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">pipeline &#123;</span><br><span class="line">   agent any</span><br><span class="line">   stages &#123;</span><br><span class="line">       stage( <span class="string">&#x27;Deploy&#x27;</span>) &#123;</span><br><span class="line">           parallel &#123;</span><br><span class="line">               stage(<span class="string">&#x27;deploy_proxy&#x27;</span>)&#123;</span><br><span class="line">                   steps &#123;</span><br><span class="line">                        echo <span class="string">&quot;部署反向代理服务&quot;</span></span><br><span class="line">                   &#125;</span><br><span class="line">               &#125;</span><br><span class="line">               stage(<span class="string">&#x27;deploy app1&#x27;</span>) &#123;</span><br><span class="line">                   steps &#123;</span><br><span class="line">                        echo <span class="string">&quot;部署deploy_app1应用&quot;</span></span><br><span class="line">                   &#125;</span><br><span class="line">               &#125;</span><br><span class="line">               stage (<span class="string">&#x27;deploy app2&#x27;</span>)&#123;</span><br><span class="line">                   stages &#123;</span><br><span class="line">                       stage (<span class="string">&#x27;delete container&#x27;</span>) &#123;</span><br><span class="line">                           steps &#123;</span><br><span class="line">                                 echo <span class="string">&quot;删除旧容器&quot;</span></span><br><span class="line">                           &#125;</span><br><span class="line">                       &#125;</span><br><span class="line">                       stage(<span class="string">&#x27;start container&#x27;</span>) &#123;</span><br><span class="line">                           steps &#123;</span><br><span class="line">                                echo <span class="string">&quot;启动新容器&quot;</span></span><br><span class="line">                           &#125;</span><br><span class="line">                       &#125;</span><br><span class="line">                   &#125;</span><br><span class="line">               &#125;</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>无法看并行执行的效果</p>
<p><img src="C:\Users\Lenovo\Desktop\img\376.jpg" alt="376"></p>
<p>安装 Blue Ocean插件</p>
<p><img src="C:\Users\Lenovo\Desktop\img\377.jpg" alt="377"><br><img src="C:\Users\Lenovo\Desktop\img\378.jpg" alt="378"></p>
<p>案例：并行</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">pipeline &#123;</span><br><span class="line">   agent any</span><br><span class="line">   stages &#123;</span><br><span class="line">       stage(<span class="string">&#x27;获取代码&#x27;</span>)&#123;</span><br><span class="line">           steps &#123;</span><br><span class="line">                sh <span class="string">&#x27;echo &quot;获取代码&quot;&#x27;</span></span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">       stage(<span class="string">&#x27;构建代码&#x27;</span>)&#123;</span><br><span class="line">           steps &#123;</span><br><span class="line">                sh <span class="string">&#x27;echo &quot;构建代码&quot;&#x27;</span></span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">       stage(<span class="string">&#x27;测试阶段&#x27;</span>)&#123;</span><br><span class="line">           parallel &#123;</span><br><span class="line">               stage(<span class="string">&#x27;接口测试&#x27;</span>)&#123;</span><br><span class="line">                   steps &#123;</span><br><span class="line">                        sh <span class="string">&#x27;echo &quot;接口测试&quot;&#x27;</span></span><br><span class="line">                   &#125;</span><br><span class="line">               &#125;</span><br><span class="line">               stage(<span class="string">&#x27;系统测试&#x27;</span>)&#123;</span><br><span class="line">                   steps &#123;</span><br><span class="line">                        sh <span class="string">&#x27;echo &quot;系统测试&quot;&#x27;</span></span><br><span class="line">                   &#125;</span><br><span class="line">               &#125;</span><br><span class="line">               stage( <span class="string">&#x27;压力测试&#x27;</span>)&#123;</span><br><span class="line">                   steps &#123;</span><br><span class="line">                        sh <span class="string">&#x27;echo &quot;压力测试&quot;&#x27;</span></span><br><span class="line">                   &#125;</span><br><span class="line">               &#125;</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">       stage(<span class="string">&#x27;环境部署&#x27;</span>)&#123;</span><br><span class="line">           steps &#123;</span><br><span class="line">                sh <span class="string">&#x27;echo &quot;环境部署&quot;&#x27;</span></span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">       stage(<span class="string">&#x27;项目检查&#x27;</span>)&#123;</span><br><span class="line">           steps &#123;</span><br><span class="line">                sh <span class="string">&#x27;echo &quot;项目检查&quot;&#x27;</span></span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">       stage(<span class="string">&#x27;环境清理&#x27;</span>)&#123;</span><br><span class="line">           steps &#123;</span><br><span class="line">                sh <span class="string">&#x27;echo &quot;环境清理&quot;&#x27;</span></span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="C:\Users\Lenovo\Desktop\img\379.jpg" alt="379"><br><img src="C:\Users\Lenovo\Desktop\img\380.jpg" alt="380"></p>
<h4 id="案例：构建后操作"><a href="#案例：构建后操作" class="headerlink" title="案例：构建后操作"></a>案例：构建后操作</h4><p>流水线也提供了构建后的动作，常可用于消息通知</p>
<p>这个动作就在post 配置段中</p>
<p>post部分定义了一个或多个在管道或阶段运行完成后运行的附加步骤(取决于post 部分在管道中的位置)。</p>
<p>post可以支持以下任何后置条件块:</p>
<p>always、changed、fixed、regression、aborted、 failure、successunstable、 unsuccessful、cleanup。</p>
<p>这些条件块允许根据管道或阶段的完成状态在每个条件内执行步骤。条件块按如下所示的顺序执行。</p>
<p>格式说明</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">在stages同级别的位置，添加一个post配置段</span><br><span class="line">post &#123;</span><br><span class="line">     always &#123;</span><br><span class="line">         echo &#x27;任执行结束后执行此操作&#x27;</span><br><span class="line">     &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>范例：邮件通知</p>
<p>注意：需要事先配置好Jenkins的邮件配置</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">pipeline &#123;</span><br><span class="line">   agent any</span><br><span class="line">   parameters &#123;</span><br><span class="line">       booleanParam(<span class="attr">name:</span><span class="string">&#x27;pushImage&#x27;</span>, <span class="attr">defaultValue:</span> <span class="string">&#x27;true&#x27;</span>, <span class="attr">description:</span> <span class="string">&#x27;Push Image to Harbor?&#x27;</span>)</span><br><span class="line">   &#125;    </span><br><span class="line">   tools &#123;</span><br><span class="line">       maven <span class="string">&#x27;maven-3.6.3&#x27;</span></span><br><span class="line">   &#125;</span><br><span class="line">   stages &#123;</span><br><span class="line">       stage(<span class="string">&#x27;Source&#x27;</span>) &#123;</span><br><span class="line">           steps &#123;</span><br><span class="line">                echo <span class="string">&quot;source&quot;</span></span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">       stage(<span class="string">&#x27;Build&#x27;</span>) &#123;</span><br><span class="line">           steps &#123;</span><br><span class="line">                echo <span class="string">&quot;Build&quot;</span></span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">       stage(<span class="string">&#x27;Build Docker Image&#x27;</span>) &#123;</span><br><span class="line">           steps &#123;</span><br><span class="line">                echo <span class="string">&quot;Build Docker image&quot;</span></span><br><span class="line">           &#125;           </span><br><span class="line">       &#125;</span><br><span class="line">       stage(<span class="string">&#x27;Push Docker Image&#x27;</span>) &#123;</span><br><span class="line">           agent any</span><br><span class="line">           when &#123;</span><br><span class="line">               expression &#123; <span class="string">&quot;$&#123;params.pushImage&#125;&quot;</span> == <span class="string">&#x27;true&#x27;</span> &#125;</span><br><span class="line">           &#125;</span><br><span class="line">           steps &#123;</span><br><span class="line">           echo <span class="string">&quot;Push&quot;</span></span><br><span class="line">           &#125;   </span><br><span class="line">       &#125;</span><br><span class="line">       stage(<span class="string">&#x27;Run Docker &#x27;</span>) &#123;</span><br><span class="line">           steps &#123;</span><br><span class="line"> echo <span class="string">&quot;run docker&quot;</span></span><br><span class="line">           &#125;   </span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br><span class="line">   post &#123;</span><br><span class="line">       always &#123;</span><br><span class="line">           mail <span class="attr">to:</span> <span class="string">&#x27;root@wangxiaochun.com&#x27;</span>,</span><br><span class="line">           <span class="symbol">subject:</span> <span class="string">&quot;Status of pipeline: $&#123;currentBuild.fullDisplayName&#125;&quot;</span>,</span><br><span class="line">           <span class="symbol">body:</span> <span class="string">&quot;$&#123;env.BUILD_URL&#125; has result $&#123;currentBuild.result&#125;&quot;</span></span><br><span class="line">       &#125;</span><br><span class="line">   &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="C:\Users\Lenovo\Desktop\img\381.jpg" alt="381"><br><img src="C:\Users\Lenovo\Desktop\img\382.jpg" alt="382"><br><img src="C:\Users\Lenovo\Desktop\img\383.jpg" alt="383"></p>
<p>案例: 利用 Email 插件实现任务完成状态通知</p>
<p>Email Extension 插件说明</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://www.jenkins.io/doc/pipeline/steps/email-ext/#emailext-extended-email</span><br></pre></td></tr></table></figure>

<p>安装插件<code> Email Extension</code></p>
<p><img src="C:\Users\Lenovo\Desktop\img\384.jpg" alt="384"></p>
<p>系统管理– 系统配置 配置邮件信息</p>
<p><img src="C:\Users\Lenovo\Desktop\img\385.jpg" alt="385"></p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">pipeline &#123;</span><br><span class="line">   agent any    </span><br><span class="line">   stages &#123;</span><br><span class="line">       stage(<span class="string">&#x27;test&#x27;</span>) &#123;</span><br><span class="line">           steps &#123;</span><br><span class="line">               echo <span class="string">&#x27;test&#x27;</span></span><br><span class="line">               sh <span class="string">&#x27;true&#x27;</span></span><br><span class="line">               <span class="comment">//sh &#x27;false&#x27;</span></span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br><span class="line">   post &#123;</span><br><span class="line">       success &#123;</span><br><span class="line">           emailext (</span><br><span class="line">               <span class="symbol">body:</span> <span class="string">&quot;&quot;&quot;项目名称: $&#123;JOB_NAME&#125;\n构建编号:$&#123;BUILD_NUMBER&#125;\n构建日志:$&#123;BUILD_URL&#125;console&quot;&quot;&quot;</span>,</span><br><span class="line">               <span class="symbol">subject:</span> <span class="string">&#x27;【Jenkins构建通知】:$JOB_NAME - Build # $BUILD_NUMBER - 成功!&#x27;</span>,</span><br><span class="line">               <span class="symbol">to:</span> <span class="string">&#x27;29308620@qq.com&#x27;</span>,</span><br><span class="line">               <span class="symbol">from:</span> <span class="string">&#x27;29308620@qq.com&#x27;</span></span><br><span class="line">           )</span><br><span class="line">       &#125;</span><br><span class="line">       failure &#123;</span><br><span class="line">           emailext (</span><br><span class="line">               <span class="symbol">body:</span> <span class="string">&quot;&quot;&quot;项目名称: $&#123;JOB_NAME&#125;\n构建编号:$&#123;BUILD_NUMBER&#125;\n构建日志:$&#123;BUILD_URL&#125;console&quot;&quot;&quot;</span>,</span><br><span class="line">               <span class="symbol">subject:</span> <span class="string">&#x27;【Jenkins构建通知】:$JOB_NAME - Build # $BUILD_NUMBER - 失败!&#x27;</span>,</span><br><span class="line">               <span class="symbol">to:</span> <span class="string">&#x27;29308620@qq.com&#x27;</span>,</span><br><span class="line">               <span class="symbol">from:</span> <span class="string">&#x27;29308620@qq.com&#x27;</span></span><br><span class="line">           )</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>构建后可以收到下面成功和失败的邮件</p>
<p><img src="C:\Users\Lenovo\Desktop\img\386.jpg" alt="386"><br><img src="C:\Users\Lenovo\Desktop\img\387.jpg" alt="387"></p>
<p>范例：钉钉通知</p>
<p>注意：需要安装DingTalk插件并配置</p>
<p><img src="C:\Users\Lenovo\Desktop\img\388.jpg" alt="388"></p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">post &#123;</span><br><span class="line">       always &#123;</span><br><span class="line">           dingtalk(</span><br><span class="line">               <span class="symbol">robot:</span> <span class="string">&#x27;dingtalk&#x27;</span>,</span><br><span class="line">               <span class="symbol">type:</span> <span class="string">&#x27;TEXT&#x27;</span>,</span><br><span class="line">               <span class="symbol">text:</span> [</span><br><span class="line">                    <span class="string">&quot;Status of pipeline: $&#123;currentBuild.fullDisplayName&#125;&quot;</span>,</span><br><span class="line">                    <span class="string">&quot;$&#123;env.BUILD_URL&#125; has result $&#123;currentBuild.result&#125;.&quot;</span></span><br><span class="line">               ]</span><br><span class="line">           )</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<p>范例：企业微信</p>
<p>注意：需要安装Qy Wechat Notification插件并配置</p>
<p>范例</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">post&#123;</span><br><span class="line">       success&#123;</span><br><span class="line">           qyWechatNotification <span class="attr">failNotify:</span> <span class="literal">true</span>, <span class="attr">webhookUrl:</span> <span class="string">&#x27;https://qyapi.weixin.qq.com/cgi-bin/webhook/send?key=c79e3215-d39f-44a7-a760-fa0ab63ca46b&#x27;</span></span><br><span class="line">       &#125;</span><br><span class="line">       failure&#123;</span><br><span class="line">           qyWechatNotification <span class="attr">failNotify:</span> <span class="literal">true</span>, <span class="attr">webhookUrl:</span> <span class="string">&#x27;https://qyapi.weixin.qq.com/cgi-bin/webhook/send?key=c79e3215-d39f-44a7-a760-fa0ab63ca46b&#x27;</span></span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>范例：综合案例，成功发邮件，失败发微信</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">pipeline &#123;</span><br><span class="line">   agent any</span><br><span class="line">   parameters &#123;</span><br><span class="line">       booleanParam(<span class="attr">name:</span><span class="string">&#x27;pushImage&#x27;</span>, <span class="attr">defaultValue:</span> <span class="string">&#x27;true&#x27;</span>, <span class="attr">description:</span> <span class="string">&#x27;Push </span></span><br><span class="line"><span class="string">Image to Harbor?&#x27;</span>)</span><br><span class="line">   &#125;    </span><br><span class="line">   tools &#123;</span><br><span class="line">       maven <span class="string">&#x27;maven-3.6.3&#x27;</span></span><br><span class="line">   &#125;</span><br><span class="line">   stages &#123;</span><br><span class="line">       stage(<span class="string">&#x27;Source&#x27;</span>) &#123;</span><br><span class="line">           steps &#123;</span><br><span class="line">                echo <span class="string">&quot;source&quot;</span></span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">       stage(<span class="string">&#x27;Build&#x27;</span>) &#123;</span><br><span class="line">           steps &#123;</span><br><span class="line">                echo <span class="string">&quot;Build&quot;</span></span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">       stage(<span class="string">&#x27;Build Docker Image&#x27;</span>) &#123;</span><br><span class="line">           steps &#123;</span><br><span class="line">                echo <span class="string">&quot;Build Docker image&quot;</span></span><br><span class="line">           &#125;           </span><br><span class="line">       &#125;</span><br><span class="line">       stage(<span class="string">&#x27;Push Docker Image&#x27;</span>) &#123;</span><br><span class="line">           agent any</span><br><span class="line">           when &#123;</span><br><span class="line">               expression &#123; <span class="string">&quot;$&#123;params.pushImage&#125;&quot;</span> == <span class="string">&#x27;true&#x27;</span>            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">           steps &#123;</span><br><span class="line">           echo <span class="string">&quot;Push&quot;</span></span><br><span class="line">           &#125;   </span><br><span class="line">       &#125;</span><br><span class="line">       stage(<span class="string">&#x27;Run Docker &#x27;</span>) &#123;</span><br><span class="line">           steps &#123;</span><br><span class="line"> echo <span class="string">&quot;run docker&quot;</span></span><br><span class="line">           &#125;   </span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br><span class="line">   post &#123;</span><br><span class="line">       success &#123;</span><br><span class="line">           mail <span class="attr">to:</span> <span class="string">&#x27;root@wangxiaochun.com&#x27;</span>,</span><br><span class="line">           <span class="symbol">subject:</span> <span class="string">&quot;Status of pipeline: $&#123;currentBuild.fullDisplayName&#125;&quot;</span>,</span><br><span class="line">           <span class="symbol">body:</span> <span class="string">&quot;$&#123;env.BUILD_URL&#125; has result $&#123;currentBuild.result&#125;&quot;</span></span><br><span class="line">       &#125;</span><br><span class="line">       failure&#123;</span><br><span class="line">           qyWechatNotification <span class="attr">failNotify:</span> <span class="literal">true</span>, <span class="attr">webhookUrl:</span> <span class="string">&#x27;https://qyapi.weixin.qq.com/cgi-bin/webhook/send?key=1a4e1e74-e7d6-4376-99f6-048b01a7b7fc&#x27;</span></span><br><span class="line">       &#125;</span><br><span class="line">   &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="C:\Users\Lenovo\Desktop\img\389.jpg" alt="389"></p>
<h2 id="Jenkins-视图"><a href="#Jenkins-视图" class="headerlink" title="Jenkins 视图"></a>Jenkins 视图</h2><p>视图可用于归档job进行分组显示，比如将一个业务的视图放在一个视图显示，安装完成插件之后将会有一个+号用于创建视图，支持三种视图，其中列表视图使用较多。</p>
<p><img src="C:\Users\Lenovo\Desktop\img\390.jpg" alt="390"></p>
<h3 id="列表视图"><a href="#列表视图" class="headerlink" title="列表视图"></a>列表视图</h3><p>列表视图使用场景比较多，用于将同一个业务的job保存至一个列表视图进行分类管理，即不同业务的job放在不同的列表视图中。</p>
<h4 id="创建新的视图"><a href="#创建新的视图" class="headerlink" title="创建新的视图"></a>创建新的视图</h4><p><img src="C:\Users\Lenovo\Desktop\img\391.jpg" alt="391"></p>
<h4 id="定义视图名称"><a href="#定义视图名称" class="headerlink" title="定义视图名称"></a>定义视图名称</h4><p><img src="C:\Users\Lenovo\Desktop\img\392.jpg" alt="392"></p>
<h4 id="选择视图包含的任务"><a href="#选择视图包含的任务" class="headerlink" title="选择视图包含的任务"></a>选择视图包含的任务</h4><p>选择相关的任务名称</p>
<p><img src="C:\Users\Lenovo\Desktop\img\393.jpg" alt="393"></p>
<p>还支持正则表达式进行过滤任务</p>
<p><img src="C:\Users\Lenovo\Desktop\img\394.jpg" alt="394"></p>
<h4 id="最终状态"><a href="#最终状态" class="headerlink" title="最终状态"></a>最终状态</h4><p><img src="C:\Users\Lenovo\Desktop\img\395.jpg" alt="395"></p>
<h3 id="我的视图"><a href="#我的视图" class="headerlink" title="我的视图"></a>我的视图</h3><p>我的视图会显示当前账户有权限访问的job，因此需要提前划分好权限。</p>
<h4 id="创建我的视图"><a href="#创建我的视图" class="headerlink" title="创建我的视图"></a>创建我的视图</h4><p>创建后点保存，就会直接看到当前账户有权限的job。</p>
<p><img src="C:\Users\Lenovo\Desktop\img\396.jpg" alt="396"></p>
<h4 id="最终状态-1"><a href="#最终状态-1" class="headerlink" title="最终状态"></a>最终状态</h4><p><img src="C:\Users\Lenovo\Desktop\img\397.jpg" alt="397"></p>
<h3 id="Pipeline-视图"><a href="#Pipeline-视图" class="headerlink" title="Pipeline 视图"></a>Pipeline 视图</h3><p><strong>Pipeline 视图可以显示任务之间的上下游关系，而非Pipeline风格的任务</strong></p>
<h4 id="安装-build-pipeline-插件"><a href="#安装-build-pipeline-插件" class="headerlink" title="安装 build pipeline 插件"></a>安装 build pipeline 插件</h4><p>安装 build pipeline 插件，可以在原来“列表视图”和“我的视图”上面增加“Build Pipeline View”</p>
<p><img src="C:\Users\Lenovo\Desktop\img\398.jpg" alt="398"><br><img src="C:\Users\Lenovo\Desktop\img\399.jpg" alt="399"><br><img src="C:\Users\Lenovo\Desktop\img\400.jpg" alt="400"></p>
<h4 id="创建视图"><a href="#创建视图" class="headerlink" title="创建视图"></a>创建视图</h4><p><img src="C:\Users\Lenovo\Desktop\img\401.jpg" alt="401"></p>
<h4 id="定义视图配置信息"><a href="#定义视图配置信息" class="headerlink" title="定义视图配置信息"></a>定义视图配置信息</h4><p><img src="C:\Users\Lenovo\Desktop\img\402.jpg" alt="402"></p>
<p>配置说明</p>
<p>No Of Displayed Builds 构建记录默认是1，此处修改为10</p>
<p><img src="C:\Users\Lenovo\Desktop\img\403.jpg" alt="403"><br><img src="C:\Users\Lenovo\Desktop\img\404.jpg" alt="404"></p>
<h4 id="Web-显示界面"><a href="#Web-显示界面" class="headerlink" title="Web 显示界面"></a>Web 显示界面</h4><p>以下图示表示 test-job1 —&gt; test-job2 —&gt; test-job3 构成上下游的任务关系</p>
<p><img src="C:\Users\Lenovo\Desktop\img\405.jpg" alt="405"></p>
<h2 id="Jenkins-权限管理"><a href="#Jenkins-权限管理" class="headerlink" title="Jenkins 权限管理"></a>Jenkins 权限管理</h2><p>默认jenkins用户可以执行所有操作和管理所有job</p>
<p>为了更好的分层控制，可以实现基于角色的权限管理，先创建角色和用户，给角色授权，然后把用户管理到角色。</p>
<p><strong>查看默认的权限设</strong></p>
<p>新版界面</p>
<p><img src="C:\Users\Lenovo\Desktop\img\406.jpg" alt="406"></p>
<p>旧版界面</p>
<p><img src="C:\Users\Lenovo\Desktop\img\407.jpg" alt="407"></p>
<h3 id="创建新用户"><a href="#创建新用户" class="headerlink" title="创建新用户"></a>创建新用户</h3><p>默认所有jenkins用户都具有管理权限</p>
<p>Jenkins—系统管理—管理用户— 新建用户</p>
<p><img src="C:\Users\Lenovo\Desktop\img\408.jpg" alt="408"><br><img src="C:\Users\Lenovo\Desktop\img\409.jpg" alt="409"><br><img src="C:\Users\Lenovo\Desktop\img\410.jpg" alt="410"><br><img src="C:\Users\Lenovo\Desktop\img\411.jpg" alt="411"></p>
<p>使用wang用户登录，重复上面操作，也可以创建mage用户</p>
<p><img src="C:\Users\Lenovo\Desktop\img\412.jpg" alt="412"></p>
<p>说明默认所有用户都是管理员权限</p>
<p><img src="C:\Users\Lenovo\Desktop\img\413.jpg" alt="413"></p>
<h3 id="安装角色权限相关的插件"><a href="#安装角色权限相关的插件" class="headerlink" title="安装角色权限相关的插件"></a>安装角色权限相关的插件</h3><p>搜索<code>Role-based Authorization Strategy</code>可以找到下面插件</p>
<p><img src="C:\Users\Lenovo\Desktop\img\414.jpg" alt="414"><br><img src="C:\Users\Lenovo\Desktop\img\415.jpg" alt="415"></p>
<p>如果直接下载失败，可以直接清华源下载，将插件放在 <code>/var/lib/jenkins/plugins</code> 目录下</p>
<p><img src="C:\Users\Lenovo\Desktop\img\416.jpg" alt="416"></p>
<h3 id="更改认证方式"><a href="#更改认证方式" class="headerlink" title="更改认证方式"></a>更改认证方式</h3><p>Jenkins—系统管理—全局安全配置</p>
<p>默认创建的用户登录后可以做任何操作，取决于默认的认证授权方式。</p>
<p><img src="C:\Users\Lenovo\Desktop\img\417.jpg" alt="417"><br><img src="C:\Users\Lenovo\Desktop\img\418.jpg" alt="418"></p>
<h3 id="创建全局角色"><a href="#创建全局角色" class="headerlink" title="创建全局角色"></a>创建全局角色</h3><p>Jenkins—系统管理–Manage and Assign Roles</p>
<p>最新版界面</p>
<p><img src="C:\Users\Lenovo\Desktop\img\419.jpg" alt="419"></p>
<p>较新版界面</p>
<p><img src="C:\Users\Lenovo\Desktop\img\420.jpg" alt="420"><br><img src="C:\Users\Lenovo\Desktop\img\421.jpg" alt="421"></p>
<p>旧版界面</p>
<p><img src="C:\Users\Lenovo\Desktop\img\422.jpg" alt="422"><br><img src="C:\Users\Lenovo\Desktop\img\423.jpg" alt="423"><br><img src="C:\Users\Lenovo\Desktop\img\424.jpg" alt="424"><br><img src="C:\Users\Lenovo\Desktop\img\425.jpg" alt="425"></p>
<h3 id="对全局角色分配权限"><a href="#对全局角色分配权限" class="headerlink" title="对全局角色分配权限"></a>对全局角色分配权限</h3><p>全局角色配置分配权限，实现控制登陆用户能操作jenkins的那些资源</p>
<p>只分配置全部overall中的Read权限即可</p>
<p><img src="C:\Users\Lenovo\Desktop\img\426.jpg" alt="426"></p>
<p><strong>注意：add完成后，还需要保存</strong></p>
<p>旧版</p>
<p><img src="C:\Users\Lenovo\Desktop\img\427.jpg" alt="427"></p>
<h3 id="将用户关联到全局角色"><a href="#将用户关联到全局角色" class="headerlink" title="将用户关联到全局角色"></a>将用户关联到全局角色</h3><p>Jenkins—系统管理–Manage and Assign Roles —Assign Roles</p>
<p><img src="C:\Users\Lenovo\Desktop\img\428.jpg" alt="428"><br><img src="C:\Users\Lenovo\Desktop\img\429.jpg" alt="429"><br><img src="C:\Users\Lenovo\Desktop\img\430.jpg" alt="430"><br><img src="C:\Users\Lenovo\Desktop\img\431.jpg" alt="431"><br><img src="C:\Users\Lenovo\Desktop\img\432.jpg" alt="432"></p>
<h3 id="测试普通用户登录"><a href="#测试普通用户登录" class="headerlink" title="测试普通用户登录"></a>测试普通用户登录</h3><p><img src="C:\Users\Lenovo\Desktop\img\433.jpg" alt="433"></p>
<p>登录成功之的界面，没有系统管理权限，只能执行被授权过的job且没有了管理员权限。</p>
<p><img src="C:\Users\Lenovo\Desktop\img\434.jpg" alt="434"></p>
<h3 id="创建项目角色"><a href="#创建项目角色" class="headerlink" title="创建项目角色"></a>创建项目角色</h3><p>项目角色分配权限， 用于控制用户能看到哪些项目，并且有什么样的权限</p>
<p>项目角色使用pattern正则表达式，用于匹配相关的项目名称</p>
<p>比如: pattern 设为正则表达式testproject.* 表示所有testproject开头的job</p>
<p><img src="C:\Users\Lenovo\Desktop\img\435.jpg" alt="435"><br><img src="C:\Users\Lenovo\Desktop\img\436.jpg" alt="436"></p>
<p>可以显示匹配的job</p>
<p><img src="C:\Users\Lenovo\Desktop\img\437.jpg" alt="437"><br><img src="C:\Users\Lenovo\Desktop\img\438.jpg" alt="438"></p>
<p>再创建项目角色testproject2-role</p>
<p><img src="C:\Users\Lenovo\Desktop\img\439.jpg" alt="439"></p>
<h3 id="对项目角色分配权限"><a href="#对项目角色分配权限" class="headerlink" title="对项目角色分配权限"></a>对项目角色分配权限</h3><p>给项目角色分配权限，可以在凭据部分授予View权限即可，其它部分全部权限。</p>
<p>分配权限如下显示</p>
<p><img src="C:\Users\Lenovo\Desktop\img\440.jpg" alt="440"></p>
<h3 id="将用户关联到项目角色"><a href="#将用户关联到项目角色" class="headerlink" title="将用户关联到项目角色"></a>将用户关联到项目角色</h3><p>Jenkins—系统管理–Manage and Assign Roles —Assign Roles</p>
<p><img src="C:\Users\Lenovo\Desktop\img\441.jpg" alt="441"><br><img src="C:\Users\Lenovo\Desktop\img\442.jpg" alt="442"><br><img src="C:\Users\Lenovo\Desktop\img\443.jpg" alt="443"></p>
<h3 id="用户登录验证结果"><a href="#用户登录验证结果" class="headerlink" title="用户登录验证结果"></a>用户登录验证结果</h3><p>用wang用户登录查看以下显示</p>
<p><img src="C:\Users\Lenovo\Desktop\img\444.jpg" alt="444"></p>
<p>用户mage登录，查看</p>
<p><img src="C:\Users\Lenovo\Desktop\img\445.jpg" alt="445"><br><img src="C:\Users\Lenovo\Desktop\img\446.jpg" alt="446"></p>
<h1 id="代码质量检测-SonarQube"><a href="#代码质量检测-SonarQube" class="headerlink" title="代码质量检测 SonarQube"></a>代码质量检测 SonarQube</h1><h2 id="代码质量检测工具-SonarQube"><a href="#代码质量检测工具-SonarQube" class="headerlink" title="代码质量检测工具 SonarQube"></a>代码质量检测工具 SonarQube</h2><h3 id="代码测试工具-SonarQube-简介"><a href="#代码测试工具-SonarQube-简介" class="headerlink" title="代码测试工具 SonarQube 简介"></a>代码测试工具 SonarQube 简介</h3><p><img src="https://assets-eu-01.kc-usercontent.com/5dddefee-e8bb-013a-3b4e-7907971cf825/679d64ab-c8d4-4525-afff-c03747f121dc/sonarqube-server-logo-3.svg" alt="logo"></p>
<p>SonarQube 是一个开源平台，用于管理源代码的质量。Sonar 不只是一个质量数据报告工具，更是代码质量管理平台。支持的语言包括：Java、Go、Python、PHP、C、C++C#、C#、JavaScripts、Scala、HTML、PL/SQL、Swift、Ruby等29种语言。</p>
<p><img src="C:\Users\Lenovo\Desktop\img\447.jpg" alt="447"></p>
<p>SonarQube是一种自动代码审查工具，用于检测代码中的错误漏洞和代码异味，它集成到现有的工作流程，以便在项目分支和拉取(PR)请求之间进行连续的代码检查 </p>
<p>SonarQube 支持多种插件，实现和 Jenkins 等 CICD 工具的集成</p>
<p><img src="C:\Users\Lenovo\Desktop\img\448.jpg" alt="448"></p>
<p><strong>主要特点：</strong> </p>
<ul>
<li>代码覆盖：通过单元测试，将会显示哪行代码被选中</li>
<li>改善编码规则</li>
<li>搜寻编码规则：按照名字，插件，激活级别和类别进行查询</li>
<li>项目搜寻：按照项目的名字进行查询</li>
<li>对比数据：比较同一张表中的任何测量的趋势</li>
</ul>
<p>官方网站：<a target="_blank" rel="noopener" href="http://www.sonarqube.org/">http://www.sonarqube.org/</a> </p>
<p>下载地址：<a target="_blank" rel="noopener" href="https://www.sonarqube.org/downloads/">https://www.sonarqube.org/downloads/</a> </p>
<p>Github 地址: <a target="_blank" rel="noopener" href="https://github.com/SonarSource/sonarqube">https://github.com/SonarSource/sonarqube</a></p>
<h3 id="七个维度检测代码质量"><a href="#七个维度检测代码质量" class="headerlink" title="七个维度检测代码质量"></a>七个维度检测代码质量</h3><ol>
<li><p>可维护性（maintainability）</p>
<p>所谓“代码易维护”就是指，在不破坏原有代码设计、不引入新的 bug 的情况下，能够快速地修改或者添加代码。 </p>
</li>
<li><p>可读性（readability）</p>
<p>在编写代码的时候，时刻要考虑到代码是否易读、易理解。除此之外，代码的可读性在非常大程度上会影响代码的可维护性。</p>
<p>看代码是否符合编码规范、命名是否达意、注释是否详尽、函数是否长短合适、模块划分是否清晰、是否符合高内聚低耦合等等。</p>
<p>code review 是一个很好的测验代码可读性的手段</p>
</li>
<li><p>可扩展性（extensibility）</p>
<p>表示代码应对未来需求变化的能力。跟可读性一样，代码是否易扩展也很大程度上决定代码是否易维护.</p>
<p>代码的可扩展性表示，在不修改或少量修改原有代码的情况下，通过扩展的方式添加新的功能代码</p>
</li>
<li><p>灵活性（flexibility）</p>
<p>如果一段代码易扩展、易复用或者易用，都可以称这段代码写得比较灵活 </p>
</li>
<li><p>简洁性（simplicity）</p>
<p>KISS ( Keep It Simple, Stupid)原则:尽量保持代码简单。代码简单、逻辑清晰，也就意味着易读、易维护.</p>
</li>
<li><p>可复用性（reusability）</p>
<p>代码的可复用性可以简单地理解为，尽量减少重复代码的编写，复用已有的代码</p>
</li>
<li><p>可测试性（testability）</p>
<p>代码可测试性的好坏，能从侧面上非常准确地反应代码质量的好坏。代码的可测试性差，比较难写单元测试，那基本上就能说明代码设计得有问题</p>
</li>
</ol>
<h3 id="架构和集成"><a href="#架构和集成" class="headerlink" title="架构和集成"></a>架构和集成</h3><p>官方说明</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">https://docs.sonarqube.org/8.9/architecture/architecture-integration/</span><br><span class="line">https://docs.sonarqube.org/7.9/architecture/architecture-integration/</span><br></pre></td></tr></table></figure>

<h4 id="SonarQube-架构"><a href="#SonarQube-架构" class="headerlink" title="SonarQube 架构"></a>SonarQube 架构</h4><p><strong>SonarQube 四个主要组件</strong></p>
<p><img src="C:\Users\Lenovo\Desktop\img\449.jpg" alt="449"></p>
<ul>
<li>SonarQube Server 包括三个主要部分<ul>
<li>Web Server: UI 界面</li>
<li>Search Server :为UI提供搜索功能，基于 ElasticSearch 实现</li>
<li>Compute Engine Server：处理代码分析报告，并将之存储到 SonarQube Database</li>
</ul>
</li>
<li>SonarQube Database: 负责存储 SonarQube 的配置，以及项目的质量快照等</li>
<li>SonarQube Plugin: 可以在 SonarQube Server 安装丰富的插件，实现支持各种开发语言、SCM、集成、身份验证和治理等功能</li>
<li>Code analysis Scanners: 代码扫描器，是SonarQube Server的客户端， 将代码扫描后得出报告提交给 SonarQube Server</li>
</ul>
<h4 id="SonarQube-生态集成"><a href="#SonarQube-生态集成" class="headerlink" title="SonarQube 生态集成"></a>SonarQube 生态集成</h4><p>Sonar有两种使用方式：插件和客户端。</p>
<p>Sonar的插件名称为 sonarlint,实现支持多种开发工具的IDE的插件安装</p>
<p><img src="C:\Users\Lenovo\Desktop\img\450.jpg" alt="450"></p>
<h3 id="SonarQube-版本说明"><a href="#SonarQube-版本说明" class="headerlink" title="SonarQube 版本说明"></a>SonarQube 版本说明</h3><p>SonarQube 分为: 社区版，开发版，企业版和数据中心版</p>
<p>其中只有社区版是开源免费的</p>
<p><img src="C:\Users\Lenovo\Desktop\img\451.jpg" alt="451"></p>
<p>生产建议使用 LTA 版</p>
<p>官方LTA版本说明</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://www.sonarsource.com/products/sonarqube/downloads/lts/</span><br></pre></td></tr></table></figure>

<p>各种版本下载</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">https://www.sonarsource.com/products/sonarqube/downloads/historical-downloads/</span><br><span class="line">https://www.sonarqube.org/downloads/</span><br></pre></td></tr></table></figure>

<p><img src="C:\Users\Lenovo\Desktop\img\452.jpg" alt="452"></p>
<p><img src="C:\Users\Lenovo\Desktop\img\453.jpg" alt="453"></p>
<h2 id="安装环境准备"><a href="#安装环境准备" class="headerlink" title="安装环境准备"></a>安装环境准备</h2><h3 id="硬件要求"><a href="#硬件要求" class="headerlink" title="硬件要求"></a>硬件要求</h3><p>CPU/内存/磁盘</p>
<p>官方说明</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">https://docs.sonarqube.org/latest/requirements/prerequisites-and-overview/</span><br><span class="line">https://docs.sonarqube.org/8.9/requirements/requirements/</span><br><span class="line">https://docs.sonarqube.org/7.9/requirements/requirements/</span><br></pre></td></tr></table></figure>

<p>硬件需求</p>
<ul>
<li>小型应用至少需要2GB的RAM</li>
<li>磁盘空间取决于SonarQube分析的代码量</li>
<li>必须安装在读写性能较好的磁盘， 存储数据的目录中包含ElasticSearch的索引，服务器启动并运行时，将会在该索引上进行大是I/O操作</li>
<li>不支持32位操作系统</li>
</ul>
<h3 id="系统内核优化"><a href="#系统内核优化" class="headerlink" title="系统内核优化"></a>系统内核优化</h3><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://docs.sonarqube.org/latest/requirements/prerequisites-and-overview/</span><br></pre></td></tr></table></figure>

<ul>
<li><code>vm.max_map_count</code> is greater than or equal to 524288</li>
<li><code>fs.file-max</code> is greater than or equal to 131072</li>
<li>the user running SonarQube can open at least 131072 file descriptors</li>
<li>the user running SonarQube can open at least 8192 threads</li>
</ul>
<p>You can set them dynamically for the current session by running the following commands as <code>root</code>:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">sysctl -w vm.max_map_count=524288</span><br><span class="line">sysctl -w fs.file-max=131072</span><br><span class="line"><span class="built_in">ulimit</span> -n 131072</span><br><span class="line"><span class="built_in">ulimit</span> -u 8192</span><br></pre></td></tr></table></figure>

<p>旧版要求</p>
<p>按官网说明修改配置</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://docs.sonarqube.org/7.9/requirements/requirements/</span><br></pre></td></tr></table></figure>

<p><img src="C:\Users\Lenovo\Desktop\img\454.jpg" alt="454"></p>
<p>注意: 必须修改内核限制，否则在启动时会报以下错误</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sonarqube@SonarQube-Server:~$ <span class="built_in">cat</span> /usr/local/sonarqube/logs/es.log</span><br></pre></td></tr></table></figure>

<p><img src="C:\Users\Lenovo\Desktop\img\455.jpg" alt="455"></p>
<p><strong>创建用户和修改内核配置</strong></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">[root@SonarQube-Server ~]<span class="comment"># vim /etc/sysctl.conf</span></span><br><span class="line">vm.max_map_count=262144  <span class="comment">#此项必须修改，否则无法启动</span></span><br><span class="line">fs.file-max=65536        <span class="comment">#此项可不改，默认值满足要求</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#此文件可不改</span></span><br><span class="line">[root@SonarQube-Server ~]<span class="comment"># vim /etc/security/limits.conf</span></span><br><span class="line">sonarqube  - nofile  65536</span><br><span class="line">sonarqube  - <span class="built_in">nproc</span>   4096</span><br><span class="line">root       - nofile  65536   </span><br><span class="line">root       - <span class="built_in">nproc</span>   4096</span><br><span class="line"></span><br><span class="line"><span class="comment">#如果以systemd 运行SonarQube,需要在service文件配置</span></span><br><span class="line">[servcie]</span><br><span class="line">.....</span><br><span class="line">LimitNOFILE=65536</span><br><span class="line">LimitNPROC=4096</span><br><span class="line">......</span><br></pre></td></tr></table></figure>

<h3 id="数据库环境依赖说明"><a href="#数据库环境依赖说明" class="headerlink" title="数据库环境依赖说明"></a>数据库环境依赖说明</h3><h4 id="SonarQube-7-9-以上版本的数据库要求"><a href="#SonarQube-7-9-以上版本的数据库要求" class="headerlink" title="SonarQube 7.9 以上版本的数据库要求"></a>SonarQube 7.9 以上版本的数据库要求</h4><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://docs.sonarqube.org/7.9/requirements/requirements/</span><br></pre></td></tr></table></figure>

<p>注意：SonarQube 7.9 不再支持MySQL，可以选择安装 PostgreSQL</p>
<p><strong>官方如下说明: 7.9.x 版本不再支持MySQL</strong></p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://docs.sonarqube.org/7.9/setup/upgrade-notes/</span><br></pre></td></tr></table></figure>

<p><img src="C:\Users\Lenovo\Desktop\img\456.jpg" alt="456"></p>
<h4 id="SonarQube-6-7-的数据库要求"><a href="#SonarQube-6-7-的数据库要求" class="headerlink" title="SonarQube 6.7 的数据库要求"></a>SonarQube 6.7 的数据库要求</h4><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://docs.sonarqube.org/6.7/Requirements.html</span><br></pre></td></tr></table></figure>

<p>SonarQube 6.7 数据库要使用MySQL 5.6版本，不支持MySQL 5.5的版本</p>
<p><img src="C:\Users\Lenovo\Desktop\img\457.jpg" alt="457"></p>
<h3 id="Java-环境依赖说明"><a href="#Java-环境依赖说明" class="headerlink" title="Java 环境依赖说明"></a>Java 环境依赖说明</h3><h4 id="SonarQube-9-9-以上版本的-java-环境要求"><a href="#SonarQube-9-9-以上版本的-java-环境要求" class="headerlink" title="SonarQube 9.9 以上版本的 java 环境要求"></a>SonarQube 9.9 以上版本的 java 环境要求</h4><p><strong>SonarQube 7.9 以上版本不再支持 java 11</strong></p>
<p><img src="C:\Users\Lenovo\Desktop\img\458.jpg" alt="458"></p>
<h4 id="SonarQube-7-9-以上版本的-java-环境要求"><a href="#SonarQube-7-9-以上版本的-java-环境要求" class="headerlink" title="SonarQube 7.9 以上版本的 java 环境要求"></a>SonarQube 7.9 以上版本的 java 环境要求</h4><p><strong>SonarQube 7.9 以上版本不再支持 java 8</strong></p>
<p><img src="C:\Users\Lenovo\Desktop\img\459.jpg" alt="459"></p>
<p>范例：安装 openjdk-11-jdk</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#Ubuntu安装java</span></span><br><span class="line">[root@SonarQube-Server ~]<span class="comment"># apt update &amp;&amp; apt -y install openjdk-11-jdk</span></span><br><span class="line"><span class="comment">#RHEL系统安装java</span></span><br><span class="line">[root@SonarQube-Server ~]<span class="comment"># yum -y install java-11-openjdk</span></span><br><span class="line">[root@SonarQube-Server ~]<span class="comment"># java -version</span></span><br><span class="line">openjdk version <span class="string">&quot;11.0.6&quot;</span> 2020-01-14</span><br><span class="line">OpenJDK Runtime Environment (build 11.0.6+10-post-Ubuntu-1ubuntu118.04.1)</span><br><span class="line">OpenJDK 64-Bit Server VM (build 11.0.6+10-post-Ubuntu-1ubuntu118.04.1, mixed mode, sharing)</span><br></pre></td></tr></table></figure>

<h4 id="SonarQube-6-7-的-Java-环境要求"><a href="#SonarQube-6-7-的-Java-环境要求" class="headerlink" title="SonarQube 6.7 的 Java 环境要求"></a>SonarQube 6.7 的 Java 环境要求</h4><p><img src="C:\Users\Lenovo\Desktop\img\460.jpg" alt="460"></p>
<h3 id="创建SonarQube用户"><a href="#创建SonarQube用户" class="headerlink" title="创建SonarQube用户"></a>创建SonarQube用户</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#使用普通账户启动sonarqube</span></span><br><span class="line"><span class="comment">#Ubuntu使用useradd创建用户时默认使用/bin/sh,并且不创建家目录</span></span><br><span class="line">[root@SonarQube-Server ~]<span class="comment"># useradd -s /bin/bash -m sonarqube</span></span><br></pre></td></tr></table></figure>

<h2 id="安装-SonarQube-服务器"><a href="#安装-SonarQube-服务器" class="headerlink" title="安装 SonarQube 服务器"></a>安装 SonarQube 服务器</h2><h3 id="数据库准备"><a href="#数据库准备" class="headerlink" title="数据库准备"></a>数据库准备</h3><h4 id="安装和配置-PostgreSQL-数据库"><a href="#安装和配置-PostgreSQL-数据库" class="headerlink" title="安装和配置 PostgreSQL 数据库"></a>安装和配置 PostgreSQL 数据库</h4><p><img src="C:\Users\Lenovo\Desktop\img\461.jpg" alt="461"></p>
<h5 id="安装和配置-PostgreSQL"><a href="#安装和配置-PostgreSQL" class="headerlink" title="安装和配置 PostgreSQL"></a>安装和配置 PostgreSQL</h5><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">[root@SonarQube-Server ~]<span class="comment"># apt -y install postgresql</span></span><br><span class="line">[root@SonarQube-Server ~]<span class="comment"># id postgres</span></span><br><span class="line">uid=112(postgres) gid=116(postgres) <span class="built_in">groups</span>=116(postgres),115(ssl-cert)</span><br><span class="line"></span><br><span class="line"><span class="comment">#默认监听在127.0.0.1的5432端口，需要修改监听地址</span></span><br><span class="line">[root@SonarQube-Server ~]<span class="comment"># ss -ntlp|grep post</span></span><br><span class="line">LISTEN   0         128               127.0.0.1:5432             0.0.0.0:*       <span class="built_in">users</span>:((&quot;postgres&quot;,pid=<span class="number">23337</span>,fd=<span class="number">8</span>))             </span><br><span class="line">LISTEN   0         128                   [::1]:5432               [::]:*        <span class="built_in">users</span>:((&quot;postgres&quot;,pid=<span class="number">23337</span>,fd=<span class="number">7</span>)) </span><br><span class="line"></span><br><span class="line"><span class="comment">#修改监听地址支持远程连接</span></span><br><span class="line">[root@ubuntu2204 ~]<span class="comment"># vim /etc/postgresql/14/main/postgresql.conf</span></span><br><span class="line">[root@ubuntu2004 ~]<span class="comment"># vim /etc/postgresql/12/main/postgresql.conf</span></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment"># vim /etc/postgresql/10/main/postgresql.conf </span></span><br><span class="line">listen_addresses = <span class="string">&#x27;*&#x27;</span> 或者 <span class="string">&#x27;0.0.0.0&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#开启远程访问</span></span><br><span class="line">[root@ubuntu2204 ~]<span class="comment"># vim /etc/postgresql/14/main/pg_hba.conf</span></span><br><span class="line">host   all             all             127.0.0.1/32           scram-sha-256</span><br><span class="line">host   all             all             0.0.0.0/0               scram-sha-256 <span class="comment">#加此行</span></span><br><span class="line"></span><br><span class="line">[root@ubuntu2004 ~]<span class="comment"># vim /etc/postgresql/12/main/pg_hba.conf</span></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment"># vim /etc/postgresql/10/main/pg_hba.conf</span></span><br><span class="line"><span class="comment"># IPv4 local connections:</span></span><br><span class="line">host   all             all             127.0.0.1/32           md5</span><br><span class="line">host   all             all             0.0.0.0/0               md5 <span class="comment">#加此行</span></span><br><span class="line"></span><br><span class="line">[root@SonarQube-Server ~]<span class="comment"># grep -n &quot;^[a-Z]&quot; /etc/postgresql/10/main/pg_hba.conf</span></span><br><span class="line">85:<span class="built_in">local</span>   all             postgres                                peer</span><br><span class="line">90:<span class="built_in">local</span>   all             all                                     peer</span><br><span class="line">92:host   all              all             0.0.0.0/0               md5</span><br><span class="line">94:host   all              all             ::1/128                 md5</span><br><span class="line">97:<span class="built_in">local</span>   replication     all                                     peer</span><br><span class="line">98:host   replication      all             127.0.0.1/32            md5</span><br><span class="line">99:host   replication      all             ::1/128                 md5</span><br><span class="line"></span><br><span class="line">[root@SonarQube-Server ~]<span class="comment"># systemctl restart postgresql</span></span><br><span class="line">[root@SonarQube-Server ~]<span class="comment"># ss -ntl|grep 5432</span></span><br><span class="line">LISTEN   0         128                 0.0.0.0:5432             0.0.0.0:*       </span><br><span class="line">LISTEN   0         128                   [::]:5432               [::]:* </span><br></pre></td></tr></table></figure>

<p>说明: <code>/etc/postgresql/1X/main/pg_hba.conf</code></p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">格式:TYPE DATABASE       USER           ADDRESS                 METHOD</span><br><span class="line">METHOD有如下值可选</span><br><span class="line">md5： 执行MD5身份验证以验证用户的密码。</span><br><span class="line">peer：从操作系统获取客户端的操作系统用户名，并检查它是否与请求的数据库用户名匹配。这仅适用于本地连接。</span><br><span class="line">trust：允许无条件连接，允许任何PostgreSQL用户身份登录，而无需密码或任何其他身份验证。</span><br><span class="line">reject：拒绝任何条件连接，这对于从组中“过滤掉”某些主机非常有用。</span><br><span class="line">scram-sha-256：执行SCRAM-SHA-256身份验证以验证用户的密码。</span><br><span class="line">password：要提供未加密的密码以进行身份••验证。由于密码是通过网络以明文形式发送的，因此不应在不受信任的网络上使用。</span><br><span class="line">gss：使用GSSAPI对用户进行身份验证，这仅适用于TCP / IP连接。</span><br><span class="line">sspi：使用SSPI对用户进行身份验证，这仅适用于Windows。</span><br><span class="line">ident：通过联系客户端上的ident服务器获取客户端的操作系统用户名，并检查它是否与请求的数据库用户</span><br><span class="line">名匹配。 Ident身份验证只能用于TCP/IP连接。为本地连接指定时，将使用对等身份验证。</span><br><span class="line">ldap：使用LDAP服务器进行身份验证。</span><br><span class="line">radius：使用RADIUS服务器进行身份验证。</span><br><span class="line">cert：使用SSL客户端证书进行身份验证。</span><br><span class="line">pam：使用操作系统提供的可插入身份验证模块（PAM）服务进行身份验证。</span><br><span class="line">bsd：使用操作系统提供的BSD身份验证服务进行身份验证。</span><br></pre></td></tr></table></figure>

<p>范例: CentOS 安装 postgresql 12</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#CentOS7以postresql 12 为例</span></span><br><span class="line">设置yum仓库</span><br><span class="line"><span class="comment">#rpm -i https://download.postgresql.org/pub/repos/yum/reporpms/EL-7-x86_64/pgdg-redhat-repo-latest.noarch.rpm</span></span><br><span class="line">安装postgresql1,2-server、postgresql12和postgresql12-libs</span><br><span class="line"><span class="comment"># yum install postgresql12-server postgresql12 postgresql12-libs</span></span><br><span class="line">初始化</span><br><span class="line"><span class="comment"># postgresql-12-setup initdb</span></span><br><span class="line"><span class="comment">#注意:</span></span><br><span class="line">配置文件在/var/lib/pgsql/12/data/日录下</span><br><span class="line">服务管理:systemctl start postgresql-12</span><br></pre></td></tr></table></figure>

<h5 id="创建数据库和用户授权"><a href="#创建数据库和用户授权" class="headerlink" title="创建数据库和用户授权"></a>创建数据库和用户授权</h5><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#使用postgres用户登录（PostgresSQL安装后会自动创建postgres用户）</span></span><br><span class="line">[root@SonarQube-Server ~]<span class="comment"># su - postgres</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#登录postgresql数据库</span></span><br><span class="line">postgres@SonarQube-Server:~$ psql -U postgres</span><br><span class="line">psql (10.12 (Ubuntu 10.12-0ubuntu0.18.04.1))</span><br><span class="line">Type <span class="string">&quot;help&quot;</span> <span class="keyword">for</span> <span class="built_in">help</span>.</span><br><span class="line"><span class="comment">#安全起见,修改数据库管理员postgres用户的密码</span></span><br><span class="line">postgres=<span class="comment"># ALTER USER postgres WITH ENCRYPTED PASSWORD &#x27;123456&#x27;;</span></span><br><span class="line">ALTER ROLE</span><br><span class="line"></span><br><span class="line"><span class="comment">#创建用户和数据库并授权</span></span><br><span class="line">postgres=<span class="comment"># CREATE USER sonarqube WITH ENCRYPTED PASSWORD &#x27;123456&#x27;;</span></span><br><span class="line">CREATE ROLE</span><br><span class="line">postgres=<span class="comment"># CREATE DATABASE sonarqube OWNER sonarqube;</span></span><br><span class="line">CREATE DATABASE</span><br><span class="line">postgres=<span class="comment"># GRANT ALL PRIVILEGES ON DATABASE sonarqube TO sonarqube;</span></span><br><span class="line">GRANT</span><br><span class="line"></span><br><span class="line"><span class="comment">#前面如果已经指定数据库的OWNER,则可以不执行下面命令</span></span><br><span class="line">postgres=<span class="comment"># ALTER DATABASE sonarqube OWNER TO sonarqube; </span></span><br><span class="line">ALTER DATABASE</span><br><span class="line"></span><br><span class="line"><span class="comment">#查看数据库是否创建</span></span><br><span class="line">postgres=<span class="comment"># \l</span></span><br><span class="line">                                 List of databases</span><br><span class="line">    Name   |  Owner   | Encoding |   Collate   |    Ctype    |   Access privileges   </span><br><span class="line">-----------+----------+----------+-------------+-------------+-----------------------</span><br><span class="line">  postgres | postgres | UTF8     | en_HK.UTF-8 | en_HK.UTF-8 | </span><br><span class="line"> sonarqube |  sonar   | UTF8     | en_HK.UTF-8 | en_HK.UTF-8 | =Tc/sonarqube        +</span><br><span class="line">           |          |          |             |             | sonarqube=CTc/sonarqube</span><br><span class="line"> template0 | postgres | UTF8     | en_HK.UTF-8 | en_HK.UTF-8 | =c/postgres          +</span><br><span class="line">           |          |          |             |             | postgres=CTc/postgres</span><br><span class="line"> template1 | postgres | UTF8     | en_HK.UTF-8 | en_HK.UTF-8 | =c/postgres          +</span><br><span class="line">           |          |          |             |             | postgres=CTc/postgres</span><br><span class="line">(4 rows)</span><br><span class="line"></span><br><span class="line"><span class="comment">#退出数据库连接</span></span><br><span class="line">postgres=<span class="comment"># \q</span></span><br></pre></td></tr></table></figure>

<h3 id="下载-SonarQube-和修改配置文件"><a href="#下载-SonarQube-和修改配置文件" class="headerlink" title="下载 SonarQube 和修改配置文件"></a>下载 SonarQube 和修改配置文件</h3><h4 id="下载解压缩"><a href="#下载解压缩" class="headerlink" title="下载解压缩"></a>下载解压缩</h4><p>下载链接</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://www.sonarqube.org/downloads/</span><br></pre></td></tr></table></figure>

<p><img src="C:\Users\Lenovo\Desktop\img\462.jpg" alt="462"></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#8.9版下载</span></span><br><span class="line">[root@SonarQube-Server ~]<span class="comment"># wget -P /usr/local/src https://binaries.sonarsource.com/Distribution/sonarqube/sonarqube-8.9.2.46101.zip</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#7.9版下载</span></span><br><span class="line">[root@SonarQube-Server ~]<span class="comment"># wget -P /usr/local/src https://binaries.sonarsource.com/Distribution/sonarqube/sonarqube-7.9.2.zip</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#解压</span></span><br><span class="line">[root@SonarQube-Server ~]<span class="comment"># cd /usr/local/src</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#新版</span></span><br><span class="line">[root@SonarQube-Server src]<span class="comment"># unzip sonarqube-8.9.2.46101.zip</span></span><br><span class="line">[root@SonarQube-Server src]<span class="comment"># ln -s /usr/local/src/sonarqube-8.9.2.46101 /usr/local/sonarqube</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#旧版</span></span><br><span class="line">[root@SonarQube-Server src]<span class="comment"># unzip sonarqube-7.9.2.zip</span></span><br><span class="line">[root@SonarQube-Server src]<span class="comment"># ln -s /usr/local/src/sonarqube-7.9.2 /usr/local/sonarqube</span></span><br><span class="line"></span><br><span class="line">[root@SonarQube-Server ~]<span class="comment"># ls /usr/local/sonarqube</span></span><br><span class="line">bin conf COPYING data elasticsearch extensions lib logs temp web</span><br><span class="line"></span><br><span class="line">[root@SonarQube-Server ~]<span class="comment"># ls /usr/local/sonarqube/conf/</span></span><br><span class="line">sonar.properties wrapper.conf  </span><br><span class="line"></span><br><span class="line"><span class="comment">#设置属性</span></span><br><span class="line">[root@SonarQube-Server ~]<span class="comment"># chown -R sonarqube.sonarqube /usr/local/sonarqube/</span></span><br></pre></td></tr></table></figure>

<h4 id="设置-SonarQube-连接数据库"><a href="#设置-SonarQube-连接数据库" class="headerlink" title="设置 SonarQube 连接数据库"></a>设置 SonarQube 连接数据库</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#修改SonarQube配置用于连接postgresql数据库</span></span><br><span class="line">[root@SonarQube-Server ~]<span class="comment"># vim /usr/local/sonarqube/conf/sonar.properties </span></span><br><span class="line"><span class="comment">#修改连接postgresql数据库的账号和密码,和前面的配置必须匹配</span></span><br><span class="line">sonar.jdbc.username=sonarqube</span><br><span class="line">sonar.jdbc.password=123456</span><br><span class="line"></span><br><span class="line"><span class="comment">#修改数据库相关的信息，这里必须和此前配置的postgresql内容相匹配，其中localhost为DB服务器的地址，而sonarqube为数据库名称</span></span><br><span class="line">sonar.jdbc.url=jdbc:postgresql://localhost/sonarqube</span><br><span class="line"></span><br><span class="line"><span class="comment">#设置 SonarQube 的提供的 Web Server监听的地址和端口</span></span><br><span class="line">sonar.web.host=0.0.0.0 <span class="comment">#此为默认值,可不做修改</span></span><br><span class="line">sonar.web.port=9000    <span class="comment">#此为默认值,可不做修改</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#如有需要可以修改SonarQube存储数据的目录位置，以下两个目录为相对路径，相对于sonarqube的安装目录，也可以使用绝对路径</span></span><br><span class="line">sonar.path.data=data   <span class="comment">#默认值,可不做修改</span></span><br><span class="line">sonar.path.temp=temp   <span class="comment">#默认值,可不做修改</span></span><br></pre></td></tr></table></figure>

<h3 id="启动-SonarQube"><a href="#启动-SonarQube" class="headerlink" title="启动 SonarQube"></a>启动 SonarQube</h3><p><strong>注意:SonarQube 需要调用 Elasticsearch，而且默认需要使用普通用户启动，如果以root启动会报错</strong></p>
<p>范例: 以sonarqube用户身份启动</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#以sonarqube用户身份启动服务</span></span><br><span class="line">[root@SonarQube-Server ~]<span class="comment"># su - sonarqube</span></span><br><span class="line">sonarqube@SonarQube-Server:~$ /usr/local/sonarqube/bin/linux-x86-64/sonar.sh start</span><br><span class="line">Starting SonarQube...</span><br><span class="line">Started SonarQube.</span><br><span class="line"></span><br><span class="line"><span class="comment">#或者执行下面启动SonarQube</span></span><br><span class="line">[root@SonarQube-Server ~]<span class="comment"># su - sonarqube -c &#x27;/usr/local/sonarqube/bin/linux-x86-64/sonar.sh start&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#查看状态</span></span><br><span class="line">sonarqube@SonarQube-Server:~$ /usr/local/sonarqube/bin/linux-x86-64/sonar.sh status</span><br><span class="line">SonarQube is running (11788).</span><br><span class="line"></span><br><span class="line"><span class="comment">#查看是否9000/tcp端口</span></span><br><span class="line">LISTEN 0 25                   *:9000       *:* <span class="built_in">users</span>:((&quot;java&quot;,pid=<span class="number">24885</span>,fd=<span class="number">14</span>))</span><br><span class="line"></span><br><span class="line"><span class="comment">#如果无法启动,重设目录属性</span></span><br><span class="line">[root@SonarQube-Server ~]<span class="comment"># chown -R sonarqube.sonarqube /usr/local/sonarqube/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#验证日志</span></span><br><span class="line">[root@SonarQube-Server ~]<span class="comment"># tail -n 3 /usr/local/sonarqube/logs/sonar.log</span></span><br><span class="line">2020.03.12 17:02:39 INFO app[][o.s.a.SchedulerImpl] Process[ce] is up</span><br><span class="line">2020.03.12 17:02:39 INFO app[][o.s.a.SchedulerImpl] SonarQube is up</span><br></pre></td></tr></table></figure>

<p>范例: 以root 身份启动会导致失败</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[root@SonarQube-Server sonarqube]<span class="comment"># pwd</span></span><br><span class="line">/usr/local/sonarqube</span><br><span class="line">[root@SonarQube-Server sonarqube]<span class="comment"># bin/linux-x86-64/sonar.sh start</span></span><br><span class="line">Starting SonarQube...</span><br><span class="line">Started SonarQube.</span><br><span class="line"></span><br><span class="line"><span class="comment">#查看日志无法启动</span></span><br><span class="line">[root@SonarQube-Server sonarqube]<span class="comment"># cat logs/sonar*.log</span></span><br><span class="line">2020.03.12 16:33:53 WARN app[][o.s.a.p.AbstractManagedProcess] Process exited with <span class="built_in">exit</span> value [es]: 1</span><br><span class="line"></span><br><span class="line"><span class="comment">#查看es日志,提示不能以root启动</span></span><br><span class="line">[root@SonarQube-Server sonarqube]<span class="comment"># cat logs/es.log</span></span><br></pre></td></tr></table></figure>

<p><img src="C:\Users\Lenovo\Desktop\img\463.jpg" alt="463"></p>
<p><strong>无法启动的主要的可能原因</strong> </p>
<ul>
<li>用户和权限</li>
<li>java 版本不对或没有安装</li>
<li>内核参数没有优化</li>
<li>数据库及权限</li>
</ul>
<h3 id="创建-service-文件"><a href="#创建-service-文件" class="headerlink" title="创建 service 文件"></a>创建 service 文件</h3><p>官网参考</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">https://docs.sonarqube.org/8.9/setup/operate-server/</span><br><span class="line">https://docs.sonarqube.org/7.9/setup/operate-server/</span><br></pre></td></tr></table></figure>

<p>范例: 创建 service 文件</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#先停止sonarqube</span></span><br><span class="line">[root@SonarQube-Server ~]<span class="comment"># su - sonarqube </span></span><br><span class="line">sonarqube@SonarQube-Server:~$ /usr/local/sonarqube/bin/linux-x86-64/sonar.sh stop           </span><br><span class="line">sonarqube@SonarQube-Server:~$ /usr/local/sonarqube/bin/linux-x86-64/sonar.sh status</span><br><span class="line">SonarQube is not running.</span><br><span class="line"></span><br><span class="line">sonarqube@SonarQube-Server:~<span class="variable">$exit</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#创建service文件</span></span><br><span class="line">[root@SonarQube-Server ~]<span class="comment"># vim /etc/systemd/system/sonarqube.service</span></span><br><span class="line">[Unit]</span><br><span class="line">Description=SonarQube service</span><br><span class="line">After=syslog.target network.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">Type=simple</span><br><span class="line">User=sonarqube</span><br><span class="line">Group=sonarqube</span><br><span class="line">PermissionsStartOnly=<span class="literal">true</span></span><br><span class="line">ExecStart=/usr/bin/nohup /usr/bin/java -Xms32m -Xmx32m -</span><br><span class="line">Djava.net.preferIPv4Stack=<span class="literal">true</span> -jar /usr/local/sonarqube/lib/sonar-application-8.9.2.46101.jar</span><br><span class="line"><span class="comment">#ExecStart=/usr/bin/nohup /usr/bin/java -Xms32m -Xmx32m -Djava.net.preferIPv4Stack=true -jar /usr/local/sonarqube/lib/sonar-application-7.9.6.jar</span></span><br><span class="line">StandardOutput=syslog</span><br><span class="line">LimitNOFILE=65536</span><br><span class="line">LimitNPROC=4096</span><br><span class="line">TimeoutStartSec=5</span><br><span class="line">Restart=always</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line"></span><br><span class="line">[root@SonarQube-Server ~]<span class="comment"># systemctl daemon-reload </span></span><br><span class="line">[root@SonarQube-Server ~]<span class="comment"># systemctl enable --now   sonarqube.service </span></span><br><span class="line">[root@SonarQube-Server ~]<span class="comment"># systemctl status sonarqube.service</span></span><br></pre></td></tr></table></figure>

<h3 id="登录到-Web-界面"><a href="#登录到-Web-界面" class="headerlink" title="登录到 Web 界面"></a>登录到 Web 界面</h3><p>用浏览器访问地址： <a target="_blank" rel="noopener" href="http://sonarqube服务器ip:9000/">http://SonarQube服务器IP:9000</a></p>
<p><strong>新版默认必须登录，不支持匿名访问</strong></p>
<p>以下为新版界面</p>
<p><strong>默认用户名和密码都是 admin</strong></p>
<p><img src="C:\Users\Lenovo\Desktop\img\464.jpg" alt="464"></p>
<p>首次登录必须修改admin用户的密码</p>
<p>注意: 新密码不能使用原密码</p>
<p><img src="C:\Users\Lenovo\Desktop\img\465.jpg" alt="465"><br><img src="C:\Users\Lenovo\Desktop\img\466.jpg" alt="466"></p>
<p><strong>以下旧版默认可以匿名登录</strong></p>
<p><img src="C:\Users\Lenovo\Desktop\img\467.jpg" alt="467"></p>
<p>点击有左上角 login 登录，默认用户名和密码都是admin</p>
<p><img src="C:\Users\Lenovo\Desktop\img\468.jpg" alt="468"><br><img src="C:\Users\Lenovo\Desktop\img\469.jpg" alt="469"></p>
<h2 id="管理-SonarQube-服务器"><a href="#管理-SonarQube-服务器" class="headerlink" title="管理 SonarQube 服务器"></a>管理 SonarQube 服务器</h2><h3 id="安装中文支持"><a href="#安装中文支持" class="headerlink" title="安装中文支持"></a>安装中文支持</h3><h4 id="查看本地已安装插件"><a href="#查看本地已安装插件" class="headerlink" title="查看本地已安装插件"></a>查看本地已安装插件</h4><p>插件本地路径用于安装相关插件，比如: 中文插件，用于分析不同开发语言的对应的插件</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#初始此目录没有插件文件</span></span><br><span class="line">[root@SonarQube-Server ~]<span class="comment"># ll /usr/local/sonarqube/extensions/plugins/</span></span><br><span class="line">total 12</span><br><span class="line">drwxr-xr-x 2 sonarqube sonarqube 4096 Jul 27 06:27 ./</span><br><span class="line">drwxr-xr-x 5 sonarqube sonarqube 4096 Oct 24 09:59 ../</span><br><span class="line">-rw-r--r-- 1 sonarqube sonarqube  737 Jul 27 06:27 README.txt</span><br></pre></td></tr></table></figure>

<h4 id="安装中文语言插件"><a href="#安装中文语言插件" class="headerlink" title="安装中文语言插件"></a>安装中文语言插件</h4><p>administration- Marketplace，在后面的搜索框搜索插件chinese，然后点install安装：</p>
<p><strong>新版需要先理解风险，才能安装插件</strong></p>
<p><img src="C:\Users\Lenovo\Desktop\img\470.jpg" alt="470"><br><img src="C:\Users\Lenovo\Desktop\img\471.jpg" alt="471"></p>
<p>安装完后，点 <code>Restart Server</code></p>
<p><img src="C:\Users\Lenovo\Desktop\img\472.jpg" alt="472"><br><img src="C:\Users\Lenovo\Desktop\img\473.jpg" alt="473"><br><img src="C:\Users\Lenovo\Desktop\img\474.jpg" alt="474"></p>
<p>或者通过命令重新启动</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@SonarQube-Server ~]<span class="comment"># su - sonarqube</span></span><br><span class="line">sonarqube@SonarQube-Server:~$ /usr/local/sonarqube/bin/linux-x86-64/sonar.sh restart</span><br><span class="line">Gracefully stopping SonarQube...</span><br><span class="line">SonarQube was not running.</span><br><span class="line">Starting SonarQube...</span><br><span class="line">Started SonarQube.</span><br></pre></td></tr></table></figure>

<p>查看到多了一个插件文件</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@SonarQube-Server ~]<span class="comment"># ls /usr/local/sonarqube/extensions/plugins/</span></span><br><span class="line">README.txt sonar-l10n-zh-plugin-8.9.jar</span><br></pre></td></tr></table></figure>

<p>如果上面方式安装失败，可以下载插件到目录 /usr/local/sonarqube/extensions/plugins/ </p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@SonarQube-Server ~]<span class="comment"># wget https://github.com/SonarQubeCommunity/sonar-l10n-zh/releases/download/sonar-l10n-zh-plugin-1.29/sonar-l10n-zh-plugin-1.29.jar -P /usr/local/sonarqube/extensions/plugins/</span></span><br></pre></td></tr></table></figure>

<p><img src="C:\Users\Lenovo\Desktop\img\475.jpg" alt="475"></p>
<h4 id="验证中文界面"><a href="#验证中文界面" class="headerlink" title="验证中文界面"></a>验证中文界面</h4><p>重新登录 SonarQube</p>
<p><img src="C:\Users\Lenovo\Desktop\img\476.jpg" alt="476"><br><img src="C:\Users\Lenovo\Desktop\img\477.jpg" alt="477"></p>
<p>查看安装的插件</p>
<p><img src="C:\Users\Lenovo\Desktop\img\478.jpg" alt="478"></p>
<h3 id="安装其他插件"><a href="#安装其他插件" class="headerlink" title="安装其他插件"></a>安装其他插件</h3><p>Sonarquebe对代码的扫描都基于插件实现，因此要安装扫描的各种开发语言的插件 </p>
<p>默认已安装 Java、Python、Go，Php，javaScript，Html 等语言对应的插件</p>
<p><img src="C:\Users\Lenovo\Desktop\img\479.jpg" alt="479"><br><img src="C:\Users\Lenovo\Desktop\img\480.jpg" alt="480"><br><img src="C:\Users\Lenovo\Desktop\img\481.jpg" alt="481"><br><img src="C:\Users\Lenovo\Desktop\img\482.jpg" alt="482"></p>
<p>插件可以在github上找到最新版本</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://github.com/SonarSource</span><br></pre></td></tr></table></figure>

<p><img src="C:\Users\Lenovo\Desktop\img\483.jpg" alt="483"><br><img src="C:\Users\Lenovo\Desktop\img\484.jpg" alt="484"><br><img src="C:\Users\Lenovo\Desktop\img\485.jpg" alt="485"></p>
<h3 id="权限管理"><a href="#权限管理" class="headerlink" title="权限管理"></a>权限管理</h3><h4 id="允许匿名访问"><a href="#允许匿名访问" class="headerlink" title="允许匿名访问"></a>允许匿名访问</h4><p>8.9.X 新版默认取消了匿名用户访问，可以在下面配置中打开匿名访问即关闭认证</p>
<p><img src="C:\Users\Lenovo\Desktop\img\486.jpg" alt="486"></p>
<p><strong>关闭开关，允许匿名</strong></p>
<p><img src="C:\Users\Lenovo\Desktop\img\487.jpg" alt="487"><br><img src="C:\Users\Lenovo\Desktop\img\488.jpg" alt="488"></p>
<p>旧版默认任何匿名用户都可以执行代码分析</p>
<p><img src="C:\Users\Lenovo\Desktop\img\489.jpg" alt="489"></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#如果取消上面对勾，将禁止匿名用户执行分析，在执行下面代码分析时操作出现失败</span></span><br><span class="line">[root@jenkins spring-boot-helloWorld]<span class="comment"># /usr/local/sonar-scanner/bin/sonar-scanner</span></span><br><span class="line">.......</span><br><span class="line">INFO: Load project repositories</span><br><span class="line">INFO: ------------------------------------------------------------------------</span><br><span class="line">INFO: EXECUTION FAILURE</span><br><span class="line">INFO: ------------------------------------------------------------------------</span><br><span class="line">INFO: Total time: 5.005s</span><br><span class="line">INFO: Final Memory: 13M/47M</span><br><span class="line">INFO: ------------------------------------------------------------------------</span><br><span class="line">ERROR: Error during SonarScanner execution</span><br><span class="line">ERROR: You<span class="string">&#x27;re not authorized to run analysis. Please contact the project administrator.</span></span><br><span class="line"><span class="string">ERROR: </span></span><br><span class="line"><span class="string">ERROR: Re-run SonarScanner using the -X switch to enable full debug logging.</span></span><br></pre></td></tr></table></figure>

<p>构建时会出错</p>
<p><img src="C:\Users\Lenovo\Desktop\img\490.jpg" alt="490"></p>
<h4 id="不允许匿名访问"><a href="#不允许匿名访问" class="headerlink" title="不允许匿名访问"></a>不允许匿名访问</h4><p>如果不允许匿名访问，就需要给 Jenkins 创建访问sonarqube 所使用的用户的访问令牌</p>
<p>可以创建新用户或使用默认的admin用户</p>
<p><strong>新建用户并授权</strong></p>
<ul>
<li><p>在SonarQube上创建用户账号（不建议使用admin账号）</p>
<p>配置 →权限 →用户</p>
</li>
<li><p>为用户账号赋予相应的权限，例如执行分析和置备项目</p>
<p>配置 →权限 →全局权限</p>
</li>
</ul>
<p><img src="C:\Users\Lenovo\Desktop\img\491.jpg" alt="491"><br><img src="C:\Users\Lenovo\Desktop\img\492.jpg" alt="492"></p>
<h2 id="Jenkins-服务器部署扫描器-sonar-scanner"><a href="#Jenkins-服务器部署扫描器-sonar-scanner" class="headerlink" title="Jenkins 服务器部署扫描器 sonar-scanner"></a>Jenkins 服务器部署扫描器 sonar-scanner</h2><p>官方文档：</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://docs.sonarqube.org/latest/analysis/scan/sonarscanner/</span><br></pre></td></tr></table></figure>

<p><img src="C:\Users\Lenovo\Desktop\img\493.jpg" alt="493"></p>
<h3 id="部署和配置-sonar-scanner"><a href="#部署和配置-sonar-scanner" class="headerlink" title="部署和配置 sonar-scanner"></a>部署和配置 sonar-scanner</h3><p>sonarqube 通过调用扫描器sonar-scanner进行代码质量分析，即扫描器的具体工作就是扫描代码</p>
<p>下载地址：</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">https://docs.sonarqube.org/latest/analyzing-source-code/scanners/sonarscanner/</span><br><span class="line">https://binaries.sonarsource.com/?prefix=Distribution/sonar-scanner-cli/</span><br><span class="line">https://binaries.sonarsource.com/Distribution/sonar-scanner-cli/</span><br></pre></td></tr></table></figure>

<p><img src="C:\Users\Lenovo\Desktop\img\494.jpg" alt="494"></p>
<p><strong>下载和配置较新的版本并配置</strong></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">[root@jenkins-ubuntu ~]<span class="comment"># cd /usr/local/src</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#新版</span></span><br><span class="line">[root@jenkins-ubuntu src]<span class="comment"># wget https://binaries.sonarsource.com/Distribution/sonar-scanner-cli/sonar-scanner-cli-4.6.2.2472-linux.zip</span></span><br><span class="line">[root@jenkins-ubuntu src]<span class="comment"># unzip sonar-scanner-cli-4.6.2.2472-linux.zip</span></span><br><span class="line">[root@jenkins-ubuntu src]<span class="comment"># ln -s /usr/local/src/sonar-scanner-4.6.2.2472-linux/ /usr/local/sonar-scanner</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#旧版</span></span><br><span class="line"><span class="comment">#[root@jenkins-ubuntu src]# wget https://binaries.sonarsource.com/Distribution/sonar-scanner-cli/sonar-scanner-cli-4.3.0.2102-linux.zip</span></span><br><span class="line"><span class="comment">#[root@jenkins-ubuntu src]# unzip sonar-scanner-cli-4.3.0.2102-linux.zip</span></span><br><span class="line"><span class="comment">#[root@jenkins-ubuntu src]# ln -s /usr/local/src/sonar-scanner-4.3.0.2102-linux/ /usr/local/sonar-scanner</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#创建软链接方便运行</span></span><br><span class="line">[root@jenkins-ubuntu ~]<span class="comment"># ln -s /usr/local/sonar-scanner/bin/sonar-scanner /usr/bin/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#配置sonar-scanner连接sonarqube服务器</span></span><br><span class="line">[root@jenkins-ubuntu ~]<span class="comment"># vim /usr/local/sonar-scanner/conf/sonar-scanner.properties</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#指向sonarqube服务器的地址和端口</span></span><br><span class="line">sonar.host.url=http://sonarqube.wang.org:9000 </span><br><span class="line">sonar.sourceEncoding=UTF-8</span><br><span class="line"></span><br><span class="line"><span class="comment">#如果登录sonarqube server需要验证，还要加下面两行sonarqube的预先创建的用户信息</span></span><br><span class="line">sonar.login=admin</span><br><span class="line">sonar.password=123456</span><br></pre></td></tr></table></figure>

<h3 id="准备测试代码"><a href="#准备测试代码" class="headerlink" title="准备测试代码"></a>准备测试代码</h3><p>测试代码下载</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://github.com/SonarSource/sonar-scanning-examples</span><br></pre></td></tr></table></figure>

<p>范例: php 项目</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#准备测试代码</span></span><br><span class="line">[root@jenkins-ubuntu ~]<span class="comment"># unzip sonar-examples-master.zip</span></span><br><span class="line">[root@jenkins-ubuntu ~]<span class="comment"># cd sonar-examples-master/</span></span><br><span class="line">[root@jenkins-ubuntu sonar-examples-master]<span class="comment"># pwd</span></span><br><span class="line">/root/sonar-examples-master</span><br><span class="line"></span><br><span class="line">[root@jenkins-ubuntu sonar-examples-master]<span class="comment"># ls</span></span><br><span class="line">plugins projects README.md</span><br><span class="line"></span><br><span class="line">[root@jenkins-ubuntu sonar-examples-master]<span class="comment"># cd projects/</span></span><br><span class="line">[root@jenkins projects]<span class="comment"># ls</span></span><br><span class="line">ci-workaround-pom.xml languages multi-module tycho</span><br><span class="line"></span><br><span class="line">[root@jenkins-ubuntu projects]<span class="comment"># cd languages/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#支持多种语言</span></span><br><span class="line">[root@jenkins-ubuntu languages]<span class="comment"># ls</span></span><br><span class="line">abap   c     cpp     css     flex groovy javascript objc pli python sonar-project.properties</span><br><span class="line">vb6   web android cobol csharp erlang generic-coverage </span><br><span class="line">java   multi-language php   plsql rpg swift       vbnet xml</span><br><span class="line"></span><br><span class="line"><span class="comment">#以PHP为例</span></span><br><span class="line">[root@jenkins-ubuntu ~]<span class="comment"># cd sonar-examples-master/projects/languages/php/php-sonar-runner</span></span><br><span class="line">[root@jenkins-ubuntu php-sonar-runner]<span class="comment"># pwd</span></span><br><span class="line">/root/sonar-examples-master/projects/languages/php/php-sonar-runner</span><br><span class="line"></span><br><span class="line">[root@jenkins-ubuntu php-sonar-runner]<span class="comment"># ll</span></span><br><span class="line">total 28</span><br><span class="line">drwxr-xr-x 4 root root 4096 Mar 14 12:06 ./</span><br><span class="line">drwxr-xr-x 4 root root 4096 Jul 25  2016 ../</span><br><span class="line">-rw-r--r-- 1 root root  453 Jul 25  2016 README.md</span><br><span class="line">drwxr-xr-x 2 root root 4096 Mar 14 12:07 .scannerwork/</span><br><span class="line">-rw-r--r-- 1 root root  331 Jul 25  2016 sonar-project.properties</span><br><span class="line">drwxr-xr-x 2 root root 4096 Jul 25  2016 src/</span><br><span class="line">-rw-r--r-- 1 root root  272 Jul 25  2016 validation.txt</span><br><span class="line"></span><br><span class="line"><span class="comment">#以下为默认生成的配置文件</span></span><br><span class="line">[root@jenkins-ubuntu php-sonar-runner]<span class="comment"># cat sonar-project.properties </span></span><br><span class="line"><span class="comment"># Required metadata</span></span><br><span class="line">sonar.projectKey=org.sonarqube:php-simple-sq-scanner <span class="comment">#自定义项目唯一标识 key 名称</span></span><br><span class="line">sonar.projectName=PHP :: Simple Project :: SonarQube Scanner <span class="comment">#项目名称,此值会显示在sonarqube的web</span></span><br><span class="line">sonar.projectVersion=1.0  <span class="comment">#项目版本</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Comma-separated paths to directories with sources (required)</span></span><br><span class="line">sonar.sources=src   <span class="comment">#源代码目录</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Language</span></span><br><span class="line">sonar.language=php  <span class="comment">#代码语言类型</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Encoding of the source files</span></span><br><span class="line">sonar.sourceEncoding=UTF-8 <span class="comment">#编码格式</span></span><br></pre></td></tr></table></figure>

<p>范例: Java 代码配置</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[root@gitlab spring-boot-helloWorld]<span class="comment"># cat sonar-project.properties</span></span><br><span class="line"><span class="comment">#项目的唯一标识</span></span><br><span class="line">sonar.projectKey=sprint-boot-helloworld</span><br><span class="line"><span class="comment">#项目的名称,用于显示在 sonarqube web 界面</span></span><br><span class="line">sonar.projectName=sprint-boot-helloworld</span><br><span class="line"><span class="comment">#项目版本</span></span><br><span class="line">sonar.projectVersion=1.0</span><br><span class="line"><span class="comment">#项目源码所在目录</span></span><br><span class="line">sonar.sources=.</span><br><span class="line"><span class="comment">#项目源码编译生成的二进制文件路径</span></span><br><span class="line">sonar.java.binaries=.</span><br><span class="line"><span class="comment">#编程语言</span></span><br><span class="line">sonar.language=java</span><br><span class="line"><span class="comment">#编码格式</span></span><br><span class="line">sonar.sourceEncoding=UTF-8</span><br></pre></td></tr></table></figure>

<h3 id="在源代码目录执行扫描"><a href="#在源代码目录执行扫描" class="headerlink" title="在源代码目录执行扫描"></a>在源代码目录执行扫描</h3><p>在当前项目代码目录下即sonar-project.properties文件所在目录进行执行扫描，以下是扫描过程的提示信息，扫描的配置文件sonar-project.propertie每个项目都要有</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@jenkins-ubuntu php-sonar-runner]<span class="comment"># pwd</span></span><br><span class="line">/root/sonar-examples-master/projects/languages/php/php-sonar-runner</span><br><span class="line"></span><br><span class="line">[root@jenkins-ubuntu php-sonar-runner]<span class="comment"># /usr/local/sonar-scanner/bin/sonar-scanner</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#在源码所有目录下执行上面命令，可以看到如下显示</span></span><br><span class="line"><span class="comment">#注意:默认SonarQube Server 8.9版本不允许匿名,需要打开允许匿名才能成功</span></span><br></pre></td></tr></table></figure>

<p><img src="C:\Users\Lenovo\Desktop\img\495.jpg" alt="495"></p>
<p>范例: 扫描 Java 项目</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@jenkins spring-boot-helloWorld]<span class="comment"># /usr/local/sonar-scanner/bin/sonar-scanner</span></span><br></pre></td></tr></table></figure>

<p><img src="C:\Users\Lenovo\Desktop\img\496.jpg" alt="496"></p>
<h3 id="SonarQube-Web-界面验证扫描结果"><a href="#SonarQube-Web-界面验证扫描结果" class="headerlink" title="SonarQube Web 界面验证扫描结果"></a>SonarQube Web 界面验证扫描结果</h3><p>根据上面的执行结果，复制上面的链接地址，可以看到下面的信息</p>
<p><img src="C:\Users\Lenovo\Desktop\img\497.jpg" alt="497"></p>
<p>可以查看到重新的代码块</p>
<p><img src="C:\Users\Lenovo\Desktop\img\498.jpg" alt="498"></p>
<p>范例: java 程序的扫描结果</p>
<p><img src="C:\Users\Lenovo\Desktop\img\499.jpg" alt="499"></p>
<h2 id="Jenkins-和-SonarQube-集成实现代码扫描"><a href="#Jenkins-和-SonarQube-集成实现代码扫描" class="headerlink" title="Jenkins 和 SonarQube 集成实现代码扫描"></a>Jenkins 和 SonarQube 集成实现代码扫描</h2><h3 id="Jenkins-和-SonarQube-集成说明"><a href="#Jenkins-和-SonarQube-集成说明" class="headerlink" title="Jenkins 和 SonarQube 集成说明"></a>Jenkins 和 SonarQube 集成说明</h3><p><img src="C:\Users\Lenovo\Desktop\img\500.jpg" alt="500"></p>
<p>Jenkins借助于SonarQube Scanner插件将SonarQube提供的代码质量检查能力集成到pipeline上，从而确保质量阈检查失败时，能够避免继续进行后续的操作，例如发布等</p>
<p>通常的流程如下</p>
<ul>
<li>Jenkins Pipeline启动</li>
<li>SonarQube Scanner分析代码，并将报告发送至SonarQubeServer </li>
<li>SonarQube Server分析代码检测的结果是否符合预定义的质量阈 </li>
<li>SonarQube Server将通过(passed)或者失败（failed)的结果发送回Jenkins上的SonarQube Scanner插件暴露的Webhook</li>
<li>质量域相关的阶段成功通过或可选地失败时Jenkins pipeline继续后面的Stage,否则pipeline将终止</li>
</ul>
<h3 id="SonarQube-质量阈"><a href="#SonarQube-质量阈" class="headerlink" title="SonarQube 质量阈"></a>SonarQube 质量阈</h3><ul>
<li>质量阙是一组预定义的评估条件</li>
<li>代码质量扫描结果可满足这组条件时，项目才会被标记为“passed”</li>
<li>管理员也可以在SonarQube上按需自定义并调用质量阈</li>
</ul>
<p><img src="C:\Users\Lenovo\Desktop\img\501.jpg" alt="501"></p>
<p>范例: 创建新的质量阈</p>
<p><img src="C:\Users\Lenovo\Desktop\img\502.jpg" alt="502"><br><img src="C:\Users\Lenovo\Desktop\img\503.jpg" alt="503"><br><img src="C:\Users\Lenovo\Desktop\img\504.jpg" alt="504"></p>
<p>设为默认</p>
<p><img src="C:\Users\Lenovo\Desktop\img\505.jpg" alt="505"><br><img src="C:\Users\Lenovo\Desktop\img\506.jpg" alt="506"></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#再次执行代码扫描</span></span><br><span class="line">[root@jenkins spring-boot-helloWorld]<span class="comment"># /usr/local/sonar-scanner/bin/sonar-scanner</span></span><br></pre></td></tr></table></figure>

<p>如果不合格，会显示下面提示</p>
<p><img src="C:\Users\Lenovo\Desktop\img\507.jpg" alt="507"></p>
<h3 id="Jenkins-通过-Shell-实现-sonar-scanner-功能"><a href="#Jenkins-通过-Shell-实现-sonar-scanner-功能" class="headerlink" title="Jenkins 通过 Shell 实现 sonar scanner 功能"></a>Jenkins 通过 Shell 实现 sonar scanner 功能</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">[root@gitlab-ubuntu app1]<span class="comment"># cd /data/</span></span><br><span class="line">[root@gitlab-ubuntu data]<span class="comment"># git clone -b develop http://gitlab.wang.org/magedu/app1.git</span></span><br><span class="line">[root@gitlab-ubuntu data]<span class="comment"># ls</span></span><br><span class="line">app1</span><br><span class="line"></span><br><span class="line">[root@gitlab-ubuntu data]<span class="comment"># cd app1</span></span><br><span class="line">[root@gitlab-ubuntu app1]<span class="comment"># ls</span></span><br><span class="line">index.html</span><br><span class="line"></span><br><span class="line">[root@gitlab-ubuntu app1]<span class="comment"># vim sonar-project.properties</span></span><br><span class="line">[root@gitlab-ubuntu app1]<span class="comment"># cat sonar-project.properties</span></span><br><span class="line">sonar.projectKey=job2-develop</span><br><span class="line">sonar.projectName=job2-develop</span><br><span class="line">sonar.projectVersion=2.0</span><br><span class="line">sonar.sources=./</span><br><span class="line">sonar.language=php</span><br><span class="line">sonar.sourceEncoding=UTF-8</span><br><span class="line"></span><br><span class="line">[root@gitlab-ubuntu app1]<span class="comment"># vim index.html </span></span><br><span class="line">[root@gitlab-ubuntu app1]<span class="comment"># cat index.html</span></span><br><span class="line">&lt;h1&gt;demo_app1 v20&lt;/h1&gt;</span><br><span class="line"></span><br><span class="line">[root@gitlab-ubuntu app1]<span class="comment"># git add .</span></span><br><span class="line">[root@gitlab-ubuntu app1]<span class="comment"># git commit -m v20</span></span><br><span class="line">[develop b66c729] v20</span><br><span class="line">2 files changed, 7 insertions(+), 1 deletion(-)</span><br><span class="line"> create mode 100644 sonar-project.properties</span><br><span class="line"> </span><br><span class="line">[root@gitlab-ubuntu app1]<span class="comment"># git push </span></span><br><span class="line">Username <span class="keyword">for</span> <span class="string">&#x27;http://gitlab.wang.org&#x27;</span>: wang</span><br><span class="line">Password <span class="keyword">for</span> <span class="string">&#x27;http://wang@gitlab.wang.org&#x27;</span>: </span><br><span class="line">Counting objects: 4, <span class="keyword">done</span>.</span><br><span class="line">Delta compression using up to 2 threads.</span><br><span class="line">Compressing objects: 100% (3/3), <span class="keyword">done</span>.</span><br><span class="line">Writing objects: 100% (4/4), 402 bytes | 402.00 KiB/s, <span class="keyword">done</span>.</span><br><span class="line">Total 4 (delta 0), reused 0 (delta 0)</span><br><span class="line">remote: </span><br><span class="line">remote: To create a merge request <span class="keyword">for</span> develop, visit:</span><br><span class="line">remote:   http://gitlab.wang.org/magedu/app1/merge_requests/new?</span><br><span class="line">merge_request%5Bsource_branch%5D=develop</span><br><span class="line">remote: </span><br><span class="line">To http://gitlab.wang.org/magedu/app1.git</span><br><span class="line">   c5ca637..b66c729 develop -&gt; develop</span><br></pre></td></tr></table></figure>

<p>登录 Jenkins 服务器，修改”执行shell“如下</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> $<span class="variable">$WORKSPACE</span></span><br><span class="line">/usr/local/sonar-scanner/bin/sonar-scanner</span><br><span class="line">tar czvf /data/code.tar.gz *</span><br><span class="line">scp /data/code.tar.gz 10.0.0.104:/data/tomcat/tomcat_appdir/</span><br><span class="line">scp /data/code.tar.gz 10.0.0.105:/data/tomcat/tomcat_appdir/</span><br><span class="line">ssh 10.0.0.104 <span class="string">&quot;systemctl stop tomcat &amp;&amp; rm -rf /data/tomcat/tomcat_webdir/myapp/* &amp;&amp; cd /data/tomcat/tomcat_appdir &amp;&amp; tar xf code.tar.gz -C /data/tomcat/tomcat_webdir/myapp/ &amp;&amp; systemctl start tomcat&quot;</span></span><br><span class="line">ssh 10.0.0.105 <span class="string">&quot;systemctl stop tomcat &amp;&amp; rm -rf /data/tomcat/tomcat_webdir/myapp/* &amp;&amp; cd /data/tomcat/tomcat_appdir &amp;&amp; tar xf code.tar.gz -C /data/tomcat/tomcat_webdir/myapp/ &amp;&amp; systemctl start tomcat&quot;</span></span><br></pre></td></tr></table></figure>

<p><img src="C:\Users\Lenovo\Desktop\img\508.jpg" alt="508"></p>
<p><strong>立即构建，观察控制台输出结果</strong></p>
<p><img src="C:\Users\Lenovo\Desktop\img\509.jpg" alt="509"></p>
<p>登录sonarqube网页，可以看到下信息</p>
<p><img src="C:\Users\Lenovo\Desktop\img\510.jpg" alt="510"></p>
<h3 id="Jenkins-安装-SonarQube-插件实现代码扫描"><a href="#Jenkins-安装-SonarQube-插件实现代码扫描" class="headerlink" title="Jenkins 安装 SonarQube 插件实现代码扫描"></a>Jenkins 安装 SonarQube 插件实现代码扫描</h3><p>配置Jenkins使用sonar-scanner进行代码质量扫描，并将结果报告给SonarQube Server的主要步骤如下</p>
<ul>
<li>在 Jenkins上安装SonarQube插件</li>
<li>配置Jenkins对接到SonarQube Server</li>
<li>配置Jenkins的全局工具sonar-scanner</li>
<li>在SonarQube上添加回调Jenkins的Webhook</li>
<li>在Jenkins项目上调用sonar-scanner进行代码质量扫描</li>
<li>通过SonarQube确认扫描结果的评估</li>
</ul>
<h4 id="在SonarQube添加Jenkins的回调接口"><a href="#在SonarQube添加Jenkins的回调接口" class="headerlink" title="在SonarQube添加Jenkins的回调接口"></a>在SonarQube添加Jenkins的回调接口</h4><p>在SonarQube上添加webhook（网络调用），以便于Jenkins通过SonarQube Quality Gate插件调用其“质量阈”信息</p>
<p>注意：此处的密码需要足够长并有复杂度要求</p>
<p>生成随机密码</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@ubuntu2204 ~]<span class="comment"># openssl rand -hex 15</span></span><br><span class="line">73710fca9af2a665fcf72f3fce6368</span><br></pre></td></tr></table></figure>

<p><img src="C:\Users\Lenovo\Desktop\img\511.jpg" alt="511"></p>
<h4 id="Jenkins-安装-SonarQube-插件"><a href="#Jenkins-安装-SonarQube-插件" class="headerlink" title="Jenkins 安装 SonarQube 插件"></a>Jenkins 安装 SonarQube 插件</h4><p>Jenkins—系统管理–插件管理</p>
<p>安装插件 SonarQube Scanner</p>
<p><img src="C:\Users\Lenovo\Desktop\img\512.jpg" alt="512"></p>
<h4 id="系统配置中添加-SonarQuebe-Server-的地址和验证令牌"><a href="#系统配置中添加-SonarQuebe-Server-的地址和验证令牌" class="headerlink" title="系统配置中添加 SonarQuebe Server 的地址和验证令牌"></a>系统配置中添加 SonarQuebe Server 的地址和验证令牌</h4><p>Jenkins—系统管理—系统设置–SonarQube servers–输入Name –SonarQube-Server</p>
<p>注意: Name 的大小敏感</p>
<h5 id="SonarQube-服务器允许匿名访问"><a href="#SonarQube-服务器允许匿名访问" class="headerlink" title="SonarQube 服务器允许匿名访问"></a>SonarQube 服务器允许匿名访问</h5><p>旧版SonarQube默认匿名可以访问</p>
<p><img src="C:\Users\Lenovo\Desktop\img\513.jpg" alt="513"></p>
<h5 id="SonarQube服务器不允许匿名访问"><a href="#SonarQube服务器不允许匿名访问" class="headerlink" title="SonarQube服务器不允许匿名访问"></a>SonarQube服务器不允许匿名访问</h5><p>新版SonarQube默认匿名不可以访问</p>
<p>如果sonarqube不允许匿名，则还需要添加认证，即前面4.4.3.2创建的令牌</p>
<p><img src="C:\Users\Lenovo\Desktop\img\514.jpg" alt="514"></p>
<p><img src="C:\Users\Lenovo\Desktop\img\515.jpg" alt="515"></p>
<h4 id="Jenkins-添加-Sonar-Scanner-扫描器"><a href="#Jenkins-添加-Sonar-Scanner-扫描器" class="headerlink" title="Jenkins 添加 Sonar Scanner 扫描器"></a>Jenkins 添加 Sonar Scanner 扫描器</h4><p><strong>Jenkins–系统管理–全局工具配置</strong></p>
<p>有三种方法可以安装 Sonar Scanner</p>
<h5 id="手动指定-sonar-scanner-在本地安装的绝对路径"><a href="#手动指定-sonar-scanner-在本地安装的绝对路径" class="headerlink" title="手动指定 sonar-scanner 在本地安装的绝对路径"></a>手动指定 sonar-scanner 在本地安装的绝对路径</h5><p><img src="C:\Users\Lenovo\Desktop\img\516.jpg" alt="516"></p>
<h5 id="指定下载路径自动安装"><a href="#指定下载路径自动安装" class="headerlink" title="指定下载路径自动安装"></a>指定下载路径自动安装</h5><p>注意:此方式以后用脚本调用sonar scanner的路径要和下面相匹配，如果使用相关插件，可以则不关注路径</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://binaries.sonarsource.com/Distribution/sonar-scanner-cli/</span><br></pre></td></tr></table></figure>

<p><img src="C:\Users\Lenovo\Desktop\img\517.jpg" alt="517"></p>
<h5 id="自动从-Maven-仓库安装"><a href="#自动从-Maven-仓库安装" class="headerlink" title="自动从 Maven 仓库安装"></a>自动从 Maven 仓库安装</h5><p><img src="C:\Users\Lenovo\Desktop\img\518.jpg" alt="518"></p>
<h4 id="在任务构建步骤中添加-Execute-Sonarqube-Scanner"><a href="#在任务构建步骤中添加-Execute-Sonarqube-Scanner" class="headerlink" title="在任务构建步骤中添加 Execute Sonarqube Scanner"></a>在任务构建步骤中添加 Execute Sonarqube Scanner</h4><p>选择项目—增加构建步骤—选择“Execute Sonarqube Scanner”，并将Execute Sonarqube Scanner框，拖至执行shell 的前面，即先扫描再执行构建</p>
<p><img src="C:\Users\Lenovo\Desktop\img\519.jpg" alt="519"></p>
<h4 id="配置项目进行扫描"><a href="#配置项目进行扫描" class="headerlink" title="配置项目进行扫描"></a>配置项目进行扫描</h4><p>注意: 必须在源码管理 source code Management 中指定 git仓库路径 ，不能由脚本进行git clone </p>
<p><img src="C:\Users\Lenovo\Desktop\img\520.jpg" alt="520"></p>
<p>构建— Execute Sonarqube Scanner—Analysis properties，将配置文件的内容修改成如下格式</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">sonar.projectKey=<span class="variable">$&#123;JOB_NAME&#125;</span></span><br><span class="line">sonar.projectName=<span class="variable">$&#123;JOB_NAME&#125;</span></span><br><span class="line">sonar.sources=./</span><br><span class="line">sonar.projectVersion=1.0   （可选）</span><br><span class="line">sonar.language=php （可选）</span><br><span class="line">sonar.sourceEncoding=UTF-8 （可选）</span><br></pre></td></tr></table></figure>

<p>范例:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#项目的唯一标识</span></span><br><span class="line">sonar.projectKey=sprint-boot-helloworld</span><br><span class="line"><span class="comment">#项目的名称,用于显示在 sonarqube web 界面</span></span><br><span class="line">sonar.projectName=sprint-boot-helloworld</span><br><span class="line"><span class="comment">#项目版本</span></span><br><span class="line">sonar.projectVersion=1.0</span><br><span class="line"><span class="comment">#项目源码所在目录</span></span><br><span class="line">sonar.sources=.</span><br><span class="line"><span class="comment">#项目源码编译生成的二进制文件路径，必须添加，否则会scanner失败</span></span><br><span class="line">sonar.java.binaries=.</span><br><span class="line"><span class="comment">#编程语言</span></span><br><span class="line">sonar.language=java</span><br><span class="line"><span class="comment">#编码格式</span></span><br><span class="line">sonar.sourceEncoding=UTF-8</span><br></pre></td></tr></table></figure>

<p>范例: shell内容</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[root@jenkins ~]<span class="comment"># cat /data/jenkins/scripts/spring-boot-helloWorld-deploy-job.sh</span></span><br><span class="line"><span class="comment">#!/bin/bash</span></span><br><span class="line">HOST_LIST=<span class="string">&quot;</span></span><br><span class="line"><span class="string">10.0.0.8</span></span><br><span class="line"><span class="string">10.0.0.18</span></span><br><span class="line"><span class="string">&quot;</span></span><br><span class="line"></span><br><span class="line">mvn clean package -Dmaven.test.skip=<span class="literal">true</span></span><br><span class="line"><span class="keyword">for</span> host <span class="keyword">in</span> <span class="variable">$HOST_LIST</span>;<span class="keyword">do</span></span><br><span class="line">    ssh <span class="variable">$host</span> <span class="string">&quot;pgrep java &amp;&amp; killall java||true &quot;</span></span><br><span class="line">    scp target/spring-boot-helloworld-*.jar <span class="variable">$host</span>:/data/tomcat/appdir/</span><br><span class="line">    ssh <span class="variable">$host</span> <span class="string">&quot;java -jar /data/tomcat/appdir/spring-boot-helloworld-*.jar --server.port=8888 &quot;</span>&amp;</span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></table></figure>

<p><img src="C:\Users\Lenovo\Desktop\img\521.jpg" alt="521"></p>
<p>创建任务后可以看到下面出现三条曲线</p>
<p><img src="C:\Users\Lenovo\Desktop\img\522.jpg" alt="522"></p>
<p><strong>如果是 Java 项目，还可以使用Maven工程的另一种代码分析方法</strong></p>
<p><strong>直接使用mvn命令实现</strong></p>
<p><img src="C:\Users\Lenovo\Desktop\img\523.jpg" alt="523"><br><img src="C:\Users\Lenovo\Desktop\img\524.jpg" alt="524"></p>
<h4 id="构建项目并测试-sonar-scanner-是否生效"><a href="#构建项目并测试-sonar-scanner-是否生效" class="headerlink" title="构建项目并测试 sonar-scanner 是否生效"></a>构建项目并测试 sonar-scanner 是否生效</h4><p>点击项目的立即构建，下图是执行成功的信息：</p>
<p><img src="C:\Users\Lenovo\Desktop\img\525.jpg" alt="525"></p>
<h4 id="查看项目的构建历史"><a href="#查看项目的构建历史" class="headerlink" title="查看项目的构建历史"></a>查看项目的构建历史</h4><p><img src="C:\Users\Lenovo\Desktop\img\526.jpg" alt="526"></p>
<p><strong>登录SonarQube网页，可以看到下面信息</strong></p>
<p><img src="C:\Users\Lenovo\Desktop\img\527.jpg" alt="527"></p>
<h2 id="案例1-Pipeline-集成-SonarQube-实现代码检测通知-Jenkins"><a href="#案例1-Pipeline-集成-SonarQube-实现代码检测通知-Jenkins" class="headerlink" title="案例1: Pipeline 集成 SonarQube 实现代码检测通知 Jenkins"></a>案例1: Pipeline 集成 SonarQube 实现代码检测通知 Jenkins</h2><p>实现当Sonarqube检测失败时，不会继续进行后面的构建编译等步骤</p>
<h3 id="在-SonarQube-添加-Jenkins-的回调接口"><a href="#在-SonarQube-添加-Jenkins-的回调接口" class="headerlink" title="在 SonarQube 添加 Jenkins 的回调接口"></a>在 SonarQube 添加 Jenkins 的回调接口</h3><p>在SonarQube上添加webhook(网络调用)，以便于Jenkins通过SonarQube Quality Gate插件调用其”质量阈”信息，决定是否继续执行下面的构建步骤</p>
<p>配置 — 网络调用 — 创建</p>
<p><img src="C:\Users\Lenovo\Desktop\img\528.jpg" alt="528"></p>
<p>输入名称和下面 Jenkins的URL地址</p>
<p>注意: 密码防止攻击使用， 可以随意输入</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">http://jenkins.wang.org:8080/sonarqube-webhook</span><br><span class="line"></span><br><span class="line"><span class="comment">#生成Secet,注意:密码不能太短,否则会导致在执行waitForQualityGate abortPipeline: true时提示Invalid JSON String</span></span><br><span class="line"></span><br><span class="line">[root@ubuntu2204 ~]<span class="comment"># openssl rand -base64 21</span></span><br><span class="line">PiTVO6epEqIUlvU1DBoK1bVS3bkh</span><br></pre></td></tr></table></figure>

<p><img src="C:\Users\Lenovo\Desktop\img\529.jpg" alt="529"><br><img src="C:\Users\Lenovo\Desktop\img\530.jpg" alt="530"></p>
<h3 id="准备项目的-Jenkinsfile-文件"><a href="#准备项目的-Jenkinsfile-文件" class="headerlink" title="准备项目的 Jenkinsfile 文件"></a>准备项目的 Jenkinsfile 文件</h3><p>在项目所在的目录中准备Jenkinsfile文件</p>
<p>注意: 之后需要git commit 此文件</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="meta">@dev</span> spring-boot-helloWorld]# cat Jenkinsfile</span><br><span class="line">pipeline &#123;</span><br><span class="line">   agent any </span><br><span class="line">   stages &#123;</span><br><span class="line">       stage(<span class="string">&quot;SonarQube Analysis&quot;</span>)&#123;</span><br><span class="line">           steps &#123;</span><br><span class="line">         <span class="comment">//注意:下面的SonarQube-Server和系统配置SonarQube installations的Name必须一致,大小写敏感</span></span><br><span class="line">               withSonarQubeEnv(<span class="string">&quot;SonarQube-Server&quot;</span>)&#123; </span><br><span class="line">                    sh <span class="string">&#x27;mvn sonar:sonar&#x27;</span></span><br><span class="line">               &#125;</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">       stage(<span class="string">&quot;Quality Gate&quot;</span>) &#123;</span><br><span class="line">           steps &#123;</span><br><span class="line">           <span class="comment">//代码检测失败,将不再继续执行后面的任务,直接退出,报告返回的超时时长设为5分钟</span></span><br><span class="line">               timeout(<span class="attr">time:</span> <span class="number">5</span>,<span class="attr">unit:</span> <span class="string">&#x27;MINUTES&#x27;</span>)&#123;   </span><br><span class="line">                   waitForQualityGate <span class="attr">abortPipeline:</span> <span class="literal">true</span></span><br><span class="line">               &#125;</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">       stage(<span class="string">&#x27;Build&#x27;</span>) &#123; </span><br><span class="line">           steps &#123;</span><br><span class="line">               sh <span class="string">&#x27;mvn clean package -Dmaven.test.skip=true&#x27;</span></span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">       stage(<span class="string">&#x27;Test&#x27;</span>) &#123; </span><br><span class="line">           steps &#123;</span><br><span class="line">                echo <span class="string">&quot;Test&quot;</span></span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">       stage(<span class="string">&#x27;Deploy&#x27;</span>) &#123; </span><br><span class="line">           steps &#123;</span><br><span class="line">               echo <span class="string">&quot;Deploy&quot;</span></span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br><span class="line">   post &#123;</span><br><span class="line">       always &#123;</span><br><span class="line">           mail <span class="attr">to:</span><span class="string">&quot;29308620@qq.com&quot;</span>,</span><br><span class="line">           <span class="symbol">subject:</span><span class="string">&quot;Status of pipeline: $&#123;currentBuild.fullDisplayName&#125;&quot;</span>,</span><br><span class="line">           <span class="symbol">body:</span><span class="string">&quot;$&#123;env.BUILD_URL&#125; has result $&#123;currentBuild.result&#125;&quot;</span></span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="准备项目目录中的-sonar-project-properties-文件"><a href="#准备项目目录中的-sonar-project-properties-文件" class="headerlink" title="准备项目目录中的 sonar-project.properties 文件"></a>准备项目目录中的 sonar-project.properties 文件</h3><p>准备 sonar scanner 所需的项目目录中 sonar-project.properties 文件</p>
<p>注意: 之后需要git commit 此文件</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[root@dev spring-boot-helloWorld]<span class="comment"># cat sonar-project.properties </span></span><br><span class="line"><span class="comment">#项目的唯一标识</span></span><br><span class="line">sonar.projectKey=sprint-boot-helloworld</span><br><span class="line"><span class="comment">#项目的名称,用于显示在 sonarqube web 界面</span></span><br><span class="line">sonar.projectName=sprint-boot-helloworld</span><br><span class="line"><span class="comment">#项目版本</span></span><br><span class="line">sonar.projectVersion=1.0</span><br><span class="line"><span class="comment">#项目源码所在目录</span></span><br><span class="line">sonar.sources=.</span><br><span class="line"><span class="comment">#项目源码编译生成的二进制文件路径</span></span><br><span class="line">sonar.java.binaries=.</span><br><span class="line"><span class="comment">#编程语言</span></span><br><span class="line">sonar.language=java</span><br><span class="line"><span class="comment">#编码格式</span></span><br><span class="line">sonar.sourceEncoding=UTF-8</span><br></pre></td></tr></table></figure>

<h3 id="创建任务使用-Pipeline-Script-from-SCM"><a href="#创建任务使用-Pipeline-Script-from-SCM" class="headerlink" title="创建任务使用 Pipeline Script from SCM"></a>创建任务使用 Pipeline Script from SCM</h3><p>创建任务</p>
<p><img src="C:\Users\Lenovo\Desktop\img\531.jpg" alt="531"></p>
<h3 id="执行成功构建"><a href="#执行成功构建" class="headerlink" title="执行成功构建"></a>执行成功构建</h3><p><img src="C:\Users\Lenovo\Desktop\img\532.jpg" alt="532"><br><img src="C:\Users\Lenovo\Desktop\img\533.jpg" alt="533"><br><img src="C:\Users\Lenovo\Desktop\img\534.jpg" alt="534"><br><img src="C:\Users\Lenovo\Desktop\img\535.jpg" alt="535"></p>
<h3 id="执行问题代码构建"><a href="#执行问题代码构建" class="headerlink" title="执行问题代码构建"></a>执行问题代码构建</h3><h4 id="构建问题代码"><a href="#构建问题代码" class="headerlink" title="构建问题代码"></a>构建问题代码</h4><p>修改默认质量阈</p>
<p><img src="C:\Users\Lenovo\Desktop\img\536.jpg" alt="536"></p>
<h4 id="查看结果-1"><a href="#查看结果-1" class="headerlink" title="查看结果"></a>查看结果</h4><p><img src="C:\Users\Lenovo\Desktop\img\537.jpg" alt="537"><br><img src="C:\Users\Lenovo\Desktop\img\538.jpg" alt="538"><br><img src="C:\Users\Lenovo\Desktop\img\539.jpg" alt="539"><br><img src="C:\Users\Lenovo\Desktop\img\540.jpg" alt="540"><br><img src="C:\Users\Lenovo\Desktop\img\541.jpg" alt="541"></p>
<h2 id="案例2-PipeLine-实现集成-SonarQube-实现代码检测通知-Jenkins"><a href="#案例2-PipeLine-实现集成-SonarQube-实现代码检测通知-Jenkins" class="headerlink" title="案例2: PipeLine 实现集成 SonarQube 实现代码检测通知 Jenkins"></a>案例2: PipeLine 实现集成 SonarQube 实现代码检测通知 Jenkins</h2><h3 id="安装-Jenkins-并安装相关插件"><a href="#安装-Jenkins-并安装相关插件" class="headerlink" title="安装 Jenkins 并安装相关插件"></a>安装 Jenkins 并安装相关插件</h3><p>安装相关插件: GitLab ,pipeline,Qy Wechat Notification,SonarQube Scanner </p>
<h3 id="安装-Jenkins-的-Maven-工具"><a href="#安装-Jenkins-的-Maven-工具" class="headerlink" title="安装 Jenkins 的 Maven 工具"></a>安装 Jenkins 的 Maven 工具</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">[root@ubuntu2204 ~]<span class="comment"># apt update;apt install maven -y</span></span><br><span class="line">[root@ubuntu2204 ~]<span class="comment"># vim /etc/maven/settings.xml</span></span><br><span class="line">......</span><br><span class="line">   &lt;mirror&gt;</span><br><span class="line">       &lt;<span class="built_in">id</span>&gt;nexus-aliyun&lt;/id&gt;</span><br><span class="line">       &lt;mirrorOf&gt;*&lt;/mirrorOf&gt;</span><br><span class="line">       &lt;name&gt;Nexus aliyun&lt;/name&gt;</span><br><span class="line">       &lt;url&gt;http://maven.aliyun.com/nexus/content/groups/public&lt;/url&gt;</span><br><span class="line">   &lt;/mirror&gt;</span><br><span class="line"> &lt;/mirrors&gt;</span><br><span class="line">.....</span><br><span class="line"></span><br><span class="line"><span class="comment">#查看Maven信息</span></span><br><span class="line">[root@ubuntu2204 ~]<span class="comment"># mvn -version</span></span><br><span class="line">Apache Maven 3.6.3</span><br><span class="line">Maven home: /usr/share/maven</span><br><span class="line">Java version: 11.0.17, vendor: Ubuntu, runtime: /usr/lib/jvm/java-11-openjdk-amd64</span><br><span class="line">Default locale: zh_CN, platform encoding: UTF-8</span><br><span class="line">OS name: <span class="string">&quot;linux&quot;</span>, version: <span class="string">&quot;5.15.0-52-generic&quot;</span>, <span class="built_in">arch</span>: <span class="string">&quot;amd64&quot;</span>, family: <span class="string">&quot;unix&quot;</span></span><br></pre></td></tr></table></figure>

<p><img src="C:\Users\Lenovo\Desktop\img\542.jpg" alt="542"></p>
<h3 id="安装-Gitlab-准备项目"><a href="#安装-Gitlab-准备项目" class="headerlink" title="安装 Gitlab 准备项目"></a>安装 Gitlab 准备项目</h3><p><img src="C:\Users\Lenovo\Desktop\img\543.jpg" alt="543"></p>
<h3 id="在-Jenkins-创建连接-Gitlab的凭据"><a href="#在-Jenkins-创建连接-Gitlab的凭据" class="headerlink" title="在 Jenkins 创建连接 Gitlab的凭据"></a>在 Jenkins 创建连接 Gitlab的凭据</h3><p><img src="C:\Users\Lenovo\Desktop\img\544.jpg" alt="544"></p>
<h3 id="安装-Harbor-并配置-Jenkins-连接Harbor"><a href="#安装-Harbor-并配置-Jenkins-连接Harbor" class="headerlink" title="安装 Harbor 并配置 Jenkins 连接Harbor"></a>安装 Harbor 并配置 Jenkins 连接Harbor</h3><p>在Jenkins 服务器安装Docker,并配置连接 Harbor</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">[root@ubuntu2204 ~]<span class="comment"># apt update;apt install docker.io</span></span><br><span class="line">[root@ubuntu2204 ~]<span class="comment"># vim /etc/docker/daemon.json </span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;registry-mirrors&quot;</span>: [<span class="string">&quot;https://si7y70hh.mirror.aliyuncs.com&quot;</span>],</span><br><span class="line">  <span class="string">&quot;insecure-registries&quot;</span>: [<span class="string">&quot;harbor.wang.org&quot;</span>]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">[root@ubuntu2204 ~]<span class="comment"># systemctl restart docker</span></span><br><span class="line">[root@ubuntu2204 ~]<span class="comment"># docker info</span></span><br><span class="line">......</span><br><span class="line"> Registry: https://index.docker.io/v1/</span><br><span class="line"> Labels:</span><br><span class="line"> Experimental: <span class="literal">false</span></span><br><span class="line"> Insecure Registries:</span><br><span class="line"> harbor.wang.org</span><br><span class="line">  127.0.0.0/8</span><br><span class="line"> Registry Mirrors:</span><br><span class="line"> https://si7y70hh.mirror.aliyuncs.com/</span><br><span class="line"> Live Restore Enabled: <span class="literal">false</span></span><br></pre></td></tr></table></figure>

<h3 id="在Jenkins上修改-Docker的socket文件权限"><a href="#在Jenkins上修改-Docker的socket文件权限" class="headerlink" title="在Jenkins上修改 Docker的socket文件权限"></a>在Jenkins上修改 Docker的socket文件权限</h3><p>默认Jenkins以Jenkins用户启动，无法访问Docker,构建时会提示如下错误:</p>
<p><img src="C:\Users\Lenovo\Desktop\img\545.jpg" alt="545"></p>
<p>范例: 解决错误</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[root@ubuntu2204 src]<span class="comment"># ll /var/run/docker.sock</span></span><br><span class="line">srw-rw---- 1 root docker 0  1月 31 17:20 /var/run/docker.sock=</span><br><span class="line"></span><br><span class="line">[root@ubuntu2204 src]<span class="comment"># cd </span></span><br><span class="line">[root@ubuntu2204 ~]<span class="comment"># id jenkins</span></span><br><span class="line">用户<span class="built_in">id</span>=113(jenkins) 组<span class="built_in">id</span>=118(jenkins) 组=118(jenkins)</span><br><span class="line"></span><br><span class="line">[root@ubuntu2204 ~]<span class="comment"># usermod -G docker jenkins</span></span><br><span class="line">[root@ubuntu2204 ~]<span class="comment"># id jenkins</span></span><br><span class="line">用户<span class="built_in">id</span>=113(jenkins) 组<span class="built_in">id</span>=118(jenkins) 组=118(jenkins),119(docker)</span><br><span class="line"></span><br><span class="line">[root@ubuntu2204 ~]<span class="comment"># systemctl restart jenkins</span></span><br></pre></td></tr></table></figure>

<h3 id="在-Jenkins-创建凭据连接-Harbor"><a href="#在-Jenkins-创建凭据连接-Harbor" class="headerlink" title="在 Jenkins 创建凭据连接 Harbor"></a>在 Jenkins 创建凭据连接 Harbor</h3><p><img src="C:\Users\Lenovo\Desktop\img\546.jpg" alt="546"></p>
<h3 id="安装-SonarQube-并创建用户和令牌"><a href="#安装-SonarQube-并创建用户和令牌" class="headerlink" title="安装 SonarQube 并创建用户和令牌"></a>安装 SonarQube 并创建用户和令牌</h3><p>在 Sonarqube 创建用户并授权</p>
<p><img src="C:\Users\Lenovo\Desktop\img\547.jpg" alt="547"></p>
<p>生成令牌</p>
<p><img src="C:\Users\Lenovo\Desktop\img\548.jpg" alt="548"><br><img src="C:\Users\Lenovo\Desktop\img\549.jpg" alt="549"></p>
<h3 id="在-SonarQube-添加-Jenkins-的回调接口-1"><a href="#在-SonarQube-添加-Jenkins-的回调接口-1" class="headerlink" title="在 SonarQube 添加 Jenkins 的回调接口"></a>在 SonarQube 添加 Jenkins 的回调接口</h3><p>在SonarQube上添加webhook(网络调用)，以便于Jenkins通过SonarQube Quality Gate插件调用其”质量阈”信息，决定是否继续执行下面的构建步骤</p>
<p>配置 — 网络调用 — 创建</p>
<p><img src="C:\Users\Lenovo\Desktop\img\550.jpg" alt="550"></p>
<p>输入名称和下面 Jenkins的URL地址</p>
<p>注意: 密码防止攻击使用， 可以随意输入</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">http://jenkins.wang.org:8080/sonarqube-webhook</span><br><span class="line"></span><br><span class="line"><span class="comment">#生成Secet,注意:密码不能太短,否则会导致在执行waitForQualityGate abortPipeline: true时提示Invalid JSON String</span></span><br><span class="line"></span><br><span class="line">[root@ubuntu2204 ~]<span class="comment"># openssl rand -base64 21</span></span><br><span class="line">PiTVO6epEqIUlvU1DBoK1bVS3bkh</span><br></pre></td></tr></table></figure>

<p><img src="C:\Users\Lenovo\Desktop\img\551.jpg" alt="551"><br><img src="C:\Users\Lenovo\Desktop\img\552.jpg" alt="552"></p>
<h3 id="创建Jenkins访问-Sonarqube的令牌凭据"><a href="#创建Jenkins访问-Sonarqube的令牌凭据" class="headerlink" title="创建Jenkins访问 Sonarqube的令牌凭据"></a>创建Jenkins访问 Sonarqube的令牌凭据</h3><p>用上面4.8.3小节生成的令牌，在Jenkins 创建凭据</p>
<p><img src="C:\Users\Lenovo\Desktop\img\553.jpg" alt="553"></p>
<h3 id="在Jenkins上配置系统的-SonarQube-服务器信息"><a href="#在Jenkins上配置系统的-SonarQube-服务器信息" class="headerlink" title="在Jenkins上配置系统的 SonarQube 服务器信息"></a>在Jenkins上配置系统的 SonarQube 服务器信息</h3><p><img src="C:\Users\Lenovo\Desktop\img\554.jpg" alt="554"></p>
<h3 id="在Jenkins上创建-Pipeline-任务"><a href="#在Jenkins上创建-Pipeline-任务" class="headerlink" title="在Jenkins上创建 Pipeline 任务"></a>在Jenkins上创建 Pipeline 任务</h3><p><img src="C:\Users\Lenovo\Desktop\img\555.jpg" alt="555"></p>
<h3 id="创建任务使用Pipeline-Script"><a href="#创建任务使用Pipeline-Script" class="headerlink" title="创建任务使用Pipeline Script"></a>创建任务使用Pipeline Script</h3><p>直接使用Pipeline Script</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line">pipeline &#123;</span><br><span class="line">   agent any</span><br><span class="line">   tools &#123;</span><br><span class="line">       maven <span class="string">&#x27;maven-3.6.3&#x27;</span></span><br><span class="line">   &#125;</span><br><span class="line">   environment &#123;</span><br><span class="line">        codeRepo=<span class="string">&quot;http://gitlab.wang.org/example/spring-boot-helloWorld.git&quot;</span></span><br><span class="line">        harborServer=<span class="string">&#x27;harbor.wang.org&#x27;</span></span><br><span class="line">        projectName=<span class="string">&#x27;spring-boot-helloworld&#x27;</span></span><br><span class="line">        imageUrl=<span class="string">&quot;$&#123;harborServer&#125;/example/$&#123;projectName&#125;&quot;</span></span><br><span class="line">        imageTag=<span class="string">&#x27;latest&#x27;</span></span><br><span class="line">   &#125;</span><br><span class="line">   stages &#123;</span><br><span class="line">       stage(<span class="string">&#x27;Source&#x27;</span>) &#123;</span><br><span class="line">           steps &#123;</span><br><span class="line">                git <span class="attr">branch:</span> <span class="string">&#x27;main&#x27;</span>, <span class="attr">credentialsId:</span> <span class="string">&#x27;gitlab-root-credential&#x27;</span>, <span class="attr">url:</span> <span class="string">&quot;$&#123;codeRepo&#125;&quot;</span></span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">       stage(<span class="string">&#x27;Build&#x27;</span>) &#123;</span><br><span class="line">           steps &#123;</span><br><span class="line">                sh <span class="string">&#x27;mvn -B -DskipTests clean package&#x27;</span></span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">       stage(<span class="string">&#x27;Test&#x27;</span>) &#123;</span><br><span class="line">           steps &#123;</span><br><span class="line">                sh <span class="string">&#x27;mvn test&#x27;</span></span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">       stage(<span class="string">&quot;SonarQube Analysis&quot;</span>) &#123;</span><br><span class="line">           steps &#123;</span><br><span class="line">               withSonarQubeEnv(<span class="string">&#x27;SonarQube-Server&#x27;</span>) &#123;</span><br><span class="line">                    sh <span class="string">&#x27;mvn sonar:sonar&#x27;</span></span><br><span class="line">               &#125;</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">       stage(<span class="string">&quot;Quality Gate&quot;</span>) &#123;</span><br><span class="line">           steps &#123;</span><br><span class="line">               timeout(<span class="attr">time:</span> <span class="number">30</span>, <span class="attr">unit:</span> <span class="string">&#x27;MINUTES&#x27;</span>) &#123;</span><br><span class="line">                   waitForQualityGate <span class="attr">abortPipeline:</span> <span class="literal">true</span></span><br><span class="line">               &#125;</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">       stage(<span class="string">&#x27;Build Docker Image&#x27;</span>) &#123;</span><br><span class="line">           steps &#123;</span><br><span class="line">                sh <span class="string">&#x27;docker image build . -t &quot;$&#123;imageUrl&#125;:$&#123;imageTag&#125;&quot;&#x27;</span></span><br><span class="line">               <span class="comment">// input(message: &#x27;镜像已经构建完成，是否要推送？&#x27;)</span></span><br><span class="line">           &#125;           </span><br><span class="line">       &#125;</span><br><span class="line">       stage(<span class="string">&#x27;Push Docker Image&#x27;</span>) &#123;</span><br><span class="line">           steps &#123;</span><br><span class="line">               withCredentials([usernamePassword(<span class="attr">credentialsId:</span> <span class="string">&#x27;harbor-user-credential&#x27;</span>, <span class="attr">passwordVariable:</span> <span class="string">&#x27;harborPassword&#x27;</span>, <span class="attr">usernameVariable:</span> </span><br><span class="line"><span class="string">&#x27;harborUserName&#x27;</span>)]) &#123;</span><br><span class="line">                    sh <span class="string">&quot;docker login -u $&#123;env.harborUserName&#125; -p $&#123;env.harborPassword&#125; $&#123;harborServer&#125;&quot;</span></span><br><span class="line">                    sh <span class="string">&quot;docker image push $&#123;imageUrl&#125;:$&#123;imageTag&#125;&quot;</span></span><br><span class="line">               &#125;</span><br><span class="line">           &#125;   </span><br><span class="line">       &#125; </span><br><span class="line">   &#125;</span><br><span class="line">   post&#123;</span><br><span class="line">       success&#123;</span><br><span class="line">           qyWechatNotification <span class="attr">failNotify:</span> <span class="literal">true</span>, <span class="attr">webhookUrl:</span> <span class="string">&#x27;https://qyapi.weixin.qq.com/cgi-bin/webhook/send?key=1a4e1e74-e7d6-4376-99f6-048b01a7b7fc&#x27;</span></span><br><span class="line">       &#125;</span><br><span class="line">       failure&#123;</span><br><span class="line">           qyWechatNotification <span class="attr">failNotify:</span> <span class="literal">true</span>, <span class="attr">webhookUrl:</span> <span class="string">&#x27;https://qyapi.weixin.qq.com/cgi-bin/webhook/send?key=1a4e1e74-e7d6-4376-99f6-048b01a7b7fc&#x27;</span></span><br><span class="line">       &#125;</span><br><span class="line">   &#125;   </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="C:\Users\Lenovo\Desktop\img\556.jpg" alt="556"></p>
<h3 id="执行构建-2"><a href="#执行构建-2" class="headerlink" title="执行构建"></a>执行构建</h3><p><img src="C:\Users\Lenovo\Desktop\img\557.jpg" alt="557"><br><img src="C:\Users\Lenovo\Desktop\img\558.jpg" alt="558"></p>
<p> SonarQube 生成报告</p>
<p><img src="C:\Users\Lenovo\Desktop\img\559.jpg" alt="559"></p>
<p>镜像上传到Harbor</p>
<p><img src="C:\Users\Lenovo\Desktop\img\560.jpg" alt="560"><br><img src="C:\Users\Lenovo\Desktop\img\561.jpg" alt="561"></p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="http://example.com">૮(˶ᵔ ᵕ ᵔ˶)ა</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="http://example.com/2025/05/09/SRE-jenkins/">http://example.com/2025/05/09/SRE-jenkins/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="http://example.com" target="_blank">૮(˶ᵔ ᵕ ᵔ˶)ა</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/Jenkins/">Jenkins</a><a class="post-meta__tags" href="/tags/SRE/">SRE</a></div><div class="post_share"><div class="social-share" data-image="/../images/SRE/day55/1.jpg" data-sites="wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2025/04/24/SRE-git/" title="版本管理系统Git和GitLab"><img class="cover" src="/../images/SRE/day53/77.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">版本管理系统Git和GitLab</div></div></a></div><div class="next-post pull-right"><a href="/2025/07/30/MY-k8s1.29/" title="K8S 1.29.2"><img class="cover" src="/../images/SRE/day46/1.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">K8S 1.29.2</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><div><a href="/2023/06/13/DN-Jenkins/" title="Jenkins"><img class="cover" src="/../images/TITLE/jenkins.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-06-13</div><div class="title">Jenkins</div></div></a></div><div><a href="/2025/04/15/SRE-HAProxy/" title="高可用性集群HAProxy"><img class="cover" src="/../images/SRE/day47/1.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2025-04-15</div><div class="title">高可用性集群HAProxy</div></div></a></div><div><a href="/2025/04/16/SRE-Keepalived/" title="高可用性集群Keepalived"><img class="cover" src="/../images/SRE/day48/1.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2025-04-16</div><div class="title">高可用性集群Keepalived</div></div></a></div><div><a href="/2025/02/21/SRE-LVS/" title="企业级调度器LVS"><img class="cover" src="/../images/SRE/day27/3.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2025-02-21</div><div class="title">企业级调度器LVS</div></div></a></div><div><a href="/2024/04/24/SRE-Linux%E5%9F%BA%E6%9C%AC%E6%93%8D%E4%BD%9C%E5%92%8C%E5%B8%AE%E5%8A%A9/" title="Linux基本操作和帮助"><img class="cover" src="/../images/TITLE/linux2.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-04-24</div><div class="title">Linux基本操作和帮助</div></div></a></div><div><a href="/2024/08/27/SRE-Linux%E6%96%87%E4%BB%B6%E7%AE%A1%E7%90%86%E5%92%8CIO%E9%87%8D%E5%AE%9A%E5%90%91/" title="Linux文件管理和IO重定向"><img class="cover" src="/../images/TITLE/linux3.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-08-27</div><div class="title">Linux文件管理和IO重定向</div></div></a></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="/../images/TITLE/user.webp" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">૮(˶ᵔ ᵕ ᵔ˶)ა</div><div class="author-info__description">这家伙很勤奋，什么都留下了</div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">103</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">42</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">35</div></a></div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content is-expand"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Jenkins-%E9%83%A8%E7%BD%B2%E4%B8%8E%E5%9F%BA%E6%9C%AC%E9%85%8D%E7%BD%AE"><span class="toc-number">1.</span> <span class="toc-text">Jenkins 部署与基本配置</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Jenkins-%E4%BB%8B%E7%BB%8D"><span class="toc-number">1.1.</span> <span class="toc-text">Jenkins 介绍</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Jenkins-%E5%AE%89%E8%A3%85%E5%92%8C%E5%90%AF%E5%8A%A8"><span class="toc-number">1.2.</span> <span class="toc-text">Jenkins 安装和启动</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Jenkins-%E7%9A%84%E5%AE%89%E8%A3%85"><span class="toc-number">1.2.1.</span> <span class="toc-text">Jenkins 的安装</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%89%E8%A3%85%E5%89%8D%E7%8E%AF%E5%A2%83%E5%87%86%E5%A4%87"><span class="toc-number">1.2.1.1.</span> <span class="toc-text">安装前环境准备</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E7%B3%BB%E7%BB%9F%E8%A6%81%E6%B1%82"><span class="toc-number">1.2.1.1.1.</span> <span class="toc-text">系统要求</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E7%B3%BB%E7%BB%9F%E5%87%86%E5%A4%87"><span class="toc-number">1.2.1.1.2.</span> <span class="toc-text">系统准备</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#JAVA-%E7%8E%AF%E5%A2%83"><span class="toc-number">1.2.1.1.3.</span> <span class="toc-text">JAVA 环境</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8C%85%E5%AE%89%E8%A3%85-Jenkins"><span class="toc-number">1.2.1.2.</span> <span class="toc-text">包安装 Jenkins</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#Ubuntu-%E5%8C%85%E5%AE%89%E8%A3%85-Jenkins"><span class="toc-number">1.2.1.2.1.</span> <span class="toc-text">Ubuntu 包安装 Jenkins</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#CentOS-%E5%8C%85%E5%AE%89%E8%A3%85-Jenkins"><span class="toc-number">1.2.1.2.2.</span> <span class="toc-text">CentOS 包安装 Jenkins</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%BF%AE%E6%94%B9-jenkins-%E6%9C%8D%E5%8A%A1%E7%9A%84%E7%94%A8%E6%88%B7"><span class="toc-number">1.2.1.2.3.</span> <span class="toc-text">修改 jenkins 服务的用户</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%B8%80%E9%94%AE%E5%AE%89%E8%A3%85-Jenkins-%E8%84%9A%E6%9C%AC"><span class="toc-number">1.2.1.2.4.</span> <span class="toc-text">一键安装 Jenkins 脚本</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%9F%BA%E4%BA%8E-WAR-%E5%8C%85%E7%9B%B4%E6%8E%A5%E9%83%A8%E7%BD%B2"><span class="toc-number">1.2.1.3.</span> <span class="toc-text">基于 WAR 包直接部署</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%9F%BA%E4%BA%8E-Docker-%E9%83%A8%E7%BD%B2-Jenkins"><span class="toc-number">1.2.1.4.</span> <span class="toc-text">基于 Docker 部署 Jenkins</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%90%AF%E5%8A%A8-Jenkins"><span class="toc-number">1.2.2.</span> <span class="toc-text">启动 Jenkins</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%80%9A%E8%BF%87%E8%84%9A%E6%9C%AC%E6%88%96service%E5%90%AF%E5%8A%A8"><span class="toc-number">1.2.2.1.</span> <span class="toc-text">通过脚本或service启动</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%80%9A%E8%BF%87-Java-%E5%91%BD%E4%BB%A4%E7%9B%B4%E6%8E%A5%E5%90%AF%E5%8A%A8-Jenkins"><span class="toc-number">1.2.2.2.</span> <span class="toc-text">通过 Java 命令直接启动 Jenkins</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%B0%86-WAR-%E6%96%87%E4%BB%B6%E6%94%BE%E5%9C%A8tomcat%E8%BF%9B%E8%A1%8C%E8%BF%90%E8%A1%8C"><span class="toc-number">1.2.2.3.</span> <span class="toc-text">将 WAR 文件放在tomcat进行运行</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%A6%96%E6%AC%A1%E7%99%BB%E5%BD%95-Jenkins%E9%A1%B5%E9%9D%A2%E5%88%9D%E5%A7%8B%E5%8C%96"><span class="toc-number">1.2.3.</span> <span class="toc-text">首次登录 Jenkins页面初始化</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%A6%96%E6%AC%A1%E7%99%BB%E5%BD%95-Jenkins-%E9%A1%B5%E9%9D%A2"><span class="toc-number">1.2.3.1.</span> <span class="toc-text">首次登录 Jenkins 页面</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%80%89%E6%8B%A9%E5%AE%89%E8%A3%85-Jenkins-%E6%8F%92%E4%BB%B6"><span class="toc-number">1.2.3.2.</span> <span class="toc-text">选择安装 Jenkins 插件</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%8F%92%E4%BB%B6%E5%AE%89%E8%A3%85"><span class="toc-number">1.2.3.3.</span> <span class="toc-text">插件安装</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA-Jenkins-%E7%AE%A1%E7%90%86%E5%91%98-%E5%8F%AF%E9%80%89"><span class="toc-number">1.2.3.4.</span> <span class="toc-text">创建 Jenkins 管理员(可选)</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE-Jenkins-URL"><span class="toc-number">1.2.3.5.</span> <span class="toc-text">配置 Jenkins URL</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE%E5%AE%8C%E6%88%90%E5%B9%B6%E7%99%BB%E9%99%86-Jenkins"><span class="toc-number">1.2.3.6.</span> <span class="toc-text">配置完成并登陆 Jenkins</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%99%BB%E9%99%86-Jenkins%E7%95%8C%E9%9D%A2"><span class="toc-number">1.2.3.7.</span> <span class="toc-text">登陆 Jenkins界面</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Jenkins-%E5%9F%BA%E7%A1%80%E9%85%8D%E7%BD%AE"><span class="toc-number">1.3.</span> <span class="toc-text">Jenkins 基础配置</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BF%AE%E6%94%B9%E7%AE%A1%E7%90%86%E5%91%98%E5%AF%86%E7%A0%81"><span class="toc-number">1.3.1.</span> <span class="toc-text">修改管理员密码</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Jenkins-%E7%AE%A1%E7%90%86%E5%B7%A5%E5%85%B7"><span class="toc-number">1.3.2.</span> <span class="toc-text">Jenkins 管理工具</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Jenkins-%E6%8F%92%E4%BB%B6%E7%AE%A1%E7%90%86%E5%8F%8A%E5%AE%89%E8%A3%85"><span class="toc-number">1.3.3.</span> <span class="toc-text">Jenkins 插件管理及安装</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%8F%92%E4%BB%B6%E5%AE%89%E8%A3%85%E7%9B%AE%E5%BD%95"><span class="toc-number">1.3.3.1.</span> <span class="toc-text">插件安装目录</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%8F%92%E4%BB%B6%E7%AE%A1%E7%90%86"><span class="toc-number">1.3.3.2.</span> <span class="toc-text">插件管理</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%96%B9%E6%B3%951-%E6%9B%B4%E6%94%B9-Jenkins-%E7%9A%84%E9%95%9C%E5%83%8F%E6%BA%90%E4%B8%BA%E5%9B%BD%E5%86%85%E9%95%9C%E5%83%8F%E7%AB%99"><span class="toc-number">1.3.3.2.1.</span> <span class="toc-text">方法1: 更改 Jenkins 的镜像源为国内镜像站</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%96%B9%E6%B3%952-Jenkins-%E5%AE%98%E7%BD%91%E6%88%96%E9%95%9C%E5%83%8F%E7%BD%91%E7%AB%99%E4%B8%8B%E8%BD%BD%E6%83%B3%E8%A6%81%E7%9A%84%E6%8F%92%E4%BB%B6%E6%96%87%E4%BB%B6%EF%BC%8C%E5%86%8D%E5%AF%BC%E5%85%A5%E5%88%B0-Jenkins-%E4%B8%AD"><span class="toc-number">1.3.3.2.2.</span> <span class="toc-text">方法2: Jenkins 官网或镜像网站下载想要的插件文件，再导入到 Jenkins 中</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%96%B9%E6%B3%953-%E7%A6%BB%E7%BA%BF%E6%8F%92%E4%BB%B6%E5%8C%85%E5%A4%8D%E5%88%B6%E8%87%B3%E6%8F%92%E4%BB%B6%E5%AE%89%E8%A3%85%E7%9B%AE%E5%BD%95"><span class="toc-number">1.3.3.2.3.</span> <span class="toc-text">方法3: 离线插件包复制至插件安装目录</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%89%E8%A3%85%E4%B8%AD%E6%96%87%E6%8F%92%E4%BB%B6"><span class="toc-number">1.3.3.3.</span> <span class="toc-text">安装中文插件</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BF%AE%E6%94%B9-Jenkins-%E7%9A%84%E5%90%AF%E5%8A%A8%E7%94%A8%E6%88%B7%E4%B8%BA-root"><span class="toc-number">1.3.4.</span> <span class="toc-text">修改 Jenkins 的启动用户为 root</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BC%98%E5%8C%96%E9%85%8D%E7%BD%AE"><span class="toc-number">1.3.5.</span> <span class="toc-text">优化配置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Jenkins-%E7%9A%84%E5%A4%87%E4%BB%BD%E8%BF%98%E5%8E%9F"><span class="toc-number">1.3.6.</span> <span class="toc-text">Jenkins 的备份还原</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Jenkins-%E5%AE%9E%E7%8E%B0-CICD"><span class="toc-number">2.</span> <span class="toc-text">Jenkins 实现 CICD</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Jenkins-%E5%AE%9E%E7%8E%B0-CICD-%E8%AF%B4%E6%98%8E"><span class="toc-number">2.1.</span> <span class="toc-text">Jenkins 实现 CICD 说明</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA-Freestyle-%E9%A3%8E%E6%A0%BC%E7%9A%84%E4%BB%BB%E5%8A%A1-Job"><span class="toc-number">2.2.</span> <span class="toc-text">创建 Freestyle 风格的任务 Job</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Freestyle-%E9%A3%8E%E6%A0%BC%E4%BB%BB%E5%8A%A1%E8%AF%B4%E6%98%8E"><span class="toc-number">2.2.1.</span> <span class="toc-text">Freestyle 风格任务说明</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Freestyle-%E9%A3%8E%E6%A0%BC%E4%BB%BB%E5%8A%A1%E6%9E%84%E5%BB%BA%E6%B5%81%E7%A8%8B"><span class="toc-number">2.2.2.</span> <span class="toc-text">Freestyle 风格任务构建流程</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Jenkins-%E6%9E%84%E5%BB%BA%E7%9A%84%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8F"><span class="toc-number">2.2.3.</span> <span class="toc-text">Jenkins 构建的环境变量</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%A1%88%E4%BE%8B%EF%BC%9A-%E5%88%9B%E5%BB%BA%E7%AE%80%E5%8D%95%E7%9A%84-Freestyle-%E4%BB%BB%E5%8A%A1"><span class="toc-number">2.2.4.</span> <span class="toc-text">案例： 创建简单的 Freestyle 任务</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Jenkins-%E7%BB%93%E5%90%88-GitLab-%E5%AE%9E%E7%8E%B0%E4%BB%A3%E7%A0%81%E4%B8%8B%E8%BD%BD"><span class="toc-number">2.3.</span> <span class="toc-text">Jenkins 结合 GitLab 实现代码下载</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#GitLab-%E5%88%9B%E5%BB%BA%E9%A1%B9%E7%9B%AE"><span class="toc-number">2.3.1.</span> <span class="toc-text">GitLab 创建项目</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Jenkins-%E5%AE%89%E8%A3%85%E5%92%8C-Gitlab-%E7%9B%B8%E5%85%B3%E7%9A%84%E6%8F%92%E4%BB%B6"><span class="toc-number">2.3.2.</span> <span class="toc-text">Jenkins 安装和 Gitlab 相关的插件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Jenkins-%E6%9C%8D%E5%8A%A1%E5%99%A8%E5%88%9B%E5%BB%BA%E8%AE%BF%E9%97%AEGitLab%E7%9A%84%E5%87%AD%E6%8D%AE"><span class="toc-number">2.3.3.</span> <span class="toc-text">Jenkins 服务器创建访问GitLab的凭据</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%B7%BB%E5%8A%A0%E5%9F%BA%E4%BA%8E%E7%94%A8%E6%88%B7%E5%90%8D%E5%92%8C%E5%AF%86%E7%A0%81%E7%B1%BB%E5%9E%8B%E7%9A%84%E5%87%AD%E6%8D%AE"><span class="toc-number">2.3.3.1.</span> <span class="toc-text">添加基于用户名和密码类型的凭据</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E5%9F%BA%E4%BA%8E-ssh-key-%E7%9A%84%E5%87%AD%E6%8D%AE"><span class="toc-number">2.3.3.2.</span> <span class="toc-text">创建基于 ssh key 的凭据</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%9C%A8-Jenkins-%E6%9C%8D%E5%8A%A1%E5%99%A8%E4%B8%8A%E7%94%9F%E6%88%90-ssh-key"><span class="toc-number">2.3.3.2.1.</span> <span class="toc-text">在 Jenkins 服务器上生成 ssh key</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%9C%A8-Gitlab%E6%9C%8D%E5%8A%A1%E5%99%A8%E4%B8%8A%E7%94%A8%E6%88%B7%E4%B8%AD%E5%85%B3%E8%81%94-Jenkins-%E7%94%9F%E6%88%90%E7%9A%84ssh-%E5%85%AC%E9%92%A5key"><span class="toc-number">2.3.3.2.2.</span> <span class="toc-text">在 Gitlab服务器上用户中关联 Jenkins 生成的ssh 公钥key</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%9C%A8-Jenkins%E6%9C%8D%E5%8A%A1%E5%99%A8%E4%B8%8A%E6%B5%8B%E8%AF%95-ssh-key"><span class="toc-number">2.3.3.2.3.</span> <span class="toc-text">在 Jenkins服务器上测试 ssh key</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%9C%A8-Jenkins-%E6%B7%BB%E5%8A%A0%E7%94%A8%E6%88%B7%E5%90%8D%E5%92%8C-private-key-%E7%B1%BB%E5%9E%8B%E5%87%AD%E6%8D%AE"><span class="toc-number">2.3.3.2.4.</span> <span class="toc-text">在 Jenkins 添加用户名和 private key 类型凭据</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Jenkins-%E4%BB%BB%E5%8A%A1%E4%B8%AD%E4%BD%BF%E7%94%A8%E5%87%AD%E6%8D%AE"><span class="toc-number">2.3.4.</span> <span class="toc-text">Jenkins 任务中使用凭据</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA-Jenkins-%E4%BB%BB%E5%8A%A1"><span class="toc-number">2.3.4.1.</span> <span class="toc-text">创建 Jenkins 任务</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8%E5%87%AD%E6%8D%AE"><span class="toc-number">2.3.4.2.</span> <span class="toc-text">使用凭据</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8%E5%9F%BA%E4%BA%8E%E7%94%A8%E6%88%B7%E5%92%8C%E5%AF%86%E7%A0%81%E7%9A%84%E5%87%AD%E6%8D%AE"><span class="toc-number">2.3.4.2.1.</span> <span class="toc-text">使用基于用户和密码的凭据</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8%E5%9F%BA%E4%BA%8E-SSH-Key-%E7%9A%84%E5%87%AD%E6%8D%AE"><span class="toc-number">2.3.4.2.2.</span> <span class="toc-text">使用基于 SSH Key 的凭据</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%89%A7%E8%A1%8C%E4%BB%BB%E5%8A%A1%E9%AA%8C%E8%AF%81"><span class="toc-number">2.3.5.</span> <span class="toc-text">执行任务验证</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE-Jenkins-%E7%BB%93%E5%90%88-GitLab-%E5%AE%9E%E7%8E%B0%E8%87%AA%E5%8A%A8%E5%8C%96%E5%89%8D%E7%AB%AF%E9%A1%B9%E7%9B%AE%E7%9A%84%E9%83%A8%E7%BD%B2-%E5%92%8C%E5%9B%9E%E6%BB%9A"><span class="toc-number">2.4.</span> <span class="toc-text">配置 Jenkins 结合 GitLab 实现自动化前端项目的部署 和回滚</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Jenkins-%E5%88%9B%E5%BB%BA%E4%BB%BB%E5%8A%A1"><span class="toc-number">2.4.1.</span> <span class="toc-text">Jenkins 创建任务</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE-Git-%E9%A1%B9%E7%9B%AE%E5%9C%B0%E5%9D%80%E5%92%8C%E5%87%AD%E8%AF%81"><span class="toc-number">2.4.2.</span> <span class="toc-text">配置 Git 项目地址和凭证</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%87%86%E5%A4%87%E8%84%9A%E6%9C%AC%E5%B9%B6%E5%8A%A0%E5%85%A5%E6%9E%84%E5%BB%BA%E4%BB%BB%E5%8A%A1"><span class="toc-number">2.4.3.</span> <span class="toc-text">准备脚本并加入构建任务</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0%E9%83%A8%E7%BD%B2%E4%BB%BB%E5%8A%A1"><span class="toc-number">2.4.4.</span> <span class="toc-text">实现部署任务</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%9C%8D%E5%8A%A1%E5%99%A8%E9%AA%8C%E8%AF%81%E6%95%B0%E6%8D%AE"><span class="toc-number">2.4.4.1.</span> <span class="toc-text">服务器验证数据</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%B0%86%E4%BB%A3%E7%A0%81%E9%83%A8%E7%BD%B2%E8%87%B3%E5%90%8E%E7%AB%AF-Web-%E6%9C%8D%E5%8A%A1%E5%99%A8"><span class="toc-number">2.4.4.2.</span> <span class="toc-text">将代码部署至后端 Web 服务器</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%AE%BF%E9%97%AE-Web-%E6%9C%8D%E5%8A%A1"><span class="toc-number">2.4.4.3.</span> <span class="toc-text">访问 Web 服务</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BF%AE%E6%94%B9%E4%BB%A3%E7%A0%81%E5%86%8D%E4%B8%8A%E4%BC%A0%E9%87%8D%E6%96%B0%E6%9E%84%E5%BB%BA"><span class="toc-number">2.4.4.4.</span> <span class="toc-text">修改代码再上传重新构建</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0%E7%89%88%E6%9C%AC%E5%9B%9E%E6%BB%9A%E4%BB%BB%E5%8A%A1"><span class="toc-number">2.4.5.</span> <span class="toc-text">实现版本回滚任务</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8F%82%E6%95%B0%E5%8C%96%E6%9E%84%E5%BB%BA"><span class="toc-number">2.5.</span> <span class="toc-text">参数化构建</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8F%82%E6%95%B0%E7%B1%BB%E5%9E%8B%E8%AF%B4%E6%98%8E"><span class="toc-number">2.5.1.</span> <span class="toc-text">参数类型说明</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E5%8C%85%E5%90%AB%E5%90%84%E7%A7%8D%E7%B1%BB%E5%9E%8B%E5%8F%82%E6%95%B0%E7%9A%84%E4%BB%BB%E5%8A%A1"><span class="toc-number">2.5.1.1.</span> <span class="toc-text">创建包含各种类型参数的任务</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%9E%84%E5%BB%BA"><span class="toc-number">2.5.1.2.</span> <span class="toc-text">构建</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%89%A7%E8%A1%8C%E7%BB%93%E6%9E%9C"><span class="toc-number">2.5.1.3.</span> <span class="toc-text">执行结果</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AD%97%E7%AC%A6%E5%8F%82%E6%95%B0%E5%AE%9E%E7%8E%B0%E5%AE%9E%E7%8E%B0%E4%B8%8D%E5%90%8C%E5%88%86%E6%94%AF%E7%9A%84%E9%83%A8%E7%BD%B2"><span class="toc-number">2.5.2.</span> <span class="toc-text">字符参数实现实现不同分支的部署</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%80%89%E9%A1%B9%E5%8F%82%E6%95%B0%E5%AE%9E%E7%8E%B0%E5%AE%9E%E7%8E%B0%E4%B8%8D%E5%90%8C%E5%88%86%E6%94%AF%E7%9A%84%E9%83%A8%E7%BD%B2"><span class="toc-number">2.5.3.</span> <span class="toc-text">选项参数实现实现不同分支的部署</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%80%89%E9%A1%B9%E5%8F%82%E6%95%B0%E5%AE%9E%E7%8E%B0%E4%B8%8D%E5%90%8C%E5%88%86%E6%94%AF%E7%9A%84%E9%83%A8%E7%BD%B2%E5%92%8C%E5%9B%9E%E6%BB%9A"><span class="toc-number">2.5.4.</span> <span class="toc-text">选项参数实现不同分支的部署和回滚</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%A9%E7%94%A8-Git-Parameter-%E6%8F%92%E4%BB%B6%E5%AE%9E%E7%8E%B0%E6%8B%89%E5%8F%96%E6%8C%87%E5%AE%9A%E7%89%88%E6%9C%AC"><span class="toc-number">2.6.</span> <span class="toc-text">利用 Git Parameter 插件实现拉取指定版本</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%A9%E7%94%A8-Git-Parameter-%E6%8F%92%E4%BB%B6%E5%AE%9E%E7%8E%B0%E6%8B%89%E5%8F%96%E6%8C%87%E5%AE%9A-Tag"><span class="toc-number">2.6.1.</span> <span class="toc-text">利用 Git Parameter 插件实现拉取指定 Tag</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%89%E8%A3%85Git-Parameter-%E6%8F%92%E4%BB%B6"><span class="toc-number">2.6.1.1.</span> <span class="toc-text">安装Git Parameter 插件</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E4%BB%BB%E5%8A%A1"><span class="toc-number">2.6.1.2.</span> <span class="toc-text">创建任务</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%87%86%E5%A4%87Shell-%E8%84%9A%E6%9C%AC"><span class="toc-number">2.6.1.3.</span> <span class="toc-text">准备Shell 脚本</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%89%A7%E8%A1%8C%E6%9E%84%E5%BB%BA%E5%B9%B6%E9%AA%8C%E8%AF%81%E7%BB%93%E6%9E%9C"><span class="toc-number">2.6.1.4.</span> <span class="toc-text">执行构建并验证结果</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%A9%E7%94%A8-Git-Parameter-%E6%8F%92%E4%BB%B6%E5%AE%9E%E7%8E%B0%E6%8B%89%E5%8F%96%E6%8C%87%E5%AE%9A-Commit-ID"><span class="toc-number">2.6.2.</span> <span class="toc-text">利用 Git Parameter 插件实现拉取指定 Commit_ID</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%89%E8%A3%85Git-Parameter-%E6%8F%92%E4%BB%B6-1"><span class="toc-number">2.6.2.1.</span> <span class="toc-text">安装Git Parameter 插件</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E4%BB%BB%E5%8A%A1-1"><span class="toc-number">2.6.2.2.</span> <span class="toc-text">创建任务</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%89%A7%E8%A1%8C%E6%9E%84%E5%BB%BA"><span class="toc-number">2.6.2.3.</span> <span class="toc-text">执行构建</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%AA%8C%E8%AF%81%E7%BB%93%E6%9E%9C"><span class="toc-number">2.6.2.4.</span> <span class="toc-text">验证结果</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0-Java-%E5%BA%94%E7%94%A8%E6%BA%90%E7%A0%81%E7%BC%96%E8%AF%91%E5%B9%B6%E9%83%A8%E7%BD%B2"><span class="toc-number">2.7.</span> <span class="toc-text">实现 Java 应用源码编译并部署</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9E%84%E5%BB%BA%E5%9F%BA%E4%BA%8E-Spring-Boot-%E7%9A%84-JAR-%E5%8C%85-JAVA-%E9%A1%B9%E7%9B%AE"><span class="toc-number">2.7.1.</span> <span class="toc-text">构建基于 Spring Boot 的 JAR 包 JAVA 项目</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Gitlab-%E5%AF%BC%E5%85%A5%E9%A1%B9%E7%9B%AE"><span class="toc-number">2.7.1.1.</span> <span class="toc-text">Gitlab 导入项目</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Jenkins-%E6%9C%8D%E5%8A%A1%E5%99%A8%E4%B8%8A%E5%AE%89%E8%A3%85-maven-%E5%92%8C%E9%85%8D%E7%BD%AE%E9%95%9C%E5%83%8F%E5%8A%A0%E9%80%9F"><span class="toc-number">2.7.1.2.</span> <span class="toc-text">Jenkins 服务器上安装 maven 和配置镜像加速</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Jenkins-%E5%85%A8%E5%B1%80%E5%B7%A5%E5%85%B7%E9%85%8D%E7%BD%AE-JDK-%E5%92%8C-Maven"><span class="toc-number">2.7.1.3.</span> <span class="toc-text">Jenkins 全局工具配置 JDK 和 Maven</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%87%86%E5%A4%87%E7%9B%B8%E5%85%B3%E8%84%9A%E6%9C%AC"><span class="toc-number">2.7.1.4.</span> <span class="toc-text">准备相关脚本</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%9C%A8-Jenkins-%E5%88%9B%E5%BB%BA-Jenkins%E4%BB%BB%E5%8A%A1"><span class="toc-number">2.7.1.5.</span> <span class="toc-text">在 Jenkins 创建 Jenkins任务</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%9E%84%E5%BB%BA%E5%B9%B6%E6%A3%80%E6%9F%A5%E7%BB%93%E6%9E%9C"><span class="toc-number">2.7.1.6.</span> <span class="toc-text">构建并检查结果</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9E%84%E5%BB%BA%E5%9F%BA%E4%BA%8EWAR%E5%8C%85%E8%BF%90%E8%A1%8C-Tomcat%E6%9C%8D%E5%8A%A1%E5%99%A8-JAVA-%E9%A1%B9%E7%9B%AE"><span class="toc-number">2.7.2.</span> <span class="toc-text">构建基于WAR包运行 Tomcat服务器 JAVA 项目</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Gitlab%E4%BB%93%E5%BA%93%E4%B8%AD%E5%87%86%E5%A4%87-Java-%E4%BB%A3%E7%A0%81"><span class="toc-number">2.7.2.1.</span> <span class="toc-text">Gitlab仓库中准备 Java 代码</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%89%E8%A3%85-tomcat-%E6%9C%8D%E5%8A%A1%E5%99%A8%E5%92%8C%E9%85%8D%E7%BD%AE"><span class="toc-number">2.7.3.</span> <span class="toc-text">安装 tomcat 服务器和配置</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Jenkins-%E5%AE%89%E8%A3%85-Maven-%E5%92%8C-Tomcat-%E6%8F%92%E4%BB%B6"><span class="toc-number">2.7.3.1.</span> <span class="toc-text">Jenkins 安装 Maven 和 Tomcat 插件</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Jenkins-%E6%9C%8D%E5%8A%A1%E5%99%A8%E4%B8%8A%E5%AE%89%E8%A3%85-maven-%E5%92%8C%E9%85%8D%E7%BD%AE%E9%95%9C%E5%83%8F%E5%8A%A0%E9%80%9F-1"><span class="toc-number">2.7.3.2.</span> <span class="toc-text">Jenkins 服务器上安装 maven 和配置镜像加速</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Jenkins-%E5%85%A8%E5%B1%80%E5%B7%A5%E5%85%B7%E9%85%8D%E7%BD%AE-JDK-%E5%92%8C-Maven-1"><span class="toc-number">2.7.3.3.</span> <span class="toc-text">Jenkins 全局工具配置 JDK 和 Maven</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA-Tomcat-%E7%9A%84%E5%85%A8%E5%B1%80%E5%87%AD%E6%8D%AE"><span class="toc-number">2.7.3.4.</span> <span class="toc-text">创建 Tomcat 的全局凭据</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA-Maven-%E9%A3%8E%E6%A0%BC%E7%9A%84%E4%BB%BB%E5%8A%A1"><span class="toc-number">2.7.3.5.</span> <span class="toc-text">创建 Maven 风格的任务</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%9E%84%E5%BB%BA%E9%AA%8C%E8%AF%81"><span class="toc-number">2.7.3.6.</span> <span class="toc-text">构建验证</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0-Golang-%E5%BA%94%E7%94%A8%E6%BA%90%E7%A0%81%E7%BC%96%E8%AF%91%E5%B9%B6%E9%83%A8%E7%BD%B2"><span class="toc-number">2.8.</span> <span class="toc-text">实现 Golang 应用源码编译并部署</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%89%E8%A3%85-Golang-%E7%8E%AF%E5%A2%83"><span class="toc-number">2.8.1.</span> <span class="toc-text">安装 Golang 环境</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%87%86%E5%A4%87-Golang-%E6%BA%90%E4%BB%A3%E7%A0%81"><span class="toc-number">2.8.2.</span> <span class="toc-text">准备 Golang 源代码</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Gitlab-%E5%88%9B%E5%BB%BA%E9%A1%B9%E7%9B%AE"><span class="toc-number">2.8.3.</span> <span class="toc-text">Gitlab 创建项目</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B0%86%E6%BA%90%E7%A0%81%E4%B8%8A%E4%BC%A0%E5%88%B0-GitLab"><span class="toc-number">2.8.4.</span> <span class="toc-text">将源码上传到 GitLab</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%94%9F%E6%88%90ssh%E5%AF%86%E9%92%A5%E5%B9%B6%E4%B8%8A%E4%BC%A0%E5%88%B0GitLab"><span class="toc-number">2.8.4.1.</span> <span class="toc-text">生成ssh密钥并上传到GitLab</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%8A%E4%BC%A0%E4%BB%A3%E7%A0%81%E5%88%B0-GitLab"><span class="toc-number">2.8.4.2.</span> <span class="toc-text">上传代码到 GitLab</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BC%96%E5%86%99-Shell-%E8%84%9A%E6%9C%AC"><span class="toc-number">2.8.5.</span> <span class="toc-text">编写 Shell 脚本</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA-Jenkins-%E4%BB%BB%E5%8A%A1-1"><span class="toc-number">2.8.6.</span> <span class="toc-text">创建 Jenkins 任务</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%89%A7%E8%A1%8C%E4%BB%BB%E5%8A%A1"><span class="toc-number">2.8.7.</span> <span class="toc-text">执行任务</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%AA%8C%E8%AF%81%E6%9C%8D%E5%8A%A1"><span class="toc-number">2.8.8.</span> <span class="toc-text">验证服务</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%9B%86%E6%88%90-Ansible-%E7%9A%84%E4%BB%BB%E5%8A%A1%E6%9E%84%E5%BB%BA"><span class="toc-number">2.9.</span> <span class="toc-text">集成 Ansible 的任务构建</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%89%E8%A3%85-Ansible-%E7%8E%AF%E5%A2%83"><span class="toc-number">2.9.1.</span> <span class="toc-text">安装 Ansible 环境</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%89%E8%A3%85-Ansible-%E6%8F%92%E4%BB%B6"><span class="toc-number">2.9.2.</span> <span class="toc-text">安装 Ansible 插件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8-Ansible-Ad-Hoc-%E5%AE%9E%E7%8E%B0%E4%BB%BB%E5%8A%A1"><span class="toc-number">2.9.3.</span> <span class="toc-text">使用 Ansible Ad-Hoc 实现任务</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8-Ansible-Playbook-%E5%AE%9E%E7%8E%B0%E4%BB%BB%E5%8A%A1"><span class="toc-number">2.9.4.</span> <span class="toc-text">使用 Ansible Playbook 实现任务</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%87%86%E5%A4%87-Playbook%E6%96%87%E4%BB%B6"><span class="toc-number">2.9.4.1.</span> <span class="toc-text">准备 Playbook文件</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E4%BB%BB%E5%8A%A1-2"><span class="toc-number">2.9.4.2.</span> <span class="toc-text">创建任务</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8-Ansible-Playbook-%E5%AE%9E%E7%8E%B0%E5%8F%82%E6%95%B0%E5%8C%96%E4%BB%BB%E5%8A%A1"><span class="toc-number">2.9.5.</span> <span class="toc-text">使用 Ansible Playbook 实现参数化任务</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%87%86%E5%A4%87Playbook%E6%96%87%E4%BB%B6"><span class="toc-number">2.9.5.1.</span> <span class="toc-text">准备Playbook文件</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%87%86%E5%A4%87%E4%B8%A4%E4%B8%AA%E4%B8%BB%E6%9C%BA%E6%B8%85%E5%8D%95%E6%96%87%E4%BB%B6"><span class="toc-number">2.9.5.2.</span> <span class="toc-text">准备两个主机清单文件</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E5%8F%82%E6%95%B0%E5%8C%96%E4%BB%BB%E5%8A%A1"><span class="toc-number">2.9.5.3.</span> <span class="toc-text">创建参数化任务</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%89%A7%E8%A1%8C%E4%BB%BB%E5%8A%A1-1"><span class="toc-number">2.9.5.4.</span> <span class="toc-text">执行任务</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8-Ansible-Playbook-%E5%AE%9E%E7%8E%B0%E5%90%91-Playbook-%E4%B8%AD%E4%BC%A0%E5%8F%82%E5%8A%9F%E8%83%BD"><span class="toc-number">2.9.6.</span> <span class="toc-text">使用 Ansible Playbook 实现向 Playbook 中传参功能</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%BC%96%E5%86%99Playbook%E6%96%87%E4%BB%B6"><span class="toc-number">2.9.6.1.</span> <span class="toc-text">编写Playbook文件</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E4%B8%BB%E6%9C%BA%E6%B8%85%E5%8D%95%E6%96%87%E4%BB%B6"><span class="toc-number">2.9.6.2.</span> <span class="toc-text">创建主机清单文件</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA-Ansible-Playbook-%E7%9A%84%E4%BB%BB%E5%8A%A1"><span class="toc-number">2.9.6.3.</span> <span class="toc-text">创建 Ansible Playbook 的任务</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%89%A7%E8%A1%8C%E6%9E%84%E5%BB%BA-1"><span class="toc-number">2.9.6.4.</span> <span class="toc-text">执行构建</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%9F%A5%E7%9C%8B%E7%BB%93%E6%9E%9C"><span class="toc-number">2.9.6.5.</span> <span class="toc-text">查看结果</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9E%84%E5%BB%BA%E5%90%8E%E9%80%9A%E7%9F%A5"><span class="toc-number">2.10.</span> <span class="toc-text">构建后通知</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%82%AE%E4%BB%B6%E9%80%9A%E7%9F%A5"><span class="toc-number">2.10.1.</span> <span class="toc-text">邮件通知</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%94%9F%E6%88%90%E9%82%AE%E7%AE%B1%E7%99%BB%E5%BD%95%E6%8E%88%E6%9D%83%E7%A0%81"><span class="toc-number">2.10.1.1.</span> <span class="toc-text">生成邮箱登录授权码</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%89%E8%A3%85-mailer-%E6%8F%92%E4%BB%B6"><span class="toc-number">2.10.1.2.</span> <span class="toc-text">安装 mailer 插件</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE-Jenkins%E7%AE%A1%E7%90%86%E5%91%98%E9%82%AE%E7%AE%B1"><span class="toc-number">2.10.1.3.</span> <span class="toc-text">配置 Jenkins管理员邮箱</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE%E5%8F%91%E9%80%81%E9%82%AE%E4%BB%B6%E7%9A%84%E9%82%AE%E4%BB%B6%E9%80%9A%E7%9F%A5"><span class="toc-number">2.10.1.4.</span> <span class="toc-text">配置发送邮件的邮件通知</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE%E4%BB%BB%E5%8A%A1%E7%9A%84%E6%9E%84%E5%BB%BA%E5%90%8E%E9%80%9A%E7%9F%A5"><span class="toc-number">2.10.1.5.</span> <span class="toc-text">配置任务的构建后通知</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%89%A7%E8%A1%8C%E4%BB%BB%E5%8A%A1%E9%AA%8C%E8%AF%81%E7%BB%93%E6%9E%9C"><span class="toc-number">2.10.1.6.</span> <span class="toc-text">执行任务验证结果</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%9C%A8-Pipeline-%E4%B8%AD%E4%B9%9F%E5%8F%AF%E4%BB%A5%E6%B7%BB%E5%8A%A0%E9%82%AE%E4%BB%B6%E9%80%9A%E7%9F%A5"><span class="toc-number">2.10.1.7.</span> <span class="toc-text">在 Pipeline 中也可以添加邮件通知</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%92%89%E9%92%89%E9%80%9A%E7%9F%A5"><span class="toc-number">2.10.2.</span> <span class="toc-text">钉钉通知</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%92%89%E9%92%89%E9%85%8D%E7%BD%AE%E7%BE%A4%E8%81%8A%E6%9C%BA%E5%99%A8%E4%BA%BA"><span class="toc-number">2.10.2.1.</span> <span class="toc-text">钉钉配置群聊机器人</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Jenkins-%E5%AE%89%E8%A3%85-DingTalk-%E6%8F%92%E4%BB%B6"><span class="toc-number">2.10.2.2.</span> <span class="toc-text">Jenkins 安装 DingTalk 插件</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Jenkins-%E7%B3%BB%E7%BB%9F%E9%85%8D%E7%BD%AE"><span class="toc-number">2.10.2.3.</span> <span class="toc-text">Jenkins 系统配置</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE%E4%BB%BB%E5%8A%A1%E5%AE%9E%E7%8E%B0%E9%92%89%E9%92%89%E9%80%9A%E7%9F%A5"><span class="toc-number">2.10.2.4.</span> <span class="toc-text">配置任务实现钉钉通知</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%89%A7%E8%A1%8C%E4%BB%BB%E5%8A%A1%E9%AA%8C%E8%AF%81%E9%92%89%E9%92%89%E9%80%9A%E7%9F%A5"><span class="toc-number">2.10.2.5.</span> <span class="toc-text">执行任务验证钉钉通知</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Pipeline-%E5%AE%9E%E7%8E%B0%E9%92%89%E9%92%89%E9%80%9A%E7%9F%A5"><span class="toc-number">2.10.2.6.</span> <span class="toc-text">Pipeline 实现钉钉通知</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%BE%AE%E4%BF%A1%E9%80%9A%E7%9F%A5"><span class="toc-number">2.10.3.</span> <span class="toc-text">微信通知</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%B3%A8%E5%86%8C%E4%BC%81%E4%B8%9A%E5%BE%AE%E4%BF%A1%E6%B7%BB%E5%8A%A0WebHook%E6%9C%BA%E5%99%A8"><span class="toc-number">2.10.3.1.</span> <span class="toc-text">注册企业微信添加WebHook机器</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Jenkins-%E5%AE%89%E8%A3%85-Qy-Wechat-Notification-%E6%8F%92%E4%BB%B6"><span class="toc-number">2.10.3.2.</span> <span class="toc-text">Jenkins 安装 Qy Wechat Notification 插件</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E8%87%AA%E7%94%B1%E9%A3%8E%E6%A0%BC%E4%BB%BB%E5%8A%A1"><span class="toc-number">2.10.3.3.</span> <span class="toc-text">创建自由风格任务</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%89%A7%E8%A1%8C%E4%BB%BB%E5%8A%A1-2"><span class="toc-number">2.10.3.4.</span> <span class="toc-text">执行任务</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%9B%E5%BB%BAPipeline%E7%9A%84%E4%BB%BB%E5%8A%A1"><span class="toc-number">2.10.3.5.</span> <span class="toc-text">创建Pipeline的任务</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%88%9B%E5%BB%BAPipeline%E7%9A%84%E4%BB%BB%E5%8A%A1%E6%88%90%E5%8A%9F%E6%89%A7%E8%A1%8C"><span class="toc-number">2.10.3.5.1.</span> <span class="toc-text">创建Pipeline的任务成功执行</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%88%9B%E5%BB%BAPipeline%E7%9A%84%E4%BB%BB%E5%8A%A1%E5%A4%B1%E8%B4%A5%E6%89%A7%E8%A1%8C"><span class="toc-number">2.10.3.5.2.</span> <span class="toc-text">创建Pipeline的任务失败执行</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%87%AA%E5%8A%A8%E5%8C%96%E6%9E%84%E5%BB%BA"><span class="toc-number">2.11.</span> <span class="toc-text">自动化构建</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9A%E6%97%B6%E5%92%8C-SCM-%E6%9E%84%E5%BB%BA"><span class="toc-number">2.11.1.</span> <span class="toc-text">定时和 SCM 构建</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9E%84%E5%BB%BA-Webhook-%E8%A7%A6%E5%8F%91%E5%99%A8"><span class="toc-number">2.11.2.</span> <span class="toc-text">构建 Webhook 触发器</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%A7%A6%E5%8F%91%E8%BF%9C%E7%A8%8B%E6%9E%84%E5%BB%BA"><span class="toc-number">2.11.2.1.</span> <span class="toc-text">触发远程构建</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#Jenkins%E9%85%8D%E7%BD%AE%E6%9E%84%E5%BB%BA-Webhook-%E8%A7%A6%E5%8F%91%E5%99%A8"><span class="toc-number">2.11.2.1.1.</span> <span class="toc-text">Jenkins配置构建 Webhook 触发器</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#Jenkins-%E9%85%8D%E7%BD%AE%E7%94%9F%E6%88%90%E7%94%A8%E6%88%B7%E7%9A%84-API-Token"><span class="toc-number">2.11.2.1.2.</span> <span class="toc-text">Jenkins 配置生成用户的 API Token</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#Jenkins-%E5%AE%89%E8%A3%85%E6%8F%92%E4%BB%B6-%E6%97%A7%E7%89%88%E9%85%8D%E7%BD%AE%EF%BC%8C%E6%96%B0%E7%89%88%E4%B8%8D%E9%9C%80%E8%A6%81"><span class="toc-number">2.11.2.1.3.</span> <span class="toc-text">Jenkins 安装插件(旧版配置，新版不需要)</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#Jenkins-%E4%BF%AE%E6%94%B9%E7%9B%B8%E5%85%B3%E9%85%8D%E7%BD%AE-%E6%97%A7%E7%89%88%E6%89%8D%E9%9C%80%E5%AE%89%E8%A3%85%EF%BC%8C%E6%96%B0%E7%89%88%E4%B8%8D%E9%9C%80%E8%A6%81"><span class="toc-number">2.11.2.1.4.</span> <span class="toc-text">Jenkins 修改相关配置(旧版才需安装，新版不需要)</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E5%85%B3%E9%97%AD%E8%A7%92%E8%89%B2%E6%8E%88%E6%9D%83%E7%AD%96%E7%95%A5"><span class="toc-number">2.11.2.1.4.1.</span> <span class="toc-text">关闭角色授权策略</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E4%BF%AE%E6%94%B9CSRF%E9%85%8D%E7%BD%AE"><span class="toc-number">2.11.2.1.4.2.</span> <span class="toc-text">修改CSRF配置</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#Gitlab%E9%85%8D%E7%BD%AE-Webhook"><span class="toc-number">2.11.2.1.5.</span> <span class="toc-text">Gitlab配置 Webhook</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#Gitlab%E9%85%8D%E7%BD%AE-Webhook-1"><span class="toc-number">2.11.2.1.5.1.</span> <span class="toc-text">Gitlab配置 Webhook</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#Gitlab-%E6%89%93%E5%BC%80%E5%A4%96%E5%8F%91%E8%AF%B7%E6%B1%82"><span class="toc-number">2.11.2.1.5.2.</span> <span class="toc-text">Gitlab 打开外发请求</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%B5%8B%E8%AF%95%E8%B0%83%E7%94%A8-webhook"><span class="toc-number">2.11.2.1.6.</span> <span class="toc-text">测试调用 webhook</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%8F%90%E4%BA%A4%E4%BB%A3%E7%A0%81%E8%87%AA%E5%8A%A8%E8%A7%A6%E5%8F%91-webhook%E6%89%A7%E8%A1%8C"><span class="toc-number">2.11.2.1.7.</span> <span class="toc-text">提交代码自动触发 webhook执行</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#GitLab-Webhook-URL"><span class="toc-number">2.11.2.2.</span> <span class="toc-text">GitLab Webhook URL</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#Jenkins-%E5%AE%89%E8%A3%85-GitLab-%E6%8F%92%E4%BB%B6"><span class="toc-number">2.11.2.2.1.</span> <span class="toc-text">Jenkins 安装 GitLab 插件</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#Jenkins-%E5%88%9B%E5%BB%BA%E5%92%8C%E9%85%8D%E7%BD%AE%E4%BB%BB%E5%8A%A1"><span class="toc-number">2.11.2.2.2.</span> <span class="toc-text">Jenkins 创建和配置任务</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE-Gitlab-Webhook"><span class="toc-number">2.11.2.2.3.</span> <span class="toc-text">配置 Gitlab Webhook</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE-Gitlab-%E6%89%93%E5%BC%80%E5%A4%96%E5%8F%91%E8%AF%B7%E6%B1%82"><span class="toc-number">2.11.2.2.4.</span> <span class="toc-text">配置 Gitlab 打开外发请求</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E9%AA%8C%E8%AF%81%E7%BB%93%E6%9E%9C-1"><span class="toc-number">2.11.2.2.5.</span> <span class="toc-text">验证结果</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9E%84%E5%BB%BA%E5%89%8D%E5%90%8E%E5%A4%9A%E4%B8%AA%E9%A1%B9%E7%9B%AE%E5%85%B3%E8%81%94%E8%87%AA%E5%8A%A8%E8%A7%A6%E5%8F%91%E4%BB%BB%E5%8A%A1%E6%89%A7%E8%A1%8C"><span class="toc-number">2.12.</span> <span class="toc-text">构建前后多个项目关联自动触发任务执行</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9C%A8%E5%89%8D%E9%9D%A2%E4%BB%BB%E5%8A%A1%E9%87%8C%E9%85%8D%E7%BD%AE%E6%9E%84%E5%BB%BA%E5%90%8E%E6%93%8D%E4%BD%9C"><span class="toc-number">2.12.1.</span> <span class="toc-text">在前面任务里配置构建后操作</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E6%9E%84%E5%BB%BA%E5%90%8E%E6%93%8D%E4%BD%9C"><span class="toc-number">2.12.1.1.</span> <span class="toc-text">创建构建后操作</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E5%90%8E%E9%9D%A2%E7%9A%84%E4%BB%BB%E5%8A%A1"><span class="toc-number">2.12.1.2.</span> <span class="toc-text">创建后面的任务</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%AA%8C%E8%AF%81%E6%9E%84%E5%BB%BA%E5%90%8E%E6%93%8D%E4%BD%9C"><span class="toc-number">2.12.1.3.</span> <span class="toc-text">验证构建后操作</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9C%A8%E5%90%8E%E9%9D%A2%E6%9E%84%E5%BB%BA%E7%9A%84%E4%BB%BB%E5%8A%A1%E9%87%8C%E5%88%9B%E5%BB%BA"><span class="toc-number">2.12.2.</span> <span class="toc-text">在后面构建的任务里创建</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%9C%A8%E5%90%8E%E7%BB%AD%E6%9E%84%E5%BB%BA%E7%9A%84%E4%BB%BB%E5%8A%A1%E9%87%8C%E5%88%A9%E7%94%A8%E6%9E%84%E5%BB%BA%E8%A7%A6%E5%8F%91%E5%99%A8%E5%AE%9E%E7%8E%B0"><span class="toc-number">2.12.2.1.</span> <span class="toc-text">在后续构建的任务里利用构建触发器实现</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%AA%8C%E8%AF%81%E7%BB%93%E6%9E%9C-2"><span class="toc-number">2.12.2.2.</span> <span class="toc-text">验证结果</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Blue-Ocean-%E6%8F%92%E4%BB%B6%E5%AE%9E%E7%8E%B0%E5%8F%AF%E8%A7%86%E5%8C%96"><span class="toc-number">2.13.</span> <span class="toc-text">Blue Ocean 插件实现可视化</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%89%E8%A3%85-Blue-Ocean-%E6%8F%92%E4%BB%B6"><span class="toc-number">2.13.1.</span> <span class="toc-text">安装 Blue Ocean 插件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8-Blue-Ocean"><span class="toc-number">2.13.2.</span> <span class="toc-text">使用 Blue Ocean</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Jenkins-%E7%9A%84%E9%AB%98%E7%BA%A7%E5%8A%9F%E8%83%BD"><span class="toc-number">3.</span> <span class="toc-text">Jenkins 的高级功能</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Jenkins-%E5%88%86%E5%B8%83%E5%BC%8F"><span class="toc-number">3.1.</span> <span class="toc-text">Jenkins 分布式</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Jenkins-%E5%88%86%E5%B8%83%E5%BC%8F%E8%AF%B4%E6%98%8E"><span class="toc-number">3.1.1.</span> <span class="toc-text">Jenkins 分布式说明</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Jenkins-%E5%88%86%E5%B8%83%E5%BC%8F%E7%9B%B8%E5%85%B3%E6%A6%82%E5%BF%B5"><span class="toc-number">3.1.1.1.</span> <span class="toc-text">Jenkins 分布式相关概念</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Jenkins-%E4%B8%BB%E4%BB%8E%E6%9E%B6%E6%9E%84%E5%9B%BE"><span class="toc-number">3.1.1.2.</span> <span class="toc-text">Jenkins 主从架构图</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%8A%82%E7%82%B9%E6%A0%87%E7%AD%BE"><span class="toc-number">3.1.1.3.</span> <span class="toc-text">节点标签</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Jenkins-%E4%B8%8E-Agent%E4%B9%8B%E9%97%B4%E7%9A%84%E9%80%9A%E4%BF%A1%E6%96%B9%E5%BC%8F"><span class="toc-number">3.1.1.4.</span> <span class="toc-text">Jenkins 与 Agent之间的通信方式</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BB%A5Docker-%E6%96%B9%E5%BC%8F%E8%BF%90%E8%A1%8C-Agent"><span class="toc-number">3.1.1.5.</span> <span class="toc-text">以Docker 方式运行 Agent</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9E%E6%88%98%E6%A1%88%E4%BE%8B-%E5%AE%9E%E7%8E%B0-Jenkins-%E5%88%86%E5%B8%83%E5%BC%8F"><span class="toc-number">3.1.2.</span> <span class="toc-text">实战案例: 实现 Jenkins 分布式</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Slave-%E8%8A%82%E7%82%B9%E5%AE%89%E8%A3%85-Java-%E7%AD%89%E7%8E%AF%E5%A2%83%E7%A1%AE%E4%BF%9D%E5%92%8C-Master-%E7%8E%AF%E5%A2%83%E4%B8%80%E8%87%B4"><span class="toc-number">3.1.2.1.</span> <span class="toc-text">Slave 节点安装 Java 等环境确保和 Master 环境一致</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Master-%E8%8A%82%E7%82%B9%E5%AE%89%E8%A3%85%E6%8F%92%E4%BB%B6"><span class="toc-number">3.1.2.2.</span> <span class="toc-text">Master 节点安装插件</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%B7%BB%E5%8A%A0-Master-%E8%AE%BF%E9%97%AE-Slave-%E8%AE%A4%E8%AF%81%E5%87%AD%E6%8D%AE"><span class="toc-number">3.1.2.3.</span> <span class="toc-text">添加 Master 访问 Slave 认证凭据</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%B7%BB%E5%8A%A0-Slave-%E8%8A%82%E7%82%B9"><span class="toc-number">3.1.2.4.</span> <span class="toc-text">添加 Slave 节点</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%9F%A5%E7%9C%8B-Jenkins-Slave-%E5%88%9B%E5%BB%BA%E6%97%A5%E5%BF%97"><span class="toc-number">3.1.2.5.</span> <span class="toc-text">查看 Jenkins Slave 创建日志</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%95%85%E9%9A%9C%E6%8E%92%E9%94%99"><span class="toc-number">3.1.2.6.</span> <span class="toc-text">故障排错</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%AA%8C%E8%AF%81-Slave-Web-%E7%8A%B6%E6%80%81"><span class="toc-number">3.1.2.7.</span> <span class="toc-text">验证 Slave Web 状态</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%AA%8C%E8%AF%81-Slave-%E8%BF%9B%E7%A8%8B%E7%8A%B6%E6%80%81"><span class="toc-number">3.1.2.8.</span> <span class="toc-text">验证 Slave 进程状态</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%BB%BA%E7%AB%8B%E5%90%8E%E7%BB%AD%E7%9A%84%E5%85%B6%E5%AE%83%E8%8A%82%E7%82%B9"><span class="toc-number">3.1.2.9.</span> <span class="toc-text">建立后续的其它节点</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%8C%87%E5%AE%9A%E4%BB%BB%E5%8A%A1%E8%BF%90%E8%A1%8C%E7%9A%84%E8%8A%82%E7%82%B9"><span class="toc-number">3.1.2.10.</span> <span class="toc-text">指定任务运行的节点</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Jenkins-Pipeline"><span class="toc-number">3.2.</span> <span class="toc-text">Jenkins Pipeline</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Pipeline-%E4%BB%8B%E7%BB%8D"><span class="toc-number">3.2.1.</span> <span class="toc-text">Pipeline 介绍</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Pipeline-%E4%BC%98%E5%8A%BF"><span class="toc-number">3.2.2.</span> <span class="toc-text">Pipeline 优势</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Pipeline-%E8%AF%AD%E6%B3%95"><span class="toc-number">3.2.3.</span> <span class="toc-text">Pipeline 语法</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Pipeline-%E8%AF%AD%E6%B3%95%E4%BB%8B%E7%BB%8D%E5%92%8C%E7%BB%93%E6%9E%84"><span class="toc-number">3.2.3.1.</span> <span class="toc-text">Pipeline 语法介绍和结构</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%84%9A%E6%9C%AC%E5%BC%8F%E6%B5%81%E6%B0%B4%E7%BA%BF%E8%AF%AD%E6%B3%95"><span class="toc-number">3.2.3.2.</span> <span class="toc-text">脚本式流水线语法</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%A3%B0%E6%98%8E%E5%BC%8F%E6%B5%81%E6%B0%B4%E7%BA%BF%E8%AF%AD%E6%B3%95"><span class="toc-number">3.2.3.3.</span> <span class="toc-text">声明式流水线语法</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%9F%BA%E6%9C%AC%E6%A1%88%E4%BE%8B"><span class="toc-number">3.2.3.4.</span> <span class="toc-text">基本案例</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0%E4%B8%80%E4%B8%AA%E7%AE%80%E5%8D%95-Pipeline-Job"><span class="toc-number">3.2.4.</span> <span class="toc-text">实现一个简单 Pipeline Job</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%89%E8%A3%85-Pipeline-%E6%8F%92%E4%BB%B6"><span class="toc-number">3.2.4.1.</span> <span class="toc-text">安装 Pipeline 插件</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA-Pipeline-Job"><span class="toc-number">3.2.4.2.</span> <span class="toc-text">创建 Pipeline Job</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%B5%8B%E8%AF%95%E7%AE%80%E5%8D%95-Pipeline-Job-%E8%BF%90%E8%A1%8C"><span class="toc-number">3.2.4.3.</span> <span class="toc-text">测试简单 Pipeline Job 运行</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%89%A7%E8%A1%8C-Pipeline-Job"><span class="toc-number">3.2.4.4.</span> <span class="toc-text">执行 Pipeline Job</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%87%AA%E5%8A%A8%E7%94%9F%E6%88%90%E6%8B%89%E5%8F%96%E4%BB%A3%E7%A0%81%E7%9A%84-Pipeline-%E8%84%9A%E6%9C%AC"><span class="toc-number">3.2.4.5.</span> <span class="toc-text">自动生成拉取代码的 Pipeline 脚本</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%9B%B4%E6%94%B9-Pipeline-%E4%BB%BB%E5%8A%A1"><span class="toc-number">3.2.4.6.</span> <span class="toc-text">更改 Pipeline 任务</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%89%A7%E8%A1%8C-Jenkins-Pipeline-%E4%BB%BB%E5%8A%A1"><span class="toc-number">3.2.4.7.</span> <span class="toc-text">执行 Jenkins Pipeline 任务</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%AA%8C%E8%AF%81%E7%BB%93%E6%9E%9C-3"><span class="toc-number">3.2.4.8.</span> <span class="toc-text">验证结果</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%B5%81%E6%B0%B4%E7%BA%BF%E6%AD%A5%E9%AA%A4"><span class="toc-number">3.2.4.9.</span> <span class="toc-text">流水线步骤</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%9B%9E%E6%94%BE-Replay"><span class="toc-number">3.2.4.10.</span> <span class="toc-text">回放 Replay</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BB%8E%E6%8C%87%E5%AE%9A%E9%98%B6%E6%AE%B5%E9%87%8D%E6%96%B0%E8%BF%90%E8%A1%8C"><span class="toc-number">3.2.4.11.</span> <span class="toc-text">从指定阶段重新运行</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9E%E6%88%98%E6%A1%88%E4%BE%8B-%E5%A3%B0%E6%98%8E%E5%BC%8F-Pipeline"><span class="toc-number">3.2.5.</span> <span class="toc-text">实战案例: 声明式 Pipeline</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%A1%88%E4%BE%8B%EF%BC%9A%E5%9F%BA%E6%9C%AC%E8%AF%AD%E6%B3%95"><span class="toc-number">3.2.5.1.</span> <span class="toc-text">案例：基本语法</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%A1%88%E4%BE%8B%EF%BC%9AMaven-%E7%BC%96%E8%AF%91-Java-%E9%A1%B9%E7%9B%AE"><span class="toc-number">3.2.5.2.</span> <span class="toc-text">案例：Maven 编译 Java 项目</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%A1%88%E4%BE%8B%EF%BC%9A%E5%8F%98%E9%87%8F"><span class="toc-number">3.2.5.3.</span> <span class="toc-text">案例：变量</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%A1%88%E4%BE%8B%EF%BC%9A%E4%BD%BF%E7%94%A8%E5%87%AD%E6%8D%AE-Credential"><span class="toc-number">3.2.5.4.</span> <span class="toc-text">案例：使用凭据 Credential</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%A1%88%E4%BE%8B%EF%BC%9A%E5%8F%82%E6%95%B0%E9%80%89%E9%A1%B9%E5%92%8C%E5%AF%86%E7%A0%81"><span class="toc-number">3.2.5.5.</span> <span class="toc-text">案例：参数选项和密码</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%A1%88%E4%BE%8B%EF%BC%9A%E6%9D%A1%E4%BB%B6%E5%88%A4%E6%96%AD"><span class="toc-number">3.2.5.6.</span> <span class="toc-text">案例：条件判断</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%A1%88%E4%BE%8B%EF%BC%9AJava-%E5%BA%94%E7%94%A8%E9%83%A8%E7%BD%B2"><span class="toc-number">3.2.5.7.</span> <span class="toc-text">案例：Java 应用部署</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%A1%88%E4%BE%8B%EF%BC%9A%E5%B9%B6%E8%A1%8C"><span class="toc-number">3.2.5.8.</span> <span class="toc-text">案例：并行</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%A1%88%E4%BE%8B%EF%BC%9A%E6%9E%84%E5%BB%BA%E5%90%8E%E6%93%8D%E4%BD%9C"><span class="toc-number">3.2.5.9.</span> <span class="toc-text">案例：构建后操作</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Jenkins-%E8%A7%86%E5%9B%BE"><span class="toc-number">3.3.</span> <span class="toc-text">Jenkins 视图</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%97%E8%A1%A8%E8%A7%86%E5%9B%BE"><span class="toc-number">3.3.1.</span> <span class="toc-text">列表视图</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E6%96%B0%E7%9A%84%E8%A7%86%E5%9B%BE"><span class="toc-number">3.3.1.1.</span> <span class="toc-text">创建新的视图</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%9A%E4%B9%89%E8%A7%86%E5%9B%BE%E5%90%8D%E7%A7%B0"><span class="toc-number">3.3.1.2.</span> <span class="toc-text">定义视图名称</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%80%89%E6%8B%A9%E8%A7%86%E5%9B%BE%E5%8C%85%E5%90%AB%E7%9A%84%E4%BB%BB%E5%8A%A1"><span class="toc-number">3.3.1.3.</span> <span class="toc-text">选择视图包含的任务</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%9C%80%E7%BB%88%E7%8A%B6%E6%80%81"><span class="toc-number">3.3.1.4.</span> <span class="toc-text">最终状态</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%88%91%E7%9A%84%E8%A7%86%E5%9B%BE"><span class="toc-number">3.3.2.</span> <span class="toc-text">我的视图</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E6%88%91%E7%9A%84%E8%A7%86%E5%9B%BE"><span class="toc-number">3.3.2.1.</span> <span class="toc-text">创建我的视图</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%9C%80%E7%BB%88%E7%8A%B6%E6%80%81-1"><span class="toc-number">3.3.2.2.</span> <span class="toc-text">最终状态</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Pipeline-%E8%A7%86%E5%9B%BE"><span class="toc-number">3.3.3.</span> <span class="toc-text">Pipeline 视图</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%89%E8%A3%85-build-pipeline-%E6%8F%92%E4%BB%B6"><span class="toc-number">3.3.3.1.</span> <span class="toc-text">安装 build pipeline 插件</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E8%A7%86%E5%9B%BE"><span class="toc-number">3.3.3.2.</span> <span class="toc-text">创建视图</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%9A%E4%B9%89%E8%A7%86%E5%9B%BE%E9%85%8D%E7%BD%AE%E4%BF%A1%E6%81%AF"><span class="toc-number">3.3.3.3.</span> <span class="toc-text">定义视图配置信息</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Web-%E6%98%BE%E7%A4%BA%E7%95%8C%E9%9D%A2"><span class="toc-number">3.3.3.4.</span> <span class="toc-text">Web 显示界面</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Jenkins-%E6%9D%83%E9%99%90%E7%AE%A1%E7%90%86"><span class="toc-number">3.4.</span> <span class="toc-text">Jenkins 权限管理</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E6%96%B0%E7%94%A8%E6%88%B7"><span class="toc-number">3.4.1.</span> <span class="toc-text">创建新用户</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%89%E8%A3%85%E8%A7%92%E8%89%B2%E6%9D%83%E9%99%90%E7%9B%B8%E5%85%B3%E7%9A%84%E6%8F%92%E4%BB%B6"><span class="toc-number">3.4.2.</span> <span class="toc-text">安装角色权限相关的插件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9B%B4%E6%94%B9%E8%AE%A4%E8%AF%81%E6%96%B9%E5%BC%8F"><span class="toc-number">3.4.3.</span> <span class="toc-text">更改认证方式</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E5%85%A8%E5%B1%80%E8%A7%92%E8%89%B2"><span class="toc-number">3.4.4.</span> <span class="toc-text">创建全局角色</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AF%B9%E5%85%A8%E5%B1%80%E8%A7%92%E8%89%B2%E5%88%86%E9%85%8D%E6%9D%83%E9%99%90"><span class="toc-number">3.4.5.</span> <span class="toc-text">对全局角色分配权限</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B0%86%E7%94%A8%E6%88%B7%E5%85%B3%E8%81%94%E5%88%B0%E5%85%A8%E5%B1%80%E8%A7%92%E8%89%B2"><span class="toc-number">3.4.6.</span> <span class="toc-text">将用户关联到全局角色</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B5%8B%E8%AF%95%E6%99%AE%E9%80%9A%E7%94%A8%E6%88%B7%E7%99%BB%E5%BD%95"><span class="toc-number">3.4.7.</span> <span class="toc-text">测试普通用户登录</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E9%A1%B9%E7%9B%AE%E8%A7%92%E8%89%B2"><span class="toc-number">3.4.8.</span> <span class="toc-text">创建项目角色</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AF%B9%E9%A1%B9%E7%9B%AE%E8%A7%92%E8%89%B2%E5%88%86%E9%85%8D%E6%9D%83%E9%99%90"><span class="toc-number">3.4.9.</span> <span class="toc-text">对项目角色分配权限</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B0%86%E7%94%A8%E6%88%B7%E5%85%B3%E8%81%94%E5%88%B0%E9%A1%B9%E7%9B%AE%E8%A7%92%E8%89%B2"><span class="toc-number">3.4.10.</span> <span class="toc-text">将用户关联到项目角色</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%94%A8%E6%88%B7%E7%99%BB%E5%BD%95%E9%AA%8C%E8%AF%81%E7%BB%93%E6%9E%9C"><span class="toc-number">3.4.11.</span> <span class="toc-text">用户登录验证结果</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%BB%A3%E7%A0%81%E8%B4%A8%E9%87%8F%E6%A3%80%E6%B5%8B-SonarQube"><span class="toc-number">4.</span> <span class="toc-text">代码质量检测 SonarQube</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BB%A3%E7%A0%81%E8%B4%A8%E9%87%8F%E6%A3%80%E6%B5%8B%E5%B7%A5%E5%85%B7-SonarQube"><span class="toc-number">4.1.</span> <span class="toc-text">代码质量检测工具 SonarQube</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BB%A3%E7%A0%81%E6%B5%8B%E8%AF%95%E5%B7%A5%E5%85%B7-SonarQube-%E7%AE%80%E4%BB%8B"><span class="toc-number">4.1.1.</span> <span class="toc-text">代码测试工具 SonarQube 简介</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%83%E4%B8%AA%E7%BB%B4%E5%BA%A6%E6%A3%80%E6%B5%8B%E4%BB%A3%E7%A0%81%E8%B4%A8%E9%87%8F"><span class="toc-number">4.1.2.</span> <span class="toc-text">七个维度检测代码质量</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9E%B6%E6%9E%84%E5%92%8C%E9%9B%86%E6%88%90"><span class="toc-number">4.1.3.</span> <span class="toc-text">架构和集成</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#SonarQube-%E6%9E%B6%E6%9E%84"><span class="toc-number">4.1.3.1.</span> <span class="toc-text">SonarQube 架构</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#SonarQube-%E7%94%9F%E6%80%81%E9%9B%86%E6%88%90"><span class="toc-number">4.1.3.2.</span> <span class="toc-text">SonarQube 生态集成</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#SonarQube-%E7%89%88%E6%9C%AC%E8%AF%B4%E6%98%8E"><span class="toc-number">4.1.4.</span> <span class="toc-text">SonarQube 版本说明</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%89%E8%A3%85%E7%8E%AF%E5%A2%83%E5%87%86%E5%A4%87"><span class="toc-number">4.2.</span> <span class="toc-text">安装环境准备</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%A1%AC%E4%BB%B6%E8%A6%81%E6%B1%82"><span class="toc-number">4.2.1.</span> <span class="toc-text">硬件要求</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%B3%BB%E7%BB%9F%E5%86%85%E6%A0%B8%E4%BC%98%E5%8C%96"><span class="toc-number">4.2.2.</span> <span class="toc-text">系统内核优化</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%95%B0%E6%8D%AE%E5%BA%93%E7%8E%AF%E5%A2%83%E4%BE%9D%E8%B5%96%E8%AF%B4%E6%98%8E"><span class="toc-number">4.2.3.</span> <span class="toc-text">数据库环境依赖说明</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#SonarQube-7-9-%E4%BB%A5%E4%B8%8A%E7%89%88%E6%9C%AC%E7%9A%84%E6%95%B0%E6%8D%AE%E5%BA%93%E8%A6%81%E6%B1%82"><span class="toc-number">4.2.3.1.</span> <span class="toc-text">SonarQube 7.9 以上版本的数据库要求</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#SonarQube-6-7-%E7%9A%84%E6%95%B0%E6%8D%AE%E5%BA%93%E8%A6%81%E6%B1%82"><span class="toc-number">4.2.3.2.</span> <span class="toc-text">SonarQube 6.7 的数据库要求</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Java-%E7%8E%AF%E5%A2%83%E4%BE%9D%E8%B5%96%E8%AF%B4%E6%98%8E"><span class="toc-number">4.2.4.</span> <span class="toc-text">Java 环境依赖说明</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#SonarQube-9-9-%E4%BB%A5%E4%B8%8A%E7%89%88%E6%9C%AC%E7%9A%84-java-%E7%8E%AF%E5%A2%83%E8%A6%81%E6%B1%82"><span class="toc-number">4.2.4.1.</span> <span class="toc-text">SonarQube 9.9 以上版本的 java 环境要求</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#SonarQube-7-9-%E4%BB%A5%E4%B8%8A%E7%89%88%E6%9C%AC%E7%9A%84-java-%E7%8E%AF%E5%A2%83%E8%A6%81%E6%B1%82"><span class="toc-number">4.2.4.2.</span> <span class="toc-text">SonarQube 7.9 以上版本的 java 环境要求</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#SonarQube-6-7-%E7%9A%84-Java-%E7%8E%AF%E5%A2%83%E8%A6%81%E6%B1%82"><span class="toc-number">4.2.4.3.</span> <span class="toc-text">SonarQube 6.7 的 Java 环境要求</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%9B%E5%BB%BASonarQube%E7%94%A8%E6%88%B7"><span class="toc-number">4.2.5.</span> <span class="toc-text">创建SonarQube用户</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%89%E8%A3%85-SonarQube-%E6%9C%8D%E5%8A%A1%E5%99%A8"><span class="toc-number">4.3.</span> <span class="toc-text">安装 SonarQube 服务器</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%95%B0%E6%8D%AE%E5%BA%93%E5%87%86%E5%A4%87"><span class="toc-number">4.3.1.</span> <span class="toc-text">数据库准备</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%89%E8%A3%85%E5%92%8C%E9%85%8D%E7%BD%AE-PostgreSQL-%E6%95%B0%E6%8D%AE%E5%BA%93"><span class="toc-number">4.3.1.1.</span> <span class="toc-text">安装和配置 PostgreSQL 数据库</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%AE%89%E8%A3%85%E5%92%8C%E9%85%8D%E7%BD%AE-PostgreSQL"><span class="toc-number">4.3.1.1.1.</span> <span class="toc-text">安装和配置 PostgreSQL</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E6%95%B0%E6%8D%AE%E5%BA%93%E5%92%8C%E7%94%A8%E6%88%B7%E6%8E%88%E6%9D%83"><span class="toc-number">4.3.1.1.2.</span> <span class="toc-text">创建数据库和用户授权</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%8B%E8%BD%BD-SonarQube-%E5%92%8C%E4%BF%AE%E6%94%B9%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6"><span class="toc-number">4.3.2.</span> <span class="toc-text">下载 SonarQube 和修改配置文件</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%8B%E8%BD%BD%E8%A7%A3%E5%8E%8B%E7%BC%A9"><span class="toc-number">4.3.2.1.</span> <span class="toc-text">下载解压缩</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%AE%BE%E7%BD%AE-SonarQube-%E8%BF%9E%E6%8E%A5%E6%95%B0%E6%8D%AE%E5%BA%93"><span class="toc-number">4.3.2.2.</span> <span class="toc-text">设置 SonarQube 连接数据库</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%90%AF%E5%8A%A8-SonarQube"><span class="toc-number">4.3.3.</span> <span class="toc-text">启动 SonarQube</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA-service-%E6%96%87%E4%BB%B6"><span class="toc-number">4.3.4.</span> <span class="toc-text">创建 service 文件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%99%BB%E5%BD%95%E5%88%B0-Web-%E7%95%8C%E9%9D%A2"><span class="toc-number">4.3.5.</span> <span class="toc-text">登录到 Web 界面</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AE%A1%E7%90%86-SonarQube-%E6%9C%8D%E5%8A%A1%E5%99%A8"><span class="toc-number">4.4.</span> <span class="toc-text">管理 SonarQube 服务器</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%89%E8%A3%85%E4%B8%AD%E6%96%87%E6%94%AF%E6%8C%81"><span class="toc-number">4.4.1.</span> <span class="toc-text">安装中文支持</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%9F%A5%E7%9C%8B%E6%9C%AC%E5%9C%B0%E5%B7%B2%E5%AE%89%E8%A3%85%E6%8F%92%E4%BB%B6"><span class="toc-number">4.4.1.1.</span> <span class="toc-text">查看本地已安装插件</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%89%E8%A3%85%E4%B8%AD%E6%96%87%E8%AF%AD%E8%A8%80%E6%8F%92%E4%BB%B6"><span class="toc-number">4.4.1.2.</span> <span class="toc-text">安装中文语言插件</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%AA%8C%E8%AF%81%E4%B8%AD%E6%96%87%E7%95%8C%E9%9D%A2"><span class="toc-number">4.4.1.3.</span> <span class="toc-text">验证中文界面</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%89%E8%A3%85%E5%85%B6%E4%BB%96%E6%8F%92%E4%BB%B6"><span class="toc-number">4.4.2.</span> <span class="toc-text">安装其他插件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9D%83%E9%99%90%E7%AE%A1%E7%90%86"><span class="toc-number">4.4.3.</span> <span class="toc-text">权限管理</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%85%81%E8%AE%B8%E5%8C%BF%E5%90%8D%E8%AE%BF%E9%97%AE"><span class="toc-number">4.4.3.1.</span> <span class="toc-text">允许匿名访问</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%8D%E5%85%81%E8%AE%B8%E5%8C%BF%E5%90%8D%E8%AE%BF%E9%97%AE"><span class="toc-number">4.4.3.2.</span> <span class="toc-text">不允许匿名访问</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Jenkins-%E6%9C%8D%E5%8A%A1%E5%99%A8%E9%83%A8%E7%BD%B2%E6%89%AB%E6%8F%8F%E5%99%A8-sonar-scanner"><span class="toc-number">4.5.</span> <span class="toc-text">Jenkins 服务器部署扫描器 sonar-scanner</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%83%A8%E7%BD%B2%E5%92%8C%E9%85%8D%E7%BD%AE-sonar-scanner"><span class="toc-number">4.5.1.</span> <span class="toc-text">部署和配置 sonar-scanner</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%87%86%E5%A4%87%E6%B5%8B%E8%AF%95%E4%BB%A3%E7%A0%81"><span class="toc-number">4.5.2.</span> <span class="toc-text">准备测试代码</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9C%A8%E6%BA%90%E4%BB%A3%E7%A0%81%E7%9B%AE%E5%BD%95%E6%89%A7%E8%A1%8C%E6%89%AB%E6%8F%8F"><span class="toc-number">4.5.3.</span> <span class="toc-text">在源代码目录执行扫描</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#SonarQube-Web-%E7%95%8C%E9%9D%A2%E9%AA%8C%E8%AF%81%E6%89%AB%E6%8F%8F%E7%BB%93%E6%9E%9C"><span class="toc-number">4.5.4.</span> <span class="toc-text">SonarQube Web 界面验证扫描结果</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Jenkins-%E5%92%8C-SonarQube-%E9%9B%86%E6%88%90%E5%AE%9E%E7%8E%B0%E4%BB%A3%E7%A0%81%E6%89%AB%E6%8F%8F"><span class="toc-number">4.6.</span> <span class="toc-text">Jenkins 和 SonarQube 集成实现代码扫描</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Jenkins-%E5%92%8C-SonarQube-%E9%9B%86%E6%88%90%E8%AF%B4%E6%98%8E"><span class="toc-number">4.6.1.</span> <span class="toc-text">Jenkins 和 SonarQube 集成说明</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#SonarQube-%E8%B4%A8%E9%87%8F%E9%98%88"><span class="toc-number">4.6.2.</span> <span class="toc-text">SonarQube 质量阈</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Jenkins-%E9%80%9A%E8%BF%87-Shell-%E5%AE%9E%E7%8E%B0-sonar-scanner-%E5%8A%9F%E8%83%BD"><span class="toc-number">4.6.3.</span> <span class="toc-text">Jenkins 通过 Shell 实现 sonar scanner 功能</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Jenkins-%E5%AE%89%E8%A3%85-SonarQube-%E6%8F%92%E4%BB%B6%E5%AE%9E%E7%8E%B0%E4%BB%A3%E7%A0%81%E6%89%AB%E6%8F%8F"><span class="toc-number">4.6.4.</span> <span class="toc-text">Jenkins 安装 SonarQube 插件实现代码扫描</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%9C%A8SonarQube%E6%B7%BB%E5%8A%A0Jenkins%E7%9A%84%E5%9B%9E%E8%B0%83%E6%8E%A5%E5%8F%A3"><span class="toc-number">4.6.4.1.</span> <span class="toc-text">在SonarQube添加Jenkins的回调接口</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Jenkins-%E5%AE%89%E8%A3%85-SonarQube-%E6%8F%92%E4%BB%B6"><span class="toc-number">4.6.4.2.</span> <span class="toc-text">Jenkins 安装 SonarQube 插件</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%B3%BB%E7%BB%9F%E9%85%8D%E7%BD%AE%E4%B8%AD%E6%B7%BB%E5%8A%A0-SonarQuebe-Server-%E7%9A%84%E5%9C%B0%E5%9D%80%E5%92%8C%E9%AA%8C%E8%AF%81%E4%BB%A4%E7%89%8C"><span class="toc-number">4.6.4.3.</span> <span class="toc-text">系统配置中添加 SonarQuebe Server 的地址和验证令牌</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#SonarQube-%E6%9C%8D%E5%8A%A1%E5%99%A8%E5%85%81%E8%AE%B8%E5%8C%BF%E5%90%8D%E8%AE%BF%E9%97%AE"><span class="toc-number">4.6.4.3.1.</span> <span class="toc-text">SonarQube 服务器允许匿名访问</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#SonarQube%E6%9C%8D%E5%8A%A1%E5%99%A8%E4%B8%8D%E5%85%81%E8%AE%B8%E5%8C%BF%E5%90%8D%E8%AE%BF%E9%97%AE"><span class="toc-number">4.6.4.3.2.</span> <span class="toc-text">SonarQube服务器不允许匿名访问</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Jenkins-%E6%B7%BB%E5%8A%A0-Sonar-Scanner-%E6%89%AB%E6%8F%8F%E5%99%A8"><span class="toc-number">4.6.4.4.</span> <span class="toc-text">Jenkins 添加 Sonar Scanner 扫描器</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%89%8B%E5%8A%A8%E6%8C%87%E5%AE%9A-sonar-scanner-%E5%9C%A8%E6%9C%AC%E5%9C%B0%E5%AE%89%E8%A3%85%E7%9A%84%E7%BB%9D%E5%AF%B9%E8%B7%AF%E5%BE%84"><span class="toc-number">4.6.4.4.1.</span> <span class="toc-text">手动指定 sonar-scanner 在本地安装的绝对路径</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%8C%87%E5%AE%9A%E4%B8%8B%E8%BD%BD%E8%B7%AF%E5%BE%84%E8%87%AA%E5%8A%A8%E5%AE%89%E8%A3%85"><span class="toc-number">4.6.4.4.2.</span> <span class="toc-text">指定下载路径自动安装</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E8%87%AA%E5%8A%A8%E4%BB%8E-Maven-%E4%BB%93%E5%BA%93%E5%AE%89%E8%A3%85"><span class="toc-number">4.6.4.4.3.</span> <span class="toc-text">自动从 Maven 仓库安装</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%9C%A8%E4%BB%BB%E5%8A%A1%E6%9E%84%E5%BB%BA%E6%AD%A5%E9%AA%A4%E4%B8%AD%E6%B7%BB%E5%8A%A0-Execute-Sonarqube-Scanner"><span class="toc-number">4.6.4.5.</span> <span class="toc-text">在任务构建步骤中添加 Execute Sonarqube Scanner</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE%E9%A1%B9%E7%9B%AE%E8%BF%9B%E8%A1%8C%E6%89%AB%E6%8F%8F"><span class="toc-number">4.6.4.6.</span> <span class="toc-text">配置项目进行扫描</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%9E%84%E5%BB%BA%E9%A1%B9%E7%9B%AE%E5%B9%B6%E6%B5%8B%E8%AF%95-sonar-scanner-%E6%98%AF%E5%90%A6%E7%94%9F%E6%95%88"><span class="toc-number">4.6.4.7.</span> <span class="toc-text">构建项目并测试 sonar-scanner 是否生效</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%9F%A5%E7%9C%8B%E9%A1%B9%E7%9B%AE%E7%9A%84%E6%9E%84%E5%BB%BA%E5%8E%86%E5%8F%B2"><span class="toc-number">4.6.4.8.</span> <span class="toc-text">查看项目的构建历史</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%A1%88%E4%BE%8B1-Pipeline-%E9%9B%86%E6%88%90-SonarQube-%E5%AE%9E%E7%8E%B0%E4%BB%A3%E7%A0%81%E6%A3%80%E6%B5%8B%E9%80%9A%E7%9F%A5-Jenkins"><span class="toc-number">4.7.</span> <span class="toc-text">案例1: Pipeline 集成 SonarQube 实现代码检测通知 Jenkins</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9C%A8-SonarQube-%E6%B7%BB%E5%8A%A0-Jenkins-%E7%9A%84%E5%9B%9E%E8%B0%83%E6%8E%A5%E5%8F%A3"><span class="toc-number">4.7.1.</span> <span class="toc-text">在 SonarQube 添加 Jenkins 的回调接口</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%87%86%E5%A4%87%E9%A1%B9%E7%9B%AE%E7%9A%84-Jenkinsfile-%E6%96%87%E4%BB%B6"><span class="toc-number">4.7.2.</span> <span class="toc-text">准备项目的 Jenkinsfile 文件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%87%86%E5%A4%87%E9%A1%B9%E7%9B%AE%E7%9B%AE%E5%BD%95%E4%B8%AD%E7%9A%84-sonar-project-properties-%E6%96%87%E4%BB%B6"><span class="toc-number">4.7.3.</span> <span class="toc-text">准备项目目录中的 sonar-project.properties 文件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E4%BB%BB%E5%8A%A1%E4%BD%BF%E7%94%A8-Pipeline-Script-from-SCM"><span class="toc-number">4.7.4.</span> <span class="toc-text">创建任务使用 Pipeline Script from SCM</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%89%A7%E8%A1%8C%E6%88%90%E5%8A%9F%E6%9E%84%E5%BB%BA"><span class="toc-number">4.7.5.</span> <span class="toc-text">执行成功构建</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%89%A7%E8%A1%8C%E9%97%AE%E9%A2%98%E4%BB%A3%E7%A0%81%E6%9E%84%E5%BB%BA"><span class="toc-number">4.7.6.</span> <span class="toc-text">执行问题代码构建</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%9E%84%E5%BB%BA%E9%97%AE%E9%A2%98%E4%BB%A3%E7%A0%81"><span class="toc-number">4.7.6.1.</span> <span class="toc-text">构建问题代码</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%9F%A5%E7%9C%8B%E7%BB%93%E6%9E%9C-1"><span class="toc-number">4.7.6.2.</span> <span class="toc-text">查看结果</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%A1%88%E4%BE%8B2-PipeLine-%E5%AE%9E%E7%8E%B0%E9%9B%86%E6%88%90-SonarQube-%E5%AE%9E%E7%8E%B0%E4%BB%A3%E7%A0%81%E6%A3%80%E6%B5%8B%E9%80%9A%E7%9F%A5-Jenkins"><span class="toc-number">4.8.</span> <span class="toc-text">案例2: PipeLine 实现集成 SonarQube 实现代码检测通知 Jenkins</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%89%E8%A3%85-Jenkins-%E5%B9%B6%E5%AE%89%E8%A3%85%E7%9B%B8%E5%85%B3%E6%8F%92%E4%BB%B6"><span class="toc-number">4.8.1.</span> <span class="toc-text">安装 Jenkins 并安装相关插件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%89%E8%A3%85-Jenkins-%E7%9A%84-Maven-%E5%B7%A5%E5%85%B7"><span class="toc-number">4.8.2.</span> <span class="toc-text">安装 Jenkins 的 Maven 工具</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%89%E8%A3%85-Gitlab-%E5%87%86%E5%A4%87%E9%A1%B9%E7%9B%AE"><span class="toc-number">4.8.3.</span> <span class="toc-text">安装 Gitlab 准备项目</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9C%A8-Jenkins-%E5%88%9B%E5%BB%BA%E8%BF%9E%E6%8E%A5-Gitlab%E7%9A%84%E5%87%AD%E6%8D%AE"><span class="toc-number">4.8.4.</span> <span class="toc-text">在 Jenkins 创建连接 Gitlab的凭据</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%89%E8%A3%85-Harbor-%E5%B9%B6%E9%85%8D%E7%BD%AE-Jenkins-%E8%BF%9E%E6%8E%A5Harbor"><span class="toc-number">4.8.5.</span> <span class="toc-text">安装 Harbor 并配置 Jenkins 连接Harbor</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9C%A8Jenkins%E4%B8%8A%E4%BF%AE%E6%94%B9-Docker%E7%9A%84socket%E6%96%87%E4%BB%B6%E6%9D%83%E9%99%90"><span class="toc-number">4.8.6.</span> <span class="toc-text">在Jenkins上修改 Docker的socket文件权限</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9C%A8-Jenkins-%E5%88%9B%E5%BB%BA%E5%87%AD%E6%8D%AE%E8%BF%9E%E6%8E%A5-Harbor"><span class="toc-number">4.8.7.</span> <span class="toc-text">在 Jenkins 创建凭据连接 Harbor</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%89%E8%A3%85-SonarQube-%E5%B9%B6%E5%88%9B%E5%BB%BA%E7%94%A8%E6%88%B7%E5%92%8C%E4%BB%A4%E7%89%8C"><span class="toc-number">4.8.8.</span> <span class="toc-text">安装 SonarQube 并创建用户和令牌</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9C%A8-SonarQube-%E6%B7%BB%E5%8A%A0-Jenkins-%E7%9A%84%E5%9B%9E%E8%B0%83%E6%8E%A5%E5%8F%A3-1"><span class="toc-number">4.8.9.</span> <span class="toc-text">在 SonarQube 添加 Jenkins 的回调接口</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%9B%E5%BB%BAJenkins%E8%AE%BF%E9%97%AE-Sonarqube%E7%9A%84%E4%BB%A4%E7%89%8C%E5%87%AD%E6%8D%AE"><span class="toc-number">4.8.10.</span> <span class="toc-text">创建Jenkins访问 Sonarqube的令牌凭据</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9C%A8Jenkins%E4%B8%8A%E9%85%8D%E7%BD%AE%E7%B3%BB%E7%BB%9F%E7%9A%84-SonarQube-%E6%9C%8D%E5%8A%A1%E5%99%A8%E4%BF%A1%E6%81%AF"><span class="toc-number">4.8.11.</span> <span class="toc-text">在Jenkins上配置系统的 SonarQube 服务器信息</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9C%A8Jenkins%E4%B8%8A%E5%88%9B%E5%BB%BA-Pipeline-%E4%BB%BB%E5%8A%A1"><span class="toc-number">4.8.12.</span> <span class="toc-text">在Jenkins上创建 Pipeline 任务</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E4%BB%BB%E5%8A%A1%E4%BD%BF%E7%94%A8Pipeline-Script"><span class="toc-number">4.8.13.</span> <span class="toc-text">创建任务使用Pipeline Script</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%89%A7%E8%A1%8C%E6%9E%84%E5%BB%BA-2"><span class="toc-number">4.8.14.</span> <span class="toc-text">执行构建</span></a></li></ol></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2025/08/01/MY-Proxy/" title="Proxy 代理"><img src="/../images/MY/clash.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Proxy 代理"/></a><div class="content"><a class="title" href="/2025/08/01/MY-Proxy/" title="Proxy 代理">Proxy 代理</a><time datetime="2025-08-01T11:05:46.000Z" title="发表于 2025-08-01 19:05:46">2025-08-01</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2025/07/30/MY-k8s1.29/" title="K8S 1.29.2"><img src="/../images/SRE/day46/1.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="K8S 1.29.2"/></a><div class="content"><a class="title" href="/2025/07/30/MY-k8s1.29/" title="K8S 1.29.2">K8S 1.29.2</a><time datetime="2025-07-30T07:17:21.000Z" title="发表于 2025-07-30 15:17:21">2025-07-30</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2025/05/09/SRE-jenkins/" title="DevOps之CICD工具Jenkins"><img src="/../images/SRE/day55/1.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="DevOps之CICD工具Jenkins"/></a><div class="content"><a class="title" href="/2025/05/09/SRE-jenkins/" title="DevOps之CICD工具Jenkins">DevOps之CICD工具Jenkins</a><time datetime="2025-05-09T09:30:43.000Z" title="发表于 2025-05-09 17:30:43">2025-05-09</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2025/04/24/SRE-git/" title="版本管理系统Git和GitLab"><img src="/../images/SRE/day53/77.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="版本管理系统Git和GitLab"/></a><div class="content"><a class="title" href="/2025/04/24/SRE-git/" title="版本管理系统Git和GitLab">版本管理系统Git和GitLab</a><time datetime="2025-04-24T01:21:27.000Z" title="发表于 2025-04-24 09:21:27">2025-04-24</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2023 - 2025 By ૮(˶ᵔ ᵕ ᵔ˶)ა</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div><div class="footer_custom_text"><a target="_blank" rel="noopener" href="https://beian.miit.gov.cn/#/Integrated/index"><img src="../images/BEIAN/icp.png" width="15" height="15">豫ICP备2023009931号</a></br><a href="http://www.beian.gov.cn/portal/registerSystemInfo?recordcode=41162702000178" target="_blank"><img src="../images/BEIAN/beian.png" width="15" height="15">豫公网安备 41162702000178号</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.umd.min.js"></script><script src="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.js"></script><script>function panguFn () {
  if (typeof pangu === 'object') pangu.autoSpacingPage()
  else {
    getScript('https://cdn.jsdelivr.net/npm/pangu/dist/browser/pangu.min.js')
      .then(() => {
        pangu.autoSpacingPage()
      })
  }
}

function panguInit () {
  if (true){
    GLOBAL_CONFIG_SITE.isPost && panguFn()
  } else {
    panguFn()
  }
}

document.addEventListener('DOMContentLoaded', panguInit)</script><div class="js-pjax"></div><canvas id="universe"></canvas><script src="/js/universe.js"></script><canvas class="fireworks" mobile="true"></canvas><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/fireworks.min.js"></script><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/activate-power-mode.min.js"></script><script>POWERMODE.colorful = true;
POWERMODE.shake = false;
POWERMODE.mobile = false;
document.body.addEventListener('input', POWERMODE);
</script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>