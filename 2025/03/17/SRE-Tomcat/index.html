<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>企业级Web应用服务器TOMCAT | ૮(˶ᵔ ᵕ ᵔ˶)ა</title><meta name="author" content="૮(˶ᵔ ᵕ ᵔ˶)ა"><meta name="copyright" content="૮(˶ᵔ ᵕ ᵔ˶)ა"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="ffffff"><meta name="description" content="Site Reliability Engineering">
<meta property="og:type" content="article">
<meta property="og:title" content="企业级Web应用服务器TOMCAT">
<meta property="og:url" content="http://example.com/2025/03/17/SRE-Tomcat/index.html">
<meta property="og:site_name" content="૮(˶ᵔ ᵕ ᵔ˶)ა">
<meta property="og:description" content="Site Reliability Engineering">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://example.com/images/SRE/day33/24.jpg">
<meta property="article:published_time" content="2025-03-17T09:45:17.000Z">
<meta property="article:modified_time" content="2025-04-01T11:34:55.950Z">
<meta property="article:author" content="૮(˶ᵔ ᵕ ᵔ˶)ა">
<meta property="article:tag" content="SRE">
<meta property="article:tag" content="Tomcat">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://example.com/images/SRE/day33/24.jpg"><link rel="shortcut icon" href="/../images/TITLE/user.webp"><link rel="canonical" href="http://example.com/2025/03/17/SRE-Tomcat/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//fonts.googleapis.com" crossorigin=""/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Titillium+Web&amp;display=swap" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":false,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: true,
    post: true
  },
  runtime: '天',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: {"chs_to_cht":"你已切换为繁体","cht_to_chs":"你已切换为简体","day_to_night":"你已切换为深色模式","night_to_day":"你已切换为浅色模式","bgLight":"#49b1f5","bgDark":"#1f1f1f","position":"top-center"},
  source: {
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: true,
  }
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: '企业级Web应用服务器TOMCAT',
  isPost: true,
  isHome: false,
  isHighlightShrink: undefined,
  isToc: true,
  postUpdate: '2025-04-01 19:34:55'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
    win.getCSS = (url,id = false) => new Promise((resolve, reject) => {
      const link = document.createElement('link')
      link.rel = 'stylesheet'
      link.href = url
      if (id) link.id = id
      link.onerror = reject
      link.onload = link.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        link.onload = link.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(link)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', 'ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><link rel="stylesheet" href="/css/custom.css"  media="defer" onload="this.media='all'"><meta name="generator" content="Hexo 5.4.2"></head><body><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="/../images/TITLE/user.webp" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">101</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">41</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">34</div></a></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间线</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('/../images/SRE/day33/24.jpg')"><nav id="nav"><span id="blog-info"><a href="/" title="૮(˶ᵔ ᵕ ᵔ˶)ა"><span class="site-name">૮(˶ᵔ ᵕ ᵔ˶)ა</span></a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间线</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">企业级Web应用服务器TOMCAT</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2025-03-17T09:45:17.000Z" title="发表于 2025-03-17 17:45:17">2025-03-17</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2025-04-01T11:34:55.950Z" title="更新于 2025-04-01 19:34:55">2025-04-01</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/Tomcat/">Tomcat</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">字数总计:</span><span class="word-count">59.1k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>276分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="企业级Web应用服务器TOMCAT"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="Java-基础"><a href="#Java-基础" class="headerlink" title="Java 基础"></a>Java 基础</h1><h2 id="WEB架构"><a href="#WEB架构" class="headerlink" title="WEB架构"></a>WEB架构</h2><h3 id="Web资源和访问"><a href="#Web资源和访问" class="headerlink" title="Web资源和访问"></a>Web资源和访问</h3><p><img src="../../../../images/SRE/day33/1.jpg" alt="1"></p>
<p><strong>PC 端或移动端浏览器访问</strong> </p>
<p>从静态服务器请求HTML、CSS、JS等文件发送到浏览器端，浏览器端接收后渲染在浏览器上</p>
<p>从图片服务器请求图片资源显示</p>
<p>从业务服务器访问动态内容，动态内容是请求后有后台服务访问数据库后得到的，最终返回到浏览器端</p>
<p><strong>手机 App 访问</strong></p>
<p>内置了HTML和JS文件，不需要从静态WEB服务器下载 JS 或 HTML。为的就是减少文件的发送，现代前端开发使用的JS文件太多或太大了</p>
<p>有必要就从图片服务器请求图片，从业务服务器请求动态数据</p>
<p>客户需求多样，更多的内容还是需要由业务服务器提供，业务服务器往往都是由一组服务器组成。</p>
<h3 id="后台应用架构"><a href="#后台应用架构" class="headerlink" title="后台应用架构"></a>后台应用架构</h3><p><img src="../../../../images/SRE/day33/2.jpg" alt="2"></p>
<h4 id="单体架构"><a href="#单体架构" class="headerlink" title="单体架构"></a>单体架构</h4><ul>
<li><p>传统架构（单机系统），一个项目一个工程：比如商品、订单、支付、库存、登录、注册等等，统一部署，一个进程</p>
</li>
<li><p>all in one的架构方式，把所有的功能单元放在一个应用里。然后把整个应用部署到一台服务器上。如果负载能力不行，将整个应用进行水平复制，进行扩展，然后通过负载均衡实现访问。</p>
</li>
<li><p>Java实现：JSP、Servlet，打包成一个jar、war文件部署</p>
</li>
<li><p>易于开发和测试:也十分方便部署;当需要扩展时，只需要将war复制多份，然后放到多个服务器上，再做个负载均衡就可以了。</p>
</li>
<li><p>如果某个功能模块出问题，有可能全站不可访问，修改Bug后、某模块功能修改或升级后，需要停掉整个服务，重新整体重新打包、部署这个应用war包，功能模块相互之间耦合度高,相互影响,不适合当今互联网业务功能的快速迭代。</p>
</li>
<li><p>特别是对于一个大型应用，我们不可能吧所有内容都放在一个应用里面，我们如何维护、如何分工合作都是问题。如果项目庞大，管理难度大</p>
</li>
<li><p>web应用服务器：开源的tomcat、jetty、glassfish。商用的有weblogic、websphere、Jboss</p>
</li>
</ul>
<h4 id="微服务"><a href="#微服务" class="headerlink" title="微服务"></a>微服务</h4><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://www.martinfowler.com/microservices/</span><br></pre></td></tr></table></figure>

<p><img src="../../../../images/SRE/day33/3.jpg" alt="3"></p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">In short, the microservice architectural style is an approach to developing a single</span><br><span class="line">application as a suite of small services, each running in its own process and communicating</span><br><span class="line">with lightweight mechanisms, often an HTTP resource API. These services are built around</span><br><span class="line">business capabilities and independently deployable by fully automated deployment machinery.</span><br><span class="line">There is a bare minimum of centralized management of these services, which may be written in</span><br><span class="line">different programming languages and use different data storage technologies.</span><br><span class="line">简而言之，微服务架构风格是一种将单个应用程序开发为一组小服务的方法，每个小服务都在自己的进程中运行，并与轻量级</span><br><span class="line">机制（通常是 HTTP 资源 API）进行通信。 这些服务是围绕业务能力构建的，并且可以通过完全自动化的部署机制独立部</span><br><span class="line">署。 这些服务的集中管理极少，可以用不同的编程语言编写并使用不同的数据存储技术。</span><br><span class="line">                                                  -- James Lewis and Martin Fowler (2014)</span><br></pre></td></tr></table></figure>

<ul>
<li>属于SOA（Service Oriented Architecture）的子集,SOA可以认为面向服务的1.0版本,微服务可以认为是面向服务的2.0版本,SOA的服务之间通过ESB(Enterprise Service Bus)进行通信,则ESB的单点依赖和商业ESB的费用问题反而成为了所有服务的瓶颈</li>
<li>微服务化的核心就是将传统的一站式应用，根据业务拆分成一个一个的服务，彻底去掉耦合，每一个微服务提供单个业务功能，一个服务只做一件事。每个服务都围绕着具体业务进行构建，并且能够被独立地部署到生产环境、类生产环境等</li>
<li>从技术角度讲就是一种小而独立的处理过程，类似与进程的概念，能够自行单独启动或销毁</li>
<li>微服务架构（分布式系统），各个模块/服务，各自独立出来，”让专业的人干专业的事”，独立部署。分布式系统中，不同的服务可以使用各自独立的数据库。</li>
<li>服务之间采用轻量级的通信机制（通常是基于HTTP的RESTful API）。 </li>
<li>微服务设计的思想改变了原有的企业研发团队组织架构。传统的研发组织架构是水平架构，前端、后端、DBA、测试分别有自己对应的团队，属于水平团队组织架构。而微服务的设计思想对团队的划分有着一定的影响，使得团队组织架构的划分更倾向于垂直架构，比如用户业务是一个团队来负责，支付业务是一个团队来负责。但实际上在企业中并不会把团队组织架构拆分得这么绝对，垂直架构只是一种理想的架构</li>
<li>微服务的实现框架有多种，不同的应用架构，部署方式也有不同</li>
</ul>
<h2 id="Java"><a href="#Java" class="headerlink" title="Java"></a>Java</h2><p><img src="../../../../images/SRE/day33/4.jpg" alt="4"></p>
<h3 id="Java历史"><a href="#Java历史" class="headerlink" title="Java历史"></a>Java历史</h3><p>Java原指的是印度尼西亚的爪哇岛，人口众多，盛产咖啡、橡胶等。</p>
<p>Java语言最早是在1991年开始设计的，最初叫Oak项目，它初衷是跑在不同机顶盒设备中的。</p>
<p>1993年网景公司成立。Oak项目组很快他们发现了浏览器和动态网页技术这个巨大的市场，转向WEB方向。并首先发布了可以让网页动起来的Applet技术（浏览器中嵌入运行Java字节码的技术）。</p>
<p>在1995年，一杯爪哇岛咖啡成就了Java这个名字。</p>
<p>Sun公司第一个Java公开版本1.0发布于1996年。口号是”一次编写，到处运行”(Write once，Run anywhere)，跨平台运行。</p>
<p>1999年，SUN公司发布了第二代Java平台(Java2)。</p>
<p>2009年4月20日，Oracle甲骨文公司宣布将以每股9.50美元，总计74亿美金收购SUN（计算机系统）公司。2010年1月成功收购。</p>
<p>2010年，Java创始人之一的 James Gosling 离开了Oracle，去了Google。</p>
<blockquote>
<p>2010年8月13日，Oracle在加利福尼亚地方法院起诉Google侵犯版权和专利权。Oracle声称Google侵犯了Java 37个API和部分专利。地方法院的陪审团认为未侵犯专利，且API无版权。</p>
<p>2016年5月26日，地方法院二审陪审团认定未侵犯版权，对37个JAVA API的重新实现受到合理使用的保护。</p>
<p>2017年Oracle上诉美国联邦巡回上诉法院，2018年3月27日判决Oracle胜诉，Google应赔偿近90 亿美金。</p>
<p>2019年1月Google想让美国最高法院撤销联邦法院裁决。谷歌表示裁决是”对软件业的毁灭性一击”。现任特朗普政府支持Oracle公司，但微软、Mozilla、 红帽支持Google。目前案件已经受理，但由于疫情推迟。有更多的企业和组织加入进来，包括IBM、计算机和通信协会、互联网协会、超过150名学者和教授。 </p>
<p>此案如果Oracle胜诉，将在美国形成判例，将深远广泛影响软件业。例如: POSIX接口， 是商用系统UNIX的兼容接口规范。</p>
<p>2021 年 4 月 5 日，美国最高法院就 Oracle 起诉 Google 知识产权侵权案作出了判决，这场两大科技巨头之间长达十几年的官司终于“一锤定音”：谷歌胜，甲骨文败。最高法院的判决中包含两项关键的决议：最高法院维持下级法院的原判，并裁定 API 受版权保护。 Google 从 Java 复制 11,500 行代码的行为属于“合理使用”。</p>
</blockquote>
<h3 id="Java-组成"><a href="#Java-组成" class="headerlink" title="Java 组成"></a>Java 组成</h3><p>Java 包含下面部分：</p>
<ul>
<li>语言、语法规范。关键字,如: if、for、class等</li>
<li>源代码 source code</li>
<li>依赖库，标准库(基础)、第三方库(针对某些应用)。底层代码太难使用且开发效率低，封装成现成的库</li>
<li>JVM虚拟机。将源代码编译为中间码即字节码后,再运行在JVM之上</li>
</ul>
<p><img src="../../../../images/SRE/day33/5.jpg" alt="5"></p>
<p>由于各种操作系统ABI不一样，采用编译方式，需要为不同操作系统编译成相应格式的二进制程序才能运行。</p>
<p>1995年，Java发布Applet技术，Java程序在后台编译成字节码，发送到浏览器端，在浏览器中运行一个Applet程序，这段程序是运行在另外一个JVM进程中的。</p>
<p>但是这种在客户端运行Java代码的技术，会有很大的安全问题。1997年CGI技术发展起来，动态网页技术开始向后端开发转移，在后端将动态内容组织好，拼成HTML发回到浏览器端。</p>
<h3 id="Java动态网页技术"><a href="#Java动态网页技术" class="headerlink" title="Java动态网页技术"></a>Java动态网页技术</h3><h4 id="servlet"><a href="#servlet" class="headerlink" title="servlet"></a>servlet</h4><p>本质就是一段Java程序</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.*;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HelloWorld</span> <span class="keyword">extends</span> <span class="title class_">HttpServlet</span> &#123;</span><br><span class="line">  <span class="keyword">private</span> String message;</span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">init</span><span class="params">()</span> <span class="keyword">throws</span> ServletException</span><br><span class="line">  &#123;</span><br><span class="line">      message = <span class="string">&quot;Hello World&quot;</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">doGet</span><span class="params">(HttpServletRequest request,</span></span><br><span class="line"><span class="params">                    HttpServletResponse response)</span></span><br><span class="line">            <span class="keyword">throws</span> ServletException, IOException</span><br><span class="line">  &#123;</span><br><span class="line">      response.setContentType(<span class="string">&quot;text/html&quot;</span>); <span class="comment">//响应报文内容类型</span></span><br><span class="line">      <span class="type">PrintWriter</span> <span class="variable">out</span> <span class="operator">=</span> response.getWriter();  <span class="comment">//构建响应报文内容</span></span><br><span class="line">      out.println(<span class="string">&quot;&lt;h1&gt;&quot;</span> + message + <span class="string">&quot;&lt;/h1&gt;&quot;</span>);</span><br><span class="line">      out.println(<span class="string">&quot;&lt;p&gt;&lt;a href=http://www.magedu.com&gt;马哥教育&lt;/a&gt;欢迎你&lt;/p&gt;&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">destroy</span><span class="params">()</span></span><br><span class="line">  &#123;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在Servlet中最大的问题是，HTML输出和Java代码混在一起，如果网页布局要调整，Java源代码就需要随之进行调整,对于开发人员来说就是个噩梦。</p>
<h4 id="jsp（Java-Server-Pages）"><a href="#jsp（Java-Server-Pages）" class="headerlink" title="jsp（Java Server Pages）"></a>jsp（Java Server Pages）</h4><p>JSP本质是提供一个HTML模板，也就是在网页中预留以后填充的空，后续将Java程序运行生成的数据对HTML进行填空就可以了。如果网页布局需要调整,JAVA源代码不需要很大的调整</p>
<figure class="highlight jsp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">&lt;%@ page language=<span class="string">&quot;java&quot;</span> contentType=<span class="string">&quot;text/html; charset=UTF-8&quot;</span></span><br><span class="line">    pageEncoding=<span class="string">&quot;UTF-8&quot;</span>%&gt;</span><br><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">    &lt;meta charset=<span class="string">&quot;utf-8&quot;</span>&gt;</span><br><span class="line">    &lt;title&gt;jsp例子&lt;/title&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">本行后面的内容是服务器端动态生成字符串，最后拼接在一起</span><br><span class="line">&lt;%</span><br><span class="line">out.println(<span class="string">&quot;你的 IP 地址 &quot;</span> + request.getRemoteAddr());</span><br><span class="line">%&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure>

<p>JSP是基于Servlet实现，JSP将表现和逻辑分离，这样页面开发人员更好的注重页面表现力更好服务客户。</p>
<p>不过最终 JSP 还需要先转换为 Servlet的源代码.java文件（Tomcat中使用Jasper转换），只不过这个转换过程无需人工完成,是通过工具自动实现的,然后再编译成.class文件，最后才可以在JVM中运行。</p>
<p>比如: 浏览器第一次请求test.jsp时, Tomcat服务器会自动将test.jsp转化成test.jsp.java这么一个类,并将该文件编译成class文件。编译完毕后再运行class文件来响应浏览器的请求。如果以后访问test.jsp就不再重新编译jsp文件了，直接调用class文件来响应浏览器。后续如果Tomcat检测到JSP页面改动了的话，会重新编译</p>
<p>JSP类似于PHP和ASP,前端代码和后端JAVA代码混写在一起,需要前端和后端工程师在一起协作才能完成,无法做到真正的前后端分离开发</p>
<p>在web早期的开发中，通常采用的分为两层，视图层和模型层。</p>
<p><img src="../../../../images/SRE/day33/6.jpg" alt="6"></p>
<p>优点：架构简单，比较适合小型项目开发</p>
<p>缺点：JSP职责不单一，职责过重，不便于维护</p>
<h4 id="MVC"><a href="#MVC" class="headerlink" title="MVC"></a>MVC</h4><p>如果过度使用jsp技术,jsp中既写有大量的java代码，也有html，甚至还有javascript等，造成难以维护，难以实现前后端分工协作，后来java 的web开发借鉴了MVC（Model View Controller ）开发模式，</p>
<p>MVC是模型(Model)、视图(View)、控制器(Controller)的简写，是一种软件设计规范。是将业务逻辑、数据、显示分离的方法来组织代码。MVC主要作用是降低了视图与业务逻辑间的双向偶合。</p>
<p>MVC不是一种设计模式，MVC是一种架构模式。当然不同的MVC存在差异。 </p>
<ul>
<li>Model（模型）：数据模型，提供要展示的数据，因此包含数据和行为，可以认为是领域模型或JavaBean组件（包含数据和行为），不过现在一般都分离开来：Value Object（数据Dao） 和 服务层（行为Service）。也就是模型提供了模型数据查询和模型数据的状态更新等功能，包括数据和业务。</li>
<li>View（视图）：负责进行模型的展示，一般就是我们见到的用户界面，客户想看到的东西。可通过JSP实现</li>
<li>Controller（控制器）：接收用户请求，委托给模型进行处理（状态改变），处理完毕后把返回的模型数据返回给视图，由视图负责展示。也就是说控制器做了个调度员的工作。最终表现为Servlet</li>
</ul>
<p>最典型的MVC就是JSP + servlet + javabean的模式。</p>
<p><img src="../../../../images/SRE/day33/7.jpg" alt="7"></p>
<p><strong>职责分析</strong>：</p>
<p><strong>Controller：控制器</strong></p>
<ul>
<li>取得表单数据</li>
<li>调用业务逻辑</li>
<li>转向指定的页面</li>
</ul>
<p><strong>Model：模型</strong></p>
<ul>
<li>业务逻辑</li>
<li>保存数据的状态</li>
</ul>
<p><strong>View：视图</strong></p>
<ul>
<li>显示页面</li>
</ul>
<p><strong>处理流程</strong> </p>
<ol>
<li>用户发请求 </li>
<li>Servlet接收请求数据，并调用对应的业务逻辑方法</li>
<li>业务处理完毕，返回更新后的数据给servlet</li>
<li>servlet转向到JSP，由JSP来渲染页面</li>
<li>响应给前端更新后的页面</li>
</ol>
<p><img src="../../../../images/SRE/day33/8.jpg" alt="8"></p>
<p>MVC模式也有以下不足：</p>
<ul>
<li>每次请求必须经过”控制器-&gt;模型-&gt;视图”这个流程，用户才能看到最终的展现界面，这个过程似乎有些复杂</li>
<li>实际上视图是依赖于模型的，换句话说，如果没有模型，视图也无法呈现出最终的效果</li>
<li>渲染视图过程是在服务端来完成的，最终呈现给浏览器的是带有模型的视图页面，性能无法得到很好的优化</li>
</ul>
<h4 id="REST"><a href="#REST" class="headerlink" title="REST"></a>REST</h4><p>为了使数据展现过程更加直接，并且提供更好的用户体验，对MVC模式进行改进。首先从浏览器发送AJAX（ Asynchronous JavaScript and XML 异步的 JavaScript 和 XML）请求，然后服务端接受该请求并返回JSON数据返回给浏览器，最后在浏览器中进行界面渲染。改进后的MVC模式如下图所示：</p>
<p><img src="../../../../images/SRE/day33/9.jpg" alt="9"></p>
<p>也就是说，我们输入的是AJAX请求，输出的是JSON数据，REST技术实现这样的功能。</p>
<p>REST(Representational State Transfer表述性状态转移，全称是 Resource Representational State Transfer</p>
<p>即资源在网络中以某种表现形式进行状态转移。</p>
<p>分解开来：Resource：资源，即数据</p>
<p>Representational：某种表现形式，比如用JSON，XML，JPEG等</p>
<p>State Transfer：状态变化。通过HTTP动词实现</p>
<p>它是Roy Fielding博士在2000年写的一篇关于软件架构风格的论文，后来国内外许多知名互联网公司纷纷开始采用这种轻量级的Web服务，大家习惯将其称为RESTful Web Services，或简称REST服务。</p>
<p>如果将浏览器这一端视为前端，而服务器那一端视为后端的话，可以将以上改进后的MVC模式简化为以下前后端分离模式，如下图所示：</p>
<p><img src="../../../../images/SRE/day33/10.jpg" alt="10"></p>
<p>可见，采用REST风格的架构可以使得前端关注界面展现，后端关注业务逻辑，分工明确，职责清晰。</p>
<p>在设计web接口的时候，REST主要是用于定义接口名，接口名一般是用名次写，不用动词，那怎么表达“获取”或者“删除”或者“更新”这样的操作呢——用请求类型来区分。</p>
<p>比如，我们有一个friends接口，对于“朋友”我们有增删改查四种操作，怎么定义REST接口？</p>
<p>增加一个朋友，uri: generalcode.cn/v1/friends 接口类型：POST</p>
<p>删除一个朋友，uri: generalcode.cn/va/friends 接口类型：DELETE</p>
<p>修改一个朋友，uri: generalcode.cn/va/friends 接口类型：PUT</p>
<p>查找朋友，uri: generalcode.cn/va/friends 接口类型：GET</p>
<p>上面我们定义的四个接口就是符合REST协议的，请注意，这几个接口都没有动词，只有名词friends，都是通过Http请求的接口类型来判断是什么业务操作。 </p>
<p>REST就是一种设计API的模式。最常用的数据格式是JSON。由于JSON能直接被JavaScript读取，所以，以JSON格式编写的REST风格的API具有简单、易读、易用的特点。</p>
<p>编写API有什么好处呢？由于API就是把Web App的功能全部封装了，所以，通过API操作数据，可以极大地把前端和后端的代码隔离，使得后端代码易于测试，前端代码编写更简单。前端拿到数据只负责展示和渲染，不对数据做任何处理。后端处理数据并以JSON格式传输出去，定义这样一套统一的接口，在web，ios，android三端都可以用相同的接口，通过客户端访问API，就可以完成通过浏览器页面提供的功能，而后端代码基本无需改动。</p>
<h3 id="JDK"><a href="#JDK" class="headerlink" title="JDK"></a>JDK</h3><h4 id="JDK和JRE"><a href="#JDK和JRE" class="headerlink" title="JDK和JRE"></a>JDK和JRE</h4><h5 id="JDK-和-JRE-关系"><a href="#JDK-和-JRE-关系" class="headerlink" title="JDK 和 JRE 关系"></a>JDK 和 JRE 关系</h5><p><img src="../../../../images/SRE/day33/11.jpg" alt="11"></p>
<p><strong>Java SE API</strong>: Java 基础类库开发接口</p>
<p><strong>JRE</strong>：Java Runtime Environment缩写，指Java运行时环境， 包含 JVM + Java核心类库</p>
<p><strong>JDK</strong>：Java Development Kit，即 Java 语言的软件开发工具包,JDK协议基于 JRL(JavaResearch License)协议</p>
<p><img src="../../../../images/SRE/day33/12.jpg" alt="12"></p>
<p><img src="../../../../images/SRE/day33/13.jpg" alt="13"></p>
<h5 id="JVM-的各种版本"><a href="#JVM-的各种版本" class="headerlink" title="JVM 的各种版本"></a>JVM 的各种版本</h5><p>参考链接:</p>
<p><a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/List_of_Java_virtual_machines">https://en.wikipedia.org/wiki/List_of_Java_virtual_machines</a></p>
<p><a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Comparison_of_Java_virtual_machines">https://en.wikipedia.org/wiki/Comparison_of_Java_virtual_machines</a></p>
<p>各个公司和组织基于标准规范,开发了不同的JVM版本</p>
<ul>
<li>SUN HotSpot</li>
<li>IBM J9VM</li>
<li>BEA JRockit </li>
</ul>
<p><strong>JVM 市场份额</strong> </p>
<p>2018年12月，由 Snyk 和 The Java Magazine 联合推出发布的 2018 JVM 生态调查报告</p>
<p><img src="../../../../images/SRE/day33/14.jpg" alt="14"></p>
<h4 id="Oracle-JDK版本"><a href="#Oracle-JDK版本" class="headerlink" title="Oracle JDK版本"></a>Oracle JDK版本</h4><p><img src="../../../../images/SRE/day33/15.jpg" alt="15"><br><img src="../../../../images/SRE/day33/16.jpg" alt="16"></p>
<p>JDK也就是常说的J2SE，在1999年，正式发布了Java第二代平台，发布了三个版本：</p>
<ul>
<li>J2SE：标准版，适用于桌面平台</li>
<li>J2EE：企业版，java在企业级开发所有规范的总和，共有13个大的规范,Servlet、Jsp都包含在JavaEE规范中</li>
<li>J2ME：微型版，适用于移动、无线、机顶盒等设备环境</li>
</ul>
<p>2005年，Java的版本又更名为JavaSE、JavaEE、JavaME</p>
<p>**JDK7、JDK8、JDK11是LTS（Long Term Support）</p>
<p><strong>JDK 历史版本</strong> </p>
<p><a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Java_version_history">https://en.wikipedia.org/wiki/Java_version_history</a></p>
<p><img src="../../../../images/SRE/day33/17.jpg" alt="17"></p>
<p><strong>时间-事件轴</strong></p>
<blockquote>
<p>1995年5月23日，Java语言诞生</p>
<p>1996年1月，第一个JDK-JDK1.0诞生</p>
<p>1996年4月，10个最主要的操作系统供应商申明将在其产品中嵌入JAVA技术 </p>
<p>1996年9月，约8.3万个网页应用了JAVA技术来制作</p>
<p>1997年2月18日，JDK1.1发布</p>
<p>1997年4月2日，JavaOne会议召开，参与者逾一万人，创当时全球同类会议规模之纪录</p>
<p>1997年9月，JavaDeveloperConnection社区成员超过十万</p>
<p>1998年2月，JDK1.1被下载超过2,000,000次</p>
<p>1998年12月8日，JAVA2企业平台J2EE发布</p>
<p>1999年6月，SUN公司发布Java的三个版本：标准版、企业版和微型版（J2SE、J2EE、J2ME）</p>
<p>2000年5月8日，JDK1.3发布</p>
<p>2000年5月29日，JDK1.4发布</p>
<p>2001年6月5日，NOKIA宣布，到2003年将出售1亿部支持Java的手机</p>
<p>2001年9月24日，J2EE1.3发布</p>
<p>2002年2月13日，J2SE1.4发布，自此Java的计算能力有了大幅提升。</p>
<p>2004年9月30日18:00PM，J2SE1.5发布，是Java语言的发展史上的又一里程碑事件。为了表示这个版本的重要性，J2SE1.5更名为J2SE5.0</p>
<p>2005年6月，JavaOne大会召开，SUN公司公开Java SE 6。此时，Java的各种版本已经更名以取消其中的数字”2”：J2EE更名为Java EE, J2SE更名为Java SE，J2ME更名为Java ME。 </p>
<p>2006年11月13日，SUN公司宣布Java全线采纳GNU General Public License Version 2，从而公开了Java的源代码。</p>
</blockquote>
<p><strong>JDK 版本使用情况</strong></p>
<p>数据来源</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://www.baeldung.com/java-in-2019</span><br></pre></td></tr></table></figure>

<p><img src="../../../../images/SRE/day33/18.jpg" alt="19"></p>
<p><strong>收费</strong></p>
<p>从2019年1月份开始，Oracle JDK 开始对 Java SE 8 之后的版本开始进行商用收费，确切的说是8u201/202 之后的版本。如果你用 Java 开发的功能如果是用作商业用途的，如果还不想花钱购买的话，能免费使用的最新版本是 8u201/202。当然如果是个人客户端或者个人开发者可以免费试用 Oracle JDK 所有的版本。</p>
<p><strong>发版方式</strong></p>
<p>在 JDK 9 发布之前，Oracle 的发版策略是以特性驱动的，只有重大的特性改变才会发布大版本，比如 JDK 7 到 JDK 8，中间会发多个更新版本。而从 JDK 9 开始变为以时间驱动的方式。发布周期为6个月一个大版本，比如 JDK 9 到 JDK 10，3个月一次补丁版，3年一个 LTS(长期支持版本)。</p>
<h4 id="OpenJDK"><a href="#OpenJDK" class="headerlink" title="OpenJDK"></a>OpenJDK</h4><p>OpenJDK 介绍</p>
<p><img src="../../../../images/SRE/day33/19.jpg" alt="19"></p>
<p>OpenJDK是Sun公司采用GPL v2协议发布的JDK开源版本，于2009年正式发布。</p>
<p><img src="../../../../images/SRE/day33/20.jpg" alt="20"></p>
<p>官方网站：<a target="_blank" rel="noopener" href="https://openjdk.java.net/projects/jdk6/">https://openjdk.java.net/projects/jdk6/</a></p>
<p>OpenJDK 7是基于JDK7的beta版开发，但为了也将Java SE 6开源，从OpenJDK7的b20构建反向分支开发，从中剥离了不符合Java SE 6规范的代码，发布OpenJDK 6。所以OpenJDK6和JDK6没什么关系,只是API兼容而已</p>
<p>OpenJDK使用GPL v2可以用于商业用途。目前由红帽维护。OpenJDK也有在其基础上的众多发行版，比如阿里的Dragonwell。</p>
<p>相对来说,Oracle jDK具有更好的响应能力和JVM性能，更加稳定。</p>
<h5 id="安装-openjdk"><a href="#安装-openjdk" class="headerlink" title="安装 openjdk"></a>安装 openjdk</h5><ul>
<li>在CentOS中，可以使用 yum 仓库安装 openjdk</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ~]<span class="comment"># dnf list &quot;*jdk*&quot;</span></span><br><span class="line"></span><br><span class="line">[root@centos8 ~]<span class="comment"># dnf -y install java-1.8.0-openjdk.x86_64 java-1.8.0-openjdk-devel</span></span><br><span class="line"></span><br><span class="line">[root@centos8 ~]<span class="comment"># java -version</span></span><br><span class="line">openjdk version <span class="string">&quot;1.8.0_232&quot;</span></span><br><span class="line">OpenJDK Runtime Environment (build 1.8.0_232-b09)</span><br><span class="line">OpenJDK 64-Bit Server VM (build 25.232-b09, mixed mode)</span><br><span class="line"></span><br><span class="line">[root@centos8 ~]<span class="comment"># which java</span></span><br><span class="line">/usr/bin/java</span><br><span class="line"></span><br><span class="line">[root@centos8 ~]<span class="comment"># ll /usr/bin/java</span></span><br><span class="line">lrwxrwxrwx 1 root root 22 Feb  8 20:03 /usr/bin/java -&gt; /etc/alternatives/java</span><br><span class="line"></span><br><span class="line">[root@centos8 ~]<span class="comment"># ll /etc/alternatives/java</span></span><br><span class="line">lrwxrwxrwx 1 root root 73 Feb  8 20:03 /etc/alternatives/java -&gt; /usr/lib/jvm/java-1.8.0-openjdk-1.8.0.232.b09-0.el8_0.x86_64/jre/bin/java</span><br><span class="line"></span><br><span class="line">[root@centos8 ~]<span class="comment"># rpm -qf /usr/lib/jvm/java-1.8.0-openjdk-1.8.0.232.b09-0.el8_0.x86_64/jre/bin/java</span></span><br><span class="line">java-1.8.0-openjdk-headless-1.8.0.232.b09-0.el8_0.x86_64</span><br></pre></td></tr></table></figure>

<p>范例: 安装 java-11-openjdk</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">OpenJDK 64-Bit Server VM 18.9 (build 11.0.7+10-LTS, mixed mode, sharing)</span><br><span class="line">[root@centos8 ~]<span class="comment"># dnf -y install java-11-openjdk.x86_64</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># java --version</span></span><br><span class="line">openjdk 11.0.7 2020-04-14 LTS</span><br><span class="line">OpenJDK Runtime Environment 18.9 (build 11.0.7+10-LTS)</span><br></pre></td></tr></table></figure>

<p>范例: 编译运行java程序</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ~]<span class="comment"># dnf -y install java-1.8.0-openjdk-devel</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># cat Hello.java</span></span><br><span class="line">class Hello&#123;  </span><br><span class="line">   public static void main(String[] args)</span><br><span class="line">   &#123;  </span><br><span class="line">       System.out.println(<span class="string">&quot;hello, world&quot;</span>);  </span><br><span class="line">   &#125;  </span><br><span class="line">&#125;  </span><br><span class="line"></span><br><span class="line"><span class="comment">#编译成字节码</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># javac Hello.java </span></span><br><span class="line">[root@centos8 ~]<span class="comment"># ll Hello.*</span></span><br><span class="line">-rw-r--r-- 1 root root 416 Oct 24 13:00 Hello.class</span><br><span class="line">-rw-r--r-- 1 root root 130 Aug 22 23:38 Hello.java</span><br><span class="line"></span><br><span class="line">[root@centos8 ~]<span class="comment"># file Hello.class </span></span><br><span class="line">Hello.class: compiled Java class data, version 52.0 (Java 1.8)</span><br><span class="line"></span><br><span class="line"><span class="comment">#运行java程序</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># java Hello </span></span><br><span class="line">hello, world</span><br></pre></td></tr></table></figure>

<p>范例: ubuntu 安装 openjdk</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[root@ubuntu1804 ~]<span class="comment"># apt update</span></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment"># apt -y install openjdk-8-jdk </span></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment"># java -version</span></span><br><span class="line">openjdk version <span class="string">&quot;1.8.0_242&quot;</span></span><br><span class="line">OpenJDK Runtime Environment (build 1.8.0_242-8u242-b08-0ubuntu3~18.04-b08)</span><br><span class="line">OpenJDK 64-Bit Server VM (build 25.242-b08, mixed mode)</span><br><span class="line"></span><br><span class="line">root@ubuntu2004:~<span class="comment"># apt -y install openjdk-11-jdk</span></span><br><span class="line">root@ubuntu2004:~<span class="comment"># java -version</span></span><br><span class="line">openjdk version <span class="string">&quot;11.0.9.1&quot;</span> 2020-11-04</span><br><span class="line">OpenJDK Runtime Environment (build 11.0.9.1+1-Ubuntu-0ubuntu1.20.04)</span><br><span class="line">OpenJDK 64-Bit Server VM (build 11.0.9.1+1-Ubuntu-0ubuntu1.20.04, mixed mode, sharing)</span><br></pre></td></tr></table></figure>

<h4 id="安装-Oracle-官方-JDK"><a href="#安装-Oracle-官方-JDK" class="headerlink" title="安装 Oracle 官方 JDK"></a>安装 Oracle 官方 JDK</h4><p>官方下载链接: </p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">#注意需要注册登录后,才能下载JDK</span><br><span class="line">https://www.oracle.com/java/technologies/downloads/#java8</span><br><span class="line">https://www.oracle.com/java/technologies/downloads/#java11</span><br><span class="line">https://www.oracle.com/java/technologies/javase/javase-jdk8-downloads.html</span><br></pre></td></tr></table></figure>

<p><img src="../../../../images/SRE/day33/21.jpg" alt="21"></p>
<p><img src="../../../../images/SRE/day33/22.jpg" alt="22"><br><img src="../../../../images/SRE/day33/23.jpg" alt="23"></p>
<h5 id="Oracle-JDK-的-rpm安装"><a href="#Oracle-JDK-的-rpm安装" class="headerlink" title="Oracle JDK 的 rpm安装"></a>Oracle JDK 的 rpm安装</h5><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#需要登录下载：https://www.oracle.com/java/technologies/javase/javase-jdk8-downloads.html</span></span><br><span class="line"></span><br><span class="line">[root@centos8 ~]<span class="comment"># ls -lh jdk-8u241-linux-x64.rpm</span></span><br><span class="line">-rw-r--r-- 1 root root 171M Feb  8 18:29 jdk-8u241-linux-x64.rpm</span><br><span class="line"></span><br><span class="line"><span class="comment">#安装jdk，无相关依赖包</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># dnf -y install jdk-8u241-linux-x64.rpm</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># java -version</span></span><br><span class="line">java version <span class="string">&quot;1.8.0_241&quot;</span></span><br><span class="line">Java(TM) SE Runtime Environment (build 1.8.0_241-b07)</span><br><span class="line">Java HotSpot(TM) 64-Bit Server VM (build 25.241-b07, mixed mode)</span><br><span class="line"></span><br><span class="line"><span class="comment">#初始化环境变量</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># vim /etc/profile.d/jdk.sh</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># cat /etc/profile.d/jdk.sh</span></span><br><span class="line"><span class="built_in">export</span> JAVA_HOME=/usr/java/default</span><br><span class="line"><span class="built_in">export</span> PATH=<span class="variable">$JAVA_HOME</span>/bin:<span class="variable">$PATH</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#以下两项非必须项</span></span><br><span class="line"><span class="built_in">export</span> JRE_HOME=<span class="variable">$JAVA_HOME</span>/jre   </span><br><span class="line"><span class="built_in">export</span> CLASSPATH=<span class="variable">$JAVA_HOME</span>/lib/:<span class="variable">$JRE_HOME</span>/lib/ </span><br><span class="line"></span><br><span class="line">[root@centos8 ~]<span class="comment"># . /etc/profile.d/jdk.sh</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#查看jdk信息</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># which java</span></span><br><span class="line">/usr/bin/java</span><br><span class="line">[root@centos8 ~]<span class="comment"># ll /usr/bin/java</span></span><br><span class="line">lrwxrwxrwx 1 root root 22 Feb  8 18:35 /usr/bin/java -&gt; /etc/alternatives/java</span><br><span class="line"></span><br><span class="line">[root@centos8 ~]<span class="comment"># ll /etc/alternatives/java</span></span><br><span class="line">lrwxrwxrwx 1 root root 41 Feb  8 18:35 /etc/alternatives/java -&gt; /usr/java/jdk1.8.0_241-amd64/jre/bin/java</span><br><span class="line"></span><br><span class="line">[root@centos8 ~]<span class="comment"># rpm -q --scripts jdk-8u241-linux-x64.rpm</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#查看到安装目录为/user/java下</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># rpm -ql jdk-8u241-linux-x64.rpm |less</span></span><br><span class="line">warning: jdk-8u241-linux-x64.rpm: Header V3 RSA/SHA256 Signature, key ID ec551f03: NOKEY</span><br><span class="line">/usr</span><br><span class="line">/usr/java</span><br><span class="line">/usr/java/jdk1.8.0_241-amd64</span><br><span class="line">/usr/java/jdk1.8.0_241-amd64/.java</span><br><span class="line">/usr/java/jdk1.8.0_241-amd64/.java/.systemPrefs</span><br><span class="line">/usr/java/jdk1.8.0_241-amd64/.java/.systemPrefs/.system.lock</span><br><span class="line">/usr/java/jdk1.8.0_241-amd64/.java/.systemPrefs/.systemRootModFile</span><br><span class="line">/usr/java/jdk1.8.0_241-amd64/.java/init.d</span><br><span class="line">......</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@centos8 ~]<span class="comment"># ll /usr/java/</span></span><br><span class="line">total 0</span><br><span class="line">lrwxrwxrwx 1 root root  16 Feb  8 18:35 default -&gt; /usr/java/latest</span><br><span class="line">drwxr-xr-x 8 root root 258 Feb  8 18:35 jdk1.8.0_241-amd64</span><br><span class="line">lrwxrwxrwx 1 root root  28 Feb  8 18:35 latest -&gt; /usr/java/jdk1.8.0_241-amd64</span><br></pre></td></tr></table></figure>

<h5 id="Oracle-JDK的二进制文件安装"><a href="#Oracle-JDK的二进制文件安装" class="headerlink" title="Oracle JDK的二进制文件安装"></a>Oracle JDK的二进制文件安装</h5><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#下载安装包：https://www.oracle.com/java/technologies/javase/javase-jdk8-downloads.html</span></span><br><span class="line"></span><br><span class="line">[root@centos8 ~]<span class="comment"># tar xvf jdk-8u241-linux-x64.tar.gz -C /usr/local/</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># cd /usr/local/</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># ln -s jdk1.8.0_241/ jdk</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#初始化环境变量</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># vim /etc/profile.d/jdk.sh</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># cat /etc/profile.d/jdk.sh </span></span><br><span class="line"><span class="built_in">export</span> JAVA_HOME=/usr/local/jdk</span><br><span class="line"><span class="built_in">export</span> PATH=<span class="variable">$PATH</span>:<span class="variable">$JAVA_HOME</span>/bin</span><br><span class="line"><span class="comment">#以下两项非必须项</span></span><br><span class="line"><span class="comment">#export JRE_HOME=$JAVA_HOME/jre </span></span><br><span class="line"><span class="comment">#export CLASSPATH=.:$JAVA_HOME/lib/:$JRE_HOME/lib/</span></span><br><span class="line"></span><br><span class="line">[root@centos8 ~]<span class="comment"># . /etc/profile.d/jdk.sh</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#注意:JAVA_HOME变量必须设置,否则tomcat启动时会出下面错误</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># catalina.sh</span></span><br><span class="line">Neither the JAVA_HOME nor the JRE_HOME environment variable is defined</span><br><span class="line">At least one of these environment variable is needed to run this program</span><br><span class="line"></span><br><span class="line">[root@centos8 ~]<span class="comment"># startup.sh </span></span><br><span class="line">Neither the JAVA_HOME nor the JRE_HOME environment variable is defined</span><br><span class="line">At least one of these environment variable is needed to run this program</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#验证安装</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># java -version</span></span><br><span class="line">java version <span class="string">&quot;1.8.0_241&quot;</span></span><br><span class="line">Java(TM) SE Runtime Environment (build 1.8.0_241-b07)</span><br><span class="line">Java HotSpot(TM) 64-Bit Server VM (build 25.241-b07, mixed mode)</span><br><span class="line"></span><br><span class="line">[root@centos8 ~]<span class="comment"># which java</span></span><br><span class="line">/usr/local/jdk/bin/java</span><br></pre></td></tr></table></figure>

<h5 id="一键安装二进制的JDK"><a href="#一键安装二进制的JDK" class="headerlink" title="一键安装二进制的JDK"></a>一键安装二进制的JDK</h5><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line">[root@ubuntu1804 ~]<span class="comment"># cat install_jdk.sh</span></span><br><span class="line"><span class="comment">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line">JDK_FILE=<span class="string">&quot;jdk-11.0.17_linux-x64_bin.tar.gz&quot;</span></span><br><span class="line"><span class="comment">#JDK_FILE=&quot;jdk-11.0.15.1_linux-x64_bin.tar.gz&quot;</span></span><br><span class="line"><span class="comment">#JDK_FILE=&quot;jdk-11.0.12_linux-x64_bin.tar.gz&quot;</span></span><br><span class="line"><span class="comment">#JDK_FILE=&quot;jdk-8u301-linux-x64.tar.gz&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">JDK_DIR=<span class="string">&quot;/usr/local&quot;</span></span><br><span class="line"></span><br><span class="line">DIR=`<span class="built_in">pwd</span>`</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">color</span></span> () &#123;</span><br><span class="line">    RES_COL=60</span><br><span class="line">    MOVE_TO_COL=<span class="string">&quot;echo -en \\033[<span class="variable">$&#123;RES_COL&#125;</span>G&quot;</span></span><br><span class="line">    SETCOLOR_SUCCESS=<span class="string">&quot;echo -en \\033[1;32m&quot;</span></span><br><span class="line">    SETCOLOR_FAILURE=<span class="string">&quot;echo -en \\033[1;31m&quot;</span></span><br><span class="line">    SETCOLOR_WARNING=<span class="string">&quot;echo -en \\033[1;33m&quot;</span></span><br><span class="line">    SETCOLOR_NORMAL=<span class="string">&quot;echo -en \E[0m&quot;</span></span><br><span class="line">    <span class="built_in">echo</span> -n <span class="string">&quot;<span class="variable">$2</span>&quot;</span> &amp;&amp; <span class="variable">$MOVE_TO_COL</span></span><br><span class="line">    <span class="built_in">echo</span> -n <span class="string">&quot;[&quot;</span></span><br><span class="line">    <span class="keyword">if</span> [ <span class="variable">$1</span> = <span class="string">&quot;success&quot;</span> -o <span class="variable">$1</span> = <span class="string">&quot;0&quot;</span> ] ;<span class="keyword">then</span></span><br><span class="line">        <span class="variable">$&#123;SETCOLOR_SUCCESS&#125;</span></span><br><span class="line">        <span class="built_in">echo</span> -n $<span class="string">&quot;  OK  &quot;</span>    </span><br><span class="line">    <span class="keyword">elif</span> [ <span class="variable">$1</span> = <span class="string">&quot;failure&quot;</span> -o <span class="variable">$1</span> = <span class="string">&quot;1&quot;</span>  ] ;<span class="keyword">then</span></span><br><span class="line">        <span class="variable">$&#123;SETCOLOR_FAILURE&#125;</span></span><br><span class="line">        <span class="built_in">echo</span> -n $<span class="string">&quot;FAILED&quot;</span></span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="variable">$&#123;SETCOLOR_WARNING&#125;</span></span><br><span class="line">        <span class="built_in">echo</span> -n $<span class="string">&quot;WARNING&quot;</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line">    <span class="variable">$&#123;SETCOLOR_NORMAL&#125;</span></span><br><span class="line">    <span class="built_in">echo</span> -n <span class="string">&quot;]&quot;</span></span><br><span class="line">    <span class="built_in">echo</span>                                                                                                                              </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">install_jdk</span></span>()&#123;</span><br><span class="line"><span class="keyword">if</span>   [ ! -f <span class="string">&quot;<span class="variable">$DIR</span>/<span class="variable">$JDK_FILE</span>&quot;</span> ];<span class="keyword">then</span></span><br><span class="line">	color 1  <span class="string">&quot;<span class="variable">$JDK_FILE</span> 文件不存在&quot;</span> </span><br><span class="line">	<span class="built_in">exit</span>; </span><br><span class="line"><span class="keyword">elif</span> [ -d <span class="variable">$JDK_DIR</span>/jdk ];<span class="keyword">then</span></span><br><span class="line">        color 1  <span class="string">&quot;JDK 已经安装&quot;</span> </span><br><span class="line">	<span class="built_in">exit</span></span><br><span class="line"><span class="keyword">else</span> </span><br><span class="line">    [ -d <span class="string">&quot;<span class="variable">$JDK_DIR</span>&quot;</span> ] || <span class="built_in">mkdir</span> -pv <span class="variable">$JDK_DIR</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line">tar xvf <span class="variable">$DIR</span>/<span class="variable">$JDK_FILE</span>  -C <span class="variable">$JDK_DIR</span></span><br><span class="line"><span class="built_in">cd</span>  <span class="variable">$JDK_DIR</span> &amp;&amp; <span class="built_in">ln</span> -s jdk* jdk </span><br><span class="line"></span><br><span class="line"><span class="built_in">cat</span> &gt;  /etc/profile.d/jdk.sh &lt;&lt;<span class="string">EOF</span></span><br><span class="line"><span class="string">export JAVA_HOME=$JDK_DIR/jdk</span></span><br><span class="line"><span class="string">export PATH=\$PATH:\$JAVA_HOME/bin</span></span><br><span class="line"><span class="string">#export JRE_HOME=\$JAVA_HOME/jre</span></span><br><span class="line"><span class="string">#export CLASSPATH=.:\$JAVA_HOME/lib/:\$JRE_HOME/lib/</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line">.  /etc/profile.d/jdk.sh</span><br><span class="line">java -version &amp;&amp; color 0  <span class="string">&quot;JDK 安装完成&quot;</span> || &#123; color 1  <span class="string">&quot;JDK 安装失败&quot;</span> ; <span class="built_in">exit</span>; &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">install_jdk</span><br></pre></td></tr></table></figure>

<h1 id="Tomcat-基础功能"><a href="#Tomcat-基础功能" class="headerlink" title="Tomcat 基础功能"></a>Tomcat 基础功能</h1><p><img src="../../../../images/SRE/day33/24.jpg" alt="24"></p>
<h2 id="Tomcat历史和介绍"><a href="#Tomcat历史和介绍" class="headerlink" title="Tomcat历史和介绍"></a>Tomcat历史和介绍</h2><h3 id="WEB应用服务器"><a href="#WEB应用服务器" class="headerlink" title="WEB应用服务器"></a>WEB应用服务器</h3><p><strong>Web 应用服务器的使用</strong></p>
<p>数据来源</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://www.baeldung.com/java-in-2019</span><br></pre></td></tr></table></figure>

<p><img src="../../../../images/SRE/day33/25.jpg" alt="25"></p>
<ul>
<li>商用：IBM WebSphere、Oracle WebLogic（原属于BEA公司）、Oracle Oc4j、RedHat JBoss等</li>
<li>开源：Tomcat、Jetty、Resin、Glassfish</li>
</ul>
<h3 id="Tomcat-介绍"><a href="#Tomcat-介绍" class="headerlink" title="Tomcat 介绍"></a>Tomcat 介绍</h3><p>Tomcat 服务器是一个免费的开放源代码的Web 应用服务器，属于轻量级应用服务器，在中小型系统和并发访问用户不是很多的场合下被普遍使用，Tomcat 具有处理HTML静态资源页面的功能，它还是一个Servlet和JSP容器</p>
<p>起始于SUN 公司的一个Servlet的参考实现项目 Java Web Server，开发者是 James Duncan Davidson，在1999年，将项目贡献给了apache软件基金会（ASF），和ASF现有的项目 JServ 合并，并 开源成为顶级项目</p>
<p>Tomcat 仅仅实现了Java EE规范中与Servlet、JSP相关的类库，是JavaEE不完整实现。</p>
<p>著名图书出版商O’Reilly约稿该项目成员Davidson希望使用一个公猫作为封面，但是公猫已经被使用，书出版后封面是一只雪豹。</p>
<p>《Tomcat权威指南》封面如下</p>
<p><img src="../../../../images/SRE/day33/26.jpg" alt="26"></p>
<p>1999年发布初始版本是Tomcat 3.0，实现了Servlet 2.2 和 JSP 1.1规范。</p>
<p>Tomcat 4.x发布时，内建了Catalina（Servlet容器）和 Jasper（JSP engine）等</p>
<p>当前 Tomcat 的正式版本已经更新到 9.0.x 版本，但当前企业中主流版本为 8.x 和 7.x </p>
<p>官网： <a target="_blank" rel="noopener" href="http://tomcat.apache.org/">http://tomcat.apache.org/</a></p>
<p>官网文档: <a target="_blank" rel="noopener" href="https://tomcat.apache.org/tomcat-8.5-doc/index.html">https://tomcat.apache.org/tomcat-8.5-doc/index.html</a></p>
<p>帮助文档: </p>
<p><a target="_blank" rel="noopener" href="https://cwiki.apache.org/confluence/display/tomcat/">https://cwiki.apache.org/confluence/display/tomcat/</a></p>
<p><a target="_blank" rel="noopener" href="https://cwiki.apache.org/confluence/display/tomcat/FAQ">https://cwiki.apache.org/confluence/display/tomcat/FAQ</a></p>
<h3 id="Tomcat-各版本区别"><a href="#Tomcat-各版本区别" class="headerlink" title="Tomcat 各版本区别"></a>Tomcat 各版本区别</h3><p>官方文档：<a target="_blank" rel="noopener" href="https://tomcat.apache.org/whichversion.html">https://tomcat.apache.org/whichversion.html</a></p>
<table>
<thead>
<tr>
<th align="left"><strong>Servlet Spec</strong></th>
<th align="left"><strong>JSP Spec</strong></th>
<th align="left"><strong>EL Spec</strong></th>
<th align="left"><strong>WebSocket Spec</strong></th>
<th align="center"><strong>Authentication Spec (JASPIC)</strong></th>
<th align="left"><strong>Apache Tomcat Version</strong></th>
<th align="left"><strong>Final<a target="_blank" rel="noopener" href="https://tomcat.apache.org/whichversion.html#final_release_note">1</a> Released Version</strong></th>
<th align="left"><strong>Supported Java Versions</strong></th>
<th align="left">EOL Date</th>
</tr>
</thead>
<tbody><tr>
<td align="left">5.0</td>
<td align="left">3.0</td>
<td align="left">4.0</td>
<td align="left">2.0</td>
<td align="center">2.0</td>
<td align="left">10.0.x (superseded)</td>
<td align="left">10.0.27 (superseded)</td>
<td align="left">8 and later</td>
<td align="left"><a target="_blank" rel="noopener" href="https://tomcat.apache.org/tomcat-10.0-eol.html">2022-10-31</a></td>
</tr>
<tr>
<td align="left">3.1</td>
<td align="left">2.3</td>
<td align="left">3.0</td>
<td align="left">1.1</td>
<td align="center">1.1</td>
<td align="left">8.5.x (<a target="_blank" rel="noopener" href="https://tomcat.apache.org/tomcat-85-eol.html">EOL</a>)</td>
<td align="left">8.5.100 (<a target="_blank" rel="noopener" href="https://tomcat.apache.org/tomcat-85-eol.html">EOL</a>)</td>
<td align="left">7 and later</td>
<td align="left"><a target="_blank" rel="noopener" href="https://tomcat.apache.org/tomcat-85-eol.html">2024-03-31</a></td>
</tr>
<tr>
<td align="left">3.1</td>
<td align="left">2.3</td>
<td align="left">3.0</td>
<td align="left">1.1</td>
<td align="center">N/A</td>
<td align="left">8.0.x (superseded)</td>
<td align="left">8.0.53 (superseded)</td>
<td align="left">7 and later</td>
<td align="left"><a target="_blank" rel="noopener" href="https://tomcat.apache.org/tomcat-80-eol.html">2018-06-30</a></td>
</tr>
<tr>
<td align="left">3.0</td>
<td align="left">2.2</td>
<td align="left">2.2</td>
<td align="left">1.1</td>
<td align="center">N/A</td>
<td align="left">7.0.x (archived)</td>
<td align="left">7.0.109 (archived)</td>
<td align="left">6 and later (7 and later for WebSocket)</td>
<td align="left"><a target="_blank" rel="noopener" href="https://tomcat.apache.org/tomcat-70-eol.html">2021-03-31</a></td>
</tr>
<tr>
<td align="left">2.5</td>
<td align="left">2.1</td>
<td align="left">2.1</td>
<td align="left">N/A</td>
<td align="center">N/A</td>
<td align="left">6.0.x (archived)</td>
<td align="left">6.0.53 (archived)</td>
<td align="left">5 and later</td>
<td align="left"><a target="_blank" rel="noopener" href="https://tomcat.apache.org/tomcat-60-eol.html">2016-12-31</a></td>
</tr>
<tr>
<td align="left">2.4</td>
<td align="left">2.0</td>
<td align="left">N/A</td>
<td align="left">N/A</td>
<td align="center">N/A</td>
<td align="left">5.5.x (archived)</td>
<td align="left">5.5.36 (archived)</td>
<td align="left">1.4 and later</td>
<td align="left"><a target="_blank" rel="noopener" href="https://tomcat.apache.org/tomcat-55-eol.html">2012-09-31</a></td>
</tr>
<tr>
<td align="left">2.3</td>
<td align="left">1.2</td>
<td align="left">N/A</td>
<td align="left">N/A</td>
<td align="center">N/A</td>
<td align="left">4.1.x (archived)</td>
<td align="left">4.1.40 (archived)</td>
<td align="left">1.3 and later</td>
<td align="left"><a target="_blank" rel="noopener" href="https://lists.apache.org/thread/v1ccn429s9lh32ypvwwhxo26zhh1965c">2009-06-25</a></td>
</tr>
<tr>
<td align="left">2.2</td>
<td align="left">1.1</td>
<td align="left">N/A</td>
<td align="left">N/A</td>
<td align="center">N/A</td>
<td align="left">3.3.x (archived)</td>
<td align="left">3.3.2 (archived)</td>
<td align="left">1.1 and later</td>
<td align="left"><a target="_blank" rel="noopener" href="https://lists.apache.org/thread/nw4vpbwgrn480gsvn06f4qj4yhoo89v7">2004-03-09</a></td>
</tr>
</tbody></table>
<h2 id="Tomcat-安装"><a href="#Tomcat-安装" class="headerlink" title="Tomcat 安装"></a>Tomcat 安装</h2><h3 id="基于包安装-Tomcat"><a href="#基于包安装-Tomcat" class="headerlink" title="基于包安装 Tomcat"></a>基于包安装 Tomcat</h3><h4 id="CentOS-包安装-tomcat"><a href="#CentOS-包安装-tomcat" class="headerlink" title="CentOS 包安装 tomcat"></a>CentOS 包安装 tomcat</h4><p>范例: Rocky 基于EPEL源安装 tomcat</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@rocky8 ~]<span class="comment"># yum list |grep tomcat</span></span><br><span class="line"></span><br><span class="line">[root@rocky8 ~]<span class="comment"># yum -y install tomcat tomcat-admin-webapps tomcat-docs-webapp tomcat-webapps</span></span><br><span class="line">[root@rocky8 ~]<span class="comment"># systemctl enable --now tomcat.service</span></span><br></pre></td></tr></table></figure>

<p><img src="../../../../images/SRE/day33/27.jpg" alt="27"></p>
<p>CentOS 8 包仓库中目前还没有提供tomcat相关包</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ~]<span class="comment"># yum list tomcat</span></span><br><span class="line">Last metadata expiration check: 1:25:35 ago on Wed 15 Jul 2020 09:01:28 AM CST.</span><br><span class="line">Error: No matching Packages to list</span><br></pre></td></tr></table></figure>

<p>CentOS 7 yum仓库源中自带的Tomcat 7.0版本安装，此方式安装tomcat版本较低，不推荐</p>
<p><strong>范例：在CentOS 7 上安装 tomcat</strong></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">[root@centos7 ~]<span class="comment"># yum list tomcat*</span></span><br><span class="line"></span><br><span class="line">[root@centos7 ~]<span class="comment"># yum -y install tomcat tomcat-webapps tomcat-admin-webapps tomcat-docs-webapp</span></span><br><span class="line">[root@centos7 ~]<span class="comment"># systemctl enable --now tomcat</span></span><br><span class="line">Created symlink from /etc/systemd/system/multi-user.target.wants/tomcat.service </span><br><span class="line">to /usr/lib/systemd/system/tomcat.service.</span><br><span class="line"></span><br><span class="line">[root@centos7 ~]<span class="comment"># ss -ntl</span></span><br><span class="line">LISTEN     0      1         [::ffff:127.0.0.1]:8005      [::]:*</span><br><span class="line">LISTEN     0      100                     [::]:8080      [::]:*</span><br><span class="line"></span><br><span class="line">[root@centos7 ~]<span class="comment"># getent passwd tomcat</span></span><br><span class="line">tomcat:x:53:53:Apache Tomcat:/usr/share/tomcat:/sbin/nologin</span><br><span class="line"></span><br><span class="line">[root@centos7 ~]<span class="comment"># ps aux|grep tomcat</span></span><br><span class="line">tomcat     1328  0.4 11.2 2298188 112004 ?     Ssl  21:32   0:11 /usr/lib/jvm/jre/bin/java -classpath</span><br><span class="line">···</span><br></pre></td></tr></table></figure>

<p>打开浏览器访问：<a target="_blank" rel="noopener" href="http://tomcat:8080/">http://tomcat:8080/</a></p>
<p><img src="../../../../images/SRE/day33/28.jpg" alt="28"></p>
<h4 id="Ubuntu-包安装-tomcat"><a href="#Ubuntu-包安装-tomcat" class="headerlink" title="Ubuntu 包安装 tomcat"></a>Ubuntu 包安装 tomcat</h4><p>范例: Ubuntu22.04 安装 tomcat9</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@ubuntu2204 ~]<span class="comment"># apt list |grep tomcat</span></span><br><span class="line">[root@ubuntu2204 ~]<span class="comment"># apt update;apt -y install tomcat9 tomcat9-admin tomcat9-docs tomcat9-examples</span></span><br><span class="line"></span><br><span class="line">[root@ubuntu2204 ~]<span class="comment"># ss -ntl</span></span><br><span class="line">LISTEN         0              100                    *:8080         *:* </span><br></pre></td></tr></table></figure>

<p><img src="../../../../images/SRE/day33/29.jpg" alt="29"></p>
<p>范例：Ubuntu20.04安装tomcat9</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@ubuntu2004 ~]<span class="comment"># apt update</span></span><br><span class="line">[root@ubuntu2004 ~]<span class="comment"># apt list tomcat*</span></span><br><span class="line">[root@ubuntu2004 ~]<span class="comment"># apt -y install tomcat9 tomcat9-admin tomcat9-docs tomcat9-examples</span></span><br></pre></td></tr></table></figure>

<p><img src="../../../../images/SRE/day33/30.jpg" alt="30"></p>
<p>范例: Ubuntu18.04安装 tomcat8</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@ubuntu1804 ~]<span class="comment"># apt update</span></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment"># apt -y install tomcat8 tomcat8-admin tomcat8-docs</span></span><br></pre></td></tr></table></figure>

<h3 id="二进制安装-Tomcat"><a href="#二进制安装-Tomcat" class="headerlink" title="二进制安装 Tomcat"></a>二进制安装 Tomcat</h3><p>CentOS 7 的yum源的tomcat版本老旧,而CentOS8 yum源里无tomcat 目前比较主流的Tomcat是8.5.X版本,推荐从Apache官网下载二进制tomcat包进行安装,此为生产常用方式</p>
<h4 id="下载并安装"><a href="#下载并安装" class="headerlink" title="下载并安装"></a>下载并安装</h4><p><strong>注意: 安装tomcat 前必须先部署JDK</strong></p>
<p>官方和镜像站点下载: </p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">https://tomcat.apache.org/download-80.cgi</span><br><span class="line">https://mirrors.tuna.tsinghua.edu.cn/apache/tomcat/</span><br></pre></td></tr></table></figure>

<p><img src="../../../../images/SRE/day33/31.jpg" alt="31"></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#安装Tomcat之前先安装Java</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#官网或镜像网站下载：</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># wget http://mirrors.tuna.tsinghua.edu.cn/apache/tomcat/tomcat-8/v8.5.50/bin/apache-tomcat-8.5.50.tar.gz</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># tar xf apache-tomcat-8.5.50.tar.gz -C /usr/local/</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># cd /usr/local/</span></span><br><span class="line">[root@centos8 <span class="built_in">local</span>]<span class="comment"># ln -s apache-tomcat-8.5.50/ tomcat</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#指定PATH变量</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># echo &#x27;PATH=/usr/local/tomcat/bin:$PATH&#x27; &gt; /etc/profile.d/tomcat.sh</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># . /etc/profile.d/tomcat.sh</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># echo $PATH</span></span><br><span class="line">/usr/local/tomcat/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/usr/local/jdk/bin:/root/bin</span><br><span class="line"></span><br><span class="line"><span class="comment">#查看当前变量设置和命令用法</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># catalina.sh</span></span><br><span class="line">Using CATALINA_BASE:   /usr/local/tomcat</span><br><span class="line">Using CATALINA_HOME:   /usr/local/tomcat</span><br><span class="line">Using CATALINA_TMPDIR: /usr/local/tomcat/temp</span><br><span class="line">Using JRE_HOME:        /usr/local/jdk</span><br><span class="line">Using CLASSPATH:       </span><br><span class="line">/usr/local/tomcat/bin/bootstrap.jar:/usr/local/tomcat/bin/tomcat-juli.jar</span><br><span class="line">Usage: catalina.sh ( commands ... )</span><br><span class="line">commands:</span><br><span class="line"> debug             Start Catalina <span class="keyword">in</span> a debugger</span><br><span class="line"> debug -security   Debug Catalina with a security manager</span><br><span class="line"> jpda start        Start Catalina under JPDA debugger</span><br><span class="line"> run               Start Catalina <span class="keyword">in</span> the current window</span><br><span class="line"> run -security     Start <span class="keyword">in</span> the current window with security manager</span><br><span class="line">  start            Start Catalina <span class="keyword">in</span> a separate window</span><br><span class="line">  start -security  Start <span class="keyword">in</span> a separate window with security manager</span><br><span class="line">  stop             Stop Catalina, waiting up to 5 seconds <span class="keyword">for</span> the process to end</span><br><span class="line">  stop n           Stop Catalina, waiting up to n seconds <span class="keyword">for</span> the process to end</span><br><span class="line">  stop -force      Stop Catalina, <span class="built_in">wait</span> up to 5 seconds and <span class="keyword">then</span> use <span class="built_in">kill</span> -KILL <span class="keyword">if</span> still running</span><br><span class="line">  stop n -force    Stop Catalina, <span class="built_in">wait</span> up to n seconds and <span class="keyword">then</span> use <span class="built_in">kill</span> -KILL <span class="keyword">if</span> still running</span><br><span class="line"> configtest       Run a basic syntax check on server.xml - check <span class="built_in">exit</span> code <span class="keyword">for</span></span><br><span class="line">result</span><br><span class="line"> version          What version of tomcat are you running?</span><br><span class="line">Note: Waiting <span class="keyword">for</span> the process to end and use of the -force option require that <span class="variable">$CATALINA_PID</span> is defined</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#查看环境变量和版本信息</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># catalina.sh version</span></span><br><span class="line">Using CATALINA_BASE:   /usr/local/tomcat</span><br><span class="line">Using CATALINA_HOME:   /usr/local/tomcat</span><br><span class="line">Using CATALINA_TMPDIR: /usr/local/tomcat/temp</span><br><span class="line">Using JRE_HOME:        /usr/local/jdk/jre</span><br><span class="line">Using CLASSPATH:       </span><br><span class="line">/usr/local/tomcat/bin/bootstrap.jar:/usr/local/tomcat/bin/tomcat-juli.jar</span><br><span class="line">Using CATALINA_OPTS:   </span><br><span class="line">Server version: Apache Tomcat/8.5.59</span><br><span class="line">Server built:   Oct 6 2020 16:57:18 UTC</span><br><span class="line">Server number:  8.5.59.0</span><br><span class="line">OS Name:        Linux</span><br><span class="line">OS Version:     4.18.0-193.el8.x86_64</span><br><span class="line">Architecture:   amd64</span><br><span class="line">JVM Version:    1.8.0_261-b12</span><br><span class="line">JVM Vendor:     Oracle Corporation</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#启动tomcat </span></span><br><span class="line">[root@centos8 ~]<span class="comment"># startup.sh </span></span><br><span class="line">Using CATALINA_BASE:   /usr/local/tomcat</span><br><span class="line">Using CATALINA_HOME:   /usr/local/tomcat</span><br><span class="line">Using CATALINA_TMPDIR: /usr/local/tomcat/temp</span><br><span class="line">Using JRE_HOME:        /usr/local/jdk/jre</span><br><span class="line">Using CLASSPATH:       </span><br><span class="line">/usr/local/tomcat/bin/bootstrap.jar:/usr/local/tomcat/bin/tomcat-juli.jar</span><br><span class="line">Tomcat started.</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#查看端口</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># ss -ntl</span></span><br><span class="line">State       Recv-Q Send-Q       Local Address:Port     Peer Address:Port     </span><br><span class="line">LISTEN      0      128                0.0.0.0:22            0.0.0.0:*         </span><br><span class="line">LISTEN      0      100                      *:8080                *:*         </span><br><span class="line">LISTEN      0      128                   [::]:22               [::]:*         </span><br><span class="line">LISTEN      0      1       [::ffff:127.0.0.1]:8005                *:*         </span><br><span class="line">LISTEN      0      100                      *:8009                *:*</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#查看进程是以root启动的</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># ps aux|grep tomcat</span></span><br><span class="line">root      12994 34.1  9.4 2155140 76912 pts/0   Sl   22:38   0:02 </span><br><span class="line">/usr/local/jdk/jre/bin/java</span><br><span class="line"></span><br><span class="line"><span class="comment">#关闭tomcat</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># shutdown.sh</span></span><br><span class="line">Using CATALINA_BASE:   /usr/local/tomcat</span><br><span class="line">Using CATALINA_HOME:   /usr/local/tomcat</span><br><span class="line">Using CATALINA_TMPDIR: /usr/local/tomcat/temp</span><br><span class="line">Using JRE_HOME:        /usr/local/jdk/jre</span><br><span class="line">Using CLASSPATH:       </span><br><span class="line">/usr/local/tomcat/bin/bootstrap.jar:/usr/local/tomcat/bin/tomcat-juli.jar</span><br><span class="line"></span><br><span class="line"><span class="comment">#或者以下也可以,指定10s后停止,默认5s</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># catalina.sh stop 10</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># ss -ntl</span></span><br><span class="line">State       Recv-Q       Send-Q             Local Address:Port        Peer Address:Port</span><br><span class="line">LISTEN       0             128                    0.0.0.0:22               0.0.0.0:*</span><br><span class="line">LISTEN       0             128                       [::]:22                  [::]:*</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#再次用不同方式启动tomcat </span></span><br><span class="line">[root@centos8 ~]<span class="comment"># catalina.sh start</span></span><br><span class="line">Using CATALINA_BASE:   /usr/local/tomcat</span><br><span class="line">Using CATALINA_HOME:   /usr/local/tomcat</span><br><span class="line">Using CATALINA_TMPDIR: /usr/local/tomcat/temp</span><br><span class="line">Using JRE_HOME:        /usr/local/jdk/jre</span><br><span class="line">Using CLASSPATH:       </span><br><span class="line">/usr/local/tomcat/bin/bootstrap.jar:/usr/local/tomcat/bin/tomcat-juli.jar</span><br><span class="line">Tomcat started.</span><br><span class="line"></span><br><span class="line">[root@centos8 ~]<span class="comment"># ss -ntl</span></span><br><span class="line">State       Recv-Q       Send-Q              Local Address:Port         Peer Address:Port</span><br><span class="line">LISTEN      0             128                      0.0.0.0:22                0.0.0.0:*</span><br><span class="line">LISTEN      0             100                            *:8080                    *:*</span><br><span class="line">LISTEN      0             128                         [::]:22                   [::]:*</span><br><span class="line">LISTEN      0             1             [::ffff:127.0.0.1]:8005                    *:*</span><br><span class="line">LISTEN      0             100                            *:8009                    *:*</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#再次用不同方式关闭tomcat </span></span><br><span class="line">[root@centos8 ~]<span class="comment"># catalina.sh stop</span></span><br><span class="line">Using CATALINA_BASE:   /usr/local/tomcat</span><br><span class="line">Using CATALINA_HOME:   /usr/local/tomcat</span><br><span class="line">Using CATALINA_TMPDIR: /usr/local/tomcat/temp</span><br><span class="line">Using JRE_HOME:       /usr/local/jdk/jre</span><br><span class="line">Using CLASSPATH:       </span><br><span class="line">/usr/local/tomcat/bin/bootstrap.jar:/usr/local/tomcat/bin/tomcat-juli.jar</span><br></pre></td></tr></table></figure>

<p>打开浏览器访问：<a target="_blank" rel="noopener" href="http://tomcat:8080/%EF%BC%8C%E6%AD%A3%E5%B8%B8%E5%8F%AF%E4%BB%A5%E7%9C%8B%E5%88%B0%E4%BB%A5%E4%B8%8B%E7%95%8C%E9%9D%A2">http://tomcat:8080/，正常可以看到以下界面</a></p>
<p><img src="../../../../images/SRE/day33/32.jpg" alt="32"></p>
<p><strong>扩展知识：tomcat 和 catalina 关系</strong></p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">Tomcat的servlet容器在4.X版本中被Craig McClanahan(Apache Struts项目的创始人,也是Tomcat </span><br><span class="line">的 Catalina 的架构师)重新设计为Catalina.即Catalina就是servlet容器。</span><br><span class="line"></span><br><span class="line">Tomcat的核心分为3个部分: </span><br><span class="line">（1）Web容器:处理静态页面；</span><br><span class="line">（2）JSP容器:把jsp页面翻译成一般的 servlet</span><br><span class="line">（3）catalina: 是一个servlet容器,用于处理servlet</span><br><span class="line"></span><br><span class="line">Catalina是美国西海岸靠近洛杉矶22英里的一个小岛，因为其风景秀丽而著名，曾被评为全美最漂亮的小</span><br><span class="line">岛。Servlet运行模块的最早开发者Craig McClanahan因为喜欢Catalina岛,故以Catalina命名他所开</span><br><span class="line">这个模块，另外在开发的早期阶段，Tomcat是被搭建在一个叫Avalon的服务器框架上，而Avalon则是</span><br><span class="line">Catalina岛上的一个小镇的名字，于是想一个与小镇名字相关联的单词也是自然而然。设计者估计是想把</span><br><span class="line">tomcat设计成最美的轻量级容器吧。下图为该小岛。</span><br></pre></td></tr></table></figure>

<p><img src="../../../../images/SRE/day33/33.jpg" alt="33"></p>
<h4 id="配置-tomcat-自启动的-service-文件"><a href="#配置-tomcat-自启动的-service-文件" class="headerlink" title="配置 tomcat 自启动的 service 文件"></a>配置 tomcat 自启动的 service 文件</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#创建tomcat专用帐户</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># useradd -r -s /sbin/nologin tomcat</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#准备service文件中相关环境文件</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># vim /usr/local/tomcat/conf/tomcat.conf</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># cat /usr/local/tomcat/conf/tomcat.conf</span></span><br><span class="line"><span class="comment">#两个变量至少设置一项才能启动 tomcat</span></span><br><span class="line">JAVA_HOME=/usr/local/jdk</span><br><span class="line"><span class="comment">#JRE_HOME=/usr/local/jdk/jre </span></span><br><span class="line"></span><br><span class="line"><span class="comment">#如果不指定上面变量,/var/log/messages文件中会出现下面无法启动错误提示</span></span><br><span class="line">Mar 15 14:30:09 centos8 startup.sh[1530]: Neither the JAVA_HOME nor the JRE_HOME environment variable is defined</span><br><span class="line">Mar 15 14:30:09 centos8 startup.sh[1530]: At least one of these environment variable is needed to run this program</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@centos8 ~]<span class="comment"># chown -R tomcat.tomcat /usr/local/tomcat/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#创建tomcat.service文件</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># vim /lib/systemd/system/tomcat.service</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># cat /lib/systemd/system/tomcat.service </span></span><br><span class="line">[Unit]</span><br><span class="line">Description=Tomcat</span><br><span class="line"><span class="comment">#After=syslog.target network.target remote-fs.target nss-lookup.target</span></span><br><span class="line">After=syslog.target network.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">Type=forking</span><br><span class="line"><span class="comment">#以下二选一</span></span><br><span class="line">EnvironmentFile=/usr/local/tomcat/conf/tomcat.conf</span><br><span class="line"><span class="comment">#或者，如果没有创建上面的/usr/local/tomcat/conf/tomcat.conf文件，可以加下面一行也可</span></span><br><span class="line">Environment=JAVA_HOME=/usr/local/jdk</span><br><span class="line">ExecStart=/usr/local/tomcat/bin/startup.sh</span><br><span class="line">ExecStop=/usr/local/tomcat/bin/shutdown.sh</span><br><span class="line">PrivateTmp=<span class="literal">true</span></span><br><span class="line">User=tomcat</span><br><span class="line">Group=tomcat</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@centos8 ~]<span class="comment"># systemctl daemon-reload</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># systemctl enable --now tomcat</span></span><br><span class="line">Created symlink /etc/systemd/system/multi-user.target.wants/tomcat.service → /usr/lib/systemd/system/tomcat.service.</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@centos8 ~]<span class="comment"># systemctl status tomcat</span></span><br><span class="line">● tomcat.service - Tomcat</span><br><span class="line">   Loaded: loaded (/usr/lib/systemd/system/tomcat.service; enabled; vendor preset: disabled)</span><br><span class="line">   Active: active (running) since Sat 2020-02-08 23:37:02 CST; 5s ago</span><br><span class="line"> Process: 14312 ExecStart=/usr/local/tomcat/bin/startup.sh (code=exited, status=0/SUCCESS)</span><br><span class="line"> Main PID: 14320 (java)</span><br><span class="line">   Tasks: 43 (<span class="built_in">limit</span>: 4895)</span><br><span class="line">   Memory: 64.2M</span><br><span class="line">   CGroup: /system.slice/tomcat.service</span><br><span class="line">           └─14320 /usr/local/jdk/jre/bin/java -</span><br><span class="line">           </span><br><span class="line">Djava.util.logging.config.file=/usr/local/tomcat/conf/logging&gt;</span><br><span class="line">Feb 08 23:37:02 centos8.localdomain systemd[1]: Starting Tomcat...</span><br><span class="line">Feb 08 23:37:02 centos8.localdomain systemd[1]: Started Tomcat.</span><br><span class="line"></span><br><span class="line"><span class="comment">#查看日志</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># tail /var/log/messages </span></span><br><span class="line">Mar 15 14:32:13 centos8 systemd[1]: Reloading.</span><br><span class="line">Mar 15 14:32:23 centos8 systemd[1]: Starting Tomcat...</span><br><span class="line">Mar 15 14:32:23 centos8 startup.sh[1575]: Tomcat started.</span><br><span class="line">Mar 15 14:32:23 centos8 systemd[1]: Started Tomcat.</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="实战案例：-一键安装-tomcat-脚本"><a href="#实战案例：-一键安装-tomcat-脚本" class="headerlink" title="实战案例： 一键安装 tomcat 脚本"></a>实战案例： 一键安装 tomcat 脚本</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">TOMCAT_VERSION=9.0.69</span><br><span class="line">JDK_VERSION=8u351</span><br><span class="line"></span><br><span class="line">TOMCAT_FILE=<span class="string">&quot;apache-tomcat-<span class="variable">$&#123;TOMCAT_VERSION&#125;</span>.tar.gz&quot;</span></span><br><span class="line"><span class="comment">#TOMCAT_FILE=&quot;apache-tomcat-9.0.69.tar.gz&quot;</span></span><br><span class="line"><span class="comment">#TOMCAT_FILE=&quot;apache-tomcat-9.0.64.tar.gz&quot;</span></span><br><span class="line"><span class="comment">#TOMCAT_FILE=&quot;apache-tomcat-9.0.59.tar.gz&quot;</span></span><br><span class="line"><span class="comment">#TOMCAT_FILE=&quot;apache-tomcat-8.5.64.tar.gz&quot;</span></span><br><span class="line"></span><br><span class="line">JDK_FILE=<span class="string">&quot;jdk-<span class="variable">$&#123;JDK_VERSION&#125;</span>-linux-x64.tar.gz&quot;</span></span><br><span class="line"><span class="comment">#JDK_FILE=&quot;jdk-8u351-linux-x64.tar.gz&quot;</span></span><br><span class="line"><span class="comment">#JDK_FILE=&quot;jdk-8u333-linux-x64.tar.gz&quot;</span></span><br><span class="line"><span class="comment">#JDK_FILE=&quot;jdk-8u281-linux-x64.tar.gz&quot;</span></span><br><span class="line"><span class="comment">#JDK_FILE=&quot;jdk-11.0.14_linux-x64_bin.tar.gz&quot;</span></span><br><span class="line"></span><br><span class="line">JDK_DIR=<span class="string">&quot;/usr/local&quot;</span></span><br><span class="line">TOMCAT_DIR=<span class="string">&quot;/usr/local&quot;</span></span><br><span class="line">DIR=`<span class="built_in">pwd</span>`</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">color</span></span> () &#123;</span><br><span class="line">    RES_COL=60</span><br><span class="line">    MOVE_TO_COL=<span class="string">&quot;echo -en \\033[<span class="variable">$&#123;RES_COL&#125;</span>G&quot;</span></span><br><span class="line">    SETCOLOR_SUCCESS=<span class="string">&quot;echo -en \\033[1;32m&quot;</span></span><br><span class="line">    SETCOLOR_FAILURE=<span class="string">&quot;echo -en \\033[1;31m&quot;</span></span><br><span class="line">    SETCOLOR_WARNING=<span class="string">&quot;echo -en \\033[1;33m&quot;</span></span><br><span class="line">    SETCOLOR_NORMAL=<span class="string">&quot;echo -en \E[0m&quot;</span></span><br><span class="line">    <span class="built_in">echo</span> -n <span class="string">&quot;<span class="variable">$2</span>&quot;</span> &amp;&amp; <span class="variable">$MOVE_TO_COL</span></span><br><span class="line">    <span class="built_in">echo</span> -n <span class="string">&quot;[&quot;</span></span><br><span class="line">    <span class="keyword">if</span> [ <span class="variable">$1</span> = <span class="string">&quot;success&quot;</span> -o <span class="variable">$1</span> = <span class="string">&quot;0&quot;</span> ] ;<span class="keyword">then</span></span><br><span class="line">        <span class="variable">$&#123;SETCOLOR_SUCCESS&#125;</span></span><br><span class="line">        <span class="built_in">echo</span> -n $<span class="string">&quot;  OK  &quot;</span>    </span><br><span class="line">    <span class="keyword">elif</span> [ <span class="variable">$1</span> = <span class="string">&quot;failure&quot;</span> -o <span class="variable">$1</span> = <span class="string">&quot;1&quot;</span>  ] ;<span class="keyword">then</span></span><br><span class="line">        <span class="variable">$&#123;SETCOLOR_FAILURE&#125;</span></span><br><span class="line">        <span class="built_in">echo</span> -n $<span class="string">&quot;FAILED&quot;</span></span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="variable">$&#123;SETCOLOR_WARNING&#125;</span></span><br><span class="line">        <span class="built_in">echo</span> -n $<span class="string">&quot;WARNING&quot;</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line">    <span class="variable">$&#123;SETCOLOR_NORMAL&#125;</span></span><br><span class="line">    <span class="built_in">echo</span> -n <span class="string">&quot;]&quot;</span></span><br><span class="line">    <span class="built_in">echo</span>                                                                                                                              </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">install_jdk</span></span>()&#123;</span><br><span class="line"><span class="keyword">if</span>  [ ! -f <span class="string">&quot;<span class="variable">$DIR</span>/<span class="variable">$JDK_FILE</span>&quot;</span> ];<span class="keyword">then</span></span><br><span class="line">    color 1 <span class="string">&quot;<span class="variable">$JDK_FILE</span> 文件不存在&quot;</span> </span><br><span class="line">    <span class="built_in">exit</span>; </span><br><span class="line"><span class="keyword">elif</span> [ -d <span class="variable">$JDK_DIR</span>/jdk ];<span class="keyword">then</span></span><br><span class="line">    color 1  <span class="string">&quot;JDK 已经安装&quot;</span> </span><br><span class="line">    <span class="built_in">exit</span></span><br><span class="line"><span class="keyword">else</span> </span><br><span class="line">    [ -d <span class="string">&quot;<span class="variable">$JDK_DIR</span>&quot;</span> ] || <span class="built_in">mkdir</span> -pv <span class="variable">$JDK_DIR</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line">tar xvf <span class="variable">$DIR</span>/<span class="variable">$JDK_FILE</span>  -C <span class="variable">$JDK_DIR</span></span><br><span class="line"><span class="built_in">cd</span>  <span class="variable">$JDK_DIR</span> &amp;&amp; <span class="built_in">ln</span> -s jdk* jdk </span><br><span class="line"></span><br><span class="line"><span class="built_in">cat</span> &gt;  /etc/profile.d/jdk.sh &lt;&lt;<span class="string">EOF</span></span><br><span class="line"><span class="string">export JAVA_HOME=$JDK_DIR/jdk</span></span><br><span class="line"><span class="string">export PATH=\$PATH:\$JAVA_HOME/bin</span></span><br><span class="line"><span class="string">#export JRE_HOME=\$JAVA_HOME/jre</span></span><br><span class="line"><span class="string">#export CLASSPATH=.:\$JAVA_HOME/lib/:\$JRE_HOME/lib/</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line">.  /etc/profile.d/jdk.sh</span><br><span class="line">java -version &amp;&amp; color 0 <span class="string">&quot;JDK 安装完成&quot;</span> || &#123; color 1  <span class="string">&quot;JDK 安装失败&quot;</span> ; <span class="built_in">exit</span>; &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">install_tomcat</span></span>()&#123;</span><br><span class="line"><span class="keyword">if</span> ! [ -f <span class="string">&quot;<span class="variable">$DIR</span>/<span class="variable">$TOMCAT_FILE</span>&quot;</span> ];<span class="keyword">then</span></span><br><span class="line">    color 1 <span class="string">&quot;<span class="variable">$TOMCAT_FILE</span> 文件不存在&quot;</span> </span><br><span class="line">    <span class="built_in">exit</span>; </span><br><span class="line"><span class="keyword">elif</span> [ -d <span class="variable">$TOMCAT_DIR</span>/tomcat ];<span class="keyword">then</span></span><br><span class="line">    color 1 <span class="string">&quot;TOMCAT 已经安装&quot;</span> </span><br><span class="line">    <span class="built_in">exit</span></span><br><span class="line"><span class="keyword">else</span> </span><br><span class="line">    [ -d <span class="string">&quot;<span class="variable">$TOMCAT_DIR</span>&quot;</span> ] || <span class="built_in">mkdir</span> -pv <span class="variable">$TOMCAT_DIR</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line">tar xf <span class="variable">$DIR</span>/<span class="variable">$TOMCAT_FILE</span> -C <span class="variable">$TOMCAT_DIR</span></span><br><span class="line"><span class="built_in">cd</span>  <span class="variable">$TOMCAT_DIR</span> &amp;&amp; <span class="built_in">ln</span> -s apache-tomcat-*/  tomcat</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;PATH=<span class="variable">$TOMCAT_DIR</span>/tomcat/bin:&quot;</span><span class="string">&#x27;$PATH&#x27;</span> &gt; /etc/profile.d/tomcat.sh</span><br><span class="line"><span class="built_in">id</span> tomcat &amp;&gt; /dev/null || useradd -r -s /sbin/nologin tomcat</span><br><span class="line"></span><br><span class="line"><span class="built_in">cat</span> &gt; <span class="variable">$TOMCAT_DIR</span>/tomcat/conf/tomcat.conf &lt;&lt;<span class="string">EOF</span></span><br><span class="line"><span class="string">JAVA_HOME=$JDK_DIR/jdk</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">chown</span> -R tomcat.tomcat <span class="variable">$TOMCAT_DIR</span>/tomcat/</span><br><span class="line"></span><br><span class="line"><span class="built_in">cat</span> &gt; /lib/systemd/system/tomcat.service  &lt;&lt;<span class="string">EOF</span></span><br><span class="line"><span class="string">[Unit]</span></span><br><span class="line"><span class="string">Description=Tomcat</span></span><br><span class="line"><span class="string">#After=syslog.target network.target remote-fs.target nss-lookup.target</span></span><br><span class="line"><span class="string">After=syslog.target network.target </span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">[Service]</span></span><br><span class="line"><span class="string">Type=forking</span></span><br><span class="line"><span class="string">EnvironmentFile=$TOMCAT_DIR/tomcat/conf/tomcat.conf</span></span><br><span class="line"><span class="string">ExecStart=$TOMCAT_DIR/tomcat/bin/startup.sh</span></span><br><span class="line"><span class="string">ExecStop=$TOMCAT_DIR/tomcat/bin/shutdown.sh</span></span><br><span class="line"><span class="string">RestartSec=3</span></span><br><span class="line"><span class="string">PrivateTmp=true</span></span><br><span class="line"><span class="string">User=tomcat</span></span><br><span class="line"><span class="string">Group=tomcat</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">[Install]</span></span><br><span class="line"><span class="string">WantedBy=multi-user.target</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line">systemctl daemon-reload</span><br><span class="line">systemctl <span class="built_in">enable</span> --now tomcat.service &amp;&gt; /dev/null</span><br><span class="line">systemctl is-active tomcat.service &amp;&gt; /dev/null &amp;&amp;  color 0 <span class="string">&quot;TOMCAT 安装完成&quot;</span> || &#123; color 1 <span class="string">&quot;TOMCAT 安装失败&quot;</span> ; <span class="built_in">exit</span>; &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">install_jdk </span><br><span class="line"></span><br><span class="line">install_tomcat</span><br></pre></td></tr></table></figure>

<h2 id="Tomcat-的文件结构和组成"><a href="#Tomcat-的文件结构和组成" class="headerlink" title="Tomcat 的文件结构和组成"></a>Tomcat 的文件结构和组成</h2><h3 id="目录结构"><a href="#目录结构" class="headerlink" title="目录结构"></a>目录结构</h3><table>
<thead>
<tr>
<th>目录</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>bin</td>
<td>服务启动、停止等相关程序和文件</td>
</tr>
<tr>
<td><strong>conf</strong></td>
<td>配置文件</td>
</tr>
<tr>
<td>lib</td>
<td>库目录</td>
</tr>
<tr>
<td>logs</td>
<td>日志目录</td>
</tr>
<tr>
<td><strong>webapps</strong></td>
<td>应用程序，应用部署目录</td>
</tr>
<tr>
<td>work</td>
<td>jsp编译后的结果文件，建议提前预热访问，升级应用后，删除此目录数据才能更新</td>
</tr>
</tbody></table>
<p><img src="../../../../images/SRE/day33/34.jpg" alt="34"></p>
<p>范例：查看tomcat相关目录和文件</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 tomcat]<span class="comment"># pwd</span></span><br><span class="line">/usr/local/tomcat</span><br><span class="line"></span><br><span class="line">[root@centos8 tomcat]<span class="comment"># ls</span></span><br><span class="line">bin          conf            lib     logs   README.md     RUNNING.txt  webapps</span><br><span class="line">BUILDING.txt CONTRIBUTING.md LICENSE NOTICE RELEASE-NOTES temp         work</span><br><span class="line"></span><br><span class="line">[root@centos8 tomcat]<span class="comment"># ls bin</span></span><br><span class="line">bootstrap.jar       commons-daemon-native.tar.gz  makebase.sh       tomcat-juli.jar</span><br><span class="line">catalina.bat        configtest.bat                setclasspath.bat  tomcat-native.tar.gz</span><br><span class="line">catalina.sh         configtest.sh                 setclasspath.sh   tool-wrapper.bat</span><br><span class="line">catalina-tasks.xml  daemon.sh                     shutdown.bat      tool-wrapper.sh</span><br><span class="line">ciphers.bat         digest.bat                    shutdown.sh       version.bat</span><br><span class="line">ciphers.sh          digest.sh                     startup.bat       version.sh</span><br><span class="line">commons-daemon.jar  makebase.bat                  startup.sh</span><br><span class="line"></span><br><span class="line">[root@centos8 tomcat]<span class="comment"># ls conf</span></span><br><span class="line">Catalina             context.xml           logging.properties  tomcat-users.xml</span><br><span class="line">catalina.policy      jaspic-providers.xml  server.xml          tomcat-users.xsd</span><br><span class="line">catalina.properties  jaspic-providers.xsd  tomcat.conf         web.xml</span><br><span class="line"></span><br><span class="line">[root@centos8 tomcat]<span class="comment"># ls lib</span></span><br><span class="line">annotations-api.jar       jasper-el.jar          tomcat-i18n-cs.jar     tomcat-jdbc.jar</span><br><span class="line">catalina-ant.jar          jasper.jar             tomcat-i18n-de.jar     tomcat-jni.jar</span><br><span class="line">catalina-ha.jar           jaspic-api.jar         tomcat-i18n-es.jar     tomcat-util.jar</span><br><span class="line">catalina.jar              jsp-api.jar            tomcat-i18n-fr.jar     tomcat-util-scan.jar</span><br><span class="line">catalina-ssi.jar          servlet-api.jar        tomcat-i18n-ja.jar     tomcat-websocket.jar</span><br><span class="line">catalina-storeconfig.jar  tomcat-api.jar         tomcat-i18n-ko.jar     websocket-api.jar</span><br><span class="line">catalina-tribes.jar       tomcat-coyote-ffm.jar  tomcat-i18n-pt-BR.jar</span><br><span class="line">ecj-4.20.jar              tomcat-coyote.jar      tomcat-i18n-ru.jar</span><br><span class="line">el-api.jar                tomcat-dbcp.jar        tomcat-i18n-zh-CN.jar</span><br><span class="line"></span><br><span class="line">[root@centos8 tomcat]<span class="comment"># ls logs</span></span><br><span class="line">catalina.2025-03-05.log  host-manager.2025-03-05.log  localhost_access_log.2025-03-05.txt</span><br><span class="line">catalina.out             localhost.2025-03-05.log     manager.2025-03-05.log</span><br><span class="line"></span><br><span class="line">[root@centos8 tomcat]<span class="comment"># ls webapps/</span></span><br><span class="line">docs examples host-manager manager ROOT</span><br><span class="line"></span><br><span class="line">[root@centos8 tomcat]<span class="comment"># ls work/</span></span><br><span class="line">Catalina</span><br><span class="line"></span><br><span class="line">[root@centos8 tomcat]<span class="comment"># ls work/Catalina/</span></span><br><span class="line">localhost</span><br><span class="line"></span><br><span class="line">[root@centos8 tomcat]<span class="comment"># ls work/Catalina/localhost/</span></span><br><span class="line">docs examples host-manager manager ROOT</span><br><span class="line"></span><br><span class="line">[root@centos8 tomcat]<span class="comment"># ll -i work/Catalina/localhost/</span></span><br><span class="line">total 0</span><br><span class="line"> 68039883 drwxr-x--- 2 tomcat tomcat 6 Feb  9 11:02 docs</span><br><span class="line">135579640 drwxr-x--- 2 tomcat tomcat 6 Feb  9 11:02 examples</span><br><span class="line">202681358 drwxr-x--- 2 tomcat tomcat 6 Feb  9 11:02 host-manager</span><br><span class="line">   571365 drwxr-x--- 2 tomcat tomcat 6 Feb  9 11:02 manager</span><br><span class="line">   571364 drwxr-x--- 2 tomcat tomcat 6 Feb  9 11:02 ROOT</span><br><span class="line">   </span><br><span class="line">[root@centos8 tomcat]<span class="comment"># ll -i webapps/</span></span><br><span class="line">total 4</span><br><span class="line">202681088 drwxr-x--- 15 tomcat tomcat 4096 Feb  9 11:02 docs</span><br><span class="line">202681094 drwxr-x---  6 tomcat tomcat   83 Feb  9 11:02 examples</span><br><span class="line">   571165 drwxr-x---  5 tomcat tomcat   87 Feb  9 11:02 host-manager</span><br><span class="line"> 68039687 drwxr-x---  5 tomcat tomcat  103 Feb  9 11:02 manager</span><br><span class="line"> 68039663 drwxr-x---  3 tomcat tomcat  283 Feb  9 11:02 ROOT</span><br><span class="line"> </span><br><span class="line">[root@centos8 tomcat]<span class="comment"># tree work/Catalina/localhost/</span></span><br><span class="line">work/Catalina/localhost/</span><br><span class="line">├── docs</span><br><span class="line">├── examples</span><br><span class="line">├── host-manager</span><br><span class="line">├── manager</span><br><span class="line">└── ROOT</span><br><span class="line"></span><br><span class="line">5 directories, 0 files</span><br><span class="line"></span><br><span class="line">[root@centos8 tomcat]<span class="comment"># curl http://10.0.0.8:8080/</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#当访问过后，work目录中生成新文件</span></span><br><span class="line">[root@centos8 tomcat]<span class="comment"># tree work/Catalina/localhost/</span></span><br><span class="line">work/Catalina/localhost/</span><br><span class="line">├── docs</span><br><span class="line">├── examples</span><br><span class="line">├── host-manager</span><br><span class="line">├── manager</span><br><span class="line">└── ROOT</span><br><span class="line">   └── org</span><br><span class="line">       └── apache</span><br><span class="line">           └── jsp</span><br><span class="line">               ├── index_jsp.class <span class="comment">#字节码文件</span></span><br><span class="line">               └── index_jsp.java  <span class="comment">#servlet文件</span></span><br><span class="line">              </span><br><span class="line">8 directories, 2 files</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#tomcat会自动的将jsp文件生成java源文件，再编译成class文件</span></span><br><span class="line">[root@centos8 tomcat]<span class="comment"># less </span></span><br><span class="line">work/Catalina/localhost/ROOT/org/apache/jsp/index_jsp.java</span><br><span class="line">/*</span><br><span class="line"> * Generated by the Jasper component of Apache Tomcat</span><br><span class="line"> * Version: Apache Tomcat/8.5.50</span><br><span class="line"> * Generated at: 2020-02-09 03:20:20 UTC</span><br><span class="line"> * Note: The last modified time of this file was <span class="built_in">set</span> to</span><br><span class="line"> *       the last modified time of the <span class="built_in">source</span> file after</span><br><span class="line"> *       generation to assist with modification tracking.</span><br><span class="line"> */</span><br><span class="line">package org.apache.jsp;</span><br><span class="line">import javax.servlet.*;</span><br><span class="line">import javax.servlet.http.*;</span><br><span class="line">import javax.servlet.jsp.*;</span><br><span class="line">public final class index_jsp extends org.apache.jasper.runtime.HttpJspBase</span><br><span class="line">   implements org.apache.jasper.runtime.JspSourceDependent,</span><br><span class="line">                 org.apache.jasper.runtime.JspSourceImports &#123;</span><br><span class="line"> private static final javax.servlet.jsp.JspFactory _jspxFactory =</span><br><span class="line">         javax.servlet.jsp.JspFactory.getDefaultFactory();</span><br><span class="line"> private static java.util.Map&lt;java.lang.String,java.lang.Long&gt; </span><br><span class="line">_jspx_dependants;</span><br></pre></td></tr></table></figure>

<h3 id="配置文件"><a href="#配置文件" class="headerlink" title="配置文件"></a>配置文件</h3><h4 id="配置文件说明"><a href="#配置文件说明" class="headerlink" title="配置文件说明"></a>配置文件说明</h4><p>官方帮助文档：<a target="_blank" rel="noopener" href="http://tomcat.apache.org/tomcat-8.5-doc/index.html">http://tomcat.apache.org/tomcat-8.5-doc/index.html</a></p>
<p>在tomcat安装目录下的 conf 子目录中，有以下的 tomcat 的配置文件</p>
<table>
<thead>
<tr>
<th>文件名</th>
<th><strong>说明</strong></th>
</tr>
</thead>
<tbody><tr>
<td><strong>server.xml</strong></td>
<td><strong>主配置文件</strong></td>
</tr>
<tr>
<td><strong>web.xml</strong></td>
<td>每个webapp只有“部署”后才能被访问，它的部署方式通常由web.xml进行定义，其存放位置为WEB-INF/目录中；此文件为所有的webapps提供默认部署相关的配置,每个web应用也可以使用专用配置文件,来覆盖全局文件</td>
</tr>
<tr>
<td><strong>context.xml</strong></td>
<td>用于定义所有web应用均需加载的Context配置，此文件为所有的webapps提供默认配置，每个web应用也可以使用自已专用的配置，它通常由专用的配置文件context.xml来定义，其存放位置为WEB-INF/目录中,覆盖全局的文件</td>
</tr>
<tr>
<td>tomcat-users.xml</td>
<td>用户认证的账号和密码文件</td>
</tr>
<tr>
<td>catalina.policy</td>
<td>当使用security选项启动tomcat时，用于为tomcat设置安全策略</td>
</tr>
<tr>
<td>catalina.properties</td>
<td>Tomcat 环境变量的配置，用于设定类加载器路径，以及一些与JVM调优相关参数</td>
</tr>
<tr>
<td>logging.properties</td>
<td>Tomcat 日志系统相关的配置，可以修改日志级别和日志路径等</td>
</tr>
</tbody></table>
<p><strong>注意：配置文件大小写敏感</strong></p>
<p>范例：查看配置文件</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 conf]<span class="comment"># pwd</span></span><br><span class="line">/usr/local/tomcat/conf</span><br><span class="line"></span><br><span class="line">[root@centos8 conf]<span class="comment"># ls</span></span><br><span class="line">Catalina             context.xml           logging.properties tomcat-users.xml</span><br><span class="line">catalina.policy     jaspic-providers.xml server.xml         tomcat-users.xsd</span><br><span class="line">catalina.properties jaspic-providers.xsd tomcat.conf         web.xml</span><br><span class="line"></span><br><span class="line">[root@centos8 conf]<span class="comment"># wc -l server.xml web.xml context.xml tomcat-users.xml catalina.policy catalina.properties logging.properties </span></span><br><span class="line">   167 server.xml</span><br><span class="line">  4726 web.xml</span><br><span class="line">    30 context.xml</span><br><span class="line">    44 tomcat-users.xml</span><br><span class="line">   271 catalina.policy</span><br><span class="line">   214 catalina.properties</span><br><span class="line">    75 logging.properties</span><br><span class="line">  5527 total</span><br></pre></td></tr></table></figure>

<h4 id="日志文件"><a href="#日志文件" class="headerlink" title="日志文件"></a>日志文件</h4><p>参考文档: <a target="_blank" rel="noopener" href="https://cwiki.apache.org/confluence/display/TOMCAT/Logging">https://cwiki.apache.org/confluence/display/TOMCAT/Logging</a></p>
<p>日志格式: <a target="_blank" rel="noopener" href="https://tomcat.apache.org/tomcat-9.0-doc/config/valve.html#Access_Logging">https://tomcat.apache.org/tomcat-9.0-doc/config/valve.html#Access_Logging</a></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">%a - 远程 IP 地址。 另请参阅下文。%&#123;xxx&#125;a</span><br><span class="line">%A - 本地 IP 地址</span><br><span class="line">%b - 发送的字节数，不包括 HTTP 标头，如果为零，则为“-”</span><br><span class="line">%B - 发送的字节数，不包括 HTTP 标头</span><br><span class="line">%D - 处理请求所用的时间（以毫秒为单位）。注意：在 httpd %D 是微秒。行为将与 httpd 保持一致 在 Tomcat 10 及更高版本中。</span><br><span class="line">%F - 提交响应所用的时间（以毫秒为单位）</span><br><span class="line">%h - 远程主机名（如果连接器为 <span class="literal">false</span>，则为 IP 地址）enableLookups</span><br><span class="line">%H - 请求协议</span><br><span class="line">%I - 当前请求线程名称（稍后可以与堆栈跟踪进行比较）</span><br><span class="line">%l - 来自 identd 的远程逻辑用户名（始终返回 <span class="string">&#x27;-&#x27;</span>)</span><br><span class="line">%m - 请求方法（GET、POST 等）</span><br><span class="line">%p - 收到此请求的本地端口。 另请参阅下文。%&#123;xxx&#125;p</span><br><span class="line">%q - 查询字符串（如果存在，则以 <span class="string">&#x27;？&#x27;</span> 开头）</span><br><span class="line">%r - 请求的第一行（方法和请求 URI）</span><br><span class="line">%s - 响应的 HTTP 状态代码</span><br><span class="line">%s - 用户会话 ID</span><br><span class="line">%t - 日期和时间，采用通用日志格式</span><br><span class="line">%T - 处理请求所用的时间（以秒为单位）。注意：这个 值具有毫秒级分辨率，而在 httpd 中，它具有 第二个分辨率。行为将与 httpd 保持一致 在 Tomcat 10 及更高版本中。</span><br><span class="line">%u - 已验证的远程用户（如果有），否则为“-”（如果需要，则转义）</span><br><span class="line">%U - 请求的 URL 路径</span><br><span class="line">%v - 本地服务器名称</span><br><span class="line">%X - 响应完成时的连接状态：</span><br><span class="line">     X= 连接在响应完成之前中止。</span><br><span class="line">     += 发送响应后，连接可能会保持活动状态。</span><br><span class="line">     -= 发送响应后，连接将关闭。</span><br><span class="line"></span><br><span class="line">%&#123;xxx&#125;a 写入远程地址（客户端）（） 或 连接对等体地址 （xxx==remotexxx=peer)</span><br><span class="line">%&#123;xxx&#125;我写入带有 name 的传入标头的值（如果需要，请转义）xxx</span><br><span class="line">%&#123;xxx&#125;o 写入带有 name 的传出标头的值（如果需要，请转义）xxx</span><br><span class="line">%&#123;xxx&#125;c 写入名称为 （如果需要，请以逗号分隔和转义）xxx</span><br><span class="line">%&#123;xxx&#125;r 写入带有 name 的 ServletRequest 属性的值（如果需要，则转义，如果 request 为 null，则为 value）xxx??</span><br><span class="line">%&#123;xxx&#125;s 写入带有 name 的 HttpSession 属性的值（如果需要，则转义，如果 request 为 null，则为 value）xxx??</span><br><span class="line">%&#123;xxx&#125;p 写入本地（服务器）端口 （） 或 远程（客户端）端口 （xxx==localxxx=remote)</span><br><span class="line">%&#123;xxx&#125;t 写入时间戳，并使用 增强的 SimpleDateFormat 模式xxx</span><br></pre></td></tr></table></figure>

<p>范例: tomcat的访问日志格式</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#查看访问日志格式</span></span><br><span class="line">[root@centos8 ~]<span class="comment">#tail /usr/local/tomcat/conf/server.xml </span></span><br><span class="line">             Documentation at: /docs/config/valve.html</span><br><span class="line">             Note: The pattern used is equivalent to using pattern=<span class="string">&quot;common&quot;</span> --&gt;</span><br><span class="line">       &lt;Valve className=<span class="string">&quot;org.apache.catalina.valves.AccessLogValve&quot;</span> directory=<span class="string">&quot;logs&quot;</span></span><br><span class="line">               prefix=<span class="string">&quot;localhost_access_log&quot;</span> suffix=<span class="string">&quot;.txt&quot;</span></span><br><span class="line">               pattern=<span class="string">&quot;%h %l %u %t &amp;quot;%r&amp;quot; %s %b&quot;</span> /&gt;   <span class="comment">#说明: &amp;quot;在html中表示双引号&quot;符号</span></span><br><span class="line">     &lt;/Host&gt;</span><br><span class="line">   &lt;/Engine&gt;</span><br><span class="line"> &lt;/Service&gt;</span><br><span class="line">&lt;/Server&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#查看访问日志</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># tail /usr/local/tomcat/logs/localhost_access_log.2020-07-14.txt</span></span><br><span class="line">10.0.0.1 - - [14/Jul/2020:09:08:46 +0800] <span class="string">&quot;GET / HTTP/1.1&quot;</span> 200 11215</span><br><span class="line">10.0.0.1 - - [14/Jul/2020:09:08:46 +0800] <span class="string">&quot;GET /tomcat.css HTTP/1.1&quot;</span> 200 5581</span><br><span class="line">10.0.0.1 - - [14/Jul/2020:09:08:46 +0800] <span class="string">&quot;GET /tomcat.png HTTP/1.1&quot;</span> 200 5103</span><br><span class="line">10.0.0.1 - - [14/Jul/2020:09:08:46 +0800] <span class="string">&quot;GET /bg-nav.png HTTP/1.1&quot;</span> 200 1401</span><br><span class="line">10.0.0.1 - - [14/Jul/2020:09:08:46 +0800] <span class="string">&quot;GET /bg-upper.png HTTP/1.1&quot;</span> 200 3103</span><br><span class="line">10.0.0.1 - - [14/Jul/2020:09:08:46 +0800] <span class="string">&quot;GET /asf-logo-wide.svg HTTP/1.1&quot;</span> 200 27235</span><br><span class="line">10.0.0.1 - - [14/Jul/2020:09:08:46 +0800] <span class="string">&quot;GET /bg-middle.png HTTP/1.1&quot;</span> 200 1918</span><br><span class="line">10.0.0.1 - - [14/Jul/2020:09:08:46 +0800] <span class="string">&quot;GET /bg-button.png HTTP/1.1&quot;</span> 200 713</span><br><span class="line">10.0.0.1 - - [14/Jul/2020:09:08:46 +0800] <span class="string">&quot;GET /favicon.ico HTTP/1.1&quot;</span> 200 21630</span><br></pre></td></tr></table></figure>

<p>范例: tomcat日志实现json格式的访问日志</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ~]<span class="comment"># vim /usr/local/tomcat/conf/server.xml</span></span><br><span class="line">.......</span><br><span class="line">&lt;Valve className=<span class="string">&quot;org.apache.catalina.valves.AccessLogValve&quot;</span> directory=<span class="string">&quot;logs&quot;</span></span><br><span class="line">               prefix=<span class="string">&quot;localhost_access_log&quot;</span> suffix=<span class="string">&quot;.txt&quot;</span></span><br><span class="line"><span class="comment">########################添加下面一行,注意是一行,不要换行#####################################</span></span><br><span class="line">pattern=<span class="string">&quot;&#123;&amp;quot;clientip&amp;quot;:&amp;quot;%h&amp;quot;,&amp;quot;ClientUser&amp;quot;:&amp;quot;%l&amp;quot;,&amp;quot;authenticated&amp;quot;:&amp;quot;%u&amp;quot;,&amp;quot;AccessTime&amp;quot;:&amp;quot;%t&amp;quot;,&amp;quot;method&amp;quot;:&amp;quot;%r&amp;quot;,&amp;quot;status&amp;quot;:&amp;quot;%s&amp;quot;,&amp;quot;SendBytes&amp;quot;:&amp;quot;%b&amp;quot;,&amp;quot;Query?string&amp;quot;:&amp;quot;%q&amp;quot;,&amp;quot;partner&amp;quot;:&amp;quot;%&#123;Referer&#125;i&amp;quot;,&amp;quot;AgentVersion&amp;quot;:&amp;quot;%&#123;User-Agent&#125;i&amp;quot;&#125;&quot;</span>/&gt;</span><br><span class="line"><span class="comment">########################################################################################</span></span><br><span class="line">&lt;!-- pattern=<span class="string">&quot;%h %l %u %t &amp;quot;%r&amp;quot; %s %b&quot;</span> /&gt; --&gt;</span><br><span class="line">     &lt;/Host&gt;</span><br><span class="line">   &lt;/Engine&gt;</span><br><span class="line"> &lt;/Service&gt;</span><br><span class="line">&lt;/Server&gt;</span><br><span class="line"></span><br><span class="line">[root@centos8 ~]<span class="comment"># systemctl restart tomcat</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># tail   /usr/local/tomcat/logs/localhost_access_log.2020-08-18.txt</span></span><br><span class="line"></span><br><span class="line">&#123;<span class="string">&quot;clientip&quot;</span>:<span class="string">&quot;10.0.0.100&quot;</span>,<span class="string">&quot;ClientUser&quot;</span>:<span class="string">&quot;-&quot;</span>,<span class="string">&quot;authenticated&quot;</span>:<span class="string">&quot;-&quot;</span>,<span class="string">&quot;AccessTime&quot;</span>:<span class="string">&quot;[18/Aug/2020:18:03:46 +0800]&quot;</span>,<span class="string">&quot;method&quot;</span>:<span class="string">&quot;GET / HTTP/1.0&quot;</span>,<span class="string">&quot;status&quot;</span>:<span class="string">&quot;200&quot;</span>,<span class="string">&quot;SendBytes&quot;</span>:<span class="string">&quot;11136&quot;</span>,<span class="string">&quot;Query?string&quot;</span>:<span class="string">&quot;&quot;</span>,<span class="string">&quot;partner&quot;</span>:<span class="string">&quot;-&quot;</span>,<span class="string">&quot;AgentVersion&quot;</span>:<span class="string">&quot;ApacheBench/2.3&quot;</span>&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">#安装json工具jq</span></span><br><span class="line">[root@rocky8 ~]<span class="comment"># yum -y install jq</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#利用jq解析json格式</span></span><br><span class="line">[root@rocky8 ~]<span class="comment"># echo &#x27;&#123;&quot;clientip&quot;:&quot;10.0.0.1&quot;,&quot;ClientUser&quot;:&quot;-&quot;,&quot;authenticated&quot;:&quot;-&quot;,&quot;AccessTime&quot;:&quot;[11/Mar/2022:09:26:53 +0800]&quot;,&quot;method&quot;:&quot;GET / HTTP/1.1&quot;,&quot;status&quot;:&quot;200&quot;,&quot;SendBytes&quot;:&quot;11165&quot;,&quot;Query?string&quot;:&quot;&quot;,&quot;partner&quot;:&quot;-&quot;,&quot;AgentVersion&quot;:&quot;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/99.0.4844.51 Safari/537.36 Edg/99.0.1150.36&quot;&#125;&#x27; |jq</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;clientip&quot;</span>: <span class="string">&quot;10.0.0.1&quot;</span>,</span><br><span class="line">  <span class="string">&quot;ClientUser&quot;</span>: <span class="string">&quot;-&quot;</span>,</span><br><span class="line">  <span class="string">&quot;authenticated&quot;</span>: <span class="string">&quot;-&quot;</span>,</span><br><span class="line">  <span class="string">&quot;AccessTime&quot;</span>: <span class="string">&quot;[11/Mar/2022:09:26:53 +0800]&quot;</span>,</span><br><span class="line">  <span class="string">&quot;method&quot;</span>: <span class="string">&quot;GET / HTTP/1.1&quot;</span>,</span><br><span class="line">  <span class="string">&quot;status&quot;</span>: <span class="string">&quot;200&quot;</span>,</span><br><span class="line">  <span class="string">&quot;SendBytes&quot;</span>: <span class="string">&quot;11165&quot;</span>,</span><br><span class="line">  <span class="string">&quot;Query?string&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">  <span class="string">&quot;partner&quot;</span>: <span class="string">&quot;-&quot;</span>,</span><br><span class="line">  <span class="string">&quot;AgentVersion&quot;</span>: <span class="string">&quot;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/99.0.4844.51 Safari/537.36 Edg/99.0.1150.36&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="组件"><a href="#组件" class="headerlink" title="组件"></a>组件</h3><h4 id="组件分层和分类"><a href="#组件分层和分类" class="headerlink" title="组件分层和分类"></a>组件分层和分类</h4><p><strong>顶级组件</strong></p>
<p>Server，代表整个Tomcat容器，一台主机可以启动多tomcat实例，需要确保端口不要产生冲突</p>
<p><strong>服务类组件</strong></p>
<p>Service，实现组织Engine和Connector，建立两者之间关联关系, service 里面只能包含一个Engine</p>
<p><strong>连接器组件</strong></p>
<p>Connector，有HTTP（默认端口8080/tcp）、HTTPS（默认端口8443/tcp）、AJP（默认端口 8009/tcp）协议的连接器，AJP（Apache Jserv protocol）是一种基于TCP的二进制通讯协议。</p>
<p><strong>容器类</strong> </p>
<p>Engine、Host（虚拟主机）、Context(上下文件,解决路径映射)都是容器类组件，可以嵌入其它组件，内部配置如何运行应用程序。</p>
<p><strong>内嵌类</strong></p>
<p>可以内嵌到其他组件内，valve、logger、realm、loader、manager等。以logger举例，在不同容器组件内分别定义。</p>
<p><strong>集群类组件</strong></p>
<p>listener、cluster</p>
<h4 id="Tomcat-内部组成"><a href="#Tomcat-内部组成" class="headerlink" title="Tomcat 内部组成"></a>Tomcat 内部组成</h4><p>由上述组件就构成了Tomcat，如下图</p>
<p><img src="../../../../images/SRE/day33/35.jpg" alt="35"></p>
<table>
<thead>
<tr>
<th>名称</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>Server</td>
<td>服务器，Tomcat 运行的进程实例，一个Server中可以有多个service，但通常就一个</td>
</tr>
<tr>
<td>Service</td>
<td>服务，用来组织Engine和Connector的对应关系，一个service中只有一个Engine</td>
</tr>
<tr>
<td>Connector</td>
<td>连接器，负责客户端的HTTP、HTTPS、AJP等协议连接。一个Connector只属于某一个Engine</td>
</tr>
<tr>
<td>Engine</td>
<td>即引擎，用来响应并处理用户请求。一个Engine上可以绑定多个Connector</td>
</tr>
<tr>
<td>Host</td>
<td>即虚拟主机,可以实现多虚拟主机,例如使用不同的主机头区分</td>
</tr>
<tr>
<td>Context</td>
<td>应用的上下文，配置特定url路径映射和目录的映射关系：url =&gt; directory</td>
</tr>
</tbody></table>
<p>每一个组件都由一个Java“类”实现，这些组件大体可分为以下几个类型：</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">顶级组件：Server</span><br><span class="line">服务类组件：Service</span><br><span class="line">连接器组件：http, https, ajp（apache jserv protocol）</span><br><span class="line">容器类：Engine, Host, Context</span><br><span class="line">被嵌套类：valve, logger, realm, loader, manager, ...</span><br><span class="line">集群类组件：listener, cluster, ...</span><br></pre></td></tr></table></figure>

<p>范例: 查看类</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ~]<span class="comment">#grep className /usr/local/tomcat/conf/server.xml </span></span><br><span class="line"> &lt;Listener className=<span class="string">&quot;org.apache.catalina.startup.VersionLoggerListener&quot;</span> /&gt;</span><br><span class="line"> &lt;Listener className=<span class="string">&quot;org.apache.catalina.security.SecurityListener&quot;</span> /&gt;</span><br><span class="line"> &lt;Listener className=<span class="string">&quot;org.apache.catalina.core.AprLifecycleListener&quot;</span> SSLEngine=<span class="string">&quot;on&quot;</span> /&gt;</span><br><span class="line"> &lt;Listener className=<span class="string">&quot;org.apache.catalina.core.JreMemoryLeakPreventionListener&quot;</span></span><br><span class="line">/&gt;</span><br><span class="line"> &lt;Listener className=<span class="string">&quot;org.apache.catalina.mbeans.GlobalResourcesLifecycleListener&quot;</span> /&gt;</span><br><span class="line"> &lt;Listener </span><br><span class="line">className=<span class="string">&quot;org.apache.catalina.core.ThreadLocalLeakPreventionListener&quot;</span> /&gt;</span><br><span class="line">       &lt;UpgradeProtocol className=<span class="string">&quot;org.apache.coyote.http2.Http2Protocol&quot;</span> /&gt;</span><br><span class="line">     &lt;Cluster className=<span class="string">&quot;org.apache.catalina.ha.tcp.SimpleTcpCluster&quot;</span>/&gt;</span><br><span class="line">     &lt;Realm className=<span class="string">&quot;org.apache.catalina.realm.LockOutRealm&quot;</span>&gt;</span><br><span class="line">       &lt;Realm className=<span class="string">&quot;org.apache.catalina.realm.UserDatabaseRealm&quot;</span></span><br><span class="line">       &lt;Valve className=<span class="string">&quot;org.apache.catalina.authenticator.SingleSignOn&quot;</span> /&gt;</span><br><span class="line">       &lt;Valve className=<span class="string">&quot;org.apache.catalina.valves.AccessLogValve&quot;</span> directory=<span class="string">&quot;logs&quot;</span></span><br></pre></td></tr></table></figure>

<h4 id="核心组件"><a href="#核心组件" class="headerlink" title="核心组件"></a>核心组件</h4><ul>
<li>Tomcat启动一个Server进程。可以启动多个Server，即tomcat的多实例, 但一般只启动一个</li>
<li>创建一个Service提供服务。可以创建多个Service，但一般也只创建一个<ul>
<li>每个Service中，是Engine和其连接器Connector的关联配置</li>
</ul>
</li>
<li>可以为这个Service提供多个连接器Connector，这些Connector使用了不同的协议，绑定了不同的端口。其作用就是处理来自客户端的不同的连接请求或响应</li>
<li>Service 内部还定义了Engine，引擎才是真正的处理请求的入口，其内部定义多个虚拟主机Host<ul>
<li>Engine对请求头做了分析，将请求发送给相应的虚拟主机</li>
<li>如果没有匹配，数据就发往Engine上的defaultHost缺省虚拟主机</li>
<li>Engine上的缺省虚拟主机可以修改</li>
</ul>
</li>
<li>Host 定义虚拟主机，虚拟主机有name名称，通过名称匹配</li>
<li>Context 定义应用程序单独的路径映射和配置</li>
</ul>
<p>范例：多个组件关系 conf/server.xml</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">Server</span> <span class="attr">port</span>=<span class="string">&quot;8005&quot;</span> <span class="attr">shutdown</span>=<span class="string">&quot;SHUTDOWN&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">Service</span> <span class="attr">name</span>=<span class="string">&quot;Catalina&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">Connector</span> <span class="attr">port</span>=<span class="string">&quot;8080&quot;</span> <span class="attr">protocol</span>=<span class="string">&quot;HTTP/1.1&quot;</span><span class="attr">connectionTimeout</span>=<span class="string">&quot;20000&quot;</span></span></span><br><span class="line"><span class="tag">               <span class="attr">redirectPort</span>=<span class="string">&quot;8443&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">Connector</span> <span class="attr">port</span>=<span class="string">&quot;8009&quot;</span> <span class="attr">protocol</span>=<span class="string">&quot;AJP/1.3&quot;</span> <span class="attr">redirectPort</span>=<span class="string">&quot;8443&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">Engine</span> <span class="attr">name</span>=<span class="string">&quot;Catalina&quot;</span> <span class="attr">defaultHost</span>=<span class="string">&quot;localhost&quot;</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;<span class="name">Host</span> <span class="attr">name</span>=<span class="string">&quot;localhost&quot;</span>  <span class="attr">appBase</span>=<span class="string">&quot;webapps&quot;</span> <span class="attr">unpackWARs</span>=<span class="string">&quot;true&quot;</span></span></span><br><span class="line"><span class="tag"><span class="attr">autoDeploy</span>=<span class="string">&quot;true&quot;</span>&gt;</span></span><br><span class="line">         <span class="tag">&lt;<span class="name">Context</span> &gt;</span></span><br><span class="line">         <span class="tag">&lt;<span class="name">Context</span> /&gt;</span></span><br><span class="line">     <span class="tag">&lt;/<span class="name">Host</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">Engine</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">Service</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">Server</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h4 id="tomcat-处理请求过程"><a href="#tomcat-处理请求过程" class="headerlink" title="tomcat 处理请求过程"></a>tomcat 处理请求过程</h4><p><img src="../../../../images/SRE/day33/36.jpg" alt="36"></p>
<p>假设来自客户的请求为：<a target="_blank" rel="noopener" href="http://localhost:8080/test/index.jsp">http://localhost:8080/test/index.jsp</a></p>
<ul>
<li>浏览器端的请求被发送到服务端端口8080，Tomcat进程监听在此端口上。通过侦听的HTTP/1.1 Connector获得此请求。</li>
<li>Connector把该请求交给它所在的Service的Engine来处理，并等待Engine的响应</li>
<li>Engine获得请求localhost:8080/test/index.jsp，遍历它所有虚拟主机Host </li>
<li>Engine匹配到名为localhost的Host。如果匹配不到,就把请求交给该Engine中的defaultHost处理</li>
<li>localhost Host获得请求/test/index.jsp，匹配它所拥有的所有Context</li>
<li>Host匹配到路径为/test的Context</li>
<li>path=/test的Context获得请求index.jsp，在它的mapping table中寻找对应的servlet</li>
<li>Context匹配到URL PATTERN为 *.jsp 的servlet，对应于JspServlet类构造HttpServletRequest对象和HttpServletResponse对象，作为参数调用JspServlet的doGet或doPost方法。</li>
<li>Context把执行完了之后的HttpServletResponse对象返回给Host</li>
<li>Host把HttpServletResponse对象返回给Engine</li>
<li>Engine把HttpServletResponse对象返回给Connector</li>
<li>Connector把HttpServletResponse对象返回给浏览器端</li>
</ul>
<h2 id="Java-应用部署"><a href="#Java-应用部署" class="headerlink" title="Java 应用部署"></a>Java 应用部署</h2><h3 id="tomcat的根目录结构"><a href="#tomcat的根目录结构" class="headerlink" title="tomcat的根目录结构"></a>tomcat的根目录结构</h3><p>Tomcat中默认网站根目录是$CATALINA_BASE/webapps/</p>
<p>在Tomcat中部署主站应用程序和其他应用程序，和之前WEB服务程序不同。</p>
<p><strong>nginx</strong></p>
<p>假设在nginx中部署2个网站应用eshop、forum，假设网站根目录是/data/nginx/html，那么部署可以是这样的。</p>
<p>eshop解压缩所有文件放到 /data/nginx/html/ 目录下,forum 的文件放在 /data/nginx/html/forum/ 下。</p>
<p>最终网站链接有以下对应关系</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">http://localhost/ 对应于eshop的应用，即 /data/nginx/html/</span><br><span class="line">http://localhost/forum/ 对应于forum的应用，即/data/nginx/html/forum/</span><br></pre></td></tr></table></figure>

<p><strong>Tomcat</strong></p>
<p>Tomcat中默认网站根目录是**$CATALINA_BASE**/webapps/</p>
<p>在Tomcat的webapps目录中，有个非常特殊的目录ROOT，它就是网站默认根目录。</p>
<p>将eshop解压后的文件放到这个**$CATALINA_BASE**/webapps/ROOT中。</p>
<p>bbs解压后文件都放在**$CATALINA_BASE**/webapps/forum目录下。</p>
<p><strong>$CATALINA_BASE</strong>/webapps下面的每个目录都对应一个Web应用,即WebApp</p>
<p>最终网站链接有以下对应关系</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">http://localhost/ 对应于eshop的应用WebApp，即$CATALINA_BASE/webapps/ROOT/目录,</span><br><span class="line">http://localhost/forum/ 对应于forum的应用WebApp，即$CATALINA_BASE/webapps/forum/</span><br></pre></td></tr></table></figure>

<p>如果同时存在**$CATALINA_BASE** /webapps/ROOT/forum ，仍以 $CATALINA_BASE/webapps/forum/ 优先生效</p>
<p>每一个虚拟主机都可以使用appBase指令配置自己的站点目录，使用appBase目录下的ROOT目录作为 主站目录。</p>
<p>范例: 主页目录和编码</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ~]<span class="comment"># cat /usr/local/tomcat/webapps/ROOT/index.html </span></span><br><span class="line">&lt;h1&gt;马哥教育&lt;/h1&gt;</span><br><span class="line"></span><br><span class="line">[root@centos8 ~]<span class="comment"># curl 10.0.0.8:8080/index.html -I</span></span><br><span class="line">HTTP/1.1 200</span><br><span class="line">Accept-Ranges: bytes</span><br><span class="line">ETag: W/<span class="string">&quot;22-1594212097000&quot;</span></span><br><span class="line">Last-Modified: Wed, 08 Jul 2020 12:41:37 GMT</span><br><span class="line">Content-Type: text/html  <span class="comment">#tomcat无指定编码,浏览器自动识别为GBK,可能会导致乱码</span></span><br><span class="line">Content-Length: 22</span><br><span class="line">Date: Wed, 08 Jul 2020 13:06:03 GMT</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#httpd服务器默认指定编码为UTF-8,因为服务器本身不会出现乱码</span></span><br><span class="line"><span class="comment">#nginx服务器默认在响应头部没有批定编码,也会出现乱码</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># curl 10.0.0.18/index.html -I</span></span><br><span class="line">HTTP/1.1 200 OK</span><br><span class="line">Date: Wed, 08 Jul 2020 13:07:57 GMT</span><br><span class="line">Server: Apache/2.4.37 (centos)</span><br><span class="line">Last-Modified: Wed, 08 Jul 2020 12:59:55 GMT</span><br><span class="line">ETag: <span class="string">&quot;16-5a9edaf39d274&quot;</span></span><br><span class="line">Accept-Ranges: bytes</span><br><span class="line">Content-Length: 22</span><br><span class="line">Content-Type: text/html; charset=UTF-8</span><br><span class="line"></span><br><span class="line"><span class="comment">#浏览器的设置默认不是UTF-8,可能会导致乱码</span></span><br></pre></td></tr></table></figure>

<p><img src="../../../../images/SRE/day33/37.jpg" alt="37"><br><img src="../../../../images/SRE/day33/38.jpg" alt="38"></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#修改网页指定编码</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># cat /usr/local/tomcat/webapps/ROOT/index.html</span></span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;<span class="built_in">head</span>&gt;</span><br><span class="line">&lt;meta http-equiv=Content-Type content=<span class="string">&quot;text/html;charset=utf-8&quot;</span>&gt;</span><br><span class="line">&lt;title&gt;tomcat&lt;/title&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;h1&gt;马哥教育&lt;/h1&gt;</span><br></pre></td></tr></table></figure>

<p><img src="../../../../images/SRE/day33/39.jpg" alt="39"></p>
<h3 id="JSP-WebApp目录结构"><a href="#JSP-WebApp目录结构" class="headerlink" title="JSP WebApp目录结构"></a>JSP WebApp目录结构</h3><p><strong>$CATALINA_BASE/webapps</strong>下面的每个目录对应的WebApp,可能有以下子目录,但下面子目录是非必须的</p>
<ul>
<li>主页配置：默认按以下顺序查找主页文件 index.html，index.htm、index.jsp</li>
<li>WEB-INF/：当前目录WebApp的私有资源路径，通常存储当前应用使用的web.xml和context.xml配置文件</li>
<li>META-INF/：类似于WEB-INF，也是私有资源的配置信息，和WEB-INF/目录一样浏览器无法访问</li>
<li>classes/：类文件，当前webapp需要的类</li>
<li>lib/：当前应用依赖的jar包</li>
</ul>
<h3 id="主页设置"><a href="#主页设置" class="headerlink" title="主页设置"></a>主页设置</h3><h4 id="全局配置实现修改默认主页文件"><a href="#全局配置实现修改默认主页文件" class="headerlink" title="全局配置实现修改默认主页文件"></a>全局配置实现修改默认主页文件</h4><p>默认情况下 tomcat 会在$CATALINA_BASE/webapps/ROOT/目录下按以下次序查找文件,找到第一个则进行显示</p>
<ul>
<li>index.html</li>
<li>index.htm</li>
<li>index.jsp</li>
</ul>
<p>可以通过修改 $CATALINA_BASE/conf/web.xml 中的下面 标签 内容修改默认页文件</p>
<p>范例: 修改默认主页文件</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 tomcat]<span class="comment"># pwd</span></span><br><span class="line">/usr/local/tomcat</span><br><span class="line">[root@centos8 tomcat]<span class="comment"># echo &#x27;&lt;h1&gt;www.magedu.org&lt;/h1&gt;&#x27; &gt; webapps/ROOT/index.html</span></span><br><span class="line">[root@centos8 tomcat]<span class="comment"># curl http://127.0.0.1:8080/</span></span><br><span class="line">&lt;h1&gt;www.magedu.org&lt;/h1&gt;</span><br><span class="line"></span><br><span class="line">[root@centos8 tomcat]<span class="comment"># tail conf/web.xml</span></span><br><span class="line"> &lt;!-- here, so be sure to include any of the default values that you wish  --&gt;</span><br><span class="line"> &lt;!-- to use within your application.                                       --&gt;</span><br><span class="line">   &lt;welcome-file-list&gt;</span><br><span class="line">       &lt;welcome-file&gt;index.html&lt;/welcome-file&gt;</span><br><span class="line">       &lt;welcome-file&gt;index.htm&lt;/welcome-file&gt;</span><br><span class="line">       &lt;welcome-file&gt;index.jsp&lt;/welcome-file&gt;</span><br><span class="line">   &lt;/welcome-file-list&gt;</span><br><span class="line">&lt;/web-app&gt;</span><br><span class="line"></span><br><span class="line">[root@centos8 tomcat]<span class="comment"># vim conf/web.xml</span></span><br><span class="line">[root@centos8 tomcat]<span class="comment"># tail conf/web.xml</span></span><br><span class="line"> &lt;!-- here, so be sure to include any of the default values that you wish  --&gt;</span><br><span class="line"> &lt;!-- to use within your application.                                       --&gt;</span><br><span class="line">   &lt;welcome-file-list&gt;</span><br><span class="line">       &lt;welcome-file&gt;index.jsp&lt;/welcome-file&gt;</span><br><span class="line">       &lt;welcome-file&gt;index.htm&lt;/welcome-file&gt;</span><br><span class="line">       &lt;welcome-file&gt;index.html&lt;/welcome-file&gt;</span><br><span class="line">   &lt;/welcome-file-list&gt;</span><br><span class="line">&lt;/web-app&gt;</span><br><span class="line"></span><br><span class="line">[root@centos8 tomcat]<span class="comment"># systemctl restart tomcat</span></span><br><span class="line">[root@centos8 tomcat]<span class="comment"># curl http://127.0.0.1:8080/</span></span><br></pre></td></tr></table></figure>

<h4 id="WebApp的专用配置文件"><a href="#WebApp的专用配置文件" class="headerlink" title="WebApp的专用配置文件"></a>WebApp的专用配置文件</h4><p>将上面主配置文件conf/web.xml中的标签内容，复制 到/usr/local/tomcat/webapps/ROOT/WEB-INF/web.xml中，如下所示: </p>
<p>范例: 针对主站点根目录设置专用配置文件</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 tomcat]<span class="comment"># vim webapps/ROOT/WEB-INF/web.xml </span></span><br><span class="line">[root@centos8 tomcat]<span class="comment"># cat webapps/ROOT/WEB-INF/web.xml </span></span><br><span class="line">&lt;web-app xmlns=<span class="string">&quot;http://xmlns.jcp.org/xml/ns/javaee&quot;</span></span><br><span class="line"> xmlns:xsi=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span><br><span class="line"> xsi:schemaLocation=<span class="string">&quot;http://xmlns.jcp.org/xml/ns/javaee</span></span><br><span class="line"><span class="string">                     http://xmlns.jcp.org/xml/ns/javaee/web-app_3_1.xsd&quot;</span></span><br><span class="line">  version=<span class="string">&quot;3.1&quot;</span></span><br><span class="line">  metadata-complete=<span class="string">&quot;true&quot;</span>&gt;</span><br><span class="line"> &lt;display-name&gt;Welcome to Tomcat&lt;/display-name&gt;</span><br><span class="line"> &lt;description&gt;</span><br><span class="line">     Welcome to Tomcat</span><br><span class="line"> &lt;/description&gt;</span><br><span class="line">   &lt;welcome-file-list&gt;</span><br><span class="line">       &lt;welcome-file&gt;index.html&lt;/welcome-file&gt;   <span class="comment">#修改三个文件的顺序</span></span><br><span class="line">       &lt;welcome-file&gt;index.htm&lt;/welcome-file&gt;</span><br><span class="line">       &lt;welcome-file&gt;index.jsp&lt;/welcome-file&gt;</span><br><span class="line">   &lt;/welcome-file-list&gt;</span><br><span class="line">&lt;/web-app&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment">#配置修改后，无需重启tomcat服务，即可观察首页变化</span></span><br><span class="line">[root@centos8 tomcat]<span class="comment"># curl http://127.0.0.1:8080/</span></span><br></pre></td></tr></table></figure>

<p>范例: 针对特定APP目录设置专用配置文件</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 tomcat]<span class="comment"># cp -a webapps/ROOT/WEB-INF/   webapps/magedu/</span></span><br><span class="line">[root@centos8 tomcat]<span class="comment"># echo /usr/local/tomcat/webapps/magedu/test.html &gt; webapps/magedu/test.html</span></span><br><span class="line">[root@centos8 tomcat]<span class="comment"># tree webapps/magedu/</span></span><br><span class="line">webapps/magedu/</span><br><span class="line">├── index.htm</span><br><span class="line">├── index.html</span><br><span class="line">├── test.html</span><br><span class="line">└── WEB-INF</span><br><span class="line">   └── web.xml</span><br><span class="line">   </span><br><span class="line">1 directory, 4 files</span><br><span class="line"></span><br><span class="line">[root@centos8 tomcat]<span class="comment"># cat webapps/magedu/WEB-INF/web.xml</span></span><br><span class="line">......</span><br><span class="line"> &lt;description&gt;</span><br><span class="line">     Welcome to Tomcat</span><br><span class="line"> &lt;/description&gt;</span><br><span class="line">   &lt;welcome-file-list&gt;</span><br><span class="line">   &lt;welcome-file&gt;test.html&lt;/welcome-file&gt;  <span class="comment">#修改默认页面文件的顺序</span></span><br><span class="line">   &lt;welcome-file&gt;index.htm&lt;/welcome-file&gt;</span><br><span class="line">   &lt;welcome-file&gt;index.html&lt;/welcome-file&gt;</span><br><span class="line">   &lt;/welcome-file-list&gt;</span><br><span class="line">&lt;/web-app&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#注意修改属性</span></span><br><span class="line">[root@centos8 tomcat]<span class="comment"># chown -R tomcat.tomcat webapps/magedu/</span></span><br><span class="line">[root@centos7 ~]<span class="comment"># curl http://www.magedu.org:8080/magedu/</span></span><br><span class="line">/usr/local/tomcat/webapps/magedu/test.html</span><br></pre></td></tr></table></figure>

<p><strong>配置规则：</strong></p>
<ul>
<li>webApp的专有配置优先于系统的全局配置</li>
<li>修改系统的全局配置文件，需要重新启动服务生效</li>
<li>修改 webApp的专有配置，无需重启即可生效</li>
</ul>
<h3 id="应用部署实现"><a href="#应用部署实现" class="headerlink" title="应用部署实现"></a>应用部署实现</h3><h4 id="WebApp应用的归档格式"><a href="#WebApp应用的归档格式" class="headerlink" title="WebApp应用的归档格式"></a>WebApp应用的归档格式</h4><ul>
<li>.war：WebApp打包,类zip格式文件,通常包括一个应用的所有资源,比如jsp,html,配置文件等</li>
<li>.jar：EJB类文件的打包压缩类zip格式文件，,包括很多的class文件, 网景公司发明</li>
<li>.rar：资源适配器类打包文件，目前已不常用</li>
<li>.ear：企业级WebApp打包，目前已不常用</li>
</ul>
<p>传统应用开发测试后，通常打包为war格式，这种文件部署到Tomcat的webapps目录下，并默认会自动解包展开和部署上线。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#conf/server.xml中文件配置</span></span><br><span class="line">&lt;Host name=<span class="string">&quot;localhost&quot;</span>  appBase=<span class="string">&quot;webapps&quot;</span> unpackWARs=<span class="string">&quot;true&quot;</span> autoDeploy=<span class="string">&quot;true&quot;</span>&gt;</span><br></pre></td></tr></table></figure>

<h4 id="部署方式"><a href="#部署方式" class="headerlink" title="部署方式"></a>部署方式</h4><ul>
<li>部署Deploy：将webapp的源文件放置到目标目录，通过web.xml和context.xml文件中配置的路径就可以访问该webapp，通过类加载器加载其特有的类和依赖的类到JVM上，即：最终用户可以通过浏览器访问该应用<ul>
<li>自动部署：Tomcat一旦发现多了一个web应用APP.war包，默认会自动把它解压缩，加载并启动起来</li>
<li>手动部署<ul>
<li>冷部署：将webapp放到指定目录，才去启动Tomcat服务</li>
<li>热部署：Tomcat服务不停止，需要依赖manager、ant脚本、tcd（tomcat client deployer）等工具</li>
</ul>
</li>
</ul>
</li>
<li>反部署 undeploy：停止webapp运行，并从JVM上清除已经加载的类，从Tomcat应用目录中移除部署的文件</li>
<li>启动 start：启用 webapp 能够访问</li>
<li>停止 stop：禁用 webapp 不能访问，不能提供服务，但是JVM并不清除它</li>
</ul>
<h4 id="部署WebApp的目录结构"><a href="#部署WebApp的目录结构" class="headerlink" title="部署WebApp的目录结构"></a>部署WebApp的目录结构</h4><p><strong>常见开发项目目录组成</strong></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#目录结构一般由开发用工具自动生成，以下模拟生成相关目录</span></span><br><span class="line"><span class="built_in">mkdir</span> projects/myapp/&#123;WEB-INF,META-INF,classes,lib&#125; -pv</span><br><span class="line"><span class="built_in">mkdir</span>: 已创建目录 <span class="string">&quot;projects&quot;</span></span><br><span class="line"><span class="built_in">mkdir</span>: 已创建目录 <span class="string">&quot;projects/myapp&quot;</span></span><br><span class="line"><span class="built_in">mkdir</span>: 已创建目录 <span class="string">&quot;projects/myapp/WEB-INF&quot;</span></span><br><span class="line"><span class="built_in">mkdir</span>: 已创建目录 <span class="string">&quot;projects/myapp/META-INF&quot;</span></span><br><span class="line"><span class="built_in">mkdir</span>: 已创建目录 <span class="string">&quot;projects/myapp/classes&quot;</span></span><br><span class="line"><span class="built_in">mkdir</span>: 已创建目录 <span class="string">&quot;projects/myapp/lib&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#常见应用首页，内容就用前面的test.jsp内部</span></span><br><span class="line">vi projects/myapp/index.jsp</span><br><span class="line"></span><br><span class="line"><span class="comment">#手动复制项目目录到webapps目录下去</span></span><br><span class="line"><span class="built_in">cp</span> -r projects/myapp/ /usr/local/tomcat/webapps/</span><br><span class="line"></span><br><span class="line"><span class="comment">#注意权限和属性</span></span><br><span class="line"><span class="built_in">chown</span> -R tomcat.tomcat /usr/local/tomcat/webapps/myapp</span><br><span class="line"></span><br><span class="line"><span class="comment">#访问http://YourIP:8080/myapp/</span></span><br></pre></td></tr></table></figure>

<h4 id="实战案例：手动的应用部署"><a href="#实战案例：手动的应用部署" class="headerlink" title="实战案例：手动的应用部署"></a>实战案例：手动的应用部署</h4><h5 id="部署主页目录下的应用WebApp"><a href="#部署主页目录下的应用WebApp" class="headerlink" title="部署主页目录下的应用WebApp"></a>部署主页目录下的应用WebApp</h5><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 tomcat]<span class="comment"># vim webapps/ROOT/test.jsp</span></span><br><span class="line">[root@centos8 tomcat]<span class="comment"># cat webapps/ROOT/test.jsp</span></span><br><span class="line">&lt;%@ page language=<span class="string">&quot;java&quot;</span> contentType=<span class="string">&quot;text/html; charset=UTF-8&quot;</span></span><br><span class="line">    pageEncoding=<span class="string">&quot;UTF-8&quot;</span>%&gt;</span><br><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;<span class="built_in">head</span>&gt;</span><br><span class="line">   &lt;meta charset=<span class="string">&quot;utf-8&quot;</span>&gt;</span><br><span class="line">   &lt;title&gt;jsp例子&lt;/title&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">后面的内容是服务器端动态生成字符串，最后拼接在一起</span><br><span class="line">&lt;%</span><br><span class="line">out.println(<span class="string">&quot;hello jsp&quot;</span>);</span><br><span class="line">%&gt;</span><br><span class="line">&lt;br&gt;</span><br><span class="line">&lt;%=request.getRequestURL()%&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@centos8 tomcat]<span class="comment"># curl http://127.0.0.1:8080/test.jsp</span></span><br><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;<span class="built_in">head</span>&gt;</span><br><span class="line">   &lt;meta charset=<span class="string">&quot;utf-8&quot;</span>&gt;</span><br><span class="line">   &lt;title&gt;jsp例子&lt;/title&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">后面的内容是服务器端动态生成字符串，最后拼接在一起</span><br><span class="line">hello jsp</span><br><span class="line">&lt;br&gt;</span><br><span class="line">http://127.0.0.1:8080/test.jsp</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br><span class="line"></span><br><span class="line">[root@centos8 tomcat]<span class="comment"># tree work/Catalina/localhost/ROOT/</span></span><br><span class="line">work/Catalina/localhost/ROOT/</span><br><span class="line">└── org</span><br><span class="line">   └── apache</span><br><span class="line">       └── jsp</span><br><span class="line">           ├── test_jsp.class</span><br><span class="line">           └── test_jsp.java</span><br><span class="line">3 directories, 2 files</span><br></pre></td></tr></table></figure>

<h5 id="部署一个子目录的应用WebApp"><a href="#部署一个子目录的应用WebApp" class="headerlink" title="部署一个子目录的应用WebApp"></a>部署一个子目录的应用WebApp</h5><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 tomcat]<span class="comment"># pwd</span></span><br><span class="line">/usr/local/tomcat</span><br><span class="line"></span><br><span class="line">[root@centos8 tomcat]<span class="comment"># mkdir webapps/app1/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#利用之前实验的文件生成新应用</span></span><br><span class="line">[root@centos8 tomcat]<span class="comment"># cp -p webapps/ROOT/test.jsp webapps/app1/</span></span><br><span class="line">[root@centos8 tomcat]<span class="comment"># chown -R tomcat.tomcat webapps/app1/</span></span><br><span class="line">[root@centos8 tomcat]<span class="comment"># tree webapps/app1/</span></span><br><span class="line">webapps/testapp1/</span><br><span class="line">└── test.jsp</span><br><span class="line">0 directories, 1 file</span><br><span class="line"></span><br><span class="line">[root@centos8 tomcat]<span class="comment"># curl http://127.0.0.1:8080/app1/test.jsp</span></span><br><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;<span class="built_in">head</span>&gt;</span><br><span class="line">   &lt;meta charset=<span class="string">&quot;utf-8&quot;</span>&gt;</span><br><span class="line">   &lt;title&gt;jsp例子&lt;/title&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">后面的内容是服务器端动态生成字符串，最后拼接在一起</span><br><span class="line">hello jsp</span><br><span class="line">&lt;br&gt;</span><br><span class="line">&lt;%=request.getRequestURL()%&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br><span class="line"></span><br><span class="line">[root@centos8 tomcat]<span class="comment"># tree work/Catalina/localhost/app1/</span></span><br><span class="line">work/Catalina/localhost/app1/</span><br><span class="line">└── org</span><br><span class="line">   └── apache</span><br><span class="line">       └── jsp</span><br><span class="line">           ├── test_jsp.class</span><br><span class="line">           └── test_jsp.java</span><br><span class="line">3 directories, 2 files</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#删除应用</span></span><br><span class="line">[root@centos8 tomcat]<span class="comment"># rm -rf webapps/app1/</span></span><br><span class="line">[root@centos8 tomcat]<span class="comment">#l s webapps/</span></span><br><span class="line">docs examples host-manager manager ROOT</span><br><span class="line"></span><br><span class="line">[root@centos8 tomcat]<span class="comment"># ls work/Catalina/localhost/</span></span><br><span class="line">docs examples host-manager manager ROOT</span><br></pre></td></tr></table></figure>

<h4 id="实战案例：自动的应用部署war包"><a href="#实战案例：自动的应用部署war包" class="headerlink" title="实战案例：自动的应用部署war包"></a>实战案例：自动的应用部署war包</h4><h5 id="制作应用的war包文件"><a href="#制作应用的war包文件" class="headerlink" title="制作应用的war包文件"></a>制作应用的war包文件</h5><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ~]<span class="comment"># ls /data/app2/</span></span><br><span class="line">test.html test.jsp</span><br><span class="line"></span><br><span class="line">[root@centos8 ~]<span class="comment"># cat /data/app2/test.html </span></span><br><span class="line">&lt;h1&gt;This is <span class="built_in">test</span> html &lt;/h1&gt;</span><br><span class="line"></span><br><span class="line">[root@centos8 ~]<span class="comment"># cat /data/app2/test.jsp</span></span><br><span class="line">&lt;%@ page language=<span class="string">&quot;java&quot;</span> contentType=<span class="string">&quot;text/html; charset=UTF-8&quot;</span></span><br><span class="line">    pageEncoding=<span class="string">&quot;UTF-8&quot;</span>%&gt;</span><br><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;<span class="built_in">head</span>&gt;</span><br><span class="line">   &lt;meta charset=<span class="string">&quot;utf-8&quot;</span>&gt;</span><br><span class="line">   &lt;title&gt;jsp例子&lt;/title&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">后面的内容是服务器端动态生成字符串，最后拼接在一起</span><br><span class="line">&lt;%</span><br><span class="line">out.println(<span class="string">&quot;test jsp&quot;</span>);</span><br><span class="line">%&gt;</span><br><span class="line">&lt;br&gt;</span><br><span class="line">&lt;%=request.getRequestURL()%&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br><span class="line"></span><br><span class="line">[root@centos8 ~]<span class="comment"># cd /data/app2/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#生成war包文件app2.war,此文件的名称决定了tomcat子目录的名称</span></span><br><span class="line">[root@centos8 app2]<span class="comment"># jar cvf /data/app2.war *</span></span><br><span class="line">added manifest</span><br><span class="line">adding: test.html(<span class="keyword">in</span> = 28) (out= 27)(deflated 3%)</span><br><span class="line">adding: test.jsp(<span class="keyword">in</span> = 329) (out= 275)(deflated 16%)</span><br><span class="line"></span><br><span class="line">[root@centos8 app2]<span class="comment"># cd /data/app2/</span></span><br><span class="line">[root@centos8 app2]<span class="comment"># ls</span></span><br><span class="line">test.html test.jsp</span><br><span class="line"></span><br><span class="line">[root@centos8 app2]<span class="comment"># cd /data/</span></span><br><span class="line">[root@centos8 data]<span class="comment"># ls</span></span><br><span class="line">app2 app2.war</span><br><span class="line"></span><br><span class="line">[root@centos8 data]<span class="comment"># file app2.war</span></span><br><span class="line">app2.war: Java archive data (JAR)</span><br><span class="line">[root@centos8 data]<span class="comment"># chown tomcat.tomcat /data/app2.war</span></span><br></pre></td></tr></table></figure>

<h5 id="自动应用部署上面的war包"><a href="#自动应用部署上面的war包" class="headerlink" title="自动应用部署上面的war包"></a>自动应用部署上面的war包</h5><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 tomcat]<span class="comment"># pwd</span></span><br><span class="line">/usr/local/tomcat</span><br><span class="line"></span><br><span class="line">[root@centos8 tomcat]<span class="comment"># ls webapps/</span></span><br><span class="line">docs examples host-manager manager ROOT</span><br><span class="line"></span><br><span class="line">[root@centos8 tomcat]<span class="comment"># ls work/Catalina/localhost/</span></span><br><span class="line">docs examples host-manager manager ROOT</span><br><span class="line"></span><br><span class="line">[root@centos8 tomcat]<span class="comment"># cp -p /data/app2.war webapps/</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#再次查看，tomcat将app2.war自动解压缩</span></span><br><span class="line">[root@centos8 tomcat]<span class="comment"># ll webapps/</span></span><br><span class="line">total 8</span><br><span class="line">drwxr-x--- 15 tomcat tomcat 4096 Feb  9 11:02 docs</span><br><span class="line">drwxr-x---  6 tomcat tomcat   83 Feb  9 11:02 examples</span><br><span class="line">drwxr-x---  5 tomcat tomcat   87 Feb  9 11:02 host-manager</span><br><span class="line">drwxr-x---  5 tomcat tomcat  103 Feb  9 11:02 manager</span><br><span class="line">drwxr-x---  3 tomcat tomcat  300 Feb  9 19:59 ROOT</span><br><span class="line">drwxr-x---  3 tomcat tomcat   55 Feb  9 20:14 app2</span><br><span class="line">-rw-r--r--  1 tomcat tomcat  862 Feb  9 20:05 app2.war</span><br><span class="line"></span><br><span class="line">[root@centos8 tomcat]<span class="comment"># ll webapps/app2</span></span><br><span class="line">total 8</span><br><span class="line">drwxr-x--- 2 tomcat tomcat  44 Feb  9 20:14 META-INF</span><br><span class="line">-rw-r----- 1 tomcat tomcat  28 Feb  9 20:03 test.html</span><br><span class="line">-rw-r----- 1 tomcat tomcat 329 Aug 30 02:30 test.jsp</span><br><span class="line"></span><br><span class="line"><span class="comment">#work目录会自动生成对应的app2的子目录，但目录内无内容</span></span><br><span class="line">[root@centos8 tomcat]<span class="comment"># tree work/Catalina/localhost/app2/</span></span><br><span class="line">work/Catalina/localhost/app2/</span><br><span class="line">0 directories, 0 files</span><br><span class="line"></span><br><span class="line"><span class="comment">#访问jsp文件后，tomcat会自动将jsp转换和编译生成work目录下对应的java和class文件</span></span><br><span class="line">[root@centos8 tomcat]<span class="comment"># curl http://127.0.0.1:8080/app2/test.jsp</span></span><br><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;<span class="built_in">head</span>&gt;</span><br><span class="line">   &lt;meta charset=<span class="string">&quot;utf-8&quot;</span>&gt;</span><br><span class="line">   &lt;title&gt;jsp例子&lt;/title&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">后面的内容是服务器端动态生成字符串，最后拼接在一起</span><br><span class="line">hello jsp</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br><span class="line"></span><br><span class="line">[root@centos8 tomcat]<span class="comment"># tree work/Catalina/localhost/app2/</span></span><br><span class="line">work/Catalina/localhost/app2/</span><br><span class="line">└── org</span><br><span class="line">   └── apache</span><br><span class="line">       └── jsp</span><br><span class="line">           ├── test_jsp.class</span><br><span class="line">           └── test_jsp.java</span><br><span class="line">3 directories, 2 files</span><br><span class="line"></span><br><span class="line">[root@centos8 tomcat]<span class="comment"># curl http://127.0.0.1:8080/app2/test.html</span></span><br><span class="line">&lt;h1&gt;This is <span class="built_in">test</span> html &lt;/h1&gt;</span><br><span class="line"></span><br><span class="line">[root@centos8 tomcat]<span class="comment"># tree work/Catalina/localhost/app2/</span></span><br><span class="line">work/Catalina/localhost/estapp2/</span><br><span class="line">└── org</span><br><span class="line">   └── apache</span><br><span class="line">       └── jsp</span><br><span class="line">           ├── test_jsp.class</span><br><span class="line">           └── test_jsp.java</span><br><span class="line">3 directories, 2 files</span><br><span class="line"></span><br><span class="line"><span class="comment">#自动删除（反部署）</span></span><br><span class="line"><span class="comment">#[root@centos8 tomcat]#rm -f webapps/app2.war  </span></span><br><span class="line">[root@centos8 tomcat]<span class="comment"># ls webapps/</span></span><br><span class="line">docs examples host-manager manager ROOT app2</span><br><span class="line"></span><br><span class="line"><span class="comment">#过几秒再查看，发现app2目录也随之删除</span></span><br><span class="line">[root@centos8 tomcat]<span class="comment"># ls webapps/</span></span><br><span class="line">docs examples host-manager manager ROOT</span><br><span class="line"></span><br><span class="line">[root@centos8 tomcat]<span class="comment"># ls webapps/</span></span><br><span class="line">docs examples host-manager manager ROOT</span><br><span class="line"></span><br><span class="line">[root@centos8 tomcat]<span class="comment"># ls work/Catalina/localhost/</span></span><br><span class="line">docs examples host-manager manager ROOT</span><br></pre></td></tr></table></figure>

<h4 id="实站案例-部署基于JAVA的博客系统-JPress"><a href="#实站案例-部署基于JAVA的博客系统-JPress" class="headerlink" title="实站案例: 部署基于JAVA的博客系统 JPress"></a>实站案例: 部署基于JAVA的博客系统 JPress</h4><p><img src="../../../../images/SRE/day33/40.jpg" alt="40"></p>
<p>JPress 是一个使用Java开发的类似WordPress的产品的建站神器，目前已有超过10万+网站使用 JPress 搭建，其中包括多个政府机构，200+上市公司，中科院、红十字会等。</p>
<p>和JPress 相类似的基于 java 开发的博客系统还有zrlog,Halo等</p>
<p>开源协议: LGPL-3.0</p>
<p>官方网站: <a target="_blank" rel="noopener" href="http://www.jpress.io/">http://www.jpress.io/</a></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ~]<span class="comment"># cd /usr/local/tomcat/webapps/</span></span><br><span class="line">[root@centos8 webapps]<span class="comment"># ls</span></span><br><span class="line">docs examples host-manager jpress-v3.2.1.war manager ROOT</span><br><span class="line"></span><br><span class="line"><span class="comment">#自动解压缩生成jpress-v3.2.1目录</span></span><br><span class="line">[root@centos8 webapps]<span class="comment"># ls</span></span><br><span class="line">docs examples host-manager jpress-v3.2.1 jpress-v3.2.1.war manager ROOT</span><br><span class="line"></span><br><span class="line"><span class="comment">#生成软链接</span></span><br><span class="line">[root@centos8 webapps]<span class="comment"># ln -s jpress-v3.2.1 jpress</span></span><br><span class="line">[root@centos8 webapps]<span class="comment"># ls</span></span><br><span class="line">docs examples host-manager jpress jpress-v3.2.1 jpress-v3.2.1.war manager ROOT</span><br><span class="line"></span><br><span class="line"><span class="comment">#准备数据库和用户授权</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># yum -y install mysql-server</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># systemctl enable --now mysqld</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># mysql </span></span><br><span class="line"></span><br><span class="line">mysql&gt; create user jpress@<span class="string">&#x27;10.0.0.%&#x27;</span> identified with mysql_native_password by <span class="string">&#x27;123456&#x27;</span>;</span><br><span class="line">mysql&gt; create database jpress;</span><br><span class="line">mysql&gt; grant all on jpress.* to jpress@<span class="string">&#x27;10.0.0.%&#x27;</span>;</span><br></pre></td></tr></table></figure>

<p><img src="../../../../images/SRE/day33/41.jpg" alt="41"><br><img src="../../../../images/SRE/day33/42.jpg" alt="42"><br><img src="../../../../images/SRE/day33/43.jpg" alt="43"><br><img src="../../../../images/SRE/day33/44.jpg" alt="44"><br><img src="../../../../images/SRE/day33/45.jpg" alt="45"><br><img src="../../../../images/SRE/day33/46.jpg" alt="46"><br><img src="../../../../images/SRE/day33/47.jpg" alt="47"><br><img src="../../../../images/SRE/day33/48.jpg" alt="48"></p>
<p>上传的图片存放路径</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 webapps]<span class="comment"># tree jpress/attachment/</span></span><br><span class="line">jpress/attachment/</span><br><span class="line">└── 20210110</span><br><span class="line">   └── 2169440a4e75459d8a420f4b245565d4.jpg</span><br><span class="line">   </span><br><span class="line">1 directory, 1 file</span><br></pre></td></tr></table></figure>

<h4 id="实战案例-部署基于JAR包的博客系统-Halo"><a href="#实战案例-部署基于JAR包的博客系统-Halo" class="headerlink" title="实战案例: 部署基于JAR包的博客系统 Halo"></a>实战案例: 部署基于JAR包的博客系统 Halo</h4><p><img src="../../../../images/SRE/day33/49.jpg" alt="49"></p>
<p>Halo 是一款现代化的基于JAVA实现的博客/CMS系统</p>
<p>Halo 官网: <a target="_blank" rel="noopener" href="https://halo.run/">https://halo.run/</a></p>
<p>Halo 部署: <a target="_blank" rel="noopener" href="https://docs.halo.run/install/linux">https://docs.halo.run/install/linux</a></p>
<p>Docker 部署: <a target="_blank" rel="noopener" href="https://docs.halo.run/install/docker">https://docs.halo.run/install/docker</a></p>
<p>Halo 下载: <a target="_blank" rel="noopener" href="https://dl.halo.run/">https://dl.halo.run/</a></p>
<p>范例: 部署 Halo 博客系统</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#注意:运行当前版本Halo的最低依赖要求为 JRE 11，目前介绍两种 Linux 发行版的安装方式，均为OpenJRE，不推荐 Oracle 版本。</span></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment"># apt -y install openjdk-11-jdk</span></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment"># mkdir /apps</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#最新版</span></span><br><span class="line">[root@ubuntu2204 ~]<span class="comment"># wget https://dl.halo.run/release/halo-1.6.0.jar -O /opt/halo.jar</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#旧版</span></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment"># wget https://dl.halo.run/release/halo-1.4.11.jar -O /apps/halo.jar</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#或者</span></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment"># curl -L https://github.com/halo-dev/halo/releases/download/v1.4.11/halo-1.4.11.jar --output /apps/halo.jar</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#运行Halo</span></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment">#java -jar /apps/halo.jar --server.port=80</span></span><br></pre></td></tr></table></figure>

<p><img src="../../../../images/SRE/day33/50.jpg" alt="50"></p>
<p><img src="../../../../images/SRE/day33/51.jpg" alt="51"></p>
<p><img src="../../../../images/SRE/day33/52.jpg" alt="52"></p>
<p>范例: docker 启动 halo</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@ubuntu1804 ~]<span class="comment"># docker run -it -d --name halo -p 8090:8090 -v ~/.halo:/root/.halo --restart=always halohub/halo</span></span><br></pre></td></tr></table></figure>

<h4 id="基于WEB的管理Server-status和Manager-APP实现应用部署"><a href="#基于WEB的管理Server-status和Manager-APP实现应用部署" class="headerlink" title="基于WEB的管理Server status和Manager APP实现应用部署"></a>基于WEB的管理Server status和Manager APP实现应用部署</h4><p>tomcat 提供了基于WEB的管理页面,默认由 tomcat-admin-webapps.noarch包提供相关文件</p>
<h5 id="实现WEB的管理Server-status和Manager-APP"><a href="#实现WEB的管理Server-status和Manager-APP" class="headerlink" title="实现WEB的管理Server status和Manager APP"></a>实现WEB的管理Server status和Manager APP</h5><p>打开浏览器可以访问tomcat管理的默认管理页面，点击下图两个按钮都会出现下面提示403的错误提示</p>
<p><img src="../../../../images/SRE/day33/53.jpg" alt="53"><br><img src="../../../../images/SRE/day33/54.jpg" alt="54"><br><img src="../../../../images/SRE/day33/55.jpg" alt="55"></p>
<p><strong>默认的管理页面被禁用，启用方法如下</strong></p>
<ul>
<li><strong>修改conf/conf/tomcat-users.xml</strong></li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 tomcat]<span class="comment"># ls conf/</span></span><br><span class="line">Catalina             context.xml           logging.properties tomcat-users.xml</span><br><span class="line">catalina.policy     jaspic-providers.xml server.xml         tomcat-users.xsd</span><br><span class="line">catalina.properties jaspic-providers.xsd tomcat.conf         web.xml</span><br><span class="line"></span><br><span class="line"><span class="comment">#查看配置信息</span></span><br><span class="line">[root@centos8 tomcat]<span class="comment"># cat conf/server.xml </span></span><br><span class="line">&lt;GlobalNamingResources&gt;</span><br><span class="line">   &lt;!-- Editable user database that can also be used by</span><br><span class="line">         UserDatabaseRealm to authenticate <span class="built_in">users</span></span><br><span class="line">    --&gt;</span><br><span class="line">   &lt;Resource name=<span class="string">&quot;UserDatabase&quot;</span> auth=<span class="string">&quot;Container&quot;</span></span><br><span class="line">              <span class="built_in">type</span>=<span class="string">&quot;org.apache.catalina.UserDatabase&quot;</span></span><br><span class="line">              description=<span class="string">&quot;User database that can be updated and saved&quot;</span></span><br><span class="line">              factory=<span class="string">&quot;org.apache.catalina.users.MemoryUserDatabaseFactory&quot;</span></span><br><span class="line">              pathname=<span class="string">&quot;conf/tomcat-users.xml&quot;</span> /&gt;  <span class="comment">#由此文件指定授权用户信息</span></span><br><span class="line"> &lt;/GlobalNamingResources&gt;</span><br></pre></td></tr></table></figure>

<p>用户认证，配置文件是conf/tomcat-users.xml。打开tomcat-users.xml，我们需要一个角色manager-gui。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 tomcat]<span class="comment"># vim conf/tomcat-users.xml </span></span><br><span class="line">&lt;tomcat-users xmlns=<span class="string">&quot;http://tomcat.apache.org/xml&quot;</span></span><br><span class="line">             xmlns:xsi=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span><br><span class="line">             xsi:schemaLocation=<span class="string">&quot;http://tomcat.apache.org/xml tomcat-users.xsd&quot;</span></span><br><span class="line">              version=<span class="string">&quot;1.0&quot;</span>&gt;</span><br><span class="line"><span class="comment">#加下面两行，指定用户和密码</span></span><br><span class="line"> &lt;role rolename=<span class="string">&quot;manager-gui&quot;</span>/&gt;</span><br><span class="line"> &lt;user username=<span class="string">&quot;admin&quot;</span> password=<span class="string">&quot;123456&quot;</span> roles=<span class="string">&quot;manager-gui&quot;</span>/&gt;</span><br><span class="line">&lt;/tomcat-users&gt;</span><br><span class="line"><span class="comment">#修改全局配置文件需要重启服务生效</span></span><br><span class="line"></span><br><span class="line">[root@centos8 tomcat]<span class="comment"># systemctl restart tomcat</span></span><br></pre></td></tr></table></figure>

<ul>
<li><strong>修改webapps/manager/META-INF/context.xml</strong></li>
</ul>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">Context</span> <span class="attr">antiResourceLocking</span>=<span class="string">&quot;false&quot;</span> <span class="attr">privileged</span>=<span class="string">&quot;true&quot;</span> &gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">Valve</span> <span class="attr">className</span>=<span class="string">&quot;org.apache.catalina.valves.RemoteAddrValve&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">allow</span>=<span class="string">&quot;127\.\d+\.\d+\.\d+|::1|0:0:0:0:0:0:0:1&quot;</span> /&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">Manager</span> <span class="attr">sessionAttributeValueClassNameFilter</span>=<span class="string">&quot;java\.lang\.</span></span></span><br><span class="line"><span class="string"><span class="tag">(?:Boolean|Integer|Long|Number|String)|org\.apache\.catalina\.filters\.CsrfPreve</span></span></span><br><span class="line"><span class="string"><span class="tag">ntionFilter\$LruCache(?:\$1)?|java\.util\.(?:Linked)?HashMap&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">Context</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>查看正则表达式就知道是本地访问了，由于当前访问地址是192.168.x.x，可以修改正则表达式为</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">allow=<span class="string">&quot;127\.\d+\.\d+\.\d+|::1|0:0:0:0:0:0:0:1|192\.168\.\d+\.\d+&quot;</span></span><br></pre></td></tr></table></figure>

<p>范例：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 tomcat]<span class="comment"># vim webapps/manager/META-INF/context.xml</span></span><br><span class="line">&lt;Context antiResourceLocking=<span class="string">&quot;false&quot;</span> privileged=<span class="string">&quot;true&quot;</span> &gt;</span><br><span class="line"> &lt;Valve className=<span class="string">&quot;org.apache.catalina.valves.RemoteAddrValve&quot;</span></span><br><span class="line">         allow=<span class="string">&quot;127\.\d+\.\d+\.\d+|::1|0:0:0:0:0:0:0:1|10\.0\.0\.\d+&quot;</span> /&gt;</span><br><span class="line"> &lt;Manager sessionAttributeValueClassNameFilter=<span class="string">&quot;java\.lang\.</span></span><br><span class="line"><span class="string">(?:Boolean|Integer|Long|Number|String)|org\.apach</span></span><br><span class="line"><span class="string">e\.catalina\.filters\.CsrfPreventionFilter\$LruCache(?:\$1)?|java\.util\.(?:Linked)?HashMap&quot;</span>/&gt;</span><br><span class="line">&lt;/Context&gt; </span><br><span class="line"></span><br><span class="line"><span class="comment">#修改WebApp的配置无需重启服务即可生效</span></span><br><span class="line">[root@centos7 ~]<span class="comment"># links -dump http://admini:123456@10.0.0.100:8080/manager/status</span></span><br></pre></td></tr></table></figure>

<ul>
<li>再次通过浏览器访问两个按钮Server Status和Manager App，可以看到以下管理界面，输入前面的用户和密码进行登录</li>
</ul>
<p><img src="../../../../images/SRE/day33/56.jpg" alt="56"><br><img src="../../../../images/SRE/day33/57.jpg" alt="57"><br><img src="../../../../images/SRE/day33/58.jpg" alt="58"></p>
<h5 id="基于WEB应用程序管理器实现APP的部署"><a href="#基于WEB应用程序管理器实现APP的部署" class="headerlink" title="基于WEB应用程序管理器实现APP的部署"></a>基于WEB应用程序管理器实现APP的部署</h5><p>Web 应用程序管理界面可以实现以下功能</p>
<p>Applications 应用程序管理，可以启动、停止、重加载、反部署、清理过期session </p>
<p>Deploy 可以热部署，也可以部署war文件。</p>
<p><strong>方式1: 指定目录部署软件</strong></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ~]<span class="comment"># mkdir -p /data/myapp/</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># echo /data/myapp/index.html &gt; /data/myapp/index.html</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#按下面信息添写,实现下面链接的访问</span></span><br><span class="line">http://10.0.0.8:8080/test1/</span><br></pre></td></tr></table></figure>

<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Context Path (required): 指定通过浏览器访问的虚拟目录</span><br><span class="line">WAR or Directory URL：指定真正存放文件的实际磁盘目录路径</span><br></pre></td></tr></table></figure>

<p><img src="../../../../images/SRE/day33/59.jpg" alt="59"><br><img src="../../../../images/SRE/day33/60.jpg" alt="60"></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#自动将/data/myapp目录下的数据复制到webapps/test1下面</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># tree /usr/local/tomcat/webapps/test1/</span></span><br><span class="line">/usr/local/tomcat/webapps/test1/</span><br><span class="line">└── index.html</span><br><span class="line">0 directories, 1 file</span><br><span class="line"></span><br><span class="line">[root@centos8 ~]<span class="comment"># cat /usr/local/tomcat/webapps/test1/index.html </span></span><br><span class="line">/data/myapp/index.html</span><br></pre></td></tr></table></figure>

<p><strong>方式2: 部署war包文件</strong></p>
<p><img src="../../../../images/SRE/day33/61.jpg" alt="61"><br><img src="../../../../images/SRE/day33/62.jpg" alt="62"></p>
<h3 id="常见配置详解"><a href="#常见配置详解" class="headerlink" title="常见配置详解"></a>常见配置详解</h3><h4 id="端口8005-tcp-安全配置管理"><a href="#端口8005-tcp-安全配置管理" class="headerlink" title="端口8005/tcp 安全配置管理"></a>端口8005/tcp 安全配置管理</h4><p>在conf/server.xml 有以下内容</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">Server</span> <span class="attr">port</span>=<span class="string">&quot;8005&quot;</span> <span class="attr">shutdown</span>=<span class="string">&quot;SHUTDOWN&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">Service</span> <span class="attr">name</span>=<span class="string">&quot;Catalina&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">Connector</span> <span class="attr">port</span>=<span class="string">&quot;8080&quot;</span> <span class="attr">protocol</span>=<span class="string">&quot;HTTP/1.1&quot;</span></span></span><br><span class="line"><span class="tag">               <span class="attr">connectionTimeout</span>=<span class="string">&quot;20000&quot;</span></span></span><br><span class="line"><span class="tag">               <span class="attr">redirectPort</span>=<span class="string">&quot;8443&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">Connector</span> <span class="attr">port</span>=<span class="string">&quot;8009&quot;</span> <span class="attr">protocol</span>=<span class="string">&quot;AJP/1.3&quot;</span> <span class="attr">redirectPort</span>=<span class="string">&quot;8443&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">Engine</span> <span class="attr">name</span>=<span class="string">&quot;Catalina&quot;</span> <span class="attr">defaultHost</span>=<span class="string">&quot;localhost&quot;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">Host</span> <span class="attr">name</span>=<span class="string">&quot;localhost&quot;</span>  <span class="attr">appBase</span>=<span class="string">&quot;webapps&quot;</span></span></span><br><span class="line"><span class="tag">            <span class="attr">unpackWARs</span>=<span class="string">&quot;true&quot;</span> <span class="attr">autoDeploy</span>=<span class="string">&quot;true&quot;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">Host</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">Engine</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">Service</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">Server</span>&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">Server</span> <span class="attr">port</span>=<span class="string">&quot;8005&quot;</span> <span class="attr">shutdown</span>=<span class="string">&quot;SHUTDOWN&quot;</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>8005是Tomcat的管理端口，默认监听在127.0.0.1上。无需验证就可发送SHUTDOWN (大小写敏感)这个字符串，tomcat接收到后就会关闭此Server。</p>
<p><strong>此管理功能建议禁用，可将SHUTDOWN改为一串猜不出的字符串实现</strong></p>
<p><strong>或者port修改成 0, 会使用随机端口,如:36913</strong></p>
<p><strong>port设为-1等无效端口,将关闭此功能，注意：-2等不支持</strong></p>
<p><strong>此行不能被注释,否则无法启动tomcat服务</strong></p>
<p>范例:</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">Server</span> <span class="attr">port</span>=<span class="string">&quot;8005&quot;</span> <span class="attr">shutdown</span>=<span class="string">&quot;44ba3c71d57f494992641b258b965f28&quot;</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>范例：修改8005/tcp端口管理命令</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ~]<span class="comment"># ss -ntl</span></span><br><span class="line">State       Recv-Q       Send-Q           Local Address:Port          Peer Address:Port     </span><br><span class="line">LISTEN      0             128                   0.0.0.0:22                 0.0.0.0:*         </span><br><span class="line">LISTEN      0             100                         *:8080                     *:* </span><br><span class="line">LISTEN      0             128                      [::]:22                    [::]:*</span><br><span class="line">LISTEN      0             1          [::ffff:127.0.0.1]:8005                     *:*         </span><br><span class="line">LISTEN      0             100                         *:8009                     *:*</span><br><span class="line"></span><br><span class="line">[root@centos8 ~]<span class="comment"># telnet 127.0.0.1 8005</span></span><br><span class="line">Trying 127.0.0.1...</span><br><span class="line">Connected to 127.0.0.1.</span><br><span class="line">Escape character is <span class="string">&#x27;^]&#x27;</span>.</span><br><span class="line">SHUTDOWN <span class="comment">#执行命令关闭tomcat</span></span><br><span class="line">Connection closed by foreign host.</span><br><span class="line"></span><br><span class="line">[root@centos8 ~]<span class="comment"># ss -ntl</span></span><br><span class="line">State       Recv-Q       Send-Q           Local Address:Port          Peer Address:Port     </span><br><span class="line">LISTEN      0             128                   0.0.0.0:22                 0.0.0.0:*         </span><br><span class="line">LISTEN      0             128                      [::]:22                    [::]:*</span><br><span class="line"></span><br><span class="line">[root@centos8 tomcat]<span class="comment"># vim conf/server.xml </span></span><br><span class="line">&lt;Server port=<span class="string">&quot;8005&quot;</span> shutdown=<span class="string">&quot;magedu&quot;</span>&gt;</span><br><span class="line"></span><br><span class="line">[root@centos8 tomcat]<span class="comment"># systemctl start tomcat</span></span><br><span class="line">[root@centos8 tomcat]<span class="comment"># telnet 127.0.0.1 8005</span></span><br><span class="line">Trying 127.0.0.1...</span><br><span class="line">Connected to 127.0.0.1.</span><br><span class="line">Escape character is <span class="string">&#x27;^]&#x27;</span>.</span><br><span class="line">SHUTDOWN</span><br><span class="line">Connection closed by foreign host.</span><br><span class="line"></span><br><span class="line">[root@centos8 tomcat]<span class="comment"># ss -ntl</span></span><br><span class="line">State       Recv-Q       Send-Q           Local Address:Port          Peer Address:Port     </span><br><span class="line">LISTEN      0             128                   0.0.0.0:22                 0.0.0.0:*         </span><br><span class="line">LISTEN      0             100                         *:8080                     *:* </span><br><span class="line">LISTEN      0             128                      [::]:22                    [::]:*</span><br><span class="line">LISTEN      0             1          [::ffff:127.0.0.1]:8005                     *:*         </span><br><span class="line">LISTEN      0             100                         *:8009                     *:*</span><br><span class="line"></span><br><span class="line">[root@centos8 tomcat]<span class="comment"># telnet 127.0.0.1 8005</span></span><br><span class="line">Trying 127.0.0.1...</span><br><span class="line">Connected to 127.0.0.1.</span><br><span class="line">Escape character is <span class="string">&#x27;^]&#x27;</span>.</span><br><span class="line">magedu</span><br><span class="line">Connection closed by foreign host.</span><br><span class="line"></span><br><span class="line">[root@centos8 ~]<span class="comment"># ss -ntl</span></span><br><span class="line">State       Recv-Q       Send-Q           Local Address:Port          Peer Address:Port     </span><br><span class="line">LISTEN      0             128                   0.0.0.0:22                 0.0.0.0:*         </span><br><span class="line">LISTEN      0             128                      [::]:22                    [::]:*</span><br></pre></td></tr></table></figure>

<h4 id="显示指定的http服务器版本信息"><a href="#显示指定的http服务器版本信息" class="headerlink" title="显示指定的http服务器版本信息"></a>显示指定的http服务器版本信息</h4><p>默认不显示tomcat的http的Server头信息, 可以指定tomcat的http的Server头信息为相应的值</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">#conf/server.xml</span><br><span class="line"><span class="tag">&lt;<span class="name">Connector</span> <span class="attr">port</span>=<span class="string">&quot;8080&quot;</span> <span class="attr">protocol</span>=<span class="string">&quot;HTTP/1.1&quot;</span>  <span class="attr">connectionTimeout</span>=<span class="string">&quot;20000&quot;</span></span></span><br><span class="line"><span class="tag"><span class="attr">redirectPort</span>=<span class="string">&quot;8443&quot;</span> <span class="attr">Server</span>=<span class="string">&quot;SOME STRING&quot;</span>/&gt;</span> </span><br></pre></td></tr></table></figure>

<p>范例:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ~]<span class="comment"># curl -I 127.0.0.1:8080 </span></span><br><span class="line">HTTP/1.1 200</span><br><span class="line">Content-Type: text/html;charset=UTF-8</span><br><span class="line">Transfer-Encoding: chunked</span><br><span class="line">Date: Fri, 17 Jul 2020 08:32:52 GMT</span><br><span class="line"></span><br><span class="line"><span class="comment">#修改配置,指定想显示的tomcat版本</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># vim /usr/local/tomcat/conf/server.xml </span></span><br><span class="line">......</span><br><span class="line"> &lt;Connector port=<span class="string">&quot;8080&quot;</span> protocol=<span class="string">&quot;HTTP/1.1&quot;</span></span><br><span class="line">               connectionTimeout=<span class="string">&quot;20000&quot;</span></span><br><span class="line">               redirectPort=<span class="string">&quot;8443&quot;</span> Server=<span class="string">&quot;WangServer&quot;</span>/&gt; </span><br><span class="line">......</span><br><span class="line"></span><br><span class="line">[root@centos8 ~]<span class="comment"># systemctl restart tomcat</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># curl 127.0.0.1:8080 -I</span></span><br><span class="line">HTTP/1.1 200</span><br><span class="line">Content-Type: text/html;charset=UTF-8</span><br><span class="line">Transfer-Encoding: chunked</span><br><span class="line">Date: Fri, 17 Jul 2020 08:34:17 GMT</span><br><span class="line">Server: WangServer</span><br></pre></td></tr></table></figure>

<h4 id="其它配置"><a href="#其它配置" class="headerlink" title="其它配置"></a>其它配置</h4><p>conf/server.xml中可以配置service，connector, Engine,Host等</p>
<ul>
<li>service配置</li>
</ul>
<p>一般情况下，一个Server实例配置一个Service，name属性相当于该Service的ID。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">Service</span> <span class="attr">name</span>=<span class="string">&quot;Catalina&quot;</span>&gt;</span></span><br></pre></td></tr></table></figure>

<ul>
<li>连接器配置</li>
</ul>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">Connector</span> <span class="attr">port</span>=<span class="string">&quot;8080&quot;</span> <span class="attr">protocol</span>=<span class="string">&quot;HTTP/1.1&quot;</span></span></span><br><span class="line"><span class="tag">               <span class="attr">connectionTimeout</span>=<span class="string">&quot;20000&quot;</span></span></span><br><span class="line"><span class="tag">               <span class="attr">redirectPort</span>=<span class="string">&quot;8443&quot;</span> /&gt;</span></span><br></pre></td></tr></table></figure>

<p>redirectPort，如果访问HTTPS协议，自动转向这个连接器。但大多数时候，Tomcat并不会开启HTTPS，因为Tomcat往往部署在内部，HTTPS性能较差</p>
<ul>
<li>引擎配置</li>
</ul>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">Engine</span> <span class="attr">name</span>=<span class="string">&quot;Catalina&quot;</span> <span class="attr">defaultHost</span>=<span class="string">&quot;localhost&quot;</span>&gt;</span></span><br></pre></td></tr></table></figure>

<ul>
<li>defaultHost 配置</li>
</ul>
<p>defaultHost指向内部定义某虚拟主机。缺省虚拟主机可以改动，默认localhost。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">Host</span> <span class="attr">name</span>=<span class="string">&quot;localhost&quot;</span>  <span class="attr">appBase</span>=<span class="string">&quot;webapps&quot;</span> <span class="attr">unpackWARs</span>=<span class="string">&quot;true&quot;</span> <span class="attr">autoDeploy</span>=<span class="string">&quot;true&quot;</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h4 id="多虚拟主机配置"><a href="#多虚拟主机配置" class="headerlink" title="多虚拟主机配置"></a>多虚拟主机配置</h4><h5 id="多虚拟主机配置说明"><a href="#多虚拟主机配置说明" class="headerlink" title="多虚拟主机配置说明"></a>多虚拟主机配置说明</h5><ul>
<li>name 必须是主机名，用主机名来匹配</li>
<li>appBase 当前主机的网页根目录，是相对于 $CATALINA_HOME ，也可以使用绝对路径</li>
<li>unpackWARs 是否自动解压war格式</li>
<li>autoDeploy 热部署，自动加载并运行应用</li>
</ul>
<p><strong>虚拟主机配置过程</strong></p>
<ul>
<li>再添加和配置一个新的虚拟主机，并将myapp部署到/data/webapps目录下</li>
</ul>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">vim conf/server.xml </span><br><span class="line">#在文件最后面增加下面内容</span><br><span class="line"><span class="tag">&lt;<span class="name">Host</span> <span class="attr">name</span>=<span class="string">&quot;web1.magedu.org&quot;</span> <span class="attr">appBase</span>=<span class="string">&quot;/data/webapps/&quot;</span> <span class="attr">unpackWARs</span>=<span class="string">&quot;True&quot;</span> <span class="attr">autoDeploy</span>=<span class="string">&quot;false&quot;</span>&gt;</span></span><br><span class="line">    </span><br><span class="line">#虚拟主机专有访问日志</span><br><span class="line"><span class="tag">&lt;<span class="name">Valve</span> <span class="attr">className</span>=<span class="string">&quot;org.apache.catalina.valves.AccessLogValve&quot;</span> <span class="attr">directory</span>=<span class="string">&quot;logs&quot;</span> </span></span><br><span class="line"><span class="tag"><span class="attr">prefix</span>=<span class="string">&quot;web1_access_log&quot;</span> <span class="attr">suffix</span>=<span class="string">&quot;.txt&quot;</span> <span class="attr">pattern</span>=<span class="string">&quot;%h %l %u %t <span class="symbol">&amp;quot;</span>%r<span class="symbol">&amp;quot;</span> %s %b&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">Host</span>&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#以下行是自带的不需要修改</span><br><span class="line"><span class="tag">&lt;/<span class="name">Engine</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">Service</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">Server</span>&gt;</span></span><br><span class="line"></span><br><span class="line">#或者如果不加日志也可以用下面简化写法</span><br><span class="line"><span class="tag">&lt;<span class="name">Host</span> <span class="attr">name</span>=<span class="string">&quot;web1.magedu.org&quot;</span> <span class="attr">appBase</span>=<span class="string">&quot;/data/webapps/&quot;</span> <span class="attr">unpackWARs</span>=<span class="string">&quot;True&quot;</span></span></span><br><span class="line"><span class="tag"><span class="attr">autoDeploy</span>=<span class="string">&quot;false&quot;</span>/&gt;</span></span><br></pre></td></tr></table></figure>

<ul>
<li>准备虚拟主机的数据目录</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">常见虚拟主机根目录</span><br><span class="line"><span class="comment"># mkdir /data/webapps/ROOT -pv</span></span><br><span class="line"><span class="comment"># chown -R tomcat.tomcat /data/webapps</span></span><br><span class="line"><span class="comment"># echo web1.magedu.org &gt; /data/webapps/ROOT/index.html</span></span><br></pre></td></tr></table></figure>

<ul>
<li>测试</li>
</ul>
<p>刚才在虚拟主机中主机名定义node1.magedu.org，所以需要主机在本机手动配置一个域名解析。</p>
<p>如果是windows，修改在C:\Windows\System32\drivers\etc下的hosts文件，需要管理员权限。</p>
<p>使用<a target="_blank" rel="noopener" href="http://web1.magedu.org:8080/%E8%AE%BF%E9%97%AE%E6%9F%A5%E7%9C%8B">http://web1.magedu.org:8080/访问查看</a></p>
<h5 id="实战案例：tomcat实现多虚拟主机"><a href="#实战案例：tomcat实现多虚拟主机" class="headerlink" title="实战案例：tomcat实现多虚拟主机"></a>实战案例：tomcat实现多虚拟主机</h5><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 tomcat]<span class="comment"># pwd</span></span><br><span class="line">/usr/local/tomcat</span><br><span class="line"></span><br><span class="line">[root@centos8 tomcat]<span class="comment"># vim conf/server.xml </span></span><br><span class="line">[root@centos8 tomcat]<span class="comment"># tail conf/server.xml</span></span><br><span class="line">               pattern=<span class="string">&quot;%h %l %u %t &amp;quot;%r&amp;quot; %s %b&quot;</span> /&gt;</span><br><span class="line">     &lt;/Host&gt;</span><br><span class="line"><span class="comment">#添加了以下行</span></span><br><span class="line">       &lt;Host name=<span class="string">&quot;node1.magedu.org&quot;</span>  appBase=<span class="string">&quot;/data/webapps1/&quot;</span></span><br><span class="line">unpackWARs=<span class="string">&quot;true&quot;</span> autoDeploy=<span class="string">&quot;true&quot;</span>&gt;</span><br><span class="line">           &lt;Valve className=<span class="string">&quot;org.apache.catalina.valves.AccessLogValve&quot;</span></span><br><span class="line">directory=<span class="string">&quot;logs&quot;</span></span><br><span class="line">              prefix=<span class="string">&quot;node1_access_log&quot;</span> suffix=<span class="string">&quot;.txt&quot;</span></span><br><span class="line">               pattern=<span class="string">&quot;%h %l %u %t &amp;quot;%r&amp;quot; %s %b&quot;</span> /&gt;</span><br><span class="line">       &lt;/Host&gt;</span><br><span class="line">       &lt;Host name=<span class="string">&quot;node2.magedu.org&quot;</span>  appBase=<span class="string">&quot;/data/webapps2/&quot;</span></span><br><span class="line">unpackWARs=<span class="string">&quot;true&quot;</span> autoDeploy=<span class="string">&quot;true&quot;</span>&gt;</span><br><span class="line">       &lt;Valve className=<span class="string">&quot;org.apache.catalina.valves.AccessLogValve&quot;</span></span><br><span class="line">directory=<span class="string">&quot;logs&quot;</span></span><br><span class="line">              prefix=<span class="string">&quot;node2_access_log&quot;</span> suffix=<span class="string">&quot;.txt&quot;</span></span><br><span class="line">              pattern=<span class="string">&quot;%h %l %u %t &amp;quot;%r&amp;quot; %s %b&quot;</span> /&gt;</span><br><span class="line">       &lt;/Host&gt;</span><br><span class="line">   &lt;/Engine&gt;</span><br><span class="line"> &lt;/Service&gt;</span><br><span class="line">&lt;/Server&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment">#对每个虚拟主机，准备数据</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># mkdir /data/webapps&#123;1,2&#125;/ROOT -pv </span></span><br><span class="line"><span class="built_in">mkdir</span>: created directory <span class="string">&#x27;/data/webapps1/ROOT&#x27;</span></span><br><span class="line"><span class="built_in">mkdir</span>: created directory <span class="string">&#x27;/data/webapps2/ROOT&#x27;</span></span><br><span class="line"></span><br><span class="line">[root@centos8 ~]<span class="comment"># cat /data/webapps1/ROOT/index.jsp </span></span><br><span class="line">&lt;%@ page language=<span class="string">&quot;java&quot;</span> contentType=<span class="string">&quot;text/html; charset=UTF-8&quot;</span></span><br><span class="line">    pageEncoding=<span class="string">&quot;UTF-8&quot;</span>%&gt;</span><br><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;<span class="built_in">head</span>&gt;</span><br><span class="line">   &lt;meta charset=<span class="string">&quot;utf-8&quot;</span>&gt;</span><br><span class="line">   &lt;title&gt;jsp例子&lt;/title&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">后面的内容是服务器端动态生成字符串，最后拼接在一起</span><br><span class="line">&lt;br&gt;</span><br><span class="line">&lt;%=request.getRequestURL()%&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br><span class="line"></span><br><span class="line">[root@centos8 ~]<span class="comment"># cat /data/webapps2/ROOT/index.jsp </span></span><br><span class="line">&lt;%@ page language=<span class="string">&quot;java&quot;</span> contentType=<span class="string">&quot;text/html; charset=UTF-8&quot;</span></span><br><span class="line">    pageEncoding=<span class="string">&quot;UTF-8&quot;</span>%&gt;</span><br><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;<span class="built_in">head</span>&gt;</span><br><span class="line">   &lt;meta charset=<span class="string">&quot;utf-8&quot;</span>&gt;</span><br><span class="line">   &lt;title&gt;jsp例子&lt;/title&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">后面的内容是服务器端动态生成字符串，最后拼接在一起</span><br><span class="line">&lt;br&gt;</span><br><span class="line">&lt;%=request.getRequestURL()%&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment">#设置权限</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># chown -R tomcat.tomcat /data/webapps&#123;1,2&#125;/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#准备虚拟主机的名称解析</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># cat /etc/hosts</span></span><br><span class="line">10.0.0.8 node1.magedu.org node2.magedu.org</span><br><span class="line"></span><br><span class="line">[root@centos8 ~]<span class="comment"># curl http://node1.magedu.org:8080/</span></span><br><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;<span class="built_in">head</span>&gt;</span><br><span class="line">   &lt;meta charset=<span class="string">&quot;utf-8&quot;</span>&gt;</span><br><span class="line">   &lt;title&gt;jsp例子&lt;/title&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">后面的内容是服务器端动态生成字符串，最后拼接在一起</span><br><span class="line">http://node1.magedu.org:8080/</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br><span class="line"></span><br><span class="line">[root@centos8 ~]<span class="comment"># curl http://node2.magedu.org:8080/</span></span><br><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;<span class="built_in">head</span>&gt;</span><br><span class="line">   &lt;meta charset=<span class="string">&quot;utf-8&quot;</span>&gt;</span><br><span class="line">   &lt;title&gt;jsp例子&lt;/title&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">后面的内容是服务器端动态生成字符串，最后拼接在一起</span><br><span class="line">http://node2.magedu.org:8080/</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure>

<h5 id="实战案例：修改tomcat实现多虚拟主机的端口为80"><a href="#实战案例：修改tomcat实现多虚拟主机的端口为80" class="headerlink" title="实战案例：修改tomcat实现多虚拟主机的端口为80"></a>实战案例：修改tomcat实现多虚拟主机的端口为80</h5><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"> [root@centos8 ~]<span class="comment"># vim /usr/local/tomcat/conf/server.xml</span></span><br><span class="line"> &lt;Connector port=<span class="string">&quot;80&quot;</span> protocol=<span class="string">&quot;HTTP/1.1&quot;</span></span><br><span class="line">               connectionTimeout=<span class="string">&quot;20000&quot;</span></span><br><span class="line">               redirectPort=<span class="string">&quot;8443&quot;</span> /&gt;</span><br><span class="line">               </span><br><span class="line"><span class="comment">#注意: 因为以tomcat用户运行,不能直接使用1024以下的端口,需要修改tomcat的运行身份,否则会出现下面错误</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># tail -f /usr/local/tomcat/logs/catalina.out</span></span><br><span class="line"> Caused by: java.net.SocketException: Permission denied</span><br><span class="line"> </span><br><span class="line">[root@centos8 ~]<span class="comment"># vim /lib/systemd/system/tomcat.service </span></span><br><span class="line">[Service]</span><br><span class="line">.....</span><br><span class="line"><span class="comment">#User=tomcat</span></span><br><span class="line"><span class="comment">#Group=tomcat</span></span><br><span class="line"></span><br><span class="line">[root@centos8 ~]<span class="comment"># systemctl daemon-reload</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># systemctl restart tomcat</span></span><br></pre></td></tr></table></figure>

<h4 id="基于web方式的Host-Manager虚拟主机管理"><a href="#基于web方式的Host-Manager虚拟主机管理" class="headerlink" title="基于web方式的Host Manager虚拟主机管理"></a>基于web方式的Host Manager虚拟主机管理</h4><p>可以通过tomcat的管理页面点下面Host Manager按钮进入管理虚拟主机的页面</p>
<p><img src="../../../../images/SRE/day33/63.jpg" alt="63"></p>
<p>默认Host Manager 管理页被禁用，会出现下面提示</p>
<p><img src="../../../../images/SRE/day33/64.jpg" alt="64"></p>
<h5 id="允许本机访问"><a href="#允许本机访问" class="headerlink" title="允许本机访问"></a>允许本机访问</h5><p>配置如下</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 tomcat]# vim conf/tomcat-users.xml </span><br><span class="line"><span class="tag">&lt;<span class="name">tomcat-users</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://tomcat.apache.org/xml&quot;</span></span></span><br><span class="line"><span class="tag">              <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">              <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://tomcat.apache.org/xml tomcat-users.xsd&quot;</span></span></span><br><span class="line"><span class="tag">              <span class="attr">version</span>=<span class="string">&quot;1.0&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">role</span> <span class="attr">rolename</span>=<span class="string">&quot;manager-gui&quot;</span>/&gt;</span> #3.4.4.6添加的内容</span><br><span class="line">    <span class="tag">&lt;<span class="name">role</span> <span class="attr">rolename</span>=<span class="string">&quot;admin-gui&quot;</span> /&gt;</span>   #添加新的role </span><br><span class="line">    <span class="tag">&lt;<span class="name">user</span> <span class="attr">username</span>=<span class="string">&quot;admin&quot;</span> <span class="attr">password</span>=<span class="string">&quot;123456&quot;</span> <span class="attr">roles</span>=<span class="string">&quot;manager-gui,admin-gui&quot;</span>/&gt;</span> #再加新role</span><br><span class="line">    </span><br><span class="line"><span class="tag">&lt;/<span class="name">tomcat-users</span>&gt;</span></span><br><span class="line"></span><br><span class="line">[root@centos8 tomcat]# systemctl restart tomcat</span><br></pre></td></tr></table></figure>

<p>重启Tomcat后，点击”Host Manager”按钮</p>
<p><img src="../../../../images/SRE/day33/65.jpg" alt="65"><br><img src="../../../../images/SRE/day33/66.jpg" alt="66"></p>
<h5 id="允许远程主机访问"><a href="#允许远程主机访问" class="headerlink" title="允许远程主机访问"></a>允许远程主机访问</h5><p>但通过远程访问地址仍无法访问Host Manager管理页面</p>
<p><img src="../../../../images/SRE/day33/67.jpg" alt="67"></p>
<p>默认无法通过网络远程访问Host Manager管理页面，默认会出现以下界面</p>
<p><img src="../../../../images/SRE/day33/68.jpg" alt="68"></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 tomcat]<span class="comment">#vim webapps/host-manager/META-INF/context.xml </span></span><br><span class="line">&lt;Context antiResourceLocking=<span class="string">&quot;false&quot;</span> privileged=<span class="string">&quot;true&quot;</span> &gt;</span><br><span class="line"> &lt;Valve className=<span class="string">&quot;org.apache.catalina.valves.RemoteAddrValve&quot;</span></span><br><span class="line">         allow=<span class="string">&quot;127\.\d+\.\d+\.\d+|::1|0:0:0:0:0:0:0:1|10\.0\.0\.\d+&quot;</span> /&gt;</span><br><span class="line"> &lt;Manager sessionAttributeValueClassNameFilter=<span class="string">&quot;java\.lang\.</span></span><br><span class="line"><span class="string">(?:Boolean|Integer|Long|Number|String)|org\.apach</span></span><br><span class="line"><span class="string">e\.catalina\.filters\.CsrfPreventionFilter\$LruCache(?:\$1)?|java\.util\.(?:Linked)?HashMap&quot;</span>/&gt;</span><br><span class="line">&lt;/Context&gt;</span><br></pre></td></tr></table></figure>

<p>无需重启服务，直接访问，输入前面的用户和密码，即可登录成功</p>
<p><img src="../../../../images/SRE/day33/69.jpg" alt="69"></p>
<p><img src="../../../../images/SRE/day33/70.jpg" alt="70"></p>
<h5 id="创建新的虚拟主机"><a href="#创建新的虚拟主机" class="headerlink" title="创建新的虚拟主机"></a>创建新的虚拟主机</h5><p>可以管理虚拟主机</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#创建虚拟主机前,必须先创建相关目录,否则创建虚拟机不成功</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># mkdir /data/node1/ROOT/</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># echo node1.magedu.org &gt; /data/node1/ROOT/index.html</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># chown -R tomcat.tomcat /data/node1/</span></span><br></pre></td></tr></table></figure>

<p><img src="../../../../images/SRE/day33/70.jpg" alt="70"><br><img src="../../../../images/SRE/day33/71.jpg" alt="71"><br><img src="../../../../images/SRE/day33/72.jpg" alt="72"><br><img src="../../../../images/SRE/day33/73.jpg" alt="73"></p>
<h4 id="Context-配置"><a href="#Context-配置" class="headerlink" title="Context 配置"></a>Context 配置</h4><h5 id="Centext-配置方式"><a href="#Centext-配置方式" class="headerlink" title="Centext 配置方式"></a>Centext 配置方式</h5><p>Context作用：</p>
<ul>
<li>路径映射：将url映射至指定路径，而非使用appBase下的物理目录，实现虚拟目录功能</li>
<li>应用独立配置，例如单独配置应用日志、单独配置应用访问控制</li>
</ul>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">#映射指定路径</span><br><span class="line"><span class="tag">&lt;<span class="name">Context</span> <span class="attr">path</span>=<span class="string">&quot;/test&quot;</span> <span class="attr">docBase</span>=<span class="string">&quot;/data/test&quot;</span> <span class="attr">reloadable</span>=<span class="string">&quot;true&quot;</span> /&gt;</span></span><br><span class="line"></span><br><span class="line">#映射站点的根目录</span><br><span class="line"><span class="tag">&lt;<span class="name">Context</span> <span class="attr">path</span>=<span class="string">&quot;/&quot;</span> <span class="attr">docBase</span>=<span class="string">&quot;/data/website&quot;</span> <span class="attr">reloadable</span>=<span class="string">&quot;true&quot;</span> /&gt;</span></span><br><span class="line"></span><br><span class="line">#还可以添加日志等独立的配置</span><br><span class="line"><span class="tag">&lt;<span class="name">Context</span> <span class="attr">path</span>=<span class="string">&quot;/test&quot;</span> <span class="attr">docBase</span>=<span class="string">&quot;/data/test&quot;</span> <span class="attr">reloadable</span>=<span class="string">&quot;true&quot;</span> &gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">Valve</span> <span class="attr">className</span>=<span class="string">&quot;org.apache.catalina.valves.AccessLogValve&quot;</span> <span class="attr">directory</span>=<span class="string">&quot;logs&quot;</span></span></span><br><span class="line"><span class="tag">               <span class="attr">prefix</span>=<span class="string">&quot;localhost_test_log&quot;</span> <span class="attr">suffix</span>=<span class="string">&quot;.txt&quot;</span></span></span><br><span class="line"><span class="tag">               <span class="attr">pattern</span>=<span class="string">&quot;%h %l %u %t <span class="symbol">&amp;quot;</span>%r<span class="symbol">&amp;quot;</span> %s %b&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">Context</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>说明：</p>
<ul>
<li>path：指的是访问的URL路径，如果path与appBase下面的子目录同名，context的docBase路径优先级更高</li>
<li>docBase：可以是磁盘文件的绝对路径，也可以是相对路径（相对于Host的appBase）</li>
<li>reloadable：true表示如果WEB-INF/classes或META-INF/lib目录下.class文件有改动，就会将WEB应用重新加载。生产环境中，建议使用false来禁用。</li>
</ul>
<p>Centext实现过程</p>
<ul>
<li>将~/projects/myapp/下面的项目文件复制到/data/下，可以修改一下index.jsp 区别一下</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># cp -r ~/projects/myapp /data/myapp-v1</span></span><br><span class="line"><span class="comment"># vim /data/myappv1/index.jsp </span></span><br><span class="line"><span class="comment"># cd /data</span></span><br><span class="line"><span class="comment"># ln -sv myapp-v1 test</span></span><br></pre></td></tr></table></figure>

<p><strong>注意：</strong>这里特别使用了软链接，原因方便后期版升级或回滚，如是是版本升级，需要将软链接指向myappv2，重新启动。如果新版上线后，出现问题，重新修改软链接到上一个版本的目录，并重启，就可以实现回滚</p>
<ul>
<li>修改conf/server.xml设置context</li>
</ul>
<p>Tomcat的配置文件server.xml中修改如下，重启Tomcat生效</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">Host</span> <span class="attr">name</span>=<span class="string">&quot;node1.magedu.com&quot;</span>  <span class="attr">appBase</span>=<span class="string">&quot;/data/webapps&quot;</span></span></span><br><span class="line"><span class="tag">            <span class="attr">unpackWARs</span>=<span class="string">&quot;true&quot;</span> <span class="attr">autoDeploy</span>=<span class="string">&quot;true&quot;</span> &gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">Context</span> <span class="attr">path</span>=<span class="string">&quot;/test&quot;</span> <span class="attr">docBase</span>=<span class="string">&quot;/data/test&quot;</span> <span class="attr">reloadable</span>=<span class="string">&quot;true&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">Host</span>&gt;</span></span><br></pre></td></tr></table></figure>

<ul>
<li><p>测试</p>
<p>使用<a target="_blank" rel="noopener" href="http://node1.magedu.com:8080/test/">http://node1.magedu.com:8080/test/</a></p>
</li>
</ul>
<h5 id="Valve组件"><a href="#Valve组件" class="headerlink" title="Valve组件"></a>Valve组件</h5><p>日志格式说明</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://tomcat:8080/docs/config/valve.html#Access_Logging</span><br></pre></td></tr></table></figure>

<p>valve(阀门)组件可以定义日志</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">Valve</span> <span class="attr">className</span>=<span class="string">&quot;org.apache.catalina.valves.AccessLogValve&quot;</span> <span class="attr">directory</span>=<span class="string">&quot;logs&quot;</span></span></span><br><span class="line"><span class="tag">            <span class="attr">prefix</span>=<span class="string">&quot;localhost_access_log&quot;</span> <span class="attr">suffix</span>=<span class="string">&quot;.txt&quot;</span></span></span><br><span class="line"><span class="tag">            <span class="attr">pattern</span>=<span class="string">&quot;%h %l %u %t <span class="symbol">&amp;quot;</span>%r<span class="symbol">&amp;quot;</span> %s %b&quot;</span> /&gt;</span></span><br></pre></td></tr></table></figure>

<p><strong>valve存在多种类型：</strong></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">定义访问日志：org.apache.catalina.valves.AccessLogValve</span><br><span class="line">定义访问控制：org.apache.catalina.valves.RemoteAddrValve</span><br></pre></td></tr></table></figure>

<p>示例:</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">Valve</span> <span class="attr">className</span>=<span class="string">&quot;org.apache.catalina.valves.RemoteAddrValve&quot;</span></span></span><br><span class="line"><span class="tag"><span class="attr">deny</span>=<span class="string">&quot;10\.0\.0\.\d+&quot;</span>/&gt;</span></span><br></pre></td></tr></table></figure>

<h5 id="实战案例"><a href="#实战案例" class="headerlink" title="实战案例"></a>实战案例</h5><p><strong>范例：虚拟主机上利用context实现虚拟目录</strong></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#在前面范例的基础上实现，继续创建node1.magedu.org虚拟主机下的物理子目录</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># mkdir /data/webapps1/app1/</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># echo /data/webapps1/app1/index.html &gt; /data/webapps1/app1/index.html</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># curl http://node1.magedu.org:8080/app1/</span></span><br><span class="line">/data/webapps1/app1/index.html</span><br><span class="line"></span><br><span class="line"><span class="comment">#利用context实现node1.magedu.org虚拟主机下的虚拟子目录</span></span><br><span class="line">[root@centos8 tomcat]<span class="comment"># vim conf/server.xml</span></span><br><span class="line">[root@centos8 tomcat]<span class="comment"># tail conf/server.xml</span></span><br><span class="line">     &lt;/Host&gt;</span><br><span class="line">     &lt;Host  name=<span class="string">&quot;node1.magedu.org&quot;</span>  appBase=<span class="string">&quot;/data/webapps1&quot;</span>&gt;</span><br><span class="line">      <span class="comment">#加下面六行</span></span><br><span class="line">     &lt;Context path=<span class="string">&quot;/app1&quot;</span> docBase=<span class="string">&quot;/data/app1&quot;</span> reloadable=<span class="string">&quot;true&quot;</span> &gt;</span><br><span class="line">     &lt;Valve className=<span class="string">&quot;org.apache.catalina.valves.AccessLogValve&quot;</span></span><br><span class="line">directory=<span class="string">&quot;logs&quot;</span></span><br><span class="line">               prefix=<span class="string">&quot;node1.magedu.org_app1&quot;</span> suffix=<span class="string">&quot;.log&quot;</span></span><br><span class="line">               pattern=<span class="string">&quot;%h %l %u %t &amp;quot;%r&amp;quot; %s %b&quot;</span> /&gt;</span><br><span class="line">       &lt;Valve className=<span class="string">&quot;org.apache.catalina.valves.RemoteAddrValve&quot;</span></span><br><span class="line">deny=<span class="string">&quot;10\.0\.0\.7&quot;</span>/&gt;</span><br><span class="line">       &lt;/Context&gt;</span><br><span class="line">      </span><br><span class="line">     &lt;/Host&gt;</span><br><span class="line">     &lt;Host  name=<span class="string">&quot;node2.magedu.org&quot;</span>  appBase=<span class="string">&quot;/data/webapps2&quot;</span>&gt;</span><br><span class="line">     &lt;/Host&gt;</span><br><span class="line">   &lt;/Engine&gt;</span><br><span class="line"> &lt;/Service&gt;</span><br><span class="line">&lt;/Server&gt;</span><br><span class="line"></span><br><span class="line">[root@centos8 tomcat]<span class="comment"># systemctl restart tomcat</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#因数据没有准备好，出现下面错误</span></span><br><span class="line">[root@centos8 tomcat]<span class="comment"># curl http://node1.magedu.org:8080/app1/</span></span><br><span class="line">curl: (7) Failed to connect to node1.magedu.org port 8080: Connection refused</span><br><span class="line"></span><br><span class="line"><span class="comment">#准备数据目录</span></span><br><span class="line">[root@centos8 tomcat]<span class="comment"># mkdir /data/app1-v1</span></span><br><span class="line">[root@centos8 tomcat]<span class="comment"># echo /data/app1-v1/index.html &gt; /data/app1-v1/index.html</span></span><br><span class="line">[root@centos8 tomcat]<span class="comment"># ln -s /data/app1-v1/ /data/app1</span></span><br><span class="line">[root@centos8 tomcat]<span class="comment"># curl http://node1.magedu.org:8080/app1/</span></span><br><span class="line">curl: (7) Failed to connect to node1.magedu.org port 8080: Connection refused</span><br><span class="line"></span><br><span class="line"><span class="comment">#数据目录准备好，还需要重新启动服务，才能访问</span></span><br><span class="line">[root@centos8 tomcat]<span class="comment"># systemctl restart tomcat</span></span><br><span class="line"></span><br><span class="line">[root@centos8 tomcat]<span class="comment"># curl http://node1.magedu.org:8080/app1/</span></span><br><span class="line">/data/app1-v1/index.html</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@centos7 ~]<span class="comment"># curl -I http://node1.magedu.org:8080/app1/</span></span><br><span class="line">HTTP/1.1 403</span><br><span class="line">Content-Type: text/html;charset=utf-8</span><br><span class="line">Content-Language: en</span><br><span class="line">Transfer-Encoding: chunked</span><br><span class="line">Date: Tue, 14 Jul 2020 06:48:54 GMT</span><br><span class="line"></span><br><span class="line"><span class="comment">#可以看到此目录单独的访问日志</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># cat /usr/local/tomcat/logs/node1.magedu.org_app1.2020-07-14.log</span></span><br><span class="line">10.0.0.8 - - [14/Jul/2020:14:36:01 +0800] <span class="string">&quot;GET /app1/ HTTP/1.1&quot;</span> 200 330</span><br><span class="line">10.0.0.7 - - [14/Jul/2020:14:48:07 +0800] <span class="string">&quot;GET /app1/ HTTP/1.1&quot;</span> 403 618</span><br></pre></td></tr></table></figure>

<p><strong>范例: 基于前面环境,实现软件升级和回滚功能</strong></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#升级版本</span></span><br><span class="line">[root@centos8 tomcat]<span class="comment"># mkdir /data/app1-v2</span></span><br><span class="line">[root@centos8 tomcat]<span class="comment"># echo /data/app1-v2/index.html &gt; /data/app1-v2/index.html</span></span><br><span class="line">[root@centos8 tomcat]<span class="comment"># rm -f /data/app1</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#删除软链接，仍然可以访问旧版本</span></span><br><span class="line">[root@centos8 tomcat]<span class="comment"># curl http://node1.magedu.org:8080/app1/</span></span><br><span class="line">/data/app1-v1/index.html</span><br><span class="line"></span><br><span class="line"><span class="comment">#重新服务后，出现错误</span></span><br><span class="line">[root@centos8 tomcat]<span class="comment"># systemctl restart tomcat</span></span><br><span class="line">[root@centos8 tomcat]<span class="comment"># curl http://node1.magedu.org:8080/app1/</span></span><br><span class="line">curl: (7) Failed to connect to node1.magedu.org port 8080: Connection refused</span><br><span class="line"></span><br><span class="line"><span class="comment">#新建软链接，指向新版，仍需重启服务才生效</span></span><br><span class="line">[root@centos8 tomcat]<span class="comment"># ln -s /data/app1-v2/ /data/app1</span></span><br><span class="line">[root@centos8 tomcat]<span class="comment"># curl http://node1.magedu.org:8080/app1/</span></span><br><span class="line">curl: (7) Failed to connect to node1.magedu.org port 8080: Connection refused</span><br><span class="line"></span><br><span class="line">[root@centos8 tomcat]<span class="comment"># systemctl restart tomcat</span></span><br><span class="line">[root@centos8 tomcat]<span class="comment"># curl http://node1.magedu.org:8080/app1/</span></span><br><span class="line">/data/app1-v2/index.html</span><br><span class="line"></span><br><span class="line"><span class="comment">#软件降级或回滚</span></span><br><span class="line">[root@centos8 tomcat]<span class="comment"># rm -f /data/app1</span></span><br><span class="line">[root@centos8 tomcat]<span class="comment"># ln -s /data/app1-v1/ /data/app1</span></span><br><span class="line">[root@centos8 tomcat]<span class="comment"># systemctl restart tomcat</span></span><br><span class="line">[root@centos8 tomcat]<span class="comment"># curl http://node1.magedu.org:8080/app1/</span></span><br><span class="line">/data/app1-v1/index.html</span><br></pre></td></tr></table></figure>

<h1 id="结合反向代理实现-Tomcat-部署"><a href="#结合反向代理实现-Tomcat-部署" class="headerlink" title="结合反向代理实现 Tomcat 部署"></a>结合反向代理实现 Tomcat 部署</h1><h2 id="常见部署方式介绍"><a href="#常见部署方式介绍" class="headerlink" title="常见部署方式介绍"></a>常见部署方式介绍</h2><p><img src="../../../../images/SRE/day33/74.jpg" alt="74"></p>
<ul>
<li>standalone模式，Tomcat单独运行，直接接受用户的请求，不推荐。</li>
<li>反向代理，单机运行，提供了一个Nginx作为反向代理，可以做到静态由nginx提供响应，动态jsp代理给Tomcat<ul>
<li>LNMT：Linux + Nginx + MySQL + Tomcat</li>
<li>LAMT：Linux + Apache（Httpd）+ MySQL + Tomcat</li>
</ul>
</li>
<li>前置一台Nginx，给多台Tomcat实例做反向代理和负载均衡调度，Tomcat上部署的纯动态页面更适合<ul>
<li>LNMT：Linux + Nginx + MySQL + Tomcat</li>
</ul>
</li>
<li>多级代理<ul>
<li>LNNMT：Linux + Nginx + Nginx + MySQL + Tomcat</li>
</ul>
</li>
</ul>
<h2 id="利用-nginx-反向代理实现全部转发置指定同一个虚拟主机"><a href="#利用-nginx-反向代理实现全部转发置指定同一个虚拟主机" class="headerlink" title="利用 nginx 反向代理实现全部转发置指定同一个虚拟主机"></a>利用 nginx 反向代理实现全部转发置指定同一个虚拟主机</h2><h3 id="配置说明"><a href="#配置说明" class="headerlink" title="配置说明"></a>配置说明</h3><p><img src="../../../../images/SRE/day33/75.jpg" alt="75"></p>
<p>利用nginx反向代理功能，实现上图的代理功能，将用户请求全部转发至指定的同一个tomcat主机</p>
<p>利用nginx指令proxy_pass 可以向后端服务器转发请求报文,并且在转发时会保留客户端的请求报文中的host首部</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#从yum源安装nginx</span></span><br><span class="line"><span class="comment">#yum install nginx -y</span></span><br><span class="line"><span class="comment">#vim /etc/nginx/nginx.conf</span></span><br><span class="line"><span class="comment">#全部反向代理测试</span></span><br><span class="line">location / &#123;</span><br><span class="line">    <span class="comment"># proxy_pass http://127.0.0.1:8080; # 不管什么请求，都会访问后面的localhost虚拟主机</span></span><br><span class="line">   proxy_pass http://node1.magedu.com:8080; <span class="comment"># 此项将用户访问全部请求转发到node1的虚拟主机上</span></span><br><span class="line">    <span class="comment">#proxy_pass http://node2.magedu.com:8080; #此项将用户访问全部请求转发到node2的虚拟主机上</span></span><br><span class="line">    <span class="comment">#proxy_set_header Host $http_host; #转发主机头至后端服务器</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">#以上两项都需要修改nginx服务器的/etc/hosts,实现node1.magedu.com和node2.magedu.com到IP的解析    </span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">#nginx -t</span></span><br><span class="line"><span class="comment">#systemctl restart nginx</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#说明: proxy_pass http://FQDN/ 中的FQDN 决定转发至后端哪个虚拟主机,而与用户请求的URL无关</span></span><br><span class="line"><span class="comment">#如果转到后端的哪个服务器由用户请求决定,可以向后端服务转发请求的主机头实现,示例: </span></span><br><span class="line">proxy_set_header Host <span class="variable">$http_host</span>;</span><br></pre></td></tr></table></figure>

<h3 id="实战案例1"><a href="#实战案例1" class="headerlink" title="实战案例1"></a>实战案例1</h3><p>环境说明:</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">一台主机,实现nginx和tomcat</span><br><span class="line">tomcat上有两个虚拟主机node1和node2</span><br></pre></td></tr></table></figure>

<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#先按3.4.5.4介绍方式在同一下主机上建立两个tomcat虚拟主机，node1.magedu.org和node2.magedu.org</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#修改/etc/hosts文件，实现名称解析</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># vim /etc/hosts</span></span><br><span class="line">127.0.0.1   localhost localhost.localdomain localhost4 localhost4.localdomain4 centos8.localdomain</span><br><span class="line">::1         localhost localhost.localdomain localhost6 localhost6.localdomain6</span><br><span class="line">10.0.0.100 node1.magedu.org node2.magedu.org</span><br><span class="line"></span><br><span class="line"><span class="comment">#安装nginx</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># yum -y install nginx</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#修改nginx.conf配置文件</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># vim /etc/nginx/nginx.conf</span></span><br><span class="line">......</span><br><span class="line"></span><br><span class="line"><span class="comment">#修改location / 此行，添加以下内容</span></span><br><span class="line">location / &#123;</span><br><span class="line">           <span class="comment">#proxy_pass http://127.0.0.1:8080;</span></span><br><span class="line">           proxy_pass http://node1.magedu.org:8080;   </span><br><span class="line">           <span class="comment">#proxy_set_header Host $http_host; #转发主机头至后端服务器</span></span><br><span class="line">           &#125;</span><br><span class="line">......</span><br><span class="line"></span><br><span class="line">[root@centos8 ~]<span class="comment"># systemctl enable --now nginx</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#分别访问node1,node2和IP都可以看到一样的node1的虚拟主机页面</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># curl http://node1.magedu.org/</span></span><br><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;<span class="built_in">head</span>&gt;</span><br><span class="line">   &lt;meta charset=<span class="string">&quot;utf-8&quot;</span>&gt;</span><br><span class="line">   &lt;title&gt;jsp例子&lt;/title&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">后面的内容是服务器端动态生成字符串，最后拼接在一起</span><br><span class="line">node1.magedu.org</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br><span class="line"></span><br><span class="line">[root@centos8 ~]<span class="comment"># curl http://node2.magedu.org/</span></span><br><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;<span class="built_in">head</span>&gt;</span><br><span class="line">   &lt;meta charset=<span class="string">&quot;utf-8&quot;</span>&gt;</span><br><span class="line">   &lt;title&gt;jsp例子&lt;/title&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">后面的内容是服务器端动态生成字符串，最后拼接在一起</span><br><span class="line">node2.magedu.org</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br><span class="line"></span><br><span class="line">[root@centos8 ~]<span class="comment"># curl http://127.0.0.1/</span></span><br><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;<span class="built_in">head</span>&gt;</span><br><span class="line">   &lt;meta charset=<span class="string">&quot;utf-8&quot;</span>&gt;</span><br><span class="line">   &lt;title&gt;jsp例子&lt;/title&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">后面的内容是服务器端动态生成字符串，最后拼接在一起</span><br><span class="line">node1.magedu.org</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br><span class="line"></span><br><span class="line">[root@centos8 ~]<span class="comment"># curl http://10.0.0.100/</span></span><br><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;<span class="built_in">head</span>&gt;</span><br><span class="line">   &lt;meta charset=<span class="string">&quot;utf-8&quot;</span>&gt;</span><br><span class="line">   &lt;title&gt;jsp例子&lt;/title&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">后面的内容是服务器端动态生成字符串，最后拼接在一起</span><br><span class="line">node1.magedu.org</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br><span class="line"></span><br><span class="line">[root@centos8 ~]<span class="comment"># systemctl restart nginx</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#再次修改nginx.conf配置文件</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># vim /etc/nginx/nginx.conf</span></span><br><span class="line">......</span><br><span class="line"><span class="comment">#修改location / 行，添加以下内容</span></span><br><span class="line">location / &#123;</span><br><span class="line">           <span class="comment">#proxy_pass http://127.0.0.1:8080;</span></span><br><span class="line">           proxy_pass http://node2.magedu.org:8080; </span><br><span class="line">           <span class="comment">#proxy_set_header Host $http_host; #转发主机头至后端服务器</span></span><br><span class="line">           &#125;</span><br><span class="line">......</span><br><span class="line"></span><br><span class="line"><span class="comment">#分别访问node1,node2和IP都可以看到一样的node2的虚拟主机页面</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># curl http://node1.magedu.org/</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># curl http://node2.magedu.org/</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># curl http://127.0.0.1/</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># curl http://10.0.0.100/</span></span><br><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;<span class="built_in">head</span>&gt;</span><br><span class="line">   &lt;meta charset=<span class="string">&quot;utf-8&quot;</span>&gt;</span><br><span class="line">   &lt;title&gt;jsp例子&lt;/title&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">后面的内容是服务器端动态生成字符串，最后拼接在一起</span><br><span class="line">node2.magedu.org</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure>

<h3 id="实战案例2"><a href="#实战案例2" class="headerlink" title="实战案例2"></a>实战案例2</h3><p>tomcat 实现 https的参考文档</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://help.aliyun.com/document_detail/98576.html?spm=5176.b657008.0.0.5a471b48Cyahpi</span><br></pre></td></tr></table></figure>

<p>范例： 实现 http自动跳转至 tomcat的https</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">  listen 80;</span><br><span class="line">  server_name blog.magedu.org;</span><br><span class="line">  <span class="built_in">return</span> 302 https://$host<span class="variable">$request_uri</span>;</span><br><span class="line">&#125;</span><br><span class="line">server &#123;</span><br><span class="line">  listen 443 ssl;</span><br><span class="line">  server_name blog.magedu.org;</span><br><span class="line">  ssl_certificate   /etc/nginx/ssl/www.magedu.org.pem;</span><br><span class="line">  ssl_certificate_key /etc/nginx/ssl/www.magedu.org.key;</span><br><span class="line">  location / &#123;</span><br><span class="line">    proxy_pass http://127.0.0.1:8080;</span><br><span class="line">    proxy_set_header Host  <span class="variable">$http_host</span>; </span><br><span class="line">    proxy_set_header X-Forwarded-For   <span class="variable">$proxy_add_x_forwarded_for</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="利用nginx实现动静分离代理"><a href="#利用nginx实现动静分离代理" class="headerlink" title="利用nginx实现动静分离代理"></a>利用nginx实现动静分离代理</h2><h3 id="配置说明-1"><a href="#配置说明-1" class="headerlink" title="配置说明"></a>配置说明</h3><p>可以利用nginx实现动静分离</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">vim nginx.conf</span><br><span class="line">root /usr/share/nginx/html;</span><br><span class="line"><span class="comment">#下面行可不加</span></span><br><span class="line"><span class="comment">#location / &#123;</span></span><br><span class="line"><span class="comment">#   root /data/webapps/ROOT;</span></span><br><span class="line"><span class="comment">#   index index.html;</span></span><br><span class="line"><span class="comment">#&#125;</span></span><br><span class="line"><span class="comment"># ~* 不区分大小写</span></span><br><span class="line">location ~* \.jsp$ &#123;</span><br><span class="line">    proxy_pass http://node1.magedu.com:8080; <span class="comment">#注意: 8080后不要加/,需要在nginx服务器修改 /etc/hosts</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>以上设置，可以将jsp的请求反向代理到tomcat，而其它文件仍由nginx处理，从而实现所谓动静分离。但由于jsp文件中实际上是由静态资源和动态组成，所以无法彻底实现动静分离。实际上Tomcat不太适合做动静分离，用它来管理程序的图片不好做动静分离部署</p>
<h3 id="实战案例-1"><a href="#实战案例-1" class="headerlink" title="实战案例"></a>实战案例</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#准备三个不同的资源文件</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># echo /usr/local/tomcat/webapps/ROOT/test.html &gt; /usr/local/tomcat/webapps/ROOT/test.html</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># echo /usr/local/tomcat/webapps/ROOT/test.jsp &gt; /usr/local/tomcat/webapps/ROOT/test.jsp</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># echo /usr/share/nginx/html/test.html &gt; /usr/share/nginx/html/test.html</span></span><br><span class="line"></span><br><span class="line">[root@centos8 ~]<span class="comment"># vim /etc/nginx/nginx.conf</span></span><br><span class="line">......</span><br><span class="line">root         /usr/share/nginx/html;</span><br><span class="line"><span class="comment">#location / &#123;</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#&#125;</span></span><br><span class="line">location ~* \.jsp$ &#123;</span><br><span class="line">   proxy_pass http://127.0.0.1:8080;                                             </span><br><span class="line">        &#125;</span><br><span class="line">......</span><br><span class="line"></span><br><span class="line">[root@centos8 ~]<span class="comment"># systemctl restart nginx</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#访问test.html，观察结果都一样访问的是nginx自身的资源</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># curl http://node1.magedu.org/test.html</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># curl http://node2.magedu.org/test.html</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># curl http://127.0.0.1/test.html</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># curl http://10.0.0.8/test.html</span></span><br><span class="line">/usr/share/nginx/html/test.html</span><br><span class="line"></span><br><span class="line"><span class="comment">#访问test.jsp，观察结果都一样访问的是tomcat的默认主机资源</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># curl http://node1.magedu.org/test.jsp</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># curl http://node2.magedu.org/test.jsp</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># curl http://127.0.0.1/test.jsp</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># curl http://10.0.0.8/test.jsp</span></span><br><span class="line">/usr/local/tomcat/webapps/ROOT/test.jsp</span><br></pre></td></tr></table></figure>

<p>范例: 实现单机的tomcat的服务器的动静分离</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">listen 80;</span><br><span class="line">server name java.wang.org;</span><br><span class="line">   location / &#123;</span><br><span class="line">       proxy_pass http://127.0.0.1:8080;</span><br><span class="line">       proxy_set_header Host <span class="variable">$http_host</span>;</span><br><span class="line">   &#125;</span><br><span class="line">   lcation ~* \.(png|jpg|jpeg|svg)<span class="variable">$&#123;</span></span><br><span class="line"><span class="variable">       root /data/www/images;</span></span><br><span class="line"><span class="variable">       expires 1d;</span></span><br><span class="line"><span class="variable">   &#125;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>范例: 实现多主机的负载均衡的动静分离</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#cat proxy.www.wang.org.conf</span></span><br><span class="line">upstream static &#123;</span><br><span class="line">   server 10.0.0.8:80;</span><br><span class="line">&#125;</span><br><span class="line">upstream tomcat &#123;</span><br><span class="line">   server 10.0.0.18:8080;</span><br><span class="line">&#125;</span><br><span class="line">server &#123;</span><br><span class="line">   listen 80;</span><br><span class="line">     server_name www.wang.org;</span><br><span class="line">     location / &#123;</span><br><span class="line">         proxy_pass http://tomcat;</span><br><span class="line">         proxy_set_header Host <span class="variable">$http_host</span>;</span><br><span class="line">     &#125;</span><br><span class="line">     location ~* .*\.(png|jpg|jpeg|gif)$ &#123;</span><br><span class="line">         proxy_pass http://static;</span><br><span class="line">         proxy_set_header Host <span class="variable">$http_host</span>;</span><br><span class="line">     &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="利用-httpd-实现基于AJP协议的反向代理至后端Tomcat服务器"><a href="#利用-httpd-实现基于AJP协议的反向代理至后端Tomcat服务器" class="headerlink" title="利用 httpd 实现基于AJP协议的反向代理至后端Tomcat服务器"></a>利用 httpd 实现基于AJP协议的反向代理至后端Tomcat服务器</h2><p><img src="../../../../images/SRE/day33/76.jpg" alt="76"></p>
<h3 id="AJP-协议说明"><a href="#AJP-协议说明" class="headerlink" title="AJP 协议说明"></a>AJP 协议说明</h3><p>AJP（Apache JServ Protocol）是定向包协议，是一个二进制的TCP传输协议，相比HTTP这种纯文本的协议来说，效率和性能更高，也做了很多优化。但是浏览器并不能直接支持AJP13协议，只支持HTTP协议。所以实际情况是，通过Apache的proxy_ajp模块进行反向代理，暴露成http协议给客户端访问</p>
<h3 id="启用和禁用-AJP"><a href="#启用和禁用-AJP" class="headerlink" title="启用和禁用 AJP"></a>启用和禁用 AJP</h3><p><strong>注意: Tomcat/8.5.51之后版本基于安全需求默认禁用AJP协议</strong></p>
<p><strong>范例: Tomcat/8.5.51之后版启用支持AJP协议</strong></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 tomcat]<span class="comment"># vim conf/server.xml</span></span><br><span class="line"><span class="comment">#取消前面的注释,并修改下面行,修改address和secretRequired</span></span><br><span class="line">&lt;Connector protocol=<span class="string">&quot;AJP/1.3&quot;</span>  address=<span class="string">&quot;0.0.0.0&quot;</span> port=<span class="string">&quot;8009&quot;</span></span><br><span class="line">redirectPort=<span class="string">&quot;8443&quot;</span> secretRequired=<span class="string">&quot;&quot;</span> /&gt;</span><br><span class="line"></span><br><span class="line">[root@centos8 tomcat]<span class="comment"># systemctl restart tomcat</span></span><br><span class="line">[root@centos8 tomcat]<span class="comment"># ss -ntl</span></span><br><span class="line">State         Recv-Q       Send-Q              Local Address:Port        Peer Address:Port</span><br><span class="line">LISTEN        0             128                      0.0.0.0:22               0.0.0.0:*</span><br><span class="line">LISTEN        0             100                    127.0.0.1:25               0.0.0.0:*</span><br><span class="line">LISTEN        0             128                         [::]:22                  [::]:*</span><br><span class="line">LISTEN        0             100                        [::1]:25                  [::]:*</span><br><span class="line">LISTEN        0             1             [::ffff:127.0.0.1]:8005                   *:*</span><br><span class="line">LISTEN        0             100           [::ffff:127.0.0.1]:8009                   *:*</span><br><span class="line">LISTEN        0             100                            *:8080                   *:*</span><br><span class="line">LISTEN        0             128                            *:80                     *:* </span><br></pre></td></tr></table></figure>

<p><strong>注意: secretRequired=”” 必须加上,否则出现以下错误提示</strong></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 tomcat]<span class="comment"># cat logs/catalina.log </span></span><br><span class="line">Caused by: java.lang.IllegalArgumentException: The AJP Connector is configured </span><br><span class="line">with secretRequired=<span class="string">&quot;true&quot;</span> but the secret attribute is either null or <span class="string">&quot;&quot;</span>. This </span><br><span class="line">combination is not valid.</span><br></pre></td></tr></table></figure>

<p>除httpd外，其它支持AJP代理的服务器非常少，比如Nginx就不支持AJP，所以目前一般都禁用AJP协议端口</p>
<p><strong>范例：禁用AJP协议</strong></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 tomcat]<span class="comment"># ss -ntl</span></span><br><span class="line">State         Recv-Q       Send-Q              Local Address:Port        Peer Address:Port</span><br><span class="line">LISTEN        0             128                      0.0.0.0:22               0.0.0.0:*</span><br><span class="line">LISTEN        0             128                         [::]:22                  [::]:*</span><br><span class="line">LISTEN        0             1             [::ffff:127.0.0.1]:8005                   *:*</span><br><span class="line">LISTEN        0             100           [::ffff:127.0.0.1]:8009                   *:*</span><br><span class="line">LISTEN        0             100                            *:8080                   *:*</span><br><span class="line">LISTEN        0             128                            *:80                     *:*</span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置tomcat配置文件，删除下面一行</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># vim /usr/local/tomcat/conf/server.xml </span></span><br><span class="line">&lt;Connector port=<span class="string">&quot;8009&quot;</span> protocol=<span class="string">&quot;AJP/1.3&quot;</span> redirectPort=<span class="string">&quot;8443&quot;</span> /&gt;</span><br><span class="line"></span><br><span class="line">[root@centos8 ~]<span class="comment"># systemctl restart tomcat</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># ss -ntl</span></span><br><span class="line">State         Recv-Q       Send-Q              Local Address:Port        Peer Address:Port</span><br><span class="line">LISTEN        0             128                      0.0.0.0:22               0.0.0.0:*</span><br><span class="line">LISTEN        0             128                         [::]:22                  [::]:*</span><br><span class="line">LISTEN        0             1             [::ffff:127.0.0.1]:8005                   *:*</span><br><span class="line">LISTEN        0             100                            *:8080                   *:*</span><br><span class="line">LISTEN        0             128                            *:80                     *:*</span><br></pre></td></tr></table></figure>

<h3 id="httpd-实现-AJP-反向代理"><a href="#httpd-实现-AJP-反向代理" class="headerlink" title="httpd 实现 AJP 反向代理"></a>httpd 实现 AJP 反向代理</h3><h4 id="配置说明-2"><a href="#配置说明-2" class="headerlink" title="配置说明"></a>配置说明</h4><p>相对来讲，AJP协议基于二进制比使用HTTP协议的连接器效率高些。</p>
<p><strong>proxy_ajp_module模块代理配置</strong></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">VirtualHost</span> *<span class="attr">:80</span>&gt;</span></span><br><span class="line">   ServerName       node1.magedu.org</span><br><span class="line">   ProxyRequests     Off</span><br><span class="line">   ProxyVia         On</span><br><span class="line">   ProxyPreserveHost On</span><br><span class="line">   ProxyPass       / ajp://127.0.0.1:8009/</span><br><span class="line"><span class="tag">&lt;/<span class="name">VirtualHost</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>查看Server Status可以看到确实使用的是ajp连接了。</p>
<p><img src="../../../../images/SRE/day33/77.jpg" alt="77"></p>
<h4 id="实战案例-2"><a href="#实战案例-2" class="headerlink" title="实战案例"></a>实战案例</h4><p><strong>范例：启用httpd的AJP反向代理功能</strong></p>
<p><img src="../../../../images/SRE/day33/78.jpg" alt="78"></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ~]<span class="comment"># vim /etc/httpd/conf.d/tomcat.conf </span></span><br><span class="line">[root@centos8 ~]<span class="comment"># cat /etc/httpd/conf.d/tomcat.conf</span></span><br><span class="line">&lt;VirtualHost *:80&gt;</span><br><span class="line">   ServerName       node1.magedu.org</span><br><span class="line">   ProxyRequests     Off</span><br><span class="line">   ProxyVia         On   <span class="comment">#此项对AJP无效</span></span><br><span class="line">   ProxyPreserveHost On   <span class="comment">#此项对AJP无效</span></span><br><span class="line">   ProxyPass       / ajp://127.0.0.1:8009/</span><br><span class="line">&lt;/VirtualHost&gt;</span><br><span class="line"></span><br><span class="line">[root@centos8 ~]<span class="comment"># systemctl restart httpd</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#再次用用下面不同URL访问，可以看以下结果</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># curl http://node1.magedu.org/test.html</span></span><br><span class="line">/data/node1/ROOT/test.html</span><br><span class="line">[root@centos8 ~]<span class="comment"># curl http://node2.magedu.org/test.html</span></span><br><span class="line">/data/node2/ROOT/test.html</span><br><span class="line">[root@centos8 ~]<span class="comment"># curl http://10.0.0.8/test.html</span></span><br><span class="line">/usr/local/tomcat/webapps/ROOT/test.html</span><br><span class="line">[root@centos8 ~]<span class="comment"># curl http://127.0.0.1/test.html</span></span><br><span class="line">/usr/local/tomcat/webapps/ROOT/test.html</span><br><span class="line"></span><br><span class="line">[root@centos8 ~]<span class="comment"># vim /etc/httpd/conf.d/tomcat.conf </span></span><br><span class="line"><span class="comment">#只修改下面一行,关闭向后端转发请求的host首部</span></span><br><span class="line"> ProxyPreserveHost Off</span><br><span class="line"> </span><br><span class="line"><span class="comment">#再次用用下面不同URL访问，可以看到和上面一样的结果，说明AJP协议和Http不同，自动转发所有首部信息</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># curl http://node1.magedu.org/test.html</span></span><br><span class="line">/data/node1/ROOT/test.html</span><br><span class="line">[root@centos8 ~]<span class="comment"># curl http://node2.magedu.org/test.html</span></span><br><span class="line">/data/node2/ROOT/test.html</span><br><span class="line">[root@centos8 ~]<span class="comment"># curl http://10.0.0.8/test.html</span></span><br><span class="line">/usr/local/tomcat/webapps/ROOT/test.html</span><br><span class="line">[root@centos8 ~]<span class="comment"># curl http://127.0.0.1/test.html</span></span><br><span class="line">/usr/local/tomcat/webapps/ROOT/test.html</span><br></pre></td></tr></table></figure>

<p>可以通过status页面看到下面AJP的信息</p>
<p><img src="../../../../images/SRE/day33/79.jpg" alt="79"><br><img src="../../../../images/SRE/day33/80.jpg" alt="80"></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#用iptables禁用AJP的访问</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># iptables -A INPUT -p tcp --dport 8009 -j REJECT</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># curl http://node1.magedu.org/test.html</span></span><br><span class="line">&lt;!DOCTYPE HTML PUBLIC <span class="string">&quot;-//IETF//DTD HTML 2.0//EN&quot;</span>&gt;</span><br><span class="line">&lt;html&gt;&lt;<span class="built_in">head</span>&gt;</span><br><span class="line">&lt;title&gt;503 Service Unavailable&lt;/title&gt;</span><br><span class="line">&lt;/head&gt;&lt;body&gt;</span><br><span class="line">&lt;h1&gt;Service Unavailable&lt;/h1&gt;</span><br><span class="line">&lt;p&gt;The server is temporarily unable to service your</span><br><span class="line">request due to maintenance downtime or capacity</span><br><span class="line">problems. Please try again later.&lt;/p&gt;</span><br><span class="line">&lt;/body&gt;&lt;/html&gt;</span><br></pre></td></tr></table></figure>

<h2 id="实现-tomcat-负载均衡"><a href="#实现-tomcat-负载均衡" class="headerlink" title="实现 tomcat 负载均衡"></a>实现 tomcat 负载均衡</h2><p>动态服务器的问题，往往就是并发能力太弱，往往需要多台动态服务器一起提供服务。如何把并发的压力分摊，这就需要调度，采用一定的调度策略，将请求分发给不同的服务器，这就是Load Balance负载均衡。</p>
<p>当单机Tomcat，演化出多机多级部署的时候，一个问题便凸显出来，这就是Session。而这个问题的由来，都是由于HTTP协议在设计之初没有想到未来的发展。</p>
<h3 id="HTTP的无状态，有连接和短连接"><a href="#HTTP的无状态，有连接和短连接" class="headerlink" title="HTTP的无状态，有连接和短连接"></a>HTTP的无状态，有连接和短连接</h3><ul>
<li><p>无状态：指的是服务器端无法知道2次请求之间的联系，即使是前后2次请求来自同一个浏览器，也没有任何数据能够判断出是同一个浏览器的请求。后来可以通过cookie、session机制来判断。</p>
<ul>
<li><p>浏览器端第一次HTTP请求服务器端时，在服务器端使用session这种技术，就可以在服务器端产生一个随机值即SessionID发给浏览器端，浏览器端收到后会保持这个SessionID在Cookie当中，这个Cookie值一般不能持久存储，浏览器关闭就消失。浏览器在每一次提交HTTP请求的时候会把这个SessionID传给服务器端，服务器端就可以通过比对知道是谁了 </p>
</li>
<li><p>Session通常会保存在服务器端内存中，如果没有持久化，则易丢失 </p>
</li>
<li><p>Session会定时过期。过期后浏览器如果再访问，服务端发现没有此ID，将给浏览器端重新发新的SessionID</p>
</li>
<li><p>更换浏览器也将重新获得新的SessionID</p>
</li>
</ul>
</li>
<li><p>有连接：是因为它基于TCP协议，是面向连接的，需要3次握手、4次断开。</p>
</li>
<li><p>短连接：Http 1.1之前，都是一个请求一个连接，而Tcp的连接创建销毁成本高，对服务器有很大的影响。所以，自Http 1.1开始，支持keep-alive，默认也开启，一个连接打开后，会保持一段时间（可设置），浏览器再访问该服务器就使用这个Tcp连接，减轻了服务器压力，提高了效率。</p>
</li>
</ul>
<p>服务器端如果故障，即使Session被持久化了，但是服务没有恢复前都不能使用这些SessionID。</p>
<p>如果使用HAProxy或者Nginx等做负载均衡器，调度到了不同的Tomcat上，那么也会出现找不到SessionID的情况。</p>
<h3 id="会话保持方式"><a href="#会话保持方式" class="headerlink" title="会话保持方式"></a>会话保持方式</h3><h4 id="Session-sticky-会话黏性"><a href="#Session-sticky-会话黏性" class="headerlink" title="Session sticky 会话黏性"></a>Session sticky 会话黏性</h4><p>Session绑定</p>
<ul>
<li>nginx：source ip, cookie</li>
<li>HAProxy：source ip, cookie </li>
</ul>
<p>优点：简单易配置</p>
<p>缺点：如果目标服务器故障后，如果没有做sessoin持久化，就会丢失session,此方式生产很少使用</p>
<h4 id="Session-复制集群"><a href="#Session-复制集群" class="headerlink" title="Session 复制集群"></a>Session 复制集群</h4><p>Tomcat自己的提供的多播集群，通过多播将任何一台的session同步到其它节点。 缺点</p>
<ul>
<li>Tomcat的同步节点不宜过多，互相即时通信同步session需要太多带宽</li>
<li>每一台都拥有全部session，内存损耗太多</li>
</ul>
<h4 id="Session-Server"><a href="#Session-Server" class="headerlink" title="Session Server"></a>Session Server</h4><p>session 共享服务器，使用memcached、redis做共享的Session服务器，此为推荐方式</p>
<h3 id="负载均衡规划和准备"><a href="#负载均衡规划和准备" class="headerlink" title="负载均衡规划和准备"></a>负载均衡规划和准备</h3><h4 id="负载均衡主机和网络地址规划"><a href="#负载均衡主机和网络地址规划" class="headerlink" title="负载均衡主机和网络地址规划"></a>负载均衡主机和网络地址规划</h4><p><img src="../../../../images/SRE/day33/81.jpg" alt="81"></p>
<table>
<thead>
<tr>
<th>ip</th>
<th>主机名</th>
<th>服务</th>
<th>软件</th>
</tr>
</thead>
<tbody><tr>
<td>10.0.0.100</td>
<td>proxy.magedu.org</td>
<td>调度器</td>
<td>Nginx、HTTPD</td>
</tr>
<tr>
<td>10.0.0.101</td>
<td>t1.magedu.org</td>
<td>tomcat1</td>
<td>JDK8、Tomcat8</td>
</tr>
<tr>
<td>10.0.0.102</td>
<td>t2.magedu.org</td>
<td>tomcat2</td>
<td>JDK8、Tomcat8</td>
</tr>
</tbody></table>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#只需在10.0.0.100的nginx主机上实现域名解析</span></span><br><span class="line">vim /etc/hosts </span><br><span class="line"><span class="comment">#添加以下三行</span></span><br><span class="line">10.0.0.100 proxy.magedu.org proxy</span><br><span class="line">10.0.0.101 t1.magedu.org t1</span><br><span class="line">10.0.0.102 t2.magedu.org t2</span><br></pre></td></tr></table></figure>

<h4 id="负载均衡tomcat主机准备"><a href="#负载均衡tomcat主机准备" class="headerlink" title="负载均衡tomcat主机准备"></a>负载均衡tomcat主机准备</h4><p>修改tomcat的虚拟机主机为自定义的主机名,并设为默认的虚拟主机</p>
<p>t1虚拟主机配置conf/server.xml</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">Engine</span> <span class="attr">name</span>=<span class="string">&quot;Catalina&quot;</span> <span class="attr">defaultHost</span>=<span class="string">&quot;t1.magedu.org&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">Host</span> <span class="attr">name</span>=<span class="string">&quot;t1.magedu.org&quot;</span> <span class="attr">appBase</span>=<span class="string">&quot;/data/webapps&quot;</span> <span class="attr">autoDeploy</span>=<span class="string">&quot;true&quot;</span> &gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">Host</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">Engine</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>t2虚拟主机配置conf/server.xml</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">Engine</span> <span class="attr">name</span>=<span class="string">&quot;Catalina&quot;</span> <span class="attr">defaultHost</span>=<span class="string">&quot;t2.magedu.org&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">Host</span> <span class="attr">name</span>=<span class="string">&quot;t2.magedu.org&quot;</span> <span class="attr">appBase</span>=<span class="string">&quot;/data/webapps&quot;</span> <span class="attr">autoDeploy</span>=<span class="string">&quot;true&quot;</span> &gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">Host</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">Engine</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h4 id="准备负载均衡规划测试用的jsp文件"><a href="#准备负载均衡规划测试用的jsp文件" class="headerlink" title="准备负载均衡规划测试用的jsp文件"></a>准备负载均衡规划测试用的jsp文件</h4><p>在t1和 t2节点创建相同的文件/data/webapps/ROOT/index.jsp</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#项目路径配置</span></span><br><span class="line"><span class="built_in">mkdir</span> -pv /data/webapps/ROOT</span><br><span class="line"></span><br><span class="line"><span class="comment">#编写测试jsp文件，内容在下面</span></span><br><span class="line">vim /data/webapps/ROOT/index.jsp</span><br><span class="line">&lt;%@ page import=<span class="string">&quot;java.util.*&quot;</span> %&gt;</span><br><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html lang=<span class="string">&quot;en&quot;</span>&gt;</span><br><span class="line">&lt;<span class="built_in">head</span>&gt;</span><br><span class="line">   &lt;meta charset=<span class="string">&quot;UTF-8&quot;</span>&gt;</span><br><span class="line">   &lt;title&gt;tomcat <span class="built_in">test</span>&lt;/title&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">&lt;div&gt;On &lt;%=request.getServerName() %&gt;&lt;/div&gt;</span><br><span class="line">&lt;div&gt;&lt;%=request.getLocalAddr() + <span class="string">&quot;:&quot;</span> + request.getLocalPort() %&gt;&lt;/div&gt;</span><br><span class="line">&lt;div&gt;SessionID = &lt;span style=<span class="string">&quot;color:blue&quot;</span>&gt;&lt;%=session.getId() %&gt;&lt;/span&gt;&lt;/div&gt;</span><br><span class="line">&lt;%=new Date()%&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment">#设置权限</span></span><br><span class="line"><span class="built_in">chown</span> -R tomcat.tomcat /data/webapps/</span><br></pre></td></tr></table></figure>

<h3 id="Nginx-实现后端-tomcat-的负载均衡调度"><a href="#Nginx-实现后端-tomcat-的负载均衡调度" class="headerlink" title="Nginx 实现后端 tomcat 的负载均衡调度"></a>Nginx 实现后端 tomcat 的负载均衡调度</h3><h4 id="Nginx-实现后端-tomcat-的负载均衡"><a href="#Nginx-实现后端-tomcat-的负载均衡" class="headerlink" title="Nginx 实现后端 tomcat 的负载均衡"></a>Nginx 实现后端 tomcat 的负载均衡</h4><p>nginx 配置如下</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/nginx/nginx.conf </span><br><span class="line"><span class="comment">#在http块中加以下内容</span></span><br><span class="line"><span class="comment">#注意名称不要用下划线</span></span><br><span class="line"></span><br><span class="line">upstream tomcat-server &#123;</span><br><span class="line">        <span class="comment">#ip_hash; # 先禁用看看轮询，之后开启开黏性</span></span><br><span class="line">        <span class="comment">#hash $cookie_JSESSIONID; # 先禁用看看轮询，之后开启开黏性</span></span><br><span class="line">        server t1.magedu.org:8080;</span><br><span class="line">        server t2.magedu.org:8080;</span><br><span class="line">&#125;</span><br><span class="line">    </span><br><span class="line">server &#123;</span><br><span class="line">        location ~* \.(jsp|<span class="keyword">do</span>)$ &#123;</span><br><span class="line">        proxy_pass http://tomcat-server;</span><br><span class="line">        <span class="comment">#proxy_set_header Host $http_host; #转发主机头至后端服务器</span></span><br><span class="line">       &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>测试 <a target="_blank" rel="noopener" href="http://proxy.magedu.com/index.jsp%EF%BC%8C%E5%8F%AF%E4%BB%A5%E7%9C%8B%E5%88%B0%E8%BD%AE%E8%AF%A2%E8%B0%83%E5%BA%A6%E6%95%88%E6%9E%9C,%E6%AF%8F%E6%AC%A1%E5%88%B7%E6%96%B0%E5%90%8E%E7%AB%AF%E4%B8%BB%E6%9C%BA%E5%92%8CSessionID%E9%83%BD%E4%BC%9A%E5%8F%98%E5%8C%96">http://proxy.magedu.com/index.jsp，可以看到轮询调度效果,每次刷新后端主机和SessionID都会变化</a></p>
<p><img src="../../../../images/SRE/day33/82.jpg" alt="82"><br><img src="../../../../images/SRE/day33/83.jpg" alt="83"></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">[root@proxy ~]<span class="comment"># curl http://proxy.magedu.org/index.jsp</span></span><br><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html lang=<span class="string">&quot;en&quot;</span>&gt;</span><br><span class="line">&lt;<span class="built_in">head</span>&gt;</span><br><span class="line">   &lt;meta charset=<span class="string">&quot;UTF-8&quot;</span>&gt;</span><br><span class="line">   &lt;title&gt;tomcat <span class="built_in">test</span>&lt;/title&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">&lt;h1&gt; tomcat website &lt;/h1&gt;</span><br><span class="line">&lt;div&gt;On tomcat-server&lt;/div&gt;</span><br><span class="line">&lt;div&gt;10.0.0.101:8080&lt;/div&gt;</span><br><span class="line">&lt;div&gt;SessionID = &lt;span </span><br><span class="line">style=<span class="string">&quot;color:blue&quot;</span>&gt;2E4BFA5135497EA3628F1EBDAE62493E&lt;/span&gt;&lt;/div&gt;</span><br><span class="line">Thu Jul 09 17:58:06 CST 2020</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br><span class="line"></span><br><span class="line">[root@proxy ~]<span class="comment"># curl http://proxy.magedu.org/index.jsp</span></span><br><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html lang=<span class="string">&quot;en&quot;</span>&gt;</span><br><span class="line">&lt;<span class="built_in">head</span>&gt;</span><br><span class="line">   &lt;meta charset=<span class="string">&quot;UTF-8&quot;</span>&gt;</span><br><span class="line">   &lt;title&gt;tomcat <span class="built_in">test</span>&lt;/title&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">&lt;h1&gt; tomcat website &lt;/h1&gt;</span><br><span class="line">&lt;div&gt;On tomcat-server&lt;/div&gt;</span><br><span class="line">&lt;div&gt;10.0.0.102:8080&lt;/div&gt;</span><br><span class="line">&lt;div&gt;SessionID = &lt;span </span><br><span class="line">style=<span class="string">&quot;color:blue&quot;</span>&gt;C5CC437BC05EE5A8620822CB07E71B7C&lt;/span&gt;&lt;/div&gt;</span><br><span class="line">Thu Jul 09 17:58:07 CST 2020</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure>

<p>使用抓包wireshark工具可以看到下面信息</p>
<p><img src="../../../../images/SRE/day33/84.jpg" alt="84"></p>
<p><img src="../../../../images/SRE/day33/85.jpg" alt="85"><br><img src="../../../../images/SRE/day33/86.jpg" alt="86"><br><img src="../../../../images/SRE/day33/87.jpg" alt="87"><br><img src="../../../../images/SRE/day33/88.jpg" alt="88"></p>
<h4 id="实现-session-黏性"><a href="#实现-session-黏性" class="headerlink" title="实现 session 黏性"></a>实现 session 黏性</h4><p>在upstream中使用ip_hash指令，使用客户端IP地址Hash。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@proxy ~]<span class="comment"># vim /etc/nginx/nginx.conf</span></span><br><span class="line"><span class="comment">#只添加ip_hash;这一行</span></span><br><span class="line">upstream tomcat-server &#123;</span><br><span class="line">       ip_hash; <span class="comment">#启动源地址hash  </span></span><br><span class="line">        <span class="comment">#hash $cookie_JSESSIONID   #启动基于cookie的hash</span></span><br><span class="line">       server t1.magedu.org:8080;</span><br><span class="line">       server t2.magedu.org:8080;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>配置完reload nginx服务。curl 测试一下看看效果。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#用curl访问每次都调度到10.0.0.102主机上，但因为curl每次请求不会自动携带之前获取的cookie,所有SessionID每次都在变化</span></span><br><span class="line">[root@proxy ~]<span class="comment"># curl http://proxy.magedu.org/index.jsp</span></span><br><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html lang=<span class="string">&quot;en&quot;</span>&gt;</span><br><span class="line">&lt;<span class="built_in">head</span>&gt;</span><br><span class="line">   &lt;meta charset=<span class="string">&quot;UTF-8&quot;</span>&gt;</span><br><span class="line">   &lt;title&gt;tomcat <span class="built_in">test</span>&lt;/title&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">&lt;h1&gt; tomcat website &lt;/h1&gt;</span><br><span class="line">&lt;div&gt;On tomcat-server&lt;/div&gt;</span><br><span class="line">&lt;div&gt;10.0.0.102:8080&lt;/div&gt;</span><br><span class="line">&lt;div&gt;SessionID = &lt;span style=<span class="string">&quot;color:blue&quot;</span>&gt;C471641C26865B08B2FDA970BE7C71A6&lt;/span&gt;&lt;/div&gt;</span><br><span class="line">Thu Jul 09 18:02:48 CST 2020</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br><span class="line"></span><br><span class="line">[root@proxy ~]<span class="comment"># curl http://proxy.magedu.org/index.jsp</span></span><br><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html lang=<span class="string">&quot;en&quot;</span>&gt;</span><br><span class="line">&lt;<span class="built_in">head</span>&gt;</span><br><span class="line">   &lt;meta charset=<span class="string">&quot;UTF-8&quot;</span>&gt;</span><br><span class="line">   &lt;title&gt;tomcat <span class="built_in">test</span>&lt;/title&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">&lt;h1&gt; tomcat website &lt;/h1&gt;</span><br><span class="line">&lt;div&gt;On tomcat-server&lt;/div&gt;</span><br><span class="line">&lt;div&gt;10.0.0.102:8080&lt;/div&gt;</span><br><span class="line">&lt;div&gt;SessionID = &lt;span style=<span class="string">&quot;color:blue&quot;</span>&gt;3F61232DFD791A94D60D0D2E9561309A&lt;/span&gt;&lt;/div&gt;</span><br><span class="line">Thu Jul 09 18:02:52 CST 2020</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure>

<p>通过图形浏览器看到主机不变，sessionID不变</p>
<p><img src="../../../../images/SRE/day33/89.jpg" alt="89"></p>
<p>关闭Session对应的Tomcat服务，再重启启动它，看看Session的变化。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@t2 ~]<span class="comment"># systemctl restart tomcat</span></span><br></pre></td></tr></table></figure>

<p>通过浏览器看到主机不变，但sessionID和上一次变化，但后续刷新不再变化</p>
<p><img src="../../../../images/SRE/day33/90.jpg" alt="90"></p>
<h4 id="实现-https-的负载均衡"><a href="#实现-https-的负载均衡" class="headerlink" title="实现 https 的负载均衡"></a>实现 https 的负载均衡</h4><p>范例： 实现 https 的负载均衡</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line">[root@rocky8 ~]<span class="comment"># vim /etc/nginx/conf.d/blog.wangxiaochun.com.conf</span></span><br><span class="line">upstream blog &#123;</span><br><span class="line">   ip_hash;</span><br><span class="line">   server 10.0.0.101:8080;</span><br><span class="line">   server 10.0.0.102:8080;</span><br><span class="line">&#125;</span><br><span class="line">server &#123;</span><br><span class="line">   listen 80;</span><br><span class="line">   server_name blog.wangxiaochun.com;</span><br><span class="line">   <span class="built_in">return</span> 302 https://$host<span class="variable">$request_uri</span>;</span><br><span class="line">    <span class="comment">#return 302 https://$server_name$request_uri; #$server_name 来自于上面的server_name,即blog.wangxiaochun.com</span></span><br><span class="line">&#125;</span><br><span class="line">server &#123;</span><br><span class="line">   listen 443 ssl;</span><br><span class="line">   server_name blog.wangxiaochun.com;</span><br><span class="line">   ssl_certificate   /etc/nginx/ssl/blog.wangxiaochun.com.pem;</span><br><span class="line">   ssl_certificate_key /etc/nginx/ssl/blog.wangxiaochun.com.key;</span><br><span class="line">   client_max_body_size 20m;</span><br><span class="line">   location / &#123;</span><br><span class="line">       proxy_pass http://blog;</span><br><span class="line">       proxy_set_header Host  <span class="variable">$http_host</span>; </span><br><span class="line">       proxy_set_header X-Forwarded-For <span class="variable">$proxy_add_x_forwarded_for</span>;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">#配置后端tomcat服务器</span></span><br><span class="line">[root@rocky8 ~]<span class="comment"># vim /usr/local/tomcat/conf/server.xml</span></span><br><span class="line">...</span><br><span class="line"><span class="comment">#添加下面行</span></span><br><span class="line">   &lt;Host name=<span class="string">&quot;blog.wangxiaochun.com&quot;</span>  appBase=<span class="string">&quot;/data/blog&quot;</span></span><br><span class="line">            unpackWARs=<span class="string">&quot;true&quot;</span> autoDeploy=<span class="string">&quot;true&quot;</span>&gt;</span><br><span class="line">   &lt;/Host&gt;</span><br><span class="line"><span class="comment">#添加上面行</span></span><br><span class="line">   &lt;/Engine&gt;</span><br><span class="line"> &lt;/Service&gt;</span><br><span class="line">&lt;/Server&gt;</span><br><span class="line"></span><br><span class="line">[root@rocky8 ~]<span class="comment"># mkdir /data/blog -p</span></span><br><span class="line">[root@rocky8 ~]<span class="comment"># mv jpress-4.1.2.war /data/blog/ROOT.war</span></span><br><span class="line">[root@rocky8 ~]<span class="comment"># chown -R tomcat.tomcat /data/blog</span></span><br><span class="line"><span class="comment">#注意：先只在第一台tomcat服务器上配置完成初始化连接数据库和上传图片发表文章后，然后复制相关web文件至第二台主机即可，无需多次初始化</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#配置后端数据库</span></span><br><span class="line">[root@rocky8 ~]<span class="comment"># yum -y install mysql-server</span></span><br><span class="line">[root@rocky8 ~]<span class="comment"># systemctl enable --now mysqld</span></span><br><span class="line">mysql&gt; create user blog@<span class="string">&#x27;10.0.0.%&#x27;</span> identified by <span class="string">&#x27;123456&#x27;</span>;</span><br><span class="line">mysql&gt; create database jpress;</span><br><span class="line">mysql&gt; grant all on jpress.* to blog@<span class="string">&#x27;10.0.0.%&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">#配置后端NFS共享存储</span></span><br><span class="line">[root@rocky8 ~]<span class="comment"># yum -y install nfs-utils</span></span><br><span class="line">[root@rocky8 ~]<span class="comment"># groupadd -g 80 www</span></span><br><span class="line">[root@rocky8 ~]<span class="comment"># useradd -g www -u 80 -s /sbin/nlogin www</span></span><br><span class="line">[root@rocky8 ~]<span class="comment"># mkdir /data/blog/ROOT/attachment -p</span></span><br><span class="line">[root@rocky8 ~]<span class="comment"># vim /etc/exports</span></span><br><span class="line">[root@rocky8 ~]<span class="comment"># cat /etc/exports</span></span><br><span class="line">/data/blog/ROOT/attachment *(rw,all_squash,anonuid=80,anongid=80)</span><br><span class="line"></span><br><span class="line">[root@rocky8 ~]<span class="comment"># systemctl enable --now nfs-server.service </span></span><br><span class="line">[root@rocky8 ~]<span class="comment"># chown -R www.www /data/blog/ROOT/attachment</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#tomcat服务器挂载 NFS共享</span></span><br><span class="line">[root@rocky8 ~]<span class="comment"># vim /etc/fstab </span></span><br><span class="line">NFS服务器IP:/data/blog/ROOT/attachment /data/blog/ROOT/attachment   nfs   _netdev 0 0</span><br><span class="line">[root@rocky8 ~]<span class="comment"># yum -y install nfs-utils</span></span><br><span class="line">[root@rocky8 ~]<span class="comment"># mount -a</span></span><br></pre></td></tr></table></figure>

<h1 id="Tomcat-Session-Replication-Cluster"><a href="#Tomcat-Session-Replication-Cluster" class="headerlink" title="Tomcat Session Replication Cluster"></a>Tomcat Session Replication Cluster</h1><p>Tomcat 官方实现了 Session 的复制集群,将每个Tomcat的Session进行相互的复制同步,从而保证所有Tomcat都有相同的Session信息.</p>
<p><img src="../../../../images/SRE/day33/91.jpg" alt="91"></p>
<h2 id="配置说明-3"><a href="#配置说明-3" class="headerlink" title="配置说明"></a>配置说明</h2><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">https://tomcat.apache.org/tomcat-10.0-doc/cluster-howto.html</span><br><span class="line">https://tomcat.apache.org/tomcat-9.0-doc/cluster-howto.html</span><br><span class="line">https://tomcat.apache.org/tomcat-8.5-doc/cluster-howto.html</span><br><span class="line">http://tomcat.apache.org/tomcat-7.0-doc/cluster-howto.html</span><br></pre></td></tr></table></figure>

<h3 id="修改-conf-server-conf"><a href="#修改-conf-server-conf" class="headerlink" title="修改 conf/server.conf"></a>修改 conf/server.conf</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">Cluster</span> <span class="attr">className</span>=<span class="string">&quot;org.apache.catalina.ha.tcp.SimpleTcpCluster&quot;</span></span></span><br><span class="line"><span class="tag"> <span class="attr">channelSendOptions</span>=<span class="string">&quot;8&quot;</span>&gt;</span></span><br><span class="line">    </span><br><span class="line"> <span class="tag">&lt;<span class="name">Manager</span> <span class="attr">className</span>=<span class="string">&quot;org.apache.catalina.ha.session.DeltaManager&quot;</span></span></span><br><span class="line"><span class="tag">   <span class="attr">expireSessionsOnShutdown</span>=<span class="string">&quot;false&quot;</span></span></span><br><span class="line"><span class="tag">   <span class="attr">notifyListenersOnReplication</span>=<span class="string">&quot;true&quot;</span>/&gt;</span></span><br><span class="line">    </span><br><span class="line"> <span class="tag">&lt;<span class="name">Channel</span> <span class="attr">className</span>=<span class="string">&quot;org.apache.catalina.tribes.group.GroupChannel&quot;</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;<span class="name">Membership</span> <span class="attr">className</span>=<span class="string">&quot;org.apache.catalina.tribes.membership.McastService&quot;</span></span></span><br><span class="line"><span class="tag">             <span class="attr">address</span>=<span class="string">&quot;228.0.0.4&quot;</span>         #<span class="attr">指定的多播地址</span></span></span><br><span class="line"><span class="tag">             <span class="attr">port</span>=<span class="string">&quot;45564&quot;</span>                #<span class="attr">45564</span>/<span class="attr">UDP</span></span></span><br><span class="line"><span class="tag">             <span class="attr">frequency</span>=<span class="string">&quot;500&quot;</span>             #<span class="attr">间隔500ms发送</span></span></span><br><span class="line"><span class="tag">             <span class="attr">dropTime</span>=<span class="string">&quot;3000&quot;</span>/&gt;</span>           #故障阈值3s</span><br><span class="line">     </span><br><span class="line"> <span class="tag">&lt;<span class="name">Receiver</span> <span class="attr">className</span>=<span class="string">&quot;org.apache.catalina.tribes.transport.nio.NioReceiver&quot;</span></span></span><br><span class="line"><span class="tag">           <span class="attr">address</span>=<span class="string">&quot;auto&quot;</span>                #<span class="attr">监听地址</span>,<span class="attr">此项建议修改为当前主机的IP</span></span></span><br><span class="line"><span class="tag">           <span class="attr">port</span>=<span class="string">&quot;4000&quot;</span>                   #<span class="attr">监听端口</span></span></span><br><span class="line"><span class="tag">           <span class="attr">autoBind</span>=<span class="string">&quot;100&quot;</span>                #<span class="attr">如果端口冲突</span>,<span class="attr">自动绑定其它端口</span>,<span class="attr">范围是4000-4100</span></span></span><br><span class="line"><span class="tag">           <span class="attr">selectorTimeout</span>=<span class="string">&quot;5000&quot;</span>        #<span class="attr">自动绑定超时时长5s</span></span></span><br><span class="line"><span class="tag">           <span class="attr">maxThreads</span>=<span class="string">&quot;6&quot;</span>/&gt;</span></span><br><span class="line">     </span><br><span class="line"> <span class="tag">&lt;<span class="name">Sender</span> </span></span><br><span class="line"><span class="tag"><span class="attr">className</span>=<span class="string">&quot;org.apache.catalina.tribes.transport.ReplicationTransmitter&quot;</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;<span class="name">Transport</span> </span></span><br><span class="line"><span class="tag"><span class="attr">className</span>=<span class="string">&quot;org.apache.catalina.tribes.transport.nio.PooledParallelSender&quot;</span>/&gt;</span></span><br><span class="line"> <span class="tag">&lt;/<span class="name">Sender</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">Interceptor</span> </span></span><br><span class="line"><span class="tag"><span class="attr">className</span>=<span class="string">&quot;org.apache.catalina.tribes.group.interceptors.TcpFailureDetector&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">Interceptor</span> </span></span><br><span class="line"><span class="tag"><span class="attr">className</span>=<span class="string">&quot;org.apache.catalina.tribes.group.interceptors.MessageDispatchInterceptor&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">Channel</span>&gt;</span></span><br><span class="line">    </span><br><span class="line"> <span class="tag">&lt;<span class="name">Valve</span> <span class="attr">className</span>=<span class="string">&quot;org.apache.catalina.ha.tcp.ReplicationValve&quot;</span> <span class="attr">filter</span>=<span class="string">&quot;&quot;</span>/&gt;</span></span><br><span class="line"> <span class="tag">&lt;<span class="name">Valve</span> <span class="attr">className</span>=<span class="string">&quot;org.apache.catalina.ha.session.JvmRouteBinderValve&quot;</span>/&gt;</span></span><br><span class="line">    </span><br><span class="line"> <span class="tag">&lt;<span class="name">Deployer</span> <span class="attr">className</span>=<span class="string">&quot;org.apache.catalina.ha.deploy.FarmWarDeployer&quot;</span></span></span><br><span class="line"><span class="tag">           <span class="attr">tempDir</span>=<span class="string">&quot;/tmp/war-temp/&quot;</span></span></span><br><span class="line"><span class="tag">           <span class="attr">deployDir</span>=<span class="string">&quot;/tmp/war-deploy/&quot;</span></span></span><br><span class="line"><span class="tag">           <span class="attr">watchDir</span>=<span class="string">&quot;/tmp/war-listen/&quot;</span></span></span><br><span class="line"><span class="tag">           <span class="attr">watchEnabled</span>=<span class="string">&quot;false&quot;</span>/&gt;</span></span><br><span class="line">    </span><br><span class="line"> <span class="tag">&lt;<span class="name">ClusterListener</span> </span></span><br><span class="line"><span class="tag"><span class="attr">className</span>=<span class="string">&quot;org.apache.catalina.ha.session.ClusterSessionListener&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">Cluster</span>&gt;</span></span><br><span class="line"></span><br><span class="line">#注意:tomcat7的官方文档此处有错误</span><br><span class="line">http://tomcat.apache.org/tomcat-7.0-doc/cluster-howto.html</span><br><span class="line">......</span><br><span class="line"><span class="tag">&lt;<span class="name">ClusterListener</span> </span></span><br><span class="line"><span class="tag"><span class="attr">className</span>=<span class="string">&quot;org.apache.catalina.ha.session.JvmRouteSessionIDBinderListener&quot;</span>&gt;</span></span><br><span class="line">         <span class="tag">&lt;<span class="name">ClusterListener</span> </span></span><br><span class="line"><span class="tag"><span class="attr">className</span>=<span class="string">&quot;org.apache.catalina.ha.session.ClusterSessionListener&quot;</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;/<span class="name">Cluster</span>&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>配置说明</p>
<ul>
<li>Cluster 集群配置</li>
<li>Manager 会话管理器配置</li>
<li>Channel 信道配置<ul>
<li>Membership 成员判定。使用什么多播地址、端口多少、间隔时长ms、超时时长ms。同一个多播地址和端口认为同属一个组。使用时修改这个多播地址，以防冲突</li>
<li>Receiver 接收器，多线程接收多个其他节点的心跳、会话信息。默认会从4000到4100依次尝试可用端口<ul>
<li>address=”auto”，auto可能绑定到127.0.0.1上，所以一定要改为当前主机可用的IP</li>
</ul>
</li>
<li>Sender 多线程发送器，内部使用了tcp连接池。</li>
<li>Interceptor 拦截器</li>
</ul>
</li>
<li>Valve <ul>
<li>ReplicationValve 检测哪些请求需要检测Session，Session数据是否有了变化，需要启动复制过程</li>
</ul>
</li>
<li>ClusterListener<ul>
<li>ClusterSessionListener 集群session侦听器</li>
</ul>
</li>
</ul>
<p>使用 <code>&lt;Cluster className=&quot;org.apache.catalina.ha.tcp.SimpleTcpCluster&quot;/&gt;  </code></p>
<p>添加到 <code>&lt;Engine&gt;</code> 所有虚拟主机都可以启用Session复制</p>
<p>添加到 <code>&lt;Host&gt;</code> ，该虚拟主机可以启用Session复制</p>
<p>最后，在应用程序内部启用了才可以使用</p>
<h3 id="修改-WEB-INF-web-xml"><a href="#修改-WEB-INF-web-xml" class="headerlink" title="修改 WEB-INF/web.xml"></a>修改 WEB-INF/web.xml</h3><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">  &lt;/description&gt;</span><br><span class="line">&lt;distributable/&gt; #添加此行</span><br><span class="line">&lt;/web-app&gt;</span><br></pre></td></tr></table></figure>

<h2 id="实战案例-实现-Tomcat-Session-集群"><a href="#实战案例-实现-Tomcat-Session-集群" class="headerlink" title="实战案例: 实现 Tomcat Session 集群"></a>实战案例: 实现 Tomcat Session 集群</h2><p><img src="../../../../images/SRE/day33/92.jpg" alt="92"></p>
<p>环境准备：</p>
<ul>
<li>时间同步，确保NTP或Chrony服务正常运行</li>
<li>防火墙规则</li>
</ul>
<table>
<thead>
<tr>
<th>ip</th>
<th>主机名</th>
<th>服务</th>
<th></th>
</tr>
</thead>
<tbody><tr>
<td>10.0.0.100</td>
<td>proxy.magedu.org</td>
<td>调度器</td>
<td>Nginx、HTTPD</td>
</tr>
<tr>
<td>10.0.0.101</td>
<td>t1.magedu.org</td>
<td>tomcat1</td>
<td>JDK8、Tomcat8</td>
</tr>
<tr>
<td>10.0.0.102</td>
<td>t2.magedu.org</td>
<td>tomcat2</td>
<td>JDK8、Tomcat8</td>
</tr>
</tbody></table>
<h3 id="在-proxy-主机设置-httpd-或nginx-实现后端tomcat主机轮询"><a href="#在-proxy-主机设置-httpd-或nginx-实现后端tomcat主机轮询" class="headerlink" title="在 proxy 主机设置 httpd (或nginx)实现后端tomcat主机轮询"></a>在 proxy 主机设置 httpd (或nginx)实现后端tomcat主机轮询</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[root@proxy ~]<span class="comment"># cat /etc/httpd/conf.d/tomcat.conf</span></span><br><span class="line">&lt;Proxy balancer://tomcat-server&gt;</span><br><span class="line">   BalancerMember http://t1.magedu.org:8080 loadfactor=1</span><br><span class="line">   BalancerMember http://t2.magedu.org:8080 loadfactor=1</span><br><span class="line">&lt;/Proxy&gt;</span><br><span class="line"></span><br><span class="line">&lt;VirtualHost *:80&gt;</span><br><span class="line">   ServerName       proxy.magedu.org</span><br><span class="line">   ProxyRequests     Off</span><br><span class="line">   ProxyVia         On</span><br><span class="line">   ProxyPreserveHost On  </span><br><span class="line">   ProxyPass       / balancer://tomcat-server/</span><br><span class="line">   ProxyPassReverse / balancer://tomcat-server/</span><br><span class="line">&lt;/VirtualHost&gt;</span><br><span class="line"></span><br><span class="line">[root@proxy ~]<span class="comment"># systemctl restart httpd</span></span><br></pre></td></tr></table></figure>

<h3 id="在所有后端tomcat主机上修改conf-server-xml"><a href="#在所有后端tomcat主机上修改conf-server-xml" class="headerlink" title="在所有后端tomcat主机上修改conf/server.xml"></a>在所有后端tomcat主机上修改conf/server.xml</h3><p>本次把多播复制的配置放到t1.magedu.org和t2.magedu.org虚拟主机里面， 即Host块中。</p>
<p>特别注意<strong>修改Receiver的address属性</strong>为一个本机可对外的IP地址。</p>
<h4 id="修改-t1-主机的-conf-server-xml"><a href="#修改-t1-主机的-conf-server-xml" class="headerlink" title="修改 t1 主机的 conf/server.xml"></a>修改 t1 主机的 conf/server.xml</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#将5.1 内容复制到conf/server.xml的Host块内或Engine块(针对所有主机)</span></span><br><span class="line">[root@t1 ~]<span class="comment"># vim /usr/local/tomcat/conf/server.xml </span></span><br><span class="line">[root@t1 ~]<span class="comment"># cat /usr/local/tomcat/conf/server.xml</span></span><br><span class="line">.....以上省略.....</span><br><span class="line">   &lt;Host name=<span class="string">&quot;t1.magedu.org&quot;</span>  appBase=<span class="string">&quot;/data/webapps&quot;</span> unpackWARs=<span class="string">&quot;true&quot;</span></span><br><span class="line">autoDeploy=<span class="string">&quot;true&quot;</span>&gt;</span><br><span class="line"><span class="comment">###################在&lt;Host&gt; &lt;/host&gt;块中间加下面一段内容##############################</span></span><br><span class="line"> &lt;Cluster className=<span class="string">&quot;org.apache.catalina.ha.tcp.SimpleTcpCluster&quot;</span></span><br><span class="line">          channelSendOptions=<span class="string">&quot;8&quot;</span>&gt;</span><br><span class="line"></span><br><span class="line"> &lt;Manager className=<span class="string">&quot;org.apache.catalina.ha.session.DeltaManager&quot;</span></span><br><span class="line">          expireSessionsOnShutdown=<span class="string">&quot;false&quot;</span></span><br><span class="line">          notifyListenersOnReplication=<span class="string">&quot;true&quot;</span>/&gt;</span><br><span class="line"></span><br><span class="line"> &lt;Channel className=<span class="string">&quot;org.apache.catalina.tribes.group.GroupChannel&quot;</span>&gt;</span><br><span class="line"> &lt;Membership className=<span class="string">&quot;org.apache.catalina.tribes.membership.McastService&quot;</span></span><br><span class="line">            address=<span class="string">&quot;230.100.100.100&quot;</span>   <span class="comment">#指定不冲突的多播地址</span></span><br><span class="line">            port=<span class="string">&quot;45564&quot;</span></span><br><span class="line">            frequency=<span class="string">&quot;500&quot;</span></span><br><span class="line">            dropTime=<span class="string">&quot;3000&quot;</span>/&gt;</span><br><span class="line"> </span><br><span class="line"> &lt;Receiver className=<span class="string">&quot;org.apache.catalina.tribes.transport.nio.NioReceiver&quot;</span></span><br><span class="line">           address=<span class="string">&quot;10.0.0.101&quot;</span>          <span class="comment">#指定网卡的IP</span></span><br><span class="line">           port=<span class="string">&quot;4000&quot;</span></span><br><span class="line">           autoBind=<span class="string">&quot;100&quot;</span></span><br><span class="line">           selectorTimeout=<span class="string">&quot;5000&quot;</span></span><br><span class="line">           maxThreads=<span class="string">&quot;6&quot;</span>/&gt;</span><br><span class="line"> </span><br><span class="line"> &lt;Sender </span><br><span class="line">className=<span class="string">&quot;org.apache.catalina.tribes.transport.ReplicationTransmitter&quot;</span>&gt;</span><br><span class="line"> &lt;Transport </span><br><span class="line">className=<span class="string">&quot;org.apache.catalina.tribes.transport.nio.PooledParallelSender&quot;</span>/&gt;</span><br><span class="line"> &lt;/Sender&gt;</span><br><span class="line"> </span><br><span class="line">&lt;Interceptor </span><br><span class="line">className=<span class="string">&quot;org.apache.catalina.tribes.group.interceptors.TcpFailureDetector&quot;</span>/&gt;</span><br><span class="line">&lt;Interceptor </span><br><span class="line">className=<span class="string">&quot;org.apache.catalina.tribes.group.interceptors.MessageDispatchInterceptor&quot;</span>/&gt;</span><br><span class="line">&lt;/Channel&gt;</span><br><span class="line"></span><br><span class="line"> &lt;Valve className=<span class="string">&quot;org.apache.catalina.ha.tcp.ReplicationValve&quot;</span></span><br><span class="line">        filter=<span class="string">&quot;&quot;</span>/&gt;</span><br><span class="line"> &lt;Valve className=<span class="string">&quot;org.apache.catalina.ha.session.JvmRouteBinderValve&quot;</span>/&gt;</span><br><span class="line"> &lt;Deployer className=<span class="string">&quot;org.apache.catalina.ha.deploy.FarmWarDeployer&quot;</span></span><br><span class="line">           tempDir=<span class="string">&quot;/tmp/war-temp/&quot;</span></span><br><span class="line">           deployDir=<span class="string">&quot;/tmp/war-deploy/&quot;</span></span><br><span class="line">           watchDir=<span class="string">&quot;/tmp/war-listen/&quot;</span></span><br><span class="line">           watchEnabled=<span class="string">&quot;false&quot;</span>/&gt;</span><br><span class="line">           </span><br><span class="line"> &lt;ClusterListener </span><br><span class="line">className=<span class="string">&quot;org.apache.catalina.ha.session.ClusterSessionListener&quot;</span>/&gt;</span><br><span class="line">&lt;/Cluster&gt;</span><br><span class="line"><span class="comment">#######################################以上内容是新加的#################################</span></span><br><span class="line">     &lt;/Host&gt;</span><br><span class="line">   &lt;/Engine&gt;</span><br><span class="line"> &lt;/Service&gt;</span><br><span class="line">&lt;/Server&gt;</span><br><span class="line"></span><br><span class="line">[root@t1 ~]<span class="comment"># systemctl restart tomcat</span></span><br><span class="line">     </span><br><span class="line">[root@t1 ~]<span class="comment"># ss -ntl</span></span><br><span class="line">State           Recv-Q   Send-Q Local Address:Port Peer       Address:Port           </span><br><span class="line">LISTEN           0         128        0.0.0.0:22              0.0.0.0:*</span><br><span class="line">LISTEN           0         100      127.0.0.1:25              0.0.0.0:*</span><br><span class="line">LISTEN           0         128           [::]:22                 [::]:*              </span><br><span class="line">LISTEN           0         100          [::1]:25                 [::]:*</span><br><span class="line">LISTEN           0         50   [::ffff:10.0.0.101]:4000            *:*</span><br><span class="line">LISTEN           0         1      ::ffff:127.0.0.1]:8005            *:*</span><br><span class="line">LISTEN           0         100              *:8009                  *:* </span><br><span class="line">LISTEN           0         100              *:8080                  *:*</span><br></pre></td></tr></table></figure>

<p><strong>简化说明</strong></p>
<p>t1的conf/server.xml中，如下</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">Host</span> <span class="attr">name</span>=<span class="string">&quot;t1.magedu.com&quot;</span> <span class="attr">appBase</span>=<span class="string">&quot;/data/webapps&quot;</span> <span class="attr">autoDeploy</span>=<span class="string">&quot;true&quot;</span> &gt;</span></span><br><span class="line">   #其他略去</span><br><span class="line">    <span class="tag">&lt;<span class="name">Receiver</span> <span class="attr">className</span>=<span class="string">&quot;org.apache.catalina.tribes.transport.nio.NioReceiver&quot;</span></span></span><br><span class="line"><span class="tag">              <span class="attr">address</span>=<span class="string">&quot;10.0.0.101&quot;</span>  #<span class="attr">只改此行</span></span></span><br><span class="line"><span class="tag">              <span class="attr">port</span>=<span class="string">&quot;4000&quot;</span></span></span><br><span class="line"><span class="tag">              <span class="attr">autoBind</span>=<span class="string">&quot;100&quot;</span></span></span><br><span class="line"><span class="tag">              <span class="attr">selectorTimeout</span>=<span class="string">&quot;5000&quot;</span></span></span><br><span class="line"><span class="tag">              <span class="attr">maxThreads</span>=<span class="string">&quot;6&quot;</span>/&gt;</span></span><br></pre></td></tr></table></figure>

<h4 id="修改-t2-主机的-conf-server-xml"><a href="#修改-t2-主机的-conf-server-xml" class="headerlink" title="修改 t2 主机的 conf/server.xml"></a>修改 t2 主机的 conf/server.xml</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line">[root@t2 ~]<span class="comment"># vim /usr/local/tomcat/conf/server.xml </span></span><br><span class="line">[root@t2 ~]<span class="comment"># cat /usr/local/tomcat/conf/server.xml</span></span><br><span class="line">.....以上省略.....</span><br><span class="line">   &lt;Host name=<span class="string">&quot;localhost&quot;</span>  appBase=<span class="string">&quot;webapps&quot;</span></span><br><span class="line">            unpackWARs=<span class="string">&quot;true&quot;</span> autoDeploy=<span class="string">&quot;true&quot;</span>&gt;</span><br><span class="line">        &lt;Valve className=<span class="string">&quot;org.apache.catalina.valves.AccessLogValve&quot;</span></span><br><span class="line">directory=<span class="string">&quot;logs&quot;</span></span><br><span class="line">               prefix=<span class="string">&quot;localhost_access_log&quot;</span> suffix=<span class="string">&quot;.txt&quot;</span></span><br><span class="line">               pattern=<span class="string">&quot;%h %l %u %t &amp;quot;%r&amp;quot; %s %b&quot;</span> /&gt;</span><br><span class="line">      &lt;/Host&gt;</span><br><span class="line">          &lt;Host name=<span class="string">&quot;t2.magedu.org&quot;</span> appBase=<span class="string">&quot;/data/webapps&quot;</span> autoDeploy=<span class="string">&quot;true&quot;</span> &gt;</span><br><span class="line">              </span><br><span class="line"><span class="comment">###################在&lt;Host&gt; &lt;/host&gt;块中间加下面一段内容##############################</span></span><br><span class="line">  &lt;Cluster className=<span class="string">&quot;org.apache.catalina.ha.tcp.SimpleTcpCluster&quot;</span></span><br><span class="line">           channelSendOptions=<span class="string">&quot;8&quot;</span>&gt;</span><br><span class="line">  &lt;Manager className=<span class="string">&quot;org.apache.catalina.ha.session.DeltaManager&quot;</span></span><br><span class="line">           expireSessionsOnShutdown=<span class="string">&quot;false&quot;</span></span><br><span class="line">           notifyListenersOnReplication=<span class="string">&quot;true&quot;</span>/&gt;</span><br><span class="line">  &lt;Channel className=<span class="string">&quot;org.apache.catalina.tribes.group.GroupChannel&quot;</span>&gt;</span><br><span class="line">  &lt;Membership className=<span class="string">&quot;org.apache.catalina.tribes.membership.McastService&quot;</span></span><br><span class="line">              address=<span class="string">&quot;230.100.100.100&quot;</span></span><br><span class="line">              port=<span class="string">&quot;45564&quot;</span></span><br><span class="line">              frequency=<span class="string">&quot;500&quot;</span></span><br><span class="line">              dropTime=<span class="string">&quot;3000&quot;</span>/&gt;</span><br><span class="line"> &lt;Receiver className=<span class="string">&quot;org.apache.catalina.tribes.transport.nio.NioReceiver&quot;</span></span><br><span class="line">              address=<span class="string">&quot;10.0.0.102&quot;</span>            <span class="comment">#此行指定当前主机的IP,其它和T1节点配置相同</span></span><br><span class="line">              port=<span class="string">&quot;4000&quot;</span></span><br><span class="line">              autoBind=<span class="string">&quot;100&quot;</span></span><br><span class="line">              selectorTimeout=<span class="string">&quot;5000&quot;</span></span><br><span class="line">              maxThreads=<span class="string">&quot;6&quot;</span>/&gt;</span><br><span class="line"> &lt;Sender</span><br><span class="line">className=<span class="string">&quot;org.apache.catalina.tribes.transport.ReplicationTransmitter&quot;</span>&gt;</span><br><span class="line">  &lt;Transport</span><br><span class="line">className=<span class="string">&quot;org.apache.catalina.tribes.transport.nio.PooledParallelSender&quot;</span>/&gt;</span><br><span class="line"> &lt;/Sender&gt;</span><br><span class="line">&lt;Interceptor</span><br><span class="line">className=<span class="string">&quot;org.apache.catalina.tribes.group.interceptors.TcpFailureDetector&quot;</span>/&gt;</span><br><span class="line">&lt;Interceptor</span><br><span class="line">className=<span class="string">&quot;org.apache.catalina.tribes.group.interceptors.MessageDispatchInterceptor&quot;</span>/&gt;</span><br><span class="line">&lt;/Channel&gt;</span><br><span class="line">  &lt;Valve className=<span class="string">&quot;org.apache.catalina.ha.tcp.ReplicationValve&quot;</span></span><br><span class="line">         filter=<span class="string">&quot;&quot;</span>/&gt;</span><br><span class="line">  &lt;Valve className=<span class="string">&quot;org.apache.catalina.ha.session.JvmRouteBinderValve&quot;</span>/&gt;</span><br><span class="line">  &lt;Deployer className=<span class="string">&quot;org.apache.catalina.ha.deploy.FarmWarDeployer&quot;</span></span><br><span class="line">            tempDir=<span class="string">&quot;/tmp/war-temp/&quot;</span></span><br><span class="line">            deployDir=<span class="string">&quot;/tmp/war-deploy/&quot;</span></span><br><span class="line">            watchDir=<span class="string">&quot;/tmp/war-listen/&quot;</span></span><br><span class="line">            watchEnabled=<span class="string">&quot;false&quot;</span>/&gt;</span><br><span class="line">  &lt;ClusterListener</span><br><span class="line">className=<span class="string">&quot;org.apache.catalina.ha.session.ClusterSessionListener&quot;</span>/&gt;</span><br><span class="line">&lt;/Cluster&gt;</span><br><span class="line"><span class="comment">#######################################以上内容是新加的#################################</span></span><br><span class="line">              &lt;/Host&gt;</span><br><span class="line">    &lt;/Engine&gt;</span><br><span class="line">  &lt;/Service&gt;</span><br><span class="line">&lt;/Server&gt;</span><br><span class="line"></span><br><span class="line">[root@t2 ~]<span class="comment"># systemctl restart tomcat</span></span><br><span class="line">[root@t2 ~]<span class="comment"># ss -ntl</span></span><br><span class="line">State           Recv-Q   Send-Q       Local Address:Port   Peer Address:Port  </span><br><span class="line">LISTEN           0       128                0.0.0.0:22           0.0.0.0:*       </span><br><span class="line">LISTEN           0       100              127.0.0.1:25           0.0.0.0:*       </span><br><span class="line">LISTEN           0       128                   [::]:22              [::]:*       </span><br><span class="line">LISTEN           0       100                  [::1]:25              [::]:*       </span><br><span class="line">LISTEN           0       50     [::ffff:10.0.0.102]:4000               *:*       </span><br><span class="line">LISTEN           0       1       [::ffff:127.0.0.1]:8005               *:*       </span><br><span class="line">LISTEN           0       100                      *:8009               *:*       </span><br><span class="line">LISTEN           0       100                      *:8080               *:*    </span><br></pre></td></tr></table></figure>

<p><strong>简化说明</strong></p>
<p>t2主机的server.xml中，如下</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">Host</span> <span class="attr">name</span>=<span class="string">&quot;t2.magedu.com&quot;</span> <span class="attr">appBase</span>=<span class="string">&quot;/data/webapps&quot;</span> <span class="attr">autoDeploy</span>=<span class="string">&quot;true&quot;</span> &gt;</span></span><br><span class="line">   其他略去</span><br><span class="line">    <span class="tag">&lt;<span class="name">Receiver</span> <span class="attr">className</span>=<span class="string">&quot;org.apache.catalina.tribes.transport.nio.NioReceiver&quot;</span></span></span><br><span class="line"><span class="tag">              <span class="attr">address</span>=<span class="string">&quot;10.0.0.102&quot;</span>  #<span class="attr">只改此行</span></span></span><br><span class="line"><span class="tag">              <span class="attr">port</span>=<span class="string">&quot;4000&quot;</span></span></span><br><span class="line"><span class="tag">              <span class="attr">autoBind</span>=<span class="string">&quot;100&quot;</span></span></span><br><span class="line"><span class="tag">              <span class="attr">selectorTimeout</span>=<span class="string">&quot;5000&quot;</span></span></span><br><span class="line"><span class="tag">              <span class="attr">maxThreads</span>=<span class="string">&quot;6&quot;</span>/&gt;</span></span><br></pre></td></tr></table></figure>

<p>尝试使用刚才配置过得负载均衡(移除Session黏性)，测试发现Session还是变来变去</p>
<h3 id="修改应用的web-xml文件开启该应用程序的分布式"><a href="#修改应用的web-xml文件开启该应用程序的分布式" class="headerlink" title="修改应用的web.xml文件开启该应用程序的分布式"></a>修改应用的web.xml文件开启该应用程序的分布式</h3><p>参考官方说明: <a target="_blank" rel="noopener" href="https://tomcat.apache.org/tomcat-8.5-doc/cluster-howto.html">https://tomcat.apache.org/tomcat-8.5-doc/cluster-howto.html</a></p>
<p><img src="../../../../images/SRE/day33/93.jpg" alt="93"></p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Make sure your web.xml has the &lt;distributable/&gt; element</span><br></pre></td></tr></table></figure>

<p>为所有tomcat主机应用web.xml的  标签增加子标签  来开启该应用程序的分布式。</p>
<h4 id="修改t1主机的应用的web-xml文件"><a href="#修改t1主机的应用的web-xml文件" class="headerlink" title="修改t1主机的应用的web.xml文件"></a>修改t1主机的应用的web.xml文件</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">[root@t1 ~]<span class="comment"># ll /usr/local/tomcat/webapps/ROOT/WEB-INF/</span></span><br><span class="line">total 4</span><br><span class="line">-rw-r----- 1 tomcat tomcat 1227 Jul  1 05:53 web.xml</span><br><span class="line"></span><br><span class="line">[root@t1 ~]<span class="comment"># cp -a /usr/local/tomcat/webapps/ROOT/WEB-INF/ /data/webapps/ROOT/</span></span><br><span class="line">[root@t1 ~]<span class="comment"># tree /data/webapps/ROOT/</span></span><br><span class="line">/data/webapps/ROOT/</span><br><span class="line">├── index.jsp</span><br><span class="line">└── WEB-INF</span><br><span class="line">   └── web.xml</span><br><span class="line">1 directory, 2 files</span><br><span class="line"></span><br><span class="line"><span class="comment">#在倒数第二行加一行</span></span><br><span class="line">[root@t1 ~]<span class="comment"># vim /data/webapps/ROOT/WEB-INF/web.xml </span></span><br><span class="line">[root@t1 ~]<span class="comment"># tail -n3 /data/webapps/ROOT/WEB-INF/web.xml</span></span><br><span class="line"> &lt;/description&gt;</span><br><span class="line">&lt;distributable/&gt;  <span class="comment">#添加此行</span></span><br><span class="line">&lt;/web-app&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment">#注意权限</span></span><br><span class="line">[root@t1 ~]<span class="comment"># ll /data/webapps/ROOT/WEB-INF/</span></span><br><span class="line">total 4</span><br><span class="line">-rw-r----- 1 tomcat tomcat 1243 Jan 17 09:37 web.xml</span><br><span class="line"></span><br><span class="line">[root@t1 ~]<span class="comment"># systemctl restart tomcat</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#同时观察日志</span></span><br><span class="line">[root@t1 ~]<span class="comment"># tail -f /usr/local/tomcat/logs/catalina.out </span></span><br><span class="line">15-Jul-2020 11:29:10.998 INFO [Membership-MemberAdded.] </span><br><span class="line">org.apache.catalina.ha.tcp.SimpleTcpCluster.memberAdded Replication member added:</span><br><span class="line">[org.apache.catalina.tribes.membership.MemberImpl[tcp://&#123;10, 0, 0, 102&#125;:4000,</span><br><span class="line">&#123;10, 0, 0, 102&#125;,4000, alive=1022, securePort=-1, UDP Port=-1, <span class="built_in">id</span>=&#123;89 -26 -30 -99</span><br><span class="line">16 80 65 95 -65 14 -33 124 -55 -123 -30 82 &#125;, payload=&#123;&#125;, <span class="built_in">command</span>=&#123;&#125;, domain=&#123;&#125;]]</span><br></pre></td></tr></table></figure>

<h4 id="修改t2主机的应用的web-xml文件"><a href="#修改t2主机的应用的web-xml文件" class="headerlink" title="修改t2主机的应用的web.xml文件"></a>修改t2主机的应用的web.xml文件</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#与5.2.3.1上的t1相同的操作</span></span><br><span class="line">[root@t2 ~]<span class="comment"># cp -a /usr/local/tomcat/webapps/ROOT/WEB-INF/ /data/webapps/ROOT/</span></span><br><span class="line">[root@t2 ~]<span class="comment"># vim /data/webapps/ROOT/WEB-INF/web.xml</span></span><br><span class="line">[root@t2 ~]<span class="comment"># tail -n3 /data/webapps/ROOT/WEB-INF/web.xml</span></span><br><span class="line"> &lt;/description&gt;</span><br><span class="line">&lt;distributable/&gt;  <span class="comment">#添加此行</span></span><br><span class="line">&lt;/web-app&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment">#注意权限</span></span><br><span class="line">[root@t2 ~]<span class="comment"># ll /data/webapps/ROOT/WEB-INF/</span></span><br><span class="line">total 4</span><br><span class="line">-rw-r----- 1 tomcat tomcat 1243 Jan 17 09:38 web.xml</span><br><span class="line"></span><br><span class="line">[root@t2 ~]<span class="comment"># systemctl restart tomcat</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#同时观察日志</span></span><br><span class="line">[root@t2 ~]<span class="comment"># tail -f /usr/local/tomcat/logs/catalina.out </span></span><br><span class="line">15-Jul-2020 11:29:12.088 INFO [t2.magedu.org-startStop-1] </span><br><span class="line">org.apache.catalina.ha.session.DeltaManager.getAllClusterSessions Manager [], </span><br><span class="line">requesting session state from </span><br><span class="line">[org.apache.catalina.tribes.membership.MemberImpl[tcp://&#123;10, 0, 0, 101&#125;:4000,</span><br><span class="line">&#123;10, 0, 0, 101&#125;,4000, alive=208408, securePort=-1, UDP Port=-1, <span class="built_in">id</span>=&#123;118 -108</span><br><span class="line">-116 119 58 22 73 113 -123 -96 -94 111 -65 -90 -87 -107 &#125;, payload=&#123;&#125;, <span class="built_in">command</span>=</span><br><span class="line">&#123;&#125;, domain=&#123;&#125;]]. This operation will <span class="built_in">timeout</span> <span class="keyword">if</span> no session state has been </span><br><span class="line">received within [60] seconds.</span><br></pre></td></tr></table></figure>

<h3 id="测试访问"><a href="#测试访问" class="headerlink" title="测试访问"></a>测试访问</h3><p>重启全部Tomcat，通过负载均衡调度到不同节点，返回的SessionID不变了。</p>
<p>用浏览器访问,并刷新多次,发现SessionID 不变,但后端主机在轮询</p>
<p><strong>但此方式当后端tomcat主机较多时,会重复占用大量的内存,并不适合后端服务器众多的场景</strong></p>
<p><img src="../../../../images/SRE/day33/94.jpg" alt="94"><br><img src="../../../../images/SRE/day33/95.jpg" alt="95"></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#修改t1和t2的配置项,删除jvmRoute配置项</span></span><br><span class="line">[root@t1 tomcat]<span class="comment"># vim conf/server.xml</span></span><br><span class="line"> &lt;Engine name=<span class="string">&quot;Catalina&quot;</span> defaultHost=<span class="string">&quot;t1.magedu.org&quot;</span> &gt;</span><br><span class="line">[root@t1 tomcat]<span class="comment"># systemctl restart tomcat</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#多次执行下面操作,可以看到SessionID不变</span></span><br><span class="line">[root@centos7 ~]<span class="comment"># curl -b &#x27;JSESSIONID=1A3E7EED14F3E44FAF7469F8693E1CB6&#x27; proxy.magedu.org/index.jsp</span></span><br><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html lang=<span class="string">&quot;en&quot;</span>&gt;</span><br><span class="line">&lt;<span class="built_in">head</span>&gt;</span><br><span class="line">   &lt;meta charset=<span class="string">&quot;UTF-8&quot;</span>&gt;</span><br><span class="line">   &lt;title&gt;tomcat <span class="built_in">test</span>&lt;/title&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">&lt;h1&gt; tomcat website &lt;/h1&gt;</span><br><span class="line">&lt;div&gt;On tomcat-server&lt;/div&gt;</span><br><span class="line">&lt;div&gt;10.0.0.102:8080&lt;/div&gt;</span><br><span class="line">&lt;div&gt;SessionID = &lt;span </span><br><span class="line">style=<span class="string">&quot;color:blue&quot;</span>&gt;1A3E7EED14F3E44FAF7469F8693E1CB6&lt;/span&gt;&lt;/div&gt;</span><br><span class="line">Wed Jul 15 11:33:09 CST 2020</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br><span class="line"></span><br><span class="line">[root@centos7 ~]<span class="comment"># curl -b &#x27;JSESSIONID=1A3E7EED14F3E44FAF7469F8693E1CB6&#x27; </span></span><br><span class="line">proxy.magedu.org/index.jsp</span><br><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html lang=<span class="string">&quot;en&quot;</span>&gt;</span><br><span class="line">&lt;<span class="built_in">head</span>&gt;</span><br><span class="line">   &lt;meta charset=<span class="string">&quot;UTF-8&quot;</span>&gt;</span><br><span class="line">   &lt;title&gt;tomcat <span class="built_in">test</span>&lt;/title&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">&lt;h1&gt; tomcat website &lt;/h1&gt;</span><br><span class="line">&lt;div&gt;On tomcat-server&lt;/div&gt;</span><br><span class="line">&lt;div&gt;10.0.0.101:8080&lt;/div&gt;</span><br><span class="line">&lt;div&gt;SessionID = &lt;span </span><br><span class="line">style=<span class="string">&quot;color:blue&quot;</span>&gt;1A3E7EED14F3E44FAF7469F8693E1CB6&lt;/span&gt;&lt;/div&gt;</span><br><span class="line">Wed Jul 15 11:33:10 CST 2020</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure>

<p><img src="../../../../images/SRE/day33/96.jpg" alt="96"></p>
<h3 id="故障模拟"><a href="#故障模拟" class="headerlink" title="故障模拟"></a>故障模拟</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#模拟t2节点故障</span></span><br><span class="line">[root@t2 ~]<span class="comment"># systemctl stop tomcat</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#多次访问SessionID不变</span></span><br><span class="line">[root@centos7 ~]<span class="comment"># curl -b &#x27;JSESSIONID=1A3E7EED14F3E44FAF7469F8693E1CB6&#x27; proxy.magedu.org/index.jsp</span></span><br><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html lang=<span class="string">&quot;en&quot;</span>&gt;</span><br><span class="line">&lt;<span class="built_in">head</span>&gt;</span><br><span class="line">   &lt;meta charset=<span class="string">&quot;UTF-8&quot;</span>&gt;</span><br><span class="line">   &lt;title&gt;tomcat <span class="built_in">test</span>&lt;/title&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">&lt;h1&gt; tomcat website &lt;/h1&gt;</span><br><span class="line">&lt;div&gt;On tomcat-server&lt;/div&gt;</span><br><span class="line">&lt;div&gt;10.0.0.101:8080&lt;/div&gt;</span><br><span class="line">&lt;div&gt;SessionID = &lt;span </span><br><span class="line">style=<span class="string">&quot;color:blue&quot;</span>&gt;1A3E7EED14F3E44FAF7469F8693E1CB6&lt;/span&gt;&lt;/div&gt;</span><br><span class="line">Wed Jul 15 12:01:16 CST 2020</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure>

<h3 id="恢复实验环境"><a href="#恢复实验环境" class="headerlink" title="恢复实验环境"></a>恢复实验环境</h3><p>本小节结束,为学习后面的内容,删除此节相关配置,为后续内容准备</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#恢复t1环境</span></span><br><span class="line">[root@t1 ~]<span class="comment"># vim /usr/local/tomcat/conf/server.xml </span></span><br><span class="line">[root@t1 ~]<span class="comment"># tail /usr/local/tomcat/conf/server.xml </span></span><br><span class="line">       &lt;Valve className=<span class="string">&quot;org.apache.catalina.valves.AccessLogValve&quot;</span></span><br><span class="line">              directory=<span class="string">&quot;logs&quot;</span></span><br><span class="line">              prefix=<span class="string">&quot;localhost_access_log&quot;</span> suffix=<span class="string">&quot;.txt&quot;</span></span><br><span class="line">              pattern=<span class="string">&quot;%h %l %u %t &amp;quot;%r&amp;quot; %s %b&quot;</span> /&gt;</span><br><span class="line">     &lt;/Host&gt;</span><br><span class="line">     &lt;Host name=<span class="string">&quot;t1.magedu.org&quot;</span>  appBase=<span class="string">&quot;/data/webapps&quot;</span> unpackWARs=<span class="string">&quot;true&quot;</span></span><br><span class="line">autoDeploy=<span class="string">&quot;true&quot;</span>&gt;</span><br><span class="line">     &lt;/Host&gt;</span><br><span class="line">   &lt;/Engine&gt;</span><br><span class="line"> &lt;/Service&gt;</span><br><span class="line">&lt;/Server&gt;</span><br><span class="line"></span><br><span class="line">[root@t1 ~]<span class="comment"># rm -f   /data/webapps/ROOT/WEB-INF/web.xml</span></span><br><span class="line">[root@t1 ~]<span class="comment"># systemctl restart tomcat</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#恢复t2环境</span></span><br><span class="line">[root@t2 ~]<span class="comment"># vim /usr/local/tomcat/conf/server.xml</span></span><br><span class="line">[root@t2 ~]<span class="comment"># tail /usr/local/tomcat/conf/server.xml</span></span><br><span class="line">               prefix=<span class="string">&quot;localhost_access_log&quot;</span> suffix=<span class="string">&quot;.txt&quot;</span></span><br><span class="line">               pattern=<span class="string">&quot;%h %l %u %t &amp;quot;%r&amp;quot; %s %b&quot;</span> /&gt;</span><br><span class="line">     &lt;/Host&gt;</span><br><span class="line">         &lt;Host name=<span class="string">&quot;t2.magedu.org&quot;</span> appBase=<span class="string">&quot;/data/webapps&quot;</span> autoDeploy=<span class="string">&quot;true&quot;</span> &gt;</span><br><span class="line">             &lt;/Host&gt;</span><br><span class="line">   &lt;/Engine&gt;</span><br><span class="line"> &lt;/Service&gt;</span><br><span class="line">&lt;/Server&gt;</span><br><span class="line"></span><br><span class="line">[root@t2 ~]<span class="comment"># rm -f   /data/webapps/ROOT/WEB-INF/web.xml</span></span><br><span class="line">[root@t2 ~]<span class="comment"># systemctl restart tomcat</span></span><br></pre></td></tr></table></figure>

<h1 id="Memcached"><a href="#Memcached" class="headerlink" title="Memcached"></a>Memcached</h1><h2 id="NoSQL介绍"><a href="#NoSQL介绍" class="headerlink" title="NoSQL介绍"></a>NoSQL介绍</h2><p>NoSQL是对 Not Only SQL、非传统关系型数据库的统称。</p>
<p>NoSQL一词诞生于1998年，2009年这个词汇被再次提出指非关系型、分布式、不提供ACID的数据库设计模式。</p>
<p>随着互联网时代的到来，数据爆发式增长，数据库技术发展日新月异，要适应新的业务需求。</p>
<p>而随着移动互联网、物联网的到来，大数据的技术中NoSQL也同样重要。</p>
<p>数据库排名：<a target="_blank" rel="noopener" href="https://db-engines.com/en/ranking">https://db-engines.com/en/ranking</a></p>
<p>NoSQL 分类</p>
<ul>
<li>Key-value Store k/v数据库<ul>
<li>性能好 O(1) , 如: redis、memcached</li>
</ul>
</li>
<li>Document Store 文档数据库<ul>
<li>mongodb、CouchDB</li>
</ul>
</li>
<li>Column Store 列存数据库，Column-Oriented DB<ul>
<li>HBase、Cassandra，大数据领域应用广泛</li>
</ul>
</li>
<li>Graph DB 图数据库<ul>
<li>Neo4j</li>
</ul>
</li>
<li>Time Series 时序数据库<ul>
<li>InfluxDB、Prometheus</li>
</ul>
</li>
</ul>
<h2 id="Memcached-1"><a href="#Memcached-1" class="headerlink" title="Memcached"></a>Memcached</h2><p><img src="../../../../images/SRE/day33/97.jpg" alt="97"></p>
<p>Memcached 只支持能序列化的数据类型，不支持持久化，基于Key-Value的内存缓存系统</p>
<p>memcached 虽然没有像redis所具备的数据持久化功能，比如RDB和AOF都没有，但是可以通过做集群同步的方式，让各memcached服务器的数据进行同步，从而实现数据的一致性，即保证各memcached的数据是一样的，即使有任何一台 memcached 发生故障，只要集群中有一台 memcached 可用就不会出现数据丢失，当其他memcached 重新加入到集群的时候,可以自动从有数据的memcached 当中自动获取数据并提供服务。 </p>
<p>Memcached 借助了操作系统的 libevent 工具做高效的读写。libevent是个程序库，它将Linux的epoll、BSD类操作系统的kqueue等事件处理功能封装成统一的接口。即使对服务器的连接数增加，也能发挥高性能。memcached使用这个libevent库，因此能在Linux、BSD、Solaris等操作系统上发挥其高性能</p>
<p>Memcached 支持最大的内存存储对象为1M，超过1M的数据可以使用客户端压缩或拆分报包放到多个key中，比较大的数据在进行读取的时候需要消耗的时间比较长，memcached 最适合保存用户的session实现session共享</p>
<p>Memcached存储数据时, Memcached会去申请1MB的内存, 把该块内存称为一个slab, 也称为一个page</p>
<p>Memcached 支持多种开发语言，包括：JAVA,C,Python,PHP,C#,Ruby,Perl等 </p>
<p>Memcached 官网：<a target="_blank" rel="noopener" href="http://memcached.org/">http://memcached.org/</a></p>
<h2 id="Memcached-和-Redis-比较"><a href="#Memcached-和-Redis-比较" class="headerlink" title="Memcached 和 Redis 比较"></a>Memcached 和 Redis 比较</h2><table>
<thead>
<tr>
<th>比较类别</th>
<th>Redis</th>
<th>Memcached</th>
</tr>
</thead>
<tbody><tr>
<td>支持的数据结构</td>
<td>哈希、列表、集合、有序集合</td>
<td>纯kev-value</td>
</tr>
<tr>
<td>持久化支持</td>
<td>有</td>
<td>无</td>
</tr>
<tr>
<td>高可用支持</td>
<td>redis支持集群功能，可以实现主动复制，读写分离。官方也提供了sentinel集群管理工具，能够实现主从服务监控，故障自动转移，这一切，对于客户端都是透明的，无需程序改动，也无需人工介入</td>
<td>需要二次开发</td>
</tr>
<tr>
<td>存储 value 容量</td>
<td>最大512M</td>
<td>最大1M</td>
</tr>
<tr>
<td>内存分配</td>
<td>临时申请空间，可能导致碎片</td>
<td>预分配内存池的方式管理内存，能够省去内存分配时间</td>
</tr>
<tr>
<td>虚拟内存使用</td>
<td>有自己的VM机制，理论上能够存储比物理内存更多的数据，当数据超量时，会引发swap，把冷数据刷到磁盘上</td>
<td>所有的数据存储在物理内存里</td>
</tr>
<tr>
<td>网络模型</td>
<td>非阻塞IO复用模型,提供一些非KV存储之外的排序，聚合功能，在执行这些功能时，复杂的CPU计算，会阻塞整个IO调度</td>
<td>非阻塞IO复用模型</td>
</tr>
<tr>
<td>水平扩展的支持</td>
<td>redis cluster 可以横向扩展</td>
<td>暂无</td>
</tr>
<tr>
<td>多线程</td>
<td>Redis6.0之前是只支持单线程</td>
<td>Memcached支持多线程,CPU利用方面Memcache优于Redis</td>
</tr>
<tr>
<td>过期策略</td>
<td>有专门线程，清除缓存数据</td>
<td>懒淘汰机制：每次往缓存放入数据的时候，都会存一个时间，在读取的时候要和设置的时间做TTL比较来判断是否过期</td>
</tr>
<tr>
<td>单机QPS</td>
<td>约10W</td>
<td>约60W</td>
</tr>
<tr>
<td>源代码可读性</td>
<td>代码清爽简洁</td>
<td>可能是考虑了太多的扩展性，多系统的兼容性，代码不清爽</td>
</tr>
<tr>
<td><strong>适用场景</strong></td>
<td>复杂数据结构、有持久化、高可用需求、value存储内容较大</td>
<td>纯KV，数据量非常大，并发量非常大的业务</td>
</tr>
</tbody></table>
<h2 id="Memcached-工作机制"><a href="#Memcached-工作机制" class="headerlink" title="Memcached 工作机制"></a>Memcached 工作机制</h2><h3 id="内存分配机制"><a href="#内存分配机制" class="headerlink" title="内存分配机制"></a>内存分配机制</h3><p>应用程序运行需要使用内存存储数据，但对于一个缓存系统来说，申请内存、释放内存将十分频繁，非常容易导致大量内存碎片，最后导致无连续可用内存可用。 </p>
<p>Memcached采用了Slab Allocator机制来分配、管理内存。</p>
<ul>
<li>Page：分配给Slab的内存空间，默认为1MB，分配后就得到一个Slab。Slab分配之后内存按照固定字节大小等分成chunk。</li>
<li>Chunk：用于缓存记录k/v值的内存空间。Memcached会根据数据大小选择存到哪一个chunk中，假设chunk有128bytes、64bytes等多种，数据只有100bytes存储在128bytes中，存在少许浪费。<ul>
<li>Chunk最大就是Page的大小，即一个Page中就一个Chunk</li>
</ul>
</li>
<li>Slab Class：Slab按照Chunk的大小分组，就组成不同的Slab Class, 第一个Chunk大小为 96B的Slab为Class1,Chunk 120B为Class 2,如果有100bytes要存，那么Memcached会选择下图中Slab Class 2 存储，因为它是120bytes的Chunk。Slab之间的差异可以使用Growth Factor 控制，默认1.25。</li>
</ul>
<p><img src="../../../../images/SRE/day33/98.jpg" alt="98"></p>
<p>范例：查看Slab Class</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#-f, --slab-growth-factor=&lt;num&gt; chunk size growth factor (default: 1.25)</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># memcached -u memcached -f 2 -vv</span></span><br><span class="line">slab class   1: chunk size        96 perslab   10922</span><br><span class="line">slab class   2: chunk size       192 perslab    5461</span><br><span class="line">slab class   3: chunk size       384 perslab    2730</span><br><span class="line">slab class   4: chunk size       768 perslab    1365</span><br><span class="line">slab class   5: chunk size      1536 perslab     682</span><br><span class="line">slab class   6: chunk size      3072 perslab     341</span><br><span class="line">slab class   7: chunk size      6144 perslab     170</span><br><span class="line">slab class   8: chunk size     12288 perslab      85</span><br><span class="line">slab class   9: chunk size     24576 perslab      42</span><br><span class="line">slab class  10: chunk size     49152 perslab      21</span><br><span class="line">slab class  11: chunk size     98304 perslab      10</span><br><span class="line">slab class  12: chunk size    196608 perslab       5</span><br><span class="line">slab class  13: chunk size    524288 perslab       2</span><br><span class="line">&lt;27 server listening (auto-negotiate)</span><br><span class="line">&lt;28 server listening (auto-negotiate)</span><br></pre></td></tr></table></figure>

<h3 id="懒过期-Lazy-Expiration"><a href="#懒过期-Lazy-Expiration" class="headerlink" title="懒过期 Lazy Expiration"></a>懒过期 Lazy Expiration</h3><p>memcached不会监视数据是否过期，而是在取数据时才看是否过期，如果过期,把数据有效期限标识为0，并不清除该数据。以后可以覆盖该位置存储其它数据。</p>
<h3 id="LRU"><a href="#LRU" class="headerlink" title="LRU"></a>LRU</h3><p>当内存不足时，memcached会使用LRU（Least Recently Used）机制来查找可用空间，分配给新记录使用。</p>
<h3 id="集群"><a href="#集群" class="headerlink" title="集群"></a>集群</h3><p>Memcached集群，称为基于客户端的分布式集群，即由客户端实现集群功能，即Memcached本身不支持集群</p>
<p>Memcached集群内部并不互相通信，一切都需要客户端连接到Memcached服务器后自行组织这些节点，并决定数据存储的节点。</p>
<h2 id="安装和启动"><a href="#安装和启动" class="headerlink" title="安装和启动"></a>安装和启动</h2><p>官方安装说明</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://github.com/memcached/memcached/wiki/Install</span><br></pre></td></tr></table></figure>

<h3 id="yum安装"><a href="#yum安装" class="headerlink" title="yum安装"></a>yum安装</h3><p>范例: CentOS 8 安装 memcached</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ~]<span class="comment"># dnf info memcached</span></span><br><span class="line">Last metadata expiration check: 0:16:45 ago on Wed 15 Jul 2020 03:07:47 PM CST. Available Packages</span><br><span class="line">Name         : memcached</span><br><span class="line">Version      : 1.5.9</span><br><span class="line">Release      : 3.el8</span><br><span class="line">Architecture : x86_64</span><br><span class="line">Size         : 132 k</span><br><span class="line">Source       : memcached-1.5.9-3.el8.src.rpm</span><br><span class="line">Repository   : AppStream</span><br><span class="line">Summary      : High Performance, Distributed Memory Object Cache</span><br><span class="line">URL          : https://www.memcached.org/</span><br><span class="line">License      : BSD</span><br><span class="line">Description  : memcached is a high-performance, distributed memory object </span><br><span class="line">caching</span><br><span class="line">             : system, generic <span class="keyword">in</span> nature, but intended <span class="keyword">for</span> use <span class="keyword">in</span> speeding up </span><br><span class="line">dynamic</span><br><span class="line">             : web applications by alleviating database load.</span><br><span class="line">             </span><br><span class="line">[root@centos8 ~]<span class="comment"># dnf -y install memcached</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># rpm -ql memcached</span></span><br><span class="line"></span><br><span class="line">[root@t1 ~]<span class="comment"># cat /etc/sysconfig/memcached </span></span><br><span class="line">PORT=<span class="string">&quot;11211&quot;</span>     <span class="comment">#监听端口</span></span><br><span class="line">USER=<span class="string">&quot;memcached&quot;</span> <span class="comment">#启动用户</span></span><br><span class="line">MAXCONN=<span class="string">&quot;1024&quot;</span>  <span class="comment">#最大连接数</span></span><br><span class="line">CACHESIZE=<span class="string">&quot;64&quot;</span>  <span class="comment">#最大使用内存</span></span><br><span class="line">OPTIONS=<span class="string">&quot;-l 127.0.0.1,::1&quot;</span> <span class="comment">#其他选项</span></span><br><span class="line"></span><br><span class="line">[root@centos8 ~]<span class="comment"># grep -Ev &quot;^#|^$&quot; /usr/lib/systemd/system/memcached.service</span></span><br><span class="line">[Unit]</span><br><span class="line">Description=memcached daemon</span><br><span class="line">Before=httpd.service</span><br><span class="line">After=network.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">EnvironmentFile=/etc/sysconfig/memcached</span><br><span class="line">ExecStart=/usr/bin/memcached -p <span class="variable">$&#123;PORT&#125;</span> -u <span class="variable">$&#123;USER&#125;</span> -m <span class="variable">$&#123;CACHESIZE&#125;</span> -c <span class="variable">$&#123;MAXCONN&#125;</span></span><br><span class="line"><span class="variable">$OPTIONS</span></span><br><span class="line">PrivateTmp=<span class="literal">true</span></span><br><span class="line">ProtectSystem=full</span><br><span class="line">NoNewPrivileges=<span class="literal">true</span></span><br><span class="line">PrivateDevices=<span class="literal">true</span></span><br><span class="line">CapabilityBoundingSet=CAP_SETGID CAP_SETUID CAP_SYS_RESOURCE</span><br><span class="line">RestrictAddressFamilies=AF_INET AF_INET6 AF_UNIX</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line"></span><br><span class="line">[root@centos8 ~]<span class="comment"># getent passwd memcached</span></span><br><span class="line">memcached:x:992:989:Memcached daemon:/run/memcached:/sbin/nologin</span><br><span class="line"></span><br><span class="line">[root@centos8 ~]<span class="comment"># systemctl enable --now memcached</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># pstree -p |grep memcached</span></span><br><span class="line">           |-memcached(25582)-+-&#123;memcached&#125;(25584)</span><br><span class="line">           |                 |-&#123;memcached&#125;(25585)</span><br><span class="line">           |                 |-&#123;memcached&#125;(25586)</span><br><span class="line">           |                 |-&#123;memcached&#125;(25587)</span><br><span class="line">           |                 |-&#123;memcached&#125;(25588)</span><br><span class="line">           |                 |-&#123;memcached&#125;(25589)</span><br><span class="line">           |                 |-&#123;memcached&#125;(25590)</span><br><span class="line">           |                 |-&#123;memcached&#125;(25591)</span><br><span class="line">           |                  `-&#123;memcached&#125;(25592)</span><br><span class="line">           </span><br><span class="line">[root@centos8 ~]<span class="comment"># ss -ntlup|grep memcached</span></span><br><span class="line">tcp   LISTEN  0       128                127.0.0.1:11211         0.0.0.0:*     <span class="built_in">users</span>:((&quot;memcached&quot;,pid=<span class="number">25453</span>,fd=<span class="number">27</span>))           </span><br><span class="line">tcp   LISTEN  0       128                    [::1]:11211            [::]:*     <span class="built_in">users</span>:((&quot;memcached&quot;,pid=<span class="number">25453</span>,fd=<span class="number">28</span>)) </span><br><span class="line"></span><br><span class="line"><span class="comment">#修改端口绑定的IP为当前主机的所有IP</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># vim /etc/sysconfig/memcached </span></span><br><span class="line">[root@centos8 ~]<span class="comment"># cat /etc/sysconfig/memcached </span></span><br><span class="line">PORT=<span class="string">&quot;11211&quot;</span></span><br><span class="line">USER=<span class="string">&quot;memcached&quot;</span></span><br><span class="line">MAXCONN=<span class="string">&quot;1024&quot;</span></span><br><span class="line">CACHESIZE=<span class="string">&quot;64&quot;</span></span><br><span class="line"><span class="comment">#OPTIONS=&quot;-l 127.0.0.1,::1&quot; #注释此行</span></span><br><span class="line">OPTIONS=<span class="string">&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">[root@centos8 ~]<span class="comment"># systemctl restart memcached.service </span></span><br><span class="line">[root@centos8 ~]<span class="comment"># ss -ntul</span></span><br><span class="line">Netid     State   Recv-Q Send-Q Local Address:Port   Peer Address:Port      </span><br><span class="line">udp       UNCONN  0      0          127.0.0.1:323          0.0.0.0:*         </span><br><span class="line">udp       UNCONN  0      0              [::1]:323             [::]:*         </span><br><span class="line">tcp       LISTEN  0      128          0.0.0.0:22           0.0.0.0:*         </span><br><span class="line">tcp       LISTEN  0      100        127.0.0.1:25           0.0.0.0:*         </span><br><span class="line">tcp       LISTEN  0      128          0.0.0.0:11211        0.0.0.0:*         </span><br><span class="line">tcp       LISTEN  0      128             [::]:22              [::]:*         </span><br><span class="line">tcp       LISTEN  0      100            [::1]:25              [::]:*         </span><br><span class="line">tcp       LISTEN  0      128             [::]:11211           [::]:* </span><br></pre></td></tr></table></figure>

<p>范例: CentOS 7 安装 memcached</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">[root@centos7 ~]<span class="comment"># yum install memcached</span></span><br><span class="line">[root@centos7 ~]<span class="comment"># rpm -ql memcached</span></span><br><span class="line">[root@centos7 ~]<span class="comment"># getent passwd memcached</span></span><br><span class="line">memcached:x:997:995:Memcached daemon:/run/memcached:/sbin/nologin</span><br><span class="line"></span><br><span class="line">[root@centos7 ~]<span class="comment"># cat /usr/lib/systemd/system/memcached.service</span></span><br><span class="line">[Service]</span><br><span class="line">Type=simple</span><br><span class="line">EnvironmentFile=-/etc/sysconfig/memcached</span><br><span class="line">ExecStart=/usr/bin/memcached -u <span class="variable">$USER</span> -p <span class="variable">$PORT</span> -m <span class="variable">$CACHESIZE</span> -c <span class="variable">$MAXCONN</span></span><br><span class="line"><span class="variable">$OPTIONS</span></span><br><span class="line"></span><br><span class="line">[root@centos7 ~]<span class="comment"># cat /etc/sysconfig/memcached</span></span><br><span class="line">PORT=<span class="string">&quot;11211&quot;</span></span><br><span class="line">USER=<span class="string">&quot;memcached&quot;</span></span><br><span class="line">MAXCONN=<span class="string">&quot;1024&quot;</span></span><br><span class="line">CACHESIZE=<span class="string">&quot;64&quot;</span></span><br><span class="line">OPTIONS=<span class="string">&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#前台显示看看效果</span></span><br><span class="line">[root@centos7 ~]<span class="comment"># memcached -u memcached -p 11211 -f 1.25 -vv</span></span><br><span class="line">[root@centos7 ~]<span class="comment"># systemctl start memcached</span></span><br><span class="line">[root@centos7 ~]<span class="comment"># ss -ntlpu|grep memcached</span></span><br></pre></td></tr></table></figure>

<h3 id="编译安装"><a href="#编译安装" class="headerlink" title="编译安装"></a>编译安装</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line">[root@centos7 ~]<span class="comment"># yum -y install gcc libevent-devel </span></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment"># apt -y install gcc make libevent-dev</span></span><br><span class="line"></span><br><span class="line">[root@centos7 ~]<span class="comment"># wget http://memcached.org/files/memcached-1.6.6.tar.gz</span></span><br><span class="line">[root@centos7 ~]<span class="comment"># tar xvf memcached-1.6.6.tar.gz</span></span><br><span class="line">[root@centos7 ~]<span class="comment"># cd memcached-1.6.6/</span></span><br><span class="line">[root@centos7 memcached-1.6.6]<span class="comment"># ./configure --prefix=/apps/memcached</span></span><br><span class="line">[root@centos7 memcached-1.6.6]<span class="comment"># make &amp;&amp; make install</span></span><br><span class="line">[root@centos7 ~]<span class="comment"># tree /apps/memcached/</span></span><br><span class="line">/apps/memcached/</span><br><span class="line">├── bin</span><br><span class="line">│   └── memcached</span><br><span class="line">├── include</span><br><span class="line">│   └── memcached</span><br><span class="line">│       └── protocol_binary.h</span><br><span class="line">└── share</span><br><span class="line">   └── man</span><br><span class="line">       └── man1</span><br><span class="line">           └── memcached.1</span><br><span class="line">6 directories, 3 files</span><br><span class="line"></span><br><span class="line">[root@centos7 ~]<span class="comment"># echo &#x27;PATH=/apps/memcached/bin:$PATH&#x27; &gt; </span></span><br><span class="line">/etc/profile.d/memcached.sh</span><br><span class="line">[root@centos7 ~]<span class="comment"># . /etc/profile.d/memcached.sh</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#准备用户</span></span><br><span class="line">[root@centos7 ~]<span class="comment"># useradd -r -s /sbin/nologin memcached</span></span><br><span class="line">[root@centos7 ~]<span class="comment"># cat /etc/sysconfig/memcached </span></span><br><span class="line">PORT=<span class="string">&quot;11211&quot;</span></span><br><span class="line">USER=<span class="string">&quot;memcached&quot;</span></span><br><span class="line">MAXCONN=<span class="string">&quot;1024&quot;</span></span><br><span class="line">CACHESIZE=<span class="string">&quot;64&quot;</span></span><br><span class="line">OPTIONS=<span class="string">&quot;-l 127.0.0.1,::1&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#默认前台执行</span></span><br><span class="line">[root@centos7 ~]<span class="comment"># memcached -u memcached -m 2048 -c 65536 -f 2 -vv</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#以后台方式执行</span></span><br><span class="line">[root@centos7 ~]<span class="comment"># memcached -u memcached -m 2048 -c 65536 -d</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#准备service文件</span></span><br><span class="line">[root@centos7 ~]<span class="comment"># cat /lib/systemd/system/memcached.service </span></span><br><span class="line">[Unit]</span><br><span class="line">Description=memcached daemon</span><br><span class="line">Before=httpd.service</span><br><span class="line">After=network.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">EnvironmentFile=/etc/sysconfig/memcached</span><br><span class="line">ExecStart=/apps/memcached/bin/memcached -p <span class="variable">$&#123;PORT&#125;</span> -u &#123;USER&#125; -m <span class="variable">$&#123;CACHESIZE&#125;</span> -c <span class="variable">$&#123;MAXCONN&#125;</span> <span class="variable">$OPTIONS</span></span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line"></span><br><span class="line">[root@centos7 ~]<span class="comment"># systemctl daemon-reload </span></span><br><span class="line">[root@centos7 ~]<span class="comment"># systemctl enable --now memcached.service</span></span><br><span class="line">[root@centos7 ~]<span class="comment"># ss -ntl</span></span><br><span class="line">State     Recv-Q Send-Q Local Address:Port   Peer Address:Port</span><br><span class="line">LISTEN     0      128         127.0.0.1:11211        *:*                  </span><br><span class="line">LISTEN     0      128                 *:22           *:*                  </span><br><span class="line">LISTEN     0      100         127.0.0.1:25           *:*                  </span><br><span class="line">LISTEN     0      128             [::1]:11211     [::]:*                  </span><br><span class="line">LISTEN     0      128              [::]:22        [::]:*                  </span><br><span class="line">LISTEN     0      100             [::1]:25        [::]:*  </span><br><span class="line"></span><br><span class="line">[root@centos7 ~]<span class="comment"># memcached --version </span></span><br><span class="line">memcached 1.6.6</span><br></pre></td></tr></table></figure>

<h3 id="memcached-启动程序说明"><a href="#memcached-启动程序说明" class="headerlink" title="memcached 启动程序说明"></a>memcached 启动程序说明</h3><p>修改memcached 运行参数，可以使用下面的选项修改/etc/sysconfig/memcached文件</p>
<p>memcached 常见选项</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">-u username memcached运行的用户身份，必须普通用户</span><br><span class="line">-p 绑定的端口，默认11211</span><br><span class="line">-m num 最大内存，单位MB，默认64MB</span><br><span class="line">-c num 最大连接数，缺省1024</span><br><span class="line">-d 守护进程方式运行</span><br><span class="line">-f 增长因子Growth Factor，默认1.25</span><br><span class="line">-v 详细信息，-vv能看到详细信息</span><br><span class="line">-M 使用内存直到耗尽，不许LRU</span><br><span class="line">-U 设置UDP监听端口，0表示禁用UDP</span><br></pre></td></tr></table></figure>

<p>范例: </p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ~]<span class="comment"># memcached -u memcached -p 11211 -f 2 -vv</span></span><br><span class="line">slab class   1: chunk size        96 perslab   10922</span><br><span class="line">slab class   2: chunk size       192 perslab    5461</span><br><span class="line">slab class   3: chunk size       384 perslab    2730</span><br><span class="line">slab class   4: chunk size       768 perslab    1365</span><br><span class="line">slab class   5: chunk size      1536 perslab     682</span><br><span class="line">slab class   6: chunk size      3072 perslab     341</span><br><span class="line">slab class   7: chunk size      6144 perslab     170</span><br><span class="line">slab class   8: chunk size     12288 perslab      85</span><br><span class="line">slab class   9: chunk size     24576 perslab      42</span><br><span class="line">slab class  10: chunk size     49152 perslab      21</span><br><span class="line">slab class  11: chunk size     98304 perslab      10</span><br><span class="line">slab class  12: chunk size    196608 perslab       5</span><br><span class="line">slab class  13: chunk size    524288 perslab       2</span><br><span class="line">&lt;27 server listening (auto-negotiate)</span><br><span class="line">&lt;28 server listening (auto-negotiate)</span><br><span class="line"></span><br><span class="line">[root@centos8 ~]<span class="comment"># memcached -u memcached -p 11211 -f 1.25 -vv</span></span><br><span class="line">slab class   1: chunk size        96 perslab   10922</span><br><span class="line">slab class   2: chunk size       120 perslab    8738</span><br><span class="line">slab class   3: chunk size       152 perslab    6898</span><br><span class="line">slab class   4: chunk size       192 perslab    5461</span><br><span class="line">slab class   5: chunk size       240 perslab    4369</span><br><span class="line">slab class   6: chunk size       304 perslab    3449</span><br><span class="line">slab class   7: chunk size       384 perslab    2730</span><br><span class="line">slab class   8: chunk size       480 perslab    2184</span><br></pre></td></tr></table></figure>

<h2 id="使用-memcached"><a href="#使用-memcached" class="headerlink" title="使用 memcached"></a>使用 memcached</h2><h3 id="memcached-开发库和工具"><a href="#memcached-开发库和工具" class="headerlink" title="memcached 开发库和工具"></a>memcached 开发库和工具</h3><p>与memcached通信的不同语言的连接器。libmemcached提供了C库和命令行工具。  </p>
<p>范例: 查看memcached相关包</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ~]<span class="comment">#yum list &quot;*memcached*&quot;</span></span><br><span class="line">Last metadata expiration check: 0:09:46 ago on Thu 13 Feb 2020 07:14:15 PM CST. Installed Packages</span><br><span class="line">memcached.x86_64              1.5.9-2.el8         @AppStream Available Packages</span><br><span class="line">libmemcached.x86_64           1.0.18-15.el8       AppStream </span><br><span class="line">libmemcached-libs.i686        1.0.18-15.el8       AppStream </span><br><span class="line">libmemcached-libs.x86_64      1.0.18-15.el8       AppStream </span><br><span class="line">perl-Cache-Memcached.noarch   1.30-21.el8         epel      </span><br><span class="line">python2-memcached.noarch      1.58-8.el8          epel      </span><br><span class="line">python3-memcached.noarch      1.58-8.el8          epel </span><br><span class="line"></span><br><span class="line">[root@centos7 ~]<span class="comment"># yum list &quot;*memcached*&quot;</span></span><br><span class="line">Loaded plugins: fastestmirror</span><br><span class="line">Loading mirror speeds from cached hostfile</span><br><span class="line"> * base: </span><br><span class="line">Installed Packages</span><br><span class="line">memcached.x86_64                                        1.4.15-10.el7_3.1   @base Available Packages</span><br><span class="line">libmemcached.i686                                       1.0.16-5.el7       base </span><br><span class="line">libmemcached.x86_64                                     1.0.16-5.el7       base </span><br><span class="line">libmemcached-devel.i686                                 1.0.16-5.el7       base </span><br><span class="line">libmemcached-devel.x86_64                               1.0.16-5.el7       base </span><br><span class="line">memcached-devel.i686                                    1.4.15-10.el7_3.1  base </span><br><span class="line">memcached-devel.x86_64                                  1.4.15-10.el7_3.1  base </span><br><span class="line">opensips-memcached.x86_64                               1.10.5-4.el7       epel </span><br><span class="line">perl-Cache-Memcached.noarch                             1.30-8.el7         epel </span><br><span class="line">php-ZendFramework-Cache-Backend-Libmemcached.noarch     1.12.20-1.el7      epel </span><br><span class="line">php-ZendFramework-Cache-Backend-Memcached.noarch        1.12.20-1.el7      epel </span><br><span class="line">php-pecl-memcached.x86_64                               2.2.0-1.el7        epel </span><br><span class="line">python-memcached.noarch                                 1.48-4.el7         base </span><br><span class="line">uwsgi-router-memcached.x86_64                           2.0.17.1-2.el7     epel</span><br></pre></td></tr></table></figure>

<p><strong>协议</strong> </p>
<p>查看/usr/share/doc/memcached-1.4.15/protocol.txt </p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ~]<span class="comment"># dnf info libmemcached</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># dnf repoquery -l libmemcached</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#测试memcached是否可访问</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># memping --servers=10.0.0.7</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># echo $?</span></span><br><span class="line">0</span><br><span class="line"></span><br><span class="line">[root@centos8 ~]<span class="comment"># memping --servers=10.0.0.77</span></span><br><span class="line">Failed to ping 10.0.0.77:11211 SYSTEM ERROR</span><br><span class="line"></span><br><span class="line"><span class="comment">#查看memcached状态</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># memstat --servers=10.0.0.101</span></span><br><span class="line">Server: 10.0.0.101 (11211)</span><br><span class="line">    pid: 25582</span><br><span class="line">    <span class="built_in">uptime</span>: 648</span><br><span class="line">    time: 1594801017</span><br><span class="line">    version: 1.5.9</span><br><span class="line">    libevent: 2.1.8-stable</span><br><span class="line">    pointer_size: 64</span><br><span class="line">    rusage_user: 0.051100</span><br><span class="line">    rusage_system: 0.079158</span><br><span class="line">    max_connections: 1024</span><br><span class="line">    curr_connections: 3</span><br><span class="line">    total_connections: 4</span><br><span class="line">    rejected_connections: 0</span><br><span class="line">    connection_structures: 4</span><br><span class="line">    reserved_fds: 20</span><br></pre></td></tr></table></figure>

<h3 id="memcached-操作命令"><a href="#memcached-操作命令" class="headerlink" title="memcached 操作命令"></a>memcached 操作命令</h3><p>帮助文档: </p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ~]<span class="comment"># cat /usr/share/doc/memcached/protocol.txt</span></span><br></pre></td></tr></table></figure>

<p>五种基本 memcached 命令执行最简单的操作。这些命令和操作包括： </p>
<ul>
<li>set</li>
<li>add</li>
<li>replace</li>
<li>get</li>
<li>delete</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#前三个命令是用于操作存储在 memcached 中的键值对的标准修改命令,都使用如下所示的语法：</span></span><br><span class="line"><span class="built_in">command</span> &lt;key&gt; &lt;flags&gt; &lt;expiration time&gt; &lt;bytes&gt;</span><br><span class="line">&lt;value&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#参数说明如下：</span></span><br><span class="line"><span class="built_in">command</span> <span class="built_in">set</span>/add/replace</span><br><span class="line">key                 key 用于查找缓存值</span><br><span class="line">flags               可以包括键值对的整型参数，客户机使用它存储关于键值对的额外信息</span><br><span class="line">expiration time     在缓存中保存键值对的时间长度（以秒为单位，0 表示永远）</span><br><span class="line">bytes               在缓存中存储的字节数</span><br><span class="line">value               存储的值（始终位于第二行）</span><br><span class="line"></span><br><span class="line"><span class="comment">#增加key，过期时间为秒，bytes为存储数据的字节数</span></span><br><span class="line">add key flags exptime bytes </span><br></pre></td></tr></table></figure>

<p>范例：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ~]<span class="comment"># systemctl start memcached</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># telnet localhost 11211</span></span><br><span class="line">Trying ::1...</span><br><span class="line">Connected to localhost.</span><br><span class="line">Escape character is <span class="string">&#x27;^]&#x27;</span>.</span><br><span class="line">stats</span><br><span class="line">STAT pid 27208</span><br><span class="line">STAT <span class="built_in">uptime</span> 242</span><br><span class="line">STAT time 1603035824</span><br><span class="line">STAT version 1.5.9</span><br><span class="line">STAT libevent 2.1.8-stable</span><br><span class="line">STAT pointer_size 64</span><br><span class="line">STAT rusage_user 0.004214</span><br><span class="line">STAT rusage_system 0.040611</span><br><span class="line">STAT max_connections 1024</span><br><span class="line">STAT curr_connections 2</span><br><span class="line">STAT total_connections 4</span><br><span class="line">STAT rejected_connections 0</span><br><span class="line">STAT connection_structures 3</span><br><span class="line">STAT reserved_fds 20</span><br><span class="line">······</span><br><span class="line">stats slabs <span class="comment">#用于显示各个slab的信息，包括chunk的大小、数目、使用情况等</span></span><br><span class="line">STAT 1:chunk_size 96</span><br><span class="line">STAT 1:chunks_per_page 10922</span><br><span class="line">STAT 1:total_pages 1</span><br><span class="line">STAT 1:total_chunks 10922</span><br><span class="line">STAT 1:used_chunks 1</span><br><span class="line">STAT 1:free_chunks 10921</span><br><span class="line">STAT 1:free_chunks_end 0</span><br><span class="line">STAT 1:mem_requested 67</span><br><span class="line">······</span><br><span class="line"></span><br><span class="line"><span class="comment">#加</span></span><br><span class="line">add mykey 1 60 4   </span><br><span class="line"><span class="built_in">test</span></span><br><span class="line">STORED</span><br><span class="line"></span><br><span class="line"><span class="comment">#查</span></span><br><span class="line">get mykey</span><br><span class="line">VALUE mykey 1 4</span><br><span class="line"><span class="built_in">test</span></span><br><span class="line">END</span><br><span class="line"></span><br><span class="line"><span class="comment">#改</span></span><br><span class="line"><span class="built_in">set</span> mykey 1 60 5</span><br><span class="line">test1</span><br><span class="line">STORED</span><br><span class="line">get mykey</span><br><span class="line">VALUE mykey 1 5</span><br><span class="line">test1</span><br><span class="line">END</span><br><span class="line"></span><br><span class="line"><span class="comment">#删除</span></span><br><span class="line">delete mykey</span><br><span class="line">DELETED</span><br><span class="line">get mykey</span><br><span class="line">END</span><br><span class="line"></span><br><span class="line"><span class="comment">#清空</span></span><br><span class="line">flush_all</span><br><span class="line">OK</span><br><span class="line">get mykey</span><br><span class="line">END</span><br><span class="line">quit </span><br></pre></td></tr></table></figure>

<p>范例: 非交互式取信息</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@rocky8 ~]<span class="comment">#echo -e &quot;stats\nquit&quot; | nc 10.0.0.28 11211 |awk &#x27;/curr_connections/&#123;print $NF&#125;&#x27;</span></span><br><span class="line">2</span><br></pre></td></tr></table></figure>

<h3 id="python-语言连接-memcached"><a href="#python-语言连接-memcached" class="headerlink" title="python 语言连接 memcached"></a>python 语言连接 memcached</h3><h4 id="范例-python3-测试代码"><a href="#范例-python3-测试代码" class="headerlink" title="范例: python3 测试代码"></a>范例: python3 测试代码</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ~]<span class="comment"># yum -y install python3 python3-memcached</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># cat m3.py </span></span><br><span class="line"><span class="comment">#!/usr/bin/python3</span></span><br><span class="line"><span class="comment">#coding:utf-8</span></span><br><span class="line">import memcache</span><br><span class="line">m = memcache.Client([<span class="string">&#x27;127.0.0.1:11211&#x27;</span>], debug=True)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(10):</span><br><span class="line">   m.set(<span class="string">&quot;key%d&quot;</span> % i,<span class="string">&quot;v%d&quot;</span> % i)</span><br><span class="line">   ret = m.get(<span class="string">&#x27;key%d&#x27;</span> % i)</span><br><span class="line">   <span class="built_in">print</span>(<span class="string">&quot;%s&quot;</span> % ret)</span><br><span class="line">   </span><br><span class="line">[root@centos8 ~]<span class="comment"># chmod +x m3.py</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># ./m3.py </span></span><br><span class="line">v0</span><br><span class="line">v1</span><br><span class="line">v2</span><br><span class="line">v3</span><br><span class="line">v4</span><br><span class="line">v5</span><br><span class="line">v6</span><br><span class="line">v7</span><br><span class="line">v8</span><br><span class="line">v9</span><br></pre></td></tr></table></figure>

<h4 id="范例-python2-测试代码"><a href="#范例-python2-测试代码" class="headerlink" title="范例: python2 测试代码"></a>范例: python2 测试代码</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">[root@centos7 ~]<span class="comment"># yum -y install python-memcached </span></span><br><span class="line">[root@centos7 ~]<span class="comment"># cat m2.py </span></span><br><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment">#coding:utf-8</span></span><br><span class="line">import memcache</span><br><span class="line">m = memcache.Client([<span class="string">&#x27;127.0.0.1:11211&#x27;</span>], debug=True)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(10):</span><br><span class="line">    m.set(<span class="string">&quot;key%d&quot;</span> % i,<span class="string">&quot;v%d&quot;</span> % i)</span><br><span class="line">    ret = m.get(<span class="string">&#x27;key%d&#x27;</span> % i)</span><br><span class="line">    <span class="built_in">print</span> ret</span><br><span class="line">    </span><br><span class="line">[root@centos7 ~]<span class="comment"># python m2.py</span></span><br><span class="line">v0</span><br><span class="line">v1</span><br><span class="line">v2</span><br><span class="line">v3</span><br><span class="line">v4</span><br><span class="line">v5</span><br><span class="line">v6</span><br><span class="line">v7</span><br><span class="line">v8</span><br><span class="line">v9</span><br><span class="line"></span><br><span class="line">[root@centos7 ~]<span class="comment"># telnet 127.0.0.1 11211</span></span><br><span class="line">Trying 127.0.0.1...</span><br><span class="line">Connected to 127.0.0.1.</span><br><span class="line">Escape character is <span class="string">&#x27;^]&#x27;</span>.</span><br><span class="line">get key1</span><br><span class="line">VALUE key1 0 2</span><br><span class="line">v1</span><br><span class="line">END</span><br><span class="line">get key9</span><br><span class="line">VALUE key9 0 2</span><br><span class="line">v9</span><br><span class="line">END</span><br><span class="line">get key10</span><br><span class="line">END</span><br><span class="line">quit</span><br><span class="line">Connection closed by foreign host.</span><br></pre></td></tr></table></figure>

<h1 id="Session-共享服务器"><a href="#Session-共享服务器" class="headerlink" title="Session 共享服务器"></a>Session 共享服务器</h1><h2 id="msm-介绍"><a href="#msm-介绍" class="headerlink" title="msm 介绍"></a>msm 介绍</h2><p>注意：当前MSM不支持 tomcat 10版本</p>
<p><img src="../../../../images/SRE/day33/99.jpg" alt="99"></p>
<p>msm（memcached session manager）提供将Tomcat的session保持到memcached或redis的程序，可以实现高可用。</p>
<p>项目早期托管在google code,目前在Github</p>
<p>github网站链接: <a target="_blank" rel="noopener" href="https://github.com/magro/memcached-session-manager">https://github.com/magro/memcached-session-manager</a></p>
<p><img src="../../../../images/SRE/day33/100.jpg" alt="100"></p>
<p>支持Tomcat的 6.x、7.x、8.x、9.x</p>
<ul>
<li>Tomcat的Session管理类，Tomcat版本不同<ul>
<li>memcached-session-manager-2.3.2.jar</li>
<li>memcached-session-manager-tc8-2.3.2.jar</li>
</ul>
</li>
<li>Session数据的序列化、反序列化类<ul>
<li>官方推荐kyro</li>
<li>在webapp中WEB-INF/lib/下</li>
</ul>
</li>
<li>驱动类<ul>
<li>memcached(spymemcached.jar)</li>
<li>Redis(jedis.jar)</li>
</ul>
</li>
</ul>
<h2 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h2><p>参考链接: <a target="_blank" rel="noopener" href="https://github.com/magro/memcached-session-manager/wiki/SetupAndConfiguration">https://github.com/magro/memcached-session-manager/wiki/SetupAndConfiguration</a></p>
<p>将spymemcached.jar、memcached-session-manage、kyro相关的jar文件都放到Tomcat的lib目录中去，这个目录是 $CATALINA_HOME/lib/ ，对应本次安装就是/usr/local/tomcat/lib。</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">kryo-3.0.3.jar</span><br><span class="line">asm-5.2.jar</span><br><span class="line">objenesis-2.6.jar</span><br><span class="line">reflectasm-1.11.9.jar</span><br><span class="line">minlog-1.3.1.jar</span><br><span class="line">kryo-serializers-0.45.jar</span><br><span class="line">msm-kryo-serializer-2.3.2.jar</span><br><span class="line">memcached-session-manager-tc8-2.3.2.jar</span><br><span class="line">spymemcached-2.12.3.jar</span><br><span class="line">memcached-session-manager-2.3.2.jar</span><br></pre></td></tr></table></figure>

<h2 id="sticky-模式"><a href="#sticky-模式" class="headerlink" title="sticky 模式"></a>sticky 模式</h2><h3 id="sticky-模式工作原理"><a href="#sticky-模式工作原理" class="headerlink" title="sticky 模式工作原理"></a>sticky 模式工作原理</h3><p>sticky 模式即前端tomcat和后端memcached有关联(粘性)关系</p>
<p>参考文档:<a target="_blank" rel="noopener" href="https://github.com/magro/memcached-session-manager/wiki/SetupAndConfiguration">https://github.com/magro/memcached-session-manager/wiki/SetupAndConfiguration</a></p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">Tomcat-1 (t1) will primarily store it&#x27;s sessions in memcached-2 (m2) which is </span><br><span class="line">running on another machine (m2 is a regular node for t1). Only if m2 is not </span><br><span class="line">available, t1 will store it&#x27;s sessions in memcached-1 (m1, m1 is the failoverNode </span><br><span class="line">for t1). With this configuration, sessions won&#x27;t be lost when machine 1 (serving </span><br><span class="line">t1 and m1) crashes. The following really nice ASCII art shows this setup.</span><br><span class="line">Tomcat-1（t1）主要将其会话存储在另一台计算机上运行的memcached-2（m2）中（m2是t1的常规节</span><br><span class="line">点）。 仅当m2不可用时，t1才会将其会话存储在memcached-1中（m1，m1是t1的failoverNode）。 使</span><br><span class="line">用此配置，当计算机1（服务于t1和m1）崩溃时，会话不会丢失。 以下非常好的ASCII艺术显示了此设置。</span><br><span class="line">&lt;t1&gt;   &lt;t2&gt;</span><br><span class="line"> . \ / .</span><br><span class="line">  . X .</span><br><span class="line"> . / \ .</span><br><span class="line">&lt;m1&gt;   &lt;m2&gt;</span><br></pre></td></tr></table></figure>

<p>t1和m1部署可以在一台主机上，t2和m2部署也可以在同一台。</p>
<p>当新用户发请求到Tomcat1时, Tomcat1生成session返回给用户的同时,也会同时发给memcached2备份。即Tomcat1 session为主session，memcached2 session为备用session，使用memcached相当于备份了一份Session</p>
<p>如果Tomcat1发现memcached2 失败,无法备份Session到memcached2,则将Sessoin备份存放在memcached1中</p>
<h3 id="配置过程"><a href="#配置过程" class="headerlink" title="配置过程"></a>配置过程</h3><h4 id="下载相关jar包"><a href="#下载相关jar包" class="headerlink" title="下载相关jar包"></a>下载相关jar包</h4><p>下载相关jar包,参考下面官方说明的下载链接</p>
<p><a target="_blank" rel="noopener" href="https://github.com/magro/memcached-session-manager/wiki/SetupAndConfiguration">https://github.com/magro/memcached-session-manager/wiki/SetupAndConfiguration</a></p>
<p><strong>tomcat和memcached相关包</strong></p>
<p><img src="../../../../images/SRE/day33/101.jpg" alt="101"></p>
<p><strong>序列化相关下载</strong></p>
<p><img src="../../../../images/SRE/day33/102.jpg" alt="102"></p>
<h4 id="修改tomcat配置"><a href="#修改tomcat配置" class="headerlink" title="修改tomcat配置"></a>修改tomcat配置</h4><p>修改 <code>$CATALINA_HOME/conf/context.xml</code></p>
<p>特别注意，t1配置中为<code>failoverNodes=&quot;n1&quot;</code>， t2配置为<code>failoverNodes=&quot;n2&quot;</code></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">#以下是sticky的配置</span><br><span class="line"><span class="tag">&lt;<span class="name">Context</span>&gt;</span></span><br><span class="line"> ...</span><br><span class="line">  <span class="tag">&lt;<span class="name">Manager</span> <span class="attr">className</span>=<span class="string">&quot;de.javakaffee.web.msm.MemcachedBackupSessionManager&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">memcachedNodes</span>=<span class="string">&quot;n1:10.0.0.101:11211,n2:10.0.0.102:11211&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">failoverNodes</span>=<span class="string">&quot;n1&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">requestUriIgnorePattern</span>=<span class="string">&quot;.*\.(ico|png|gif|jpg|css|js)$&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">transcoderFactoryClass</span>=<span class="string">&quot;de.javakaffee.web.msm.serializer.kryo.KryoTranscoderFactory&quot;</span></span></span><br><span class="line"><span class="tag">    /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">Context</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><strong>配置说明</strong></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">memcachedNodes=<span class="string">&quot;n1:host1.yourdomain.com:11211,n2:host2.yourdomain.com:11211&quot;</span></span><br><span class="line"></span><br><span class="line">memcached的节点: n1、n2只是别名，可以重新命名。</span><br><span class="line">failoverNodes 为故障转移节点，n1是备用节点，n2是主存储节点。另一台Tomcat将此处的n1改为n2，其主节点是n1，备用节点是n2。</span><br></pre></td></tr></table></figure>

<p>如果配置成功，可以在logs/catalina.out中看到下面的内容</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">12-APR-2020 16:24:08.975 INFO [t1.magedu.com-startStop-1] </span><br><span class="line">de.javakaffee.web.msm.MemcachedSessionService.startInternal --------</span><br><span class="line">- finished initialization:</span><br><span class="line">- sticky: <span class="literal">true</span></span><br><span class="line">- operation <span class="built_in">timeout</span>: 1000</span><br><span class="line">- node ids: [n2]</span><br><span class="line">- failover node ids: [n1]</span><br><span class="line">- storage key prefix: null</span><br><span class="line">- locking mode: null (expiration: 5s)</span><br></pre></td></tr></table></figure>

<p>配置成功后，网页访问以下，页面中看到了Session。然后运行下面的Python程序，就可以看到是否存储到了memcached中了。</p>
<h4 id="准备测试msm的python脚本"><a href="#准备测试msm的python脚本" class="headerlink" title="准备测试msm的python脚本"></a>准备测试msm的python脚本</h4><p>范例：安装python环境准备python程序查看memcached中的SessionID</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ~]<span class="comment"># yum -y install python3 python3-memcached</span></span><br><span class="line"><span class="comment">#或者执行下面两步</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># dnf install python3 -y</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># pip3 install python-memcached</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#脚本内容</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># cat showmemcached.py </span></span><br><span class="line"><span class="comment">#!/usr/bin/python3</span></span><br><span class="line">import memcache</span><br><span class="line"></span><br><span class="line">mc = memcache.Client([<span class="string">&#x27;10.0.0.101:11211&#x27;</span>], debug=True)</span><br><span class="line"></span><br><span class="line">stats = mc.get_stats()[0]</span><br><span class="line"><span class="built_in">print</span>(stats)</span><br><span class="line"><span class="keyword">for</span> k,v <span class="keyword">in</span> stats[1].items():</span><br><span class="line">    <span class="built_in">print</span>(k, v)</span><br><span class="line">    </span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;-&#x27;</span> * 30)</span><br><span class="line"><span class="comment"># 查看全部key</span></span><br><span class="line"><span class="built_in">print</span>(mc.get_stats(<span class="string">&#x27;items&#x27;</span>)) <span class="comment"># stats items 返回 items:5:number 1</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;-&#x27;</span> * 30)</span><br><span class="line"><span class="built_in">print</span>(mc.get_stats(<span class="string">&#x27;cachedump 5 0&#x27;</span>)) <span class="comment"># stats cachedump 5 0 # 5和上面的items返回的值有关；0表示全部</span></span><br></pre></td></tr></table></figure>

<p>t1、t2、n1、n2依次启动成功，分别使用<a target="_blank" rel="noopener" href="http://t1.magedu.org:8080/">http://t1.magedu.org:8080/</a> 和<a target="_blank" rel="noopener" href="http://t2.magedu.org:8080/%E8%A7%82%E5%AF%9F%E3%80%82">http://t2.magedu.org:8080/观察。</a></p>
<p>开启负载均衡调度器，通过<a target="_blank" rel="noopener" href="http://proxy.magedu.com来访问看看效果/">http://proxy.magedu.com来访问看看效果</a></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">On tomcats</span><br><span class="line">10.0.0.102:8080</span><br><span class="line">SessionID = 2A19B1EB6D9649C9FED3E7277FDFD470-n2.Tomcat1</span><br><span class="line">Wed Jun 26 16:32:11 CST 2019</span><br><span class="line"></span><br><span class="line">On tomcats</span><br><span class="line">10.0.0.101:8080</span><br><span class="line">SessionID = 2A19B1EB6D9649C9FED3E7277FDFD470-n1.Tomcat2</span><br><span class="line">Wed Jun 26 16:32:36 CST 2019</span><br></pre></td></tr></table></figure>

<p>可以看到浏览器端被调度到不同Tomcat上，但是都获得了同样的SessionID。 </p>
<p>停止t2、n2看看效果，恢复看看效果。</p>
<p>范例：访问tomcat，查看memcached中SessionID信息</p>
<p><img src="../../../../images/SRE/day33/103.jpg" alt="103"></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ~]<span class="comment"># python3 showmemcached.py </span></span><br><span class="line">.....</span><br><span class="line">[(<span class="string">&#x27;10.0.0.48:11211 (1)&#x27;</span>, &#123;<span class="string">&#x27;8D0B801640CA0B1EB9AD4A4C221EA81A-n2.Tomcat1&#x27;</span>: <span class="string">&#x27;[97 b; 1581598952 s]&#x27;</span>&#125;)]</span><br><span class="line"><span class="comment">#以上结果表示SessionID来自于memcached的n2节点，但是最终是由tomcat1返回的SessionID</span></span><br></pre></td></tr></table></figure>

<h3 id="实战案例-1-tomcat和memcached集成在一台主机"><a href="#实战案例-1-tomcat和memcached集成在一台主机" class="headerlink" title="实战案例 1 : tomcat和memcached集成在一台主机"></a>实战案例 1 : tomcat和memcached集成在一台主机</h3><p><img src="../../../../images/SRE/day33/104.jpg" alt="104"></p>
<p>环境准备：</p>
<ul>
<li>时间同步，确保NTP或Chrony服务正常运行。</li>
<li>防火墙规则</li>
<li>禁用SELinux</li>
<li>三台主机</li>
</ul>
<table>
<thead>
<tr>
<th>ip</th>
<th>主机名</th>
<th>服务</th>
<th>软件</th>
</tr>
</thead>
<tbody><tr>
<td>10.0.0.100</td>
<td>proxy</td>
<td>调度器</td>
<td>CentOS8、Nginx、HTTPD</td>
</tr>
<tr>
<td>10.0.0.101</td>
<td>t1</td>
<td>tomcat1</td>
<td>CentOS8、JDK8、Tomcat8、memcached</td>
</tr>
<tr>
<td>10.0.0.102</td>
<td>t2</td>
<td>tomcat2</td>
<td>CentOS8、JDK8、Tomcat8、memcached</td>
</tr>
</tbody></table>
<h4 id="配置nginx充当proxy"><a href="#配置nginx充当proxy" class="headerlink" title="配置nginx充当proxy"></a>配置nginx充当proxy</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">[root@proxy ~]<span class="comment"># cat /etc/nginx/nginx.conf</span></span><br><span class="line">http &#123;</span><br><span class="line">......</span><br><span class="line"> upstream tomcat-server &#123;</span><br><span class="line">        <span class="comment">#ip_hash; </span></span><br><span class="line">       server t1.magedu.org:8080;</span><br><span class="line">       server t2.magedu.org:8080;</span><br><span class="line"> &#125;</span><br><span class="line">   server &#123;</span><br><span class="line"> ......</span><br><span class="line">       location / &#123;</span><br><span class="line">       &#125;</span><br><span class="line">       location ~* \.(jsp|<span class="keyword">do</span>)$ &#123;</span><br><span class="line">         proxy_pass http://tomcat-server;</span><br><span class="line">         <span class="comment">#proxy_set_header Host $http_host; #转发主机头至后端服务器</span></span><br><span class="line">       &#125;</span><br><span class="line">       </span><br><span class="line">[root@proxy ~]<span class="comment"># cat /etc/hosts</span></span><br><span class="line">10.0.0.100 proxy.magedu.org proxy</span><br><span class="line">10.0.0.101 t1.magedu.org t1</span><br><span class="line">10.0.0.102 t2.magedu.org t2</span><br></pre></td></tr></table></figure>

<h4 id="配置memcached"><a href="#配置memcached" class="headerlink" title="配置memcached"></a>配置memcached</h4><h5 id="在-tomcat1-上配置-memcached"><a href="#在-tomcat1-上配置-memcached" class="headerlink" title="在 tomcat1 上配置 memcached"></a>在 tomcat1 上配置 memcached</h5><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root@t1 ~]<span class="comment"># dnf -y install memcached </span></span><br><span class="line">[root@t1 ~]<span class="comment"># vim /etc/sysconfig/memcached </span></span><br><span class="line">[root@t1 ~]<span class="comment"># cat /etc/sysconfig/memcached </span></span><br><span class="line">PORT=<span class="string">&quot;11211&quot;</span></span><br><span class="line">USER=<span class="string">&quot;memcached&quot;</span></span><br><span class="line">MAXCONN=<span class="string">&quot;1024&quot;</span></span><br><span class="line">CACHESIZE=<span class="string">&quot;64&quot;</span></span><br><span class="line"><span class="comment">#注释下面行</span></span><br><span class="line"><span class="comment">#OPTIONS=&quot;-l 127.0.0.1,::1&quot; </span></span><br><span class="line"></span><br><span class="line">[root@t1 ~]<span class="comment"># systemctl enable --now memcached.service </span></span><br></pre></td></tr></table></figure>

<h5 id="在-tomcat2-上配置-memcached"><a href="#在-tomcat2-上配置-memcached" class="headerlink" title="在 tomcat2 上配置 memcached"></a>在 tomcat2 上配置 memcached</h5><p>配置和t1相同</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root@t2 ~]<span class="comment"># dnf -y install memcached </span></span><br><span class="line">[root@t2 ~]<span class="comment"># vim /etc/sysconfig/memcached </span></span><br><span class="line">[root@t2 ~]<span class="comment"># cat /etc/sysconfig/memcached </span></span><br><span class="line">PORT=<span class="string">&quot;11211&quot;</span></span><br><span class="line">USER=<span class="string">&quot;memcached&quot;</span></span><br><span class="line">MAXCONN=<span class="string">&quot;1024&quot;</span></span><br><span class="line">CACHESIZE=<span class="string">&quot;64&quot;</span></span><br><span class="line"><span class="comment">#注释下面行</span></span><br><span class="line"><span class="comment">#OPTIONS=&quot;-l 127.0.0.1,::1&quot;</span></span><br><span class="line"></span><br><span class="line">[root@t2 ~]<span class="comment"># systemctl enable --now memcached.service </span></span><br></pre></td></tr></table></figure>

<h4 id="配置-tomcat"><a href="#配置-tomcat" class="headerlink" title="配置 tomcat"></a>配置 tomcat</h4><h5 id="配置-tomcat1"><a href="#配置-tomcat1" class="headerlink" title="配置 tomcat1"></a>配置 tomcat1</h5><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line">[root@t1 tomcat]<span class="comment"># vim conf/server.xml</span></span><br><span class="line"> &lt;Engine name=<span class="string">&quot;Catalina&quot;</span> defaultHost=<span class="string">&quot;t1.magedu.org&quot;</span> jvmRoute=<span class="string">&quot;Tomcat1&quot;</span>&gt;  </span><br><span class="line"> ......</span><br><span class="line">       &lt;Host name=<span class="string">&quot;t1.magedu.org&quot;</span> appBase=<span class="string">&quot;/data/webapps&quot;</span> autoDeploy=<span class="string">&quot;true&quot;</span> &gt; </span><br><span class="line">     &lt;/Host&gt;  </span><br><span class="line">   &lt;/Engine&gt;</span><br><span class="line"> &lt;/Service&gt;</span><br><span class="line">&lt;/Server&gt;</span><br><span class="line"></span><br><span class="line">[root@t1 tomcat]<span class="comment"># vim conf/context.xml</span></span><br><span class="line">&lt;Context&gt;</span><br><span class="line">......</span><br><span class="line">   &lt;Manager pathname=<span class="string">&quot;&quot;</span> /&gt;</span><br><span class="line">    --&gt;</span><br><span class="line"><span class="comment">###倒数第一行前,即&lt;/Context&gt;行的前面,加下面内容</span></span><br><span class="line"> &lt;Manager className=<span class="string">&quot;de.javakaffee.web.msm.MemcachedBackupSessionManager&quot;</span></span><br><span class="line">    memcachedNodes=<span class="string">&quot;n1:10.0.0.101:11211,n2:10.0.0.102:11211&quot;</span>                     </span><br><span class="line">    failoverNodes=<span class="string">&quot;n1&quot;</span></span><br><span class="line">    requestUriIgnorePattern=<span class="string">&quot;.*\.(ico|png|gif|jpg|css|js)$&quot;</span></span><br><span class="line">    </span><br><span class="line">    transcoderFactoryClass=<span class="string">&quot;de.javakaffee.web.msm.serializer.kryo.KryoTranscoderFactory&quot;</span></span><br><span class="line">   /&gt;</span><br><span class="line">&lt;/Context&gt;  <span class="comment">#最后一行</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#将相关包传到lib/目录下,共10个文件</span></span><br><span class="line">asm-5.2.jar</span><br><span class="line">kryo-3.0.3.jar</span><br><span class="line">kryo-serializers-0.45.jar</span><br><span class="line">memcached-session-manager-2.3.2.jar</span><br><span class="line">memcached-session-manager-tc8-2.3.2.jar</span><br><span class="line">minlog-1.3.1.jar</span><br><span class="line">msm-kryo-serializer-2.3.2.jar</span><br><span class="line">objenesis-2.6.jar</span><br><span class="line">reflectasm-1.11.9.jar</span><br><span class="line">spymemcached-2.12.3.jar</span><br><span class="line"></span><br><span class="line">[root@t1 tomcat]<span class="comment"># ls lib/ -t |tail </span></span><br><span class="line">kryo-3.0.3.jar</span><br><span class="line">asm-5.2.jar</span><br><span class="line">objenesis-2.6.jar</span><br><span class="line">reflectasm-1.11.9.jar</span><br><span class="line">minlog-1.3.1.jar</span><br><span class="line">kryo-serializers-0.45.jar</span><br><span class="line">msm-kryo-serializer-2.3.2.jar</span><br><span class="line">memcached-session-manager-tc8-2.3.2.jar</span><br><span class="line">spymemcached-2.12.3.jar</span><br><span class="line">memcached-session-manager-2.3.2.jar</span><br><span class="line"></span><br><span class="line">[root@t1 tomcat]<span class="comment"># systemctl restart tomcat</span></span><br><span class="line">[root@t1 tomcat]<span class="comment"># cat /data/webapps/ROOT/index.jsp </span></span><br><span class="line">&lt;%@ page import=<span class="string">&quot;java.util.*&quot;</span> %&gt;</span><br><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html lang=<span class="string">&quot;en&quot;</span>&gt;</span><br><span class="line">&lt;<span class="built_in">head</span>&gt;</span><br><span class="line">   &lt;meta charset=<span class="string">&quot;UTF-8&quot;</span>&gt;</span><br><span class="line">   &lt;title&gt;tomcat <span class="built_in">test</span>&lt;/title&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">&lt;h1&gt; tomcat website &lt;/h1&gt;</span><br><span class="line">&lt;div&gt;On &lt;%=request.getServerName() %&gt;&lt;/div&gt;</span><br><span class="line">&lt;div&gt;&lt;%=request.getLocalAddr() + <span class="string">&quot;:&quot;</span> + request.getLocalPort() %&gt;&lt;/div&gt;</span><br><span class="line">&lt;div&gt;SessionID = &lt;span style=<span class="string">&quot;color:blue&quot;</span>&gt;&lt;%=session.getId() %&gt;&lt;/span&gt;&lt;/div&gt;</span><br><span class="line">&lt;%=new Date()%&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure>

<h5 id="配置-tomcat2"><a href="#配置-tomcat2" class="headerlink" title="配置 tomcat2"></a>配置 tomcat2</h5><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#t2参考上面t1做配置</span></span><br><span class="line">[root@t2 tomcat]<span class="comment"># vim conf/server.xml</span></span><br><span class="line"> &lt;Engine name=<span class="string">&quot;Catalina&quot;</span> defaultHost=<span class="string">&quot;t2.magedu.org&quot;</span> jvmRoute=<span class="string">&quot;Tomcat2&quot;</span>&gt;  </span><br><span class="line"> ......</span><br><span class="line">     &lt;Host name=<span class="string">&quot;t2.magedu.org&quot;</span> appBase=<span class="string">&quot;/data/webapps&quot;</span> autoDeploy=<span class="string">&quot;true&quot;</span> &gt; </span><br><span class="line">     &lt;/Host&gt;  </span><br><span class="line">   &lt;/Engine&gt;</span><br><span class="line"> &lt;/Service&gt;</span><br><span class="line">&lt;/Server&gt;</span><br><span class="line"></span><br><span class="line">[root@t2 tomcat]<span class="comment"># vim conf/context.xml</span></span><br><span class="line">&lt;Context&gt;</span><br><span class="line">......</span><br><span class="line">   &lt;Manager pathname=<span class="string">&quot;&quot;</span> /&gt;</span><br><span class="line">    --&gt;</span><br><span class="line"><span class="comment">####################加下面内容################</span></span><br><span class="line"> &lt;Manager className=<span class="string">&quot;de.javakaffee.web.msm.MemcachedBackupSessionManager&quot;</span></span><br><span class="line">    memcachedNodes=<span class="string">&quot;n1:10.0.0.101:11211,n2:10.0.0.102:11211&quot;</span></span><br><span class="line">    failoverNodes=<span class="string">&quot;n2&quot;</span>  <span class="comment">#只修改此行,和t1不同,其它都一样</span></span><br><span class="line">    requestUriIgnorePattern=<span class="string">&quot;.*\.(ico|png|gif|jpg|css|js)$&quot;</span></span><br><span class="line">    </span><br><span class="line">   transcoderFactoryClass=<span class="string">&quot;de.javakaffee.web.msm.serializer.kryo.KryoTranscoderFactory&quot;</span></span><br><span class="line">   /&gt;</span><br><span class="line"><span class="comment">####################加上面内容################</span></span><br><span class="line">&lt;/Context&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment">#将相关包传到lib/目录下</span></span><br><span class="line">asm-5.2.jar</span><br><span class="line">kryo-3.0.3.jar</span><br><span class="line">kryo-serializers-0.45.jar</span><br><span class="line">memcached-session-manager-2.3.2.jar</span><br><span class="line">memcached-session-manager-tc8-2.3.2.jar</span><br><span class="line">minlog-1.3.1.jar</span><br><span class="line">msm-kryo-serializer-2.3.2.jar</span><br><span class="line">objenesis-2.6.jar</span><br><span class="line">reflectasm-1.11.9.jar</span><br><span class="line">spymemcached-2.12.3.jar</span><br><span class="line"></span><br><span class="line">[root@t2 tomcat]<span class="comment"># ls lib/ -t |tail </span></span><br><span class="line">kryo-3.0.3.jar</span><br><span class="line">asm-5.2.jar</span><br><span class="line">objenesis-2.6.jar</span><br><span class="line">reflectasm-1.11.9.jar</span><br><span class="line">minlog-1.3.1.jar</span><br><span class="line">kryo-serializers-0.45.jar</span><br><span class="line">msm-kryo-serializer-2.3.2.jar</span><br><span class="line">memcached-session-manager-tc8-2.3.2.jar</span><br><span class="line">spymemcached-2.12.3.jar</span><br><span class="line">memcached-session-manager-2.3.2.jar</span><br><span class="line"></span><br><span class="line">[root@t2 tomcat]<span class="comment"># systemctl restart tomcat</span></span><br><span class="line">[root@t2 tomcat]<span class="comment"># cat /data/webapps/ROOT/index.jsp </span></span><br><span class="line">&lt;%@ page import=<span class="string">&quot;java.util.*&quot;</span> %&gt;</span><br><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html lang=<span class="string">&quot;en&quot;</span>&gt;</span><br><span class="line">&lt;<span class="built_in">head</span>&gt;</span><br><span class="line">   &lt;meta charset=<span class="string">&quot;UTF-8&quot;</span>&gt;</span><br><span class="line">   &lt;title&gt;tomcat <span class="built_in">test</span>&lt;/title&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">&lt;h1&gt; tomcat website &lt;/h1&gt;</span><br><span class="line">&lt;div&gt;On &lt;%=request.getServerName() %&gt;&lt;/div&gt;</span><br><span class="line">&lt;div&gt;&lt;%=request.getLocalAddr() + <span class="string">&quot;:&quot;</span> + request.getLocalPort() %&gt;&lt;/div&gt;</span><br><span class="line">&lt;div&gt;SessionID = &lt;span style=<span class="string">&quot;color:blue&quot;</span>&gt;&lt;%=session.getId() %&gt;&lt;/span&gt;&lt;/div&gt;</span><br><span class="line">&lt;%=new Date()%&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure>

<h5 id="查看tomcat日志"><a href="#查看tomcat日志" class="headerlink" title="查看tomcat日志"></a>查看tomcat日志</h5><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">[root@t1 tomcat]<span class="comment"># tail -n 20 logs/catalina.out</span></span><br><span class="line">2020-07-13 09:00:28.580 INFO net.spy.memcached.MemcachedConnection: Setting retryQueueSize to -1</span><br><span class="line">2020-07-13 09:00:28.581 INFO net.spy.memcached.MemcachedConnection: Added &#123;QA sa=/10.0.0.101:11211, <span class="comment">#Rops=0, #Wops=0, #iq=0, topRop=null, topWop=null, toWrite=0, interested=0&#125; to connect queue</span></span><br><span class="line">2020-07-13 09:00:28.581 INFO net.spy.memcached.MemcachedConnection: Added &#123;QA sa=/10.0.0.102:11211, <span class="comment">#Rops=0, #Wops=0, #iq=0, topRop=null, topWop=null, toWrite=0, interested=0&#125; to connect queue</span></span><br><span class="line">13-Jul-2020 09:00:28.582 INFO [t1.magedu.org-startStop-1] de.javakaffee.web.msm.RequestTrackingHostValve.&lt;init&gt; Setting ignorePattern to .*\.(ico|png|gif|jpg|css|js)$</span><br><span class="line">13-Jul-2020 09:00:28.582 INFO [t1.magedu.org-startStop-1] de.javakaffee.web.msm.MemcachedSessionService.setLockingMode Setting lockingMode to null</span><br><span class="line">13-Jul-2020 09:00:28.582 INFO [t1.magedu.org-startStop-1] de.javakaffee.web.msm.MemcachedSessionService.createTranscoderFactory Creating transcoder factory de.javakaffee.web.msm.serializer.kryo.KryoTranscoderFactory</span><br><span class="line">13-Jul-2020 09:00:28.583 INFO [t1.magedu.org-startStop-1] de.javakaffee.web.msm.serializer.kryo.KryoTranscoder.&lt;init&gt; Starting with initialBufferSize 102400, maxBufferSize 2048000 and defaultSerializerFactory de.javakaffee.web.msm.serializer.kryo.DefaultFieldSerializerFactory</span><br><span class="line">13-Jul-2020 09:00:28.583 INFO [t1.magedu.org-startStop-1] de.javakaffee.web.msm.MemcachedSessionService.startInternal --------</span><br><span class="line">- finished initialization:</span><br><span class="line">- sticky: <span class="literal">true</span></span><br><span class="line">- operation <span class="built_in">timeout</span>: 1000</span><br><span class="line">- node ids: [n2]</span><br><span class="line">- failover node ids: [n1]</span><br><span class="line">- storage key prefix: null</span><br><span class="line">- locking mode: null (expiration: 5s)</span><br><span class="line">--------</span><br><span class="line">13-Jul-2020 09:00:28.587 INFO [t1.magedu.org-startStop-1] org.apache.catalina.startup.HostConfig.deployDirectory Deployment of web application directory [/data/webapps/ROOT] has finished <span class="keyword">in</span> [160] ms</span><br><span class="line">13-Jul-2020 09:00:28.596 INFO [main] org.apache.coyote.AbstractProtocol.start Starting ProtocolHandler [<span class="string">&quot;http-nio-8080&quot;</span>]</span><br><span class="line">13-Jul-2020 09:00:28.619 INFO [main] org.apache.coyote.AbstractProtocol.start Starting ProtocolHandler [<span class="string">&quot;ajp-nio-0.0.0.0-8009&quot;</span>]</span><br><span class="line">13-Jul-2020 09:00:28.621 INFO [main] org.apache.catalina.startup.Catalina.start Server startup <span class="keyword">in</span> 2097 ms</span><br></pre></td></tr></table></figure>

<h4 id="python测试脚本"><a href="#python测试脚本" class="headerlink" title="python测试脚本"></a>python测试脚本</h4><p>在t1 上安装部署python3环境,访问memcached</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">[root@t1 ~]<span class="comment"># dnf -y install python3 python3-memcached</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#或者下面方式也可以安装</span></span><br><span class="line">[root@t1 ~]<span class="comment"># dnf -y install python3</span></span><br><span class="line">[root@t1 ~]<span class="comment"># pip3 install python-memcached</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#准备python测试脚本</span></span><br><span class="line">[root@t1 ~]<span class="comment"># cat showmemcached.py </span></span><br><span class="line"><span class="comment">#!/usr/bin/python3</span></span><br><span class="line">import memcache</span><br><span class="line">mc = memcache.Client([<span class="string">&#x27;10.0.0.101:11211&#x27;</span>,<span class="string">&#x27;10.0.0.102:11211&#x27;</span>], debug=True)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;-&#x27;</span> * 30)</span><br><span class="line"></span><br><span class="line"><span class="comment">#查看全部 key</span></span><br><span class="line"><span class="comment">#for x in mc.get_stats(&#x27;items&#x27;): # stats items 返回 items:5:number 1</span></span><br><span class="line"><span class="comment">#   print(x)</span></span><br><span class="line"><span class="comment">#print(&#x27;-&#x27; * 30)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> x <span class="keyword">in</span> mc.get_stats(<span class="string">&#x27;cachedump 5 0&#x27;</span>):  <span class="comment"># stats cachedump 5 0 # 5和上面的items返回的值有关；0表示全部</span></span><br><span class="line">   <span class="built_in">print</span>(x)</span><br><span class="line">   </span><br><span class="line">[root@t1 ~]<span class="comment"># chmod +x showmemcached.py</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#运行python脚本</span></span><br><span class="line">[root@t1 ~]<span class="comment"># ./showmemcached.py</span></span><br><span class="line">(<span class="string">&#x27;10.0.0.101:11211 (1)&#x27;</span>, &#123;&#125;)</span><br><span class="line">(<span class="string">&#x27;10.0.0.102:11211 (1)&#x27;</span>, &#123;&#125;)</span><br></pre></td></tr></table></figure>

<h4 id="浏览器访问"><a href="#浏览器访问" class="headerlink" title="浏览器访问"></a>浏览器访问</h4><p>第一次刷新页面,可以看到下面显示</p>
<p><img src="../../../../images/SRE/day33/105.jpg" alt="105"></p>
<p>第一次运行脚本查看结果</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@t1 ~]<span class="comment"># ./showmemcached.py </span></span><br><span class="line">------------------------------</span><br><span class="line">(<span class="string">&#x27;10.0.0.101:11211 (1)&#x27;</span>, &#123;&#125;)</span><br><span class="line">(<span class="string">&#x27;10.0.0.102:11211 (1)&#x27;</span>, &#123;<span class="string">&#x27;3B4E6FB0934692150DD9944845830FCC-n2.Tomcat1&#x27;</span>: <span class="string">&#x27;[97 b; 1603970381 s]&#x27;</span>&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">#只有10.0.0.102上有信息,说明SessionID是由Tomcat1生成,并备份到n2,即t2上面的memcached</span></span><br></pre></td></tr></table></figure>

<p>第二次刷新页面后,运行脚本可以查看到下面显示</p>
<p><img src="../../../../images/SRE/day33/106.jpg" alt="106"></p>
<p>第二次执行脚本</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@t1 ~]<span class="comment"># ./showmemcached.py </span></span><br><span class="line">------------------------------</span><br><span class="line">(<span class="string">&#x27;10.0.0.101:11211 (1)&#x27;</span>, &#123;<span class="string">&#x27;3B4E6FB0934692150DD9944845830FCC-n1.Tomcat2&#x27;</span>: <span class="string">&#x27;[97 b; 1603970442 s]&#x27;</span>&#125;)</span><br><span class="line">(<span class="string">&#x27;10.0.0.102:11211 (1)&#x27;</span>, &#123;&#125;)</span><br></pre></td></tr></table></figure>

<p>第三次刷新页面</p>
<p><img src="../../../../images/SRE/day33/107.jpg" alt="107"></p>
<p>第三次执行脚本</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@t1 ~]<span class="comment">#./showmemcached.py </span></span><br><span class="line">------------------------------</span><br><span class="line">(<span class="string">&#x27;10.0.0.101:11211 (1)&#x27;</span>, &#123;<span class="string">&#x27;3B4E6FB0934692150DD9944845830FCC-n1.Tomcat2&#x27;</span>: <span class="string">&#x27;[97 b; 1603970442 s]&#x27;</span>&#125;)</span><br><span class="line">(<span class="string">&#x27;10.0.0.102:11211 (1)&#x27;</span>, &#123;<span class="string">&#x27;3B4E6FB0934692150DD9944845830FCC-n2.Tomcat1&#x27;</span>: <span class="string">&#x27;[97 b; 1603970381 s]&#x27;</span>&#125;)</span><br></pre></td></tr></table></figure>

<p>第四次刷新页面</p>
<p><img src="../../../../images/SRE/day33/108.jpg" alt="108"></p>
<p>第四次执行脚本</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@t1 ~]<span class="comment">#./showmemcached.py </span></span><br><span class="line">------------------------------</span><br><span class="line">(<span class="string">&#x27;10.0.0.101:11211 (1)&#x27;</span>, &#123;<span class="string">&#x27;3B4E6FB0934692150DD9944845830FCC-n1.Tomcat2&#x27;</span>: <span class="string">&#x27;[97 b; 1603970442 s]&#x27;</span>&#125;)</span><br><span class="line">(<span class="string">&#x27;10.0.0.102:11211 (1)&#x27;</span>, &#123;<span class="string">&#x27;3B4E6FB0934692150DD9944845830FCC-n2.Tomcat1&#x27;</span>: <span class="string">&#x27;[97 b; 1603970381 s]&#x27;</span>&#125;)</span><br></pre></td></tr></table></figure>

<p>之后多次刷新页面,执行脚本后,session信息不在变化</p>
<h4 id="故障访问"><a href="#故障访问" class="headerlink" title="故障访问"></a>故障访问</h4><h5 id="模拟tomcat故障"><a href="#模拟tomcat故障" class="headerlink" title="模拟tomcat故障"></a>模拟tomcat故障</h5><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@t2 ~]# systemctl stop tomcat</span><br></pre></td></tr></table></figure>

<p>刷新几次页面,看到下面SessionID显示不变</p>
<p><img src="../../../../images/SRE/day33/109.jpg" alt="109"></p>
<p>运行脚本看到下面结果</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[root@t1 ~]<span class="comment"># ./showmemcached.py</span></span><br><span class="line">------------------------------</span><br><span class="line">(<span class="string">&#x27;10.0.0.101:11211 (1)&#x27;</span>, &#123;<span class="string">&#x27;items:5:number&#x27;</span>: <span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;items:5:number_hot&#x27;</span>: <span class="string">&#x27;0&#x27;</span>, </span><br><span class="line"><span class="string">&#x27;items:5:number_warm&#x27;</span>: <span class="string">&#x27;0&#x27;</span>, <span class="string">&#x27;items:5:number_cold&#x27;</span>: <span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;items:5:age_hot&#x27;</span>: <span class="string">&#x27;0&#x27;</span>, </span><br><span class="line"><span class="string">&#x27;items:5:age_warm&#x27;</span>: <span class="string">&#x27;0&#x27;</span>, <span class="string">&#x27;items:5:age&#x27;</span>: <span class="string">&#x27;1531&#x27;</span>, <span class="string">&#x27;items:5:evicted&#x27;</span>: <span class="string">&#x27;0&#x27;</span>, </span><br><span class="line"><span class="string">&#x27;items:5:evicted_nonzero&#x27;</span>: <span class="string">&#x27;0&#x27;</span>, <span class="string">&#x27;items:5:evicted_time&#x27;</span>: <span class="string">&#x27;0&#x27;</span>, <span class="string">&#x27;items:5:outofmemory&#x27;</span>: <span class="string">&#x27;0&#x27;</span>,</span><br><span class="line"><span class="string">&#x27;items:5:tailrepairs&#x27;</span>: <span class="string">&#x27;0&#x27;</span>, <span class="string">&#x27;items:5:reclaimed&#x27;</span>: <span class="string">&#x27;0&#x27;</span>, <span class="string">&#x27;items:5:expired_unfetched&#x27;</span>: <span class="string">&#x27;0&#x27;</span>,</span><br><span class="line"><span class="string">&#x27;items:5:evicted_unfetched&#x27;</span>: <span class="string">&#x27;0&#x27;</span>, <span class="string">&#x27;items:5:evicted_active&#x27;</span>: <span class="string">&#x27;0&#x27;</span>, <span class="string">&#x27;items:5:crawler_reclaimed&#x27;</span>: <span class="string">&#x27;0&#x27;</span>,</span><br><span class="line"><span class="string">&#x27;items:5:crawler_items_checked&#x27;</span>: <span class="string">&#x27;9&#x27;</span>, <span class="string">&#x27;items:5:lrutail_reflocked&#x27;</span>: <span class="string">&#x27;0&#x27;</span>, <span class="string">&#x27;items:5:moves_to_cold&#x27;</span>: <span class="string">&#x27;2&#x27;</span>, </span><br><span class="line"><span class="string">&#x27;items:5:moves_to_warm&#x27;</span>: <span class="string">&#x27;0&#x27;</span>, <span class="string">&#x27;items:5:moves_within_lru&#x27;</span>: <span class="string">&#x27;0&#x27;</span>, <span class="string">&#x27;items:5:direct_reclaims&#x27;</span>: <span class="string">&#x27;0&#x27;</span>, </span><br><span class="line"><span class="string">&#x27;items:5:hits_to_hot&#x27;</span>: <span class="string">&#x27;0&#x27;</span>, <span class="string">&#x27;items:5:hits_to_warm&#x27;</span>: <span class="string">&#x27;0&#x27;</span>, <span class="string">&#x27;items:5:hits_to_cold&#x27;</span>: </span><br><span class="line"><span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;items:5:hits_to_temp&#x27;</span>: <span class="string">&#x27;0&#x27;</span>&#125;)</span><br><span class="line">(<span class="string">&#x27;10.0.0.102:11211 (1)&#x27;</span>, &#123;&#125;)</span><br><span class="line">------------------------------</span><br><span class="line">(<span class="string">&#x27;10.0.0.101:11211 (1)&#x27;</span>, &#123;<span class="string">&#x27;4E92417BEFB38ED09E50433EF6F96DDF-n1.Tomcat2&#x27;</span>: <span class="string">&#x27;[97 b; 1594562924 s]&#x27;</span>&#125;)</span><br><span class="line">(<span class="string">&#x27;10.0.0.102:11211 (1)&#x27;</span>, &#123;&#125;)</span><br></pre></td></tr></table></figure>

<h5 id="模拟memcached故障"><a href="#模拟memcached故障" class="headerlink" title="模拟memcached故障"></a>模拟memcached故障</h5><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@t2 ~]<span class="comment"># systemctl start tomcat</span></span><br><span class="line">[root@t2 ~]<span class="comment"># systemctl stop memcached.service </span></span><br></pre></td></tr></table></figure>

<p>刷新几次页面可以看到下面显示</p>
<p><img src="../../../../images/SRE/day33/110.jpg" alt="110"></p>
<p>再次运行脚本</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">[root@t1 ~]<span class="comment">#./showmemcached.py</span></span><br><span class="line">------------------------------</span><br><span class="line">MemCached: MemCache: inet:10.0.0.102:11211: connect: [Errno 111] Connection </span><br><span class="line">refused. Marking dead.</span><br><span class="line">(<span class="string">&#x27;10.0.0.101:11211 (1)&#x27;</span>, &#123;<span class="string">&#x27;items:5:number&#x27;</span>: <span class="string">&#x27;2&#x27;</span>, <span class="string">&#x27;items:5:number_hot&#x27;</span>: <span class="string">&#x27;0&#x27;</span>, </span><br><span class="line"><span class="string">&#x27;items:5:number_warm&#x27;</span>: <span class="string">&#x27;0&#x27;</span>, <span class="string">&#x27;items:5:number_cold&#x27;</span>: <span class="string">&#x27;2&#x27;</span>, <span class="string">&#x27;items:5:age_hot&#x27;</span>: <span class="string">&#x27;0&#x27;</span>, </span><br><span class="line"><span class="string">&#x27;items:5:age_warm&#x27;</span>: <span class="string">&#x27;0&#x27;</span>, <span class="string">&#x27;items:5:age&#x27;</span>: <span class="string">&#x27;60&#x27;</span>, <span class="string">&#x27;items:5:evicted&#x27;</span>: <span class="string">&#x27;0&#x27;</span>, </span><br><span class="line"><span class="string">&#x27;items:5:evicted_nonzero&#x27;</span>: <span class="string">&#x27;0&#x27;</span>, <span class="string">&#x27;items:5:evicted_time&#x27;</span>: <span class="string">&#x27;0&#x27;</span>, </span><br><span class="line"><span class="string">&#x27;items:5:outofmemory&#x27;</span>: <span class="string">&#x27;0&#x27;</span>, <span class="string">&#x27;items:5:tailrepairs&#x27;</span>: <span class="string">&#x27;0&#x27;</span>, <span class="string">&#x27;items:5:reclaimed&#x27;</span>: </span><br><span class="line"><span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;items:5:expired_unfetched&#x27;</span>: <span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;items:5:evicted_unfetched&#x27;</span>: <span class="string">&#x27;0&#x27;</span>, </span><br><span class="line"><span class="string">&#x27;items:5:evicted_active&#x27;</span>: <span class="string">&#x27;0&#x27;</span>, <span class="string">&#x27;items:5:crawler_reclaimed&#x27;</span>: <span class="string">&#x27;0&#x27;</span>, </span><br><span class="line"><span class="string">&#x27;items:5:crawler_items_checked&#x27;</span>: <span class="string">&#x27;11&#x27;</span>, <span class="string">&#x27;items:5:lrutail_reflocked&#x27;</span>: <span class="string">&#x27;0&#x27;</span>, </span><br><span class="line"><span class="string">&#x27;items:5:moves_to_cold&#x27;</span>: <span class="string">&#x27;13&#x27;</span>, <span class="string">&#x27;items:5:moves_to_warm&#x27;</span>: <span class="string">&#x27;0&#x27;</span>, </span><br><span class="line"><span class="string">&#x27;items:5:moves_within_lru&#x27;</span>: <span class="string">&#x27;0&#x27;</span>, <span class="string">&#x27;items:5:direct_reclaims&#x27;</span>: <span class="string">&#x27;0&#x27;</span>, </span><br><span class="line"><span class="string">&#x27;items:5:hits_to_hot&#x27;</span>: <span class="string">&#x27;0&#x27;</span>, <span class="string">&#x27;items:5:hits_to_warm&#x27;</span>: <span class="string">&#x27;0&#x27;</span>, <span class="string">&#x27;items:5:hits_to_cold&#x27;</span>: </span><br><span class="line"><span class="string">&#x27;5&#x27;</span>, <span class="string">&#x27;items:5:hits_to_temp&#x27;</span>: <span class="string">&#x27;0&#x27;</span>&#125;)</span><br><span class="line">------------------------------</span><br><span class="line">(<span class="string">&#x27;10.0.0.101:11211 (1)&#x27;</span>, &#123;<span class="string">&#x27;63B8F0CE41AF8943351AB9B71DE174C3-n1.Tomcat1&#x27;</span>: <span class="string">&#x27;[97 b; 1594564819 s]&#x27;</span>, <span class="string">&#x27;63B8F0CE41AF8943351AB9B71DE174C3-n1.Tomcat2&#x27;</span>: <span class="string">&#x27;[97 b; 1594564785 s]&#x27;</span>&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">#看到只有10.0.0.101有信息,并且生成两个sessionID,说明当memcached2挂掉后,tomcat1只能将Session信息写入至memcached1做为备份</span></span><br></pre></td></tr></table></figure>

<p>恢复memcached </p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">[root@t2 ~]<span class="comment"># systemctl start memcached.service </span></span><br><span class="line">[root@t1 ~]<span class="comment"># ./showmemcached.py</span></span><br><span class="line">------------------------------</span><br><span class="line">(<span class="string">&#x27;10.0.0.101:11211 (1)&#x27;</span>, &#123;<span class="string">&#x27;items:5:number&#x27;</span>: <span class="string">&#x27;2&#x27;</span>, <span class="string">&#x27;items:5:number_hot&#x27;</span>: <span class="string">&#x27;0&#x27;</span>, </span><br><span class="line"><span class="string">&#x27;items:5:number_warm&#x27;</span>: <span class="string">&#x27;0&#x27;</span>, <span class="string">&#x27;items:5:number_cold&#x27;</span>: <span class="string">&#x27;2&#x27;</span>, <span class="string">&#x27;items:5:age_hot&#x27;</span>: <span class="string">&#x27;0&#x27;</span>, </span><br><span class="line"><span class="string">&#x27;items:5:age_warm&#x27;</span>: <span class="string">&#x27;0&#x27;</span>, <span class="string">&#x27;items:5:age&#x27;</span>: <span class="string">&#x27;23&#x27;</span>, <span class="string">&#x27;items:5:evicted&#x27;</span>: <span class="string">&#x27;0&#x27;</span>, </span><br><span class="line"><span class="string">&#x27;items:5:evicted_nonzero&#x27;</span>: <span class="string">&#x27;0&#x27;</span>, <span class="string">&#x27;items:5:evicted_time&#x27;</span>: <span class="string">&#x27;0&#x27;</span>, </span><br><span class="line"><span class="string">&#x27;items:5:outofmemory&#x27;</span>: <span class="string">&#x27;0&#x27;</span>, <span class="string">&#x27;items:5:tailrepairs&#x27;</span>: <span class="string">&#x27;0&#x27;</span>, <span class="string">&#x27;items:5:reclaimed&#x27;</span>: </span><br><span class="line"><span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;items:5:expired_unfetched&#x27;</span>: <span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;items:5:evicted_unfetched&#x27;</span>: <span class="string">&#x27;0&#x27;</span>, </span><br><span class="line"><span class="string">&#x27;items:5:evicted_active&#x27;</span>: <span class="string">&#x27;0&#x27;</span>, <span class="string">&#x27;items:5:crawler_reclaimed&#x27;</span>: <span class="string">&#x27;0&#x27;</span>, </span><br><span class="line"><span class="string">&#x27;items:5:crawler_items_checked&#x27;</span>: <span class="string">&#x27;13&#x27;</span>, <span class="string">&#x27;items:5:lrutail_reflocked&#x27;</span>: <span class="string">&#x27;0&#x27;</span>, </span><br><span class="line"><span class="string">&#x27;items:5:moves_to_cold&#x27;</span>: <span class="string">&#x27;20&#x27;</span>, <span class="string">&#x27;items:5:moves_to_warm&#x27;</span>: <span class="string">&#x27;0&#x27;</span>, </span><br><span class="line"><span class="string">&#x27;items:5:moves_within_lru&#x27;</span>: <span class="string">&#x27;0&#x27;</span>, <span class="string">&#x27;items:5:direct_reclaims&#x27;</span>: <span class="string">&#x27;0&#x27;</span>, </span><br><span class="line"><span class="string">&#x27;items:5:hits_to_hot&#x27;</span>: <span class="string">&#x27;0&#x27;</span>, <span class="string">&#x27;items:5:hits_to_warm&#x27;</span>: <span class="string">&#x27;0&#x27;</span>, <span class="string">&#x27;items:5:hits_to_cold&#x27;</span>: </span><br><span class="line"><span class="string">&#x27;5&#x27;</span>, <span class="string">&#x27;items:5:hits_to_temp&#x27;</span>: <span class="string">&#x27;0&#x27;</span>&#125;)</span><br><span class="line">(<span class="string">&#x27;10.0.0.102:11211 (1)&#x27;</span>, &#123;<span class="string">&#x27;items:5:number&#x27;</span>: <span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;items:5:number_hot&#x27;</span>: <span class="string">&#x27;0&#x27;</span>, </span><br><span class="line"><span class="string">&#x27;items:5:number_warm&#x27;</span>: <span class="string">&#x27;0&#x27;</span>, <span class="string">&#x27;items:5:number_cold&#x27;</span>: <span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;items:5:age_hot&#x27;</span>: <span class="string">&#x27;0&#x27;</span>, </span><br><span class="line"><span class="string">&#x27;items:5:age_warm&#x27;</span>: <span class="string">&#x27;0&#x27;</span>, <span class="string">&#x27;items:5:age&#x27;</span>: <span class="string">&#x27;20&#x27;</span>, <span class="string">&#x27;items:5:evicted&#x27;</span>: <span class="string">&#x27;0&#x27;</span>, </span><br><span class="line"><span class="string">&#x27;items:5:evicted_nonzero&#x27;</span>: <span class="string">&#x27;0&#x27;</span>, <span class="string">&#x27;items:5:evicted_time&#x27;</span>: <span class="string">&#x27;0&#x27;</span>, </span><br><span class="line"><span class="string">&#x27;items:5:outofmemory&#x27;</span>: <span class="string">&#x27;0&#x27;</span>, <span class="string">&#x27;items:5:tailrepairs&#x27;</span>: <span class="string">&#x27;0&#x27;</span>, <span class="string">&#x27;items:5:reclaimed&#x27;</span>: </span><br><span class="line"><span class="string">&#x27;0&#x27;</span>, <span class="string">&#x27;items:5:expired_unfetched&#x27;</span>: <span class="string">&#x27;0&#x27;</span>, <span class="string">&#x27;items:5:evicted_unfetched&#x27;</span>: <span class="string">&#x27;0&#x27;</span>, </span><br><span class="line"><span class="string">&#x27;items:5:evicted_active&#x27;</span>: <span class="string">&#x27;0&#x27;</span>, <span class="string">&#x27;items:5:crawler_reclaimed&#x27;</span>: <span class="string">&#x27;0&#x27;</span>, </span><br><span class="line"><span class="string">&#x27;items:5:crawler_items_checked&#x27;</span>: <span class="string">&#x27;0&#x27;</span>, <span class="string">&#x27;items:5:lrutail_reflocked&#x27;</span>: <span class="string">&#x27;0&#x27;</span>, </span><br><span class="line"><span class="string">&#x27;items:5:moves_to_cold&#x27;</span>: <span class="string">&#x27;2&#x27;</span>, <span class="string">&#x27;items:5:moves_to_warm&#x27;</span>: <span class="string">&#x27;0&#x27;</span>, </span><br><span class="line"><span class="string">&#x27;items:5:moves_within_lru&#x27;</span>: <span class="string">&#x27;0&#x27;</span>, <span class="string">&#x27;items:5:direct_reclaims&#x27;</span>: <span class="string">&#x27;0&#x27;</span>, </span><br><span class="line"><span class="string">&#x27;items:5:hits_to_hot&#x27;</span>: <span class="string">&#x27;0&#x27;</span>, <span class="string">&#x27;items:5:hits_to_warm&#x27;</span>: <span class="string">&#x27;0&#x27;</span>, <span class="string">&#x27;items:5:hits_to_cold&#x27;</span>: </span><br><span class="line"><span class="string">&#x27;0&#x27;</span>, <span class="string">&#x27;items:5:hits_to_temp&#x27;</span>: <span class="string">&#x27;0&#x27;</span>&#125;)</span><br><span class="line">------------------------------</span><br><span class="line">(<span class="string">&#x27;10.0.0.101:11211 (1)&#x27;</span>, &#123;<span class="string">&#x27;63B8F0CE41AF8943351AB9B71DE174C3-n1.Tomcat2&#x27;</span>: <span class="string">&#x27;[97 b; 1594564785 s]&#x27;</span>, <span class="string">&#x27;63B8F0CE41AF8943351AB9B71DE174C3-n1.Tomcat1&#x27;</span>: <span class="string">&#x27;[97 b; 1594564819 s]&#x27;</span>&#125;)</span><br><span class="line">(<span class="string">&#x27;10.0.0.102:11211 (1)&#x27;</span>, &#123;<span class="string">&#x27;63B8F0CE41AF8943351AB9B71DE174C3-n2.Tomcat1&#x27;</span>: <span class="string">&#x27;[97 b; 1594564796 s]&#x27;</span>&#125;)</span><br></pre></td></tr></table></figure>

<h3 id="实战案例-2-tomcat和memcached-分别处于不同主机"><a href="#实战案例-2-tomcat和memcached-分别处于不同主机" class="headerlink" title="实战案例 2 : tomcat和memcached 分别处于不同主机"></a>实战案例 2 : tomcat和memcached 分别处于不同主机</h3><p><img src="../../../../images/SRE/day33/111.jpg" alt="111"></p>
<p>环境准备：</p>
<ul>
<li>时间同步，确保NTP或Chrony服务正常运行。</li>
<li>防火墙规则</li>
<li>禁用SELinux</li>
<li>五台主机</li>
</ul>
<table>
<thead>
<tr>
<th>ip</th>
<th>主机名</th>
<th>服务</th>
<th>软件</th>
</tr>
</thead>
<tbody><tr>
<td>10.0.0.100</td>
<td>proxy</td>
<td>调度器</td>
<td>CentOS8、Nginx、HTTPD</td>
</tr>
<tr>
<td>10.0.0.101</td>
<td>t1</td>
<td>tomcat1</td>
<td>CentOS8、JDK8、Tomcat8</td>
</tr>
<tr>
<td>10.0.0.102</td>
<td>t2</td>
<td>tomcat2</td>
<td>CentOS8、JDK8、Tomcat8</td>
</tr>
<tr>
<td>10.0.0.103</td>
<td>m1</td>
<td>memcached1</td>
<td>CentOS8、memcached</td>
</tr>
<tr>
<td>10.0.0.104</td>
<td>m2</td>
<td>memcached2</td>
<td>CentOS8、memcached</td>
</tr>
</tbody></table>
<h4 id="准备proxy主机的配置，利用nginx作为反向代理"><a href="#准备proxy主机的配置，利用nginx作为反向代理" class="headerlink" title="准备proxy主机的配置，利用nginx作为反向代理"></a>准备proxy主机的配置，利用nginx作为反向代理</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">[root@proxy ~]<span class="comment"># cat /etc/nginx/nginx.conf</span></span><br><span class="line">http &#123;</span><br><span class="line"> ......</span><br><span class="line">       upstream tomcat-server &#123;</span><br><span class="line">           server t1.magedu.org:8080;</span><br><span class="line">           server t2.magedu.org:8080;</span><br><span class="line">       &#125;</span><br><span class="line">       server &#123;</span><br><span class="line">            ......</span><br><span class="line">            location / &#123;</span><br><span class="line">            &#125;</span><br><span class="line">            location ~* \.(jsp|<span class="keyword">do</span>)$ &#123;</span><br><span class="line">                proxy_pass http://tomcat-server;</span><br><span class="line">                <span class="comment">#proxy_set_header Host $http_host; #转发主机头至后端服务器</span></span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">[root@proxy ~]<span class="comment"># cat /etc/hosts</span></span><br><span class="line">10.0.0.100 proxy.magedu.org proxy</span><br><span class="line">10.0.0.101 t1.magedu.org t1</span><br><span class="line">10.0.0.102 t2.magedu.org t2</span><br><span class="line"></span><br><span class="line"><span class="comment">#准备一台测试机(可选)</span></span><br><span class="line">[root@centos7 ~]<span class="comment"># cat /etc/hosts</span></span><br><span class="line">127.0.0.1   localhost localhost.localdomain localhost4 localhost4.localdomain4 centos7.wangxiaochun.com</span><br><span class="line">::1         localhost localhost.localdomain localhost6 localhost6.localdomain6</span><br><span class="line">10.0.0.100 proxy.magedu.org</span><br><span class="line"></span><br><span class="line">[root@centos7 ~]<span class="comment"># hostname -I</span></span><br><span class="line">10.0.0.7</span><br></pre></td></tr></table></figure>

<h4 id="在m1和m2上分别配置memcached"><a href="#在m1和m2上分别配置memcached" class="headerlink" title="在m1和m2上分别配置memcached"></a>在m1和m2上分别配置memcached</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#在m1和m2上做相同的配置</span></span><br><span class="line">[root@m1 ~]<span class="comment"># dnf -y install memcached </span></span><br><span class="line">[root@m1 ~]<span class="comment"># vim /etc/sysconfig/memcached </span></span><br><span class="line">[root@m1 ~]<span class="comment"># cat /etc/sysconfig/memcached </span></span><br><span class="line">PORT=<span class="string">&quot;11211&quot;</span></span><br><span class="line">USER=<span class="string">&quot;memcached&quot;</span></span><br><span class="line">MAXCONN=<span class="string">&quot;1024&quot;</span></span><br><span class="line">CACHESIZE=<span class="string">&quot;64&quot;</span></span><br><span class="line"><span class="comment">#OPTIONS=&quot;-l 127.0.0.1,::1&quot;</span></span><br><span class="line">OPTIONS=<span class="string">&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">[root@m1 ~]<span class="comment"># systemctl start memcached.service</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#m2的配置和m1相同</span></span><br></pre></td></tr></table></figure>

<h4 id="在t1和t2上准备tomcat"><a href="#在t1和t2上准备tomcat" class="headerlink" title="在t1和t2上准备tomcat"></a>在t1和t2上准备tomcat</h4><p><strong>t1 的配置</strong></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line">[root@t1 tomcat]<span class="comment"># vim conf/server.xml</span></span><br><span class="line"> &lt;Engine name=<span class="string">&quot;Catalina&quot;</span> defaultHost=<span class="string">&quot;t1.magedu.org&quot;</span> jvmRoute=<span class="string">&quot;Tomcat1&quot;</span>&gt;  </span><br><span class="line"> ......</span><br><span class="line">       &lt;Host name=<span class="string">&quot;t1.magedu.org&quot;</span> appBase=<span class="string">&quot;/data/webapps&quot;</span> autoDeploy=<span class="string">&quot;true&quot;</span> &gt; </span><br><span class="line">     &lt;/Host&gt;  </span><br><span class="line">   &lt;/Engine&gt;</span><br><span class="line"> &lt;/Service&gt;</span><br><span class="line">&lt;/Server&gt;</span><br><span class="line"></span><br><span class="line">[root@t1 tomcat]<span class="comment"># vim conf/context.xml</span></span><br><span class="line">.....</span><br><span class="line">&lt;Context&gt;</span><br><span class="line">......</span><br><span class="line">   &lt;Manager pathname=<span class="string">&quot;&quot;</span> /&gt;</span><br><span class="line">    --&gt;</span><br><span class="line"><span class="comment">#在最后一行前加下面内容</span></span><br><span class="line"> &lt;Manager className=<span class="string">&quot;de.javakaffee.web.msm.MemcachedBackupSessionManager&quot;</span></span><br><span class="line">    memcachedNodes=<span class="string">&quot;n1:10.0.0.103:11211,n2:10.0.0.104:11211&quot;</span>  </span><br><span class="line">    failoverNodes=<span class="string">&quot;n1&quot;</span></span><br><span class="line">    requestUriIgnorePattern=<span class="string">&quot;.*\.(ico|png|gif|jpg|css|js)$&quot;</span></span><br><span class="line">    </span><br><span class="line">    transcoderFactoryClass=<span class="string">&quot;de.javakaffee.web.msm.serializer.kryo.KryoTranscoderFactory&quot;</span></span><br><span class="line">   /&gt;</span><br><span class="line">&lt;/Context&gt; <span class="comment">#此行是最后一行</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#将相关包传到lib/目录下</span></span><br><span class="line">asm-5.2.jar</span><br><span class="line">kryo-3.0.3.jar</span><br><span class="line">kryo-serializers-0.45.jar</span><br><span class="line">memcached-session-manager-2.3.2.jar</span><br><span class="line">memcached-session-manager-tc8-2.3.2.jar</span><br><span class="line">minlog-1.3.1.jar</span><br><span class="line">msm-kryo-serializer-2.3.2.jar</span><br><span class="line">objenesis-2.6.jar</span><br><span class="line">reflectasm-1.11.9.jar</span><br><span class="line">spymemcached-2.12.3.jar</span><br><span class="line"></span><br><span class="line">[root@t1 tomcat]<span class="comment"># ls lib/ -t |tail </span></span><br><span class="line">kryo-3.0.3.jar</span><br><span class="line">asm-5.2.jar</span><br><span class="line">objenesis-2.6.jar</span><br><span class="line">reflectasm-1.11.9.jar</span><br><span class="line">minlog-1.3.1.jar</span><br><span class="line">kryo-serializers-0.45.jar</span><br><span class="line">msm-kryo-serializer-2.3.2.jar</span><br><span class="line">memcached-session-manager-tc8-2.3.2.jar</span><br><span class="line">spymemcached-2.12.3.jar</span><br><span class="line">memcached-session-manager-2.3.2.jar</span><br><span class="line"></span><br><span class="line">[root@t1 tomcat]<span class="comment"># cat /data/webapps/ROOT/index.jsp </span></span><br><span class="line">&lt;%@ page import=<span class="string">&quot;java.util.*&quot;</span> %&gt;</span><br><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html lang=<span class="string">&quot;en&quot;</span>&gt;</span><br><span class="line">&lt;<span class="built_in">head</span>&gt;</span><br><span class="line">   &lt;meta charset=<span class="string">&quot;UTF-8&quot;</span>&gt;</span><br><span class="line">   &lt;title&gt;tomcat <span class="built_in">test</span>&lt;/title&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">&lt;div&gt;On &lt;%=request.getServerName() %&gt;&lt;/div&gt;</span><br><span class="line">&lt;div&gt;&lt;%=request.getLocalAddr() + <span class="string">&quot;:&quot;</span> + request.getLocalPort() %&gt;&lt;/div&gt;</span><br><span class="line">&lt;div&gt;SessionID = &lt;span style=<span class="string">&quot;color:blue&quot;</span>&gt;&lt;%=session.getId() %&gt;&lt;/span&gt;&lt;/div&gt;</span><br><span class="line">&lt;%=new Date()%&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br><span class="line"></span><br><span class="line">[root@t1 ~]<span class="comment"># systemctl restart tomcat</span></span><br></pre></td></tr></table></figure>

<p><strong>t2参考上面t1做类似的配置</strong></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line">[root@t2 tomcat]<span class="comment"># vim conf/server.xml</span></span><br><span class="line"> &lt;Engine name=<span class="string">&quot;Catalina&quot;</span> defaultHost=<span class="string">&quot;t2.magedu.org&quot;</span> jvmRoute=<span class="string">&quot;Tomcat2&quot;</span>&gt;  </span><br><span class="line"> ......</span><br><span class="line">       &lt;Host name=<span class="string">&quot;t2.magedu.org&quot;</span> appBase=<span class="string">&quot;/data/webapps&quot;</span> autoDeploy=<span class="string">&quot;true&quot;</span> &gt; </span><br><span class="line">     &lt;/Host&gt;  </span><br><span class="line">   &lt;/Engine&gt;</span><br><span class="line"> &lt;/Service&gt;</span><br><span class="line">&lt;/Server&gt;</span><br><span class="line"></span><br><span class="line">[root@t2 tomcat]<span class="comment"># vim conf/context.xml</span></span><br><span class="line">.....</span><br><span class="line">&lt;Context&gt;</span><br><span class="line">......</span><br><span class="line">   &lt;Manager pathname=<span class="string">&quot;&quot;</span> /&gt;</span><br><span class="line">    --&gt;</span><br><span class="line"><span class="comment">#在最后一行前加下面内容</span></span><br><span class="line"> &lt;Manager className=<span class="string">&quot;de.javakaffee.web.msm.MemcachedBackupSessionManager&quot;</span></span><br><span class="line">    memcachedNodes=<span class="string">&quot;n1:10.0.0.103:11211,n2:10.0.0.104:11211&quot;</span>  </span><br><span class="line">    failoverNodes=<span class="string">&quot;n2&quot;</span> <span class="comment">#只修改此行,和t1不同,其它都一样</span></span><br><span class="line">    requestUriIgnorePattern=<span class="string">&quot;.*\.(ico|png|gif|jpg|css|js)$&quot;</span></span><br><span class="line">    </span><br><span class="line">    transcoderFactoryClass=<span class="string">&quot;de.javakaffee.web.msm.serializer.kryo.KryoTranscoderFactory&quot;</span></span><br><span class="line">   /&gt;</span><br><span class="line">&lt;/Context&gt; <span class="comment">#此行是最后一行</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#将相关包传到lib/目录下</span></span><br><span class="line">asm-5.2.jar</span><br><span class="line">kryo-3.0.3.jar</span><br><span class="line">kryo-serializers-0.45.jar</span><br><span class="line">memcached-session-manager-2.3.2.jar</span><br><span class="line">memcached-session-manager-tc8-2.3.2.jar</span><br><span class="line">minlog-1.3.1.jar</span><br><span class="line">msm-kryo-serializer-2.3.2.jar</span><br><span class="line">objenesis-2.6.jar</span><br><span class="line">reflectasm-1.11.9.jar</span><br><span class="line">spymemcached-2.12.3.jar</span><br><span class="line"></span><br><span class="line">[root@t2 tomcat]<span class="comment"># cat /data/webapps/ROOT/index.jsp </span></span><br><span class="line">&lt;%@ page import=<span class="string">&quot;java.util.*&quot;</span> %&gt;</span><br><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html lang=<span class="string">&quot;en&quot;</span>&gt;</span><br><span class="line">&lt;<span class="built_in">head</span>&gt;</span><br><span class="line">   &lt;meta charset=<span class="string">&quot;UTF-8&quot;</span>&gt;</span><br><span class="line">   &lt;title&gt;tomcat <span class="built_in">test</span>&lt;/title&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">&lt;div&gt;On &lt;%=request.getServerName() %&gt;&lt;/div&gt;</span><br><span class="line">&lt;div&gt;&lt;%=request.getLocalAddr() + <span class="string">&quot;:&quot;</span> + request.getLocalPort() %&gt;&lt;/div&gt;</span><br><span class="line">&lt;div&gt;SessionID = &lt;span style=<span class="string">&quot;color:blue&quot;</span>&gt;&lt;%=session.getId() %&gt;&lt;/span&gt;&lt;/div&gt;</span><br><span class="line">&lt;%=new Date()%&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br><span class="line"></span><br><span class="line">[root@t2 ~]<span class="comment"># systemctl restart tomcat</span></span><br></pre></td></tr></table></figure>

<p>查看日志</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root@t1 ~]<span class="comment"># tail /usr/local/tomcat/logs/catalina.out</span></span><br><span class="line">.......</span><br><span class="line">...... INFO [t1.magedu.org-startStop-1] </span><br><span class="line">de.javakaffee.web.msm.MemcachedSessionService.startInternal --------</span><br><span class="line">- finished initialization:</span><br><span class="line">- sticky: <span class="literal">true</span></span><br><span class="line">- operation <span class="built_in">timeout</span>: 1000</span><br><span class="line">- node ids: [n2]</span><br><span class="line">- failover node ids: [n1]</span><br><span class="line">- storage key prefix: null</span><br><span class="line">- locking mode: null (expiration: 5s)</span><br></pre></td></tr></table></figure>

<h4 id="测试的python脚本"><a href="#测试的python脚本" class="headerlink" title="测试的python脚本"></a>测试的python脚本</h4><p>在proxy 上安装部署python3环境,访问memcached</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">[root@proxy ~]<span class="comment"># dnf -y install python3 python3-memcached</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#准备python测试脚本</span></span><br><span class="line">[root@proxy ~]<span class="comment"># cat showmemcached.py </span></span><br><span class="line"><span class="comment">#!/usr/bin/python3</span></span><br><span class="line">import memcache</span><br><span class="line">mc = memcache.Client([<span class="string">&#x27;10.0.0.103:11211&#x27;</span>,<span class="string">&#x27;10.0.0.104:11211&#x27;</span>], debug=True)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;-&#x27;</span> * 30)</span><br><span class="line"><span class="keyword">for</span> x <span class="keyword">in</span> mc.get_stats(<span class="string">&#x27;cachedump 5 0&#x27;</span>):  <span class="comment"># stats cachedump 5 0 # 5和上面的items返回的值有关；0表示全部</span></span><br><span class="line">   <span class="built_in">print</span>(x)</span><br><span class="line">   </span><br><span class="line">[root@proxy ~]<span class="comment"># chmod +x showmemcached.py</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#运行python脚本</span></span><br><span class="line">[root@proxy ~]<span class="comment"># ./showmemcached.py</span></span><br><span class="line">------------------------------</span><br><span class="line">(<span class="string">&#x27;10.0.0.103:11211 (1)&#x27;</span>, &#123;&#125;)</span><br><span class="line">(<span class="string">&#x27;10.0.0.104:11211 (1)&#x27;</span>, &#123;&#125;)</span><br></pre></td></tr></table></figure>

<h4 id="浏览器访问测试"><a href="#浏览器访问测试" class="headerlink" title="浏览器访问测试"></a>浏览器访问测试</h4><p><strong>第一次刷新浏览器可以看到以下显示</strong></p>
<p><img src="../../../../images/SRE/day33/112.jpg" alt="112"></p>
<p>运行脚本,可以看到只有m2上有SessionID信息</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@proxy ~]<span class="comment">#./showmemcached.py</span></span><br><span class="line">------------------------------</span><br><span class="line">(<span class="string">&#x27;10.0.0.103:11211 (1)&#x27;</span>, &#123;&#125;)</span><br><span class="line">(<span class="string">&#x27;10.0.0.104:11211 (1)&#x27;</span>, &#123;<span class="string">&#x27;8F9B4782FFFE6F1840728C344A179EE8-n2.Tomcat1&#x27;</span>: <span class="string">&#x27;[97 b; 1594812395 s]&#x27;</span>&#125;)</span><br></pre></td></tr></table></figure>

<p>第二次刷新页面,可以看到主机轮询,SessionID不变,但SessionID来自别一个tomcat</p>
<p><img src="../../../../images/SRE/day33/113.jpg" alt="113"></p>
<p>多次刷新页面,可以看到主机轮询,SessionID不变,发现以下规律</p>
<p>当tomcat为t1,发现SessionID为n1.Tomcat2</p>
<p>当tomcat为t2,发现SessionID为n2.Tomcat1</p>
<p><img src="../../../../images/SRE/day33/114.jpg" alt="114"><br><img src="../../../../images/SRE/day33/115.jpg" alt="115"></p>
<p>运行脚本,可以看到m1和m2上都有了SessionID信息</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@proxy ~]<span class="comment"># ./showmemcached.py</span></span><br><span class="line">------------------------------</span><br><span class="line">(<span class="string">&#x27;10.0.0.103:11211 (1)&#x27;</span>, &#123;<span class="string">&#x27;8F9B4782FFFE6F1840728C344A179EE8-n1.Tomcat2&#x27;</span>: <span class="string">&#x27;[97 b; 1594812654 s]&#x27;</span>&#125;)</span><br><span class="line">(<span class="string">&#x27;10.0.0.104:11211 (1)&#x27;</span>, &#123;<span class="string">&#x27;8F9B4782FFFE6F1840728C344A179EE8-n2.Tomcat1&#x27;</span>: <span class="string">&#x27;[97 b; 1594812396 s]&#x27;</span>&#125;)</span><br></pre></td></tr></table></figure>

<h4 id="模拟故障"><a href="#模拟故障" class="headerlink" title="模拟故障"></a>模拟故障</h4><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@t2 ~]# systemctl stop tomcat</span><br></pre></td></tr></table></figure>

<p>多次刷新页面,SessionID不变</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@m2 ~]<span class="comment"># systemctl stop memcached.service</span></span><br></pre></td></tr></table></figure>

<p>多次刷新页面,SessionID不变</p>
<p><img src="../../../../images/SRE/day33/116.jpg" alt="116"><br><img src="../../../../images/SRE/day33/117.jpg" alt="117"></p>
<p>运行脚本</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@proxy ~]<span class="comment"># ./showmemcached.py</span></span><br><span class="line">------------------------------</span><br><span class="line">MemCached: MemCache: inet:10.0.0.104:11211: connect: [Errno 111] Connection </span><br><span class="line">refused. Marking dead.</span><br><span class="line">(<span class="string">&#x27;10.0.0.103:11211 (1)&#x27;</span>, &#123;<span class="string">&#x27;F82C3A7C84B2E0D6B05E6E6F496F9FBC-n1.Tomcat2&#x27;</span>: <span class="string">&#x27;[97 b; 1594815951 s]&#x27;</span>, <span class="string">&#x27;F82C3A7C84B2E0D6B05E6E6F496F9FBC-n1.Tomcat1&#x27;</span>: <span class="string">&#x27;[97 b; 1594815949 s]&#x27;</span>&#125;)</span><br></pre></td></tr></table></figure>

<h2 id="non-sticky-模式"><a href="#non-sticky-模式" class="headerlink" title="non-sticky 模式"></a>non-sticky 模式</h2><h3 id="non-sticky-模式工作原理"><a href="#non-sticky-模式工作原理" class="headerlink" title="non-sticky 模式工作原理"></a>non-sticky 模式工作原理</h3><p>non-sticky 模式即前端tomcat和后端memcached**无关联(无粘性)**关系</p>
<p>从msm 1.4.0之后版本开始支持non-sticky模式。</p>
<p>Tomcat session为中转Session，对每一个SessionID随机选中后端的memcached节点n1(或者n2)为主session，而另一个memcached节点n2(或者是n1)为备session。产生的新的Session会发送给主、备memcached，并清除本地Session。</p>
<p>后端两个memcached服务器对一个session来说是一个是主,一个是备,但对所有session信息来说每个memcached即是主同时也是备</p>
<p>如果n1下线，n2则转正。n1再次上线，n2依然是主Session存储节点。</p>
<h3 id="memcached配置"><a href="#memcached配置" class="headerlink" title="memcached配置"></a>memcached配置</h3><p>放到 <code>$CATALINA_HOME/conf/context.xml</code> 中</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">Context</span>&gt;</span></span><br><span class="line"> ...</span><br><span class="line">  <span class="tag">&lt;<span class="name">Manager</span> <span class="attr">className</span>=<span class="string">&quot;de.javakaffee.web.msm.MemcachedBackupSessionManager&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">memcachedNodes</span>=<span class="string">&quot;n1:10.0.0.101:11211,n2:10.0.0.102:11211&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">sticky</span>=<span class="string">&quot;false&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">sessionBackupAsync</span>=<span class="string">&quot;false&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">lockingMode</span>=<span class="string">&quot;uriPattern:/path1|/path2&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">requestUriIgnorePattern</span>=<span class="string">&quot;.*\.(ico|png|gif|jpg|css|js)$&quot;</span></span></span><br><span class="line"><span class="tag">   </span></span><br><span class="line"><span class="tag"><span class="attr">transcoderFactoryClass</span>=<span class="string">&quot;de.javakaffee.web.msm.serializer.kryo.KryoTranscoderFactory&quot;</span></span></span><br><span class="line"><span class="tag">    /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">Context</span>&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="redis-配置"><a href="#redis-配置" class="headerlink" title="redis 配置"></a>redis 配置</h3><p><img src="../../../../images/SRE/day33/118.jpg" alt="118"></p>
<p>支持将session存放在Redis中,但当前对Redis的支持不允许连接到多个Redis节点,可以通过Redis的集群服务实现防止redis的单点失败</p>
<p>参考文档 :</p>
<p><a target="_blank" rel="noopener" href="https://github.com/ran-jit/tomcat-cluster-redis-session-manager/wiki">https://github.com/ran-jit/tomcat-cluster-redis-session-manager/wiki</a></p>
<p><a target="_blank" rel="noopener" href="https://github.com/magro/memcached-session-manager/wiki/SetupAndConfiguration#example-for-non-sticky-sessions--kryo--redis">https://github.com/magro/memcached-session-manager/wiki/SetupAndConfiguration#example-for-non-sticky-sessions--kryo--redis</a></p>
<p><img src="../../../../images/SRE/day33/119.jpg" alt="119"></p>
<p>下载 <code>jedis.jar</code>，放到 <code>$CATALINA_HOME/lib/</code> ，对应本次安装就是<code>/usr/local/tomcat/lib</code>。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># yum install redis</span></span><br><span class="line"><span class="comment"># vim /etc/redis.conf</span></span><br><span class="line"><span class="built_in">bind</span> 0.0.0.0</span><br><span class="line"></span><br><span class="line"><span class="comment"># systemctl start redis</span></span><br></pre></td></tr></table></figure>

<p>放到 <code>$CATALINA_HOME/conf/context.xml</code> 中</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">Context</span>&gt;</span></span><br><span class="line"> ...</span><br><span class="line">  <span class="tag">&lt;<span class="name">Manager</span> <span class="attr">className</span>=<span class="string">&quot;de.javakaffee.web.msm.MemcachedBackupSessionManager&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">memcachedNodes</span>=<span class="string">&quot;redis://:password@redis.example.com:portnumber&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">sticky</span>=<span class="string">&quot;false&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">sessionBackupAsync</span>=<span class="string">&quot;false&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">lockingMode</span>=<span class="string">&quot;uriPattern:/path1|/path2&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">requestUriIgnorePattern</span>=<span class="string">&quot;.*\.(ico|png|gif|jpg|css|js)$&quot;</span></span></span><br><span class="line"><span class="tag">   </span></span><br><span class="line"><span class="tag"><span class="attr">transcoderFactoryClass</span>=<span class="string">&quot;de.javakaffee.web.msm.serializer.kryo.KryoTranscoderFactory&quot;</span></span></span><br><span class="line"><span class="tag">    /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">Context</span>&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>浏览器访问，使用redis相关工具可以观察到redis中的信息</p>
<p><img src="../../../../images/SRE/day33/120.jpg" alt="120"></p>
<h3 id="实战案例-memcached-实现non-sticky模式"><a href="#实战案例-memcached-实现non-sticky模式" class="headerlink" title="实战案例: memcached 实现non-sticky模式"></a>实战案例: memcached 实现non-sticky模式</h3><p><img src="../../../../images/SRE/day33/121.jpg" alt="121"></p>
<p>环境准备：</p>
<ul>
<li>时间同步，确保NTP或Chrony服务正常运行。</li>
<li>防火墙规则</li>
<li>禁用SELinux</li>
<li>三台主机</li>
</ul>
<table>
<thead>
<tr>
<th>ip</th>
<th>主机名</th>
<th>服务</th>
<th></th>
</tr>
</thead>
<tbody><tr>
<td>10.0.0.100</td>
<td>proxy</td>
<td>调度器</td>
<td>Nginx、HTTPD</td>
</tr>
<tr>
<td>10.0.0.101</td>
<td>t1</td>
<td>tomcat1</td>
<td>JDK8、Tomcat8,memcached</td>
</tr>
<tr>
<td>10.0.0.102</td>
<td>t2</td>
<td>tomcat2</td>
<td>JDK8、Tomcat8,memcached</td>
</tr>
</tbody></table>
<h4 id="修改tomcat配置-1"><a href="#修改tomcat配置-1" class="headerlink" title="修改tomcat配置"></a>修改tomcat配置</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#在前面实验基础上修改,memcached配置不变,只需要修改tomcat配置</span></span><br><span class="line">[root@t1 tomcat]<span class="comment"># vim conf/context.xml</span></span><br><span class="line">&lt;Context&gt;</span><br><span class="line"> ...</span><br><span class="line"> &lt;Manager className=<span class="string">&quot;de.javakaffee.web.msm.MemcachedBackupSessionManager&quot;</span></span><br><span class="line">    memcachedNodes=<span class="string">&quot;n1:10.0.0.101:11211,n2:10.0.0.102:11211&quot;</span></span><br><span class="line">    sticky=<span class="string">&quot;false&quot;</span>               <span class="comment">#下面三行和sticky模式不同</span></span><br><span class="line">    sessionBackupAsync=<span class="string">&quot;false&quot;</span></span><br><span class="line">    lockingMode=<span class="string">&quot;uriPattern:/path1|/path2&quot;</span></span><br><span class="line">    requestUriIgnorePattern=<span class="string">&quot;.*\.(ico|png|gif|jpg|css|js)$&quot;</span></span><br><span class="line">   </span><br><span class="line">transcoderFactoryClass=<span class="string">&quot;de.javakaffee.web.msm.serializer.kryo.KryoTranscoderFactory&quot;</span></span><br><span class="line">   /&gt;</span><br><span class="line">&lt;/Context&gt;</span><br><span class="line"></span><br><span class="line">[root@t1 tomcat]<span class="comment"># systemctl restart tomcat</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#查看日志</span></span><br><span class="line">[root@t1 ~]<span class="comment"># tail -f /usr/local/tomcat/logs/catalina.out</span></span><br><span class="line">..... INFO [t1.magedu.org-startStop-1] </span><br><span class="line">de.javakaffee.web.msm.MemcachedSessionService.startInternal --------</span><br><span class="line">- finished initialization:</span><br><span class="line">- sticky: <span class="literal">false</span></span><br><span class="line">- operation <span class="built_in">timeout</span>: 1000</span><br><span class="line">- node ids: [n1, n2]</span><br><span class="line">- failover node ids: []</span><br><span class="line">- storage key prefix: null</span><br><span class="line">- locking mode: uriPattern:/path1|/path2 (expiration: 5s)</span><br><span class="line">.......</span><br><span class="line"></span><br><span class="line"><span class="comment">#t2和t1相同操作</span></span><br><span class="line">[root@t2 tomcat]<span class="comment"># vim conf/context.xml</span></span><br><span class="line">[root@t2 tomcat]<span class="comment"># systemctl restart tomcat</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#运行脚本查看key</span></span><br><span class="line">[root@t1 ~]<span class="comment"># cat ./showmemcached.py</span></span><br><span class="line"><span class="comment">#!/usr/bin/python3</span></span><br><span class="line">import memcache </span><br><span class="line">mc = memcache.Client([<span class="string">&#x27;10.0.0.101:11211&#x27;</span>,<span class="string">&#x27;10.0.0.102:11211&#x27;</span>], debug=True)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;-&#x27;</span> * 30)</span><br><span class="line"><span class="keyword">for</span> x <span class="keyword">in</span> mc.get_stats(<span class="string">&#x27;cachedump 5 0&#x27;</span>):  <span class="comment"># stats cachedump 5 0 # 5和上面的items返回的值有关；0表示全部</span></span><br><span class="line">   <span class="built_in">print</span>(x)</span><br><span class="line">   </span><br><span class="line">[root@t1 ~]<span class="comment"># ./showmemcached.py </span></span><br><span class="line">------------------------------</span><br><span class="line">(<span class="string">&#x27;10.0.0.101:11211 (1)&#x27;</span>, &#123;&#125;)</span><br><span class="line">(<span class="string">&#x27;10.0.0.102:11211 (1)&#x27;</span>, &#123;&#125;)</span><br></pre></td></tr></table></figure>

<h4 id="通过浏览器访问"><a href="#通过浏览器访问" class="headerlink" title="通过浏览器访问"></a>通过浏览器访问</h4><p><img src="../../../../images/SRE/day33/122.jpg" alt="122"></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#再次运行脚本后可以看到,t2为memcached的主节点,t1为备份节点</span></span><br><span class="line">[root@t1 ~]<span class="comment"># ./showmemcached.py </span></span><br><span class="line">------------------------------</span><br><span class="line">(<span class="string">&#x27;10.0.0.101:11211 (1)&#x27;</span>, &#123;<span class="string">&#x27;bak:D65D49C8BB068B0854F11BD1A7BFAE88-n2.Tomcat2&#x27;</span>: <span class="string">&#x27;[97 b; 1594609275 s]&#x27;</span>&#125;)</span><br><span class="line">(<span class="string">&#x27;10.0.0.102:11211 (1)&#x27;</span>, &#123;<span class="string">&#x27;D65D49C8BB068B0854F11BD1A7BFAE88-n2.Tomcat2&#x27;</span>: <span class="string">&#x27;[97 b; 1594609274 s]&#x27;</span>&#125;)</span><br></pre></td></tr></table></figure>

<h4 id="模拟故障-1"><a href="#模拟故障-1" class="headerlink" title="模拟故障"></a>模拟故障</h4><p><strong>模拟t1的memcached 故障</strong></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">[root@t1 ~]<span class="comment"># systemctl stop memcached.service </span></span><br><span class="line">[root@t1 ~]<span class="comment"># ./showmemcached.py </span></span><br><span class="line">------------------------------</span><br><span class="line">MemCached: MemCache: inet:10.0.0.101:11211: connect: [Errno 111] Connection </span><br><span class="line">refused. Marking dead.</span><br><span class="line">(<span class="string">&#x27;10.0.0.102:11211 (1)&#x27;</span>, &#123;<span class="string">&#x27;D65D49C8BB068B0854F11BD1A7BFAE88-n2.Tomcat2&#x27;</span>: <span class="string">&#x27;[97 b; 1594609274 s]&#x27;</span>&#125;)</span><br><span class="line"></span><br><span class="line">[root@t1 ~]<span class="comment"># systemctl start memcached.service </span></span><br><span class="line">[root@t1 ~]<span class="comment"># ./showmemcached.py </span></span><br><span class="line">------------------------------</span><br><span class="line">(<span class="string">&#x27;10.0.0.101:11211 (1)&#x27;</span>, &#123;&#125;)</span><br><span class="line">(<span class="string">&#x27;10.0.0.102:11211 (1)&#x27;</span>, &#123;<span class="string">&#x27;D65D49C8BB068B0854F11BD1A7BFAE88-n2.Tomcat2&#x27;</span>: <span class="string">&#x27;[97 b; 1594609274 s]&#x27;</span>&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">#刷新几次页面后,再运行脚本</span></span><br><span class="line">[root@t1 ~]<span class="comment"># ./showmemcached.py </span></span><br><span class="line">------------------------------</span><br><span class="line">(<span class="string">&#x27;10.0.0.101:11211 (1)&#x27;</span>, &#123;<span class="string">&#x27;bak:D65D49C8BB068B0854F11BD1A7BFAE88-n2.Tomcat2&#x27;</span>: <span class="string">&#x27;[97 b; 1594609854 s]&#x27;</span>&#125;)</span><br><span class="line">(<span class="string">&#x27;10.0.0.102:11211 (1)&#x27;</span>, &#123;<span class="string">&#x27;D65D49C8BB068B0854F11BD1A7BFAE88-n2.Tomcat2&#x27;</span>: <span class="string">&#x27;[97 b; 1594609274 s]&#x27;</span>&#125;)</span><br></pre></td></tr></table></figure>

<p><strong>模拟t2的memcached 故障</strong></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@t2 ~]<span class="comment"># systemctl stop memcached.service </span></span><br><span class="line">[root@t1 ~]<span class="comment"># ./showmemcached.py </span></span><br><span class="line">------------------------------</span><br><span class="line">MemCached: MemCache: inet:10.0.0.102:11211: connect: [Errno 111] Connection </span><br><span class="line">refused. Marking dead.</span><br><span class="line">(<span class="string">&#x27;10.0.0.101:11211 (1)&#x27;</span>, &#123;<span class="string">&#x27;bak:D65D49C8BB068B0854F11BD1A7BFAE88-n2.Tomcat2&#x27;</span>: <span class="string">&#x27;[97 b; 1594609854 s]&#x27;</span>&#125;)</span><br></pre></td></tr></table></figure>

<p>再刷新页面</p>
<p><img src="../../../../images/SRE/day33/123.jpg" alt="123"></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#运行脚本看到在t1上生成相同的SessionID,并成为memcached新主</span></span><br><span class="line">[root@t1 ~]<span class="comment"># ./showmemcached.py </span></span><br><span class="line">------------------------------</span><br><span class="line">MemCached: MemCache: inet:10.0.0.102:11211: connect: [Errno 111] Connection </span><br><span class="line">refused. Marking dead.</span><br><span class="line">(<span class="string">&#x27;10.0.0.101:11211 (1)&#x27;</span>, &#123;<span class="string">&#x27;D65D49C8BB068B0854F11BD1A7BFAE88-n1.Tomcat2&#x27;</span>: <span class="string">&#x27;[97 b; 1594610030 s]&#x27;</span>, <span class="string">&#x27;bak:D65D49C8BB068B0854F11BD1A7BFAE88-n2.Tomcat2&#x27;</span>: <span class="string">&#x27;[97 b; 1594609854 s]&#x27;</span>&#125;)</span><br><span class="line"></span><br><span class="line">[root@t2 ~]<span class="comment"># systemctl start memcached.service </span></span><br><span class="line"></span><br><span class="line">[root@t1 ~]<span class="comment"># ./showmemcached.py </span></span><br><span class="line">------------------------------</span><br><span class="line">(<span class="string">&#x27;10.0.0.101:11211 (1)&#x27;</span>, &#123;<span class="string">&#x27;D65D49C8BB068B0854F11BD1A7BFAE88-n1.Tomcat2&#x27;</span>: <span class="string">&#x27;[97 b; 1594610030 s]&#x27;</span>, <span class="string">&#x27;bak:D65D49C8BB068B0854F11BD1A7BFAE88-n2.Tomcat2&#x27;</span>: <span class="string">&#x27;[97 b; 1594609854 s]&#x27;</span>&#125;)</span><br><span class="line">(<span class="string">&#x27;10.0.0.102:11211 (1)&#x27;</span>, &#123;&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">#再刷新页,运行脚本看到t2成为备用节点</span></span><br><span class="line">[root@t1 ~]<span class="comment"># ./showmemcached.py </span></span><br><span class="line">------------------------------</span><br><span class="line">(<span class="string">&#x27;10.0.0.101:11211 (1)&#x27;</span>, &#123;<span class="string">&#x27;D65D49C8BB068B0854F11BD1A7BFAE88-n1.Tomcat2&#x27;</span>: <span class="string">&#x27;[97 b; 1594610030 s]&#x27;</span>, <span class="string">&#x27;bak:D65D49C8BB068B0854F11BD1A7BFAE88-n2.Tomcat2&#x27;</span>: <span class="string">&#x27;[97 b; 1594609854 s]&#x27;</span>&#125;)</span><br><span class="line">(<span class="string">&#x27;10.0.0.102:11211 (1)&#x27;</span>, &#123;<span class="string">&#x27;bak:D65D49C8BB068B0854F11BD1A7BFAE88-n1.Tomcat2&#x27;</span>: <span class="string">&#x27;[97 b; 1594610367 s]&#x27;</span>&#125;)</span><br></pre></td></tr></table></figure>

<p>模拟t1的tomcat故障,刷新页面,可以看到SessionID不变</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@t1 ~]<span class="comment"># systemctl stop tomcat</span></span><br></pre></td></tr></table></figure>

<p><img src="../../../../images/SRE/day33/124.jpg" alt="124"></p>
<h3 id="实战案例-redis-实现-non-sticky-模式的msm"><a href="#实战案例-redis-实现-non-sticky-模式的msm" class="headerlink" title="实战案例: redis 实现 non-sticky 模式的msm"></a>实战案例: redis 实现 non-sticky 模式的msm</h3><p><img src="../../../../images/SRE/day33/125.jpg" alt="125"></p>
<p>环境准备：</p>
<ul>
<li>时间同步，确保NTP或Chrony服务正常运行</li>
<li>防火墙规则</li>
<li>禁用SELinux</li>
<li>四台主机</li>
</ul>
<table>
<thead>
<tr>
<th>IP</th>
<th>主机名</th>
<th>服务</th>
<th>软件包</th>
</tr>
</thead>
<tbody><tr>
<td>10.0.0.100</td>
<td>proxy</td>
<td>调度器</td>
<td>Nginx、HTTPD</td>
</tr>
<tr>
<td>10.0.0.101</td>
<td>t1.magedu.org</td>
<td>tomcat1</td>
<td>JDK8、Tomcat8</td>
</tr>
<tr>
<td>10.0.0.102</td>
<td>t2.magedu.org</td>
<td>tomcat2</td>
<td>JDK8、Tomcat8</td>
</tr>
<tr>
<td>10.0.0.103</td>
<td>redis.magedu.org</td>
<td>redis</td>
<td>Redis</td>
</tr>
</tbody></table>
<h4 id="上传redis库到tomcat服务器"><a href="#上传redis库到tomcat服务器" class="headerlink" title="上传redis库到tomcat服务器"></a>上传redis库到tomcat服务器</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@t1 ~]<span class="comment"># ll /usr/local/tomcat/lib/jedis-3.0.0.jar </span></span><br><span class="line">-rw-r--r-- 1 root root 586620 Jun 26  2019 /usr/local/tomcat/lib/jedis-3.0.0.jar</span><br><span class="line">[root@t2 ~]<span class="comment"># ll /usr/local/tomcat/lib/jedis-3.0.0.jar </span></span><br><span class="line">-rw-r--r-- 1 root root 586620 Jun 26  2019 /usr/local/tomcat/lib/jedis-3.0.0.jar</span><br></pre></td></tr></table></figure>

<h4 id="安装并配置-Redis-服务"><a href="#安装并配置-Redis-服务" class="headerlink" title="安装并配置 Redis 服务"></a>安装并配置 Redis 服务</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[root@redis ~]<span class="comment"># dnf -y install redis</span></span><br><span class="line">[root@redis ~]<span class="comment"># sed -i.bak &#x27;s/^bind.*/bind 0.0.0.0/&#x27; /etc/redis.conf</span></span><br><span class="line">[root@redis ~]<span class="comment"># systemctl enable --now redis</span></span><br><span class="line">[root@redis ~]<span class="comment"># ss -ntl</span></span><br><span class="line">State             Recv-Q   Send-Q Local Address:Port Peer Address:Port           </span><br><span class="line">LISTEN            0        128          0.0.0.0:22    0.0.0.0:*</span><br><span class="line">LISTEN            0        100          127.0.0.1:25  0.0.0.0:*</span><br><span class="line">LISTEN            0        128          0.0.0.0:6379  0.0.0.0:*</span><br><span class="line">LISTEN            0        128         [::]:22       [::]:* </span><br><span class="line">LISTEN            0        100         [::1]:25     [::]:* </span><br></pre></td></tr></table></figure>

<h4 id="修改tomcat-配置指定redis服务器地址"><a href="#修改tomcat-配置指定redis服务器地址" class="headerlink" title="修改tomcat 配置指定redis服务器地址"></a>修改tomcat 配置指定redis服务器地址</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">[root@t1 ~]<span class="comment"># vim /usr/local/tomcat/conf/context.xml </span></span><br><span class="line">&lt;Context&gt;</span><br><span class="line"> ...</span><br><span class="line"> &lt;Manager className=<span class="string">&quot;de.javakaffee.web.msm.MemcachedBackupSessionManager&quot;</span></span><br><span class="line">    memcachedNodes=<span class="string">&quot;redis://10.0.0.103:6379&quot;</span>     <span class="comment">#和non-sticky的memcached相比,只修改此行</span></span><br><span class="line">    sticky=<span class="string">&quot;false&quot;</span></span><br><span class="line">    sessionBackupAsync=<span class="string">&quot;false&quot;</span></span><br><span class="line">    lockingMode=<span class="string">&quot;uriPattern:/path1|/path2&quot;</span></span><br><span class="line">    requestUriIgnorePattern=<span class="string">&quot;.*\.(ico|png|gif|jpg|css|js)$&quot;</span> </span><br><span class="line">    </span><br><span class="line">    transcoderFactoryClass=<span class="string">&quot;de.javakaffee.web.msm.serializer.kryo.KryoTranscoderFactory&quot;</span></span><br><span class="line">   /&gt;</span><br><span class="line">&lt;/Context&gt;</span><br><span class="line"></span><br><span class="line">[root@t1 ~]<span class="comment"># systemctl restart tomcat</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#查看日志</span></span><br><span class="line">[root@t1 ~]<span class="comment"># tail -f /usr/local/tomcat/logs/catalina.out</span></span><br><span class="line">....., INFO [t1.magedu.org-startStop-1] </span><br><span class="line">de.javakaffee.web.msm.MemcachedSessionService.startInternal --------</span><br><span class="line">- finished initialization:</span><br><span class="line">- sticky: <span class="literal">false</span></span><br><span class="line">- operation <span class="built_in">timeout</span>: 1000</span><br><span class="line">- node ids: []</span><br><span class="line">- failover node ids: []</span><br><span class="line">- storage key prefix: null</span><br><span class="line">- locking mode: uriPattern:/path1|/path2 (expiration: 5s)</span><br><span class="line">.......</span><br><span class="line"></span><br><span class="line"><span class="comment">#t2和t1配置相同</span></span><br><span class="line">[root@t2 ~]<span class="comment"># vim /usr/local/tomcat/conf/context.xml</span></span><br><span class="line">[root@t2 ~]<span class="comment"># systemctl restart tomcat</span></span><br></pre></td></tr></table></figure>

<h4 id="测试访问-1"><a href="#测试访问-1" class="headerlink" title="测试访问"></a>测试访问</h4><p>浏览器刷新访问多次,主机轮询,但SessionID不变</p>
<p><img src="../../../../images/SRE/day33/126.jpg" alt="126"></p>
<p>使用redis工具连接redis 查看SessionID</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@redis ~]<span class="comment"># redis-cli </span></span><br><span class="line">127.0.0.1:6379&gt; KEYS *</span><br><span class="line">1) <span class="string">&quot;4245D5D28B2CDAB292623A01DD5D2C83.Tomcat2&quot;</span></span><br><span class="line">2) <span class="string">&quot;validity:4245D5D28B2CDAB292623A01DD5D2C83.Tomcat2&quot;</span></span><br><span class="line">127.0.0.1:6379&gt; GET 4245D5D28B2CDAB292623A01DD5D2C83.Tomcat2</span><br><span class="line"><span class="string">&quot;\x00\x02\x00\\\x00\x00\x01sR\xf6\x8b@\x00\x00\x01sR\xf6\x8b@\x00\x00\a\b11\x00\</span></span><br><span class="line"><span class="string">x00\x01sR\xf6\x8b@\x00\x00\x01sR\xf6\x8bA\x00(4245D5D28B2CDAB292623A01DD5D2C83.T</span></span><br><span class="line"><span class="string">omcat2\x00\x00\x00\x00\x00\x00\x00\x00\x01\x00&quot;</span></span><br><span class="line">127.0.0.1:6379&gt;</span><br></pre></td></tr></table></figure>

<p><img src="../../../../images/SRE/day33/127.jpg" alt="127"><br><img src="../../../../images/SRE/day33/128.jpg" alt="128"><br><img src="../../../../images/SRE/day33/129.jpg" alt="129"></p>
<h4 id="模拟故障-2"><a href="#模拟故障-2" class="headerlink" title="模拟故障"></a>模拟故障</h4><h5 id="模拟tomcat故障-查看是否SessionID变化"><a href="#模拟tomcat故障-查看是否SessionID变化" class="headerlink" title="模拟tomcat故障,查看是否SessionID变化"></a>模拟tomcat故障,查看是否SessionID变化</h5><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@t2 ~]<span class="comment"># systemctl stop tomcat</span></span><br></pre></td></tr></table></figure>

<p>刷新页面,可以看到SessinID不变</p>
<p><img src="../../../../images/SRE/day33/130.jpg" alt="130"></p>
<h5 id="模拟Redis-故障"><a href="#模拟Redis-故障" class="headerlink" title="模拟Redis 故障"></a>模拟Redis 故障</h5><p>模拟Redis 故障,再刷新页面,可以看到SessionID不断变化,说明redis存在单点故障</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@t1 ~]<span class="comment"># systemctl start tomcat</span></span><br><span class="line">[root@redis ~]<span class="comment"># systemctl stop redis</span></span><br></pre></td></tr></table></figure>

<p><img src="../../../../images/SRE/day33/131.jpg" alt="131"><br><img src="../../../../images/SRE/day33/132.jpg" alt="132"></p>
<h2 id="使用-redisson-利用-redis-实现session共享"><a href="#使用-redisson-利用-redis-实现session共享" class="headerlink" title="使用 redisson 利用 redis 实现session共享"></a>使用 redisson 利用 redis 实现session共享</h2><p>Redisson是Redis官方推荐的Java版的Redis客户端。它提供的功能非常多，也非常强大 </p>
<p>redisson 是基于redis的扩展库，使得redis除了应用于缓存以外，还能做队列等数据结构，直接使用的分布式锁，以及事务调度器等。 </p>
<p>官网:</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://github.com/redisson/redisson</span><br></pre></td></tr></table></figure>

<p>tomcat 配置Redisson的文档链接</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://github.com/redisson/redisson/tree/master/redisson-tomcat</span><br></pre></td></tr></table></figure>

<p><img src="../../../../images/SRE/day33/133.jpg" alt="133"></p>
<p>相关jar包下载链接</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">https://repository.sonatype.org/service/local/artifact/maven/redirect?r=central-proxy&amp;g=org.redisson&amp;a=redisson-all&amp;v=3.16.1&amp;e=jar</span><br><span class="line">https://repository.sonatype.org/service/local/artifact/maven/redirect?r=central-proxy&amp;g=org.redisson&amp;a=redisson-tomcat-8&amp;v=3.16.1&amp;e=jar</span><br><span class="line">https://repository.sonatype.org/service/local/artifact/maven/redirect?r=central-proxy&amp;g=org.redisson&amp;a=redisson-tomcat-9&amp;v=3.16.1&amp;e=jar</span><br></pre></td></tr></table></figure>

<p>范例: 使用redisson实现session共享</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ~]<span class="comment"># vim /usr/local/tomcat/conf/context.xml</span></span><br><span class="line"><span class="comment">#倒数第一行前加下面内容</span></span><br><span class="line">&lt;Manager className=<span class="string">&quot;org.redisson.tomcat.RedissonSessionManager&quot;</span></span><br><span class="line">         configPath=<span class="string">&quot;<span class="variable">$&#123;catalina.base&#125;</span>/conf/redisson.conf&quot;</span> readMode=<span class="string">&quot;MEMORY&quot;</span></span><br><span class="line">         updateMode=<span class="string">&quot;DEFAULT&quot;</span>/&gt;</span><br><span class="line">&lt;/Context&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment">#创建下面文件内容</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># vim /usr/local/tomcat/conf/redisson.conf</span></span><br><span class="line">&#123;</span><br><span class="line">   <span class="string">&quot;singleServerConfig&quot;</span>:&#123;</span><br><span class="line">      <span class="string">&quot;idleConnectionTimeout&quot;</span>:10000,</span><br><span class="line">      <span class="string">&quot;connectTimeout&quot;</span>:10000,</span><br><span class="line">      <span class="string">&quot;timeout&quot;</span>:3000,</span><br><span class="line">      <span class="string">&quot;retryAttempts&quot;</span>:3,</span><br><span class="line">      <span class="string">&quot;retryInterval&quot;</span>:1500,</span><br><span class="line">      <span class="string">&quot;password&quot;</span>:null,</span><br><span class="line">      <span class="string">&quot;subscriptionsPerConnection&quot;</span>:5,</span><br><span class="line">      <span class="string">&quot;clientName&quot;</span>:null,</span><br><span class="line">      <span class="string">&quot;address&quot;</span>: <span class="string">&quot;redis://10.0.0.100:6379&quot;</span>,  <span class="comment">#指向redis服务器地址</span></span><br><span class="line">      <span class="string">&quot;subscriptionConnectionMinimumIdleSize&quot;</span>:1,</span><br><span class="line">      <span class="string">&quot;subscriptionConnectionPoolSize&quot;</span>:50,</span><br><span class="line">      <span class="string">&quot;connectionMinimumIdleSize&quot;</span>:32,</span><br><span class="line">      <span class="string">&quot;connectionPoolSize&quot;</span>:64,</span><br><span class="line">      <span class="string">&quot;database&quot;</span>:0,</span><br><span class="line">      <span class="string">&quot;dnsMonitoringInterval&quot;</span>:5000</span><br><span class="line">   &#125;,</span><br><span class="line">   <span class="string">&quot;threads&quot;</span>:0,</span><br><span class="line">   <span class="string">&quot;nettyThreads&quot;</span>:0,</span><br><span class="line">   <span class="string">&quot;codec&quot;</span>:&#123;</span><br><span class="line">      <span class="string">&quot;class&quot;</span>:<span class="string">&quot;org.redisson.codec.JsonJacksonCodec&quot;</span></span><br><span class="line">   &#125;,</span><br><span class="line">   <span class="string">&quot;transportMode&quot;</span>:<span class="string">&quot;NIO&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">#准备两个jar包到lib目录</span></span><br><span class="line"><span class="comment">#下载链接https://github.com/redisson/redisson/tree/master/redisson-tomcat</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># ls /usr/local/tomcat/lib/redisson-*</span></span><br><span class="line">/usr/local/tomcat/lib/redisson-all-3.16.1.jar  </span><br><span class="line">/usr/local/tomcat/lib/redisson-tomcat-9-3.16.1.jar</span><br><span class="line"></span><br><span class="line"><span class="comment">#重启tomcat生效</span></span><br><span class="line">systemctl restart tomcat</span><br><span class="line"></span><br><span class="line"><span class="comment">#准备测试页面</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># cat /usr/local/tomcat/webapps/ROOT/test.jsp </span></span><br><span class="line">&lt;%@ page import=<span class="string">&quot;java.util.*&quot;</span> %&gt;</span><br><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html lang=<span class="string">&quot;en&quot;</span>&gt;</span><br><span class="line">&lt;<span class="built_in">head</span>&gt;</span><br><span class="line">   &lt;meta charset=<span class="string">&quot;UTF-8&quot;</span>&gt;</span><br><span class="line">   &lt;title&gt;tomcat <span class="built_in">test</span>&lt;/title&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">&lt;h1&gt; Tomcat Website &lt;/h1&gt;</span><br><span class="line">&lt;div&gt;On &lt;%=request.getServerName() %&gt;&lt;/div&gt;</span><br><span class="line">&lt;div&gt;&lt;%=request.getLocalAddr() + <span class="string">&quot;:&quot;</span> + request.getLocalPort() %&gt;&lt;/div&gt;</span><br><span class="line">&lt;div&gt;SessionID = &lt;span style=<span class="string">&quot;color:blue&quot;</span>&gt;&lt;%=session.getId() %&gt;&lt;/span&gt;&lt;/div&gt;</span><br><span class="line">&lt;%=new Date()%&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment">#访问此页面</span></span><br><span class="line">[root@centos8 ~]<span class="comment">#curl 127.0.0.1:8080/test.jsp</span></span><br><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html lang=<span class="string">&quot;en&quot;</span>&gt;</span><br><span class="line">&lt;<span class="built_in">head</span>&gt;</span><br><span class="line">   &lt;meta charset=<span class="string">&quot;UTF-8&quot;</span>&gt;</span><br><span class="line">   &lt;title&gt;tomcat <span class="built_in">test</span>&lt;/title&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">&lt;h1&gt; Tomcat Website &lt;/h1&gt;</span><br><span class="line">&lt;div&gt;On  127.0.0.1&lt;/div&gt;</span><br><span class="line">&lt;div&gt;127.0.0.1:8080&lt;/div&gt;</span><br><span class="line">&lt;div&gt;SessionID = &lt;span </span><br><span class="line">style=<span class="string">&quot;color:blue&quot;</span>&gt;F14D14DF86AD76D55789269190950393&lt;/span&gt;&lt;/div&gt;</span><br><span class="line">Fri Aug 06 14:44:18 CST 2021</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment">#访问redis,查看生成数据</span></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment"># redis-cli </span></span><br><span class="line">127.0.0.1:6379&gt; keys *</span><br><span class="line">1) <span class="string">&quot;redisson:tomcat_session:4B5FC68977FC980E3C32564C357A2785&quot;</span></span><br><span class="line">s127.0.0.1:6379&gt; <span class="built_in">type</span> <span class="string">&quot;redisson:tomcat_session:4B5FC68977FC980E3C32564C357A2785&quot;</span></span><br><span class="line"><span class="built_in">hash</span></span><br><span class="line">127.0.0.1:6379&gt; hgetall redisson:tomcat_session:4B5FC68977FC980E3C32564C357A2785</span><br><span class="line">1) <span class="string">&quot;session:thisAccessedTime&quot;</span></span><br><span class="line">2) <span class="string">&quot;[\&quot;java.lang.Long\&quot;,1628231049422]&quot;</span></span><br><span class="line">3) <span class="string">&quot;session:isNew&quot;</span></span><br><span class="line">4) <span class="string">&quot;false&quot;</span></span><br><span class="line">5) <span class="string">&quot;session:lastAccessedTime&quot;</span></span><br><span class="line">6) <span class="string">&quot;[\&quot;java.lang.Long\&quot;,1628231049422]&quot;</span></span><br><span class="line">7) <span class="string">&quot;session:maxInactiveInterval&quot;</span></span><br><span class="line">8) <span class="string">&quot;1800&quot;</span></span><br><span class="line">9) <span class="string">&quot;session:isValid&quot;</span></span><br><span class="line">10) <span class="string">&quot;true&quot;</span></span><br><span class="line">11) <span class="string">&quot;session:creationTime&quot;</span></span><br><span class="line">12) <span class="string">&quot;[\&quot;java.lang.Long\&quot;,1628231049358]&quot;</span></span><br></pre></td></tr></table></figure>

<h2 id="利用-Tomcat-Clustering-Redis-Session-Manager-利用-redis-实现session共享"><a href="#利用-Tomcat-Clustering-Redis-Session-Manager-利用-redis-实现session共享" class="headerlink" title="利用 Tomcat Clustering Redis Session Manager 利用 redis 实现session共享"></a>利用 Tomcat Clustering Redis Session Manager 利用 redis 实现session共享</h2><p>Redis session manager 是一个插件。 它将会话存储到 Redis 中，以便在 Tomcat 服务器集群中轻松分发 HTTP 请求。</p>
<p>在这里，会话被实现为非粘性（意味着，每个请求都可以转到集群中的任何服务器，这与 Apache 提供的 Tomcat 集群设置不同。）</p>
<p>请求Sessions会立即存入Redis（Session属性必须是Serializable），供其他服务器使用。 当 tomcat 收到客户端的请求时，Sessions 直接从 Redis 加载。从而无需在负载均衡器中启用粘性会话(JSESSIONID)。</p>
<p>支持Redis默认、哨兵和集群模式，基于配置。</p>
<p>参考文档</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://github.com/ran-jit/tomcat-cluster-redis-session-manager</span><br></pre></td></tr></table></figure>

<p>范例：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#下载相关文件并解压缩</span></span><br><span class="line">wget https://github.com/ran-jit/tomcat-cluster-redis-session-manager/releases/download/3.0.1.1/tomcat-cluster-redis-session-manager.zip</span><br><span class="line">unzip /opt/tomcat-cluster-redis-session-manager.zip -d /opt</span><br><span class="line"></span><br><span class="line"><span class="comment">#复制jar包到tomcat/lib目录中</span></span><br><span class="line"><span class="built_in">cp</span> /opt/tomcat-cluster-redis-session-manager/lib/* /usr/local/tomcat/lib/</span><br><span class="line"><span class="built_in">chown</span> -R tomcat.tomcat /usr/local/tomcat/lib</span><br><span class="line"></span><br><span class="line"><span class="comment">#复制redis配置文件到tomcat/conf目录中</span></span><br><span class="line"><span class="built_in">cp</span> /opt/tomcat-cluster-redis-session-manager/conf/redis-data-cache.properties /usr/local/tomcat/conf/</span><br><span class="line"></span><br><span class="line"><span class="comment">#修改redis配置信息</span></span><br><span class="line">vim /usr/local/tomcat/conf/redis-data-cache.properties</span><br><span class="line"></span><br><span class="line"><span class="comment">#修改下面两行</span></span><br><span class="line">redis.hosts=10.0.0.100:6379 <span class="comment">#指向redis服务器地址</span></span><br><span class="line">redis.password=123456</span><br><span class="line"></span><br><span class="line"><span class="comment">#添加两行配置文件在 tomcat/conf/context.xml</span></span><br><span class="line">vim /usr/local/tomcat/conf/context.xml</span><br><span class="line"></span><br><span class="line"><span class="comment">#在最后一行前加下两行</span></span><br><span class="line">&lt;Valve className=<span class="string">&quot;tomcat.request.session.redis.SessionHandlerValve&quot;</span> /&gt;</span><br><span class="line">&lt;Manager className=<span class="string">&quot;tomcat.request.session.redis.SessionManager&quot;</span> /&gt;</span><br><span class="line">&lt;/Context&gt; <span class="comment">#此是最后一行</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#修改session过期时间为60m，默认30m,此步可选</span></span><br><span class="line">vim /usr/local/tomcat/conf/web.xml</span><br><span class="line">&lt;session-config&gt;</span><br><span class="line">&lt;session-timeout&gt;60&lt;/session-timeout&gt;</span><br><span class="line">&lt;/session-config&gt;</span><br><span class="line"> </span><br><span class="line"><span class="comment">#重启服务</span></span><br><span class="line">systemctl restart tomcat </span><br><span class="line"></span><br><span class="line"><span class="comment">#nginx配置反向代理和均衡负载</span></span><br><span class="line">vim /etc/nginx/conf.d/session.conf  </span><br><span class="line">upstream tomcat-server &#123;</span><br><span class="line">       server t1.magedu.org:8080;</span><br><span class="line">       server t2.magedu.org:8080;</span><br><span class="line">&#125;</span><br><span class="line">server &#123;</span><br><span class="line"> listen 80;</span><br><span class="line"> server_name www.magedu.org;</span><br><span class="line">       location / &#123;</span><br><span class="line">       proxy_pass http://tomcat-server;</span><br><span class="line">       proxy_set_header Host  <span class="variable">$http_host</span>;</span><br><span class="line">       &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">#tomcat测试页面</span></span><br><span class="line"><span class="built_in">cat</span> /data/webapps/ROOT/test.jsp </span><br><span class="line">&lt;%@ page import=<span class="string">&quot;java.util.*&quot;</span> %&gt;</span><br><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html lang=<span class="string">&quot;en&quot;</span>&gt;</span><br><span class="line">&lt;<span class="built_in">head</span>&gt;</span><br><span class="line">   &lt;meta charset=<span class="string">&quot;UTF-8&quot;</span>&gt;</span><br><span class="line">   &lt;title&gt;tomcat <span class="built_in">test</span>&lt;/title&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">&lt;h1&gt; Tomcat1 Website &lt;/h1&gt;</span><br><span class="line">&lt;div&gt;On &lt;%=request.getServerName() %&gt;&lt;/div&gt;</span><br><span class="line">&lt;div&gt;&lt;%=request.getLocalAddr() + <span class="string">&quot;:&quot;</span> + request.getLocalPort() %&gt;&lt;/div&gt;</span><br><span class="line">&lt;div&gt;SessionID = &lt;span style=<span class="string">&quot;color:blue&quot;</span>&gt;&lt;%=session.getId() %&gt;&lt;/span&gt;&lt;/div&gt;</span><br><span class="line">&lt;%=new Date()%&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure>

<h1 id="Tomcat-性能优化"><a href="#Tomcat-性能优化" class="headerlink" title="Tomcat 性能优化"></a>Tomcat 性能优化</h1><p>在目前流行的互联网架构中，Tomcat在目前的网络编程中是举足轻重的，由于Tomcat的运行依赖于 JVM，从虚拟机的角度把Tomcat的调整分为外部环境调优 JVM 和 Tomcat 自身调优两部分</p>
<h2 id="JVM组成"><a href="#JVM组成" class="headerlink" title="JVM组成"></a>JVM组成</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@t1 ~]<span class="comment"># java -version</span></span><br><span class="line">java version <span class="string">&quot;1.8.0_271&quot;</span></span><br><span class="line">Java(TM) SE Runtime Environment (build 1.8.0_271-b09)</span><br><span class="line">Java HotSpot(TM) 64-Bit Server VM (build 25.271-b09, mixed mode)</span><br></pre></td></tr></table></figure>

<h3 id="JVM组成-1"><a href="#JVM组成-1" class="headerlink" title="JVM组成"></a>JVM组成</h3><p><img src="../../../../images/SRE/day33/134.jpg" alt="134"></p>
<p><strong>JVM 组成部分</strong></p>
<ul>
<li>类加载子系统: 使用Java语言编写.java Source Code文件，通过javac编译成.class Byte Code文件。class loader类加载器将所需所有类加载到内存，必要时将类实例化成实例</li>
<li>运行时数据区: 最消耗内存的空间,需要优化</li>
<li>执行引擎: 包括JIT (JustInTimeCompiler)即时编译器, GC垃圾回收器</li>
<li>本地方法接口: 将本地方法栈通过JNI(Java Native Interface)调用Native Method Libraries, 比如:C,C++库等,扩展Java功能,融合不同的编程语言为Java所用</li>
</ul>
<p><strong>JVM运行时数据区域由下面部分构成：</strong></p>
<ul>
<li><p><strong>Method Area (线程共享)：</strong>方法区是所有线程共享的内存空间，存放已加载的类信息(构造方法,接口定义),常量(final),静态变量(static), 运行时常量池等。但实例变量存放在堆内存中. 从JDK8开始此空间由永久代改名为元空间</p>
</li>
<li><p><strong>heap (线程共享)：</strong>堆在虚拟机启动时创建,存放创建的所有对象信息。如果对象无法申请到可用内存将抛出OOM异常.堆是靠<strong>GC</strong>垃圾回收器管理的,通过-Xmx -Xms 指定最大堆和最小堆空间大小</p>
</li>
<li><p><strong>Java stack (线程私有)：</strong>Java栈是每个线程会分配一个栈，存放java中8大基本数据类型,对象引用, 实例的本地变量,方法参数和返回值等,基于FILO()（First In Last Out）,每个方法为一个栈帧</p>
</li>
<li><p><strong>Program Counter Register (线程私有)：</strong>PC寄存器就是一个指针,指向方法区中的方法字节码,每一个线程用于记录当前线程正在执行的字节码指令地址。由执行引擎读取下一条指令.因为线程需要切换，当一个线程被切换回来需要执行的时候，知道执行到哪里了</p>
</li>
<li><p><strong>Native Method stack (线程私有)：</strong>本地方法栈为本地方法执行构建的内存空间，存放本地方法 执行时的局部变量、操作数等。</p>
<p>所谓本地方法，使用native 关健字修饰的方法,比如:Thread.sleep方法. 简单的说是非Java实现的方法，例如操作系统的C编写的库提供的本地方法，Java调用这些本地方法接口执行。但是要注意，本地方法应该避免直接编程使用，因为Java可能跨平台使用，如果用了Windows API，换到了Linux平台部署就有了问题</p>
</li>
</ul>
<h3 id="虚拟机"><a href="#虚拟机" class="headerlink" title="虚拟机"></a>虚拟机</h3><p>目前Oracle官方使用的是HotSpot， 它最早由一家名为”Longview Technologies”公司设计，使用了很多优秀的设计理念和出色的性能，1997年该公司被SUN公司收购。后来随着JDK一起发布了HotSpot VM。目前HotSpot是最主要的 JVM。</p>
<p>安卓程序需要运行在JVM上，而安卓平台使用了Google自研的Java虚拟机——Dalvid，适合于内存、处理器能力有限系统。</p>
<h2 id="GC-Garbage-Collection-垃圾收集器"><a href="#GC-Garbage-Collection-垃圾收集器" class="headerlink" title="GC (Garbage Collection) 垃圾收集器"></a>GC (Garbage Collection) 垃圾收集器</h2><p><img src="../../../../images/SRE/day33/135.jpg" alt="135"></p>
<p>在堆内存中如果创建的对象不再使用,仍占用着内存,此时即为垃圾.需要即使进行垃圾回收,从而释放内存空间给其它对象使用</p>
<p>其实不同的开发语言都有垃圾回收问题,C,C++需要程序员人为回收,造成开发难度大,容易出错等问题,但执行效率高,而JAVA和Python中不需要程序员进行人为的回收垃圾,而由JVM或相关程序自动回收垃圾,减轻程序员的开发难度,但可能会造成执行效率低下</p>
<p>堆内存里面经常创建、销毁对象，内存也是被使用、被释放。如果不妥善处理，一个使用频繁的进程， 可能会出现虽然有足够的内存容量，但是无法分配出可用内存空间，因为没有连续成片的内存了，内存全是碎片化的空间。</p>
<p>所以需要有合适的垃圾回收机制,确保正常释放不再使用的内存空间,还需要保证内存空间尽可能的保持一定的连续</p>
<p>对于垃圾回收,需要解决三个问题</p>
<ul>
<li>哪些是垃圾要回收</li>
<li>怎么回收垃圾</li>
<li>什么时候回收垃圾</li>
</ul>
<h3 id="Garbage-垃圾确定方法"><a href="#Garbage-垃圾确定方法" class="headerlink" title="Garbage 垃圾确定方法"></a>Garbage 垃圾确定方法</h3><ul>
<li>引用计数: 每一个堆内对象上都与一个私有引用计数器，记录着被引用的次数，引用计数清零，该对象所占用堆内存就可以被回收。循环引用的对象都无法将引用计数归零，就无法清除。Python中即使用此种方式</li>
<li>根搜索(可达)算法 Root Searching</li>
</ul>
<p><img src="../../../../images/SRE/day33/136.jpg" alt="136"></p>
<h3 id="垃圾回收基本算法"><a href="#垃圾回收基本算法" class="headerlink" title="垃圾回收基本算法"></a>垃圾回收基本算法</h3><h4 id="标记-清除-Mark-Sweep"><a href="#标记-清除-Mark-Sweep" class="headerlink" title="标记-清除 Mark-Sweep"></a>标记-清除 Mark-Sweep</h4><p>分垃圾标记阶段和内存释放两个阶段。</p>
<ul>
<li>标记阶段，找到所有可访问对象打个标记。清理阶段，遍历整个堆</li>
<li>对未标记对象(即不再使用的对象)逐一进行清理。</li>
</ul>
<p><img src="../../../../images/SRE/day33/137.jpg" alt="137"></p>
<p><img src="../../../../images/SRE/day33/138.jpg" alt="138"></p>
<p><strong>特点：</strong> </p>
<p>优点：算法简单</p>
<p>缺点：标记-清除最大的问题会造成内存碎片,但是不浪费空间,效率较高(如果对象较多时,逐一删除效率也会受到影响)</p>
<h4 id="标记-压缩-压实-Mark-Compact"><a href="#标记-压缩-压实-Mark-Compact" class="headerlink" title="标记-压缩 (压实)Mark-Compact"></a>标记-压缩 (压实)Mark-Compact</h4><p>分垃圾标记阶段和内存整理两个阶段。 </p>
<ul>
<li>标记阶段，找到所有可访问对象打个标记。</li>
<li>内存清理阶段时，整理时将对象向内存一端移动，整理后存活对象连续的集中在内存一端。</li>
</ul>
<p><img src="../../../../images/SRE/day33/139.jpg" alt="139"></p>
<p>特点： </p>
<p>标记-压缩算法好处是整理后内存空间连续分配，有大段的连续内存可分配，没有内存碎片。</p>
<p>缺点是内存整理过程有消耗,<strong>效率相对低下</strong></p>
<h4 id="复制-Copying"><a href="#复制-Copying" class="headerlink" title="复制 Copying"></a>复制 Copying</h4><p><img src="../../../../images/SRE/day33/140.jpg" alt="140"></p>
<p>先将可用内存分为大小相同两块区域A和B，每次只用其中一块，比如A。当A用完后，则将A中存活的对象复制到B。复制到B的时候连续的使用内存，最后将A一次性清除干净。</p>
<p><strong>特点</strong></p>
<p>好处是没有碎片，复制过程中保证对象使用连续空间,且一次性清除所有垃圾,所以即使对象很多，收回效率也很高</p>
<p>缺点是比较<strong>浪费内存</strong>，只能使用原来一半内存，因为内存对半划分了，复制过程毕竟也是有代价。</p>
<h4 id="多种算法总结"><a href="#多种算法总结" class="headerlink" title="多种算法总结"></a>多种算法总结</h4><p>没有最好的算法,在不同场景选择最合适的算法</p>
<ul>
<li>效率: 复制算法&gt;标记清除算法&gt; 标记压缩算法</li>
<li>内存整齐度: 复制算法=标记压缩算法&gt; 标记清除算法</li>
<li>内存利用率: 标记压缩算法=标记清除算法&gt;复制算法</li>
</ul>
<h4 id="STW"><a href="#STW" class="headerlink" title="STW"></a>STW</h4><p>对于大多数垃圾回收算法而言，GC线程工作时，停止所有工作的线程，称为Stop The World。GC 完成时，恢复其他工作线程运行。这也是JVM运行中最头疼的问题。</p>
<h3 id="分代堆内存GC策略"><a href="#分代堆内存GC策略" class="headerlink" title="分代堆内存GC策略"></a>分代堆内存GC策略</h3><p>上述垃圾回收算法都有优缺点，能不能对不同数据进行区分管理，不同分区对数据实施不同回收策略，分而治之。</p>
<h4 id="堆内存分代"><a href="#堆内存分代" class="headerlink" title="堆内存分代"></a>堆内存分代</h4><p><strong>将heap内存空间分为三个不同类别: 年轻代、老年代、持久代</strong></p>
<p><img src="../../../../images/SRE/day33/141.jpg" alt="141"></p>
<p><img src="../../../../images/SRE/day33/142.jpg" alt="142"><br><img src="../../../../images/SRE/day33/143.jpg" alt="143"></p>
<p><strong>Heap堆内存分为</strong></p>
<ul>
<li>年轻代Young：Young Generation<ul>
<li>伊甸园区eden: 只有一个,刚刚创建的对象</li>
<li>幸存(存活)区Servivor Space：有2个幸存区，一个是from区，一个是to区。大小相等、地位相同、可互换。<ul>
<li>from 指的是本次复制数据的源区</li>
<li>to 指的是本次复制数据的目标区 </li>
</ul>
</li>
</ul>
</li>
<li>老年代Tenured：Old Generation, 长时间存活的对象</li>
</ul>
<p><strong>默认空间大小比例:</strong></p>
<p>默认JVM试图分配最大内存的总内存的1/4,初始化默认总内存为总内存的1/64,年青代中heap的1/3，老年代占2/3</p>
<p><img src="../../../../images/SRE/day33/144.jpg" alt="144"></p>
<p><strong>永久代</strong>：JDK1.7之前使用, 即Method Area方法区,保存JVM自身的类和方法,存储JAVA运行时的环境信息, JDK1.8后 改名为 MetaSpace,此空间不存在垃圾回收,关闭JVM会释放此区域内存,此空间物理上不属于heap内存,但逻辑上存在于heap内存</p>
<ul>
<li>永久代必须指定大小限制,字符串常量JDK1.7存放在永久代,1.8后存放在heap中</li>
<li>MetaSpace 可以设置,也可不设置,无上限 </li>
</ul>
<p><strong>规律: 一般情况99%的对象都是临时对象</strong> </p>
<p>范例: 在tomcat 状态页可以看到以下的内存分代</p>
<p><img src="../../../../images/SRE/day33/145.jpg" alt="145"></p>
<p><strong>范例: 查看JVM内存分配情况</strong></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ~]<span class="comment"># cat Heap.java</span></span><br><span class="line">public class Heap &#123;</span><br><span class="line">   public static void main(String[] args)&#123;</span><br><span class="line">       //返回JVM试图使用的最大内存,字节单位</span><br><span class="line">       long max = Runtime.getRuntime().maxMemory();</span><br><span class="line">       //返回JVM初始化总内存</span><br><span class="line">       long total = Runtime.getRuntime().totalMemory();</span><br><span class="line">       System.out.println(<span class="string">&quot;max=&quot;</span>+max+<span class="string">&quot;字节\t&quot;</span>+(max/(double)1024/1024)+<span class="string">&quot;MB&quot;</span>);</span><br><span class="line">       System.out.println(<span class="string">&quot;total=&quot;</span>+total+<span class="string">&quot;字节\t&quot;</span>+</span><br><span class="line">(total/(double)1024/1024)+<span class="string">&quot;MB&quot;</span>);</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">[root@centos8 ~]<span class="comment"># javac Heap.java</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># java -classpath . Heap</span></span><br><span class="line">max=243269632字节 232.0MB</span><br><span class="line">total=16252928字节 15.5MB</span><br><span class="line"></span><br><span class="line">[root@centos8 ~]<span class="comment"># java -XX:+PrintGCDetails Heap</span></span><br><span class="line">max=243269632字节 232.0MB</span><br><span class="line">total=16252928字节 15.5MB</span><br><span class="line">Heap</span><br><span class="line"> def new generation   total 4928K, used 530K [0x00000000f1000000, </span><br><span class="line">0x00000000f1550000, 0x00000000f6000000)</span><br><span class="line"> eden space 4416K,  12% used [0x00000000f1000000, 0x00000000f1084a60, </span><br><span class="line">0x00000000f1450000)</span><br><span class="line"> from space 512K,   0% used [0x00000000f1450000, 0x00000000f1450000, </span><br><span class="line">0x00000000f14d0000)</span><br><span class="line"> to   space 512K,   0% used [0x00000000f14d0000, 0x00000000f14d0000, </span><br><span class="line">0x00000000f1550000)</span><br><span class="line"> tenured generation   total 10944K, used 0K [0x00000000f6000000, </span><br><span class="line">0x00000000f6ab0000, 0x0000000100000000)</span><br><span class="line">   the space 10944K,   0% used [0x00000000f6000000, 0x00000000f6000000, </span><br><span class="line">0x00000000f6000200, 0x00000000f6ab0000)</span><br><span class="line"> Metaspace       used 2525K, capacity 4486K, committed 4864K, reserved 1056768K</span><br><span class="line"> class space   used 269K, capacity 386K, committed 512K, reserved 1048576K</span><br><span class="line">  </span><br><span class="line">[root@centos8 ~]<span class="comment"># echo &quot;scale=2;(4928+10944)/1024&quot; |bc</span></span><br><span class="line">15.50</span><br><span class="line"></span><br><span class="line"><span class="comment">#说明年轻代+老年代占用了所有heap空间, Metaspace实际不占heap空间,逻辑上存在于Heap</span></span><br></pre></td></tr></table></figure>

<h4 id="年轻代回收-Minor-GC"><a href="#年轻代回收-Minor-GC" class="headerlink" title="年轻代回收 Minor GC"></a>年轻代回收 Minor GC</h4><ol>
<li>起始时，所有新建对象(特大对象直接进入老年代)都出生在eden，当eden满了，<strong>启动GC</strong>。这个称为<strong>Young GC</strong> 或者 <strong>Minor GC</strong>。</li>
<li>先<strong>标记</strong>eden存活对象，然后将存活对象<strong>复制</strong>到s0（假设本次是s0，也可以是s1，它们可以调换），eden剩余所有空间都清空。<strong>GC完成</strong>。</li>
<li>继续新建对象，当eden再次满了，<strong>启动GC</strong>。</li>
<li>先同时<strong>标记</strong>eden和s0中存活对象，然后将存活对象<strong>复制</strong>到s1。将eden和s0清空,此次<strong>GC完成</strong> </li>
<li>继续新建对象，当eden满了，<strong>启动GC</strong>。</li>
<li>先<strong>标记</strong>eden和s1中存活对象，然后将存活对象<strong>复制</strong>到s0。将eden和s1清空,此次<strong>GC完成</strong></li>
</ol>
<p>以后就重复上面的步骤。 </p>
<p>通常场景下,大多数对象都不会存活很久，而且创建活动非常多，新生代就需要频繁垃圾回收。</p>
<p>但是，如果一个对象一直存活，它最后就在from、to来回复制，如果from区中对象复制次数达到阈值(默认15次,CMS为6次,可通过java的选项 <strong>-XX:MaxTenuringThreshold=N</strong> 指定)，就直接复制到老年代。</p>
<h4 id="老年代回收-Major-GC"><a href="#老年代回收-Major-GC" class="headerlink" title="老年代回收 Major GC"></a>老年代回收 Major GC</h4><p>进入老年代的数据较少，所以老年代区被占满的速度较慢，所以垃圾回收也不频繁。</p>
<p>如果老年代也满了,会触发老年代GC,称为Old GC或者 Major GC。</p>
<p>由于老年代对象一般来说存活次数较长，所以较常采用标记-压缩算法。 </p>
<p>当老年代满时,会触发 Full GC,即对所有”代”的内存进行垃圾回收</p>
<p>Minor GC比较频繁，Major GC较少。但一般Major GC时，由于老年代对象也可以引用新生代对象，所以先进行一次Minor GC，然后在Major GC会提高效率。可以认为回收老年代的时候完成了一次Full GC。</p>
<p>所以可以认为 MajorGC = FullGC</p>
<h4 id="GC-触发条件"><a href="#GC-触发条件" class="headerlink" title="GC 触发条件"></a>GC 触发条件</h4><p><img src="../../../../images/SRE/day33/146.jpg" alt="146"></p>
<p>Minor GC 触发条件：当eden区满了触发</p>
<p>Full GC 触发条件：</p>
<ul>
<li>老年代满了</li>
<li>System.gc()手动调用。不推荐 </li>
</ul>
<p>年轻代: </p>
<ul>
<li>存活时长低</li>
<li>适合复制算法</li>
</ul>
<p>老年代:</p>
<ul>
<li>区域大,存活时长高</li>
<li>适合标记压缩算法</li>
</ul>
<h3 id="java-内存调整相关参数"><a href="#java-内存调整相关参数" class="headerlink" title="java 内存调整相关参数"></a>java 内存调整相关参数</h3><h4 id="JVM-内存常用相关参数"><a href="#JVM-内存常用相关参数" class="headerlink" title="JVM 内存常用相关参数"></a>JVM 内存常用相关参数</h4><p>Java 命令行参考文档: <a target="_blank" rel="noopener" href="https://docs.oracle.com/javase/8/docs/technotes/tools/unix/java.html">https://docs.oracle.com/javase/8/docs/technotes/tools/unix/java.html</a></p>
<p><img src="../../../../images/SRE/day33/147.jpg" alt="147"></p>
<p>帮助：man java </p>
<p><strong>选项分类</strong> </p>
<ul>
<li>-选项名称 此为标准选项,所有HotSpot都支持</li>
<li>-X选项名称 此为稳定的非标准选项 </li>
<li>-XX:选项名称 非标准的不稳定选项，下一个版本可能会取消</li>
</ul>
<table>
<thead>
<tr>
<th>参数</th>
<th>说明</th>
<th>举例</th>
</tr>
</thead>
<tbody><tr>
<td>-Xms</td>
<td>设置应用程序初始使用的堆内存大小（年轻代+老年代）</td>
<td>-Xms2g</td>
</tr>
<tr>
<td>-Xmx</td>
<td>设置应用程序能获得的最大堆内存<br />早期JVM不建议超过32G，内存管理效率下降</td>
<td>-Xmx4g</td>
</tr>
<tr>
<td>-XX:NewSize</td>
<td>设置初始新生代大小</td>
<td>-XX:NewSize=128m</td>
</tr>
<tr>
<td>-XX:MaxNewSize</td>
<td>设置最大新生代内存空间</td>
<td>-XX:MaxNewSize=256m</td>
</tr>
<tr>
<td>-Xmnsize</td>
<td>同时设置-XX:NewSize 和 -XX:MaxNewSize，代替两者</td>
<td>-Xmn1g</td>
</tr>
<tr>
<td>-XX:NewRatio</td>
<td>以比例方式设置新生代和老年代</td>
<td>-XX:NewRatio=2<br />即：new:old=1:2</td>
</tr>
<tr>
<td>-XX:SurvivorRatio</td>
<td>以比例方式设置eden和survivor(S0或S1)</td>
<td>-XX:SurvivorRatio=6<br />即：Eden:S0:S1=6:1:1</td>
</tr>
<tr>
<td>-Xss</td>
<td>设置每个线程私有的栈空间大小,依据具体线程大小和数量</td>
<td>-Xss256k</td>
</tr>
</tbody></table>
<p>范例: 查看java的选项帮助</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#查看java命令标准选项</span></span><br><span class="line">[root@centos ~]<span class="comment"># java </span></span><br><span class="line">Usage: java [-options] class [args...]</span><br><span class="line">           (to execute a class)</span><br><span class="line">   or java [-options] -jar jarfile [args...]</span><br><span class="line">           (to execute a jar file)</span><br><span class="line"><span class="built_in">where</span> options include:</span><br><span class="line">    -d32 use a 32-bit data model <span class="keyword">if</span> available</span><br><span class="line">    -d64 use a 64-bit data model <span class="keyword">if</span> available</span><br><span class="line">    -server to select the <span class="string">&quot;server&quot;</span> VM</span><br><span class="line">                 The default VM is server.</span><br><span class="line">······</span><br><span class="line">    -X           <span class="built_in">print</span> <span class="built_in">help</span> on non-standard options  <span class="comment">#非标准选项</span></span><br><span class="line"></span><br><span class="line">······</span><br><span class="line"></span><br><span class="line"><span class="comment">#查看java的非标准选项</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># java -X</span></span><br><span class="line">    -Xmixed           mixed mode execution (default)</span><br><span class="line">    -Xint             interpreted mode execution only</span><br><span class="line">    -Xbootclasspath:&lt;directories and zip/jar files separated by :&gt;</span><br><span class="line">                      <span class="built_in">set</span> search path <span class="keyword">for</span> bootstrap classes and resources</span><br><span class="line">    -Xbootclasspath/a:&lt;directories and zip/jar files separated by :&gt;</span><br><span class="line">                     append to end of bootstrap class path</span><br><span class="line">    -Xbootclasspath/p:&lt;directories and zip/jar files separated by :&gt;</span><br><span class="line">                     prepend <span class="keyword">in</span> front of bootstrap class path</span><br><span class="line">    -Xdiag           show additional diagnostic messages</span><br><span class="line">    -Xnoclassgc       <span class="built_in">disable</span> class garbage collection</span><br><span class="line">    -Xincgc           <span class="built_in">enable</span> incremental garbage collection</span><br><span class="line">    -Xloggc:&lt;file&gt;   <span class="built_in">log</span> GC status to a file with time stamps</span><br><span class="line">    -Xbatch           <span class="built_in">disable</span> background compilation</span><br><span class="line">    -Xms&lt;size&gt;        <span class="built_in">set</span> initial Java heap size</span><br><span class="line">    -Xmx&lt;size&gt;        <span class="built_in">set</span> maximum Java heap size</span><br><span class="line">    -Xss&lt;size&gt;        <span class="built_in">set</span> java thread stack size</span><br><span class="line">    -Xprof           output cpu profiling data</span><br><span class="line">    -Xfuture         <span class="built_in">enable</span> strictest checks, anticipating future default</span><br><span class="line">    -Xrs             reduce use of OS signals by Java/VM (see documentation)</span><br><span class="line">    -Xcheck:jni       perform additional checks <span class="keyword">for</span> JNI <span class="built_in">functions</span></span><br><span class="line">    -Xshare:off       <span class="keyword">do</span> not attempt to use shared class data</span><br><span class="line">    -Xshare:auto     use shared class data <span class="keyword">if</span> possible (default)</span><br><span class="line">    -Xshare:on       require using shared class data, otherwise fail.</span><br><span class="line">    -XshowSettings   show all settings and <span class="built_in">continue</span></span><br><span class="line">    -XshowSettings:all</span><br><span class="line">                     show all settings and <span class="built_in">continue</span></span><br><span class="line">    -XshowSettings:vm show all vm related settings and <span class="built_in">continue</span></span><br><span class="line">    -XshowSettings:properties</span><br><span class="line">                     show all property settings and <span class="built_in">continue</span></span><br><span class="line">    -XshowSettings:locale</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#查看所有不稳定选项的当前生效值</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># java -XX:+PrintFlagsFinal</span></span><br><span class="line">[Global flags]</span><br><span class="line">     intx ActiveProcessorCount                     = -1             &#123;product&#125;</span><br><span class="line">   uintx AdaptiveSizeDecrementScaleFactor          = 4              &#123;product&#125;</span><br><span class="line">   uintx AdaptiveSizeMajorGCDecayTimeScale         = 10             &#123;product&#125;</span><br><span class="line">   uintx AdaptiveSizePausePolicy                   = 0              &#123;product&#125;</span><br><span class="line">   uintx AdaptiveSizePolicyCollectionCostMargin    = 50             &#123;product&#125;</span><br><span class="line">   uintx AdaptiveSizePolicyInitializingSteps       = 20             &#123;product&#125;</span><br><span class="line">   uintx AdaptiveSizePolicyOutputInterval          = 0              &#123;product&#125;</span><br><span class="line">   uintx AdaptiveSizePolicyWeight                  = 10             &#123;product&#125;</span><br><span class="line">   uintx AdaptiveSizeThroughPutPolicy              = 0              &#123;product&#125;</span><br><span class="line"> .......</span><br><span class="line"> </span><br><span class="line"><span class="comment">#查看所有不稳定选项的默认值</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># java -XX:+PrintFlagsInitial</span></span><br><span class="line">[Global flags]</span><br><span class="line">     intx ActiveProcessorCount                     = -1             &#123;product&#125;</span><br><span class="line">   uintx AdaptiveSizeDecrementScaleFactor          = 4              &#123;product&#125;</span><br><span class="line">   uintx AdaptiveSizeMajorGCDecayTimeScale         = 10             &#123;product&#125;</span><br><span class="line">   uintx AdaptiveSizePausePolicy                   = 0              &#123;product&#125;</span><br><span class="line">   uintx AdaptiveSizePolicyCollectionCostMargin    = 50             &#123;product&#125;</span><br><span class="line">   uintx AdaptiveSizePolicyInitializingSteps       = 20             &#123;product&#125;</span><br><span class="line">.......</span><br><span class="line"></span><br><span class="line"><span class="comment">#查看当前命令行的使用的选项设置</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># java -XX:+PrintCommandLineFlags</span></span><br><span class="line">-XX:InitialHeapSize=15598528 -XX:MaxHeapSize=249576448 -XX:+PrintCommandLineFlags -XX:+UseCompressedClassPointers -XX:+UseCompressedOops </span><br><span class="line">-XX:+UseParallelGC</span><br><span class="line"></span><br><span class="line"><span class="comment">#上面的-XX:+UseParallelGC 说明当前使用Parallel Scavenge + Parallel Old</span></span><br></pre></td></tr></table></figure>

<p>范例: 查看和指定 JVM 内存分配</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#默认JVM试图分配最大内存的总内存的1/4,初始化默认总内存为总内存的1/64</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># cat Heap.java</span></span><br><span class="line">public class Heap &#123;</span><br><span class="line">   public static void main(String[] args)&#123;</span><br><span class="line">       //返回JVM试图使用的最大内存,字节单位</span><br><span class="line">       long max = Runtime.getRuntime().maxMemory();</span><br><span class="line">       //返回JVM初始化总内存</span><br><span class="line">       long total = Runtime.getRuntime().totalMemory();</span><br><span class="line">       System.out.println(<span class="string">&quot;max=&quot;</span>+max+<span class="string">&quot;字节\t&quot;</span>+(max/(double)1024/1024)+<span class="string">&quot;MB&quot;</span>);</span><br><span class="line">       System.out.println(<span class="string">&quot;total=&quot;</span>+total+<span class="string">&quot;字节\t&quot;</span>+</span><br><span class="line">(total/(double)1024/1024)+<span class="string">&quot;MB&quot;</span>);</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">#编译生成class文件</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># javac Heap.java</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#通过$CLASSPATH指定类文件路径,否则无法找到类,也可以通过 java -cp /path指定类路径</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># echo $CLASSPATH</span></span><br><span class="line">/usr/local/jdk/lib/:/usr/local/jdk/jre/lib/</span><br><span class="line"></span><br><span class="line">[root@centos8 ~]<span class="comment"># cp Heap.class /usr/local/jdk/lib</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#查看当前内存默认值</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># java -XX:+PrintGCDetails Heap</span></span><br><span class="line">max=243269632字节 232.0MB</span><br><span class="line">total=16252928字节 15.5MB</span><br><span class="line">Heap</span><br><span class="line"> def new generation   total 4928K, used 530K [0x00000000f1000000, </span><br><span class="line">0x00000000f1550000, 0x00000000f6000000)</span><br><span class="line"> eden space 4416K,  12% used [0x00000000f1000000, 0x00000000f1084a60, </span><br><span class="line">0x00000000f1450000)</span><br><span class="line"> from space 512K,   0% used [0x00000000f1450000, 0x00000000f1450000, </span><br><span class="line">0x00000000f14d0000)</span><br><span class="line"> to   space 512K,   0% used [0x00000000f14d0000, 0x00000000f14d0000, </span><br><span class="line">0x00000000f1550000)</span><br><span class="line"> tenured generation   total 10944K, used 0K [0x00000000f6000000, </span><br><span class="line">0x00000000f6ab0000, 0x0000000100000000)</span><br><span class="line">   the space 10944K,   0% used [0x00000000f6000000, 0x00000000f6000000, </span><br><span class="line">0x00000000f6000200, 0x00000000f6ab0000)</span><br><span class="line"> Metaspace       used 2525K, capacity 4486K, committed 4864K, reserved 1056768K</span><br><span class="line"> class space    used 269K, capacity 386K, committed 512K, reserved 1048576K</span><br><span class="line"> </span><br><span class="line"><span class="comment">#指定内存空间</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># java -Xms1024m -Xmx1024m -XX:+PrintGCDetails Heap</span></span><br><span class="line">max=1037959168字节 989.875MB</span><br><span class="line">total=1037959168字节 989.875MB</span><br><span class="line">Heap</span><br><span class="line"> def new generation   total 314560K, used 11185K [0x00000000c0000000, </span><br><span class="line">0x00000000d5550000, 0x00000000d5550000)</span><br><span class="line"> eden space 279616K,   4% used [0x00000000c0000000, 0x00000000c0aec408, </span><br><span class="line">0x00000000d1110000)</span><br><span class="line"> from space 34944K,   0% used [0x00000000d1110000, 0x00000000d1110000, </span><br><span class="line">0x00000000d3330000)</span><br><span class="line"> to   space 34944K,   0% used [0x00000000d3330000, 0x00000000d3330000, </span><br><span class="line">0x00000000d5550000)</span><br><span class="line"> tenured generation   total 699072K, used 0K [0x00000000d5550000, </span><br><span class="line">0x0000000100000000, 0x0000000100000000)</span><br><span class="line">   the space 699072K,   0% used [0x00000000d5550000, 0x00000000d5550000, </span><br><span class="line">0x00000000d5550200, 0x0000000100000000)</span><br><span class="line"> Metaspace       used 2525K, capacity 4486K, committed 4864K, reserved 1056768K</span><br><span class="line"> class space   used 269K, capacity 386K, committed 512K, reserved 1048576K</span><br><span class="line">  </span><br><span class="line"><span class="comment">#以下计算结果和max一样,说明Metaspace逻辑存在,但物理上并不属于heap空间</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># echo &#x27;(314560+699072)*1024&#x27;|bc</span></span><br><span class="line">1037959168</span><br></pre></td></tr></table></figure>

<p>范例: 查看 OOM</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ~]<span class="comment">#cat HeapOom2.java</span></span><br><span class="line">import java. util. Random;</span><br><span class="line">public class HeapOom2 &#123;</span><br><span class="line">    public static void main(String[] args) &#123;</span><br><span class="line">        String str = <span class="string">&quot;I am wangxiaochun&quot;</span>;</span><br><span class="line">        <span class="keyword">while</span> (<span class="literal">true</span>)&#123;</span><br><span class="line">            str += str + new Random().nextInt(88888888); //生成0到88888888之间的随机数字</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">[root@centos8 ~]<span class="comment"># javac -cp . HeapOom2.java</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># java -Xms100m -Xmx100m -XX:+PrintGCDetails -cp . HeapOom2</span></span><br></pre></td></tr></table></figure>

<h4 id="JDK-工具监控使用情况"><a href="#JDK-工具监控使用情况" class="headerlink" title="JDK 工具监控使用情况"></a>JDK 工具监控使用情况</h4><h5 id="案例1-jvisualvm工具"><a href="#案例1-jvisualvm工具" class="headerlink" title="案例1: jvisualvm工具"></a>案例1: jvisualvm工具</h5><p>范例: 指定参数运行Java程序</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#java -cp . -Xms512m -Xmx1g HelloWorld</span></span><br></pre></td></tr></table></figure>

<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#测试用java程序</span></span><br><span class="line">javac HelloWorld.java</span><br><span class="line">java -classpath . -Xms512m -Xmx1g HelloWorld</span><br><span class="line"></span><br><span class="line">[root@tomcat ~]<span class="comment"># cat HelloWorld.java</span></span><br><span class="line">public class HelloWorld extends Thread &#123;</span><br><span class="line">    public static void main(String[] args) &#123;</span><br><span class="line">        try &#123;</span><br><span class="line">            <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">                Thread.<span class="built_in">sleep</span>(2000);</span><br><span class="line">                System.out.println(<span class="string">&quot;hello magedu&quot;</span>);</span><br><span class="line">            &#125;            </span><br><span class="line">        &#125; catch (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">#编译为字节码.class文件</span></span><br><span class="line">[root@tomcat ~]<span class="comment"># javac HelloWorld.java</span></span><br><span class="line">[root@tomcat ~]<span class="comment"># ll HelloWorld.class </span></span><br><span class="line">-rw-r--r-- 1 root root 590 Jul 13 16:31 HelloWorld.class</span><br><span class="line"></span><br><span class="line">[root@tomcat ~]<span class="comment"># file HelloWorld.class </span></span><br><span class="line">HelloWorld.class: compiled Java class data, version 52.0 (Java 1.8)</span><br><span class="line"></span><br><span class="line"><span class="comment">#指定路径运行class文件</span></span><br><span class="line">[root@tomcat ~]<span class="comment"># java -cp . -Xms512m -Xmx1g HelloWorld</span></span><br><span class="line">hello magedu</span><br><span class="line">hello magedu</span><br><span class="line">hello magedu</span><br><span class="line"></span><br><span class="line"><span class="comment">#或者用下面方法指定CLASS文件的搜索路径</span></span><br><span class="line">[root@tomcat ~]<span class="comment"># echo $CLASSPATH</span></span><br><span class="line">/usr/local/jdk/lib/:/usr/local/jdk/jre/lib/</span><br><span class="line"></span><br><span class="line">[root@tomcat ~]<span class="comment"># mv HelloWorld.class /usr/local/jdk/lib/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#分别执行多次观察</span></span><br><span class="line">[root@tomcat ~]<span class="comment"># java HelloWorld </span></span><br><span class="line">[root@tomcat ~]<span class="comment"># java -Xms256m -Xmx512m HelloWorld </span></span><br><span class="line">[root@tomcat ~]<span class="comment"># java -Xms128m -Xmx512m -XX:NewSize=64m -XX:MaxNewSize=200m </span></span><br><span class="line">HelloWorld </span><br><span class="line">hello magedu</span><br><span class="line"></span><br><span class="line">[root@tomcat ~]<span class="comment"># jps</span></span><br><span class="line">21299 Main</span><br><span class="line">21418 Jps</span><br><span class="line">21407 HelloWorld</span><br><span class="line"></span><br><span class="line"><span class="comment">#将Linux的图形工具显示到windows桌面</span></span><br><span class="line"><span class="comment">#方法1</span></span><br><span class="line"><span class="comment">#注意:先在windows上开启Xwindows Server，如Xmanager</span></span><br><span class="line">[root@tomcat ~]<span class="comment"># export DISPLAY=10.0.0.1:0.0</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#方法2:使用 MobaXterm 连接</span></span><br><span class="line">[root@tomcat ~]<span class="comment"># yum -y install xorg-x11-xauth xorg-x11-fonts-* xorg-x11-fontutils xorg-x11-fonts-Type1 </span></span><br><span class="line">[root@tomcat ~]<span class="comment"># exit</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#运行图形工具</span></span><br><span class="line">[roottomcat ~]<span class="comment"># which jvisualvm </span></span><br><span class="line">/usr/local/jdk/bin/jvisualvm</span><br><span class="line">[root@tomcat ~]<span class="comment"># jvisualvm</span></span><br></pre></td></tr></table></figure>

<p><img src="../../../../images/SRE/day33/148.jpg" alt="148"><br><img src="../../../../images/SRE/day33/149.jpg" alt="149"><br><img src="../../../../images/SRE/day33/150.jpg" alt="150"></p>
<h5 id="案例2-使用-jvisualvm的-Visual-GC-插件"><a href="#案例2-使用-jvisualvm的-Visual-GC-插件" class="headerlink" title="案例2: 使用 jvisualvm的 Visual GC 插件"></a>案例2: 使用 jvisualvm的 Visual GC 插件</h5><p>范例: 使用 jvisualvm的 Visual GC 插件 观察 java程序的OOM</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="meta">@centos8</span> ~]#cat HeapOom.java </span><br><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HeapOom</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        List&lt;<span class="type">byte</span>[]&gt; list =<span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;<span class="type">byte</span>[]&gt;();</span><br><span class="line">        <span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">        <span class="type">boolean</span> <span class="variable">flag</span> <span class="operator">=</span> <span class="literal">true</span>;</span><br><span class="line">        <span class="keyword">while</span>(flag)&#123;</span><br><span class="line">            <span class="keyword">try</span>&#123;</span><br><span class="line">                i++;</span><br><span class="line">                list.add(<span class="keyword">new</span> <span class="title class_">byte</span>[<span class="number">1024</span>* <span class="number">1024</span>]);<span class="comment">//每次增加一个1M大小的数组对象</span></span><br><span class="line">                Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span>(Throwable e)&#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">                flag =<span class="literal">false</span>;</span><br><span class="line">                System.out.println(<span class="string">&quot;count=&quot;</span>+i);<span class="comment">//记录运行的次数</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>安装VirtualGC插件</p>
<p><img src="../../../../images/SRE/day33/151.jpg" alt="151"><br><img src="../../../../images/SRE/day33/152.jpg" alt="152"><br><img src="../../../../images/SRE/day33/153.jpg" alt="153"><br><img src="../../../../images/SRE/day33/154.jpg" alt="154"><br><img src="../../../../images/SRE/day33/155.jpg" alt="155"><br><img src="../../../../images/SRE/day33/156.jpg" alt="156"><br><img src="../../../../images/SRE/day33/157.jpg" alt="157"><br><img src="../../../../images/SRE/day33/158.jpg" alt="158"></p>
<p>运行上面的OOM程序,重新运行jvisualm, 可以看到多了一下VisualGC页标,下面的图示</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ~]<span class="comment"># java -Xms100m -Xmx200m HeapOom</span></span><br></pre></td></tr></table></figure>

<p><img src="../../../../images/SRE/day33/159.jpg" alt="159"></p>
<p>当OOM时退出JAVA程序时,会显示下面图示</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ~]<span class="comment"># java HeapOom </span></span><br><span class="line">java.lang.OutOfMemoryError: Java heap space</span><br><span class="line">    at HeapOom.main(HeapOom.java:12)</span><br><span class="line">count=229</span><br></pre></td></tr></table></figure>

<p><img src="../../../../images/SRE/day33/160.jpg" alt="160"><br><img src="../../../../images/SRE/day33/161.jpg" alt="161"></p>
<h5 id="Jprofiler定位OOM的问题原因"><a href="#Jprofiler定位OOM的问题原因" class="headerlink" title="Jprofiler定位OOM的问题原因"></a>Jprofiler定位OOM的问题原因</h5><p>JProfiler是一款功能强大的Java开发分析工具，它可以快速的帮助用户分析出存在的错误，软件还可对需要的显示类进行标记，包括了内存的分配情况和信息的视图等</p>
<p>JProfiler官网：<a target="_blank" rel="noopener" href="http://www.ej-technologies.com/products/jprofiler/overview.html">http://www.ej-technologies.com/products/jprofiler/overview.html</a> </p>
<p>范例: 安装jprofiler工具定位OOM原因和源码问题的位置</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#安装OpenJDK</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># dnf -y install java-1.8.0-openjdk-devel</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># cat HeapOom.java </span></span><br><span class="line">import java.util.ArrayList;</span><br><span class="line">import java.util.List;</span><br><span class="line">public class HeapOom &#123;</span><br><span class="line">    public static void main(String[] args) &#123;</span><br><span class="line">        List&lt;byte[]&gt; list =new ArrayList&lt;byte[]&gt;();</span><br><span class="line">        int i = 0;</span><br><span class="line">        boolean flag = <span class="literal">true</span>;</span><br><span class="line">        <span class="keyword">while</span>(flag)&#123;</span><br><span class="line">            try&#123;</span><br><span class="line">                i++;</span><br><span class="line">                list.add(new byte[1024* 1024]);//每次增加一个1M大小的数组对象</span><br><span class="line">                Thread.<span class="built_in">sleep</span>(1000);</span><br><span class="line">            &#125; catch(Throwable e)&#123;</span><br><span class="line">                  e.printStackTrace();</span><br><span class="line">                  flag = <span class="literal">false</span>;</span><br><span class="line">                  System.out.println(<span class="string">&quot;count=&quot;</span>+i);//记录运行的次数</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">[root@centos8 ~]<span class="comment"># javac HeapOom.java </span></span><br><span class="line">[root@centos8 ~]<span class="comment"># java -cp . -Xms5m -Xmx10m -XX:+HeapDumpOnOutOfMemoryError HeapOom</span></span><br><span class="line">java.lang.OutOfMemoryError: Java heap space</span><br><span class="line">Dumping heap to java_pid96271.hprof ...</span><br><span class="line">Heap dump file created [8134070 bytes <span class="keyword">in</span> 0.031 secs]</span><br><span class="line">java.lang.OutOfMemoryError: Java heap space</span><br><span class="line">    at HeapOom.main(HeapOom.java:12)</span><br><span class="line">count=8</span><br><span class="line"></span><br><span class="line">[root@centos8 ~]<span class="comment"># cat HeapOom2.java </span></span><br><span class="line">import java. util. Random;</span><br><span class="line">public class HeapOom2 &#123;</span><br><span class="line">    public static void main(String[] args) &#123;</span><br><span class="line">        String str = <span class="string">&quot;I am lao wang&quot;</span>;</span><br><span class="line">        <span class="keyword">while</span> (<span class="literal">true</span>)&#123;</span><br><span class="line">            str += str + new Random().nextInt(88888888);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">[root@centos8 ~]<span class="comment"># javac HeapOom2.java </span></span><br><span class="line">[root@centos8 ~]<span class="comment"># java -cp . -Xms5m -Xmx10m -XX:+HeapDumpOnOutOfMemoryError HeapOom2</span></span><br><span class="line">java.lang.OutOfMemoryError: Java heap space</span><br><span class="line">Dumping heap to java_pid96339.hprof ...</span><br><span class="line">Heap dump file created [4925877 bytes <span class="keyword">in</span> 0.016 secs]</span><br><span class="line">Exception <span class="keyword">in</span> thread <span class="string">&quot;main&quot;</span> java.lang.OutOfMemoryError: Java heap space</span><br><span class="line">    at java.util.Arrays.copyOf(Arrays.java:3332)</span><br><span class="line">    at java.lang.AbstractStringBuilder.ensureCapacityInternal(AbstractStringBuilder.java:124)</span><br><span class="line">    at java.lang.AbstractStringBuilder.append(AbstractStringBuilder.java:674)</span><br><span class="line">    at java.lang.StringBuilder.append(StringBuilder.java:208)</span><br><span class="line">    at HeapOom2.main(HeapOom2.java:6)</span><br></pre></td></tr></table></figure>

<p><strong>下载并安装Jprofiler</strong></p>
<p><img src="../../../../images/SRE/day33/162.jpg" alt="162"><br><img src="../../../../images/SRE/day33/163.jpg" alt="163"><br><img src="../../../../images/SRE/day33/164.jpg" alt="164"><br><img src="../../../../images/SRE/day33/165.jpg" alt="165"><br><img src="../../../../images/SRE/day33/166.jpg" alt="166"></p>
<p>下载并安装JProfiler(傻瓜式安装略)后,双击打开前面生成的两个文件java_pid96271.hprof和java_pid96339,可以看到下面显示,从中分析OOM原因</p>
<p><img src="../../../../images/SRE/day33/167.jpg" alt="167"><br><img src="../../../../images/SRE/day33/168.jpg" alt="168"><br><img src="../../../../images/SRE/day33/169.jpg" alt="169"><br><img src="../../../../images/SRE/day33/170.jpg" alt="170"><br><img src="../../../../images/SRE/day33/171.jpg" alt="171"></p>
<h4 id="Tomcat的JVM参数设置"><a href="#Tomcat的JVM参数设置" class="headerlink" title="Tomcat的JVM参数设置"></a>Tomcat的JVM参数设置</h4><p>默认不指定，-Xmx大约使用了1/4的内存，当前本机内存指定约为1G。 </p>
<p>在bin/catalina.sh中增加一行</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># OS specific support. $var _must_ be set to either true or false.</span></span><br><span class="line"><span class="comment">#添加下面一行</span></span><br><span class="line">JAVA_OPTS=<span class="string">&quot;-server -Xms128m -Xmx512m -XX:NewSize=48m -XX:MaxNewSize=200m&quot;</span></span><br><span class="line"></span><br><span class="line">cygwin=<span class="literal">false</span></span><br><span class="line">darwin=<span class="literal">false</span></span><br></pre></td></tr></table></figure>

<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">-server：VM运行在server模式，为在服务器端最大化程序运行速度而优化</span><br><span class="line">-client：VM运行在Client模式，为客户端环境减少启动时间而优化</span><br></pre></td></tr></table></figure>

<p>重启 Tomcat 观察</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@tomcat ~]<span class="comment">#ps aux|grep tomcat</span></span><br><span class="line">tomcat    22194  5.1 15.1 2497008 123480 ?     Sl   13:31   0:03 /usr/local/jdk/jre/bin/java -</span><br></pre></td></tr></table></figure>

<p>浏览器访问server status页面，可以看到以下页面</p>
<p><img src="../../../../images/SRE/day33/172.jpg" alt="172"></p>
<h3 id="垃圾收集方式"><a href="#垃圾收集方式" class="headerlink" title="垃圾收集方式"></a>垃圾收集方式</h3><p>按<strong>工作模式</strong>不同：指的是GC线程和工作线程是否一起运行</p>
<ul>
<li>独占垃圾回收器：只有GC在工作，<strong>STW</strong> 一直进行到回收完毕，工作线程才能继续执行</li>
<li>并发垃圾回收器：让<strong>GC线程</strong>垃圾回收某些阶段可以和<strong>工作线程</strong>一起进行,如:标记阶段并行,回收阶段仍然串行 </li>
</ul>
<p>按<strong>回收线程</strong>数：指的是GC线程是否串行或并行执行</p>
<ul>
<li>串行垃圾回收器：一个GC线程完成回收工作</li>
<li>并行垃圾回收器：多个GC线程同时一起完成回收工作，充分利用CPU资源</li>
</ul>
<p><img src="../../../../images/SRE/day33/173.jpg" alt="173"></p>
<h3 id="调整策略"><a href="#调整策略" class="headerlink" title="调整策略"></a>调整策略</h3><p>对JVM调整策略应用极广</p>
<ul>
<li>在WEB领域中Tomcat等</li>
<li>在大数据领域Hadoop生态各组件</li>
<li>在消息中间件领域的Kafka等</li>
<li>在搜索引擎领域的ElasticSearch、Solr等</li>
</ul>
<p><strong>注意: 在不同领域和场景对JVM需要不同的调整策略</strong></p>
<ul>
<li>减少 STW 时长，串行变并行</li>
<li>减少 GC 次数，要分配合适的内存大小</li>
</ul>
<p><strong>一般情况下，大概可以使用以下原则：</strong> </p>
<ul>
<li>客户端或较小程序，内存使用量不大，可以使用串行回收</li>
<li>对于服务端大型计算，可以使用并行回收</li>
<li>大型WEB应用，用户端不愿意等待，尽量少的STW，可以使用并发回收</li>
</ul>
<h3 id="垃圾回收器"><a href="#垃圾回收器" class="headerlink" title="垃圾回收器"></a>垃圾回收器</h3><h4 id="常用垃圾回收器"><a href="#常用垃圾回收器" class="headerlink" title="常用垃圾回收器"></a>常用垃圾回收器</h4><p><img src="../../../../images/SRE/day33/174.jpg" alt="174"></p>
<h5 id="按分代设置不同垃圾回收器"><a href="#按分代设置不同垃圾回收器" class="headerlink" title="按分代设置不同垃圾回收器"></a>按分代设置不同垃圾回收器</h5><p><strong>新生代</strong></p>
<ul>
<li>新生代串行收集器Serial：单线程、独占式串行，采用复制算法,简单高效但会造成STW</li>
</ul>
<p><img src="../../../../images/SRE/day33/175.jpg" alt="175"></p>
<ul>
<li><p>新生代并行回收收集器<strong>PS(Parallel Scavenge)<strong>：多线程并行、独占式，会产生STW, 使用</strong>复制算法</strong></p>
<p>关注调整吞吐量,此收集器关注点是达到一个可控制的吞吐量</p>
<p>吞吐量 = 运行用户代码时间/（运行用户代码时间+垃圾收集时间），比如虚拟机总共运行100分钟，其中垃圾回收花掉1分钟，那吞吐量就是99%。 </p>
<p>高吞吐量可以高效率利用CPU时间，尽快完成运算任务，主要适合在<strong>后台运算</strong>而不需要太多交互的任务。</p>
<p>除此之外，Parallel Scavenge 收集器具有自适应调节策略，它可以将内存管理的调优任务交给虚拟机去完成。自适应调节策略也是Parallel Scavenge与 ParNew 收集器的一个重要区别。</p>
<p>此为默认的新生代的垃圾回收器</p>
<p><strong>和ParNew不同,PS不可以和老年代的CMS组合</strong></p>
</li>
<li><p>新生代并行收集器<strong>ParNew</strong>：就是Serial 收集器的多线程版,将单线程的串行收集器变成了多线程并行、独占式,使用<strong>复制算法</strong>,相当于PS的改进版</p>
<p>经常和CMS配合使用,关注点是尽可能地缩短垃圾收集时用户线程的停顿时间，适合需要与<strong>用户交互</strong>的程序，良好的响应速度能提升用户体验</p>
</li>
</ul>
<p><img src="../../../../images/SRE/day33/176.jpg" alt="176"></p>
<p><strong>老年代：</strong> </p>
<ul>
<li><p>老年代串行收集器<strong>Serial Old</strong>：Serial Old是Serial收集器的老年代版本,单线程、独占式串行，回收算法使用<strong>标记压缩</strong></p>
</li>
<li><p>老年代并行回收收集器<strong>Parallel Old</strong>：多线程、独占式并行，回收算法使用标记压缩，关注调整<strong>吞吐量</strong></p>
<p>Parallel Old收集器是Parallel Scavenge 收集器的老年代版本，这个收集器是JDK1.6之后才开始提供，从HotSpot虚拟机的垃圾收集器的图中也可以看出，Parallel Scavenge 收集器无法与CMS收集器配合工作,因为一个是为了吞吐量，一个是为了客户体验（也就是暂停时间的缩短） </p>
<p>此为默认的新老年代的垃圾回收器</p>
</li>
<li><p><strong>CMS (Concurrent Mark Sweep并发标记清除算法) 收集器</strong></p>
<ul>
<li>在某些阶段尽量使用和工作线程一起运行，减少STW时长(200ms以内), 提升响应速度,是互联网服务端BS系统上较佳的回收算法</li>
<li>分为4个阶段：初始标记、并发标记、重新标记、并发清除，在初始标记、重新标记时需要 STW。</li>
</ul>
</li>
</ul>
<p><img src="../../../../images/SRE/day33/177.jpg" alt="177"></p>
<ul>
<li>初始标记：此过程需要STW（Stop The Word），只标记一下GC Roots能直接关联到的对象，速度很快。</li>
<li>并发标记：就是GC Roots进行扫描可达链的过程，为了找出哪些对象需要收集。这个过程远远慢于初始标记，但它是和用户线程一起运行的，不会出现STW，所有用户并不会感受到。</li>
<li>重新标记：为了修正在并发标记期间，用户线程产生的垃圾，这个过程会比初始标记时间稍微长一点，但是也很快，和初始标记一样会产生STW。</li>
<li>并发清理：在重新标记之后，对现有的垃圾进行清理，和并发标记一样也是和用户线程一起运行的，耗时较长（和初始标记比的话），不会出现STW。</li>
<li>由于整个过程中，耗时最长的并发标记和并发清理都是与用户线程一起执行的，所以总体上来说，CMS收集器的内存回收过程是与用户线程一起并发执行的。</li>
</ul>
<h5 id="以下收集器不再按明确的分代单独设置"><a href="#以下收集器不再按明确的分代单独设置" class="headerlink" title="以下收集器不再按明确的分代单独设置"></a>以下收集器不再按明确的分代单独设置</h5><ul>
<li><p><strong>G1(Garbage First)收集器</strong></p>
<ul>
<li>是最新垃圾回收器，从JDK1.6实验性提供，JDK1.7发布，其设计目标是在多处理器、大内存服务器端提供优于CMS收集器的吞吐量和停顿控制的回收器。JDK9将G1设为默认的收集器,建议 JDK9版本以后使用。</li>
<li>基于<strong>标记压缩</strong>算法,不会产生大量的空间碎片，有利于程序的长期执行。</li>
<li>分为4个阶段：初始标记、并发标记、最终标记、筛选回收。并发标记并发执行，其它阶段STW只有GC线程并行执行。</li>
<li>G1收集器是面向服务端的收集器，它的思想就是首先回收尽可能多的垃圾（这也是Garbage-First名字的由来）</li>
<li>G1能充分的利用多CPU，多核环境下的硬件优势，使用多个CPU来缩短STW停顿的时间**(10ms以内)**。</li>
<li>可预测的停顿：这是G1相对于CMS的另一大优势，G1和CMS一样都是关注于降低停顿时间，但是G1能够让使用者明确的指定在一个M毫秒的时间片段内，消耗在垃圾收集的时间不得超过N毫秒。</li>
<li>通过此选项指定: +UseG1GC</li>
</ul>
</li>
<li><p>ZGC收集器: 减少STW时长(<strong>1ms</strong>以内), 可以PK C++的效率,目前实验阶段 </p>
</li>
<li><p>Shenandoah收集器: 和ZGC竞争关系,目前实验阶段</p>
</li>
<li><p>Epsilon收集器: 调试 JDK 使用,内部使用,不用于生产环境</p>
</li>
</ul>
<p><strong>JVM 1.8 默认的垃圾回收器：PS + ParallelOld,所以大多数都是针对此进行调优</strong></p>
<h4 id="垃圾收集器设置"><a href="#垃圾收集器设置" class="headerlink" title="垃圾收集器设置"></a>垃圾收集器设置</h4><p>优化调整Java 相关参数的目标: 尽量减少FullGC和STW</p>
<p>通过以下选项可以单独指定新生代、老年代的垃圾收集器</p>
<ul>
<li>-server 指定为Server模式,也是默认值,一般使用此工作模式</li>
<li>-XX:+UseSerialGC<ul>
<li>运行在Client模式下，新生代是Serial, 老年代使用SerialOld</li>
</ul>
</li>
<li>-XX:+UseParNewGC<ul>
<li>新生代使用ParNew，老年代使用SerialOld</li>
</ul>
</li>
<li>-XX:+UseParallelGC <ul>
<li>运行于server模式下，新生代使用Parallel Scavenge, 老年代使用 Parallel Old</li>
</ul>
</li>
<li>-XX:+UseParallelOldGC<ul>
<li>新生代使用Paralell Scavenge, 老年代使用Paralell Old，和上面 -XX:+UseParallelGC相同</li>
<li>-XX:ParallelGCThreads=N，在关注吞吐量的场景使用此选项增加并行线程数</li>
</ul>
</li>
<li>-XX:+UseConcMarkSweepGC<ul>
<li>新生代使用ParNew, 老年代优先使用CMS，备选方式为Serial Old</li>
<li>响应时间要短，停顿短使用这个垃圾收集器</li>
<li>-XX:CMSInitiatingOccupancyFraction=N，N为0-100整数表示达到老年代的大小的百分比多少触发回收<ul>
<li>默认68</li>
</ul>
</li>
<li>-XX:+UseCMSCompactAtFullCollection 开启此值,在CMS收集后，进行内存碎片整理</li>
<li>-XX:CMSFullGCsBeforeCompaction=N 设定多少次CMS后，进行一次内存碎片整理</li>
<li>-XX:+CMSParallelRemarkEnabled 降低标记停顿</li>
</ul>
</li>
</ul>
<p>范例:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">-XX:+UseConcMarkSweepGC -XX:CMSInitiatingOccupancyFraction=80 </span><br><span class="line">-XX:+UseCMSCompactAtFullCollection -XX:CMSFullGCsBeforeCompaction=5</span><br></pre></td></tr></table></figure>

<p>范例：查看默认垃圾回收器</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#Linux</span></span><br><span class="line">[root@rocky8 ~]<span class="comment"># java   -XX:+PrintCommandLineFlags -version</span></span><br><span class="line">-XX:InitialHeapSize=31964352 -XX:MaxHeapSize=511429632 </span><br><span class="line">-XX:+PrintCommandLineFlags -XX:+UseCompressedClassPointers -XX:+UseCompressedOops </span><br><span class="line">-XX:+UseParallelGC </span><br><span class="line">java version <span class="string">&quot;1.8.0_301&quot;</span></span><br><span class="line">Java(TM) SE Runtime Environment (build 1.8.0_301-b09)</span><br><span class="line">Java HotSpot(TM) 64-Bit Server VM (build 25.301-b09, mixed mode)</span><br><span class="line"></span><br><span class="line"><span class="comment">#Windows</span></span><br><span class="line">C:\Users\wang&gt;java   -XX:+PrintCommandLineFlags  -version</span><br><span class="line">-XX:InitialHeapSize=1071317952 -XX:MaxHeapSize=17141087232 -XX:+PrintCommandLineFlags -XX:+UseCompressedClassPointers -XX:+UseCompressedOops </span><br><span class="line">-XX:-UseLargePagesIndividualAllocation -XX:+UseParallelGC</span><br><span class="line">java version <span class="string">&quot;1.8.0_281&quot;</span></span><br><span class="line">Java(TM) SE Runtime Environment (build 1.8.0_281-b09)</span><br><span class="line">Java HotSpot(TM) 64-Bit Server VM (build 25.281-b09, mixed mode)</span><br></pre></td></tr></table></figure>

<p>范例：查看垃圾回收器</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#-XX:+UseSerialGC表示Serial+SerialOld</span></span><br><span class="line">[root@rocky8 ~]<span class="comment"># java -Xms10m -Xmx10m -XX:+PrintGCDetails -XX:+UseSerialGC -cp . HeapOom2 </span></span><br><span class="line">[GC (Allocation Failure) [DefNew: 2376K-&gt;320K(3072K), 0.0004583 secs] 2376K-</span><br><span class="line">&gt;657K(9920K), 0.0004984 secs] [Times: user=0.00 sys=0.00, real=0.00 secs] </span><br><span class="line">[GC (Allocation Failure) [DefNew: 2374K-&gt;0K(3072K), 0.0003771 secs] 2711K-</span><br><span class="line">&gt;1257K(9920K), 0.0003866 secs] [Times: user=0.00 sys=0.00, real=0.00 secs] </span><br><span class="line">[GC (Allocation Failure) [DefNew: 2447K-&gt;0K(3072K), 0.0004045 secs] 3704K-</span><br><span class="line">&gt;2857K(9920K), 0.0004243 secs] [Times: user=0.00 sys=0.00, real=0.00 secs] </span><br><span class="line">[GC (Allocation Failure) [DefNew: 1643K-&gt;0K(3072K), 0.0001604 secs] 4500K-</span><br><span class="line">&gt;4457K(9920K), 0.0001758 secs] [Times: user=0.00 sys=0.00, real=0.00 secs] </span><br><span class="line">[GC (Allocation Failure) [DefNew: 1600K-&gt;0K(3072K), 0.0002896 secs][Tenured: </span><br><span class="line">6057K-&gt;2856K(6848K), 0.0009171 secs] 6057K-&gt;2856K(9920K), [Metaspace: 2480K-</span><br><span class="line">&gt;2480K(1056768K)], 0.0012276 secs] [Times: user=0.00 sys=0.00, real=0.00 secs]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#-XX:+UseParNewGC表示ParNew+SerialOld</span></span><br><span class="line">[root@rocky8 ~]<span class="comment"># java -Xms10m -Xmx10m -XX:+PrintGCDetails -XX:+UseParNewGC -cp . HeapOom2</span></span><br><span class="line">Java HotSpot(TM) 64-Bit Server VM warning: Using the ParNew young collector with </span><br><span class="line">the Serial old collector is deprecated and will likely be removed <span class="keyword">in</span> a future release</span><br><span class="line">[GC (Allocation Failure) [ParNew: 2373K-&gt;265K(3072K), 0.0008588 secs] 2373K-</span><br><span class="line">&gt;664K(9920K), 0.0008885 secs] [Times: user=0.00 sys=0.00, real=0.01 secs] </span><br><span class="line">[GC (Allocation Failure) [ParNew: 2316K-&gt;99K(3072K), 0.0007617 secs] 2716K-</span><br><span class="line">&gt;1559K(9920K), 0.0007802 secs] [Times: user=0.00 sys=0.00, real=0.00 secs] </span><br><span class="line">[GC (Allocation Failure) [ParNew: 2543K-&gt;24K(3072K), 0.0006585 secs] 4002K-</span><br><span class="line">&gt;3082K(9920K), 0.0006758 secs] [Times: user=0.00 sys=0.00, real=0.00 secs]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#-XX:+UseParallelGC表示PS+ParOld 此为默认值</span></span><br><span class="line">[root@rocky8 ~]<span class="comment">#java -Xms10m -Xmx10m -XX:+PrintGCDetails -XX:+UseParallelGC -cp . HeapOom2 </span></span><br><span class="line">[GC (Allocation Failure) [PSYoungGen: 1953K-&gt;491K(2560K)] 1953K-&gt;755K(9728K), </span><br><span class="line">0.0009754 secs] [Times: user=0.00 sys=0.00, real=0.00 secs] </span><br><span class="line">[GC (Allocation Failure) [PSYoungGen: 2512K-&gt;492K(2560K)] 2775K-&gt;755K(9728K), </span><br><span class="line">0.0005462 secs] [Times: user=0.00 sys=0.00, real=0.00 secs] </span><br><span class="line">[GC (Allocation Failure) [PSYoungGen: 2512K-&gt;96K(2560K)] 4359K-&gt;2735K(9728K), </span><br><span class="line">0.0006484 secs] [Times: user=0.00 sys=0.00, real=0.00 secs] </span><br><span class="line">[GC (Allocation Failure) [PSYoungGen: 888K-&gt;96K(2560K)] 5111K-&gt;4319K(9728K), </span><br><span class="line">0.0004700 secs] [Times: user=0.00 sys=0.00, real=0.00 secs] </span><br><span class="line">[GC (Allocation Failure) [PSYoungGen: 96K-&gt;96K(2560K)] 4319K-&gt;4319K(9728K), </span><br><span class="line">0.0004402 secs] [Times: user=0.00 sys=0.00, real=0.00 secs] </span><br><span class="line">[Full GC (Allocation Failure) [PSYoungGen: 96K-&gt;0K(2560K)] [ParOldGen: 4223K-</span><br><span class="line">&gt;2632K(7168K)] 4319K-&gt;2632K(9728K), [Metaspace: 2480K-&gt;2480K(1056768K)], </span><br><span class="line">0.0020238 secs] [Times: user=0.00 sys=0.00, real=0.00 secs] </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#-XX:+UseParallelOldGC表示PS+ParOld</span></span><br><span class="line">[root@rocky8 ~]<span class="comment"># java -Xms10m -Xmx10m -XX:+PrintGCDetails -XX:+UseParallelOldGC -cp . HeapOom2 </span></span><br><span class="line">[GC (Allocation Failure) [PSYoungGen: 1933K-&gt;486K(2560K)] 1933K-&gt;748K(9728K), </span><br><span class="line">0.0009954 secs] [Times: user=0.00 sys=0.00, real=0.00 secs] </span><br><span class="line">[GC (Allocation Failure) [PSYoungGen: 2482K-&gt;486K(2560K)] 2744K-&gt;748K(9728K), </span><br><span class="line">0.0005175 secs] [Times: user=0.00 sys=0.00, real=0.00 secs] </span><br><span class="line">[GC (Allocation Failure) [PSYoungGen: 2482K-&gt;96K(2560K)] 4308K-&gt;2703K(9728K), </span><br><span class="line">0.0006469 secs] [Times: user=0.00 sys=0.00, real=0.00 secs] </span><br><span class="line">[GC (Allocation Failure) [PSYoungGen: 878K-&gt;96K(2560K)] 5049K-&gt;4267K(9728K), </span><br><span class="line">0.0005057 secs] [Times: user=0.00 sys=0.00, real=0.00 secs] </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#-XX:+UseConcMarkSweepGC表示ParNew+CMS</span></span><br><span class="line">[root@rocky8 ~]<span class="comment"># java -Xms10m -Xmx10m -XX:+PrintGCDetails -XX:+UseConcMarkSweepGC -cp . HeapOom2 </span></span><br><span class="line">[GC (Allocation Failure) [ParNew: 2365K-&gt;273K(3072K), 0.0004709 secs] 2365K-</span><br><span class="line">&gt;674K(9920K), 0.0005774 secs] [Times: user=0.00 sys=0.00, real=0.00 secs] </span><br><span class="line">[GC (Allocation Failure) [ParNew: 2324K-&gt;100K(3072K), 0.0008058 secs] 2726K-</span><br><span class="line">&gt;1563K(9920K), 0.0008263 secs] [Times: user=0.00 sys=0.00, real=0.00 secs] </span><br><span class="line">[GC (Allocation Failure) [ParNew: 2543K-&gt;25K(3072K), 0.0004260 secs] 4006K-</span><br><span class="line">&gt;3085K(9920K), 0.0004505 secs] [Times: user=0.00 sys=0.00, real=0.00 secs] </span><br><span class="line">[GC (Allocation Failure) [ParNew: 1665K-&gt;6K(3072K), 0.0004862 secs] 4726K-</span><br><span class="line">&gt;4664K(9920K), 0.0005126 secs] [Times: user=0.00 sys=0.00, real=0.00 secs] </span><br></pre></td></tr></table></figure>

<p>范例: 查看默认模式</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ~]<span class="comment"># java |&amp; grep &#x27;-server&#x27;</span></span><br><span class="line">    -server to select the <span class="string">&quot;server&quot;</span> VM</span><br><span class="line">                 The default VM is server.</span><br><span class="line">                 </span><br><span class="line">[root@centos8 ~]<span class="comment"># tail -n 2 /usr/local/jdk/jre/lib/amd64/jvm.cfg</span></span><br><span class="line">-server KNOWN</span><br><span class="line">-client IGNORE</span><br></pre></td></tr></table></figure>

<p>范例: 指定垃圾回收设置</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#将参数加入到bin/catalina.sh中，重启观察Tomcat status。老年代已经使用CMS</span></span><br><span class="line">[root@tomcat ~]<span class="comment"># vim /usr/local/tomcat/bin/catalina.sh</span></span><br><span class="line">......</span><br><span class="line"><span class="comment"># OS specific support. $var _must_ be set to either true or false.</span></span><br><span class="line">JAVA_OPTS=<span class="string">&quot;-server -Xmx512m -Xms128m -XX:NewSize=48m -XX:MaxNewSize=200m </span></span><br><span class="line"><span class="string">-XX:+UseConcMarkSweepGC -XX:+UseCMSCompactAtFullCollection </span></span><br><span class="line"><span class="string">-XX:CMSFullGCsBeforeCompaction=5&quot;</span>                                                 </span><br><span class="line">                                                          </span><br><span class="line">cygwin=<span class="literal">false</span></span><br><span class="line">darwin=<span class="literal">false</span></span><br><span class="line">os400=<span class="literal">false</span></span><br><span class="line">.......</span><br><span class="line">[root@tomcat ~]<span class="comment"># systemctl restart tomcat</span></span><br><span class="line">[root@tomcat ~]<span class="comment"># ps aux |grep tomcat</span></span><br></pre></td></tr></table></figure>

<p><img src="../../../../images/SRE/day33/178.jpg" alt="178"></p>
<p>开启垃圾回收输出统计信息,适用于调试环境的相关选项</p>
<ul>
<li>-XX:+PrintGC 输出GC信息</li>
<li>-XX:+PrintGCDetails 输出GC详细信息</li>
<li>-XX:+PrintGCTimeStamps 与前两个组合使用，在信息上加上一个时间戳 </li>
<li>-XX:+PrintHeapAtGC 生成GC前后椎栈的详细信息，日志会更大</li>
</ul>
<p>注意: 以上适用调试环境，生产环境请移除这些参数，否则有非常多的日志输出</p>
<h2 id="JVM相关工具"><a href="#JVM相关工具" class="headerlink" title="JVM相关工具"></a>JVM相关工具</h2><h3 id="JVM-工具概述"><a href="#JVM-工具概述" class="headerlink" title="JVM 工具概述"></a>JVM 工具概述</h3><p>$JAVA_HOME/bin下</p>
<table>
<thead>
<tr>
<th>命令</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>jps</td>
<td>查看所有JVM进程的PID和主类名称</td>
</tr>
<tr>
<td>jinfo</td>
<td>实时查看或修改JVM进程的运行环境参数（支持-dump生成堆配置快照）</td>
</tr>
<tr>
<td>jstat</td>
<td>监控JVM资源和性能（类加载、GC、JIT编译等），支持定时采样</td>
</tr>
<tr>
<td>jstack</td>
<td>查看JVM进程内所有线程的堆栈状态，支持生成线程快照用于死锁分析</td>
</tr>
<tr>
<td>jmap</td>
<td>生成堆内存使用详情报告（包括直方图、对象统计等），支持导出堆转储文件</td>
</tr>
<tr>
<td>jhat</td>
<td>分析Java堆转储文件（需配合jmap使用），内置HTTP服务器展示分析结果</td>
</tr>
<tr>
<td>jconsole</td>
<td>基于JMX的图形化监控工具（支持内存、线程、类、MBean等实时监控）</td>
</tr>
<tr>
<td>jvisualvm</td>
<td>多合一图形化诊断工具（包含内存/CPU分析、堆转储分析、方法级性能采样等）</td>
</tr>
</tbody></table>
<h3 id="jps"><a href="#jps" class="headerlink" title="jps"></a>jps</h3><p>JVM 进程状态工具</p>
<p>格式</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">jps：Java virutal machine Process Status tool，</span><br><span class="line">jps [-q] [-mlvV] [&lt;<span class="built_in">hostid</span>&gt;]</span><br><span class="line">-q：静默模式；</span><br><span class="line">-v：显示传递给jvm的命令行参数；</span><br><span class="line">-m：输出传入main方法的参数；</span><br><span class="line">-l：输出main类或jar完全限定名称；</span><br><span class="line">-v：显示通过flag文件传递给jvm的参数；</span><br><span class="line">[&lt;<span class="built_in">hostid</span>&gt;]：主机<span class="built_in">id</span>，默认为localhost；</span><br></pre></td></tr></table></figure>

<p>范例:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#显示java进程</span></span><br><span class="line">[root@tomcat ~]<span class="comment"># jps</span></span><br><span class="line">22357 Jps</span><br><span class="line">21560 Main</span><br><span class="line">21407 HelloWorld</span><br><span class="line"></span><br><span class="line"><span class="comment">#详细列出当前Java进程信息</span></span><br><span class="line">[root@tomcat ~]<span class="comment"># jps -l -v</span></span><br><span class="line">21560 org.netbeans.Main -Djdk.home=/usr/local/jdk -</span><br><span class="line">Dnetbeans.default_userdir_root=/root/.visualvm -</span><br><span class="line">Dnetbeans.<span class="built_in">dirs</span>=/usr/local/jdk/lib/visualvm/visualvm:/usr/local/jdk/lib/visualvm/</span><br></pre></td></tr></table></figure>

<h3 id="jinfo"><a href="#jinfo" class="headerlink" title="jinfo"></a>jinfo</h3><p>输出给定的java进程的所有配置信息</p>
<p>格式:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">jinfo [option] &lt;pid&gt;</span><br><span class="line">-flags：打印 VM flags</span><br><span class="line">-sysprops：to <span class="built_in">print</span> Java system properties</span><br><span class="line">-flag &lt;name&gt;：to <span class="built_in">print</span> the value of the named VM flag</span><br></pre></td></tr></table></figure>

<p>范例:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#先获得一个java进程ID，然后jinfo</span></span><br><span class="line">[root@tomcat ~]<span class="comment"># jps</span></span><br><span class="line">22357 Jps</span><br><span class="line">21560 Main</span><br><span class="line">21407 HelloWorld</span><br><span class="line"></span><br><span class="line">[root@tomcat ~]<span class="comment"># jinfo 21407</span></span><br><span class="line">Attaching to process ID 21407, please <span class="built_in">wait</span>...</span><br><span class="line">Debugger attached successfully.</span><br><span class="line">Server compiler detected.</span><br><span class="line">JVM version is 25.241-b07</span><br><span class="line">Java System Properties:</span><br></pre></td></tr></table></figure>

<h3 id="jstat"><a href="#jstat" class="headerlink" title="jstat"></a>jstat</h3><p>输出指定的java进程的统计信息</p>
<p>格式:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">jstat -<span class="built_in">help</span>|-options</span><br><span class="line">jstat -&lt;option&gt; [-t] [-h&lt;lines&gt;] &lt;vmid&gt; [&lt;interval&gt; [&lt;count&gt;]]</span><br><span class="line">[&lt;interval&gt; [&lt;count&gt;]]</span><br><span class="line">interval：时间间隔，单位是毫秒；</span><br><span class="line">count：显示的次数；</span><br><span class="line"></span><br><span class="line"><span class="comment">#返回可用统计项列表</span></span><br><span class="line"><span class="comment"># jstat -options</span></span><br><span class="line">    -class：class loader</span><br><span class="line">    -compiler：JIT</span><br><span class="line">    -gc：gc</span><br><span class="line">    -gccapacity：统计堆中各代的容量</span><br><span class="line">    -gccause：</span><br><span class="line">    -gcmetacapacity</span><br><span class="line">    -gcnew：新生代</span><br><span class="line">    -gcnewcapacity</span><br><span class="line">    -gcold：老年代</span><br><span class="line">    -gcoldcapacity</span><br><span class="line">    -gcutil</span><br><span class="line">    -printcompilation</span><br></pre></td></tr></table></figure>

<p>范例:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">[root@tomcat ~]<span class="comment">#jstat -gc 21407</span></span><br><span class="line"> S0C   S1C   S0U   S1U     EC       EU       OC         OU       MC     MU   CCSC   CCSU   YGC     YGCT   FGC   FGCT     GCT   </span><br><span class="line">8704.0 8704.0 1563.6  0.0   69952.0  58033.0   174784.0     0.0     9344.0 8830.0 1152.0 1013.0      2    0.050   0      0.000    0.050</span><br><span class="line"></span><br><span class="line">S0C:S0区容量</span><br><span class="line">YGC：新生代的垃圾回收次数</span><br><span class="line">YGCT：新生代垃圾回收消耗的时长；</span><br><span class="line">FGC：Full GC的次数</span><br><span class="line">FGCT：Full GC消耗的时长</span><br><span class="line">GCT：GC消耗的总时长</span><br><span class="line"></span><br><span class="line"><span class="comment">#3次，一秒一次</span></span><br><span class="line">[root@tomcat ~]<span class="comment"># jstat -gcnew 21407 1000 3</span></span><br><span class="line"> S0C   S1C   S0U   S1U   TT MTT DSS     EC       EU     YGC     YGCT  </span><br><span class="line">8704.0 8704.0 1563.6    0.0 15  15 4352.0  69952.0  62794.3      2    0.050</span><br><span class="line">8704.0 8704.0 1563.6    0.0 15  15 4352.0  69952.0  62794.3      2    0.050</span><br><span class="line">8704.0 8704.0 1563.6    0.0 15  15 4352.0  69952.0  63074.5      2    0.050</span><br></pre></td></tr></table></figure>

<h3 id="jstack"><a href="#jstack" class="headerlink" title="jstack"></a>jstack</h3><p>程序员常用堆栈情况查看工具</p>
<p>jstack：查看指定的java进程的线程栈的相关信息</p>
<p>格式:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">jstack [-l] &lt;pid&gt;</span><br><span class="line">jstack -F [-m] [-l] &lt;pid&gt;</span><br><span class="line">-l：long listings，会显示额外的锁信息，因此，发生死锁时常用此选项</span><br><span class="line">-m：混合模式，既输出java堆栈信息，也输出C/C++堆栈信息</span><br><span class="line">-F：当使用<span class="string">&quot;jstack -l PID&quot;</span>无响应，可以使用-F强制输出信息</span><br></pre></td></tr></table></figure>

<p>范例:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#先获得一个java进程PID，然后jinfo</span></span><br><span class="line">[root@tomcat ~]<span class="comment"># jstack -l 21407</span></span><br><span class="line">2020-02-15 13:49:56</span><br><span class="line">Full thread dump Java HotSpot(TM) 64-Bit Server VM (25.241-b07 mixed mode):</span><br><span class="line"></span><br><span class="line"><span class="string">&quot;RMI TCP Connection(4)-10.0.0.101&quot;</span> <span class="comment">#16 daemon prio=9 os_prio=0 </span></span><br><span class="line">tid=0x00007f279c29e800 nid=0x5753 runnable [0x00007f279b181000]</span><br><span class="line">   java.lang.Thread.State: RUNNABLE</span><br><span class="line"> at java.net.SocketInputStream.socketRead0(Native Method)</span><br></pre></td></tr></table></figure>

<h3 id="jmap"><a href="#jmap" class="headerlink" title="jmap"></a>jmap</h3><p>Memory Map, 用于查看堆内存的使用状态</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#查看进程堆内存情况</span></span><br><span class="line">[root@tomcat ~]<span class="comment"># jmap -heap 21407</span></span><br><span class="line">Attaching to process ID 21407, please <span class="built_in">wait</span>...</span><br><span class="line">Debugger attached successfully.</span><br><span class="line">Server compiler detected.</span><br><span class="line">JVM version is 25.241-b07</span><br><span class="line">using thread-local object allocation.</span><br><span class="line">Mark Sweep Compact GC</span><br><span class="line">·····</span><br></pre></td></tr></table></figure>

<h3 id="jhat"><a href="#jhat" class="headerlink" title="jhat"></a>jhat</h3><p>Java Heap Analysis Tool 堆分析工具</p>
<p>格式</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">jmap [option] &lt;pid&gt; </span><br><span class="line"><span class="comment">#查看堆空间的详细信息：</span></span><br><span class="line">jmap -heap &lt;pid&gt;</span><br></pre></td></tr></table></figure>

<p>范例:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">[root@t1 ~]<span class="comment"># jmap -heap 96334</span></span><br><span class="line">Attaching to process ID 96334, please <span class="built_in">wait</span>...</span><br><span class="line">Debugger attached successfully.</span><br><span class="line">Server compiler detected.</span><br><span class="line">JVM version is 25.251-b08</span><br><span class="line"></span><br><span class="line">using thread-local object allocation.</span><br><span class="line">Mark Sweep Compact GC</span><br><span class="line"></span><br><span class="line">Heap Configuration:</span><br><span class="line">   MinHeapFreeRatio         = 40</span><br><span class="line">   MaxHeapFreeRatio         = 70</span><br><span class="line">   MaxHeapSize              = 251658240 (240.0MB)</span><br><span class="line">   NewSize                  = 5570560 (5.3125MB)</span><br><span class="line">   MaxNewSize               = 83886080 (80.0MB)</span><br><span class="line">   OldSize                  = 11206656 (10.6875MB)</span><br><span class="line">   </span><br><span class="line"><span class="comment">#查看堆内存中的对象的数目：</span></span><br><span class="line">jmap -histo[:live] &lt;pid&gt;</span><br><span class="line"> live：只统计活动对象；</span><br><span class="line"> </span><br><span class="line"><span class="comment">#保存堆内存数据至文件中，而后使用jvisualvm或jhat进行查看：</span></span><br><span class="line">jmap -dump:&lt;dump-options&gt; &lt;pid&gt;</span><br><span class="line"> dump-options:</span><br><span class="line"> live   dump only live objects; <span class="keyword">if</span> not specified, all objects <span class="keyword">in</span> the heap are </span><br><span class="line">dumped.</span><br><span class="line"> format=b     binary format</span><br><span class="line"> file=&lt;file&gt; dump heap to &lt;file&gt;</span><br></pre></td></tr></table></figure>

<h3 id="jconsole-和-JMX"><a href="#jconsole-和-JMX" class="headerlink" title="jconsole 和 JMX"></a>jconsole 和 JMX</h3><p>图形化工具,可以用来查看Java进程信息</p>
<p>JMX（Java Management Extensions，即Java管理扩展）是一个为JAVA应用程序、设备、系统等植入管理功能的框架。JMX可以跨越一系列异构操作系统平台、系统体系结构和网络传输协议，灵活的开发无缝集成的系统、网络和服务管理应用。</p>
<p>JMX最常见的场景是监控Java程序的基本信息和运行情况，任何Java程序都可以开启JMX，然后使用JConsole或Visual VM进行预览。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#为Java程序开启JMX很简单，只要在运行Java程序的命令后面指定如下命令即可</span></span><br><span class="line">java \</span><br><span class="line">-Dcom.sun.management.jmxremote         \    <span class="comment">#启用远程监控JMX </span></span><br><span class="line">-Djava.rmi.server.hostname=10.0.0.100   \  <span class="comment">#指定自已监听的IP</span></span><br><span class="line">-Dcom.sun.management.jmxremote.port=12345 \  <span class="comment">#指定监听的PORT</span></span><br><span class="line">-Dcom.sun.management.jmxremote.authenticate=<span class="literal">false</span> \</span><br><span class="line">-Dcom.sun.management.jmxremote.ssl=<span class="literal">false</span> \</span><br><span class="line">-jar app.jar|app.war </span><br></pre></td></tr></table></figure>

<p>在 tomcat 开启远程 JMX 支持 Zabbix 监控，如下配置</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">vim /usr/local/tomcat/bin/catalina.sh</span><br><span class="line">CATALINA_OPTS=<span class="string">&quot;<span class="variable">$CATALINA_OPTS</span></span></span><br><span class="line"><span class="string">-Dcom.sun.management.jmxremote         #启用远程监控JMX </span></span><br><span class="line"><span class="string">-Dcom.sun.management.jmxremote.port=XXXXX       #默认启动的JMX端口号，要和zabbix添加主机时候的端口一致即可</span></span><br><span class="line"><span class="string">-Dcom.sun.management.jmxremote.authenticate=false    #不使用用户名密码</span></span><br><span class="line"><span class="string">-Dcom.sun.management.jmxremote.ss1=false       #不使用ssl认证</span></span><br><span class="line"><span class="string">-Djava.rmi.server.hostname=&lt;JAVA主机IP&gt;&quot;</span>     <span class="comment">#tomcat主机自己的IP地址,不要写zabbix服务器的地址</span></span><br></pre></td></tr></table></figure>

<p>下图是使用Jconsle通过JMX查看Java程序的运行信息</p>
<p><img src="../../../../images/SRE/day33/179.jpg" alt="179"><br><img src="../../../../images/SRE/day33/180.jpg" alt="180"></p>
<p>范例: 开启远程JMX功能</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">[root@tomcat ~]<span class="comment"># vim /usr/local/tomcat/bin/catalina.sh</span></span><br><span class="line">.......</span><br><span class="line"><span class="comment"># -----------------------------------------------------------------------------</span></span><br><span class="line">CATALINA_OPTS=<span class="string">&quot;<span class="variable">$CATALINA__OPTS</span> \</span></span><br><span class="line"><span class="string">-Dcom.sun.management.jmxremote \</span></span><br><span class="line"><span class="string">-Djava.rmi.server.hostname=10.0.0.101 \</span></span><br><span class="line"><span class="string">-Dcom.sun.management.jmxremote.port=12345 \</span></span><br><span class="line"><span class="string">-Dcom.sun.management.jmxremote.authenticate=false \</span></span><br><span class="line"><span class="string">-Dcom.sun.management.jmxremote.ssl=false&quot;</span></span><br><span class="line"><span class="comment"># OS specific support. $var _must_ be set to either true or false.</span></span><br><span class="line">.......</span><br><span class="line"></span><br><span class="line">[root@tomcat ~]<span class="comment"># systemctl restart tomcat</span></span><br><span class="line">[root@tomcat ~]<span class="comment"># ss -ntl</span></span><br><span class="line">State               Recv-Q             Send-Q       Local Address:Port   Peer Address:Port  </span><br><span class="line">LISTEN              0                   128                 0.0.0.0:22        0.0.0.0:*</span><br><span class="line">LISTEN              0                   100               127.0.0.1:25        0.0.0.0:*</span><br><span class="line">LISTEN              0                   128                    [::]:22           [::]:*</span><br><span class="line">LISTEN              0                   50                        *:12345           *:*</span><br><span class="line">LISTEN              0                   100                   [::1]:25           [::]:*</span><br><span class="line">LISTEN              0                   50                        *:38563           *:*</span><br><span class="line">LISTEN              0                   1        [::ffff:127.0.0.1]:8005            *:*</span><br><span class="line">LISTEN              0                   50                        *:40613           *:*</span><br><span class="line">LISTEN              0                   100                       *:8080            *:*</span><br></pre></td></tr></table></figure>

<p><img src="../../../../images/SRE/day33/181.jpg" alt="181"><br><img src="../../../../images/SRE/day33/182.jpg" alt="182"><br><img src="../../../../images/SRE/day33/183.jpg" alt="183"><br><img src="../../../../images/SRE/day33/184.jpg" alt="184"></p>
<h2 id="Tomcat-性能优化常用配置"><a href="#Tomcat-性能优化常用配置" class="headerlink" title="Tomcat 性能优化常用配置"></a>Tomcat 性能优化常用配置</h2><h3 id="内存空间优化"><a href="#内存空间优化" class="headerlink" title="内存空间优化"></a>内存空间优化</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">JAVA_OPTS=<span class="string">&quot;-server -Xms4g -Xmx4g -XX:NewSize= -XX:MaxNewSize= &quot;</span></span><br><span class="line"></span><br><span class="line">-server：服务器模式</span><br><span class="line">-Xms：堆内存初始化大小</span><br><span class="line">-Xmx：堆内存空间上限</span><br><span class="line">-XX:NewSize=：新生代空间初始化大小 </span><br><span class="line">-XX:MaxNewSize=：新生代空间最大值</span><br></pre></td></tr></table></figure>

<p><strong>生产案例：</strong></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ~]<span class="comment"># vim /usr/local/tomcat/bin/catalina.sh </span></span><br><span class="line">JAVA_OPTS=<span class="string">&quot;-server -Xms4g -Xmx4g -Xss512k -Xmn1g -XX:CMSInitiatingOccupancyFraction=65 </span></span><br><span class="line"><span class="string">-XX:+AggressiveOpts -XX:+UseBiasedLocking -XX:+DisableExplicitGC -XX:MaxTenuringThreshold=10</span></span><br><span class="line"><span class="string">-XX:NewRatio=2 -XX:PermSize=128m -XX:MaxPermSize=512m -XX:CMSFullGCsBeforeCompaction=5 </span></span><br><span class="line"><span class="string">-XX:+ExplicitGCInvokesConcurrent -XX:+UseConcMarkSweepGC -XX:+UseParNewGC </span></span><br><span class="line"><span class="string">-XX:+CMSParallelRemarkEnabled -XX:+UseCMSCompactAtFullCollection </span></span><br><span class="line"><span class="string">-XX:LargePageSizeInBytes=128m -XX:+UseFastAccessorMethods&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#一台tomcat服务器并发连接数不高,生产建议分配物理内存通常4G到8G较多,如果需要更多连接,一般会利用虚拟化技术实现多台tomcat</span></span><br></pre></td></tr></table></figure>

<h3 id="线程池调整"><a href="#线程池调整" class="headerlink" title="线程池调整"></a>线程池调整</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ~]<span class="comment"># vim /usr/local/tomcat/conf/server.xml</span></span><br><span class="line">......</span><br><span class="line">&lt;Connector port=<span class="string">&quot;8080&quot;</span> protocol=<span class="string">&quot;HTTP/1.1&quot;</span>  connectionTimeout=<span class="string">&quot;20000&quot;</span></span><br><span class="line">          redirectPort=<span class="string">&quot;8443&quot;</span>  maxThreads=<span class="string">&quot;2000&quot;</span>/&gt;</span><br></pre></td></tr></table></figure>

<p>常用属性：</p>
<ul>
<li>connectionTimeout ：连接超时时长,单位ms</li>
<li>maxThreads：最大线程数，默认200</li>
<li>minSpareThreads：最小空闲线程数</li>
<li>maxSpareThreads：最大空闲线程数</li>
<li>acceptCount：当启动线程满了之后，等待队列的最大长度，默认100</li>
<li>URIEncoding：URI 地址编码格式，建议使用 UTF-8</li>
<li>enableLookups：是否启用客户端主机名的DNS反向解析，缺省禁用，建议禁用，就使用客户端IP就行</li>
<li>compression：是否启用传输压缩机制，建议 “on”，CPU和流量的平衡<ul>
<li>compressionMinSize：启用压缩传输的数据流最小值，单位是字节</li>
<li>compressableMimeType：定义启用压缩功能的MIME类型text/html, text/xml,text/css,  text/javascript</li>
</ul>
</li>
</ul>
<h1 id="Java-程序编译"><a href="#Java-程序编译" class="headerlink" title="Java 程序编译"></a>Java 程序编译</h1><h2 id="源代码克隆与编译过程说明"><a href="#源代码克隆与编译过程说明" class="headerlink" title="源代码克隆与编译过程说明"></a>源代码克隆与编译过程说明</h2><p>以github 上 java 开源项目dubbo-admin 为例</p>
<p>github 说明:</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://github.com/apache/dubbo-admin/</span><br></pre></td></tr></table></figure>

<p><img src="../../../../images/SRE/day33/185.jpg" alt="185"></p>
<p>官方部署过程</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">Production Setup</span><br><span class="line">Clone source code on develop branch git clone https://github.com/apache/dubbo-admin.git</span><br><span class="line"></span><br><span class="line">Specify registry address in dubbo-admin-server/src/main/resources/application.properties</span><br><span class="line"></span><br><span class="line">Build</span><br><span class="line"></span><br><span class="line">mvn clean package -Dmaven.test.skip=true</span><br><span class="line">Start</span><br><span class="line"></span><br><span class="line">mvn --projects dubbo-admin-server spring-boot:run</span><br><span class="line">OR</span><br><span class="line">cd dubbo-admin-distribution/target; java -jar dubbo-admin-0.1.jar</span><br><span class="line">Visit http://localhost:8080</span><br><span class="line"></span><br><span class="line">Default username and password is root</span><br></pre></td></tr></table></figure>

<h2 id="Maven-部署准备"><a href="#Maven-部署准备" class="headerlink" title="Maven 部署准备"></a>Maven 部署准备</h2><h3 id="Maven-介绍"><a href="#Maven-介绍" class="headerlink" title="Maven 介绍"></a>Maven 介绍</h3><p><img src="../../../../images/SRE/day33/186.jpg" alt="186"></p>
<p>Maven 翻译为”专家”、”内行”，是 Apache 基金会旗下的一个纯 Java 开发的开源项目</p>
<p>Maven 是一个项目管理工具，可以对 Java项目进行构建、解决打包依赖等。</p>
<p>它为开发者提供了一套完整的构建生命周期框架,开发团队稍微投入一些时间就能够自动完成工程的基础构建配置;在有多个开发团队环境的情况下，Maven 能够在很短的时间内使得每项工作都按照标准进行;那是因为大部分的工程配置操作都非常简单并且可复用</p>
<p>Maven基干项目对象模型(POM project object model)，它可以通过一小段描述信息（配置)来管理项目的构建;因而,每个maven项目都有一个pom.xml文件</p>
<p>POM( Project Object Model，项目对象模型 ) 是 Maven 工程的基本工作单元，是一个 XML 文件，包含了项目的基本信息，用于描述项目如何构建，声明项目依赖等，在执行任务或目标时，Maven 会在当前目录中查找 pom 文件，通过读取pom文件获取所需的配置信息，然后执行目标。 </p>
<p>pom.xml 文件中可以指定以下配置：</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">项目依赖</span><br><span class="line">插件</span><br><span class="line">执行目标</span><br><span class="line">项目构建 profile</span><br><span class="line">项目版本</span><br><span class="line">项目开发者列表 相关邮件列表信息</span><br><span class="line">用&lt;packaging&gt; 指定项目打包形式，jar或者war</span><br></pre></td></tr></table></figure>

<p>maven 官网</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://maven.apache.org/</span><br></pre></td></tr></table></figure>

<p>maven 官方仓库 ：</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://repo.maven.apache.org</span><br></pre></td></tr></table></figure>

<p>maven 下载</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#官方</span></span><br><span class="line">https://maven.apache.org/download.cgi</span><br><span class="line"></span><br><span class="line"><span class="comment">#清华镜像源</span></span><br><span class="line">http://mirrors.tuna.tsinghua.edu.cn/apache/maven</span><br><span class="line"></span><br><span class="line"><span class="comment">#官方各版本下载地址，推荐使用次新版本</span></span><br><span class="line">https://archive.apache.org/dist/maven/maven-3</span><br></pre></td></tr></table></figure>

<p>安装maven前必须安装java 环境：</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Maven 3.3 要求 JDK 1.7 或以上</span><br><span class="line">Maven 3.2 要求 JDK 1.6 或以上</span><br><span class="line">Maven 3.0/3.1 要求 JDK 1.5 或以上</span><br></pre></td></tr></table></figure>

<p>注意: Maven所安装JDK的版本不影响编译应用的所依赖的JDK版本,比如Maven安装JDK11,而java应用Jpress 可以使用JDK8</p>
<h3 id="maven-安装"><a href="#maven-安装" class="headerlink" title="maven 安装"></a>maven 安装</h3><h4 id="安装方式1-包安装"><a href="#安装方式1-包安装" class="headerlink" title="安装方式1: 包安装"></a>安装方式1: 包安装</h4><p>范例：Ubuntu20.04安装maven</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">[root@ubuntu2004 ~]<span class="comment"># apt -y install maven</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#自动安装Openjdk11</span></span><br><span class="line">[root@ubuntu2004 ~]<span class="comment"># java -version</span></span><br><span class="line">openjdk version <span class="string">&quot;11.0.15&quot;</span> 2022-04-19</span><br><span class="line">OpenJDK Runtime Environment (build 11.0.15+10-Ubuntu-0ubuntu0.20.04.1)</span><br><span class="line">OpenJDK 64-Bit Server VM (build 11.0.15+10-Ubuntu-0ubuntu0.20.04.1, mixed mode, sharing)</span><br><span class="line"></span><br><span class="line">[root@ubuntu2004 ~]<span class="comment"># mvn -v</span></span><br><span class="line">Apache Maven 3.6.3</span><br><span class="line">Maven home: /usr/share/maven</span><br><span class="line">Java version: 11.0.15, vendor: Private Build, runtime: /usr/lib/jvm/java-11-openjdk-amd64</span><br><span class="line">Default locale: zh_CN, platform encoding: UTF-8</span><br><span class="line">OS name: <span class="string">&quot;linux&quot;</span>, version: <span class="string">&quot;5.4.0-110-generic&quot;</span>, <span class="built_in">arch</span>: <span class="string">&quot;amd64&quot;</span>, family: <span class="string">&quot;unix&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#镜像加速</span></span><br><span class="line">[root@ubuntu2004 ~]<span class="comment"># vim /etc/maven/settings.xml</span></span><br><span class="line"><span class="comment">#大约在159行</span></span><br><span class="line">......</span><br><span class="line"> &lt;mirrors&gt;</span><br><span class="line">   &lt;!--阿里云镜像--&gt;</span><br><span class="line">   &lt;mirror&gt;</span><br><span class="line">       &lt;<span class="built_in">id</span>&gt;nexus-aliyun&lt;/id&gt;</span><br><span class="line">       &lt;mirrorOf&gt;*&lt;/mirrorOf&gt;</span><br><span class="line">       &lt;name&gt;Nexus aliyun&lt;/name&gt;</span><br><span class="line">       &lt;url&gt;http://maven.aliyun.com/nexus/content/groups/public&lt;/url&gt;</span><br><span class="line">   &lt;/mirror&gt;</span><br><span class="line"> &lt;/mirrors&gt;</span><br><span class="line"> ......</span><br></pre></td></tr></table></figure>

<p>范例：Ubuntu18.04安装maven</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">[root@ubuntu1804 ~]<span class="comment"># apt list maven -a</span></span><br><span class="line">Listing... Done</span><br><span class="line">maven/bionic-security,bionic-security,bionic-updates,bionic-updates,now 3.6.0-1~18.04.1 all [installed]</span><br><span class="line">maven/bionic,bionic 3.5.2-2 all</span><br><span class="line"></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment"># apt -y install maven</span></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment"># mvn -v</span></span><br><span class="line">Apache Maven 3.6.0</span><br><span class="line">Maven home: /usr/share/maven</span><br><span class="line">Java version: 11.0.11, vendor: Ubuntu, runtime: /usr/lib/jvm/java-11-openjdk-amd64</span><br><span class="line">Default locale: en_HK, platform encoding: UTF-8</span><br><span class="line">OS name: <span class="string">&quot;linux&quot;</span>, version: <span class="string">&quot;4.15.0-112-generic&quot;</span>, <span class="built_in">arch</span>: <span class="string">&quot;amd64&quot;</span>, family: <span class="string">&quot;unix&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#镜像加速</span></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment">#vim /etc/maven/settings.xml</span></span><br><span class="line"> &lt;mirrors&gt;</span><br><span class="line">   &lt;!--阿里云镜像--&gt;</span><br><span class="line">   &lt;mirror&gt;</span><br><span class="line">       &lt;<span class="built_in">id</span>&gt;nexus-aliyun&lt;/id&gt;</span><br><span class="line">       &lt;mirrorOf&gt;*&lt;/mirrorOf&gt;</span><br><span class="line">       &lt;name&gt;Nexus aliyun&lt;/name&gt;</span><br><span class="line">       &lt;url&gt;http://maven.aliyun.com/nexus/content/groups/public&lt;/url&gt;</span><br><span class="line">   &lt;/mirror&gt;</span><br><span class="line"> &lt;/mirrors&gt;</span><br></pre></td></tr></table></figure>

<p>范例: Rocky/CentOS/RHEL安装maven</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[root@rocky8 ~]<span class="comment"># yum -y install maven</span></span><br><span class="line">[root@rocky8 ~]<span class="comment"># mvn -v</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#镜像加速</span></span><br><span class="line">[root@rocky8 ~]<span class="comment"># vim /etc/maven/settings.xml</span></span><br><span class="line"> &lt;mirrors&gt;</span><br><span class="line">   &lt;!--阿里云镜像--&gt;</span><br><span class="line">   &lt;mirror&gt;</span><br><span class="line">       &lt;<span class="built_in">id</span>&gt;nexus-aliyun&lt;/id&gt;</span><br><span class="line">       &lt;mirrorOf&gt;*&lt;/mirrorOf&gt;</span><br><span class="line">       &lt;name&gt;Nexus aliyun&lt;/name&gt;</span><br><span class="line">       &lt;url&gt;http://maven.aliyun.com/nexus/content/groups/public&lt;/url&gt;</span><br><span class="line">   &lt;/mirror&gt;  </span><br><span class="line"> &lt;/mirrors&gt;</span><br></pre></td></tr></table></figure>

<h4 id="安装方式2-二进制安装"><a href="#安装方式2-二进制安装" class="headerlink" title="安装方式2: 二进制安装"></a>安装方式2: 二进制安装</h4><p>官方说明:</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://maven.apache.org/install.html</span><br></pre></td></tr></table></figure>

<p>范例: 二进制安装</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">[root@ubuntu1804 ~]<span class="comment"># apt update</span></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment"># apt install openjdk-8-jdk -y</span></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment"># java -version</span></span><br><span class="line">openjdk version <span class="string">&quot;1.8.0_282&quot;</span></span><br><span class="line">OpenJDK Runtime Environment (build 1.8.0_282-8u282-b08-0ubuntu1~18.04-b08)</span><br><span class="line">OpenJDK 64-Bit Server VM (build 25.282-b08, mixed mode)</span><br><span class="line"></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment"># wget https://mirrors.tuna.tsinghua.edu.cn/apache/maven/maven-3/3.6.3/binaries/apache-maven-3.6.3-bin.tar.gz</span></span><br><span class="line"></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment"># tar xf apache-maven-3.6.3-bin.tar.gz -C /usr/local/</span></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment"># ln -s /usr/local/apache-maven-3.6.3/ /usr/local/maven</span></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment"># echo &#x27;PATH=/usr/local/maven/bin:$PATH&#x27; &gt; /etc/profile.d/maven.sh</span></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment"># echo &#x27;export MAVEN_HOME=/usr/local/maven&#x27; &gt;&gt; /etc/profile.d/maven.sh</span></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment"># . /etc/profile.d/maven.sh</span></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment"># mvn -v</span></span><br><span class="line">Apache Maven 3.6.3 (cecedd343002696d0abb50b32b541b8a6ba2883f)</span><br><span class="line">Maven home: /usr/local/maven</span><br><span class="line">Java version: 1.8.0_282, vendor: Private Build, runtime: /usr/lib/jvm/java-8-openjdk-amd64/jre</span><br><span class="line">Default locale: en_HK, platform encoding: UTF-8</span><br><span class="line">OS name: <span class="string">&quot;linux&quot;</span>, version: <span class="string">&quot;4.15.0-112-generic&quot;</span>, <span class="built_in">arch</span>: <span class="string">&quot;amd64&quot;</span>, family: <span class="string">&quot;unix&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#镜像加速</span></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment"># vim /usr/local/maven/conf/settings.xml</span></span><br><span class="line"> &lt;mirrors&gt;</span><br><span class="line">   &lt;!--阿里云镜像--&gt;</span><br><span class="line">   &lt;mirror&gt;</span><br><span class="line">       &lt;<span class="built_in">id</span>&gt;nexus-aliyun&lt;/id&gt;</span><br><span class="line">       &lt;mirrorOf&gt;*&lt;/mirrorOf&gt;</span><br><span class="line">       &lt;name&gt;Nexus aliyun&lt;/name&gt;</span><br><span class="line">       &lt;url&gt;http://maven.aliyun.com/nexus/content/groups/public&lt;/url&gt;</span><br><span class="line">   &lt;/mirror&gt;              </span><br><span class="line"> &lt;/mirrors&gt;</span><br></pre></td></tr></table></figure>

<h2 id="Maven-的打包命令说明"><a href="#Maven-的打包命令说明" class="headerlink" title="Maven 的打包命令说明"></a>Maven 的打包命令说明</h2><p>Maven工程构建的各个环节</p>
<ul>
<li>clean: 以前编译得到的旧文件class字节码文件删除</li>
<li>compile:将java源程序编译成class字节码文件</li>
<li>test:自动测试,例如，自动调用junit程序</li>
<li>report:报告测试程序执行的结果</li>
<li>package:应用打包,动态Web工程打成war包,java工程打成jar包</li>
<li>install: 是指将打包得到的文件复制到仓库中指定的位置</li>
<li>deploy:将动态Web工程生成的war包复制到Servlet容器下，使其可以运行</li>
</ul>
<p>范例:  </p>
<ul>
<li>进入到包含有“pom.xml”的路径，执行：</li>
</ul>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mvn clean install package</span><br></pre></td></tr></table></figure>

<ul>
<li>有的时候受到测试的干扰，导致无法正在进行编译，这时候可以选择跳过测试：</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mvn clean install package -Dmaven.test.skip=<span class="literal">true</span></span><br><span class="line"><span class="comment">#选项&quot;-Dmaven.test.skip=true&quot;：跳过测试，并且不编译测试下的源代码</span></span><br><span class="line"><span class="comment">#选项&quot;-DskipTests&quot;：不执行测试，但是会进行测试代码的编译</span></span><br></pre></td></tr></table></figure>

<ul>
<li>如果需要编译的代码很庞大，需要考虑对编译环境做一些处理，提成编译效率：</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#启动多线程编译：</span></span><br><span class="line">mvn -T 4 clean install package -Dmaven.test.skip=<span class="literal">true</span></span><br><span class="line"><span class="comment">#分配编译的CPU 个数：</span></span><br><span class="line">mvn -T 2C clean install package -Dmaven.test.skip=<span class="literal">true</span></span><br><span class="line"><span class="comment">#启用多线程编译：</span></span><br><span class="line">mvn clean install package -Dmaven.test.skip=<span class="literal">true</span> -Dmaven.compile.fork=<span class="literal">true</span></span><br></pre></td></tr></table></figure>

<ul>
<li>所有的 Maven 都是建立在 JVM 上的，所以进行编译的时候还需要考虑JVM 参数优化：</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#如果是windows </span></span><br><span class="line">找到“maven/bin/mvn.cmd”，如果 linux 找到“maven/bin/mvn”，配置参数是：“MAVEN_OPTS”</span><br><span class="line"></span><br><span class="line"><span class="comment">#打开属性配置文件：</span></span><br><span class="line">vim /etc/profile</span><br><span class="line"></span><br><span class="line"><span class="comment">#指定内存配置：</span></span><br><span class="line"><span class="built_in">export</span> MAVEN_OPTS=<span class="string">&quot;-Xmx6g -Xms6g&quot;</span> 注意不要超过物理内存一半</span><br><span class="line"></span><br><span class="line"><span class="comment">#使配置立即生效：</span></span><br><span class="line"><span class="built_in">source</span> /etc/profile</span><br></pre></td></tr></table></figure>

<h2 id="执行-java-代码编译实战案例"><a href="#执行-java-代码编译实战案例" class="headerlink" title="执行 java 代码编译实战案例"></a>执行 java 代码编译实战案例</h2><h3 id="编译安装-spring-boot-项目"><a href="#编译安装-spring-boot-项目" class="headerlink" title="编译安装 spring-boot 项目"></a>编译安装 spring-boot 项目</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">[root@ubuntu1804 ~]<span class="comment"># apt -y install maven git </span></span><br><span class="line"></span><br><span class="line"><span class="comment">#镜像加速</span></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment"># vim /etc/maven/settings.xml</span></span><br><span class="line">   &lt;mirror&gt;</span><br><span class="line">       &lt;<span class="built_in">id</span>&gt;nexus-aliyun&lt;/id&gt;</span><br><span class="line">       &lt;mirrorOf&gt;*&lt;/mirrorOf&gt;</span><br><span class="line">       &lt;name&gt;Nexus aliyun&lt;/name&gt;</span><br><span class="line">       &lt;url&gt;http://maven.aliyun.com/nexus/content/groups/public&lt;/url&gt;</span><br><span class="line">   &lt;/mirror&gt;</span><br><span class="line">   </span><br><span class="line">[root@ubuntu1804 ~]<span class="comment"># cd /data</span></span><br><span class="line">[root@ubuntu1804 data]<span class="comment"># git clone https://gitee.com/lbtooth/spring-boot-helloWorld.git</span></span><br><span class="line">[root@ubuntu1804 data]<span class="comment"># cd spring-boot-helloWorld/</span></span><br><span class="line">[root@ubuntu1804 spring-boot-helloWorld]<span class="comment"># ls</span></span><br><span class="line">deploy Dockerfile Jenkinsfile LICENSE pom.xml README.md src</span><br><span class="line"></span><br><span class="line">[root@ubuntu1804 spring-boot-helloWorld]<span class="comment"># ls src</span></span><br><span class="line">main <span class="built_in">test</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#编译</span></span><br><span class="line">[root@ubuntu1804 spring-boot-helloWorld]<span class="comment"># mvn -T 4 clean package -Dmaven.test.skip=true</span></span><br><span class="line">......</span><br><span class="line">[INFO] --- maven-jar-plugin:3.1.1:jar (default-jar) @ spring-boot-helloworld ---</span><br><span class="line">[INFO] Building jar: /root/spring-boot-helloWorld/target/spring-boot-helloworld-0.9.0-SNAPSHOT.jar</span><br><span class="line">[INFO] </span><br><span class="line">[INFO] --- spring-boot-maven-plugin:2.1.3.RELEASE:repackage (repackage) @ </span><br><span class="line">spring-boot-helloworld ---</span><br><span class="line">[INFO] Replacing main artifact with repackaged archive</span><br><span class="line">[INFO] ------------------------------------------------------------------------</span><br><span class="line">[INFO] BUILD SUCCESS</span><br><span class="line">[INFO] ------------------------------------------------------------------------</span><br><span class="line">[INFO] Total time:  57.183 s (Wall Clock)</span><br><span class="line">[INFO] Finished at: 2022-06-15T09:53:14+08:00</span><br><span class="line">[INFO] ------------------------------------------------------------------------</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@ubuntu1804 spring-boot-helloWorld]<span class="comment"># ls target/</span></span><br><span class="line">classes                 maven-archiver                             spring-boot-helloworld-0.9.0-SNAPSHOT.jar.original</span><br><span class="line">generated-sources       maven-status                               surefire-reports</span><br><span class="line">generated-test-sources spring-boot-helloworld-0.9.0-SNAPSHOT.jar test-classes</span><br><span class="line"></span><br><span class="line"><span class="comment">#默认为8080端口</span></span><br><span class="line">[root@ubuntu1804 spring-boot-helloWorld]<span class="comment">#java -jar target/spring-boot-helloworld-0.9.0-SNAPSHOT.jar --server.port=8888</span></span><br></pre></td></tr></table></figure>

<p><img src="../../../../images/SRE/day33/187.jpg" alt="187"><br><img src="../../../../images/SRE/day33/188.jpg" alt="188"></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[root@ubuntu1804 ~]<span class="comment"># ss -ntl</span></span><br><span class="line">State         Recv-Q   Send-Q     Local Address:Port   Peer Address:Port Process       </span><br><span class="line">LISTEN         0        128              0.0.0.0:22           0.0.0.0:*</span><br><span class="line">LISTEN         0        100            127.0.0.1:25           0.0.0.0:*         </span><br><span class="line">LISTEN         0        128                 [::]:22              [::]:*</span><br><span class="line">LISTEN         0        100                    *:8888               *:*</span><br><span class="line">LISTEN         0        100                [::1]:25              [::]:*   </span><br><span class="line"></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment"># curl 127.0.0.1:8888</span></span><br><span class="line">Hello Spring Boot 2.0!</span><br><span class="line"></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment"># curl 127.0.0.1:8888/hello</span></span><br><span class="line">Hello World</span><br></pre></td></tr></table></figure>

<h3 id="编译-java-程序-Jpress"><a href="#编译-java-程序-Jpress" class="headerlink" title="编译 java 程序 Jpress"></a>编译 java 程序 Jpress</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#下载源码</span></span><br><span class="line">[root@rocky8 ~]<span class="comment"># git clone https://gitee.com/JPressProjects/jpress.git</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#或者</span></span><br><span class="line">[root@rocky8 ~]<span class="comment"># wget -O jpress-v4.2.0.tar.gz &#x27;https://gitee.com/JPressProjects/jpress/repository/archive/v4.2.0?format=tar.gz&#x27;</span></span><br><span class="line"></span><br><span class="line">[root@rocky8 ~]<span class="comment"># tar xf jpress-v4.2.0.tar.gz</span></span><br><span class="line">[root@rocky8 ~]<span class="comment"># cd jpress-v4.2.0/</span></span><br><span class="line">[root@rocky8 jpress-v4.2.0]<span class="comment"># ls</span></span><br><span class="line">changes.txt docker             Dockerfile     jpress-commons jpress-service   </span><br><span class="line">        jpress-template module-article pom.xml   starter-tomcat</span><br><span class="line">codegen     docker-build.sh     install.sh     jpress-core     jpress-service-provider jpress-web       module-page     README.md upgrade.sh</span><br><span class="line">doc         docker-compose.yml jpress-addons jpress-model   jpress.sql       </span><br><span class="line">        LICENSE         module-product starter</span><br><span class="line">        </span><br><span class="line">[root@rocky8 jpress-v4.2.0]<span class="comment"># mvn clean install package -Dmaven.test.skip=true</span></span><br><span class="line">...</span><br><span class="line">[INFO] module-product-search-db ........................... SUCCESS [  0.095 s]</span><br><span class="line">[INFO] module-product-search-lucene ....................... SUCCESS [  0.101 s]</span><br><span class="line">[INFO] module-product-search-es ........................... SUCCESS [  0.160 s]</span><br><span class="line">[INFO] module-product-search-opensearch ................... SUCCESS [  0.120 s]</span><br><span class="line">[INFO] module-product-service-provider .................... SUCCESS [  0.228 s]</span><br><span class="line">[INFO] module-product-web ................................. SUCCESS [  0.274 s]</span><br><span class="line">[INFO] starter ............................................ SUCCESS [01:20 min]</span><br><span class="line">[INFO] starter-tomcat 4.0 ................................. SUCCESS [  8.736 s]</span><br><span class="line">[INFO] ------------------------------------------------------------------------</span><br><span class="line">[INFO] BUILD SUCCESS</span><br><span class="line">[INFO] ------------------------------------------------------------------------</span><br><span class="line">[INFO] Total time: 03:00 min</span><br><span class="line">[INFO] Finished at: 2021-12-15T18:18:06+08:00</span><br><span class="line">[INFO] ------------------------------------------------------------------------</span><br><span class="line"></span><br><span class="line">[root@rocky8 jpress-v4.2.0]<span class="comment"># cp starter-tomcat/target/starter-tomcat-4.0.war usr/local/tomcat/webapps/jpress.war</span></span><br></pre></td></tr></table></figure>

<h1 id="私有仓库-Nexus"><a href="#私有仓库-Nexus" class="headerlink" title="私有仓库 Nexus"></a>私有仓库 Nexus</h1><h2 id="Nexus-介绍"><a href="#Nexus-介绍" class="headerlink" title="Nexus 介绍"></a>Nexus 介绍</h2><p>Nexus 是一个强大的 Maven 和其它仓库的管理器，它极大地简化了自己内部仓库的维护和外部仓库的访问。</p>
<p>Nexus 官网:</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://www.sonatype.com/</span><br></pre></td></tr></table></figure>

<p>官方下载说明</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://help.sonatype.com/repomanager3/download</span><br></pre></td></tr></table></figure>

<p><img src="../../../../images/SRE/day33/189.jpg" alt="189"></p>
<p>官方下载页面</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://help.sonatype.com/repomanager3/download/download-archives---repository-manager-3 </span><br></pre></td></tr></table></figure>

<p>官方安装文档链接</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://help.sonatype.com/repomanager3/installation</span><br></pre></td></tr></table></figure>

<p>安装要求</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">https://help.sonatype.com/repomanager3/installation/system-requirements</span><br><span class="line">#官方要求内存8G以上，太小比如4G以下会导致无法启动</span><br></pre></td></tr></table></figure>

<h2 id="部署-Nexus"><a href="#部署-Nexus" class="headerlink" title="部署 Nexus"></a>部署 Nexus</h2><h3 id="下载并启动-Nexus"><a href="#下载并启动-Nexus" class="headerlink" title="下载并启动 Nexus"></a>下载并启动 Nexus</h3><p><strong>注意: : 安装Nexus建议内存至少4G以上</strong></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#安装JDK</span></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment"># apt install openjdk-8-jdk -y</span></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment"># java -version</span></span><br><span class="line">openjdk version <span class="string">&quot;1.8.0_282&quot;</span></span><br><span class="line">OpenJDK Runtime Environment (build 1.8.0_282-8u282-b08-0ubuntu1~18.04-b08)</span><br><span class="line">OpenJDK 64-Bit Server VM (build 25.282-b08, mixed mode)</span><br><span class="line"></span><br><span class="line"><span class="comment">#可能需要科学上网下载</span></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment"># wget https://download.sonatype.com/nexus/3/nexus-3.29.2-02-unix.tar.gz</span></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment"># ll -h nexus-3.29.2-02-unix.tar.gz </span></span><br><span class="line">-rw-r--r-- 1 root root 155M Feb 18 17:09 nexus-3.29.2-02-unix.tar.gz</span><br><span class="line"></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment"># tar xf nexus-3.29.2-02-unix.tar.gz -C /usr/local/</span></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment"># ln -s /usr/local/nexus-3.29.2-02/ /usr/local/nexus</span></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment"># ln -s /usr/local/nexus/bin/nexus /usr/bin/</span></span><br><span class="line"></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment"># file /usr/local/nexus/bin/nexus</span></span><br><span class="line">bin/nexus: POSIX shell script, ASCII text executable, with very long lines</span><br><span class="line"></span><br><span class="line"><span class="comment">#指定运行身份</span></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment"># vim /usr/local/nexus/bin/nexus.rc</span></span><br><span class="line">run_as_user=<span class="string">&quot;root&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#查看配置文件,可以在此文件中修改端口等配置</span></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment"># cat /usr/local/nexus/etc/nexus-default.properties</span></span><br><span class="line"><span class="comment">## DO NOT EDIT - CUSTOMIZATIONS BELONG IN $data-dir/etc/nexus.properties</span></span><br><span class="line"><span class="comment">##</span></span><br><span class="line"><span class="comment"># Jetty section</span></span><br><span class="line">application-port=8081</span><br><span class="line">application-host=0.0.0.0</span><br><span class="line">nexus-args=<span class="variable">$&#123;jetty.etc&#125;</span>/jetty.xml,<span class="variable">$&#123;jetty.etc&#125;</span>/jetty-http.xml,<span class="variable">$&#123;jetty.etc&#125;</span>/jetty-requestlog.xml</span><br><span class="line">nexus-context-path=/</span><br><span class="line"></span><br><span class="line"><span class="comment"># Nexus section</span></span><br><span class="line">nexus-edition=nexus-pro-edition</span><br><span class="line">nexus-features=\</span><br><span class="line"> nexus-pro-feature</span><br><span class="line">nexus.hazelcast.discovery.isEnabled=<span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#查看JVM配置文件</span></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment"># cat /usr/local/nexus/bin/nexus.vmoptions</span></span><br><span class="line">-Xms2703m</span><br><span class="line">-Xmx2703m</span><br><span class="line">......</span><br><span class="line"></span><br><span class="line"><span class="comment">#前台运行</span></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment"># nexus run </span></span><br><span class="line">WARNING: ************************************************************</span><br><span class="line">WARNING: Detected execution as <span class="string">&quot;root&quot;</span> user. This is NOT recommended!</span><br><span class="line">WARNING: ************************************************************</span><br><span class="line">.....</span><br><span class="line">2021-02-18 17:20:21,580+0800 INFO [jetty-main-1] *SYSTEM </span><br><span class="line">org.eclipse.jetty.server.Server - Started @37755ms</span><br><span class="line">2021-02-18 17:20:21,581+0800 INFO [jetty-main-1] *SYSTEM </span><br><span class="line">org.sonatype.nexus.bootstrap.jetty.JettyServer -</span><br><span class="line">-------------------------------------------------</span><br><span class="line">Started Sonatype Nexus OSS 3.29.2-02</span><br><span class="line">-------------------------------------------------</span><br><span class="line"></span><br><span class="line"><span class="comment">#注意: 如果内存太小,可能会出现下面提示错误</span></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment"># nexus run </span></span><br><span class="line">WARNING: ************************************************************</span><br><span class="line">WARNING: Detected execution as <span class="string">&quot;root&quot;</span> user. This is NOT recommended!</span><br><span class="line">WARNING: ************************************************************</span><br><span class="line">OpenJDK 64-Bit Server VM warning: INFO: os::commit_memory(0x0000000717000000, </span><br><span class="line">1890582528, 0) failed; error=<span class="string">&#x27;Cannot allocate memory&#x27;</span> (errno=12)</span><br><span class="line"></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># There is insufficient memory for the Java Runtime Environment to continue.</span></span><br><span class="line"><span class="comment"># Native memory allocation (mmap) failed to map 1890582528 bytes for committing reserved memory.</span></span><br><span class="line"><span class="comment"># An error report file with more information is saved as:</span></span><br><span class="line"><span class="comment"># /usr/local/nexus-3.29.2-02/hs_err_pid7285.log</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#后台运行</span></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment"># nexus start</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#查看状态</span></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment"># nexus status</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#停止服务</span></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment"># nexus stop</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#查看端口</span></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment"># ss -ntlp|grep java</span></span><br><span class="line">LISTEN   0  50     0.0.0.0:8081    0.0.0.0:*   <span class="built_in">users</span>:((&quot;java&quot;,pid=<span class="number">20564</span>,fd=<span class="number">798</span>)) </span><br><span class="line">LISTEN   0  1    127.0.0.1:38147   0.0.0.0:*   <span class="built_in">users</span>:((&quot;java&quot;,pid=<span class="number">20564</span>,fd=<span class="number">125</span>)) </span><br><span class="line"></span><br><span class="line"><span class="comment">#创建service文件</span></span><br><span class="line"><span class="comment">#参考链接https://help.sonatype.com/repomanager3/installation/system-requirements</span></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment"># cat   /lib/systemd/system/nexus.service</span></span><br><span class="line">[Unit]</span><br><span class="line">Description=nexus service</span><br><span class="line">After=network.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">Type=forking</span><br><span class="line">LimitNOFILE=65536</span><br><span class="line">ExecStart=/usr/local/nexus/bin/nexus start</span><br><span class="line">ExecStop=/usr/local/nexus/bin/nexus stop</span><br><span class="line">User=root</span><br><span class="line"><span class="comment">#User=nexus</span></span><br><span class="line">Restart=on-abort</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line"></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment"># systemctl daemon-reload </span></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment"># systemctl enable --now nexus.service</span></span><br><span class="line"></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment"># tail /var/log/syslog</span></span><br><span class="line">Aug  4 12:20:23 ubuntu1804 systemd[1]: Starting nexus service...</span><br><span class="line">Aug  4 12:20:23 ubuntu1804 nexus[9534]: WARNING: </span><br><span class="line">************************************************************</span><br><span class="line">Aug  4 12:20:23 ubuntu1804 nexus[9534]: WARNING: Detected execution as <span class="string">&quot;root&quot;</span></span><br><span class="line">user. This is NOT recommended!</span><br><span class="line">Aug  4 12:20:23 ubuntu1804 nexus[9534]: WARNING: </span><br><span class="line">************************************************************</span><br><span class="line">Aug  4 12:20:23 ubuntu1804 nexus[9534]: Starting nexus</span><br><span class="line">Aug  4 12:20:23 ubuntu1804 systemd[1]: Started nexus service.</span><br><span class="line">Aug  4 12:21:58 ubuntu1804 systemd[1]: Reloading.</span><br></pre></td></tr></table></figure>

<h3 id="登录-web-界面初始化"><a href="#登录-web-界面初始化" class="headerlink" title="登录 web 界面初始化"></a>登录 web 界面初始化</h3><p>通过浏览器访问</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://nexus主机:8081/</span><br></pre></td></tr></table></figure>

<p>默认打开无法进行管理</p>
<p><img src="../../../../images/SRE/day33/190.jpg" alt="190"></p>
<p>需要在右上角点Sign in 进行登录才能进行管理</p>
<p><img src="../../../../images/SRE/day33/191.jpg" alt="191"></p>
<p>查看默认密码</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@ubuntu1804 ~]<span class="comment"># cat /usr/local/sonatype-work/nexus3/admin.password</span></span><br><span class="line">f88248fc-2589-44da-af76-4b01855591b8</span><br></pre></td></tr></table></figure>

<p>设置密码,使用admin用户和上面的密码登录</p>
<p><img src="../../../../images/SRE/day33/192.jpg" alt="192"><br><img src="../../../../images/SRE/day33/193.jpg" alt="193"></p>
<p>重设密码</p>
<p><img src="../../../../images/SRE/day33/194.jpg" alt="194"></p>
<p>启用匿名访问将默认允许未经授权的下载，浏览和搜索存储库内容，可以通过编辑分配给匿名用户的角色来更改匿名用户的权限。 </p>
<p><strong>生产建议打开匿名访问功能,无需登录就可以下载资源</strong></p>
<p><img src="../../../../images/SRE/day33/195.jpg" alt="195"></p>
<p>配置完成</p>
<p><img src="../../../../images/SRE/day33/196.jpg" alt="196"></p>
<h3 id="验证默认仓库"><a href="#验证默认仓库" class="headerlink" title="验证默认仓库"></a>验证默认仓库</h3><p>默认仓库有以下 type 类型</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Hosted：本地仓库，通常我们会部署自己的构件到这一类型的仓库，比如公司的第三方库</span><br><span class="line">Proxy：代理仓库，它们被用来代理远程的公共仓库，如maven 中央仓库(官方仓库)</span><br><span class="line">Group：仓库组，用来合并多个 hosted/proxy 仓库，当你的项目希望在多个repository 使用资源时就不需要多次引用了，只需要引用一个 group 即可</span><br></pre></td></tr></table></figure>

<p><img src="../../../../images/SRE/day33/197.jpg" alt="197"></p>
<h3 id="Maven的仓库优化配置"><a href="#Maven的仓库优化配置" class="headerlink" title="Maven的仓库优化配置"></a>Maven的仓库优化配置</h3><p>默认仓库maven-central使用国外仓库地址,可修改为如下的国内镜像地址进行加速</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://maven.aliyun.com/nexus/content/groups/public</span><br></pre></td></tr></table></figure>

<p><img src="../../../../images/SRE/day33/198.jpg" alt="198"><br><img src="../../../../images/SRE/day33/199.jpg" alt="199"></p>
<p>可以修改为国内镜像,参考阿里云以下说明</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://maven.aliyun.com/mvn/guide</span><br></pre></td></tr></table></figure>

<p><img src="../../../../images/SRE/day33/200.jpg" alt="200"></p>
<h3 id="配置邮件"><a href="#配置邮件" class="headerlink" title="配置邮件"></a>配置邮件</h3><p><img src="../../../../images/SRE/day33/201.jpg" alt="201"><br><img src="../../../../images/SRE/day33/202.jpg" alt="202"><br><img src="../../../../images/SRE/day33/203.jpg" alt="203"></p>
<h2 id="使用-Nexus-构建私有-Yum-和-Apt-仓库"><a href="#使用-Nexus-构建私有-Yum-和-Apt-仓库" class="headerlink" title="使用 Nexus 构建私有 Yum 和 Apt 仓库"></a>使用 Nexus 构建私有 Yum 和 Apt 仓库</h2><p>通过 Nexus 构建为公司内网 Yum 和 Apt 仓库,代理至阿里云镜像安装包</p>
<h3 id="使用-Nexus-构建私有-Yum-仓库"><a href="#使用-Nexus-构建私有-Yum-仓库" class="headerlink" title="使用 Nexus 构建私有 Yum 仓库"></a>使用 Nexus 构建私有 Yum 仓库</h3><h4 id="创建-Blob-Store"><a href="#创建-Blob-Store" class="headerlink" title="创建 Blob Store"></a>创建 Blob Store</h4><p>阿里云镜像地址</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://mirrors.aliyun.com/zabbix/zabbix/5.0/rhel/7/x86_64/</span><br></pre></td></tr></table></figure>

<p>创建自定义存储存放仓库数据</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@ubuntu1804 ~]<span class="comment"># mkdir -p /data/blobs/</span></span><br></pre></td></tr></table></figure>

<p><img src="../../../../images/SRE/day33/204.jpg" alt="204"><br><img src="../../../../images/SRE/day33/205.jpg" alt="205"><br><img src="../../../../images/SRE/day33/206.jpg" alt="206"></p>
<h4 id="创建-Yum-仓库"><a href="#创建-Yum-仓库" class="headerlink" title="创建 Yum 仓库"></a>创建 Yum 仓库</h4><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">setting--Create repository—yum(proxy)</span><br></pre></td></tr></table></figure>

<p><img src="../../../../images/SRE/day33/207.jpg" alt="207"><br><img src="../../../../images/SRE/day33/208.jpg" alt="208"><br><img src="../../../../images/SRE/day33/209.jpg" alt="209"><br><img src="../../../../images/SRE/day33/210.jpg" alt="210"></p>
<p>默认路径下没有文件</p>
<p><img src="../../../../images/SRE/day33/211.jpg" alt="211"></p>
<h4 id="将nexus-服务仓库配置为yum仓库"><a href="#将nexus-服务仓库配置为yum仓库" class="headerlink" title="将nexus 服务仓库配置为yum仓库"></a>将nexus 服务仓库配置为yum仓库</h4><p>准备一台CentOS7的系统,测试将nexus服务器做为yum仓库源</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">[root@centos7 ~]<span class="comment"># cat &gt; /etc/yum.repos.d/zabbix.repo &lt;&lt;EOF</span></span><br><span class="line">&gt; [zabbix-nexus]</span><br><span class="line">&gt; name=zabbix-nexus</span><br><span class="line">&gt; baseurl=http://10.0.0.100:8081/repository/zabbix-5.0-yum-centos7/</span><br><span class="line">&gt; gpgcheck=0</span><br><span class="line">&gt; EOF</span><br><span class="line"></span><br><span class="line">[root@centos7 ~]<span class="comment"># yum repolist</span></span><br><span class="line">Loaded plugins: fastestmirror</span><br><span class="line">Loading mirror speeds from cached hostfile</span><br><span class="line"> * base: </span><br><span class="line">repo <span class="built_in">id</span>                 repo name status</span><br><span class="line">base/7/x86_64           CentOS     10,070</span><br><span class="line">epel/7/x86_64           EPEL       13,523</span><br><span class="line">extras/7/x86_64         extras        451</span><br><span class="line">zabbix-nexus           zabbix-nexus  100</span><br><span class="line">repolist: 24,144</span><br><span class="line"></span><br><span class="line">[root@centos7 ~]<span class="comment"># yum install --downloadonly sl</span></span><br><span class="line">[root@centos7 ~]<span class="comment"># yum -y install zabbix-agent</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#如果是Centos8,下载包存放在/var/cache/dnf/下面</span></span><br><span class="line">[root@centos7 ~]<span class="comment"># ls /var/cache/yum/x86_64/7/epel/packages/</span></span><br><span class="line">sl-5.02-1.el7.x86_64.rpm</span><br><span class="line"></span><br><span class="line"><span class="comment">#在nexus服务器存储目录下自动下载相关文件</span></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment"># ls /data/blobs/blob-zabbix-5.0-yum-centos7</span></span><br><span class="line">899D2379-D9D78DB2-4B816C59-1418D257-7A0183F0-deletions.index     content</span><br><span class="line">899D2379-D9D78DB2-4B816C59-1418D257-7A0183F0-metrics.properties </span><br><span class="line">metadata.properties</span><br></pre></td></tr></table></figure>

<p>查看nexus服务器的仓库路径下可以看到下面文件和目录</p>
<p><img src="../../../../images/SRE/day33/212.jpg" alt="212"></p>
<h3 id="使用-Nexus-构建私有-Apt-仓库"><a href="#使用-Nexus-构建私有-Apt-仓库" class="headerlink" title="使用 Nexus 构建私有 Apt 仓库"></a>使用 Nexus 构建私有 Apt 仓库</h3><p>阿里云镜像地址</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://mirrors.aliyun.com/ubuntu/</span><br></pre></td></tr></table></figure>

<h4 id="创建-Blob-Store-1"><a href="#创建-Blob-Store-1" class="headerlink" title="创建 Blob Store"></a>创建 Blob Store</h4><p><img src="../../../../images/SRE/day33/213.jpg" alt="213"></p>
<h4 id="创建-Apt-仓库"><a href="#创建-Apt-仓库" class="headerlink" title="创建 Apt 仓库"></a>创建 Apt 仓库</h4><p><img src="../../../../images/SRE/day33/214.jpg" alt="214"></p>
<p>生成仓库路径</p>
<p><img src="../../../../images/SRE/day33/215.jpg" alt="215"></p>
<h4 id="配置客户端的-apt-源指向私有仓库路径"><a href="#配置客户端的-apt-源指向私有仓库路径" class="headerlink" title="配置客户端的 apt 源指向私有仓库路径"></a>配置客户端的 apt 源指向私有仓库路径</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line">[root@ubuntu1804 ~]<span class="comment"># cat /etc/apt/sources.list</span></span><br><span class="line">deb http://10.0.0.100:8081/repository/ubuntu1804-apt/ bionic main restricted universe multiverse</span><br><span class="line">deb-src http://10.0.0.100:8081/repository/ubuntu1804-apt/ bionic main restricted universe multiverse</span><br><span class="line"></span><br><span class="line">deb http://10.0.0.100:8081/repository/ubuntu1804-apt/ bionic-security main restricted universe multiverse</span><br><span class="line">deb-src http://10.0.0.100:8081/repository/ubuntu1804-apt/ bionic-security main restricted universe multiverse</span><br><span class="line"></span><br><span class="line">deb http://10.0.0.100:8081/repository/ubuntu1804-apt/ bionic-updates main restricted universe multiverse</span><br><span class="line">deb-src http://10.0.0.100:8081/repository/ubuntu1804-apt/ bionic-updates main restricted universe multiverse</span><br><span class="line"></span><br><span class="line">deb http://10.0.0.100:8081/repository/ubuntu1804-apt/ bionic-proposed main restricted universe multiverse</span><br><span class="line">deb-src http://10.0.0.100:8081/repository/ubuntu1804-apt/ bionic-proposed main restricted universe multiverse</span><br><span class="line"></span><br><span class="line">deb http://10.0.0.100:8081/repository/ubuntu1804-apt/ bionic-backports main restricted universe multiverse</span><br><span class="line">deb-src http://10.0.0.100:8081/repository/ubuntu1804-apt/ bionic-backports main restricted universe multiverse</span><br><span class="line"></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment"># apt update</span></span><br><span class="line">Get:1 http://10.0.0.100:8081/repository/ubuntu1804-apt bionic InRelease [242 kB]</span><br><span class="line">Get:2 http://10.0.0.100:8081/repository/ubuntu1804-apt bionic-security InRelease [88.7 kB]</span><br><span class="line">Get:3 http://10.0.0.100:8081/repository/ubuntu1804-apt bionic-updates InRelease [88.7 kB]</span><br><span class="line">Get:4 http://10.0.0.100:8081/repository/ubuntu1804-apt bionic-proposed InRelease [242 kB]</span><br><span class="line">Get:5 http://10.0.0.100:8081/repository/ubuntu1804-apt bionic-backports InRelease [74.6 kB]</span><br><span class="line"></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment"># apt install sl</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#在nexus服务器上自动生成相关文件</span></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment"># tree /data/blobs/blob-ubuntu1804/|less</span></span><br><span class="line">/data/blobs/blob-ubuntu1804/</span><br><span class="line">├── B1F301F8-B40ABB49-1FAEB7F0-43883B27-6A28E1C4-deletions.index</span><br><span class="line">├── B1F301F8-B40ABB49-1FAEB7F0-43883B27-6A28E1C4-metrics.properties</span><br><span class="line">├── content</span><br><span class="line">│   ├── tmp</span><br><span class="line">│   ├── vol-01</span><br><span class="line">│   │   ├── chap-22</span><br><span class="line">│   │   │   ├── 8e4192c2-1840-4f2c-8a79-e4b1e32b59cd.bytes</span><br><span class="line">│   │   │   └── 8e4192c2-1840-4f2c-8a79-e4b1e32b59cd.properties</span><br><span class="line">│   │   └── chap-38</span><br><span class="line">│   │       ├── 7c73ca13-eda6-4f8a-8047-bbdc363eeeab.bytes</span><br><span class="line">│   │       └── 7c73ca13-eda6-4f8a-8047-bbdc363eeeab.properties</span><br><span class="line">│   ├── vol-02</span><br><span class="line">│   │   ├── chap-12</span><br><span class="line">│   │   │   ├── 028770ba-00c8-4291-a98e-619ec77ffb7f.bytes</span><br><span class="line">│   │   │   └── 028770ba-00c8-4291-a98e-619ec77ffb7f.properties</span><br><span class="line"></span><br><span class="line">[root@ubuntu1804 ~]<span class="comment"># cat /data/blobs/blob-ubuntu1804/content/vol-02/chap-12/028770ba-00c8-4291-a98e-619ec77ffb7f.properties </span></span><br><span class="line"><span class="comment">#2021-08-04 15:05:33,295+0800</span></span><br><span class="line"><span class="comment">#Wed Aug 04 15:05:33 CST 2021</span></span><br><span class="line">@BlobStore.created-by=anonymous</span><br><span class="line">size=9050880</span><br><span class="line">@Bucket.repo-name=ubuntu1804-apt</span><br><span class="line">creationTime=1628060733295</span><br><span class="line">@BlobStore.created-by-ip=10.0.0.106</span><br><span class="line">@BlobStore.content-type=application/x-xz</span><br><span class="line">@BlobStore.blob-name=dists/bionic/universe/source/by-hash/SHA256/b779bf46d2471b11c40d91975bf6d0e088a6c4491223afe4fe688d8062511368</span><br><span class="line">sha1=780fec92a0c16cb41a661de664ec0222105a5bce</span><br></pre></td></tr></table></figure>

<p><img src="../../../../images/SRE/day33/216.jpg" alt="216"></p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="http://example.com">૮(˶ᵔ ᵕ ᵔ˶)ა</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="http://example.com/2025/03/17/SRE-Tomcat/">http://example.com/2025/03/17/SRE-Tomcat/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="http://example.com" target="_blank">૮(˶ᵔ ᵕ ᵔ˶)ა</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/SRE/">SRE</a><a class="post-meta__tags" href="/tags/Tomcat/">Tomcat</a></div><div class="post_share"><div class="social-share" data-image="/../images/SRE/day33/24.jpg" data-sites="wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2025/03/03/SRE-jumpserver/" title="企业级堡垒机JumpServer"><img class="cover" src="https://www.jumpserver.org/images/logo/logo-dark-JumpServer.svg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">企业级堡垒机JumpServer</div></div></a></div><div class="next-post pull-right"><a href="/2025/03/26/SRE-zabbix/" title="企业级监控系统ZABBIX"><img class="cover" src="/../images/SRE/day38/9.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">企业级监控系统ZABBIX</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><div><a href="/2025/04/15/SRE-HAProxy/" title="高可用性集群HAProxy"><img class="cover" src="/../images/SRE/day47/1.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2025-04-15</div><div class="title">高可用性集群HAProxy</div></div></a></div><div><a href="/2025/02/21/SRE-LVS/" title="企业级调度器LVS"><img class="cover" src="/../images/SRE/day27/3.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2025-02-21</div><div class="title">企业级调度器LVS</div></div></a></div><div><a href="/2024/04/24/SRE-Linux%E5%9F%BA%E6%9C%AC%E6%93%8D%E4%BD%9C%E5%92%8C%E5%B8%AE%E5%8A%A9/" title="Linux基本操作和帮助"><img class="cover" src="/../images/TITLE/linux2.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-04-24</div><div class="title">Linux基本操作和帮助</div></div></a></div><div><a href="/2024/08/27/SRE-Linux%E6%96%87%E4%BB%B6%E7%AE%A1%E7%90%86%E5%92%8CIO%E9%87%8D%E5%AE%9A%E5%90%91/" title="Linux文件管理和IO重定向"><img class="cover" src="/../images/TITLE/linux3.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-08-27</div><div class="title">Linux文件管理和IO重定向</div></div></a></div><div><a href="/2024/12/08/SRE-Linux%E9%98%B2%E7%81%AB%E5%A2%99/" title="Linux防火墙"><img class="cover" src="/../images/SRE/day17/12.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-12-08</div><div class="title">Linux防火墙</div></div></a></div><div><a href="/2025/02/18/SRE-OpenVPN/" title="OpenVPN"><img class="cover" src="/../images/SRE/day25/5.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2025-02-18</div><div class="title">OpenVPN</div></div></a></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="/../images/TITLE/user.webp" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">૮(˶ᵔ ᵕ ᵔ˶)ა</div><div class="author-info__description">这家伙很勤奋，什么都留下了</div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">101</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">41</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">34</div></a></div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content is-expand"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Java-%E5%9F%BA%E7%A1%80"><span class="toc-number">1.</span> <span class="toc-text">Java 基础</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#WEB%E6%9E%B6%E6%9E%84"><span class="toc-number">1.1.</span> <span class="toc-text">WEB架构</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Web%E8%B5%84%E6%BA%90%E5%92%8C%E8%AE%BF%E9%97%AE"><span class="toc-number">1.1.1.</span> <span class="toc-text">Web资源和访问</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%90%8E%E5%8F%B0%E5%BA%94%E7%94%A8%E6%9E%B6%E6%9E%84"><span class="toc-number">1.1.2.</span> <span class="toc-text">后台应用架构</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8D%95%E4%BD%93%E6%9E%B6%E6%9E%84"><span class="toc-number">1.1.2.1.</span> <span class="toc-text">单体架构</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%BE%AE%E6%9C%8D%E5%8A%A1"><span class="toc-number">1.1.2.2.</span> <span class="toc-text">微服务</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Java"><span class="toc-number">1.2.</span> <span class="toc-text">Java</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Java%E5%8E%86%E5%8F%B2"><span class="toc-number">1.2.1.</span> <span class="toc-text">Java历史</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Java-%E7%BB%84%E6%88%90"><span class="toc-number">1.2.2.</span> <span class="toc-text">Java 组成</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Java%E5%8A%A8%E6%80%81%E7%BD%91%E9%A1%B5%E6%8A%80%E6%9C%AF"><span class="toc-number">1.2.3.</span> <span class="toc-text">Java动态网页技术</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#servlet"><span class="toc-number">1.2.3.1.</span> <span class="toc-text">servlet</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#jsp%EF%BC%88Java-Server-Pages%EF%BC%89"><span class="toc-number">1.2.3.2.</span> <span class="toc-text">jsp（Java Server Pages）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#MVC"><span class="toc-number">1.2.3.3.</span> <span class="toc-text">MVC</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#REST"><span class="toc-number">1.2.3.4.</span> <span class="toc-text">REST</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#JDK"><span class="toc-number">1.2.4.</span> <span class="toc-text">JDK</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#JDK%E5%92%8CJRE"><span class="toc-number">1.2.4.1.</span> <span class="toc-text">JDK和JRE</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#JDK-%E5%92%8C-JRE-%E5%85%B3%E7%B3%BB"><span class="toc-number">1.2.4.1.1.</span> <span class="toc-text">JDK 和 JRE 关系</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#JVM-%E7%9A%84%E5%90%84%E7%A7%8D%E7%89%88%E6%9C%AC"><span class="toc-number">1.2.4.1.2.</span> <span class="toc-text">JVM 的各种版本</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Oracle-JDK%E7%89%88%E6%9C%AC"><span class="toc-number">1.2.4.2.</span> <span class="toc-text">Oracle JDK版本</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#OpenJDK"><span class="toc-number">1.2.4.3.</span> <span class="toc-text">OpenJDK</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%AE%89%E8%A3%85-openjdk"><span class="toc-number">1.2.4.3.1.</span> <span class="toc-text">安装 openjdk</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%89%E8%A3%85-Oracle-%E5%AE%98%E6%96%B9-JDK"><span class="toc-number">1.2.4.4.</span> <span class="toc-text">安装 Oracle 官方 JDK</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#Oracle-JDK-%E7%9A%84-rpm%E5%AE%89%E8%A3%85"><span class="toc-number">1.2.4.4.1.</span> <span class="toc-text">Oracle JDK 的 rpm安装</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#Oracle-JDK%E7%9A%84%E4%BA%8C%E8%BF%9B%E5%88%B6%E6%96%87%E4%BB%B6%E5%AE%89%E8%A3%85"><span class="toc-number">1.2.4.4.2.</span> <span class="toc-text">Oracle JDK的二进制文件安装</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%B8%80%E9%94%AE%E5%AE%89%E8%A3%85%E4%BA%8C%E8%BF%9B%E5%88%B6%E7%9A%84JDK"><span class="toc-number">1.2.4.4.3.</span> <span class="toc-text">一键安装二进制的JDK</span></a></li></ol></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Tomcat-%E5%9F%BA%E7%A1%80%E5%8A%9F%E8%83%BD"><span class="toc-number">2.</span> <span class="toc-text">Tomcat 基础功能</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Tomcat%E5%8E%86%E5%8F%B2%E5%92%8C%E4%BB%8B%E7%BB%8D"><span class="toc-number">2.1.</span> <span class="toc-text">Tomcat历史和介绍</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#WEB%E5%BA%94%E7%94%A8%E6%9C%8D%E5%8A%A1%E5%99%A8"><span class="toc-number">2.1.1.</span> <span class="toc-text">WEB应用服务器</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Tomcat-%E4%BB%8B%E7%BB%8D"><span class="toc-number">2.1.2.</span> <span class="toc-text">Tomcat 介绍</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Tomcat-%E5%90%84%E7%89%88%E6%9C%AC%E5%8C%BA%E5%88%AB"><span class="toc-number">2.1.3.</span> <span class="toc-text">Tomcat 各版本区别</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Tomcat-%E5%AE%89%E8%A3%85"><span class="toc-number">2.2.</span> <span class="toc-text">Tomcat 安装</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9F%BA%E4%BA%8E%E5%8C%85%E5%AE%89%E8%A3%85-Tomcat"><span class="toc-number">2.2.1.</span> <span class="toc-text">基于包安装 Tomcat</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#CentOS-%E5%8C%85%E5%AE%89%E8%A3%85-tomcat"><span class="toc-number">2.2.1.1.</span> <span class="toc-text">CentOS 包安装 tomcat</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Ubuntu-%E5%8C%85%E5%AE%89%E8%A3%85-tomcat"><span class="toc-number">2.2.1.2.</span> <span class="toc-text">Ubuntu 包安装 tomcat</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BA%8C%E8%BF%9B%E5%88%B6%E5%AE%89%E8%A3%85-Tomcat"><span class="toc-number">2.2.2.</span> <span class="toc-text">二进制安装 Tomcat</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%8B%E8%BD%BD%E5%B9%B6%E5%AE%89%E8%A3%85"><span class="toc-number">2.2.2.1.</span> <span class="toc-text">下载并安装</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE-tomcat-%E8%87%AA%E5%90%AF%E5%8A%A8%E7%9A%84-service-%E6%96%87%E4%BB%B6"><span class="toc-number">2.2.2.2.</span> <span class="toc-text">配置 tomcat 自启动的 service 文件</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9E%E6%88%98%E6%A1%88%E4%BE%8B%EF%BC%9A-%E4%B8%80%E9%94%AE%E5%AE%89%E8%A3%85-tomcat-%E8%84%9A%E6%9C%AC"><span class="toc-number">2.2.3.</span> <span class="toc-text">实战案例： 一键安装 tomcat 脚本</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Tomcat-%E7%9A%84%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84%E5%92%8C%E7%BB%84%E6%88%90"><span class="toc-number">2.3.</span> <span class="toc-text">Tomcat 的文件结构和组成</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%9B%AE%E5%BD%95%E7%BB%93%E6%9E%84"><span class="toc-number">2.3.1.</span> <span class="toc-text">目录结构</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6"><span class="toc-number">2.3.2.</span> <span class="toc-text">配置文件</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%E8%AF%B4%E6%98%8E"><span class="toc-number">2.3.2.1.</span> <span class="toc-text">配置文件说明</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%97%A5%E5%BF%97%E6%96%87%E4%BB%B6"><span class="toc-number">2.3.2.2.</span> <span class="toc-text">日志文件</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BB%84%E4%BB%B6"><span class="toc-number">2.3.3.</span> <span class="toc-text">组件</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%BB%84%E4%BB%B6%E5%88%86%E5%B1%82%E5%92%8C%E5%88%86%E7%B1%BB"><span class="toc-number">2.3.3.1.</span> <span class="toc-text">组件分层和分类</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Tomcat-%E5%86%85%E9%83%A8%E7%BB%84%E6%88%90"><span class="toc-number">2.3.3.2.</span> <span class="toc-text">Tomcat 内部组成</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%A0%B8%E5%BF%83%E7%BB%84%E4%BB%B6"><span class="toc-number">2.3.3.3.</span> <span class="toc-text">核心组件</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#tomcat-%E5%A4%84%E7%90%86%E8%AF%B7%E6%B1%82%E8%BF%87%E7%A8%8B"><span class="toc-number">2.3.3.4.</span> <span class="toc-text">tomcat 处理请求过程</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Java-%E5%BA%94%E7%94%A8%E9%83%A8%E7%BD%B2"><span class="toc-number">2.4.</span> <span class="toc-text">Java 应用部署</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#tomcat%E7%9A%84%E6%A0%B9%E7%9B%AE%E5%BD%95%E7%BB%93%E6%9E%84"><span class="toc-number">2.4.1.</span> <span class="toc-text">tomcat的根目录结构</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#JSP-WebApp%E7%9B%AE%E5%BD%95%E7%BB%93%E6%9E%84"><span class="toc-number">2.4.2.</span> <span class="toc-text">JSP WebApp目录结构</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%BB%E9%A1%B5%E8%AE%BE%E7%BD%AE"><span class="toc-number">2.4.3.</span> <span class="toc-text">主页设置</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%85%A8%E5%B1%80%E9%85%8D%E7%BD%AE%E5%AE%9E%E7%8E%B0%E4%BF%AE%E6%94%B9%E9%BB%98%E8%AE%A4%E4%B8%BB%E9%A1%B5%E6%96%87%E4%BB%B6"><span class="toc-number">2.4.3.1.</span> <span class="toc-text">全局配置实现修改默认主页文件</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#WebApp%E7%9A%84%E4%B8%93%E7%94%A8%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6"><span class="toc-number">2.4.3.2.</span> <span class="toc-text">WebApp的专用配置文件</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%BA%94%E7%94%A8%E9%83%A8%E7%BD%B2%E5%AE%9E%E7%8E%B0"><span class="toc-number">2.4.4.</span> <span class="toc-text">应用部署实现</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#WebApp%E5%BA%94%E7%94%A8%E7%9A%84%E5%BD%92%E6%A1%A3%E6%A0%BC%E5%BC%8F"><span class="toc-number">2.4.4.1.</span> <span class="toc-text">WebApp应用的归档格式</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%83%A8%E7%BD%B2%E6%96%B9%E5%BC%8F"><span class="toc-number">2.4.4.2.</span> <span class="toc-text">部署方式</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%83%A8%E7%BD%B2WebApp%E7%9A%84%E7%9B%AE%E5%BD%95%E7%BB%93%E6%9E%84"><span class="toc-number">2.4.4.3.</span> <span class="toc-text">部署WebApp的目录结构</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%9E%E6%88%98%E6%A1%88%E4%BE%8B%EF%BC%9A%E6%89%8B%E5%8A%A8%E7%9A%84%E5%BA%94%E7%94%A8%E9%83%A8%E7%BD%B2"><span class="toc-number">2.4.4.4.</span> <span class="toc-text">实战案例：手动的应用部署</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E9%83%A8%E7%BD%B2%E4%B8%BB%E9%A1%B5%E7%9B%AE%E5%BD%95%E4%B8%8B%E7%9A%84%E5%BA%94%E7%94%A8WebApp"><span class="toc-number">2.4.4.4.1.</span> <span class="toc-text">部署主页目录下的应用WebApp</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E9%83%A8%E7%BD%B2%E4%B8%80%E4%B8%AA%E5%AD%90%E7%9B%AE%E5%BD%95%E7%9A%84%E5%BA%94%E7%94%A8WebApp"><span class="toc-number">2.4.4.4.2.</span> <span class="toc-text">部署一个子目录的应用WebApp</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%9E%E6%88%98%E6%A1%88%E4%BE%8B%EF%BC%9A%E8%87%AA%E5%8A%A8%E7%9A%84%E5%BA%94%E7%94%A8%E9%83%A8%E7%BD%B2war%E5%8C%85"><span class="toc-number">2.4.4.5.</span> <span class="toc-text">实战案例：自动的应用部署war包</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%88%B6%E4%BD%9C%E5%BA%94%E7%94%A8%E7%9A%84war%E5%8C%85%E6%96%87%E4%BB%B6"><span class="toc-number">2.4.4.5.1.</span> <span class="toc-text">制作应用的war包文件</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E8%87%AA%E5%8A%A8%E5%BA%94%E7%94%A8%E9%83%A8%E7%BD%B2%E4%B8%8A%E9%9D%A2%E7%9A%84war%E5%8C%85"><span class="toc-number">2.4.4.5.2.</span> <span class="toc-text">自动应用部署上面的war包</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%9E%E7%AB%99%E6%A1%88%E4%BE%8B-%E9%83%A8%E7%BD%B2%E5%9F%BA%E4%BA%8EJAVA%E7%9A%84%E5%8D%9A%E5%AE%A2%E7%B3%BB%E7%BB%9F-JPress"><span class="toc-number">2.4.4.6.</span> <span class="toc-text">实站案例: 部署基于JAVA的博客系统 JPress</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%9E%E6%88%98%E6%A1%88%E4%BE%8B-%E9%83%A8%E7%BD%B2%E5%9F%BA%E4%BA%8EJAR%E5%8C%85%E7%9A%84%E5%8D%9A%E5%AE%A2%E7%B3%BB%E7%BB%9F-Halo"><span class="toc-number">2.4.4.7.</span> <span class="toc-text">实战案例: 部署基于JAR包的博客系统 Halo</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%9F%BA%E4%BA%8EWEB%E7%9A%84%E7%AE%A1%E7%90%86Server-status%E5%92%8CManager-APP%E5%AE%9E%E7%8E%B0%E5%BA%94%E7%94%A8%E9%83%A8%E7%BD%B2"><span class="toc-number">2.4.4.8.</span> <span class="toc-text">基于WEB的管理Server status和Manager APP实现应用部署</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0WEB%E7%9A%84%E7%AE%A1%E7%90%86Server-status%E5%92%8CManager-APP"><span class="toc-number">2.4.4.8.1.</span> <span class="toc-text">实现WEB的管理Server status和Manager APP</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%9F%BA%E4%BA%8EWEB%E5%BA%94%E7%94%A8%E7%A8%8B%E5%BA%8F%E7%AE%A1%E7%90%86%E5%99%A8%E5%AE%9E%E7%8E%B0APP%E7%9A%84%E9%83%A8%E7%BD%B2"><span class="toc-number">2.4.4.8.2.</span> <span class="toc-text">基于WEB应用程序管理器实现APP的部署</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B8%B8%E8%A7%81%E9%85%8D%E7%BD%AE%E8%AF%A6%E8%A7%A3"><span class="toc-number">2.4.5.</span> <span class="toc-text">常见配置详解</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%AB%AF%E5%8F%A38005-tcp-%E5%AE%89%E5%85%A8%E9%85%8D%E7%BD%AE%E7%AE%A1%E7%90%86"><span class="toc-number">2.4.5.1.</span> <span class="toc-text">端口8005&#x2F;tcp 安全配置管理</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%98%BE%E7%A4%BA%E6%8C%87%E5%AE%9A%E7%9A%84http%E6%9C%8D%E5%8A%A1%E5%99%A8%E7%89%88%E6%9C%AC%E4%BF%A1%E6%81%AF"><span class="toc-number">2.4.5.2.</span> <span class="toc-text">显示指定的http服务器版本信息</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%85%B6%E5%AE%83%E9%85%8D%E7%BD%AE"><span class="toc-number">2.4.5.3.</span> <span class="toc-text">其它配置</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%A4%9A%E8%99%9A%E6%8B%9F%E4%B8%BB%E6%9C%BA%E9%85%8D%E7%BD%AE"><span class="toc-number">2.4.5.4.</span> <span class="toc-text">多虚拟主机配置</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%A4%9A%E8%99%9A%E6%8B%9F%E4%B8%BB%E6%9C%BA%E9%85%8D%E7%BD%AE%E8%AF%B4%E6%98%8E"><span class="toc-number">2.4.5.4.1.</span> <span class="toc-text">多虚拟主机配置说明</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%AE%9E%E6%88%98%E6%A1%88%E4%BE%8B%EF%BC%9Atomcat%E5%AE%9E%E7%8E%B0%E5%A4%9A%E8%99%9A%E6%8B%9F%E4%B8%BB%E6%9C%BA"><span class="toc-number">2.4.5.4.2.</span> <span class="toc-text">实战案例：tomcat实现多虚拟主机</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%AE%9E%E6%88%98%E6%A1%88%E4%BE%8B%EF%BC%9A%E4%BF%AE%E6%94%B9tomcat%E5%AE%9E%E7%8E%B0%E5%A4%9A%E8%99%9A%E6%8B%9F%E4%B8%BB%E6%9C%BA%E7%9A%84%E7%AB%AF%E5%8F%A3%E4%B8%BA80"><span class="toc-number">2.4.5.4.3.</span> <span class="toc-text">实战案例：修改tomcat实现多虚拟主机的端口为80</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%9F%BA%E4%BA%8Eweb%E6%96%B9%E5%BC%8F%E7%9A%84Host-Manager%E8%99%9A%E6%8B%9F%E4%B8%BB%E6%9C%BA%E7%AE%A1%E7%90%86"><span class="toc-number">2.4.5.5.</span> <span class="toc-text">基于web方式的Host Manager虚拟主机管理</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%85%81%E8%AE%B8%E6%9C%AC%E6%9C%BA%E8%AE%BF%E9%97%AE"><span class="toc-number">2.4.5.5.1.</span> <span class="toc-text">允许本机访问</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%85%81%E8%AE%B8%E8%BF%9C%E7%A8%8B%E4%B8%BB%E6%9C%BA%E8%AE%BF%E9%97%AE"><span class="toc-number">2.4.5.5.2.</span> <span class="toc-text">允许远程主机访问</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E6%96%B0%E7%9A%84%E8%99%9A%E6%8B%9F%E4%B8%BB%E6%9C%BA"><span class="toc-number">2.4.5.5.3.</span> <span class="toc-text">创建新的虚拟主机</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Context-%E9%85%8D%E7%BD%AE"><span class="toc-number">2.4.5.6.</span> <span class="toc-text">Context 配置</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#Centext-%E9%85%8D%E7%BD%AE%E6%96%B9%E5%BC%8F"><span class="toc-number">2.4.5.6.1.</span> <span class="toc-text">Centext 配置方式</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#Valve%E7%BB%84%E4%BB%B6"><span class="toc-number">2.4.5.6.2.</span> <span class="toc-text">Valve组件</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%AE%9E%E6%88%98%E6%A1%88%E4%BE%8B"><span class="toc-number">2.4.5.6.3.</span> <span class="toc-text">实战案例</span></a></li></ol></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%BB%93%E5%90%88%E5%8F%8D%E5%90%91%E4%BB%A3%E7%90%86%E5%AE%9E%E7%8E%B0-Tomcat-%E9%83%A8%E7%BD%B2"><span class="toc-number">3.</span> <span class="toc-text">结合反向代理实现 Tomcat 部署</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%B8%B8%E8%A7%81%E9%83%A8%E7%BD%B2%E6%96%B9%E5%BC%8F%E4%BB%8B%E7%BB%8D"><span class="toc-number">3.1.</span> <span class="toc-text">常见部署方式介绍</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%A9%E7%94%A8-nginx-%E5%8F%8D%E5%90%91%E4%BB%A3%E7%90%86%E5%AE%9E%E7%8E%B0%E5%85%A8%E9%83%A8%E8%BD%AC%E5%8F%91%E7%BD%AE%E6%8C%87%E5%AE%9A%E5%90%8C%E4%B8%80%E4%B8%AA%E8%99%9A%E6%8B%9F%E4%B8%BB%E6%9C%BA"><span class="toc-number">3.2.</span> <span class="toc-text">利用 nginx 反向代理实现全部转发置指定同一个虚拟主机</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE%E8%AF%B4%E6%98%8E"><span class="toc-number">3.2.1.</span> <span class="toc-text">配置说明</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9E%E6%88%98%E6%A1%88%E4%BE%8B1"><span class="toc-number">3.2.2.</span> <span class="toc-text">实战案例1</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9E%E6%88%98%E6%A1%88%E4%BE%8B2"><span class="toc-number">3.2.3.</span> <span class="toc-text">实战案例2</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%A9%E7%94%A8nginx%E5%AE%9E%E7%8E%B0%E5%8A%A8%E9%9D%99%E5%88%86%E7%A6%BB%E4%BB%A3%E7%90%86"><span class="toc-number">3.3.</span> <span class="toc-text">利用nginx实现动静分离代理</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE%E8%AF%B4%E6%98%8E-1"><span class="toc-number">3.3.1.</span> <span class="toc-text">配置说明</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9E%E6%88%98%E6%A1%88%E4%BE%8B-1"><span class="toc-number">3.3.2.</span> <span class="toc-text">实战案例</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%A9%E7%94%A8-httpd-%E5%AE%9E%E7%8E%B0%E5%9F%BA%E4%BA%8EAJP%E5%8D%8F%E8%AE%AE%E7%9A%84%E5%8F%8D%E5%90%91%E4%BB%A3%E7%90%86%E8%87%B3%E5%90%8E%E7%AB%AFTomcat%E6%9C%8D%E5%8A%A1%E5%99%A8"><span class="toc-number">3.4.</span> <span class="toc-text">利用 httpd 实现基于AJP协议的反向代理至后端Tomcat服务器</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#AJP-%E5%8D%8F%E8%AE%AE%E8%AF%B4%E6%98%8E"><span class="toc-number">3.4.1.</span> <span class="toc-text">AJP 协议说明</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%90%AF%E7%94%A8%E5%92%8C%E7%A6%81%E7%94%A8-AJP"><span class="toc-number">3.4.2.</span> <span class="toc-text">启用和禁用 AJP</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#httpd-%E5%AE%9E%E7%8E%B0-AJP-%E5%8F%8D%E5%90%91%E4%BB%A3%E7%90%86"><span class="toc-number">3.4.3.</span> <span class="toc-text">httpd 实现 AJP 反向代理</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE%E8%AF%B4%E6%98%8E-2"><span class="toc-number">3.4.3.1.</span> <span class="toc-text">配置说明</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%9E%E6%88%98%E6%A1%88%E4%BE%8B-2"><span class="toc-number">3.4.3.2.</span> <span class="toc-text">实战案例</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0-tomcat-%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1"><span class="toc-number">3.5.</span> <span class="toc-text">实现 tomcat 负载均衡</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#HTTP%E7%9A%84%E6%97%A0%E7%8A%B6%E6%80%81%EF%BC%8C%E6%9C%89%E8%BF%9E%E6%8E%A5%E5%92%8C%E7%9F%AD%E8%BF%9E%E6%8E%A5"><span class="toc-number">3.5.1.</span> <span class="toc-text">HTTP的无状态，有连接和短连接</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BC%9A%E8%AF%9D%E4%BF%9D%E6%8C%81%E6%96%B9%E5%BC%8F"><span class="toc-number">3.5.2.</span> <span class="toc-text">会话保持方式</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Session-sticky-%E4%BC%9A%E8%AF%9D%E9%BB%8F%E6%80%A7"><span class="toc-number">3.5.2.1.</span> <span class="toc-text">Session sticky 会话黏性</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Session-%E5%A4%8D%E5%88%B6%E9%9B%86%E7%BE%A4"><span class="toc-number">3.5.2.2.</span> <span class="toc-text">Session 复制集群</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Session-Server"><span class="toc-number">3.5.2.3.</span> <span class="toc-text">Session Server</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E8%A7%84%E5%88%92%E5%92%8C%E5%87%86%E5%A4%87"><span class="toc-number">3.5.3.</span> <span class="toc-text">负载均衡规划和准备</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E4%B8%BB%E6%9C%BA%E5%92%8C%E7%BD%91%E7%BB%9C%E5%9C%B0%E5%9D%80%E8%A7%84%E5%88%92"><span class="toc-number">3.5.3.1.</span> <span class="toc-text">负载均衡主机和网络地址规划</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1tomcat%E4%B8%BB%E6%9C%BA%E5%87%86%E5%A4%87"><span class="toc-number">3.5.3.2.</span> <span class="toc-text">负载均衡tomcat主机准备</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%87%86%E5%A4%87%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E8%A7%84%E5%88%92%E6%B5%8B%E8%AF%95%E7%94%A8%E7%9A%84jsp%E6%96%87%E4%BB%B6"><span class="toc-number">3.5.3.3.</span> <span class="toc-text">准备负载均衡规划测试用的jsp文件</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Nginx-%E5%AE%9E%E7%8E%B0%E5%90%8E%E7%AB%AF-tomcat-%E7%9A%84%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E8%B0%83%E5%BA%A6"><span class="toc-number">3.5.4.</span> <span class="toc-text">Nginx 实现后端 tomcat 的负载均衡调度</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Nginx-%E5%AE%9E%E7%8E%B0%E5%90%8E%E7%AB%AF-tomcat-%E7%9A%84%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1"><span class="toc-number">3.5.4.1.</span> <span class="toc-text">Nginx 实现后端 tomcat 的负载均衡</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0-session-%E9%BB%8F%E6%80%A7"><span class="toc-number">3.5.4.2.</span> <span class="toc-text">实现 session 黏性</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0-https-%E7%9A%84%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1"><span class="toc-number">3.5.4.3.</span> <span class="toc-text">实现 https 的负载均衡</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Tomcat-Session-Replication-Cluster"><span class="toc-number">4.</span> <span class="toc-text">Tomcat Session Replication Cluster</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE%E8%AF%B4%E6%98%8E-3"><span class="toc-number">4.1.</span> <span class="toc-text">配置说明</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BF%AE%E6%94%B9-conf-server-conf"><span class="toc-number">4.1.1.</span> <span class="toc-text">修改 conf&#x2F;server.conf</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BF%AE%E6%94%B9-WEB-INF-web-xml"><span class="toc-number">4.1.2.</span> <span class="toc-text">修改 WEB-INF&#x2F;web.xml</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%9E%E6%88%98%E6%A1%88%E4%BE%8B-%E5%AE%9E%E7%8E%B0-Tomcat-Session-%E9%9B%86%E7%BE%A4"><span class="toc-number">4.2.</span> <span class="toc-text">实战案例: 实现 Tomcat Session 集群</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9C%A8-proxy-%E4%B8%BB%E6%9C%BA%E8%AE%BE%E7%BD%AE-httpd-%E6%88%96nginx-%E5%AE%9E%E7%8E%B0%E5%90%8E%E7%AB%AFtomcat%E4%B8%BB%E6%9C%BA%E8%BD%AE%E8%AF%A2"><span class="toc-number">4.2.1.</span> <span class="toc-text">在 proxy 主机设置 httpd (或nginx)实现后端tomcat主机轮询</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9C%A8%E6%89%80%E6%9C%89%E5%90%8E%E7%AB%AFtomcat%E4%B8%BB%E6%9C%BA%E4%B8%8A%E4%BF%AE%E6%94%B9conf-server-xml"><span class="toc-number">4.2.2.</span> <span class="toc-text">在所有后端tomcat主机上修改conf&#x2F;server.xml</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BF%AE%E6%94%B9-t1-%E4%B8%BB%E6%9C%BA%E7%9A%84-conf-server-xml"><span class="toc-number">4.2.2.1.</span> <span class="toc-text">修改 t1 主机的 conf&#x2F;server.xml</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BF%AE%E6%94%B9-t2-%E4%B8%BB%E6%9C%BA%E7%9A%84-conf-server-xml"><span class="toc-number">4.2.2.2.</span> <span class="toc-text">修改 t2 主机的 conf&#x2F;server.xml</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BF%AE%E6%94%B9%E5%BA%94%E7%94%A8%E7%9A%84web-xml%E6%96%87%E4%BB%B6%E5%BC%80%E5%90%AF%E8%AF%A5%E5%BA%94%E7%94%A8%E7%A8%8B%E5%BA%8F%E7%9A%84%E5%88%86%E5%B8%83%E5%BC%8F"><span class="toc-number">4.2.3.</span> <span class="toc-text">修改应用的web.xml文件开启该应用程序的分布式</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BF%AE%E6%94%B9t1%E4%B8%BB%E6%9C%BA%E7%9A%84%E5%BA%94%E7%94%A8%E7%9A%84web-xml%E6%96%87%E4%BB%B6"><span class="toc-number">4.2.3.1.</span> <span class="toc-text">修改t1主机的应用的web.xml文件</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BF%AE%E6%94%B9t2%E4%B8%BB%E6%9C%BA%E7%9A%84%E5%BA%94%E7%94%A8%E7%9A%84web-xml%E6%96%87%E4%BB%B6"><span class="toc-number">4.2.3.2.</span> <span class="toc-text">修改t2主机的应用的web.xml文件</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B5%8B%E8%AF%95%E8%AE%BF%E9%97%AE"><span class="toc-number">4.2.4.</span> <span class="toc-text">测试访问</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%95%85%E9%9A%9C%E6%A8%A1%E6%8B%9F"><span class="toc-number">4.2.5.</span> <span class="toc-text">故障模拟</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%81%A2%E5%A4%8D%E5%AE%9E%E9%AA%8C%E7%8E%AF%E5%A2%83"><span class="toc-number">4.2.6.</span> <span class="toc-text">恢复实验环境</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Memcached"><span class="toc-number">5.</span> <span class="toc-text">Memcached</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#NoSQL%E4%BB%8B%E7%BB%8D"><span class="toc-number">5.1.</span> <span class="toc-text">NoSQL介绍</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Memcached-1"><span class="toc-number">5.2.</span> <span class="toc-text">Memcached</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Memcached-%E5%92%8C-Redis-%E6%AF%94%E8%BE%83"><span class="toc-number">5.3.</span> <span class="toc-text">Memcached 和 Redis 比较</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Memcached-%E5%B7%A5%E4%BD%9C%E6%9C%BA%E5%88%B6"><span class="toc-number">5.4.</span> <span class="toc-text">Memcached 工作机制</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%86%85%E5%AD%98%E5%88%86%E9%85%8D%E6%9C%BA%E5%88%B6"><span class="toc-number">5.4.1.</span> <span class="toc-text">内存分配机制</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%87%92%E8%BF%87%E6%9C%9F-Lazy-Expiration"><span class="toc-number">5.4.2.</span> <span class="toc-text">懒过期 Lazy Expiration</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#LRU"><span class="toc-number">5.4.3.</span> <span class="toc-text">LRU</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%9B%86%E7%BE%A4"><span class="toc-number">5.4.4.</span> <span class="toc-text">集群</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%89%E8%A3%85%E5%92%8C%E5%90%AF%E5%8A%A8"><span class="toc-number">5.5.</span> <span class="toc-text">安装和启动</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#yum%E5%AE%89%E8%A3%85"><span class="toc-number">5.5.1.</span> <span class="toc-text">yum安装</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BC%96%E8%AF%91%E5%AE%89%E8%A3%85"><span class="toc-number">5.5.2.</span> <span class="toc-text">编译安装</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#memcached-%E5%90%AF%E5%8A%A8%E7%A8%8B%E5%BA%8F%E8%AF%B4%E6%98%8E"><span class="toc-number">5.5.3.</span> <span class="toc-text">memcached 启动程序说明</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8-memcached"><span class="toc-number">5.6.</span> <span class="toc-text">使用 memcached</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#memcached-%E5%BC%80%E5%8F%91%E5%BA%93%E5%92%8C%E5%B7%A5%E5%85%B7"><span class="toc-number">5.6.1.</span> <span class="toc-text">memcached 开发库和工具</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#memcached-%E6%93%8D%E4%BD%9C%E5%91%BD%E4%BB%A4"><span class="toc-number">5.6.2.</span> <span class="toc-text">memcached 操作命令</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#python-%E8%AF%AD%E8%A8%80%E8%BF%9E%E6%8E%A5-memcached"><span class="toc-number">5.6.3.</span> <span class="toc-text">python 语言连接 memcached</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%8C%83%E4%BE%8B-python3-%E6%B5%8B%E8%AF%95%E4%BB%A3%E7%A0%81"><span class="toc-number">5.6.3.1.</span> <span class="toc-text">范例: python3 测试代码</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%8C%83%E4%BE%8B-python2-%E6%B5%8B%E8%AF%95%E4%BB%A3%E7%A0%81"><span class="toc-number">5.6.3.2.</span> <span class="toc-text">范例: python2 测试代码</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Session-%E5%85%B1%E4%BA%AB%E6%9C%8D%E5%8A%A1%E5%99%A8"><span class="toc-number">6.</span> <span class="toc-text">Session 共享服务器</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#msm-%E4%BB%8B%E7%BB%8D"><span class="toc-number">6.1.</span> <span class="toc-text">msm 介绍</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%89%E8%A3%85"><span class="toc-number">6.2.</span> <span class="toc-text">安装</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#sticky-%E6%A8%A1%E5%BC%8F"><span class="toc-number">6.3.</span> <span class="toc-text">sticky 模式</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#sticky-%E6%A8%A1%E5%BC%8F%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86"><span class="toc-number">6.3.1.</span> <span class="toc-text">sticky 模式工作原理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE%E8%BF%87%E7%A8%8B"><span class="toc-number">6.3.2.</span> <span class="toc-text">配置过程</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%8B%E8%BD%BD%E7%9B%B8%E5%85%B3jar%E5%8C%85"><span class="toc-number">6.3.2.1.</span> <span class="toc-text">下载相关jar包</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BF%AE%E6%94%B9tomcat%E9%85%8D%E7%BD%AE"><span class="toc-number">6.3.2.2.</span> <span class="toc-text">修改tomcat配置</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%87%86%E5%A4%87%E6%B5%8B%E8%AF%95msm%E7%9A%84python%E8%84%9A%E6%9C%AC"><span class="toc-number">6.3.2.3.</span> <span class="toc-text">准备测试msm的python脚本</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9E%E6%88%98%E6%A1%88%E4%BE%8B-1-tomcat%E5%92%8Cmemcached%E9%9B%86%E6%88%90%E5%9C%A8%E4%B8%80%E5%8F%B0%E4%B8%BB%E6%9C%BA"><span class="toc-number">6.3.3.</span> <span class="toc-text">实战案例 1 : tomcat和memcached集成在一台主机</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%85%8D%E7%BD%AEnginx%E5%85%85%E5%BD%93proxy"><span class="toc-number">6.3.3.1.</span> <span class="toc-text">配置nginx充当proxy</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%85%8D%E7%BD%AEmemcached"><span class="toc-number">6.3.3.2.</span> <span class="toc-text">配置memcached</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%9C%A8-tomcat1-%E4%B8%8A%E9%85%8D%E7%BD%AE-memcached"><span class="toc-number">6.3.3.2.1.</span> <span class="toc-text">在 tomcat1 上配置 memcached</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%9C%A8-tomcat2-%E4%B8%8A%E9%85%8D%E7%BD%AE-memcached"><span class="toc-number">6.3.3.2.2.</span> <span class="toc-text">在 tomcat2 上配置 memcached</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE-tomcat"><span class="toc-number">6.3.3.3.</span> <span class="toc-text">配置 tomcat</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE-tomcat1"><span class="toc-number">6.3.3.3.1.</span> <span class="toc-text">配置 tomcat1</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE-tomcat2"><span class="toc-number">6.3.3.3.2.</span> <span class="toc-text">配置 tomcat2</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%9F%A5%E7%9C%8Btomcat%E6%97%A5%E5%BF%97"><span class="toc-number">6.3.3.3.3.</span> <span class="toc-text">查看tomcat日志</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#python%E6%B5%8B%E8%AF%95%E8%84%9A%E6%9C%AC"><span class="toc-number">6.3.3.4.</span> <span class="toc-text">python测试脚本</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%B5%8F%E8%A7%88%E5%99%A8%E8%AE%BF%E9%97%AE"><span class="toc-number">6.3.3.5.</span> <span class="toc-text">浏览器访问</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%95%85%E9%9A%9C%E8%AE%BF%E9%97%AE"><span class="toc-number">6.3.3.6.</span> <span class="toc-text">故障访问</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%A8%A1%E6%8B%9Ftomcat%E6%95%85%E9%9A%9C"><span class="toc-number">6.3.3.6.1.</span> <span class="toc-text">模拟tomcat故障</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%A8%A1%E6%8B%9Fmemcached%E6%95%85%E9%9A%9C"><span class="toc-number">6.3.3.6.2.</span> <span class="toc-text">模拟memcached故障</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9E%E6%88%98%E6%A1%88%E4%BE%8B-2-tomcat%E5%92%8Cmemcached-%E5%88%86%E5%88%AB%E5%A4%84%E4%BA%8E%E4%B8%8D%E5%90%8C%E4%B8%BB%E6%9C%BA"><span class="toc-number">6.3.4.</span> <span class="toc-text">实战案例 2 : tomcat和memcached 分别处于不同主机</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%87%86%E5%A4%87proxy%E4%B8%BB%E6%9C%BA%E7%9A%84%E9%85%8D%E7%BD%AE%EF%BC%8C%E5%88%A9%E7%94%A8nginx%E4%BD%9C%E4%B8%BA%E5%8F%8D%E5%90%91%E4%BB%A3%E7%90%86"><span class="toc-number">6.3.4.1.</span> <span class="toc-text">准备proxy主机的配置，利用nginx作为反向代理</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%9C%A8m1%E5%92%8Cm2%E4%B8%8A%E5%88%86%E5%88%AB%E9%85%8D%E7%BD%AEmemcached"><span class="toc-number">6.3.4.2.</span> <span class="toc-text">在m1和m2上分别配置memcached</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%9C%A8t1%E5%92%8Ct2%E4%B8%8A%E5%87%86%E5%A4%87tomcat"><span class="toc-number">6.3.4.3.</span> <span class="toc-text">在t1和t2上准备tomcat</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%B5%8B%E8%AF%95%E7%9A%84python%E8%84%9A%E6%9C%AC"><span class="toc-number">6.3.4.4.</span> <span class="toc-text">测试的python脚本</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%B5%8F%E8%A7%88%E5%99%A8%E8%AE%BF%E9%97%AE%E6%B5%8B%E8%AF%95"><span class="toc-number">6.3.4.5.</span> <span class="toc-text">浏览器访问测试</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%A8%A1%E6%8B%9F%E6%95%85%E9%9A%9C"><span class="toc-number">6.3.4.6.</span> <span class="toc-text">模拟故障</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#non-sticky-%E6%A8%A1%E5%BC%8F"><span class="toc-number">6.4.</span> <span class="toc-text">non-sticky 模式</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#non-sticky-%E6%A8%A1%E5%BC%8F%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86"><span class="toc-number">6.4.1.</span> <span class="toc-text">non-sticky 模式工作原理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#memcached%E9%85%8D%E7%BD%AE"><span class="toc-number">6.4.2.</span> <span class="toc-text">memcached配置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#redis-%E9%85%8D%E7%BD%AE"><span class="toc-number">6.4.3.</span> <span class="toc-text">redis 配置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9E%E6%88%98%E6%A1%88%E4%BE%8B-memcached-%E5%AE%9E%E7%8E%B0non-sticky%E6%A8%A1%E5%BC%8F"><span class="toc-number">6.4.4.</span> <span class="toc-text">实战案例: memcached 实现non-sticky模式</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BF%AE%E6%94%B9tomcat%E9%85%8D%E7%BD%AE-1"><span class="toc-number">6.4.4.1.</span> <span class="toc-text">修改tomcat配置</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%80%9A%E8%BF%87%E6%B5%8F%E8%A7%88%E5%99%A8%E8%AE%BF%E9%97%AE"><span class="toc-number">6.4.4.2.</span> <span class="toc-text">通过浏览器访问</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%A8%A1%E6%8B%9F%E6%95%85%E9%9A%9C-1"><span class="toc-number">6.4.4.3.</span> <span class="toc-text">模拟故障</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9E%E6%88%98%E6%A1%88%E4%BE%8B-redis-%E5%AE%9E%E7%8E%B0-non-sticky-%E6%A8%A1%E5%BC%8F%E7%9A%84msm"><span class="toc-number">6.4.5.</span> <span class="toc-text">实战案例: redis 实现 non-sticky 模式的msm</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%8A%E4%BC%A0redis%E5%BA%93%E5%88%B0tomcat%E6%9C%8D%E5%8A%A1%E5%99%A8"><span class="toc-number">6.4.5.1.</span> <span class="toc-text">上传redis库到tomcat服务器</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%89%E8%A3%85%E5%B9%B6%E9%85%8D%E7%BD%AE-Redis-%E6%9C%8D%E5%8A%A1"><span class="toc-number">6.4.5.2.</span> <span class="toc-text">安装并配置 Redis 服务</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BF%AE%E6%94%B9tomcat-%E9%85%8D%E7%BD%AE%E6%8C%87%E5%AE%9Aredis%E6%9C%8D%E5%8A%A1%E5%99%A8%E5%9C%B0%E5%9D%80"><span class="toc-number">6.4.5.3.</span> <span class="toc-text">修改tomcat 配置指定redis服务器地址</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%B5%8B%E8%AF%95%E8%AE%BF%E9%97%AE-1"><span class="toc-number">6.4.5.4.</span> <span class="toc-text">测试访问</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%A8%A1%E6%8B%9F%E6%95%85%E9%9A%9C-2"><span class="toc-number">6.4.5.5.</span> <span class="toc-text">模拟故障</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%A8%A1%E6%8B%9Ftomcat%E6%95%85%E9%9A%9C-%E6%9F%A5%E7%9C%8B%E6%98%AF%E5%90%A6SessionID%E5%8F%98%E5%8C%96"><span class="toc-number">6.4.5.5.1.</span> <span class="toc-text">模拟tomcat故障,查看是否SessionID变化</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%A8%A1%E6%8B%9FRedis-%E6%95%85%E9%9A%9C"><span class="toc-number">6.4.5.5.2.</span> <span class="toc-text">模拟Redis 故障</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8-redisson-%E5%88%A9%E7%94%A8-redis-%E5%AE%9E%E7%8E%B0session%E5%85%B1%E4%BA%AB"><span class="toc-number">6.5.</span> <span class="toc-text">使用 redisson 利用 redis 实现session共享</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%A9%E7%94%A8-Tomcat-Clustering-Redis-Session-Manager-%E5%88%A9%E7%94%A8-redis-%E5%AE%9E%E7%8E%B0session%E5%85%B1%E4%BA%AB"><span class="toc-number">6.6.</span> <span class="toc-text">利用 Tomcat Clustering Redis Session Manager 利用 redis 实现session共享</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Tomcat-%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96"><span class="toc-number">7.</span> <span class="toc-text">Tomcat 性能优化</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#JVM%E7%BB%84%E6%88%90"><span class="toc-number">7.1.</span> <span class="toc-text">JVM组成</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#JVM%E7%BB%84%E6%88%90-1"><span class="toc-number">7.1.1.</span> <span class="toc-text">JVM组成</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%99%9A%E6%8B%9F%E6%9C%BA"><span class="toc-number">7.1.2.</span> <span class="toc-text">虚拟机</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#GC-Garbage-Collection-%E5%9E%83%E5%9C%BE%E6%94%B6%E9%9B%86%E5%99%A8"><span class="toc-number">7.2.</span> <span class="toc-text">GC (Garbage Collection) 垃圾收集器</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Garbage-%E5%9E%83%E5%9C%BE%E7%A1%AE%E5%AE%9A%E6%96%B9%E6%B3%95"><span class="toc-number">7.2.1.</span> <span class="toc-text">Garbage 垃圾确定方法</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9E%83%E5%9C%BE%E5%9B%9E%E6%94%B6%E5%9F%BA%E6%9C%AC%E7%AE%97%E6%B3%95"><span class="toc-number">7.2.2.</span> <span class="toc-text">垃圾回收基本算法</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%A0%87%E8%AE%B0-%E6%B8%85%E9%99%A4-Mark-Sweep"><span class="toc-number">7.2.2.1.</span> <span class="toc-text">标记-清除 Mark-Sweep</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%A0%87%E8%AE%B0-%E5%8E%8B%E7%BC%A9-%E5%8E%8B%E5%AE%9E-Mark-Compact"><span class="toc-number">7.2.2.2.</span> <span class="toc-text">标记-压缩 (压实)Mark-Compact</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%A4%8D%E5%88%B6-Copying"><span class="toc-number">7.2.2.3.</span> <span class="toc-text">复制 Copying</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%A4%9A%E7%A7%8D%E7%AE%97%E6%B3%95%E6%80%BB%E7%BB%93"><span class="toc-number">7.2.2.4.</span> <span class="toc-text">多种算法总结</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#STW"><span class="toc-number">7.2.2.5.</span> <span class="toc-text">STW</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%86%E4%BB%A3%E5%A0%86%E5%86%85%E5%AD%98GC%E7%AD%96%E7%95%A5"><span class="toc-number">7.2.3.</span> <span class="toc-text">分代堆内存GC策略</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%A0%86%E5%86%85%E5%AD%98%E5%88%86%E4%BB%A3"><span class="toc-number">7.2.3.1.</span> <span class="toc-text">堆内存分代</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%B9%B4%E8%BD%BB%E4%BB%A3%E5%9B%9E%E6%94%B6-Minor-GC"><span class="toc-number">7.2.3.2.</span> <span class="toc-text">年轻代回收 Minor GC</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%80%81%E5%B9%B4%E4%BB%A3%E5%9B%9E%E6%94%B6-Major-GC"><span class="toc-number">7.2.3.3.</span> <span class="toc-text">老年代回收 Major GC</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#GC-%E8%A7%A6%E5%8F%91%E6%9D%A1%E4%BB%B6"><span class="toc-number">7.2.3.4.</span> <span class="toc-text">GC 触发条件</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#java-%E5%86%85%E5%AD%98%E8%B0%83%E6%95%B4%E7%9B%B8%E5%85%B3%E5%8F%82%E6%95%B0"><span class="toc-number">7.2.4.</span> <span class="toc-text">java 内存调整相关参数</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#JVM-%E5%86%85%E5%AD%98%E5%B8%B8%E7%94%A8%E7%9B%B8%E5%85%B3%E5%8F%82%E6%95%B0"><span class="toc-number">7.2.4.1.</span> <span class="toc-text">JVM 内存常用相关参数</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#JDK-%E5%B7%A5%E5%85%B7%E7%9B%91%E6%8E%A7%E4%BD%BF%E7%94%A8%E6%83%85%E5%86%B5"><span class="toc-number">7.2.4.2.</span> <span class="toc-text">JDK 工具监控使用情况</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%A1%88%E4%BE%8B1-jvisualvm%E5%B7%A5%E5%85%B7"><span class="toc-number">7.2.4.2.1.</span> <span class="toc-text">案例1: jvisualvm工具</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%A1%88%E4%BE%8B2-%E4%BD%BF%E7%94%A8-jvisualvm%E7%9A%84-Visual-GC-%E6%8F%92%E4%BB%B6"><span class="toc-number">7.2.4.2.2.</span> <span class="toc-text">案例2: 使用 jvisualvm的 Visual GC 插件</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#Jprofiler%E5%AE%9A%E4%BD%8DOOM%E7%9A%84%E9%97%AE%E9%A2%98%E5%8E%9F%E5%9B%A0"><span class="toc-number">7.2.4.2.3.</span> <span class="toc-text">Jprofiler定位OOM的问题原因</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Tomcat%E7%9A%84JVM%E5%8F%82%E6%95%B0%E8%AE%BE%E7%BD%AE"><span class="toc-number">7.2.4.3.</span> <span class="toc-text">Tomcat的JVM参数设置</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9E%83%E5%9C%BE%E6%94%B6%E9%9B%86%E6%96%B9%E5%BC%8F"><span class="toc-number">7.2.5.</span> <span class="toc-text">垃圾收集方式</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%B0%83%E6%95%B4%E7%AD%96%E7%95%A5"><span class="toc-number">7.2.6.</span> <span class="toc-text">调整策略</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9E%83%E5%9C%BE%E5%9B%9E%E6%94%B6%E5%99%A8"><span class="toc-number">7.2.7.</span> <span class="toc-text">垃圾回收器</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%B8%B8%E7%94%A8%E5%9E%83%E5%9C%BE%E5%9B%9E%E6%94%B6%E5%99%A8"><span class="toc-number">7.2.7.1.</span> <span class="toc-text">常用垃圾回收器</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%8C%89%E5%88%86%E4%BB%A3%E8%AE%BE%E7%BD%AE%E4%B8%8D%E5%90%8C%E5%9E%83%E5%9C%BE%E5%9B%9E%E6%94%B6%E5%99%A8"><span class="toc-number">7.2.7.1.1.</span> <span class="toc-text">按分代设置不同垃圾回收器</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%BB%A5%E4%B8%8B%E6%94%B6%E9%9B%86%E5%99%A8%E4%B8%8D%E5%86%8D%E6%8C%89%E6%98%8E%E7%A1%AE%E7%9A%84%E5%88%86%E4%BB%A3%E5%8D%95%E7%8B%AC%E8%AE%BE%E7%BD%AE"><span class="toc-number">7.2.7.1.2.</span> <span class="toc-text">以下收集器不再按明确的分代单独设置</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%9E%83%E5%9C%BE%E6%94%B6%E9%9B%86%E5%99%A8%E8%AE%BE%E7%BD%AE"><span class="toc-number">7.2.7.2.</span> <span class="toc-text">垃圾收集器设置</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#JVM%E7%9B%B8%E5%85%B3%E5%B7%A5%E5%85%B7"><span class="toc-number">7.3.</span> <span class="toc-text">JVM相关工具</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#JVM-%E5%B7%A5%E5%85%B7%E6%A6%82%E8%BF%B0"><span class="toc-number">7.3.1.</span> <span class="toc-text">JVM 工具概述</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#jps"><span class="toc-number">7.3.2.</span> <span class="toc-text">jps</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#jinfo"><span class="toc-number">7.3.3.</span> <span class="toc-text">jinfo</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#jstat"><span class="toc-number">7.3.4.</span> <span class="toc-text">jstat</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#jstack"><span class="toc-number">7.3.5.</span> <span class="toc-text">jstack</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#jmap"><span class="toc-number">7.3.6.</span> <span class="toc-text">jmap</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#jhat"><span class="toc-number">7.3.7.</span> <span class="toc-text">jhat</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#jconsole-%E5%92%8C-JMX"><span class="toc-number">7.3.8.</span> <span class="toc-text">jconsole 和 JMX</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Tomcat-%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96%E5%B8%B8%E7%94%A8%E9%85%8D%E7%BD%AE"><span class="toc-number">7.4.</span> <span class="toc-text">Tomcat 性能优化常用配置</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%86%85%E5%AD%98%E7%A9%BA%E9%97%B4%E4%BC%98%E5%8C%96"><span class="toc-number">7.4.1.</span> <span class="toc-text">内存空间优化</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BA%BF%E7%A8%8B%E6%B1%A0%E8%B0%83%E6%95%B4"><span class="toc-number">7.4.2.</span> <span class="toc-text">线程池调整</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Java-%E7%A8%8B%E5%BA%8F%E7%BC%96%E8%AF%91"><span class="toc-number">8.</span> <span class="toc-text">Java 程序编译</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%BA%90%E4%BB%A3%E7%A0%81%E5%85%8B%E9%9A%86%E4%B8%8E%E7%BC%96%E8%AF%91%E8%BF%87%E7%A8%8B%E8%AF%B4%E6%98%8E"><span class="toc-number">8.1.</span> <span class="toc-text">源代码克隆与编译过程说明</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Maven-%E9%83%A8%E7%BD%B2%E5%87%86%E5%A4%87"><span class="toc-number">8.2.</span> <span class="toc-text">Maven 部署准备</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Maven-%E4%BB%8B%E7%BB%8D"><span class="toc-number">8.2.1.</span> <span class="toc-text">Maven 介绍</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#maven-%E5%AE%89%E8%A3%85"><span class="toc-number">8.2.2.</span> <span class="toc-text">maven 安装</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%89%E8%A3%85%E6%96%B9%E5%BC%8F1-%E5%8C%85%E5%AE%89%E8%A3%85"><span class="toc-number">8.2.2.1.</span> <span class="toc-text">安装方式1: 包安装</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%89%E8%A3%85%E6%96%B9%E5%BC%8F2-%E4%BA%8C%E8%BF%9B%E5%88%B6%E5%AE%89%E8%A3%85"><span class="toc-number">8.2.2.2.</span> <span class="toc-text">安装方式2: 二进制安装</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Maven-%E7%9A%84%E6%89%93%E5%8C%85%E5%91%BD%E4%BB%A4%E8%AF%B4%E6%98%8E"><span class="toc-number">8.3.</span> <span class="toc-text">Maven 的打包命令说明</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%89%A7%E8%A1%8C-java-%E4%BB%A3%E7%A0%81%E7%BC%96%E8%AF%91%E5%AE%9E%E6%88%98%E6%A1%88%E4%BE%8B"><span class="toc-number">8.4.</span> <span class="toc-text">执行 java 代码编译实战案例</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BC%96%E8%AF%91%E5%AE%89%E8%A3%85-spring-boot-%E9%A1%B9%E7%9B%AE"><span class="toc-number">8.4.1.</span> <span class="toc-text">编译安装 spring-boot 项目</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BC%96%E8%AF%91-java-%E7%A8%8B%E5%BA%8F-Jpress"><span class="toc-number">8.4.2.</span> <span class="toc-text">编译 java 程序 Jpress</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%A7%81%E6%9C%89%E4%BB%93%E5%BA%93-Nexus"><span class="toc-number">9.</span> <span class="toc-text">私有仓库 Nexus</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Nexus-%E4%BB%8B%E7%BB%8D"><span class="toc-number">9.1.</span> <span class="toc-text">Nexus 介绍</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%83%A8%E7%BD%B2-Nexus"><span class="toc-number">9.2.</span> <span class="toc-text">部署 Nexus</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%8B%E8%BD%BD%E5%B9%B6%E5%90%AF%E5%8A%A8-Nexus"><span class="toc-number">9.2.1.</span> <span class="toc-text">下载并启动 Nexus</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%99%BB%E5%BD%95-web-%E7%95%8C%E9%9D%A2%E5%88%9D%E5%A7%8B%E5%8C%96"><span class="toc-number">9.2.2.</span> <span class="toc-text">登录 web 界面初始化</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%AA%8C%E8%AF%81%E9%BB%98%E8%AE%A4%E4%BB%93%E5%BA%93"><span class="toc-number">9.2.3.</span> <span class="toc-text">验证默认仓库</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Maven%E7%9A%84%E4%BB%93%E5%BA%93%E4%BC%98%E5%8C%96%E9%85%8D%E7%BD%AE"><span class="toc-number">9.2.4.</span> <span class="toc-text">Maven的仓库优化配置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE%E9%82%AE%E4%BB%B6"><span class="toc-number">9.2.5.</span> <span class="toc-text">配置邮件</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8-Nexus-%E6%9E%84%E5%BB%BA%E7%A7%81%E6%9C%89-Yum-%E5%92%8C-Apt-%E4%BB%93%E5%BA%93"><span class="toc-number">9.3.</span> <span class="toc-text">使用 Nexus 构建私有 Yum 和 Apt 仓库</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8-Nexus-%E6%9E%84%E5%BB%BA%E7%A7%81%E6%9C%89-Yum-%E4%BB%93%E5%BA%93"><span class="toc-number">9.3.1.</span> <span class="toc-text">使用 Nexus 构建私有 Yum 仓库</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA-Blob-Store"><span class="toc-number">9.3.1.1.</span> <span class="toc-text">创建 Blob Store</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA-Yum-%E4%BB%93%E5%BA%93"><span class="toc-number">9.3.1.2.</span> <span class="toc-text">创建 Yum 仓库</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%B0%86nexus-%E6%9C%8D%E5%8A%A1%E4%BB%93%E5%BA%93%E9%85%8D%E7%BD%AE%E4%B8%BAyum%E4%BB%93%E5%BA%93"><span class="toc-number">9.3.1.3.</span> <span class="toc-text">将nexus 服务仓库配置为yum仓库</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8-Nexus-%E6%9E%84%E5%BB%BA%E7%A7%81%E6%9C%89-Apt-%E4%BB%93%E5%BA%93"><span class="toc-number">9.3.2.</span> <span class="toc-text">使用 Nexus 构建私有 Apt 仓库</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA-Blob-Store-1"><span class="toc-number">9.3.2.1.</span> <span class="toc-text">创建 Blob Store</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA-Apt-%E4%BB%93%E5%BA%93"><span class="toc-number">9.3.2.2.</span> <span class="toc-text">创建 Apt 仓库</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE%E5%AE%A2%E6%88%B7%E7%AB%AF%E7%9A%84-apt-%E6%BA%90%E6%8C%87%E5%90%91%E7%A7%81%E6%9C%89%E4%BB%93%E5%BA%93%E8%B7%AF%E5%BE%84"><span class="toc-number">9.3.2.3.</span> <span class="toc-text">配置客户端的 apt 源指向私有仓库路径</span></a></li></ol></li></ol></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2025/05/09/SRE-jenkins/" title="DevOps之CICD工具Jenkins"><img src="/../images/SRE/day55/1.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="DevOps之CICD工具Jenkins"/></a><div class="content"><a class="title" href="/2025/05/09/SRE-jenkins/" title="DevOps之CICD工具Jenkins">DevOps之CICD工具Jenkins</a><time datetime="2025-05-09T09:30:43.000Z" title="发表于 2025-05-09 17:30:43">2025-05-09</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2025/04/24/SRE-git/" title="版本管理系统Git和GitLab"><img src="/../images/SRE/day53/77.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="版本管理系统Git和GitLab"/></a><div class="content"><a class="title" href="/2025/04/24/SRE-git/" title="版本管理系统Git和GitLab">版本管理系统Git和GitLab</a><time datetime="2025-04-24T01:21:27.000Z" title="发表于 2025-04-24 09:21:27">2025-04-24</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2025/04/21/SRE-kafka/" title="消息队列和微服务"><img src="/../images/SRE/day52/30.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="消息队列和微服务"/></a><div class="content"><a class="title" href="/2025/04/21/SRE-kafka/" title="消息队列和微服务">消息队列和微服务</a><time datetime="2025-04-21T15:34:02.000Z" title="发表于 2025-04-21 23:34:02">2025-04-21</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2025/04/19/SRE-redis/" title="企业级NoSQL数据库Redis"><img src="/../images/SRE/day49/1.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="企业级NoSQL数据库Redis"/></a><div class="content"><a class="title" href="/2025/04/19/SRE-redis/" title="企业级NoSQL数据库Redis">企业级NoSQL数据库Redis</a><time datetime="2025-04-19T15:34:02.000Z" title="发表于 2025-04-19 23:34:02">2025-04-19</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2023 - 2025 By ૮(˶ᵔ ᵕ ᵔ˶)ა</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div><div class="footer_custom_text"><a target="_blank" rel="noopener" href="https://beian.miit.gov.cn/#/Integrated/index"><img src="../images/BEIAN/icp.png" width="15" height="15">豫ICP备2023009931号</a></br><a href="http://www.beian.gov.cn/portal/registerSystemInfo?recordcode=41162702000178" target="_blank"><img src="../images/BEIAN/beian.png" width="15" height="15">豫公网安备 41162702000178号</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.umd.min.js"></script><script src="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.js"></script><script>function panguFn () {
  if (typeof pangu === 'object') pangu.autoSpacingPage()
  else {
    getScript('https://cdn.jsdelivr.net/npm/pangu/dist/browser/pangu.min.js')
      .then(() => {
        pangu.autoSpacingPage()
      })
  }
}

function panguInit () {
  if (true){
    GLOBAL_CONFIG_SITE.isPost && panguFn()
  } else {
    panguFn()
  }
}

document.addEventListener('DOMContentLoaded', panguInit)</script><div class="js-pjax"></div><canvas id="universe"></canvas><script src="/js/universe.js"></script><canvas class="fireworks" mobile="true"></canvas><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/fireworks.min.js"></script><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/activate-power-mode.min.js"></script><script>POWERMODE.colorful = true;
POWERMODE.shake = false;
POWERMODE.mobile = false;
document.body.addEventListener('input', POWERMODE);
</script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>