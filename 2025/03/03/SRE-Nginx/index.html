<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>企业级高性能WEB服务Nginx | ૮(˶ᵔ ᵕ ᵔ˶)ა</title><meta name="author" content="૮(˶ᵔ ᵕ ᵔ˶)ა"><meta name="copyright" content="૮(˶ᵔ ᵕ ᵔ˶)ა"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="ffffff"><meta name="description" content="Site Reliability Engineering">
<meta property="og:type" content="article">
<meta property="og:title" content="企业级高性能WEB服务Nginx">
<meta property="og:url" content="http://example.com/2025/03/03/SRE-Nginx/index.html">
<meta property="og:site_name" content="૮(˶ᵔ ᵕ ᵔ˶)ა">
<meta property="og:description" content="Site Reliability Engineering">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://example.com/images/TITLE/nginx_logo.png">
<meta property="article:published_time" content="2025-03-03T09:54:42.000Z">
<meta property="article:modified_time" content="2025-04-01T11:34:55.935Z">
<meta property="article:author" content="૮(˶ᵔ ᵕ ᵔ˶)ა">
<meta property="article:tag" content="Nginx">
<meta property="article:tag" content="SRE">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://example.com/images/TITLE/nginx_logo.png"><link rel="shortcut icon" href="/../images/TITLE/user.webp"><link rel="canonical" href="http://example.com/2025/03/03/SRE-Nginx/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//fonts.googleapis.com" crossorigin=""/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Titillium+Web&amp;display=swap" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":false,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: true,
    post: true
  },
  runtime: '天',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: {"chs_to_cht":"你已切换为繁体","cht_to_chs":"你已切换为简体","day_to_night":"你已切换为深色模式","night_to_day":"你已切换为浅色模式","bgLight":"#49b1f5","bgDark":"#1f1f1f","position":"top-center"},
  source: {
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: true,
  }
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: '企业级高性能WEB服务Nginx',
  isPost: true,
  isHome: false,
  isHighlightShrink: undefined,
  isToc: true,
  postUpdate: '2025-04-01 19:34:55'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
    win.getCSS = (url,id = false) => new Promise((resolve, reject) => {
      const link = document.createElement('link')
      link.rel = 'stylesheet'
      link.href = url
      if (id) link.id = id
      link.onerror = reject
      link.onload = link.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        link.onload = link.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(link)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', 'ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><link rel="stylesheet" href="/css/custom.css"  media="defer" onload="this.media='all'"><meta name="generator" content="Hexo 5.4.2"></head><body><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="/../images/TITLE/user.webp" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">105</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">42</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">35</div></a></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间线</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('/../images/TITLE/nginx_logo.png')"><nav id="nav"><span id="blog-info"><a href="/" title="૮(˶ᵔ ᵕ ᵔ˶)ა"><span class="site-name">૮(˶ᵔ ᵕ ᵔ˶)ა</span></a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间线</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">企业级高性能WEB服务Nginx</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2025-03-03T09:54:42.000Z" title="发表于 2025-03-03 17:54:42">2025-03-03</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2025-04-01T11:34:55.935Z" title="更新于 2025-04-01 19:34:55">2025-04-01</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/Nginx/">Nginx</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">字数总计:</span><span class="word-count">83k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>353分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="企业级高性能WEB服务Nginx"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="WEB-服务和HTTP协议"><a href="#WEB-服务和HTTP协议" class="headerlink" title="WEB 服务和HTTP协议"></a>WEB 服务和HTTP协议</h1><h2 id="Internet-因特网"><a href="#Internet-因特网" class="headerlink" title="Internet 因特网"></a>Internet 因特网</h2><p>因特网是”Internet”的中文译名，它起源于美国的五角大楼，它的前身是美国国防部高级研究计划局（ARPA）主持研制的ARPAnet。20世纪50年代末，正处于冷战时期。当时美国军方为了自己的计算机网络在受到袭击时,即使部分网络被摧毁，其余部分仍能保持通信联系，便由美国国防部的高级研究计划局（ARPA）建设了一个军用网，叫做”阿帕网”（ARPAnet）。</p>
<p>1969年正式启用阿帕网，当时仅连接了4台计算机，供科学家们进行计算机联网实验用，这就是因特网的前身。 到70年代，ARPAnet已经有了好几十个计算机网络，但是每个网络只能在网络内部的计算机之间互联通信，不同计算机网络之间仍然不能互通。为此， ARPA又设立了新的研究项目，支持学术界和工业界进行有关的研究，研究的主要内容就是想用一种新的方法将不同的计算机局域网互联，形成”互联网”。研究人员称之为”internetwork”，简称”Internet”。在研究实现互联的过程中，计算机软件起了主要的作用。</p>
<p>1974年，出现了连接分组网络的协议，其中就包括了TCP/IP协议。TCP/IP有一个非常重要的特点，就是开放性，即TCP/IP的规范和Internet的技术都是公开的。目的就是使任何厂家生产的计算机都能相互通信，使Internet成为一个开放的系统，这正是后来Internet得到飞速发展的重要原因。ARPA在1982年接受了TCP/IP，选定Internet为主要的计算机通信系统，并把其它的军用计算机网络都转换到TCP/IP。</p>
<p>1983年，ARPAnet分成两部分：一部分军用，称为MILNET；另一部分仍称ARPAnet，供民用。</p>
<p>1986年，美国国家科学基金组织（NSF）将分布在美国各地的5个为科研教育服务的超级计算机中心互联，并支持地区网络，形成SNSFnet。1988 年，SNSFnet替代ARPAnet成为Internet的主干网。NSFnet主干网利用了在ARPAnet中已证明是非常成功的TCP/IP技术，准许各大学、政府或私人科研机构的网络加入。</p>
<p>1989年，ARPAnet解散，Internet从军用转向民用。</p>
<p>Internet的发展引起了商家的极大兴趣。1992年，美国IBM、MCI、MERIT三家公司联合组建了一个高级网络服务公司（SNS），建立了一个新的网络，叫做SNSnet，成为Internet的另一个主干网。它与SNSFnet不同，NSFnet是由国家出资建立的，而SNSnet则是SNS 公司所有，从而使Internet开始走向商业化。</p>
<p>1995年4月30日，SNSFnet正式宣布停止运作。而此时Internet的骨干网已经覆盖了全球91个国家，主机已超过400万台。而在当前，因特网仍以惊人的速度向前发展</p>
<p>在90年代，超文本标识语言（HTML），即一个可以获得因特网的图像信息的超文本因特网协议被采用，使每一个人可以产生自己的图像页面（网址），然后成为一个巨大的虚拟超文本网络的组成部分。这个增强型的因特网又被非正式地称为万维网，与此同时产生了数量庞大的新用户群。于是，许多人用“因特网” 一词指这个网络的物理结构，包括连接所有事物的客户机、服务器和网络；而用“万维网”一词指利用这个网络可以访问的所有网站和信息。</p>
<h2 id="Internet-和中国"><a href="#Internet-和中国" class="headerlink" title="Internet 和中国"></a>Internet 和中国</h2><p>北京时间1987年9月14日，物理研究员钱天白建立起一个网络节点，通过电话拨号连接到国际互联网，向他的德国朋友发出来自中国的第一封电子邮件：Across the Great Wall we can reach every corner in the world，自此，中国与国际计算机网络开始连接在一起</p>
<p><img src="../../../../images/SRE/day28/1.jpg" alt="1"></p>
<p><img src="../../../../images/SRE/day28/2.jpg" alt="2"></p>
<p>1990年10月，钱天白教授代表中国正式在国际互联网络信息中心的前身DDN-NIC注册登记了我国的顶级域名CN，并且从此开通了使用中国顶级域名CN的国际电子邮件服务。由于当时中国尚未正式连入Internet，所以委托德国卡尔斯鲁厄大学运行CN域名服务器</p>
<p>1993年3月2日， 中国科学院高能物理研究所租用AT&amp;T公司的国际卫星信道接入美国斯坦福线性加速器中心（SLAC）的64K专线正式开通,专线开通后，美国政府以Internet上有许多科技信息和其它各种资源，不能让社会主义国家接入为由，只允许这条专线进入美国能源网而不能连接到其它地方。尽管如此，这条专线仍是我国部分连入Internet的第一根专线</p>
<p>1994年4月20日，中国通过一条64k的国际专线全功能接入国际互联网，成为国际互联网大家庭中的第77个成员，正式开启了互联网时代。随后，中科院高能物理研究所推出第一个WWW网站和第一套网页</p>
<p>1994年5月21日， 在钱天白教授和德国卡尔斯鲁厄大学的协助下，中国科学院计算机网络信息中心完成了中国国家顶级域名(CN)服务器的设置，改变了中国CN顶级域名服务器一直放在国外的历史</p>
<p>1995年5月17日， 第27个世界电信日，邮电部正式宣布，向国内社会开放计算机互联网接入服务</p>
<p>1995年5月，北京的中关村南大街上出现了一块巨大的广告牌，”中国离信息高速公路还有多远？向北1500米。”那个位置就是一家叫”瀛海威”的网络科教馆，瀛海威正是information highway的音译，作为中国第一个互联网接入服务商，瀛海威几乎就是当时互联网的代名词</p>
<p>1996年1月，中国互联网全国骨干网建成并正式开通，开始提供服务</p>
<p>1995年4月，马云凑了两万块钱，成立杭州海博网络公司，专门给企业做主页</p>
<p>1997年5月，丁磊创立网易</p>
<p>1998年2月， 张朝阳创立搜狐</p>
<p>1998年6月18日，刘强东在中关村创办京东公司，代理销售光磁产品</p>
<p>1998年11月，马化腾和张志东成立深圳市腾讯计算机系统有限公司，OICQ开通</p>
<p>1998年12月， 新浪网成立，关键人物：王志东 </p>
<p>1999年5月18日，中国第一家电子商务企业8848.com成立，创始人王峻涛也曾被誉为“中国电子商务教父”。2000年底，调查显示接近70%的人说上网买东西首选 8848</p>
<p>2000年1月，李彦宏创建了百度</p>
<p>2003年5月，阿里巴巴集团在创立淘宝网</p>
<p>2003年10月，淘宝网首次推出支付宝服务</p>
<p>2009年11月, 阿里开始举办双十一购物狂欢节</p>
<p>2012年1月11日淘宝商城正式更名为“天猫”</p>
<p>2014年9月19日阿里巴巴集团于纽约证券交易所正式挂牌上市</p>
<p>2004年1月，京东多媒体网正式开通，启用域名<a target="_blank" rel="noopener" href="http://www.jdlaser.com/">www.jdlaser.com</a></p>
<p>2010年4月，雷军创办小米</p>
<p>2011年1月21日，腾讯公司推出微信 (WeChat) </p>
<p>2012年3月，今日头条由张一鸣于创建</p>
<p>2012年7月10日，北京小桔科技有限公司成立，滴滴司机端3个月后北京上线</p>
<p>2016年9月20日, 字节跳动上线抖音</p>
<p><strong>中国互联网连接世界</strong></p>
<p>1885年台湾建省，首任巡抚刘铭传派人与福州船政联系，使用船政电报学堂毕业生为技术人员，于1887年铺设成功台湾淡水至福州川石海底电缆，全长117海里。这是我国自行设计安装的第一条海底电缆。此电缆毁于第二次世界大战我国于1989年开始投入到全球海底光缆的投资与建设中来，并于1993年实现了首条国际海底光缆的登陆（中日之间C-J海底光缆系统）；随后在1997年，我国参与建设的全球海底光缆系统（FLAG）建成并投入运营，这也是第一条在我国登陆的洲际海底光缆中国连接世界目前共有8条光缆，四个登陆站允许入境，目前我国的登陆站设立在三个城市的四个地区，分别是山东青岛登陆站（隶属中国联通）、上海崇明登陆站（隶属中国电信）、上海南汇登陆站（隶属中国联通）和广东汕头登陆站（隶属中国电信） </p>
<p>1993年3月2日，中国科学院高能物理研究所租用AT&amp;T公司的国际卫星信道建立的接入美国SLAC国家实验室的64K专线正式开通，成为我国连入Internet的第一根专线。</p>
<p>参考链接: <a target="_blank" rel="noopener" href="http://www.ihep.cas.cn/kxcb/kpcg/jsywl/201407/t20140714_4156699.html">http://www.ihep.cas.cn/kxcb/kpcg/jsywl/201407/t20140714_4156699.html</a></p>
<p>下图是海底光缆</p>
<p><img src="../../../../images/SRE/day28/3.jpg" alt="3"></p>
<h2 id="HTTP-超文本传输协议"><a href="#HTTP-超文本传输协议" class="headerlink" title="HTTP 超文本传输协议"></a>HTTP 超文本传输协议</h2><h3 id="HTTP-相关概念"><a href="#HTTP-相关概念" class="headerlink" title="HTTP 相关概念"></a>HTTP 相关概念</h3><p>互联网：是网络的网络，是所有类型网络的母集。</p>
<p>因特网：世界上最大的互联网网络。即因特网概念从属于互联网概念。习惯上，大家把连接在因特网上的计算机都成为主机。</p>
<p>万维网：WWW（world wide web）万维网并非某种特殊的计算机网络，是一个大规模的、联机式的信息贮藏库，使用链接的方法能非常方便地从因特网上的一个站点访问另一个站点（超链技术），具有提供分布式服务的特点。万维网是一个分布式的超媒体系统，是超文本系统的扩充，基于B/S架构实现</p>
<p><img src="../../../../images/SRE/day28/4.jpg" alt="4"></p>
<p>URL：万维网使用统一资源定位符（Uniform Resource Locator）来标志万维网上的各种文档，并使每个文档在整个因特网的范围内具有唯一的标识符URL。</p>
<p>HTTP：为解决”用什么样的网络协议来实现整个因特网上的万维网文档”这一难题，就要使万维网客户程序（以浏览器为主，但不限于浏览器）与万维网服务器程序之间的交互遵守严格的协议，即超文本传送协议（HyperText Transfer Protocol）。HTTP是处于应用层的协议，使用TCP传输层协议进行可靠的传送。因此，需要特别提醒的是，万维网是基于因特网的一种广泛因特网应用系统，且万维网采用的是 HTTP（80/TCP）和 HTTPS（443/TCP）的传输协议，但因特网还有其他的网络应用系统（如：FTP、SMTP等等）。</p>
<p>HTML：为了解决”怎样使不同作者创作的不同风格的万维网文档，都能在因特网上的各种主机上显示出来，同时使用户清楚地知道在什么地方存在着链接”这一问题，万维网使用超文本标记语言（HyperText Markup Language），使得万维网页面的设计者可以很方便地用链接从页面的某处链接到因特网的任何一个万维网页面，并且能够在自己的主机品目上将这些页面显示出来。HTML与txt一样，仅仅是是一种文档，不同之处在于，这种文档专供于浏览器上为浏览器用户提供统一的界面呈现的统一规约。且具备结构化的特征，这是txt所不具备的强制规定。</p>
<h3 id="浏览器访问网站的过程"><a href="#浏览器访问网站的过程" class="headerlink" title="浏览器访问网站的过程"></a>浏览器访问网站的过程</h3><p><img src="../../../../images/SRE/day28/5.jpg" alt="5"></p>
<h3 id="HTTP-协议通信过程"><a href="#HTTP-协议通信过程" class="headerlink" title="HTTP 协议通信过程"></a>HTTP 协议通信过程</h3><p><img src="../../../../images/SRE/day28/6.jpg" alt="6"></p>
<p>HTTP（HyperText Transfer Protocol，超文本传输协议）是一种用于分布式、协作式和超媒体信息系统的应用层协议。HTTP是万维网的数据通信的基础设计HTTP最初的目的是为了提供一种远距离共享知识的方式，借助多文档进行关联实现超文本，连成相互参阅的WWW（world wide web,万维网）</p>
<p>HTTP的发展是由蒂姆·伯纳斯-李（Tim Berners-Lee）于1989年在欧洲核子研究组织（CERN）所发起。HTTP的标准制定由万维网协会（World Wide Web Consortium，W3C）和互联网工程任务组（Internet Engineering Task Force，IETF）进行协调，最终发布了一系列的RFC，其中最著名的是 1999年6月公布的 RFC 2616，定义了HTTP协议中现今广泛使用的一个版本——HTTP 1.1版</p>
<p><strong>HTTP服务通信过程</strong></p>
<p><img src="../../../../images/SRE/day28/7.jpg" alt="7"></p>
<p><strong>HTTP协议分层</strong></p>
<p><img src="../../../../images/SRE/day28/8.jpg" alt="8"></p>
<h3 id="HTTP-相关技术"><a href="#HTTP-相关技术" class="headerlink" title="HTTP 相关技术"></a>HTTP 相关技术</h3><h4 id="WEB-开发语言"><a href="#WEB-开发语言" class="headerlink" title="WEB 开发语言"></a>WEB 开发语言</h4><p><strong>http</strong>：Hyper Text Transfer Protocol 应用层协议，默认端口： 80/tcp</p>
<p><strong>WEB前端开发语言：</strong> </p>
<ul>
<li>html</li>
<li>css</li>
<li>javascript</li>
</ul>
<p><img src="../../../../images/SRE/day28/9.jpg" alt="9"></p>
<p><strong>html</strong></p>
<p>Hyper Text Markup Language 超文本标记语言，编程语言，主要负责实现页面的结构</p>
<p>范例：html 语言</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">Content-Type</span> <span class="attr">content</span>=<span class="string">&quot;text/html;charset=utf-8&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">title</span>&gt;</span>HTML语言<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">&quot;http://www.magedu.com/wp-content/uploads/2017/09/logo.png&quot;</span> &gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">h1</span> <span class="attr">style</span>=<span class="string">&quot;color:red&quot;</span>&gt;</span>欢迎<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">p</span>&gt;</span><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">http://www.magedu.com</span>&gt;</span>马哥教育<span class="tag">&lt;/<span class="name">a</span>&gt;</span>欢迎你<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br><span class="line"></span><br><span class="line">#注意:html文件编码为utf-8编码</span><br></pre></td></tr></table></figure>

<p><strong>CSS</strong></p>
<p>Cascading Style Sheet 层叠样式表， 定义了如何显示（装扮） HTML 元素，比如：字体大小和颜色属性等。样式通常保存在外部的 .css 文件中,用于存放一些HTML文件的公共属性,从而通过仅编辑一个简单的 CSS 文档，可以同时改变站点中所有页面的布局和外观。</p>
<p>范例 ：CSS</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">#test.html 建议用Vscode创建文件,用记事本可能会出现乱码</span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">Content-Type</span> <span class="attr">content</span>=<span class="string">&quot;text/html;charset=utf-8&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">&quot;stylesheet&quot;</span> <span class="attr">type</span>=<span class="string">&quot;text/css&quot;</span> <span class="attr">href</span>=<span class="string">&quot;mystyle.css&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">h1</span>&gt;</span>这是 heading 1<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">p</span>&gt;</span>这是一段普通的段落。请注意，该段落的文本是红色的。在 body 选择器中定义了本页面中的默认文本颜色。<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">p</span> <span class="attr">class</span>=<span class="string">&quot;ex&quot;</span>&gt;</span>该段落定义了 class=&quot;ex&quot;。该段落中的文本是蓝色的。<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br><span class="line"></span><br><span class="line">#mystyle.css</span><br><span class="line">body &#123;color:red&#125;</span><br><span class="line">h1 &#123;color:#00ff00&#125;</span><br><span class="line">p.ex &#123;color:rgb(0,0,255)&#125;</span><br></pre></td></tr></table></figure>

<p><strong>Js</strong></p>
<p>javascript，实现网页的动画效果，但实属于静态资源</p>
<p>范例：javascript</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">Content-Type</span> <span class="attr">content</span>=<span class="string">&quot;text/html;charset=utf-8&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">h2</span>&gt;</span>我的第一个 JavaScript<span class="tag">&lt;/<span class="name">h2</span>&gt;</span></span><br><span class="line">    </span><br><span class="line"><span class="tag">&lt;<span class="name">button</span> <span class="attr">type</span>=<span class="string">&quot;button&quot;</span> <span class="attr">onclick</span>=<span class="string">&quot;document.getElementById(&#x27;demo&#x27;).innerHTML = Date()&quot;</span>&gt;</span>点击这里来显示日期和时间</span><br><span class="line"><span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">    </span><br><span class="line"><span class="tag">&lt;<span class="name">p</span> <span class="attr">id</span>=<span class="string">&quot;demo&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h4 id="MIME"><a href="#MIME" class="headerlink" title="MIME"></a>MIME</h4><p>MIME : Multipurpose Internet Mail Extensions 多用途互联网邮件扩展</p>
<p>文件 /etc/mime.types ,来自于mailcap包</p>
<p>MIME格式：type/subtype txt html jpg bmp</p>
<p>参考链接：</p>
<p><a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Basics_of_HTTP/MIME_Types">https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Basics_of_HTTP/MIME_Types</a></p>
<p><a target="_blank" rel="noopener" href="http://www.w3school.com.cn/media/media_mimeref.asp">http://www.w3school.com.cn/media/media_mimeref.asp</a></p>
<p>范例：</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">text/plain   txt asc text pm el c h cc hh cxx hxx f90 conf log</span><br><span class="line">text/html     html htm</span><br><span class="line">text/css </span><br><span class="line">image/jpeg    jpg jpeg</span><br><span class="line">image/png </span><br><span class="line">video/mp4 </span><br><span class="line">application/javascript</span><br></pre></td></tr></table></figure>

<h4 id="URI和URL"><a href="#URI和URL" class="headerlink" title="URI和URL"></a>URI和URL</h4><p>参考链接</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Basics_of_HTTP/Identifying_resources_on_the_Web</span><br></pre></td></tr></table></figure>

<p>URI： Uniform Resource Identifier 统一资源标识，分为URL 和 URN</p>
<p>URN：Uniform Resource Naming，统一资源命名</p>
<p>示例： P2P下载使用的磁力链接是URN的一种实现</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">magnet:?xt=urn:btih:1E45C21458681BFECBEB72D77A2500762D6F799F</span><br></pre></td></tr></table></figure>

<p>URL：Uniform Resorce Locator，统一资源定位符，用于描述某服务器某特定资源位置</p>
<p>两者区别：URN如同一个人的名称，而URL代表一个人的住址。换言之，URN定义某事物的身份，而URL提供查找该事物的方法。URN仅用于命名，而不指定地址</p>
<p>URL组成</p>
<p><img src="../../../../images/SRE/day28/10.jpg" alt="10"></p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;scheme&gt;://&lt;user&gt;:&lt;password&gt;@&lt;host&gt;:&lt;port&gt;/&lt;path&gt;;&lt;params&gt;?&lt;query&gt;#&lt;frag&gt;</span><br></pre></td></tr></table></figure>

<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">scheme:方案，访问服务器以获取资源时要使用哪种协议</span><br><span class="line">user:用户，某些方案访问资源时需要的用户名</span><br><span class="line">password:密码，用户对应的密码，中间用：分隔</span><br><span class="line">Host:主机，资源宿主服务器的主机名或IP地址</span><br><span class="line">port:端口,资源宿主服务器正在监听的端口号，很多方案有默认端口号</span><br><span class="line">path:路径,服务器资源的本地名，由一个/将其与前面的URL组件分隔</span><br><span class="line">params:参数，指定输入的参数，参数为名/值对，多个参数，用;分隔</span><br><span class="line">query:查询，传递参数给程序，如数据库，用？分隔,多个查询用&amp;分隔</span><br><span class="line">frag:片段,一小片或一部分资源的名字，此组件在客户端使用，用#分隔</span><br></pre></td></tr></table></figure>

<p><strong>URL示例</strong></p>
<p><img src="../../../../images/SRE/day28/11.jpg" alt="11"></p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">http://www.magedu.com:8080/images/logo.jpg</span><br><span class="line">ftp://mage:password@172.16.0.1/pub/linux.ppt</span><br><span class="line">rtsp://videoserver/video_demo/ #Real Time Streaming Protocol</span><br><span class="line">gcomm://10.0.0.8,10.0.0.18,10.0.0.28 </span><br><span class="line">http://www.magedu.com/bbs/hello;gender=f/send;type=title</span><br><span class="line">https://list.jd.com/list.html?</span><br><span class="line">cat=670,671,672&amp;ev=14_2&amp;sort=sort_totalsales15_desc&amp;trans=1</span><br><span class="line">http://apache.org/index.html#projects-list</span><br></pre></td></tr></table></figure>

<h4 id="网站访问量"><a href="#网站访问量" class="headerlink" title="网站访问量"></a>网站访问量</h4><p><strong>网站访问量统计的重要指标</strong></p>
<ul>
<li>IP(独立IP)：即Internet Protocol,指独立IP数。一天内来自相同客户机IP 地址只计算一次，记录远程客户机IP地址的计算机访问网站的次数，是衡量网站流量的重要指标</li>
<li>PV(访问量)： 即Page View, 页面浏览量或点击量，用户每次刷新即被计算一次，PV反映的是浏览某网站的页面数，PV与来访者的数量成正比，PV并不是页面的来访者数量，而是网站被访问的页面数量</li>
<li>UV(独立访客)：即Unique Visitor,访问网站的一台电脑为一个访客。一天内相同的客户端只被计算一次。可以理解成访问某网站的电脑的数量。网站判断来访电脑的身份是通过cookies实现的。如果更换了IP后但不清除cookies，再访问相同网站，该网站的统计中UV数是不变的</li>
</ul>
<p><strong>网站统计：</strong><a target="_blank" rel="noopener" href="http://www.alexa.cn/rank/">http://www.alexa.cn/rank/</a></p>
<p>范例：网站访问统计</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">1. 甲乙丙三人在同一台通过 ADSL 上网的电脑上（中间没有断网），分别访问 www.magedu.com 网站，并且每人共用一个浏览器，各个浏览了2个页面，那么网站的流量统计是：</span><br><span class="line"><span class="attribute">IP</span><span class="punctuation">: </span>1 PV:6   UV：1</span><br><span class="line">2. 若三人都是ADSL重新拨号后,各个使用不同的浏览器，分别浏览了2个页面，则</span><br><span class="line"><span class="attribute">IP</span><span class="punctuation">: </span>3 PV:6 UV：3</span><br></pre></td></tr></table></figure>

<p><strong>网站访问量 PV,IP,UV统计方法</strong></p>
<ul>
<li>使用文本工具, 比如awk提取IP，sort排序、uniq统计去重后统计IP数</li>
<li>第三方统计工具进行pv统计，比如: 百度统计、腾讯分析、piwik、开发自研统计平台。</li>
</ul>
<h3 id="HTTP工作机制"><a href="#HTTP工作机制" class="headerlink" title="HTTP工作机制"></a>HTTP工作机制</h3><p>一次http事务包括：</p>
<ul>
<li>http请求：http request</li>
<li>http响应：http response</li>
</ul>
<p><strong>Web资源</strong>：web resource， 一个网页由多个资源（文件）构成，打开一个页面，通常会有多个资源展示出来，但是每个资源都要单独请求。因此，一个“Web 页面”通常并不是单个资源，而是一组资源的集合</p>
<p><strong>资源类型：</strong></p>
<ul>
<li><p>静态文件：无需服务端做出额外处理,服务器端和客户端的文件内容相同 </p>
<p>常见文件后缀：.html, .txt, .jpg, .js, .css, .mp3, .avi</p>
</li>
<li><p>动态文件：服务端执行程序，返回执行的结果,服务器端和客户端的文件内容不相同</p>
<p>常见文件后缀：.php, .jsp ,.asp</p>
</li>
</ul>
<p><strong>HTTP 连接请求</strong></p>
<p><img src="../../../../images/SRE/day28/12.jpg" alt="12"></p>
<p><strong>串行和并行连接</strong></p>
<p><img src="../../../../images/SRE/day28/13.jpg" alt="13"></p>
<p><strong>串行,持久连接和管道</strong></p>
<p><img src="../../../../images/SRE/day28/14.jpg" alt="14"></p>
<p><strong>提高HTTP连接性能</strong> </p>
<ul>
<li>并行连接：通过多条TCP连接发起并发的HTTP请求</li>
<li>持久连接：keep-alive，重用TCP连接，以消除连接和关闭的时延,以事务个数和时间来决定是否关闭连接</li>
<li>管道化连接：通过共享TCP连接，发起并发的多个HTTP请求,但需要也要按发起请求的顺序来接收响应,实现难度很大,很多代理服务器和浏览器不支持</li>
<li>复用的连接：交替传送请求和响应报文（实验阶段）</li>
</ul>
<h3 id="HTTP-协议版本"><a href="#HTTP-协议版本" class="headerlink" title="HTTP 协议版本"></a>HTTP 协议版本</h3><h4 id="HTTP-1-X-协议"><a href="#HTTP-1-X-协议" class="headerlink" title="HTTP 1.X 协议"></a>HTTP 1.X 协议</h4><p>RFC Hypertext Transfer Protocol – HTTP/1.1</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://tools.ietf.org/html/rfc2616</span><br></pre></td></tr></table></figure>

<p><img src="../../../../images/SRE/day28/15.jpg" alt="15"></p>
<p><strong>http/0.9：</strong></p>
<p>1991，原型版本，功能简陋，只有一个命令GET。GET /index.html ,服务器只能回应HTML格式字符串，不能回应别的格式</p>
<p><strong>http/1.0</strong></p>
<p>1996年5月,支持cache, MIME, method</p>
<p>每个TCP连接只能发送一个请求，发送数据完毕，连接就关闭，如果还要请求其他资源，就必须再新建一个连接引入了POST命令和HEAD命令头信息是 ASCII 码，后面数据可为任何格式。服务器回应时会告诉客户端，数据是什么格式，即Content-Type字段的作用。这些数据类型总称为MIME 多用途互联网邮件扩展，每个值包括一级类型和二级类型，预定义的类型，也可自定义类型, 常见Content-Type值：text/xml image/jpeg audio/mp3 </p>
<p><strong>http/1.1</strong></p>
<p>1997年1月，引入了持久连接（persistent connection），即TCP连接默认不关闭，可以被多个请求复用，不用声明Connection: keep-alive。对于同一个域名，大多数浏览器允许同时建立6个持久连接引入了管道机制，即在同一个TCP连接里，客户端可以同时发送多个请求，进一步改进了HTTP协议的效率</p>
<p>新增方法：PUT、PATCH、OPTIONS、DELETE</p>
<p>同一个TCP连接里，所有的数据通信是按次序进行的。服务器只能顺序处理回应，前面的回应慢，会有许多请求排队，造成”队头堵塞”（Head-of-line blocking）</p>
<p>为避免上述问题，两种方法：一是减少请求数，二是同时多开持久连接。</p>
<p>网页优化技巧，如合并脚本和样式表、将图片嵌入CSS代码、域名分片（domain sharding）等</p>
<p>HTTP 协议不带有状态，每次请求都必须附上所有信息。请求的很多字段都是重复的，浪费带宽，影响速度</p>
<p><strong>HTTP1.0和HTTP1.1的区别</strong></p>
<p><img src="../../../../images/SRE/day28/16.jpg" alt="16"></p>
<ul>
<li>缓存处理，在HTTP1.0中主要使用header里的If-Modified-Since,Expires来做为缓存判断的标准，HTTP1.1则引入了更多的缓存控制策略例如Entity tag，If-Unmodified-Since, If-Match, If-None-Match等更多可供选择的缓存头来控制缓存策略</li>
<li>带宽优化及网络连接的使用，HTTP1.0中，存在一些浪费带宽的现象，例如：客户端只是需要某个对象的一部分，而服务器却将整个对象送过来了，并且不支持断点续传功能，HTTP1.1则在请求头引入了range头域，它允许只请求资源的某个部分，即返回码是206（Partial Content），方便了开发者自由的选择以便于充分利用带宽和连接</li>
<li>错误通知的管理，在HTTP1.1中新增24个状态响应码，如409（Conflict）表示请求的资源与资源当前状态冲突；410（Gone）表示服务器上的某个资源被永久性的删除</li>
<li>Host 头处理，在HTTP1.0中认为每台服务器都绑定一个唯一的IP地址，因此，请求消息中的URL并没有传递主机名（hostname）。但随着虚拟主机技术的发展，在一台物理服务器上可以存在多个虚拟主机（Multi-homed Web Servers），并且它们共享一个IP地址。HTTP1.1的请求消息和响应消息都应支持Host头域，且请求消息中如果没有Host头域会报告一个错误（400 Bad Request）</li>
<li>长连接，HTTP 1.1支持持久连接（PersistentConnection）和请求的流水线（Pipelining）处理，在一个TCP连接上可以传送多个HTTP请求和响应，减少了建立和关闭连接的消耗和延迟，在HTTP1.1中默认开启Connection： keep-alive，弥补了HTTP1.0每次请求都要创建连接的缺点</li>
</ul>
<p><strong>HTTP1.0和1.1的问题</strong></p>
<ul>
<li>HTTP1.x在传输数据时，每次都需要重新建立连接，无疑增加了大量的延迟时间，特别是在移动端更为突出</li>
<li>HTTP1.x在传输数据时，所有传输的内容都是明文，客户端和服务器端都无法验证对方的身份，无 法保证数据的安全性</li>
<li>HTTP1.x在使用时，header里携带的内容过大，增加了传输的成本，并且每次请求header基本不怎么变化，尤其在移动端增加用户流量</li>
<li>虽然HTTP1.x支持了keep-alive，来弥补多次创建连接产生的延迟，但是keep-alive使用多了同样会给服务端带来大量的性能压力，并且对于单个文件被不断请求的服务(例如图片存放网站)，keep-alive可能会极大的影响性能，因为它在文件被请求之后还保持了不必要的连接很长时间</li>
</ul>
<p><strong>HTTPS协议</strong>：</p>
<p>为解决安全问题，网景在1994年创建了HTTPS，并应用在网景导航者浏览器中。 最初，HTTP是与SSL一起使用的；在SSL逐渐演变到TLS时（其实两个是一个东西，只是名字不同而已），最新的HTTPS也由在2000年五月公布的RFC 2818正式确定下来。HTTPS就是安全版的HTTP，目前大型网站基本实现全站HTTPS</p>
<p><strong>HTTPS特点</strong></p>
<ul>
<li>HTTPS协议需要到CA申请证书，一般免费证书很少，需要交费</li>
<li>HTTP协议运行在TCP之上，所有传输的内容都是明文，HTTPS运行在SSL/TLS之上，SSL/TLS运行在TCP之上，所有传输的内容都经过加密的 </li>
<li>HTTP和HTTPS使用的是不同的连接方式，端口不同，前者是80，后者是443</li>
<li>HTTPS可以有效的防止运营商劫持，解决了防劫持的一个大问题</li>
<li>HTTPS 实现过程降低用户访问速度，但经过合理优化和部署，HTTPS 对速度的影响还是可以接受的</li>
</ul>
<h4 id="HTTP-2-0-协议"><a href="#HTTP-2-0-协议" class="headerlink" title="HTTP 2.0 协议"></a>HTTP 2.0 协议</h4><p><strong>SPDY协议</strong></p>
<p>SPDY：2009年谷歌研发，综合HTTPS和HTTP两者有点于一体的传输协议，主要特点：</p>
<ul>
<li>降低延迟，针对HTTP高延迟的问题，SPDY优雅的采取了多路复用（multiplexing）。多路复用通过多个请求stream共享一个tcp连接的方式，解决了HOL blocking的问题，降低了延迟同时提高了带宽的利用率</li>
<li>请求优先级（request prioritization）。多路复用带来一个新的问题是，在连接共享的基础之上有可能会导致关键请求被阻塞。SPDY允许给每个request设置优先级，重要的请求就会优先得到响应。比如浏览器加载首页，首页的html内容应该优先展示，之后才是各种静态资源文件，脚本文件等加载，可以保证用户能第一时间看到网页内容</li>
<li>header压缩。HTTP1.x的header很多时候都是重复多余的。选择合适的压缩算法可以减小包的大 小和数量</li>
<li>基于HTTPS的加密协议传输，大大提高了传输数据的可靠性</li>
<li>服务端推送（server push），采用了SPDY的网页，例如网页有一个sytle.css的请求，在客户端收到sytle.css数据的同时，服务端会将sytle.js的文件推送给客户端，当客户端再次尝试获取sytle.js时就可以直接从缓存中获取到，不用再发请求了 </li>
</ul>
<p><strong>HTTP2协议</strong></p>
<p>http/2.0：2015年发布，HTTP2.0是SPDY的升级版</p>
<ul>
<li>头信息和数据体都是二进制，称为头信息帧和数据帧</li>
<li>复用TCP连接，在一个连接里，客户端和浏览器都可以同时发送多个请求或回应，且不用按顺序响应，避免了”队头堵塞”,此双向的实时通信称为多工（Multiplexing）</li>
<li>引入头信息压缩机制（header compression）,头信息使用gzip或compress压缩后再发送；客户端和服务器同时维护一张头信息表，所有字段都会存入这个表，生成一个索引号，不发送同样字段，只发送索引号，提高速度</li>
<li>HTTP/2 允许服务器有新数据时未经请求，主动向客户端发送资源，而无需客户端拉取,即服务器推送（server push）</li>
</ul>
<p><strong>HTTP2.0和SPDY区别：</strong></p>
<ul>
<li>HTTP2.0 支持明文 HTTP 传输，而 SPDY 强制使用 HTTPS</li>
<li>HTTP2.0 消息头的压缩算法采用 HPACK，而非 SPDY 采用的 DEFLATE</li>
</ul>
<p><strong>HTTP 版本速度比较</strong></p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://http2.akamai.com/demo/http2-lab.html</span><br></pre></td></tr></table></figure>

<h4 id="HTTP-3-0-协议"><a href="#HTTP-3-0-协议" class="headerlink" title="HTTP 3.0 协议"></a>HTTP 3.0 协议</h4><p><img src="../../../../images/SRE/day28/17.jpg" alt="17"></p>
<p><img src="../../../../images/SRE/day28/18.jpg" alt="18"></p>
<p>2020年发布 HTTP/3 的草案,2022年6月正式发布,使用QUIC(基于UDP协议)的新协议代替TCP</p>
<p>它在传输层引入流作为一等公民,多个QUIC流共享相同的快速连接,因此不需要额外的握手,来创建新连接,QUIC流是独立交付的,在大多数情况下，丢包仅影响一个流,并不影响其他流,这就是QUIC 在传输层消除队头阻塞的方法</p>
<p>QUIC是为移动互联网重度使用而设计的,携带智能手机的人们经常从一个网络切换到另一个网络,如果使用TCP,从一个网络切换到另一个网络是很慢的</p>
<p>QUIC实现了一个称为连接ID的概念,它允许连接在IP地址和网络接口之间快速可靠地移动</p>
<p>尽管HTTP/3刚刚发布,号称已经有25%的网站开始使用,许多浏览器也支持它</p>
<p><img src="../../../../images/SRE/day28/19.jpg" alt="19"></p>
<p>QUIC的数据包格式</p>
<p>从协议栈可以看出:QUIC = HTTP/2 + TLS + UDP</p>
<p><img src="../../../../images/SRE/day28/20.jpg" alt="20"></p>
<p><img src="../../../../images/SRE/day28/21.jpg" alt="21"></p>
<p>QUIC的数据包分为Header和Data部分，其中Header是明文传输，包括Flags是标志位，Connection ID是连接ID，可用于连接迁移，QUIC Version是QUIC的版本号，Packet Number是包序号，用于保证可靠传输；Data部分是密文传输，是一些数据帧，有很多数据帧类型：Stream、ACK、Padding、Blocked等，其中Stream帧传输应用数据。</p>
<p>Stream</p>
<p><img src="../../../../images/SRE/day28/22.jpg" alt="22"></p>
<h3 id="HTTP-请求访问的完整过程"><a href="#HTTP-请求访问的完整过程" class="headerlink" title="HTTP 请求访问的完整过程"></a>HTTP 请求访问的完整过程</h3><p><img src="../../../../images/SRE/day28/23.jpg" alt="23"></p>
<p><strong>一次完整的http请求处理过程</strong> </p>
<p>1、建立连接：接收或拒绝连接请求</p>
<p>2、接收请求：接收客户端请求报文中对某资源的一次请求的过程</p>
<p>Web访问响应模型（Web I/O）</p>
<p><img src="../../../../images/SRE/day28/24.jpg" alt="24"></p>
<ul>
<li>单进程I/O模型：启动一个进程处理用户请求，而且一次只处理一个，多个请求被串行响应</li>
<li>多进程I/O模型：并行启动多个进程,每个进程响应一个连接请求</li>
<li>复用I/O结构：启动一个进程，同时响应N个连接请求</li>
<li>复用的多进程I/O模型：启动M个进程，每个进程响应N个连接请求，同时接收M*N个请求</li>
</ul>
<p>3、处理请求：服务器对请求报文进行解析，并获取请求的资源及请求方法等相关信息，根据方法，资源，首部和可选的主体部分对请求进行处理</p>
<p>常用请求Method: GET、POST、HEAD、PUT、DELETE、TRACE、OPTIONS</p>
<p>4、访问资源：</p>
<p>​        服务器获取请求报文中请求的资源web服务器，即存放了web资源的服务器，负责向请求者提供对方 请求的静态资源，或动态运行后生成的资源</p>
<p>5、构建响应报文：</p>
<p>​        一旦Web服务器识别除了资源，就执行请求方法中描述的动作，并返回响应报文。响应报文中 包含有响应状态码、响应首部，如果生成了响应主体的话，还包括响应主体</p>
<p>1）响应实体：如果事务处理产生了响应主体，就将内容放在响应报文中回送过去。响应报文中通常包括：</p>
<ul>
<li>描述了响应主体MIME类型的Content-Type首部</li>
<li>描述了响应主体长度的Content-Length</li>
<li>实际报文的主体内容</li>
</ul>
<p>2）URL重定向：web服务构建的响应并非客户端请求的资源，而是资源另外一个访问路径</p>
<p>3）MIME类型： Web服务器要负责确定响应主体的MIME类型。多种配置服务器的方法可将MIME类型与资源管理起来</p>
<p>6、发送响应报文</p>
<p>​        Web服务器通过连接发送数据时也会面临与接收数据一样的问题。服务器可能有很多条到各个客户端的连接，有些是空闲的，有些在向服务器发送数据，还有一些在向客户端回送响应数据。服务器要记录连接的状态，还要特别注意对持久连接的处理。对非持久连接而言，服务器应该在发送了整条报文之后，关闭自己这一端的连接。对持久连接来说，连接可能仍保持打开状态，在这种情况下，服务器要正确地计算Content-Length首部，不然客户端就无法知道响应什么时候结束</p>
<p>7、记录日志</p>
<p>​        最后，当事务结束时，Web服务器会在日志文件中添加一个条目，来描述已执行的事务</p>
<h2 id="HTTP-协议报文头部结构"><a href="#HTTP-协议报文头部结构" class="headerlink" title="HTTP 协议报文头部结构"></a>HTTP 协议报文头部结构</h2><p>http协议：http/0.9, http/1.0, http/1.1, http/2.0，http/3.0</p>
<p>http协议：stateless 无状态, 服务器无法持续追踪访问者来源</p>
<p>解决http协议无状态方法</p>
<ul>
<li>cookie 客户端存放</li>
<li>session 服务端存放</li>
</ul>
<p>http事务：一次访问的过程</p>
<ul>
<li>请求：request</li>
<li>响应：response</li>
</ul>
<p>HTTP报文结构</p>
<p>协议查看或分析的工具：tcpdump, wireshark,tshark</p>
<p>参考资料：<a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP">https://developer.mozilla.org/zh-CN/docs/Web/HTTP</a> </p>
<h3 id="HTTP-请求报文"><a href="#HTTP-请求报文" class="headerlink" title="HTTP 请求报文"></a>HTTP 请求报文</h3><p><img src="../../../../images/SRE/day28/25.jpg" alt="25"></p>
<p><strong>request报文格式</strong></p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;method&gt; &lt;request-URL&gt; &lt;version&gt;</span><br><span class="line">&lt;headers&gt;</span><br><span class="line">&lt;entity-body&gt;</span><br></pre></td></tr></table></figure>

<p>范例：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">GET / HTTP/1.1</span><br><span class="line">Accept: */*</span><br><span class="line">Accept-Encoding: gzip, deflate</span><br><span class="line">Connection: keep-alive</span><br><span class="line">Host: www.magedu.com</span><br><span class="line">User-Agent: HTTPie/0.9.4</span><br></pre></td></tr></table></figure>

<p>范例：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">#post.html</span><br><span class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">action</span>=<span class="string">&quot;index.html&quot;</span> <span class="attr">method</span>=<span class="string">&quot;POST&quot;</span>&gt;</span></span><br><span class="line">username:<span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;text&quot;</span> <span class="attr">name</span>=<span class="string">&quot;username&quot;</span> &gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line">password:<span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;text&quot;</span> <span class="attr">name</span>=<span class="string">&quot;password&quot;</span> &gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">br</span>&gt;</span><span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;submit&quot;</span> <span class="attr">value</span>=<span class="string">&quot;Submit&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="HTTP响应报文"><a href="#HTTP响应报文" class="headerlink" title="HTTP响应报文"></a>HTTP响应报文</h3><p><img src="../../../../images/SRE/day28/26.jpg" alt="26"></p>
<p><strong>response报文格式</strong></p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;version&gt; &lt;status&gt; &lt;reason-phrase&gt;</span><br><span class="line">&lt;headers&gt;</span><br><span class="line">&lt;entity-body&gt;</span><br></pre></td></tr></table></figure>

<p>范例：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">HTTP/1.1 200 OK</span><br><span class="line">Cache-Control: max-age=3, must-revalidate</span><br><span class="line">Connection: keep-alive</span><br><span class="line">Content-Encoding: gzip</span><br><span class="line">Content-Type: text/html; charset=UTF-8</span><br><span class="line">Date: Thu, 07 Nov 2019 03:44:14 GMT</span><br><span class="line">Server: Tengine</span><br><span class="line">Transfer-Encoding: chunked</span><br><span class="line">Vary: Accept-Encoding</span><br><span class="line">Vary: Accept-Encoding, Cookie</span><br></pre></td></tr></table></figure>

<h3 id="HTTP报文格式详解"><a href="#HTTP报文格式详解" class="headerlink" title="HTTP报文格式详解"></a>HTTP报文格式详解</h3><h4 id="Method-方法"><a href="#Method-方法" class="headerlink" title="Method 方法"></a>Method 方法</h4><p>请求方法，标明客户端希望服务器对资源执行的动作，包括以下：</p>
<ul>
<li>GET： 从服务器获取一个资源</li>
<li>HEAD： 只从服务器获取文档的响应首部</li>
<li>POST： 向服务器输入数据，通常会再由网关程序继续处理</li>
<li>PUT： 将请求的主体部分存储在服务器中，如上传文件</li>
<li>DELETE： 请求删除服务器上指定的文档</li>
<li>TRACE：追踪请求到达服务器中间经过的代理服务器</li>
<li>OPTIONS：请求服务器返回对指定资源支持使用的请求方法</li>
<li>CONNECT：建立一个到由目标资源标识的服务器的隧道</li>
<li>PATCH：用于对资源应用部分修改</li>
</ul>
<h4 id="version版本"><a href="#version版本" class="headerlink" title="version版本"></a>version版本</h4><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">HTTP/&lt;major&gt;.&lt;minor&gt;</span><br></pre></td></tr></table></figure>

<p>范例：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">HTTP/1.1</span><br></pre></td></tr></table></figure>

<h4 id="status-状态码"><a href="#status-状态码" class="headerlink" title="status 状态码"></a>status 状态码</h4><p><img src="../../../../images/SRE/day28/27.jpg" alt="27"></p>
<p><img src="../../../../images/SRE/day28/28.jpg" alt="28"></p>
<p><img src="../../../../images/SRE/day28/29.jpg" alt="29"></p>
<p><img src="../../../../images/SRE/day28/30.jpg" alt="30"></p>
<p><img src="../../../../images/SRE/day28/31.jpg" alt="31"></p>
<p><img src="../../../../images/SRE/day28/32.jpg" alt="32"></p>
<p>三位数字，标记请求处理过程中发生的情况</p>
<p>参考资料：<a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Status">https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Status</a></p>
<p><strong>http协议状态码分类</strong></p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">1xx：100-101 信息提示</span><br><span class="line">2xx：200-206 成功</span><br><span class="line">3xx：300-307 重定向</span><br><span class="line">4xx：400-415 错误类信息，客户端错误</span><br><span class="line">5xx：500-505 错误类信息，服务器端错误</span><br></pre></td></tr></table></figure>

<p><strong>http协议常用的状态码</strong></p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">200： 成功，请求数据通过响应报文的entity-body部分发送;OK</span><br><span class="line">301： Moved Permanently,请求的URL指向的资源已经被删除；但在响应报文中通过首部Location指明了资源现在所处的新位置</span><br><span class="line">302： Moved Temporarily,响应报文Location指明资源临时新位置</span><br><span class="line">304： 客户端发出了条件式请求，但服务器上的资源未曾发生改变，则通过响应此响应状态码通知客户端；Not Modified,但无需再发送原始数据即实体给客户端</span><br><span class="line">307: 浏览器内部重定向，而无需再向服务器发送请求</span><br><span class="line">401： 需要输入账号和密码认证方能访问资源；Unauthorized</span><br><span class="line">403： 请求被禁止；Forbidden,一般是因为权限错误或主页文件不存在</span><br><span class="line">404： 服务器无法找到客户端请求的资源；Not Found</span><br><span class="line">413： 上传的资源超过了最大限制值</span><br><span class="line">499： 客户端主动断开连接。然而在实际业务开发中，当出现 HTTP 499 状态码时，大部分都是由于服务端</span><br><span class="line">请求时间过长，导致客户端等的“不耐烦”了，因此断开了连接。比如：慢SQL问题，499是客户端读超时关闭</span><br><span class="line">连接造成的，推荐从超时时间或者优化响应速度入手,web服务器发现客户端主动关闭连接后，记录到access</span><br><span class="line">日志中的。可能是客户端接收响应超时了,可以先在客户端统计下是不是这个原因，再调查为什么会导致超时</span><br><span class="line">500： 服务器内部错误；Internal Server Error,比如:cgi程序没有执行权限,或连接数据库失败,rewrite死循环</span><br><span class="line">502： Bad Gateway,代理服务器从后端服务器收到了一条错误响应，如无法连接到网关；Bad Gateway,比如:后端服务端口没有打开,或后端服务不可用,iptable -j REJECT</span><br><span class="line">503： 服务不可用，临时服务器维护或过载，服务器无法处理请求,比如:超过连接数和连接频率</span><br><span class="line">504： Gateway Timeout,网关超时,或者后端服务器无回应报文,比如:服务端口虽然打开,但服务返回结果时间过长,iptable -j DROP</span><br></pre></td></tr></table></figure>

<h4 id="reason-phrase原因短语"><a href="#reason-phrase原因短语" class="headerlink" title="reason-phrase原因短语"></a>reason-phrase原因短语</h4><p>状态码所标记的状态的简要描述</p>
<h4 id="headers首部字段头"><a href="#headers首部字段头" class="headerlink" title="headers首部字段头"></a>headers首部字段头</h4><p>首部字段包含的信息最为丰富。首部字段同时存在于请求和响应报文内，并涵盖 HTTP 报文相关的内容信息。使用首部字段是为了给客服端和服务器端提供报文主体大小、所使用的语言、认证信息等内容</p>
<p>首部字段是由首部字段名和字段值构成的，中间用冒号”：”分隔字段值对应，即key/value 键/值对</p>
<p>单个 HTTP 首部字段可以有多个值</p>
<p>参考资料：<a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Headers">https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Headers</a></p>
<h4 id="entity-body实体"><a href="#entity-body实体" class="headerlink" title="entity-body实体"></a>entity-body实体</h4><p>请求时附加的数据或响应时附加的数据，例如：登录网站时的用户名和密码，博客的上传文章，论坛上的发言等。</p>
<h3 id="Cookie-和-Session"><a href="#Cookie-和-Session" class="headerlink" title="Cookie 和 Session"></a>Cookie 和 Session</h3><p><img src="../../../../images/SRE/day28/33.jpg" alt="33"></p>
<p>无状态协议是指协议对事物处理没有记忆能力。缺少状态意味着如果后续处理需要前面的信息，则必须重传，这样可能导致每次连接传送的数据量增大。另一方面，在服务器不需要先前信息时它应答就很快。</p>
<p>HTTP是超本文传输协议，顾名思义，这个协议支持超文本的传输。什么是超文本？说白了就是使用HTML编写的页面。通常，我们使用客户端浏览器访问服务器的资源，最常见的URL也是以html为后缀的文件，因此可以说超文本是网络上最主要的资源。</p>
<p>既然HTTP协议的目的是在于支持超文本的传输，也就是资源的传输，那么客户端浏览器向HTTP服务器发送请求，继而HTTP服务器将相信资源发回给客户端这样一个过程中，无论对于客户端还是服务器，都没有必要记录这个过程，因为每一次请求和响应都是相对独立的，一般而言，一个URL对应着一个唯一的超文本，正是因为这样的唯一性，使得记录用户的行为状态变得毫无意义，所以，HTTP协议被设计为无状态的连接协议符合它本身的需求。</p>
<p>HTTP协议这种特性有优点也有缺点，优点在于解放了服务器，每一次请求”点到为止”，不会造成不必要的连接占用，缺点在于如果为了保留状态，每次请求都会传输大量的重复信息内容。</p>
<p>可是随着 Web 的不断发展，很多业务都需要对通信状态进行保存.</p>
<p>如果是一次性会话的过程： 打开浏览器 -&gt; 访问一些服务器内容 -&gt; 关闭浏览器</p>
<p>但目前有很多WEB访问场景，并不是一次性会话，而是多次相关的会话，比如：</p>
<p>登录场景：</p>
<p>打开浏览器 -&gt; 浏览到登陆页面 -&gt; 输入用户名和密码 -&gt; 访问到用户主页(显示用户名) -&gt; 修改密码（输入原密码）-&gt; 修改收货地址…….</p>
<p>问题：在此处登录会话过程中产生的数据（用户会话数据）如何保存下来呢？</p>
<p>购物场景：</p>
<p>打开浏览器 -&gt; 浏览商品列表 -&gt; 加入购物车(把商品信息保存下来) -&gt; 关闭浏览器</p>
<p>打开浏览器-&gt; 直接进入购物车 -&gt; 查看到上次加入购物车的商品 -&gt; 下订单 -&gt; 支付 </p>
<p>问题： 在购物会话过程中，如何保存商品信息？</p>
<p>以上场景都需要保留会话数据，需要会话管理机制。</p>
<p>会话管理： 管理浏览器客户端和服务器端之间会话过程中产生的会话数据。</p>
<p>为了会话管理，HTTP就需要传输大量重复信息内容的问题，造成大量的网络带宽消耗。于是 Cookie 和 Session 技术闪亮登场了，它们可以为用户进行会话管理，实现保存状态。</p>
<h4 id="Cookie"><a href="#Cookie" class="headerlink" title="Cookie"></a>Cookie</h4><p>Cookie 又称为”小甜饼”。类型为”小型文本文件”，指某些网站为了辨别用户身份而储存在用户本地终端（Client Side）上的数据（通常经过加密）。由网景公司的前雇员卢·蒙特利在1993年3月发明</p>
<p>因为HTTP协议是无状态的，即服务器不知道用户上一次做了什么，这严重阻碍了交互式Web应用程序的实现。在典型的网上购物场景中，用户浏览了几个页面，买了一盒饼干和两瓶饮料。最后结帐时，由于HTTP的无状态性，不通过额外的手段，服务器并不知道用户到底买了什么，所以Cookie就是用来绕开HTTP的无状态性的”额外手段”之一。服务器可以设置或读取Cookies中包含信息，借此维护用户跟服务器会话中的状态。</p>
<p>在上面的购物场景中，当用户选购了第一项商品，服务器在向用户发送网页的同时，还发送了一段Cookie，记录着那项商品的信息。当用户访问另一个页面，浏览器会把Cookie发送给服务器，于是服务器知道他之前选购了什么。用户继续选购饮料，服务器就在原来那段Cookie里追加新的商品信息。结帐时，服务器读取发送来的Cookie就行了。</p>
<p>Cookie基于HTTP协议，也叫Web Cookie或浏览器Cookie，是服务器发送到用户浏览器并保存在客户端本地的一小块数据，它会在浏览器下次向同一服务器再发起请求时被携带并发送到服务器上。通常，它用于告知服务端两个请求是否来自同一浏览器，如保持用户的登录状态。Cookie使基于无状态的HTTP协议记录稳定的状态信息成为了可能。</p>
<p><strong>cookie 的获取过程</strong></p>
<p><img src="../../../../images/SRE/day28/34.jpg" alt="34"></p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">#第一次请求过程</span><br><span class="line">浏览器第一次发送请求时,不会携带任何cookie信息</span><br><span class="line">服务器接收到请求之后，发现请求中没有任何cookie信息</span><br><span class="line">服务器生成和设置一个cookie.并将此cookie设置通过set_cookie的首部字段保存在响应报文中返回给浏</span><br><span class="line">览器</span><br><span class="line">浏览器接收到这个响应报文之后,发现里面有cookie信息,浏览器会将cookie信息保存起来</span><br><span class="line">#第二次及其之后的过程</span><br><span class="line">当浏览器第二次及其之后的请求报文中自动 cookie的首部字段携带第一次响应报文中获取的cookie信息</span><br><span class="line">服务器再次接收到请求之后,会发现请求中携带的cookie信息,这样的话就认识是谁发的请求了</span><br><span class="line">之后的响应报文中不会再添加set_cookie首部字段</span><br></pre></td></tr></table></figure>

<p>Cookie主要用于以下三个方面：</p>
<ul>
<li>会话状态管理（如用户登录状态、购物车、游戏分数或其它需要记录的信息）</li>
<li>个性化设置（如用户自定义设置、主题等）</li>
<li>浏览器行为跟踪（如跟踪分析用户行为等） </li>
</ul>
<p>使用 Cookie 的状态管理</p>
<p>Cookie 技术通过在请求和响应报文中写入 Cookie 信息来控制客户端的状态。当服务器收到HTTP请求时，服务器可以在响应头里面添加一个Set-Cookie选项。浏览器收到响应后通常会保存下Cookie，之后对该服务器每一次请求中都通过Cookie请求头部将Cookie信息发送给服务器。服务器端发现客户端发送过来的 Cookie 后，会去检查究竟是从哪一个客户端发来的连接请求，然后对比服务器上的记录，最后得到之前的状态信息.另外，Cookie的过期时间、域、路径、有效期、适用站点都可以根据需要来指定。 </p>
<p><strong>Set-Cookie首部字段</strong></p>
<ul>
<li><p>NAME=VALUE 赋予 Cookie 的名称和其值,此为必需项</p>
</li>
<li><p>expires=DATE Cookie 的有效期，若不明确指定则默认为浏览器关闭前为止</p>
<p><strong>会话期Cookie</strong></p>
<p>基于内存保存，会话期Cookie是最简单的Cookie：浏览器关闭之后它会被自动删除，也就是说它仅在会话期内有效。会话期Cookie不需要指定过期时间（Expires）或者有效期（Max-Age）。需要注意的是，有些浏览器提供了会话恢复功能，这种情况下即使关闭了浏览器，会话期Cookie也会被保留下来，就好像浏览器从来没有关闭一样。</p>
<p><strong>持久性Cookie</strong></p>
<p>基于硬盘保存，和关闭浏览器便失效的会话期Cookie不同，持久性Cookie可以指定一个特定的过期时间（Expires）或有效期（Max-Age）。</p>
</li>
</ul>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">Set-Cookie</span><span class="punctuation">: </span>id=a3fWa; Expires=Wed, 21 Oct 2015 07:28:00 GMT;</span><br></pre></td></tr></table></figure>

<p>提示：当Cookie的过期时间被设定时，设定的日期和时间只与客户端相关，而不是服务端。</p>
<ul>
<li><p>path=PATH 指定了主机下的哪些路径可以接受Cookie（该URL路径必须存在于请求URL中）。若不指定则默认为文档所在的文件目录,以字符 %x2F (“/“) 作为路径分隔符，子路径也会被匹配。</p>
<p>例如，设置 Path=/docs ，则以下地址都会匹配：</p>
<ul>
<li>/docs</li>
<li>/docs/Web/</li>
<li>/docs/Web/HTTP </li>
</ul>
</li>
<li><p>domain=域名 指定了哪些主机可以接受Cookie。如果不指定，默认为当前文档的主机（不包含子域名）。如果指定了Domain，则一般包含子域名。</p>
<p>例如，如果设置 Domain=magedu.com，则Cookie也包含子域名（如：study.magedu.com）</p>
</li>
<li><p>Secure 标记为 Secure 的Cookie只应通过被HTTPS协议加密过的请求发送给服务端。但即便设置了 Secure 标记，敏感信息也不应该通过Cookie传输，因为Cookie有其固有的不安全性，Secure 标记也无法提供确实的安全保障。从 Chrome 52 和 Firefox 52 开始，不安全的站点（http:）无法使用Cookie的 Secure 标记。</p>
</li>
<li><p>HttpOnly 加以限制使 Cookie 不能被 JavaScript 脚本访问,为避免跨域脚本 (XSS) 攻击，通过 JavaScript的 Document.cookie API无法访问带有 HttpOnly 标记的Cookie，它们只应该发送给服务端。如果包含服务端 Session 信息的 Cookie 不想被客户端 JavaScript 脚本调用，那么就应该为其设置 HttpOnly 标记</p>
</li>
</ul>
<p><strong>浏览器对cookie的限制：</strong></p>
<p>Cookie 存储的限制是不一样的。例如：单个域名可存储的 Cookie 数量、Cookie 大小等。</p>
<p><img src="../../../../images/SRE/day28/35.jpg" alt="35"></p>
<p>在进行页面 Cookie 操作的时候，应该尽量保证 Cookie 的个数小于 20 个，总大小小于 4KB，这是一个 安全且保险的范围。</p>
<p>范例：响应报文中的set-cookie首部</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">HTTP/1.0</span> <span class="number">200</span> OK</span><br><span class="line"><span class="attribute">Content-type</span><span class="punctuation">: </span>text/html</span><br><span class="line"><span class="attribute">Set-Cookie</span><span class="punctuation">: </span>yummy_cookie=choco</span><br><span class="line"><span class="attribute">Set-Cookie</span><span class="punctuation">: </span>tasty_cookie=strawberry</span><br></pre></td></tr></table></figure>

<p>范例：请求报文中的cookie首部字段</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">GET</span> <span class="string">/sample_page.html</span> <span class="meta">HTTP/1.1</span></span><br><span class="line"><span class="attribute">Host</span><span class="punctuation">: </span>www.example.org</span><br><span class="line"><span class="attribute">Cookie</span><span class="punctuation">: </span>yummy_cookie=choco; tasty_cookie=strawberry</span><br></pre></td></tr></table></figure>

<p>范例：响应报文set-cookie中的Secure 和 HttpOnly</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">Set-Cookie</span><span class="punctuation">: </span>id=a3fWa; Expires=Wed, 21 Oct 2015 07:28:00 GMT; Secure; HttpOnly</span><br></pre></td></tr></table></figure>

<p>范例：浏览器查看cookie</p>
<p><img src="../../../../images/SRE/day28/36.jpg" alt="36"></p>
<p>范例：chrome 浏览器禁止cookie</p>
<p><img src="../../../../images/SRE/day28/37.jpg" alt="37"></p>
<p><img src="../../../../images/SRE/day28/38.jpg" alt="38"></p>
<p>范例：php语言实现cookie的管理</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#设置cookie</span></span><br><span class="line"><span class="comment">#cat setcookie.php </span></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">setcookie</span>(<span class="string">&#x27;title&#x27;</span>,<span class="string">&#x27;cto&#x27;</span>);    <span class="comment">#有效期为会话级</span></span><br><span class="line"><span class="title function_ invoke__">setcookie</span>(<span class="string">&#x27;user&#x27;</span>,<span class="string">&#x27;wang&#x27;</span>,<span class="title function_ invoke__">time</span>()+<span class="number">3600</span>*<span class="number">12</span>);  <span class="comment">#有效期为12小时</span></span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;&lt;h1&gt;test setcookie &lt;/h1&gt;&quot;</span></span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"><span class="comment">#说明：setcookie设置的cookie，只有下一次http请求才能生效</span></span><br><span class="line"><span class="comment">#显示cookie</span></span><br><span class="line">cat showcookies.php</span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;&lt;h1&gt;test showcookie &lt;/h1&gt;&quot;</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$_COOKIE</span>[<span class="string">&quot;user&quot;</span>];    <span class="comment">#显示user的这一个cookie</span></span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;&lt;br /&gt;&quot;</span>;</span><br><span class="line"><span class="title function_ invoke__">var_dump</span>(<span class="variable">$_COOKIE</span>);      <span class="comment">#显示所有cookie </span></span><br><span class="line"><span class="comment">//print_r($_COOKIE);     #不如上面方式详细</span></span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line"><span class="comment">#删除cookie，通过设置过期时间实现</span></span><br><span class="line"><span class="comment">#vim delcookie.php</span></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">setcookie</span>(<span class="string">&#x27;user&#x27;</span>,<span class="string">&#x27;wang&#x27;</span>,<span class="title function_ invoke__">time</span>()-<span class="number">3600</span>*<span class="number">12</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;&lt;h1&gt;cookie:user is deleted &lt;/h1&gt;&quot;</span>;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<h4 id="Session"><a href="#Session" class="headerlink" title="Session"></a>Session</h4><p><img src="../../../../images/SRE/day28/39.jpg" alt="39"></p>
<p><strong>session</strong></p>
<p>session是相对于cookie的另外一个状态保持的解决方案，它是通过服务器来保持状态的。session指的是服务器上为每个客户端所开辟的独立存储空间，在其中保存的信息就是用于保存状态的。</p>
<p>Session是服务器端程序运行的过程中创建的，不同语言实现的应用程序有不同创建session的方法。在创建了session的同时，服务器会为该session生成唯一的sessionId，而这个sessionId被创建了之后，就可以调用session相关的方法往session中增加内容了，而这些内容只会保存在服务器中，每个sessionid就像数据库中主键，可以根据SessionId 关联每个session的相关信息，比如：购物车里的商器，登录用户等。但发送给客户端浏览器的只有sessionId。当客户端浏览器再次发送http请求时，会自动地将这个sessionId 附加在请求报文中 ，服务器收到请求之后就会根据sessionId找到对应的session，从而再次使用，使得用户的状态得以保持。</p>
<p>每个session都有一个sessionId，这个ID存放有两种方式：</p>
<p>1、通过URL存取，比如：Java程序中，URL会带上一个jsessionId=xxxxxx等，这样每次重新请求的时候都传了sessionId给服务器,但此方式不安全,所以很少使用,所以一般session是依赖于cookie的.即如果浏览器禁用了cookie,则session无法实现</p>
<p>2、通过cookie存取（Tomcat默认如此），这种cookie是session cookie，区别于persistent cookies也就是我们常说的cookie，session cookie要注意的是存储在浏览器内存中，而不是写到硬盘上。程序一开始执行，服务器就生成一个sessionId并通过cookie携带客户端浏览器的缓存中，当下一次访问的时候，服务器先检测一下是否有这个cookie，如果有就取它的ID，如果没有就再生成一个。这就是为什么关闭浏览器之后，再进去session已经没有了，其实在服务器端session并没有清空，而是sessionId变了。</p>
<p>当将浏览器关闭，服务器保存的session数据不是立即释放的，此时数据还会存在一段时间（可以在程序中加以设置，Tomcat默认15分钟），只要我们知道那个sessionId，就可以继续通过请求获得此session的信息。session里面的数据都放在服务器端，通过sessionId保证不会访问错误，服务端自动对session进行管理，如果在规定的时间内没有访问，则释放掉这个session。</p>
<p>最后提两点：</p>
<p>1、sessionId通常在浏览器地址中是看不到的，但是当我们把浏览器的cookie禁止之后，Web服务器会采用URL重写的方式传递sessionId，这样就可以在地址栏看到sessionId了</p>
<p>2、session cookie不可以跨窗口使用，但可以跨同一个窗口的多个标签页。</p>
<p><strong>session 的工作流程</strong></p>
<p>第一次请求: </p>
<ul>
<li>浏览器发起第一次请求的时候可以携带一些信息(比如: 用户名/密码) cookie中没有任何信息</li>
<li>当服务器接收到这个请求之后,进行用户名和密码的验证,验证成功后则可以设置session信息</li>
<li>在设置session信息的同时(session信息保存在服务器端) .服务器会在响应头中设置一个随机的session id的cookie信息</li>
<li>客户端(浏览器)在接收到响应之后,会将cookie信息保存起来(保存session id的信息) </li>
</ul>
<p>第二次及其之后的请求:</p>
<ul>
<li>第二次及其之后的请求都会携带session id信息</li>
<li>当服务器接收到这个请求之后,会获取到session id信息,然后进行验证</li>
<li>验证成功,则可以获取session信息(session信息保存在服务器端)</li>
</ul>
<p><strong>范例：PHP的PHPSESSID</strong></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">session_start</span>(); </span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">session_id</span>();</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"><span class="comment">#执行结果如下图</span></span><br></pre></td></tr></table></figure>

<p><img src="../../../../images/SRE/day28/40.jpg" alt="40"></p>
<p>范例：JAVA的JSESSIONID</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ~]<span class="comment">#cat /usr/local/tomcat/webapps/ROOT/session.jsp </span></span><br><span class="line">&lt;h1&gt;</span><br><span class="line">sessionId: &lt;%=request.getSession().getId()%&gt;</span><br><span class="line">&lt;/h1&gt;</span><br></pre></td></tr></table></figure>

<p><img src="../../../../images/SRE/day28/41.jpg" alt="41"></p>
<p><img src="../../../../images/SRE/day28/42.jpg" alt="42"></p>
<p><img src="../../../../images/SRE/day28/43.jpg" alt="43"></p>
<h4 id="cookie和session比较"><a href="#cookie和session比较" class="headerlink" title="cookie和session比较"></a>cookie和session比较</h4><p>cookie和session的相同和不同：</p>
<ul>
<li>cookie通常是在服务器生成,但也可以在客户端生成,session是在服务器端生成的</li>
<li>session 将数据信息保存在服务器端，可以是内存，文件，数据库等多种形式,cookie 将数据保存在客户端的内存或文件中</li>
<li>单个cookie保存的数据不能超过4K，每个站点cookie个数有限制，比如IE8为50个、Firefox为50个、Opera为30个；session存储在服务器，没有容量限制</li>
<li>cookie存放在用户本地，可以被轻松访问和修改，安全性不高；session存储于服务器，比较安全</li>
<li>cookie有<strong>会话cookie和持久cookie</strong>，生命周期为浏览器会话期的会话cookie保存在缓存，关闭浏览器窗口就消失，持久cookie被保存在硬盘，知道超过设定的过期时间；随着服务端session存储压力增大，会根据需要定期清理session数据</li>
<li>session中有众多数据，只将sessionID这一项可以通过cookie发送至客户端进行保留，客户端下次访问时，在请求报文中的cookie会自动携带sessionID，从而和服务器上的的session进行关联 </li>
</ul>
<p>cookie缺点：</p>
<p>1、使用cookie来传递信息，随着cookie个数的增多和访问量的增加，它占用的网络带宽也很大，试想假如cookie占用200字节，如果一天的PV有几个亿，那么它要占用多少带宽？</p>
<p>2、cookie并不安全，因为cookie是存放在客户端的，所以这些cookie可以被访问到，设置可以通过插件添加、修改cookie。所以从这个角度来说，我们要使用sesssion，session是将数据保存在服务端的，只是通过cookie传递一个sessionId而已，所以session更适合存储用户隐私和重要的数据</p>
<p>session 缺点：</p>
<p>1、不容易在多台服务器之间共享，可以使用session绑定，session复制，session共享解决</p>
<p>2、session存放在服务器中，所以session如果太多会非常消耗服务器的性能</p>
<p>cookie和session各有优缺点，在大型互联网系统中，单独使用cookie和session都是不可行的</p>
<h2 id="Web-相关工具"><a href="#Web-相关工具" class="headerlink" title="Web 相关工具"></a>Web 相关工具</h2><h3 id="links"><a href="#links" class="headerlink" title="links"></a>links</h3><p>格式：</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">links [OPTION]... [URL]...</span><br></pre></td></tr></table></figure>

<p>常用选项：</p>
<ul>
<li>-dump 非交互式模式，显示输出结果</li>
<li>-source 打印源码</li>
</ul>
<h3 id="wget"><a href="#wget" class="headerlink" title="wget"></a>wget</h3><p>格式：</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wget [OPTION]... [URL]...</span><br></pre></td></tr></table></figure>

<p>常用选项：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#启动</span></span><br><span class="line">-V, -version 显示wget的版本后退出</span><br><span class="line">-h, -<span class="built_in">help</span> 打印语法帮助</span><br><span class="line">-b, -background 启动后转入后台执行</span><br><span class="line">-e, -execute=COMMAND 执行`.wgetrc<span class="string">&#x27;格式的命令，wgetrc格式参见/etc/wgetrc或~/.wgetrc</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">#记录和输入文件</span></span><br><span class="line"><span class="string">-o, -output-file=FILE 把记录写到FILE文件中</span></span><br><span class="line"><span class="string">-a, -append-output=FILE 把记录追加到FILE文件中</span></span><br><span class="line"><span class="string">-d, -debug 打印调试输出</span></span><br><span class="line"><span class="string">-q, -quiet 安静模式(没有输出)</span></span><br><span class="line"><span class="string">-v, -verbose 冗长模式(这是缺省设置)</span></span><br><span class="line"><span class="string">-nv, -non-verbose 关掉冗长模式，但不是安静模式</span></span><br><span class="line"><span class="string">-i, -input-file=FILE 下载在FILE文件中出现的URLs</span></span><br><span class="line"><span class="string">-F, -force-html 把输入文件当作HTML格式文件对待</span></span><br><span class="line"><span class="string">-B, -base=URL 将URL作为在-F -i参数指定的文件中出现的相对链接的前缀</span></span><br><span class="line"><span class="string">-sslcertfile=FILE 可选客户端证书</span></span><br><span class="line"><span class="string">-sslcertkey=KEYFILE 可选客户端证书的KEYFILE</span></span><br><span class="line"><span class="string">-egd-file=FILE 指定EGD socket的文件名</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">#下载</span></span><br><span class="line"><span class="string">-bind-address=ADDRESS 指定本地使用地址(主机名或IP，当本地有多个IP或名字时使用)</span></span><br><span class="line"><span class="string">-t, -tries=NUMBER 设定最大尝试链接次数(0 表示无限制).</span></span><br><span class="line"><span class="string">-O -output-document=FILE 把文档写到FILE文件中</span></span><br><span class="line"><span class="string">-nc, -no-clobber 不要覆盖存在的文件或使用.#前缀</span></span><br><span class="line"><span class="string">-c, -continue 接着下载没下载完的文件</span></span><br><span class="line"><span class="string">-progress=TYPE 设定进程条标记</span></span><br><span class="line"><span class="string">-N, -timestamping 不要重新下载文件除非比本地文件新</span></span><br><span class="line"><span class="string">-S, -server-response 打印服务器的回应</span></span><br><span class="line"><span class="string">-spider 不下载任何东西</span></span><br><span class="line"><span class="string">-T, -timeout=SECONDS 设定响应超时的秒数</span></span><br><span class="line"><span class="string">-w, -wait=SECONDS 两次尝试之间间隔SECONDS秒</span></span><br><span class="line"><span class="string">-waitretry=SECONDS 在重新链接之间等待1…SECONDS秒</span></span><br><span class="line"><span class="string">-random-wait 在下载之间等待0…2*WAIT秒</span></span><br><span class="line"><span class="string">-Y, -proxy=on/off 打开或关闭代理</span></span><br><span class="line"><span class="string">-Q, -quota=NUMBER 设置下载的容量限制</span></span><br><span class="line"><span class="string">-limit-rate=RATE 限定下载输率</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">#目录</span></span><br><span class="line"><span class="string">-nd -no-directories 不创建目录</span></span><br><span class="line"><span class="string">-x, -force-directories 强制创建目录</span></span><br><span class="line"><span class="string">-nH, -no-host-directories 不创建主机目录</span></span><br><span class="line"><span class="string">-P, -directory-prefix=PREFIX 将文件保存到目录 PREFIX/…</span></span><br><span class="line"><span class="string">-cut-dirs=NUMBER 忽略 NUMBER层远程目录</span></span><br><span class="line"><span class="string">#HTTP 选项</span></span><br><span class="line"><span class="string">-http-user=USER 设定HTTP用户名为 USER.</span></span><br><span class="line"><span class="string">-http-passwd=PASS 设定http密码为 PASS.</span></span><br><span class="line"><span class="string">-C, -cache=on/off 允许/不允许服务器端的数据缓存 (一般情况下允许).</span></span><br><span class="line"><span class="string">-E, -html-extension 将所有text/html文档以.html扩展名保存</span></span><br><span class="line"><span class="string">-ignore-length 忽略 `Content-Length&#x27;</span>头域</span><br><span class="line">-header=STRING 在headers中插入字符串 STRING</span><br><span class="line">-proxy-user=USER 设定代理的用户名为 USER</span><br><span class="line">-proxy-passwd=PASS 设定代理的密码为 PASS</span><br><span class="line">-referer=URL 在HTTP请求中包含 `Referer: URL<span class="string">&#x27;头</span></span><br><span class="line"><span class="string">-s, -save-headers 保存HTTP头到文件</span></span><br><span class="line"><span class="string">-U, -user-agent=AGENT 设定代理的名称为 AGENT而不是 Wget/VERSION.</span></span><br><span class="line"><span class="string">-no-http-keep-alive 关闭 HTTP活动链接 (永远链接).</span></span><br><span class="line"><span class="string">-cookies=off 不使用 cookies.</span></span><br><span class="line"><span class="string">-load-cookies=FILE 在开始会话前从文件 FILE中加载cookie</span></span><br><span class="line"><span class="string">-save-cookies=FILE 在会话结束后将 cookies保存到 FILE文件中</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">#FTP 选项</span></span><br><span class="line"><span class="string">-nr, -dont-remove-listing 不移走 `.listing&#x27;</span>文件</span><br><span class="line">-g, -glob=on/off 打开或关闭文件名的 globbing机制</span><br><span class="line">-passive-ftp 使用被动传输模式 (缺省值).</span><br><span class="line">-active-ftp 使用主动传输模式</span><br><span class="line">-retr-symlinks 在递归的时候，将链接指向文件(而不是目录)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#递归下载</span></span><br><span class="line">-r, -recursive 递归下载－－慎用!</span><br><span class="line">-l, -level=NUMBER 最大递归深度 (inf 或 0 代表无穷).</span><br><span class="line">-delete-after 在现在完毕后局部删除文件</span><br><span class="line">-k, -convert-links 转换非相对链接为相对链接</span><br><span class="line">-K, -backup-converted 在转换文件X之前，将之备份为 X.orig</span><br><span class="line">-m, -mirror 等价于 -r -N -l inf -nr.</span><br><span class="line">-p, -page-requisites 下载显示HTML文件的所有图片</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#递归下载中的包含和不包含(accept/reject)</span></span><br><span class="line">-A, -accept=LIST 分号分隔的被接受扩展名的列表</span><br><span class="line">-R, -reject=LIST 分号分隔的不被接受的扩展名的列表</span><br><span class="line">-D, -domains=LIST 分号分隔的被接受域的列表</span><br><span class="line">-exclude-domains=LIST 分号分隔的不被接受的域的列表</span><br><span class="line">-follow-ftp 跟踪HTML文档中的FTP链接</span><br><span class="line">-follow-tags=LIST 分号分隔的被跟踪的HTML标签的列表</span><br><span class="line">-G, -ignore-tags=LIST 分号分隔的被忽略的HTML标签的列表</span><br><span class="line">-H, -span-hosts 当递归时转到外部主机</span><br><span class="line">-L, -relative 仅仅跟踪相对链接</span><br><span class="line">-I, -include-directories=LIST 允许目录的列表</span><br><span class="line">-X, -exclude-directories=LIST 不被包含目录的列表</span><br><span class="line">-np, -no-parent 不要追溯到父目录</span><br></pre></td></tr></table></figure>

<p>常用选项: </p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">-q                    静默模式</span><br><span class="line">-c                    断点续传</span><br><span class="line">-P /path              保存在指定目录</span><br><span class="line">-O filename           保存为指定文件名，filename 为 - 时，发送至标准输出</span><br><span class="line">--limit-rate=         指定传输速率，单位K，M等</span><br></pre></td></tr></table></figure>

<p>范例：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ~]<span class="comment"># wget --limit-rate 1M -P /data https://mirrors.aliyun.com/centos/8/isos/x86_64/CentOS-8-x86_64-1905-dvd1.iso</span></span><br><span class="line"></span><br><span class="line">[root@centos8 ~]<span class="comment"># ls /data</span></span><br><span class="line">CentOS-8-x86_64-1905-dvd1.iso</span><br></pre></td></tr></table></figure>

<p>范例：实现浏览器功能</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ~]<span class="comment"># wget -qO - http://10.0.0.6/</span></span><br><span class="line">&lt;h1&gt;welcome to magedu&lt;/1&gt;</span><br></pre></td></tr></table></figure>

<p>范例: 下载指定目录</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ~]<span class="comment"># wget -r -np -nH -R index.html http://www.example.com/dir/</span></span><br><span class="line"></span><br><span class="line">[root@centos8 ~]<span class="comment"># wget -c -r -np -k -L -p http://www.example.com/dir/</span></span><br><span class="line"></span><br><span class="line">-r : 遍历所有子目录</span><br><span class="line">-np : 不到上一层子目录去</span><br><span class="line">-nH : 不要将文件保存到主机名文件夹</span><br><span class="line">-R index.html : 不下载 index.html 文件</span><br></pre></td></tr></table></figure>

<h3 id="curl"><a href="#curl" class="headerlink" title="curl"></a>curl</h3><p>curl是基于URL语法在命令行方式下工作的文件传输工具，它支持FTP, FTPS, HTTP, HTTPS, GOPHER, TELNET, DICT, FILE及LDAP等协议。curl支持HTTPS认证，并且支持HTTP的POST、PUT等方法， FTP上传， kerberos认证，HTTP上传，代理服务器，cookies，用户名/密码认证， 下载文件断点续传，上载文件断点续传, http代理服务器管道（ proxy tunneling），还支持IPv6，socks5代理服务器，通过http代理服务器上传文件到FTP服务器等，功能十分强大</p>
<p>格式：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl [options] [URL...]</span><br></pre></td></tr></table></figure>

<p>常见选项：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">-A/--user-agent &lt;string&gt; 设置用户代理发送给服务器</span><br><span class="line">-e/--referer &lt;URL&gt; 来源网址</span><br><span class="line">--cacert &lt;file&gt; CA证书 (SSL)</span><br><span class="line">-k/--insecure   允许忽略证书进行 SSL 连接</span><br><span class="line">--compressed 要求返回是压缩的格式</span><br><span class="line">-H/--header <span class="string">&quot;key:value” 自定义首部字段传递给服务器</span></span><br><span class="line"><span class="string">-i 显示页面内容，包括报文首部信息</span></span><br><span class="line"><span class="string">-I/--head 只显示响应报文首部信息</span></span><br><span class="line"><span class="string">-D/--dump-header &lt;file&gt;将url的header信息存放在指定文件中</span></span><br><span class="line"><span class="string">--basic 使用HTTP基本认证</span></span><br><span class="line"><span class="string">-u/--user &lt;user[:password]&gt;设置服务器的用户和密码</span></span><br><span class="line"><span class="string">-L   如果有3xx响应码，重新发请求到新位置</span></span><br><span class="line"><span class="string">-O 使用URL中默认的文件名保存文件到本地</span></span><br><span class="line"><span class="string">-o &lt;file&gt; 将网络文件保存为指定的文件中</span></span><br><span class="line"><span class="string">--limit-rate &lt;rate&gt; 设置传输速度</span></span><br><span class="line"><span class="string">-0/--http1.0 数字0，使用HTTP 1.0</span></span><br><span class="line"><span class="string">-v/--verbose 更详细</span></span><br><span class="line"><span class="string">-C 选项可对文件使用断点续传功能</span></span><br><span class="line"><span class="string">-c/--cookie-jar &lt;file name&gt; 将url中cookie存放在指定文件中</span></span><br><span class="line"><span class="string">-x/--proxy &lt;proxyhost[:port]&gt; 指定代理服务器地址</span></span><br><span class="line"><span class="string">-X/--request &lt;command&gt; 向服务器发送指定请求方法</span></span><br><span class="line"><span class="string">-U/--proxy-user &lt;user:password&gt; 代理服务器用户和密码</span></span><br><span class="line"><span class="string">-T 选项可将指定的本地文件上传到FTP服务器上</span></span><br><span class="line"><span class="string">--data/-d 方式指定使用POST方式传递数据</span></span><br><span class="line"><span class="string">-s --silent   Silent mode</span></span><br><span class="line"><span class="string">-b name=data 从服务器响应set-cookie得到值，返回给服务器</span></span><br><span class="line"><span class="string">-w &lt;format&gt; 显示相应的指定的报文信息，如：%&#123;http_code&#125;，%&#123;remote_ip&#125;等</span></span><br><span class="line"><span class="string">-m, --max-time &lt;time&gt; 允许最大传输时间</span></span><br></pre></td></tr></table></figure>

<p>范例：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ~]<span class="comment"># curl -I http://www.163.com</span></span><br><span class="line">HTTP/1.1 403 Forbidden</span><br><span class="line">Date: Thu, 12 Dec 2019 01:18:11 GMT</span><br><span class="line">Content-Type: text/html</span><br><span class="line">Content-Length: 234</span><br><span class="line">Connection: keep-alive</span><br><span class="line">Server: web cache</span><br><span class="line">Expires: Thu, 12 Dec 2019 01:18:11 GMT</span><br><span class="line">X-Ser: BC14_lt-tianjin-tianjin-3-cache-3</span><br><span class="line">Cache-Control: no-cache,no-store,private</span><br><span class="line">cdn-user-ip: 123.118.223.243</span><br><span class="line">cdn-ip: 125.39.21.14</span><br><span class="line">X-Cache-Remote: HIT</span><br><span class="line">cdn-source: baishan</span><br><span class="line"></span><br><span class="line">[root@centos8 ~]<span class="comment"># curl -I -A ie10 http://www.163.com</span></span><br><span class="line">HTTP/1.1 200 OK</span><br><span class="line">Date: Thu, 12 Dec 2019 01:19:30 GMT</span><br><span class="line">Content-Type: text/html; charset=GBK</span><br><span class="line">Connection: keep-alive</span><br><span class="line">Expires: Thu, 12 Dec 2019 01:20:45 GMT</span><br><span class="line">Server: nginx</span><br><span class="line">Cache-Control: no-cache,no-store,private</span><br><span class="line">Age: 5</span><br><span class="line">Vary: Accept-Encoding</span><br><span class="line">X-Ser: BC20_dx-lt-yd-fujian-xiamen-8-cache-2, BC57_dx-lt-yd-fujian-xiamen-8-</span><br><span class="line">cache-2, BC5_lt-tianjin-tianjin-3-cache-3, BC13_lt-tianjin-tianjin-3-cache-3</span><br><span class="line">cdn-user-ip: 123.118.223.243</span><br><span class="line">cdn-ip: 125.39.21.13</span><br><span class="line">X-Cache-Remote: HIT</span><br><span class="line">cdn-source: baishan</span><br><span class="line"></span><br><span class="line">[root@centos6 ~]<span class="comment"># curl -H &quot;user-agent: firefox&quot; 192.168.100.8</span></span><br></pre></td></tr></table></figure>

<p>范例: 判断网站正常</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ~]<span class="comment"># if [ &quot;$(curl -sL -w &#x27;%&#123;http_code&#125;&#x27; http://www.wangxiaochun.com -o /dev/null)&quot; = &quot;200&quot; ]; then</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;Success&quot;</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;Fail&quot;</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@centos8 ~]<span class="comment"># if curl -sL --fail http://www.wangxiaochun.com -o /dev/null; then</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;Success&quot;</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;Fail&quot;</span></span><br><span class="line"><span class="keyword">fi</span></span><br></pre></td></tr></table></figure>

<p>范例：利用curl 获取响应码和远程主机IP</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[root@ubuntu ~]<span class="comment"># curl -s -I -m10 -o /dev/null   -w %&#123;http_code&#125; http://www.baidu.com/</span></span><br><span class="line">200</span><br><span class="line"></span><br><span class="line">[root@ubuntu ~]<span class="comment"># curl -s -I -m10 -o /dev/null   -w %&#123;remote_ip&#125; http://wangxiaochun.com/</span></span><br><span class="line">58.87.87.99</span><br><span class="line"></span><br><span class="line">[root@centos8 ~]<span class="comment"># curl -s -I -m10 -o /dev/null -w %&#123;local_ip&#125; http://wangxiaochun.com/</span></span><br><span class="line">10.0.0.8</span><br><span class="line"></span><br><span class="line">[root@centos8 ~]<span class="comment"># curl -s -I -m10 -o /dev/null -w %&#123;local_port&#125; http://wangxiaochun.com/</span></span><br><span class="line">45304</span><br><span class="line"></span><br><span class="line">[root@centos8 ~]<span class="comment"># curl -s -I -m10 -o /dev/null -w %&#123;remote_port&#125; http://wangxiaochun.com/</span></span><br><span class="line">80</span><br></pre></td></tr></table></figure>

<h3 id="httpie"><a href="#httpie" class="headerlink" title="httpie"></a>httpie</h3><p><img src="../../../../images/SRE/day28/44.jpg" alt="44"></p>
<p>HTTPie 工具是功能丰富的 HTTP 命令行客户端，它能通过命令行界面与 Web 服务进行交互。它提供一个简单的 http 命令，允许使用简单而自然的语法发送任意的 HTTP 请求，并会显示彩色的输出HTTPie 能用于测试、调试及与 HTTP 服务器交互。</p>
<p>主要特点：</p>
<ul>
<li><p>具表达力的和直观语法</p>
</li>
<li><p>格式化的及彩色化的终端输出</p>
</li>
<li><p>内置 JSON 支持</p>
</li>
<li><p>表单和文件上传 HTTPS、代理和认证</p>
<p>任意请求数据</p>
</li>
<li><p>自定义头部</p>
</li>
<li><p>持久化会话</p>
</li>
<li><p>类似 wget 的下载</p>
</li>
<li><p>支持 Python 2.7 和 3.x</p>
</li>
</ul>
<p>官方网站：<a target="_blank" rel="noopener" href="https://httpie.org/">https://httpie.org</a></p>
<p>安装：基于EPEL</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ~]<span class="comment"># yum install httpie -y</span></span><br></pre></td></tr></table></figure>

<p>范例：查看帮助</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ~]<span class="comment"># http --help</span></span><br><span class="line">usage: http [--json] [--form] [--pretty &#123;all,colors,format,none&#125;]</span><br><span class="line">           [--style STYLE] [--<span class="built_in">print</span> WHAT] [--headers] [--body] [--verbose]</span><br><span class="line">           [--all] [--history-print WHAT] [--stream] [--output FILE]</span><br><span class="line">           [--download] [--<span class="built_in">continue</span>]</span><br><span class="line">           [--session SESSION_NAME_OR_PATH | --session-read-only</span><br><span class="line">SESSION_NAME_OR_PATH]</span><br><span class="line">           [--auth USER[:PASS]] [--auth-type &#123;basic,digest&#125;]</span><br><span class="line">           [--proxy PROTOCOL:PROXY_URL] [--follow]</span><br><span class="line">           [--max-redirects MAX_REDIRECTS] [--<span class="built_in">timeout</span> SECONDS]</span><br><span class="line">           [--check-status] [--verify VERIFY]</span><br><span class="line">           [--ssl &#123;ssl2.3,ssl3,tls1,tls1.1,tls1.2&#125;] [--cert CERT]</span><br><span class="line">           [--cert-key CERT_KEY] [--ignore-stdin] [--<span class="built_in">help</span>] [--version]</span><br><span class="line">           [--traceback] [--debug]</span><br><span class="line">           [METHOD] URL [REQUEST_ITEM [REQUEST_ITEM ...]]</span><br></pre></td></tr></table></figure>

<p>范例：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 显示信息（包含响应头200）</span></span><br><span class="line">http www.magedu.com</span><br><span class="line"></span><br><span class="line"><span class="comment"># 显示详细的请求（包含请求和返回头200）</span></span><br><span class="line">http -v www.magedu.com</span><br><span class="line"></span><br><span class="line"><span class="comment"># 只显示Header</span></span><br><span class="line">http -h www.magedu.com</span><br><span class="line">http --<span class="built_in">head</span> www.magedu.com</span><br><span class="line">http --header www.magedu.com</span><br><span class="line">http --headers www.magedu.com</span><br><span class="line"></span><br><span class="line"><span class="comment"># 只显示Body</span></span><br><span class="line">http -b www.magedu.com</span><br><span class="line">http --body magedu.com</span><br><span class="line"></span><br><span class="line"><span class="comment"># 下载文件</span></span><br><span class="line">http -d www.magedu.com</span><br><span class="line"></span><br><span class="line"><span class="comment"># 模拟提交表单</span></span><br><span class="line">http -f POST www.magedu.com username=<span class="string">&#x27;wang&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 请求删除的方法</span></span><br><span class="line">http DELETE www.magedu.com</span><br><span class="line"></span><br><span class="line"><span class="comment"># 传递JSON数据请求(默认就是JSON数据请求)</span></span><br><span class="line">http PUT www.magedu.com username=<span class="string">&#x27;wang&#x27;</span> password=<span class="string">&#x27;magedu&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 如果JSON数据存在不是字符串则用:=分隔，例如</span></span><br><span class="line">http PUT www.magedu.com username=<span class="string">&#x27;wang&#x27;</span> password=<span class="string">&#x27;magedu&#x27;</span> age:=30 a:=<span class="literal">true</span> streets:=<span class="string">&#x27;[&quot;a&quot;, &quot;b&quot;]&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 模拟Form的Post请求, Content-Type: application/x-www-form-urlencoded; charset=utf-8</span></span><br><span class="line">http --form POST www.magedu.com username=<span class="string">&#x27;wang&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 模拟Form的上传, Content-Type: multipart/form-data</span></span><br><span class="line">http -f POST www.magedu.com/jobs username=<span class="string">&#x27;wang&#x27;</span> file@~/test.pdf</span><br><span class="line"></span><br><span class="line"><span class="comment"># 修改请求头, 使用:分隔</span></span><br><span class="line">http www.magedu.com User-Agent:magedu-agent/1.0  <span class="string">&#x27;Cookie:a=b;b=c&#x27;</span> Referer:http://www.google.com/</span><br><span class="line"></span><br><span class="line"><span class="comment"># 认证</span></span><br><span class="line">http -a username:password www.magedu.com</span><br><span class="line">http -A basic -a username:password www.magedu.com</span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用http代理</span></span><br><span class="line">http --proxy=http:http://172.16.0.100:8081 proxy.magedu.com</span><br><span class="line">http --proxy=http:http://user:pass@172.16.0.100:8081 proxy.magedu.com</span><br><span class="line">http --proxy=https:http://172.16.0.100:8118 proxy.magedu.com</span><br><span class="line">http --proxy=https:http://user:pass@172.16.0.100:8118 proxy.magedu.com</span><br></pre></td></tr></table></figure>

<p>范例：查看信息及响应头</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ~]<span class="comment"># http 192.168.8.8/test.html</span></span><br><span class="line">HTTP/1.1 200 OK</span><br><span class="line">Accept-Ranges: bytes</span><br><span class="line">Connection: Keep-Alive</span><br><span class="line">Content-Length: 30</span><br><span class="line">Content-Type: text/html; charset=UTF-8</span><br><span class="line">Date: Thu, 07 Nov 2019 09:09:34 GMT</span><br><span class="line">ETag: <span class="string">&quot;1e-596be05bc9a34&quot;</span></span><br><span class="line">Keep-Alive: <span class="built_in">timeout</span>=5, max=100</span><br><span class="line">Last-Modified: Thu, 07 Nov 2019 09:09:27 GMT</span><br><span class="line">Server: Apache/2.4.37 (centos)</span><br><span class="line"></span><br><span class="line">&lt;strong&gt;马哥教育&lt;/strong&gt;</span><br></pre></td></tr></table></figure>

<p>范例：查看请示和响应头部及信息</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ~]<span class="comment"># http -v 192.168.8.8/test.html</span></span><br><span class="line">GET /test.html HTTP/1.1</span><br><span class="line">Accept: */*</span><br><span class="line">Accept-Encoding: gzip, deflate</span><br><span class="line">Connection: keep-alive</span><br><span class="line">Host: 192.168.8.8</span><br><span class="line">User-Agent: HTTPie/0.9.4</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">HTTP/1.1 200 OK</span><br><span class="line">Accept-Ranges: bytes</span><br><span class="line">Connection: Keep-Alive</span><br><span class="line">Content-Length: 30</span><br><span class="line">Content-Type: text/html; charset=UTF-8</span><br><span class="line">Date: Thu, 07 Nov 2019 09:09:39 GMT</span><br><span class="line">ETag: <span class="string">&quot;1e-596be05bc9a34&quot;</span></span><br><span class="line">Keep-Alive: <span class="built_in">timeout</span>=5, max=100</span><br><span class="line">Last-Modified: Thu, 07 Nov 2019 09:09:27 GMT</span><br><span class="line">Server: Apache/2.4.37 (centos)</span><br><span class="line"></span><br><span class="line">&lt;strong&gt;马哥教育&lt;/strong&gt;</span><br></pre></td></tr></table></figure>

<p>范例：查看响应报文头部</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ~]<span class="comment"># http HEAD http://www.magedu.com</span></span><br><span class="line">HTTP/1.1 200 OK</span><br><span class="line">Connection: keep-alive</span><br><span class="line">Content-Encoding: gzip</span><br><span class="line">Content-Type: text/html; charset=UTF-8</span><br><span class="line">Date: Thu, 07 Nov 2019 08:09:49 GMT</span><br><span class="line">Link: &lt;http://www.magedu.com/wp-json/&gt;; rel=<span class="string">&quot;https://api.w.org/&quot;</span></span><br><span class="line">Link: &lt;http://www.magedu.com/&gt;; rel=shortlink</span><br><span class="line">Server: Tengine</span><br><span class="line">Vary: Accept-Encoding</span><br><span class="line">Vary: Accept-Encoding, Cookie</span><br></pre></td></tr></table></figure>

<p>范例： 查看请求和响应报文头部</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ~]<span class="comment"># http -p Hh http://www.magedu.com</span></span><br><span class="line">GET / HTTP/1.1</span><br><span class="line">Accept: */*</span><br><span class="line">Accept-Encoding: gzip, deflate</span><br><span class="line">Connection: keep-alive</span><br><span class="line">Host: www.magedu.com</span><br><span class="line">User-Agent: HTTPie/0.9.4</span><br><span class="line"></span><br><span class="line">HTTP/1.1 200 OK</span><br><span class="line">Cache-Control: max-age=3, must-revalidate</span><br><span class="line">Connection: keep-alive</span><br><span class="line">Content-Encoding: gzip</span><br><span class="line">Content-Type: text/html; charset=UTF-8</span><br><span class="line">Date: Thu, 07 Nov 2019 03:44:14 GMT</span><br><span class="line">Server: Tengine</span><br><span class="line">Transfer-Encoding: chunked</span><br><span class="line">Vary: Accept-Encoding</span><br><span class="line">Vary: Accept-Encoding, Cookie</span><br></pre></td></tr></table></figure>

<p>范例：指定请求头部的首部字段</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ~]<span class="comment"># http -p H http://www.magedu.com User-Agent:wangtest </span></span><br><span class="line">Referer:http://www.baidu.com</span><br><span class="line">GET / HTTP/1.1</span><br><span class="line">Accept: */*</span><br><span class="line">Accept-Encoding: gzip, deflate</span><br><span class="line">Connection: keep-alive</span><br><span class="line">Host: www.magedu.com</span><br><span class="line">Referer: http://www.baidu.com</span><br><span class="line">User-Agent: wangtest</span><br></pre></td></tr></table></figure>

<p>范例：下载资源</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#方法1</span></span><br><span class="line">[root@centos8 ~]<span class="comment">#http http://www.magedu.com/wp-content/uploads/2018/12/2018122312035677.png &gt; logo.png</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#方法2</span></span><br><span class="line">[root@centos8 ~]<span class="comment">#file logo.png</span></span><br><span class="line">logo.png: PNG image data, 411 x 127, 8-bit/color RGBA, non-interlaced</span><br><span class="line">[root@centos7 ~]<span class="comment">#http --download   http://www.magedu.com/wp-content/uploads/2018/12/2018122312035677.png </span></span><br><span class="line">HTTP/1.1 200 OK</span><br><span class="line">Accept-Ranges: bytes</span><br><span class="line">Cache-Control: max-age=604800</span><br><span class="line">Connection: keep-alive</span><br><span class="line">Content-Length: 8983</span><br><span class="line">Content-Type: image/png</span><br><span class="line">Date: Thu, 07 Nov 2019 08:20:44 GMT</span><br><span class="line">ETag: <span class="string">&quot;5c1f79ac-2317&quot;</span></span><br><span class="line">Expires: Thu, 14 Nov 2019 08:20:44 GMT</span><br><span class="line">Last-Modified: Sun, 23 Dec 2018 12:03:56 GMT</span><br><span class="line">Server: Tengine</span><br><span class="line">Vary: Accept-Encoding</span><br><span class="line"></span><br><span class="line">Downloading 8.77 kB to <span class="string">&quot;2018122312035677.png&quot;</span></span><br><span class="line">Done. 8.77 kB <span class="keyword">in</span> 0.00091s (9.46 MB/s)</span><br></pre></td></tr></table></figure>

<p>范例：用POST方法提交json格式的数据</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ~]<span class="comment"># http http://www.magedu.com user=wang password=magedu</span></span><br></pre></td></tr></table></figure>

<p><img src="../../../../images/SRE/day28/45.jpg" alt="45"></p>
<p>范例：用POST方法，指交表单数据</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ~]<span class="comment"># http -f POST http://www.magedu.com user=wang password=magedu</span></span><br></pre></td></tr></table></figure>

<p><img src="../../../../images/SRE/day28/46.jpg" alt="46"></p>
<h3 id="压力测试工具"><a href="#压力测试工具" class="headerlink" title="压力测试工具"></a>压力测试工具</h3><p>httpd的压力测试工具：</p>
<ul>
<li>ab, webbench, http_load, seige</li>
<li>Jmeter 开源</li>
<li>Loadrunner 商业，有相关认证</li>
<li>tcpcopy：网易，复制生产环境中的真实请求，并将之保存</li>
</ul>
<p>ab 来自httpd-tools包</p>
<p>命令格式</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ab [OPTIONS] URL </span><br></pre></td></tr></table></figure>

<p>常见选项：</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">-n：总请求数</span><br><span class="line">-c：模拟的并发数</span><br><span class="line">-k：以持久连接模式测试</span><br></pre></td></tr></table></figure>

<p>说明：并发数高于1024时，需要用 ulimit -n # 调整能打开的文件数</p>
<h2 id="Web-服务介绍"><a href="#Web-服务介绍" class="headerlink" title="Web 服务介绍"></a>Web 服务介绍</h2><p>Netcraft公司于1994年底在英国成立，多年来一直致力于互联网市场以及在线安全方面的咨询服务，其中在国际上最具影响力的当属其针对网站服务器，域名解析/主机提供商，以及SSL市场所做的客观严谨的分析研究。</p>
<p><a target="_blank" rel="noopener" href="https://news.netcraft.com/">https://news.netcraft.com/</a></p>
<p><img src="../../../../images/SRE/day28/47.jpg" alt="47"></p>
<h3 id="Apache-经典的-Web-服务端"><a href="#Apache-经典的-Web-服务端" class="headerlink" title="Apache 经典的 Web 服务端"></a>Apache 经典的 Web 服务端</h3><p>Apache起初由美国的伊利诺伊大学香槟分校的国家超级计算机应用中心开发，目前经历了两大版本分别是1.X和2.X，其可以通过编译安装实现特定的功能</p>
<p>官方网站：<a target="_blank" rel="noopener" href="http://www.apache.org/">http://www.apache.org</a></p>
<p>MPM multi-processing module 有三种工作模式</p>
<h4 id="Apache-prefork-模型"><a href="#Apache-prefork-模型" class="headerlink" title="Apache prefork 模型"></a>Apache prefork 模型</h4><p>预派生模式，有一个主控制进程，然后生成多个子进程，每个子进程有一个独立的线程响应用户请求，相对比较占用内存，但是比较稳定，可以设置最大和最小进程数，是最古老的一种模式，也是最稳定的模式，适用于访问量不是很大的场景。</p>
<p>优点：稳定</p>
<p>缺点：每个用户请求需要对应开启一个进程,占用资源较多，并发性差,不适用于高并发场景</p>
<p><img src="../../../../images/SRE/day28/48.jpg" alt="48"></p>
<h4 id="Apache-worker-模型"><a href="#Apache-worker-模型" class="headerlink" title="Apache worker 模型"></a>Apache worker 模型</h4><p>一种多进程和多线程混合的模型，有一个控制进程，启动多个子进程，每个子进程里面包含固定的线程，使用线程程来处理请求，当线程不够使用的时候会再启动一个新的子进程，然后在进程里面再启动线程处理请求，由于其使用了线程处理请求，因此可以承受更高的并发。</p>
<p>优点：相比prefork 占用的内存较少，可以同时处理更多的请求</p>
<p>缺点：使用keepalive的长连接方式，某个线程会一直被占据，即使没有传输数据，也需要一直等待到超时才会被释放。如果过多的线程，被这样占据，也会导致在高并发场景下的无服务线程可用。（该问题在prefork模式下，同样会发生）</p>
<p><img src="../../../../images/SRE/day28/49.jpg" alt="49"></p>
<h4 id="Apache-event-模型"><a href="#Apache-event-模型" class="headerlink" title="Apache event 模型"></a>Apache event 模型</h4><p>Apache中最新的模式，2012年发布的apache 2.4.X系列正式支持event 模型，属于事件驱动模型(epoll)，每个进程响应多个请求，在现在版本里的已经是稳定可用的模式。它和worker模式很像，最大的区别在于，它解决了keepalive场景下，长期被占用的线程的资源浪费问题（某些线程因为被keepalive，空挂在哪里等待，中间几乎没有请求过来，甚至等到超时）。event MPM中，会有一个专门的线程来管理这些keepalive类型的线程，当有真实请求过来的时候，将请求传递给服务线程，执行完毕后，又允许它释放。这样增强了高并发场景下的请求处理能力。</p>
<p>优点：单线程响应多请求，占据更少的内存，高并发下表现更优秀，会有一个专门的线程来管理keep-alive类型的线程，当有真实请求过来的时候，将请求传递给服务线程，执行完毕后，又允许它释放</p>
<p>缺点：没有线程安全控制</p>
<p><img src="../../../../images/SRE/day28/50.jpg" alt="50"></p>
<h3 id="Nginx-高性能的-Web-服务端"><a href="#Nginx-高性能的-Web-服务端" class="headerlink" title="Nginx-高性能的 Web 服务端"></a>Nginx-高性能的 Web 服务端</h3><p>Nginx是由俄罗斯国立莫斯科鲍曼科技大学在1994年毕业的学生为俄罗斯rambler.ru公司开发的，开发工作最早从2002年开始，第一次公开发布时间是2004年10月4日，版本号是0.1.0</p>
<p>2019年3月11日F5 与 NGINX达成协议,F5 将收购 NGINX 的所有已发行股票，总价值约为 6.7 亿美元。6.7亿美金约合44.97亿人民币,nginx核心模块代码长度198430（包括空格、注释），所以一行代码约为2.2万人民币</p>
<p>官网地址 <a target="_blank" rel="noopener" href="http://www.nginx.org/">www.nginx.org</a></p>
<p>Nginx历经十几年的迭代更新（<a target="_blank" rel="noopener" href="https://nginx.org/en/CHANGES%EF%BC%89%EF%BC%8C">https://nginx.org/en/CHANGES），</a> 目前功能已经非常完善且运行稳定，分为社区版本和商业版，另外Nginx的社区版本分为开发版（奇数）、最新稳定版（偶数）和过期版，nginx以功能丰富著称，它即可以作为http服务器，也可以作为反向代理服务器或者邮件服务器，能够快速的响应静态网页的请求，支持FastCGI/SSL/Virtual Host/URL Rwrite/Gzip/HTTP Basic Auth/http或者TCP的负载均衡(1.9版本以上且开启stream模块)等功能，并且支持第三方的功能扩展。</p>
<p>天猫 淘宝 京东 小米 163 新浪等一线互联网公司都在用Nginx或者进行二次开发</p>
<p>基于Nginx的工作场景：</p>
<p><img src="../../../../images/SRE/day28/51.jpg" alt="51"></p>
<h3 id="用户访问体验和性能"><a href="#用户访问体验和性能" class="headerlink" title="用户访问体验和性能"></a>用户访问体验和性能</h3><h4 id="用户访问体验统计"><a href="#用户访问体验统计" class="headerlink" title="用户访问体验统计"></a>用户访问体验统计</h4><p>互联网存在用户速度体验的1-3-10原则，即1秒最优，1-3秒较优，3~10秒比较慢，10秒以上用户无法接受。用户放弃一个产品的代价很低，只是换一个URL而已。</p>
<p><img src="../../../../images/SRE/day28/52.jpg" alt="52"></p>
<p>全球最大搜索引擎 Google：慢500ms = 20% 将放弃访问。</p>
<p>全球最大的电商零售网站亚马逊：慢100ms = 1% 将放弃交易</p>
<p>有很多研究都表明，性能对用户的行为有很大的影响：</p>
<p>79%的用户表示不太可能再次打开一个缓慢的网站</p>
<p>47%的用户期望网页能在2秒钟以内加载</p>
<p>40%的用户表示如果加载时间超过三秒钟，就会放弃这个网站</p>
<p>页面加载时间延迟一秒可能导致转换损失7%，页面浏览量减少11%</p>
<p>8秒定律：用户访问一个网站时，如果等待网页打开的时间超过8秒，会有超过30%的用户放弃等待</p>
<p>请珍惜每一毫秒的时间 !</p>
<h4 id="影响用户体验的因素"><a href="#影响用户体验的因素" class="headerlink" title="影响用户体验的因素"></a>影响用户体验的因素</h4><p>据说马云在刚开始创业在给客户演示时，打开一个网站花了不到四个小时。</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">https://www.toutiao.com/article/6440287421317218562/?wid=1669189116646</span><br><span class="line">https://www.shuimiao.net/NjHaO/</span><br></pre></td></tr></table></figure>

<p>影响用户体验的因素</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">#客户端</span><br><span class="line">客户端硬件配置</span><br><span class="line">客户端网络速率</span><br><span class="line">客户端与服务端距离</span><br><span class="line">#服务器</span><br><span class="line">服务端网络速率</span><br><span class="line">服务端硬件配置</span><br><span class="line">服务端架构设计</span><br><span class="line">服务端应用程序工作模式</span><br><span class="line">服务端并发数量</span><br><span class="line">服务端响应文件大小及数量 buffer cache</span><br><span class="line">服务端I/O压力</span><br></pre></td></tr></table></figure>

<h3 id="服务端-I-O-流程"><a href="#服务端-I-O-流程" class="headerlink" title="服务端 I/O 流程"></a>服务端 I/O 流程</h3><p>I/O在计算机中指Input/Output， IOPS (Input/Output Per Second)即每秒的输入输出量(或读写次数)，是衡量磁盘性能的主要指标之一。IOPS是指单位时间内系统能处理的I/O请求数量，一般以每秒处理的I/O请求数量为单位，I/O请求通常为读或写数据操作请求。</p>
<p>一次完整的I/O是用户空间的进程数据与内核空间的内核数据的报文的完整交换，但是由于内核空间与用户空间是严格隔离的，所以其数据交换过程中不能由用户空间的进程直接调用内核空间的内存数据，而是需要经历一次从内核空间中的内存数据copy到用户空间的进程内存当中，所以简单说I/O就是把数据从内核空间中的内存数据复制到用户空间中进程的内存当中。</p>
<p>Linux 的 I/O </p>
<ul>
<li>磁盘I/O</li>
<li>网络I/O : 一切皆文件,本质为对socket文件的读写</li>
</ul>
<h4 id="磁盘-I-O"><a href="#磁盘-I-O" class="headerlink" title="磁盘 I/O"></a>磁盘 I/O</h4><p>磁盘I/O是进程向内核发起系统调用，请求磁盘上的某个资源比如是html 文件或者图片，然后内核通过相应的驱动程序将目标文件加载到内核的内存空间，加载完成之后把数据从内核内存再复制给进程内存，如果是比较大的数据也需要等待时间</p>
<h4 id="网络-I-O"><a href="#网络-I-O" class="headerlink" title="网络 I/O"></a>网络 I/O</h4><p>网络通信就是网络协议栈到用户空间进程的IO就是网络IO</p>
<p><img src="../../../../images/SRE/day28/53.jpg" alt="53"></p>
<p>网络I/O 处理过程</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">获取请求数据，客户端与服务器建立连接发出请求，服务器接受请求（1-3）</span><br><span class="line">构建响应，当服务器接收完请求，并在用户空间处理客户端的请求，直到构建响应完成（4）</span><br><span class="line">返回数据，服务器将已构建好的响应再通过内核空间的网络 I/O 发还给客户端（5-7）</span><br></pre></td></tr></table></figure>

<p>不论磁盘和网络I/O</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">每次I/O，都要经由两个阶段：</span><br><span class="line">第一步：将数据从文件先加载至内核内存空间（缓冲区），等待数据准备完成，时间较长</span><br><span class="line">第二步：将数据从内核缓冲区复制到用户空间的进程的内存中，时间较短</span><br></pre></td></tr></table></figure>

<h2 id="I-O-模型"><a href="#I-O-模型" class="headerlink" title="I/O 模型"></a>I/O 模型</h2><h3 id="I-O-模型相关概念"><a href="#I-O-模型相关概念" class="headerlink" title="I/O 模型相关概念"></a>I/O 模型相关概念</h3><h4 id="同步和异步"><a href="#同步和异步" class="headerlink" title="同步和异步"></a>同步和异步</h4><p>关注的是消息通信机制，即调用者在等待一件事情的处理结果时，被调用者是否提供完成状态的通知。</p>
<ul>
<li>同步：synchronous，被调用者并不提供事件的处理结果相关的通知消息，需要调用者主动询问事情是否处理完成</li>
<li>异步：asynchronous，被调用者通过状态、通知或回调机制主动通知调用者被调用者的运行状态</li>
</ul>
<h4 id="阻塞和非阻塞"><a href="#阻塞和非阻塞" class="headerlink" title="阻塞和非阻塞"></a>阻塞和非阻塞</h4><p>关注调用者在等待结果返回之前所处的状态</p>
<ul>
<li>阻塞：blocking，指IO操作需要彻底完成后才返回到用户空间，调用结果返回之前，调用者被挂起，干不了别的事情。</li>
<li>非阻塞：nonblocking，指IO操作被调用后立即返回给用户一个状态值，而无需等到IO操作彻底完成，在最终的调用结果返回之前，调用者不会被挂起，可以去做别的事情。</li>
</ul>
<h3 id="网络-I-O-模型"><a href="#网络-I-O-模型" class="headerlink" title="网络 I/O 模型"></a>网络 I/O 模型</h3><p>阻塞型、非阻塞型、复用型、信号驱动型、异步</p>
<p>参看:《UNIX网络编程 卷1：套接字联网API 》(美)W. Richard Stevens 著</p>
<h4 id="阻塞型-I-O-模型（blocking-IO）"><a href="#阻塞型-I-O-模型（blocking-IO）" class="headerlink" title="阻塞型 I/O 模型（blocking IO）"></a>阻塞型 I/O 模型（blocking IO）</h4><p><img src="../../../../images/SRE/day28/54.jpg" alt="54"></p>
<p>阻塞IO模型是最简单的I/O模型，用户线程在内核进行IO操作时被阻塞</p>
<p>用户线程通过系统调用read发起I/O读操作，由用户空间转到内核空间。内核等到数据包到达后，然后将接收的数据拷贝到用户空间，完成read操作</p>
<p>用户需要等待read将数据读取到buffer后，才继续处理接收的数据。整个I/O请求的过程中，用户线程是被阻塞的，这导致用户在发起IO请求时，不能做任何事情，对CPU的资源利用率不够</p>
<p>优点：程序简单，在阻塞等待数据期间进程/线程挂起，基本不会占用 CPU 资源 </p>
<p>缺点：每个连接需要独立的进程/线程单独处理，当并发请求量大时为了维护程序，内存、线程切换开销较大，apache 的prefork使用的是这种模式。</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">同步阻塞：程序向内核发送I/O请求后一直等待内核响应，如果内核处理请求的IO操作不能立即返回,则进程将</span><br><span class="line">一直等待并不再接受新的请求，并由进程轮询查看I/O是否完成，完成后进程将I/O结果返回给Client，在IO</span><br><span class="line">没有返回期间进程不能接受其他客户的请求，而且是有进程自己去查看I/O是否完成，这种方式简单，但是比</span><br><span class="line">较慢，用的比较少。</span><br></pre></td></tr></table></figure>

<h4 id="非阻塞型-I-O-模型-nonblocking-IO"><a href="#非阻塞型-I-O-模型-nonblocking-IO" class="headerlink" title="非阻塞型 I/O 模型 (nonblocking IO)"></a>非阻塞型 I/O 模型 (nonblocking IO)</h4><p><img src="../../../../images/SRE/day28/55.jpg" alt="55"></p>
<p>用户线程发起IO请求时立即返回。但并未读取到任何数据，用户线程需要不断地发起IO请求，直到数据到达后，才真正读取到数据，继续执行。即 “轮询”机制存在两个问题：如果有大量文件描述符都要等，那么就得一个一个的read。这会带来大量的Context Switch（read是系统调用，每调用一次就得在用户态和核心态切换一次）。轮询的时间不好把握。这里是要猜多久之后数据才能到。等待时间设的太长，程序响应延迟就过大;设的太短，就会造成过于频繁的重试，干耗CPU而已，是比较浪费CPU的方式，一般很少直接使用这种模型，而是在其他IO模型中使用非阻塞IO这一特性。</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">非阻塞：程序向内核发送请I/O求后一直等待内核响应，如果内核处理请求的IO操作不能立即返回IO结果，进</span><br><span class="line">程将不再等待，而且继续处理其他请求，但是仍然需要进程隔一段时间就要查看内核I/O是否完成。</span><br></pre></td></tr></table></figure>

<p>查看上图可知，在设置连接为非阻塞时，当应用进程系统调用 recvfrom 没有数据返回时，内核会立即返回一个 EWOULDBLOCK 错误，而不会一直阻塞到数据准备好。如上图在第四次调用时有一个数据报准备好了，所以这时数据会被复制到应用进程缓冲区 ，于是 recvfrom 成功返回数据</p>
<p>当一个应用进程这样循环调用 recvfrom 时，称之为轮询 polling 。这么做往往会耗费大量CPU时间，实际使用很少</p>
<h4 id="I-O-多路复用型-I-O-multiplexing"><a href="#I-O-多路复用型-I-O-multiplexing" class="headerlink" title="I/O 多路复用型 (I/O multiplexing)"></a>I/O 多路复用型 (I/O multiplexing)</h4><p>上面的模型中,每一个文件描述符对应的IO是由一个线程监控和处理,即如果一个I/O流进来，就开启一个进程处理这个I/O流。那么假设现在有一百万个I/O流进来，那就需要开启一百万个进程一一对应处理这些I/O流（——这就是传统意义下的多进程并发处理）。一百万个进程，CPU占有率会多高，所以提出了I/O多路复用这个模型，一个线程，通过记录I/O流的状态来同时管理多个I/O，可以提高服务器的吞吐能力</p>
<p>多路复用IO指一个线程可以同时（实际是交替实现，即并发完成）监控和处理多个文件描述符对应各自的IO，即复用同一个线程</p>
<p>一个线程之所以能实现同时处理多个IO,是因为这个线程调用了内核中的SELECT,POLL或EPOLL等系统调用，从而实现多路复用IO</p>
<p><img src="../../../../images/SRE/day28/56.jpg" alt="56"></p>
<p>I/O multiplexing 主要包括:select，poll，epoll三种系统调用，select/poll/epoll的好处就在于单个process就可以同时处理多个网络连接的IO。</p>
<p>它的基本原理就是select/poll/epoll这个function会不断的轮询所负责的所有socket，当某个socket有数据到达了，就通知用户进程。</p>
<p>当用户进程调用了select，那么整个进程会被block，而同时，kernel会“监视”所有select负责的socket，当任何一个socket中的数据准备好了，select就会返回。这个时候用户进程再调用read操作，将数据从kernel拷贝到用户进程。 </p>
<p>Apache prefork是此模式的select，worker是poll模式。</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">IO多路复用（IO Multiplexing) ：是一种机制，程序注册一组socket文件描述符给操作系统，表示“我要</span><br><span class="line">监视这些fd是否有IO事件发生，有了就告诉程序处理”</span><br><span class="line">IO多路复用一般和NIO一起使用的。NIO和IO多路复用是相对独立的。NIO仅仅是指IO API总是能立刻返回，</span><br><span class="line">不会被Blocking;而IO多路复用仅仅是操作系统提供的一种便利的通知机制。操作系统并不会强制这俩必须得</span><br><span class="line">一起用，可以只用IO多路复用 + BIO，这时还是当前线程被卡住。IO多路复用和NIO是要配合一起使用才有</span><br><span class="line">实际意义</span><br><span class="line">IO多路复用是指内核一旦发现进程指定的一个或者多个IO条件准备读取，就通知该进程</span><br><span class="line">多个连接共用一个等待机制，本模型会阻塞进程，但是进程是阻塞在select或者poll这两个系统调用上，而</span><br><span class="line">不是阻塞在真正的IO操作上</span><br><span class="line">用户首先将需要进行IO操作添加到select中，同时等待select系统调用返回。当数据到达时，IO被激活，</span><br><span class="line">select函数返回。用户线程正式发起read请求，读取数据并继续执行</span><br><span class="line">从流程上来看，使用select函数进行IO请求和同步阻塞模型没有太大的区别，甚至还多了添加监视IO，以及</span><br><span class="line">调用select函数的额外操作，效率更差。并且阻塞了两次，但是第一次阻塞在select上时，select可以监</span><br><span class="line">控多个IO上是否已有IO操作准备就绪，即可达到在同一个线程内同时处理多个IO请求的目的。而不像阻塞IO</span><br><span class="line">那种，一次只能监控一个IO</span><br><span class="line">虽然上述方式允许单线程内处理多个IO请求，但是每个IO请求的过程还是阻塞的（在select函数上阻塞），</span><br><span class="line">平均时间甚至比同步阻塞IO模型还要长。如果用户线程只是注册自己需要的IO请求，然后去做自己的事情，等</span><br><span class="line">到数据到来时再进行处理，则可以提高CPU的利用率</span><br><span class="line">IO多路复用是最常使用的IO模型，但是其异步程度还不够“彻底”，因它使用了会阻塞线程的select系统调</span><br><span class="line">用。因此IO多路复用只能称为异步阻塞IO模型，而非真正的异步IO</span><br></pre></td></tr></table></figure>

<p>优缺点</p>
<ul>
<li>优点：可以基于一个阻塞对象，同时在多个描述符上等待就绪，而不是使用多个线程(每个文件描述符一个线程)，这样可以大大节省系统资源</li>
<li>缺点：当连接数较少时效率相比多线程+阻塞 I/O 模型效率较低，可能延迟更大，因为单个连接处理需要 2 次系统调用，占用时间会有增加</li>
</ul>
<p>IO多路复用适用如下场合：</p>
<ul>
<li>当客户端处理多个描述符时（一般是交互式输入和网络套接口），必须使用I/O复用</li>
<li>当一个客户端同时处理多个套接字时，此情况可能的但很少出现</li>
<li>当一个服务器既要处理监听套接字，又要处理已连接套接字，一般也要用到I/O复用</li>
<li>当一个服务器即要处理TCP，又要处理UDP，一般要使用I/O复用</li>
<li>当一个服务器要处理多个服务或多个协议，一般要使用I/O复用</li>
</ul>
<h4 id="信号驱动式-I-O-模型-signal-driven-IO"><a href="#信号驱动式-I-O-模型-signal-driven-IO" class="headerlink" title="信号驱动式 I/O 模型 (signal-driven IO)"></a>信号驱动式 I/O 模型 (signal-driven IO)</h4><p><img src="../../../../images/SRE/day28/57.jpg" alt="57"></p>
<p>信号驱动I/O的意思就是进程现在不用傻等着，也不用去轮询。而是让内核在数据就绪时，发送信号通知进程。</p>
<p>调用的步骤是，通过系统调用 sigaction ，并注册一个信号处理的回调函数，该调用会立即返回，然后主程序可以继续向下执行，当有I/O操作准备就绪,即内核数据就绪时，内核会为该进程产生一个 SIGIO 信号，并回调注册的信号回调函数，这样就可以在信号回调函数中系统调用 recvfrom 获取数据,将用户进程所需要的数据从内核空间拷贝到用户空间</p>
<p>此模型的优势在于等待数据报到达期间进程不被阻塞。用户主程序可以继续执行，只要等待来自信号处理函数的通知。</p>
<p>在信号驱动式 I/O 模型中，应用程序使用套接口进行信号驱动 I/O，并安装一个信号处理函数，进程继续运行并不阻塞</p>
<p>当数据准备好时，进程会收到一个 SIGIO 信号，可以在信号处理函数中调用 I/O 操作函数处理数据。</p>
<p>优点：线程并没有在等待数据时被阻塞，内核直接返回调用接收信号，不影响进程继续处理其他请求因此可以提高资源的利用率</p>
<p>缺点：信号 I/O 在大量 IO 操作时可能会因为信号队列溢出导致没法通知</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">异步阻塞：程序进程向内核发送IO调用后，不用等待内核响应，可以继续接受其他请求，内核收到进程请求后进行的IO如果不能立即返回，就由内核等待结果，直到IO完成后内核再通知进程。</span><br></pre></td></tr></table></figure>

<h4 id="异步-I-O-模型-asynchronous-IO"><a href="#异步-I-O-模型-asynchronous-IO" class="headerlink" title="异步 I/O 模型 (asynchronous IO)"></a>异步 I/O 模型 (asynchronous IO)</h4><p><img src="../../../../images/SRE/day28/58.jpg" alt="58"></p>
<p>异步I/O 与 信号驱动I/O最大区别在于，信号驱动是内核通知用户进程何时开始一个I/O操作，而异步I/O是由内核通知用户进程I/O操作何时完成，两者有本质区别,相当于不用去饭店场吃饭，直接点个外卖，把等待上菜的时间也给省了</p>
<p>相对于同步I/O，异步I/O不是顺序执行。用户进程进行aio_read系统调用之后，无论内核数据是否准备好，都会直接返回给用户进程，然后用户态进程可以去做别的事情。等到socket数据准备好了，内核直接复制数据给进程，然后从内核向进程发送通知。IO两个阶段，进程都是非阻塞的。</p>
<p>信号驱动IO当内核通知触发信号处理程序时，信号处理程序还需要阻塞在从内核空间缓冲区拷贝数据到用户空间缓冲区这个阶段，而异步IO直接是在第二个阶段完成后，内核直接通知用户线程可以进行后续操作了</p>
<p>优点：异步 I/O 能够充分利用 DMA 特性，让 I/O 操作与计算重叠</p>
<p>缺点：要实现真正的异步 I/O，操作系统需要做大量的工作。目前 Windows 下通过 IOCP 实现了真正的异步 I/O，在 Linux 系统下，Linux 2.6才引入，目前 AIO 并不完善，因此在 Linux 下实现高并发网络编程时以 IO 复用模型模式+多线程任务的架构基本可以满足需求</p>
<p>Linux提供了AIO库函数实现异步，但是用的很少。目前有很多开源的异步IO库，例如libevent、libev、libuv。</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">异步非阻塞：程序进程向内核发送IO调用后，不用等待内核响应，可以继续接受其他请求，内核调用的IO如果不能立即返回，内核会继续处理其他事物，直到IO完成后将结果通知给内核，内核在将IO完成的结果返回给进</span><br><span class="line">程，期间进程可以接受新的请求，内核也可以处理新的事物，因此相互不影响，可以实现较大的同时并实现较高的IO复用，因此异步非阻塞使用最多的一种通信方式。</span><br></pre></td></tr></table></figure>

<h3 id="五种-IO-对比"><a href="#五种-IO-对比" class="headerlink" title="五种 IO 对比"></a>五种 IO 对比</h3><p>这五种 I/O 模型中，越往后，阻塞越少，理论上效率也是最优前四种属于同步 I/O，因为其中真正的 I/O 操作(recvfrom)将阻塞进程/线程，只有异步 I/O 模型才与 POSIX 定义的异步 I/O 相匹配</p>
<p><img src="../../../../images/SRE/day28/59.jpg" alt="59"></p>
<h3 id="I-O-的具体实现方式"><a href="#I-O-的具体实现方式" class="headerlink" title="I/O 的具体实现方式"></a>I/O 的具体实现方式</h3><h4 id="I-O常见实现"><a href="#I-O常见实现" class="headerlink" title="I/O常见实现"></a>I/O常见实现</h4><p>Nginx支持在多种不同的操作系统实现不同的事件驱动模型，但是其在不同的操作系统甚至是不同的系统版本上面的实现方式不尽相同，主要有以下实现方式：</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">1、select：</span><br><span class="line">select库是在linux和windows平台都基本支持的 事件驱动模型库，并且在接口的定义也基本相同，只是部分参数的含义略有差异，最大并发限制1024，是最早期的事件驱动模型。I/O多路复用这个概念被提出来以后， select于1983年第一个在BSD里面实现</span><br><span class="line">2、poll：</span><br><span class="line">在Linux 的基本驱动模型，windows不支持此驱动模型，是select的升级版，取消了最大的并发限制，在编译nginx的时候可以使用--with-poll_module和--without-poll_module这两个指定是否编译select库。poll出现在1997年</span><br><span class="line">3、epoll：</span><br><span class="line">epoll是库是Nginx服务器支持的最高性能的事件驱动库之一，是公认的非常优秀的事件驱动模型，它和select和poll有很大的区别，epoll是poll的升级版，但是与poll有很大的区别.在2002年Davide Libenzi 实现了epoll.</span><br><span class="line">epoll的处理方式是创建一个待处理的事件列表，然后把这个列表发给内核，返回的时候在去轮询检查这个表，以判断事件是否发生，epoll支持一个进程打开的最大事件描述符的上限是系统可以打开的文件的最大数，同时epoll库的I/O效率不随描述符数目增加而线性下降，因为它只会对内核上报的“活跃”的描述符进行操作。</span><br><span class="line">4、kqueue：</span><br><span class="line">用于支持BSD系列平台的高校事件驱动模型，主要用在FreeBSD 4.1及以上版本、OpenBSD 2.0级以上版本，NetBSD级以上版本及Mac OS X 平台上，该模型也是poll库的变种，因此和epoll没有本质上的区别，</span><br><span class="line">效效率和epoll相似</span><br><span class="line">5、IOCP：</span><br><span class="line"> Windows系统上的实现方式，对应第5种（异步I/O）模型。</span><br><span class="line">6、/dev/poll:</span><br><span class="line">用于支持unix衍生平台的高效事件驱动模型，主要在Solaris 平台、HP/UX，该模型是sun公司在开发Solaris系列平台的时候提出的用于完成事件驱动机制的方案，它使用了虚拟的/dev/poll设备，开发人员将要见识的文件描述符加入这个设备，然后通过ioctl()调用来获取事件通知，因此运行在以上系列平台的时候</span><br><span class="line">请使用/dev/poll事件驱动机制。效率和epoll相似</span><br><span class="line">7、rtsig：</span><br><span class="line">不是一个常用事件驱动，最大队列1024，不是很常用</span><br><span class="line">8、eventport：</span><br><span class="line">该方案也是sun公司在开发Solaris的时候提出的事件驱动库，只是Solaris 10以上的版本，该驱动库可防止内核崩溃等情况的发生。</span><br></pre></td></tr></table></figure>

<h4 id="常用I-O模型比较"><a href="#常用I-O模型比较" class="headerlink" title="常用I/O模型比较"></a>常用I/O模型比较</h4><p><img src="../../../../images/SRE/day28/60.jpg" alt="60"></p>
<p><img src="../../../../images/SRE/day28/61.jpg" alt="61"></p>
<p>上图中横轴Dead connections 就是链接数的意思，叫这个名字只是它的测试工具叫deadcon. 纵轴是每秒处理请求的数量，你可以看到，epoll每秒处理请求的数量基本不会随着链接变多而下降的。poll 和/dev/poll 就很差了。</p>
<p><img src="../../../../images/SRE/day28/62.jpg" alt="62"></p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">Select：</span><br><span class="line">实现过程</span><br><span class="line">1. 从用户空间将fd_set拷贝到内核空间</span><br><span class="line">2. 注册回调函数</span><br><span class="line">3. 调用其对应的poll方法</span><br><span class="line">4. poll方法会返回一个描述读写是否就绪的mask掩码，根据这个mask掩码给fd_set赋值。</span><br><span class="line">5. 如果遍历完所有的fd都没有返回一个可读写的mask掩码，就会让select的进程进入休眠模式，直到发现可读写的资源后，重新唤醒等待队列上休眠的进程。如果在规定时间内都没有唤醒休眠进程，那么进程会被唤醒重新获得CPU，再去遍历一次fd。</span><br><span class="line">6. 将fd_set从内核空间拷贝到用户空间</span><br><span class="line">优点:</span><br><span class="line">POSIX所规定，目前几乎在所有的平台上支持，其良好跨平台支持也是它的一个优点</span><br><span class="line">缺点</span><br><span class="line">单个进程能够监视的文件描述符的数量存在最大限制，在Linux上一般为1024，可以通过修改宏定义FD_SETSIZE，再重新编译内核实现，但是这样也会造成效率的降低单个进程可监视的fd数量被限制，默认是1024，修改此值需要重新编译内核</span><br><span class="line">对socket是线性扫描，即采用轮询的方法，效率较低select 采取了内存拷贝方法来实现内核将 FD 消息通知给用户空间，这样一个用来存放大量fd的数据结</span><br><span class="line">构，这样会使得用户空间和内核空间在传递该结构时复制开销大</span><br></pre></td></tr></table></figure>

<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">poll：</span><br><span class="line">实现过程本质上和select没有区别，它将用户传入的数组拷贝到内核空间，然后查询每个fd对应的设备状态其没有最大连接数的限制，原因是它是基于链表来存储的</span><br><span class="line">大量的fd的数组被整体复制于用户态和内核地址空间之间，而不管这样的复制是不是有意义</span><br><span class="line">poll特点是“水平触发”，如果报告了fd后，没有被处理，那么下次poll时会再次报告该fd </span><br><span class="line">select是边缘触发即只通知一次</span><br></pre></td></tr></table></figure>

<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">epoll：</span><br><span class="line">在Linux 2.6内核中提出的select和poll的增强版本</span><br><span class="line">支持水平触发LT和边缘触发ET</span><br><span class="line">最大的特点在于边缘触发，它只告诉进程哪些fd刚刚变为就绪态，并且只会通知一次</span><br><span class="line">使用“事件”的就绪通知方式，通过epoll_ctl注册fd，一旦该fd就绪，内核就会采用类似callback的回调</span><br><span class="line">机制来激活该fd，epoll_wait便可以收到通知</span><br><span class="line">优点:</span><br><span class="line">1)没有最大并发连接的限制：能打开的FD的上限远大于1024(1G的内存能监听约10万个端口)，具体查</span><br><span class="line">看/proc/sys/fs/file-max，此值和系统内存大小相关</span><br><span class="line">2)效率提升：非轮询的方式，不会随着FD数目的增加而效率下降;只有活跃可用的FD才会调用callback函</span><br><span class="line">数，即epoll最大的优点就在于它只管理“活跃”的连接，而跟连接总数无关</span><br><span class="line">3)内存拷贝，利用mmap(Memory Mapping)加速与内核空间的消息传递;即epoll使用mmap减少复制开销</span><br><span class="line">缺点:</span><br><span class="line">只有linux支持。在BSD上面对应的实现是kqueue。</span><br></pre></td></tr></table></figure>

<p>总结:</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">1、epoll只是一组API，比起select这种扫描全部的文件描述符，epoll只读取就绪的文件描述符</span><br><span class="line">2、epoll比select等多路复用方式来说，减少了遍历循环及内存拷贝的工作量，因为活跃连接只占总并发连接的很小一部分。</span><br><span class="line">3、epoll基于事件的就绪通知机制，使用回调机制,所以性能比较好</span><br><span class="line">4、基于epoll的IO多路复用减少了进程间切换的次数，使得操作系统少做了相对于用户任务来说的无用功。</span><br></pre></td></tr></table></figure>

<h4 id="开发的选择"><a href="#开发的选择" class="headerlink" title="开发的选择"></a>开发的选择</h4><ul>
<li>完全跨平台，可以使用select、poll。但是性能较差</li>
<li>针对不同操作系统自行选择支持的最优技术，比如: Linux选用epoll,Mac选用kqueue,Windows 选用IOCP,提高IO处理的性能</li>
</ul>
<p>范例: 最大并发连接数和内存有直接关系</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#内存1G</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># free -h</span></span><br><span class="line">              total        used       free     shared buff/cache   available</span><br><span class="line">Mem:          952Mi       168Mi      605Mi       12Mi       178Mi       629Mi</span><br><span class="line">Swap:         2.0Gi          0B      2.0Gi</span><br><span class="line"></span><br><span class="line">[root@centos8 ~]<span class="comment"># cat /proc/sys/fs/file-max</span></span><br><span class="line">92953</span><br><span class="line"></span><br><span class="line"><span class="comment">#内存2G</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># free -h</span></span><br><span class="line">              total       used       free     shared buff/cache   available</span><br><span class="line">Mem:          1.9Gi       258Mi      1.3Gi       12Mi       341Mi       1.6Gi</span><br><span class="line">Swap:         2.0Gi         0B       2.0Gi</span><br><span class="line"></span><br><span class="line">[root@centos8 ~]<span class="comment"># cat /proc/sys/fs/file-max</span></span><br><span class="line">195920</span><br></pre></td></tr></table></figure>

<p>范例: 内核限制</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ~]<span class="comment"># grep -R FD_SETSIZE linux-5.8/*</span></span><br><span class="line">linux-5.8/Documentation/userspace-api/media/v4l/func-select.rst: ``FD_SETSIZE``.</span><br><span class="line">linux-5.8/include/uapi/linux/posix_types.h:<span class="comment">#undef __FD_SETSIZE</span></span><br><span class="line">linux-5.8/include/uapi/linux/posix_types.h:<span class="comment">#define __FD_SETSIZE 1024 #单个进程能够监视的文件描述符的文件最大数量</span></span><br><span class="line">linux-5.8/include/uapi/linux/posix_types.h: unsigned long fds_bits[__FD_SETSIZE / (8 * sizeof(long))];</span><br><span class="line">linux-5.8/tools/include/nolibc/nolibc.h:<span class="comment">#define FD_SETSIZE 256</span></span><br><span class="line">linux-5.8/tools/include/nolibc/nolibc.h:typedef struct &#123; uint32_tfd32[FD_SETSIZE/32]; &#125; fd_set;</span><br><span class="line">linux-5.8/tools/include/nolibc/nolibc.h: <span class="keyword">if</span> (fd &lt; 0 || fd &gt;= FD_SETSIZE)</span><br><span class="line">linux-5.8/tools/testing/selftests/net/nettest.c: rc = select(FD_SETSIZE, NULL, &amp;wfd, NULL, tv);</span><br></pre></td></tr></table></figure>

<p>范例: select 和epoll 帮助</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ~]<span class="comment"># whatis epoll</span></span><br><span class="line">epoll (7)            - I/O event notification facility</span><br><span class="line"></span><br><span class="line">[root@centos8 ~]<span class="comment"># whatis select</span></span><br><span class="line">select (2)           - synchronous I/O multiplexing</span><br><span class="line">select (3)           - synchronous I/O multiplexing</span><br><span class="line">select (3p)          - synchronous I/O multiplexing</span><br><span class="line"></span><br><span class="line">[root@centos8 ~]<span class="comment"># whatis poll</span></span><br><span class="line">poll (2)             - <span class="built_in">wait</span> <span class="keyword">for</span> some event on a file descriptor</span><br><span class="line">poll (3p)            - input/output multiplexing</span><br><span class="line"></span><br><span class="line">[root@centos8 ~]<span class="comment"># man 2 select</span></span><br><span class="line">SELECT(2)                                            Linux Programmer<span class="string">&#x27;s </span></span><br><span class="line"><span class="string">Manual                                               SELECT(2)</span></span><br><span class="line"><span class="string">NAME</span></span><br><span class="line"><span class="string">       select, pselect, FD_CLR, FD_ISSET, FD_SET, FD_ZERO - synchronous I/O </span></span><br><span class="line"><span class="string">multiplexing</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">[root@centos8 ~]# man 2 poll</span></span><br><span class="line"><span class="string">POLL(2)                                                Linux Programmer&#x27;</span>s </span><br><span class="line">Manual                                                 POLL(2)</span><br><span class="line">NAME</span><br><span class="line">       poll, ppoll - <span class="built_in">wait</span> <span class="keyword">for</span> some event on a file descriptor</span><br></pre></td></tr></table></figure>

<h2 id="零拷贝"><a href="#零拷贝" class="headerlink" title="零拷贝"></a>零拷贝</h2><h3 id="零拷贝介绍"><a href="#零拷贝介绍" class="headerlink" title="零拷贝介绍"></a>零拷贝介绍</h3><h4 id="传统-Linux中-I-O-的问题"><a href="#传统-Linux中-I-O-的问题" class="headerlink" title="传统 Linux中 I/O 的问题"></a>传统 Linux中 I/O 的问题</h4><p><img src="../../../../images/SRE/day28/63.jpg" alt="63"></p>
<p>传统的 Linux 系统的标准 I/O 接口（read、write）是基于数据拷贝的，也就是数据都是 copy_to_user 或者 copy_from_user，这样做的好处是，通过中间缓存的机制，减少磁盘 I/O 的操作，但是坏处也很明显，大量数据的拷贝，用户态和内核态的频繁切换，会消耗大量的 CPU 资源，严重影响数据传输的性能，统计表明，在Linux协议栈中，数据包在内核态和用户态之间的拷贝所用的时间甚至占到了数据包整个处理流程时间的57.1%</p>
<h4 id="什么是零拷贝"><a href="#什么是零拷贝" class="headerlink" title="什么是零拷贝"></a>什么是零拷贝</h4><p>零拷贝就是上述问题的一个解决方案，通过尽量避免拷贝操作来缓解 CPU 的压力。零拷贝并没有真正做到“0”拷贝，它更多是一种思想，很多的零拷贝技术都是基于这个思想去做的优化</p>
<h3 id="零拷页相关技术"><a href="#零拷页相关技术" class="headerlink" title="零拷页相关技术"></a>零拷页相关技术</h3><h4 id="MMAP-Memory-Mapping"><a href="#MMAP-Memory-Mapping" class="headerlink" title="MMAP ( Memory Mapping )"></a>MMAP ( Memory Mapping )</h4><p><img src="../../../../images/SRE/day28/64.jpg" alt="64"></p>
<p>mmap()系统调用使得进程之间通过映射同一个普通文件实现共享内存。普通文件被映射到进程地址空间后，进程可以向访问普通内存一样对文件进行访问。</p>
<p>mmap是一种内存映射文件的方法，即将一个文件或者其它对象映射到进程的地址空间，实现文件磁盘地址和进程虚拟地址空间中一段虚拟地址的一一对映关系。</p>
<p>实现这样的映射关系后，进程就可以采用指针的方式读写操作这一段内存，而系统会自动回写脏页面到对应的文件磁盘上，即完成了对文件的操作而不必再调用read,write等系统调用函数。相反，内核空间对这段区域的修改也直接反映用户空间，从而可以实现不同进程间的文件共享。 </p>
<p>内存映射减少数据在用户空间和内核空间之间的拷贝操作,适合大量数据传输</p>
<p><img src="../../../../images/SRE/day28/65.jpg" alt="65"><br><img src="../../../../images/SRE/day28/66.jpg" alt="66"></p>
<p>上面左图为传统读写,右图为MMAP.两者相比mmap要比普通的read系统调用少了一次copy的过程。因为read调用，进程是无法直接访问kernel space的，所以在read系统调用返回前，内核需要将数据从内核复制到进程指定的buffer。但mmap之后，进程可以直接访问mmap的数据(page cache)。</p>
<h4 id="SENDFILE"><a href="#SENDFILE" class="headerlink" title="SENDFILE"></a>SENDFILE</h4><p><img src="../../../../images/SRE/day28/67.jpg" alt="67"></p>
<h4 id="DMA辅助的-SENDFILE"><a href="#DMA辅助的-SENDFILE" class="headerlink" title="DMA辅助的 SENDFILE"></a>DMA辅助的 SENDFILE</h4><p><img src="../../../../images/SRE/day28/68.jpg" alt="68"></p>
<h1 id="Nginx-架构和安装"><a href="#Nginx-架构和安装" class="headerlink" title="Nginx 架构和安装"></a>Nginx 架构和安装</h1><h2 id="Nginx-概述"><a href="#Nginx-概述" class="headerlink" title="Nginx 概述"></a>Nginx 概述</h2><h3 id="Nginx-介绍"><a href="#Nginx-介绍" class="headerlink" title="Nginx 介绍"></a>Nginx 介绍</h3><p>Nginx：engine X ，2002年开发，分为社区版和商业版(nginx plus )</p>
<p>2019年3月11日 F5 Networks 6.7亿美元的价格收购</p>
<p>Nginx是免费的、开源的、高性能的HTTP和反向代理服务器、邮件代理服务器、以及TCP/UDP代理服务器</p>
<p>解决C10K问题（10K Connections）</p>
<p>解决C1000K问题参考链接: <a target="_blank" rel="noopener" href="http://www.ideawu.net/blog/archives/740.html">http://www.ideawu.net/blog/archives/740.html</a></p>
<p>Nginx官网：<a target="_blank" rel="noopener" href="http://nginx.org/">http://nginx.org</a></p>
<p>nginx的其它的二次发行版：</p>
<ul>
<li><p>Tengine</p>
<p>由淘宝网发起的Web服务器项目。它在Nginx的基础上，针对大访问量网站的需求，添加了很多高级功能和特性。Tengine的性能和稳定性已经在大型的网站如淘宝网，天猫商城等得到了很好的检验。它的最终目标是打造一个高效、稳定、安全、易用的Web平台。从2011年12月开始，Tengine 成为一个开源项目</p>
<p>官网: <a target="_blank" rel="noopener" href="http://tengine.taobao.org/">http://tengine.taobao.org/</a></p>
</li>
<li><p>OpenResty </p>
<p>基于 Nginx 与 Lua 语言的高性能 Web 平台， 章亦春团队开发</p>
<p>官网：<a target="_blank" rel="noopener" href="http://openresty.org/cn/">http://openresty.org/cn/</a></p>
</li>
</ul>
<h3 id="Nginx-功能介绍"><a href="#Nginx-功能介绍" class="headerlink" title="Nginx 功能介绍"></a>Nginx 功能介绍</h3><ul>
<li>静态的web资源服务器html，图片，js，css，txt等静态资源</li>
<li>http/https协议的反向代理</li>
<li>结合FastCGI/uWSGI/SCGI等协议反向代理动态资源请求</li>
<li>tcp/udp协议的请求转发（反向代理）</li>
<li>imap4/pop3协议的反向代理</li>
</ul>
<h3 id="基础特性"><a href="#基础特性" class="headerlink" title="基础特性"></a>基础特性</h3><ul>
<li>模块化设计，较好的扩展性</li>
<li>高可靠性</li>
<li>支持热部署：不停机更新配置文件，升级版本，更换日志文件</li>
<li>低内存消耗：10000个keep-alive连接模式下的非活动连接，仅需2.5M内存</li>
<li>event-driven,aio,mmap，sendfile</li>
</ul>
<h3 id="Web-服务相关的功能"><a href="#Web-服务相关的功能" class="headerlink" title="Web 服务相关的功能"></a>Web 服务相关的功能</h3><ul>
<li>虚拟主机（server）</li>
<li>支持 keep-alive 和管道连接(利用一个连接做多次请求)</li>
<li>访问日志（支持基于日志缓冲提高其性能） </li>
<li>url rewirte</li>
<li>路径别名</li>
<li>基于IP及用户的访问控制</li>
<li>支持速率限制及并发数限制</li>
<li>重新配置和在线升级而无须中断客户的工作进程</li>
</ul>
<h2 id="Nginx-架构和进程"><a href="#Nginx-架构和进程" class="headerlink" title="Nginx 架构和进程"></a>Nginx 架构和进程</h2><h3 id="Nginx-架构"><a href="#Nginx-架构" class="headerlink" title="Nginx 架构"></a>Nginx 架构</h3><p><img src="../../../../images/SRE/day28/69.jpg" alt="69"></p>
<h3 id="Nginx-进程结构"><a href="#Nginx-进程结构" class="headerlink" title="Nginx 进程结构"></a>Nginx 进程结构</h3><p>Nginx是多进程组织模型，而且是一个由Master主进程和Worker工作进程组成。</p>
<p><img src="../../../../images/SRE/day28/70.jpg" alt="70"></p>
<p>主进程(master process)的功能：</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">对外接口：接收外部的操作（信号）</span><br><span class="line">对内转发：根据外部的操作的不同，通过信号管理 Worker</span><br><span class="line">监控：监控 worker 进程的运行状态，worker 进程异常终止后，自动重启 worker 进程</span><br><span class="line">读取Nginx 配置文件并验证其有效性和正确性</span><br><span class="line">建立、绑定和关闭socket连接</span><br><span class="line">按照配置生成、管理和结束工作进程</span><br><span class="line">接受外界指令，比如重启、升级及退出服务器等指令</span><br><span class="line">不中断服务，实现平滑升级，重启服务并应用新的配置</span><br><span class="line">开启日志文件，获取文件描述符</span><br><span class="line">不中断服务，实现平滑升级，升级失败进行回滚处理</span><br><span class="line">编译和处理perl脚本</span><br></pre></td></tr></table></figure>

<p>工作进程（worker process）的功能：</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">所有 Worker 进程都是平等的</span><br><span class="line">实际处理：网络请求，由 Worker 进程处理</span><br><span class="line">Worker进程数量：一般设置为核心数，充分利用CPU资源，同时避免进程数量过多，导致进程竞争CPU资源，</span><br><span class="line">增加上下文切换的损耗</span><br><span class="line">接受处理客户的请求</span><br><span class="line">将请求依次送入各个功能模块进行处理</span><br><span class="line">I/O调用，获取响应数据</span><br><span class="line">与后端服务器通信，接收后端服务器的处理结果</span><br><span class="line">缓存数据，访问缓存索引，查询和调用缓存数据</span><br><span class="line">发送请求结果，响应客户的请求</span><br><span class="line">接收主程序指令，比如重启、升级和退出等</span><br></pre></td></tr></table></figure>

<h3 id="Nginx-启动和-HTTP-连接建立"><a href="#Nginx-启动和-HTTP-连接建立" class="headerlink" title="Nginx 启动和 HTTP 连接建立"></a>Nginx 启动和 HTTP 连接建立</h3><p><img src="../../../../images/SRE/day28/71.jpg" alt="71"></p>
<ul>
<li>Nginx 启动时，Master 进程，加载配置文件</li>
<li>Master 进程，初始化监听的 socket</li>
<li>Master 进程，fork 出多个 Worker 进程</li>
<li>Worker 进程，竞争新的连接，获胜方通过三次握手，建立 Socket 连接，并处理请求</li>
</ul>
<h3 id="HTTP-处理过程"><a href="#HTTP-处理过程" class="headerlink" title="HTTP 处理过程"></a>HTTP 处理过程</h3><p><img src="../../../../images/SRE/day28/72.jpg" alt="72"></p>
<h2 id="Nginx-模块介绍"><a href="#Nginx-模块介绍" class="headerlink" title="Nginx 模块介绍"></a>Nginx 模块介绍</h2><p>nginx 有多种模块</p>
<ul>
<li>核心模块：是 Nginx 服务器正常运行必不可少的模块，提供错误日志记录 、配置文件解析 、事件驱动机制 、进程管理等核心功能</li>
<li>标准HTTP模块：提供 HTTP 协议解析相关的功能，比如： 端口配置 、 网页编码设置 、 HTTP响应头设置等</li>
<li>可选HTTP模块：主要用于扩展标准的 HTTP 功能，让 Nginx 能处理一些特殊的服务，比如： Flash 多媒体传输 、解析 GeoIP 请求、 网络传输压缩 、 安全协议 SSL 支持等</li>
<li>邮件服务模块：主要用于支持 Nginx 的 邮件服务 ，包括对 POP3 协议、 IMAP 协议和 SMTP协议的支持</li>
<li>Stream服务模块: 实现反向代理功能,包括TCP协议代理</li>
<li>第三方模块：是为了扩展 Nginx 服务器应用，完成开发者自定义功能，比如： Json 支持、 Lua 支持等</li>
</ul>
<p>nginx高度模块化，但其模块早期不支持DSO机制;1.9.11 版本支持动态装载和卸载 </p>
<p>模块分类：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">核心模块：core module</span><br><span class="line">标准模块：</span><br><span class="line">   HTTP 模块： ngx_http_*</span><br><span class="line">         HTTP Core modules   <span class="comment">#默认功能</span></span><br><span class="line">         HTTP Optional modules <span class="comment">#需编译时指定</span></span><br><span class="line">   Mail 模块: ngx_mail_*</span><br><span class="line">   Stream 模块 ngx_stream_*</span><br><span class="line"></span><br><span class="line">第三方模块</span><br></pre></td></tr></table></figure>

<p><img src="../../../../images/SRE/day28/73.jpg" alt="73"></p>
<h2 id="Nginx-安装"><a href="#Nginx-安装" class="headerlink" title="Nginx 安装"></a>Nginx 安装</h2><h3 id="Nginx版本和安装方式"><a href="#Nginx版本和安装方式" class="headerlink" title="Nginx版本和安装方式"></a>Nginx版本和安装方式</h3><p>Nginx 分为社区版和商业版,一般是社区版</p>
<p>Nginx版本</p>
<ul>
<li>Mainline version 主要开发版本,一般为奇数版本号,比如1.19</li>
<li>Stable version 当前最新稳定版,一般为偶数版本,如:1.20</li>
<li>Legacy versions 旧的稳定版,一般为偶数版本,如:1.18</li>
</ul>
<p>Nginx安装可以使用yum或源码安装，但是推荐使用源码编译安装</p>
<ul>
<li>yum/apt的系统仓库版本比较旧</li>
<li>编译安装可以更方便自定义相关路径,使用源码编译可以自定义相关功能，更方便业务的上的使用</li>
<li>docker 容器直接运行</li>
</ul>
<h3 id="基于-yum-安装-Nginx"><a href="#基于-yum-安装-Nginx" class="headerlink" title="基于 yum 安装 Nginx"></a>基于 yum 安装 Nginx</h3><h4 id="查看当前系统中的-nginx-版本"><a href="#查看当前系统中的-nginx-版本" class="headerlink" title="查看当前系统中的 nginx 版本"></a>查看当前系统中的 nginx 版本</h4><p>范例: 查看系统和EPEL的nginx版本</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ~]<span class="comment"># dnf info nginx</span></span><br><span class="line">Last metadata expiration check: 0:53:10 ago on Tue 22 Sep 2020 11:01:33 AM CST.</span><br><span class="line">Available Packages</span><br><span class="line">Name         : nginx</span><br><span class="line">Epoch       : 1</span><br><span class="line">Version     : 1.14.1</span><br><span class="line">Release     : 9.module_el8.0.0+184+e34fea82</span><br><span class="line">Architecture : x86_64</span><br><span class="line">Size         : 570 k</span><br><span class="line">Source       : nginx-1.14.1-9.module_el8.0.0+184+e34fea82.src.rpm</span><br><span class="line">Repository   : AppStream</span><br><span class="line">Summary     : A high performance web server and reverse proxy server</span><br><span class="line">URL         : http://nginx.org/</span><br><span class="line">License     : BSD</span><br><span class="line">Description : Nginx is a web server and a reverse proxy server <span class="keyword">for</span> HTTP, SMTP, </span><br><span class="line">POP3 and</span><br><span class="line">             : IMAP protocols, with a strong focus on high concurrency, </span><br><span class="line">performance and low</span><br><span class="line">             : memory usage.</span><br><span class="line">             </span><br><span class="line">             </span><br><span class="line"><span class="comment">#CentOS 7 需要提前配置好epel源</span></span><br><span class="line">[root@centos7 ~]<span class="comment"># yum info nginx</span></span><br><span class="line">Loaded plugins: fastestmirror</span><br><span class="line">Loading mirror speeds from cached hostfile</span><br><span class="line"> * base: </span><br><span class="line">Available Packages</span><br><span class="line">Name       : nginx</span><br><span class="line">Arch       : x86_64</span><br><span class="line">Epoch       : 1</span><br><span class="line">Version     : 1.16.1</span><br><span class="line">Release     : 1.el7</span><br><span class="line">Size       : 562 k</span><br><span class="line">Repo       : epel/7/x86_64</span><br><span class="line">Summary     : A high performance web server and reverse proxy server</span><br><span class="line">URL         : http://nginx.org/</span><br><span class="line">License     : BSD</span><br><span class="line">Description : Nginx is a web server and a reverse proxy server <span class="keyword">for</span> HTTP, SMTP, </span><br><span class="line">POP3 and</span><br><span class="line">           : IMAP protocols, with a strong focus on high concurrency, </span><br><span class="line">performance and low</span><br><span class="line">           : memory usage.</span><br></pre></td></tr></table></figure>

<h4 id="官方包源安装最新版本-nginx"><a href="#官方包源安装最新版本-nginx" class="headerlink" title="官方包源安装最新版本 nginx"></a>官方包源安装最新版本 nginx</h4><p>系统和EPEL源的中 nignx版本较旧,可以安装官方源的最新版本</p>
<p>官方包链接: </p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://nginx.org/en/linux_packages.html</span><br></pre></td></tr></table></figure>

<p>官方 yum 源链接</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://nginx.org/en/linux_packages.html#RHEL-CentOS</span><br></pre></td></tr></table></figure>

<p>范例: 通过官方 yum 源安装nginx</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ~]<span class="comment"># cat /etc/yum.repos.d/nginx.repo</span></span><br><span class="line">[nginx-stable]</span><br><span class="line">name=nginx stable repo</span><br><span class="line">baseurl=http://nginx.org/packages/centos/<span class="variable">$releasever</span>/<span class="variable">$basearch</span>/</span><br><span class="line">gpgcheck=1</span><br><span class="line">enabled=1</span><br><span class="line">gpgkey=https://nginx.org/keys/nginx_signing.key</span><br><span class="line">module_hotfixes=<span class="literal">true</span></span><br><span class="line">[nginx-mainline]</span><br><span class="line">name=nginx mainline repo</span><br><span class="line">baseurl=http://nginx.org/packages/mainline/centos/<span class="variable">$releasever</span>/<span class="variable">$basearch</span>/</span><br><span class="line">gpgcheck=1</span><br><span class="line">enabled=0</span><br><span class="line">gpgkey=https://nginx.org/keys/nginx_signing.key</span><br><span class="line">module_hotfixes=<span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#列出所有版本</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># yum list nginx --showduplicates</span></span><br><span class="line">Last metadata expiration check: 0:01:08 ago on Tue 22 Sep 2020 12:01:59 PM CST.</span><br><span class="line">Available Packages</span><br><span class="line">nginx.x86_64    1.16.0-1.el8.ngx                         nginx-stable</span><br><span class="line">nginx.x86_64    1:1.14.1-9.module_el8.0.0+184+e34fea82   AppStream   </span><br><span class="line">nginx.x86_64    1:1.16.1-1.el8.ngx                       nginx-stable</span><br><span class="line">nginx.x86_64    1:1.18.0-1.el8.ngx                       nginx-stable</span><br><span class="line"></span><br><span class="line"><span class="comment">#查看版本信息</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># dnf info nginx</span></span><br><span class="line">Last metadata expiration check: 0:02:50 ago on Tue 22 Sep 2020 12:01:59 PM CST.</span><br><span class="line">Available Packages</span><br><span class="line">Name         : nginx</span><br><span class="line">Epoch       : 1</span><br><span class="line">Version     : 1.18.0</span><br><span class="line">Release     : 1.el8.ngx</span><br><span class="line">Architecture : x86_64</span><br><span class="line">Size         : 806 k</span><br><span class="line">Source       : nginx-1.18.0-1.el8.ngx.src.rpm</span><br><span class="line">Repository   : nginx-stable</span><br><span class="line">Summary     : High performance web server</span><br><span class="line">URL         : http://nginx.org/</span><br><span class="line">License     : 2-clause BSD-like license</span><br><span class="line">Description : nginx [engine x] is an HTTP and reverse proxy server, as well as</span><br><span class="line">             : a mail proxy server.</span><br><span class="line">             </span><br><span class="line"><span class="comment">#安装指定版本</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># yum -y install nginx-1.18.0</span></span><br></pre></td></tr></table></figure>

<h4 id="检查安装"><a href="#检查安装" class="headerlink" title="检查安装"></a>检查安装</h4><p>查看nginx安装包信息</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ~]<span class="comment"># rpm -q nginx</span></span><br><span class="line">nginx-1.18.0-1.el8.ngx.x86_64</span><br><span class="line"></span><br><span class="line">[root@centos8 ~]<span class="comment"># rpm -qi nginx</span></span><br><span class="line">Name       : nginx</span><br><span class="line">Epoch       : 1</span><br><span class="line">Version     : 1.18.0</span><br><span class="line">Release     : 1.el8.ngx</span><br><span class="line">Architecture: x86_64</span><br><span class="line">Install Date: Tue 22 Sep 2020 12:05:14 PM CST</span><br><span class="line">Group       : System Environment/Daemons</span><br><span class="line">Size       : 3815084</span><br><span class="line">License     : 2-clause BSD-like license</span><br><span class="line">Signature   : RSA/SHA1, Tue 21 Apr 2020 11:19:19 PM CST, Key ID abf5bd827bd9bf62</span><br><span class="line">Source RPM : nginx-1.18.0-1.el8.ngx.src.rpm</span><br><span class="line">Build Date : Tue 21 Apr 2020 11:07:57 PM CST</span><br><span class="line">Build Host : ip-10-1-17-47.eu-central-1.compute.internal</span><br><span class="line">Relocations : (not relocatable)</span><br><span class="line">Vendor     : Nginx, Inc.</span><br><span class="line">URL         : http://nginx.org/</span><br><span class="line">Summary     : High performance web server</span><br><span class="line">Description :</span><br><span class="line">nginx [engine x] is an HTTP and reverse proxy server, as well as</span><br><span class="line">a mail proxy server.</span><br><span class="line"></span><br><span class="line">[root@centos8 ~]<span class="comment"># rpm -ql nginx</span></span><br><span class="line">/etc/logrotate.d/nginx</span><br><span class="line">/etc/nginx</span><br><span class="line">/etc/nginx/conf.d</span><br><span class="line">/etc/nginx/conf.d/default.conf</span><br><span class="line">/etc/nginx/fastcgi_params</span><br><span class="line">/etc/nginx/koi-utf</span><br><span class="line">/etc/nginx/koi-win</span><br><span class="line">/etc/nginx/mime.types</span><br><span class="line">/etc/nginx/modules</span><br><span class="line">/etc/nginx/nginx.conf</span><br><span class="line">/etc/nginx/scgi_params</span><br><span class="line">/etc/nginx/uwsgi_params</span><br><span class="line">/etc/nginx/win-utf</span><br><span class="line">/etc/sysconfig/nginx</span><br><span class="line">/etc/sysconfig/nginx-debug</span><br><span class="line">/usr/lib/.build-id</span><br><span class="line">/usr/lib/.build-id/72</span><br><span class="line">/usr/lib/.build-id/72/32b3d274d95e3739c1690a6344d3aac4c6272b</span><br><span class="line">/usr/lib/.build-id/7f</span><br><span class="line">/usr/lib/.build-id/7f/0259e101e7ab850dee7e6ac2907ac62f6f5917</span><br><span class="line">/usr/lib/systemd/system/nginx-debug.service</span><br><span class="line"></span><br><span class="line"><span class="comment">#带有自动日志切割功能</span></span><br><span class="line">[root@centos8 ~]<span class="comment">#cat /etc/logrotate.d/nginx </span></span><br><span class="line">/var/log/nginx/*<span class="built_in">log</span> &#123;</span><br><span class="line">   create 0664 nginx root</span><br><span class="line">   daily</span><br><span class="line">   rotate 10</span><br><span class="line">   missingok</span><br><span class="line">   notifempty</span><br><span class="line">   compress</span><br><span class="line">   sharedscripts</span><br><span class="line">   postrotate</span><br><span class="line">       /bin/kill -USR1 `<span class="built_in">cat</span> /run/nginx.pid 2&gt;/dev/null` 2&gt;/dev/null || <span class="literal">true</span></span><br><span class="line">   endscript</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="nginx-程序用法帮助"><a href="#nginx-程序用法帮助" class="headerlink" title="nginx 程序用法帮助"></a>nginx 程序用法帮助</h4><p>使用安装完成的二进制文件nginx</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ~]<span class="comment">#nginx -h</span></span><br><span class="line">nginx version: nginx/1.18.0</span><br><span class="line">Usage: nginx [-?hvVtTq] [-s signal] [-c filename] [-p prefix] [-g directives]</span><br><span class="line">Options:</span><br><span class="line">  -?,-h        : this <span class="built_in">help</span></span><br><span class="line">  -v           : show version and <span class="built_in">exit</span></span><br><span class="line">  -V           : show version and configure options <span class="keyword">then</span> <span class="built_in">exit</span> <span class="comment">#显示版本和编译参数</span></span><br><span class="line">  -t           : <span class="built_in">test</span> configuration and <span class="built_in">exit</span> <span class="comment">#测试配置文件是否异常</span></span><br><span class="line">  -T           : <span class="built_in">test</span> configuration, dump it and <span class="built_in">exit</span> <span class="comment">#测试并打印</span></span><br><span class="line">  -q           : suppress non-error messages during configuration testing <span class="comment">#静默模式</span></span><br><span class="line">  -s signal     : send signal to a master process: stop, quit, reopen, reload <span class="comment">#发送信号,reload信号 会生成新的worker,但master不会重新生成</span></span><br><span class="line">  -p prefix     : <span class="built_in">set</span> prefix path (default: /etc/nginx/) <span class="comment">#指定Nginx 目录</span></span><br><span class="line">  -c filename   : <span class="built_in">set</span> configuration file (default: /etc/nginx/nginx.conf)<span class="comment">#配置文件路径</span></span><br><span class="line">  -g directives : <span class="built_in">set</span> global directives out of configuration file<span class="comment">#设置全局指令,注意和配置文件不要同时配置,否则冲突</span></span><br></pre></td></tr></table></figure>

<p>范例: nginx 命令使用</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ~]<span class="comment"># nginx -g &quot;worker_processes 6;&quot;</span></span><br><span class="line">nginx: [emerg] <span class="string">&quot;worker_processes&quot;</span> directive is duplicate <span class="keyword">in</span></span><br><span class="line">/apps/nginx/conf/nginx.conf:3</span><br><span class="line"></span><br><span class="line">[root@centos8 ~]<span class="comment"># vim /apps/nginx/conf/nginx.conf</span></span><br><span class="line"><span class="comment">#worker_processes 1;</span></span><br><span class="line"></span><br><span class="line">[root@centos8 ~]<span class="comment"># nginx -g &quot;worker_processes 6;&quot;</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># ps aux|grep nginx</span></span><br><span class="line">root        8843  0.0  0.0  41048   844 ?       Ss   18:53   0:00 nginx: master </span><br><span class="line">process nginx -g worker_processes 6;</span><br><span class="line">nginx       8844  0.0  0.4  74572  4832 ?       S    18:53   0:00 nginx: worker </span><br><span class="line">process</span><br><span class="line">nginx       8845  0.0  0.4  74572  4832 ?       S    18:53   0:00 nginx: worker </span><br><span class="line">process</span><br><span class="line">nginx       8846  0.0  0.4  74572  4832 ?       S    18:53   0:00 nginx: worker </span><br><span class="line">process</span><br><span class="line">nginx       8847  0.0  0.4  74572  4832 ?       S    18:53   0:00 nginx: worker </span><br><span class="line">process</span><br><span class="line">nginx       8848  0.0  0.4  74572  4832 ?       S    18:53   0:00 nginx: worker </span><br><span class="line">process</span><br><span class="line">nginx       8849  0.0  0.4  74572  4832 ?       S    18:53   0:00 nginx: worker </span><br><span class="line">process</span><br><span class="line">root        8851  0.0  0.1  12108  1076 pts/1   S+   18:53   0:00 grep --color=auto nginx</span><br><span class="line"></span><br><span class="line">[root@centos8 ~]<span class="comment"># nginx -s quit</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># ps aux|grep nginx</span></span><br><span class="line">root        8858  0.0  0.1  12108  1100 pts/1   S+   18:54   0:00 grep --color=auto nginx</span><br><span class="line"></span><br><span class="line"><span class="comment"># 前台运行</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># nginx -g &#x27;daemon off;&#x27;</span></span><br><span class="line">^C[root@centos8 ~]<span class="comment">#</span></span><br></pre></td></tr></table></figure>

<h4 id="验证-Nginx"><a href="#验证-Nginx" class="headerlink" title="验证 Nginx"></a>验证 Nginx</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ~]<span class="comment"># nginx -t</span></span><br><span class="line">nginx: the configuration file /etc/nginx/nginx.conf syntax is ok</span><br><span class="line">nginx: configuration file /etc/nginx/nginx.conf <span class="built_in">test</span> is successful</span><br><span class="line"></span><br><span class="line">[root@centos8 ~]<span class="comment"># nginx -V</span></span><br><span class="line">nginx version: nginx/1.18.0</span><br><span class="line">built by gcc 8.3.1 20190507 (Red Hat 8.3.1-4) (GCC) </span><br><span class="line">built with OpenSSL 1.1.1c FIPS  28 May 2019</span><br><span class="line">TLS SNI support enabled</span><br><span class="line">configure arguments: --prefix=/etc/nginx --sbin-path=/usr/sbin/nginx </span><br><span class="line">--modules-path=/usr/lib64/nginx/modules --conf-path=/etc/nginx/nginx.conf </span><br><span class="line">--error-log-path=/var/log/nginx/error.log --http-log-path=/var/log/nginx/access.log</span><br><span class="line">--pid-path=/var/run/nginx.pid --lock-path=/var/run/nginx.lock </span><br><span class="line">--http-client-body-temp-path=/var/cache/nginx/client_temp --http-proxy-temp-path=/var/cache/nginx/proxy_temp </span><br><span class="line">--http-fastcgi-temp-path=/var/cache/nginx/fastcgi_temp --http-uwsgi-temp-path=/var/cache/nginx/uwsgi_temp</span><br><span class="line">--http-scgi-temp-path=/var/cache/nginx/scgi_temp --user=nginx --group=nginx</span><br><span class="line">--with-compat --with-file-aio --with-threads --with-http_addition_module</span><br><span class="line">--with-http_auth_request_module --with-http_dav_module --with-http_flv_module </span><br><span class="line">--with-http_gunzip_module --with-http_gzip_static_module --with-http_mp4_module </span><br><span class="line">--with-http_random_index_module --with-http_realip_module --with-http_secure_link_module </span><br><span class="line">--with-http_slice_module --with-http_ssl_module --with-http_stub_status_module </span><br><span class="line">--with-http_sub_module --with-http_v2_module --with-mail --with-mail_ssl_module </span><br><span class="line">--with-stream --with-stream_realip_module --with-stream_ssl_module --with-stream_ssl_preread_module </span><br><span class="line">--with-cc-opt=<span class="string">&#x27;-O2 -g -pipe -Wall -Werror=format-security -Wp,-D_FORTIFY_SOURCE=2 -Wp,-D_GLIBCXX_ASSERTIONS -fexceptions -fstack-protector-strong -grecord-gcc-switches -specs=/usr/lib/rpm/redhat/redhat-hardened-cc1 -specs=/usr/lib/rpm/redhat/redhat-annobin-cc1 -m64 -mtune=generic -fasynchronous-unwind-tables -fstack-clash-protection -fcf-protection -fPIC&#x27;</span> </span><br><span class="line">--with-ld-opt=<span class="string">&#x27;-Wl,-z,relro -Wl,-z,now -pi</span></span><br></pre></td></tr></table></figure>

<h4 id="Nginx-启动文件"><a href="#Nginx-启动文件" class="headerlink" title="Nginx 启动文件"></a>Nginx 启动文件</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ~]<span class="comment"># cat /usr/lib/systemd/system/nginx.service</span></span><br><span class="line">[Unit]</span><br><span class="line">Description=nginx - high performance web server</span><br><span class="line">Documentation=http://nginx.org/en/docs/</span><br><span class="line">After=network-online.target remote-fs.target nss-lookup.target</span><br><span class="line">Wants=network-online.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">Type=forking</span><br><span class="line">PIDFile=/var/run/nginx.pid</span><br><span class="line">ExecStart=/usr/sbin/nginx -c /etc/nginx/nginx.conf</span><br><span class="line">ExecReload=/bin/kill -s HUP <span class="variable">$MAINPID</span></span><br><span class="line">ExecStop=/bin/kill -s TERM <span class="variable">$MAINPID</span></span><br><span class="line">LimitNOFILE=100000</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br></pre></td></tr></table></figure>

<h4 id="Nginx-配置文件"><a href="#Nginx-配置文件" class="headerlink" title="Nginx 配置文件"></a>Nginx 配置文件</h4><p>范例: 查看配置文件列表</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ~]<span class="comment"># rpm -qc nginx</span></span><br><span class="line">/etc/logrotate.d/nginx</span><br><span class="line">/etc/nginx/conf.d/default.conf</span><br><span class="line">/etc/nginx/fastcgi_params</span><br><span class="line">/etc/nginx/koi-utf</span><br><span class="line">/etc/nginx/koi-win</span><br><span class="line">/etc/nginx/mime.types</span><br><span class="line">/etc/nginx/nginx.conf</span><br><span class="line">/etc/nginx/scgi_params</span><br><span class="line">/etc/nginx/uwsgi_params</span><br><span class="line">/etc/nginx/win-utf</span><br><span class="line">/etc/sysconfig/nginx</span><br><span class="line">/etc/sysconfig/nginx-debug</span><br><span class="line"></span><br><span class="line">[root@centos8 ~]<span class="comment"># cat /etc/sysconfig/nginx</span></span><br><span class="line"><span class="comment"># Configuration file for the nginx service.</span></span><br><span class="line">NGINX=/usr/sbin/nginx</span><br><span class="line">CONFFILE=/etc/nginx/nginx.conf</span><br><span class="line"></span><br><span class="line">[root@centos8 ~]<span class="comment"># tree /etc/nginx/</span></span><br><span class="line">/etc/nginx/</span><br><span class="line">├── conf.d</span><br><span class="line">│   └── default.conf</span><br><span class="line">├── fastcgi_params</span><br><span class="line">├── koi-utf</span><br><span class="line">├── koi-win</span><br><span class="line">├── mime.types</span><br><span class="line">├── modules -&gt; ../../usr/lib64/nginx/modules</span><br><span class="line">├── nginx.conf</span><br><span class="line">├── scgi_params</span><br><span class="line">├── uwsgi_params</span><br><span class="line">└── win-utf</span><br><span class="line"></span><br><span class="line">2 directories, 9 files</span><br></pre></td></tr></table></figure>

<p>范例: 配置文件/etc/nginx/nginx.conf 默认配置</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ~]<span class="comment">#grep -Ev &quot;^ *#|^$&quot; /etc/nginx/nginx.conf </span></span><br><span class="line">user nginx;</span><br><span class="line">worker_processes  1;</span><br><span class="line">error_log /var/log/nginx/error.log warn;</span><br><span class="line">pid       /var/run/nginx.pid;</span><br><span class="line">events &#123;</span><br><span class="line">   worker_connections  1024;</span><br><span class="line">&#125;</span><br><span class="line">http &#123;</span><br><span class="line">   include       /etc/nginx/mime.types;</span><br><span class="line">   default_type application/octet-stream;</span><br><span class="line">   log_format main  <span class="string">&#x27;$remote_addr - $remote_user [$time_local] &quot;$request&quot; &#x27;</span></span><br><span class="line">                     <span class="string">&#x27;$status $body_bytes_sent &quot;$http_referer&quot; &#x27;</span></span><br><span class="line">                     <span class="string">&#x27;&quot;$http_user_agent&quot; &quot;$http_x_forwarded_for&quot;&#x27;</span>;</span><br><span class="line">   access_log /var/log/nginx/access.log main;</span><br><span class="line">   sendfile       on;</span><br><span class="line">   keepalive_timeout  65;</span><br><span class="line">   include /etc/nginx/conf.d/*.conf;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="启动-Nginx"><a href="#启动-Nginx" class="headerlink" title="启动 Nginx"></a>启动 Nginx</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ~]<span class="comment"># systemctl enable --now nginx</span></span><br><span class="line">Created symlink /etc/systemd/system/multi-user.target.wants/nginx.service → /usr/lib/systemd/system/nginx.service.</span><br><span class="line"></span><br><span class="line">[root@centos8 ~]<span class="comment"># systemctl status nginx</span></span><br><span class="line">● nginx.service - nginx - high performance web server</span><br><span class="line">   Loaded: loaded (/usr/lib/systemd/system/nginx.service; enabled; vendor preset: disabled)</span><br><span class="line">   Active: active (running) since Tue 2020-09-22 12:24:19 CST; 4s ago</span><br><span class="line">     Docs: http://nginx.org/en/docs/</span><br><span class="line">  Process: 24584 ExecStart=/usr/sbin/nginx -c /etc/nginx/nginx.conf (code=exited, status=0/SUCCESS)</span><br><span class="line">  Main PID: 24585 (nginx)</span><br><span class="line">    Tasks: 2 (<span class="built_in">limit</span>: 5882)</span><br><span class="line">    Memory: 2.4M</span><br><span class="line">    CGroup: /system.slice/nginx.service</span><br><span class="line">            ├─24585 nginx: master process /usr/sbin/nginx -c /etc/nginx/nginx.conf</span><br><span class="line">            └─24586 nginx: worker process</span><br><span class="line">Sep 22 12:24:19 centos8.wangxiaochun.com systemd[1]: Starting nginx - high performance web server...</span><br><span class="line">Sep 22 12:24:19 centos8.wangxiaochun.com systemd[1]: Started nginx - high performance web server.</span><br><span class="line"></span><br><span class="line">[root@centos8 ~]<span class="comment"># ps aux|grep nginx</span></span><br><span class="line">root       24585  0.0  0.0  41312   860 ?       Ss   12:24   0:00 nginx: master process /usr/sbin/nginx -c /etc/nginx/nginx.conf</span><br><span class="line">nginx      24586  0.0  0.5  74896  4884 ?       S    12:24   0:00 nginx: worker process</span><br><span class="line">root       24590  0.0  0.1  12108  1088 pts/0   S+   12:24   0:00 grep --color=auto nginx</span><br><span class="line"></span><br><span class="line">[root@centos8 ~]<span class="comment"># pstree -p |grep nginx</span></span><br><span class="line">           |-nginx(24585)---nginx(24586)</span><br></pre></td></tr></table></figure>

<h4 id="访问-Nginx"><a href="#访问-Nginx" class="headerlink" title="访问 Nginx"></a>访问 Nginx</h4><p><img src="../../../../images/SRE/day28/74.jpg" alt="74"></p>
<h3 id="Nginx-编译安装"><a href="#Nginx-编译安装" class="headerlink" title="Nginx 编译安装"></a>Nginx 编译安装</h3><p>Nginx是由C语言编写而成,所以Nginx源码安装需要提前准备标准的编译器GCC（GNU Compiler collection），由GNU开发，并以GPL即LGPL许可，早期GCC原本只能处理C语言，所以原名为GNU C语言编译器，后来得到快速发展，还可以处理C++,Fortran，pascal，objective-C，java以及Ada等其他语言，此外还需要Automake工具，以完成自动创建Makefile文件，Nginx的一些模块需要依赖第三方库，比如: pcre（支持rewrite），zlib（支持gzip模块）和openssl（支持ssl模块）等。</p>
<h4 id="编译安装-Nginx"><a href="#编译安装-Nginx" class="headerlink" title="编译安装 Nginx"></a>编译安装 Nginx</h4><p>官方源码包下载地址：</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://nginx.org/en/download.html</span><br></pre></td></tr></table></figure>

<p>范例: 编译安装</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#安装依赖包</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># yum -y install gcc pcre-devel openssl-devel zlib-devel</span></span><br><span class="line">[root@rocky8 ~]<span class="comment"># yum -y install gcc make gcc-c++ libtool pcre pcre-devel zlib zlib-devel openssl openssl-devel perl-ExtUtils-Embed </span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@ubuntu2004 ~]<span class="comment"># apt -y install gcc make libpcre3 libpcre3-dev openssl libssl-dev zlib1g-dev</span></span><br><span class="line"></span><br><span class="line">[root@centos8 ~]<span class="comment"># useradd -s /sbin/nologin nginx</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># cd /usr/local/src/</span></span><br><span class="line">[root@centos8 src]<span class="comment"># wget http://nginx.org/download/nginx-1.18.0.tar.gz</span></span><br><span class="line">[root@centos8 src]<span class="comment"># tar xf nginx-1.18.0.tar.gz </span></span><br><span class="line">[root@centos8 src]<span class="comment"># cd nginx-1.18.0/</span></span><br><span class="line">[root@centos8 nginx-1.18.0]<span class="comment"># ./configure --prefix=/apps/nginx \</span></span><br><span class="line">--user=nginx \</span><br><span class="line">--group=nginx \</span><br><span class="line">--with-http_ssl_module \</span><br><span class="line">--with-http_v2_module \</span><br><span class="line">--with-http_realip_module \</span><br><span class="line">--with-http_stub_status_module \</span><br><span class="line">--with-http_gzip_static_module \</span><br><span class="line">--with-pcre \</span><br><span class="line">--with-stream \</span><br><span class="line">--with-stream_ssl_module \</span><br><span class="line">--with-stream_realip_module</span><br><span class="line"></span><br><span class="line">[root@centos8 nginx-1.18.0]<span class="comment"># make &amp;&amp; make install</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#修改权限</span></span><br><span class="line">[root@centos8 nginx-1.18.0]<span class="comment"># chown -R nginx.nginx /apps/nginx</span></span><br></pre></td></tr></table></figure>

<p>nginx完成安装以后，有四个主要的目录</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#生成目录</span></span><br><span class="line">[root@centos8 nginx-1.18.0]<span class="comment">#ll /apps/nginx/</span></span><br><span class="line">total 0</span><br><span class="line">drwxr-xr-x 2 root root 333 Sep 22 12:49 conf</span><br><span class="line">drwxr-xr-x 2 root root  40 Sep 22 12:49 html</span><br><span class="line">drwxr-xr-x 2 root root   6 Sep 22 12:49 logs</span><br><span class="line">drwxr-xr-x 2 root root  19 Sep 22 12:49 sbin</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#conf：保存nginx所有的配置文件，其中nginx.conf是nginx服务器的最核心最主要的配置文件，其他的.conf则是用来配置nginx相关的功能的，例如fastcgi功能使用的是fastcgi.conf和fastcgi_params两个文件，配置文件一般都有一个样板配置文件，是以.default为后缀，使用时可将其复制并将default后缀去掉即可。</span></span><br><span class="line"><span class="comment">#html目录中保存了nginx服务器的web文件，但是可以更改为其他目录保存web文件,另外还有一个50x的web文件是默认的错误页面提示页面。</span></span><br><span class="line"><span class="comment">#logs：用来保存nginx服务器的访问日志错误日志等日志，logs目录可以放在其他路径，比如/var/logs/nginx里面。</span></span><br><span class="line"><span class="comment">#sbin：保存nginx二进制启动脚本，可以接受不同的参数以实现不同的功能。</span></span><br></pre></td></tr></table></figure>

<h4 id="验证版本及编译参数"><a href="#验证版本及编译参数" class="headerlink" title="验证版本及编译参数"></a>验证版本及编译参数</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 nginx-1.18.0]<span class="comment"># ls /apps/nginx/sbin/</span></span><br><span class="line">nginx</span><br><span class="line">[root@centos8 nginx-1.18.0]<span class="comment"># ln -s /apps/nginx/sbin/nginx /usr/sbin/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#查看版本</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># nginx -v</span></span><br><span class="line">nginx version: nginx/1.18.0</span><br><span class="line"></span><br><span class="line"><span class="comment">#查看编译参数</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># nginx -V</span></span><br><span class="line">nginx version: nginx/1.18.0</span><br><span class="line">built by gcc 8.3.1 20191121 (Red Hat 8.3.1-5) (GCC) </span><br><span class="line">built with OpenSSL 1.1.1c FIPS  28 May 2019</span><br><span class="line">TLS SNI support enabled</span><br><span class="line">configure arguments: --prefix=/apps/nginx --user=nginx --group=nginx --with-http_ssl_module </span><br><span class="line">--with-http_v2_module --with-http_realip_module --with-http_stub_status_module </span><br><span class="line">--with-http_gzip_static_module --with-pcre --with-stream --with-stream_ssl_module </span><br><span class="line">--with-stream_realip_module</span><br></pre></td></tr></table></figure>

<h4 id="启动和停止-nginx-测试访问-web-界面"><a href="#启动和停止-nginx-测试访问-web-界面" class="headerlink" title="启动和停止 nginx 测试访问 web 界面"></a>启动和停止 nginx 测试访问 web 界面</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#启动nginx</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># nginx</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#浏览器可以访问看到下面图示</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># ss -ntl</span></span><br><span class="line">State             Recv-Q           Send-Q     Local Address:Port   Peer Address:Port   </span><br><span class="line">LISTEN            0                 100             127.0.0.1:25        0.0.0.0:*       </span><br><span class="line">LISTEN            0                 128               0.0.0.0:80        0.0.0.0:*       </span><br><span class="line">LISTEN            0                 128               0.0.0.0:22        0.0.0.0:*       </span><br><span class="line">LISTEN            0                 100                 [::1]:25           [::]:*       </span><br><span class="line">LISTEN            0                 128                  [::]:22           [::]:* </span><br><span class="line"></span><br><span class="line"><span class="comment">#关闭nginx</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># nginx -s stop</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># ss -ntl</span></span><br><span class="line">State             Recv-Q           Send-Q   Local Address:Port   Peer Address:Port     </span><br><span class="line">LISTEN            0                 100           127.0.0.1:25        0.0.0.0:*         </span><br><span class="line">LISTEN            0                 128             0.0.0.0:22        0.0.0.0:*         </span><br><span class="line">LISTEN            0                 100               [::1]:25           [::]:*         </span><br><span class="line">LISTEN            0                 128                [::]:22           [::]:* </span><br></pre></td></tr></table></figure>

<p><img src="../../../../images/SRE/day28/75.jpg" alt="75"></p>
<h4 id="创建-Nginx-自启动文件"><a href="#创建-Nginx-自启动文件" class="headerlink" title="创建 Nginx 自启动文件"></a>创建 Nginx 自启动文件</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#复制同一版本的nginx的yum安装生成的service文件</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># vim /usr/lib/systemd/system/nginx.service </span></span><br><span class="line">[Unit]</span><br><span class="line">Description=nginx - high performance web server</span><br><span class="line">Documentation=http://nginx.org/en/docs/</span><br><span class="line">After=network-online.target remote-fs.target nss-lookup.target</span><br><span class="line">Wants=network-online.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">Type=forking</span><br><span class="line">PIDFile=/apps/nginx/run/nginx.pid <span class="comment">#指定pid文件的目录,默认在logs目录下,可选配置</span></span><br><span class="line">ExecStart=/apps/nginx/sbin/nginx -c /apps/nginx/conf/nginx.conf</span><br><span class="line">ExecReload=/bin/kill -s HUP <span class="variable">$MAINPID</span></span><br><span class="line">ExecStop=/bin/kill -s TERM <span class="variable">$MAINPID</span></span><br><span class="line">LimitNOFILE=100000</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line"></span><br><span class="line"><span class="comment">#创建pid文件存放的目录</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># mkdir /apps/nginx/run/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#修改配置文件</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># vim /apps/nginx/conf/nginx.conf</span></span><br><span class="line">pid   /apps/nginx/run/nginx.pid;</span><br></pre></td></tr></table></figure>

<h4 id="验证-Nginx-自启动文件"><a href="#验证-Nginx-自启动文件" class="headerlink" title="验证 Nginx 自启动文件"></a>验证 Nginx 自启动文件</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ~]<span class="comment"># systemctl daemon-reload </span></span><br><span class="line">[root@centos8 ~]<span class="comment"># systemctl enable --now nginx</span></span><br><span class="line">Created symlink /etc/systemd/system/multi-user.target.wants/nginx.service →       </span><br><span class="line">       </span><br><span class="line">[root@centos8 ~]<span class="comment"># ll /apps/nginx/run/</span></span><br><span class="line">total 4</span><br><span class="line">-rw-r--r-- 1 root root 5 Sep 22 13:01 nginx.pid</span><br><span class="line"></span><br><span class="line">[root@centos8 ~]<span class="comment"># ss -ntl</span></span><br><span class="line">State             Recv-Q           Send-Q Local Address:Port   Peer Address:Port       </span><br><span class="line">LISTEN            0                 100         127.0.0.1:25          0.0.0.0:*</span><br><span class="line">LISTEN            0                 128           0.0.0.0:80          0.0.0.0:* </span><br><span class="line">LISTEN            0                 128           0.0.0.0:22          0.0.0.0:*          </span><br><span class="line">LISTEN            0                 100             [::1]:25             [::]:*           </span><br><span class="line">LISTEN            0                 128              [::]:22             [::]:* </span><br><span class="line"></span><br><span class="line">[root@centos8 ~]<span class="comment"># systemctl stop nginx</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># systemctl status nginx</span></span><br><span class="line">Active: inactive (dead) since Tue 2020-09-22 13:01:49 CST; 1s ago</span><br></pre></td></tr></table></figure>

<h3 id="自动化部署-nginx"><a href="#自动化部署-nginx" class="headerlink" title="自动化部署 nginx"></a>自动化部署 nginx</h3><h4 id="实战案例-一键安装-nginx-脚本"><a href="#实战案例-一键安装-nginx-脚本" class="headerlink" title="实战案例: 一键安装 nginx 脚本"></a>实战案例: 一键安装 nginx 脚本</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line">NGINX_FILE=nginx-1.20.2</span><br><span class="line"><span class="comment">#NGINX_FILE=nginx-1.18.0</span></span><br><span class="line">NGINX_URL=http://nginx.org/download/</span><br><span class="line">TAR=.tar.gz</span><br><span class="line">SRC_DIR=/usr/local/src</span><br><span class="line">NGINX_INSTALL_DIR=/apps/nginx</span><br><span class="line">CPUS=`lscpu |awk <span class="string">&#x27;/^CPU\(s\)/&#123;print $2&#125;&#x27;</span>`</span><br><span class="line">. /etc/os-release</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">color</span></span> () &#123;</span><br><span class="line">    RES_COL=60</span><br><span class="line">    MOVE_TO_COL=<span class="string">&quot;echo -en \\033[<span class="variable">$&#123;RES_COL&#125;</span>G&quot;</span></span><br><span class="line">    SETCOLOR_SUCCESS=<span class="string">&quot;echo -en \\033[1;32m&quot;</span></span><br><span class="line">    SETCOLOR_FAILURE=<span class="string">&quot;echo -en \\033[1;31m&quot;</span></span><br><span class="line">    SETCOLOR_WARNING=<span class="string">&quot;echo -en \\033[1;33m&quot;</span></span><br><span class="line">    SETCOLOR_NORMAL=<span class="string">&quot;echo -en \E[0m&quot;</span></span><br><span class="line">    <span class="built_in">echo</span> -n <span class="string">&quot;<span class="variable">$1</span>&quot;</span> &amp;&amp; <span class="variable">$MOVE_TO_COL</span></span><br><span class="line">    <span class="built_in">echo</span> -n <span class="string">&quot;[&quot;</span></span><br><span class="line">    <span class="keyword">if</span> [ <span class="variable">$2</span> = <span class="string">&quot;success&quot;</span> -o <span class="variable">$2</span> = <span class="string">&quot;0&quot;</span> ] ;<span class="keyword">then</span></span><br><span class="line">        <span class="variable">$&#123;SETCOLOR_SUCCESS&#125;</span></span><br><span class="line">        <span class="built_in">echo</span> -n $<span class="string">&quot; OK &quot;</span>    </span><br><span class="line">    <span class="keyword">elif</span> [ <span class="variable">$2</span> = <span class="string">&quot;failure&quot;</span> -o <span class="variable">$2</span> = <span class="string">&quot;1&quot;</span> ] ;<span class="keyword">then</span> </span><br><span class="line">        <span class="variable">$&#123;SETCOLOR_FAILURE&#125;</span></span><br><span class="line">        <span class="built_in">echo</span> -n $<span class="string">&quot;FAILED&quot;</span></span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="variable">$&#123;SETCOLOR_WARNING&#125;</span></span><br><span class="line">        <span class="built_in">echo</span> -n $<span class="string">&quot;WARNING&quot;</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line">    <span class="variable">$&#123;SETCOLOR_NORMAL&#125;</span></span><br><span class="line">    <span class="built_in">echo</span> -n <span class="string">&quot;]&quot;</span></span><br><span class="line">    <span class="built_in">echo</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">check</span></span> () &#123;</span><br><span class="line">    [ -e <span class="variable">$&#123;NGINX_INSTALL_DIR&#125;</span> ] &amp;&amp; &#123; color <span class="string">&quot;nginx 已安装,请卸载后再安装&quot;</span> 1; <span class="built_in">exit</span>; &#125;</span><br><span class="line">    <span class="built_in">cd</span>  <span class="variable">$&#123;SRC_DIR&#125;</span></span><br><span class="line">    <span class="keyword">if</span> [  -e <span class="variable">$&#123;NGINX_FILE&#125;</span><span class="variable">$&#123;TAR&#125;</span> ];<span class="keyword">then</span></span><br><span class="line">       color <span class="string">&quot;相关文件已准备好&quot;</span> 0</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">       color <span class="string">&#x27;开始下载 nginx 源码包&#x27;</span> 0</span><br><span class="line">       wget <span class="variable">$&#123;NGINX_URL&#125;</span><span class="variable">$&#123;NGINX_FILE&#125;</span><span class="variable">$&#123;TAR&#125;</span></span><br><span class="line">       [ $? -ne 0 ] &amp;&amp; &#123; color <span class="string">&quot;下载 <span class="variable">$&#123;NGINX_FILE&#125;</span><span class="variable">$&#123;TAR&#125;</span>文件失败&quot;</span> 1; <span class="built_in">exit</span>; &#125; </span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line">&#125; </span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">install</span></span> () &#123;</span><br><span class="line">    color <span class="string">&quot;开始安装 nginx&quot;</span> 0</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">id</span> nginx &amp;&gt; /dev/null;<span class="keyword">then</span></span><br><span class="line">       color <span class="string">&quot;nginx 用户已存在&quot;</span> 1</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">       useradd -s /sbin/nologin -r nginx</span><br><span class="line">       color <span class="string">&quot;创建 nginx 用户&quot;</span> 0</span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line">    color <span class="string">&quot;开始安装 nginx 依赖包&quot;</span> 0</span><br><span class="line">    <span class="keyword">if</span> [ <span class="variable">$ID</span> == <span class="string">&quot;centos&quot;</span> ] ;<span class="keyword">then</span></span><br><span class="line">        <span class="keyword">if</span> [[ <span class="variable">$VERSION_ID</span> =~ ^7 ]];<span class="keyword">then</span></span><br><span class="line">            yum -y -q install make gcc pcre-devel openssl-devel zlib-devel perl-ExtUtils-Embed</span><br><span class="line">        <span class="keyword">elif</span> [[ <span class="variable">$VERSION_ID</span> =~ ^8 ]];<span class="keyword">then</span></span><br><span class="line">            yum -y -q install make gcc-c++ libtool pcre pcre-devel zlib zlib-devel openssl openssl-devel perl-ExtUtils-Embed </span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            color <span class="string">&#x27;不支持此系统!&#x27;</span>  1</span><br><span class="line">            <span class="built_in">exit</span></span><br><span class="line">        <span class="keyword">fi</span></span><br><span class="line">    <span class="keyword">elif</span> [ <span class="variable">$ID</span> == <span class="string">&quot;rocky&quot;</span> ];<span class="keyword">then</span> </span><br><span class="line">        yum -y -q install make gcc-c++ libtool pcre pcre-devel zlib zlib-devel openssl openssl-devel perl-ExtUtils-Embed </span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        apt update &amp;&gt; /dev/null</span><br><span class="line">        apt -y install make gcc libpcre3 libpcre3-dev openssl libssl-dev zlib1gdev &amp;&gt; /dev/null</span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line">    <span class="built_in">cd</span> <span class="variable">$SRC_DIR</span></span><br><span class="line">    tar xf <span class="variable">$&#123;NGINX_FILE&#125;</span><span class="variable">$&#123;TAR&#125;</span></span><br><span class="line">    NGINX_DIR=`<span class="built_in">echo</span> <span class="variable">$&#123;NGINX_FILE&#125;</span><span class="variable">$&#123;TAR&#125;</span>| sed -nr <span class="string">&#x27;s/^(.*[0-9]).*/\1/p&#x27;</span>`</span><br><span class="line">    <span class="built_in">cd</span> <span class="variable">$&#123;NGINX_DIR&#125;</span></span><br><span class="line">   ./configure --prefix=<span class="variable">$&#123;NGINX_INSTALL_DIR&#125;</span> --user=nginx --group=nginx --with-http_ssl_module --with-http_v2_module --with-http_realip_module --with-http_stub_status_module --with-http_gzip_static_module --with-pcre --with-stream --with-stream_ssl_module --with-stream_realip_module</span><br><span class="line">   make -j <span class="variable">$CPUS</span> &amp;&amp; make install </span><br><span class="line">   [ $? -eq 0 ] &amp;&amp; color <span class="string">&quot;nginx 编译安装成功&quot;</span> 0 || &#123; color <span class="string">&quot;nginx 编译安装失败,退出!&quot;</span> 1 ;<span class="built_in">exit</span>; &#125;</span><br><span class="line">   <span class="built_in">echo</span> <span class="string">&quot;PATH=<span class="variable">$&#123;NGINX_INSTALL_DIR&#125;</span>/sbin:<span class="variable">$&#123;PATH&#125;</span>&quot;</span> &gt; /etc/profile.d/nginx.sh</span><br><span class="line">   <span class="built_in">chown</span> -R nginx.nginx <span class="variable">$&#123;NGINX_INSTALL_DIR&#125;</span></span><br><span class="line">   </span><br><span class="line">   <span class="built_in">cat</span> &gt; /lib/systemd/system/nginx.service &lt;&lt;<span class="string">EOF</span></span><br><span class="line"><span class="string">[Unit]</span></span><br><span class="line"><span class="string">Description=The nginx HTTP and reverse proxy server</span></span><br><span class="line"><span class="string">After=network.target remote-fs.target nss-lookup.target</span></span><br><span class="line"><span class="string">[Service]</span></span><br><span class="line"><span class="string">Type=forking</span></span><br><span class="line"><span class="string">PIDFile=$&#123;NGINX_INSTALL_DIR&#125;/logs/nginx.pid</span></span><br><span class="line"><span class="string">ExecStartPre=/bin/rm -f $&#123;NGINX_INSTALL_DIR&#125;/logs/nginx.pid</span></span><br><span class="line"><span class="string">ExecStartPre=$&#123;NGINX_INSTALL_DIR&#125;/sbin/nginx -t</span></span><br><span class="line"><span class="string">ExecStart=$&#123;NGINX_INSTALL_DIR&#125;/sbin/nginx</span></span><br><span class="line"><span class="string">ExecReload=/bin/kill -s HUP \$MAINPID</span></span><br><span class="line"><span class="string">KillSignal=SIGQUIT</span></span><br><span class="line"><span class="string">TimeoutStopSec=5</span></span><br><span class="line"><span class="string">KillMode=process</span></span><br><span class="line"><span class="string">PrivateTmp=true</span></span><br><span class="line"><span class="string">LimitNOFILE=100000</span></span><br><span class="line"><span class="string">[Install]</span></span><br><span class="line"><span class="string">WantedBy=multi-user.target</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"></span><br><span class="line">   systemctl daemon-reload</span><br><span class="line">   systemctl <span class="built_in">enable</span> --now nginx &amp;&gt; /dev/null </span><br><span class="line">   systemctl is-active nginx &amp;&gt; /dev/null || &#123; color <span class="string">&quot;nginx 启动失败,退出!&quot;</span> 1 ; <span class="built_in">exit</span>; &#125;</span><br><span class="line">   color <span class="string">&quot;nginx 安装完成&quot;</span> 0</span><br><span class="line">&#125;</span><br><span class="line">check</span><br><span class="line">install</span><br></pre></td></tr></table></figure>

<h4 id="利用-ansible-的playbook-实现-nginx-编译安装"><a href="#利用-ansible-的playbook-实现-nginx-编译安装" class="headerlink" title="利用 ansible 的playbook 实现 nginx 编译安装"></a>利用 ansible 的playbook 实现 nginx 编译安装</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br></pre></td><td class="code"><pre><span class="line">[<span class="string">root@centos8</span> <span class="string">~</span>]<span class="comment">#cat nginx_install.yml</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">webservers</span></span><br><span class="line"> <span class="attr">remote_user:</span> <span class="string">root</span></span><br><span class="line"> <span class="attr">gather_facts:</span> <span class="literal">yes</span></span><br><span class="line"> <span class="attr">vars:</span></span><br><span class="line">   <span class="attr">nginx_verison:</span> <span class="string">nginx-1.18.0</span></span><br><span class="line">   <span class="attr">suffix:</span> <span class="string">.tar.gz</span></span><br><span class="line">   <span class="attr">down_dir:</span> <span class="string">/usr/local/src/</span></span><br><span class="line">   <span class="attr">ins_dir:</span> <span class="string">/apps/nginx/</span></span><br><span class="line">   <span class="attr">user:</span> <span class="string">nginx</span></span><br><span class="line">   <span class="attr">group:</span> <span class="string">nginx</span></span><br><span class="line"> <span class="attr">tasks:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">install</span> <span class="string">packages</span> <span class="string">on</span> <span class="string">centos8</span></span><br><span class="line">     <span class="attr">yum:</span></span><br><span class="line">       <span class="attr">name:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">gcc</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">make</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">pcre-devel</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">openssl-devel</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">zlib-devel</span></span><br><span class="line">       <span class="attr">state:</span> <span class="string">present</span></span><br><span class="line">     <span class="attr">when:</span> </span><br><span class="line">        <span class="bullet">-</span> <span class="string">ansible_facts[&#x27;distribution&#x27;]</span> <span class="string">==</span> <span class="string">&quot;CentOS&quot;</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">ansible_facts[&#x27;distribution_major_version&#x27;]</span> <span class="string">==</span> <span class="string">&quot;8&quot;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">install</span> <span class="string">packages</span> <span class="string">on</span> <span class="string">centos7</span></span><br><span class="line">     <span class="attr">yum:</span></span><br><span class="line">       <span class="attr">name:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">gcc</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">make</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">pcre-devel</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">openssl-devel</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">zlib-devel</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">perl-ExtUtils-Embed</span></span><br><span class="line">       <span class="attr">state:</span> <span class="string">present</span></span><br><span class="line">     <span class="attr">when:</span> </span><br><span class="line">        <span class="bullet">-</span> <span class="string">ansible_facts[&#x27;distribution&#x27;]</span> <span class="string">==</span> <span class="string">&quot;CentOS&quot;</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">ansible_facts[&#x27;distribution_major_version&#x27;]</span> <span class="string">==</span> <span class="string">&quot;7&quot;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">install</span> <span class="string">packages</span> <span class="string">on</span> <span class="string">ubuntu18.04</span></span><br><span class="line">     <span class="attr">apt:</span></span><br><span class="line">       <span class="attr">name:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">gcc</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">make</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">libpcre3</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">libpcre3-dev</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">openssl</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">libssl-dev</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">zlib1g-dev</span></span><br><span class="line">       <span class="attr">state:</span> <span class="string">present</span></span><br><span class="line">     <span class="attr">when:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">ansible_facts[&#x27;distribution&#x27;]</span> <span class="string">==</span> <span class="string">&quot;Ubuntu&quot;</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">ansible_facts[&#x27;distribution_major_version&#x27;]</span> <span class="string">==</span> <span class="string">&quot;18&quot;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">group</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; group &#125;&#125;</span>&quot;</span></span><br><span class="line">     <span class="attr">group:</span> <span class="string">name=&#123;&#123;</span> <span class="string">group</span> <span class="string">&#125;&#125;</span> <span class="string">state=present</span> <span class="string">system=yes</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">user</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; user &#125;&#125;</span>&quot;</span></span><br><span class="line">     <span class="attr">user:</span></span><br><span class="line">       <span class="attr">name:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; user &#125;&#125;</span>&quot;</span></span><br><span class="line">       <span class="attr">shell:</span> <span class="string">/sbin/nologin</span></span><br><span class="line">       <span class="attr">system:</span> <span class="literal">yes</span></span><br><span class="line">       <span class="attr">group:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; group &#125;&#125;</span>&quot;</span></span><br><span class="line">       <span class="attr">home:</span> <span class="string">&quot;/home/<span class="template-variable">&#123;&#123; user &#125;&#125;</span>&quot;</span></span><br><span class="line">       <span class="attr">create_home:</span> <span class="literal">no</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">unarchive</span></span><br><span class="line">     <span class="attr">unarchive:</span></span><br><span class="line">       <span class="attr">src:</span> <span class="string">&quot;http://nginx.org/download/<span class="template-variable">&#123;&#123; nginx_verison &#125;&#125;</span><span class="template-variable">&#123;&#123; suffix &#125;&#125;</span>&quot;</span></span><br><span class="line">       <span class="attr">dest:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; down_dir &#125;&#125;</span>&quot;</span></span><br><span class="line">       <span class="attr">remote_src:</span> <span class="literal">yes</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">configure</span></span><br><span class="line">     <span class="attr">shell:</span> <span class="string">./configure</span> <span class="string">\</span></span><br><span class="line">                <span class="string">--prefix=&#123;&#123;</span> <span class="string">ins_dir</span> <span class="string">&#125;&#125;</span> <span class="string">\</span></span><br><span class="line">                <span class="string">--user=&#123;&#123;</span> <span class="string">user</span> <span class="string">&#125;&#125;</span> <span class="string">--group=&#123;&#123;</span> <span class="string">group</span> <span class="string">&#125;&#125;</span> <span class="string">\</span></span><br><span class="line">                <span class="string">--with-http_ssl_module</span> <span class="string">\</span></span><br><span class="line">                <span class="string">--with-http_realip_module</span> <span class="string">\</span></span><br><span class="line">                <span class="string">--with-http_v2_module</span> <span class="string">\</span></span><br><span class="line">                <span class="string">--with-http_stub_status_module</span> <span class="string">\</span></span><br><span class="line">                <span class="string">--with-http_gzip_static_module</span> <span class="string">\</span></span><br><span class="line">                <span class="string">--with-pcre</span> <span class="string">\</span></span><br><span class="line">                <span class="string">--with-stream</span> <span class="string">\</span></span><br><span class="line">                <span class="string">--with-stream_ssl_module</span> <span class="string">\</span></span><br><span class="line">                <span class="string">--with-stream_realip_module</span></span><br><span class="line">     <span class="attr">args:</span></span><br><span class="line">       <span class="attr">chdir:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; down_dir &#125;&#125;</span><span class="template-variable">&#123;&#123; nginx_verison &#125;&#125;</span>/&quot;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">make</span></span><br><span class="line">     <span class="attr">shell:</span> <span class="string">make</span> <span class="string">-j</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; ansible_processor_vcpus &#125;&#125;</span>&quot;</span> <span class="string">&amp;&amp;</span> <span class="string">make</span> <span class="string">install</span></span><br><span class="line">     <span class="attr">args:</span></span><br><span class="line">       <span class="attr">chdir:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; down_dir &#125;&#125;</span><span class="template-variable">&#123;&#123; nginx_verison &#125;&#125;</span>/&quot;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">link</span></span><br><span class="line">     <span class="attr">file:</span></span><br><span class="line">       <span class="attr">src:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; ins_dir &#125;&#125;</span>sbin/nginx&quot;</span></span><br><span class="line">       <span class="attr">dest:</span> <span class="string">/usr/sbin/nginx</span></span><br><span class="line">       <span class="attr">state:</span> <span class="string">link</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">service</span> <span class="string">file</span></span><br><span class="line">     <span class="attr">copy:</span> <span class="string">content=&#x27;[Unit]\nDescription=nginx</span> <span class="bullet">-</span> <span class="string">high</span> <span class="string">performance</span> <span class="string">web</span> <span class="string">server\nDocumentation=http://nginx.org/en/docs/\nAfter=network-online.target</span> <span class="string">remote-fs.target</span> <span class="string">nss-lookup.target\nWants=network-online.target\n\n[Service]\nType=forking\nPIDFile=&#123;&#123;</span> <span class="string">ins_dir</span> <span class="string">&#125;&#125;run/nginx.pid\nExecStart=/usr/sbin/nginx</span> <span class="string">-c</span> &#123;&#123; <span class="string">ins_dir</span> &#125;&#125;<span class="string">conf//nginx.conf\nExecReload=/bin/sh</span> <span class="string">-c</span> <span class="string">&quot;/bin/kill -s HUP $(/bin/cat <span class="template-variable">&#123;&#123; ins_dir &#125;&#125;</span>run/nginx.pid)&quot;</span><span class="string">\nExecStop=/bin/sh</span> <span class="string">-c</span> <span class="string">&quot;/bin/kill -s TERM $(/bin/cat <span class="template-variable">&#123;&#123; ins_dir &#125;&#125;</span>run/nginx.pid)&quot;</span><span class="string">\nLimitNOFILE=100000\n[Install]\nWantedBy=multi-user.target&#x27;</span></span><br><span class="line"><span class="string">dest=/lib/systemd/system/nginx.service</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">change</span> <span class="string">configure</span> <span class="string">pid</span> <span class="string">location</span> <span class="string">and</span> <span class="string">change</span> <span class="string">worker_processes</span></span><br><span class="line">     <span class="attr">lineinfile:</span></span><br><span class="line">       <span class="attr">path:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; item.path &#125;&#125;</span>&quot;</span></span><br><span class="line">       <span class="attr">regexp:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; item.regexp &#125;&#125;</span>&quot;</span></span><br><span class="line">       <span class="attr">line:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; item.line &#125;&#125;</span>&quot;</span></span><br><span class="line">     <span class="attr">with_items:</span></span><br><span class="line">        <span class="bullet">-</span> &#123; <span class="attr">path:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; ins_dir &#125;&#125;</span>conf/nginx.conf&quot;</span>,<span class="attr">regexp:</span> </span><br><span class="line"><span class="string">&#x27;^worker_processes&#x27;</span>,<span class="attr">line:</span> <span class="string">&quot;worker_processes <span class="template-variable">&#123;&#123; ansible_processor_vcpus &#125;&#125;</span>;&quot;</span> &#125;</span><br><span class="line">        <span class="bullet">-</span> &#123; <span class="attr">path:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; ins_dir &#125;&#125;</span>conf/nginx.conf&quot;</span>,<span class="attr">regexp:</span> <span class="string">&#x27;^#pid&#x27;</span>,<span class="attr">line:</span> <span class="string">&#x27;pid     </span></span><br><span class="line"><span class="string">  run/nginx.pid;&#x27;</span> &#125;</span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">create</span> <span class="string">dir</span> <span class="string">run</span> <span class="string">and</span> <span class="string">modify</span> <span class="string">directory</span> <span class="string">permission</span></span><br><span class="line">     <span class="attr">file:</span> </span><br><span class="line">       <span class="attr">path:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; ins_dir &#125;&#125;</span>run&quot;</span></span><br><span class="line">       <span class="attr">owner:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; user &#125;&#125;</span>&quot;</span></span><br><span class="line">       <span class="attr">group:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; group &#125;&#125;</span>&quot;</span></span><br><span class="line">       <span class="attr">state:</span> <span class="string">directory</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">start</span> <span class="string">serivce</span></span><br><span class="line">      <span class="attr">service:</span> </span><br><span class="line">       <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">       <span class="attr">state:</span> <span class="string">started</span></span><br><span class="line">       <span class="attr">enabled:</span> <span class="literal">yes</span></span><br></pre></td></tr></table></figure>

<h4 id="利用-ansible-的role-实现-nginx-编译安装"><a href="#利用-ansible-的role-实现-nginx-编译安装" class="headerlink" title="利用 ansible 的role 实现 nginx 编译安装"></a>利用 ansible 的role 实现 nginx 编译安装</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 nginx_ansible]<span class="comment">#tree</span></span><br><span class="line">.</span><br><span class="line">├── ansible.cfg</span><br><span class="line">├── hosts</span><br><span class="line">├── install_nginx.yml</span><br><span class="line">└── roles</span><br><span class="line">   └── nginx</span><br><span class="line">       ├── handlers</span><br><span class="line">       │   └── main.yml</span><br><span class="line">       ├── tasks</span><br><span class="line">       │   ├── config.yml</span><br><span class="line">       │   ├── group.yml</span><br><span class="line">       │   ├── install.yml</span><br><span class="line">       │   ├── main.yml</span><br><span class="line">       │   ├── package.yml</span><br><span class="line">       │   ├── service.yml</span><br><span class="line">       │   ├── unarchive.yml</span><br><span class="line">       │   ├── unit.yml</span><br><span class="line">       │   └── user.yml</span><br><span class="line">       ├── templates</span><br><span class="line">       │   ├── nginx.conf.j2</span><br><span class="line">       │   └── nginx.service.j2</span><br><span class="line">       └── vars</span><br><span class="line">           └── main.yml</span><br><span class="line">6 directories, 16 files</span><br><span class="line"></span><br><span class="line">[root@centos8 nginx_ansible]<span class="comment"># cat hosts </span></span><br><span class="line">[<span class="built_in">local</span>]</span><br><span class="line">10.0.0.8 ansible_connection=<span class="built_in">local</span></span><br><span class="line">[dnsservers]</span><br><span class="line">10.0.0.10</span><br><span class="line">[webservers]</span><br><span class="line">10.0.0.7</span><br><span class="line">10.0.0.18</span><br><span class="line">10.0.0.100</span><br><span class="line">10.0.0.152</span><br><span class="line">[web8servers]</span><br><span class="line">10.0.0.18</span><br><span class="line">10.0.0.28</span><br><span class="line">10.0.0.38</span><br><span class="line">10.0.0.48</span><br><span class="line">10.0.0.58</span><br><span class="line">[web7servers]</span><br><span class="line">10.0.0.7</span><br><span class="line">10.0.0.17</span><br><span class="line">10.0.0.27</span><br><span class="line">10.0.0.37</span><br><span class="line"></span><br><span class="line">[root@centos8 nginx_ansible]<span class="comment"># cat roles/nginx/vars/main.yml </span></span><br><span class="line">nginx_version: 1.18.0</span><br><span class="line">nginx_url: http://nginx.org/download</span><br><span class="line">nginx_full_name: nginx-&#123;&#123; nginx_version &#125;&#125;.tar.gz</span><br><span class="line">nginx_src: /usr/local/src</span><br><span class="line">nginx_install_dir: /usr/local/nginx</span><br><span class="line">user_name: nginx</span><br><span class="line">group_name: nginx</span><br><span class="line">centos7_packages: [ make,gcc,pcre-devel,openssl-devel,zlib-devel,perl-ExtUtils-Embed ] </span><br><span class="line">centos8_packages: [ make,gcc-c++,libtool,pcre,pcre-devel,zlib,zlib-devel,openssl,openssl-devel,perl-ExtUtils-Embed ]</span><br><span class="line">ubuntu_packages: [ make,gcc,libpcre3,libpcre3-dev,openssl,libssl-dev,zlib1g-dev ]</span><br><span class="line"></span><br><span class="line">[root@centos8 nginx_ansible]<span class="comment"># grep -Ev &quot;#|^$&quot; roles/nginx/templates/nginx.conf.j2</span></span><br><span class="line">user &#123;&#123; user_name &#125;&#125; &#123;&#123; group_name &#125;&#125;;</span><br><span class="line">worker_processes &#123;&#123; ansible_processor_vcpus &#125;&#125;;</span><br><span class="line">events &#123;</span><br><span class="line">   worker_connections  1024;</span><br><span class="line">&#125;</span><br><span class="line">http &#123;</span><br><span class="line">   include       mime.types;</span><br><span class="line">   default_type application/octet-stream;</span><br><span class="line">   sendfile       on;</span><br><span class="line">   keepalive_timeout  65;</span><br><span class="line">   server &#123;</span><br><span class="line">       listen       80;</span><br><span class="line">       server_name localhost;</span><br><span class="line">       location / &#123;</span><br><span class="line">           root   html;</span><br><span class="line">           index index.html index.htm;</span><br><span class="line">       &#125;</span><br><span class="line">       error_page   500 502 503 504 /50x.html;</span><br><span class="line">       location = /50x.html &#123;</span><br><span class="line">           root   html;</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">[root@centos8 nginx_ansible]<span class="comment"># grep -Ev &quot;#|^$&quot; roles/nginx/templates/nginx.service.j2 </span></span><br><span class="line">[Unit]</span><br><span class="line">Description=nginx - high performance web server</span><br><span class="line">Documentation=http://nginx.org/en/docs/</span><br><span class="line">After=network-online.target remote-fs.target nss-lookup.target</span><br><span class="line">Wants=network-online.target</span><br><span class="line">[Service]</span><br><span class="line">Type=forking</span><br><span class="line">PIDFile=&#123;&#123; nginx_install_dir &#125;&#125;/logs/nginx.pid</span><br><span class="line">ExecStart=&#123;&#123; nginx_install_dir &#125;&#125;/sbin/nginx -c &#123;&#123; nginx_install_dir </span><br><span class="line">&#125;&#125;/conf/nginx.conf</span><br><span class="line">ExecReload=/bin/kill -s HUP <span class="variable">$MAINPID</span></span><br><span class="line">ExecStop=/bin/kill -s TERM <span class="variable">$MAINPID</span></span><br><span class="line">LimitNOFILE=100000</span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line"></span><br><span class="line">[root@centos8 nginx_ansible]<span class="comment"># grep -Ev &quot;#|^$&quot; roles/nginx/handlers/main.yml </span></span><br><span class="line">- name: restart nginx</span><br><span class="line">  service: name=nginx state=restarted </span><br><span class="line">  </span><br><span class="line">[root@centos8 nginx_ansible]<span class="comment"># cat roles/nginx/tasks/main.yml </span></span><br><span class="line">- include: group.yml</span><br><span class="line">- include: user.yml</span><br><span class="line">- include: package.yml</span><br><span class="line">- include: unarchive.yml</span><br><span class="line">- include: install.yml</span><br><span class="line">- include: unit.yml</span><br><span class="line">- include: config.yml</span><br><span class="line">- include: service.yml</span><br><span class="line"></span><br><span class="line">[root@centos8 nginx_ansible]<span class="comment"># cat roles/nginx/tasks/group.yml </span></span><br><span class="line">- name: create &#123;&#123; group_name &#125;&#125; group</span><br><span class="line"> group: name=&#123;&#123; group_name &#125;&#125; system=<span class="built_in">yes</span></span><br><span class="line"> </span><br><span class="line">[root@centos8 nginx_ansible]<span class="comment"># cat roles/nginx/tasks/user.yml </span></span><br><span class="line">- name: create &#123;&#123; user_name &#125;&#125; user</span><br><span class="line">  user: name=&#123;&#123; user_name &#125;&#125; system=<span class="built_in">yes</span> group=&#123;&#123; group_name &#125;&#125; shell=/sbin/nologin</span><br><span class="line">  </span><br><span class="line">[root@centos8 nginx_ansible]<span class="comment"># cat roles/nginx/tasks/package.yml </span></span><br><span class="line">- name: yum nginx dependence packages to centos7</span><br><span class="line">  yum: name=&#123;&#123; centos7_packages &#125;&#125;</span><br><span class="line">  when: ansible_distribution_major_version == <span class="string">&quot;7&quot;</span></span><br><span class="line">- name: yum nginx dependence packages to centos8</span><br><span class="line">  yum: name=&#123;&#123; centos8_packages &#125;&#125;</span><br><span class="line">  when: ansible_distribution_major_version == <span class="string">&quot;8&quot;</span></span><br><span class="line">- name: apt nginx dependence packages to ubuntu</span><br><span class="line">  apt: name=&#123;&#123; ubuntu_packages &#125;&#125;</span><br><span class="line">  when: ansible_os_family == <span class="string">&quot;Debian&quot;</span></span><br><span class="line">- name: download &#123;&#123; nginx_full_name &#125;&#125;</span><br><span class="line">  get_url: url=&#123;&#123; nginx_url &#125;&#125;/&#123;&#123; nginx_full_name &#125;&#125; dest=&#123;&#123; nginx_src &#125;&#125;</span><br><span class="line"></span><br><span class="line">[root@centos8 nginx_ansible]<span class="comment"># cat roles/nginx/tasks/unarchive.yml </span></span><br><span class="line">- name: unarchive &#123;&#123; nginx_full_name &#125;&#125;</span><br><span class="line">  unarchive: src=&#123;&#123; nginx_src &#125;&#125;/&#123;&#123; nginx_full_name &#125;&#125; dest=&#123;&#123; nginx_src &#125;&#125; copy=no</span><br><span class="line">  </span><br><span class="line">[root@centos8 nginx_ansible]<span class="comment"># cat roles/nginx/tasks/install.yml </span></span><br><span class="line">- name: configure</span><br><span class="line"> shell: </span><br><span class="line">   ./configure \</span><br><span class="line">    --prefix=&#123;&#123; nginx_install_dir &#125;&#125; \</span><br><span class="line">    --user=nginx --group=nginx \</span><br><span class="line">    --with-http_ssl_module \</span><br><span class="line">    --with-http_v2_module \</span><br><span class="line">    --with-http_realip_module \</span><br><span class="line">    --with-http_stub_status_module \</span><br><span class="line">    --with-http_gzip_static_module \</span><br><span class="line">    --with-pcre \</span><br><span class="line">    --with-stream \</span><br><span class="line">    --with-stream_ssl_module \</span><br><span class="line">    --with-stream_realip_module</span><br><span class="line"> args:</span><br><span class="line">   <span class="built_in">chdir</span>: <span class="string">&quot;&#123;&#123; nginx_src &#125;&#125;/nginx-&#123;&#123; nginx_version &#125;&#125;&quot;</span></span><br><span class="line"> - name: make &amp;&amp; make install</span><br><span class="line">   shell: make -j &#123;&#123; ansible_processor_vcpus &#125;&#125; &amp;&amp; make install</span><br><span class="line">   args:</span><br><span class="line">     <span class="built_in">chdir</span>: <span class="string">&quot;&#123;&#123; nginx_src &#125;&#125;/nginx-&#123;&#123; nginx_version &#125;&#125;&quot;</span></span><br><span class="line"> - name: add nginx to profile</span><br><span class="line">   copy: content=PATH=&#123;&#123; nginx_install_dir &#125;&#125;/sbin:&#123;&#123; ansible_env.PATH &#125;&#125; dest=/etc/profile.d/nginx.sh</span><br><span class="line">   </span><br><span class="line">[root@centos8 nginx_ansible]<span class="comment"># cat roles/nginx/tasks/unit.yml </span></span><br><span class="line">- name: copy nginx.service to centos</span><br><span class="line">  template: src=nginx.service.j2 dest=/usr/lib/systemd/system/nginx.service</span><br><span class="line">  when: ansible_os_family == <span class="string">&quot;RedHat&quot;</span></span><br><span class="line">- name: copy nginx.service to ubuntu</span><br><span class="line">  template: src=nginx.service.j2 dest=/lib/systemd/system/nginx.service</span><br><span class="line">  when: ansible_os_family == <span class="string">&quot;Debian&quot;</span></span><br><span class="line">- name: reload systemd manager configuration </span><br><span class="line">  shell: systemctl daemon-reload</span><br><span class="line"></span><br><span class="line">[root@centos8 nginx_ansible]<span class="comment"># cat roles/nginx/tasks/config.yml </span></span><br><span class="line">- name: template config to remote hosts</span><br><span class="line">  template: src=nginx.conf.j2 dest=&#123;&#123; nginx_install_dir &#125;&#125;/conf/nginx.conf</span><br><span class="line">  notify: </span><br><span class="line">    - restart nginx</span><br><span class="line">    </span><br><span class="line">[root@centos8 nginx_ansible]<span class="comment"># cat roles/nginx/tasks/service.yml </span></span><br><span class="line">- name: start nginx.service</span><br><span class="line">  service: name=nginx state=started enabled=<span class="built_in">yes</span></span><br></pre></td></tr></table></figure>

<h2 id="nginx-命令和信号"><a href="#nginx-命令和信号" class="headerlink" title="nginx 命令和信号"></a>nginx 命令和信号</h2><h3 id="nginx-命令"><a href="#nginx-命令" class="headerlink" title="nginx 命令"></a>nginx 命令</h3><p>nginx 命令支持向其发送信号,实现不同功能</p>
<p>nginx 格式</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nginx [-?hvVtTq] [-s signal] [-c filename] [-p prefix] [-g directives]</span><br></pre></td></tr></table></figure>

<p>选项说明</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">帮助: -? -h</span><br><span class="line">使用指定的配置文件: -c</span><br><span class="line">指定配置指令:-g</span><br><span class="line">指定运行目录:-p</span><br><span class="line">测试配置文件是否有语法错误:-t -T</span><br><span class="line">打印nginx的版本信息、编译信息等:-v -V</span><br><span class="line">发送信号: -s 示例: nginx -s reload</span><br></pre></td></tr></table></figure>

<p>信号说明:</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">立刻停止服务:stop,相当于信号SIGTERM,SIGINT</span><br><span class="line">优雅的停止服务:quit,相当于信号SIGQUIT</span><br><span class="line">平滑重启，重新加载配置文件: reload,相当于信号SIGHUP</span><br><span class="line">重新开始记录日志文件:reopen,相当于信号SIGUSR1,在切割日志时用途较大</span><br><span class="line">平滑升级可执行程序:发送信号SIGUSR2,在升级版本时使用</span><br><span class="line">优雅的停止工作进程:发送信号SIGWINCH,在升级版本时使用</span><br></pre></td></tr></table></figure>

<p>范例: 查看nginx帮助</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ~]<span class="comment"># nginx -h</span></span><br><span class="line">nginx version: nginx/1.14.1</span><br><span class="line">Usage: nginx [-?hvVtTq] [-s signal] [-c filename] [-p prefix] [-g directives]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Options:</span><br><span class="line">  -?,-h         : this <span class="built_in">help</span></span><br><span class="line">  -v           : show version and <span class="built_in">exit</span></span><br><span class="line">  -V           : show version and configure options <span class="keyword">then</span> <span class="built_in">exit</span></span><br><span class="line">  -t           : <span class="built_in">test</span> configuration and <span class="built_in">exit</span></span><br><span class="line">  -T           : <span class="built_in">test</span> configuration, dump it and <span class="built_in">exit</span></span><br><span class="line">  -q           : suppress non-error messages during configuration testing</span><br><span class="line">  -s signal     : send signal to a master process: stop, quit, reopen, reload</span><br><span class="line">  -p prefix     : <span class="built_in">set</span> prefix path (default: /usr/share/nginx/)</span><br><span class="line">  -c filename   : <span class="built_in">set</span> configuration file (default: /etc/nginx/nginx.conf)</span><br><span class="line">  -g directives : <span class="built_in">set</span> global directives out of configuration file</span><br></pre></td></tr></table></figure>

<h3 id="quit-实现worker进程优雅关闭"><a href="#quit-实现worker进程优雅关闭" class="headerlink" title="quit 实现worker进程优雅关闭"></a>quit 实现worker进程优雅关闭</h3><ul>
<li>设置定时器: worker_shutdown_timeout</li>
</ul>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">http://nginx.org/en/docs/ngx_core_module.html#worker_shutdown_timeout</span><br><span class="line"></span><br><span class="line"><span class="attribute">Syntax</span><span class="punctuation">: </span>worker_shutdown_timeout time;</span><br><span class="line"><span class="attribute">Default</span><span class="punctuation">: </span>—</span><br><span class="line"><span class="attribute">Context</span><span class="punctuation">: </span>main</span><br><span class="line">This directive appeared in version 1.11.11.</span><br><span class="line"></span><br><span class="line">Configures a timeout for a graceful shutdown of worker processes. When the </span><br><span class="line">time expires, nginx will try to close all the connections currently open to facilitate shutdown.</span><br></pre></td></tr></table></figure>

<ul>
<li>关闭监听句柄</li>
<li>关闭空闲连接</li>
<li>在循环中等待全部连接关闭</li>
<li>退出nginx所有进程</li>
</ul>
<h3 id="reload-流程"><a href="#reload-流程" class="headerlink" title="reload 流程"></a>reload 流程</h3><p><img src="../../../../images/SRE/day28/76.jpg" alt="76"></p>
<p><img src="../../../../images/SRE/day28/77.jpg" alt="77"></p>
<p>利用 reload 可以实现平滑修改配置并生效</p>
<ul>
<li>向master进程发送HUP信号(reload命令) master进程校验配置语法是否正确</li>
<li>master进程打开新的监听端口 master进程用新配置启动新的worker子进程</li>
<li>master进程向老worker子进程发送QUIT信号，老的worker对已建立连接继续处理，处理完才会优雅退出.未关闭的worker旧进程不会处理新来的请求</li>
<li>老worker进程关闭监听句柄，处理完当前连接后结束进程</li>
</ul>
<h2 id="平滑升级和回滚"><a href="#平滑升级和回滚" class="headerlink" title="平滑升级和回滚"></a>平滑升级和回滚</h2><p>有时候需要对Nginx版本进行升级以满足对其功能的需求，例如添加新模块，需要新功能，而此时Nginx又在跑着业务无法停止，这时就可以选择平滑升级</p>
<h3 id="平滑升级流程"><a href="#平滑升级流程" class="headerlink" title="平滑升级流程"></a>平滑升级流程</h3><p>平滑升级四个阶段</p>
<ul>
<li>只有旧版nginx的master和worker进程</li>
<li>旧版和新版nginx的master和worker进程并存,由旧版nginx接收处理用户的新请求(注意:做快照方便测试回滚)</li>
<li>旧版和新版nginx的master和worker进程并存,由新版nginx接收处理用户的新请求</li>
<li>只有新版nginx的master和worker进程</li>
</ul>
<p><img src="../../../../images/SRE/day28/78.jpg" alt="78"></p>
<p><img src="../../../../images/SRE/day28/79.jpg" alt="79"></p>
<ul>
<li><p>将旧Nginx二进制文件换成新Nginx程序文件（注意先备份)</p>
</li>
<li><p>向master进程发送USR2信号启动新nginx进程</p>
<p>master进程修改pid文件名加上后缀.oldbin,成为nginx.pid.oldbin</p>
<p>master进程用新Nginx文件启动新master进程及worker子进程成为旧master的子进程</p>
<p>系统中将有新旧两个Nginx主进程和对应的worker子进程并存</p>
<p>当前新的请求仍然由旧Nginx的worker进程进行处理</p>
<p>将新生成的master进程的PID存放至新生成的pid文件nginx.pid</p>
</li>
<li><p>向旧的Nginx服务进程发送WINCH信号，使旧的Nginx worker进程平滑停止</p>
<p>当前新的请求由新Nginx的worker进程进行处理</p>
</li>
<li><p>向旧master进程发送QUIT信号，关闭旧master，并删除Nginx.pid.oldbin文件</p>
</li>
<li><p>如果发现升级有问题,可以回滚∶向旧master发送HUP，向新master发送QUIT</p>
</li>
</ul>
<h3 id="平滑升级和回滚案例"><a href="#平滑升级和回滚案例" class="headerlink" title="平滑升级和回滚案例"></a>平滑升级和回滚案例</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#下载最新稳定版</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># wget http://nginx.org/download/nginx-1.20.1.tar.gz</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># tar xvf nginx-1.20.1.tar.gz</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># cd nginx-1.20.1</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#查看当前使用的版本及编译选项。结果如下：</span></span><br><span class="line">[root@centos8 nginx-1.20.1]<span class="comment"># /apps/nginx/sbin/nginx -V   </span></span><br><span class="line">nginx version: nginx/1.18.0</span><br><span class="line">built by gcc 8.3.1 20191121 (Red Hat 8.3.1-5) (GCC) </span><br><span class="line">built with OpenSSL 1.1.1g FIPS  21 Apr 2020</span><br><span class="line">TLS SNI support enabled</span><br><span class="line">configure arguments: --prefix=/apps/nginx --user=nginx --group=nginx --with-http_ssl_module --with-http_v2_module --with-http_realip_module --with-http_stub_status_module --with-http_gzip_static_module --with-pcre --with-stream --with-stream_ssl_module --with-stream_realip_module</span><br><span class="line"></span><br><span class="line"><span class="comment">#configure arguments后面是以前编译时的参数。现在编译使用一样的参数</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#开始编译新版本</span></span><br><span class="line">[root@centos8 nginx-1.20.1]<span class="comment"># ./configure --prefix=/apps/nginx --user=nginx --group=nginx --with-http_ssl_module --with-http_v2_module --with-http_realip_module --with-http_stub_status_module --with-http_gzip_static_module --with-pcre --with-stream --with-stream_ssl_module --with-stream_realip_module</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#只要make无需要make install</span></span><br><span class="line">[root@centos8 nginx-1.20.1]<span class="comment"># make</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@centos8 nginx-1.20.1]<span class="comment"># objs/nginx -v</span></span><br><span class="line">nginx version: nginx/1.20.1</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#查看两个版本</span></span><br><span class="line">[root@centos8 nginx-1.20.1]<span class="comment"># ll objs/nginx /apps/nginx/sbin/nginx</span></span><br><span class="line">-rwxr-xr-x 1 nginx nginx 7591096 Jun  7 16:28 /apps/nginx/sbin/nginx</span><br><span class="line">-rwxr-xr-x 1 root root  7723272 Jun  7 17:27 objs/nginx</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#把之前的旧版的nginx命令备份</span></span><br><span class="line">[root@centos8 nginx-1.20.1]<span class="comment"># cp /apps/nginx/sbin/nginx /opt/nginx.old</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#把新版本的nginx命令复制过去覆盖旧版本程序文件,注意:需要加 -f 选项强制覆盖,否则会提示Text file busy</span></span><br><span class="line">[root@centos8 nginx-1.20.1]<span class="comment"># cp -f ./objs/nginx /apps/nginx/sbin/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#如果cp 不加-f 选项，会出现下面提示</span></span><br><span class="line">[root@rocky8 nginx-1.21.6]<span class="comment"># cp objs/nginx /apps/nginx/sbin/</span></span><br><span class="line"><span class="built_in">cp</span>: overwrite <span class="string">&#x27;/apps/nginx/sbin/nginx&#x27;</span>? y</span><br><span class="line"><span class="built_in">cp</span>: cannot create regular file <span class="string">&#x27;/apps/nginx/sbin/nginx&#x27;</span>: Text file busy</span><br><span class="line"></span><br><span class="line"><span class="comment">#检测一下有没有问题</span></span><br><span class="line">[root@centos8 nginx-1.20.1]<span class="comment"># /apps/nginx/sbin/nginx -t</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#发送信号USR2 平滑升级可执行程序,将存储有旧版本主进程PID的文件重命名为nginx.pid.oldbin，并启动新的nginx</span></span><br><span class="line"><span class="comment">#此时两个master的进程都在运行,只是旧的master不在监听,由新的master监听80</span></span><br><span class="line"><span class="comment">#此时Nginx开启一个新的master进程，这个master进程会生成新的worker进程，这就是升级后的Nginx进程，此时老的进程不会自动退出，但是当接收到新的请求不作处理而是交给新的进程处理。</span></span><br><span class="line"></span><br><span class="line">[root@centos8 nginx-1.20.1]<span class="comment"># kill -USR2 `cat /apps/nginx/logs/nginx.pid`</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#可以看到两个master,新的master是旧版master的子进程,并生成新版的worker进程</span></span><br><span class="line">[root@centos8 nginx-1.20.1]<span class="comment"># ps auxf|grep nginx</span></span><br><span class="line">root       12018  0.0  0.0  12112  1092 pts/0   S+   17:32   0:00 |           </span><br><span class="line">\_ grep --color=auto nginx</span><br><span class="line">root        8814  0.0  0.2  42460  3760 ?       Ss   16:58   0:00 nginx: master process /apps/nginx/sbin/nginx -c /apps/nginx/conf/nginx.conf</span><br><span class="line">nginx       8957  0.0  0.2  77172  4724 ?       S    17:23   0:00 \_ nginx: worker process</span><br><span class="line">nginx       8958  0.0  0.2  77172  4724 ?       S    17:23   0:00 \_ nginx: worker process</span><br><span class="line">root       12014  0.0  0.3  42448  5512 ?       S    17:32   0:00 \_ nginx: master process /apps/nginx/sbin/nginx -c /apps/nginx/conf/nginx.conf</span><br><span class="line">nginx      12015  0.0  0.2  77192  4904 ?       S    17:32   0:00     \_ nginx: worker process</span><br><span class="line">nginx      12016  0.0  0.2  77192  4908 ?       S    17:32   0:00     \_ nginx: worker process</span><br><span class="line"></span><br><span class="line">[root@centos8 nginx-1.20.1]<span class="comment"># lsof -i :80</span></span><br><span class="line">COMMAND   PID USER   FD   TYPE DEVICE SIZE/OFF NODE NAME</span><br><span class="line">nginx    8814 root   8u IPv4  40843     0t0 TCP *:http (LISTEN)</span><br><span class="line">nginx    8957 nginx  8u IPv4  40843     0t0 TCP *:http (LISTEN)</span><br><span class="line">nginx    8958 nginx  8u IPv4  40843     0t0 TCP *:http (LISTEN)</span><br><span class="line">nginx   12014 root   8u IPv4  40843     0t0 TCP *:http (LISTEN)</span><br><span class="line">nginx   12015 nginx  8u IPv4  40843     0t0 TCP *:http (LISTEN)</span><br><span class="line">nginx   12016 nginx  8u IPv4  40843     0t0 TCP *:http (LISTEN)</span><br><span class="line"></span><br><span class="line"><span class="comment">#先关闭旧nginx的worker进程,而不关闭nginx主进程方便回滚</span></span><br><span class="line"><span class="comment">#向原Nginx主进程发送WINCH信号，它会逐步关闭旗下的工作进程（主进程不退出），这时所有请求都会由新版Nginx处理</span></span><br><span class="line">[root@centos8 nginx-1.20.1]<span class="comment">#kill -WINCH `cat /apps/nginx/logs/nginx.pid.oldbin`</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#如果旧版worker进程有用户的请求,会一直等待处理完后才会关闭</span></span><br><span class="line">[root@centos8 nginx-1.20.1]<span class="comment">#ps auxf|grep nginx</span></span><br><span class="line">root       12066  0.0  0.0  12112  1112 pts/0   S+   17:38   0:00 |           \_ grep --color=auto nginx</span><br><span class="line">root        8814  0.0  0.1  42460  2656 ?       Ss   16:58   0:00 nginx: master process /apps/nginx/sbin/nginx -c /apps/nginx/conf/nginx.conf</span><br><span class="line">nginx       8957  0.0  0.1  77172  3484 ?       S    17:23   0:00 \_ nginx: worker process is shutting down</span><br><span class="line">root       12014  0.0  0.2  42448  3664 ?       S    17:32   0:00 \_ nginx: master process /apps/nginx/sbin/nginx -c /apps/nginx/conf/nginx.conf</span><br><span class="line">nginx      12015  0.0  0.1  77192  3284 ?       S    17:32   0:00     \_ nginx: worker process</span><br><span class="line">nginx      12016  0.0  0.1  77192  3280 ?       S    17:32   0:00     \_ nginx: worker process</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@centos8 nginx-1.20.1]<span class="comment"># pstree -p|grep nginx</span></span><br><span class="line">           |-nginx(8814)---nginx(12014)-+-nginx(12015)</span><br><span class="line">           |                            `-nginx(12016)</span><br><span class="line">           </span><br><span class="line">           </span><br><span class="line"><span class="comment">#经过一段时间测试，新版本服务没问题，最后发送QUIT信号,退出老的master</span></span><br><span class="line">[root@centos8 nginx-1.20.1]<span class="comment"># kill -QUIT `cat /apps/nginx/logs/nginx.pid.oldbin`</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#查看版本是不是已经是新版了</span></span><br><span class="line">[root@centos8 nginx-1.20.1]<span class="comment"># nginx -v</span></span><br><span class="line">nginx version: nginx/1.20.1</span><br><span class="line"></span><br><span class="line">[root@centos8 nginx-1.20.1]<span class="comment"># curl -I 127.0.0.1</span></span><br><span class="line">HTTP/1.1 200 OK</span><br><span class="line">Server: nginx/1.20.1</span><br><span class="line">Date: Mon, 07 Jun 2021 09:48:48 GMT</span><br><span class="line">Content-Type: text/html</span><br><span class="line">Content-Length: 612</span><br><span class="line">Last-Modified: Mon, 07 Jun 2021 08:28:12 GMT</span><br><span class="line">Connection: keep-alive</span><br><span class="line">ETag: <span class="string">&quot;60bdd89c-264&quot;</span></span><br><span class="line">Accept-Ranges: bytes</span><br><span class="line"></span><br><span class="line"><span class="comment">#回滚</span></span><br><span class="line"><span class="comment">#如果升级的版本发现问题需要回滚,可以发送HUP信号,重新拉起旧版本的worker</span></span><br><span class="line">[root@centos8 nginx-1.20.1]<span class="comment"># kill -HUP `cat /apps/nginx/logs/nginx.pid.oldbin`</span></span><br><span class="line">[root@centos8 nginx-1.20.1]<span class="comment"># pstree -p |grep nginx</span></span><br><span class="line">           |-nginx(8814)-+-nginx(12014)-+-nginx(12015)</span><br><span class="line">           |             |              `-nginx(12016)</span><br><span class="line">           |             |-nginx(12090)</span><br><span class="line">           |             `-nginx(12091)</span><br><span class="line">           </span><br><span class="line">           </span><br><span class="line"><span class="comment">#最后关闭新版的master </span></span><br><span class="line">[root@centos8 nginx-1.20.1]<span class="comment"># kill -QUIT `cat /apps/nginx/logs/nginx.pid`</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#恢复旧版的文件</span></span><br><span class="line">[root@rocky8 ~]<span class="comment">#mv /opt/nginx.old   /apps/nginx/sbin/</span></span><br><span class="line"><span class="built_in">mv</span>: overwrite <span class="string">&#x27;/apps/nginx/sbin/nginx&#x27;</span>? y</span><br></pre></td></tr></table></figure>

<h1 id="Nginx-核心模块"><a href="#Nginx-核心模块" class="headerlink" title="Nginx 核心模块"></a>Nginx 核心模块</h1><h2 id="配置文件说明"><a href="#配置文件说明" class="headerlink" title="配置文件说明"></a>配置文件说明</h2><p>nginx 官方帮助文档</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://nginx.org/en/docs/</span><br></pre></td></tr></table></figure>

<p>tengine 帮助文档</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://tengine.taobao.org/nginx_docs/cn/docs/</span><br></pre></td></tr></table></figure>

<p>Nginx的配置文件的组成部分：</p>
<ul>
<li><p>主配置文件：nginx.conf</p>
</li>
<li><p>子配置文件: include conf.d/*.conf</p>
</li>
<li><p>fastcgi， uwsgi，scgi 等协议相关的配置文件</p>
</li>
<li><p>mime.types：支持的mime类型，MIME(Multipurpose Internet Mail Extensions)多用途互联网邮件扩展类型，MIME消息能包含文本、图像、音频、视频以及其他应用程序专用的数据，是设定某种扩展名的文件用一种应用程序来打开的方式类型，当该扩展名文件被访问的时候，浏览器会自动使用指定应用程序来打开。多用于指定一些客户端自定义的文件名，以及一些媒体文件打开方式。</p>
<p>MIME参考文档：<a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Basics_of_HTTP/MIME_Types">https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Basics_of_HTTP/MIME_Types</a></p>
</li>
</ul>
<p>nginx 配置文件格式说明</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">配置文件由指令与指令块构成</span><br><span class="line">每条指令以;分号结尾，指令与值之间以空格符号分隔</span><br><span class="line">可以将多条指令放在同一行,用分号分隔即可,但可读性差,不推荐</span><br><span class="line">指令块以&#123; &#125;大括号将多条指令组织在一起,且可以嵌套指令块</span><br><span class="line">include语句允许组合多个配置文件以提升可维护性</span><br><span class="line">使用#符号添加注释，提高可读性</span><br><span class="line">使用$符号使用变量</span><br><span class="line">部分指令的参数支持正则表达式</span><br></pre></td></tr></table></figure>

<p>Nginx 主配置文件的配置指令方式：</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">directive value [value2 ...];</span><br><span class="line">注意</span><br><span class="line">(1) 指令必须以分号结尾</span><br><span class="line">(2) 支持使用配置变量</span><br><span class="line">   内建变量：由Nginx模块引入，可直接引用</span><br><span class="line">   自定义变量：由用户使用set命令定义,格式: set variable_name value;</span><br><span class="line">   引用变量：$variable_name</span><br></pre></td></tr></table></figure>

<p>主配置文件结构：四部分</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">main block：主配置段，即全局配置段，对http,mail都有效</span><br><span class="line"></span><br><span class="line"><span class="comment">#事件驱动相关的配置</span></span><br><span class="line">event &#123;</span><br><span class="line"> ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">#http/https 协议相关配置段</span></span><br><span class="line">http &#123;</span><br><span class="line"> ...</span><br><span class="line">&#125; </span><br><span class="line"></span><br><span class="line"><span class="comment">#默认配置文件不包括下面两个块</span></span><br><span class="line"><span class="comment">#mail 协议相关配置段</span></span><br><span class="line">mail &#123;</span><br><span class="line"> ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">#stream 服务器相关配置段</span></span><br><span class="line">stream &#123;</span><br><span class="line"> ...</span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure>

<p><strong>默认的nginx.conf 配置文件格式说明</strong></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#全局配置端，对全局生效，主要设置nginx的启动用户/组，启动的工作进程数量，工作模式，Nginx的PID路径，日志路径等。</span></span><br><span class="line">user nginx nginx;</span><br><span class="line">worker_processes  1;   <span class="comment">#启动工作进程数数量</span></span><br><span class="line">events &#123; <span class="comment">#events设置快，主要影响nginx服务器与用户的网络连接，比如是否允许同时接受多个网络连接，使用哪种事件驱动模型处理请求，每个工作进程可以同时支持的最大连接数，是否开启对多工作进程下的网络连接进行序列化等。</span></span><br><span class="line">     worker_connections  1024;   <span class="comment">#设置单个nginx工作进程可以接受的最大并发，作为web服务器的时候最大并发数为worker_connections * worker_processes，作为反向代理的时候为(worker_connections * worker_processes)/2</span></span><br><span class="line">&#125;</span><br><span class="line">http &#123; <span class="comment">#http块是Nginx服务器配置中的重要部分，缓存、代理和日志格式定义等绝大多数功能和第三方模块都可以在这设置，http块可以包含多个server块，而一个server块中又可以包含多个location块，server块可以配置文件引入、MIME-Type定义、日志自定义、是否启用sendfile、连接超时时间和单个链接的请求上限等。</span></span><br><span class="line">   include       mime.types;</span><br><span class="line">   default_type application/octet-stream;</span><br><span class="line">   sendfile       on; <span class="comment">#作为web服务器的时候打开sendfile加快静态文件传输，指定是否使用sendfile系统调用来传输文件,sendfile系统调用在两个文件描述符之间直接传递数据(完全在内核中操作)，从而避免了数据在内核缓冲区和用户缓冲区之间的拷贝，操作效率很高，被称之为零拷贝，硬盘 &gt;&gt; kernel buffer (快速拷贝到kernelsocket buffer) &gt;&gt;协议栈。</span></span><br><span class="line">   keepalive_timeout  65;  <span class="comment">#长连接超时时间，单位是秒</span></span><br><span class="line">   server &#123; <span class="comment">#设置一个虚拟机主机，可以包含自己的全局快，同时也可以包含多个location模块。比如本虚拟机监听的端口、本虚拟机的名称和IP配置，多个server 可以使用一个端口，比如都使用80端口提供web服务、</span></span><br><span class="line">       listen       80;  <span class="comment">#配置server监听的端口</span></span><br><span class="line">       server_name localhost; <span class="comment">#本server的名称，当访问此名称的时候nginx会调用当前serevr内部的配置进程匹配。</span></span><br><span class="line">       location / &#123; <span class="comment">#location其实是server的一个指令，为nginx服务器提供比较多而且灵活的指令，都是在location中体现的，主要是基于nginx接受到的请求字符串，对用户请求的UIL进行匹配，并对特定的指令进行处理，包括地址重定向、数据缓存和应答控制等功能都是在这部分实现，另外很多第三方模块的配置也是在location模块中配置。</span></span><br><span class="line">           root   html; <span class="comment">#相当于默认页面的目录名称，默认是安装目录的相对路径，可以使用绝对路径配置。</span></span><br><span class="line">           index index.html index.htm; <span class="comment">#默认的页面文件名称</span></span><br><span class="line">       &#125;</span><br><span class="line">       error_page   500 502 503 504 /50x.html; <span class="comment">#错误页面的文件名称</span></span><br><span class="line">       location = /50x.html &#123; <span class="comment">#location处理对应的不同错误码的页面定义到/50x.html，这个跟对应其server中定义的目录下。</span></span><br><span class="line">           root   html;  <span class="comment">#定义默认页面所在的目录</span></span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br><span class="line">    </span><br><span class="line"><span class="comment">#和邮件相关的配置</span></span><br><span class="line"><span class="comment">#mail &#123;</span></span><br><span class="line"><span class="comment">#               ...</span></span><br><span class="line"><span class="comment">#       &#125;         mail 协议相关配置段</span></span><br><span class="line"><span class="comment">#tcp代理配置，1.9版本以上支持</span></span><br><span class="line"><span class="comment">#stream &#123;</span></span><br><span class="line"><span class="comment">#               ...</span></span><br><span class="line"><span class="comment">#       &#125;       stream 服务器相关配置段</span></span><br><span class="line"><span class="comment">#导入其他路径的配置文件</span></span><br><span class="line"><span class="comment">#include /apps/nginx/conf.d/*.conf</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="全局配置"><a href="#全局配置" class="headerlink" title="全局配置"></a>全局配置</h2><p>Main 全局配置段常见的配置指令分类</p>
<ul>
<li>正常运行必备的配置</li>
<li>优化性能相关的配置</li>
<li>用于调试及定位问题相关的配置</li>
<li>事件驱动相关的配置</li>
</ul>
<p><strong>全局配置说明:</strong></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">user nginx nginx; <span class="comment">#启动Nginx工作进程的用户和组</span></span><br><span class="line">worker_processes [number | auto]; <span class="comment">#启动Nginx工作进程的数量,一般设为和CPU核心数相同</span></span><br><span class="line">worker_cpu_affinity 00000001 00000010 00000100 00001000 | auto ; <span class="comment">#将Nginx工作进程绑定到指定的CPU核心，默认Nginx是不进行进程绑定的，绑定并不是意味着当前nginx进程独占以一核心CPU，但是可以保证此进程不会运行在其他核心上，这就极大减少了nginx的工作进程在不同的cpu核心上的来回跳转，减少了CPU对进程的资源分配与回收以及内存管理等，因此可以有效的提升nginx服务器的性能。</span></span><br><span class="line">CPU MASK: 00000001：0号CPU</span><br><span class="line">          00000010：1号CPU</span><br><span class="line">          10000000：7号CPU</span><br><span class="line"></span><br><span class="line"><span class="comment">#示例:</span></span><br><span class="line">worker_cpu_affinity 0001 0010 0100 1000;第0号---第3号CPU</span><br><span class="line">worker_cpu_affinity 0101 1010; </span><br><span class="line"></span><br><span class="line"><span class="comment">#示例</span></span><br><span class="line">worker_processes  4;</span><br><span class="line">worker_cpu_affinity 00000010 00001000 00100000 10000000;</span><br><span class="line"></span><br><span class="line">[root@centos8 ~]<span class="comment"># ps axo pid,cmd,psr | grep nginx</span></span><br><span class="line">31093 nginx: master process /apps   1</span><br><span class="line">34474 nginx: worker process         1</span><br><span class="line">34475 nginx: worker process         3</span><br><span class="line">34476 nginx: worker process         5</span><br><span class="line">34477 nginx: worker process         7</span><br><span class="line">35751 grep nginx</span><br><span class="line"></span><br><span class="line"><span class="comment">#auto 绑定CPU</span></span><br><span class="line"><span class="comment">#The special value auto (1.9.10) allows binding worker processes automatically to available CPUs:</span></span><br><span class="line">worker_processes auto; </span><br><span class="line">worker_cpu_affinity auto;</span><br><span class="line"><span class="comment">#The optional mask parameter can be used to limit the CPUs available for </span></span><br><span class="line">automatic binding:</span><br><span class="line">worker_cpu_affinity auto 01010101;</span><br><span class="line"></span><br><span class="line"><span class="comment">#错误日志记录配置，语法：error_log file [debug | info | notice | warn | error | crit | alert | emerg]</span></span><br><span class="line"><span class="comment">#error_log logs/error.log;</span></span><br><span class="line"><span class="comment">#error_log logs/error.log notice;</span></span><br><span class="line">error_log /apps/nginx/logs/error.log error; </span><br><span class="line"></span><br><span class="line"><span class="comment">#pid文件保存路径</span></span><br><span class="line">pid       /apps/nginx/logs/nginx.pid;</span><br><span class="line"></span><br><span class="line">worker_priority 0; <span class="comment">#工作进程优先级，-20~20(19)</span></span><br><span class="line">worker_rlimit_nofile 65536; <span class="comment">#所有worker进程能打开的文件数量上限,包括:Nginx的所有连接（例如与代理服务器的连接等），而不仅仅是与客户端的连接,另一个考虑因素是实际的并发连接数不能超过系统级别的最大打开文件数的限制.最好与ulimit -n 或者limits.conf的值保持一致,</span></span><br><span class="line"></span><br><span class="line">daemon off;  <span class="comment">#前台运行Nginx服务用于测试、或者以容器运行时，需要设为off</span></span><br><span class="line">master_process off|on; <span class="comment">#是否开启Nginx的master-worker工作模式，仅用于开发调试场景,默认为on</span></span><br><span class="line"></span><br><span class="line">events &#123;</span><br><span class="line">   worker_connections  65536;  <span class="comment">#设置单个工作进程的最大并发连接数</span></span><br><span class="line">   use epoll; <span class="comment">#使用epoll事件驱动，Nginx支持众多的事件驱动，比如:select、poll、epoll，只能设置在events模块中设置。</span></span><br><span class="line">   accept_mutex on; <span class="comment">#on为同一时刻一个请求轮流由worker进程处理,而防止被同时唤醒所有worker,避免多个睡眠进程被唤醒的设置，默认为off，新请求会唤醒所有worker进程,此过程也称为&quot;惊群&quot;，因此nginx刚安装完以后要进行适当的优化。建议设置为on</span></span><br><span class="line">   multi_accept on; <span class="comment">#on时Nginx服务器的每个工作进程可以同时接受多个新的网络连接，此指令默认为off，即默认为一个工作进程只能一次接受一个新的网络连接，打开后几个同时接受多个。建议设置为on</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>范例: 实现 nginx 的高并发配置</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">[root@centos7 ~]<span class="comment"># ulimit -n 102400</span></span><br><span class="line">[root@centos7 ~]<span class="comment"># while true;do ab -c 5000 -n 10000 http://10.0.0.8/;sleep 0.5;done</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#默认配置不支持高并发,会出现以下错误日志</span></span><br><span class="line"><span class="comment">#Ubuntu默认值比较高，无需调整</span></span><br><span class="line">[root@ubuntu2004 ~]<span class="comment"># cat /proc/25149/limits</span></span><br><span class="line">Limit                     Soft Limit           Hard Limit           Units</span><br><span class="line">Max open files            1024                 524288               files</span><br><span class="line"></span><br><span class="line"><span class="comment">#Rocky8默认值比较低，需要调整</span></span><br><span class="line">[root@rocky8 ~]<span class="comment"># cat /proc/25658/limits</span></span><br><span class="line">Limit                     Soft Limit           Hard Limit           Units</span><br><span class="line">Max open files            1024                 262144               files</span><br><span class="line"></span><br><span class="line">[root@centos8 conf]<span class="comment"># tail /apps/nginx/logs/error.log</span></span><br><span class="line">2020/09/24 21:19:33 [crit] 41006<span class="comment">#0: *1105860 open() &quot;/apps/nginx/html/50x.html&quot; failed (24: Too many open files), client: 10.0.0.7, server: localhost, request: &quot;GET / HTTP/1.0&quot;, host: &quot;10.0.0.8&quot;</span></span><br><span class="line">2020/09/24 21:19:33 [crit] 41006<span class="comment">#0: accept4() failed (24: Too many open files)</span></span><br><span class="line">2020/09/24 21:19:33 [crit] 41006<span class="comment">#0: *1114177 open() &quot;/apps/nginx/html/index.html&quot; failed (24: Too many open files), client: 10.0.0.7, server: localhost, request: &quot;GET / HTTP/1.0&quot;, host: &quot;10.0.0.8&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#如果systemd启动,则需要修改nginx.service文件中加LimitNOFILE=100000,才能有效</span></span><br><span class="line">[root@rocky8 ~]<span class="comment"># vim /lib/systemd/system/nginx.service</span></span><br><span class="line">[Service]</span><br><span class="line">......</span><br><span class="line">LimitNOFILE=100000</span><br><span class="line">.....</span><br><span class="line"></span><br><span class="line"><span class="comment">#如果非systemd启动,可以修改下面pam限制</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># vim /etc/security/limits.conf </span></span><br><span class="line">*               soft   nofile          1000000</span><br><span class="line">*               hard   nofile          1000000</span><br><span class="line">[root@centos8 ~]<span class="comment"># vim /apps/nginx/conf/nginx.conf</span></span><br><span class="line">worker_rlimit_nofile 100000; </span><br><span class="line"></span><br><span class="line">[root@centos8 ~]<span class="comment"># systemctl restart nginx</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># watch -n1 &#x27;ps -axo pid,cmd,nice | grep nginx #验证进程优先级</span></span><br></pre></td></tr></table></figure>

<h2 id="http-配置块"><a href="#http-配置块" class="headerlink" title="http 配置块"></a>http 配置块</h2><p>http 协议相关的配置结构</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">http &#123;</span><br><span class="line">   ...</span><br><span class="line">   ...  <span class="comment">#各server的公共配置</span></span><br><span class="line">   server &#123;    <span class="comment">#每个server用于定义一个虚拟主机,第一个server为默认虚拟服务器</span></span><br><span class="line">   ...</span><br><span class="line">   &#125;</span><br><span class="line">   server &#123;     </span><br><span class="line">       ...</span><br><span class="line">       server_name   <span class="comment">#虚拟主机名</span></span><br><span class="line">       root     <span class="comment">#主目录</span></span><br><span class="line">       <span class="built_in">alias</span>     <span class="comment">#路径别名</span></span><br><span class="line">       location [OPERATOR] URL &#123;     <span class="comment">#指定URL的特性</span></span><br><span class="line">           ...</span><br><span class="line">           <span class="keyword">if</span> CONDITION &#123;</span><br><span class="line">               ...</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>http 协议配置说明</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><span class="line">http &#123;</span><br><span class="line">   include       mime.types; <span class="comment">#导入支持的文件类型,是相对于/apps/nginx/conf的目录</span></span><br><span class="line">   default_type application/octet-stream; <span class="comment">#除mime.types中文件类型外,设置其它文件默认类型，访问其它类型时会提示下载不匹配的类型文件</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#日志配置部分</span></span><br><span class="line">    <span class="comment">#log_format main &#x27;$remote_addr - $remote_user [$time_local] &quot;$request&quot; &#x27;</span></span><br><span class="line">    <span class="comment">#                 &#x27;$status $body_bytes_sent &quot;$http_referer&quot; &#x27;</span></span><br><span class="line">    <span class="comment">#                 &#x27;&quot;$http_user_agent&quot; &quot;$http_x_forwarded_for&quot;&#x27;;</span></span><br><span class="line">    <span class="comment">#access_log logs/access.log main;</span></span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line"><span class="comment">#自定义优化参数</span></span><br><span class="line">   sendfile       on; </span><br><span class="line">    <span class="comment">#tcp_nopush     on; #开启sendfile的情况下，合并请求后统一发送给客户端,必须开启sendfile</span></span><br><span class="line">    <span class="comment">#tcp_nodelay   off; #开启keepalived模式下的连接是否启用TCP_NODELAY选项，为off时，延迟0.2s发送，默认On时，不延迟发送，立即发送用户响应报文。</span></span><br><span class="line">    <span class="comment">#keepalive_timeout 0;</span></span><br><span class="line">   keepalive_timeout  65 65; <span class="comment">#设置会话保持时间,第二个值为响应首部:keep-Alived:timeout=65,可以和第一个值不同</span></span><br><span class="line">    <span class="comment">#gzip on; #开启文件压缩</span></span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">   server &#123;</span><br><span class="line">       listen       80 default_server; <span class="comment">#设置监听地址和端口,多个虚拟机时当前是否是默认的虚拟主机，default_server表示是默认主机，否则排在前面server为默认主机</span></span><br><span class="line">        </span><br><span class="line">       server_name localhost; <span class="comment">#设置server name，可以以空格隔开写多个并支持正则表达式，如:*.wang.com www.wang.* ~^www\d+\.wang\.com$  </span></span><br><span class="line">        <span class="comment">#charset koi8-r; #设置编码格式，默认是俄语格式，建议改为utf-8</span></span><br><span class="line">        <span class="comment">#access_log logs/host.access.log main;</span></span><br><span class="line">       location / &#123;</span><br><span class="line">           root   html;</span><br><span class="line">           index index.html index.htm;</span><br><span class="line">       &#125;</span><br><span class="line">       </span><br><span class="line">       </span><br><span class="line">        <span class="comment">#error_page 404             /404.html;</span></span><br><span class="line">        <span class="comment"># redirect server error pages to the static page /50x.html</span></span><br><span class="line">        <span class="comment">#</span></span><br><span class="line">       error_page   500 502 503 504 /50x.html; <span class="comment">#定义错误页面</span></span><br><span class="line">       location = /50x.html &#123;</span><br><span class="line">           root   html;</span><br><span class="line">       &#125;</span><br><span class="line">       </span><br><span class="line">        <span class="comment"># proxy the PHP scripts to Apache listening on 127.0.0.1:80</span></span><br><span class="line">        <span class="comment">#</span></span><br><span class="line">        <span class="comment">#location ~ \.php$ &#123; #以http的方式转发php请求到指定web服务器</span></span><br><span class="line">        <span class="comment">#   proxy_pass   http://127.0.0.1;</span></span><br><span class="line">        <span class="comment">#&#125;</span></span><br><span class="line">        <span class="comment"># pass the PHP scripts to FastCGI server listening on 127.0.0.1:9000</span></span><br><span class="line">        <span class="comment">#</span></span><br><span class="line">        <span class="comment">#location ~ \.php$ &#123; #以fastcgi的方式转发php请求到php处理</span></span><br><span class="line">        <span class="comment">#   root           html;</span></span><br><span class="line">        <span class="comment">#   fastcgi_pass   127.0.0.1:9000;</span></span><br><span class="line">        <span class="comment">#   fastcgi_index index.php;</span></span><br><span class="line">        <span class="comment">#   fastcgi_param SCRIPT_FILENAME /scripts$fastcgi_script_name;</span></span><br><span class="line">        <span class="comment">#   include       fastcgi_params;</span></span><br><span class="line">        <span class="comment">#&#125;</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># deny access to .htaccess files, if Apache&#x27;s document root</span></span><br><span class="line">        <span class="comment"># concurs with nginx&#x27;s one</span></span><br><span class="line">        <span class="comment">#</span></span><br><span class="line">        <span class="comment">#location ~ /\.ht &#123; #拒绝web形式访问指定文件，如很多的网站都是通过.htaccess文件来改变自己的重定向等功能。</span></span><br><span class="line">        <span class="comment">#   deny all;</span></span><br><span class="line">        <span class="comment">#&#125;</span></span><br><span class="line">       location ~ /passwd.html &#123;</span><br><span class="line">           deny all;</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br><span class="line">    <span class="comment"># another virtual host using mix of IP-, name-, and port-based configuration</span></span><br><span class="line">    <span class="comment">#</span></span><br><span class="line">    <span class="comment">#server &#123; #自定义虚拟server</span></span><br><span class="line">    <span class="comment">#   listen       8000;</span></span><br><span class="line">    <span class="comment">#   listen       somename:8080;</span></span><br><span class="line">    <span class="comment">#   server_name somename alias another.alias;</span></span><br><span class="line">    <span class="comment">#   location / &#123; </span></span><br><span class="line">    <span class="comment">#       root   html;</span></span><br><span class="line">    <span class="comment">#       index index.html index.htm; #指定默认网页文件，此指令由ngx_http_index_module模块提供</span></span><br><span class="line">    <span class="comment">#   &#125;</span></span><br><span class="line">    <span class="comment">#&#125;</span></span><br><span class="line">    <span class="comment"># HTTPS server</span></span><br><span class="line">    <span class="comment">#</span></span><br><span class="line">    <span class="comment">#server &#123; #https服务器配置</span></span><br><span class="line">    <span class="comment">#   listen       443 ssl;</span></span><br><span class="line">    <span class="comment">#   server_name localhost;</span></span><br><span class="line">    <span class="comment">#   ssl_certificate     cert.pem;</span></span><br><span class="line">    <span class="comment">#   ssl_certificate_key cert.key;</span></span><br><span class="line">    <span class="comment">#   ssl_session_cache   shared:SSL:1m;</span></span><br><span class="line">    <span class="comment">#   ssl_session_timeout 5m;</span></span><br><span class="line">    <span class="comment">#   ssl_ciphers HIGH:!aNULL:!MD5;</span></span><br><span class="line">    <span class="comment">#   ssl_prefer_server_ciphers on;</span></span><br><span class="line">    <span class="comment">#   location / &#123;</span></span><br><span class="line">    <span class="comment">#       root   html;</span></span><br><span class="line">    <span class="comment">#       index index.html index.htm;</span></span><br><span class="line">    <span class="comment">#   &#125;</span></span><br><span class="line">    <span class="comment">#&#125;</span></span><br></pre></td></tr></table></figure>

<h3 id="MIME-1"><a href="#MIME-1" class="headerlink" title="MIME"></a>MIME</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#在响应报文中将指定的文件扩展名映射至MIME对应的类型</span></span><br><span class="line">include           /etc/nginx/mime.types;</span><br><span class="line">default_type     application/octet-stream;<span class="comment">#除mime.types中的类型外，指定其它文件的默认MIME类型，浏览器一般会提示下载</span></span><br><span class="line">types &#123;</span><br><span class="line">   text/html html;</span><br><span class="line">   image/gif gif;</span><br><span class="line">   image/jpeg jpg;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">#MIME参考文档：</span></span><br><span class="line">https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Basics_of_HTTP/MIME_Types</span><br></pre></td></tr></table></figure>

<p>范例: 识别php文件为text/html</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ~]<span class="comment"># cat /apps/nginx/html/test.php </span></span><br><span class="line">&lt;?php</span><br><span class="line">phpinfo();</span><br><span class="line">?&gt;</span><br><span class="line"></span><br><span class="line">[root@centos7 ~]<span class="comment"># curl 10.0.0.8/test.php -I</span></span><br><span class="line">HTTP/1.1 200 OK</span><br><span class="line">Server: nginx/1.18.0</span><br><span class="line">Date: Thu, 24 Sep 2020 13:54:39 GMT</span><br><span class="line">Content-Type: application/octet-stream</span><br><span class="line">Content-Length: 20</span><br><span class="line">Last-Modified: Thu, 24 Sep 2020 13:53:26 GMT</span><br><span class="line">Connection: keep-alive</span><br><span class="line">ETag: <span class="string">&quot;5f6ca4d6-14&quot;</span></span><br><span class="line">Accept-Ranges: bytes</span><br><span class="line"></span><br><span class="line">[root@centos8 ~]<span class="comment"># vim /apps/nginx/conf/nginx.conf</span></span><br><span class="line">http &#123;</span><br><span class="line">   include       mime.types;</span><br><span class="line">   default_type text/html;</span><br><span class="line">......</span><br><span class="line"></span><br><span class="line"><span class="comment">#或者修改为下面</span></span><br><span class="line">   include       mime.types;</span><br><span class="line">   default_type application/octet-stream;</span><br><span class="line">   types&#123;</span><br><span class="line">       text/plain php;  <span class="comment">#加此行</span></span><br><span class="line">   &#125;</span><br><span class="line">   </span><br><span class="line">[root@centos8 ~]<span class="comment"># nginx -s reload</span></span><br><span class="line">[root@centos7 ~]<span class="comment"># curl 10.0.0.8/index.html -I</span></span><br><span class="line">HTTP/1.1 200 OK</span><br><span class="line">Server: nginx/1.18.0</span><br><span class="line">Date: Thu, 24 Sep 2020 13:56:26 GMT</span><br><span class="line">Content-Type: text/html</span><br><span class="line">Content-Length: 612</span><br><span class="line">Last-Modified: Thu, 24 Sep 2020 12:13:03 GMT</span><br><span class="line">Connection: keep-alive</span><br><span class="line">ETag: <span class="string">&quot;5f6c8d4f-264&quot;</span></span><br><span class="line">Accept-Ranges: bytes</span><br></pre></td></tr></table></figure>

<h3 id="指定响应报文server首部"><a href="#指定响应报文server首部" class="headerlink" title="指定响应报文server首部"></a>指定响应报文server首部</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#是否在响应报文中的Content-Type显示指定的字符集，默认off不显示</span></span><br><span class="line">charset charset | off;</span><br><span class="line"></span><br><span class="line"><span class="comment">#示例</span></span><br><span class="line">charset utf-8;</span><br><span class="line"></span><br><span class="line"><span class="comment">#是否在响应报文的Server首部显示nginx版本</span></span><br><span class="line">server_tokens on | off | build | string;</span><br></pre></td></tr></table></figure>

<p>范例: 修改server字段</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">如果想自定义响应报文的nginx版本信息，需要修改源码文件，重新编译</span><br><span class="line">如果server_tokens on，修改 src/core/nginx.h 修改第13-14行，如下示例</span><br><span class="line"><span class="comment">#define NGINX_VERSION     &quot;1.68.9&quot;</span></span><br><span class="line"><span class="comment">#define NGINX_VER         &quot;wanginx/&quot; NGINX_VERSION</span></span><br><span class="line"></span><br><span class="line">如果server_tokens off，修改 src/http/ngx_http_header_filter_module.c </span><br><span class="line">第49行，如下示例：</span><br><span class="line">static char ngx_http_server_string[] = <span class="string">&quot;Server: nginx&quot;</span> CRLF;</span><br><span class="line">把其中的nginx改为自己想要的文字即可,如：wanginx </span><br></pre></td></tr></table></figure>

<p>范例: 修改 Server 头部信息</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ~]<span class="comment"># vim /usr/local/src/nginx-1.18.0/src/core/nginx.h </span></span><br><span class="line"><span class="comment">#define NGINX_VERSION     &quot;1.68.9&quot;</span></span><br><span class="line"><span class="comment">#define NGINX_VER         &quot;wanginx/&quot; NGINX_VERSION</span></span><br><span class="line"></span><br><span class="line">[root@centos8 ~]<span class="comment"># vim nginx-1.18.0/src/http/ngx_http_header_filter_module.c</span></span><br><span class="line">static u_char ngx_http_server_string[] = <span class="string">&quot;Server: magedu-nginx&quot;</span> CRLF; </span><br><span class="line"></span><br><span class="line">[root@centos7 ~]<span class="comment"># curl -I www.wang.org</span></span><br><span class="line">HTTP/1.1 200 OK</span><br><span class="line">Server: wanginx/1.68.9</span><br><span class="line">Date: Thu, 24 Sep 2020 07:44:05 GMT</span><br><span class="line">Content-Type: text/html</span><br><span class="line">Content-Length: 8</span><br><span class="line">Last-Modified: Wed, 23 Sep 2020 14:39:21 GMT</span><br><span class="line">Connection: keep-alive</span><br><span class="line">ETag: <span class="string">&quot;5f6b5e19-8&quot;</span></span><br><span class="line">Accept-Ranges: bytes</span><br><span class="line"></span><br><span class="line">[root@centos8 ~]<span class="comment"># vim /apps/nginx/conf/conf.d/pc.conf </span></span><br><span class="line">server &#123;</span><br><span class="line">     ......</span><br><span class="line">     server_tokens off; </span><br><span class="line">     ......</span><br><span class="line">     </span><br><span class="line">[root@centos7 ~]<span class="comment"># curl -I www.wang.org</span></span><br><span class="line">HTTP/1.1 200 OK</span><br><span class="line">Server: magedu-nginx</span><br><span class="line">Date: Thu, 24 Sep 2020 07:44:59 GMT</span><br><span class="line">Content-Type: text/html</span><br><span class="line">Content-Length: 8</span><br><span class="line">Last-Modified: Wed, 23 Sep 2020 14:39:21 GMT</span><br><span class="line">Connection: keep-alive</span><br><span class="line">ETag: <span class="string">&quot;5f6b5e19-8&quot;</span></span><br><span class="line">Accept-Ranges: bytes</span><br></pre></td></tr></table></figure>

<h2 id="常见核心模块配置"><a href="#常见核心模块配置" class="headerlink" title="常见核心模块配置"></a>常见核心模块配置</h2><p>基于不同的IP、不同的端口以及不用得域名实现不同的虚拟主机，依赖于核心模块 ngx_http_core_module实现。</p>
<h3 id="新建一个-PC-web-站点"><a href="#新建一个-PC-web-站点" class="headerlink" title="新建一个 PC web 站点"></a>新建一个 PC web 站点</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#定义子配置文件路径</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># mkdir /apps/nginx/conf/conf.d</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># vim /apps/nginx/conf/nginx.conf</span></span><br><span class="line">http &#123;</span><br><span class="line"> ......</span><br><span class="line"> include /apps/nginx/conf/conf.d/*.conf; <span class="comment">#在配置文件的最后面添加此行,注意不要放在最前面,会导致前面的命令无法生效</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">#创建PC网站配置</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># cat /apps/nginx/conf/conf.d/pc.conf</span></span><br><span class="line">server &#123;</span><br><span class="line"> listen 80;</span><br><span class="line"> server_name www.wang.org;</span><br><span class="line"> location / &#123;</span><br><span class="line">   root /data/nginx/html/pc;</span><br><span class="line"> &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">[root@centos8 ~]<span class="comment"># mkdir -p /data/nginx/html/pc </span></span><br><span class="line">[root@centos8 ~]<span class="comment"># echo &quot;pc web&quot; &gt; /data/nginx/html/pc/index.html</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># systemctl  reload nginx</span></span><br><span class="line"><span class="comment">#访问测试</span></span><br></pre></td></tr></table></figure>

<h3 id="新建一个-Mobile-web-站点"><a href="#新建一个-Mobile-web-站点" class="headerlink" title="新建一个 Mobile web 站点"></a>新建一个 Mobile web 站点</h3><p><img src="../../../../images/SRE/day28/80.jpg" alt="80"></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ~]<span class="comment"># cat /apps/nginx/conf/conf.d/mobile.conf</span></span><br><span class="line">server &#123;</span><br><span class="line"> listen 80;</span><br><span class="line"> server_name m.wang.org;  <span class="comment">#指定第二个站点名称</span></span><br><span class="line"> location / &#123;</span><br><span class="line">   root /data/nginx/html/mobile;</span><br><span class="line"> &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">[root@centos8 ~]<span class="comment"># mkdir -p /data/nginx/html/mobile  </span></span><br><span class="line">[root@centos8 ~]<span class="comment"># echo &quot;mobile web&quot; &gt;&gt; /data/nginx/html/mobile/index.html</span></span><br><span class="line"></span><br><span class="line">[root@centos8 ~]<span class="comment"># systemctl reload nginx</span></span><br></pre></td></tr></table></figure>

<h3 id="root-与-alias"><a href="#root-与-alias" class="headerlink" title="root 与 alias"></a>root 与 alias</h3><p>root：指定web的家目录，在定义location的时候，文件的绝对路径等于 root+location</p>
<p>范例: </p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">  listen 80;</span><br><span class="line">  server_name www.wang.org;</span><br><span class="line">  location / &#123;</span><br><span class="line">    root /data/nginx/html/pc;</span><br><span class="line">  &#125;</span><br><span class="line">  location /about &#123;</span><br><span class="line">    root /opt/html; <span class="comment">#必须要在html目录中创建一个名为about的目录才可以访问，否则报错。</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">[root@centos8 ~]<span class="comment"># mkdir -p /opt/html/about</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># echo about &gt; /opt/html/about/index.html</span></span><br><span class="line"><span class="comment">#重启Nginx并访问测试</span></span><br></pre></td></tr></table></figure>

<p>alias：定义路径别名，会把访问的路径重新定义到其指定的路径,文档映射的另一种机制;仅能用于location上下文,此指令使用较少</p>
<p>范例: </p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">  listen 80;</span><br><span class="line">  server_name www.wang.org;</span><br><span class="line">  location / &#123;</span><br><span class="line">    root /data/nginx/html/pc;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  location /about &#123; <span class="comment">#注意about后不要加/ , 使用alias的时候uri后面如果加了斜杠,则下面的路径配置必须加斜杠，否则403</span></span><br><span class="line">    <span class="built_in">alias</span> /opt/html/about; <span class="comment">#当访问about的时候，会显示alias定义的/opt/html/about里面的内容。</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">#重启Nginx并访问测试</span></span><br></pre></td></tr></table></figure>

<p>注意：location中使用root指令和alias指令的意义不同</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">root 给定的路径对应于location中的/uri 左侧的/</span><br><span class="line">alias 给定的路径对应于location中的/uri 的完整路径</span><br></pre></td></tr></table></figure>

<h3 id="location-的详细使用"><a href="#location-的详细使用" class="headerlink" title="location 的详细使用"></a>location 的详细使用</h3><p>在一个server中location配置段可存在多个，用于实现从uri到文件系统的路径映射；ngnix会根据用户请求的URI来检查定义的所有location，按一定的优先级找出一个最佳匹配，而后应用其配置</p>
<p>在没有使用正则表达式的时候，nginx会先在server中的多个location选取匹配度最高的一个uri，uri是用户请求的字符串，即域名后面的web文件路径，然后使用该location模块中的正则url和字符串，如果匹配成功就结束搜索，并使用此location处理此请求。</p>
<p>location 官方帮助:</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://nginx.org/en/docs/http/ngx_http_core_module.html#location</span><br></pre></td></tr></table></figure>

<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#语法规则：</span></span><br><span class="line">location [ = | ~ | ~* | ^~ ] uri &#123; ... &#125;</span><br><span class="line"></span><br><span class="line">=   <span class="comment">#用于标准uri前，需要请求字串与uri精确匹配，大小敏感,如果匹配成功就停止向下匹配并立即处理请</span></span><br><span class="line">求</span><br><span class="line">^~  <span class="comment">#用于标准uri前，表示包含正则表达式,并且匹配以指定的正则表达式开头,对uri的最左边部分做匹配检查，不区分字符大小写</span></span><br><span class="line">~   <span class="comment">#用于标准uri前，表示包含正则表达式,并且区分大小写</span></span><br><span class="line">~*  <span class="comment">#用于标准uri前，表示包含正则表达式,并且不区分大写</span></span><br><span class="line">不带符号 <span class="comment">#匹配起始于此uri的所有的uri</span></span><br><span class="line">\   <span class="comment">#用于标准uri前，表示包含正则表达式并且转义字符。可以将 . * ?等转义为普通符号</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#匹配优先级从高到低：</span></span><br><span class="line">=, ^~, ~/~*, 不带符号</span><br></pre></td></tr></table></figure>

<p>官方范例</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">location = / &#123;</span><br><span class="line">   [ configuration A ]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">location / &#123;</span><br><span class="line">   [ configuration B ]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">location /documents/ &#123;</span><br><span class="line">   [ configuration C ]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">location ^~ /images/ &#123;</span><br><span class="line">   [ configuration D ]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">location ~* \.(gif|jpg|jpeg)$ &#123;</span><br><span class="line">   [ configuration E ]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">The “/” request will match configuration A(?), the “/index.html” request will match configuration B,</span><br><span class="line">the “/documents/document.html” request will match configuration C, the “/images/1.gif” request will match configuration D, and the “/documents/1.jpg” request will match configuration E.</span><br></pre></td></tr></table></figure>

<p>范例:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># cat /etc/nginx/conf.d/www.wang.org.conf</span></span><br><span class="line">server &#123;</span><br><span class="line">  listen 80;</span><br><span class="line">  server_name location.wang.org;</span><br><span class="line">  location = / &#123;</span><br><span class="line">    default_type text/html;</span><br><span class="line">    <span class="built_in">return</span> 200 <span class="string">&#x27;location = /&#x27;</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  location / &#123;</span><br><span class="line">    default_type text/html;</span><br><span class="line">    <span class="built_in">return</span> 200 <span class="string">&#x27;location /&#x27;</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  location /documents/ &#123;</span><br><span class="line">    default_type text/html;</span><br><span class="line">    <span class="built_in">return</span> 200 <span class="string">&#x27;location /documents/&#x27;</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  location ^~ /images/ &#123;</span><br><span class="line">    default_type text/html;</span><br><span class="line">    <span class="built_in">return</span> 200 <span class="string">&#x27;location ^~ /images/&#x27;</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  location ~* \.(gif|jpg|jpeg)$ &#123;</span><br><span class="line">    default_type text/html;</span><br><span class="line">    <span class="built_in">return</span> 200 <span class="string">&#x27;location ~* \.(gif|jpg|jpeg)&#x27;</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">#测试结果如下,建议是curl测试</span></span><br><span class="line"><span class="comment">#1.请求 http://location.wang.org/ 会被 location =/ 匹配</span></span><br><span class="line"><span class="comment">#2.请求 http://location.wang.org/index.html 会被 location / 匹配</span></span><br><span class="line"><span class="comment">#3.请求 http://location.wang.org/documents/1.html 会被 location /documents/ 匹配</span></span><br><span class="line"><span class="comment">#4.请求 http://location.wang.org/images/1.gif 会被 location ^~ /images/ 匹配</span></span><br><span class="line"><span class="comment">#5.请求 http://location.wang.org/documents/1.jpg 会被 location ~* \.(gif|jpg|jpeg)$匹配</span></span><br></pre></td></tr></table></figure>

<h4 id="匹配案例-精确匹配"><a href="#匹配案例-精确匹配" class="headerlink" title="匹配案例-精确匹配"></a>匹配案例-精确匹配</h4><p>在server部分使用location配置一个web界面，例如：当访问nginx 服务器的/logo.jpg的时候要显示指定html文件的内容</p>
<p>精确匹配一般用于匹配组织的logo等相对固定的URL,匹配优先级最高</p>
<p>范例: 精确匹配 logo</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ~]<span class="comment"># cat /apps/nginx/conf/conf.d/pc.conf </span></span><br><span class="line">server &#123;</span><br><span class="line">  listen 80;</span><br><span class="line">  server_name www.wang.org;</span><br><span class="line">  location / &#123;</span><br><span class="line">    root /data/nginx/html/pc;</span><br><span class="line">  &#125;</span><br><span class="line">  location = /logo.jpg &#123;</span><br><span class="line">    root /data/nginx/images;</span><br><span class="line">    index index.html;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">#上传logo.jpg图片到/data/nginx/images，重启Nginx并访问测试</span></span><br><span class="line"><span class="comment">#访问测试：http://www.wang.org/logo.jpg</span></span><br></pre></td></tr></table></figure>

<h4 id="匹配案例-区分大小写"><a href="#匹配案例-区分大小写" class="headerlink" title="匹配案例-区分大小写"></a>匹配案例-区分大小写</h4><p>~ 实现区分大小写的模糊匹配. 以下范例中, 如果访问uri中包含大写字母的JPG，则以下location匹配Ax.jpg条件不成功，因为 ~ 区分大小写，当用户的请求被执行匹配时发现location中定义的是小写的jpg，本次访问的uri匹配失败，后续要么继续往下匹配其他的location（如果有），要么报错给客户端</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">location ~ /A.?\.jpg &#123; <span class="comment">#匹配字母A开头的jpg图片，后面?表示A后面零次或一个字符</span></span><br><span class="line">   index index.html;</span><br><span class="line">   root /data/nginx/html/image;</span><br><span class="line">&#125;</span><br><span class="line">  </span><br><span class="line"><span class="comment">#重启Nginx并访问测试</span></span><br><span class="line"><span class="comment">#将只能访问以小写字符的jpg图片，不能识别大写的JPG结尾的图片</span></span><br></pre></td></tr></table></figure>

<p><img src="../../../../images/SRE/day28/81.jpg" alt="81"></p>
<p><img src="../../../../images/SRE/day28/82.jpg" alt="82"></p>
<h4 id="匹配案例-不区分大小写"><a href="#匹配案例-不区分大小写" class="headerlink" title="匹配案例-不区分大小写"></a>匹配案例-不区分大小写</h4><p>~* 用来对用户请求的uri做模糊匹配，uri中无论都是大写、都是小写或者大小写混合，此模式也都会匹配，通常使用此模式匹配用户request中的静态资源并继续做下一步操作,此方式使用较多</p>
<p>注意: 此方式中,对于Linux文件系统上的文件仍然是区分大小写的,如果磁盘文件不存在,仍会提示404 </p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#正则表达式匹配：</span></span><br><span class="line"> location ~* /A.?\.jpg &#123;</span><br><span class="line">   index index.html;</span><br><span class="line">   root /opt/nginx/html/image;</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">#重启Nginx并访问测试</span></span><br><span class="line">对于不区分大小写的location，则可以访问任意大小写结尾的图片文件,如区分大小写则只能访问Aa.jpg此类文件，不区分大小写则可以访问除了aa.jpg以外,还有其它的资源比如Aa.JPG、aA.jPG这样的混合名称文件，但是还同时也要求nginx服务器的资源目录有相应的文件，比如:必须有Aa.JPG,aA.jPG这样文件存在。</span><br></pre></td></tr></table></figure>

<p><img src="../../../../images/SRE/day28/83.jpg" alt="83"></p>
<h4 id="匹配案例-URI开始"><a href="#匹配案例-URI开始" class="headerlink" title="匹配案例-URI开始"></a>匹配案例-URI开始</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">location ^~ /images &#123;</span><br><span class="line">   root /data/nginx/;</span><br><span class="line">   index index.html;</span><br><span class="line"> &#125;</span><br><span class="line"> </span><br><span class="line">location /api &#123;</span><br><span class="line">   <span class="built_in">alias</span> /data/nginx/api;</span><br><span class="line">   index index.html;</span><br><span class="line">&#125;  </span><br><span class="line"></span><br><span class="line"><span class="comment">#重启Nginx并访问测试，实现效果是访问/images和/app返回不同的结果</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># curl http://www.wang.org/images/</span></span><br><span class="line">images</span><br><span class="line">[root@centos8 ~]<span class="comment"># curl http://www.wang.org/api/</span></span><br><span class="line">api web</span><br></pre></td></tr></table></figure>

<h4 id="匹配案例-文件名后缀"><a href="#匹配案例-文件名后缀" class="headerlink" title="匹配案例-文件名后缀"></a>匹配案例-文件名后缀</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ~]<span class="comment"># mkdir /data/nginx/static</span></span><br><span class="line"><span class="comment">#上传一个图片到/data/nginx/static</span></span><br><span class="line"></span><br><span class="line"> location ~* \.(gif|jpg|jpeg|bmp|png|tiff|tif|ico|wmf|js|css)$ &#123;</span><br><span class="line">   root /data/nginx/static;</span><br><span class="line">   index index.html;</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">#重启Nginx并访问测试</span></span><br></pre></td></tr></table></figure>

<h4 id="匹配案例-优先级"><a href="#匹配案例-优先级" class="headerlink" title="匹配案例-优先级"></a>匹配案例-优先级</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">location = /1.jpg &#123;</span><br><span class="line">   root /data/nginx/static1;</span><br><span class="line">   index index.html;</span><br><span class="line"> &#125;</span><br><span class="line"> </span><br><span class="line"> location /1.jpg &#123;</span><br><span class="line">   root /data/nginx/static2;</span><br><span class="line">   index index.html;</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"> location ~* \.(gif|jpg|jpeg|bmp|png|tiff|tif|ico|wmf|js)$ &#123;</span><br><span class="line">   root /data/nginx/static3;</span><br><span class="line">   index index.html;</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line">[root@centos8 ~]<span class="comment"># mkdir -p /data/nginx/static&#123;1,2,3&#125;</span></span><br><span class="line"><span class="comment">#上传图片到 /data/nginx/static&#123;1,2,3&#125; 并重启nginx访问测试</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#匹配优先级：=, ^~, ～/～*，/</span></span><br><span class="line">location优先级：(location =) &gt; (location ^~ 路径) &gt; (location ~,~* 正则顺序) &gt; (location 完整路径) &gt; (location 部分起始路径) &gt; (/)</span><br></pre></td></tr></table></figure>

<h4 id="生产使用案例"><a href="#生产使用案例" class="headerlink" title="生产使用案例"></a>生产使用案例</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#直接匹配网站根会加速Nginx访问处理</span></span><br><span class="line">location = /index.html &#123;</span><br><span class="line">   ......;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">location / &#123;</span><br><span class="line">   ......;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">#静态资源配置方法1</span></span><br><span class="line">location ^~ /static/ &#123;</span><br><span class="line">   ......;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">#静态资源配置方法2,应用较多</span></span><br><span class="line">location ~* \.(gif|jpg|jpeg|png|css|js|ico)$ &#123;</span><br><span class="line">   ......;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">#多应用配置</span></span><br><span class="line">location ~* /app1 &#123;</span><br><span class="line">     ......;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">location ~* /app2 &#123;</span><br><span class="line">     ......;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="Location-重定向"><a href="#Location-重定向" class="headerlink" title="Location @重定向"></a>Location @重定向</h4><p>location @name 这样的location不用于常规请求处理，而是用于请求重定向</p>
<p>范例: </p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># cat /etc/nginx/conf.d/www.wang.org.conf</span></span><br><span class="line">server &#123;</span><br><span class="line">  listen 80;</span><br><span class="line">  server_name www.wang.org;</span><br><span class="line">  root /data/www;</span><br><span class="line">  location / &#123;</span><br><span class="line">    index index.html;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">#如果出现异常,则重新定向到@error_404这个location上</span></span><br><span class="line">  error_page 404 @error_404;</span><br><span class="line">  location @error_404 &#123;</span><br><span class="line">    default_type text/html;</span><br><span class="line">    charset utf8;</span><br><span class="line">    <span class="built_in">return</span> 200 <span class="string">&#x27;你访问的页面可能走丢了!&#x27;</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="Nginx-常见模块"><a href="#Nginx-常见模块" class="headerlink" title="Nginx 常见模块"></a>Nginx 常见模块</h1><h2 id="Nginx-四层访问控制"><a href="#Nginx-四层访问控制" class="headerlink" title="Nginx 四层访问控制"></a>Nginx 四层访问控制</h2><p>访问控制基于模块ngx_http_access_module实现，可以通过匹配客户端源IP地址进行限制</p>
<p>注意: 如果能在防火墙设备控制,最好就不要在nginx上配置,可以更好的节约资源</p>
<p>官方帮助:</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://nginx.org/en/docs/http/ngx_http_access_module.html</span><br></pre></td></tr></table></figure>

<p><img src="../../../../images/SRE/day28/84.jpg" alt="84"></p>
<p>范例: </p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">location = /login/ &#123;</span><br><span class="line">   root /data/nginx/html/pc;</span><br><span class="line">   allow 10.0.0.0/24;</span><br><span class="line">   deny all;</span><br><span class="line"> &#125;</span><br><span class="line">location /about &#123;</span><br><span class="line">   <span class="built_in">alias</span> /data/nginx/html/pc;</span><br><span class="line">   index index.html;</span><br><span class="line">   deny  192.168.1.1;</span><br><span class="line">   allow 192.168.1.0/24;</span><br><span class="line">   allow 10.1.1.0/16;</span><br><span class="line">   allow 2001:0db8::/32;</span><br><span class="line">   deny all;              <span class="comment">#按先小范围在前，大范围在后排序</span></span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>

<h2 id="Nginx-账户认证功能"><a href="#Nginx-账户认证功能" class="headerlink" title="Nginx 账户认证功能"></a>Nginx 账户认证功能</h2><p>由 ngx_http_auth_basic_module 模块提供此功能</p>
<p>官方帮助:</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://nginx.org/en/docs/http/ngx_http_auth_basic_module.html</span><br></pre></td></tr></table></figure>

<p>范例: </p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#CentOS安装包</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># yum -y install httpd-tools</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#Ubuntu安装包</span></span><br><span class="line">[root@Ubuntu ~]<span class="comment"># apt -y install apache2-utils</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#创建用户</span></span><br><span class="line"><span class="comment">#-b 非交互式方式提交密码</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># htpasswd -cb /apps/nginx/conf/.htpasswd user1 123456</span></span><br><span class="line">Adding password <span class="keyword">for</span> user user1</span><br><span class="line"></span><br><span class="line">[root@centos8 ~]<span class="comment"># htpasswd -b /apps/nginx/conf/.htpasswd user2 123456</span></span><br><span class="line">Adding password <span class="keyword">for</span> user user2</span><br><span class="line"></span><br><span class="line">[root@centos8 ~]<span class="comment"># tail /apps/nginx/conf/.htpasswd </span></span><br><span class="line">user1:$apr1$Rjm0u2Kr<span class="variable">$VHvkAIc5OYg</span>.3ZoaGwaGq/</span><br><span class="line">user2:$apr1$nIqnxoJB<span class="variable">$LR9W1DTJT</span>.viDJhXa6wHv.</span><br><span class="line"></span><br><span class="line"><span class="comment">#安全加固</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># chown nginx.nginx /apps/nginx/conf/.htpasswd </span></span><br><span class="line">[root@centos8 ~]<span class="comment"># chmod 600 /apps/nginx/conf/.htpasswd </span></span><br><span class="line"></span><br><span class="line">[root@centos8 ~]<span class="comment"># vim /apps/nginx/conf/conf.d/pc.conf</span></span><br><span class="line"> location = /login/ &#123;</span><br><span class="line">   root /data/nginx/html/pc;</span><br><span class="line">   index index.html;</span><br><span class="line">   auth_basic           <span class="string">&quot;login password&quot;</span>;</span><br><span class="line">   auth_basic_user_file /apps/nginx/conf/.htpasswd; <span class="comment">#相对路径是相于/apps/nginx/conf的路径</span></span><br><span class="line"> &#125;</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"><span class="comment">#重启Nginx并访问测试</span></span><br><span class="line"></span><br><span class="line">[root@centos6 ~]<span class="comment">#curl http://user1:123456@www.wang.org/login/</span></span><br><span class="line">login page</span><br><span class="line">[root@centos6 ~]<span class="comment">#curl -u user2:123456 www.wang.org/login/</span></span><br><span class="line">login page</span><br></pre></td></tr></table></figure>

<h2 id="自定义错误页面"><a href="#自定义错误页面" class="headerlink" title="自定义错误页面"></a>自定义错误页面</h2><p>自定义错误页，同时也可以用指定的响应状态码进行响应, 可用位置：http, server, location, if in location</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">http://nginx.org/en/docs/http/ngx_http_core_module.html#error_page</span><br><span class="line"></span><br><span class="line"><span class="attribute">Syntax</span><span class="punctuation">: </span>error_page code ... [=[response]] uri;</span><br><span class="line"><span class="attribute">Default</span><span class="punctuation">: </span>—</span><br><span class="line"><span class="attribute">Context</span><span class="punctuation">: </span>http, server, location, if in location</span><br></pre></td></tr></table></figure>

<p>范例: </p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">listen 80;</span><br><span class="line">server_name www.wang.org;</span><br><span class="line">error_page  500 502 503 504 /error.html;</span><br><span class="line">location = /error.html &#123;</span><br><span class="line">   root /data/nginx/html;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">#重启nginx并访问不存在的页面进行测试</span></span><br></pre></td></tr></table></figure>

<p>范例: 自定义错误页面</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">error_page 404 /40x.html;</span><br><span class="line">location = /40x.html &#123;</span><br><span class="line">  root /data/html/ ;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>范例: 如果404,就转到主页</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#404转为302</span></span><br><span class="line"><span class="comment">#error_page 404 /index.html;</span></span><br><span class="line">error_page  404  =302 /index.html; </span><br><span class="line">error_page 500 502 503 504 /50x.html;</span><br><span class="line">     location = /50x.html &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>范例: 浏览器”截胡”</p>
<p>使用360浏览器访问基于IP的web主机上面的不存在的页面时,会自动用广告页面代替错误页面</p>
<p><img src="../../../../images/SRE/day28/85.jpg" alt="85"></p>
<p><img src="../../../../images/SRE/day28/86.jpg" alt="86"></p>
<h2 id="自定义错误日志"><a href="#自定义错误日志" class="headerlink" title="自定义错误日志"></a>自定义错误日志</h2><p>可以自定义错误日志</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">Syntax: error_log file [level];</span><br><span class="line">Default: </span><br><span class="line">error_log logs/error.log error;</span><br><span class="line">Context: main, http, mail, stream, server, location</span><br><span class="line">level: debug, info, notice, warn, error, crit, alert, emerg</span><br><span class="line"></span><br><span class="line"><span class="comment">#关闭错误日志</span></span><br><span class="line">error_log /dev/null;</span><br></pre></td></tr></table></figure>

<p>范例: </p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ~]<span class="comment"># mkdir /data/nginx/logs</span></span><br><span class="line"> listen 80;</span><br><span class="line"> server_name www.wang.org;</span><br><span class="line"> error_page  500 502 503 504 404 /error.html; </span><br><span class="line"> access_log /apps/nginx/logs/wang.org_access.log; </span><br><span class="line"> error_log /apps/nginx/logs/wang.org_error.log; <span class="comment">#定义错误日志</span></span><br><span class="line"> location = /error.html &#123;</span><br><span class="line">    root   html;</span><br><span class="line"> &#125;</span><br><span class="line"><span class="comment">#重启nginx并访问不存在的页面进行测试并验证是在指定目录生成新的日志文件</span></span><br></pre></td></tr></table></figure>

<p>范例:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root@rocky8 ~]<span class="comment">#cat /etc/nginx/conf.d/www.wang.org.conf</span></span><br><span class="line">server &#123;</span><br><span class="line">   listen 80 default_server;</span><br><span class="line">   server_name www.wang.org;</span><br><span class="line">   root /data/nginx/html/pc;</span><br><span class="line">   index index.html;</span><br><span class="line">   error_log /apps/nginx/logs/www.wang.org-error.log; <span class="comment">#全局配置启用错误日志路径</span></span><br><span class="line">   location /login &#123;</span><br><span class="line">       error_log /dev/null;  <span class="comment">#针对/login目录的错误日志不记录</span></span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>范例: </p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># cat /etc/nginx/conf.d/www.wang.org.conf</span></span><br><span class="line">server &#123;</span><br><span class="line">  listen 80;</span><br><span class="line">  server_name www.wang.org;</span><br><span class="line">  root /data/www;</span><br><span class="line">  location / &#123;</span><br><span class="line">  index index.html;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">#如果出现异常,则重新定向到@error_404这个location上</span></span><br><span class="line">  error_page 404 @error_404;</span><br><span class="line">  location @error_404 &#123;</span><br><span class="line">    default_type text/html;</span><br><span class="line">    charset utf8;</span><br><span class="line">    <span class="built_in">return</span> 200 <span class="string">&#x27;你访问的页面可走丢了!&#x27;</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="检测文件是否存在"><a href="#检测文件是否存在" class="headerlink" title="检测文件是否存在"></a>检测文件是否存在</h2><p>try_files 会按顺序检查文件是否存在，返回第一个找到的文件或文件夹（结尾加斜线表示为文件夹），如果所有文件或文件夹都找不到，会进行一个内部重定向到最后一个参数。只有最后一个参数可以引起一个内部重定向，之前的参数只设置内部URI的指向。最后一个参数是回退URI且必须存在，否则会出现内部500错误。</p>
<p>语法格式</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">Syntax</span><span class="punctuation">: </span>try_files file ... uri;</span><br><span class="line">try_files file ... =code;</span><br><span class="line"><span class="attribute">Default</span><span class="punctuation">: </span>—</span><br><span class="line"><span class="attribute">Context</span><span class="punctuation">: </span>server, location</span><br></pre></td></tr></table></figure>

<p>范例: 如果不存在页面, 就转到default.html页面</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">location / &#123;</span><br><span class="line">   root /data/nginx/html/pc;</span><br><span class="line">   index index.html;</span><br><span class="line">   try_files <span class="variable">$uri</span>  <span class="variable">$uri</span>.html <span class="variable">$uri</span>/index.html /about/default.html;</span><br><span class="line">    <span class="comment">#try_files $uri $uri/index.html $uri.html =489;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">[root@centos8 ~]<span class="comment"># echo &quot;default page&quot; &gt;&gt; /data/nginx/html/pc/about/default.html</span></span><br><span class="line"><span class="comment">#重启nginx并测试，当访问到http://www.wang.org/about/xx.html等不存在的uri会显示default.html，如果是自定义的状态码则会显示在返回数据的状态码中</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#注释default.html行,启用上面489响应码的那一行,在其生效后再观察结果</span></span><br><span class="line">location / &#123;</span><br><span class="line">   root /data/nginx/html/pc;</span><br><span class="line">   index index.html;</span><br><span class="line">    <span class="comment">#try_files $uri $uri.html $uri/index.html /about/default.html;</span></span><br><span class="line">   try_files <span class="variable">$uri</span> <span class="variable">$uri</span>/index.html <span class="variable">$uri</span>.html =489;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">[root@centos8 ~]<span class="comment"># curl -I http://www.wang.org/about/xx.html</span></span><br><span class="line">HTTP/1.1 489 <span class="comment">#489就是自定义的状态返回码</span></span><br><span class="line">Server: nginx</span><br><span class="line">Date: Thu, 21 Feb 2019 00:11:40 GMT</span><br><span class="line">Content-Length: 0</span><br><span class="line">Connection: keep-alive</span><br><span class="line">Keep-Alive: <span class="built_in">timeout</span>=65</span><br></pre></td></tr></table></figure>

<h2 id="长连接配置"><a href="#长连接配置" class="headerlink" title="长连接配置"></a>长连接配置</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">http://nginx.org/en/docs/http/ngx_http_core_module.html<span class="comment">#keepalive_timeout</span></span><br><span class="line"></span><br><span class="line">Syntax: keepalive_requests number;</span><br><span class="line">Default: </span><br><span class="line">keepalive_requests 1000;</span><br><span class="line">Context: http, server, location</span><br><span class="line">This directive appeared <span class="keyword">in</span> version 0.8.0.</span><br><span class="line"></span><br><span class="line">Syntax: keepalive_time time;</span><br><span class="line">Default: </span><br><span class="line">keepalive_time 1h;</span><br><span class="line">Context: http, server, location</span><br><span class="line">This directive appeared <span class="keyword">in</span> version 1.19.10.</span><br><span class="line"></span><br><span class="line">Syntax: keepalive_timeout <span class="built_in">timeout</span> [header_timeout];</span><br><span class="line">Default: </span><br><span class="line">keepalive_timeout 75s;</span><br><span class="line">Context: http, server, location</span><br><span class="line"></span><br><span class="line">keepalive_time time; <span class="comment">#限制对一个连接中请求处理的最长时间,到时间后续的再有新的请求会断开连接,默认1h</span></span><br><span class="line">keepalive_timeout <span class="built_in">timeout</span> [header_timeout];  <span class="comment">#设置保持空闲的连接超时时长，0表示禁止长连接，默认为75s，通常配置在http字段作为站点全局配置</span></span><br><span class="line">keepalive_requests number;  <span class="comment">#在一次长连接上所允许请求的资源的最大数量，默认为1000次</span></span><br></pre></td></tr></table></figure>

<p>范例: </p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">keepalive_requests 3;</span><br><span class="line">keepalive_timeout  65 60;</span><br><span class="line"><span class="comment">#开启长连接后，返回客户端的会话保持时间为60s，单次长连接累计请求达到指定次数请求或65秒就会被断开，第二个数字60为发送给客户端应答报文头部中显示的超时时间设置为60s：如不设置客户端将不显示超时时间。</span></span><br><span class="line">Keep-Alive:<span class="built_in">timeout</span>=60  <span class="comment">#浏览器收到的服务器返回的报文</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#如果设置为0表示关闭会话保持功能，将如下显示：</span></span><br><span class="line">Connection:close  <span class="comment">#浏览器收到的服务器返回的报文</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#使用命令测试：</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># telnet www.wang.org 80</span></span><br><span class="line">Trying 10.0.0.8...</span><br><span class="line">Connected to www.wang.org.</span><br><span class="line">Escape character is <span class="string">&#x27;^]&#x27;</span>.</span><br><span class="line">GET / HTTP/1.1</span><br><span class="line">HOST: www.wang.org</span><br><span class="line"></span><br><span class="line"><span class="comment">#Response Headers(响应头信息)：</span></span><br><span class="line">HTTP/1.1 200 OK</span><br><span class="line">Server: nginx/1.18.0</span><br><span class="line">Date: Thu, 24 Sep 2020 04:35:35 GMT</span><br><span class="line">Content-Type: text/html</span><br><span class="line">Content-Length: 7</span><br><span class="line">Last-Modified: Wed, 23 Sep 2020 14:39:21 GMT</span><br><span class="line">Connection: keep-alive</span><br><span class="line">Keep-Alive: <span class="built_in">timeout</span>=60</span><br><span class="line">ETag: <span class="string">&quot;5c8a6b3a-7&quot;</span></span><br><span class="line">Accept-Ranges: bytes</span><br><span class="line"></span><br><span class="line"><span class="comment">#页面内容</span></span><br><span class="line">pc web</span><br></pre></td></tr></table></figure>

<h2 id="作为下载服务器配置"><a href="#作为下载服务器配置" class="headerlink" title="作为下载服务器配置"></a>作为下载服务器配置</h2><p>ngx_http_autoindex_module 模块处理以斜杠字符 “/“ 结尾的请求，并生成目录列表,可以做为下载服务配置使用</p>
<p>官方文档:</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://nginx.org/en/docs/http/ngx_http_autoindex_module.html</span><br></pre></td></tr></table></figure>

<p>相关指令:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">Syntax: autoindex on | off;</span><br><span class="line">Default: </span><br><span class="line">autoindex off;</span><br><span class="line">Context: http, server, location</span><br><span class="line"></span><br><span class="line">autoindex on | off;<span class="comment">#自动文件索引功能，默为off</span></span><br><span class="line">autoindex_exact_size on | off;  <span class="comment">#计算文件确切大小（单位bytes），off 显示大概大小（单位K、M)，默认on</span></span><br><span class="line">autoindex_localtime on | off ; <span class="comment">#显示本机时间而非GMT(格林威治)时间，默认off</span></span><br><span class="line">charset charset | off;  <span class="comment">#指定字符编码,默认为off,中文会乱码,指定为utf8</span></span><br><span class="line">autoindex_format html | xml | json | jsonp; <span class="comment">#显示索引的页面文件风格，默认html</span></span><br><span class="line">limit_rate rate; <span class="comment">#限制响应客户端传输速率(除GET和HEAD以外的所有方法)，单位B/s,即bytes/second，默认值0,表示无限制,此指令由ngx_http_core_module提供</span></span><br><span class="line"><span class="built_in">set</span> <span class="variable">$limit_rate</span> 4k; <span class="comment">#也可以通变量限速,单位B/s,同时设置,此项优级高.Rate limit can also be set in the $limit_rate variable, however, since version 1.17.0, this method is not recommended:</span></span><br></pre></td></tr></table></figure>

<p>范例: 实现下载站点</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#注意:download不需要index.html文件</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># mkdir -p /data/nginx/html/pc/download</span></span><br><span class="line"></span><br><span class="line">[root@centos8 ~]<span class="comment"># vim /apps/nginx/conf/conf.d/pc.conf</span></span><br><span class="line"> location /download &#123;</span><br><span class="line">   autoindex on;    <span class="comment">#自动索引功能</span></span><br><span class="line">   autoindex_exact_size   on; <span class="comment">#计算文件确切大小（单位bytes），此为默认值,off只显示大概大小（单位kb、mb、gb）  </span></span><br><span class="line">   autoindex_localtime   on; <span class="comment">#on表示显示本机时间而非GMT(格林威治)时间,默为为off显示GMT时间</span></span><br><span class="line">   charset utf8;             <span class="comment">#支持中文</span></span><br><span class="line">   limit_rate 1024k;   <span class="comment">#限速,默认不限速</span></span><br><span class="line">   root /data/nginx/html/pc;</span><br><span class="line"> &#125;</span><br><span class="line">  </span><br><span class="line">[root@centos8 ~]<span class="comment"># cp /root/anaconda-ks.cfg /data/nginx/html/pc/download/</span></span><br><span class="line"><span class="comment">#重启Nginx并访问测试下载页面</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#可以从清华大学镜像源同步下载实现仓库功能</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># rsync -avz rsync://mirrors.tuna.tsinghua.edu.cn/ubuntu /download/ubuntu</span></span><br></pre></td></tr></table></figure>

<p><img src="../../../../images/SRE/day28/87.jpg" alt="87"></p>
<h2 id="作为上传服务器"><a href="#作为上传服务器" class="headerlink" title="作为上传服务器"></a>作为上传服务器</h2><p>以下指令控制上传数据</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">client_max_body_size 1m; <span class="comment">#设置允许客户端上传单个文件的最大值，默认值为1m,上传文件超过此值会出413错误</span></span><br><span class="line">client_body_buffer_size size; <span class="comment">#用于接收每个客户端请求报文的body部分的缓冲区大小;默认16k;超出此大小时，其将被暂存到磁盘上的由client_body_temp_path指令所定义的位置</span></span><br><span class="line">client_body_temp_path path [level1 [level2 [level3]]];</span><br><span class="line"><span class="comment">#设定存储客户端请求报文的body部分的临时存储路径及子目录结构和数量，目录名为16进制的数字，使用hash之后的值从后往前截取1位、2位、2位作为目录名</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@centos8 ~]<span class="comment"># md5sum /data/nginx/html/pc/index.html </span></span><br><span class="line">95f6f65f498c74938064851b1bb 96 3d 4 /data/nginx/html/pc/index.html</span><br><span class="line">1级目录占1位16进制，即2^4=16个目录  0-f</span><br><span class="line">2级目录占2位16进制，即2^8=256个目录 00-ff</span><br><span class="line">3级目录占2位16进制，即2^8=256个目录 00-ff</span><br><span class="line"></span><br><span class="line"><span class="comment">#配置示例：</span></span><br><span class="line">client_max_body_size 100m; <span class="comment">#如果太大，上传时会出现下图的413错误,注意:如果php上传,还需要修改php.ini的相关配置</span></span><br><span class="line">client_body_buffer_size 1024k;</span><br><span class="line">client_body_temp_path   /apps/nginx/client_body_temp/ 1 2 2; <span class="comment">#上传时,Nginx会自动创建相关目录</span></span><br></pre></td></tr></table></figure>

<p>范例: </p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root@ubuntu2004 ~]<span class="comment"># ll /var/log/syslog -h</span></span><br><span class="line">-rw-r----- 1 syslog adm 1.9M Mar  2 08:54 /var/log/syslog</span><br><span class="line"></span><br><span class="line">[root@ubuntu2004 ~]<span class="comment"># curl -T /var/log/syslog http://10.0.0.8/</span></span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;<span class="built_in">head</span>&gt;&lt;title&gt;413 Request Entity Too Large&lt;/title&gt;&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">&lt;center&gt;&lt;h1&gt;413 Request Entity Too Large&lt;/h1&gt;&lt;/center&gt;</span><br><span class="line">&lt;hr&gt;&lt;center&gt;nginx/1.20.2&lt;/center&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure>

<p><img src="../../../../images/SRE/day28/88.jpg" alt="88"></p>
<p><img src="../../../../images/SRE/day28/89.jpg" alt="89"></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#上传超过nginx指定client_max_body_size值会出413错误</span></span><br><span class="line">[root@wang-liyun-pc ~]<span class="comment"># tail /apps/nginx/logs/nginx.access.log</span></span><br><span class="line">125.41.184.117 - - [27/Sep/2020:00:09:00 +0800] <span class="string">&quot;POST /wp-admin/async-upload.php HTTP/1.1&quot;</span> 413 578 <span class="string">&quot;http://www.wangxiaochun.com/wp-admin/post-new.php&quot;</span></span><br><span class="line"><span class="string">&quot;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/85.0.4183.121 Safari/537.36 Edg/85.0.564.63&quot;</span> <span class="string">&quot;-&quot;</span></span><br></pre></td></tr></table></figure>

<p><img src="../../../../images/SRE/day28/90.jpg" alt="90"></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#上传文件后,会自动生成相关目录</span></span><br><span class="line">[root@wang-liyun-pc ~]<span class="comment"># tree /apps/nginx/client_body_temp/</span></span><br><span class="line">/apps/nginx/client_body_temp/</span><br><span class="line">├── 5</span><br><span class="line">│   └── 00</span><br><span class="line">│       └── 00</span><br><span class="line">└── 6</span><br><span class="line">   └── 00</span><br><span class="line">       └── 00</span><br></pre></td></tr></table></figure>

<h2 id="限流限速"><a href="#限流限速" class="headerlink" title="限流限速"></a>限流限速</h2><h3 id="为什么要限速"><a href="#为什么要限速" class="headerlink" title="为什么要限速"></a>为什么要限速</h3><p>限制某个用户在一定时间内能够产生的Http请求或者限制某个用户的下载速度。防止个别用户对资源消耗过多,导致其它用户受影响. </p>
<p>启用限速后,如果超过指定的阈值,则提示503过载保护</p>
<h3 id="限速相关模块"><a href="#限速相关模块" class="headerlink" title="限速相关模块"></a>限速相关模块</h3><p>下载限速：限制用户下载资源的速度</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ngx_http_core_module</span><br></pre></td></tr></table></figure>

<p>请求限制：限制用户单位时间内所产生的Http请求数</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ngx_http_limit_req_module</span><br></pre></td></tr></table></figure>

<p>连接限制：限制同一时间的连接数，即并发数限制</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ngx_http_limit_conn_module</span><br></pre></td></tr></table></figure>

<h3 id="请求频率限速原理"><a href="#请求频率限速原理" class="headerlink" title="请求频率限速原理"></a>请求频率限速原理</h3><p>先将请求放置缓存中，然后按指定速度持续处理。当请求速度超过了处理速度会导致缓存被占满，如果还有没有放入缓存的请求，则会被丢弃。</p>
<p>工作原理类似于漏斗</p>
<h3 id="限制下载速度"><a href="#限制下载速度" class="headerlink" title="限制下载速度"></a>限制下载速度</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># cat /etc/nginx/conf.d/mirrors.wang.conf</span></span><br><span class="line">server &#123;</span><br><span class="line">  listen 80;</span><br><span class="line">  server_name mirrors.wang.org;</span><br><span class="line">  root /data/mirrors/;</span><br><span class="line">  charset utf8;</span><br><span class="line">  autoindex on;</span><br><span class="line">  autoindex_exact_size off;</span><br><span class="line">  autoindex_localtime on;</span><br><span class="line">  limit_rate_after 100m;  <span class="comment">#下载达到100MB数据后开始限速</span></span><br><span class="line">  limit_rate 100k;        <span class="comment">#限速100k</span></span><br><span class="line">  location / &#123;</span><br><span class="line">    index index.html;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="限制请求数"><a href="#限制请求数" class="headerlink" title="限制请求数"></a>限制请求数</h3><p>限制同一个IP的同时发起的最大请求数</p>
<p>指令</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">http://nginx.org/en/docs/http/ngx_http_limit_req_module.html</span><br><span class="line"></span><br><span class="line">Syntax: limit_req_zone key zone=name:size rate=rate [<span class="built_in">sync</span>];</span><br><span class="line">Default: —</span><br><span class="line">Context: http</span><br><span class="line"></span><br><span class="line">Syntax: limit_req zone=name [burst=number] [nodelay | delay=number];</span><br><span class="line">Default: —</span><br><span class="line">Context: http, server, location</span><br><span class="line"></span><br><span class="line">Syntax: limit_req_status code;</span><br><span class="line">Default: </span><br><span class="line">limit_req_status 503;</span><br><span class="line">Context: http, server, location</span><br><span class="line"></span><br><span class="line"><span class="comment">#示例:</span></span><br><span class="line">http &#123;</span><br><span class="line">   limit_req_zone <span class="variable">$binary_remote_addr</span> zone=one:10m rate=10r/s;</span><br><span class="line">   ...</span><br><span class="line">   server &#123;</span><br><span class="line">       ...</span><br><span class="line">       location /search/ &#123;</span><br><span class="line">           limit_req zone=one burst=5;</span><br><span class="line">           limit_req_status 500; <span class="comment">#默认503,可以指定其它状态码</span></span><br><span class="line">       &#125;</span><br><span class="line">      </span><br><span class="line"><span class="comment">#参数说明</span></span><br><span class="line">limit_req_zone定义在http块中，<span class="variable">$binary_remote_addr</span>表示以客户端IP地址的二进制形式为限流依据的key</span><br><span class="line">Zone定义IP状态及URL访问频率的共享内存区域。zone=keyword标识区域的名字，以及冒号后面跟区域大小。8000个IP地址的状态信息约1MB，例子区域可以存储80000个IP地址。</span><br><span class="line">Rate定义最大请求速率。示例中速率不能超过每秒10个请求。超过此速率的请求放入burst队列做延迟处理</span><br><span class="line">burst表示队列大小,当此队列满后,会中断请求报错</span><br><span class="line">nodelay表示超过请求速率并且缓存区满后不延迟处理,立即返回503错误</span><br><span class="line"></span><br><span class="line"><span class="comment">#可以有几个limit_req指令。例如，以下配置将限制来自单个 IP 地址的请求的处理速率，同时限制虚拟服务器的请求处理速率</span></span><br><span class="line"><span class="comment">#示例:</span></span><br><span class="line">limit_req_zone <span class="variable">$binary_remote_addr</span> zone=perip:10m rate=1r/s;</span><br><span class="line">limit_req_zone <span class="variable">$server_name</span> zone=perserver:10m rate=10r/s;</span><br><span class="line">server &#123;</span><br><span class="line">   ...</span><br><span class="line">   limit_req zone=perip burst=5 nodelay;</span><br><span class="line">   limit_req zone=perserver burst=10;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>范例: 基于来源IP对下载速率限制，限制每秒处理1次请求，缓存区请求突发队列为10个</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># http标签段定义请求限制, rate限制速率，限制一秒钟最多一个IP请求</span></span><br><span class="line"><span class="comment">#注意:$remote_addr和$binary_remote_addr的不同</span></span><br><span class="line">http &#123;</span><br><span class="line">   limit_req_zone <span class="variable">$binary_remote_addr</span>  zone=req_one:10m rate=1r/s;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">server &#123;</span><br><span class="line">   listen 80;</span><br><span class="line">   server_name mirrors.wang.org;</span><br><span class="line">    <span class="comment">#请求超过1r/s,剩下的将被延迟处理,请求数超过burst定义的数量，则返回503</span></span><br><span class="line">   limit_req zone=req_one burst=10 nodelay;</span><br><span class="line">   location / &#123;</span><br><span class="line">       root /data/mirrors/;</span><br><span class="line">       index index.html;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">limit_req_zone <span class="variable">$binary_remote_addr</span> zone=req_one:10m rate=1r/s;</span><br><span class="line"><span class="comment">#第一个参数：$binary_remote_addr表示通过这个标识来做限制，限制同一客户端ip地址。</span></span><br><span class="line"><span class="comment">#第二个参数：zone=req_one:10m表示生成一个大小为10M，名为req_one的内存区域用来存储访问频次信息</span></span><br><span class="line"><span class="comment">#第三个参数：rate=1r/s表示允许相同标识的客户端的访问频次，此处限制的是每秒1次。</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">limit_req zone=req_one burst=10 nodelay;</span><br><span class="line"><span class="comment">#第一个参数：zone=req_one 设置使用哪个配置区域来做限制，与上面limit_req_zone的name对应。</span></span><br><span class="line"><span class="comment">#第二个参数：burst=10，设置一个大小为10的缓冲区，当有大量请求过来时，超过了访问频次限制的请求可以先放到这个缓冲区内。</span></span><br><span class="line"><span class="comment">#第三个参数：nodelay，超过访问频次并且缓冲区也满了的时候，则会返回503，如果没有设置，则所有请求会等待排队。</span></span><br></pre></td></tr></table></figure>

<h3 id="限制并发连接数"><a href="#限制并发连接数" class="headerlink" title="限制并发连接数"></a>限制并发连接数</h3><p>限制同一个IP的同时发起的最大并发连接数</p>
<p>指令</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Syntax: limit_conn_zone key zone=name:size;</span><br><span class="line">Default: —</span><br><span class="line">Context: http</span><br><span class="line"></span><br><span class="line">Syntax: limit_conn zone number;</span><br><span class="line">Default: —</span><br><span class="line">Context: http, server, location</span><br></pre></td></tr></table></figure>

<p>范例: 设置共享内存区域和给定键值的最大允许个连接数。超过此限制时服务器将返回503错误</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># cat /etc/nginx/conf.d/mirrors.wang.org.conf</span></span><br><span class="line">limit_conn_zone <span class="variable">$binary_remote_addr</span> zone=conn_zone:10m;</span><br><span class="line">server &#123;</span><br><span class="line">  listen 80;</span><br><span class="line">  server_name mirrors.wang.org;</span><br><span class="line">  root /data/mirrors/;</span><br><span class="line">  charset utf8;</span><br><span class="line">  autoindex on;</span><br><span class="line">  autoindex_exact_size off;</span><br><span class="line">  autoindex_localtime on;</span><br><span class="line">  limit_conn conn_zone 2; <span class="comment">#限制并发2个连接</span></span><br><span class="line">  limit_rate 100k;</span><br><span class="line">  location / &#123;</span><br><span class="line">    index index.html;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="综合实战"><a href="#综合实战" class="headerlink" title="综合实战"></a>综合实战</h3><p>实现百度云盘非会员限度限流功能: </p>
<ul>
<li>当下载超过100M则限制下载速度为500k</li>
<li>限制web服务器请求数处理为1秒一个，触发值为5、限制用户仅可同时下载一个文件。</li>
<li>如果同时下载超过2个资源，则返回提示 “请联系管理员进行会员充值” 并跳转到其他页面</li>
</ul>
<p>范例: </p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#cat /etc/nginx/conf.d/mirrors.wang.conf</span></span><br><span class="line">limit_req_zone <span class="variable">$binary_remote_addr</span> zone=req_zone:10m rate=1r/s;</span><br><span class="line">limit_conn_zone <span class="variable">$binary_remote_addr</span> zone=conn_zone:10m;</span><br><span class="line">server &#123;</span><br><span class="line">    listen 80;</span><br><span class="line">    server_name mirrors.wang.org;</span><br><span class="line">    root /data/mirrors/;</span><br><span class="line">    charset utf8;</span><br><span class="line">    autoindex on;</span><br><span class="line">    autoindex_exact_size off;</span><br><span class="line">    autoindex_localtime on;</span><br><span class="line">    limit_req zone=req_zone burst=5 nodelay;</span><br><span class="line">    limit_conn conn_zone 2;</span><br><span class="line">    limit_rate_after 100m;</span><br><span class="line">    limit_rate 500k;</span><br><span class="line">    error_page 503 @error_page;</span><br><span class="line">    location @error_page &#123;</span><br><span class="line">        default_type text/html;</span><br><span class="line">        charset utf8; </span><br><span class="line">        <span class="built_in">return</span> 200 <span class="string">&#x27;温馨提示:请联系管理员进行会员充值!&#x27;</span>;</span><br><span class="line">        <span class="comment">#return https://pan.baidu.com/buy/center?tag=8&amp;from=loginpage#/svip ;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">#先建立两次连接，再执行下面可以看到如果提示</span></span><br><span class="line">[root@centos7 ~]<span class="comment"># curl -I mirrors.wang.org -I</span></span><br><span class="line">HTTP/1.1 302 Moved Temporarily</span><br><span class="line">Server: nginx/1.22.0</span><br><span class="line">Date: Wed, 14 Sep 2022 10:37:19 GMT</span><br><span class="line">Content-Type: text/html</span><br><span class="line">Content-Length: 145</span><br><span class="line">Connection: keep-alive</span><br><span class="line">Location: 温馨提示:请联系管理员进行会员充值!</span><br></pre></td></tr></table></figure>

<h2 id="Nginx-状态页"><a href="#Nginx-状态页" class="headerlink" title="Nginx 状态页"></a>Nginx 状态页</h2><p>基于nginx 模块 ngx_http_stub_status_module 实现，在编译安装nginx的时候需要添加编译参数 –with-http_stub_status_module，否则配置完成之后监测会是提示语法错误</p>
<p>注意: 状态页显示的是整个服务器的状态,而非虚拟主机的状态</p>
<p>指令</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">http://nginx.org/en/docs/http/ngx_http_stub_status_module.html</span><br><span class="line"></span><br><span class="line"><span class="attribute">Syntax</span><span class="punctuation">: </span>stub_status;</span><br><span class="line"><span class="attribute">Default</span><span class="punctuation">: </span>—</span><br><span class="line"><span class="attribute">Context</span><span class="punctuation">: </span>server, location</span><br></pre></td></tr></table></figure>

<p>范例:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#配置示例：</span></span><br><span class="line">location /nginx_status &#123;</span><br><span class="line">   stub_status;</span><br><span class="line">   auth_basic           <span class="string">&quot;auth login&quot;</span>;</span><br><span class="line">   auth_basic_user_file /apps/nginx/conf/.htpasswd;</span><br><span class="line">   allow 192.168.0.0/16;</span><br><span class="line">   allow 127.0.0.1;</span><br><span class="line">   deny all;</span><br><span class="line">   access_log off;</span><br><span class="line"> &#125;</span><br><span class="line"> </span><br><span class="line"><span class="comment">#状态页用于输出nginx的基本状态信息：</span></span><br><span class="line"><span class="comment">#输出信息示例：</span></span><br><span class="line">Active connections: 291</span><br><span class="line">server accepts handled requests</span><br><span class="line">   16630948 16630948 31070465</span><br><span class="line">   上面三个数字分别对应accepts,handled,requests三个值</span><br><span class="line">Reading: 6 Writing: 179 Waiting: 106</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Active connections： <span class="comment">#当前处于活动状态的客户端连接数，包括连接等待空闲连接数=reading+writing+waiting</span></span><br><span class="line">accepts：<span class="comment">#统计总值，Nginx自启动后已经接受的客户端请求连接的总数。</span></span><br><span class="line">handled：<span class="comment">#统计总值，Nginx自启动后已经处理完成的客户端请求连接总数，通常等于accepts，除非有因worker_connections限制等被拒绝的失败连接,即失败连接数=accepts-handled</span></span><br><span class="line">requests：<span class="comment">#统计总值，Nginx自启动后客户端发来的总的请求数。因为长连接的原因此值大于上面的accept数</span></span><br><span class="line">Reading：<span class="comment">#当前状态，正在读取客户端请求报文首部的连接的连接数,数值越大,说明排队现象严重,性能不足</span></span><br><span class="line">Writing：<span class="comment">#当前状态，正在向客户端发送响应报文过程中的连接数,数值越大,说明访问量很大</span></span><br><span class="line">Waiting：<span class="comment">#当前状态，正在等待客户端发出请求的空闲连接数，开启keep-alive时,Waiting+reading+writing=active connections</span></span><br></pre></td></tr></table></figure>

<p>范例: 分析网站当前访问量</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@centos7 ~]<span class="comment"># curl -s http://wang:123456@www.wangxiaochun.com/nginx_status |awk -F: &#x27;NR==1&#123;print $NF&#125;&#x27;</span></span><br><span class="line"></span><br><span class="line">[root@centos7 ~]<span class="comment"># curl http://wang:123456@www.wangxiaochun.com/nginx_status 2&gt; /dev/null |awk &#x27;/Reading/&#123;print $2,$4,$6&#125;&#x27;</span></span><br><span class="line">0 1 15</span><br><span class="line"></span><br><span class="line">[root@centos7 ~]<span class="comment"># curl -s   http://wang:654321@www.wangxiaochun.com/nginx_status | sed -rn &#x27;/Reading/s/Reading:(.*)Writing:(.*)Waiting:(.*)/\1\2\3/p</span></span><br><span class="line"></span><br><span class="line">[root@centos7 ~]<span class="comment"># echo &quot;Nginx失败TCP连接数: $(curl -s http://wang:123456@www.wangxiaochun.com/nginx_status |awk &#x27;NR==3&#123;print $1-$2&#125;&#x27;)&quot;</span></span><br></pre></td></tr></table></figure>

<h2 id="Nginx-第三方模块"><a href="#Nginx-第三方模块" class="headerlink" title="Nginx 第三方模块"></a>Nginx 第三方模块</h2><p>第三模块是对nginx 的功能扩展，第三方模块需要在编译安装Nginx 的时候使用参数–add-module=PATH指定路径添加，有的模块是由公司的开发人员针对业务需求定制开发的，有的模块是开源爱好者开发好之后上传到github进行开源的模块，nginx的第三方模块需要从源码重新编译进行支持</p>
<h3 id="nginx-module-vts-模块实现流量监控"><a href="#nginx-module-vts-模块实现流量监控" class="headerlink" title="nginx-module-vts 模块实现流量监控"></a>nginx-module-vts 模块实现流量监控</h3><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://github.com/vozlt/nginx-module-vts</span><br></pre></td></tr></table></figure>

<p>范例: </p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ~]<span class="comment"># cd /usr/local/src</span></span><br><span class="line">[root@centos8 src]<span class="comment"># git clone git://github.com/vozlt/nginx-module-vts.git</span></span><br><span class="line">[root@centos8 src]<span class="comment"># cd nginx-1.18.0/</span></span><br><span class="line">[root@centos8 nginx-1.18.0]<span class="comment"># ./configure --prefix=/apps/nginx --add-module=/usr/local/src/nginx-module-vts</span></span><br><span class="line">[root@centos8 nginx-1.18.0]<span class="comment"># make &amp;&amp; make install</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># vim /apps/nginx/conf/nginx.conf</span></span><br><span class="line">http &#123;</span><br><span class="line">    ......</span><br><span class="line">    vhost_traffic_status_zone;</span><br><span class="line">    ......</span><br><span class="line">    server &#123;</span><br><span class="line">        ......</span><br><span class="line">        location /status &#123;</span><br><span class="line">            vhost_traffic_status_display;</span><br><span class="line">            vhost_traffic_status_display_format html;</span><br><span class="line">        &#125;</span><br><span class="line">        ......</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">[root@centos8 ~]<span class="comment"># systemctl restart nginx</span></span><br><span class="line"><span class="comment">#浏览器访问:http://&lt;nginx_ip&gt;/status 可以看到下面显示</span></span><br></pre></td></tr></table></figure>

<p><img src="../../../../images/SRE/day28/91.jpg" alt="91"><br><img src="../../../../images/SRE/day28/92.jpg" alt="92"></p>
<h3 id="echo-模块实现信息显示"><a href="#echo-模块实现信息显示" class="headerlink" title="echo 模块实现信息显示"></a>echo 模块实现信息显示</h3><p>开源的echo模块可以用来打印信息,变量等</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://github.com/openresty/echo-nginx-module</span><br></pre></td></tr></table></figure>

<p>范例: </p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ~]<span class="comment"># systemctl stop nginx</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># vim /apps/nginx/conf/conf.d/pc.conf </span></span><br><span class="line"> location /main &#123;</span><br><span class="line">     index index.html;</span><br><span class="line">     default_type text/html;</span><br><span class="line">     <span class="built_in">echo</span> <span class="string">&quot;hello world,main--&gt;&quot;</span>;</span><br><span class="line">     <span class="built_in">echo</span> <span class="variable">$remote_addr</span> ;</span><br><span class="line">     echo_reset_timer;   <span class="comment">#将计时器开始时间重置为当前时间</span></span><br><span class="line">     echo_location /sub1;</span><br><span class="line">     echo_location /sub2;</span><br><span class="line">     <span class="built_in">echo</span> <span class="string">&quot;took <span class="variable">$echo_timer_elapsed</span> sec for total.&quot;</span>;</span><br><span class="line"> &#125;</span><br><span class="line"> location /sub1 &#123;</span><br><span class="line">     echo_sleep 1;</span><br><span class="line">     <span class="built_in">echo</span> sub1;</span><br><span class="line"> &#125;</span><br><span class="line"> location /sub2 &#123;</span><br><span class="line">     echo_sleep 1;</span><br><span class="line">     <span class="built_in">echo</span> sub2;</span><br><span class="line"> &#125;</span><br><span class="line"> </span><br><span class="line">[root@centos8 ~]<span class="comment"># /apps/nginx/sbin/nginx -t</span></span><br><span class="line">nginx: [emerg] unknown directive <span class="string">&quot;echo_reset_timer&quot;</span> <span class="keyword">in</span> /apps/nginx/conf/conf.d/pc.conf:86</span><br><span class="line">nginx: configuration file /apps/nginx/conf/nginx.conf <span class="built_in">test</span> failed</span><br><span class="line"></span><br><span class="line"><span class="comment">#解决以上报错问题</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># cd /usr/local/src</span></span><br><span class="line">[root@centos8 src]<span class="comment"># yum install git -y</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#github网站国内访问不稳定,可能无法下载</span></span><br><span class="line">[root@centos8 src]<span class="comment"># git clone https://github.com/openresty/echo-nginx-module.git</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#如果上面链接无法下载,可以用下面链接</span></span><br><span class="line">[root@centos8 src]<span class="comment"># git clone https://github.com.cnpmjs.org/openresty/echo-nginx-module.git</span></span><br><span class="line">[root@centos8 src]<span class="comment"># cd nginx-1.18.0/</span></span><br><span class="line">[root@centos8 src]<span class="comment"># ./configure \</span></span><br><span class="line">--prefix=/apps/nginx \</span><br><span class="line">--user=nginx --group=nginx \</span><br><span class="line">--with-http_ssl_module \</span><br><span class="line">--with-http_v2_module \</span><br><span class="line">--with-http_realip_module \</span><br><span class="line">--with-http_stub_status_module \</span><br><span class="line">--with-http_gzip_static_module \</span><br><span class="line">--with-pcre \</span><br><span class="line">--with-stream \</span><br><span class="line">--with-stream_ssl_module \</span><br><span class="line">--with-stream_realip_module \</span><br><span class="line">--with-http_perl_module \</span><br><span class="line">--add-module=/usr/local/src/echo-nginx-module  <span class="comment">#指定模块源代码路径</span></span><br><span class="line"></span><br><span class="line">[root@centos8 src]<span class="comment"># make &amp;&amp; make install</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#确认语法检测通过</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># /apps/nginx/sbin/nginx -t</span></span><br><span class="line">nginx: the configuration file /apps/nginx/conf/nginx.conf syntax is ok</span><br><span class="line">nginx: configuration file /apps/nginx/conf/nginx.conf <span class="built_in">test</span> is successful</span><br><span class="line"></span><br><span class="line"><span class="comment">#编译新模块需要重启nginx才能访问测试，不支持reload</span></span><br><span class="line">[root@centos8 ~]<span class="comment">#systemctl restart nginx</span></span><br><span class="line">[root@centos8 ~]<span class="comment">#nginx -V</span></span><br><span class="line">nginx version: wanginx/1.68.9</span><br><span class="line">built by gcc 8.3.1 20191121 (Red Hat 8.3.1-5) (GCC) </span><br><span class="line">built with OpenSSL 1.1.1c FIPS  28 May 2019</span><br><span class="line">TLS SNI support enabled</span><br><span class="line"></span><br><span class="line">configure arguments: --prefix=/apps/nginx --user=nginx --group=nginx --with-http_ssl_module --with-http_v2_module --with-http_realip_module --with-http_stub_status_module --with-http_gzip_static_module --with-pcre --with-stream --with-stream_ssl_module --with-stream_realip_module --add-module=/usr/local/src/echo-nginx-module</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#测试查看结果</span></span><br><span class="line">[root@centos7 ~]<span class="comment">#curl http://www.wang.org/main</span></span><br><span class="line">hello world,main--&gt;</span><br><span class="line">10.0.0.7</span><br><span class="line">sub1</span><br><span class="line">sub2</span><br><span class="line">took 2.003 sec <span class="keyword">for</span> total.</span><br></pre></td></tr></table></figure>

<p><img src="../../../../images/SRE/day28/93.jpg" alt="93"></p>
<h2 id="Nginx-变量使用"><a href="#Nginx-变量使用" class="headerlink" title="Nginx 变量使用"></a>Nginx 变量使用</h2><p>nginx的变量可以在配置文件中引用，作为功能判断或者日志等场景使用</p>
<p>变量可以分为内置变量和自定义变量</p>
<p>内置变量是由nginx模块自带，通过变量可以获取到众多的与客户端访问相关的值。</p>
<h3 id="内置变量"><a href="#内置变量" class="headerlink" title="内置变量"></a>内置变量</h3><p>官方文档</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://nginx.org/en/docs/varindex.html</span><br></pre></td></tr></table></figure>

<p><strong>常用内置变量</strong></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$remote_addr</span>; </span><br><span class="line"><span class="comment">#存放了客户端的地址，注意是客户端的公网IP</span></span><br><span class="line"></span><br><span class="line"><span class="variable">$proxy_add_x_forwarded_for</span></span><br><span class="line"><span class="comment">#此变量表示将客户端IP追加请求报文中X-Forwarded-For首部字段,多个IP之间用逗号分隔,如果请求中没有X-Forwarded-For,就使用$remote_addr</span></span><br><span class="line">the “X-Forwarded-For” client request header field with the <span class="variable">$remote_addr</span> variable appended to it, separated by a comma. If the “X-Forwarded-For” field is not </span><br><span class="line">present <span class="keyword">in</span> the client request header, the <span class="variable">$proxy_add_x_forwarded_for</span> variable is equal to the <span class="variable">$remote_addr</span> variable.</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="variable">$args</span>; </span><br><span class="line"><span class="comment">#变量中存放了URL中的所有参数，例如:http://www.wang.org/main/index.do?id=20190221&amp;partner=search</span></span><br><span class="line"><span class="comment">#返回结果为: id=20190221&amp;partner=search</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="variable">$is_args</span></span><br><span class="line"><span class="comment">#如果有参数为? 否则为空</span></span><br><span class="line">“?” <span class="keyword">if</span> a request line has arguments, or an empty string otherwise</span><br><span class="line"></span><br><span class="line"><span class="variable">$document_root</span>; </span><br><span class="line"><span class="comment">#保存了针对当前资源的请求的系统根目录,例如:/apps/nginx/html。</span></span><br><span class="line"></span><br><span class="line"><span class="variable">$document_uri</span>;</span><br><span class="line"><span class="comment">#保存了当前请求中不包含参数的URI，注意是不包含请求的指令，比如:http://www.wang.org/main/index.do?id=20190221&amp;partner=search会被定义为/main/index.do </span></span><br><span class="line"><span class="comment">#返回结果为:/main/index.do</span></span><br><span class="line"></span><br><span class="line"><span class="variable">$host</span>; </span><br><span class="line"><span class="comment">#存放了请求的host名称</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">limit_rate 10240;</span><br><span class="line"><span class="built_in">echo</span> <span class="variable">$limit_rate</span>;</span><br><span class="line"><span class="comment">#如果nginx服务器使用limit_rate配置了显示网络速率，则会显示，如果没有设置， 则显示0</span></span><br><span class="line"></span><br><span class="line"><span class="variable">$remote_port</span>;</span><br><span class="line"><span class="comment">#客户端请求Nginx服务器时随机打开的端口，这是每个客户端自己的端口</span></span><br><span class="line"></span><br><span class="line"><span class="variable">$remote_user</span>;</span><br><span class="line"><span class="comment">#已经经过Auth Basic Module验证的用户名</span></span><br><span class="line"></span><br><span class="line"><span class="variable">$request_body_file</span>;</span><br><span class="line"><span class="comment">#做反向代理时发给后端服务器的本地资源的名称</span></span><br><span class="line"></span><br><span class="line"><span class="variable">$request_method</span>;</span><br><span class="line"><span class="comment">#请求资源的方式，GET/PUT/DELETE等</span></span><br><span class="line"></span><br><span class="line"><span class="variable">$request_filename</span>;</span><br><span class="line"><span class="comment">#当前请求的资源文件的磁盘路径，由root或alias指令与URI请求生成的文件绝对路径，如:/apps/nginx/html/main/index.html</span></span><br><span class="line"></span><br><span class="line"><span class="variable">$request_uri</span>;</span><br><span class="line"><span class="comment">#包含请求参数的原始URI，不包含主机名，相当于:$document_uri?$args,例如：/main/index.do?id=20190221&amp;partner=search </span></span><br><span class="line"></span><br><span class="line"><span class="variable">$scheme</span>;</span><br><span class="line"><span class="comment">#请求的协议，例如:http，https,ftp等</span></span><br><span class="line"></span><br><span class="line"><span class="variable">$server_protocol</span>;</span><br><span class="line"><span class="comment">#保存了客户端请求资源使用的协议的版本，例如:HTTP/1.0，HTTP/1.1，HTTP/2.0等</span></span><br><span class="line"></span><br><span class="line"><span class="variable">$server_addr</span>;</span><br><span class="line"><span class="comment">#保存了服务器的IP地址</span></span><br><span class="line"></span><br><span class="line"><span class="variable">$server_name</span>;</span><br><span class="line"><span class="comment">#请求的服务器的主机名</span></span><br><span class="line"></span><br><span class="line"><span class="variable">$server_port</span>;</span><br><span class="line"><span class="comment">#请求的服务器的端口号</span></span><br><span class="line"></span><br><span class="line"><span class="variable">$http_user_agent</span>;</span><br><span class="line"><span class="comment">#客户端浏览器的详细信息</span></span><br><span class="line"></span><br><span class="line"><span class="variable">$http_cookie</span>;</span><br><span class="line"><span class="comment">#客户端的所有cookie信息</span></span><br><span class="line"></span><br><span class="line"><span class="variable">$cookie_</span>&lt;name&gt;</span><br><span class="line"><span class="comment">#name为任意请求报文首部字部cookie的key名</span></span><br><span class="line"></span><br><span class="line"><span class="variable">$http_</span>&lt;name&gt;</span><br><span class="line"><span class="comment">#name为任意请求报文首部字段,表示记录请求报文的首部字段，ame的对应的首部字段名需要为小写，如果有横线需要替换为下划线</span></span><br><span class="line">arbitrary request header field; the last part of a variable name is the field </span><br><span class="line">name converted to lower <span class="keyword">case</span> with dashes replaced by underscores <span class="comment">#用下划线代替横线</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#示例: </span></span><br><span class="line"><span class="built_in">echo</span> <span class="variable">$http_user_agent</span>; </span><br><span class="line"><span class="built_in">echo</span> <span class="variable">$http_host</span>;</span><br><span class="line"></span><br><span class="line"><span class="variable">$sent_http_</span>&lt;name&gt;</span><br><span class="line"><span class="comment">#name为响应报文的首部字段，name的对应的首部字段名需要为小写，如果有横线需要替换为下划线,此变量有问题</span></span><br><span class="line"><span class="built_in">echo</span> <span class="variable">$sent_http_server</span>;</span><br><span class="line"></span><br><span class="line"><span class="variable">$arg_</span>&lt;name&gt;</span><br><span class="line"><span class="comment">#此变量存放了URL中的指定参数，name为请求url中指定的参数</span></span><br><span class="line"><span class="built_in">echo</span> <span class="variable">$arg_id</span>;</span><br></pre></td></tr></table></figure>

<p>范例: </p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ~]<span class="comment">#vi /apps/nginx/conf/conf.d/pc.conf</span></span><br><span class="line"> location /main &#123;</span><br><span class="line">     index index.html;</span><br><span class="line">     default_type text/html;</span><br><span class="line">     <span class="built_in">echo</span> <span class="string">&quot;hello world,main--&gt;&quot;</span>;</span><br><span class="line">     <span class="built_in">echo</span> <span class="variable">$remote_addr</span> ;</span><br><span class="line">     <span class="built_in">echo</span> <span class="variable">$args</span> ;</span><br><span class="line">     <span class="built_in">echo</span> <span class="variable">$document_root</span>;</span><br><span class="line">     <span class="built_in">echo</span> <span class="variable">$document_uri</span>;</span><br><span class="line">     <span class="built_in">echo</span> <span class="variable">$host</span>;</span><br><span class="line">     <span class="built_in">echo</span> <span class="variable">$http_user_agent</span>;</span><br><span class="line">     <span class="built_in">echo</span> <span class="variable">$http_cookie</span>;</span><br><span class="line">     <span class="built_in">echo</span> <span class="variable">$request_filename</span>;</span><br><span class="line">     <span class="built_in">echo</span> <span class="variable">$scheme</span>;</span><br><span class="line">     <span class="built_in">echo</span> <span class="variable">$scheme</span>://$host<span class="variable">$document_uri</span>?<span class="variable">$args</span>; </span><br><span class="line"> &#125;</span><br><span class="line">     </span><br><span class="line">[root@centos6 ~]<span class="comment"># curl -b title=ceo &#x27;http://www.wang.org/main/index.do?id=20190221&amp;partner=search&#x27;</span></span><br><span class="line">hello world,main--&gt;</span><br><span class="line">10.0.0.6</span><br><span class="line"><span class="built_in">id</span>=20190221&amp;partner=search</span><br><span class="line">/apps/nginx/html</span><br><span class="line">/main/index.do</span><br><span class="line">www.wang.org</span><br><span class="line">curl/7.19.7 (x86_64-redhat-linux-gnu) libcurl/7.19.7 NSS/3.27.1 zlib/1.2.3 libidn/1.18 libssh2/1.4.2</span><br><span class="line">title=ceo</span><br><span class="line">/apps/nginx/html/main/index.do</span><br><span class="line">http</span><br><span class="line">http://www.wang.org/main/index.do?<span class="built_in">id</span>=20190221&amp;partner=search</span><br></pre></td></tr></table></figure>

<p>范例:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 conf.d]<span class="comment"># vim www.conf</span></span><br><span class="line">.....</span><br><span class="line"> location /echo &#123;</span><br><span class="line">        <span class="built_in">echo</span> <span class="variable">$request</span>;</span><br><span class="line">        <span class="built_in">echo</span> <span class="variable">$proxy_add_x_forwarded_for</span>;</span><br><span class="line">        <span class="built_in">echo</span> <span class="variable">$args</span>;</span><br><span class="line">        <span class="built_in">echo</span> <span class="variable">$document_uri</span>;</span><br><span class="line">        <span class="built_in">echo</span> <span class="variable">$request_uri</span>;</span><br><span class="line">        <span class="built_in">echo</span> <span class="variable">$document_root</span>;</span><br><span class="line">        <span class="built_in">echo</span> <span class="variable">$host</span>;</span><br><span class="line">        <span class="built_in">echo</span> <span class="variable">$request_method</span>;</span><br><span class="line">        <span class="built_in">echo</span> <span class="variable">$request_filename</span>;</span><br><span class="line">        <span class="built_in">echo</span> <span class="variable">$scheme</span>;</span><br><span class="line">        <span class="built_in">set</span>  <span class="variable">$test</span> <span class="variable">$http_host</span>;</span><br><span class="line">        <span class="built_in">echo</span> <span class="variable">$test</span>;</span><br><span class="line">        <span class="built_in">echo</span> <span class="variable">$http_User_Agent</span>;</span><br><span class="line">        <span class="built_in">echo</span> <span class="variable">$http_cookie</span>;</span><br><span class="line">        <span class="built_in">echo</span> <span class="variable">$cookie_key1</span>;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">[root@centos7 ~]<span class="comment"># curl -b &#x27;key1=v1;key2=v2&#x27; &quot;http://www.wang.org/echo/index.html?id=123456&amp;partner=search&quot;</span></span><br><span class="line">GET /echo/index.html?<span class="built_in">id</span>=123456&amp;partner=search HTTP/1.1</span><br><span class="line">10.0.0.7</span><br><span class="line"><span class="built_in">id</span>=123456&amp;partner=search</span><br><span class="line">/echo/index.html</span><br><span class="line">/echo/index.html?<span class="built_in">id</span>=123456&amp;partner=search</span><br><span class="line">/data/nginx/html/pc</span><br><span class="line">www.wang.org</span><br><span class="line">GET</span><br><span class="line">/data/nginx/html/pc/echo/index.html</span><br><span class="line">http</span><br><span class="line">www.wang.org</span><br><span class="line">curl/7.29.0</span><br><span class="line">key1=v1;key2=v2</span><br><span class="line">v1</span><br></pre></td></tr></table></figure>

<h3 id="自定义变量"><a href="#自定义变量" class="headerlink" title="自定义变量"></a>自定义变量</h3><p>假如需要自定义变量名称和值，使用指令 set $variable value;</p>
<p>语法格式：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Syntax: <span class="built_in">set</span> <span class="variable">$variable</span> value;</span><br><span class="line">Default: —</span><br><span class="line">Context: server, location, <span class="keyword">if</span></span><br></pre></td></tr></table></figure>

<p>范例:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">set</span> <span class="variable">$name</span> magedu;</span><br><span class="line"><span class="built_in">echo</span> <span class="variable">$name</span>;</span><br><span class="line"><span class="built_in">set</span> <span class="variable">$my_port</span> <span class="variable">$server_port</span>;</span><br><span class="line"><span class="built_in">echo</span> <span class="variable">$my_port</span>;</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$server_name</span>:<span class="variable">$server_port</span>&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">#输出信息如下</span></span><br><span class="line">[root@centos6 ~]<span class="comment">#curl www.wang.org/main</span></span><br><span class="line">magedu</span><br><span class="line">80</span><br><span class="line">www.wang.org:80</span><br></pre></td></tr></table></figure>

<h2 id="Nginx-自定义访问日志"><a href="#Nginx-自定义访问日志" class="headerlink" title="Nginx 自定义访问日志"></a>Nginx 自定义访问日志</h2><p>访问日志是记录客户端即用户的具体请求内容信息，而在全局配置模块中的error_log是记录nginx服务器运行时的日志保存路径和记录日志的level，因此两者是不同的，而且Nginx的错误日志一般只有一个，但是访问日志可以在不同server中定义多个，定义一个日志需要使用access_log指定日志的保存路径，使用log_format指定日志的格式，格式中定义要保存的具体日志内容。</p>
<p>访问日志由 ngx_http_log_module 模块实现</p>
<p>官方帮助文档:</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://nginx.org/en/docs/http/ngx_http_log_module.html</span><br></pre></td></tr></table></figure>

<p>语法格式</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Syntax: access_log path [format [buffer=size] [gzip[=level]] [flush=time] [<span class="keyword">if</span>=condition]];</span><br><span class="line">access_log off; <span class="comment">#关闭访问日志,比如在反向代理上可以关闭日志功能</span></span><br><span class="line">Default: </span><br><span class="line">access_log logs/access.log combined;</span><br><span class="line">Context: http, server, location, <span class="keyword">if</span> <span class="keyword">in</span> location, limit_except</span><br></pre></td></tr></table></figure>

<p>日志格式的常见变量</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$remote_addr</span>    <span class="comment"># 记录客户端IP地址</span></span><br><span class="line"><span class="variable">$remote_user</span>    <span class="comment"># 记录客户端用户名</span></span><br><span class="line"><span class="variable">$time_local</span>     <span class="comment"># 记录通用的本地时间</span></span><br><span class="line"><span class="variable">$time_iso8601</span>   <span class="comment"># 记录ISO8601标准格式下的本地时间</span></span><br><span class="line"><span class="variable">$request</span>        <span class="comment"># 记录请求的方法以及请求的http协议</span></span><br><span class="line"><span class="variable">$status</span>           <span class="comment"># 记录请求状态码(用于定位错误信息)</span></span><br><span class="line"><span class="variable">$body_bytes_sent</span>  <span class="comment"># 发送给客户端的资源字节数，不包括响应头的大小</span></span><br><span class="line"><span class="variable">$bytes_sent</span>       <span class="comment"># 发送给客户端的总字节数$msec # 日志写入时间。单位为秒，精度是毫秒。</span></span><br><span class="line"><span class="variable">$http_referer</span>     <span class="comment"># 记录从哪个页面链接访问过来的</span></span><br><span class="line"><span class="variable">$http_user_agent</span>  <span class="comment"># 记录客户端浏览器相关信息</span></span><br><span class="line"><span class="variable">$http_x_forwarded_for</span>   <span class="comment">#记录客户端IP地址</span></span><br><span class="line"><span class="variable">$request_length</span>   <span class="comment"># 请求的长度（包括请求行，请求头和请求正文）。</span></span><br><span class="line"><span class="variable">$request_time</span>     <span class="comment"># 请求花费的时间，单位为秒，精度毫秒</span></span><br><span class="line"><span class="comment"># 注:如果Nginx位于负载均衡器，nginx反向代理之后，web服务器无法直接获取到客 户端真实的IP地址。</span></span><br><span class="line"><span class="comment"># $remote_addr获取的是反向代理的IP地址。 反向代理服务器在转发请求的http头信息中，</span></span><br><span class="line"><span class="comment"># 增加X-Forwarded-For信息，用来记录客户端IP地址和客户端请求的服务器地址</span></span><br></pre></td></tr></table></figure>

<p>默认日志格式</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">http &#123;</span><br><span class="line">   log_format main  <span class="string">&#x27;$remote_addr - $remote_user [$time_local] &quot;$request&quot; &#x27;</span></span><br><span class="line">                      <span class="string">&#x27;$status $body_bytes_sent &quot;$http_referer&quot; &#x27;</span></span><br><span class="line">                      <span class="string">&#x27;&quot;$http_user_agent&quot; &quot;$http_x_forwarded_for&quot;&#x27;</span>;</span><br><span class="line">                      </span><br><span class="line">   access_log /var/log/nginx/access.log main;</span><br></pre></td></tr></table></figure>

<h3 id="自定义默认格式日志"><a href="#自定义默认格式日志" class="headerlink" title="自定义默认格式日志"></a>自定义默认格式日志</h3><p>如果是要保留日志的源格式，只是添加相应的日志内容，则配置如下：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#注意:此指令只支持http块,不支持server块</span></span><br><span class="line">log_format access_log_format  <span class="string">&#x27;$remote_addr - $remote_user [$time_local] &quot;$request&quot; &#x27;</span></span><br><span class="line">                      <span class="string">&#x27;$status $body_bytes_sent &quot;$http_referer&quot; &#x27;</span></span><br><span class="line">                      <span class="string">&#x27;&quot;$http_user_agent&quot; &quot;$http_x_forwarded_for&quot;&#x27;</span></span><br><span class="line">                      <span class="string">&#x27;$server_name:$server_port&#x27;</span>;</span><br><span class="line">                      </span><br><span class="line"><span class="comment">#注意:此指令一定要在放在log_format命令后</span></span><br><span class="line">access_log logs/access.log   access_log_format;</span><br><span class="line"></span><br><span class="line"><span class="comment">#重启nginx并访问测试日志格式</span></span><br><span class="line">==&gt; /apps/nginx/logs/access.log &lt;==</span><br><span class="line">10.0.0.1 - - [22/Feb/2019:08:44:14 +0800] <span class="string">&quot;GET /favicon.ico HTTP/1.1&quot;</span> 404 162 <span class="string">&quot;-&quot;</span> <span class="string">&quot;Mozilla/5.0 (Windows NT 6.1; Win64; x64; rv:65.0) Gecko/2 0100101 Firefox/65.0&quot;</span> <span class="string">&quot;-&quot;</span>www.wang.org:80</span><br></pre></td></tr></table></figure>

<h3 id="自定义-json-格式日志"><a href="#自定义-json-格式日志" class="headerlink" title="自定义 json 格式日志"></a>自定义 json 格式日志</h3><p>Nginx 的默认访问日志记录内容相对比较单一，默认的格式也不方便后期做日志统计分析，生产环境中通常将nginx日志转换为json日志，然后配合使用ELK做日志收集,统计和分析。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">   log_format access_json <span class="string">&#x27;&#123;&quot;@timestamp&quot;:&quot;$time_iso8601&quot;,&#x27;</span></span><br><span class="line">        <span class="string">&#x27;&quot;host&quot;:&quot;$server_addr&quot;,&#x27;</span></span><br><span class="line">        <span class="string">&#x27;&quot;clientip&quot;:&quot;$remote_addr&quot;,&#x27;</span></span><br><span class="line">        <span class="string">&#x27;&quot;size&quot;:$body_bytes_sent,&#x27;</span></span><br><span class="line">        <span class="string">&#x27;&quot;responsetime&quot;:$request_time,&#x27;</span> <span class="comment">#总的处理时间</span></span><br><span class="line">        <span class="string">&#x27;&quot;upstreamtime&quot;:&quot;$upstream_response_time&quot;,&#x27;</span> <span class="comment">#后端应用服务器处理时间</span></span><br><span class="line">        <span class="string">&#x27;&quot;upstreamhost&quot;:&quot;$upstream_addr&quot;,&#x27;</span>   </span><br><span class="line">        <span class="string">&#x27;&quot;http_host&quot;:&quot;$host&quot;,&#x27;</span></span><br><span class="line">        <span class="string">&#x27;&quot;uri&quot;:&quot;$uri&quot;,&#x27;</span></span><br><span class="line">        <span class="string">&#x27;&quot;xff&quot;:&quot;$http_x_forwarded_for&quot;,&#x27;</span></span><br><span class="line">        <span class="string">&#x27;&quot;referer&quot;:&quot;$http_referer&quot;,&#x27;</span></span><br><span class="line">        <span class="string">&#x27;&quot;tcp_xff&quot;:&quot;$proxy_protocol_addr&quot;,&#x27;</span></span><br><span class="line">        <span class="string">&#x27;&quot;http_user_agent&quot;:&quot;$http_user_agent&quot;,&#x27;</span></span><br><span class="line">        <span class="string">&#x27;&quot;status&quot;:&quot;$status&quot;&#125;&#x27;</span>;</span><br><span class="line">     access_log /apps/nginx/logs/access_json.log access_json;</span><br><span class="line">     </span><br><span class="line"><span class="comment">#重启Nginx并访问测试日志格式,参考链接:http://json.cn/</span></span><br><span class="line">&#123;<span class="string">&quot;@timestamp&quot;</span>:<span class="string">&quot;2019-02-22T08:55:32+08:00&quot;</span>,<span class="string">&quot;host&quot;</span>:<span class="string">&quot;10.0.0.8&quot;</span>,<span class="string">&quot;clientip&quot;</span>:<span class="string">&quot;10.0.0.1&quot;</span>,<span class="string">&quot;size&quot;</span>:162,<span class="string">&quot;responsetime&quot;</span>:0.000,<span class="string">&quot;upstreamtime&quot;</span>:<span class="string">&quot;-&quot;</span>,<span class="string">&quot;upstreamhost&quot;</span>:<span class="string">&quot;-&quot;</span>,<span class="string">&quot;http_host&quot;</span>:<span class="string">&quot;www.wang.org&quot;</span>,<span class="string">&quot;uri&quot;</span>:<span class="string">&quot;/favicon.ico&quot;</span>,<span class="string">&quot;xff&quot;</span>:<span class="string">&quot;-&quot;</span>,<span class="string">&quot;referer&quot;</span>:<span class="string">&quot;-&quot;</span>,<span class="string">&quot;tcp_xff&quot;</span>:<span class="string">&quot;&quot;</span>,<span class="string">&quot;http_user_agent&quot;</span>:<span class="string">&quot;Mozilla/5.0 (Windows NT 6.1; Win64; x64; rv:65.0) Gecko/20100101 Firefox/65.0&quot;</span>,<span class="string">&quot;status&quot;</span>:<span class="string">&quot;404&quot;</span>&#125;</span><br></pre></td></tr></table></figure>

<h3 id="json-格式的日志访问统计"><a href="#json-格式的日志访问统计" class="headerlink" title="json 格式的日志访问统计"></a>json 格式的日志访问统计</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#python3</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># dnf -y install python3</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># cat log.py</span></span><br><span class="line"><span class="comment">#!/usr/bin/env python3</span></span><br><span class="line"><span class="comment">#coding:utf-8</span></span><br><span class="line">status_200= []</span><br><span class="line">status_404= []</span><br><span class="line">with open(<span class="string">&quot;access_json.log&quot;</span>) as f:</span><br><span class="line">    <span class="keyword">for</span> line <span class="keyword">in</span> f.readlines():</span><br><span class="line">        line = <span class="built_in">eval</span>(line)</span><br><span class="line">        <span class="keyword">if</span> line.get(<span class="string">&quot;status&quot;</span>) == <span class="string">&quot;200&quot;</span>:</span><br><span class="line">            status_200.append(line.get)</span><br><span class="line">        <span class="keyword">elif</span> line.get(<span class="string">&quot;status&quot;</span>) == <span class="string">&quot;404&quot;</span>:</span><br><span class="line">            status_404.append(line.get)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;状态码 ERROR&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>((line.get(&quot;clientip&quot;)))</span><br><span class="line">f.close()</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;状态码200的有--:&quot;</span>,len(status_200))</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;状态码404的有--:&quot;</span>,len(status_404))</span><br><span class="line"></span><br><span class="line"><span class="comment">#python2</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># dnf -y install python2</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># cat log.py</span></span><br><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment">#coding:utf-8</span></span><br><span class="line">status_200= []</span><br><span class="line">status_404= []</span><br><span class="line">with open(<span class="string">&quot;access_json.log&quot;</span>) as f:</span><br><span class="line">    <span class="keyword">for</span> line <span class="keyword">in</span> f.readlines():</span><br><span class="line">        line = <span class="built_in">eval</span>(line)</span><br><span class="line">        <span class="keyword">if</span> line.get(<span class="string">&quot;status&quot;</span>) == <span class="string">&quot;200&quot;</span>:</span><br><span class="line">            status_200.append(line.get)</span><br><span class="line">        <span class="keyword">elif</span> line.get(<span class="string">&quot;status&quot;</span>) == <span class="string">&quot;404&quot;</span>:</span><br><span class="line">            status_404.append(line.get)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;状态码 ERROR&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(line.get(<span class="string">&quot;clientip&quot;</span>))</span><br><span class="line">f.close()</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span> <span class="string">&quot;状态码200的有--:&quot;</span>,len(status_200)</span><br><span class="line"><span class="built_in">print</span> <span class="string">&quot;状态码404的有--:&quot;</span>,len(status_404)</span><br><span class="line"></span><br><span class="line"><span class="comment">#保存日志文件到指定路径并进测试：</span></span><br><span class="line">[root@centos7 ~]<span class="comment"># python nginx_json.py </span></span><br><span class="line">状态码200的有--: 1910</span><br><span class="line">状态码404的有--: 13</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line"><span class="comment">#转换python2语法到python3</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># pip3 install 2to3</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># 2to3 -w log.py</span></span><br></pre></td></tr></table></figure>

<h3 id="不记录访问日志"><a href="#不记录访问日志" class="headerlink" title="不记录访问日志"></a>不记录访问日志</h3><p>一个网站会包含很多元素，尤其是有大量的images、js、css等静态资源。这样的请求可以不用记录日志</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#请求 favicon.ico 时，不记录日志</span></span><br><span class="line">location /favicon.ico &#123;</span><br><span class="line">    access_log off;</span><br><span class="line">    <span class="built_in">return</span> 200;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">#当有人访问gif、png等资源时，将日志丢入空</span></span><br><span class="line">location ~* .*\.(gif|jpg|png|css|js)$ &#123;</span><br><span class="line">    access_log /dev/null;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="关于-favicon-ico"><a href="#关于-favicon-ico" class="headerlink" title="关于 favicon.ico"></a>关于 favicon.ico</h2><p>favicon.ico 文件是浏览器收藏网址时显示的图标，当客户端使用浏览器问页面时，浏览器会自己主动发起请求获取页面的favicon.ico文件，但是当浏览器请求的favicon.ico文件不存在时，服务器会记录404日志，而且浏览器也会显示404报错</p>
<p>解决办法：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#方法一：服务器不记录访问日志：</span></span><br><span class="line">location = /favicon.ico &#123;</span><br><span class="line">   log_not_found off;</span><br><span class="line">   access_log off;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">#方法二：将图标保存到指定目录访问：</span></span><br><span class="line"><span class="comment">#location ~ ^/favicon\.ico$ &#123;</span></span><br><span class="line">location = /favicon.ico &#123;</span><br><span class="line">     root   /data/nginx/html/pc/images;</span><br><span class="line">     expires 365d;  <span class="comment">#设置文件过期时间</span></span><br><span class="line">     access_log off;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="../../../../images/SRE/day28/94.jpg" alt="94"></p>
<h2 id="Nginx-压缩功能"><a href="#Nginx-压缩功能" class="headerlink" title="Nginx 压缩功能"></a>Nginx 压缩功能</h2><p>Nginx支持对指定类型的文件进行压缩然后再传输给客户端，而且压缩还可以设置压缩比例，压缩后的文件大小将比源文件显著变小，这样有助于降低出口带宽的利用率，降低企业的IT支出，不过会占用相应的CPU资源。</p>
<p>Nginx对文件的压缩功能是依赖于模块 ngx_http_gzip_module,默认是内置模块</p>
<p>官方文档： <a target="_blank" rel="noopener" href="https://nginx.org/en/docs/http/ngx_http_gzip_module.html">https://nginx.org/en/docs/http/ngx_http_gzip_module.html</a></p>
<p>配置指令如下：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#启用或禁用gzip压缩，默认关闭</span></span><br><span class="line">gzip on | off; </span><br><span class="line"></span><br><span class="line"><span class="comment">#压缩比由低到高从1到9，默认为1</span></span><br><span class="line">gzip_comp_level level;</span><br><span class="line"></span><br><span class="line"><span class="comment">#禁用IE6 gzip功能</span></span><br><span class="line">gzip_disable <span class="string">&quot;MSIE [1-6]\.&quot;</span>; </span><br><span class="line"></span><br><span class="line"><span class="comment">#gzip压缩的最小文件，小于设置值的文件将不会压缩</span></span><br><span class="line">gzip_min_length 1k; </span><br><span class="line"></span><br><span class="line"><span class="comment">#启用压缩功能时，协议的最小版本，默认HTTP/1.1</span></span><br><span class="line">gzip_http_version 1.0 | 1.1; </span><br><span class="line"></span><br><span class="line"><span class="comment">#指定Nginx服务需要向服务器申请的缓存空间的个数和大小,平台不同,默认:32 4k或者16 8k;</span></span><br><span class="line">gzip_buffers number size;  </span><br><span class="line"></span><br><span class="line"><span class="comment">#指明仅对哪些类型的资源执行压缩操作;默认为gzip_types text/html，不用显示指定，否则出错</span></span><br><span class="line">gzip_types mime-type ...; </span><br><span class="line"></span><br><span class="line"><span class="comment">#如果启用压缩，是否在响应报文首部插入“Vary: Accept-Encoding”,一般建议打开</span></span><br><span class="line">gzip_vary on | off; </span><br><span class="line"></span><br><span class="line"><span class="comment">#预压缩，即直接从磁盘找到对应文件的gz后缀的式的压缩文件返回给用户，无需消耗服务器CPU</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#注意: 来自于ngx_http_gzip_static_module模块</span></span><br><span class="line">gzip_static on | off;</span><br><span class="line"></span><br><span class="line"><span class="comment">#重启nginx并进行访问测试压缩功能</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># cp /apps/nginx/logs/access.log /data/nginx/html/pc/m.txt</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># echo &quot;test&quot; &gt; /data/nginx/html/pc/test.html #小于1k的文件测试是否会压缩</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># vim /apps/nginx/conf/nginx.conf</span></span><br><span class="line">gzip on;</span><br><span class="line">gzip_comp_level 5;</span><br><span class="line">gzip_min_length 1k;</span><br><span class="line">gzip_types text/plain application/javascript application/x-javascript text/css </span><br><span class="line">application/xml text/javascript application/x-httpd-php image/gif image/png;   </span><br><span class="line">gzip_vary on;</span><br><span class="line"></span><br><span class="line"><span class="comment">#重启Nginx并访问测试：</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># curl --head --compressed http://www.wang.org/test.html</span></span><br><span class="line">HTTP/1.1 200 OK</span><br><span class="line">Server: nginx</span><br><span class="line">Date: Fri, 22 Feb 2019 01:52:23 GMT</span><br><span class="line">Content-Type: text/html</span><br><span class="line">Last-Modified: Thu, 21 Feb 2019 10:31:18 GMT</span><br><span class="line">Connection: keep-alive</span><br><span class="line">Keep-Alive: <span class="built_in">timeout</span>=65</span><br><span class="line">Vary: Accept-Encoding</span><br><span class="line">ETag: W/<span class="string">&quot;5c6e7df6-171109&quot;</span></span><br><span class="line">Content-Encoding: gzip <span class="comment">#压缩传输</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#验证不压缩访问的文件大小：</span></span><br></pre></td></tr></table></figure>

<p><img src="../../../../images/SRE/day28/95.jpg" alt="95"></p>
<p><img src="../../../../images/SRE/day28/96.jpg" alt="96"></p>
<p>验证不压缩后访问的文件大小：</p>
<p><img src="../../../../images/SRE/day28/97.jpg" alt="97"></p>
<p>验证压缩后访问的文件大小：</p>
<p><img src="../../../../images/SRE/day28/98.jpg" alt="98"></p>
<p><img src="../../../../images/SRE/day28/99.jpg" alt="99"></p>
<h2 id="https-加密"><a href="#https-加密" class="headerlink" title="https 加密"></a>https 加密</h2><p>Web网站的登录页面通常都会使用https加密传输的，加密数据以保障数据的安全，HTTPS能够加密信息，以免敏感信息被第三方获取，所以很多银行网站或电子邮箱等等安全级别较高的服务都会采用HTTPS协议，HTTPS其实是有两部分组成：HTTP + SSL / TLS，也就是在HTTP上又加了一层处理加密信息的模块。服务端和客户端的信息传输都会通过TLS进行加密，所以传输的数据都是加密后的数据。</p>
<p><img src="../../../../images/SRE/day28/100.jpg" alt="100"></p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">https 实现过程如下：</span><br><span class="line">1.客户端发起HTTPS请求：</span><br><span class="line">客户端访问某个web端的https地址，一般都是443端口</span><br><span class="line">2.服务端的配置：</span><br><span class="line">采用https协议的服务器必须要有一套证书，可以通过一些组织申请，也可以自己制作，目前国内很多网站都</span><br><span class="line">自己做的，当你访问一个网站的时候提示证书不可信任就表示证书是自己做的，证书就是一个公钥和私钥匙，</span><br><span class="line">就像一把锁和钥匙，正常情况下只有你的钥匙可以打开你的锁，你可以把这个送给别人让他锁住一个箱子，里</span><br><span class="line">面放满了钱或秘密，别人不知道里面放了什么而且别人也打不开，只有你的钥匙是可以打开的。</span><br><span class="line">3.传送证书：</span><br><span class="line">服务端给客户端传递证书，其实就是公钥，里面包含了很多信息，例如证书得到颁发机构、过期时间等等。</span><br><span class="line">4.客户端解析证书：</span><br><span class="line">这部分工作是有客户端完成的，首先回验证公钥的有效性，比如颁发机构、过期时间等等，如果发现异常则会</span><br><span class="line">弹出一个警告框提示证书可能存在问题，如果证书没有问题就生成一个随机值，然后用证书对该随机值进行加</span><br><span class="line">密，就像2步骤所说把随机值锁起来，不让别人看到。</span><br><span class="line">5.传送4步骤的加密数据：</span><br><span class="line">就是将用证书加密后的随机值传递给服务器，目的就是为了让服务器得到这个随机值，以后客户端和服务端的</span><br><span class="line">通信就可以通过这个随机值进行加密解密了。</span><br><span class="line">6.服务端解密信息：</span><br><span class="line">服务端用私钥解密5步骤加密后的随机值之后，得到了客户端传过来的随机值(私钥)，然后把内容通过该值进</span><br><span class="line">行对称加密，对称加密就是将信息和私钥通过算法混合在一起，这样除非你知道私钥，不然是无法获取其内部</span><br><span class="line">的内容，而正好客户端和服务端都知道这个私钥，所以只要机密算法够复杂就可以保证数据的安全性。</span><br><span class="line">7.传输加密后的信息:</span><br><span class="line">服务端将用私钥加密后的数据传递给客户端，在客户端可以被还原出原数据内容。</span><br><span class="line">8.客户端解密信息：</span><br><span class="line">客户端用之前生成的私钥获解密服务端传递过来的数据，由于数据一直是加密的，因此即使第三方获取到数据</span><br><span class="line">也无法知道其详细内容。</span><br></pre></td></tr></table></figure>

<h3 id="https-配置参数"><a href="#https-配置参数" class="headerlink" title="https 配置参数"></a>https 配置参数</h3><p>nginx 的https 功能基于模块ngx_http_ssl_module实现，因此如果是编译安装的nginx要使用参数</p>
<p>ngx_http_ssl_module开启ssl功能，但是作为nginx的核心功能，yum安装的nginx默认就是开启的，编译安装的nginx需要指定编译参数–with-http_ssl_module开启</p>
<p>官方文档：</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://nginx.org/en/docs/http/ngx_http_ssl_module.html</span><br></pre></td></tr></table></figure>

<p>配置参数如下：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">ssl on | off;   </span><br><span class="line"><span class="comment">#为指定的虚拟主机配置是否启用ssl功能，此功能在1.15.0废弃，使用listen [ssl]替代</span></span><br><span class="line">listen 443 ssl http2;</span><br><span class="line"></span><br><span class="line">ssl_certificate /path/to/file;</span><br><span class="line"><span class="comment">#指向包含当前虚拟主机和CA的两个证书信息的文件，一般是crt文件</span></span><br><span class="line"></span><br><span class="line">ssl_certificate_key /path/to/file;</span><br><span class="line"><span class="comment">#当前虚拟主机使用的私钥文件，一般是key文件</span></span><br><span class="line"></span><br><span class="line">ssl_protocols [SSLv2] [SSLv3] [TLSv1] [TLSv1.1] [TLSv1.2]; </span><br><span class="line"><span class="comment">#支持ssl协议版本，早期为ssl现在是TLS，默认为后三个,最新的浏览器已经不再支持TLS1.0和TLS1.1</span></span><br><span class="line"></span><br><span class="line">ssl_session_cache off | none | [<span class="built_in">builtin</span>[:size]] [shared:name:size];</span><br><span class="line"><span class="comment">#配置ssl缓存</span></span><br><span class="line">   off： <span class="comment">#关闭缓存</span></span><br><span class="line">   none:  <span class="comment">#通知客户端支持ssl session cache，但实际不支持</span></span><br><span class="line">   <span class="built_in">builtin</span>[:size]：<span class="comment">#使用OpenSSL内建缓存，为每worker进程私有,使用此内置缓存可能会导致内存碎片</span></span><br><span class="line">   [shared:name:size]：<span class="comment">#在各worker之间使用一个共享的缓存，需要定义一个缓存名称和缓存空间大小，1M可以存储4000个会话信息，多个虚拟主机可以使用相同的缓存名称</span></span><br><span class="line"></span><br><span class="line">ssl_session_timeout time; <span class="comment">#客户端连接可以复用ssl session cache中缓存的有效时长，默认5分钟</span></span><br></pre></td></tr></table></figure>

<p>示例: 官方性能优化</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">https://nginx.org/en/docs/http/ngx_http_ssl_module.html</span><br><span class="line">To reduce the processor load it is recommended to</span><br><span class="line"><span class="built_in">set</span> the number of worker processes equal to the number of processors,</span><br><span class="line"><span class="built_in">enable</span> keep-alive connections,</span><br><span class="line"><span class="built_in">enable</span> the shared session cache,</span><br><span class="line"><span class="built_in">disable</span> the built-in session cache,</span><br><span class="line">and possibly increase the session lifetime (by default, 5 minutes):</span><br><span class="line"></span><br><span class="line">worker_processes auto;</span><br><span class="line"></span><br><span class="line">http &#123;</span><br><span class="line">   ...</span><br><span class="line">   server &#123;</span><br><span class="line">       listen              443 ssl http2;</span><br><span class="line">       keepalive_timeout   70;</span><br><span class="line">      </span><br><span class="line">       ssl_protocols       TLSv1 TLSv1.1 TLSv1.2;</span><br><span class="line">       ssl_ciphers         AES128-SHA:AES256-SHA:RC4-SHA:DES-CBC3-SHA:RC4-MD5;</span><br><span class="line">       ssl_certificate     /usr/local/nginx/conf/cert.pem;</span><br><span class="line">       ssl_certificate_key /usr/local/nginx/conf/cert.key;</span><br><span class="line">       ssl_session_cache   shared:SSL:10m;</span><br><span class="line">       ssl_session_timeout 10m;</span><br><span class="line">       ...</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<h3 id="自签名证书"><a href="#自签名证书" class="headerlink" title="自签名证书"></a>自签名证书</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#自签名CA证书</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># cd /apps/nginx/</span></span><br><span class="line">[root@centos8 nginx]<span class="comment"># mkdir certs</span></span><br><span class="line">[root@centos8 nginx]<span class="comment"># cd certs/</span></span><br><span class="line">[root@centos8 nginx]<span class="comment"># openssl req -newkey rsa:4096 -nodes -sha256 -keyout ca.key -x509 -days 3650 -out ca.crt #自签名CA证书</span></span><br><span class="line">Generating a 4096 bit RSA private key</span><br><span class="line">.................++</span><br><span class="line">.....</span><br><span class="line">Country Name (2 letter code) [XX]:CN <span class="comment">#国家代码</span></span><br><span class="line">State or Province Name (full name) []:BeiJing   <span class="comment">#省份</span></span><br><span class="line">Locality Name (eg, city) [Default City]:Beijing <span class="comment">#城市名称</span></span><br><span class="line">Organization Name (eg, company) [Default Company Ltd]:magedu.Ltd <span class="comment">#公司名称   </span></span><br><span class="line">Organizational Unit Name (eg, section) []:magedu <span class="comment">#部门</span></span><br><span class="line">Common Name (eg, your name or your server<span class="string">&#x27;s hostname) []:ca.wang.org #通用名称</span></span><br><span class="line"><span class="string">Email Address []: #邮箱</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">[root@centos8 certs]# ll ca.crt </span></span><br><span class="line"><span class="string">-rw-r--r-- 1 root root 2118 Feb 22 12:10 ca.crt</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">#自制key和csr文件</span></span><br><span class="line"><span class="string">[root@centos8 certs]# openssl req -newkey rsa:4096 -nodes -sha256 -keyout www.wang.org.key     -out www.wang.org.csr </span></span><br><span class="line"><span class="string">Generating a 4096 bit RSA private key</span></span><br><span class="line"><span class="string">........................................................................++......</span></span><br><span class="line"><span class="string">Country Name (2 letter code) [XX]:CN</span></span><br><span class="line"><span class="string">State or Province Name (full name) []:BeiJing</span></span><br><span class="line"><span class="string">Locality Name (eg, city) [Default City]:BeiJing</span></span><br><span class="line"><span class="string">Organization Name (eg, company) [Default Company Ltd]:wang.org</span></span><br><span class="line"><span class="string">Organizational Unit Name (eg, section) []:wang.org</span></span><br><span class="line"><span class="string">Common Name (eg, your name or your server&#x27;</span>s hostname) []:www.wang.org</span><br><span class="line">Email Address []:2973707860@qq.com</span><br><span class="line"></span><br><span class="line">Please enter the following <span class="string">&#x27;extra&#x27;</span> attributes</span><br><span class="line">to be sent with your certificate request</span><br><span class="line">A challenge password []:      </span><br><span class="line">An optional company name []:</span><br><span class="line"></span><br><span class="line">[root@centos8 certs]<span class="comment"># ll</span></span><br><span class="line">total 16</span><br><span class="line">-rw-r--r-- 1 root root 2118 Feb 22 12:10 ca.crt</span><br><span class="line">-rw-r--r-- 1 root root 3272 Feb 22 12:10 ca.key</span><br><span class="line">-rw-r--r-- 1 root root 1760 Feb 22 12:18 www.wang.org.csr</span><br><span class="line">-rw-r--r-- 1 root root 3272 Feb 22 12:18 www.wang.org.key</span><br><span class="line"></span><br><span class="line"><span class="comment">#签发证书</span></span><br><span class="line">[root@centos8 certs]<span class="comment"># openssl x509 -req -days 3650 -in www.wang.org.csr -CA ca.crt -CAkey ca.key -CAcreateserial -out www.wang.org.crt</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#验证证书内容</span></span><br><span class="line">[root@centos8 certs]<span class="comment"># openssl x509 -in www.wang.org.crt -noout -text </span></span><br><span class="line">Certificate:</span><br><span class="line">   Data:</span><br><span class="line">       Version: 1 (0x0)</span><br><span class="line">       Serial Number:</span><br><span class="line">           bb:76:ea:fe:f4:04:ac:06</span><br><span class="line">   Signature Algorithm: sha256WithRSAEncryption</span><br><span class="line">       Issuer: C=CN, ST=BeiJing, L=Beijing, O=magedu.Ltd, OU=magedu, </span><br><span class="line">CN=magedu.ca/emailAddress=2973707860@qq.com</span><br><span class="line">       Validity</span><br><span class="line">           Not Before: Feb 22 06:14:03 2019 GMT</span><br><span class="line">           Not After : Feb 22 06:14:03 2020 GMT</span><br><span class="line">       Subject: C=CN, ST=BeiJing, L=BeiJing, O=wang.org, OU=wang.org, </span><br><span class="line">CN=www.wang.org/emailAddress=2973707860@qq.com</span><br><span class="line">       Subject Public Key Info:</span><br><span class="line">           Public Key Algorithm: rsaEncryption</span><br><span class="line">               Public-Key: (4096 bit)</span><br><span class="line"></span><br><span class="line"><span class="comment">#合并CA和服务器证书成一个文件,注意服务器证书必须在前,ca证书在后,否则会出错</span></span><br><span class="line">[root@centos8 certs]<span class="comment">#cat www.wang.org.crt ca.crt &gt; www.wang.org.pem</span></span><br></pre></td></tr></table></figure>

<h3 id="https-配置"><a href="#https-配置" class="headerlink" title="https 配置"></a>https 配置</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">  listen 80;</span><br><span class="line">  listen 443 ssl http2;</span><br><span class="line">  ssl_certificate /apps/nginx/certs/www.wang.org.pem;</span><br><span class="line">  ssl_certificate_key /apps/nginx/certs/www.wang.org.key;</span><br><span class="line">  ssl_session_cache shared:sslcache:20m;</span><br><span class="line">  ssl_session_timeout 10m;</span><br><span class="line">  root /data/nginx/html; </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">#重启Nginx并访问验证</span></span><br></pre></td></tr></table></figure>

<p><img src="../../../../images/SRE/day28/101.jpg" alt="101"></p>
<p><img src="../../../../images/SRE/day28/102.jpg" alt="102"><br><img src="../../../../images/SRE/day28/103.jpg" alt="103"></p>
<h3 id="实现多域名-https"><a href="#实现多域名-https" class="headerlink" title="实现多域名 https"></a>实现多域名 https</h3><p>Nginx 支持基于单个IP实现多域名的功能，并且还支持单IP多域名的基础之上实现HTTPS，其实是基于Nginx的 SNI（Server Name Indication）功能实现，SNI是为了解决一个Nginx服务器内使用一个IP绑定多个域名和证书的功能，其具体功能是客户端在连接到服务器建立SSL链接之前先发送要访问站点的域名（Hostname），这样服务器再根据这个域名返回给客户端一个合适的证书。</p>
<p>范例: SNI功能</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ~]<span class="comment"># nginx -V</span></span><br><span class="line">nginx version: nginx/1.18.0</span><br><span class="line">built by gcc 8.3.1 20191121 (Red Hat 8.3.1-5) (GCC) </span><br><span class="line">built with OpenSSL 1.1.1c FIPS  28 May 2019</span><br><span class="line">TLS SNI support enabled</span><br><span class="line">configure arguments: --prefix=/apps/nginx --user=nginx --group=nginx --with-http_ssl_module --with-http_v2_module --with-http_realip_module --with-http_stub_status_module --with-http_gzip_static_module --with-pcre --with-stream --with-stream_ssl_module --with-stream_realip_module --add-module=../echo-nginx-module</span><br></pre></td></tr></table></figure>

<p>范例:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#制作key和csr文件</span></span><br><span class="line">[root@centos8 certs]<span class="comment"># openssl req -newkey rsa:4096 -nodes -sha256 -keyout m.wang.org.key -out m.wang.org.csr</span></span><br><span class="line"></span><br><span class="line">Generating a 4096 bit RSA private key</span><br><span class="line">..........</span><br><span class="line">Country Name (2 letter code) [XX]:CN</span><br><span class="line">State or Province Name (full name) []:BeiJing</span><br><span class="line">Locality Name (eg, city) [Default City]:BeiJing</span><br><span class="line">Organization Name (eg, company) [Default Company Ltd]:magedu</span><br><span class="line">Organizational Unit Name (eg, section) []:magedu</span><br><span class="line">Common Name (eg, your name or your server<span class="string">&#x27;s hostname) []:m.wang.org</span></span><br><span class="line"><span class="string">Email Address []:2973707860@qq.com</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Please enter the following &#x27;</span>extra<span class="string">&#x27; attributes</span></span><br><span class="line"><span class="string">to be sent with your certificate request</span></span><br><span class="line"><span class="string">A challenge password []:</span></span><br><span class="line"><span class="string">An optional company name []:</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">#签名证书</span></span><br><span class="line"><span class="string">[root@centos8 certs]# openssl x509 -req -days 3650 -in m.wang.org.csr -CA ca.crt -CAkey ca.key -CAcreateserial -out m.wang.org.crt</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">#验证证书内容</span></span><br><span class="line"><span class="string">[root@centos8 certs]# openssl x509 -in m.wang.org.crt -noout -text </span></span><br><span class="line"><span class="string">Certificate:</span></span><br><span class="line"><span class="string">   Data:</span></span><br><span class="line"><span class="string">       Version: 1 (0x0)</span></span><br><span class="line"><span class="string">       Serial Number:</span></span><br><span class="line"><span class="string">           bb:76:ea:fe:f4:04:ac:07</span></span><br><span class="line"><span class="string">   Signature Algorithm: sha256WithRSAEncryption</span></span><br><span class="line"><span class="string">       Issuer: C=CN, ST=BeiJing, L=Beijing, O=magedu.Ltd, OU=magedu, CN=magedu.ca</span></span><br><span class="line"><span class="string">       Validity</span></span><br><span class="line"><span class="string">           Not Before: Feb 22 13:50:43 2019 GMT</span></span><br><span class="line"><span class="string">           Not After : Feb 19 13:50:43 2029 GMT</span></span><br><span class="line"><span class="string">       Subject: C=CN, ST=BeiJing, L=BeiJing, O=magedu, OU=magedu, CN=m.wang.org/emailAddress=2973707860@qq.com</span></span><br><span class="line"><span class="string">       Subject Public Key Info:</span></span><br><span class="line"><span class="string">           Public Key Algorithm: rsaEncryption</span></span><br><span class="line"><span class="string">               Public-Key: (4096 bit)</span></span><br><span class="line"><span class="string">..............</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">#合并证书文件</span></span><br><span class="line"><span class="string">[root@centos8 certs]# cat m.wang.org.crt ca.crt &gt; m.wang.org.pem</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">#Nginx 配置</span></span><br><span class="line"><span class="string">[root@centos8 certs]# cat /apps/nginx/conf/conf.d/mobile.conf </span></span><br><span class="line"><span class="string">server &#123;</span></span><br><span class="line"><span class="string">  listen 80 default_server;</span></span><br><span class="line"><span class="string">  server_name m.wang.org;</span></span><br><span class="line"><span class="string">  rewrite ^(.*)$ https://$server_name$1 permanent;</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">server &#123;</span></span><br><span class="line"><span class="string">  listen 443 ssl http2;</span></span><br><span class="line"><span class="string">  server_name m.wang.org;</span></span><br><span class="line"><span class="string">  ssl_certificate /apps/nginx/certs/m.wang.org.pem;</span></span><br><span class="line"><span class="string">  ssl_certificate_key /apps/nginx/certs/m.wang.org.key;</span></span><br><span class="line"><span class="string">  ssl_session_cache shared:sslcache:20m;</span></span><br><span class="line"><span class="string">  ssl_session_timeout 10m;</span></span><br><span class="line"><span class="string">  location / &#123;</span></span><br><span class="line"><span class="string">    root &quot;/data/nginx/html/mobile&quot;;</span></span><br><span class="line"><span class="string">  &#125;</span></span><br><span class="line"><span class="string"> location /mobile_status &#123;</span></span><br><span class="line"><span class="string">    stub_status;</span></span><br><span class="line"><span class="string">  &#125;</span></span><br><span class="line"><span class="string">&#125;</span></span><br></pre></td></tr></table></figure>

<p><img src="../../../../images/SRE/day28/104.jpg" alt="104"></p>
<h3 id="实现-HSTS"><a href="#实现-HSTS" class="headerlink" title="实现 HSTS"></a>实现 HSTS</h3><p>官方文档:</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://www.nginx.com/blog/http-strict-transport-security-hsts-and-nginx/</span><br></pre></td></tr></table></figure>

<p><strong>注意: 配置rewrite才能实现http跳转到https</strong></p>
<p>范例: </p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">   listen 443 ssl http2;</span><br><span class="line">   server_name www.wang.org;</span><br><span class="line">   add_header Strict-Transport-Security <span class="string">&quot;max-age=31536000; includeSubDomains&quot;</span> always;</span><br><span class="line">   location / &#123;</span><br><span class="line">       <span class="keyword">if</span> ( <span class="variable">$scheme</span> = http ) &#123;</span><br><span class="line">         rewrite ^/(.*)$ https://www.wang.org/<span class="variable">$1</span> redirect;                     </span><br><span class="line">                          </span><br><span class="line">       &#125;</span><br><span class="line">   .....</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>范例:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ~]<span class="comment">#vim /apps/nginx/conf/conf.d/pc.conf</span></span><br><span class="line">server &#123;</span><br><span class="line">  listen 80;</span><br><span class="line">  listen 443 ssl http2;</span><br><span class="line">  ssl_certificate /apps/nginx/conf/conf.d/www.wang.org.crt;</span><br><span class="line">  ssl_certificate_key /apps/nginx/conf/conf.d/www.wang.org.key;</span><br><span class="line">  ssl_session_cache shared:sslcache:20m;</span><br><span class="line">  ssl_session_timeout 10m;</span><br><span class="line">  server_name www.wang.org;</span><br><span class="line">  error_log /apps/nginx/logs/wang.org_error.log notice;  </span><br><span class="line">  access_log /apps/nginx/logs/wang.org_access.log main;</span><br><span class="line">  add_header Strict-Transport-Security <span class="string">&quot;max-age=31536000; includeSubDomains&quot;</span> always;</span><br><span class="line">  location / &#123;</span><br><span class="line">    root /data/nginx/html/pc;</span><br><span class="line">    <span class="keyword">if</span> ( <span class="variable">$scheme</span> = http ) &#123;</span><br><span class="line">         rewrite ^/(.*)$ https://www.wang.org/<span class="variable">$1</span> redirect;</span><br><span class="line">   &#125;</span><br><span class="line"> &#125;</span><br><span class="line"> </span><br><span class="line">[root@centos8 ~]<span class="comment"># systemctl restart nginx</span></span><br><span class="line">[root@centos7 ~]<span class="comment"># curl -ikL https://www.wang.org</span></span><br><span class="line">HTTP/1.1 200 OK</span><br><span class="line">Server: nginx/1.18.0</span><br><span class="line">Date: Thu, 08 Oct 2020 15:29:56 GMT</span><br><span class="line">Content-Type: text/html</span><br><span class="line">Content-Length: 7</span><br><span class="line">Last-Modified: Sat, 26 Sep 2020 01:18:32 GMT</span><br><span class="line">Connection: keep-alive</span><br><span class="line">ETag: <span class="string">&quot;5f6e96e8-7&quot;</span></span><br><span class="line">Strict-Transport-Security: max-age=31536000; includeSubDomains</span><br><span class="line">Accept-Ranges: bytes</span><br><span class="line"></span><br><span class="line">pc web</span><br></pre></td></tr></table></figure>

<h2 id="升级-OpenSSL-版本"><a href="#升级-OpenSSL-版本" class="headerlink" title="升级 OpenSSL 版本"></a>升级 OpenSSL 版本</h2><p>OpenSSL程序库当前广泛用于实现互联网的传输层安全（TLS）协议。心脏出血（Heartbleed），也简称为心血漏洞，是一个出现在加密程序库OpenSSL的安全漏洞，此漏洞于2012年被引入了软件中，2014年4月首次向公众披露。只要使用的是存在缺陷的OpenSSL实例，无论是服务器还是客户端，都可能因此而受到攻击。此问题的原因是在实现TLS的心跳扩展时没有对输入进行适当验证（缺少边界检查），因此漏洞的名称来源于“心跳”（heartbeat）。该程序错误属于缓冲区过读，即可以读取的数据比应该允许读取的还多。</p>
<p>范例: 升级OpenSSL解决安全漏洞</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#准备OpenSSL源码包：</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># cd /usr/local/src</span></span><br><span class="line">[root@centos8 src]<span class="comment"># wget https://www.openssl.org/source/openssl-1.1.1h.tar.gz</span></span><br><span class="line">[root@centos8 src]<span class="comment"># tar xvf openssl-1.1.1h.tar.gz</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#编译安装Nginx并制定新版本OpenSSL路径：</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># cd /usr/local/src/nginx-1.18.0/</span></span><br><span class="line">[root@centos8 nginx-1.18.0]<span class="comment"># ./configure --prefix=/apps/nginx --user=nginx --group=nginx --with-http_ssl_module --with-http_v2_module --with-http_realip_module --with-http_stub_status_module --with-http_gzip_static_module --with-pcre --with-stream --with-stream_ssl_module --with-stream_realip_module --add-module=/usr/local/src/echo-nginx-module --with-openssl=/usr/local/src/openssl-1.1.1h</span></span><br><span class="line"></span><br><span class="line">[root@centos8 nginx-1.18.0]<span class="comment">#make &amp;&amp; make install</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#验证并启动Nginx：</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># nginx -t </span></span><br><span class="line">nginx: the configuration file /apps/nginx/conf/nginx.conf syntax is ok</span><br><span class="line">nginx: configuration file /apps/nginx/conf/nginx.conf <span class="built_in">test</span> is successful</span><br><span class="line"></span><br><span class="line">[root@centos8 ~]<span class="comment"># systemctl restart nginx</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># nginx -V</span></span><br><span class="line">nginx version: wanginx/1.68.9</span><br><span class="line">built by gcc 8.3.1 20191121 (Red Hat 8.3.1-5) (GCC) </span><br><span class="line">built with OpenSSL 1.1.1h  22 Sep 2020</span><br><span class="line">TLS SNI support enabled</span><br><span class="line">configure arguments: --prefix=/apps/nginx --user=nginx --group=nginx --with-http_ssl_module --with-http_v2_module --with-http_realip_module --with-http_stub_status_module --with-http_gzip_static_module --with-pcre --with-stream</span><br><span class="line">--with-stream_ssl_module --with-stream_realip_module --add-module=/usr/local/src/echo-nginx-module --with-openssl=/usr/local/src/openssl-1.1.1h</span><br></pre></td></tr></table></figure>

<h2 id="Rewrite-模块"><a href="#Rewrite-模块" class="headerlink" title="Rewrite 模块"></a>Rewrite 模块</h2><p>Nginx服务器利用 ngx_http_rewrite_module 模块解析和处理rewrite请求，此功能依靠 PCRE(perl compatible regular expression)，因此编译之前要安装PCRE库</p>
<p>rewrite是nginx服务器的重要功能之一，用于实现常用的URL的重写，比如可以在改变网站结构之后，不需要客户端修改原来的书签，也无需修改其它网站的链接地址，仍可继续访问原有内容，另外还可以在一定程度上提高网站的安全性。</p>
<p>比如: 利用rewrite 模块可以实现下面网站URL的跳转</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">http://www.58.com/bj --&gt; http://beijing.58.com</span><br><span class="line">http://baoji.58.com</span><br><span class="line">http://www.360buy.com --&gt; http://www.jd.com/</span><br></pre></td></tr></table></figure>

<h3 id="ngx-http-rewrite-module-模块指令"><a href="#ngx-http-rewrite-module-模块指令" class="headerlink" title="ngx_http_rewrite_module 模块指令"></a>ngx_http_rewrite_module 模块指令</h3><p>官方文档: <a target="_blank" rel="noopener" href="https://nginx.org/en/docs/http/ngx_http_rewrite_module.html">https://nginx.org/en/docs/http/ngx_http_rewrite_module.html</a></p>
<h4 id="if-指令"><a href="#if-指令" class="headerlink" title="if 指令"></a>if 指令</h4><p>官方文档: </p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://nginx.org/en/docs/http/ngx_http_rewrite_module.html#if</span><br></pre></td></tr></table></figure>

<p>用于条件匹配判断，并根据条件判断结果选择不同的Nginx配置，可以配置在server或location块中进行配置，Nginx的if语法仅能使用if做单次判断，不支持使用if else或者if elif这样的多重判断</p>
<p>语法如下：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Syntax: <span class="keyword">if</span> (condition) &#123; ... &#125;</span><br><span class="line">Default: —</span><br><span class="line">Context: server, location</span><br></pre></td></tr></table></figure>

<p>使用正则表达式对变量进行匹配，匹配成功时if指令认为条件为true，否则认为false，变量与表达式之间使用以下符号链接：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">=   <span class="comment">#比较变量和字符串是否相等，相等时if指令认为该条件为true，反之为false</span></span><br><span class="line">!=  <span class="comment">#比较变量和字符串是否不相等，不相等时if指令认为条件为true，反之为false</span></span><br><span class="line">~   <span class="comment">#区分大小写字符，可以通过正则表达式匹配，满足匹配条件为真，不满足匹配条件为假</span></span><br><span class="line">!~  <span class="comment">#区分大小写字符,判断是否匹配，不满足匹配条件为真，满足匹配条件为假</span></span><br><span class="line"></span><br><span class="line">~*  <span class="comment">#不区分大小写字符，可以通过正则表达式匹配，满足匹配条件为真，不满足匹配条件为假</span></span><br><span class="line">!~* <span class="comment">#不区分大小字符,判断是否匹配，满足匹配条件为假，不满足匹配条件为真</span></span><br><span class="line"></span><br><span class="line">-f 和 !-f <span class="comment">#判断请求的文件是否存在和是否不存在</span></span><br><span class="line">-d 和 !-d <span class="comment">#判断请求的目录是否存在和是否不存在</span></span><br><span class="line">-x 和 !-x <span class="comment">#判断文件是否可执行和是否不可执行</span></span><br><span class="line">-e 和 !-e <span class="comment">#判断请求的文件或目录是否存在和是否不存在(包括文件，目录，软链接)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#注意：</span></span><br><span class="line"><span class="comment">#如果$变量的值为空字符串或0，则if指令认为该条件为false，其他条件为true。</span></span><br><span class="line"><span class="comment">#nginx 1.0.1之前$变量的值如果以0开头的任意字符串会返回false</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#官方示例</span></span><br><span class="line"><span class="keyword">if</span> (<span class="variable">$http_user_agent</span> ~ MSIE) &#123;</span><br><span class="line">   rewrite ^(.*)$ /msie/<span class="variable">$1</span> <span class="built_in">break</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="variable">$http_cookie</span> ~* <span class="string">&quot;id=([^;]+)(?:;|$)&quot;</span>) &#123;</span><br><span class="line">    <span class="built_in">set</span> <span class="variable">$id</span> <span class="variable">$1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="variable">$request_method</span> = POST) &#123;</span><br><span class="line">   <span class="built_in">return</span> 405;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="variable">$slow</span>) &#123;</span><br><span class="line">   limit_rate 10k;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="variable">$invalid_referer</span>) &#123;</span><br><span class="line">   <span class="built_in">return</span> 403;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>范例:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">   listen 80;</span><br><span class="line">   listen 443 ssl;</span><br><span class="line">   server_name www.wang.org;</span><br><span class="line">   root /data/nginx/html/pc;</span><br><span class="line">   ssl_certificate /apps/nginx/ssl/www.wang.org.pem;</span><br><span class="line">   ssl_certificate_key /apps/nginx/ssl/www.wang.org.key;</span><br><span class="line">   location /if &#123;</span><br><span class="line">       index index.html;</span><br><span class="line">       default_type text/html;</span><br><span class="line">       <span class="built_in">echo</span> <span class="string">&quot;if-----&gt; <span class="variable">$scheme</span>&quot;</span>;</span><br><span class="line">       <span class="keyword">if</span> (!-e <span class="variable">$request_filename</span>) &#123;</span><br><span class="line">            <span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$request_filename</span> is not exist&quot;</span>;</span><br><span class="line">            <span class="comment">#return 409;</span></span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="set-指令"><a href="#set-指令" class="headerlink" title="set 指令"></a>set 指令</h4><p>指定key并给其定义一个变量，变量可以调用Nginx内置变量赋值给key，另外set定义格式为set $key value，value可以是text, variables和两者的组合。</p>
<p>语法如下：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Syntax: <span class="built_in">set</span> <span class="variable">$variable</span> value;</span><br><span class="line">Default: —</span><br><span class="line">Context: server, location, <span class="keyword">if</span></span><br></pre></td></tr></table></figure>

<p>范例</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">location /set &#123;</span><br><span class="line">    root /data/nginx/html/pc;</span><br><span class="line">    index index.html;</span><br><span class="line">    default_type text/html;</span><br><span class="line">    <span class="built_in">set</span> <span class="variable">$name</span> wang;</span><br><span class="line">    <span class="built_in">echo</span> <span class="variable">$name</span>;</span><br><span class="line">    <span class="built_in">set</span> <span class="variable">$my_port</span> <span class="variable">$server_port</span>;</span><br><span class="line">    <span class="built_in">echo</span> <span class="variable">$my_port</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>范例：根据网络判断是否限速</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line"> .....</span><br><span class="line"> location /set &#123;</span><br><span class="line">        <span class="built_in">set</span> <span class="variable">$slow</span> 1; <span class="comment">#如果为0,则不限速，非0限速</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="variable">$slow</span>) &#123;</span><br><span class="line">           limit_rate 10k;</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="break-指令"><a href="#break-指令" class="headerlink" title="break 指令"></a>break 指令</h4><p>用于中断当前相同作用域(location)中的其他Nginx配置，与该指令处于同一作用域的Nginx配置中，位于它前面的配置生效，位于后面的 ngx_http_rewrite_module 模块中指令就不再执行，Nginx服务器在根据配置处理请求的过程中遇到该指令的时候，回到上一层作用域继续向下读取配置，该指令可以在server块和locationif块中使用</p>
<p>注意: 如果break指令在location块中后续指令还会继续执行,只是不执行 ngx_http_rewrite_module 模块的指令,其它指令还会执行</p>
<p>使用语法如下：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Syntax: <span class="built_in">break</span>;</span><br><span class="line">Default: —</span><br><span class="line">Context: server, location, <span class="keyword">if</span></span><br></pre></td></tr></table></figure>

<p>范例</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (<span class="variable">$slow</span>) &#123;</span><br><span class="line">   limit_rate 10k;</span><br><span class="line">   <span class="built_in">break</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">   location /break &#123;</span><br><span class="line">       default_type text/html;</span><br><span class="line">        <span class="built_in">set</span> <span class="variable">$name</span> wang;</span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;break_before:name=<span class="variable">$name</span>&quot;</span> ;</span><br><span class="line">       <span class="built_in">break</span>;   <span class="comment">#location块中break后面指令还会执行</span></span><br><span class="line">        <span class="built_in">set</span> <span class="variable">$my_port</span> <span class="variable">$server_port</span>;</span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;break_after:my_port=<span class="variable">$my_port</span>&quot;</span> ;</span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;break_after:name=<span class="variable">$name</span>&quot;</span> ;</span><br><span class="line">   &#125;</span><br><span class="line">   </span><br><span class="line"><span class="comment">#测试结果</span></span><br><span class="line">[root@centos7 ~]<span class="comment"># curl http://www.wang.org/break/</span></span><br><span class="line">break_before:name=wang</span><br><span class="line">break_after:my_port=</span><br><span class="line">break_after:name=wang</span><br></pre></td></tr></table></figure>

<h4 id="return-指令"><a href="#return-指令" class="headerlink" title="return 指令"></a>return 指令</h4><p>return用于完成对请求的处理，并直接向客户端返回响应状态码，比如:可以指定重定向URL(对于特殊重定向状态码，301/302等) 或者是指定提示文本内容(对于特殊状态码403/500等)，处于此指令后的所有配置都将不被执行，return可以在server、if 和 location块进行配置</p>
<p>语法格式：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">Syntax: <span class="built_in">return</span> code [text];</span><br><span class="line"><span class="built_in">return</span> code URL;</span><br><span class="line"><span class="built_in">return</span> URL;</span><br><span class="line">Default: —</span><br><span class="line">Context: server, location, <span class="keyword">if</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">return</span> code; <span class="comment">#返回给客户端指定的HTTP状态码</span></span><br><span class="line"><span class="built_in">return</span> code [text]; <span class="comment">#返回给客户端的状态码及响应报文的实体内容，可以调用变量,其中text如果有空格,需要用单或双引号</span></span><br><span class="line"><span class="built_in">return</span> code URL; <span class="comment">#返回给客户端的URL地址</span></span><br><span class="line"><span class="built_in">return</span> URL; <span class="comment">#302跳转返回给客户端的URL地址，注意：URL必须是完整的URL包括scheme，如:http://www.wang.org/</span></span><br></pre></td></tr></table></figure>

<p>范例:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">location / &#123;</span><br><span class="line">   root /data/nginx/html/pc;</span><br><span class="line">   default_type text/html;</span><br><span class="line">   index index.html;</span><br><span class="line">      <span class="keyword">if</span> ( <span class="variable">$scheme</span> = http )&#123;</span><br><span class="line">        <span class="comment">#return 666;</span></span><br><span class="line">        <span class="comment">#return 666 &quot;not allow http&quot;;</span></span><br><span class="line">        <span class="comment">#return 301 http://www.baidu.com;</span></span><br><span class="line">        <span class="built_in">return</span> 500 <span class="string">&quot;service error&quot;</span>;</span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;if-----&gt; <span class="variable">$scheme</span>&quot;</span>; <span class="comment">#return后面的将不再执行</span></span><br><span class="line">     &#125;</span><br><span class="line">     <span class="keyword">if</span> ( <span class="variable">$scheme</span> = https )&#123;</span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;if ----&gt; <span class="variable">$scheme</span>&quot;</span>;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>范例: return </p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">location /test &#123;</span><br><span class="line">  default_type application/json;</span><br><span class="line">  return 200 &#x27;&#123;&quot;status:&quot;success&quot;&#125;&#x27;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>范例: 防止压力测试等工具访问</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ( <span class="variable">$http_user_agent</span> ~* <span class="string">&quot;Wget|apachebench&quot;</span> ) &#123;</span><br><span class="line">    <span class="built_in">set</span> <span class="variable">$user_agent_deny</span> 1;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> ( <span class="variable">$user_agent_deny</span> =1 ) &#123;</span><br><span class="line">    <span class="built_in">return</span> 403;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>范例: http跳转到https</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#方法0：死循环，不要使用</span></span><br><span class="line">server &#123;</span><br><span class="line">   listen 80 ;</span><br><span class="line">   listen 443 ssl;</span><br><span class="line">   ssl_certificate /apps/nginx/ssl/www.wang.org.crt;</span><br><span class="line">   ssl_certificate_key /apps/nginx/ssl/www.wang.org.key;</span><br><span class="line">   ssl_session_cache shared:sslcache:20m;</span><br><span class="line">   ssl_session_timeout 10m;</span><br><span class="line">   server_name www.wang.org ;</span><br><span class="line">   root /data/nginx/html/pc;</span><br><span class="line">   <span class="built_in">return</span> https://www.wang.org/;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">#方法1</span></span><br><span class="line">server &#123;</span><br><span class="line">  listen 80;</span><br><span class="line">  server_name www.wang.org;</span><br><span class="line">  <span class="built_in">return</span> 302 https://$server_name<span class="variable">$request_uri</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">server &#123;</span><br><span class="line">  listen 443 ssl http2;</span><br><span class="line">  server_name www.wang.org;</span><br><span class="line">  ssl_certificate   /etc/nginx/ssl/www.wang.org.crt;</span><br><span class="line">  ssl_certificate_key /etc/nginx/ssl/www.wang.org.key;</span><br><span class="line">  location / &#123;</span><br><span class="line">    root /data/www/html; </span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">#方法2</span></span><br><span class="line">server &#123;</span><br><span class="line">   listen 80 ;</span><br><span class="line">   listen 443 ssl;</span><br><span class="line">   ssl_certificate /apps/nginx/ssl/www.wang.org.crt;</span><br><span class="line">   ssl_certificate_key /apps/nginx/ssl/www.wang.org.key;</span><br><span class="line">   ssl_session_cache shared:sslcache:20m;</span><br><span class="line">   ssl_session_timeout 10m;</span><br><span class="line">   server_name www.wang.org ;</span><br><span class="line">   root /data/nginx/html/pc;</span><br><span class="line">   <span class="keyword">if</span> (<span class="variable">$scheme</span> = http) &#123;</span><br><span class="line">       <span class="built_in">return</span> https://www.wang.org/;</span><br><span class="line">   &#125;</span><br><span class="line">   location = /nginx_status &#123;</span><br><span class="line">       stub_status;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="rewrite-指令"><a href="#rewrite-指令" class="headerlink" title="rewrite 指令"></a>rewrite 指令</h3><p>通过正则表达式的匹配来改变URI，可以同时存在一个或多个指令，按照顺序依次对URI进行匹配，rewrite主要是针对用户请求的URL或者是URI做具体处理</p>
<p>官方文档：</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://nginx.org/en/docs/http/ngx_http_rewrite_module.html#rewrite</span><br></pre></td></tr></table></figure>

<p>rewrite可以配置在 server、location、if</p>
<p>语法格式 ：</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">Syntax</span><span class="punctuation">: </span>rewrite regex replacement [flag];</span><br><span class="line"><span class="attribute">Default</span><span class="punctuation">: </span>—</span><br><span class="line"><span class="attribute">Context</span><span class="punctuation">: </span>server, location, if</span><br></pre></td></tr></table></figure>

<p>rewrite将用户请求的URI基于regex所描述的模式进行检查，匹配到时将其替换为表达式指定的新的 URI</p>
<p>注意：如果在同一级配置块中存在多个rewrite规则，那么会自下而下逐个检查;被某条件规则替换完成后，会重新一轮的替换检查，隐含有循环机制,但不超过10次;如果超过，提示500响应码，[flag]所表示的标志位用于控制此循环机制</p>
<p>如果替换后的URL是以http://或https://开头，则替换结果会直接以重定向返回给客户端, 即永久重定向301</p>
<p><strong>正则表达式格式</strong></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">.     <span class="comment">#匹配除换行符以外的任意字符</span></span><br><span class="line">\w    <span class="comment">#匹配字母或数字或下划线或汉字</span></span><br><span class="line">\s    <span class="comment">#匹配任意的空白符</span></span><br><span class="line">\d    <span class="comment">#匹配数字,相当于[0-9]</span></span><br><span class="line">\b    <span class="comment">#匹配单词的开始或结束</span></span><br><span class="line">^     <span class="comment">#匹配字付串的开始</span></span><br><span class="line">$     <span class="comment">#匹配字符串的结束</span></span><br><span class="line">*     <span class="comment">#匹配重复零次或更多次</span></span><br><span class="line">+     <span class="comment">#匹配重复一次或更多次</span></span><br><span class="line">?     <span class="comment">#匹配重复零次或一次</span></span><br><span class="line">(n)   <span class="comment">#匹配重复n次</span></span><br><span class="line">&#123;n,&#125;  <span class="comment">#匹配重复n次或更多次</span></span><br><span class="line">&#123;n,m&#125; <span class="comment">#匹配重复n到m次</span></span><br><span class="line">*?    <span class="comment">#匹配重复任意次，但尽可能少重复</span></span><br><span class="line">+?    <span class="comment">#匹配重复1次或更多次，但尽可能少重复</span></span><br><span class="line">??    <span class="comment">#匹配重复0次或1次，但尽可能少重复</span></span><br><span class="line">&#123;n,m&#125;? <span class="comment">#匹配重复n到m次，但尽可能少重复</span></span><br><span class="line">&#123;n,&#125;? <span class="comment">#匹配重复n次以上，但尽可能少重复</span></span><br><span class="line">\W    <span class="comment">#匹配任意不是字母，数字，下划线，汉字的字符</span></span><br><span class="line">\S    <span class="comment">#匹配任意不是空白符的字符</span></span><br><span class="line">\D    <span class="comment">#匹配任意非数字的字符</span></span><br><span class="line">\B    <span class="comment">#匹配不是单词开头或结束的位置</span></span><br><span class="line">[^x]  <span class="comment">#匹配除了x以外的任意字符</span></span><br><span class="line">[^magedu] <span class="comment">#匹配除了magedu 这几个字母以外的任意字符</span></span><br></pre></td></tr></table></figure>

<p>官方示例</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">http://nginx.org/en/docs/http/ngx_http_rewrite_module.html<span class="comment">#rewrite</span></span><br><span class="line">Example:</span><br><span class="line">server &#123;</span><br><span class="line">   ...</span><br><span class="line">   rewrite ^(/download/.*)/media/(.*)\..*$ <span class="variable">$1</span>/mp3/<span class="variable">$2</span>.mp3 last;</span><br><span class="line">   rewrite ^(/download/.*)/audio/(.*)\..*$ <span class="variable">$1</span>/mp3/<span class="variable">$2</span>.ra last;</span><br><span class="line">   <span class="built_in">return</span>  403;</span><br><span class="line">   ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">But <span class="keyword">if</span> these directives are put inside the “/download/” location, the last flag should be replaced by <span class="built_in">break</span>, or otherwise nginx will make 10 cycles and <span class="built_in">return</span> the 500 error:</span><br><span class="line"></span><br><span class="line">location /download/ &#123;</span><br><span class="line">   rewrite ^(/download/.*)/media/(.*)\..*$ <span class="variable">$1</span>/mp3/<span class="variable">$2</span>.mp3 <span class="built_in">break</span>;</span><br><span class="line">   rewrite ^(/download/.*)/audio/(.*)\..*$ <span class="variable">$1</span>/mp3/<span class="variable">$2</span>.ra <span class="built_in">break</span>;</span><br><span class="line">   <span class="built_in">return</span>  403;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">If a replacement string includes the new request arguments, the previous request arguments are appended after them. If this is undesired, putting a question mark at the end of a replacement string avoids having them appended, <span class="keyword">for</span> example:</span><br><span class="line"></span><br><span class="line">rewrite ^/users/(.*)$ /show?user=<span class="variable">$1</span>? last;</span><br></pre></td></tr></table></figure>

<h4 id="rewrite-flag-使用介绍"><a href="#rewrite-flag-使用介绍" class="headerlink" title="rewrite flag 使用介绍"></a>rewrite flag 使用介绍</h4><p>利用nginx的rewrite的指令，可以实现url的重新跳转，rewrite有四种不同的flag，分别是redirect(临时重定向302)、permanent(永久重定向301)、break和last。</p>
<p>其中前两种是跳转型的flag，后两种是代理型</p>
<ul>
<li>跳转型指由客户端浏览器重新对新地址进行请求,客户端的浏览器地址信息会发生变化,如:301,302</li>
<li>代理型是在WEB服务器内部实现跳转,客户端的浏览器地址信息不会发生变化,如: last,break</li>
</ul>
<p>rewrite 格式</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Syntax: rewrite regex replacement [flag]; <span class="comment">#通过正则表达式处理用户请求并返回替换后的数据包。</span></span><br><span class="line">Default: —</span><br><span class="line">Context: server, location, <span class="keyword">if</span></span><br></pre></td></tr></table></figure>

<p>flag 说明</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">redirect;</span><br><span class="line"><span class="comment">#临时重定向，重写完成后以临时重定向方式直接返回重写后生成的新URL给客户端，由客户端重新发起请求;使用相对路径,或者http://或https://开头，状态码：302</span></span><br><span class="line"></span><br><span class="line">permanent;</span><br><span class="line"><span class="comment">#重写完成后以永久重定向方式直接返回重写后生成的新URL给客户端，由客户端重新发起请求，状态码：301</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">break</span>;</span><br><span class="line"><span class="comment">#重写完成后,停止对当前URL在当前location中后续的其它重写操作，而后直接跳转至重写规则配置块之后的其它配置;结束循环，建议在location中使用</span></span><br><span class="line"><span class="comment">#适用于一个URL一次重写</span></span><br><span class="line"></span><br><span class="line">last;</span><br><span class="line"><span class="comment">#重写完成后,停止对当前URI在当前location中后续的其它重写操作，而后对新的URL启动新一轮重写检查，不建议在location中使用</span></span><br><span class="line"><span class="comment">#适用于一个URL多次重写，要注意避免出现超过十次以及URL重写后返回错误的给用户</span></span><br></pre></td></tr></table></figure>

<p>范例: 测试代码</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ~]<span class="comment"># cat /apps/nginx/conf.d/www.wang.org.conf</span></span><br><span class="line">server &#123;</span><br><span class="line">   listen 80;</span><br><span class="line">   server_name www.wang.org;</span><br><span class="line">   root /data/site;</span><br><span class="line">   location / &#123;</span><br><span class="line">       rewrite /1.html /2.html;</span><br><span class="line">       rewrite /2.html /3.html;</span><br><span class="line">   &#125;</span><br><span class="line">   location /2.html &#123;</span><br><span class="line">       rewrite /2.html /a.html;</span><br><span class="line">   &#125;</span><br><span class="line">   location /3.html &#123;</span><br><span class="line">       rewrite /3.html /b.html;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">#准备对应代码</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># mkdir -p /data/site</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># echo &quot;1.html&quot; &gt;/data/site/1.html</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># echo &quot;2.html&quot; &gt;/data/site/2.html</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># echo &quot;3.html&quot; &gt;/data/site/3.html</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># echo &quot;a.html&quot; &gt;/data/site/a.html</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># echo &quot;b.html&quot; &gt;/data/site/b.html</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#测试结果: 当请求http://www.wang.org/1.html，最终将会访问/b.html</span></span><br></pre></td></tr></table></figure>

<h4 id="break-与-last"><a href="#break-与-last" class="headerlink" title="break 与 last"></a>break 与 last</h4><h5 id="break-案例"><a href="#break-案例" class="headerlink" title="break 案例"></a>break 案例</h5><p>范例: break 案例</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ~]<span class="comment">#cat /apps/nginx/conf.d/www.wang.org.conf</span></span><br><span class="line">server &#123;</span><br><span class="line">   listen 80;</span><br><span class="line">   server_name www.wang.org;</span><br><span class="line">   root /data/site;</span><br><span class="line">   location / &#123;</span><br><span class="line">       rewrite /1.html /2.html <span class="built_in">break</span>;</span><br><span class="line">       rewrite /2.html /3.html;</span><br><span class="line">        <span class="comment">#echo break;</span></span><br><span class="line">   &#125;</span><br><span class="line">   location /2.html &#123;</span><br><span class="line">       rewrite /2.html /a.html;</span><br><span class="line">   &#125;</span><br><span class="line">   location /3.html &#123;</span><br><span class="line">       rewrite /3.html /b.html;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">#测试结果: 当请求/1.html，最终会访问/2.html</span></span><br><span class="line"><span class="comment">#原因:在location&#123;&#125;内部，遇到break，本location&#123;&#125;内以及后面的所有location&#123;&#125;内的所有指令都不再执行</span></span><br></pre></td></tr></table></figure>

<h5 id="last-案例"><a href="#last-案例" class="headerlink" title="last 案例"></a>last 案例</h5><p>last：对某个location的URL匹配成功后,会停止当前location的后续rewrite规则，并结束当前location，然后将匹配生成的新URL跳转至其他location继续匹配，直到没有location可匹配后, 将最后一次location的数据返回给客户端。</p>
<p>last 适用于要不改变客户端访问方式但是需做多次目的URL重写的场景</p>
<p>范例: last 案例</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ~]<span class="comment">#cat /apps/nginx/conf.d/www.wang.org.conf</span></span><br><span class="line">server &#123;</span><br><span class="line">   listen 80;</span><br><span class="line">   server_name www.wang.org;</span><br><span class="line">   root /data/site;</span><br><span class="line">   location / &#123;</span><br><span class="line">       rewrite /1.html /2.html last;</span><br><span class="line">       rewrite /2.html /3.html;</span><br><span class="line">   &#125;</span><br><span class="line">   location /2.html &#123;</span><br><span class="line">       rewrite /2.html /a.html;</span><br><span class="line">   &#125;</span><br><span class="line">   location /3.html &#123;</span><br><span class="line">       rewrite /3.html /b.html;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment"># 测试结果：当请求/1.html，最终会访问/a.html</span></span><br><span class="line"><span class="comment"># 原因：在location&#123;&#125;内部，遇到last，本location&#123;&#125;内后续指令不再执行，</span></span><br><span class="line"><span class="comment"># 而重写后的url会对所在的server&#123;...&#125;标签重新发起请求，从头到尾匹配一遍规则，哪个匹配则执行哪个。</span></span><br></pre></td></tr></table></figure>

<p>范例: last 案例死循环</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ~]<span class="comment">#cat /apps/nginx/conf.d/www.wang.org.conf</span></span><br><span class="line">server &#123;</span><br><span class="line">   listen 80;</span><br><span class="line">   server_name www.wang.org;</span><br><span class="line">   root /data/site;</span><br><span class="line">   location / &#123;</span><br><span class="line">       rewrite /1.html /2.html last;</span><br><span class="line">       rewrite /2.html /1.html last;</span><br><span class="line">   &#125;</span><br><span class="line">   location /3.html &#123;</span><br><span class="line">       rewrite /3.html /b.html;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 测试结果：出现500的错误</span></span><br><span class="line"><span class="comment"># 原因: 死循环</span></span><br></pre></td></tr></table></figure>

<h5 id="break-和-last-区别"><a href="#break-和-last-区别" class="headerlink" title="break 和 last 区别"></a>break 和 last 区别</h5><ul>
<li>rewrite指令中的break和last都属于服务器内部跳转,客户端链接地址不变,客户端无感知</li>
<li>当rewrite规则遇到break指令后，本location{}后续的指令与其他location{}的所有指令都不执行。</li>
<li>当rewrite规则遇到last指令后，本location{}里后续规则不执行，但重写后的url会再次从头开始匹配所有Location，也包括本location,哪个location先匹配到就执行哪个,可能会造成死循环500错误</li>
</ul>
<h4 id="永久与临时重定向"><a href="#永久与临时重定向" class="headerlink" title="永久与临时重定向"></a>永久与临时重定向</h4><p>域名的临时的调整，后期可能会变，之前的域名或者URL可能还用、或者跳转的目的域名和URL还会跳转，这种情况浏览器不会缓存跳转,临时重定向不会缓存域名解析记录(A记录)，但是永久重定向会缓存。 </p>
<p>示例: 因业务需要，将访问源域名 <a target="_blank" rel="noopener" href="http://www.wang.org/">www.wang.org</a> 的请求永久重定向到 <a target="_blank" rel="noopener" href="http://www.magedu.com/">www.magedu.com</a></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"> location / &#123;</span><br><span class="line">   root /data/nginx/html/pc;</span><br><span class="line">   index index.html;</span><br><span class="line">   rewrite / http://www.magedu.com permanent;</span><br><span class="line">    <span class="comment">#rewrite / http://www.magedu.com redirect;</span></span><br><span class="line"> &#125;</span><br><span class="line"> </span><br><span class="line"><span class="comment">#重启Nginx并访问域名 http://www.wang.org 进行测试</span></span><br></pre></td></tr></table></figure>

<p><img src="../../../../images/SRE/day28/105.jpg" alt="105"></p>
<h5 id="永久重定向301"><a href="#永久重定向301" class="headerlink" title="永久重定向301"></a>永久重定向301</h5><p>域名永久型调整，即域名永远跳转至另外一个新的域名，之前的域名再也不使用，跳转记录可以缓存到客户端浏览器</p>
<p>永久重定向会缓存DNS解析记录, 浏览器中有 from disk cache 信息,即使nginx服务器无法访问,浏览器也会利用缓存进行重定向</p>
<p>比如: 京东早期的域名 <a target="_blank" rel="noopener" href="http://www.360buy.com/">www.360buy.com</a> 由于与360公司类似，于是后期永久重定向到了 <a target="_blank" rel="noopener" href="http://www.jd.com/">www.jd.com</a></p>
<p><img src="../../../../images/SRE/day28/106.jpg" alt="106"></p>
<p>范例: permanent 301永久重定向</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ~]<span class="comment">#cat /apps/nginx/conf.d/www.wang.org.conf</span></span><br><span class="line">server &#123;</span><br><span class="line">   listen 80;</span><br><span class="line">   server_name www.wang.org;</span><br><span class="line">   root /data/site;</span><br><span class="line">   location / &#123;</span><br><span class="line">       rewrite /1.html /2.html permanent;</span><br><span class="line">       rewrite /2.html /3.html;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">#测试结果: 当请求/1.html，最终会访问/2.html</span></span><br><span class="line"><span class="comment">#原因:在location&#123;&#125;内部遇到permanent，客户端会重新发起新请求到新的重定向地址进行访问,而且url会修改为后面的新URL</span></span><br></pre></td></tr></table></figure>

<h5 id="临时重定向302"><a href="#临时重定向302" class="headerlink" title="临时重定向302"></a>临时重定向302</h5><p>域名临时重定向，告诉浏览器域名不是固定重定向到当前目标域名，后期可能随时会更改，因此浏览器不会缓存当前域名的解析记录，而浏览器会缓存永久重定向的DNS解析记录，这也是临时重定向与永久重定向最大的本质区别。</p>
<p>即当nginx服务器无法访问时,浏览器不能利用缓存,而导致重定向失败</p>
<p><img src="../../../../images/SRE/day28/107.jpg" alt="107"></p>
<p>范例: redirect 302 临时重定向</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ~]<span class="comment">#cat /apps/nginx/conf.d/www.wang.org.conf</span></span><br><span class="line">server &#123;</span><br><span class="line">   listen 80;</span><br><span class="line">   server_name www.wang.org;</span><br><span class="line">   root /data/site;</span><br><span class="line">   location / &#123;</span><br><span class="line">       rewrite /1.html /2.html redirect ;</span><br><span class="line">       rewrite /2.html /3.html;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">#测试结果: 当请求/1.html，最终会访问/2.html</span></span><br><span class="line"><span class="comment">#原因:在location&#123;&#125;内部遇到redirect，客户端会重新发起新请求到新的重定向地址进行访问,而且url会修改为后面的新URL</span></span><br></pre></td></tr></table></figure>

<h5 id="redirect与permanent区别"><a href="#redirect与permanent区别" class="headerlink" title="redirect与permanent区别"></a>redirect与permanent区别</h5><p>redirect与permanent都会导致客户端上重新发起的请求,链接地址会发生变化,客户端可以感知到变化</p>
<table>
<thead>
<tr>
<th>flag</th>
<th>状态码</th>
<th>说明</th>
<th>特点</th>
</tr>
</thead>
<tbody><tr>
<td>permanent</td>
<td>301</td>
<td>永久跳转</td>
<td>旧网站排名会被清空，新跳转网站继承原网站的排名，跳转会缓存下来,主要用于旧域名废弃和新域名网站启用时使用</td>
</tr>
<tr>
<td>redirect</td>
<td>302</td>
<td>临时跳转</td>
<td>旧网站无影响，新网站会有排名,跳转不会缓存</td>
</tr>
</tbody></table>
<h3 id="案例"><a href="#案例" class="headerlink" title="案例"></a>案例</h3><h4 id="自动跳转-https"><a href="#自动跳转-https" class="headerlink" title="自动跳转 https"></a>自动跳转 https</h4><p>案例：基于通信安全考虑公司网站要求全站 https，因此要求将在不影响用户请求的情况下将http请求全部自动跳转至 https，另外也可以实现部分 location 跳转</p>
<p>范例:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">  listen 80;</span><br><span class="line">  server_name www.wang.org;</span><br><span class="line">  <span class="built_in">return</span> 302 https://$server_name<span class="variable">$request_uri</span>;</span><br><span class="line">&#125;</span><br><span class="line">server &#123;</span><br><span class="line">  listen 443 ssl http2;</span><br><span class="line">  server_name www.wang.org;</span><br><span class="line">  ssl_certificate   /etc/nginx/ssl/www.wang.org.crt;</span><br><span class="line">  ssl_certificate_key /etc/nginx/ssl/www.wang.org.key;</span><br><span class="line">  location / &#123;</span><br><span class="line">    root /data/www/html; </span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>范例:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ~]<span class="comment"># vim /apps/nginx/conf.d/pc.conf</span></span><br><span class="line">server &#123;</span><br><span class="line">  listen 443 ssl;</span><br><span class="line">  listen 80;</span><br><span class="line">  ssl_certificate /apps/nginx/certs/www.wang.org.crt;</span><br><span class="line">  ssl_certificate_key /apps/nginx/certs/www.wang.org.key;</span><br><span class="line">  ssl_session_cache shared:sslcache:20m;</span><br><span class="line">  ssl_session_timeout 10m;</span><br><span class="line">  server_name www.wang.org;</span><br><span class="line">  location / &#123;    <span class="comment">#针对全站跳转</span></span><br><span class="line">    root /data/nginx/html/pc;</span><br><span class="line">    index index.html;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$scheme</span> = http )&#123;  <span class="comment">#如果没有加条件判断，会导致死循环</span></span><br><span class="line">      rewrite ^/(.*) https://<span class="variable">$host</span>/<span class="variable">$1</span> redirect;</span><br><span class="line">    &#125;  </span><br><span class="line">  &#125;</span><br><span class="line">  location /login &#123;     <span class="comment">#针对特定的URL进行跳转https </span></span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$scheme</span> = http )&#123;  <span class="comment">#如果没有加条件判断，会导致死循环</span></span><br><span class="line">      rewrite / https://<span class="variable">$host</span>/login redirect;</span><br><span class="line">    &#125; </span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">#重启Nginx并访问测试</span></span><br><span class="line">[root@centos7 ~]<span class="comment"># curl -ikL www.wang.org</span></span><br><span class="line">HTTP/1.1 302 Moved Temporarily</span><br><span class="line">Server: nginx/1.18.0</span><br><span class="line">Date: Thu, 08 Oct 2020 15:23:48 GMT</span><br><span class="line">Content-Type: text/html</span><br><span class="line">Content-Length: 145</span><br><span class="line">Connection: keep-alive</span><br><span class="line">Location: https://www.wang.org</span><br><span class="line">HTTP/1.1 200 OK</span><br><span class="line">Server: nginx/1.18.0</span><br><span class="line">Date: Thu, 08 Oct 2020 15:23:48 GMT</span><br><span class="line">Content-Type: text/html</span><br><span class="line">Content-Length: 7</span><br><span class="line">Last-Modified: Sat, 26 Sep 2020 01:18:32 GMT</span><br><span class="line">Connection: keep-alive</span><br><span class="line">ETag: <span class="string">&quot;5f6e96e8-7&quot;</span></span><br><span class="line">Accept-Ranges: bytes</span><br><span class="line"></span><br><span class="line">pc web</span><br></pre></td></tr></table></figure>

<p>范例: 如果是因为规则匹配问题导致的陷入死循环</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">[root@centos7 ~]<span class="comment"># curl -IkL http://www.wang.org </span></span><br><span class="line">HTTP/1.1 302 Moved Temporarily</span><br><span class="line">Server: nginx/1.18.0</span><br><span class="line">Date: Thu, 08 Oct 2020 13:07:19 GMT</span><br><span class="line">Content-Type: text/html</span><br><span class="line">Content-Length: 145</span><br><span class="line">Connection: keep-alive</span><br><span class="line">Location: https://www.wang.org/</span><br><span class="line"></span><br><span class="line">HTTP/1.1 302 Moved Temporarily</span><br><span class="line">Server: nginx/1.18.0</span><br><span class="line">Date: Thu, 08 Oct 2020 13:07:19 GMT</span><br><span class="line">Content-Type: text/html</span><br><span class="line">Content-Length: 145</span><br><span class="line">Connection: keep-alive</span><br><span class="line">Location: https://www.wang.org/</span><br><span class="line"></span><br><span class="line">HTTP/1.1 302 Moved Temporarily</span><br><span class="line">Server: nginx/1.18.0</span><br><span class="line">Date: Thu, 08 Oct 2020 13:07:19 GMT</span><br><span class="line">Content-Type: text/html</span><br><span class="line">Content-Length: 145</span><br><span class="line">Connection: keep-alive</span><br><span class="line">Location: https://www.wang.org/</span><br><span class="line"></span><br><span class="line">HTTP/1.1 302 Moved Temporarily</span><br><span class="line">Server: nginx/1.18.0</span><br><span class="line">Date: Thu, 08 Oct 2020 13:39:59 GMT</span><br><span class="line">Content-Type: text/html</span><br><span class="line">Content-Length: 145</span><br><span class="line">Connection: keep-alive</span><br><span class="line">Location: https://www.wang.org</span><br><span class="line"></span><br><span class="line">curl: (47) Maximum (50) redirects followed</span><br></pre></td></tr></table></figure>

<p><img src="../../../../images/SRE/day28/108.jpg" alt="108"></p>
<h4 id="判断文件是否存在"><a href="#判断文件是否存在" class="headerlink" title="判断文件是否存在"></a>判断文件是否存在</h4><p>案例：当用户访问到公司网站的时输入了一个错误的URL，可以将用户重定向至官网首页</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ~]<span class="comment">#vim /apps/nginx/conf.d/pc.conf</span></span><br><span class="line">server &#123;</span><br><span class="line">   listen 80;</span><br><span class="line">   server_name www.wang.org;</span><br><span class="line">   location / &#123;</span><br><span class="line">   root /data/nginx/html/pc;</span><br><span class="line">   index index.html;</span><br><span class="line">    <span class="keyword">if</span> (!-e <span class="variable">$request_filename</span>) &#123;</span><br><span class="line">       rewrite .* http://www.wang.org/index.html; <span class="comment">#实现客户端浏览器的302跳转</span></span><br><span class="line">        <span class="comment">#rewrite .* /index.html; #web服务器内部跳转</span></span><br><span class="line">   &#125;</span><br><span class="line"> &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">#重启Nginx并访问测试</span></span><br></pre></td></tr></table></figure>

<h4 id="指定客户端类型跳转新的域名"><a href="#指定客户端类型跳转新的域名" class="headerlink" title="指定客户端类型跳转新的域名"></a>指定客户端类型跳转新的域名</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#需求：用户通过手机设备访问 www.wang.org，跳转至m.wang.org</span></span><br><span class="line">[root@centos8 ~]<span class="comment">#vim /apps/nginx/conf.d/www.wang.org.conf</span></span><br><span class="line">server &#123;</span><br><span class="line">   listen 80;</span><br><span class="line">   server_name www.wang.org;</span><br><span class="line">   root /data/nginx/html/pc;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$http_user_agent</span> ~* <span class="string">&quot;android|iphone|ipad&quot;</span>) &#123;</span><br><span class="line">       rewrite ^/(.*)$ http://m.wang.org/<span class="variable">$1</span> redirect;</span><br><span class="line">       <span class="comment">#return 302 http://m.wang.org$request_uri ;</span></span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="网站维护跳转"><a href="#网站维护跳转" class="headerlink" title="网站维护跳转"></a>网站维护跳转</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#需求: 公司网站在停机维护时，指定的IP能够正常访问，其他的IP跳转到维护页。</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># cat /apps/nginx/conf.d/www.wang.org.conf</span></span><br><span class="line">server &#123;</span><br><span class="line">   listen 80;</span><br><span class="line">   server_name www.wang.org;</span><br><span class="line">   root /data/site;</span><br><span class="line">   index index.html;</span><br><span class="line">    <span class="comment">#在server层下设定ip变量值为0</span></span><br><span class="line">    <span class="built_in">set</span> <span class="variable">$ip</span> 0;</span><br><span class="line">    <span class="comment">#如果来源IP是10.0.0.101或102则设定变量为ip变量为1。</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$remote_addr</span> = 10.0.0.101) &#123;</span><br><span class="line">        <span class="built_in">set</span> <span class="variable">$ip</span> 1;</span><br><span class="line">     &#125;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$remote_addr</span> = 10.0.0.102) &#123;</span><br><span class="line">        <span class="built_in">set</span> <span class="variable">$ip</span> 1;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">#如果来源IP不是10.0.0.101或102、则跳转至/data/site/maintain.html这个页面,否则不做任何处理</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$ip</span> = 0) &#123;</span><br><span class="line">       rewrite ^(.*)$ /maintain.html <span class="built_in">break</span>;</span><br><span class="line">     &#125;</span><br><span class="line">     <span class="comment">#如果想针对某个location进行操作，则将如上配置写入location中即可</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="其它案例"><a href="#其它案例" class="headerlink" title="其它案例"></a>其它案例</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#案例1:如果客户端浏览器包含MSIE，则rewrite客户端请求到/msie目录下</span></span><br><span class="line"><span class="keyword">if</span> ( <span class="variable">$http_user_agent</span> ~ MSIE)&#123;</span><br><span class="line">  rewrite ^(.*)$ /msie/<span class="variable">$1</span> <span class="built_in">break</span>;</span><br><span class="line">&#125; </span><br><span class="line"> </span><br><span class="line"><span class="comment">#案例2: 更换目录访问方式,目录转换为对象存储形式</span></span><br><span class="line"><span class="comment">#要求:</span></span><br><span class="line"><span class="comment">#/20200106/static -&gt;/static?id=20200106</span></span><br><span class="line"><span class="comment">#/20200123/image -&gt;/image?id=20200123</span></span><br><span class="line">rewrite ^/(\d+)/(.+)/   /<span class="variable">$2</span>?<span class="built_in">id</span>=<span class="variable">$1</span> redirect;</span><br><span class="line"></span><br><span class="line"><span class="comment">#案例3:多目录转换访问方式</span></span><br><span class="line"><span class="comment">#要求: www.magedu.com/images/20200106/1.jpg =&gt; www.magedu.com/index.do?name=images&amp;dir=20200106=&amp;file=1.jpg</span></span><br><span class="line"><span class="comment">#规则配置:</span></span><br><span class="line"><span class="keyword">if</span> (<span class="variable">$host</span> ~* (.*)\.magedu\.com) &#123;</span><br><span class="line">  rewrite ^/(.*)/(\d+)/(.*)$   /index.do?name=<span class="variable">$1</span>&amp;<span class="built_in">dir</span>=<span class="variable">$2</span>&amp;file=<span class="variable">$3</span> redirect; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Nginx-防盗链"><a href="#Nginx-防盗链" class="headerlink" title="Nginx 防盗链"></a>Nginx 防盗链</h2><p>防盗链基于客户端携带的referer实现，referer是记录打开一个页面之前记录是从哪个页面跳转过来的标记信息，如果别人只链接了自己网站图片或某个单独的资源，而不是打开了网站的整个页面，这就是盗链，referer就是之前的那个网站域名</p>
<p>正常通过搜索引擎搜索web 网站并访问该网站的referer信息如下：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ~]<span class="comment">#tail -f /apps/nginx/logs/wang.org_access.log</span></span><br><span class="line">10.0.0.1 - - [11/Oct/2020:09:28:10 +0800] <span class="string">&quot;GET /images/logo.png HTTP/1.1&quot;</span> 302 145 <span class="string">&quot;-&quot;</span> <span class="string">&quot;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/86.0.4240.75 Safari/537.36 Edg/86.0.622.38&quot;</span> <span class="string">&quot;-&quot;</span></span><br><span class="line">10.0.0.1 - - [11/Oct/2020:09:30:39 +0800] <span class="string">&quot;GET /images/logo.png HTTP/1.1&quot;</span> 200 5934 <span class="string">&quot;http://10.0.0.18/&quot;</span> <span class="string">&quot;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/86.0.4240.75 Safari/537.36 Edg/86.0.622.38&quot;</span> <span class="string">&quot;-&quot;</span></span><br><span class="line">10.0.0.1 - - [11/Oct/2020:09:32:20 +0800] <span class="string">&quot;GET /images/logo.png HTTP/1.1&quot;</span> 200 5934 <span class="string">&quot;http://www.wange.org/&quot;</span> <span class="string">&quot;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/86.0.4240.75 Safari/537.36 Edg/86.0.622.38&quot;</span> <span class="string">&quot;-&quot;</span></span><br><span class="line">10.0.0.1 - - [11/Oct/2020:09:35:07 +0800] <span class="string">&quot;GET /test1.html HTTP/1.1&quot;</span> 200 283 <span class="string">&quot;-&quot;</span> <span class="string">&quot;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/86.0.4240.75 Safari/537.36 Edg/86.0.622.38&quot;</span> <span class="string">&quot;-&quot;</span></span><br><span class="line">10.0.0.1 - - [11/Oct/2020:09:35:48 +0800] <span class="string">&quot;GET / HTTP/1.1&quot;</span> 200 7 <span class="string">&quot;http://www.wang.org/test1.html&quot;</span> <span class="string">&quot;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/86.0.4240.75 Safari/537.36 Edg/86.0.622.38&quot;</span> <span class="string">&quot;-&quot;</span></span><br><span class="line">10.0.0.1 - - [11/Oct/2020:09:37:39 +0800] <span class="string">&quot;GET /images/logo.png HTTP/1.1&quot;</span> 200 5934 <span class="string">&quot;http://www.baidu.com/&quot;</span> <span class="string">&quot;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/85.0.4183.83 Safari/537.36&quot;</span> <span class="string">&quot;-&quot;</span></span><br><span class="line">10.0.0.1 - - [11/Oct/2020:09:38:17 +0800] <span class="string">&quot;GET /images/logo.png HTTP/1.1&quot;</span> 200 5934 <span class="string">&quot;http://www.baidu.com/&quot;</span> <span class="string">&quot;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/85.0.4183.83 Safari/537.36&quot;</span> <span class="string">&quot;-&quot;</span></span><br><span class="line">10.0.0.1 - - [11/Oct/2020:09:38:27 +0800] <span class="string">&quot;GET / HTTP/1.1&quot;</span> 200 7 <span class="string">&quot;http://www.baidu.com/&quot;</span> <span class="string">&quot;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/85.0.4183.83 Safari/537.36&quot;</span> <span class="string">&quot;-&quot;</span></span><br><span class="line">10.0.0.1 - - [11/Oct/2020:09:38:27 +0800] <span class="string">&quot;GET /favicon.ico HTTP/1.1&quot;</span> 200 1150 <span class="string">&quot;http://www.wang.org/&quot;</span> <span class="string">&quot;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/85.0.4183.83 Safari/537.36&quot;</span> <span class="string">&quot;-&quot;</span></span><br><span class="line">10.0.0.1 - - [11/Oct/2020:09:41:35 +0800] <span class="string">&quot;GET / HTTP/1.1&quot;</span> 304 0 <span class="string">&quot;http://www.baidu.com/&quot;</span> <span class="string">&quot;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/85.0.4183.83 Safari/537.36&quot;</span> <span class="string">&quot;-&quot;</span></span><br><span class="line">10.0.0.1 - - [11/Oct/2020:09:41:35 +0800] <span class="string">&quot;GET /favicon.ico HTTP/1.1&quot;</span> 200 1150 <span class="string">&quot;http://www.wang.org/&quot;</span> <span class="string">&quot;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/85.0.4183.83 Safari/537.36&quot;</span> <span class="string">&quot;-&quot;</span></span><br><span class="line">10.0.0.1 - - [11/Oct/2020:09:42:41 +0800] <span class="string">&quot;GET /test.html HTTP/1.1&quot;</span> 200 5 <span class="string">&quot;-&quot;</span></span><br><span class="line"><span class="string">&quot;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/86.0.4240.75 Safari/537.36 Edg/86.0.622.38&quot;</span> <span class="string">&quot;-&quot;</span></span><br><span class="line">10.0.0.1 - - [11/Oct/2020:09:42:45 +0800] <span class="string">&quot;GET /test1.html HTTP/1.1&quot;</span> 304 0 <span class="string">&quot;-&quot;</span></span><br><span class="line"><span class="string">&quot;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/86.0.4240.75 Safari/537.36 Edg/86.0.622.38&quot;</span> <span class="string">&quot;-&quot;</span></span><br></pre></td></tr></table></figure>

<p>json格式日志</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#通过搜索引擎访问web网站的referer信息：</span></span><br><span class="line">==&gt; /apps/nginx/logs/access_json.log &lt;==</span><br><span class="line">&#123;<span class="string">&quot;@timestamp&quot;</span>:<span class="string">&quot;2019-02-</span></span><br><span class="line"><span class="string">28T13:58:46+08:00&quot;</span>,<span class="string">&quot;host&quot;</span>:<span class="string">&quot;10.0.0.100&quot;</span>,<span class="string">&quot;clientip&quot;</span>:<span class="string">&quot;10.0.0.1&quot;</span>,<span class="string">&quot;size&quot;</span>:0,<span class="string">&quot;responsetime&quot;</span>:0.000,<span class="string">&quot;upstreamtime&quot;</span>:<span class="string">&quot;-&quot;</span>,<span class="string">&quot;upstreamhost&quot;</span>:<span class="string">&quot;-&quot;</span>,<span class="string">&quot;http_host&quot;</span>:<span class="string">&quot;www.wang.org&quot;</span>,<span class="string">&quot;uri&quot;</span>:<span class="string">&quot;/index.html&quot;</span>,<span class="string">&quot;domain&quot;</span>:<span class="string">&quot;www.wang.org&quot;</span>,<span class="string">&quot;xff&quot;</span>:<span class="string">&quot;-&quot;</span>,<span class="string">&quot;referer&quot;</span>:<span class="string">&quot;https://www.baidu.com/s?ie=utf-8&amp;f=8&amp;rsv_bp=1&amp;rsv_idx=1&amp;tn=baidu&amp;wd=www.wang.org&amp;oq=www.wange.net&amp;rsv_pq=d63060680002eb69&amp;rsv_t=de01TWnmyTdcJqph7SfI1hXgXLJxSSfUPcQ3QkWdJk%2FLNrN95ih3XOhbRs4&amp;rqlang=cn&amp;rsv_enter=1&amp;inputT=321&amp;rsv_sug3=41&amp;rsv_sug2=0&amp;rsv_sug4=1626&quot;</span>,<span class="string">&quot;tcp_xff&quot;</span>: <span class="string">&quot;&quot;</span>,<span class="string">&quot;http_user_agent&quot;</span>:<span class="string">&quot;Mozilla/5.0 (Windows NT 6.1; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/72.0.3626.119 Safari/537.36&quot;</span>,<span class="string">&quot;status&quot;</span>:<span class="string">&quot;304&quot;</span>&#125;</span><br></pre></td></tr></table></figure>

<h3 id="实现盗链"><a href="#实现盗链" class="headerlink" title="实现盗链"></a>实现盗链</h3><p>在一个web 站点盗链另一个站点的资源信息，比如:图片、视频等</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#新建一个主机www.wange.org,盗取另一台主机www.wang.org的图片</span></span><br><span class="line">[root@centos8 conf.d]<span class="comment"># pwd</span></span><br><span class="line">/apps/nginx/conf/conf.d</span><br><span class="line"></span><br><span class="line"><span class="comment">#盗链服务器配置如下</span></span><br><span class="line">[root@centos8 conf.d]<span class="comment"># cat wange.org.conf </span></span><br><span class="line">server &#123;</span><br><span class="line">  listen 80;</span><br><span class="line">  server_name www.wange.org;</span><br><span class="line">  location / &#123;</span><br><span class="line">    index index.html;</span><br><span class="line">    root <span class="string">&quot;/data/nginx/html/wange&quot;</span>;</span><br><span class="line">    access_log /apps/nginx/logs/www.wange.org_access.log main;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">#准备盗链web页面：</span></span><br><span class="line">[root@centos8 conf.d]<span class="comment"># mkdir /data/nginx/html/wange</span></span><br><span class="line">[root@centos8 conf.d]<span class="comment"># cat /data/nginx/html/wange/daolian.html </span></span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;<span class="built_in">head</span>&gt;</span><br><span class="line">&lt;meta http-equiv=Content-Type content=<span class="string">&quot;text/html;charset=utf-8&quot;</span>&gt;</span><br><span class="line">&lt;title&gt;盗链&lt;/title&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">&lt;img src=<span class="string">&quot;http://www.wang.org/images/logo.jpg&quot;</span> &gt;</span><br><span class="line">&lt;h1 style=<span class="string">&quot;color:red&quot;</span>&gt;欢迎大家&lt;/h1&gt;</span><br><span class="line">&lt;p&gt;&lt;a href=http://www.wang.org&gt;马哥教育&lt;/a&gt;欢迎你&lt;/p&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment">#重启Nginx并访问http://www.wange.org/daolian.html 测试</span></span><br><span class="line"><span class="comment">#验证两个域名的日志，是否会在被盗链的web站点的日志中出现以下盗链日志信息：</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># tail /apps/nginx/logs/wang.org_access.log</span></span><br><span class="line">10.0.0.1 - - [11/Oct/2020:09:50:07 +0800] <span class="string">&quot;GET /images/logo.png HTTP/1.1&quot;</span> 200 5934 <span class="string">&quot;http://www.wange.org/&quot;</span> <span class="string">&quot;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/86.0.4240.75 Safari/537.36 Edg/86.0.622.38&quot;</span> <span class="string">&quot;-&quot;</span></span><br></pre></td></tr></table></figure>

<p><img src="../../../../images/SRE/day28/109.jpg" alt="109"></p>
<h3 id="实现防盗链"><a href="#实现防盗链" class="headerlink" title="实现防盗链"></a>实现防盗链</h3><p>基于访问安全考虑，nginx支持通过ngx_http_referer_module模块,检查访问请求的referer信息是否有效实现防盗链功能</p>
<p>官方文档: </p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://nginx.org/en/docs/http/ngx_http_referer_module.html</span><br></pre></td></tr></table></figure>

<p>语法:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">Syntax: valid_referers none | blocked | server_names | string ...;</span><br><span class="line">Default: —</span><br><span class="line">Context: server, location</span><br><span class="line"></span><br><span class="line">none：<span class="comment">#请求报文首部没有referer首部，比如用户直接在浏览器输入域名访问web网站，就没有referer信息。</span></span><br><span class="line">blocked：<span class="comment">#请求报文有referer首部，但无有效值，比如为空。</span></span><br><span class="line">server_names：<span class="comment">#referer首部中包含本主机名及即nginx 监听的server_name。</span></span><br><span class="line">arbitrary_string：<span class="comment">#自定义指定字符串，但可使用*作通配符。示例: *.wang.org www.magedu.*</span></span><br><span class="line">regular expression：<span class="comment">#被指定的正则表达式模式匹配到的字符串,要使用~开头，例如：~.*\.magedu\.com</span></span><br></pre></td></tr></table></figure>

<p>示例：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">location   /images &#123;</span><br><span class="line">   root /data/nginx/html/pc;</span><br><span class="line">   index index.html;</span><br><span class="line">   valid_referers none blocked server_names</span><br><span class="line">         *.example.com example.* www.example.org/galleries/</span><br><span class="line">         ~\.google\.;</span><br><span class="line">          </span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$invalid_referer</span>) &#123;</span><br><span class="line">     <span class="built_in">return</span> 403;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<p>范例: 定义防盗链：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ~]<span class="comment"># vim /apps/nginx/conf/conf.d/pc.conf</span></span><br><span class="line">server &#123;</span><br><span class="line">   index index.html;</span><br><span class="line">   valid_referers none blocked server_names *.wang.com *.wang.org   ~\.google\. ~\.baidu\. ~\.bing\. ~\.so\. ; <span class="comment">#定义有效的referer</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$invalid_referer</span>) &#123; <span class="comment">#假如是使用其他的无效的referer访问</span></span><br><span class="line">      <span class="built_in">return</span> 403 <span class="string">&quot;Forbidden Access&quot;</span>; <span class="comment">#返回状态码403</span></span><br><span class="line">      <span class="comment">#return 302 http://www.wangxiaochun.com/testdir/daotu.jpg;</span></span><br><span class="line">      <span class="comment">#rewrite ^(.*)$ /daolian.jpg break;#或者返回错误图片</span></span><br><span class="line">   &#125;</span><br><span class="line">......</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">#重启Nginx并访问测试</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#指定referer为http://www.baidu.com进行访问</span></span><br><span class="line">[root@centos7 ~]<span class="comment"># curl -e &#x27;http://www.baidu.com&#x27; www.wang.org</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#指定referer为http://www.xxx.com进行访问,被拒绝</span></span><br><span class="line">[root@centos7 ~]<span class="comment"># curl -e &#x27;http://www.xxx.com&#x27; www.wang.org</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#不加http的referer不会拒绝</span></span><br><span class="line">[root@centos7 ~]<span class="comment"># curl -e &#x27;www.xxx.com&#x27; www.wang.org</span></span><br></pre></td></tr></table></figure>

<p>使用浏览器访问盗链网站 <a target="_blank" rel="noopener" href="http://www.wange.org/daolian.html%EF%BC%8C">http://www.wange.org/daolian.html，</a> 验证是否提前状态码403：</p>
<p><img src="../../../../images/SRE/day28/110.jpg" alt="110"></p>
<p>在被盗链的nginx服务器查看日志</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ~]<span class="comment">#tail /apps/nginx/logs/wang.org_access.log </span></span><br><span class="line">10.0.0.1 - - [11/Oct/2020:09:55:26 +0800] <span class="string">&quot;GET /images/logo.png HTTP/1.1&quot;</span> 403 16 <span class="string">&quot;http://www.wange.org/&quot;</span> <span class="string">&quot;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/86.0.4240.75 Safari/537.36 Edg/86.0.622.38&quot;</span> <span class="string">&quot;-&quot;</span></span><br></pre></td></tr></table></figure>

<h1 id="Nginx-反向代理"><a href="#Nginx-反向代理" class="headerlink" title="Nginx 反向代理"></a>Nginx 反向代理</h1><p><strong>代理Proxy有两种</strong></p>
<ul>
<li>正向代理: 代理客户端访问服务器,可以实现缓存,科学上网,访问控制等功能</li>
<li>反向代理：reverse proxy，指的是代理外网用户的请求到内部的指定的服务器，并将数据返回给用户的一种方式，这是用的比较多的一种方式。</li>
</ul>
<p><img src="../../../../images/SRE/day28/111.jpg" alt="111"></p>
<p>Nginx 除了可以在企业提供高性能的web服务之外，另外还可以将 nginx 本身不具备的请求通过某种预定义的协议转发至其它服务器处理，不同的协议就是Nginx服务器与其他服务器进行通信的一种规范，主要在不同的场景使用以下模块实现不同的功能</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">ngx_http_proxy_module： <span class="comment">#将客户端的请求以http协议转发至指定服务器进行处理</span></span><br><span class="line">ngx_http_upstream_module <span class="comment">#用于定义为proxy_pass,fastcgi_pass,uwsgi_pass等指令引用的后端服务器分组</span></span><br><span class="line">ngx_stream_proxy_module：<span class="comment">#将客户端的请求以tcp协议转发至指定服务器处理</span></span><br><span class="line">ngx_http_fastcgi_module：<span class="comment">#将客户端对php的请求以fastcgi协议转发至指定服务器助理</span></span><br><span class="line">ngx_http_uwsgi_module： <span class="comment">#将客户端对Python的请求以uwsgi协议转发至指定服务器处理</span></span><br></pre></td></tr></table></figure>

<p><strong>生产环境部署结构：</strong></p>
<p><img src="../../../../images/SRE/day28/112.jpg" alt="112"></p>
<p><strong>访问逻辑图：</strong></p>
<p><img src="../../../../images/SRE/day28/113.jpg" alt="113"></p>
<p><strong>LVS和nginx的区别</strong></p>
<p><img src="../../../../images/SRE/day28/114.jpg" alt="114"></p>
<ul>
<li>工作层：LVS四层，Nginx七层</li>
<li>监听端口：LVS不监听，Nginx监听端口</li>
<li>后端服务器看到客户端地址：LVS可以，Nginx不可以</li>
<li>连接（三次握手）：LVS 不参与连接，只负责转发，Nginx代替后端服务器和客户建立连接</li>
</ul>
<h2 id="实现-http-反向代理"><a href="#实现-http-反向代理" class="headerlink" title="实现 http 反向代理"></a>实现 http 反向代理</h2><h3 id="http-协议反向代理"><a href="#http-协议反向代理" class="headerlink" title="http 协议反向代理"></a>http 协议反向代理</h3><p>Nginx 可以基于ngx_http_proxy_module模块提供http协议的反向代理服务</p>
<p>官方文档：</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://nginx.org/en/docs/http/ngx_http_proxy_module.html</span><br></pre></td></tr></table></figure>

<h4 id="反向代理配置参数"><a href="#反向代理配置参数" class="headerlink" title="反向代理配置参数"></a>反向代理配置参数</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#官方文档：https://nginx.org/en/docs/http/ngx_http_proxy_module.html#proxy_pass </span></span><br><span class="line">Syntax: proxy_pass URL;</span><br><span class="line">Default: —</span><br><span class="line">Context: location, <span class="keyword">if</span> <span class="keyword">in</span> location, limit_except</span><br><span class="line"></span><br><span class="line"><span class="comment">#用来设置将客户端请求转发给的后端服务器的主机，可以是主机名(将转发至后端服务做为主机头首部)、IP:port 方式</span></span><br><span class="line"><span class="comment">#说明: proxy_pass http://FQDN/ 中的FQDN决定转发至后端哪个虚拟主机,而与用户请求的URL无关</span></span><br><span class="line"><span class="comment">#如果转到后端的哪个服务器由用户请求决定,可以向后端服务转发请求的主机头实现</span></span><br><span class="line"><span class="comment">#示例: proxy_set_header Host $http_host; </span></span><br><span class="line"><span class="comment">#示例:</span></span><br><span class="line"> location /web &#123;</span><br><span class="line">   index index.html;</span><br><span class="line">   proxy_pass http://10.0.0.18:8080; <span class="comment">#8080后面无uri,即无 / 符号,需要将location后面url 附加到proxy_pass指定的url后面,此行为类似于root</span></span><br><span class="line">    <span class="comment">#proxy_pass指定的uri不带斜线将访问的/web,等于访问后端服务器http://10.0.0.18:8080/web/index.html，即后端服务器配置的站点根目录要有web目录才可以被访问</span></span><br><span class="line">    <span class="comment"># http://nginx/web/index.html ==&gt; http://10.0.0.18:8080/web/index.html</span></span><br><span class="line">   proxy_pass http://10.0.0.18:8080/;   <span class="comment">#8080后面有uri,即有 / 符号,相当于置换,即访问/web时实际返回proxy_pass后面uri内容.此行为类似于alias </span></span><br><span class="line">    <span class="comment">#proxy_pass指定的uri带斜线，等于访问后端服务器的http://10.0.0.18:8080/index.html 内容返回给客户端</span></span><br><span class="line"> &#125;  <span class="comment"># http://nginx/web/index.html ==&gt; http://10.0.0.18:8080</span></span><br><span class="line">    </span><br><span class="line"><span class="comment">#重启Nginx测试访问效果：</span></span><br><span class="line"><span class="comment">#curl -L http://www.wang.org/web</span></span><br><span class="line"><span class="comment">#如果location定义其uri时使用了正则表达式模式(包括~,~*,但不包括^~)，则proxy_pass之后必须不能使用uri; 即不能有/ ,用户请求时传递的uri将直接附加至后端服务器之后</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">server &#123;</span><br><span class="line"> ...</span><br><span class="line"> server_name HOSTNAME;</span><br><span class="line"> location ~|~* /uri/ &#123;</span><br><span class="line">   proxy_pass http://host:port; <span class="comment">#proxy_pass后面的url 不能加/</span></span><br><span class="line"> &#125;</span><br><span class="line"> ...</span><br><span class="line"> &#125;</span><br><span class="line"> http://HOSTNAME/uri/ --&gt; http://host/uri/ </span><br><span class="line"></span><br><span class="line">proxy_hide_header field;</span><br><span class="line"><span class="comment">#用于nginx作为反向代理的时候，在返回给客户端http响应时，隐藏后端服务器相应头部的信息，可以设置在http,server或location块</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#示例: 隐藏后端服务器ETag首部字段</span></span><br><span class="line"> location /web &#123;</span><br><span class="line">   index index.html;</span><br><span class="line">   proxy_pass http://10.0.0.18:8080/; </span><br><span class="line">   proxy_hide_header ETag;</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line">proxy_pass_header field;</span><br><span class="line"><span class="comment">#默认nginx在响应报文中不传递后端服务器的首部字段Date, Server, X-Pad, X-Accel等参数，如果要传递的话则要使用 proxy_pass_header field声明将后端服务器返回的值传递给客户端</span></span><br><span class="line"><span class="comment">#field 首部字段大小不敏感</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#示例:透传后端服务器的Server和Date首部给客户端,同时不再响应报中显示前端服务器的Server字段</span></span><br><span class="line">proxy_pass_header Server;</span><br><span class="line">proxy_pass_header Date;</span><br><span class="line"></span><br><span class="line">proxy_pass_request_body on | off; </span><br><span class="line"><span class="comment">#是否向后端服务器发送HTTP实体部分,可以设置在http,server或location块，默认即为开启</span></span><br><span class="line"></span><br><span class="line">proxy_pass_request_headers on | off; </span><br><span class="line"><span class="comment">#是否将客户端的请求头部转发给后端服务器，可以设置在http,server或location块，默认即为开启</span></span><br><span class="line"></span><br><span class="line">proxy_set_header; </span><br><span class="line"><span class="comment">#可更改或添加客户端的请求头部信息内容并转发至后端服务器，比如在后端服务器想要获取客户端的真实IP的时候，就要更改每一个报文的头部</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#示例: </span></span><br><span class="line"><span class="comment">#proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;</span></span><br><span class="line"><span class="variable">$proxy_add_x_forwarded_for</span></span><br><span class="line">the “X-Forwarded-For” client request header field with the <span class="variable">$remote_addr</span> variable appended to it, separated by a comma. If the “X-Forwarded-For” field is not present <span class="keyword">in</span> the client request header, the <span class="variable">$proxy_add_x_forwarded_for</span> variable is equal to the <span class="variable">$remote_addr</span> variable.</span><br><span class="line"></span><br><span class="line">proxy_set_header X-Real-IP  <span class="variable">$remote_addr</span>;  </span><br><span class="line"><span class="comment">#添加HOST到报文头部，如果客户端为NAT上网那么其值为客户端的共用的公网IP地址，常用于在日之中记录客户端的真实IP地址。</span></span><br><span class="line"><span class="comment">#在后端httpd服务器修改配置,添加日志记录X-Forwarded-For字段</span></span><br><span class="line"> LogFormat <span class="string">&quot;%h %l %u %t \&quot;%r\&quot; %&gt;s %b \&quot;%&#123;Referer&#125;i\&quot; \&quot;%&#123;User-Agent&#125;i\&quot; \&quot;%&#123;X-Real-IP&#125;i\&quot;&quot;</span> combined</span><br><span class="line"> </span><br><span class="line"><span class="comment">#在后端服务器查看日志</span></span><br><span class="line">[root@centos8 ~]<span class="comment">#tail /var/log/httpd/access_log   -f</span></span><br><span class="line">10.0.0.8 - - [09/Oct/2020:21:50:57 +0800] <span class="string">&quot;HEAD /static/index.html HTTP/1.0&quot;</span> 200 - <span class="string">&quot;-&quot;</span> <span class="string">&quot;curl/7.29.0&quot;</span> <span class="string">&quot;10.0.0.7&quot;</span></span><br><span class="line"></span><br><span class="line">proxy_connect_timeout time;</span><br><span class="line"><span class="comment">#配置nginx服务器与后端服务器尝试建立连接的超时时间，默认为60秒，用法如下：</span></span><br><span class="line">proxy_connect_timeout 6s; </span><br><span class="line"><span class="comment">#60s为自定义nginx与后端服务器建立连接的超时时间,超时会返回客户端504响应码</span></span><br><span class="line"></span><br><span class="line">proxy_read_timeout time;</span><br><span class="line"><span class="comment">#配置nginx服务器向后端服务器或服务器组发起read请求后，等待的超时时间，默认60s</span></span><br><span class="line"></span><br><span class="line">proxy_send_timeout time; </span><br><span class="line"><span class="comment">#配置nginx项后端服务器或服务器组发起write请求后，等待的超时 时间，默认60s</span></span><br><span class="line"></span><br><span class="line">proxy_http_version 1.0; </span><br><span class="line"><span class="comment">#用于设置nginx提供代理服务的HTTP协议的版本，默认http 1.0,建议修改1.1支持长连接</span></span><br><span class="line"><span class="comment">#注意:需要配合实现proxy_set_header Connection &quot;&quot; 实现长连接</span></span><br><span class="line"></span><br><span class="line">proxy_ignore_client_abort off; </span><br><span class="line"><span class="comment">#当客户端网络中断请求时，nginx服务器中断其对后端服务器的请求。即如果此项设置为on开启，则服务器会忽略客户端中断并一直等着代理服务执行返回，如果设置为off，则客户端中断后Nginx也会中断客户端请求并立即记录499日志，默认为off。</span></span><br><span class="line"></span><br><span class="line">proxy_headers_hash_bucket_size 128;</span><br><span class="line"><span class="comment">#当配置了 proxy_hide_header和proxy_set_header的时候，用于设置nginx保存HTTP报文头的hash表的上限</span></span><br><span class="line"></span><br><span class="line">proxy_headers_hash_max_size 512; </span><br><span class="line"><span class="comment">#设置proxy_headers_hash_bucket_size的最大可用空间</span></span><br><span class="line"></span><br><span class="line">server_namse_hash_bucket_size 512; </span><br><span class="line"><span class="comment">#server_name hash表申请空间大小</span></span><br><span class="line"></span><br><span class="line">server_names_hash_max_size  512; </span><br><span class="line"><span class="comment">#设置服务器名称hash表的上限大小</span></span><br><span class="line">proxy_next_upstream error | <span class="built_in">timeout</span> | invalid_header | http_500 | http_502 | http_503 | http_504;</span><br><span class="line"><span class="comment">#当一台后端朋务器出错,超时,无效首部,500等时,切换至下一个后端服务器提供服务</span></span><br></pre></td></tr></table></figure>

<h4 id="实战案例-反向代理单台-web-服务器"><a href="#实战案例-反向代理单台-web-服务器" class="headerlink" title="实战案例: 反向代理单台 web 服务器"></a>实战案例: 反向代理单台 web 服务器</h4><p>要求：将用户对域 <a target="_blank" rel="noopener" href="http://www.wang.org/">www.wang.org</a> 的请求转发给后端服务器处理</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ~]<span class="comment"># cat /apps/nginx/conf/conf.d/pc.conf</span></span><br><span class="line">server &#123;</span><br><span class="line"> listen 80;</span><br><span class="line"> server_name www.wang.org;</span><br><span class="line"> location / &#123;</span><br><span class="line">     proxy_pass http://10.0.0.18/; <span class="comment"># http://10.0.0.18/ 最后的 / 可加或不加</span></span><br><span class="line">     proxy_set_header Host  <span class="variable">$http_host</span>; <span class="comment">#转发主机头至后端服务器</span></span><br><span class="line">     proxy_connect_timeout 10s;</span><br><span class="line"> &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">#重启Nginx 并访问测试</span></span><br></pre></td></tr></table></figure>

<p><img src="../../../../images/SRE/day28/115.jpg" alt="115"></p>
<p>如果后端服务器无法连接((比如:iptables -AINPUT -s nginx_ip -j REJECT或者systemctl stop httpd)，关机（无后端服务器arp缓存）), 会出现下面提示</p>
<p><img src="../../../../images/SRE/day28/116.jpg" alt="116"></p>
<p>默认在1分钟内后端服务器无法响应(比如:iptables -AINPUT -s nginx_ip -j DROP或关机（有后端服务器arp缓存）),会显示下面的504超时提示</p>
<p><img src="../../../../images/SRE/day28/117.jpg" alt="117"></p>
<h4 id="实战案例-指定-location-实现反向代理"><a href="#实战案例-指定-location-实现反向代理" class="headerlink" title="实战案例: 指定 location 实现反向代理"></a>实战案例: 指定 location 实现反向代理</h4><h5 id="针对指定的-location"><a href="#针对指定的-location" class="headerlink" title="针对指定的 location"></a>针对指定的 location</h5><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line"> listen 80;</span><br><span class="line"> server_name www.wang.org;</span><br><span class="line"> location / &#123;</span><br><span class="line">   index index.html index.php;</span><br><span class="line">   root /data/nginx/html/pc;</span><br><span class="line">   &#125;</span><br><span class="line">   </span><br><span class="line"> location /static &#123;</span><br><span class="line">   <span class="comment">#proxy_pass http://10.0.0.18:80/; #注意有后面的/， 表示置换</span></span><br><span class="line">   proxy_pass http://10.0.0.18:80;  <span class="comment">#后面没有 / , 表示附加</span></span><br><span class="line"> &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">#后端web服务器必须要有相对于的访问URL</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># mkdir /var/www/html/static</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># echo &quot;web1 page for apache&quot; &gt; /var/www/html/index.html</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># echo &quot;web2 page for apache&quot; &gt; /var/www/html/static/index.html</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#重启Nginx并访问测试：</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># curl -L http://www.wang.org/</span></span><br><span class="line">pc web</span><br><span class="line">[root@centos8 ~]<span class="comment"># curl -L http://www.wang.org/static</span></span><br><span class="line">web2 page <span class="keyword">for</span> apache</span><br><span class="line"></span><br><span class="line"><span class="comment">#Apache的访问日志：</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># tail -f /var/log/httpd/access_log </span></span><br><span class="line">10.0.0.8 - - [04/Mar/2019:18:52:00 +0800] <span class="string">&quot;GET /static/ HTTP/1.1&quot;</span> 200 21 <span class="string">&quot;-&quot;</span> <span class="string">&quot;curl/7.29.0&quot;</span></span><br></pre></td></tr></table></figure>

<h5 id="针对特定的资源实现代理"><a href="#针对特定的资源实现代理" class="headerlink" title="针对特定的资源实现代理"></a>针对特定的资源实现代理</h5><p><img src="../../../../images/SRE/day28/118.jpg" alt="118"></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ~]<span class="comment">#vim /apps/nginx/conf/conf.d/pc.conf</span></span><br><span class="line">server &#123;</span><br><span class="line">......</span><br><span class="line"> location ~ \.(jpe?g|png|bmp|gif)$ &#123;</span><br><span class="line">   proxy_pass http://10.0.0.18;     <span class="comment">#如果加/ 语法出错                             </span></span><br><span class="line">                                         </span><br><span class="line"> &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">#如果 http://10.0.0.18/ 有 / 语法出错    </span></span><br><span class="line">[root@centos8 ~]<span class="comment">#nginx -t</span></span><br><span class="line">nginx: [emerg] <span class="string">&quot;proxy_pass&quot;</span> cannot have URI part <span class="keyword">in</span> location given by regular expression, or inside named location, or inside <span class="string">&quot;if&quot;</span> statement, or inside  <span class="string">&quot;limit_except&quot;</span> block <span class="keyword">in</span> /apps/nginx/conf/conf.d/pc.conf:19 nginx: configuration file /apps/nginx/conf/nginx.conf <span class="built_in">test</span> failed</span><br></pre></td></tr></table></figure>

<p><img src="../../../../images/SRE/day28/119.jpg" alt="119"></p>
<h4 id="反向代理示例-缓存功能"><a href="#反向代理示例-缓存功能" class="headerlink" title="反向代理示例: 缓存功能"></a>反向代理示例: 缓存功能</h4><p>缓存功能默认关闭状态,需要先动配置才能启用</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">proxy_cache zone_name | off; 默认off</span><br><span class="line"><span class="comment">#指明调用的缓存，或关闭缓存机制;Context:http, server, location</span></span><br><span class="line"><span class="comment">#zone_name 表示缓存的名称.需要由proxy_cache_path事先定义</span></span><br><span class="line"></span><br><span class="line">proxy_cache_key string;</span><br><span class="line"><span class="comment">#缓存中用于“键”的内容，默认值：proxy_cache_key $scheme$proxy_host$request_uri;</span></span><br><span class="line"></span><br><span class="line">proxy_cache_valid [code ...] time;</span><br><span class="line"><span class="comment">#定义对特定响应码的响应内容的缓存时长，定义在http&#123;...&#125;中</span></span><br><span class="line">   示例:</span><br><span class="line">   proxy_cache_valid 200 302 10m;</span><br><span class="line">   proxy_cache_valid 404 1m;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">proxy_cache_path;</span><br><span class="line"><span class="comment">#定义可用于proxy功能的缓存;Context:http </span></span><br><span class="line">proxy_cache_path path [levels=levels] [use_temp_path=on|off] </span><br><span class="line">keys_zone=zone_name:size [inactive=time] [max_size=size] [manager_files=number] </span><br><span class="line">[manager_sleep=time] [manager_threshold=time] [loader_files=number] </span><br><span class="line">[loader_sleep=time] [loader_threshold=time] [purger=on|off] </span><br><span class="line">[purger_files=number] [purger_sleep=time] [purger_threshold=time];</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#示例：在http配置定义缓存信息</span></span><br><span class="line">proxy_cache_path /var/cache/nginx/proxy_cache <span class="comment">#定义缓存保存路径，proxy_cache会自动创建</span></span><br><span class="line">   levels=1:2:2 <span class="comment">#定义缓存目录结构层次，1:2:2可以生成2^4x2^8x2^8=2^20=1048576个目录</span></span><br><span class="line">   keys_zone=proxycache:20m <span class="comment">#指内存中缓存的大小，主要用于存放key和metadata（如：使用次数）,一般1M可存放8000个左右的key</span></span><br><span class="line">   inactive=120s  <span class="comment">#缓存有效时间  </span></span><br><span class="line">   max_size=10g; <span class="comment">#最大磁盘占用空间，磁盘存入文件内容的缓存空间最大值</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#调用缓存功能，需要定义在相应的配置段，如server&#123;...&#125;;或者location等</span></span><br><span class="line">proxy_cache proxycache;</span><br><span class="line">proxy_cache_key <span class="variable">$request_uri</span>; <span class="comment">#对指定的数据进行MD5的运算做为缓存的key</span></span><br><span class="line">proxy_cache_valid 200 302 301 10m; <span class="comment">#指定的状态码返回的数据缓存多长时间</span></span><br><span class="line">proxy_cache_valid any 1m;   <span class="comment">#除指定的状态码返回的数据以外的缓存多长时间,必须设置,否则不会缓存</span></span><br><span class="line"></span><br><span class="line">proxy_cache_use_stale error | <span class="built_in">timeout</span> | invalid_header | updating | http_500 | http_502 | http_503 | http_504 | http_403 | http_404 | off ; <span class="comment">#默认是off</span></span><br><span class="line"><span class="comment">#在被代理的后端服务器出现哪种情况下，可直接使用过期的缓存响应客户端</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#示例</span></span><br><span class="line">proxy_cache_use_stale error http_502 http_503;</span><br><span class="line"></span><br><span class="line">proxy_cache_methods GET | HEAD | POST ...;</span><br><span class="line"><span class="comment">#对哪些客户端请求方法对应的响应进行缓存，GET和HEAD方法总是被缓存</span></span><br></pre></td></tr></table></figure>

<p><strong>扩展知识: 清理缓存</strong></p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">方法1: rm -rf 缓存目录</span><br><span class="line">方法2: 第三方扩展模块ngx_cache_purge </span><br></pre></td></tr></table></figure>

<h5 id="非缓存场景压测"><a href="#非缓存场景压测" class="headerlink" title="非缓存场景压测"></a>非缓存场景压测</h5><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#准备后端httpd服务器</span></span><br><span class="line">[root@centos8 app1]<span class="comment"># pwd</span></span><br><span class="line">/var/www/html/static</span><br><span class="line">[root@centos8 static]<span class="comment"># cat /var/log/messages &gt; ./log.html #准备测试页面</span></span><br><span class="line"></span><br><span class="line">[root@centos8 ~]<span class="comment"># ab -n 2000 -c200 http://www.wang.org/static/log.html</span></span><br><span class="line">Concurrency Level:      200</span><br><span class="line">Time taken <span class="keyword">for</span> tests:   15.363 seconds</span><br><span class="line">Complete requests:      2000</span><br><span class="line">Failed requests:        0</span><br><span class="line">Write errors:           0</span><br><span class="line">Total transferred:      1486898000 bytes</span><br><span class="line">HTML transferred:       1486316000 bytes</span><br><span class="line">Requests per second:    130.18 [<span class="comment">#/sec] (mean)</span></span><br><span class="line">Time per request:       1536.342 [ms] (mean)</span><br><span class="line">Time per request:       7.682 [ms] (mean, across all concurrent requests)</span><br><span class="line">Transfer rate:          94513.36 [Kbytes/sec] received</span><br></pre></td></tr></table></figure>

<h5 id="准备缓存配置"><a href="#准备缓存配置" class="headerlink" title="准备缓存配置"></a>准备缓存配置</h5><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ~]<span class="comment"># vim /apps/nginx/conf/nginx.conf</span></span><br><span class="line">proxy_cache_path /data/nginx/proxycache   levels=1:1:1  keys_zone=proxycache:20m inactive=120s  max_size=1g; <span class="comment">#配置在nginx.conf http配置段</span></span><br><span class="line"></span><br><span class="line">[root@centos8 ~]<span class="comment"># vim /apps/nginx/conf/conf.d/pc.conf</span></span><br><span class="line">location /static &#123;  <span class="comment">#要缓存的URL 或者放在server配置项对所有URL都进行缓存</span></span><br><span class="line">   proxy_pass http://10.0.0.18:80;</span><br><span class="line">   proxy_cache proxycache;</span><br><span class="line">   proxy_cache_key <span class="variable">$request_uri</span>;</span><br><span class="line">    <span class="comment">#proxy_cache_key $host$uri$is_args$args;</span></span><br><span class="line">   proxy_cache_valid 200 302 301 10m;</span><br><span class="line">   proxy_cache_valid any 5m;  <span class="comment">#必须指定哪些响应码的缓存</span></span><br><span class="line">   proxy_set_header Host  <span class="variable">$http_host</span>; <span class="comment">#转发主机头至后端服务器</span></span><br><span class="line">    <span class="comment">#proxy_set_header clientip $remote_addr;</span></span><br><span class="line"> &#125;</span><br><span class="line"> </span><br><span class="line">[root@centos8 ~]<span class="comment"># systemctl restart nginx</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#/data/nginx/proxycache/ 目录会自动生成</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># ll /data/nginx/proxycache/ -d</span></span><br><span class="line">drwx------ 2 nginx root 6 Oct 10 11:30 /data/nginx/proxycache/</span><br><span class="line"></span><br><span class="line">[root@centos8 ~]<span class="comment"># tree /data/nginx/proxycache/</span></span><br><span class="line">/data/nginx/proxycache/</span><br><span class="line"></span><br><span class="line">0 directories, 0 files</span><br></pre></td></tr></table></figure>

<h5 id="访问并验证缓存文件"><a href="#访问并验证缓存文件" class="headerlink" title="访问并验证缓存文件"></a>访问并验证缓存文件</h5><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#访问web并验证缓存目录</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># curl http://www.wang.org/static/log.html</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># ab -n 2000 -c200 http://www.wang.org/static/log.html    </span></span><br><span class="line">Concurrency Level:      200</span><br><span class="line">Time taken <span class="keyword">for</span> tests:   8.165 seconds</span><br><span class="line">Complete requests:      2000</span><br><span class="line">Failed requests:        0</span><br><span class="line">Write errors:           0</span><br><span class="line">Total transferred:      1486898000 bytes</span><br><span class="line">HTML transferred:       1486316000 bytes</span><br><span class="line">Requests per second:    244.96 [<span class="comment">#/sec] (mean) #性能提高近一倍</span></span><br><span class="line">Time per request:       816.476 [ms] (mean)</span><br><span class="line">Time per request:       4.082 [ms] (mean, across all concurrent requests)</span><br><span class="line">Transfer rate:          177843.44 [Kbytes/sec] received</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#验证缓存目录结构及文件大小   </span></span><br><span class="line">[root@centos8 ~]<span class="comment"># tree /data/nginx/proxycache/</span></span><br><span class="line">/data/nginx/proxycache/</span><br><span class="line">└── d</span><br><span class="line">   └── b</span><br><span class="line">       └── e</span><br><span class="line">           └── a971fce2cfaae636d54b5121d7a74ebd</span><br><span class="line">           </span><br><span class="line">3 directories, 1 file</span><br><span class="line"></span><br><span class="line">[root@centos8 ~]<span class="comment"># ll -h   </span></span><br><span class="line">/data/nginx/proxycache/d/b/e/a971fce2cfaae636d54b5121d7a74ebd</span><br><span class="line">-rw------- 1 nginx nginx 727K Oct 10 11:33 /data/nginx/proxycache/d/b/e/a971fce2cfaae636d54b5121d7a74ebd</span><br><span class="line"></span><br><span class="line"><span class="comment">#验证文件内容：</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># file </span></span><br><span class="line">/data/nginx/proxycache/d/b/e/a971fce2cfaae636d54b5121d7a74ebd </span><br><span class="line">/data/nginx/proxycache/d/b/e/a971fce2cfaae636d54b5121d7a74ebd: Hitachi SH big-endian COFF object file, not stripped, 0 section, symbol offset=0x813a815f</span><br><span class="line"></span><br><span class="line">[root@centos8 ~]<span class="comment"># head -n20 </span></span><br><span class="line">/data/nginx/proxycache/d/b/e/a971fce2cfaae636d54b5121d7a74ebd</span><br><span class="line"></span><br><span class="line"><span class="comment">#会在文件首部添加相应码</span></span><br><span class="line">:_</span><br><span class="line"> )_q,_棁gs<span class="string">&quot;b56f6-5b14894970c60&quot;</span></span><br><span class="line">KEY: /static/log.html</span><br><span class="line">HTTP/1.1 200 OK</span><br><span class="line">Date: Sat, 10 Oct 2020 03:37:21 GMT</span><br><span class="line">Server: Apache/2.4.37 (centos)</span><br><span class="line">Last-Modified: Sat, 10 Oct 2020 03:22:52 GMT</span><br><span class="line">ETag: <span class="string">&quot;b56f6-5b14894970c60&quot;</span></span><br><span class="line">Accept-Ranges: bytes</span><br><span class="line">Content-Length: 743158</span><br><span class="line">Connection: close</span><br><span class="line">Content-Type: text/html; charset=UTF-8</span><br><span class="line"></span><br><span class="line">Jun 16 06:29:40 10 kernel: Linux version 4.18.0-193.el8.x86_64 (mockbuild@kbuilder.bsys.centos.org) (gcc version 8.3.1 20191121 (Red Hat 8.3.1-5) (GCC)) <span class="comment">#1 SMP Fri May 8 10:59:10 UTC 2020</span></span><br><span class="line">Jun 16 06:29:40 10 kernel: Command line: BOOT_IMAGE=(hd0,msdos1)/vmlinuz-4.18.0-193.el8.x86_64 root=UUID=acf9bd1f-caae-4e28-87be-e53afec61347 ro resume=UUID=409e36d2-ac5e-423f-ad78-9b12db4576bd rhgb quiet</span><br><span class="line">Jun 16 06:29:40 10 kernel: Disabled fast string operations</span><br><span class="line">Jun 16 06:29:40 10 kernel: x86/fpu: Supporting XSAVE feature 0x001: <span class="string">&#x27;x87 floating point registers&#x27;</span></span><br><span class="line">Jun 16 06:29:40 10 kernel: x86/fpu: Supporting XSAVE feature 0x002: <span class="string">&#x27;SSE registers&#x27;</span></span><br><span class="line">Jun 16 06:29:40 10 kernel: x86/fpu: Supporting XSAVE feature 0x004: <span class="string">&#x27;AVX registers&#x27;</span></span><br><span class="line">Jun 16 06:29:40 10 kernel: x86/fpu: xstate_offset[2]:  576, xstate_sizes[2]: 256</span><br><span class="line">Jun 16 06:29:40 10 kernel: x86/fpu: Enabled xstate features 0x7, context size is 832 bytes, using <span class="string">&#x27;standard&#x27;</span> format.</span><br></pre></td></tr></table></figure>

<h4 id="添加响应报文的头部信息"><a href="#添加响应报文的头部信息" class="headerlink" title="添加响应报文的头部信息"></a>添加响应报文的头部信息</h4><p>nginx基于模块ngx_http_headers_module可以实现对后端服务器响应给客户端的报文中添加指定的响应首部字段</p>
<p>参考链接: <a target="_blank" rel="noopener" href="https://nginx.org/en/docs/http/ngx_http_headers_module.html">https://nginx.org/en/docs/http/ngx_http_headers_module.html</a></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">Syntax: add_header name value [always];</span><br><span class="line">Default: —</span><br><span class="line">Context: http, server, location, <span class="keyword">if</span> <span class="keyword">in</span> location</span><br><span class="line"></span><br><span class="line"><span class="comment">#添加响应报文的自定义首部：</span></span><br><span class="line">add_header name value [always]; </span><br><span class="line"></span><br><span class="line"><span class="comment">#示例:</span></span><br><span class="line">add_header X-Via   <span class="variable">$server_addr</span>; <span class="comment">#当前nginx主机的IP</span></span><br><span class="line">add_header X-Cache <span class="variable">$upstream_cache_status</span>; <span class="comment">#缓存命中HIT，未命中MISS</span></span><br><span class="line">add_header X-Accel <span class="variable">$server_name</span>; <span class="comment">#客户访问的FQDN</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#添加自定义响应信息的尾部，使用较少,1.13.2版后支持 </span></span><br><span class="line">add_trailer name value [always];</span><br></pre></td></tr></table></figure>

<h5 id="Nginx-配置"><a href="#Nginx-配置" class="headerlink" title="Nginx 配置"></a>Nginx 配置</h5><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">location /static &#123;</span><br><span class="line">   proxy_pass http://10.0.0.101:80/;</span><br><span class="line">   proxy_cache proxycache;</span><br><span class="line">   proxy_cache_key <span class="variable">$request_uri</span>;</span><br><span class="line">   proxy_cache_valid 200 302 301 1h;</span><br><span class="line">   proxy_cache_valid any 1m;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">#proxy_set_header clientip $remote_addr;</span></span><br><span class="line">   add_header X-Via  <span class="variable">$server_addr</span>;</span><br><span class="line">   add_header X-Cache <span class="variable">$upstream_cache_status</span>;</span><br><span class="line">   add_header X-Accel <span class="variable">$server_name</span>;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>

<h5 id="验证头部信息"><a href="#验证头部信息" class="headerlink" title="验证头部信息"></a>验证头部信息</h5><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">[root@centos7 ~]<span class="comment"># curl http://www.wang.org/static/log.html -I</span></span><br><span class="line">HTTP/1.1 200 OK</span><br><span class="line">Date: Sat, 10 Oct 2020 03:42:31 GMT</span><br><span class="line">Content-Type: text/html; charset=UTF-8</span><br><span class="line">Content-Length: 743158</span><br><span class="line">Connection: keep-alive</span><br><span class="line">Vary: Accept-Encoding</span><br><span class="line">Server: Apache/2.4.37 (centos)</span><br><span class="line">Last-Modified: Sat, 10 Oct 2020 03:22:52 GMT</span><br><span class="line">ETag: <span class="string">&quot;b56f6-5b14894970c60&quot;</span></span><br><span class="line">X-Via: 10.0.0.8</span><br><span class="line">X-Cache: MISS <span class="comment">#第一次无缓存 </span></span><br><span class="line">X-Accel: www.wang.org</span><br><span class="line">Accept-Ranges: bytes</span><br><span class="line"></span><br><span class="line">[root@centos7 ~]<span class="comment"># curl http://www.wang.org/static/log.html -I</span></span><br><span class="line">HTTP/1.1 200 OK</span><br><span class="line">Date: Sat, 10 Oct 2020 03:42:38 GMT</span><br><span class="line">Content-Type: text/html; charset=UTF-8</span><br><span class="line">Content-Length: 743158</span><br><span class="line">Connection: keep-alive</span><br><span class="line">Vary: Accept-Encoding</span><br><span class="line">Server: Apache/2.4.37 (centos)</span><br><span class="line">Last-Modified: Sat, 10 Oct 2020 03:22:52 GMT</span><br><span class="line">ETag: <span class="string">&quot;b56f6-5b14894970c60&quot;</span></span><br><span class="line">X-Via: 10.0.0.8</span><br><span class="line">X-Cache: HIT                 <span class="comment">#第二次命令缓存</span></span><br><span class="line">X-Accel: www.wang.org</span><br><span class="line">Accept-Ranges: bytes</span><br></pre></td></tr></table></figure>

<h4 id="实现反向代理客户端-IP-透传"><a href="#实现反向代理客户端-IP-透传" class="headerlink" title="实现反向代理客户端 IP 透传"></a>实现反向代理客户端 IP 透传</h4><h5 id="一级代理实现客户端IP透传"><a href="#一级代理实现客户端IP透传" class="headerlink" title="一级代理实现客户端IP透传"></a>一级代理实现客户端IP透传</h5><p><img src="../../../../images/SRE/day28/120.jpg" alt="120"></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ~]<span class="comment"># cat /apps/nginx/conf/conf.d/pc.conf</span></span><br><span class="line">server &#123;</span><br><span class="line"> listen 80;</span><br><span class="line"> server_name www.wang.org;</span><br><span class="line"> location / &#123;</span><br><span class="line">   index index.html index.php;</span><br><span class="line">   root /data/nginx/html/pc;</span><br><span class="line">   proxy_pass http://10.0.0.18;</span><br><span class="line">    <span class="comment">#proxy_set_header X-Real-IP $remote_addr;           #只添加客户端IP到请求报文头部,转发至后端服务器</span></span><br><span class="line">   proxy_set_header X-Forwarded-For <span class="variable">$proxy_add_x_forwarded_for</span>; <span class="comment">#添加客户端IP和反向代理服务器IP到请求报文头部</span></span><br><span class="line"> &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">#说明$proxy_add_x_forwarded_for</span></span><br><span class="line"><span class="comment">#此变量表示将客户端IP追加请求报文中X-Forwarded-For首部字段,多个IP之间用逗号分隔,如果请求中没有X-Forwarded-For,就使用$remote_addr</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#重启nginx</span></span><br><span class="line">[root@centos8 ~]<span class="comment">#systemctl restart nginx</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#后端Apache配置：</span></span><br><span class="line">[root@centos8 ~]<span class="comment">#vim /etc/httpd/conf/httpd.conf</span></span><br><span class="line"> LogFormat <span class="string">&quot;%&#123;X-Forwarded-For&#125;i %h %l %u %t \&quot;%r\&quot; %&gt;s %b \&quot;%&#123;Referer&#125;i\&quot; \&quot;%&#123;User-Agent&#125;i\&quot;&quot;</span> combined</span><br><span class="line"></span><br><span class="line"><span class="comment">#重启apache访问web界面并验证apache日志</span></span><br><span class="line"> [root@centos8 ~]<span class="comment">#cat /var/log/httpd/access_log</span></span><br><span class="line">10.0.0.1 10.0.0.8 - - [05/Mar/2019:00:40:46 +0800] <span class="string">&quot;GET / HTTP/1.0&quot;</span> 200 19 <span class="string">&quot;-&quot;</span><span class="string">&quot;Mozilla/5.0 (Windows NT 6.1; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/72.0.3626.119 Safari/537.36&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#Nginx配置：</span></span><br><span class="line">[root@centos8 conf.d]<span class="comment"># cat /apps/nginx/conf/nginx.conf</span></span><br><span class="line"><span class="string">&quot;<span class="variable">$http_x_forwarded_for</span>&quot;</span><span class="string">&#x27; #默认日志格式就有此配置</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">#重启nginx访问web界面并验证日志格式：</span></span><br><span class="line"><span class="string">10.0.0.8 - - [04/Mar/2019:16:40:51 +0800] &quot;GET / HTTP/1.0&quot; 200 24 &quot;-&quot; &quot;Mozilla/5.0 (Windows NT 6.1; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/72.0.3626.119 Safari/537.36&quot; &quot;10.0.0.1&quot;</span></span><br></pre></td></tr></table></figure>

<h5 id="多级代理实现客户端-IP-透传"><a href="#多级代理实现客户端-IP-透传" class="headerlink" title="多级代理实现客户端 IP 透传"></a>多级代理实现客户端 IP 透传</h5><p>范例: 多级代理实现IP透传</p>
<p><img src="../../../../images/SRE/day28/121.jpg" alt="121"></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#第一个代理服务器</span></span><br><span class="line">[root@nginx1 ~]<span class="comment"># vim /apps/nginx/conf/nginx.conf </span></span><br><span class="line"><span class="comment">#开启日志格式,记录x_forwarded_for</span></span><br><span class="line">http &#123;</span><br><span class="line">   include       mime.types;</span><br><span class="line">   default_type application/octet-stream;</span><br><span class="line">   proxy_cache_path /data/nginx/proxycache   levels=1:1:1 keys_zone=proxycache:20m inactive=120s  max_size=1g;</span><br><span class="line">   log_format main  <span class="string">&#x27;$remote_addr - $remote_user [$time_local] &quot;$request&quot; &#x27;</span></span><br><span class="line">                    <span class="string">&#x27;$status $body_bytes_sent &quot;$http_referer&quot; &#x27;</span></span><br><span class="line">                    <span class="string">&#x27;&quot;$http_user_agent&quot; &quot;$http_x_forwarded_for&quot;&#x27;</span>;</span><br><span class="line">   access_log logs/access.log main;</span><br><span class="line"></span><br><span class="line"><span class="comment">#定义反向代理</span></span><br><span class="line">[root@nginx1 ~]<span class="comment">#vim /apps/nginx/conf/conf.d/pc.conf </span></span><br><span class="line">server &#123;</span><br><span class="line">   location / &#123;</span><br><span class="line">     proxy_pass http://10.0.0.18;</span><br><span class="line">     proxy_set_header X-Forwarded-For <span class="variable">$proxy_add_x_forwarded_for</span>;               </span><br><span class="line">            &#125;</span><br><span class="line">   .......   </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">#第二个代理服务器</span></span><br><span class="line">[root@nginx2 ~]<span class="comment">#vim /apps/nginx/conf/nginx.conf </span></span><br><span class="line"><span class="comment">#开启日志格式,记录x_forwarded_for</span></span><br><span class="line">http &#123;</span><br><span class="line">   include       mime.types;</span><br><span class="line">   default_type application/octet-stream;</span><br><span class="line">   proxy_cache_path /data/nginx/proxycache   levels=1:1:1 keys_zone=proxycache:20m inactive=120s  max_size=1g;</span><br><span class="line">   log_format main  <span class="string">&#x27;$remote_addr - $remote_user [$time_local] &quot;$request&quot; &#x27;</span></span><br><span class="line">                      <span class="string">&#x27;$status $body_bytes_sent &quot;$http_referer&quot; &#x27;</span></span><br><span class="line">                     <span class="string">&#x27;&quot;$http_user_agent&quot; &quot;$http_x_forwarded_for&quot;&#x27;</span>;</span><br><span class="line">   access_log logs/access.log main;</span><br><span class="line"></span><br><span class="line"><span class="comment">#定义反向代理</span></span><br><span class="line">[root@nginx2 ~]<span class="comment">#vim /etc/nginx/nginx.conf</span></span><br><span class="line"> server &#123;</span><br><span class="line">       location / &#123;</span><br><span class="line">         proxy_pass http://10.0.0.28;</span><br><span class="line">         proxy_set_header X-Forwarded-For <span class="variable">$proxy_add_x_forwarded_for</span>;           </span><br><span class="line">                            </span><br><span class="line">       &#125;</span><br><span class="line">       .....</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">#在第一个proxy上面查看日志</span></span><br><span class="line">[root@nginx1 ~]<span class="comment"># tail /apps/nginx/logs/access.log -f</span></span><br><span class="line">10.0.0.7 - - [11/Oct/2020:14:37:00 +0800] <span class="string">&quot;GET /index.html HTTP/1.1&quot;</span> 200 11 <span class="string">&quot;-&quot;</span> <span class="string">&quot;curl/7.58.0&quot;</span> <span class="string">&quot;-&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#在第二个proxy上面查看日志</span></span><br><span class="line">[root@nginx2 ~]<span class="comment"># tail /apps/nginx/logs/access.log -f</span></span><br><span class="line">10.0.0.8 - - [11/Oct/2020:14:37:00 +0800] <span class="string">&quot;GET /index.html HTTP/1.0&quot;</span> 200 11 <span class="string">&quot;-&quot;</span> <span class="string">&quot;curl/7.58.0&quot;</span> <span class="string">&quot;10.0.0.7&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#后端服务器配置日志格式</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># vim /etc/httpd/conf/httpd.conf</span></span><br><span class="line">LogFormat <span class="string">&quot;\&quot;%&#123;x-Forwarded-For&#125;i\&quot; %h %l %u %t \&quot;%r\&quot; %&gt;s %b \&quot;%&#123;Referer&#125;i\&quot; \&quot;% &#123;User-Agent&#125;i\&quot;&quot;</span> testlog</span><br><span class="line">CustomLog <span class="string">&quot;logs/access_log&quot;</span> testlog</span><br><span class="line"></span><br><span class="line"><span class="comment">#测试访问</span></span><br><span class="line">[root@centos7 ~]<span class="comment"># curl www.wang.org/index.html</span></span><br><span class="line">&lt;h1&gt; web site on 10.0.0.28 &lt;/h1&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment">#后端服务器查看日志</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># tail -f /var/log/httpd/access_log</span></span><br><span class="line"><span class="string">&quot;10.0.0.7, 10.0.0.8&quot;</span>  10.0.0.18 - - [11/Oct/2020:14:37:00 +0800] <span class="string">&quot;GET /index.html HTTP/1.0&quot;</span> 200 34 <span class="string">&quot;-&quot;</span> <span class="string">&quot;curl/7.29.0&quot;</span></span><br></pre></td></tr></table></figure>

<h4 id="利用Nginx解决跨域问题"><a href="#利用Nginx解决跨域问题" class="headerlink" title="利用Nginx解决跨域问题"></a>利用Nginx解决跨域问题</h4><h5 id="跨域问题说明"><a href="#跨域问题说明" class="headerlink" title="跨域问题说明"></a>跨域问题说明</h5><p><strong>什么是跨域</strong></p>
<p>当一个请求url的<strong>协议、域名、端口</strong>三者之间任意一个与当前页面url不同即为跨域。</p>
<p><img src="../../../../images/SRE/day28/122.jpg" alt="122"></p>
<p><img src="../../../../images/SRE/day28/123.jpg" alt="123"></p>
<p>通常由于同域安全策略（the same-origin security policy），浏览器会禁止跨域请求。</p>
<p><strong>值得注意的是：虽然因为跨域的原因会导致浏览器禁止访问而获取数据失败，但返回的状态码仍为200</strong></p>
<p>常见的解决方案有：CORS，JSONP，Nginx反向代理等</p>
<p>采用CORS（Cross-Origin Resource Sharing 跨域资源共享）技术，可以允许当前域的Web相关资源被其他域的脚本请求访问</p>
<p>CORS是一种基于HTTP头的机制，该机制允许使用AJAX发送跨域请求，只要HTTP响应头中包含了相应的CORS响应头。CORS需要浏览器和服务器同时支持，CORS机制在老版本的浏览器中不支持，现代浏览器都支持CORS。在使用CORS发送AJAX请求时浏览器端代码和过去一致，服务器端需要配置CORS的响应头。</p>
<p>参考链接</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://developer.mozilla.org/zh-CN/docs/Web/HTTP/CORS</span><br></pre></td></tr></table></figure>

<p><img src="../../../../images/SRE/day28/124.jpg" alt="124"><br><img src="../../../../images/SRE/day28/125.jpg" alt="125"></p>
<p><img src="../../../../images/SRE/day28/126.jpg" alt="126"><br><img src="../../../../images/SRE/day28/127.jpg" alt="127"><br><img src="../../../../images/SRE/day28/128.jpg" alt="128"></p>
<p><img src="../../../../images/SRE/day28/129.jpg" alt="129"></p>
<h5 id="使用-Nginx-反向代理功能解决跨域问题案例"><a href="#使用-Nginx-反向代理功能解决跨域问题案例" class="headerlink" title="使用 Nginx 反向代理功能解决跨域问题案例"></a>使用 Nginx 反向代理功能解决跨域问题案例</h5><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#在www.xiaochun.net主机执行程序提供JSON数据服务</span></span><br><span class="line">[root@ubuntu2004 ~]<span class="comment"># ./web_demo</span></span><br><span class="line">[GIN-debug] [WARNING] Creating an Engine instance with the Logger and Recovery middleware already attached.</span><br><span class="line"></span><br><span class="line">[GIN-debug] [WARNING] Running <span class="keyword">in</span> <span class="string">&quot;debug&quot;</span> mode. Switch to <span class="string">&quot;release&quot;</span> mode <span class="keyword">in</span> production.</span><br><span class="line">  - using <span class="built_in">env</span>: <span class="built_in">export</span> GIN_MODE=release</span><br><span class="line">  - using code: gin.SetMode(gin.ReleaseMode)</span><br><span class="line"></span><br><span class="line">[GIN-debug] GET   /hello                    --&gt; main.sayHello (3 handlers)</span><br><span class="line">[GIN-debug] [WARNING] You trusted all proxies, this is NOT safe. We recommend you to <span class="built_in">set</span> a value.</span><br><span class="line">Please check https://pkg.go.dev/github.com/gin-gonic/gin<span class="comment">#readme-don-t-trust-all-proxies for details.</span></span><br><span class="line">[GIN-debug] Environment variable PORT is undefined. Using port :8080 by default</span><br><span class="line">[GIN-debug] Listening and serving HTTP on :8080</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#在www.wang.org主机的创建页面文件，此文件存在跨域问题</span></span><br><span class="line">[root@ubuntu2004 ~]<span class="comment">#cat /usr/share/nginx/html/cors.html</span></span><br><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html lang=<span class="string">&quot;en&quot;</span>&gt;</span><br><span class="line">&lt;<span class="built_in">head</span>&gt;</span><br><span class="line">   &lt;meta charset=<span class="string">&quot;UTF-8&quot;</span>&gt;</span><br><span class="line">   &lt;title&gt;Cross-origin resource sharing&lt;/title&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">   &lt;script src=<span class="string">&quot;https://code.jquery.com/jquery-2.2.4.min.js&quot;</span>&gt;&lt;/script&gt;</span><br><span class="line">   &lt;script&gt;</span><br><span class="line">       $.ajax(&#123;</span><br><span class="line">       url:<span class="string">&#x27;http://www.xiaochun.net:8080/hello&#x27;</span>, <span class="comment">#指向第二个域名的资源</span></span><br><span class="line">       <span class="built_in">type</span>:<span class="string">&#x27;get&#x27;</span>,</span><br><span class="line">       data:&#123;&#125;,</span><br><span class="line">       success:<span class="keyword">function</span>(res)&#123;</span><br><span class="line">           //res = JSON.parse(res);</span><br><span class="line">           console.log(<span class="string">&#x27;请求成功&#x27;</span>,res)</span><br><span class="line">       &#125;,</span><br><span class="line">       error:<span class="keyword">function</span>(er)&#123;</span><br><span class="line">           console.log(<span class="string">&#x27;请求错误&#x27;</span>)</span><br><span class="line">       &#125;</span><br><span class="line">     &#125;)</span><br><span class="line">   &lt;/script&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment">#在www.wang.org主机的nginx反向代理解决跨域</span></span><br><span class="line">[root@ubuntu2004 ~]<span class="comment"># vim /etc/nginx/nginx.conf</span></span><br><span class="line">server &#123;</span><br><span class="line">   listen 80;</span><br><span class="line">   server_name www.wang.org;</span><br><span class="line">   root /usr/share/nginx/html;</span><br><span class="line"> location /hello &#123;</span><br><span class="line"> proxy_pass http://www.xiaochun.net:8080; <span class="comment">#指向第二个域</span></span><br><span class="line"> &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">#在www.wang.org主机上修改网页如下</span></span><br><span class="line">[root@ubuntu2004 ~]<span class="comment"># cat /usr/share/nginx/html/cors.html</span></span><br><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html lang=<span class="string">&quot;en&quot;</span>&gt;</span><br><span class="line">&lt;<span class="built_in">head</span>&gt;</span><br><span class="line">   &lt;meta charset=<span class="string">&quot;UTF-8&quot;</span>&gt;</span><br><span class="line">   &lt;title&gt;Cross-origin resource sharing&lt;/title&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">   &lt;script src=<span class="string">&quot;https://code.jquery.com/jquery-2.2.4.min.js&quot;</span>&gt;&lt;/script&gt;</span><br><span class="line">   &lt;script&gt;</span><br><span class="line">       $.ajax(&#123;</span><br><span class="line">       url:<span class="string">&#x27;http://www.wang.org/hello&#x27;</span>, <span class="comment">#只修改此行指向网页所在的同一个域名</span></span><br><span class="line">       <span class="built_in">type</span>:<span class="string">&#x27;get&#x27;</span>,</span><br><span class="line">       data:&#123;&#125;,</span><br><span class="line">       success:<span class="keyword">function</span>(res)&#123;</span><br><span class="line">           //res = JSON.parse(res);</span><br><span class="line">           console.log(<span class="string">&#x27;请求成功&#x27;</span>,res)</span><br><span class="line">       &#125;,</span><br><span class="line">       error:<span class="keyword">function</span>(er)&#123;</span><br><span class="line">           console.log(<span class="string">&#x27;请求错误&#x27;</span>)</span><br><span class="line">       &#125;</span><br><span class="line">     &#125;)</span><br><span class="line">   &lt;/script&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure>

<h3 id="Http-反向代理负载均衡"><a href="#Http-反向代理负载均衡" class="headerlink" title="Http 反向代理负载均衡"></a>Http 反向代理负载均衡</h3><p>在上一个节中Nginx可以将客户端的请求转发至单台后端服务器但是无法转发至特定的一组的服务器，而且不能对后端服务器提供相应的服务器状态监测</p>
<p>Nginx 可以基于ngx_http_upstream_module模块提供服务器分组转发、权重分配、状态监测、调度算法等高级功能</p>
<p>官方文档： <a target="_blank" rel="noopener" href="https://nginx.org/en/docs/http/ngx_http_upstream_module.html">https://nginx.org/en/docs/http/ngx_http_upstream_module.html</a></p>
<h4 id="http-upstream配置参数"><a href="#http-upstream配置参数" class="headerlink" title="http upstream配置参数"></a>http upstream配置参数</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#自定义一组服务器，配置在http块内</span></span><br><span class="line">upstream name &#123; </span><br><span class="line">  server .....</span><br><span class="line">  ......</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">#示例</span></span><br><span class="line">upstream backend &#123;</span><br><span class="line">   server backend1.example.com weight=5;</span><br><span class="line">   server 127.0.0.1:8080  max_fails=3 fail_timeout=30s;</span><br><span class="line">   server unix:/tmp/backend3;</span><br><span class="line">   </span><br><span class="line">   server backup1.example.com backup;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">server address [parameters];</span><br><span class="line"><span class="comment">#配置一个后端web服务器，配置在upstream内，至少要有一个server服务器配置</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#server支持的parameters如下：</span></span><br><span class="line">weight=number <span class="comment">#设置权重，默认为1,实现类似于LVS中的WRR,WLC等</span></span><br><span class="line">max_conns=number  <span class="comment">#给当前后端server设置最大活动链接数，默认为0表示没有限制</span></span><br><span class="line">max_fails=number  <span class="comment">#后端服务器的下线条件,当客户端访问时,对本次调度选中的后端服务器连续进行检测多少次,如果都失败就标记为不可用,默认为1次,当客户端访问时,才会利用TCP触发对探测后端服务器健康性检查,而非周期性的探测</span></span><br><span class="line">fail_timeout=time <span class="comment">#后端服务器的上线条件,对已经检测到处于不可用的后端服务器,每隔此时间间隔再次进行检测是否恢复可用，如果发现可用,则将后端服务器参与调度,默认为10秒</span></span><br><span class="line">backup  <span class="comment">#设置为备份服务器，当所有后端服务器不可用时,才会启用此备用服务器，和ip_hash指令冲突，不能同时使用</span></span><br><span class="line">down    <span class="comment">#标记为down状态,可以平滑下线后端服务器,新用户不再调度到此主机,正在访问的旧用户不受影响</span></span><br></pre></td></tr></table></figure>

<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">ip_hash;</span><br><span class="line"><span class="comment">#源地址hash调度方法，基于的客户端的remote_addr(源地址IPv4的前24位或整个IPv6地址)做hash计算，以实现会话保持,注意:如果是局域网可能会导致调度到同一台主机</span></span><br><span class="line"><span class="comment">#hash $remote_addr 则是对全部32bit的IPv4进行hash计算</span></span><br><span class="line"><span class="comment">#注意:和backup指令冲突，不能同时使用</span></span><br><span class="line"></span><br><span class="line">least_conn; </span><br><span class="line"><span class="comment">#最少连接调度算法，优先将客户端请求调度到当前连接最少的后端服务器,相当于LVS中的WLC</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">hash</span> KEY [consistent];</span><br><span class="line"><span class="comment">#基于指定请求报文中首部字段或者URI等key做hash计算，使用consistent参数，将使用ketama一致性hash算法，适用于后端是Cache服务器（如varnish）时使用，consistent定义使用一致性hash运算，一致性hash基于取模运算</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#示例</span></span><br><span class="line"><span class="built_in">hash</span> <span class="variable">$request_uri</span> consistent; <span class="comment">#基于用户请求的uri做hash,可以实现调度到后端缓存服务器功能</span></span><br><span class="line"><span class="built_in">hash</span> <span class="variable">$remote_addr</span> consistent; <span class="comment">#则是对全部32bit的IPv4进行一致性hash计算</span></span><br><span class="line"><span class="built_in">hash</span> <span class="variable">$cookie_sessionid</span>        <span class="comment">#基于cookie中的sessionid这个key进行hash调度,实现会话绑定</span></span><br></pre></td></tr></table></figure>

<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">Syntax: keepalive connections;</span><br><span class="line">Default: —</span><br><span class="line">Context: upstream</span><br><span class="line">This directive appeared <span class="keyword">in</span> version 1.1.4.</span><br><span class="line"></span><br><span class="line">keepalived  <span class="comment">#该connections参数设置保留在每个工作进程缓存中的上游服务器的最大空闲保活连接数。当超过这个数字时，最近最少使用的连接将被关闭。</span></span><br><span class="line"></span><br><span class="line">Syntax: keepalive_timeout <span class="built_in">timeout</span>;</span><br><span class="line">Default: </span><br><span class="line">keepalive_timeout 60s;</span><br><span class="line">Context: upstream</span><br><span class="line">This directive appeared <span class="keyword">in</span> version 1.15.3.</span><br><span class="line"></span><br><span class="line">keepalive_timeout <span class="comment">#设置一个超时时间，在此期间与上游服务器的空闲保活连接将保持打开状态。</span></span><br></pre></td></tr></table></figure>

<p><strong>基于 hash 的调度算法</strong></p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">#对总权重3取模得出以下结果，再进行调度至后端服务器</span><br><span class="line">&#123;3,6,9&#125;%3=0</span><br><span class="line">&#123;1,4,7,10&#125;%3=1</span><br><span class="line">&#123;2,5,8&#125;%3=2</span><br></pre></td></tr></table></figure>

<p><img src="../../../../images/SRE/day28/130.jpg" alt="130"></p>
<p><strong>添加节点后,会导致很多的调度的缓存信息失效</strong></p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">#对总权重4取模得出以下结果，再进行调度至后端服务器，和上面对3取模结果差异很大,80%都发生了变化</span><br><span class="line">&#123;4,8&#125;%4=0</span><br><span class="line">&#123;1,5,7&#125;%4=1</span><br><span class="line">&#123;2,6,10&#125;%4=2</span><br><span class="line">&#123;3,7&#125;%4=3</span><br></pre></td></tr></table></figure>

<p><img src="../../../../images/SRE/day28/131.jpg" alt="131"></p>
<p><strong>一致性hash 算法</strong></p>
<p><img src="../../../../images/SRE/day28/132.jpg" alt="132"></p>
<h4 id="反向代理示例-后端多台-web服务器"><a href="#反向代理示例-后端多台-web服务器" class="headerlink" title="反向代理示例: 后端多台 web服务器"></a>反向代理示例: 后端多台 web服务器</h4><p><img src="../../../../images/SRE/day28/133.jpg" alt="133"></p>
<p>环境说明：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">10.0.0.100  <span class="comment">#Nginx 代理服务器</span></span><br><span class="line">10.0.0.101  <span class="comment">#后端web A，Apache部署</span></span><br><span class="line">10.0.0.102  <span class="comment">#后端web B，Apache部署</span></span><br></pre></td></tr></table></figure>

<h5 id="部署后端-Apache服务器"><a href="#部署后端-Apache服务器" class="headerlink" title="部署后端 Apache服务器"></a>部署后端 Apache服务器</h5><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ~]<span class="comment"># yum install httpd -y</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># echo &quot;web1 10.0.0.101&quot; &gt; /var/www/html/index.html</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># systemctl enable --now httpd</span></span><br><span class="line"></span><br><span class="line">[root@centos8 ~]<span class="comment"># yum install httpd -y</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># echo &quot;web2 10.0.0.102&quot; &gt;&gt; /var/www/html/index.html</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># systemctl enable --now httpd</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#访问测试</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># curl http://10.0.0.101</span></span><br><span class="line">web1 10.0.0.101</span><br><span class="line">[root@centos8 ~]<span class="comment"># curl http://10.0.0.102</span></span><br><span class="line">web2 10.0.0.102</span><br></pre></td></tr></table></figure>

<h5 id="配置-nginx-反向代理"><a href="#配置-nginx-反向代理" class="headerlink" title="配置 nginx 反向代理"></a>配置 nginx 反向代理</h5><p><strong>注意: 本节实验过程中先关闭缓存</strong></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ~]<span class="comment"># cat /apps/nginx/conf/conf.d/pc.conf</span></span><br><span class="line">http &#123;</span><br><span class="line">  upstream webserver &#123;</span><br><span class="line">  <span class="comment">#hash $request_uri consistent;</span></span><br><span class="line">  <span class="comment">#hash $cookie_sessionid</span></span><br><span class="line">  <span class="comment">#ip_hash;</span></span><br><span class="line">  <span class="comment">#least_conn;</span></span><br><span class="line">  server 10.0.0.101:80 weight=1 fail_timeout=5s max_fails=3; <span class="comment">#后端服务器状态监测</span></span><br><span class="line">  server 10.0.0.102:80 weight=1 fail_timeout=5s max_fails=3;</span><br><span class="line">  <span class="comment">#server 127.0.0.1:80 weight=1 fail_timeout=5s max_fails=3 backup;</span></span><br><span class="line">  keepalive 100; <span class="comment">#该connections参数设置保留在每个工作进程缓存中的上游服务器的最大空闲保活连接数。当超过这个数字时，最近最少使用的连接将被关闭。</span></span><br><span class="line">  keepalive_timeout 60s; <span class="comment">#空闲连接超时时长</span></span><br><span class="line">  &#125;</span><br><span class="line">  server &#123;</span><br><span class="line">    listen 80;</span><br><span class="line">    server_name www.wang.org;</span><br><span class="line">    location / &#123;</span><br><span class="line">      index index.html index.php;</span><br><span class="line">      root /data/nginx/html/pc;</span><br><span class="line">    &#125;</span><br><span class="line">    location /web &#123;</span><br><span class="line">      index index.html;</span><br><span class="line">      proxy_pass http://webserver/;</span><br><span class="line">      proxy_set_header Host  <span class="variable">$http_host</span>; <span class="comment">#转发主机头至后端服务器</span></span><br><span class="line">      proxy_next_upstream error | <span class="built_in">timeout</span> | invalid_header | http_500 | http_502 | http_503 | http_504;</span><br><span class="line">      proxy_http_version 1.1;         <span class="comment">#指定使用http1.1版本才能支持长连接</span></span><br><span class="line">      proxy_set_header Connection <span class="string">&quot;&quot;</span>; <span class="comment">#和上面的keepalived指令配合实现代理和后端服务器的长连接功能</span></span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">#重启Nginx 并访问测试</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># curl   http://www.wang.org/web</span></span><br><span class="line">web1 10.0.0.101</span><br><span class="line"></span><br><span class="line">[root@centos8 ~]<span class="comment"># curl http://www.wang.org/web</span></span><br><span class="line">web2 10.0.0.102</span><br><span class="line"></span><br><span class="line"><span class="comment">#关闭10.0.0.101和10.0.0.102，测试nginx backup服务器可用性：</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># while true;do curl http://www.wang.org/web;sleep 1;done</span></span><br></pre></td></tr></table></figure>

<h4 id="实战案例-基于Cookie-实现会话绑定"><a href="#实战案例-基于Cookie-实现会话绑定" class="headerlink" title="实战案例: 基于Cookie 实现会话绑定"></a>实战案例: 基于Cookie 实现会话绑定</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ~]<span class="comment"># vim /apps/nginx/conf/nginx.conf</span></span><br><span class="line">http &#123;</span><br><span class="line">  upstream websrvs &#123;</span><br><span class="line">  <span class="built_in">hash</span> <span class="variable">$cookie_hello</span>;  <span class="comment">#hello是cookie的key的名称</span></span><br><span class="line">  server 10.0.0.101:80 weight=2;</span><br><span class="line">  server 10.0.0.102:80 weight=1;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">[root@centos8 ~]<span class="comment"># vim /apps/nginx/conf/conf.d/pc.conf</span></span><br><span class="line">server &#123;</span><br><span class="line">   location /&#123;</span><br><span class="line">     <span class="comment">#proxy_cache mycache;</span></span><br><span class="line">     proxy_pass http://websrvs;</span><br><span class="line">     proxy_set_header Host  <span class="variable">$http_host</span>; <span class="comment">#转发主机头至后端服务器</span></span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">#测试</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># curl -b hello=wang http://www.wang.org/</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># curl -b hello=wange http://www.wang.org/</span></span><br></pre></td></tr></table></figure>

<h4 id="实战案例-实现-HTTPS-的负载均衡"><a href="#实战案例-实现-HTTPS-的负载均衡" class="headerlink" title="实战案例: 实现 HTTPS 的负载均衡"></a>实战案例: 实现 HTTPS 的负载均衡</h4><p><img src="../../../../images/SRE/day28/134.jpg" alt="134"></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ~]<span class="comment"># vim /apps/nginx/conf.d/proxy.conf</span></span><br><span class="line">upstream websrvs &#123;</span><br><span class="line">  server 10.0.0.101:80 ;</span><br><span class="line">  server 10.0.0.102:80 ;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">server &#123;</span><br><span class="line">  listen 80;</span><br><span class="line">  server_name www.wang.org;</span><br><span class="line">  <span class="built_in">return</span> 302 https://$server_name<span class="variable">$request_uri</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">server &#123;</span><br><span class="line">  listen 443 ssl http2;</span><br><span class="line">  server_name www.wang.org;</span><br><span class="line">  ssl_certificate   /apps/nginx/ssl/www.wang.org.pem;</span><br><span class="line">  ssl_certificate_key /apps/nginx/ssl/www.wang.org.key;</span><br><span class="line">  ssl_session_cache shared:sslcache:20m;</span><br><span class="line">  ssl_session_timeout 10m;</span><br><span class="line">  location / &#123;</span><br><span class="line">    proxy_pass http://websrvs;</span><br><span class="line">    proxy_set_header Host  <span class="variable">$http_host</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="实现-Nginx-四层负载均衡"><a href="#实现-Nginx-四层负载均衡" class="headerlink" title="实现 Nginx 四层负载均衡"></a>实现 Nginx 四层负载均衡</h2><p>Nginx在1.9.0版本开始支持tcp模式的负载均衡，在1.9.13版本开始支持udp协议的负载，udp主要用于DNS的域名解析，其配置方式和指令和http 代理类似，其基于ngx_stream_proxy_module模块实现tcp负载，另外基于模块ngx_stream_upstream_module实现后端服务器分组转发、权重分配、状态监测、调度算法等高级功能。</p>
<p>如果编译安装,需要指定 –with-stream 选项才能支持ngx_stream_proxy_module模块</p>
<p>官方文档：</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">https://nginx.org/en/docs/stream/ngx_stream_proxy_module.html</span><br><span class="line">http://nginx.org/en/docs/stream/ngx_stream_upstream_module.html</span><br></pre></td></tr></table></figure>

<h3 id="TCP协议负载均衡配置参数"><a href="#TCP协议负载均衡配置参数" class="headerlink" title="TCP协议负载均衡配置参数"></a>TCP协议负载均衡配置参数</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">stream &#123; <span class="comment">#定义stream相关的服务；Context:main</span></span><br><span class="line">   upstream backend &#123; <span class="comment">#定义后端服务器</span></span><br><span class="line">       <span class="built_in">hash</span> <span class="variable">$remote_addr</span> consistent; <span class="comment">#定义调度算法,当后端服务器可用时此算法才生效，不可用时，可能调度其它可用的主机</span></span><br><span class="line">       server backend1.example.com:12345 weight=5; <span class="comment">#定义具体server</span></span><br><span class="line">       server 127.0.0.1:12345      max_fails=3 fail_timeout=30s;</span><br><span class="line">       server unix:/tmp/backend3;</span><br><span class="line">   &#125;</span><br><span class="line">   </span><br><span class="line">   upstream dns &#123;  <span class="comment">#定义后端服务器</span></span><br><span class="line">       server 10.0.0.1:53535;  <span class="comment">#定义具体server</span></span><br><span class="line">       server dns.example.com:53;</span><br><span class="line">   &#125;</span><br><span class="line">   </span><br><span class="line">   server &#123; <span class="comment">#定义server</span></span><br><span class="line">       listen 12345; <span class="comment">#监听IP:PORT</span></span><br><span class="line">       proxy_connect_timeout 1s; <span class="comment">#连接超时时间</span></span><br><span class="line">       proxy_timeout 3s; <span class="comment">#转发超时时间</span></span><br><span class="line">       proxy_pass backend; <span class="comment">#转发到具体服务器组</span></span><br><span class="line">   &#125;</span><br><span class="line">   </span><br><span class="line">   server &#123;</span><br><span class="line">       listen 127.0.0.1:53 udp reuseport;</span><br><span class="line">       proxy_timeout 20s;</span><br><span class="line">       proxy_pass dns;</span><br><span class="line">   &#125;</span><br><span class="line">   </span><br><span class="line">   server &#123;</span><br><span class="line">       listen [::1]:12345;</span><br><span class="line">       proxy_pass unix:/tmp/stream.socket;</span><br><span class="line">   &#125;</span><br><span class="line">        </span><br><span class="line">   server &#123;</span><br><span class="line">   listen 2222;</span><br><span class="line">   proxy 10.0.0.8:22; <span class="comment"># 只实现四层代理,无负载均衡功能</span></span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="负载均衡实例-Redis"><a href="#负载均衡实例-Redis" class="headerlink" title="负载均衡实例 : Redis"></a>负载均衡实例 : Redis</h3><p><img src="../../../../images/SRE/day28/135.jpg" alt="135"></p>
<h4 id="后端服务器安装-redis"><a href="#后端服务器安装-redis" class="headerlink" title="后端服务器安装 redis"></a>后端服务器安装 redis</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#安装两台redis服务器</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># yum -y install redis </span></span><br><span class="line">[root@centos8 ~]<span class="comment"># sed -i &#x27;/^bind /c bind 0.0.0.0&#x27; /etc/redis.conf</span></span><br><span class="line"></span><br><span class="line">[root@centos8 ~]<span class="comment"># systemctl enable --now redis</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># ss -tnl | grep 6379</span></span><br><span class="line">LISTEN     0      128         *:6379                     *:* </span><br></pre></td></tr></table></figure>

<h4 id="nginx-配置"><a href="#nginx-配置" class="headerlink" title="nginx 配置"></a>nginx 配置</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ~]<span class="comment"># vim /apps/nginx/conf/nginx.conf</span></span><br><span class="line">include /apps/nginx/conf/tcp/tcp.conf; <span class="comment">#注意此处的include与http模块平级</span></span><br><span class="line"></span><br><span class="line">[root@centos8 ~]<span class="comment"># mkdir /apps/nginx/conf/tcp</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># cat /apps/nginx/conf/tcp/tcp.conf</span></span><br><span class="line">stream &#123;</span><br><span class="line">    upstream redis_server &#123;</span><br><span class="line">    <span class="comment">#hash $remote_addr consistent;</span></span><br><span class="line">        server 10.0.0.18:6379 max_fails=3 fail_timeout=30s;</span><br><span class="line">        server 10.0.0.28:6379 max_fails=3 fail_timeout=30s;</span><br><span class="line">    &#125;</span><br><span class="line">    server &#123;</span><br><span class="line">        listen 10.0.0.8:6379;</span><br><span class="line">        proxy_connect_timeout 3s;</span><br><span class="line">        proxy_timeout 3s;</span><br><span class="line">        proxy_pass redis_server;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">#重启nginx并访问测试</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># systemctl restart nginx</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># ss -tnl | grep 6379</span></span><br><span class="line">LISTEN     0      128    10.0.0.8:6379                 *:*  </span><br><span class="line"></span><br><span class="line"><span class="comment">#测试通过nginx 负载连接redis：</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># redis-cli -h 10.0.0.8 set name wang </span></span><br><span class="line">OK</span><br><span class="line">[root@centos8 ~]<span class="comment"># redis-cli -h 10.0.0.8 get name</span></span><br><span class="line">(nil)</span><br><span class="line">[root@centos8 ~]<span class="comment"># redis-cli -h 10.0.0.8 get name</span></span><br><span class="line"><span class="string">&quot;wang&quot;</span></span><br></pre></td></tr></table></figure>

<h3 id="负载均衡实例-MySQL"><a href="#负载均衡实例-MySQL" class="headerlink" title="负载均衡实例: MySQL"></a>负载均衡实例: MySQL</h3><p><img src="../../../../images/SRE/day28/136.jpg" alt="136"></p>
<h4 id="后端服务器安装-MySQL"><a href="#后端服务器安装-MySQL" class="headerlink" title="后端服务器安装 MySQL"></a>后端服务器安装 MySQL</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#先修改后端两个服务器的主机名,方便测试</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># hostnamectl set-hostname mysql-server1.wang.org</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># hostnamectl set-hostname mysql-server2.wang.org</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#安装MySQL服务</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># yum -y install mariadb-server </span></span><br><span class="line">[root@centos8 ~]<span class="comment"># systemctl enable --now mariadb</span></span><br><span class="line">MariaDB [(none)]&gt; create user wang@<span class="string">&#x27;10.0.0.%&#x27;</span> identified by <span class="string">&#x27;magedu&#x27;</span>;</span><br><span class="line">MariaDB [(none)]&gt; FLUSH PRIVILEGES;</span><br><span class="line">MariaDB [(none)]&gt; <span class="built_in">exit</span></span><br></pre></td></tr></table></figure>

<h4 id="nginx配置"><a href="#nginx配置" class="headerlink" title="nginx配置"></a>nginx配置</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ~]<span class="comment"># cat /apps/nginx/conf/tcp/tcp.conf </span></span><br><span class="line">stream &#123;</span><br><span class="line">   upstream redis_server &#123;</span><br><span class="line">     server 10.0.0.18:6379 max_fails=3 fail_timeout=30s;</span><br><span class="line">     server 10.0.0.28:6379 max_fails=3 fail_timeout=30s;</span><br><span class="line">      <span class="comment">#server 10.0.0.28:6379 max_fails=3 fail_timeout=30s backup;</span></span><br><span class="line">   &#125;</span><br><span class="line">   upstream mysql_server &#123;</span><br><span class="line">     least_conn;</span><br><span class="line">     server 10.0.0.18:3306 max_fails=3 fail_timeout=30s;</span><br><span class="line">   &#125;</span><br><span class="line"><span class="comment">###################################################################</span></span><br><span class="line"> server &#123;</span><br><span class="line">   listen 10.0.0.8:3306;</span><br><span class="line">   proxy_connect_timeout 6s;</span><br><span class="line">   proxy_timeout 15s;</span><br><span class="line">   proxy_pass mysql_server;</span><br><span class="line">   &#125;</span><br><span class="line"> server &#123;</span><br><span class="line">   listen 10.0.0.8:6379;</span><br><span class="line">   proxy_connect_timeout 3s;</span><br><span class="line">   proxy_timeout 3s;</span><br><span class="line">   proxy_pass redis_server;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">#重启nginx并访问测试：</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># systemctl restart nginx</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#测试通过nginx负载连接MySQL：</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># mysql -uwang -pmagedu -h10.0.0.8 -e &#x27;show variables like &quot;hostname&quot;&#x27;</span></span><br><span class="line">+---------------+-------------------------+</span><br><span class="line">| Variable_name | Value                   |</span><br><span class="line">+---------------+-------------------------+</span><br><span class="line">| hostname      | mysql-server1.wang.org  |</span><br><span class="line">+---------------+-------------------------+</span><br><span class="line"></span><br><span class="line">[root@centos8 ~]<span class="comment"># mysql -uwang -pmagedu -h10.0.0.8 -e &#x27;show variables like &quot;hostname&quot;&#x27;</span></span><br><span class="line">+---------------+-------------------------+</span><br><span class="line">| Variable_name | Value                   |</span><br><span class="line">+---------------+-------------------------+</span><br><span class="line">| hostname      | mysql-server2.wang.org  |</span><br><span class="line">+---------------+-------------------------+</span><br><span class="line"></span><br><span class="line"><span class="comment">#在10.0.0.28停止MySQL服务</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># systemctl stop mysqld</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#再次测试访问,只会看到mysql-server1.wang.org进行响应</span></span><br><span class="line">[root@centos8 ~]<span class="comment">#mysql -uwang -pmagedu -h10.0.0.8 -e &#x27;show variables like &quot;hostname&quot;&#x27;</span></span><br><span class="line">+---------------+-------------------------+</span><br><span class="line">| Variable_name | Value                   |</span><br><span class="line">+---------------+-------------------------+</span><br><span class="line">| hostname      | mysql-server1.wang.org  |</span><br><span class="line">+---------------+-------------------------+</span><br></pre></td></tr></table></figure>

<h3 id="UDP协议负载均衡实例-DNS"><a href="#UDP协议负载均衡实例-DNS" class="headerlink" title="UDP协议负载均衡实例: DNS"></a>UDP协议负载均衡实例: DNS</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">stream &#123; </span><br><span class="line">    upstream dns_servers &#123; </span><br><span class="line">        server 10.0.0.7:53; </span><br><span class="line">        server 10.0.0.17:53; </span><br><span class="line">    &#125; </span><br><span class="line">    server &#123; </span><br><span class="line">        listen 53 udp; </span><br><span class="line">        proxy_pass dns_servers; </span><br><span class="line">    &#125; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="实现-FastCGI"><a href="#实现-FastCGI" class="headerlink" title="实现 FastCGI"></a>实现 FastCGI</h2><p><img src="../../../../images/SRE/day28/137.jpg" alt="137"></p>
<p><img src="../../../../images/SRE/day28/138.jpg" alt="138"></p>
<p>CGI的由来：</p>
<p>最早的Web服务器只能简单地响应浏览器发来的HTTP请求，并将存储在服务器上的HTML文件返回给浏览器，也就是静态html文件，但是后期随着网站功能增多网站开发也越来越复杂，以至于出现动态技术，比如像php(1995年)、java(1995)、python(1991)语言开发的网站，但是nginx/apache服务器并不能直接运行 php、java这样的文件，apache实现的方式是打补丁，但是nginx缺通过与第三方基于协议实现，即通过某种特定协议将客户端请求转发给第三方服务处理，<strong>第三方服务器会新建新的进程处理用户的请求，处理完成后返回数据给Nginx并回收进程，</strong>最后nginx在返回给客户端，那这个约定就是通用网关接口(common gateway interface，简称CGI)，CGI（协议） 是web服务器和外部应用程序之间的接口标准，是cgi程序和web服务器之间传递信息的标准化接口。</p>
<p><img src="../../../../images/SRE/day28/139.jpg" alt="139"></p>
<p>为什么会有FastCGI？</p>
<p>CGI协议虽然解决了语言解析器和 Web Server 之间通讯的问题，但是它的效率很低，因为 Web Server 每收到一个请求都会创建一个CGI进程，PHP解析器都会解析php.ini文件，初始化环境，请求结束的时候再关闭进程，对于每一个创建的CGI进程都会执行这些操作，所以效率很低，而FastCGI是用来提高CGI性能的，FastCGI每次处理完请求之后不会关闭掉进程，而是保留这个进程，使这个进程可以处理多 个请求。这样的话每个请求都不用再重新创建一个进程了，大大提升了处理效率。</p>
<p>什么是PHP-FPM？</p>
<p>PHP-FPM(FastCGI Process Manager：FastCGI进程管理器)是一个实现了Fastcgi的程序，并且提供进程管理的功能。进程包括master进程和worker进程。master进程只有一个，负责监听端口，接受来自web server的请求。worker进程一般会有多个，每个进程中会嵌入一个PHP解析器，进行PHP代码的处理。</p>
<h3 id="FastCGI配置指令"><a href="#FastCGI配置指令" class="headerlink" title="FastCGI配置指令"></a>FastCGI配置指令</h3><p>Nginx基于模块ngx_http_fastcgi_module实现通过fastcgi协议将指定的客户端请求转发至php-fpm处理，其配置指令如下：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">fastcgi_pass address;</span><br><span class="line"><span class="comment">#转发请求到后端服务器，address为后端的fastcgi server的地址，可用位置：location, if in location</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#示例</span></span><br><span class="line">fastcgi_pass localhost:9000;</span><br><span class="line">fastcgi_pass unix:/tmp/fastcgi.socket;</span><br><span class="line"></span><br><span class="line">fastcgi_index name;</span><br><span class="line"><span class="comment">#fastcgi默认的主页资源，示例：fastcgi_index index.php;</span></span><br><span class="line"></span><br><span class="line">fastcgi_param parameter value [if_not_empty];</span><br><span class="line"><span class="comment">#设置传递给FastCGI服务器的参数值，可以是文本，变量或组合，可用于将Nginx的内置变量赋值给自定义key</span></span><br><span class="line">fastcgi_param REMOTE_ADDR        <span class="variable">$remote_addr</span>; <span class="comment">#客户端源IP</span></span><br><span class="line">fastcgi_param REMOTE_PORT        <span class="variable">$remote_port</span>; <span class="comment">#客户端源端口</span></span><br><span class="line">fastcgi_param SERVER_ADDR        <span class="variable">$server_addr</span>; <span class="comment">#请求的服务器IP地址</span></span><br><span class="line">fastcgi_param SERVER_PORT        <span class="variable">$server_port</span>; <span class="comment">#请求的服务器端口</span></span><br><span class="line">fastcgi_param SERVER_NAME        <span class="variable">$server_name</span>; <span class="comment">#请求的server name</span></span><br><span class="line"></span><br><span class="line">Nginx默认配置示例：</span><br><span class="line">   location ~ \.php$ &#123;</span><br><span class="line">     root           /scripts;</span><br><span class="line">     fastcgi_pass   127.0.0.1:9000;</span><br><span class="line">     fastcgi_index index.php;</span><br><span class="line">     fastcgi_param SCRIPT_FILENAME  $document_root<span class="variable">$fastcgi_script_name</span>; <span class="comment">#默认脚本路径</span></span><br><span class="line">      <span class="comment">#fastcgi_param SCRIPT_FILENAME /scripts$fastcgi_script_name; #此行写法不再需要上面的 root 指令</span></span><br><span class="line">     fastcgi_param HTTPS on;           <span class="comment">#如果是前端代理采用https,当前后端http服务器需要加此项,否则可能会造成页面显示不正常</span></span><br><span class="line">     include       fastcgi_params;    <span class="comment">#此文件默认系统已提供,存放的相对路径为prefix/conf</span></span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<p>fastcgi 缓存定义指令：注意使用fastcgi缓存, 可能会导致源代码更新失败,生产慎用</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">fastcgi_cache_path path [levels=levels] [use_temp_path=on|off] keys_zone=name:size </span><br><span class="line">[inactive=time] [max_size=size] [manager_files=number] [manager_sleep=time]</span><br><span class="line">[manager_threshold=time] [loader_files=number] [loader_sleep=time] [loader_threshold=time]</span><br><span class="line">[purger=on|off] [purger_files=number] [purger_sleep=time] [purger_threshold=time];</span><br><span class="line"></span><br><span class="line"><span class="comment">#定义fastcgi的缓存;</span></span><br><span class="line"> path   <span class="comment">#缓存位置为磁盘上的文件系统路径</span></span><br><span class="line"> max_size=size <span class="comment">#磁盘path路径中用于缓存数据的缓存空间上限</span></span><br><span class="line"> levels=levels：<span class="comment">#缓存目录的层级数量，以及每一级的目录数量， levels=ONE:TWO:THREE，示例：leves=1:2:2</span></span><br><span class="line"> keys_zone=name:size <span class="comment">#设置缓存名称及k/v映射的内存空间的名称及大小</span></span><br><span class="line"> inactive=time <span class="comment">#缓存有效时间，默认10分钟，需要在指定时间满足fastcgi_cache_min_uses 次数被视为活动缓存。</span></span><br></pre></td></tr></table></figure>

<p>缓存调用指令：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">fastcgi_cache zone | off; </span><br><span class="line"><span class="comment">#调用指定的缓存空间来缓存数据，可用位置：http, server, location</span></span><br><span class="line"></span><br><span class="line">fastcgi_cache_key string; </span><br><span class="line"><span class="comment">#定义用作缓存项的key的字符串，示例：fastcgi_cache_key $request_uri;</span></span><br><span class="line"></span><br><span class="line">fastcgi_cache_methods GET | HEAD | POST ...; </span><br><span class="line"><span class="comment">#为哪些请求方法使用缓存 </span></span><br><span class="line"></span><br><span class="line">fastcgi_cache_min_uses number; </span><br><span class="line"><span class="comment">#缓存空间中的缓存项在inactive定义的非活动时间内至少要被访问到此处所指定的次数方可被认作活动项</span></span><br><span class="line"></span><br><span class="line">fastcgi_keep_conn on | off;  </span><br><span class="line"><span class="comment">#收到后端服务器响应后，fastcgi服务器是否关闭连接，建议启用长连接</span></span><br><span class="line"></span><br><span class="line">fastcgi_cache_valid [code ...] time; </span><br><span class="line"><span class="comment">#不同的响应码各自的缓存时长</span></span><br><span class="line"></span><br><span class="line">fastcgi_hide_header field; <span class="comment">#隐藏响应头指定信息</span></span><br><span class="line">fastcgi_pass_header field; <span class="comment">#返回响应头指定信息，默认不会将Status、X-Accel-...返回</span></span><br></pre></td></tr></table></figure>

<h3 id="FastCGI实战案例-Nginx与php-fpm在同一服务器"><a href="#FastCGI实战案例-Nginx与php-fpm在同一服务器" class="headerlink" title="FastCGI实战案例 : Nginx与php-fpm在同一服务器"></a>FastCGI实战案例 : Nginx与php-fpm在同一服务器</h3><p>php安装可以通过yum或者编译安装，使用yum安装相对比较简单，编译安装更方便自定义参数或选项。</p>
<p> <img src="../../../../images/SRE/day28/140.jpg" alt="140"></p>
<h4 id="php-环境准备"><a href="#php-环境准备" class="headerlink" title="php 环境准备"></a>php 环境准备</h4><p>使用base源自带的php版本</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#yum安装默认版本php和相关APP依赖的包</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># yum -y install php-fpm php-mysqlnd php-json #默认版本</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#或者安装清华的php源</span></span><br><span class="line">[root@centos7 ~]<span class="comment"># yum -y install https://mirrors.tuna.tsinghua.edu.cn/remi/enterprise/remi-release-7.rpm</span></span><br><span class="line"></span><br><span class="line">[root@centos8 ~]<span class="comment"># systemctl enable --now php-fpm</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># ps -ef | grep php-fpm</span></span><br><span class="line">root       4925      1  0 17:13 ?        00:00:00 php-fpm: master process (/etc/php-fpm.conf)</span><br><span class="line">apache     4927   4925  0 17:13 ?        00:00:00 php-fpm: pool www</span><br><span class="line">apache     4928   4925  0 17:13 ?        00:00:00 php-fpm: pool www</span><br><span class="line">apache     4929   4925  0 17:13 ?        00:00:00 php-fpm: pool www</span><br><span class="line">apache     4930   4925  0 17:13 ?        00:00:00 php-fpm: pool www</span><br><span class="line">apache     4931   4925  0 17:13 ?        00:00:00 php-fpm: pool www</span><br><span class="line">root       4933   3235  0 17:13 pts/0    00:00:00 grep --color=auto php-fpm</span><br></pre></td></tr></table></figure>

<h4 id="php相关配置优化"><a href="#php相关配置优化" class="headerlink" title="php相关配置优化"></a>php相关配置优化</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ~]<span class="comment"># grep &quot;^[a-Z]&quot; /etc/php-fpm.conf </span></span><br><span class="line">include=/etc/php-fpm.d/*.conf</span><br><span class="line">pid = /run/php-fpm/php-fpm.pid</span><br><span class="line">error_log = /var/log/php-fpm/error.log</span><br><span class="line">daemonize = <span class="built_in">yes</span> <span class="comment">#是否后台启动</span></span><br><span class="line"></span><br><span class="line">[root@centos8 ~]<span class="comment"># grep -Ev &#x27;^;.*$|^ *$&#x27; /etc/php-fpm.d/www.conf </span></span><br><span class="line">[www]</span><br><span class="line">user = nginx</span><br><span class="line">group = nginx</span><br><span class="line">listen = /run/php-fpm/www.sock   <span class="comment">#指定使用UDS,或者使用下面形式</span></span><br><span class="line">;listen = 127.0.0.1:9000  <span class="comment">#监听地址及IP</span></span><br><span class="line">listen.acl_users = apache,nginx</span><br><span class="line">listen.allowed_clients = 127.0.0.1</span><br><span class="line">pm = dynamic</span><br><span class="line">pm.max_children = 50</span><br><span class="line">pm.start_servers = 5</span><br><span class="line">pm.min_spare_servers = 5</span><br><span class="line">pm.max_spare_servers = 35</span><br><span class="line">pm.status_path = /pm_status  <span class="comment">#修改此行</span></span><br><span class="line">ping.path = /ping            <span class="comment">#修改此行</span></span><br><span class="line">ping.response = ping-pong    <span class="comment">#修改此行</span></span><br><span class="line">slowlog = /var/log/php-fpm/www-slow.log  <span class="comment">#慢日志路径</span></span><br><span class="line">php_admin_value[error_log] = /var/log/php-fpm/www-error.log <span class="comment">#错误日志</span></span><br><span class="line">php_admin_flag[log_errors] = on</span><br><span class="line">php_value[session.save_handler] = files  <span class="comment">#phpsession保存方式及路径</span></span><br><span class="line">php_value[session.save_path]    = /var/lib/php/session <span class="comment">#当时使用file保存session的文件路径</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#文件最后修改下面两行</span></span><br><span class="line">php_value[session.save_handler] = redis</span><br><span class="line">php_value[session.save_path]    = <span class="string">&quot;tcp://redis-server:6379&quot;</span></span><br><span class="line"></span><br><span class="line">php_value[soap.wsdl_cache_dir]  = /var/lib/php/wsdlcache</span><br><span class="line">php_value[upload_max_filesize] = 20m</span><br><span class="line">php_value[post_max_size]  = 20m</span><br><span class="line">php_value[date.timezone]  = Asia/Shanghai</span><br><span class="line"></span><br><span class="line"><span class="comment">#修改配置文件后记得重启php-fpm</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># systemctl restart php-fpm</span></span><br></pre></td></tr></table></figure>

<h4 id="准备php测试页面"><a href="#准备php测试页面" class="headerlink" title="准备php测试页面"></a>准备php测试页面</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ~]<span class="comment"># mkdir -p /data/php</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># cat /data/php/index.php #php测试页面</span></span><br><span class="line">&lt;?php</span><br><span class="line">phpinfo();</span><br><span class="line">?&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment">#测试连接数据库</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># vim /data/php/mysql.php</span></span><br><span class="line">&lt;?php</span><br><span class="line">    <span class="variable">$servername</span> = <span class="string">&quot;localhost&quot;</span>;</span><br><span class="line">    <span class="variable">$username</span> = <span class="string">&quot;root&quot;</span>;</span><br><span class="line">    <span class="variable">$password</span> = <span class="string">&quot;123456&quot;</span>;</span><br><span class="line"> // 创建连接</span><br><span class="line">    <span class="variable">$conn</span> = mysqli_connect(<span class="variable">$servername</span>,<span class="variable">$username</span>, <span class="variable">$password</span>);</span><br><span class="line"> // 检测连接</span><br><span class="line">    <span class="keyword">if</span> (!<span class="variable">$conn</span>) &#123;</span><br><span class="line">        die(<span class="string">&quot;php连接MySQL数据库失败: &quot;</span> . mysqli_connect_error());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;php连接MySQL数据库成功!&quot;</span>;</span><br><span class="line">?&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment">#运行测式脚本</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># php /data/php/mysql.php</span></span><br></pre></td></tr></table></figure>

<h4 id="Nginx配置转发"><a href="#Nginx配置转发" class="headerlink" title="Nginx配置转发"></a>Nginx配置转发</h4><p>Nginx安装完成之后默认生成了与fastcgi的相关配置文件，一般保存在nginx的安装路径的conf目录当中，比如/apps/nginx/conf/fastcgi.conf、/apps/nginx/conf/fastcgi_params。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ~]<span class="comment"># vim /apps/nginx/conf/conf.d/pc.conf #在指定文件配置fastcgi</span></span><br><span class="line">server &#123;</span><br><span class="line">  listen 80;</span><br><span class="line">  server_name www.wang.org;</span><br><span class="line">  index index.php index.html;</span><br><span class="line">  location ~ \.php$|pm_status|ping &#123;</span><br><span class="line">    root           /data/php; <span class="comment">#下面的$document_root调用此行的root指令指定的目录</span></span><br><span class="line">    fastcgi_pass   unix:/run/php-fpm/www.sock;</span><br><span class="line">    <span class="comment">#fastcgi_pass   127.0.0.1:9000;</span></span><br><span class="line">    fastcgi_index index.php;</span><br><span class="line">    <span class="comment">#fastcgi_param SCRIPT_FILENAME /data/php$fastcgi_script_name;</span></span><br><span class="line">    <span class="comment">#如果SCRIPT_FILENAME是上面的绝对路径则可以省略root /data/php;</span></span><br><span class="line">    fastcgi_param SCRIPT_FILENAME  $document_root<span class="variable">$fastcgi_script_name</span>;</span><br><span class="line">    include       fastcgi_params;</span><br><span class="line">    fastcgi_param HTTPS <span class="variable">$https</span> if_not_empty; <span class="comment">#有些应用支持https需要此项,否则会造成页面不正常</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">#重启Nginx并访问web测试  </span></span><br><span class="line">[root@centos8 ~]<span class="comment"># systemctl restart nginx</span></span><br></pre></td></tr></table></figure>

<h4 id="访问验证php测试页面"><a href="#访问验证php测试页面" class="headerlink" title="访问验证php测试页面"></a>访问验证php测试页面</h4><p><img src="../../../../images/SRE/day28/141.jpg" alt="141"></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#常见的错误：</span></span><br><span class="line">File not found.  <span class="comment">#路径不对</span></span><br><span class="line">502  <span class="comment">#php-fpm处理超时、服务停止运行等原因导致的无法连接或请求超时</span></span><br></pre></td></tr></table></figure>

<h4 id="php-fpm-的运行状态页面"><a href="#php-fpm-的运行状态页面" class="headerlink" title="php-fpm 的运行状态页面"></a>php-fpm 的运行状态页面</h4><p>访问配置文件里面指定的路径，会返回php-fpm的当前运行状态。</p>
<p>Nginx配置：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">location ~ ^/(ping|pm_status)$ &#123;</span><br><span class="line">   fastcgi_pass unix:/run/php-fpm/www.sock;</span><br><span class="line">    <span class="comment">#fastcgi_pass 127.0.0.1:9000;</span></span><br><span class="line">   fastcgi_param PATH_TRANSLATED $document_root<span class="variable">$fastcgi_script_name</span>;</span><br><span class="line">   include fastcgi_params;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">#重启Nginx并测试：</span></span><br></pre></td></tr></table></figure>

<p><img src="../../../../images/SRE/day28/142.jpg" alt="142"><br><img src="../../../../images/SRE/day28/143.jpg" alt="143"></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ~]<span class="comment"># curl http://www.wang.org/ping</span></span><br><span class="line">ping-pong</span><br><span class="line"></span><br><span class="line">[root@centos8 ~]<span class="comment"># curl http://www.wang.org/pm_status</span></span><br><span class="line">pool:                 www</span><br><span class="line">process manager:     dynamic</span><br><span class="line">start time:           10/Oct/2020:00:04:43 +0800</span><br><span class="line">start since:          155</span><br><span class="line">accepted conn:        5</span><br><span class="line">listen queue:         0</span><br><span class="line">max listen queue:     0</span><br><span class="line">listen queue len:     0</span><br><span class="line">idle processes:       4</span><br><span class="line">active processes:     1</span><br><span class="line">total processes:      5</span><br><span class="line">max active processes: 1</span><br><span class="line">max children reached: 0</span><br><span class="line">slow requests:        0</span><br><span class="line"></span><br><span class="line">[root@centos8 ~]<span class="comment"># curl http://www.wang.org/pm_status?full</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># curl http://www.wang.org/pm_status?html</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># curl http://www.wang.org/pm_status?json</span></span><br></pre></td></tr></table></figure>

<h3 id="FastCGI实战案例-Nginx与php不在同一个服务器"><a href="#FastCGI实战案例-Nginx与php不在同一个服务器" class="headerlink" title="FastCGI实战案例 : Nginx与php不在同一个服务器"></a>FastCGI实战案例 : Nginx与php不在同一个服务器</h3><p>nginx会处理静态请求，但是会转发动态请求到后端指定的php-fpm服务器，因此php代码需要放在后端的php-fpm服务器，即静态页面放在Nginx服务器上,而动态页面放在后端php-fpm服务器，通常情况下，一般都是采用在同一个服务器</p>
<p><img src="../../../../images/SRE/day28/144.jpg" alt="144"></p>
<h4 id="yum安装较新版本php-fpm"><a href="#yum安装较新版本php-fpm" class="headerlink" title="yum安装较新版本php-fpm"></a>yum安装较新版本php-fpm</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ~]<span class="comment"># dnf -y install php-fpm php-mysqlnd php-json</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#验证安装路径：</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># rpm -ql php-fpm</span></span><br><span class="line">/etc/httpd/conf.d/php.conf</span><br><span class="line">/etc/logrotate.d/php-fpm</span><br><span class="line">/etc/nginx/conf.d/php-fpm.conf</span><br><span class="line">/etc/nginx/default.d/php.conf</span><br></pre></td></tr></table></figure>

<h4 id="修改php-fpm监听配置"><a href="#修改php-fpm监听配置" class="headerlink" title="修改php-fpm监听配置"></a>修改php-fpm监听配置</h4><p>php-fpm默认监听在127.0.0.1的9000端口，也就是无法远程连接，因此要做相应的修改。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#修改监听配置</span></span><br><span class="line">[root@centos8 ~]<span class="comment">#vim /etc/php-fpm.d/www.conf </span></span><br><span class="line">;listen = /run/php-fpm/www.sock <span class="comment">#注释此行</span></span><br><span class="line">listen = 9000  <span class="comment">#修改此行,指定监听端口</span></span><br><span class="line">;listen.allowed_clients = 127.0.0.1  <span class="comment">#注释此行</span></span><br></pre></td></tr></table></figure>

<h4 id="准备php测试页面-1"><a href="#准备php测试页面-1" class="headerlink" title="准备php测试页面"></a>准备php测试页面</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#准备php数据目录</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># mkdir -p /data/php </span></span><br><span class="line">[root@centos8 ~]<span class="comment"># vim /data/php/index.php</span></span><br><span class="line">&lt;?php</span><br><span class="line"> phpinfo();</span><br><span class="line">?&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment">#测试连接数据库</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># vim /data/php/mysql.php</span></span><br><span class="line">&lt;?php</span><br><span class="line">	<span class="variable">$servername</span> = <span class="string">&quot;localhost&quot;</span>;</span><br><span class="line">	<span class="variable">$username</span> = <span class="string">&quot;root&quot;</span>;</span><br><span class="line">	<span class="variable">$password</span> = <span class="string">&quot;123456&quot;</span>;</span><br><span class="line">	// 创建连接</span><br><span class="line">	<span class="variable">$conn</span> = mysqli_connect(<span class="variable">$servername</span>,<span class="variable">$username</span>,<span class="variable">$password</span>);</span><br><span class="line">	// 检测连接</span><br><span class="line">	<span class="keyword">if</span> (!<span class="variable">$conn</span>) &#123;</span><br><span class="line">		die(<span class="string">&quot;php连接MySQL数据库失败: &quot;</span> . mysqli_connect_error());</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="built_in">echo</span> <span class="string">&quot;php连接MySQL数据库成功!&quot;</span>;</span><br><span class="line">?&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment">#运行测式脚本</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># php /data/php/mysql.php</span></span><br></pre></td></tr></table></figure>

<h4 id="启动并验证php-fpm"><a href="#启动并验证php-fpm" class="headerlink" title="启动并验证php-fpm"></a>启动并验证php-fpm</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#启动php-fpm</span></span><br><span class="line">[root@centos8 ~]<span class="comment">#systemctl enable --now php-fpm.service</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#验证php-fpm进程及端口：</span></span><br><span class="line">[root@centos8 ~]<span class="comment">#ps -ef | grep php-fpm</span></span><br><span class="line">root        1506       1  0 23:24 ?        00:00:00 php-fpm: master process (/etc/php-fpm.conf)</span><br><span class="line">apache      1507    1506  0 23:24 ?        00:00:00 php-fpm: pool www</span><br><span class="line">apache      1508    1506  0 23:24 ?        00:00:00 php-fpm: pool www</span><br><span class="line">apache      1509    1506  0 23:24 ?        00:00:00 php-fpm: pool www</span><br><span class="line">apache      1510    1506  0 23:24 ?        00:00:00 php-fpm: pool www</span><br><span class="line">apache      1511    1506  0 23:24 ?        00:00:00 php-fpm: pool www</span><br><span class="line">root        1517    1102  0 23:25 pts/0    00:00:00 grep --color=auto php-fpm</span><br><span class="line"></span><br><span class="line">[root@centos8 ~]<span class="comment"># ss -tnl</span></span><br><span class="line">State             Recv-Q           Send-Q   Local Address:Port Peer Address:Port           </span><br><span class="line">LISTEN            0                 100           127.0.0.1:25         0.0.0.0:* </span><br><span class="line">LISTEN            0                 128             0.0.0.0:22         0.0.0.0:* </span><br><span class="line">LISTEN            0                 100               [::1]:25            [::]:* </span><br><span class="line">LISTEN            0                 128                   *:9000             *:* </span><br><span class="line">LISTEN            0                 128                [::]:22            [::]:* </span><br><span class="line">  </span><br><span class="line">[root@centos8 ~]<span class="comment"># lsof -i :9000</span></span><br><span class="line">COMMAND PID   USER   FD   TYPE DEVICE SIZE/OFF NODE NAME</span><br><span class="line">php-fpm 1506   root   9u IPv6  33898     0t0 TCP *:cslistener (LISTEN)</span><br><span class="line">php-fpm 1507 apache   11u IPv6  33898     0t0 TCP *:cslistener (LISTEN)</span><br><span class="line">php-fpm 1508 apache   11u IPv6  33898     0t0 TCP *:cslistener (LISTEN)</span><br><span class="line">php-fpm 1509 apache   11u IPv6  33898     0t0 TCP *:cslistener (LISTEN)</span><br><span class="line">php-fpm 1510 apache   11u IPv6  33898     0t0 TCP *:cslistener (LISTEN)</span><br><span class="line">php-fpm 1511 apache   11u IPv6  33898     0t0 TCP *:cslistener (LISTEN)</span><br></pre></td></tr></table></figure>

<h4 id="Nginx配置转发-1"><a href="#Nginx配置转发-1" class="headerlink" title="Nginx配置转发"></a>Nginx配置转发</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ~]<span class="comment">#vi /apps/nginx/conf/conf.d/pc.conf </span></span><br><span class="line"> location ~ \.php$ &#123;</span><br><span class="line">   root           /data/php;</span><br><span class="line">   fastcgi_pass   10.0.0.18:9000;</span><br><span class="line">   fastcgi_index index.php;</span><br><span class="line">    <span class="comment">#fastcgi_param SCRIPT_FILENAME /data/php$fastcgi_script_name;</span></span><br><span class="line">   fastcgi_param SCRIPT_FILENAME  $document_root<span class="variable">$fastcgi_script_name</span>;</span><br><span class="line">   include       fastcgi_params;</span><br><span class="line"> &#125;</span><br><span class="line"> location ~ ^/(ping|pm_status)$ &#123;</span><br><span class="line">   fastcgi_pass 10.0.0.18:9000;</span><br><span class="line">   fastcgi_param PATH_TRANSLATED $document_root<span class="variable">$fastcgi_script_name</span>;</span><br><span class="line">   include fastcgi_params;</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">#重启nginx</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># systemctl restart nginx</span></span><br></pre></td></tr></table></figure>

<h4 id="访问验证php测试页面-1"><a href="#访问验证php测试页面-1" class="headerlink" title="访问验证php测试页面"></a>访问验证php测试页面</h4><p><img src="../../../../images/SRE/day28/145.jpg" alt="145"></p>
<h3 id="实现动静分离"><a href="#实现动静分离" class="headerlink" title="实现动静分离"></a>实现动静分离</h3><p>要求：将客户端对除php以外的资源的访问转发至后端服务器 10.0.0.28上</p>
<p><img src="../../../../images/SRE/day28/146.jpg" alt="146"></p>
<h4 id="配置-nginx-实现反向代理的动静分离"><a href="#配置-nginx-实现反向代理的动静分离" class="headerlink" title="配置 nginx 实现反向代理的动静分离"></a>配置 nginx 实现反向代理的动静分离</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ~]<span class="comment">#vi /apps/nginx/conf/conf.d/pc.conf </span></span><br><span class="line"> location / &#123;</span><br><span class="line">   proxy_pass http://10.0.0.28;</span><br><span class="line">   index index.html;</span><br><span class="line"> &#125;</span><br><span class="line"> location ~ \.php$ &#123;</span><br><span class="line">   root /data/php;</span><br><span class="line">   fastcgi_pass   10.0.0.18:9000;</span><br><span class="line">   fastcgi_index index.php;</span><br><span class="line">    <span class="comment">#fastcgi_param SCRIPT_FILENAME /data/php$fastcgi_script_name;</span></span><br><span class="line">   fastcgi_param SCRIPT_FILENAME  $document_root<span class="variable">$fastcgi_script_name</span>;</span><br><span class="line">   include       fastcgi_params;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>

<h4 id="准备后端-httpd-服务器"><a href="#准备后端-httpd-服务器" class="headerlink" title="准备后端 httpd 服务器"></a>准备后端 httpd 服务器</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#在后端服务器10.0.0.28上安装httpd服务</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># dnf -y install httpd</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># systemctl enable --now httpd</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># mkdir /var/www/html/images</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># wget -O /var/www/html/images/magedu.jpg http://www.magedu.com/wp-content/uploads/2019/05/2019052306372726.jpg</span></span><br></pre></td></tr></table></figure>

<p><img src="../../../../images/SRE/day28/147.jpg" alt="147"></p>
<p><img src="../../../../images/SRE/day28/148.jpg" alt="148"></p>
<h2 id="综合实战项目"><a href="#综合实战项目" class="headerlink" title="综合实战项目"></a>综合实战项目</h2><h3 id="项目实战-利用-LNMP-实现-WordPress-站点搭建"><a href="#项目实战-利用-LNMP-实现-WordPress-站点搭建" class="headerlink" title="项目实战 : 利用 LNMP 实现 WordPress 站点搭建"></a>项目实战 : 利用 LNMP 实现 WordPress 站点搭建</h3><p><strong>LNMP项目实战环境说明</strong></p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">L：Linux（CentOS7）https://mirrors.aliyun.com/centos/7/isos/x86_64/</span><br><span class="line">N：Nginx（1.18.0） https://nginx.org/en/download.html</span><br><span class="line">M：MySQL（8.0.19） https://dev.mysql.com/downloads/mysql/</span><br><span class="line">P：PHP（7.4.10） http://php.net/downloads.php</span><br><span class="line">Wordpress（5.4.2）：https://cn.wordpress.org/download/</span><br><span class="line">#部署规划：</span><br><span class="line">10.0.0.7：Nginx php-fpm 运行web服务</span><br><span class="line">10.0.0.17：运行MySQL数据库,Redis服务</span><br></pre></td></tr></table></figure>

<p><img src="../../../../images/SRE/day28/149.jpg" alt="149"></p>
<h4 id="部署数据库"><a href="#部署数据库" class="headerlink" title="部署数据库"></a>部署数据库</h4><p><strong>在10.0.0.17主机部署MySQL服务</strong></p>
<h5 id="二进制部署MySQL数据库"><a href="#二进制部署MySQL数据库" class="headerlink" title="二进制部署MySQL数据库"></a>二进制部署MySQL数据库</h5><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line">[root@centos7 ~]<span class="comment">#ll </span></span><br><span class="line">total 473728</span><br><span class="line">-rw-r--r--  1 root root      2433 Sep  8 23:09 install_mysql5.7or8.0_for_centos.sh</span><br><span class="line">-rw-r--r--  1 root root 485074552 Aug 22 23:40 mysql-8.0.19-linux-glibc2.12-x86_64.tar.xz</span><br><span class="line"></span><br><span class="line"><span class="comment">#一键安装脚本</span></span><br><span class="line">[root@centos7 ~]<span class="comment">#cat install_mysql5.7or8.0_for_centos.sh </span></span><br><span class="line"><span class="comment">#!/bin/bash</span></span><br><span class="line"><span class="comment">#MySQL Download URL: https://dev.mysql.com/get/Downloads/MySQL-5.7/mysql-5.7.29-linux-glibc2.12-x86_64.tar.gz</span></span><br><span class="line"></span><br><span class="line">. /etc/init.d/functions </span><br><span class="line">SRC_DIR=`<span class="built_in">pwd</span>`</span><br><span class="line">MYSQL=<span class="string">&#x27;mysql-8.0.19-linux-glibc2.12-x86_64.tar.xz&#x27;</span></span><br><span class="line">COLOR=<span class="string">&#x27;echo -e \E[01;31m&#x27;</span></span><br><span class="line">END=<span class="string">&#x27;\E[0m&#x27;</span></span><br><span class="line">MYSQL_ROOT_PASSWORD=123456</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">check</span></span> ()&#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [ <span class="variable">$UID</span> -ne 0 ]; <span class="keyword">then</span></span><br><span class="line">    action <span class="string">&quot;当前用户不是root,安装失败&quot;</span> <span class="literal">false</span></span><br><span class="line">    <span class="built_in">exit</span> 1</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">cd</span>  <span class="variable">$SRC_DIR</span></span><br><span class="line"><span class="keyword">if</span> [ !  -e <span class="variable">$MYSQL</span> ];<span class="keyword">then</span></span><br><span class="line">        <span class="variable">$COLOR</span><span class="string">&quot;缺少<span class="variable">$&#123;MYSQL&#125;</span>文件&quot;</span><span class="variable">$END</span></span><br><span class="line">        <span class="variable">$COLOR</span><span class="string">&quot;请将相关软件放在<span class="variable">$&#123;SRC_DIR&#125;</span>目录下&quot;</span><span class="variable">$END</span></span><br><span class="line">        <span class="built_in">exit</span></span><br><span class="line"><span class="keyword">elif</span> [ -e /usr/local/mysql ];<span class="keyword">then</span></span><br><span class="line">        action <span class="string">&quot;数据库已存在，安装失败&quot;</span> <span class="literal">false</span></span><br><span class="line">        <span class="built_in">exit</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">        <span class="built_in">return</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line">&#125; </span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">install_mysql</span></span>()&#123;</span><br><span class="line">    <span class="variable">$COLOR</span><span class="string">&quot;开始安装MySQL数据库...&quot;</span><span class="variable">$END</span></span><br><span class="line">    yum  -y -q install libaio numactl-libs   libaio &amp;&gt; /dev/null</span><br><span class="line">    <span class="built_in">cd</span> <span class="variable">$SRC_DIR</span></span><br><span class="line">    tar xf <span class="variable">$MYSQL</span> -C /usr/local/</span><br><span class="line">    MYSQL_DIR=`<span class="built_in">echo</span> <span class="variable">$MYSQL</span>| sed -nr <span class="string">&#x27;s/^(.*[0-9]).*/\1/p&#x27;</span>`</span><br><span class="line">    <span class="built_in">ln</span> -s /usr/local/<span class="variable">$MYSQL_DIR</span> /usr/local/mysql</span><br><span class="line">    <span class="built_in">chown</span> -R root.root /usr/local/mysql/</span><br><span class="line">    <span class="built_in">id</span> mysql &amp;&gt; /dev/null || &#123; useradd -s /sbin/nologin -r mysql ; action <span class="string">&quot;创建mysql用户&quot;</span>; &#125;</span><br><span class="line">        </span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&#x27;PATH=/usr/local/mysql/bin/:$PATH&#x27;</span> &gt; /etc/profile.d/mysql.sh</span><br><span class="line">   . /etc/profile.d/mysql.sh</span><br><span class="line"> <span class="built_in">ln</span> -s /usr/local/mysql/bin/* /usr/bin/</span><br><span class="line"> </span><br><span class="line">    <span class="built_in">cat</span> &gt; /etc/my.cnf &lt;&lt;-<span class="string">EOF</span></span><br><span class="line"><span class="string">[mysqld]</span></span><br><span class="line"><span class="string">server-id=`hostname -I|cut -d. -f4`</span></span><br><span class="line"><span class="string">log-bin</span></span><br><span class="line"><span class="string">datadir=/data/mysql</span></span><br><span class="line"><span class="string">socket=/data/mysql/mysql.sock                                                   </span></span><br><span class="line"><span class="string">                                                </span></span><br><span class="line"><span class="string">log-error=/data/mysql/mysql.log</span></span><br><span class="line"><span class="string">pid-file=/data/mysql/mysql.pid</span></span><br><span class="line"><span class="string">[client]</span></span><br><span class="line"><span class="string">socket=/data/mysql/mysql.sock</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"></span><br><span class="line">   mysqld --initialize --user=mysql --datadir=/data/mysql </span><br><span class="line">   <span class="built_in">cp</span> /usr/local/mysql/support-files/mysql.server /etc/init.d/mysqld</span><br><span class="line">   chkconfig --add mysqld</span><br><span class="line">   chkconfig mysqld on</span><br><span class="line">   service mysqld start</span><br><span class="line">   [ $? -ne 0 ] &amp;&amp; &#123; <span class="variable">$COLOR</span><span class="string">&quot;数据库启动失败，退出!&quot;</span><span class="variable">$END</span>;<span class="built_in">exit</span>; &#125;</span><br><span class="line">   MYSQL_OLDPASSWORD=`awk <span class="string">&#x27;/A temporary password/&#123;print $NF&#125;&#x27;</span> /data/mysql/mysql.log`</span><br><span class="line">   mysqladmin  -uroot -p<span class="variable">$MYSQL_OLDPASSWORD</span> password <span class="variable">$MYSQL_ROOT_PASSWORD</span> &amp;&gt;/dev/null</span><br><span class="line">   action <span class="string">&quot;数据库安装完成&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">check</span><br><span class="line">install_mysql</span><br><span class="line"></span><br><span class="line"><span class="comment">#运行脚本安装数据库</span></span><br></pre></td></tr></table></figure>

<p><img src="../../../../images/SRE/day28/150.jpg" alt="150"></p>
<h5 id="创建wordpress数据库和用户并授权"><a href="#创建wordpress数据库和用户并授权" class="headerlink" title="创建wordpress数据库和用户并授权"></a>创建wordpress数据库和用户并授权</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[root@centos7 ~]# mysql -uroot -p123456</span><br><span class="line"></span><br><span class="line">mysql&gt; create database wordpress;</span><br><span class="line">Query OK, 1 row affected (0.01 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; create user wordpress@&#x27;10.0.0.%&#x27; identified by &#x27;123456&#x27;;</span><br><span class="line">Query OK, 0 rows affected (0.01 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; grant all on wordpress.* to wordpress@&#x27;10.0.0.%&#x27;;</span><br><span class="line">Query OK, 0 rows affected (0.01 sec)</span><br></pre></td></tr></table></figure>

<h5 id="验证MySQL账户权限"><a href="#验证MySQL账户权限" class="headerlink" title="验证MySQL账户权限"></a>验证MySQL账户权限</h5><p>在WordPress服务器使用授权的MySQL账户远程登录测试权限</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[root@centos7 ~]<span class="comment"># mysql -uwordpress -p123456 -h10.0.0.17 </span></span><br><span class="line"></span><br><span class="line">mysql&gt; show databases;</span><br><span class="line">+--------------------+</span><br><span class="line">| Database           |</span><br><span class="line">+--------------------+</span><br><span class="line">| information_schema |</span><br><span class="line">| wordpress          |</span><br><span class="line">+--------------------+</span><br><span class="line">2 rows <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br></pre></td></tr></table></figure>

<h4 id="编译部署PHP7-4"><a href="#编译部署PHP7-4" class="headerlink" title="编译部署PHP7.4"></a>编译部署PHP7.4</h4><p><strong>在10.0.0.7主机部署php-fpm服务</strong></p>
<h5 id="编译安装-php"><a href="#编译安装-php" class="headerlink" title="编译安装 php"></a>编译安装 php</h5><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">[root@centos7 ~]<span class="comment"># yum -y install gcc openssl-devel libxml2-devel bzip2-devel libmcrypt-devel sqlite-devel oniguruma-devel</span></span><br><span class="line">[root@centos7 ~]<span class="comment"># cd /usr/local/src</span></span><br><span class="line">[root@centos7 src]<span class="comment"># wget https://www.php.net/distributions/php-7.4.11.tar.xz</span></span><br><span class="line">[root@centos7 src]<span class="comment"># ll -h php-7.4.11.tar.xz </span></span><br><span class="line">-rw-r--r-- 1 root root 9.9M Sep 29 18:40 php-7.4.11.tar.xz</span><br><span class="line"></span><br><span class="line">[root@centos7 php-7.4.11]<span class="comment"># ./configure --prefix=/apps/php74 --enable-mysqlnd \</span></span><br><span class="line">--with-mysqli=mysqlnd --with-pdo-mysql=mysqlnd --with-openssl --with-zlib \</span><br><span class="line">--with-config-file-path=/etc --with-config-file-scan-dir=/etc/php.d --enable-mbstring \</span><br><span class="line">--enable-xml --enable-sockets --enable-fpm --enable-maintainer-zts --disable-fileinfo</span><br><span class="line"></span><br><span class="line">......</span><br><span class="line">config.status: creating main/php_config.h</span><br><span class="line">config.status: executing default commands</span><br><span class="line"></span><br><span class="line">+--------------------------------------------------------------------+</span><br><span class="line">| License:                                                           |</span><br><span class="line">| This software is subject to the PHP License, available <span class="keyword">in</span> this     |</span><br><span class="line">| distribution <span class="keyword">in</span> the file LICENSE. By continuing this installation |</span><br><span class="line">| process, you are bound by the terms of this license agreement.     |</span><br><span class="line">| If you <span class="keyword">do</span> not agree with the terms of this license, you must abort |</span><br><span class="line">| the installation process at this point.                           |</span><br><span class="line">+--------------------------------------------------------------------+</span><br><span class="line">Thank you <span class="keyword">for</span> using PHP.</span><br><span class="line"></span><br><span class="line">[root@centos7 php-7.4.11]<span class="comment"># make -j 8 &amp;&amp; make install</span></span><br></pre></td></tr></table></figure>

<h5 id="准备-php-配置文件"><a href="#准备-php-配置文件" class="headerlink" title="准备 php 配置文件"></a>准备 php 配置文件</h5><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#生成配置文件</span></span><br><span class="line">[root@centos7 php-7.4.11]<span class="comment">#cp /usr/local/src/php-7.4.11/php.ini-production /etc/php.ini</span></span><br><span class="line"></span><br><span class="line">[root@centos7 php-7.4.11]<span class="comment"># cd /apps/php74/etc</span></span><br><span class="line">[root@centos7 etc]<span class="comment"># cp php-fpm.conf.default php-fpm.conf</span></span><br><span class="line">[root@centos7 php-7.4.11]<span class="comment"># cd php-fpm.d/</span></span><br><span class="line">[root@centos7 php-fpm.d]<span class="comment"># cp www.conf.default www.conf</span></span><br><span class="line"></span><br><span class="line">[root@centos7 php-fpm.d]<span class="comment"># vim www.conf</span></span><br><span class="line">[root@centos7 php-fpm.d]<span class="comment"># grep &#x27;^[^;]&#x27; www.conf</span></span><br><span class="line">[www]</span><br><span class="line">user = www</span><br><span class="line">group = www</span><br><span class="line">listen = 127.0.0.1:9000</span><br><span class="line">pm = dynamic</span><br><span class="line">pm.max_children = 5</span><br><span class="line">pm.start_servers = 2</span><br><span class="line">pm.min_spare_servers = 1</span><br><span class="line">pm.max_spare_servers = 3</span><br><span class="line">pm.status_path = /pm_status</span><br><span class="line">ping.path = /ping</span><br><span class="line">access.log = <span class="built_in">log</span>/<span class="variable">$pool</span>.access.log</span><br><span class="line">slowlog = <span class="built_in">log</span>/<span class="variable">$pool</span>.log.slow</span><br><span class="line"></span><br><span class="line"><span class="comment">#创建用户</span></span><br><span class="line">[root@centos7 php-fpm.d]<span class="comment"># useradd -r -s /sbin/nologin www</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建访问日志文件路径</span></span><br><span class="line">[root@centos7 php-fpm.d]<span class="comment"># mkdir /apps/php74/log</span></span><br></pre></td></tr></table></figure>

<h5 id="启动并验证-php-fpm-服务"><a href="#启动并验证-php-fpm-服务" class="headerlink" title="启动并验证 php-fpm 服务"></a>启动并验证 php-fpm 服务</h5><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">[root@centos7 ~]<span class="comment"># /apps/php74/sbin/php-fpm -t</span></span><br><span class="line">[22-Oct-2020 10:55:19] NOTICE: configuration file /apps/php74/etc/php-fpm.conf <span class="built_in">test</span> is successful</span><br><span class="line"></span><br><span class="line">[root@centos7 ~]<span class="comment"># cp /usr/local/src/php-7.4.11/sapi/fpm/php-fpm.service /usr/lib/systemd/system/</span></span><br><span class="line">             </span><br><span class="line">[root@centos7 ~]<span class="comment"># systemctl daemon-reload</span></span><br><span class="line">[root@centos7 ~]<span class="comment"># systemctl enable --now php-fpm</span></span><br><span class="line"></span><br><span class="line">[root@centos7 php-7.4.11]<span class="comment"># ss -ntl</span></span><br><span class="line">LISTEN     0      128              127.0.0.1:9000       *:*</span><br><span class="line"></span><br><span class="line">[root@centos7 ~]<span class="comment"># pstree -p |grep php</span></span><br><span class="line">           |-php-fpm(16331)-+-php-fpm(16332)</span><br><span class="line">           |                `-php-fpm(16333)</span><br><span class="line">           </span><br><span class="line">[root@centos7 ~]<span class="comment"># ps -ef |grep php</span></span><br><span class="line">root      16331      1  0 12:46 ?        00:00:00 php-fpm: master process (/apps/php74/etc/php-fpm.conf)</span><br><span class="line">www       16332  16331  0 12:46 ?        00:00:00 php-fpm: pool www</span><br><span class="line">www       16333  16331  0 12:46 ?        00:00:00 php-fpm: pool www</span><br><span class="line">root      16403   1095  0 13:12 pts/0    00:00:00 grep --color=auto php</span><br></pre></td></tr></table></figure>

<h4 id="部署-Nginx"><a href="#部署-Nginx" class="headerlink" title="部署 Nginx"></a>部署 Nginx</h4><p><strong>在10.0.0.7主机部署nginx服务</strong></p>
<h5 id="编译安装-nginx"><a href="#编译安装-nginx" class="headerlink" title="编译安装 nginx"></a>编译安装 nginx</h5><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">[root@centos7 ~]<span class="comment"># yum -y install gcc pcre-devel openssl-devel zlib-devel</span></span><br><span class="line">[root@centos7 ~]<span class="comment"># cd /usr/local/src/</span></span><br><span class="line">[root@centos7 src]<span class="comment"># wget http://nginx.org/download/nginx-1.18.0.tar.gz</span></span><br><span class="line">[root@centos7 src]<span class="comment"># tar xf nginx-1.18.0.tar.gz </span></span><br><span class="line">[root@centos7 src]<span class="comment"># cd nginx-1.18.0/</span></span><br><span class="line">[root@centos7 nginx-1.18.0]<span class="comment"># ./configure --prefix=/apps/nginx \</span></span><br><span class="line">--user=www \</span><br><span class="line">--group=www \</span><br><span class="line">--with-http_ssl_module \</span><br><span class="line">--with-http_v2_module \</span><br><span class="line">--with-http_realip_module \</span><br><span class="line">--with-http_stub_status_module \</span><br><span class="line">--with-http_gzip_static_module \</span><br><span class="line">--with-pcre \</span><br><span class="line">--with-stream \</span><br><span class="line">--with-stream_ssl_module \</span><br><span class="line">--with-stream_realip_module</span><br><span class="line"></span><br><span class="line">[root@centos7 nginx-1.18.0]<span class="comment"># make &amp;&amp; make install</span></span><br></pre></td></tr></table></figure>

<h5 id="准备服务文件并启动-nginx"><a href="#准备服务文件并启动-nginx" class="headerlink" title="准备服务文件并启动 nginx"></a>准备服务文件并启动 nginx</h5><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ~]<span class="comment"># vim /usr/lib/systemd/system/nginx.service </span></span><br><span class="line">[Unit]</span><br><span class="line">Description=nginx - high performance web server</span><br><span class="line">Documentation=http://nginx.org/en/docs/</span><br><span class="line">After=network-online.target remote-fs.target nss-lookup.target</span><br><span class="line">Wants=network-online.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">Type=forking</span><br><span class="line">PIDFile=/apps/nginx/run/nginx.pid</span><br><span class="line">ExecStart=/apps/nginx/sbin/nginx -c /apps/nginx/conf/nginx.conf</span><br><span class="line">ExecReload=/bin/kill -s HUP <span class="variable">$MAINPID</span></span><br><span class="line">ExecStop=/bin/kill -s TERM <span class="variable">$MAINPID</span></span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line"></span><br><span class="line"><span class="comment">#创建目录</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># mkdir /apps/nginx/run/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#修改配置文件</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># vim /apps/nginx/conf/nginx.conf</span></span><br><span class="line">pid   /apps/nginx/run/nginx.pid;</span><br><span class="line"></span><br><span class="line">[root@centos7 ~]<span class="comment"># systemctl daemon-reload</span></span><br><span class="line">[root@centos7 ~]<span class="comment"># systemctl enable --now nginx</span></span><br><span class="line">Created symlink from /etc/systemd/system/multi-user.target.wants/nginx.service to /usr/lib/systemd/system/nginx.service.</span><br><span class="line"></span><br><span class="line">[root@centos7 ~]<span class="comment"># ss -ntl</span></span><br><span class="line">State     Recv-Q Send-Q       Local Address:Port   Peer Address:Port          </span><br><span class="line">LISTEN     0      128                     *:22                 *:*             </span><br><span class="line">LISTEN     0      100              127.0.0.1:25                 *:*             </span><br><span class="line">LISTEN     0      128              127.0.0.1:9000               *:*             </span><br><span class="line">LISTEN     0      128                     *:80                 *:*             </span><br><span class="line">LISTEN     0      128                   [::]:22             [::]:*             </span><br><span class="line">LISTEN     0      100                 [::1]:25             [::]:* </span><br></pre></td></tr></table></figure>

<h5 id="配置-Nginx-支持-fastcgi"><a href="#配置-Nginx-支持-fastcgi" class="headerlink" title="配置 Nginx 支持 fastcgi"></a>配置 Nginx 支持 fastcgi</h5><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">[root@centos7 ~]<span class="comment"># vim /apps/nginx/conf/nginx.conf</span></span><br><span class="line">[root@centos7 ~]<span class="comment"># grep -Ev &#x27;#|^$&#x27; /apps/nginx/conf/nginx.conf</span></span><br><span class="line">worker_processes  1;</span><br><span class="line">pid       /apps/nginx/run/nginx.pid;</span><br><span class="line">events &#123;</span><br><span class="line">   worker_connections  1024;</span><br><span class="line">&#125;</span><br><span class="line">http &#123;</span><br><span class="line">   include       mime.types;</span><br><span class="line">   default_type application/octet-stream;</span><br><span class="line">   sendfile       on;</span><br><span class="line">   keepalive_timeout  65;</span><br><span class="line">   server &#123;</span><br><span class="line">       listen       80;</span><br><span class="line">       server_name www.wang.org;  <span class="comment">#指定主机名</span></span><br><span class="line">       location / &#123;</span><br><span class="line">           root   /data/nginx/wordpress;  <span class="comment">#指定数据目录</span></span><br><span class="line">           index index.php index.html index.htm;          <span class="comment">#指定默认主页</span></span><br><span class="line">       &#125;</span><br><span class="line">       error_page   500 502 503 504 /50x.html;</span><br><span class="line">       location = /50x.html &#123;</span><br><span class="line">           root   html;</span><br><span class="line">       &#125;</span><br><span class="line">       location ~ \.php$ &#123;                         <span class="comment">#实现php-fpm</span></span><br><span class="line">           root           /data/nginx/wordpress;</span><br><span class="line">           fastcgi_pass   127.0.0.1:9000;</span><br><span class="line">           fastcgi_index index.php;</span><br><span class="line">           fastcgi_param SCRIPT_FILENAME  $document_root<span class="variable">$fastcgi_script_name</span>;</span><br><span class="line">           include       fastcgi_params;</span><br><span class="line">       &#125;</span><br><span class="line">       location ~ ^/(ping|pm_status)$ &#123;            <span class="comment">#实现状态页</span></span><br><span class="line">           include fastcgi_params;</span><br><span class="line">           fastcgi_pass 127.0.0.1:9000;</span><br><span class="line">           fastcgi_param SCRIPT_FILENAME $document_root<span class="variable">$fastcgi_script_name</span>;</span><br><span class="line">            <span class="comment">#fastcgi_param PATH_TRANSLATED $document_root$fastcgi_script_name; 此配置也可以</span></span><br><span class="line">       &#125; </span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">[root@centos7 ~]<span class="comment"># /apps/nginx/sbin/nginx -t</span></span><br><span class="line">nginx: the configuration file /apps/nginx/conf/nginx.conf syntax is ok</span><br><span class="line">nginx: configuration file /apps/nginx/conf/nginx.conf <span class="built_in">test</span> is successful</span><br><span class="line"></span><br><span class="line">[root@centos7 ~]<span class="comment"># systemctl reload nginx</span></span><br></pre></td></tr></table></figure>

<h5 id="准备-php-测试页"><a href="#准备-php-测试页" class="headerlink" title="准备 php 测试页"></a>准备 php 测试页</h5><p>准备测试页</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@centos7 ~]<span class="comment"># mkdir -p /data/nginx/wordpress</span></span><br><span class="line">[root@centos7 ~]<span class="comment"># vim /data/nginx/wordpress/test.php</span></span><br><span class="line">[root@centos7 ~]<span class="comment"># cat /data/nginx/wordpress/test.php</span></span><br><span class="line">&lt;?php</span><br><span class="line">phpinfo();</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>

<h5 id="验证-php-测试页"><a href="#验证-php-测试页" class="headerlink" title="验证 php 测试页"></a>验证 php 测试页</h5><p><img src="../../../../images/SRE/day28/151.jpg" alt="151"><br><img src="../../../../images/SRE/day28/152.jpg" alt="152"><br><img src="../../../../images/SRE/day28/153.jpg" alt="153"></p>
<h4 id="部署-WordPress"><a href="#部署-WordPress" class="headerlink" title="部署 WordPress"></a>部署 WordPress</h4><p>**在10.0.0.7主机部署 wordpress **</p>
<h5 id="准备-WordPress-文件"><a href="#准备-WordPress-文件" class="headerlink" title="准备 WordPress 文件"></a>准备 WordPress 文件</h5><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@centos7 ~]<span class="comment"># wget https://cn.wordpress.org/latest-zh_CN.tar.gz</span></span><br><span class="line"><span class="comment">#[root@centos7 ~]# tar xf wordpress-5.4.2-zh_CN.tar.gz</span></span><br><span class="line">[root@centos7 ~]<span class="comment"># tar xf latest-zh_CN.tar.gz</span></span><br><span class="line">[root@centos7 ~]<span class="comment"># mv wordpress/* /data/nginx/wordpress</span></span><br><span class="line">[root@centos7 ~]<span class="comment"># chown -R www.www /data/nginx/wordpress/</span></span><br></pre></td></tr></table></figure>

<h5 id="初始化web页面"><a href="#初始化web页面" class="headerlink" title="初始化web页面"></a>初始化web页面</h5><p>打开浏览器访问下面链接</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://www.wang.org/</span><br></pre></td></tr></table></figure>

<p><img src="../../../../images/SRE/day28/154.jpg" alt="154"><br><img src="../../../../images/SRE/day28/155.jpg" alt="155"><br><img src="../../../../images/SRE/day28/156.jpg" alt="156"><br><img src="../../../../images/SRE/day28/157.jpg" alt="157"><br><img src="../../../../images/SRE/day28/158.jpg" alt="158"><br><img src="../../../../images/SRE/day28/159.jpg" alt="159"><br><img src="../../../../images/SRE/day28/160.jpg" alt="160"></p>
<h5 id="验证发表的文章"><a href="#验证发表的文章" class="headerlink" title="验证发表的文章"></a>验证发表的文章</h5><p><img src="../../../../images/SRE/day28/161.jpg" alt="161"></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#可以看到上传的图片</span></span><br><span class="line">[root@centos7 ~]<span class="comment"># tree /data/nginx/wordpress/wp-content/uploads/</span></span><br><span class="line">/data/nginx/wordpress/wp-content/uploads/</span><br><span class="line">└── 2020</span><br><span class="line">   └── 10</span><br><span class="line">       └── magedu.jpg</span><br><span class="line">       </span><br><span class="line">2 directories, 1 file</span><br></pre></td></tr></table></figure>

<h5 id="配置允许上传大文件"><a href="#配置允许上传大文件" class="headerlink" title="配置允许上传大文件"></a>配置允许上传大文件</h5><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#注意:默认只支持1M以下文件上传,要利用php程序上传大图片,还需要修改下面三项配置,最大上传由三项值的最小值决定</span></span><br><span class="line"><span class="comment">#直接上传大于1M文件,会出现下面413错误</span></span><br><span class="line">[root@centos7 ~]<span class="comment"># tail -f /apps/nginx/logs/access.log</span></span><br><span class="line">10.0.0.1 - - [27/Nov/2020:12:21:16 +0800] <span class="string">&quot;POST /wp-admin/async-upload.php HTTP/1.1&quot;</span> 413 585 <span class="string">&quot;http://10.0.0.7/wp-admin/upload.php&quot;</span> <span class="string">&quot;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/87.0.4280.67 Safari/537.36 Edg/87.0.664.47&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># nginx上传文件大小限制</span></span><br><span class="line">[root@centos7 ~]<span class="comment"># vim /apps/nginx/conf/nginx.conf</span></span><br><span class="line">server &#123;</span><br><span class="line">       client_max_body_size 10m; <span class="comment">#默认值为1M</span></span><br><span class="line">.....</span><br><span class="line"></span><br><span class="line"><span class="comment"># php上传文件大小限制</span></span><br><span class="line">[root@centos7 ~]<span class="comment"># vim /etc/php.ini</span></span><br><span class="line">post_max_size = 30M   <span class="comment">#默认值为8M</span></span><br><span class="line">upload_max_filesize = 20M  <span class="comment">#默认值为2M</span></span><br><span class="line"></span><br><span class="line">[root@centos7 ~]<span class="comment"># systemctl restart nginx php-fpm</span></span><br></pre></td></tr></table></figure>

<h5 id="安全加固"><a href="#安全加固" class="headerlink" title="安全加固"></a>安全加固</h5><p><img src="../../../../images/SRE/day28/162.jpg" alt="162"></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">[root@centos7 ~]<span class="comment"># vim /apps/nginx/conf/nginx.conf</span></span><br><span class="line">[root@centos7 ~]<span class="comment"># grep -Ev &#x27;#|^$&#x27; /apps/nginx/conf/nginx.conf</span></span><br><span class="line">worker_processes  1;</span><br><span class="line">pid       /apps/nginx/run/nginx.pid;</span><br><span class="line">events &#123;</span><br><span class="line">   worker_connections  1024;</span><br><span class="line">&#125;</span><br><span class="line">http &#123;</span><br><span class="line">   include       mime.types;</span><br><span class="line">   default_type application/octet-stream;</span><br><span class="line">   sendfile       on;  </span><br><span class="line">   keepalive_timeout  65;</span><br><span class="line">   server &#123;</span><br><span class="line">       listen       80;</span><br><span class="line">       server_name www.wang.org;</span><br><span class="line">       server_tokens off; <span class="comment">#添加此行</span></span><br><span class="line">       location / &#123;</span><br><span class="line">           root   /data/nginx/wordpress;</span><br><span class="line">           index index.php index.html index.htm;</span><br><span class="line">       &#125;</span><br><span class="line">       error_page   500 502 503 504 /50x.html;</span><br><span class="line">       location = /50x.html &#123;</span><br><span class="line">           root   html;</span><br><span class="line">       &#125;</span><br><span class="line">       location ~ \.php$ &#123;</span><br><span class="line">           root           /data/nginx/wordpress;</span><br><span class="line">           fastcgi_pass   127.0.0.1:9000;</span><br><span class="line">           fastcgi_index index.php;</span><br><span class="line">           fastcgi_param SCRIPT_FILENAME  $document_root<span class="variable">$fastcgi_script_name</span>;</span><br><span class="line">           include       fastcgi_params;</span><br><span class="line">           fastcgi_hide_header X-Powered-By;  <span class="comment">#添加此行</span></span><br><span class="line">       &#125;</span><br><span class="line">       location ~ ^/(ping|pm_status)$ &#123;</span><br><span class="line">           include fastcgi_params;</span><br><span class="line">           fastcgi_pass 127.0.0.1:9000;</span><br><span class="line">           fastcgi_param PATH_TRANSLATED $document_root<span class="variable">$fastcgi_script_name</span>;</span><br><span class="line">       &#125; </span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">[root@centos7 ~]<span class="comment"># systemctl reload nginx</span></span><br></pre></td></tr></table></figure>

<p><img src="../../../../images/SRE/day28/163.jpg" alt="163"></p>
<h5 id="配置-php-开启-opcache-加速"><a href="#配置-php-开启-opcache-加速" class="headerlink" title="配置 php 开启 opcache 加速"></a>配置 php 开启 opcache 加速</h5><p><strong>在10.0.0.7主机进行以下修改配置</strong></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#编辑php.ini配置文件</span></span><br><span class="line">[root@centos7 ~]<span class="comment"># vim /etc/php.ini</span></span><br><span class="line">[opcache]</span><br><span class="line">; Determines <span class="keyword">if</span> Zend OPCache is enabled</span><br><span class="line">zend_extension=opcache.so</span><br><span class="line">opcache.enable=1</span><br><span class="line">.....</span><br><span class="line"></span><br><span class="line">[root@centos7 ~]<span class="comment"># systemctl restart php-fpm</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#访问测试页确认开启opcache加速</span></span><br></pre></td></tr></table></figure>

<p><img src="../../../../images/SRE/day28/164.jpg" alt="164"></p>
<h4 id="PHP-扩展session模块支持redis"><a href="#PHP-扩展session模块支持redis" class="headerlink" title="PHP 扩展session模块支持redis"></a>PHP 扩展session模块支持redis</h4><p>PECL是 PHP 扩展的存储库，提供用于下载和开发 PHP 扩展的所有已知扩展和托管功能的目录</p>
<p>官方链接: <a target="_blank" rel="noopener" href="http://pecl.php.net/package-stats.php">http://pecl.php.net/package-stats.php</a></p>
<p>github: <a target="_blank" rel="noopener" href="https://github.com/phpredis/phpredis">https://github.com/phpredis/phpredis</a></p>
<p>github安装文档: <a target="_blank" rel="noopener" href="https://github.com/phpredis/phpredis/blob/develop/INSTALL.markdown">https://github.com/phpredis/phpredis/blob/develop/INSTALL.markdown</a></p>
<p>开始在 PHP 中使用 Redis 前， 需要确保已经安装了 redis 服务及 PHP redis 驱动， </p>
<p>PHP redis 驱动下载地址为:<a target="_blank" rel="noopener" href="https://github.com/phpredis/phpredis/releases">https://github.com/phpredis/phpredis/releases</a></p>
<p><img src="../../../../images/SRE/day28/165.jpg" alt="165"></p>
<h5 id="编译安装phpredis模块f"><a href="#编译安装phpredis模块f" class="headerlink" title="编译安装phpredis模块f"></a>编译安装phpredis模块f</h5><p><strong>在10.0.0.7主机进行以下编译安装phpredis模块</strong></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line">[root@centos7 ~]<span class="comment"># cd /usr/local/src</span></span><br><span class="line">[root@centos7 src]<span class="comment"># ls</span></span><br><span class="line">[root@centos7 src]<span class="comment"># wget http://pecl.php.net/get/redis-5.3.1.tgz</span></span><br><span class="line">[root@centos7 src]<span class="comment"># tar xf redis-5.3.1.tgz </span></span><br><span class="line">[root@centos7 src]<span class="comment"># cd redis-5.3.1/</span></span><br><span class="line">[root@centos7 redis-5.3.1]<span class="comment"># ls</span></span><br><span class="line">arrays.markdown   config.m4   INSTALL.markdown README.markdown     redis.c     </span><br><span class="line">redis_sentinel.c  sentinel_library.h cluster_library.c config.w32 liblzf redis_array.c</span><br><span class="line">redis_cluster.c   redis_sentinel.h   sentinel.markdown cluster_library.h COPYING     library.c         redis_array.h      redis_cluster.h   redis_session.c     tests</span><br><span class="line">cluster.markdown  crc16.h     library.h         redis_array_impl.c redis_commands.c </span><br><span class="line">redis_session.h common.h           CREDITS     php_redis.h       redis_array_impl.h redis_commands.h sentinel_library.c</span><br><span class="line"></span><br><span class="line"><span class="comment">#如果是yum安装php,需要执行yum -y install php-cli php-devel</span></span><br><span class="line"><span class="comment">#以下为编译安装php的对应方式</span></span><br><span class="line">[root@centos7 redis-5.3.1]<span class="comment"># /apps/php74/bin/phpize </span></span><br><span class="line">Configuring <span class="keyword">for</span>:</span><br><span class="line">PHP Api Version:         20190902</span><br><span class="line">Zend Module Api No:      20190902</span><br><span class="line">Zend Extension Api No:   320190902</span><br><span class="line">Cannot find autoconf. Please check your autoconf installation and the <span class="comment">#报错提示</span></span><br><span class="line"><span class="variable">$PHP_AUTOCONF</span> environment variable. Then, rerun this script.</span><br><span class="line"></span><br><span class="line">[root@centos7 redis-5.3.1]<span class="comment"># yum -y install autoconf</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#重新执行成功</span></span><br><span class="line">[root@centos7 redis-5.3.1]<span class="comment"># /apps/php74/bin/phpize </span></span><br><span class="line">Configuring <span class="keyword">for</span>:</span><br><span class="line">PHP Api Version:         20190902</span><br><span class="line">Zend Module Api No:      20190902</span><br><span class="line">Zend Extension Api No:   320190902</span><br><span class="line"></span><br><span class="line"><span class="comment">#查看生成configure脚本</span></span><br><span class="line">[root@centos7 redis-5.3.1]<span class="comment"># ls </span></span><br><span class="line">arrays.markdown   common.h     COPYING           library.h           </span><br><span class="line">redis_array_impl.h redis_sentinel.c   sentinel_library.h</span><br><span class="line">autom4te.cache     config.h.in   crc16.h           php_redis.h         redis.c   </span><br><span class="line">          redis_sentinel.h   sentinel.markdown</span><br><span class="line">build             config.m4     CREDITS           README.markdown     </span><br><span class="line">redis_cluster.c     redis_session.c     tests</span><br><span class="line">cluster_library.c configure     INSTALL.markdown redis_array.c       </span><br><span class="line">redis_cluster.h     redis_session.h</span><br><span class="line">cluster_library.h configure.ac liblzf           redis_array.h       </span><br><span class="line">redis_commands.c   run-tests.php</span><br><span class="line">cluster.markdown   config.w32   library.c         redis_array_impl.c </span><br><span class="line">redis_commands.h   sentinel_library.c</span><br><span class="line"></span><br><span class="line"><span class="comment">#如果是基于yum安装php,无需指定--with-php-config</span></span><br><span class="line">[root@centos7 redis-5.3.1]<span class="comment"># ./configure --with-php-config=/apps/php74/bin/php-config</span></span><br><span class="line">[root@centos7 redis-5.3.1]<span class="comment"># make -j 8 &amp;&amp; make install</span></span><br><span class="line">.....</span><br><span class="line">See any operating system documentation about shared libraries <span class="keyword">for</span></span><br><span class="line">more information, such as the ld(1) and ld.so(8) manual pages.</span><br><span class="line">----------------------------------------------------------------------</span><br><span class="line">Build complete.</span><br><span class="line">Don<span class="string">&#x27;t forget to run &#x27;</span>make <span class="built_in">test</span><span class="string">&#x27;.</span></span><br><span class="line"><span class="string">Installing shared extensions:     /apps/php74/lib/php/extensions/no-debug-zts-20190902/</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">#验证redis模块</span></span><br><span class="line"><span class="string">#yum安装php,模块文件默认存放在 /usr/lib64/php/modules/redis.so</span></span><br><span class="line"><span class="string">[root@centos7 redis-5.3.1]# ll /apps/php74/lib/php/extensions/no-debug-zts-20190902/</span></span><br><span class="line"><span class="string">total 9584</span></span><br><span class="line"><span class="string">-rwxr-xr-x 1 root root 4647668 Oct 22 10:44 opcache.a</span></span><br><span class="line"><span class="string">-rwxr-xr-x 1 root root 2509416 Oct 22 10:44 opcache.so</span></span><br><span class="line"><span class="string">-rwxr-xr-x 1 root root 2651320 Oct 22 12:10 redis.so</span></span><br></pre></td></tr></table></figure>

<h5 id="编辑php配置文件支持redis"><a href="#编辑php配置文件支持redis" class="headerlink" title="编辑php配置文件支持redis"></a>编辑php配置文件支持redis</h5><p><strong>在10.0.0.7主机进行以下修改配置</strong></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#编辑php.ini配置文件，扩展redis.so模块</span></span><br><span class="line">[root@centos7 ~]<span class="comment"># vim /etc/php.ini</span></span><br><span class="line">.....</span><br><span class="line"><span class="comment">#extension=/apps/php74/lib/php/extensions/no-debug-zts-20190902/redis.so</span></span><br><span class="line">extension=redis.so    <span class="comment">#文件最后一行添加此行,路径可省略</span></span><br><span class="line"></span><br><span class="line">[root@centos7 ~]<span class="comment"># systemctl restart php-fpm</span></span><br></pre></td></tr></table></figure>

<h5 id="验证加载-redis-模块"><a href="#验证加载-redis-模块" class="headerlink" title="验证加载 redis 模块"></a>验证加载 redis 模块</h5><p>访问测试页确认redis模块开启</p>
<p><img src="../../../../images/SRE/day28/166.jpg" alt="166"></p>
<h5 id="安装和配置-redis-服务"><a href="#安装和配置-redis-服务" class="headerlink" title="安装和配置 redis 服务"></a>安装和配置 redis 服务</h5><p><strong>在10.0.0.17主机进行安装redis 服务</strong></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#在10.0.0.17主机安装redis服务</span></span><br><span class="line">[root@centos7 ~]<span class="comment"># yum -y install redis</span></span><br><span class="line">[root@centos7 ~]<span class="comment"># vim /etc/redis.conf</span></span><br><span class="line"><span class="built_in">bind</span> 0.0.0.0</span><br><span class="line">requirepass 123456</span><br><span class="line"></span><br><span class="line">[root@centos7 ~]<span class="comment"># systemctl enable --now redis</span></span><br><span class="line">[root@centos7 ~]<span class="comment"># ss -tnl</span></span><br><span class="line">[root@centos7 ~]<span class="comment"># ss -tnl</span></span><br><span class="line">State     Recv-Q Send-Q       Local Address:Port   Peer Address:Port          </span><br><span class="line">LISTEN     0      128             *:22                   *:*             </span><br><span class="line">LISTEN     0      100      127.0.0.1:25                   *:*             </span><br><span class="line">LISTEN     0      128             *:6379                 *:*             </span><br><span class="line">LISTEN     0      128           [::]:22               [::]:*             </span><br><span class="line">LISTEN     0      100         [::1]:25               [::]:*             </span><br><span class="line">LISTEN     0      70           [::]:33060             [::]:*             </span><br><span class="line">LISTEN     0      128           [::]:3306             [::]:*</span><br></pre></td></tr></table></figure>

<h5 id="配置-php-支持-redis-保存-session"><a href="#配置-php-支持-redis-保存-session" class="headerlink" title="配置 php 支持 redis 保存 session"></a>配置 php 支持 redis 保存 session</h5><p><strong>在10.0.0.7 主机进行以下配置</strong></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#在10.0.0.7主机配置php的session保存在redis服务</span></span><br><span class="line">[root@centos7 ~]<span class="comment"># vim /etc/php.ini</span></span><br><span class="line">[Session]</span><br><span class="line">; Handler used to store/retrieve data.</span><br><span class="line">; http://php.net/session.save-handler</span><br><span class="line">session.save_handler = redis</span><br><span class="line">session.save_path = <span class="string">&quot;tcp://10.0.0.17:6379?auth=123456&quot;</span></span><br><span class="line"></span><br><span class="line">[root@centos7 ~]<span class="comment"># systemctl restart php-fpm</span></span><br></pre></td></tr></table></figure>

<p><img src="../../../../images/SRE/day28/167.jpg" alt="167"></p>
<h5 id="准备-php实现-session-的测试页面"><a href="#准备-php实现-session-的测试页面" class="headerlink" title="准备 php实现 session 的测试页面"></a>准备 php实现 session 的测试页面</h5><p><strong>在10.0.0.7主机进行准备相关文件</strong></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">[root@centos7 ~]<span class="comment">#cat /data/nginx/wordpress/session.php</span></span><br><span class="line">&lt;?php</span><br><span class="line">session_start();</span><br><span class="line">//redis用session_id作为key 并且是以string的形式存储</span><br><span class="line"><span class="variable">$redisKey</span> = <span class="string">&#x27;PHPREDIS_SESSION:&#x27;</span> . session_id();</span><br><span class="line"></span><br><span class="line">// SESSION 赋值测试</span><br><span class="line"><span class="variable">$_SESSION</span>[<span class="string">&#x27;message&#x27;</span>] = <span class="string">&quot;Hello, I&#x27;m in redis&quot;</span>;</span><br><span class="line"><span class="variable">$_SESSION</span>[<span class="string">&#x27;arr&#x27;</span>] = [1, 2, 3, 4, 5, 6];</span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="variable">$_SESSION</span>[<span class="string">&quot;message&quot;</span>] , <span class="string">&quot;&lt;br/&gt;&quot;</span>;</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;Redis key =   &quot;</span> . <span class="variable">$redisKey</span> . <span class="string">&quot;&lt;br/&gt;&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;以下是从Redis获取的数据&quot;</span>, <span class="string">&quot;&lt;br/&gt;&quot;</span>;</span><br><span class="line">// 取数据<span class="string">&#x27;</span></span><br><span class="line"><span class="string">$redis = new Redis();</span></span><br><span class="line"><span class="string">$redis-&gt;connect(&#x27;</span>10.0.0.17<span class="string">&#x27;, 6379);</span></span><br><span class="line"><span class="string">$redis-&gt;auth(&#x27;</span>123456<span class="string">&#x27;);</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">echo $redis-&gt;get($redisKey);</span></span><br><span class="line"><span class="string">?&gt;</span></span><br></pre></td></tr></table></figure>

<h5 id="访问-web-页面测试实现session保存在redis服务"><a href="#访问-web-页面测试实现session保存在redis服务" class="headerlink" title="访问 web 页面测试实现session保存在redis服务"></a>访问 web 页面测试实现session保存在redis服务</h5><p><img src="../../../../images/SRE/day28/168.jpg" alt="168"></p>
<h5 id="redis-主机验证-session-数据"><a href="#redis-主机验证-session-数据" class="headerlink" title="redis 主机验证 session 数据"></a>redis 主机验证 session 数据</h5><p><strong>在10.0.0.17主机进行验证</strong></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@centos7 ~]<span class="comment"># redis-cli -h 10.0.0.17 -a 123456</span></span><br><span class="line">10.0.0.17:6379&gt; keys *</span><br><span class="line">1) <span class="string">&quot;PHPREDIS_SESSION:ad3nujfqfvcltkg2ml4snsf72h&quot;</span></span><br><span class="line">10.0.0.17:6379&gt; get PHPREDIS_SESSION:ad3nujfqfvcltkg2ml4snsf72h</span><br><span class="line"><span class="string">&quot;message|s:19:\&quot;Hello, I&#x27;m in redis\&quot;;arr|a:6:</span></span><br><span class="line"><span class="string">&#123;i:0;i:1;i:1;i:2;i:2;i:3;i:3;i:4;i:4;i:5;i:5;i:6;&#125;&quot;</span></span><br></pre></td></tr></table></figure>

<h3 id="项目实战：利用-LNMP-实现可道云私有云"><a href="#项目实战：利用-LNMP-实现可道云私有云" class="headerlink" title="项目实战：利用 LNMP 实现可道云私有云"></a>项目实战：利用 LNMP 实现可道云私有云</h3><p>可道云，原名芒果云，是基于Web技术的私有云在线文档管理解决方案。Kod，读音通code，意为“代码，编码”，中文名为“可道”。</p>
<p>官网： <a target="_blank" rel="noopener" href="http://kodcloud.com/">http://kodcloud.com/</a></p>
<h4 id="环境说明"><a href="#环境说明" class="headerlink" title="环境说明"></a>环境说明</h4><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">#部署规划：</span><br><span class="line">10.0.0.100：Nginx,php-fpm,kodbox</span><br><span class="line">10.0.0.8：MySQL8.0,Redis5.0</span><br><span class="line">#可道云的缓存可以由可道云程序自身指定为Redis存放</span><br></pre></td></tr></table></figure>

<p><img src="../../../../images/SRE/day28/169.jpg" alt="169"></p>
<h4 id="准备-MySQL-数据库"><a href="#准备-MySQL-数据库" class="headerlink" title="准备 MySQL 数据库"></a>准备 MySQL 数据库</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[root@ubuntu2004 ~]<span class="comment"># apt -y install mysql-server</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># yum -y install mysql-server</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># systemctl enable --now mysqld</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># mysql</span></span><br><span class="line"></span><br><span class="line">mysql&gt; create database kodbox;</span><br><span class="line">Query OK, 1 row affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; create user kodbox@<span class="string">&#x27;10.0.0.%&#x27;</span> identified by <span class="string">&#x27;123456&#x27;</span>;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; grant all on kodbox.* to kodbox@<span class="string">&#x27;10.0.0.%&#x27;</span>;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br></pre></td></tr></table></figure>

<h4 id="准备-Redis-服务"><a href="#准备-Redis-服务" class="headerlink" title="准备 Redis 服务"></a>准备 Redis 服务</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@ubuntu2004 ~]<span class="comment"># apt -y install redis</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># yum -y install redis</span></span><br><span class="line"></span><br><span class="line">[root@ubuntu2004 ~]<span class="comment"># vim /etc/redis/redis.conf</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># vim /etc/redis.conf</span></span><br><span class="line"><span class="built_in">bind</span> 0.0.0.0 <span class="comment">#修改此行</span></span><br><span class="line"></span><br><span class="line">[root@centos8 ~]<span class="comment"># systemctl enable --now redis</span></span><br></pre></td></tr></table></figure>

<h4 id="准备-Nginx-服务"><a href="#准备-Nginx-服务" class="headerlink" title="准备 Nginx 服务"></a>准备 Nginx 服务</h4><p>范例： Ubuntu 20.04 配置 Nginx</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">[root@ubuntu2004 ~]<span class="comment"># apt -y install nginx </span></span><br><span class="line">[root@ubuntu2004 ~]<span class="comment"># vim /etc/nginx/sites-enabled/default</span></span><br><span class="line">server &#123;</span><br><span class="line">.....</span><br><span class="line">   root /data/html;</span><br><span class="line">   client_max_body_size 200M;</span><br><span class="line">   location ~ \.php$ &#123;</span><br><span class="line">       include snippets/fastcgi-php.conf;</span><br><span class="line">       root /data/html;</span><br><span class="line">       fastcgi_index index.php;</span><br><span class="line">    <span class="comment">#</span></span><br><span class="line">    <span class="comment">#   # With php-fpm (or other unix sockets):</span></span><br><span class="line">    <span class="comment">#   fastcgi_pass unix:/var/run/php/php7.4-fpm.sock;</span></span><br><span class="line">    <span class="comment">#   # With php-cgi (or other tcp sockets):</span></span><br><span class="line">       fastcgi_param SCRIPT_FILENAME  $document_root<span class="variable">$fastcgi_script_name</span>;</span><br><span class="line">       fastcgi_pass 127.0.0.1:9000;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>范例： CentOS 配置 Nginx</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">[root@centos7 ~]<span class="comment"># yum -y install nginx</span></span><br><span class="line">[root@centos7 ~]<span class="comment"># mkdir -pv /data/html </span></span><br><span class="line"><span class="comment">#创建配置文件</span></span><br><span class="line">[root@centos7 ~]<span class="comment"># vim /etc/nginx/conf.d/kod.conf</span></span><br><span class="line">server &#123;</span><br><span class="line">   listen 80;</span><br><span class="line">   server_name cloud.wang.org;</span><br><span class="line">   root /data/html;</span><br><span class="line">   client_max_body_size 200M;</span><br><span class="line">   location / &#123;</span><br><span class="line">       index index.php index.html;</span><br><span class="line">   &#125;</span><br><span class="line">   location ~ \.php$ &#123;</span><br><span class="line">       fastcgi_pass   127.0.0.1:9000;</span><br><span class="line">       fastcgi_index index.php;</span><br><span class="line">       fastcgi_param SCRIPT_FILENAME  $document_root<span class="variable">$fastcgi_script_name</span>;</span><br><span class="line">       include       fastcgi_params;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">[root@centos7 ~]<span class="comment"># systemctl --now enabled nginx</span></span><br></pre></td></tr></table></figure>

<h4 id="安装-php-fpm-和配置支持-redis"><a href="#安装-php-fpm-和配置支持-redis" class="headerlink" title="安装 php-fpm 和配置支持 redis"></a>安装 php-fpm 和配置支持 redis</h4><h5 id="Ubuntu20-04-php-支持-Redis"><a href="#Ubuntu20-04-php-支持-Redis" class="headerlink" title="Ubuntu20.04 php 支持 Redis"></a>Ubuntu20.04 php 支持 Redis</h5><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#安装php-fpm相关包</span></span><br><span class="line">[root@ubuntu2004 ~]<span class="comment"># apt -y install php7.4-fpm libapache2-mod-php7.4 php7.4-mysql php7.4-json php7.4-xml php7.4-mbstring php7.4-zip php7.4-gd php7.4-curl php-redis</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#如果不安装上面的php-redis包,也可以编译redis模块,可以执行下面操作</span></span><br><span class="line">[root@ubuntu2004 ~]<span class="comment"># apt -y install gcc make autoconf libpcre3 libpcre3-dev openssl libssl-dev zlib1g-dev libxml2-dev pkg-config libsqlite3-dev libtool</span></span><br><span class="line">[root@ubuntu2004 ~]<span class="comment"># wget https://pecl.php.net/get/redis-5.3.7.tgz</span></span><br><span class="line">[root@ubuntu2004 ~]<span class="comment"># tar xf redis-5.3.7.tgz </span></span><br><span class="line">[root@ubuntu2004 ~]<span class="comment"># cd redis-5.3.7/</span></span><br><span class="line">[root@ubuntu2004 redis-5.3.7]<span class="comment"># /apps/php/bin/phpize &amp;&amp; ./configure --with-php-config=/apps/php/bin/php-config &amp;&amp; make -j 2 &amp;&amp; make install</span></span><br><span class="line">[root@ubuntu2004 redis-5.3.7]<span class="comment"># ls /apps/php/lib/php/extensions/no-debug-zts-20190902</span></span><br><span class="line">opcache.a opcache.so redis.so</span><br><span class="line"></span><br><span class="line">[root@ubuntu2004 ~]<span class="comment"># vim /etc/php/7.4/fpm/php.ini</span></span><br><span class="line">date.timezone = Asia/Shanghai</span><br><span class="line">post_max_size = 8M</span><br><span class="line">upload_max_filesize = 100M</span><br><span class="line">display_errors = On</span><br><span class="line">error_log = syslog</span><br><span class="line">extension=/apps/php/lib/php/extensions/no-debug-zts-20190902/redis.so</span><br><span class="line"></span><br><span class="line">[root@ubuntu2004 ~]<span class="comment"># vim /etc/php/7.4/fpm/pool.d/www.conf</span></span><br><span class="line">user = www-data</span><br><span class="line">group = www-data</span><br><span class="line">listen = 127.0.0.1:9000</span><br><span class="line"></span><br><span class="line">[root@ubuntu2004 ~]<span class="comment"># systemctl restart php7.4-fpm.service </span></span><br></pre></td></tr></table></figure>

<h5 id="CentOS8-php-支持-redis"><a href="#CentOS8-php-支持-redis" class="headerlink" title="CentOS8 php 支持 redis"></a>CentOS8 php 支持 redis</h5><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#利用remi源安装php7.4和redis相关包</span></span><br><span class="line">[root@rocky8 ~]<span class="comment"># yum install -y https://mirrors.tuna.tsinghua.edu.cn/remi/enterprise/remi-release-8.rpm</span></span><br><span class="line">[root@rocky8 ~]<span class="comment"># yum install -y php74-php-fpm php74-php-mbstring php74-php-json php74-php-xml php74-php-gd php74-php-mysqlnd php74-php-cli php74-php-devel php74-php-pecl-redis</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#利用内置源安装php相关包,但缺少redis相关模块,需要编译安装redis模块</span></span><br><span class="line">[root@rocky8 ~]<span class="comment"># yum -y install php-fpm php-mbstring php-json php-xml php-gd php-mysqlnd</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#修改php配置文件</span></span><br><span class="line">[root@rocky8 ~]<span class="comment"># vim /etc/php.ini</span></span><br><span class="line">post_max_size=200M</span><br><span class="line">upload_max_filesize =200M</span><br><span class="line"></span><br><span class="line">[root@rocky8 ~]<span class="comment"># vim /etc/php-fpm.d/www.conf</span></span><br><span class="line">user = nginx</span><br><span class="line">group = nginx</span><br><span class="line">listen = 127.0.0.1:9000</span><br><span class="line"></span><br><span class="line"><span class="comment">#安装编译相关包</span></span><br><span class="line">[root@rocky8 ~]<span class="comment"># yum -y install php-cli php-devel</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#编译redis模块</span></span><br><span class="line">[root@rocky8 ~]<span class="comment"># wget https://pecl.php.net/get/redis-5.3.7.tgz</span></span><br><span class="line">[root@rocky8 ~]<span class="comment"># tar xf redis-5.3.7.tgz</span></span><br><span class="line">[root@rocky8 ~]<span class="comment"># cd redis-5.3.7/</span></span><br><span class="line">[root@rocky8 redis-5.3.7]<span class="comment"># cat INSTALL</span></span><br><span class="line">[root@rocky8 redis-5.3.7]<span class="comment"># phpize</span></span><br><span class="line">[root@rocky8 redis-5.3.7]<span class="comment"># ./configure</span></span><br><span class="line">[root@rocky8 redis-5.3.7]<span class="comment"># make -j 2 &amp;&amp; make install</span></span><br><span class="line"></span><br><span class="line">......</span><br><span class="line">----------------------------------------------------------------------</span><br><span class="line">Build complete.</span><br><span class="line">Don<span class="string">&#x27;t forget to run &#x27;</span>make <span class="built_in">test</span><span class="string">&#x27;.</span></span><br><span class="line"><span class="string">Installing shared extensions:     /usr/lib64/php/modules/</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">[root@rocky8 ~]# ll /usr/lib64/php/modules/redis.so </span></span><br><span class="line"><span class="string">-rwxr-xr-x 1 root root 3530824 Feb 26 10:21 /usr/lib64/php/modules/redis.so</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">[root@rocky8 ~]# vim /etc/php.d/31-redis.ini</span></span><br><span class="line"><span class="string">extension=redis</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">[root@rocky8 ~]# systemctl enable --now php-fpm</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">#测试连接</span></span><br><span class="line"><span class="string">[root@rocky8 ~]# vim /data/html/redis.php </span></span><br><span class="line"><span class="string">&lt;?php</span></span><br><span class="line"><span class="string">   //连接本地的 Redis 服务</span></span><br><span class="line"><span class="string">   $redis = new Redis();</span></span><br><span class="line"><span class="string">   $redis-&gt;connect(&#x27;</span>127.0.0.1<span class="string">&#x27;, 6379);</span></span><br><span class="line"><span class="string">   //$redis-&gt;auth(&#x27;</span>123456<span class="string">&#x27;);</span></span><br><span class="line"><span class="string">   echo &quot;Connection to Redis sucessfully! &quot;;</span></span><br><span class="line"><span class="string">   //查看服务是否运行</span></span><br><span class="line"><span class="string">   echo &quot;Server is running: &quot; . $redis-&gt;ping();</span></span><br><span class="line"><span class="string">   </span></span><br><span class="line"><span class="string">[root@rocky8 ~]# curl http://10.0.0.8/redis.php</span></span><br><span class="line"><span class="string">Connection to server sucessfully! Server is running: 1</span></span><br></pre></td></tr></table></figure>

<h5 id="CentOS-7-php-支持-redis"><a href="#CentOS-7-php-支持-redis" class="headerlink" title="CentOS 7 php 支持 redis"></a>CentOS 7 php 支持 redis</h5><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[root@centos7 ~]<span class="comment"># yum install https://mirror.tuna.tsinghua.edu.cn/remi/enterprise/remi-release-7.rpm</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#安装必要的包</span></span><br><span class="line">[root@centos7 ~]<span class="comment">#yum -y install php74-php-fpm php74-php-mysqlnd php74-php-pecl-redis5 php74-php-mbstring php74-php-xml php74-php-gd</span></span><br><span class="line"></span><br><span class="line">[root@centos7 ~]<span class="comment"># vim /etc/opt/remi/php74/php-fpm.d/www.conf</span></span><br><span class="line">user = nginx</span><br><span class="line">group = nginx</span><br><span class="line">listen = 127.0.0.1:9000</span><br><span class="line"></span><br><span class="line"><span class="comment">#文件最后修改下面两行</span></span><br><span class="line">php_value[session.save_handler] = redis</span><br><span class="line">php_value[session.save_path]    = <span class="string">&quot;tcp://10.0.0.8:6379&quot;</span></span><br></pre></td></tr></table></figure>

<h4 id="准备可道云程序"><a href="#准备可道云程序" class="headerlink" title="准备可道云程序"></a>准备可道云程序</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@centos7 ~]<span class="comment"># wget https://static.kodcloud.com/update/download/kodbox.1.20.zip</span></span><br><span class="line">[root@centos7 ~]<span class="comment"># unzip kodbox.1.20.zip -d /data/html</span></span><br><span class="line">[root@centos7 ~]<span class="comment"># chown -R nginx.nginx /data/html</span></span><br></pre></td></tr></table></figure>

<h4 id="初始化和登录可道云"><a href="#初始化和登录可道云" class="headerlink" title="初始化和登录可道云"></a>初始化和登录可道云</h4><p><img src="../../../../images/SRE/day28/170.jpg" alt="170"><br><img src="../../../../images/SRE/day28/171.jpg" alt="171"><br><img src="../../../../images/SRE/day28/172.jpg" alt="172"><br><img src="../../../../images/SRE/day28/173.jpg" alt="173"><br><img src="../../../../images/SRE/day28/174.jpg" alt="174"><br><img src="../../../../images/SRE/day28/175.jpg" alt="175"><br><img src="../../../../images/SRE/day28/176.jpg" alt="176"><br><img src="../../../../images/SRE/day28/177.jpg" alt="177"></p>
<h4 id="验证数据库和-session-信息"><a href="#验证数据库和-session-信息" class="headerlink" title="验证数据库和 session 信息"></a>验证数据库和 session 信息</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ~]<span class="comment"># redis-cli </span></span><br><span class="line">127.0.0.1:6379&gt; keys *</span><br><span class="line">1) <span class="string">&quot;32b4b_UserModel_getInfoFull_ID_1&quot;</span></span><br><span class="line">2) <span class="string">&quot;32b4b_SystemOption_System.taskList&quot;</span></span><br><span class="line">3) <span class="string">&quot;32b4b_SystemOption_System.autoTask&quot;</span></span><br><span class="line">4) <span class="string">&quot;32b4b_UserOption_User.noticeList_1&quot;</span></span><br><span class="line">5) <span class="string">&quot;32b4b_UserFavModel_listData_ID_1&quot;</span></span><br><span class="line">6) <span class="string">&quot;32b4b_UserOption_User.tagList_1&quot;</span></span><br><span class="line">7) <span class="string">&quot;32b4b_SystemOption_&quot;</span></span><br><span class="line">8) <span class="string">&quot;32b4b_UserOption__0&quot;</span></span><br><span class="line">9) <span class="string">&quot;32b4b_%7Bsource%3A19%7D%2FattachmentTemp%2F&quot;</span></span><br><span class="line">10) <span class="string">&quot;32b4b_UserTagSourceModel_listData_ID_1&quot;</span></span><br><span class="line">11) <span class="string">&quot;32b4b_UserModel_getInfoSimple_ID_1&quot;</span></span><br><span class="line">12) <span class="string">&quot;32b4b_SystemOption_System.roleList&quot;</span></span><br><span class="line">13) <span class="string">&quot;32b4b_UserOption__1&quot;</span></span><br><span class="line">14) <span class="string">&quot;32b4b_SystemOption_System.noticeList&quot;</span></span><br><span class="line">15) <span class="string">&quot;b3ccde624f1bc5f45f3eec27812d90e5&quot;</span></span><br><span class="line">16) <span class="string">&quot;32b4b_UserOption_editor_1&quot;</span></span><br><span class="line">17) <span class="string">&quot;32b4b_SystemOption_System.sourceAuthList&quot;</span></span><br><span class="line">18) <span class="string">&quot;32b4b_IO_hashMd5_shell&quot;</span></span><br><span class="line">19) <span class="string">&quot;32b4b_IO_check_2e12e08959028ba362957fe10e2fea43&quot;</span></span><br><span class="line">20) <span class="string">&quot;32b4b_SystemOption_System.pluginList&quot;</span></span><br><span class="line">21) <span class="string">&quot;32b4b_UserModel_getInfo_ID_1&quot;</span></span><br><span class="line">22) <span class="string">&quot;32b4b_GroupModel_getInfoSimple_ID_1&quot;</span></span><br><span class="line">23) <span class="string">&quot;32b4b_GroupModel_getInfo_ID_1&quot;</span></span><br><span class="line">24) <span class="string">&quot;32b4b_SystemOption_System.storageList&quot;</span></span><br><span class="line">25) <span class="string">&quot;32b4b_ShareModel_listSimple_ID_1&quot;</span></span><br><span class="line">26) <span class="string">&quot;32b4b_SystemOption_System.LightApp&quot;</span></span><br><span class="line">127.0.0.1:6379&gt; </span><br><span class="line"></span><br><span class="line">mysql&gt; use kodbox</span><br><span class="line">mysql&gt; show tables;</span><br><span class="line">+-------------------+</span><br><span class="line">| Tables_in_kodbox  |</span><br><span class="line">+-------------------+</span><br><span class="line">| comment           |</span><br><span class="line">| comment_meta      |</span><br><span class="line">| comment_praise    |</span><br><span class="line">| group             |</span><br><span class="line">| group_meta        |</span><br><span class="line">| io_file           |</span><br><span class="line">| io_file_contents  |</span><br><span class="line">| io_file_meta      |</span><br><span class="line">| io_source         |</span><br><span class="line">| io_source_auth    |</span><br><span class="line">| io_source_event   |</span><br><span class="line">| io_source_history |</span><br><span class="line">| io_source_meta    |</span><br><span class="line">| io_source_recycle |</span><br><span class="line">| share             |</span><br><span class="line">| share_report      |</span><br><span class="line">| share_to          |</span><br><span class="line">| system_log        |</span><br><span class="line">| system_option     |</span><br><span class="line">| system_session    |</span><br><span class="line">| user              |</span><br><span class="line">| user_fav          |</span><br><span class="line">| user_group        |</span><br><span class="line">| user_meta         |</span><br><span class="line">| user_option       |</span><br><span class="line">+-------------------+</span><br><span class="line">25 rows <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br></pre></td></tr></table></figure>

<h3 id="项目实战：利用LNMP实现类京东电商网站ShopXO"><a href="#项目实战：利用LNMP实现类京东电商网站ShopXO" class="headerlink" title="项目实战：利用LNMP实现类京东电商网站ShopXO"></a>项目实战：利用LNMP实现类京东电商网站ShopXO</h3><p>官网链接: <a target="_blank" rel="noopener" href="http://www.shopxo.net/">http://www.shopxo.net</a></p>
<p><img src="../../../../images/SRE/day28/178.jpg" alt="178"></p>
<p>注意:建议安装 ShopXO-v2.2.3,可以支持PHP7.2, ShopXO-v2.2.3以上的版本要求PHP7.4以上才支持</p>
<p>范例：Ubuntu 20.04</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[root@ubuntu2004 ~]<span class="comment"># apt -y install nginx php7.4-fpm mysql-server libapache2-mod-php7.4 php7.4-mysql php7.4-json php7.4-xml php7.4-mbstring php7.4-zip php7.4-gd php7.4-curl</span></span><br><span class="line">[root@ubuntu2004 ~]<span class="comment"># vim /etc/php/7.4/fpm/php.ini</span></span><br><span class="line">post_max_size = 80M</span><br><span class="line">upload_max_filesize = 20M</span><br><span class="line"></span><br><span class="line">[root@ubuntu2004 ~]<span class="comment"># vim /etc/php/7.4/apache2/php.ini</span></span><br><span class="line">post_max_size = 80M</span><br><span class="line">upload_max_filesize = 20M</span><br><span class="line"></span><br><span class="line">[root@ubuntu2004 ~]<span class="comment"># systemctl restart apache2 php7.4-fpm.service</span></span><br></pre></td></tr></table></figure>

<p>范例: Rocky 8</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">[root@rocky8 ~]<span class="comment">#yum install nginx php-fpm php-json php-mysqlnd php-gd php-pecl-zip php-xml mysql-server</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#准备数据库和用户授权</span></span><br><span class="line">[root@rocky8 ~]<span class="comment"># mysql</span></span><br><span class="line">mysql&gt;create database shopxe;</span><br><span class="line">mysql&gt;create user shopxo@<span class="string">&#x27;localhost&#x27;</span> identified by <span class="string">&#x27;123456&#x27;</span>;</span><br><span class="line">mysql&gt;grant all on shopxo to shopxo@<span class="string">&#x27;localhost&#x27;</span>;</span><br><span class="line"></span><br><span class="line">[root@rocky8 ~]<span class="comment"># grep -v &#x27;^;&#x27; /etc/php-fpm.d/www.conf </span></span><br><span class="line">[www]</span><br><span class="line">listen = 9000</span><br><span class="line">user = nginx</span><br><span class="line">group = nginx</span><br><span class="line">pm.status_path = /php-status</span><br><span class="line">ping.path = /ping</span><br><span class="line">ping.response = pongpong</span><br><span class="line">access.log = /var/log/php-fpm/<span class="variable">$pool</span>.access.log</span><br><span class="line"></span><br><span class="line"><span class="comment">#修改文件大小和时区</span></span><br><span class="line">[root@rocky8 ~]<span class="comment"># vim /etc/php.ini</span></span><br><span class="line">date.timezone = Asia/Shanghai</span><br><span class="line">post_max_size = 80M</span><br><span class="line">upload_max_filesize = 80M</span><br><span class="line"></span><br><span class="line"><span class="comment">#准备nginx配置</span></span><br><span class="line">[root@rocky8 ~]<span class="comment"># vim /etc/nginx/conf.d/www.wang.org.conf</span></span><br><span class="line">server &#123;</span><br><span class="line">   listen 80;</span><br><span class="line">   server_name www.wang.org;</span><br><span class="line">   root /data/www/shopxo;</span><br><span class="line">   index index.php;</span><br><span class="line">   client_max_body_size 20m;</span><br><span class="line">   location ~ \.php$|/ping|/php-status &#123;</span><br><span class="line">       fastcgi_pass 127.0.0.1:9000 ;</span><br><span class="line">       fastcgi_param SCRIPT_FILENAME  $document_root<span class="variable">$fastcgi_script_name</span>;</span><br><span class="line">        <span class="comment">#fastcgi_param SCRIPT_FILENAME /data/www$fastcgi_script_name;</span></span><br><span class="line">       include fastcgi_params;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">[root@rocky8 ~]<span class="comment"># tar xf shopxo-v2.2.3.tar.gz -C /opt/</span></span><br><span class="line">[root@rocky8 ~]<span class="comment"># mkdir /data/www -pv</span></span><br><span class="line">[root@rocky8 ~]<span class="comment"># mv /opt/shopxo-2.2.3 /data/www/shopxo</span></span><br><span class="line">[root@rocky8 ~]<span class="comment"># chown -R nginx.nginx /data/www/shopxo</span></span><br></pre></td></tr></table></figure>

<p><img src="../../../../images/SRE/day28/179.jpg" alt="179"><br><img src="../../../../images/SRE/day28/180.jpg" alt="180"><br><img src="../../../../images/SRE/day28/181.jpg" alt="181"><br><img src="../../../../images/SRE/day28/182.jpg" alt="182"><br><img src="../../../../images/SRE/day28/183.jpg" alt="183"><br><img src="../../../../images/SRE/day28/184.jpg" alt="184"></p>
<h3 id="项目实战-编译安装LNMP-实现-phpMyAdmin-并利用-Redis实现会话保持"><a href="#项目实战-编译安装LNMP-实现-phpMyAdmin-并利用-Redis实现会话保持" class="headerlink" title="项目实战: 编译安装LNMP 实现 phpMyAdmin 并利用 Redis实现会话保持"></a>项目实战: 编译安装LNMP 实现 phpMyAdmin 并利用 Redis实现会话保持</h3><p>PhpMyAdmin 是一个基于PHP的MySQL管理平台</p>
<p>PhpMyAdmin 默认存放Session在本地目录,也可以由PHP-FPM服务指定存放Session的信息到Redis服务器中</p>
<p>官方链接</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://www.phpmyadmin.net/</span><br></pre></td></tr></table></figure>

<p><img src="../../../../images/SRE/day28/185.jpg" alt="185"></p>
<h4 id="准备-MySQL-和-Redis"><a href="#准备-MySQL-和-Redis" class="headerlink" title="准备 MySQL 和 Redis"></a>准备 MySQL 和 Redis</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[root@ubuntu2004 ~]<span class="comment"># apt -y install mysql-server redis</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#配置可不修改</span></span><br><span class="line">[root@ubuntu2004 ~]<span class="comment"># vim /etc/mysql/mysql.conf.d/mysqld.cnf</span></span><br><span class="line">[mysqld]</span><br><span class="line">default_authentication_plugin=mysql_native_password</span><br><span class="line"></span><br><span class="line">[root@ubuntu2004 ~]<span class="comment"># systemctl restart mysql</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#创建用户并授权</span></span><br><span class="line">[root@ubuntu2004 ~]<span class="comment"># mysql</span></span><br><span class="line">mysql&gt; create user admin@<span class="string">&#x27;localhost&#x27;</span> identified by <span class="string">&#x27;123456&#x27;</span>;</span><br><span class="line">mysql&gt; grant all on *.* to admin@<span class="string">&#x27;localhost&#x27;</span>;</span><br></pre></td></tr></table></figure>

<h4 id="编译安装-PHP-7-4"><a href="#编译安装-PHP-7-4" class="headerlink" title="编译安装 PHP-7.4"></a>编译安装 PHP-7.4</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line">[root@ubuntu2004 ~]<span class="comment"># apt -y install gcc make autoconf libpcre3 libpcre3-dev openssl libssl-dev zlib1g-dev libxml2-dev pkg-config libsqlite3-dev libtool</span></span><br><span class="line"></span><br><span class="line">[root@ubuntu2004 ~]<span class="comment"># groupadd -g 80 www &amp;&amp; useradd -u 80 -g www www</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#编译oniguruma</span></span><br><span class="line">[root@ubuntu2004 ~]<span class="comment"># wget -O oniguruma-6.9.4.tar.gz https://github.com/kkos/oniguruma/archive/refs/tags/v6.9.4.tar.gz</span></span><br><span class="line">[root@ubuntu2004 ~]<span class="comment"># tar xf oniguruma-6.9.4.tar.gz</span></span><br><span class="line">[root@ubuntu2004 oniguruma-6.9.4]<span class="comment"># ./autogen.sh </span></span><br><span class="line">[root@ubuntu2004 oniguruma-6.9.4]<span class="comment"># ./configure &amp;&amp; make &amp;&amp; make install</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#编译PHP7.4</span></span><br><span class="line">[root@ubuntu2004 ~]<span class="comment"># wget https://www.php.net/distributions/php-7.4.30.tar.gz</span></span><br><span class="line">[root@ubuntu2004 ~]<span class="comment"># tar xf php-7.4.30.tar.gz</span></span><br><span class="line">[root@ubuntu2004 ~]<span class="comment"># cd ../php-7.4.30</span></span><br><span class="line">[root@ubuntu2004 php-7.4.30]<span class="comment"># ./configure --prefix=/apps/php --enable-mysqlnd \</span></span><br><span class="line">--with-mysqli=mysqlnd  --with-pdo-mysql=mysqlnd --with-openssl --with-zlib \</span><br><span class="line">--with-config-file-path=/etc   --with-config-file-scan-dir=/etc/php.d --enable-mbstring \</span><br><span class="line">--enable-xml --enable-sockets --enable-fpm --enable-maintainer-zts --disable-fileinfo</span><br><span class="line"> </span><br><span class="line">[root@ubuntu2004 php-7.4.30]<span class="comment"># make -j 2 &amp;&amp; make install</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#查看版本验证编译成功</span></span><br><span class="line">[root@ubuntu2004 ~]<span class="comment"># /apps/php/sbin/php-fpm -v</span></span><br><span class="line">PHP 7.4.30 (fpm-fcgi) (built: Sep 18 2022 18:27:30)</span><br><span class="line">Copyright (c) The PHP Group</span><br><span class="line">Zend Engine v3.4.0, Copyright (c) Zend Technologies</span><br><span class="line"></span><br><span class="line"><span class="comment">#编译php-redis</span></span><br><span class="line">[root@ubuntu2004 ~]<span class="comment"># wget https://pecl.php.net/get/redis-5.3.7.tgz</span></span><br><span class="line">[root@ubuntu2004 ~]<span class="comment"># tar xf redis-5.3.7.tgz </span></span><br><span class="line">[root@ubuntu2004 ~]<span class="comment"># cd redis-5.3.7/</span></span><br><span class="line">[root@ubuntu2004 redis-5.3.7]<span class="comment"># /apps/php/bin/phpize &amp;&amp; ./configure --with-php-config=/apps/php/bin/php-config &amp;&amp; make -j 2 &amp;&amp; make install</span></span><br><span class="line">[root@ubuntu2004 redis-5.3.7]<span class="comment"># ls /apps/php/lib/php/extensions/no-debug-zts-20190902</span></span><br><span class="line">opcache.a opcache.so redis.so</span><br><span class="line"></span><br><span class="line">[root@ubuntu2004 redis-5.3.7]<span class="comment"># cd /root/php-7.4.30/</span></span><br><span class="line">[root@ubuntu2004 php-7.4.30]<span class="comment"># cp php.ini-production /etc/php.ini</span></span><br><span class="line">[root@ubuntu2004 php-7.4.30]<span class="comment"># cp sapi/fpm/init.d.php-fpm /etc/init.d/php-fpm</span></span><br><span class="line">[root@ubuntu2004 php-7.4.30]<span class="comment"># chmod +x /etc/init.d/php-fpm</span></span><br><span class="line">[root@ubuntu2004 php-7.4.30]<span class="comment"># cd /apps/php/etc/</span></span><br><span class="line">[root@ubuntu2004 etc]<span class="comment"># cp php-fpm.conf.default php-fpm.conf</span></span><br><span class="line">[root@ubuntu2004 etc]<span class="comment"># cp php-fpm.d/www.conf.default php-fpm.d/www.conf</span></span><br><span class="line">[root@ubuntu2004 ~]<span class="comment"># vim /etc/php.ini</span></span><br><span class="line">date.timezone = Asia/Shanghai</span><br><span class="line">post_max_size = 8M</span><br><span class="line">upload_max_filesize = 100M</span><br><span class="line">display_errors = On</span><br><span class="line">error_log = syslog</span><br><span class="line">;extension=/apps/php/lib/php/extensions/no-debug-zts-20190902/redis.so  <span class="comment">#不写路径也可以</span></span><br><span class="line">extension=redis.so</span><br><span class="line"></span><br><span class="line">[root@ubuntu2004 ~]<span class="comment"># vim /apps/php/etc/php-fpm.d/www.conf</span></span><br><span class="line">user = www</span><br><span class="line">group = www</span><br><span class="line">listen = 127.0.0.1:9000</span><br><span class="line">pm.status_path = /php-status</span><br><span class="line">ping.path = /ping</span><br><span class="line">access.log = <span class="built_in">log</span>/<span class="variable">$pool</span>.access.log</span><br><span class="line">slowlog = <span class="built_in">log</span>/<span class="variable">$pool</span>.log.slow</span><br><span class="line">php_value[session.save_handler] = redis</span><br><span class="line">php_value[session.save_path]    = <span class="string">&quot;tcp://127.0.0.1:6379&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#创建访问日志文件路径</span></span><br><span class="line">[root@ubuntu2004 ~]<span class="comment"># mkdir /apps/php/log</span></span><br><span class="line">[root@ubuntu2004 ~]<span class="comment"># systemctl daemon-reload </span></span><br><span class="line">[root@ubuntu2004 ~]<span class="comment"># systemctl enable php-fpm.service</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#启动php-fpm</span></span><br><span class="line">[root@ubuntu2004 ~]<span class="comment"># systemctl start php-fpm</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#或者直接运行程序也可以,默认是后台运行</span></span><br><span class="line">[root@ubuntu2004 ~]<span class="comment"># /apps/php/sbin/php-fpm</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#验证服务启动</span></span><br><span class="line">[root@ubuntu2004 ~]<span class="comment"># ss -ntlp|grep 9000</span></span><br><span class="line">LISTEN    0         511              127.0.0.1:9000             0.0.0.0:*       </span><br><span class="line"><span class="built_in">users</span>:((&quot;php-fpm&quot;,pid=<span class="number">154390</span>,fd=<span class="number">6</span>),(&quot;php-fpm&quot;,pid=<span class="number">154389</span>,fd=<span class="number">6</span>),(&quot;phpfpm&quot;,pid=<span class="number">154388</span>,fd=<span class="number">8</span>))</span><br><span class="line"></span><br><span class="line">[root@ubuntu2004 ~]<span class="comment"># ps aux|grep php</span></span><br><span class="line">root      154388  0.0  0.2  62812  4920 ?       Ss   19:45   0:00 php-fpm: master process (/apps/php/etc/php-fpm.conf)</span><br><span class="line">www       154389  0.0  1.3  74556 27172 ?       S    19:45   0:02 php-fpm: pool www</span><br><span class="line">www       154390  0.0  0.9  67344 19012 ?       S    19:45   0:02 php-fpm: pool www</span><br><span class="line">root      157770  0.0  0.0   9392   724 pts/0   S+   20:43   0:00 grep --color=auto php</span><br></pre></td></tr></table></figure>

<h4 id="编译安装-Nginx-1"><a href="#编译安装-Nginx-1" class="headerlink" title="编译安装 Nginx"></a>编译安装 Nginx</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line">[root@ubuntu2004 ~]<span class="comment"># wget http://nginx.org/download/nginx-1.22.0.tar.gz</span></span><br><span class="line">[root@ubuntu2004 ~]<span class="comment"># tar xf nginx-1.22.0.tar.gz</span></span><br><span class="line">[root@ubuntu2004 ~]<span class="comment"># cd nginx-1.22.0/</span></span><br><span class="line">[root@ubuntu2004 nginx-1.22.0]<span class="comment"># ./configure --prefix=/apps/nginx --user=www --group=www \</span></span><br><span class="line">--with-http_ssl_module --with-http_v2_module --with-http_realip_module \</span><br><span class="line">--with-http_stub_status_module --with-http_gzip_static_module --with-pcre --with-stream \</span><br><span class="line">--with-stream_ssl_module --with-stream_realip_module </span><br><span class="line"></span><br><span class="line">[root@ubuntu2004 nginx-1.22.0]<span class="comment"># make -j 2 &amp;&amp; make install</span></span><br><span class="line"></span><br><span class="line">[root@rocky8 ~]<span class="comment"># mkdir /apps/nginx/conf.d/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#准备配置文件</span></span><br><span class="line">[root@rocky8 ~]<span class="comment"># vim /apps/nginx/conf/nginx.conf</span></span><br><span class="line">user www; <span class="comment">#修改此行</span></span><br><span class="line">http &#123;</span><br><span class="line">....</span><br><span class="line">    include /apps/nginx/conf.d/*.conf; <span class="comment">#添加此行</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">#配置nginx支持php</span></span><br><span class="line">[root@ubuntu2004 ~]<span class="comment"># vim /apps/nginx/conf.d/www.wang.org.conf </span></span><br><span class="line">server &#123;</span><br><span class="line">   listen 80;</span><br><span class="line">   server_name www.wang.org;</span><br><span class="line">   root /data/www/;</span><br><span class="line">   index index.php;</span><br><span class="line">   client_max_body_size 20m;</span><br><span class="line">   location ~ \.php$|/ping|/php-status &#123;</span><br><span class="line">       fastcgi_pass 127.0.0.1:9000 ;</span><br><span class="line">       fastcgi_param SCRIPT_FILENAME  $document_root<span class="variable">$fastcgi_script_name</span>;</span><br><span class="line">        <span class="comment">#fastcgi_param SCRIPT_FILENAME /data/www$fastcgi_script_name;</span></span><br><span class="line">       include fastcgi_params;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@ubuntu2004 ~]<span class="comment"># cat &gt; /lib/systemd/system/nginx.service &lt;&lt;EOF</span></span><br><span class="line">[Unit]</span><br><span class="line">Description=The nginx HTTP and reverse proxy server</span><br><span class="line">After=network.target remote-fs.target nss-lookup.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">Type=forking</span><br><span class="line">PIDFile=/apps/nginx/logs/nginx.pid</span><br><span class="line">ExecStartPre=/bin/rm -f /apps/nginx/logs/nginx.pid</span><br><span class="line">ExecStartPre=/apps/nginx/sbin/nginx -t</span><br><span class="line">ExecStart=/apps/nginx/sbin/nginx</span><br><span class="line">ExecReload=/bin/kill -s HUP \<span class="variable">$MAINPID</span></span><br><span class="line">KillSignal=SIGQUIT</span><br><span class="line">TimeoutStopSec=5</span><br><span class="line">KillMode=process</span><br><span class="line">PrivateTmp=<span class="literal">true</span></span><br><span class="line">LimitNOFILE=100000</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">[root@ubuntu2004 ~]<span class="comment"># systemctl daemon-reload </span></span><br><span class="line">[root@ubuntu2004 ~]<span class="comment"># systemctl enable --now nginx</span></span><br></pre></td></tr></table></figure>

<h4 id="测试访问-PHP"><a href="#测试访问-PHP" class="headerlink" title="测试访问 PHP"></a>测试访问 PHP</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[root@ubuntu2004 ~]<span class="comment"># mkdir /data/www -p</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#测试访问</span></span><br><span class="line">[root@ubuntu2004 ~]<span class="comment"># vim /data/www/test.php</span></span><br><span class="line">&lt;?php</span><br><span class="line">phpinfo();</span><br><span class="line">?&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment">#在客户端实现名称解析,也可以配置DNS实现</span></span><br><span class="line">[root@ubuntu2004 ~]<span class="comment"># vim /etc/hosts</span></span><br><span class="line">10.0.0.100 www.wang.org</span><br><span class="line"></span><br><span class="line"><span class="comment">#访问下面查看是否成功</span></span><br><span class="line">http://www.wang.org/ping</span><br><span class="line">http://www.wang.org/php-status</span><br><span class="line">http://www.wang.org/test.php</span><br></pre></td></tr></table></figure>

<p><img src="../../../../images/SRE/day28/186.jpg" alt="186"><br><img src="../../../../images/SRE/day28/187.jpg" alt="187"><br><img src="../../../../images/SRE/day28/188.jpg" alt="188"></p>
<p>查看是否有redis模块信息</p>
<p><img src="../../../../images/SRE/day28/189.jpg" alt="189"></p>
<h4 id="准备-phpMyAdmin-程序"><a href="#准备-phpMyAdmin-程序" class="headerlink" title="准备 phpMyAdmin 程序"></a>准备 phpMyAdmin 程序</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[root@ubuntu2004 ~]<span class="comment"># wget https://files.phpmyadmin.net/phpMyAdmin/5.2.0/phpMyAdmin-5.2.0-all-languages.zip</span></span><br><span class="line">[root@ubuntu2004 ~]<span class="comment"># unzip phpMyAdmin-5.2.0-all-languages.zip</span></span><br><span class="line">[root@ubuntu2004 ~]<span class="comment"># mv phpMyAdmin-5.2.0-all-languages/* /data/www</span></span><br><span class="line">[root@ubuntu2004 ~]<span class="comment"># cp /data/www/config.sample.inc.php config.inc.php</span></span><br><span class="line">[root@ubuntu2004 ~]<span class="comment"># vim /data/www/config.inc.php</span></span><br><span class="line"><span class="variable">$cfg</span>[<span class="string">&#x27;Servers&#x27;</span>][<span class="variable">$i</span>][<span class="string">&#x27;host&#x27;</span>] = <span class="string">&#x27;127.0.0.1&#x27;</span>; </span><br><span class="line"><span class="comment">#本机也必须改为127.0.0.1,否则会出现错误:mysqli::real_connect(): (HY000/2002): No such file or directory</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@ubuntu2004 ~]<span class="comment"># chown -R www.www /data/www/</span></span><br></pre></td></tr></table></figure>

<h4 id="测试访问网站"><a href="#测试访问网站" class="headerlink" title="测试访问网站"></a>测试访问网站</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#访问链接,用5.4.4.1在MySQL创建的用户admin/123456登录</span></span><br><span class="line">http://www.wang.org/</span><br></pre></td></tr></table></figure>

<p><img src="../../../../images/SRE/day28/190.jpg" alt="190"><br><img src="../../../../images/SRE/day28/191.jpg" alt="191"></p>
<p>查看 redis 中是否有 session 数据</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">[root@ubuntu2004 ~]<span class="comment">#redis-cli </span></span><br><span class="line">127.0.0.1:6379&gt; keys *</span><br><span class="line">1) <span class="string">&quot;PHPREDIS_SESSION:ee7bn6eu6orjn1ajt9j9d06s6c&quot;</span></span><br><span class="line"></span><br><span class="line">127.0.0.1:6379&gt; <span class="built_in">type</span> <span class="string">&quot;PHPREDIS_SESSION:ee7bn6eu6orjn1ajt9j9d06s6c&quot;</span></span><br><span class="line">string</span><br><span class="line"></span><br><span class="line">127.0.0.1:6379&gt; get <span class="string">&quot;PHPREDIS_SESSION:ee7bn6eu6orjn1ajt9j9d06s6c&quot;</span></span><br><span class="line"><span class="string">&quot; PMA_token |s:32:\&quot;255a38782c5e615b667d6154352f2922\&quot;; HMAC_secret </span></span><br><span class="line"><span class="string">|s:16:\&quot;lrIb|hzERrs1et%*\&quot;;browser_access_time|a:1:</span></span><br><span class="line"><span class="string">&#123;s:7:\&quot;default\&quot;;i:1663504436;&#125;encryption_key|s:32:\&quot;\x8f\xf3\xb0\x90\x92\x95F\x</span></span><br><span class="line"><span class="string">8e_\xd8CD\x8b\x9a*\xb7\xed*\xde\x17 </span></span><br><span class="line"><span class="string">\xf4Z\xbb\x1e\xf2l$$&amp;\xe7\x10\&quot;;relation|a:1:&#123;i:1;a:41:</span></span><br><span class="line"><span class="string">&#123;s:7:\&quot;version\&quot;;s:5:\&quot;5.2.0\&quot;;s:4:\&quot;user\&quot;;N;s:2:\&quot;db\&quot;;N;s:8:\&quot;bookmark\&quot;;N;s:</span></span><br><span class="line"><span class="string">15:\&quot;central_columns\&quot;;N;s:11:\&quot;column_info\&quot;;N;s:17:\&quot;designer_settings\&quot;;N;s:1</span></span><br><span class="line"><span class="string">6:\&quot;export_templates\&quot;;N;s:8:\&quot;favorite\&quot;;N;s:7:\&quot;history\&quot;;N;s:16:\&quot;navigationh</span></span><br><span class="line"><span class="string">iding\&quot;;N;s:9:\&quot;pdf_pages\&quot;;N;s:6:\&quot;recent\&quot;;N;s:8:\&quot;relation\&quot;;N;s:13:\&quot;savedse</span></span><br><span class="line"><span class="string">arches\&quot;;N;s:12:\&quot;table_coords\&quot;;N;s:10:\&quot;table_info\&quot;;N;s:13:\&quot;table_uipref</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">#删除session</span></span><br><span class="line"><span class="string">127.0.0.1:6379&gt; flushall</span></span><br><span class="line"><span class="string">OK</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">#刷新浏览器,查看是否注销</span></span><br><span class="line"><span class="string">http://www.wang.org/</span></span><br></pre></td></tr></table></figure>

<p><img src="../../../../images/SRE/day28/192.jpg" alt="192"></p>
<p>如果php-fpm 停止,网站会出现502</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@ubuntu2004 ~]<span class="comment"># systemctl stop php-fpm.service</span></span><br></pre></td></tr></table></figure>

<p><img src="../../../../images/SRE/day28/193.jpg" alt="193"></p>
<h3 id="项目实战：利用-LNMP-实现-phpMyAdmin-的负载均衡并利用Redis实现会话保持"><a href="#项目实战：利用-LNMP-实现-phpMyAdmin-的负载均衡并利用Redis实现会话保持" class="headerlink" title="项目实战：利用 LNMP 实现 phpMyAdmin 的负载均衡并利用Redis实现会话保持"></a>项目实战：利用 LNMP 实现 phpMyAdmin 的负载均衡并利用Redis实现会话保持</h3><p><img src="../../../../images/SRE/day28/194.jpg" alt="194"></p>
<h4 id="安装和配置-MySQL"><a href="#安装和配置-MySQL" class="headerlink" title="安装和配置 MySQL"></a>安装和配置 MySQL</h4><p>在 10.0.0.38 上执行下面操作</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@rocky8 ~]<span class="comment"># yum -y install mysql-server</span></span><br><span class="line">[root@rocky8 ~]<span class="comment"># systemctl enable --now mysqld</span></span><br><span class="line">[root@rocky8 ~]<span class="comment"># mysql</span></span><br><span class="line">Server version: 8.0.26 Source distribution</span><br><span class="line">mysql&gt; create user admin@<span class="string">&#x27;10.0.0.%&#x27;</span> identified by <span class="string">&#x27;123456&#x27;</span>;</span><br><span class="line">mysql&gt; grant all on *.* to admin@<span class="string">&#x27;10.0.0.%&#x27;</span>;</span><br></pre></td></tr></table></figure>

<h4 id="安装和配置-Redis"><a href="#安装和配置-Redis" class="headerlink" title="安装和配置 Redis"></a>安装和配置 Redis</h4><p>在10.0.0.48上准备Redis服务</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#redis安装</span></span><br><span class="line">[root@rocky8 ~]<span class="comment"># yum -y install redis</span></span><br><span class="line">[root@rocky8 ~]<span class="comment"># vi /etc/redis.conf</span></span><br><span class="line">listen 0.0.0.0</span><br><span class="line"></span><br><span class="line">[root@rocky8 ~]<span class="comment"># systemctl enable --now redis</span></span><br></pre></td></tr></table></figure>

<h4 id="安装和配置-Nginx"><a href="#安装和配置-Nginx" class="headerlink" title="安装和配置 Nginx"></a>安装和配置 Nginx</h4><p>在10.0.0.18和10.0.0.28上执行下面,配置Nginx环境</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#创建用户和组</span></span><br><span class="line">[root@rocky8 ~]<span class="comment"># groupadd -g 666 -r www</span></span><br><span class="line">[root@rocky8 ~]<span class="comment"># useradd -u 666 -g www -s /sbin/nologin -r www</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#编译安装nginx </span></span><br><span class="line">略</span><br><span class="line"></span><br><span class="line"><span class="comment">#配置nginx支持php</span></span><br><span class="line">[root@rocky8 ~]<span class="comment"># mkdir /apps/nginx/conf.d/</span></span><br><span class="line">[root@rocky8 ~]<span class="comment"># vim /apps/nginx/conf/nginx.conf</span></span><br><span class="line">user www;</span><br><span class="line">http &#123;</span><br><span class="line">....</span><br><span class="line"> include /apps/nginx/conf.d/*.conf</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">#配置nginx支持php</span></span><br><span class="line">[root@rocky8 ~]<span class="comment"># vim /apps/nginx/conf.d/www.wang.org.conf </span></span><br><span class="line">server &#123;</span><br><span class="line">   listen 80;</span><br><span class="line">   server_name www.wang.org;</span><br><span class="line">   root /data/www/;</span><br><span class="line">   index index.php;</span><br><span class="line">   client_max_body_size 20m;</span><br><span class="line">   location ~ \.php$|/ping|/php-status &#123;</span><br><span class="line">       fastcgi_pass 127.0.0.1:9000 ;</span><br><span class="line">       fastcgi_param SCRIPT_FILENAME  $document_root<span class="variable">$fastcgi_script_name</span>;</span><br><span class="line">        <span class="comment">#fastcgi_param SCRIPT_FILENAME /data/www$fastcgi_script_name;</span></span><br><span class="line">       include fastcgi_params;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">[root@rocky8 ~]<span class="comment"># mkdir /data/www/</span></span><br><span class="line">[root@rocky8 ~]<span class="comment"># chown -R www.www /apps/nginx</span></span><br><span class="line">[root@rocky8 ~]<span class="comment"># systemctl enable --nginx</span></span><br><span class="line">[root@rocky8 ~]<span class="comment"># systectl restart nginx</span></span><br></pre></td></tr></table></figure>

<h4 id="安装和配置-PHP-FPM服务"><a href="#安装和配置-PHP-FPM服务" class="headerlink" title="安装和配置 PHP-FPM服务"></a>安装和配置 PHP-FPM服务</h4><p>在10.0.0.18和10.0.0.28上执行下面,配置PHP-FPM服务</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">[root@rocky8 ~]<span class="comment"># yum -y install php-fpm php-json php-mysqlnd </span></span><br><span class="line"></span><br><span class="line"><span class="comment">#优化配置(可选)</span></span><br><span class="line">[root@rocky8 ~]<span class="comment"># vim /etc/php.ini</span></span><br><span class="line">date.timezone = Asia/Shanghai</span><br><span class="line">post_max_size=100M</span><br><span class="line">upload_max_filesize =100M</span><br><span class="line"></span><br><span class="line"><span class="comment">#配置PHP-FPM服务</span></span><br><span class="line">[root@rocky8 ~]<span class="comment"># vim /etc/php-fpm.d/www.conf</span></span><br><span class="line">user = www</span><br><span class="line">group = www</span><br><span class="line">listen = 127.0.0.1:9000</span><br><span class="line">pm.status_path = /php-status</span><br><span class="line">ping.path = /ping</span><br><span class="line">php_value[session.save_handler] = redis</span><br><span class="line">php_value[session.save_path]    = <span class="string">&quot;tcp://10.0.0.38:6379&quot;</span></span><br></pre></td></tr></table></figure>

<h4 id="编译安装Redis模块PHP连接Redis服务"><a href="#编译安装Redis模块PHP连接Redis服务" class="headerlink" title="编译安装Redis模块PHP连接Redis服务"></a>编译安装Redis模块PHP连接Redis服务</h4><p>PECL 组织提供了相关PHP的扩展软件,实现扩展功能,比如:php-pecl-redis 用于PHP连接Redis</p>
<p>官方链接</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://pecl.php.net/</span><br></pre></td></tr></table></figure>

<p>官方说明</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">What is PECL?</span><br><span class="line">PECL is a repository for PHP Extensions, providing a directory of all known </span><br><span class="line">extensions and hosting facilities for downloading and development of PHP extensions.</span><br></pre></td></tr></table></figure>

<p><img src="../../../../images/SRE/day28/195.jpg" alt="195"></p>
<p>Redis 模块的官方链接:</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://pecl.php.net/package/redis</span><br></pre></td></tr></table></figure>

<p><img src="../../../../images/SRE/day28/196.jpg" alt="196"></p>
<p>由于CentOS8和Rocky8 缺失了php-pecl-redis包,可以选择源码编译安装实现PHP连接Redis</p>
<p>注意: CentIOS7 由 EPEL源提供了php-pecl-redis包,直接安装即可</p>
<p>在10.0.0.18和10.0.0.28上执行下面操作,编译Redis模块</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#安装相关包</span></span><br><span class="line">[root@rocky8 ~]<span class="comment"># yum -y install php-cli php-devel</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#编译PHP的Redis模块</span></span><br><span class="line">[root@rocky8 ~]<span class="comment"># wget https://pecl.php.net/get/redis-5.3.7.tgz</span></span><br><span class="line">[root@rocky8 ~]<span class="comment"># tar xf redis-5.3.7.tgz</span></span><br><span class="line">[root@rocky8 ~]<span class="comment"># cd redis-5.3.7/</span></span><br><span class="line">[root@rocky8 redis-5.3.7]<span class="comment"># cat INSTALL</span></span><br><span class="line">[root@rocky8 redis-5.3.7]<span class="comment"># phpize</span></span><br><span class="line">[root@rocky8 redis-5.3.7]<span class="comment"># ./configure</span></span><br><span class="line">[root@rocky8 redis-5.3.7]<span class="comment"># make -j 2 &amp;&amp; make install</span></span><br><span class="line"></span><br><span class="line">[root@rocky8 ~]<span class="comment"># ll /usr/lib64/php/modules/redis.so </span></span><br><span class="line">-rwxr-xr-x 1 root root 3530824 Feb 26 10:21 /usr/lib64/php/modules/redis.so</span><br><span class="line"></span><br><span class="line">[root@rocky8 ~]<span class="comment"># vim /etc/php.d/66-redis.ini</span></span><br><span class="line">extension=redis</span><br><span class="line"></span><br><span class="line">[root@rocky8 ~]<span class="comment"># systemctl enable --now php-fpm</span></span><br></pre></td></tr></table></figure>

<h4 id="部署-phpMyAdmin-代码上线"><a href="#部署-phpMyAdmin-代码上线" class="headerlink" title="部署 phpMyAdmin 代码上线"></a>部署 phpMyAdmin 代码上线</h4><p>PhpMyAdmin 是一个基于PHP的MySQL管理平台</p>
<p>官方链接</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://www.phpmyadmin.net/</span><br></pre></td></tr></table></figure>

<p><img src="../../../../images/SRE/day28/197.jpg" alt="197"></p>
<p>在10.0.0.18和10.0.0.28上执行下面操作,部署PhpMyAdmin代码</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@rocky8 ~]<span class="comment"># wget https://files.phpmyadmin.net/phpMyAdmin/5.2.0/phpMyAdmin-5.2.0-all-languages.zip</span></span><br><span class="line">[root@rocky8 ~]<span class="comment"># unzip phpMyAdmin-5.2.0-all-languages.zip -d /opt/</span></span><br><span class="line">[root@rocky8 ~]<span class="comment"># mv /opot/phpMyAdmin-5.2.0-all-languages/* /data/www/</span></span><br><span class="line"></span><br><span class="line">[root@rocky8 ~]<span class="comment"># cp /data/www/config.sample.inc.php config.inc.php</span></span><br><span class="line">[root@rocky8 ~]<span class="comment"># vim /data/www/config.inc.php</span></span><br><span class="line"><span class="variable">$cfg</span>[<span class="string">&#x27;Servers&#x27;</span>][<span class="variable">$i</span>][<span class="string">&#x27;host&#x27;</span>] = <span class="string">&#x27;10.0.0.38&#x27;</span>;</span><br><span class="line"></span><br><span class="line">[root@rocky8 ~]<span class="comment"># chown -R www.www /data/www/</span></span><br></pre></td></tr></table></figure>

<h4 id="配置Nginx反向代理实现负载均衡"><a href="#配置Nginx反向代理实现负载均衡" class="headerlink" title="配置Nginx反向代理实现负载均衡"></a>配置Nginx反向代理实现负载均衡</h4><p>在10.0.0.8的主机执行,实现负载均衡</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#编译安装安装nginx服务</span></span><br><span class="line">略</span><br><span class="line"></span><br><span class="line"><span class="comment">#申请证书文件</span></span><br><span class="line">略</span><br><span class="line"></span><br><span class="line">[root@rocky8 ~]<span class="comment"># ls /apps/nginx/ssl/</span></span><br><span class="line">www.wang.org.key www.wang.org.pem</span><br><span class="line"></span><br><span class="line"><span class="comment">#反向代理的配置</span></span><br><span class="line">[root@rocky8 ~]<span class="comment"># vim /apps/nginx/conf/nginx.conf</span></span><br><span class="line">user www;</span><br><span class="line">http &#123;</span><br><span class="line">....</span><br><span class="line">    include /apps/nginx/conf.d/*.conf</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">[root@rocky8 ~]<span class="comment"># mkdir /apps/nginx/conf.d/</span></span><br><span class="line">[root@rocky8 ~]<span class="comment"># vim /apps/nginx/conf.d/proxy-www.wang.org.conf</span></span><br><span class="line">upstream webservers &#123;</span><br><span class="line">   server 10.0.0.18:80 ;</span><br><span class="line">   server 10.0.0.28:80;</span><br><span class="line">&#125;</span><br><span class="line">server &#123;</span><br><span class="line">   listen 80;</span><br><span class="line">   server_name www.wang.org;</span><br><span class="line">   root /data/www/pc;</span><br><span class="line">   <span class="built_in">return</span> 302 https://$server_name<span class="variable">$request_uri</span>;</span><br><span class="line">&#125;</span><br><span class="line">server &#123;</span><br><span class="line">   listen 443 ssl http2;</span><br><span class="line">   server_name www.wang.org;</span><br><span class="line">   ssl_certificate   /apps/nginx/ssl/www.wang.org.pem;</span><br><span class="line">   ssl_certificate_key /apps/nginx/ssl/www.wang.org.key;</span><br><span class="line">   ssl_session_cache shared:sslcache:20m;</span><br><span class="line">   ssl_session_timeout 10m;</span><br><span class="line">   location / &#123;</span><br><span class="line">       proxy_pass http://webservers;</span><br><span class="line">       proxy_set_header Host  <span class="variable">$http_host</span>;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">[root@rocky8 ~]<span class="comment"># systemctl enable --nginx</span></span><br><span class="line">[root@rocky8 ~]<span class="comment"># systectl restart nginx</span></span><br></pre></td></tr></table></figure>

<h4 id="验证访问"><a href="#验证访问" class="headerlink" title="验证访问"></a>验证访问</h4><p>配置解析 /etc/hosts</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">10.0.0.8 www.wang.org</span><br></pre></td></tr></table></figure>

<p>浏览器访问</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://www.wang.org</span><br></pre></td></tr></table></figure>

<p><img src="../../../../images/SRE/day28/198.jpg" alt="198"><br><img src="../../../../images/SRE/day28/199.jpg" alt="199"></p>
<p>刷新页面后可以看到下面的变化</p>
<p><img src="../../../../images/SRE/day28/200.jpg" alt="200"></p>
<p>在10.0.0.48上执行,验证Redis服务器生成以下Session信息</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@rocky8 ~]<span class="comment"># redis-cli </span></span><br><span class="line">127.0.0.1:6379&gt; keys *</span><br><span class="line">1) <span class="string">&quot;PHPREDIS_SESSION:phjlot4qc86efhv8vuptgoshgt&quot;</span></span><br><span class="line"></span><br><span class="line">127.0.0.1:6379&gt; get PHPREDIS_SESSION:phjlot4qc86efhv8vuptgoshgt</span><br></pre></td></tr></table></figure>

<h1 id="Nginx-二次开发版本"><a href="#Nginx-二次开发版本" class="headerlink" title="Nginx 二次开发版本"></a>Nginx 二次开发版本</h1><h2 id="Tengine"><a href="#Tengine" class="headerlink" title="Tengine"></a>Tengine</h2><h3 id="Tengine-介绍"><a href="#Tengine-介绍" class="headerlink" title="Tengine 介绍"></a>Tengine 介绍</h3><p><img src="../../../../images/SRE/day28/201.jpg" alt="201"></p>
<p>Tengine是由淘宝网发起的Web服务器项目。它在Nginx的基础上，针对大访问量网站的需求，添加了很多高级功能和特性。Tengine的性能和稳定性已经在大型的网站如淘宝网，天猫商城等得到了很好的检验。它的最终目标是打造一个高效、稳定、安全、易用的Web平台。</p>
<p>官网： <a target="_blank" rel="noopener" href="http://tengine.taobao.org/">http://tengine.taobao.org</a></p>
<p>官方文档： <a target="_blank" rel="noopener" href="http://tengine.taobao.org/documentation_cn.html">http://tengine.taobao.org/documentation_cn.html</a></p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">继承Nginx-1.16.0的所有特性，兼容nginx的配置</span><br><span class="line">支持HTTP的CONNECT方法，可用于正向代理场景</span><br><span class="line">支持异步OpenSSL，可使用硬件如:QAT进行HTTPS的加速与卸载</span><br><span class="line">增强相关运维、监控能力,比如异步打印日志及回滚,本地DNS缓存,内存监控等</span><br><span class="line">Stream模块支持server_name指令</span><br><span class="line">更加强大的负载均衡能力，包括一致性hash模块、会话保持模块，还可以对后端的服务器进行主动健康检查，</span><br><span class="line">根据服务器状态自动上线下线，以及动态解析upstream中出现的域名</span><br><span class="line">输入过滤器机制支持。通过使用这种机制Web应用防火墙的编写更为方便</span><br><span class="line">支持设置proxy、memcached、fastcgi、scgi、uwsgi在后端失败时的重试次数</span><br><span class="line">动态脚本语言Lua支持。扩展功能非常高效简单</span><br><span class="line">支持按指定关键字(域名，url等)收集Tengine运行状态</span><br><span class="line">组合多个CSS、JavaScript文件的访问请求变成一个请求</span><br><span class="line">自动去除空白字符和注释从而减小页面的体积</span><br><span class="line">自动根据CPU数目设置进程个数和绑定CPU亲缘性;</span><br><span class="line">监控系统的负载和资源占用从而对系统进行保护</span><br><span class="line">显示对运维人员更友好的出错信息，便于定位出错机器</span><br><span class="line">更强大的防攻击（访问速度限制）模块</span><br><span class="line">更方便的命令行参数，如列出编译的模块列表、支持的指令等</span><br><span class="line">可以根据访问文件类型设置过期时间</span><br></pre></td></tr></table></figure>

<h3 id="动态模块"><a href="#动态模块" class="headerlink" title="动态模块"></a>动态模块</h3><p><a target="_blank" rel="noopener" href="http://tengine.taobao.org/document_cn/dso_cn.html">http://tengine.taobao.org/document_cn/dso_cn.html</a></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">这个模块主要是用来运行时动态加载模块，而不用每次都要重新编译Tengine.</span><br><span class="line">如果想要编译官方模块为动态模块，需要在configure的时候加上类似这样的指令(--with-http_xxx_module=shared),./configure --<span class="built_in">help</span>可以看到更多的细节.</span><br><span class="line">如果只想要安装官方模块为动态模块(不安装Nginx)，那么就只需要configure之后，执行 make dso_install命令.</span><br><span class="line">动态加载模块的个数限制为128个.</span><br><span class="line">如果已经加载的动态模块有修改，那么必须重启Tengine才会生效.</span><br><span class="line">只支持HTTP模块.</span><br><span class="line">模块 在Linux/FreeBSD/MacOS下测试成功.</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">例子:</span><br><span class="line">worker_processes  1;</span><br><span class="line">dso &#123;</span><br><span class="line">   load ngx_http_lua_module.so;</span><br><span class="line">   load ngx_http_memcached_module.so;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">events &#123;</span><br><span class="line">   worker_connections  1024;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">#注意</span></span><br><span class="line">在Tengine-2.3.0版本后废弃Tengine的dso_tool工具以及dso配置指令，若之前有使用Tengine的dso功能、则可以切换到Nginx官方的load_module指令,详细文档</span><br></pre></td></tr></table></figure>

<h4 id="编译安装-tengine-2-1-2"><a href="#编译安装-tengine-2-1-2" class="headerlink" title="编译安装 tengine-2.1.2"></a>编译安装 tengine-2.1.2</h4><p>注意: 不支持CentOS8 </p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br></pre></td><td class="code"><pre><span class="line">[root@centos7 ~]<span class="comment"># yum -y install gcc pcre-devel openssl-devel</span></span><br><span class="line">[root@centos7 ~]<span class="comment"># useradd -r -s /sbin/nologin nginx</span></span><br><span class="line"></span><br><span class="line">[root@centos7 ~]<span class="comment"># cd /usr/local/src</span></span><br><span class="line">[root@centos7 src]<span class="comment"># wget http://tengine.taobao.org/download/tengine-2.1.2.tar.gz</span></span><br><span class="line">[root@centos7 src]<span class="comment"># tar xf tengine-2.1.2.tar.gz </span></span><br><span class="line">[root@centos7 src]<span class="comment"># cd tengine-2.1.2/</span></span><br><span class="line">[root@centos7 tengine-2.1.2]<span class="comment"># ./configure --prefix=/apps/tengine-2.1.2 --user=nginx \</span></span><br><span class="line">--group=nginx --with-http_ssl_module --with-http_v2_module --with-http_realip_module \</span><br><span class="line">--with-http_stub_status_module --with-http_gzip_static_module --with-pcre</span><br><span class="line"></span><br><span class="line">[root@centos7 tengine-2.1.2]<span class="comment"># make &amp;&amp; make install</span></span><br><span class="line">[root@centos7 tengine-2.1.2]<span class="comment"># tree /apps/tengine-2.1.2/</span></span><br><span class="line">/apps/tengine-2.1.2/</span><br><span class="line">├── conf</span><br><span class="line">│   ├── browsers</span><br><span class="line">│   ├── fastcgi.conf</span><br><span class="line">│   ├── fastcgi.conf.default</span><br><span class="line">│   ├── fastcgi_params</span><br><span class="line">│   ├── fastcgi_params.default</span><br><span class="line">│   ├── koi-utf</span><br><span class="line">│   ├── koi-win</span><br><span class="line">│   ├── mime.types</span><br><span class="line">│   ├── mime.types.default</span><br><span class="line">│   ├── module_stubs</span><br><span class="line">│   ├── nginx.conf</span><br><span class="line">│   ├── nginx.conf.default</span><br><span class="line">│   ├── scgi_params</span><br><span class="line">│   ├── scgi_params.default</span><br><span class="line">│   ├── uwsgi_params</span><br><span class="line">│   ├── uwsgi_params.default</span><br><span class="line">│   └── win-utf</span><br><span class="line">├── html</span><br><span class="line">│   ├── 50x.html</span><br><span class="line">│   └── index.html</span><br><span class="line">├── include</span><br><span class="line">│   ├── nginx.h</span><br><span class="line">│   ├── ngx_alloc.h</span><br><span class="line">│   ├── ngx_array.h</span><br><span class="line">│   ├── ngx_atomic.h</span><br><span class="line">│   ├── ngx_auto_config.h</span><br><span class="line">│   ├── ngx_auto_headers.h</span><br><span class="line">│   ├── ngx_buf.h</span><br><span class="line">│   ├── ngx_channel.h</span><br><span class="line">│   ├── ngx_conf_file.h</span><br><span class="line">│   ├── ngx_config.h</span><br><span class="line">│   ├── ngx_connection.h</span><br><span class="line">│   ├── ngx_core.h</span><br><span class="line">│   ├── ngx_crc32.h</span><br><span class="line">│   ├── ngx_crc.h</span><br><span class="line">│   ├── ngx_crypt.h</span><br><span class="line">│   ├── ngx_cycle.h</span><br><span class="line">│   ├── ngx_errno.h</span><br><span class="line">│   ├── ngx_event_busy_lock.h</span><br><span class="line">│   ├── ngx_event_connect.h</span><br><span class="line">│   ├── ngx_event.h</span><br><span class="line">│   ├── ngx_event_openssl.h</span><br><span class="line">│   ├── ngx_event_pipe.h</span><br><span class="line">│   ├── ngx_event_posted.h</span><br><span class="line">│   ├── ngx_event_timer.h</span><br><span class="line">│   ├── ngx_file.h</span><br><span class="line">│   ├── ngx_files.h</span><br><span class="line">│   ├── ngx_gcc_atomic_x86.h</span><br><span class="line">│   ├── ngx_hash.h</span><br><span class="line">│   ├── ngx_http_busy_lock.h</span><br><span class="line">│   ├── ngx_http_cache.h</span><br><span class="line">│   ├── ngx_http_config.h</span><br><span class="line">│   ├── ngx_http_core_module.h</span><br><span class="line">│   ├── ngx_http.h</span><br><span class="line">│   ├── ngx_http_reqstat.h</span><br><span class="line">│   ├── ngx_http_request.h</span><br><span class="line">│   ├── ngx_http_script.h</span><br><span class="line">│   ├── ngx_http_ssi_filter_module.h</span><br><span class="line">│   ├── ngx_http_ssl_module.h</span><br><span class="line">│   ├── ngx_http_upstream.h</span><br><span class="line">│   ├── ngx_http_upstream_round_robin.h</span><br><span class="line">│   ├── ngx_http_v2.h</span><br><span class="line">│   ├── ngx_http_v2_module.h</span><br><span class="line">│   ├── ngx_http_variables.h</span><br><span class="line">│   ├── ngx_inet.h</span><br><span class="line">│   ├── ngx_linux_config.h</span><br><span class="line">│   ├── ngx_linux.h</span><br><span class="line">│   ├── ngx_list.h</span><br><span class="line">│   ├── ngx_log.h</span><br><span class="line">│   ├── ngx_md5.h</span><br><span class="line">│   ├── ngx_murmurhash.h</span><br><span class="line">│   ├── ngx_open_file_cache.h</span><br><span class="line">│   ├── ngx_os.h</span><br><span class="line">│   ├── ngx_palloc.h</span><br><span class="line">│   ├── ngx_parse.h</span><br><span class="line">│   ├── ngx_pipe.h</span><br><span class="line">│   ├── ngx_process_cycle.h</span><br><span class="line">│   ├── ngx_process.h</span><br><span class="line">│   ├── ngx_proc.h</span><br><span class="line">│   ├── ngx_proxy_protocol.h</span><br><span class="line">│   ├── ngx_queue.h</span><br><span class="line">│   ├── ngx_radix_tree.h</span><br><span class="line">│   ├── ngx_rbtree.h</span><br><span class="line">│   ├── ngx_regex.h</span><br><span class="line">│   ├── ngx_resolver.h</span><br><span class="line">│   ├── ngx_segment_tree.h</span><br><span class="line">│   ├── ngx_setaffinity.h</span><br><span class="line">│   ├── ngx_setproctitle.h</span><br><span class="line">│   ├── ngx_sha1.h</span><br><span class="line">│   ├── ngx_shmem.h</span><br><span class="line">│   ├── ngx_shmtx.h</span><br><span class="line">│   ├── ngx_slab.h</span><br><span class="line">│   ├── ngx_socket.h</span><br><span class="line">│   ├── ngx_string.h</span><br><span class="line">│   ├── ngx_sysinfo.h</span><br><span class="line">│   ├── ngx_syslog.h</span><br><span class="line">│   ├── ngx_thread.h</span><br><span class="line">│   ├── ngx_time.h</span><br><span class="line">│   ├── ngx_times.h</span><br><span class="line">│   ├── ngx_trie.h</span><br><span class="line">│   └── ngx_user.h</span><br><span class="line">├── logs</span><br><span class="line">├── modules</span><br><span class="line">└── sbin</span><br><span class="line">   ├── dso_tool</span><br><span class="line">   └── nginx</span><br><span class="line">6 directories, 101 files</span><br><span class="line"></span><br><span class="line">[root@centos7 tengine-2.1.2]<span class="comment"># ln -s /apps/tengine-2.1.2/sbin/* /usr/sbin/</span></span><br><span class="line">[root@centos7 tengine-2.1.2]<span class="comment"># nginx -v</span></span><br><span class="line">Tengine version: Tengine/2.1.2 (nginx/1.6.2)</span><br><span class="line"></span><br><span class="line">[root@centos7 tengine-2.1.2]<span class="comment"># nginx</span></span><br><span class="line">[root@centos7 ~]<span class="comment"># ss -tnl</span></span><br><span class="line">State     Recv-Q Send-Q   Local Address:Port Peer Address:Port              </span><br><span class="line">LISTEN     0      128                 *:80               *:*                  </span><br><span class="line">LISTEN     0      128                 *:22               *:*                  </span><br><span class="line">LISTEN     0      100          127.0.0.1:25               *:*                  </span><br><span class="line">LISTEN     0      128               [::]:22           [::]:*                  </span><br><span class="line">LISTEN     0      100             [::1]:25           [::]:*   </span><br><span class="line">[root@centos7 ~]<span class="comment"># curl 10.0.0.7</span></span><br><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;<span class="built_in">head</span>&gt;</span><br><span class="line">&lt;title&gt;Welcome to tengine!&lt;/title&gt;</span><br><span class="line">&lt;style&gt;</span><br><span class="line">   body &#123;</span><br><span class="line">       width: 35em;</span><br><span class="line">       margin: 0 auto;</span><br><span class="line">       font-family: Tahoma, Verdana, Arial, sans-serif;</span><br><span class="line">   &#125;</span><br><span class="line">&lt;/style&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">&lt;h1&gt;Welcome to tengine!&lt;/h1&gt;</span><br><span class="line">&lt;p&gt;If you see this page, the tengine web server is successfully installed and working. Further configuration is required.&lt;/p&gt;</span><br><span class="line">&lt;p&gt;For online documentation and support please refer to</span><br><span class="line">&lt;a href=<span class="string">&quot;http://tengine.taobao.org/&quot;</span>&gt;tengine.taobao.org&lt;/a&gt;.&lt;/p&gt;</span><br><span class="line">&lt;p&gt;&lt;em&gt;Thank you <span class="keyword">for</span> using tengine.&lt;/em&gt;&lt;/p&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure>

<h4 id="在tengine-2-1-2中添加-lua-动态模块"><a href="#在tengine-2-1-2中添加-lua-动态模块" class="headerlink" title="在tengine-2.1.2中添加 lua 动态模块"></a>在tengine-2.1.2中添加 lua 动态模块</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#基于上一小节继续以下操作</span></span><br><span class="line">[root@centos7 ~]<span class="comment"># yum -y install lua-devel</span></span><br><span class="line">[root@centos7 ~]<span class="comment"># cd /usr/local/src/tengine-2.1.2</span></span><br><span class="line">[root@centos7 tengine-2.1.2]<span class="comment"># ./configure --help |grep http_lua</span></span><br><span class="line">--with-http_lua_module         <span class="built_in">enable</span> ngx_http_lua_module (will also <span class="built_in">enable</span> --with-md5 and --with-sha1)</span><br><span class="line">--with-http_lua_module=shared <span class="built_in">enable</span> ngx_http_lua_module (shared) (will also <span class="built_in">enable</span> --with-md5 and --with-sha1)</span><br><span class="line"></span><br><span class="line">[root@centos7 tengine-2.1.2]<span class="comment"># ./configure --prefix=/apps/tengine-2.1.2 --user=nginx \</span></span><br><span class="line">--group=nginx --with-http_ssl_module --with-http_v2_module --with-http_realip_module \</span><br><span class="line">--with-http_stub_status_module --with-http_gzip_static_module --with-pcre --with-http_lua_module=shared</span><br><span class="line"></span><br><span class="line">[root@centos7 tengine-2.1.2]<span class="comment"># make dso_install</span></span><br><span class="line">[root@centos7 tengine-2.1.2]<span class="comment"># tree /apps/tengine-2.1.2/modules/</span></span><br><span class="line">/apps/tengine-2.1.2/modules/</span><br><span class="line">└── ngx_http_lua_module.so</span><br><span class="line">0 directories, 1 file</span><br><span class="line"></span><br><span class="line">[root@centos7 tengine-2.1.2]<span class="comment"># vim /apps/tengine-2.1.2/conf/nginx.conf</span></span><br><span class="line">......</span><br><span class="line">events &#123;</span><br><span class="line">   worker_connections  1024;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment"># load modules compiled as Dynamic Shared Object (DSO)</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#dso &#123;</span></span><br><span class="line"><span class="comment">#   load ngx_http_fastcgi_module.so;</span></span><br><span class="line"><span class="comment">#   load ngx_http_rewrite_module.so;</span></span><br><span class="line"><span class="comment">#&#125;</span></span><br><span class="line">dso &#123;                                                                             </span><br><span class="line">                          </span><br><span class="line">   load ngx_http_lua_module.so;</span><br><span class="line">&#125;</span><br><span class="line">http &#123;</span><br><span class="line">......</span><br><span class="line"></span><br><span class="line">[root@centos7 tengine-2.1.2]<span class="comment"># nginx -t</span></span><br><span class="line">the configuration file /apps/tengine-2.1.2/conf/nginx.conf syntax is ok</span><br><span class="line">configuration file /apps/tengine-2.1.2/conf/nginx.conf <span class="built_in">test</span> is successful</span><br><span class="line"></span><br><span class="line">[root@centos7 tengine-2.1.2]<span class="comment"># nginx -V |&amp; grep share</span></span><br><span class="line">   ngx_http_lua_module (shared, 3.1)</span><br></pre></td></tr></table></figure>

<h4 id="编译安装-tengine-2-3-3"><a href="#编译安装-tengine-2-3-3" class="headerlink" title="编译安装 tengine-2.3.3"></a>编译安装 tengine-2.3.3</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ~]<span class="comment"># yum -y install gcc pcre-devel openssl-devel</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># groupadd --gid 666 -r nginx</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># useradd -g nginx -u 666 -r -s /sbin/nologin nginx</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># cd /usr/local/src</span></span><br><span class="line">[root@centos8 src]<span class="comment"># wget http://tengine.taobao.org/download/tengine-2.3.3.tar.gz</span></span><br><span class="line">[root@centos8 src]<span class="comment"># tar xvf tengine-2.3.3.tar.gz</span></span><br><span class="line">[root@centos8 src]<span class="comment"># cd tengine-2.3.3/</span></span><br><span class="line">[root@centos8 tengine-2.3.3]<span class="comment"># ./configure --prefix=/apps/tengine-2.3.2 --user=nginx \</span></span><br><span class="line">--group=nginx --with-http_ssl_module --with-http_v2_module --with-http_realip_module \</span><br><span class="line">--with-http_stub_status_module --with-http_gzip_static_module --with-pcre --with-stream \</span><br><span class="line">--with-stream_ssl_module --with-stream_realip_module</span><br><span class="line"></span><br><span class="line">[root@centos8 tengine-2.3.3]<span class="comment"># make &amp;&amp; make install</span></span><br><span class="line">[root@centos8 tengine-2.3.3]<span class="comment"># tree /apps/tengine-2.3.3/</span></span><br><span class="line">/apps/tengine-2.3.3/</span><br><span class="line">├── conf</span><br><span class="line">│   ├── fastcgi.conf</span><br><span class="line">│   ├── fastcgi.conf.default</span><br><span class="line">│   ├── fastcgi_params</span><br><span class="line">│   ├── fastcgi_params.default</span><br><span class="line">│   ├── koi-utf</span><br><span class="line">│   ├── koi-win</span><br><span class="line">│   ├── mime.types</span><br><span class="line">│   ├── mime.types.default</span><br><span class="line">│   ├── nginx.conf</span><br><span class="line">│   ├── nginx.conf.default</span><br><span class="line">│   ├── scgi_params</span><br><span class="line">│   ├── scgi_params.default</span><br><span class="line">│   ├── uwsgi_params</span><br><span class="line">│   ├── uwsgi_params.default</span><br><span class="line">│   └── win-utf</span><br><span class="line">├── html</span><br><span class="line">│   ├── 50x.html</span><br><span class="line">│   └── index.html</span><br><span class="line">├── logs</span><br><span class="line">└── sbin</span><br><span class="line">   └── nginx</span><br><span class="line">4 directories, 18 files</span><br><span class="line"></span><br><span class="line">[root@centos8 tengine-2.3.3]<span class="comment"># ln -s /apps/tengine-2.3.3/sbin/* /usr/sbin/</span></span><br><span class="line">[root@centos8 tengine-2.3.3]<span class="comment"># nginx -v</span></span><br><span class="line">Tengine version: Tengine/2.3.3</span><br><span class="line">nginx version: nginx/1.17.3</span><br><span class="line"></span><br><span class="line">[root@centos8 tengine-2.3.3]<span class="comment"># nginx </span></span><br><span class="line">[root@centos8 tengine-2.3.3]<span class="comment"># ps aux|grep nginx</span></span><br><span class="line">root       31008  0.0  0.0  41188   864 ?       Ss   13:10   0:00 nginx: master process nginx</span><br><span class="line">nginx      31009  0.0  0.5  74732  5260 ?       S    13:10   0:00 nginx: worker process</span><br><span class="line">root       31011  0.0  0.1  12108  1064 pts/0   S+   13:10   0:00 grep --color=auto nginx</span><br><span class="line"></span><br><span class="line">[root@centos8 tengine-2.3.2]<span class="comment"># ss -ntl</span></span><br><span class="line">State             Recv-Q           Send-Q   Local Address:Port Peer Address:Port           </span><br><span class="line">LISTEN            0                 128            0.0.0.0:80         0.0.0.0:*</span><br><span class="line">LISTEN            0                 128            0.0.0.0:22         0.0.0.0:*             </span><br><span class="line">LISTEN            0                 100          127.0.0.1:25         0.0.0.0:*             </span><br><span class="line">LISTEN            0                 128               [::]:22            [::]:*            </span><br><span class="line">LISTEN            0                 100              [::1]:25            [::]:*</span><br><span class="line"></span><br><span class="line">[root@centos8 ~]<span class="comment"># curl 10.0.0.8</span></span><br><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;<span class="built_in">head</span>&gt;</span><br><span class="line">&lt;title&gt;Welcome to tengine!&lt;/title&gt;</span><br><span class="line">&lt;style&gt;</span><br><span class="line">   body &#123;</span><br><span class="line">       width: 35em;</span><br><span class="line">       margin: 0 auto;</span><br><span class="line">       font-family: Tahoma, Verdana, Arial, sans-serif;</span><br><span class="line">   &#125;</span><br><span class="line">&lt;/style&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">&lt;h1&gt;Welcome to tengine!&lt;/h1&gt;</span><br><span class="line">&lt;p&gt;If you see this page, the tengine web server is successfully installed and</span><br><span class="line">working. Further configuration is required.&lt;/p&gt;</span><br><span class="line">&lt;p&gt;For online documentation and support please refer to</span><br><span class="line">&lt;a href=<span class="string">&quot;http://tengine.taobao.org/&quot;</span>&gt;tengine.taobao.org&lt;/a&gt;.&lt;/p&gt;</span><br><span class="line">&lt;p&gt;&lt;em&gt;Thank you <span class="keyword">for</span> using tengine.&lt;/em&gt;&lt;/p&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure>

<h3 id="concat-模块使用"><a href="#concat-模块使用" class="headerlink" title="concat 模块使用"></a>concat 模块使用</h3><h4 id="concat模块说明"><a href="#concat模块说明" class="headerlink" title="concat模块说明"></a>concat模块说明</h4><p>网站中的css、js等文件都是小文件，单个文件大小几k甚至几十个字节，而小而多的文件会造成网站加载时http请求较多，且网络传输时间比较短，甚至有时候请求时间比传输时间还长.当网站的这类小文件很多时，大量的http请求就会造成传输效率低，影响网站的访问速度和客户端体验，这时合并http请求就非常有必要了，concat模块就提供了合并文件http请求的功能，这个模块由淘宝开发，功能和apache的mod_concat模块类似</p>
<p>模块说明</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://tengine.taobao.org/document_cn/http_concat_cn.html</span><br></pre></td></tr></table></figure>

<p>访问方式</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">请求参数需要用两个问号（&#x27;??&#x27;）例如：</span><br><span class="line">http://example.com/??style1.css,style2.css,foo/style3.css</span><br><span class="line"></span><br><span class="line">参数中某位置只包含一个‘?’，则&#x27;?&#x27;后表示文件的版本，例如：</span><br><span class="line">http://example.com/??style1.css,style2.css,foo/style3.css?v=102234</span><br></pre></td></tr></table></figure>

<h4 id="编译安装-concat-模块"><a href="#编译安装-concat-模块" class="headerlink" title="编译安装 concat 模块"></a>编译安装 concat 模块</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#基于上一小节继续以下操作</span></span><br><span class="line">[root@centos7 ~]<span class="comment"># cd /usr/local/src/tengine-2.1.2</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#tengine-2.1.2有此模块</span></span><br><span class="line">[root@centos7 tengine-2.1.2]<span class="comment">#./configure --help |grep http_concat</span></span><br><span class="line">  --with-http_concat_module         <span class="built_in">enable</span> ngx_http_concat_module</span><br><span class="line">  --with-http_concat_module=shared   <span class="built_in">enable</span> ngx_http_concat_module (shared)</span><br><span class="line"></span><br><span class="line"><span class="comment">#tengine-2.3.2无此模块</span></span><br><span class="line">[root@centos8 tengine-2.3.2]<span class="comment"># ./configure --help |grep http_concat</span></span><br><span class="line">[root@centos8 tengine-2.3.2]<span class="comment">#</span></span><br><span class="line">[root@centos7 tengine-2.1.2]<span class="comment"># ./configure --prefix=/apps/tengine-2.1.2 --user=nginx \</span></span><br><span class="line">--group=nginx --with-http_ssl_module --with-http_v2_module --with-http_realip_module \</span><br><span class="line">--with-http_stub_status_module --with-http_gzip_static_module --with-pcre \</span><br><span class="line">--with-http_lua_module=shared --with-http_concat_module=shared</span><br><span class="line"></span><br><span class="line">[root@centos7 tengine-2.1.2]<span class="comment"># make dso_install</span></span><br><span class="line">[root@centos7 tengine-2.1.2]<span class="comment"># tree /apps/tengine-2.1.2/modules/</span></span><br><span class="line">/apps/tengine-2.1.2/modules/</span><br><span class="line">├── ngx_http_concat_module.so</span><br><span class="line">└── ngx_http_lua_module.so</span><br><span class="line">0 directories, 2 files</span><br><span class="line"></span><br><span class="line"><span class="comment">#通过动态模块实现concat功能：</span></span><br><span class="line">[root@centos7 ~]<span class="comment"># vim /apps/tengine-2.1.2/conf/nginx.conf</span></span><br><span class="line">dso &#123;</span><br><span class="line">   load ngx_http_lua_module.so;</span><br><span class="line">   load ngx_http_concat_module.so;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">[root@centos7 ~]<span class="comment"># nginx -t</span></span><br><span class="line">the configuration file /apps/tengine-2.1.2/conf/nginx.conf syntax is ok</span><br><span class="line">configuration file /apps/tengine-2.1.2/conf/nginx.conf <span class="built_in">test</span> is successful</span><br><span class="line"></span><br><span class="line">[root@centos7 ~]<span class="comment"># nginx -s reload</span></span><br><span class="line">[root@centos7 tengine-2.1.2]<span class="comment"># nginx -V 2&gt;&amp;1| grep share</span></span><br><span class="line">   ngx_http_concat_module (shared, 3.1)</span><br><span class="line">   ngx_http_lua_module (shared, 3.1)</span><br><span class="line">   </span><br><span class="line"><span class="comment">#通过重新编译tengine实现concat功能：</span></span><br><span class="line">./configure --with-http_concat_module</span><br></pre></td></tr></table></figure>

<h3 id="tengine配置文件"><a href="#tengine配置文件" class="headerlink" title="tengine配置文件"></a>tengine配置文件</h3><p>tengine兼容Nginx指定版本的配置参数</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#tengine配置文件：</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># cat /apps/tenginx/conf/conf.d/pc.conf</span></span><br><span class="line">server &#123;</span><br><span class="line"> listen 80;</span><br><span class="line"> server_name www.wang.org *.www.wang.org pc.wang.org;</span><br><span class="line"> location / &#123;</span><br><span class="line">   concat on;</span><br><span class="line">   root html;</span><br><span class="line">   index index.html index.htm;</span><br><span class="line"> &#125;</span><br><span class="line"> location ~ \.php$ &#123;</span><br><span class="line">   root /data/php;</span><br><span class="line">   fastcgi_pass 10.0.0.18:9000;</span><br><span class="line">   fastcgi_index index.php;</span><br><span class="line"> <span class="comment">#fastcgi_param SCRIPT_FILENAME /data/nginx/php$fastcgi_script_name;</span></span><br><span class="line">   fastcgi_param SCRIPT_FILENAME $document_root<span class="variable">$fastcgi_script_name</span>;</span><br><span class="line">   include fastcgi_params;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="openresty"><a href="#openresty" class="headerlink" title="openresty"></a>openresty</h2><h3 id="openresty-介绍"><a href="#openresty-介绍" class="headerlink" title="openresty 介绍"></a>openresty 介绍</h3><p><img src="../../../../images/SRE/day28/202.jpg" alt="202"></p>
<p>Nginx 是俄罗斯人发明的， Lua 是巴西几个教授发明的，中国人章亦春把 LuaJIT VM 嵌入到 Nginx 中，实现了 OpenResty 这个高性能服务端解决方案</p>
<p>OpenResty® 是一个基于 Nginx 与 Lua 的高性能 Web 平台，其内部集成了大量精良的 Lua 库、第三方模块以及大多数的依赖项。用于方便地搭建能够处理超高并发、扩展性极高的动态 Web 应用、Web 服务和动态网关。</p>
<p>OpenResty® 通过汇聚各种设计精良的 Nginx 模块（主要由 OpenResty 团队自主开发），从而将 Nginx 有效地变成一个强大的通用 Web 应用平台。这样，Web 开发人员和系统工程师可以使用 Lua 脚本语言调动 Nginx 支持的各种 C 以及 Lua 模块，快速构造出足以胜任 10K 乃至 1000K 以上单机并发连接的高性能 Web 应用系统。</p>
<p>OpenResty® 的目标是让你的Web服务直接跑在 Nginx 服务内部，充分利用 Nginx 的非阻塞 I/O 模型，不仅仅对HTTP 客户端请求,甚至于对远程后端诸如 MySQL、PostgreSQL、Memcached 以及 Redis 等都进行一致的高性能响应。</p>
<p>OpenResty 由于有功能强大且方便的的API,可扩展性更强,如果需要实现定制功能,OpenResty是个不错的选择</p>
<p>官网: <a target="_blank" rel="noopener" href="http://openresty.org/cn/">http://openresty.org/cn/</a></p>
<h3 id="编译安装-openresty"><a href="#编译安装-openresty" class="headerlink" title="编译安装 openresty"></a>编译安装 openresty</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ~]<span class="comment"># dnf -yq install gcc pcre-devel openssl-devel perl</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># groupadd --gid 666 -r nginx</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># useradd -g nginx -u 666 -r -s /sbin/nologin nginx</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># cd /usr/local/src</span></span><br><span class="line">[root@centos8 src]<span class="comment"># wget https://openresty.org/download/openresty-1.21.4.1.tar.gz</span></span><br><span class="line"><span class="comment">#[root@centos8 src]# wget https://openresty.org/download/openresty-1.17.8.2.tar.gz</span></span><br><span class="line"></span><br><span class="line">[root@centos8 src]<span class="comment"># tar xf openresty-1.17.8.2.tar.gz </span></span><br><span class="line">[root@centos8 src]<span class="comment"># cd openresty-1.17.8.2/</span></span><br><span class="line">[root@centos8 openresty-1.17.8.2]<span class="comment"># ./configure --prefix=/apps/openresty --user=nginx \</span></span><br><span class="line">--group=nginx --with-http_ssl_module --with-http_v2_module --with-http_realip_module \</span><br><span class="line">--with-http_stub_status_module --with-http_gzip_static_module --with-pcre --with-stream \</span><br><span class="line">--with-stream_ssl_module --with-stream_realip_module</span><br><span class="line"></span><br><span class="line">[root@centos8 openresty-1.17.8.2]<span class="comment"># make &amp;&amp; make install</span></span><br><span class="line">[root@centos8 openresty-1.17.8.2]<span class="comment"># tree /apps/openresty/</span></span><br><span class="line">./apps/openresty/</span><br><span class="line">├── bin</span><br><span class="line">│   ├── md2pod.pl</span><br><span class="line">│   ├── nginx-xml2pod</span><br><span class="line">│   ├── openresty -&gt; /apps/openresty/nginx/sbin/nginx</span><br><span class="line">│   ├── opm</span><br><span class="line">│   ├── resty</span><br><span class="line">│   ├── restydoc</span><br><span class="line">│   └── restydoc-index</span><br><span class="line">......</span><br><span class="line"></span><br><span class="line">83 directories, 313 files</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@centos8 openresty-1.17.8.2]<span class="comment"># ln -s /apps/openresty/bin/* /usr/bin/</span></span><br><span class="line">[root@centos8 openresty-1.17.8.2]<span class="comment"># openresty -v</span></span><br><span class="line">nginx version: openresty/1.17.8.2</span><br><span class="line"></span><br><span class="line">[root@centos8 openresty-1.17.8.2]<span class="comment"># openresty </span></span><br><span class="line">[root@centos8 openresty-1.17.8.2]<span class="comment"># ss -ntl</span></span><br><span class="line">State             Recv-Q           Send-Q       Local Address:Port   Peer Address:Port</span><br><span class="line">LISTEN            0                 128                 0.0.0.0:80         0.0.0.0:*</span><br><span class="line">LISTEN            0                 128                 0.0.0.0:22         0.0.0.0:*</span><br><span class="line">LISTEN            0                 100               127.0.0.1:25         0.0.0.0:*</span><br><span class="line">LISTEN            0                 128                   [::]:22             [::]:*</span><br><span class="line">LISTEN            0                 100                   [::1]:25            [::]:*  </span><br><span class="line"></span><br><span class="line">[root@centos8 openresty-1.17.8.2]<span class="comment"># ps -ef |grep nginx</span></span><br><span class="line">root       16682       1  0 13:50 ?        00:00:00 nginx: master process openresty</span><br><span class="line">nginx      16683   16682  0 13:50 ?        00:00:00 nginx: worker process</span><br><span class="line">root       16692    1195  0 13:51 pts/1    00:00:00 grep --color=auto nginx</span><br><span class="line"></span><br><span class="line">[root@centos8 ~]<span class="comment"># curl 10.0.0.18</span></span><br><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;<span class="built_in">head</span>&gt;</span><br><span class="line">&lt;title&gt;Welcome to OpenResty!&lt;/title&gt;</span><br><span class="line">&lt;style&gt;</span><br><span class="line">   body &#123;</span><br><span class="line">       width: 35em;</span><br><span class="line">       margin: 0 auto;</span><br><span class="line">       font-family: Tahoma, Verdana, Arial, sans-serif;</span><br><span class="line">   &#125;</span><br><span class="line">&lt;/style&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">&lt;h1&gt;Welcome to OpenResty!&lt;/h1&gt;</span><br><span class="line">&lt;p&gt;If you see this page, the OpenResty web platform is successfully installed and working. Further configuration is required.&lt;/p&gt;</span><br><span class="line">&lt;p&gt;For online documentation and support please refer to</span><br><span class="line">&lt;a href=<span class="string">&quot;https://openresty.org/&quot;</span>&gt;openresty.org&lt;/a&gt;.&lt;br/&gt;</span><br><span class="line">Commercial support is available at</span><br><span class="line">&lt;a href=<span class="string">&quot;https://openresty.com/&quot;</span>&gt;openresty.com&lt;/a&gt;.&lt;/p&gt;</span><br><span class="line">&lt;p&gt;&lt;em&gt;Thank you <span class="keyword">for</span> flying OpenResty.&lt;/em&gt;&lt;/p&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure>

<p><img src="../../../../images/SRE/day28/203.jpg" alt="203"></p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="http://example.com">૮(˶ᵔ ᵕ ᵔ˶)ა</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="http://example.com/2025/03/03/SRE-Nginx/">http://example.com/2025/03/03/SRE-Nginx/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="http://example.com" target="_blank">૮(˶ᵔ ᵕ ᵔ˶)ა</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/Nginx/">Nginx</a><a class="post-meta__tags" href="/tags/SRE/">SRE</a></div><div class="post_share"><div class="social-share" data-image="/../images/TITLE/nginx_logo.png" data-sites="wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2025/02/21/SRE-LVS/" title="企业级调度器LVS"><img class="cover" src="/../images/SRE/day27/3.png" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">企业级调度器LVS</div></div></a></div><div class="next-post pull-right"><a href="/2025/03/03/SRE-jumpserver/" title="企业级堡垒机JumpServer"><img class="cover" src="https://www.jumpserver.org/images/logo/logo-dark-JumpServer.svg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">企业级堡垒机JumpServer</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><div><a href="/2023/04/01/DN-Nginx/" title="Nginx"><img class="cover" src="/../images/TITLE/nginx_logo.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-04-01</div><div class="title">Nginx</div></div></a></div><div><a href="/2025/04/15/SRE-HAProxy/" title="高可用性集群HAProxy"><img class="cover" src="/../images/SRE/day47/1.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2025-04-15</div><div class="title">高可用性集群HAProxy</div></div></a></div><div><a href="/2025/02/21/SRE-LVS/" title="企业级调度器LVS"><img class="cover" src="/../images/SRE/day27/3.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2025-02-21</div><div class="title">企业级调度器LVS</div></div></a></div><div><a href="/2024/04/24/SRE-Linux%E5%9F%BA%E6%9C%AC%E6%93%8D%E4%BD%9C%E5%92%8C%E5%B8%AE%E5%8A%A9/" title="Linux基本操作和帮助"><img class="cover" src="/../images/TITLE/linux2.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-04-24</div><div class="title">Linux基本操作和帮助</div></div></a></div><div><a href="/2025/04/16/SRE-Keepalived/" title="高可用性集群Keepalived"><img class="cover" src="/../images/SRE/day48/1.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2025-04-16</div><div class="title">高可用性集群Keepalived</div></div></a></div><div><a href="/2024/08/27/SRE-Linux%E6%96%87%E4%BB%B6%E7%AE%A1%E7%90%86%E5%92%8CIO%E9%87%8D%E5%AE%9A%E5%90%91/" title="Linux文件管理和IO重定向"><img class="cover" src="/../images/TITLE/linux3.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-08-27</div><div class="title">Linux文件管理和IO重定向</div></div></a></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="/../images/TITLE/user.webp" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">૮(˶ᵔ ᵕ ᵔ˶)ა</div><div class="author-info__description">这家伙很勤奋，什么都留下了</div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">105</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">42</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">35</div></a></div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content is-expand"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#WEB-%E6%9C%8D%E5%8A%A1%E5%92%8CHTTP%E5%8D%8F%E8%AE%AE"><span class="toc-number">1.</span> <span class="toc-text">WEB 服务和HTTP协议</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Internet-%E5%9B%A0%E7%89%B9%E7%BD%91"><span class="toc-number">1.1.</span> <span class="toc-text">Internet 因特网</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Internet-%E5%92%8C%E4%B8%AD%E5%9B%BD"><span class="toc-number">1.2.</span> <span class="toc-text">Internet 和中国</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#HTTP-%E8%B6%85%E6%96%87%E6%9C%AC%E4%BC%A0%E8%BE%93%E5%8D%8F%E8%AE%AE"><span class="toc-number">1.3.</span> <span class="toc-text">HTTP 超文本传输协议</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#HTTP-%E7%9B%B8%E5%85%B3%E6%A6%82%E5%BF%B5"><span class="toc-number">1.3.1.</span> <span class="toc-text">HTTP 相关概念</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B5%8F%E8%A7%88%E5%99%A8%E8%AE%BF%E9%97%AE%E7%BD%91%E7%AB%99%E7%9A%84%E8%BF%87%E7%A8%8B"><span class="toc-number">1.3.2.</span> <span class="toc-text">浏览器访问网站的过程</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#HTTP-%E5%8D%8F%E8%AE%AE%E9%80%9A%E4%BF%A1%E8%BF%87%E7%A8%8B"><span class="toc-number">1.3.3.</span> <span class="toc-text">HTTP 协议通信过程</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#HTTP-%E7%9B%B8%E5%85%B3%E6%8A%80%E6%9C%AF"><span class="toc-number">1.3.4.</span> <span class="toc-text">HTTP 相关技术</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#WEB-%E5%BC%80%E5%8F%91%E8%AF%AD%E8%A8%80"><span class="toc-number">1.3.4.1.</span> <span class="toc-text">WEB 开发语言</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#MIME"><span class="toc-number">1.3.4.2.</span> <span class="toc-text">MIME</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#URI%E5%92%8CURL"><span class="toc-number">1.3.4.3.</span> <span class="toc-text">URI和URL</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%BD%91%E7%AB%99%E8%AE%BF%E9%97%AE%E9%87%8F"><span class="toc-number">1.3.4.4.</span> <span class="toc-text">网站访问量</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#HTTP%E5%B7%A5%E4%BD%9C%E6%9C%BA%E5%88%B6"><span class="toc-number">1.3.5.</span> <span class="toc-text">HTTP工作机制</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#HTTP-%E5%8D%8F%E8%AE%AE%E7%89%88%E6%9C%AC"><span class="toc-number">1.3.6.</span> <span class="toc-text">HTTP 协议版本</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#HTTP-1-X-%E5%8D%8F%E8%AE%AE"><span class="toc-number">1.3.6.1.</span> <span class="toc-text">HTTP 1.X 协议</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#HTTP-2-0-%E5%8D%8F%E8%AE%AE"><span class="toc-number">1.3.6.2.</span> <span class="toc-text">HTTP 2.0 协议</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#HTTP-3-0-%E5%8D%8F%E8%AE%AE"><span class="toc-number">1.3.6.3.</span> <span class="toc-text">HTTP 3.0 协议</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#HTTP-%E8%AF%B7%E6%B1%82%E8%AE%BF%E9%97%AE%E7%9A%84%E5%AE%8C%E6%95%B4%E8%BF%87%E7%A8%8B"><span class="toc-number">1.3.7.</span> <span class="toc-text">HTTP 请求访问的完整过程</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#HTTP-%E5%8D%8F%E8%AE%AE%E6%8A%A5%E6%96%87%E5%A4%B4%E9%83%A8%E7%BB%93%E6%9E%84"><span class="toc-number">1.4.</span> <span class="toc-text">HTTP 协议报文头部结构</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#HTTP-%E8%AF%B7%E6%B1%82%E6%8A%A5%E6%96%87"><span class="toc-number">1.4.1.</span> <span class="toc-text">HTTP 请求报文</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#HTTP%E5%93%8D%E5%BA%94%E6%8A%A5%E6%96%87"><span class="toc-number">1.4.2.</span> <span class="toc-text">HTTP响应报文</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#HTTP%E6%8A%A5%E6%96%87%E6%A0%BC%E5%BC%8F%E8%AF%A6%E8%A7%A3"><span class="toc-number">1.4.3.</span> <span class="toc-text">HTTP报文格式详解</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Method-%E6%96%B9%E6%B3%95"><span class="toc-number">1.4.3.1.</span> <span class="toc-text">Method 方法</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#version%E7%89%88%E6%9C%AC"><span class="toc-number">1.4.3.2.</span> <span class="toc-text">version版本</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#status-%E7%8A%B6%E6%80%81%E7%A0%81"><span class="toc-number">1.4.3.3.</span> <span class="toc-text">status 状态码</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#reason-phrase%E5%8E%9F%E5%9B%A0%E7%9F%AD%E8%AF%AD"><span class="toc-number">1.4.3.4.</span> <span class="toc-text">reason-phrase原因短语</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#headers%E9%A6%96%E9%83%A8%E5%AD%97%E6%AE%B5%E5%A4%B4"><span class="toc-number">1.4.3.5.</span> <span class="toc-text">headers首部字段头</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#entity-body%E5%AE%9E%E4%BD%93"><span class="toc-number">1.4.3.6.</span> <span class="toc-text">entity-body实体</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Cookie-%E5%92%8C-Session"><span class="toc-number">1.4.4.</span> <span class="toc-text">Cookie 和 Session</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Cookie"><span class="toc-number">1.4.4.1.</span> <span class="toc-text">Cookie</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Session"><span class="toc-number">1.4.4.2.</span> <span class="toc-text">Session</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#cookie%E5%92%8Csession%E6%AF%94%E8%BE%83"><span class="toc-number">1.4.4.3.</span> <span class="toc-text">cookie和session比较</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Web-%E7%9B%B8%E5%85%B3%E5%B7%A5%E5%85%B7"><span class="toc-number">1.5.</span> <span class="toc-text">Web 相关工具</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#links"><span class="toc-number">1.5.1.</span> <span class="toc-text">links</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#wget"><span class="toc-number">1.5.2.</span> <span class="toc-text">wget</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#curl"><span class="toc-number">1.5.3.</span> <span class="toc-text">curl</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#httpie"><span class="toc-number">1.5.4.</span> <span class="toc-text">httpie</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8E%8B%E5%8A%9B%E6%B5%8B%E8%AF%95%E5%B7%A5%E5%85%B7"><span class="toc-number">1.5.5.</span> <span class="toc-text">压力测试工具</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Web-%E6%9C%8D%E5%8A%A1%E4%BB%8B%E7%BB%8D"><span class="toc-number">1.6.</span> <span class="toc-text">Web 服务介绍</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Apache-%E7%BB%8F%E5%85%B8%E7%9A%84-Web-%E6%9C%8D%E5%8A%A1%E7%AB%AF"><span class="toc-number">1.6.1.</span> <span class="toc-text">Apache 经典的 Web 服务端</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Apache-prefork-%E6%A8%A1%E5%9E%8B"><span class="toc-number">1.6.1.1.</span> <span class="toc-text">Apache prefork 模型</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Apache-worker-%E6%A8%A1%E5%9E%8B"><span class="toc-number">1.6.1.2.</span> <span class="toc-text">Apache worker 模型</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Apache-event-%E6%A8%A1%E5%9E%8B"><span class="toc-number">1.6.1.3.</span> <span class="toc-text">Apache event 模型</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Nginx-%E9%AB%98%E6%80%A7%E8%83%BD%E7%9A%84-Web-%E6%9C%8D%E5%8A%A1%E7%AB%AF"><span class="toc-number">1.6.2.</span> <span class="toc-text">Nginx-高性能的 Web 服务端</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%94%A8%E6%88%B7%E8%AE%BF%E9%97%AE%E4%BD%93%E9%AA%8C%E5%92%8C%E6%80%A7%E8%83%BD"><span class="toc-number">1.6.3.</span> <span class="toc-text">用户访问体验和性能</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%94%A8%E6%88%B7%E8%AE%BF%E9%97%AE%E4%BD%93%E9%AA%8C%E7%BB%9F%E8%AE%A1"><span class="toc-number">1.6.3.1.</span> <span class="toc-text">用户访问体验统计</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%BD%B1%E5%93%8D%E7%94%A8%E6%88%B7%E4%BD%93%E9%AA%8C%E7%9A%84%E5%9B%A0%E7%B4%A0"><span class="toc-number">1.6.3.2.</span> <span class="toc-text">影响用户体验的因素</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9C%8D%E5%8A%A1%E7%AB%AF-I-O-%E6%B5%81%E7%A8%8B"><span class="toc-number">1.6.4.</span> <span class="toc-text">服务端 I&#x2F;O 流程</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%A3%81%E7%9B%98-I-O"><span class="toc-number">1.6.4.1.</span> <span class="toc-text">磁盘 I&#x2F;O</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%BD%91%E7%BB%9C-I-O"><span class="toc-number">1.6.4.2.</span> <span class="toc-text">网络 I&#x2F;O</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#I-O-%E6%A8%A1%E5%9E%8B"><span class="toc-number">1.7.</span> <span class="toc-text">I&#x2F;O 模型</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#I-O-%E6%A8%A1%E5%9E%8B%E7%9B%B8%E5%85%B3%E6%A6%82%E5%BF%B5"><span class="toc-number">1.7.1.</span> <span class="toc-text">I&#x2F;O 模型相关概念</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%90%8C%E6%AD%A5%E5%92%8C%E5%BC%82%E6%AD%A5"><span class="toc-number">1.7.1.1.</span> <span class="toc-text">同步和异步</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%98%BB%E5%A1%9E%E5%92%8C%E9%9D%9E%E9%98%BB%E5%A1%9E"><span class="toc-number">1.7.1.2.</span> <span class="toc-text">阻塞和非阻塞</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BD%91%E7%BB%9C-I-O-%E6%A8%A1%E5%9E%8B"><span class="toc-number">1.7.2.</span> <span class="toc-text">网络 I&#x2F;O 模型</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%98%BB%E5%A1%9E%E5%9E%8B-I-O-%E6%A8%A1%E5%9E%8B%EF%BC%88blocking-IO%EF%BC%89"><span class="toc-number">1.7.2.1.</span> <span class="toc-text">阻塞型 I&#x2F;O 模型（blocking IO）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%9D%9E%E9%98%BB%E5%A1%9E%E5%9E%8B-I-O-%E6%A8%A1%E5%9E%8B-nonblocking-IO"><span class="toc-number">1.7.2.2.</span> <span class="toc-text">非阻塞型 I&#x2F;O 模型 (nonblocking IO)</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#I-O-%E5%A4%9A%E8%B7%AF%E5%A4%8D%E7%94%A8%E5%9E%8B-I-O-multiplexing"><span class="toc-number">1.7.2.3.</span> <span class="toc-text">I&#x2F;O 多路复用型 (I&#x2F;O multiplexing)</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BF%A1%E5%8F%B7%E9%A9%B1%E5%8A%A8%E5%BC%8F-I-O-%E6%A8%A1%E5%9E%8B-signal-driven-IO"><span class="toc-number">1.7.2.4.</span> <span class="toc-text">信号驱动式 I&#x2F;O 模型 (signal-driven IO)</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%BC%82%E6%AD%A5-I-O-%E6%A8%A1%E5%9E%8B-asynchronous-IO"><span class="toc-number">1.7.2.5.</span> <span class="toc-text">异步 I&#x2F;O 模型 (asynchronous IO)</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BA%94%E7%A7%8D-IO-%E5%AF%B9%E6%AF%94"><span class="toc-number">1.7.3.</span> <span class="toc-text">五种 IO 对比</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#I-O-%E7%9A%84%E5%85%B7%E4%BD%93%E5%AE%9E%E7%8E%B0%E6%96%B9%E5%BC%8F"><span class="toc-number">1.7.4.</span> <span class="toc-text">I&#x2F;O 的具体实现方式</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#I-O%E5%B8%B8%E8%A7%81%E5%AE%9E%E7%8E%B0"><span class="toc-number">1.7.4.1.</span> <span class="toc-text">I&#x2F;O常见实现</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%B8%B8%E7%94%A8I-O%E6%A8%A1%E5%9E%8B%E6%AF%94%E8%BE%83"><span class="toc-number">1.7.4.2.</span> <span class="toc-text">常用I&#x2F;O模型比较</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%BC%80%E5%8F%91%E7%9A%84%E9%80%89%E6%8B%A9"><span class="toc-number">1.7.4.3.</span> <span class="toc-text">开发的选择</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%9B%B6%E6%8B%B7%E8%B4%9D"><span class="toc-number">1.8.</span> <span class="toc-text">零拷贝</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%9B%B6%E6%8B%B7%E8%B4%9D%E4%BB%8B%E7%BB%8D"><span class="toc-number">1.8.1.</span> <span class="toc-text">零拷贝介绍</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BC%A0%E7%BB%9F-Linux%E4%B8%AD-I-O-%E7%9A%84%E9%97%AE%E9%A2%98"><span class="toc-number">1.8.1.1.</span> <span class="toc-text">传统 Linux中 I&#x2F;O 的问题</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BB%80%E4%B9%88%E6%98%AF%E9%9B%B6%E6%8B%B7%E8%B4%9D"><span class="toc-number">1.8.1.2.</span> <span class="toc-text">什么是零拷贝</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%9B%B6%E6%8B%B7%E9%A1%B5%E7%9B%B8%E5%85%B3%E6%8A%80%E6%9C%AF"><span class="toc-number">1.8.2.</span> <span class="toc-text">零拷页相关技术</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#MMAP-Memory-Mapping"><span class="toc-number">1.8.2.1.</span> <span class="toc-text">MMAP ( Memory Mapping )</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#SENDFILE"><span class="toc-number">1.8.2.2.</span> <span class="toc-text">SENDFILE</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#DMA%E8%BE%85%E5%8A%A9%E7%9A%84-SENDFILE"><span class="toc-number">1.8.2.3.</span> <span class="toc-text">DMA辅助的 SENDFILE</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Nginx-%E6%9E%B6%E6%9E%84%E5%92%8C%E5%AE%89%E8%A3%85"><span class="toc-number">2.</span> <span class="toc-text">Nginx 架构和安装</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Nginx-%E6%A6%82%E8%BF%B0"><span class="toc-number">2.1.</span> <span class="toc-text">Nginx 概述</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Nginx-%E4%BB%8B%E7%BB%8D"><span class="toc-number">2.1.1.</span> <span class="toc-text">Nginx 介绍</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Nginx-%E5%8A%9F%E8%83%BD%E4%BB%8B%E7%BB%8D"><span class="toc-number">2.1.2.</span> <span class="toc-text">Nginx 功能介绍</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9F%BA%E7%A1%80%E7%89%B9%E6%80%A7"><span class="toc-number">2.1.3.</span> <span class="toc-text">基础特性</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Web-%E6%9C%8D%E5%8A%A1%E7%9B%B8%E5%85%B3%E7%9A%84%E5%8A%9F%E8%83%BD"><span class="toc-number">2.1.4.</span> <span class="toc-text">Web 服务相关的功能</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Nginx-%E6%9E%B6%E6%9E%84%E5%92%8C%E8%BF%9B%E7%A8%8B"><span class="toc-number">2.2.</span> <span class="toc-text">Nginx 架构和进程</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Nginx-%E6%9E%B6%E6%9E%84"><span class="toc-number">2.2.1.</span> <span class="toc-text">Nginx 架构</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Nginx-%E8%BF%9B%E7%A8%8B%E7%BB%93%E6%9E%84"><span class="toc-number">2.2.2.</span> <span class="toc-text">Nginx 进程结构</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Nginx-%E5%90%AF%E5%8A%A8%E5%92%8C-HTTP-%E8%BF%9E%E6%8E%A5%E5%BB%BA%E7%AB%8B"><span class="toc-number">2.2.3.</span> <span class="toc-text">Nginx 启动和 HTTP 连接建立</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#HTTP-%E5%A4%84%E7%90%86%E8%BF%87%E7%A8%8B"><span class="toc-number">2.2.4.</span> <span class="toc-text">HTTP 处理过程</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Nginx-%E6%A8%A1%E5%9D%97%E4%BB%8B%E7%BB%8D"><span class="toc-number">2.3.</span> <span class="toc-text">Nginx 模块介绍</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Nginx-%E5%AE%89%E8%A3%85"><span class="toc-number">2.4.</span> <span class="toc-text">Nginx 安装</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Nginx%E7%89%88%E6%9C%AC%E5%92%8C%E5%AE%89%E8%A3%85%E6%96%B9%E5%BC%8F"><span class="toc-number">2.4.1.</span> <span class="toc-text">Nginx版本和安装方式</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9F%BA%E4%BA%8E-yum-%E5%AE%89%E8%A3%85-Nginx"><span class="toc-number">2.4.2.</span> <span class="toc-text">基于 yum 安装 Nginx</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%9F%A5%E7%9C%8B%E5%BD%93%E5%89%8D%E7%B3%BB%E7%BB%9F%E4%B8%AD%E7%9A%84-nginx-%E7%89%88%E6%9C%AC"><span class="toc-number">2.4.2.1.</span> <span class="toc-text">查看当前系统中的 nginx 版本</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%98%E6%96%B9%E5%8C%85%E6%BA%90%E5%AE%89%E8%A3%85%E6%9C%80%E6%96%B0%E7%89%88%E6%9C%AC-nginx"><span class="toc-number">2.4.2.2.</span> <span class="toc-text">官方包源安装最新版本 nginx</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%A3%80%E6%9F%A5%E5%AE%89%E8%A3%85"><span class="toc-number">2.4.2.3.</span> <span class="toc-text">检查安装</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#nginx-%E7%A8%8B%E5%BA%8F%E7%94%A8%E6%B3%95%E5%B8%AE%E5%8A%A9"><span class="toc-number">2.4.2.4.</span> <span class="toc-text">nginx 程序用法帮助</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%AA%8C%E8%AF%81-Nginx"><span class="toc-number">2.4.2.5.</span> <span class="toc-text">验证 Nginx</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Nginx-%E5%90%AF%E5%8A%A8%E6%96%87%E4%BB%B6"><span class="toc-number">2.4.2.6.</span> <span class="toc-text">Nginx 启动文件</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Nginx-%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6"><span class="toc-number">2.4.2.7.</span> <span class="toc-text">Nginx 配置文件</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%90%AF%E5%8A%A8-Nginx"><span class="toc-number">2.4.2.8.</span> <span class="toc-text">启动 Nginx</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%AE%BF%E9%97%AE-Nginx"><span class="toc-number">2.4.2.9.</span> <span class="toc-text">访问 Nginx</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Nginx-%E7%BC%96%E8%AF%91%E5%AE%89%E8%A3%85"><span class="toc-number">2.4.3.</span> <span class="toc-text">Nginx 编译安装</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%BC%96%E8%AF%91%E5%AE%89%E8%A3%85-Nginx"><span class="toc-number">2.4.3.1.</span> <span class="toc-text">编译安装 Nginx</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%AA%8C%E8%AF%81%E7%89%88%E6%9C%AC%E5%8F%8A%E7%BC%96%E8%AF%91%E5%8F%82%E6%95%B0"><span class="toc-number">2.4.3.2.</span> <span class="toc-text">验证版本及编译参数</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%90%AF%E5%8A%A8%E5%92%8C%E5%81%9C%E6%AD%A2-nginx-%E6%B5%8B%E8%AF%95%E8%AE%BF%E9%97%AE-web-%E7%95%8C%E9%9D%A2"><span class="toc-number">2.4.3.3.</span> <span class="toc-text">启动和停止 nginx 测试访问 web 界面</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA-Nginx-%E8%87%AA%E5%90%AF%E5%8A%A8%E6%96%87%E4%BB%B6"><span class="toc-number">2.4.3.4.</span> <span class="toc-text">创建 Nginx 自启动文件</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%AA%8C%E8%AF%81-Nginx-%E8%87%AA%E5%90%AF%E5%8A%A8%E6%96%87%E4%BB%B6"><span class="toc-number">2.4.3.5.</span> <span class="toc-text">验证 Nginx 自启动文件</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2-nginx"><span class="toc-number">2.4.4.</span> <span class="toc-text">自动化部署 nginx</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%9E%E6%88%98%E6%A1%88%E4%BE%8B-%E4%B8%80%E9%94%AE%E5%AE%89%E8%A3%85-nginx-%E8%84%9A%E6%9C%AC"><span class="toc-number">2.4.4.1.</span> <span class="toc-text">实战案例: 一键安装 nginx 脚本</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%A9%E7%94%A8-ansible-%E7%9A%84playbook-%E5%AE%9E%E7%8E%B0-nginx-%E7%BC%96%E8%AF%91%E5%AE%89%E8%A3%85"><span class="toc-number">2.4.4.2.</span> <span class="toc-text">利用 ansible 的playbook 实现 nginx 编译安装</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%A9%E7%94%A8-ansible-%E7%9A%84role-%E5%AE%9E%E7%8E%B0-nginx-%E7%BC%96%E8%AF%91%E5%AE%89%E8%A3%85"><span class="toc-number">2.4.4.3.</span> <span class="toc-text">利用 ansible 的role 实现 nginx 编译安装</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#nginx-%E5%91%BD%E4%BB%A4%E5%92%8C%E4%BF%A1%E5%8F%B7"><span class="toc-number">2.5.</span> <span class="toc-text">nginx 命令和信号</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#nginx-%E5%91%BD%E4%BB%A4"><span class="toc-number">2.5.1.</span> <span class="toc-text">nginx 命令</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#quit-%E5%AE%9E%E7%8E%B0worker%E8%BF%9B%E7%A8%8B%E4%BC%98%E9%9B%85%E5%85%B3%E9%97%AD"><span class="toc-number">2.5.2.</span> <span class="toc-text">quit 实现worker进程优雅关闭</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#reload-%E6%B5%81%E7%A8%8B"><span class="toc-number">2.5.3.</span> <span class="toc-text">reload 流程</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%B9%B3%E6%BB%91%E5%8D%87%E7%BA%A7%E5%92%8C%E5%9B%9E%E6%BB%9A"><span class="toc-number">2.6.</span> <span class="toc-text">平滑升级和回滚</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B9%B3%E6%BB%91%E5%8D%87%E7%BA%A7%E6%B5%81%E7%A8%8B"><span class="toc-number">2.6.1.</span> <span class="toc-text">平滑升级流程</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B9%B3%E6%BB%91%E5%8D%87%E7%BA%A7%E5%92%8C%E5%9B%9E%E6%BB%9A%E6%A1%88%E4%BE%8B"><span class="toc-number">2.6.2.</span> <span class="toc-text">平滑升级和回滚案例</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Nginx-%E6%A0%B8%E5%BF%83%E6%A8%A1%E5%9D%97"><span class="toc-number">3.</span> <span class="toc-text">Nginx 核心模块</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%E8%AF%B4%E6%98%8E"><span class="toc-number">3.1.</span> <span class="toc-text">配置文件说明</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%A8%E5%B1%80%E9%85%8D%E7%BD%AE"><span class="toc-number">3.2.</span> <span class="toc-text">全局配置</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#http-%E9%85%8D%E7%BD%AE%E5%9D%97"><span class="toc-number">3.3.</span> <span class="toc-text">http 配置块</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#MIME-1"><span class="toc-number">3.3.1.</span> <span class="toc-text">MIME</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%8C%87%E5%AE%9A%E5%93%8D%E5%BA%94%E6%8A%A5%E6%96%87server%E9%A6%96%E9%83%A8"><span class="toc-number">3.3.2.</span> <span class="toc-text">指定响应报文server首部</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%B8%B8%E8%A7%81%E6%A0%B8%E5%BF%83%E6%A8%A1%E5%9D%97%E9%85%8D%E7%BD%AE"><span class="toc-number">3.4.</span> <span class="toc-text">常见核心模块配置</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%96%B0%E5%BB%BA%E4%B8%80%E4%B8%AA-PC-web-%E7%AB%99%E7%82%B9"><span class="toc-number">3.4.1.</span> <span class="toc-text">新建一个 PC web 站点</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%96%B0%E5%BB%BA%E4%B8%80%E4%B8%AA-Mobile-web-%E7%AB%99%E7%82%B9"><span class="toc-number">3.4.2.</span> <span class="toc-text">新建一个 Mobile web 站点</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#root-%E4%B8%8E-alias"><span class="toc-number">3.4.3.</span> <span class="toc-text">root 与 alias</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#location-%E7%9A%84%E8%AF%A6%E7%BB%86%E4%BD%BF%E7%94%A8"><span class="toc-number">3.4.4.</span> <span class="toc-text">location 的详细使用</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8C%B9%E9%85%8D%E6%A1%88%E4%BE%8B-%E7%B2%BE%E7%A1%AE%E5%8C%B9%E9%85%8D"><span class="toc-number">3.4.4.1.</span> <span class="toc-text">匹配案例-精确匹配</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8C%B9%E9%85%8D%E6%A1%88%E4%BE%8B-%E5%8C%BA%E5%88%86%E5%A4%A7%E5%B0%8F%E5%86%99"><span class="toc-number">3.4.4.2.</span> <span class="toc-text">匹配案例-区分大小写</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8C%B9%E9%85%8D%E6%A1%88%E4%BE%8B-%E4%B8%8D%E5%8C%BA%E5%88%86%E5%A4%A7%E5%B0%8F%E5%86%99"><span class="toc-number">3.4.4.3.</span> <span class="toc-text">匹配案例-不区分大小写</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8C%B9%E9%85%8D%E6%A1%88%E4%BE%8B-URI%E5%BC%80%E5%A7%8B"><span class="toc-number">3.4.4.4.</span> <span class="toc-text">匹配案例-URI开始</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8C%B9%E9%85%8D%E6%A1%88%E4%BE%8B-%E6%96%87%E4%BB%B6%E5%90%8D%E5%90%8E%E7%BC%80"><span class="toc-number">3.4.4.5.</span> <span class="toc-text">匹配案例-文件名后缀</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8C%B9%E9%85%8D%E6%A1%88%E4%BE%8B-%E4%BC%98%E5%85%88%E7%BA%A7"><span class="toc-number">3.4.4.6.</span> <span class="toc-text">匹配案例-优先级</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%94%9F%E4%BA%A7%E4%BD%BF%E7%94%A8%E6%A1%88%E4%BE%8B"><span class="toc-number">3.4.4.7.</span> <span class="toc-text">生产使用案例</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Location-%E9%87%8D%E5%AE%9A%E5%90%91"><span class="toc-number">3.4.4.8.</span> <span class="toc-text">Location @重定向</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Nginx-%E5%B8%B8%E8%A7%81%E6%A8%A1%E5%9D%97"><span class="toc-number">4.</span> <span class="toc-text">Nginx 常见模块</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Nginx-%E5%9B%9B%E5%B1%82%E8%AE%BF%E9%97%AE%E6%8E%A7%E5%88%B6"><span class="toc-number">4.1.</span> <span class="toc-text">Nginx 四层访问控制</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Nginx-%E8%B4%A6%E6%88%B7%E8%AE%A4%E8%AF%81%E5%8A%9F%E8%83%BD"><span class="toc-number">4.2.</span> <span class="toc-text">Nginx 账户认证功能</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89%E9%94%99%E8%AF%AF%E9%A1%B5%E9%9D%A2"><span class="toc-number">4.3.</span> <span class="toc-text">自定义错误页面</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89%E9%94%99%E8%AF%AF%E6%97%A5%E5%BF%97"><span class="toc-number">4.4.</span> <span class="toc-text">自定义错误日志</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%A3%80%E6%B5%8B%E6%96%87%E4%BB%B6%E6%98%AF%E5%90%A6%E5%AD%98%E5%9C%A8"><span class="toc-number">4.5.</span> <span class="toc-text">检测文件是否存在</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%95%BF%E8%BF%9E%E6%8E%A5%E9%85%8D%E7%BD%AE"><span class="toc-number">4.6.</span> <span class="toc-text">长连接配置</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BD%9C%E4%B8%BA%E4%B8%8B%E8%BD%BD%E6%9C%8D%E5%8A%A1%E5%99%A8%E9%85%8D%E7%BD%AE"><span class="toc-number">4.7.</span> <span class="toc-text">作为下载服务器配置</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BD%9C%E4%B8%BA%E4%B8%8A%E4%BC%A0%E6%9C%8D%E5%8A%A1%E5%99%A8"><span class="toc-number">4.8.</span> <span class="toc-text">作为上传服务器</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%99%90%E6%B5%81%E9%99%90%E9%80%9F"><span class="toc-number">4.9.</span> <span class="toc-text">限流限速</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%BA%E4%BB%80%E4%B9%88%E8%A6%81%E9%99%90%E9%80%9F"><span class="toc-number">4.9.1.</span> <span class="toc-text">为什么要限速</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%99%90%E9%80%9F%E7%9B%B8%E5%85%B3%E6%A8%A1%E5%9D%97"><span class="toc-number">4.9.2.</span> <span class="toc-text">限速相关模块</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%AF%B7%E6%B1%82%E9%A2%91%E7%8E%87%E9%99%90%E9%80%9F%E5%8E%9F%E7%90%86"><span class="toc-number">4.9.3.</span> <span class="toc-text">请求频率限速原理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%99%90%E5%88%B6%E4%B8%8B%E8%BD%BD%E9%80%9F%E5%BA%A6"><span class="toc-number">4.9.4.</span> <span class="toc-text">限制下载速度</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%99%90%E5%88%B6%E8%AF%B7%E6%B1%82%E6%95%B0"><span class="toc-number">4.9.5.</span> <span class="toc-text">限制请求数</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%99%90%E5%88%B6%E5%B9%B6%E5%8F%91%E8%BF%9E%E6%8E%A5%E6%95%B0"><span class="toc-number">4.9.6.</span> <span class="toc-text">限制并发连接数</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BB%BC%E5%90%88%E5%AE%9E%E6%88%98"><span class="toc-number">4.9.7.</span> <span class="toc-text">综合实战</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Nginx-%E7%8A%B6%E6%80%81%E9%A1%B5"><span class="toc-number">4.10.</span> <span class="toc-text">Nginx 状态页</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Nginx-%E7%AC%AC%E4%B8%89%E6%96%B9%E6%A8%A1%E5%9D%97"><span class="toc-number">4.11.</span> <span class="toc-text">Nginx 第三方模块</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#nginx-module-vts-%E6%A8%A1%E5%9D%97%E5%AE%9E%E7%8E%B0%E6%B5%81%E9%87%8F%E7%9B%91%E6%8E%A7"><span class="toc-number">4.11.1.</span> <span class="toc-text">nginx-module-vts 模块实现流量监控</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#echo-%E6%A8%A1%E5%9D%97%E5%AE%9E%E7%8E%B0%E4%BF%A1%E6%81%AF%E6%98%BE%E7%A4%BA"><span class="toc-number">4.11.2.</span> <span class="toc-text">echo 模块实现信息显示</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Nginx-%E5%8F%98%E9%87%8F%E4%BD%BF%E7%94%A8"><span class="toc-number">4.12.</span> <span class="toc-text">Nginx 变量使用</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%86%85%E7%BD%AE%E5%8F%98%E9%87%8F"><span class="toc-number">4.12.1.</span> <span class="toc-text">内置变量</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89%E5%8F%98%E9%87%8F"><span class="toc-number">4.12.2.</span> <span class="toc-text">自定义变量</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Nginx-%E8%87%AA%E5%AE%9A%E4%B9%89%E8%AE%BF%E9%97%AE%E6%97%A5%E5%BF%97"><span class="toc-number">4.13.</span> <span class="toc-text">Nginx 自定义访问日志</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89%E9%BB%98%E8%AE%A4%E6%A0%BC%E5%BC%8F%E6%97%A5%E5%BF%97"><span class="toc-number">4.13.1.</span> <span class="toc-text">自定义默认格式日志</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89-json-%E6%A0%BC%E5%BC%8F%E6%97%A5%E5%BF%97"><span class="toc-number">4.13.2.</span> <span class="toc-text">自定义 json 格式日志</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#json-%E6%A0%BC%E5%BC%8F%E7%9A%84%E6%97%A5%E5%BF%97%E8%AE%BF%E9%97%AE%E7%BB%9F%E8%AE%A1"><span class="toc-number">4.13.3.</span> <span class="toc-text">json 格式的日志访问统计</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%8D%E8%AE%B0%E5%BD%95%E8%AE%BF%E9%97%AE%E6%97%A5%E5%BF%97"><span class="toc-number">4.13.4.</span> <span class="toc-text">不记录访问日志</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%B3%E4%BA%8E-favicon-ico"><span class="toc-number">4.14.</span> <span class="toc-text">关于 favicon.ico</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Nginx-%E5%8E%8B%E7%BC%A9%E5%8A%9F%E8%83%BD"><span class="toc-number">4.15.</span> <span class="toc-text">Nginx 压缩功能</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#https-%E5%8A%A0%E5%AF%86"><span class="toc-number">4.16.</span> <span class="toc-text">https 加密</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#https-%E9%85%8D%E7%BD%AE%E5%8F%82%E6%95%B0"><span class="toc-number">4.16.1.</span> <span class="toc-text">https 配置参数</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%87%AA%E7%AD%BE%E5%90%8D%E8%AF%81%E4%B9%A6"><span class="toc-number">4.16.2.</span> <span class="toc-text">自签名证书</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#https-%E9%85%8D%E7%BD%AE"><span class="toc-number">4.16.3.</span> <span class="toc-text">https 配置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0%E5%A4%9A%E5%9F%9F%E5%90%8D-https"><span class="toc-number">4.16.4.</span> <span class="toc-text">实现多域名 https</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0-HSTS"><span class="toc-number">4.16.5.</span> <span class="toc-text">实现 HSTS</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8D%87%E7%BA%A7-OpenSSL-%E7%89%88%E6%9C%AC"><span class="toc-number">4.17.</span> <span class="toc-text">升级 OpenSSL 版本</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Rewrite-%E6%A8%A1%E5%9D%97"><span class="toc-number">4.18.</span> <span class="toc-text">Rewrite 模块</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#ngx-http-rewrite-module-%E6%A8%A1%E5%9D%97%E6%8C%87%E4%BB%A4"><span class="toc-number">4.18.1.</span> <span class="toc-text">ngx_http_rewrite_module 模块指令</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#if-%E6%8C%87%E4%BB%A4"><span class="toc-number">4.18.1.1.</span> <span class="toc-text">if 指令</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#set-%E6%8C%87%E4%BB%A4"><span class="toc-number">4.18.1.2.</span> <span class="toc-text">set 指令</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#break-%E6%8C%87%E4%BB%A4"><span class="toc-number">4.18.1.3.</span> <span class="toc-text">break 指令</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#return-%E6%8C%87%E4%BB%A4"><span class="toc-number">4.18.1.4.</span> <span class="toc-text">return 指令</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#rewrite-%E6%8C%87%E4%BB%A4"><span class="toc-number">4.18.2.</span> <span class="toc-text">rewrite 指令</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#rewrite-flag-%E4%BD%BF%E7%94%A8%E4%BB%8B%E7%BB%8D"><span class="toc-number">4.18.2.1.</span> <span class="toc-text">rewrite flag 使用介绍</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#break-%E4%B8%8E-last"><span class="toc-number">4.18.2.2.</span> <span class="toc-text">break 与 last</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#break-%E6%A1%88%E4%BE%8B"><span class="toc-number">4.18.2.2.1.</span> <span class="toc-text">break 案例</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#last-%E6%A1%88%E4%BE%8B"><span class="toc-number">4.18.2.2.2.</span> <span class="toc-text">last 案例</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#break-%E5%92%8C-last-%E5%8C%BA%E5%88%AB"><span class="toc-number">4.18.2.2.3.</span> <span class="toc-text">break 和 last 区别</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%B0%B8%E4%B9%85%E4%B8%8E%E4%B8%B4%E6%97%B6%E9%87%8D%E5%AE%9A%E5%90%91"><span class="toc-number">4.18.2.3.</span> <span class="toc-text">永久与临时重定向</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%B0%B8%E4%B9%85%E9%87%8D%E5%AE%9A%E5%90%91301"><span class="toc-number">4.18.2.3.1.</span> <span class="toc-text">永久重定向301</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%B8%B4%E6%97%B6%E9%87%8D%E5%AE%9A%E5%90%91302"><span class="toc-number">4.18.2.3.2.</span> <span class="toc-text">临时重定向302</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#redirect%E4%B8%8Epermanent%E5%8C%BA%E5%88%AB"><span class="toc-number">4.18.2.3.3.</span> <span class="toc-text">redirect与permanent区别</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%A1%88%E4%BE%8B"><span class="toc-number">4.18.3.</span> <span class="toc-text">案例</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%87%AA%E5%8A%A8%E8%B7%B3%E8%BD%AC-https"><span class="toc-number">4.18.3.1.</span> <span class="toc-text">自动跳转 https</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%A4%E6%96%AD%E6%96%87%E4%BB%B6%E6%98%AF%E5%90%A6%E5%AD%98%E5%9C%A8"><span class="toc-number">4.18.3.2.</span> <span class="toc-text">判断文件是否存在</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%8C%87%E5%AE%9A%E5%AE%A2%E6%88%B7%E7%AB%AF%E7%B1%BB%E5%9E%8B%E8%B7%B3%E8%BD%AC%E6%96%B0%E7%9A%84%E5%9F%9F%E5%90%8D"><span class="toc-number">4.18.3.3.</span> <span class="toc-text">指定客户端类型跳转新的域名</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%BD%91%E7%AB%99%E7%BB%B4%E6%8A%A4%E8%B7%B3%E8%BD%AC"><span class="toc-number">4.18.3.4.</span> <span class="toc-text">网站维护跳转</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%85%B6%E5%AE%83%E6%A1%88%E4%BE%8B"><span class="toc-number">4.18.3.5.</span> <span class="toc-text">其它案例</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Nginx-%E9%98%B2%E7%9B%97%E9%93%BE"><span class="toc-number">4.19.</span> <span class="toc-text">Nginx 防盗链</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0%E7%9B%97%E9%93%BE"><span class="toc-number">4.19.1.</span> <span class="toc-text">实现盗链</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0%E9%98%B2%E7%9B%97%E9%93%BE"><span class="toc-number">4.19.2.</span> <span class="toc-text">实现防盗链</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Nginx-%E5%8F%8D%E5%90%91%E4%BB%A3%E7%90%86"><span class="toc-number">5.</span> <span class="toc-text">Nginx 反向代理</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0-http-%E5%8F%8D%E5%90%91%E4%BB%A3%E7%90%86"><span class="toc-number">5.1.</span> <span class="toc-text">实现 http 反向代理</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#http-%E5%8D%8F%E8%AE%AE%E5%8F%8D%E5%90%91%E4%BB%A3%E7%90%86"><span class="toc-number">5.1.1.</span> <span class="toc-text">http 协议反向代理</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8F%8D%E5%90%91%E4%BB%A3%E7%90%86%E9%85%8D%E7%BD%AE%E5%8F%82%E6%95%B0"><span class="toc-number">5.1.1.1.</span> <span class="toc-text">反向代理配置参数</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%9E%E6%88%98%E6%A1%88%E4%BE%8B-%E5%8F%8D%E5%90%91%E4%BB%A3%E7%90%86%E5%8D%95%E5%8F%B0-web-%E6%9C%8D%E5%8A%A1%E5%99%A8"><span class="toc-number">5.1.1.2.</span> <span class="toc-text">实战案例: 反向代理单台 web 服务器</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%9E%E6%88%98%E6%A1%88%E4%BE%8B-%E6%8C%87%E5%AE%9A-location-%E5%AE%9E%E7%8E%B0%E5%8F%8D%E5%90%91%E4%BB%A3%E7%90%86"><span class="toc-number">5.1.1.3.</span> <span class="toc-text">实战案例: 指定 location 实现反向代理</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E9%92%88%E5%AF%B9%E6%8C%87%E5%AE%9A%E7%9A%84-location"><span class="toc-number">5.1.1.3.1.</span> <span class="toc-text">针对指定的 location</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E9%92%88%E5%AF%B9%E7%89%B9%E5%AE%9A%E7%9A%84%E8%B5%84%E6%BA%90%E5%AE%9E%E7%8E%B0%E4%BB%A3%E7%90%86"><span class="toc-number">5.1.1.3.2.</span> <span class="toc-text">针对特定的资源实现代理</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8F%8D%E5%90%91%E4%BB%A3%E7%90%86%E7%A4%BA%E4%BE%8B-%E7%BC%93%E5%AD%98%E5%8A%9F%E8%83%BD"><span class="toc-number">5.1.1.4.</span> <span class="toc-text">反向代理示例: 缓存功能</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E9%9D%9E%E7%BC%93%E5%AD%98%E5%9C%BA%E6%99%AF%E5%8E%8B%E6%B5%8B"><span class="toc-number">5.1.1.4.1.</span> <span class="toc-text">非缓存场景压测</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%87%86%E5%A4%87%E7%BC%93%E5%AD%98%E9%85%8D%E7%BD%AE"><span class="toc-number">5.1.1.4.2.</span> <span class="toc-text">准备缓存配置</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E8%AE%BF%E9%97%AE%E5%B9%B6%E9%AA%8C%E8%AF%81%E7%BC%93%E5%AD%98%E6%96%87%E4%BB%B6"><span class="toc-number">5.1.1.4.3.</span> <span class="toc-text">访问并验证缓存文件</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%B7%BB%E5%8A%A0%E5%93%8D%E5%BA%94%E6%8A%A5%E6%96%87%E7%9A%84%E5%A4%B4%E9%83%A8%E4%BF%A1%E6%81%AF"><span class="toc-number">5.1.1.5.</span> <span class="toc-text">添加响应报文的头部信息</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#Nginx-%E9%85%8D%E7%BD%AE"><span class="toc-number">5.1.1.5.1.</span> <span class="toc-text">Nginx 配置</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E9%AA%8C%E8%AF%81%E5%A4%B4%E9%83%A8%E4%BF%A1%E6%81%AF"><span class="toc-number">5.1.1.5.2.</span> <span class="toc-text">验证头部信息</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0%E5%8F%8D%E5%90%91%E4%BB%A3%E7%90%86%E5%AE%A2%E6%88%B7%E7%AB%AF-IP-%E9%80%8F%E4%BC%A0"><span class="toc-number">5.1.1.6.</span> <span class="toc-text">实现反向代理客户端 IP 透传</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%B8%80%E7%BA%A7%E4%BB%A3%E7%90%86%E5%AE%9E%E7%8E%B0%E5%AE%A2%E6%88%B7%E7%AB%AFIP%E9%80%8F%E4%BC%A0"><span class="toc-number">5.1.1.6.1.</span> <span class="toc-text">一级代理实现客户端IP透传</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%A4%9A%E7%BA%A7%E4%BB%A3%E7%90%86%E5%AE%9E%E7%8E%B0%E5%AE%A2%E6%88%B7%E7%AB%AF-IP-%E9%80%8F%E4%BC%A0"><span class="toc-number">5.1.1.6.2.</span> <span class="toc-text">多级代理实现客户端 IP 透传</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%A9%E7%94%A8Nginx%E8%A7%A3%E5%86%B3%E8%B7%A8%E5%9F%9F%E9%97%AE%E9%A2%98"><span class="toc-number">5.1.1.7.</span> <span class="toc-text">利用Nginx解决跨域问题</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E8%B7%A8%E5%9F%9F%E9%97%AE%E9%A2%98%E8%AF%B4%E6%98%8E"><span class="toc-number">5.1.1.7.1.</span> <span class="toc-text">跨域问题说明</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8-Nginx-%E5%8F%8D%E5%90%91%E4%BB%A3%E7%90%86%E5%8A%9F%E8%83%BD%E8%A7%A3%E5%86%B3%E8%B7%A8%E5%9F%9F%E9%97%AE%E9%A2%98%E6%A1%88%E4%BE%8B"><span class="toc-number">5.1.1.7.2.</span> <span class="toc-text">使用 Nginx 反向代理功能解决跨域问题案例</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Http-%E5%8F%8D%E5%90%91%E4%BB%A3%E7%90%86%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1"><span class="toc-number">5.1.2.</span> <span class="toc-text">Http 反向代理负载均衡</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#http-upstream%E9%85%8D%E7%BD%AE%E5%8F%82%E6%95%B0"><span class="toc-number">5.1.2.1.</span> <span class="toc-text">http upstream配置参数</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8F%8D%E5%90%91%E4%BB%A3%E7%90%86%E7%A4%BA%E4%BE%8B-%E5%90%8E%E7%AB%AF%E5%A4%9A%E5%8F%B0-web%E6%9C%8D%E5%8A%A1%E5%99%A8"><span class="toc-number">5.1.2.2.</span> <span class="toc-text">反向代理示例: 后端多台 web服务器</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E9%83%A8%E7%BD%B2%E5%90%8E%E7%AB%AF-Apache%E6%9C%8D%E5%8A%A1%E5%99%A8"><span class="toc-number">5.1.2.2.1.</span> <span class="toc-text">部署后端 Apache服务器</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE-nginx-%E5%8F%8D%E5%90%91%E4%BB%A3%E7%90%86"><span class="toc-number">5.1.2.2.2.</span> <span class="toc-text">配置 nginx 反向代理</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%9E%E6%88%98%E6%A1%88%E4%BE%8B-%E5%9F%BA%E4%BA%8ECookie-%E5%AE%9E%E7%8E%B0%E4%BC%9A%E8%AF%9D%E7%BB%91%E5%AE%9A"><span class="toc-number">5.1.2.3.</span> <span class="toc-text">实战案例: 基于Cookie 实现会话绑定</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%9E%E6%88%98%E6%A1%88%E4%BE%8B-%E5%AE%9E%E7%8E%B0-HTTPS-%E7%9A%84%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1"><span class="toc-number">5.1.2.4.</span> <span class="toc-text">实战案例: 实现 HTTPS 的负载均衡</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0-Nginx-%E5%9B%9B%E5%B1%82%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1"><span class="toc-number">5.2.</span> <span class="toc-text">实现 Nginx 四层负载均衡</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#TCP%E5%8D%8F%E8%AE%AE%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E9%85%8D%E7%BD%AE%E5%8F%82%E6%95%B0"><span class="toc-number">5.2.1.</span> <span class="toc-text">TCP协议负载均衡配置参数</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E5%AE%9E%E4%BE%8B-Redis"><span class="toc-number">5.2.2.</span> <span class="toc-text">负载均衡实例 : Redis</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%90%8E%E7%AB%AF%E6%9C%8D%E5%8A%A1%E5%99%A8%E5%AE%89%E8%A3%85-redis"><span class="toc-number">5.2.2.1.</span> <span class="toc-text">后端服务器安装 redis</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#nginx-%E9%85%8D%E7%BD%AE"><span class="toc-number">5.2.2.2.</span> <span class="toc-text">nginx 配置</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E5%AE%9E%E4%BE%8B-MySQL"><span class="toc-number">5.2.3.</span> <span class="toc-text">负载均衡实例: MySQL</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%90%8E%E7%AB%AF%E6%9C%8D%E5%8A%A1%E5%99%A8%E5%AE%89%E8%A3%85-MySQL"><span class="toc-number">5.2.3.1.</span> <span class="toc-text">后端服务器安装 MySQL</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#nginx%E9%85%8D%E7%BD%AE"><span class="toc-number">5.2.3.2.</span> <span class="toc-text">nginx配置</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#UDP%E5%8D%8F%E8%AE%AE%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E5%AE%9E%E4%BE%8B-DNS"><span class="toc-number">5.2.4.</span> <span class="toc-text">UDP协议负载均衡实例: DNS</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0-FastCGI"><span class="toc-number">5.3.</span> <span class="toc-text">实现 FastCGI</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#FastCGI%E9%85%8D%E7%BD%AE%E6%8C%87%E4%BB%A4"><span class="toc-number">5.3.1.</span> <span class="toc-text">FastCGI配置指令</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#FastCGI%E5%AE%9E%E6%88%98%E6%A1%88%E4%BE%8B-Nginx%E4%B8%8Ephp-fpm%E5%9C%A8%E5%90%8C%E4%B8%80%E6%9C%8D%E5%8A%A1%E5%99%A8"><span class="toc-number">5.3.2.</span> <span class="toc-text">FastCGI实战案例 : Nginx与php-fpm在同一服务器</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#php-%E7%8E%AF%E5%A2%83%E5%87%86%E5%A4%87"><span class="toc-number">5.3.2.1.</span> <span class="toc-text">php 环境准备</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#php%E7%9B%B8%E5%85%B3%E9%85%8D%E7%BD%AE%E4%BC%98%E5%8C%96"><span class="toc-number">5.3.2.2.</span> <span class="toc-text">php相关配置优化</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%87%86%E5%A4%87php%E6%B5%8B%E8%AF%95%E9%A1%B5%E9%9D%A2"><span class="toc-number">5.3.2.3.</span> <span class="toc-text">准备php测试页面</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Nginx%E9%85%8D%E7%BD%AE%E8%BD%AC%E5%8F%91"><span class="toc-number">5.3.2.4.</span> <span class="toc-text">Nginx配置转发</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%AE%BF%E9%97%AE%E9%AA%8C%E8%AF%81php%E6%B5%8B%E8%AF%95%E9%A1%B5%E9%9D%A2"><span class="toc-number">5.3.2.5.</span> <span class="toc-text">访问验证php测试页面</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#php-fpm-%E7%9A%84%E8%BF%90%E8%A1%8C%E7%8A%B6%E6%80%81%E9%A1%B5%E9%9D%A2"><span class="toc-number">5.3.2.6.</span> <span class="toc-text">php-fpm 的运行状态页面</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#FastCGI%E5%AE%9E%E6%88%98%E6%A1%88%E4%BE%8B-Nginx%E4%B8%8Ephp%E4%B8%8D%E5%9C%A8%E5%90%8C%E4%B8%80%E4%B8%AA%E6%9C%8D%E5%8A%A1%E5%99%A8"><span class="toc-number">5.3.3.</span> <span class="toc-text">FastCGI实战案例 : Nginx与php不在同一个服务器</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#yum%E5%AE%89%E8%A3%85%E8%BE%83%E6%96%B0%E7%89%88%E6%9C%ACphp-fpm"><span class="toc-number">5.3.3.1.</span> <span class="toc-text">yum安装较新版本php-fpm</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BF%AE%E6%94%B9php-fpm%E7%9B%91%E5%90%AC%E9%85%8D%E7%BD%AE"><span class="toc-number">5.3.3.2.</span> <span class="toc-text">修改php-fpm监听配置</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%87%86%E5%A4%87php%E6%B5%8B%E8%AF%95%E9%A1%B5%E9%9D%A2-1"><span class="toc-number">5.3.3.3.</span> <span class="toc-text">准备php测试页面</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%90%AF%E5%8A%A8%E5%B9%B6%E9%AA%8C%E8%AF%81php-fpm"><span class="toc-number">5.3.3.4.</span> <span class="toc-text">启动并验证php-fpm</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Nginx%E9%85%8D%E7%BD%AE%E8%BD%AC%E5%8F%91-1"><span class="toc-number">5.3.3.5.</span> <span class="toc-text">Nginx配置转发</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%AE%BF%E9%97%AE%E9%AA%8C%E8%AF%81php%E6%B5%8B%E8%AF%95%E9%A1%B5%E9%9D%A2-1"><span class="toc-number">5.3.3.6.</span> <span class="toc-text">访问验证php测试页面</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0%E5%8A%A8%E9%9D%99%E5%88%86%E7%A6%BB"><span class="toc-number">5.3.4.</span> <span class="toc-text">实现动静分离</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE-nginx-%E5%AE%9E%E7%8E%B0%E5%8F%8D%E5%90%91%E4%BB%A3%E7%90%86%E7%9A%84%E5%8A%A8%E9%9D%99%E5%88%86%E7%A6%BB"><span class="toc-number">5.3.4.1.</span> <span class="toc-text">配置 nginx 实现反向代理的动静分离</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%87%86%E5%A4%87%E5%90%8E%E7%AB%AF-httpd-%E6%9C%8D%E5%8A%A1%E5%99%A8"><span class="toc-number">5.3.4.2.</span> <span class="toc-text">准备后端 httpd 服务器</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BB%BC%E5%90%88%E5%AE%9E%E6%88%98%E9%A1%B9%E7%9B%AE"><span class="toc-number">5.4.</span> <span class="toc-text">综合实战项目</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%A1%B9%E7%9B%AE%E5%AE%9E%E6%88%98-%E5%88%A9%E7%94%A8-LNMP-%E5%AE%9E%E7%8E%B0-WordPress-%E7%AB%99%E7%82%B9%E6%90%AD%E5%BB%BA"><span class="toc-number">5.4.1.</span> <span class="toc-text">项目实战 : 利用 LNMP 实现 WordPress 站点搭建</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%83%A8%E7%BD%B2%E6%95%B0%E6%8D%AE%E5%BA%93"><span class="toc-number">5.4.1.1.</span> <span class="toc-text">部署数据库</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%BA%8C%E8%BF%9B%E5%88%B6%E9%83%A8%E7%BD%B2MySQL%E6%95%B0%E6%8D%AE%E5%BA%93"><span class="toc-number">5.4.1.1.1.</span> <span class="toc-text">二进制部署MySQL数据库</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%88%9B%E5%BB%BAwordpress%E6%95%B0%E6%8D%AE%E5%BA%93%E5%92%8C%E7%94%A8%E6%88%B7%E5%B9%B6%E6%8E%88%E6%9D%83"><span class="toc-number">5.4.1.1.2.</span> <span class="toc-text">创建wordpress数据库和用户并授权</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E9%AA%8C%E8%AF%81MySQL%E8%B4%A6%E6%88%B7%E6%9D%83%E9%99%90"><span class="toc-number">5.4.1.1.3.</span> <span class="toc-text">验证MySQL账户权限</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%BC%96%E8%AF%91%E9%83%A8%E7%BD%B2PHP7-4"><span class="toc-number">5.4.1.2.</span> <span class="toc-text">编译部署PHP7.4</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E7%BC%96%E8%AF%91%E5%AE%89%E8%A3%85-php"><span class="toc-number">5.4.1.2.1.</span> <span class="toc-text">编译安装 php</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%87%86%E5%A4%87-php-%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6"><span class="toc-number">5.4.1.2.2.</span> <span class="toc-text">准备 php 配置文件</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%90%AF%E5%8A%A8%E5%B9%B6%E9%AA%8C%E8%AF%81-php-fpm-%E6%9C%8D%E5%8A%A1"><span class="toc-number">5.4.1.2.3.</span> <span class="toc-text">启动并验证 php-fpm 服务</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%83%A8%E7%BD%B2-Nginx"><span class="toc-number">5.4.1.3.</span> <span class="toc-text">部署 Nginx</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E7%BC%96%E8%AF%91%E5%AE%89%E8%A3%85-nginx"><span class="toc-number">5.4.1.3.1.</span> <span class="toc-text">编译安装 nginx</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%87%86%E5%A4%87%E6%9C%8D%E5%8A%A1%E6%96%87%E4%BB%B6%E5%B9%B6%E5%90%AF%E5%8A%A8-nginx"><span class="toc-number">5.4.1.3.2.</span> <span class="toc-text">准备服务文件并启动 nginx</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE-Nginx-%E6%94%AF%E6%8C%81-fastcgi"><span class="toc-number">5.4.1.3.3.</span> <span class="toc-text">配置 Nginx 支持 fastcgi</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%87%86%E5%A4%87-php-%E6%B5%8B%E8%AF%95%E9%A1%B5"><span class="toc-number">5.4.1.3.4.</span> <span class="toc-text">准备 php 测试页</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E9%AA%8C%E8%AF%81-php-%E6%B5%8B%E8%AF%95%E9%A1%B5"><span class="toc-number">5.4.1.3.5.</span> <span class="toc-text">验证 php 测试页</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%83%A8%E7%BD%B2-WordPress"><span class="toc-number">5.4.1.4.</span> <span class="toc-text">部署 WordPress</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%87%86%E5%A4%87-WordPress-%E6%96%87%E4%BB%B6"><span class="toc-number">5.4.1.4.1.</span> <span class="toc-text">准备 WordPress 文件</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%88%9D%E5%A7%8B%E5%8C%96web%E9%A1%B5%E9%9D%A2"><span class="toc-number">5.4.1.4.2.</span> <span class="toc-text">初始化web页面</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E9%AA%8C%E8%AF%81%E5%8F%91%E8%A1%A8%E7%9A%84%E6%96%87%E7%AB%A0"><span class="toc-number">5.4.1.4.3.</span> <span class="toc-text">验证发表的文章</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE%E5%85%81%E8%AE%B8%E4%B8%8A%E4%BC%A0%E5%A4%A7%E6%96%87%E4%BB%B6"><span class="toc-number">5.4.1.4.4.</span> <span class="toc-text">配置允许上传大文件</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%AE%89%E5%85%A8%E5%8A%A0%E5%9B%BA"><span class="toc-number">5.4.1.4.5.</span> <span class="toc-text">安全加固</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE-php-%E5%BC%80%E5%90%AF-opcache-%E5%8A%A0%E9%80%9F"><span class="toc-number">5.4.1.4.6.</span> <span class="toc-text">配置 php 开启 opcache 加速</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#PHP-%E6%89%A9%E5%B1%95session%E6%A8%A1%E5%9D%97%E6%94%AF%E6%8C%81redis"><span class="toc-number">5.4.1.5.</span> <span class="toc-text">PHP 扩展session模块支持redis</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E7%BC%96%E8%AF%91%E5%AE%89%E8%A3%85phpredis%E6%A8%A1%E5%9D%97f"><span class="toc-number">5.4.1.5.1.</span> <span class="toc-text">编译安装phpredis模块f</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E7%BC%96%E8%BE%91php%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%E6%94%AF%E6%8C%81redis"><span class="toc-number">5.4.1.5.2.</span> <span class="toc-text">编辑php配置文件支持redis</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E9%AA%8C%E8%AF%81%E5%8A%A0%E8%BD%BD-redis-%E6%A8%A1%E5%9D%97"><span class="toc-number">5.4.1.5.3.</span> <span class="toc-text">验证加载 redis 模块</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%AE%89%E8%A3%85%E5%92%8C%E9%85%8D%E7%BD%AE-redis-%E6%9C%8D%E5%8A%A1"><span class="toc-number">5.4.1.5.4.</span> <span class="toc-text">安装和配置 redis 服务</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE-php-%E6%94%AF%E6%8C%81-redis-%E4%BF%9D%E5%AD%98-session"><span class="toc-number">5.4.1.5.5.</span> <span class="toc-text">配置 php 支持 redis 保存 session</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%87%86%E5%A4%87-php%E5%AE%9E%E7%8E%B0-session-%E7%9A%84%E6%B5%8B%E8%AF%95%E9%A1%B5%E9%9D%A2"><span class="toc-number">5.4.1.5.6.</span> <span class="toc-text">准备 php实现 session 的测试页面</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E8%AE%BF%E9%97%AE-web-%E9%A1%B5%E9%9D%A2%E6%B5%8B%E8%AF%95%E5%AE%9E%E7%8E%B0session%E4%BF%9D%E5%AD%98%E5%9C%A8redis%E6%9C%8D%E5%8A%A1"><span class="toc-number">5.4.1.5.7.</span> <span class="toc-text">访问 web 页面测试实现session保存在redis服务</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#redis-%E4%B8%BB%E6%9C%BA%E9%AA%8C%E8%AF%81-session-%E6%95%B0%E6%8D%AE"><span class="toc-number">5.4.1.5.8.</span> <span class="toc-text">redis 主机验证 session 数据</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%A1%B9%E7%9B%AE%E5%AE%9E%E6%88%98%EF%BC%9A%E5%88%A9%E7%94%A8-LNMP-%E5%AE%9E%E7%8E%B0%E5%8F%AF%E9%81%93%E4%BA%91%E7%A7%81%E6%9C%89%E4%BA%91"><span class="toc-number">5.4.2.</span> <span class="toc-text">项目实战：利用 LNMP 实现可道云私有云</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%8E%AF%E5%A2%83%E8%AF%B4%E6%98%8E"><span class="toc-number">5.4.2.1.</span> <span class="toc-text">环境说明</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%87%86%E5%A4%87-MySQL-%E6%95%B0%E6%8D%AE%E5%BA%93"><span class="toc-number">5.4.2.2.</span> <span class="toc-text">准备 MySQL 数据库</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%87%86%E5%A4%87-Redis-%E6%9C%8D%E5%8A%A1"><span class="toc-number">5.4.2.3.</span> <span class="toc-text">准备 Redis 服务</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%87%86%E5%A4%87-Nginx-%E6%9C%8D%E5%8A%A1"><span class="toc-number">5.4.2.4.</span> <span class="toc-text">准备 Nginx 服务</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%89%E8%A3%85-php-fpm-%E5%92%8C%E9%85%8D%E7%BD%AE%E6%94%AF%E6%8C%81-redis"><span class="toc-number">5.4.2.5.</span> <span class="toc-text">安装 php-fpm 和配置支持 redis</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#Ubuntu20-04-php-%E6%94%AF%E6%8C%81-Redis"><span class="toc-number">5.4.2.5.1.</span> <span class="toc-text">Ubuntu20.04 php 支持 Redis</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#CentOS8-php-%E6%94%AF%E6%8C%81-redis"><span class="toc-number">5.4.2.5.2.</span> <span class="toc-text">CentOS8 php 支持 redis</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#CentOS-7-php-%E6%94%AF%E6%8C%81-redis"><span class="toc-number">5.4.2.5.3.</span> <span class="toc-text">CentOS 7 php 支持 redis</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%87%86%E5%A4%87%E5%8F%AF%E9%81%93%E4%BA%91%E7%A8%8B%E5%BA%8F"><span class="toc-number">5.4.2.6.</span> <span class="toc-text">准备可道云程序</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%9D%E5%A7%8B%E5%8C%96%E5%92%8C%E7%99%BB%E5%BD%95%E5%8F%AF%E9%81%93%E4%BA%91"><span class="toc-number">5.4.2.7.</span> <span class="toc-text">初始化和登录可道云</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%AA%8C%E8%AF%81%E6%95%B0%E6%8D%AE%E5%BA%93%E5%92%8C-session-%E4%BF%A1%E6%81%AF"><span class="toc-number">5.4.2.8.</span> <span class="toc-text">验证数据库和 session 信息</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%A1%B9%E7%9B%AE%E5%AE%9E%E6%88%98%EF%BC%9A%E5%88%A9%E7%94%A8LNMP%E5%AE%9E%E7%8E%B0%E7%B1%BB%E4%BA%AC%E4%B8%9C%E7%94%B5%E5%95%86%E7%BD%91%E7%AB%99ShopXO"><span class="toc-number">5.4.3.</span> <span class="toc-text">项目实战：利用LNMP实现类京东电商网站ShopXO</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%A1%B9%E7%9B%AE%E5%AE%9E%E6%88%98-%E7%BC%96%E8%AF%91%E5%AE%89%E8%A3%85LNMP-%E5%AE%9E%E7%8E%B0-phpMyAdmin-%E5%B9%B6%E5%88%A9%E7%94%A8-Redis%E5%AE%9E%E7%8E%B0%E4%BC%9A%E8%AF%9D%E4%BF%9D%E6%8C%81"><span class="toc-number">5.4.4.</span> <span class="toc-text">项目实战: 编译安装LNMP 实现 phpMyAdmin 并利用 Redis实现会话保持</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%87%86%E5%A4%87-MySQL-%E5%92%8C-Redis"><span class="toc-number">5.4.4.1.</span> <span class="toc-text">准备 MySQL 和 Redis</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%BC%96%E8%AF%91%E5%AE%89%E8%A3%85-PHP-7-4"><span class="toc-number">5.4.4.2.</span> <span class="toc-text">编译安装 PHP-7.4</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%BC%96%E8%AF%91%E5%AE%89%E8%A3%85-Nginx-1"><span class="toc-number">5.4.4.3.</span> <span class="toc-text">编译安装 Nginx</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%B5%8B%E8%AF%95%E8%AE%BF%E9%97%AE-PHP"><span class="toc-number">5.4.4.4.</span> <span class="toc-text">测试访问 PHP</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%87%86%E5%A4%87-phpMyAdmin-%E7%A8%8B%E5%BA%8F"><span class="toc-number">5.4.4.5.</span> <span class="toc-text">准备 phpMyAdmin 程序</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%B5%8B%E8%AF%95%E8%AE%BF%E9%97%AE%E7%BD%91%E7%AB%99"><span class="toc-number">5.4.4.6.</span> <span class="toc-text">测试访问网站</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%A1%B9%E7%9B%AE%E5%AE%9E%E6%88%98%EF%BC%9A%E5%88%A9%E7%94%A8-LNMP-%E5%AE%9E%E7%8E%B0-phpMyAdmin-%E7%9A%84%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E5%B9%B6%E5%88%A9%E7%94%A8Redis%E5%AE%9E%E7%8E%B0%E4%BC%9A%E8%AF%9D%E4%BF%9D%E6%8C%81"><span class="toc-number">5.4.5.</span> <span class="toc-text">项目实战：利用 LNMP 实现 phpMyAdmin 的负载均衡并利用Redis实现会话保持</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%89%E8%A3%85%E5%92%8C%E9%85%8D%E7%BD%AE-MySQL"><span class="toc-number">5.4.5.1.</span> <span class="toc-text">安装和配置 MySQL</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%89%E8%A3%85%E5%92%8C%E9%85%8D%E7%BD%AE-Redis"><span class="toc-number">5.4.5.2.</span> <span class="toc-text">安装和配置 Redis</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%89%E8%A3%85%E5%92%8C%E9%85%8D%E7%BD%AE-Nginx"><span class="toc-number">5.4.5.3.</span> <span class="toc-text">安装和配置 Nginx</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%89%E8%A3%85%E5%92%8C%E9%85%8D%E7%BD%AE-PHP-FPM%E6%9C%8D%E5%8A%A1"><span class="toc-number">5.4.5.4.</span> <span class="toc-text">安装和配置 PHP-FPM服务</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%BC%96%E8%AF%91%E5%AE%89%E8%A3%85Redis%E6%A8%A1%E5%9D%97PHP%E8%BF%9E%E6%8E%A5Redis%E6%9C%8D%E5%8A%A1"><span class="toc-number">5.4.5.5.</span> <span class="toc-text">编译安装Redis模块PHP连接Redis服务</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%83%A8%E7%BD%B2-phpMyAdmin-%E4%BB%A3%E7%A0%81%E4%B8%8A%E7%BA%BF"><span class="toc-number">5.4.5.6.</span> <span class="toc-text">部署 phpMyAdmin 代码上线</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%85%8D%E7%BD%AENginx%E5%8F%8D%E5%90%91%E4%BB%A3%E7%90%86%E5%AE%9E%E7%8E%B0%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1"><span class="toc-number">5.4.5.7.</span> <span class="toc-text">配置Nginx反向代理实现负载均衡</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%AA%8C%E8%AF%81%E8%AE%BF%E9%97%AE"><span class="toc-number">5.4.5.8.</span> <span class="toc-text">验证访问</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Nginx-%E4%BA%8C%E6%AC%A1%E5%BC%80%E5%8F%91%E7%89%88%E6%9C%AC"><span class="toc-number">6.</span> <span class="toc-text">Nginx 二次开发版本</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Tengine"><span class="toc-number">6.1.</span> <span class="toc-text">Tengine</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Tengine-%E4%BB%8B%E7%BB%8D"><span class="toc-number">6.1.1.</span> <span class="toc-text">Tengine 介绍</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8A%A8%E6%80%81%E6%A8%A1%E5%9D%97"><span class="toc-number">6.1.2.</span> <span class="toc-text">动态模块</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%BC%96%E8%AF%91%E5%AE%89%E8%A3%85-tengine-2-1-2"><span class="toc-number">6.1.2.1.</span> <span class="toc-text">编译安装 tengine-2.1.2</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%9C%A8tengine-2-1-2%E4%B8%AD%E6%B7%BB%E5%8A%A0-lua-%E5%8A%A8%E6%80%81%E6%A8%A1%E5%9D%97"><span class="toc-number">6.1.2.2.</span> <span class="toc-text">在tengine-2.1.2中添加 lua 动态模块</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%BC%96%E8%AF%91%E5%AE%89%E8%A3%85-tengine-2-3-3"><span class="toc-number">6.1.2.3.</span> <span class="toc-text">编译安装 tengine-2.3.3</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#concat-%E6%A8%A1%E5%9D%97%E4%BD%BF%E7%94%A8"><span class="toc-number">6.1.3.</span> <span class="toc-text">concat 模块使用</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#concat%E6%A8%A1%E5%9D%97%E8%AF%B4%E6%98%8E"><span class="toc-number">6.1.3.1.</span> <span class="toc-text">concat模块说明</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%BC%96%E8%AF%91%E5%AE%89%E8%A3%85-concat-%E6%A8%A1%E5%9D%97"><span class="toc-number">6.1.3.2.</span> <span class="toc-text">编译安装 concat 模块</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#tengine%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6"><span class="toc-number">6.1.4.</span> <span class="toc-text">tengine配置文件</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#openresty"><span class="toc-number">6.2.</span> <span class="toc-text">openresty</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#openresty-%E4%BB%8B%E7%BB%8D"><span class="toc-number">6.2.1.</span> <span class="toc-text">openresty 介绍</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BC%96%E8%AF%91%E5%AE%89%E8%A3%85-openresty"><span class="toc-number">6.2.2.</span> <span class="toc-text">编译安装 openresty</span></a></li></ol></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2025/08/21/XM-CICD/" title="利用CICD自动更新组件"><img src="/../images/SRE/day55/1.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="利用CICD自动更新组件"/></a><div class="content"><a class="title" href="/2025/08/21/XM-CICD/" title="利用CICD自动更新组件">利用CICD自动更新组件</a><time datetime="2025-08-21T09:34:09.000Z" title="发表于 2025-08-21 17:34:09">2025-08-21</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2025/08/10/MY-k8s%E5%AE%B9%E5%BF%8D%E6%B1%A1%E7%82%B9%E4%BA%B2%E5%92%8CHPA/" title="容忍/污点/亲和/HPA"><img src="/../images/SRE/day46/1.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="容忍/污点/亲和/HPA"/></a><div class="content"><a class="title" href="/2025/08/10/MY-k8s%E5%AE%B9%E5%BF%8D%E6%B1%A1%E7%82%B9%E4%BA%B2%E5%92%8CHPA/" title="容忍/污点/亲和/HPA">容忍/污点/亲和/HPA</a><time datetime="2025-08-10T09:35:57.000Z" title="发表于 2025-08-10 17:35:57">2025-08-10</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2025/08/01/MY-Proxy/" title="Proxy 代理"><img src="/../images/MY/clash.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Proxy 代理"/></a><div class="content"><a class="title" href="/2025/08/01/MY-Proxy/" title="Proxy 代理">Proxy 代理</a><time datetime="2025-08-01T11:05:46.000Z" title="发表于 2025-08-01 19:05:46">2025-08-01</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2025/07/30/MY-k8s1.29/" title="K8S 1.29.2"><img src="/../images/SRE/day46/1.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="K8S 1.29.2"/></a><div class="content"><a class="title" href="/2025/07/30/MY-k8s1.29/" title="K8S 1.29.2">K8S 1.29.2</a><time datetime="2025-07-30T07:17:21.000Z" title="发表于 2025-07-30 15:17:21">2025-07-30</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2023 - 2025 By ૮(˶ᵔ ᵕ ᵔ˶)ა</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div><div class="footer_custom_text"><a target="_blank" rel="noopener" href="https://beian.miit.gov.cn/#/Integrated/index"><img src="../images/BEIAN/icp.png" width="15" height="15">豫ICP备2023009931号</a></br><a href="http://www.beian.gov.cn/portal/registerSystemInfo?recordcode=41162702000178" target="_blank"><img src="../images/BEIAN/beian.png" width="15" height="15">豫公网安备 41162702000178号</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.umd.min.js"></script><script src="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.js"></script><script>function panguFn () {
  if (typeof pangu === 'object') pangu.autoSpacingPage()
  else {
    getScript('https://cdn.jsdelivr.net/npm/pangu/dist/browser/pangu.min.js')
      .then(() => {
        pangu.autoSpacingPage()
      })
  }
}

function panguInit () {
  if (true){
    GLOBAL_CONFIG_SITE.isPost && panguFn()
  } else {
    panguFn()
  }
}

document.addEventListener('DOMContentLoaded', panguInit)</script><div class="js-pjax"></div><canvas id="universe"></canvas><script src="/js/universe.js"></script><canvas class="fireworks" mobile="true"></canvas><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/fireworks.min.js"></script><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/activate-power-mode.min.js"></script><script>POWERMODE.colorful = true;
POWERMODE.shake = false;
POWERMODE.mobile = false;
document.body.addEventListener('input', POWERMODE);
</script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>