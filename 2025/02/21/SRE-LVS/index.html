<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>企业级调度器LVS | ૮(˶ᵔ ᵕ ᵔ˶)ა</title><meta name="author" content="૮(˶ᵔ ᵕ ᵔ˶)ა"><meta name="copyright" content="૮(˶ᵔ ᵕ ᵔ˶)ა"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="ffffff"><meta name="description" content="Site Reliability Engineering">
<meta property="og:type" content="article">
<meta property="og:title" content="企业级调度器LVS">
<meta property="og:url" content="http://example.com/2025/02/21/SRE-LVS/index.html">
<meta property="og:site_name" content="૮(˶ᵔ ᵕ ᵔ˶)ა">
<meta property="og:description" content="Site Reliability Engineering">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://example.com/images/SRE/day27/3.png">
<meta property="article:published_time" content="2025-02-21T08:25:19.000Z">
<meta property="article:modified_time" content="2025-04-01T11:34:55.913Z">
<meta property="article:author" content="૮(˶ᵔ ᵕ ᵔ˶)ა">
<meta property="article:tag" content="LVS">
<meta property="article:tag" content="SRE">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://example.com/images/SRE/day27/3.png"><link rel="shortcut icon" href="/../images/TITLE/user.webp"><link rel="canonical" href="http://example.com/2025/02/21/SRE-LVS/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//fonts.googleapis.com" crossorigin=""/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Titillium+Web&amp;display=swap" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":false,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: true,
    post: true
  },
  runtime: '天',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: {"chs_to_cht":"你已切换为繁体","cht_to_chs":"你已切换为简体","day_to_night":"你已切换为深色模式","night_to_day":"你已切换为浅色模式","bgLight":"#49b1f5","bgDark":"#1f1f1f","position":"top-center"},
  source: {
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: true,
  }
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: '企业级调度器LVS',
  isPost: true,
  isHome: false,
  isHighlightShrink: undefined,
  isToc: true,
  postUpdate: '2025-04-01 19:34:55'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
    win.getCSS = (url,id = false) => new Promise((resolve, reject) => {
      const link = document.createElement('link')
      link.rel = 'stylesheet'
      link.href = url
      if (id) link.id = id
      link.onerror = reject
      link.onload = link.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        link.onload = link.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(link)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', 'ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><link rel="stylesheet" href="/css/custom.css"  media="defer" onload="this.media='all'"><meta name="generator" content="Hexo 5.4.2"></head><body><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="/../images/TITLE/user.webp" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">99</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">41</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">34</div></a></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间线</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('/../images/SRE/day27/3.png')"><nav id="nav"><span id="blog-info"><a href="/" title="૮(˶ᵔ ᵕ ᵔ˶)ა"><span class="site-name">૮(˶ᵔ ᵕ ᵔ˶)ა</span></a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间线</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">企业级调度器LVS</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2025-02-21T08:25:19.000Z" title="发表于 2025-02-21 16:25:19">2025-02-21</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2025-04-01T11:34:55.913Z" title="更新于 2025-04-01 19:34:55">2025-04-01</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/LVS/">LVS</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">字数总计:</span><span class="word-count">12.9k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>64分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="企业级调度器LVS"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="集群和分布式"><a href="#集群和分布式" class="headerlink" title="集群和分布式"></a>集群和分布式</h1><p>系统性能扩展方式：</p>
<ul>
<li>Scale UP：垂直扩展，向上扩展,增强，性能更强的计算机运行同样的服务 </li>
<li>Scale Out：水平扩展，向外扩展,增加设备，并行地运行多个服务调度分配问题，Cluster</li>
</ul>
<p>垂直扩展不再提及： 随着计算机性能的增长，其价格会成倍增长</p>
<p>单台计算机的性能是有上限的，不可能无限制地垂直扩展</p>
<p>多核CPU意味着即使是单台计算机也可以并行的。那么，为什么不一开始就并行化技术？</p>
<h2 id="集群-Cluster"><a href="#集群-Cluster" class="headerlink" title="集群 Cluster"></a>集群 Cluster</h2><p>Cluster：集群,为解决某个特定问题将多台计算机组合起来形成的单个系统</p>
<p>Cluster 分为三种类型：</p>
<ul>
<li><p>LB：Load Balancing，负载均衡，多个主机组成，每个主机只承担一部分访问请求</p>
</li>
<li><p>HA：High Availiablity，高可用，避免SPOF（single Point Of failure）</p>
<p>​        MTBF:Mean Time Between Failure 平均无故障时间，正常时间</p>
<p>​        MTTR:Mean Time To Restoration（ repair）平均恢复前时间，故障时间</p>
<p>​        A = MTBF /（MTBF+MTTR） (0,1)：99%,99.5%,99.9%,99.99%,99.999%</p>
<p><strong>SLA</strong>：服务等级协议（简称：SLA，全称：service level agreement）。是在一定开销下为保障服务的性能和可用性，服务提供商与用户间定义的一种双方认可的协定。通常这个开销是驱动提供服务质量的主要因素。在常规的领域中，总是设定所谓的三个9，四个9来进行表示，当没有达到这种水平的时候，就会有一些列的惩罚措施，而运维，最主要的目标就是达成这种服务水平。</p>
</li>
</ul>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">1年 = 365天 = 8760小时</span><br><span class="line">90 = (1-90%)*365=36.5天</span><br><span class="line">99 = 8760 * 1% = 87.6小时</span><br><span class="line">99.9 = 8760 * 0.1% = 8760 * 0.001 = 8.76小时</span><br><span class="line">99.99 = 8760 * 0.0001 = 0.876小时 = 0.876 * 60 = 52.6分钟</span><br><span class="line">99.999 = 8760 * 0.00001 = 0.0876小时 = 0.0876 * 60 = 5.26分钟</span><br><span class="line">99.9999= (1-99.9999%)*365*24*60*60=31秒</span><br></pre></td></tr></table></figure>

<p>停机时间又分为两种，一种是计划内停机时间，一种是计划外停机时间，而运维则主要关注计划外停机时间。</p>
<ul>
<li>HPC：High-performance computing，高性能 <a target="_blank" rel="noopener" href="http://www.top500.org/">www.top500.org</a></li>
</ul>
<h2 id="分布式系统"><a href="#分布式系统" class="headerlink" title="分布式系统"></a>分布式系统</h2><p>分布式常见应用</p>
<ul>
<li>分布式应用-服务按照功能拆分，使用微服务</li>
<li>分布式静态资源–静态资源放在不同的存储集群上</li>
<li>分布式数据和存储–使用key-value缓存系统</li>
<li>分布式计算–对特殊业务使用分布式计算，比如Hadoop集群</li>
</ul>
<p>分布式存储： Ceph，GlusterFS，FastDFS，MogileFS 分布式计算：hadoop，Spark</p>
<h2 id="集群和分布式-1"><a href="#集群和分布式-1" class="headerlink" title="集群和分布式"></a>集群和分布式</h2><p>集群：同一个业务系统部署在多台服务器上。集群中每一台服务器实现的功能没有差别，数据和代码都 是一样的</p>
<p>分布式：一个业务被拆成多个子业务，或者本身就是不同的业务，部署在多台服务器上。分布式中，每一台服务器实现的功能是有差别的，数据和代码也是不一样的，分布式每台服务器功能加起来，才是完整的业务</p>
<p>分布式是以缩短单个任务的执行时间来提升效率的，而集群则是通过提高单位时间内执行的任务数来提升效率。</p>
<p>对于大型网站，访问用户很多，实现一个群集，在前面部署一个负载均衡服务器，后面几台服务器完成同一业务。如果有用户进行相应业务访问时，负载均衡器根据后端哪台服务器的负载情况，决定由给哪一台去完成响应，并且一台服务器垮了，其它的服务器可以顶上来。分布式的每一个节点，都完成不同的业务，如果一个节点垮了，那这个业务可能就会失败</p>
<h2 id="LB-Cluster-负载均衡集群"><a href="#LB-Cluster-负载均衡集群" class="headerlink" title="LB Cluster 负载均衡集群"></a>LB Cluster 负载均衡集群</h2><h3 id="按实现方式划分"><a href="#按实现方式划分" class="headerlink" title="按实现方式划分"></a>按实现方式划分</h3><ul>
<li>硬件</li>
</ul>
<p><img src="../../../../images/SRE/day27/1.png" alt="1"></p>
<p>F5 Big-IP <a target="_blank" rel="noopener" href="https://detail.zol.com.cn/load_leveling/f5/cheap_pic.html?qq-pf-to=pcqq.group">https://detail.zol.com.cn/load_leveling/f5/cheap_pic.html?qq-pf-to=pcqq.group</a></p>
<p>Citrix Netscaler</p>
<p>A10 </p>
<ul>
<li><p>软件</p>
<p>lvs：Linux Virtual Server，阿里云四层 SLB (Server Load Balance)使用</p>
<p>nginx：支持七层调度，阿里云七层SLB使用Tengine</p>
<p>haproxy：支持七层调度</p>
<p>ats：Apache Traffic Server，yahoo捐助给apache</p>
<p>perlbal：Perl 编写</p>
<p>pound</p>
</li>
</ul>
<h3 id="基于工作的协议层次划分"><a href="#基于工作的协议层次划分" class="headerlink" title="基于工作的协议层次划分"></a>基于工作的协议层次划分</h3><ul>
<li><p>传输层（通用）：DNAT 和 DPORT</p>
<p>LVS：</p>
<p>nginx：stream</p>
<p>haproxy：mode tcp</p>
</li>
<li><p>应用层（专用）：针对特定协议，常称为 proxy server</p>
<p>http：nginx, httpd, haproxy(mode http), …</p>
<p>fastcgi：nginx, httpd, …</p>
<p>mysql：mysql-proxy, mycat…</p>
</li>
</ul>
<h3 id="负载均衡的会话保持"><a href="#负载均衡的会话保持" class="headerlink" title="负载均衡的会话保持"></a>负载均衡的会话保持</h3><ol>
<li><p>session sticky：同一用户调度固定服务器 </p>
<p>Source IP：LVS sh算法（对某一特定服务而言）</p>
<p>Cookie </p>
</li>
<li><p>session replication：每台服务器拥有全部session</p>
<p>session multicast cluster </p>
</li>
<li><p>session server：专门的session服务器</p>
<p>Redis,Memcached </p>
</li>
</ol>
<h2 id="HA-高可用集群实现"><a href="#HA-高可用集群实现" class="headerlink" title="HA 高可用集群实现"></a>HA 高可用集群实现</h2><p>keepalived：vrrp协议</p>
<p>Ais：应用接口规范</p>
<ul>
<li>heartbeat </li>
<li>man+rgmanager(RHCS)</li>
<li>coresync_pacemaker</li>
</ul>
<h1 id="Linux-Virtual-Server-简介"><a href="#Linux-Virtual-Server-简介" class="headerlink" title="Linux Virtual Server 简介"></a>Linux Virtual Server 简介</h1><h2 id="LVS-介绍"><a href="#LVS-介绍" class="headerlink" title="LVS 介绍"></a>LVS 介绍</h2><p>LVS：Linux Virtual Server，负载调度器，内核集成，章文嵩（花名 正明）, 阿里的四层SLB(Server Load Balance)是基于LVS+keepalived实现</p>
<p>LVS 是全球最流行的四层负载均衡开源软件，由章文嵩博士（当前阿里云产品技术负责人）在1998年5月创立，可以实现LINUX平台下的负载均衡。</p>
<p>LVS 官网：<a target="_blank" rel="noopener" href="http://www.linuxvirtualserver.org/">http://www.linuxvirtualserver.org/</a></p>
<p>阿里SLB和LVS：</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">https://yq.aliyun.com/articles/1803</span><br><span class="line">https://github.com/alibaba/LVS</span><br></pre></td></tr></table></figure>

<h2 id="LVS-工作原理"><a href="#LVS-工作原理" class="headerlink" title="LVS 工作原理"></a>LVS 工作原理</h2><p>VS根据请求报文的目标IP和目标协议及端口将其调度转发至某RS，根据调度算法来挑选RS。LVS是内核级功能，工作在INPUT链的位置，将发往INPUT的流量进行“处理”</p>
<p>范例：查看内核支持LVS</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ~]<span class="comment"># grep -i -C 10 ipvs /boot/config-4.18.0-147.el8.x86_64</span></span><br><span class="line"></span><br><span class="line">...（省略部分内容）...</span><br><span class="line"></span><br><span class="line">CONFIG_NETFILTER_XT_MATCH_IPVS=m</span><br><span class="line">CONFIG_NETFILTER_XT_MATCH_POLICY=m</span><br><span class="line"></span><br><span class="line">...（省略部分内容）...</span><br><span class="line"></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># IPVS transport protocol load balancing support</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line">CONFIG_IP_VS_PROTO_TCP=y</span><br><span class="line">CONFIG_IP_VS_PROTO_UDP=y</span><br><span class="line">CONFIG_IP_VS_PROTO_AH_ESP=y</span><br><span class="line">CONFIG_IP_VS_PROTO_ESP=y</span><br><span class="line">CONFIG_IP_VS_PROTO_AH=y</span><br><span class="line">CONFIG_IP_VS_PROTO_SCTP=y</span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># IPVS scheduler</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line">CONFIG_IP_VS_RR=m</span><br><span class="line">CONFIG_IP_VS_WRR=m</span><br><span class="line">CONFIG_IP_VS_LC=m</span><br><span class="line">CONFIG_IP_VS_WLC=m</span><br><span class="line">CONFIG_IP_VS_FO=m  <span class="comment">#新增</span></span><br><span class="line">CONFIG_IP_VS_OVF=m  <span class="comment">#新增</span></span><br><span class="line">CONFIG_IP_VS_LBLC=m</span><br><span class="line">CONFIG_IP_VS_LBLCR=m</span><br><span class="line">CONFIG_IP_VS_DH=m</span><br><span class="line">CONFIG_IP_VS_SH=m</span><br><span class="line"><span class="comment"># CONFIG_IP_VS_MH is not set</span></span><br><span class="line">CONFIG_IP_VS_SED=m</span><br><span class="line">CONFIG_IP_VS_NQ=m</span><br><span class="line">...（省略部分内容）...</span><br></pre></td></tr></table></figure>

<h2 id="LVS-集群体系架构"><a href="#LVS-集群体系架构" class="headerlink" title="LVS 集群体系架构"></a>LVS 集群体系架构</h2><p><img src="../../../../images/SRE/day27/2.png" alt="2"></p>
<h2 id="LVS-集群类型中的术语"><a href="#LVS-集群类型中的术语" class="headerlink" title="LVS 集群类型中的术语"></a>LVS 集群类型中的术语</h2><p>VS：Virtual Server，Director Server(DS), Dispatcher(调度器)，Load Balancer</p>
<p>RS：Real Server(lvs), upstream server(nginx), backend server(haproxy)</p>
<p>CIP：Client IP</p>
<p>VIP：Virtual server IP VS外网的IP</p>
<p>DIP：Director IP VS内网的IP</p>
<p>RIP：Real server IP </p>
<p>访问流程：CIP &lt;–&gt; VIP == DIP &lt;–&gt; RIP</p>
<h1 id="LVS-工作模式和相关命令"><a href="#LVS-工作模式和相关命令" class="headerlink" title="LVS 工作模式和相关命令"></a>LVS 工作模式和相关命令</h1><h2 id="LVS-集群的工作模式"><a href="#LVS-集群的工作模式" class="headerlink" title="LVS 集群的工作模式"></a>LVS 集群的工作模式</h2><ul>
<li>lvs-nat：修改请求报文的目标IP,多目标IP的DNAT</li>
<li>lvs-dr：操纵封装新的MAC地址</li>
<li>lvs-tun：在原请求IP报文之外新加一个IP首部</li>
<li>lvs-fullnat：修改请求报文的源和目标IP,默认内核不支持</li>
</ul>
<h3 id="LVS-的-NAT-模式"><a href="#LVS-的-NAT-模式" class="headerlink" title="LVS 的 NAT 模式"></a>LVS 的 NAT 模式</h3><p>官方链接：</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://www.linuxvirtualserver.org/VS-NAT.html</span><br></pre></td></tr></table></figure>

<p><img src="../../../../images/SRE/day27/3.png" alt="3"></p>
<p>lvs-nat：本质是多目标IP的DNAT，通过将请求报文中的目标地址和目标端口修改为某挑出的RS的RIP和PORT实现转发</p>
<p>（1）RIP和DIP应在同一个IP网络，且应使用私网地址；RS的网关要指向DIP</p>
<p>（2）请求报文和响应报文都必须经由Director转发，Director易于成为系统瓶颈</p>
<p>（3）支持端口映射，可修改请求报文的目标PORT</p>
<p>（4）VS必须是Linux系统，RS可以是任意OS系统</p>
<p><img src="../../../../images/SRE/day27/4.png" alt="4"></p>
<p><img src="../../../../images/SRE/day27/5.png" alt="5"></p>
<h3 id="LVS-的-DR-模式"><a href="#LVS-的-DR-模式" class="headerlink" title="LVS 的 DR 模式"></a>LVS 的 DR 模式</h3><p>官方链接</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://www.linuxvirtualserver.org/VS-DRouting.html</span><br></pre></td></tr></table></figure>

<p><img src="../../../../images/SRE/day27/6.png" alt="6"></p>
<p>LVS-DR：Direct Routing，直接路由，LVS默认模式,应用最广泛,通过为请求报文重新封装一个MAC首部进行转发，源MAC是DIP所在的接口的MAC，目标MAC是某挑选出的RS的RIP所在接口的MAC地址；源IP/PORT，以及目标IP/PORT均保持不变</p>
<p><img src="../../../../images/SRE/day27/7.png" alt="7"></p>
<p><img src="../../../../images/SRE/day27/8.png" alt="8"></p>
<p><strong>DR模式的特点：</strong></p>
<ol>
<li>Director和各RS都配置有VIP</li>
<li>确保前端路由器将目标IP为VIP的请求报文发往Director<ul>
<li>在前端网关做静态绑定VIP和Director的MAC地址</li>
<li>在RS上使用arptables工具</li>
</ul>
</li>
</ol>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">arptables -A IN -d <span class="variable">$VIP</span> -j DROP</span><br><span class="line">arptables -A OUT -s <span class="variable">$VIP</span> -j mangle --mangle-ip-s <span class="variable">$RIP</span></span><br></pre></td></tr></table></figure>

<ul>
<li>在RS上修改内核参数以限制arp通告及应答级别</li>
</ul>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">不主动不负责不拒绝</span><br><span class="line">/proc/sys/net/ipv4/conf/all/arp_ignore</span><br><span class="line">/proc/sys/net/ipv4/conf/all/arp_announce</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>RS的RIP可以使用私网地址，也可以是公网地址；RIP与DIP在同一IP网络；RIP的网关不能指向DIP，以确保响应报文不会经由Director</li>
<li>RS和Director要在同一个物理网络</li>
<li>请求报文要经由Director，但响应报文不经由Director，而由RS直接发往Client</li>
<li>不支持端口映射（端口不能修改）</li>
<li>无需开启 ip_forward </li>
<li>RS可使用大多数OS系统</li>
</ol>
<p><img src="../../../../images/SRE/day27/9.png" alt="9"></p>
<h3 id="LVS-的-TUN-模式"><a href="#LVS-的-TUN-模式" class="headerlink" title="LVS 的 TUN 模式"></a>LVS 的 TUN 模式</h3><p>官方链接</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://www.linuxvirtualserver.org/VS-IPTunneling.html</span><br></pre></td></tr></table></figure>

<p><img src="../../../../images/SRE/day27/10.png" alt="10"></p>
<p>转发方式：不修改请求报文的IP首部（源IP为CIP，目标IP为VIP），而在原IP报文之外再封装一个IP首部（源IP是DIP，目标IP是RIP），将报文发往挑选出的目标RS；RS直接响应给客户端（源IP是VIP，目标IP是CIP）</p>
<p><img src="../../../../images/SRE/day27/11.png" alt="11"></p>
<p><img src="../../../../images/SRE/day27/12.png" alt="12"></p>
<p><img src="../../../../images/SRE/day27/13.png" alt="13"></p>
<p>TUN模式特点： </p>
<ol>
<li>RIP和DIP可以不处于同一物理网络中，RS的网关一般不能指向DIP,且RIP可以和公网通信。也就是说集群节点可以跨互联网实现。DIP, VIP, RIP可以是公网地址</li>
<li>RealServer的tun接口上需要配置VIP地址，以便接收director转发过来的数据包，以及作为响应的报文源IP</li>
<li>Director转发给RealServer时需要借助隧道，隧道外层的IP头部的源IP是DIP，目标IP是RIP，而 RealServer响应给客户端的IP头部是根据隧道内层的IP头分析得到的，源IP是VIP，目标IP是CIP</li>
<li>请求报文要经由Director，但响应不经由Director,响应由RealServer自己完成</li>
<li>不支持端口映射</li>
<li>RS的OS须支持隧道功能</li>
</ol>
<p>应用场景:</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">一般来说，TUN模式常会用来负载调度缓存服务器组，这些缓存服务器一般放置在不同的网络环境，可以就近</span><br><span class="line">折返给客户端。在请求对象不在Cache服务器本地命中的情况下，Cache服务器要向源服务器发送请求，将结</span><br><span class="line">果取回，最后将结果返回给用户。</span><br><span class="line">LAN环境一般多采用DR模式，WAN环境虽然可以用TUN模式，但是一般在WAN环境下，请求转发更多的被</span><br><span class="line">haproxy/nginx/DNS等实现。因此，TUN模式实际应用的很少,跨机房的应用一般专线光纤连接或DNS调度</span><br></pre></td></tr></table></figure>

<h3 id="LVS-的-FULLNAT-模式"><a href="#LVS-的-FULLNAT-模式" class="headerlink" title="LVS 的 FULLNAT 模式"></a>LVS 的 FULLNAT 模式</h3><p><img src="../../../../images/SRE/day27/14.png" alt="14"></p>
<p>通过同时修改请求报文的源IP地址和目标IP地址进行转发</p>
<p>CIP –&gt; DIP </p>
<p>VIP –&gt; RIP </p>
<p>fullnat模式特点：</p>
<ol>
<li>VIP是公网地址，RIP和DIP是私网地址，且通常不在同一IP网络；因此，RIP的网关一般不会指向DIP </li>
<li>RS收到的请求报文源地址是DIP，因此，只需响应给DIP；但Director还要将其发往Client</li>
<li>请求和响应报文都经由Director</li>
<li>相对NAT模式，可以更好的实现LVS-RealServer间跨VLAN通讯</li>
<li>支持端口映射</li>
</ol>
<p>注意：此类型kernel默认不支持</p>
<h3 id="LVS工作模式总结和比较"><a href="#LVS工作模式总结和比较" class="headerlink" title="LVS工作模式总结和比较"></a>LVS工作模式总结和比较</h3><p><img src="../../../../images/SRE/day27/15.png" alt="15"></p>
<p>lvs-nat与lvs-fullnat：</p>
<ul>
<li>请求和响应报文都经由Director</li>
<li>lvs-nat：RIP的网关要指向DIP</li>
<li>lvs-fullnat：RIP和DIP未必在同一IP网络，但要能通信</li>
</ul>
<p>lvs-dr与lvs-tun：</p>
<ul>
<li>请求报文要经由Director，但响应报文由RS直接发往Client</li>
<li>lvs-dr：通过封装新的MAC首部实现，通过MAC网络转发</li>
<li>lvs-tun：通过在原IP报文外封装新IP头实现转发，支持远距离通信</li>
</ul>
<h2 id="LVS-调度算法"><a href="#LVS-调度算法" class="headerlink" title="LVS 调度算法"></a>LVS 调度算法</h2><p>ipvs scheduler：根据其调度时是否考虑各RS当前的负载状态 </p>
<p>分为两种：静态方法和动态方法</p>
<h3 id="静态方法"><a href="#静态方法" class="headerlink" title="静态方法"></a>静态方法</h3><p>仅根据算法本身进行调度</p>
<p>1、RR：roundrobin，轮询,较常用，雨露均沾，大锅饭</p>
<p>2、WRR：Weighted RR，加权轮询,较常用</p>
<p>3、SH：Source Hashing，实现session sticky，源IP地址hash；将来自于同一个IP地址的请求始终发往第一次挑中的RS，从而实现会话绑定</p>
<p>4、DH：Destination Hashing；目标地址哈希，第一次轮询调度至RS，后续将发往同一个目标地址的请求始终转发至第一次挑中的RS，典型使用场景是正向代理缓存场景中的负载均衡,如: Web缓存</p>
<h3 id="动态方法"><a href="#动态方法" class="headerlink" title="动态方法"></a>动态方法</h3><p>主要根据每RS当前的负载状态及调度算法进行调度Overhead=value 较小的RS将被调度</p>
<p>1、LC：least connections 适用于长连接应用</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Overhead=activeconns*256+inactiveconns</span><br></pre></td></tr></table></figure>

<p>2、WLC：Weighted LC，默认调度方法,较常用</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Overhead=(activeconns*256+inactiveconns)/weight</span><br></pre></td></tr></table></figure>

<p>3、SED：Shortest Expection Delay，初始连接高权重优先,只检查活动连接,而不考虑非活动连接</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Overhead=(activeconns+1)*256/weight</span><br></pre></td></tr></table></figure>

<p>4、NQ：Never Queue，第一轮均匀分配，后续SED</p>
<p>5、LBLC：Locality-Based LC，动态的DH算法，使用场景：根据负载状态实现正向代理,实现Web Cache等</p>
<p>6、LBLCR：LBLC with Replication，带复制功能的LBLC，解决LBLC负载不均衡问题，从负载重的复制到负载轻的RS,,实现Web Cache等</p>
<h3 id="内核版本-4-15-版本后新增调度算法：FO和OVF"><a href="#内核版本-4-15-版本后新增调度算法：FO和OVF" class="headerlink" title="内核版本 4.15 版本后新增调度算法：FO和OVF"></a>内核版本 4.15 版本后新增调度算法：FO和OVF</h3><p>FO（Weighted Fail Over）调度算法,在此FO算法中，遍历虚拟服务所关联的真实服务器链表，找到还未过载（未设置IP_VS_DEST_F_OVERLOAD标志）的且权重最高的真实服务器，进行调度,属于静态算法</p>
<p>OVF（Overflow-connection）调度算法，基于真实服务器的活动连接数量和权重值实现。将新连接调度到权重值最高的真实服务器，直到其活动连接数量超过权重值，之后调度到下一个权重值最高的真实服务器,在此OVF算法中，遍历虚拟服务相关联的真实服务器链表，找到权重值最高的可用真实服务器。属于动态算法</p>
<p>一个可用的真实服务器需要同时满足以下条件：</p>
<ul>
<li>未过载（未设置IP_VS_DEST_F_OVERLOAD标志）</li>
<li>真实服务器当前的活动连接数量小于其权重值</li>
<li>其权重值不为零</li>
</ul>
<h2 id="LVS-相关软件"><a href="#LVS-相关软件" class="headerlink" title="LVS 相关软件"></a>LVS 相关软件</h2><h3 id="程序包：ipvsadm"><a href="#程序包：ipvsadm" class="headerlink" title="程序包：ipvsadm"></a>程序包：ipvsadm</h3><p>Unit File: ipvsadm.service</p>
<p>主程序：/usr/sbin/ipvsadm</p>
<p>规则保存工具：/usr/sbin/ipvsadm-save</p>
<p>规则重载工具：/usr/sbin/ipvsadm-restore</p>
<p>配置文件：/etc/sysconfig/ipvsadm-config</p>
<p>ipvs调度规则文件：/etc/sysconfig/ipvsadm</p>
<h3 id="ipvsadm-命令"><a href="#ipvsadm-命令" class="headerlink" title="ipvsadm 命令"></a>ipvsadm 命令</h3><p>ipvsadm核心功能：</p>
<ul>
<li>集群服务管理：增、删、改</li>
<li>集群服务的RS管理：增、删、改</li>
<li>查看</li>
</ul>
<p>ipvsadm 工具用法：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#管理集群服务</span></span><br><span class="line">ipvsadm -A|E -t|u|f service-address [-s scheduler] [-p [<span class="built_in">timeout</span>]] [-M netmask] [--pe persistence_engine] [-b sched-flags]</span><br><span class="line">ipvsadm -D -t|u|f service-address   <span class="comment">#删除</span></span><br><span class="line">ipvsadm –C                          <span class="comment">#清空</span></span><br><span class="line">ipvsadm –R                          <span class="comment">#重载,相当于ipvsadm-restore</span></span><br><span class="line">ipvsadm -S [-n]                     <span class="comment">#保存,相当于ipvsadm-save</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#管理集群中的RS</span></span><br><span class="line">ipvsadm -a|e -t|u|f service-address -r server-address [-g|i|m] [-w weight]  </span><br><span class="line">ipvsadm -d -t|u|f service-address -r server-address</span><br><span class="line">ipvsadm -L|l [options]</span><br><span class="line">ipvsadm -Z [-t|u|f service-address]</span><br></pre></td></tr></table></figure>

<p><strong>管理集群服务：增、改、删</strong></p>
<p><strong>增、修改：</strong></p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ipvsadm -A|E -t|u|f service-address [-s scheduler] [-p [timeout]]</span><br></pre></td></tr></table></figure>

<p>说明</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">service-address：</span><br><span class="line"></span><br><span class="line">-t|u|f：</span><br><span class="line">    -t: TCP协议的端口，VIP:TCP_PORT 如: -t 10.0.0.100:80</span><br><span class="line">    -u: UDP协议的端口，VIP:UDP_PORT</span><br><span class="line">    -f：firewall MARK，标记，一个数字       </span><br><span class="line">[-s scheduler]：指定集群的调度算法，默认为wlc</span><br></pre></td></tr></table></figure>

<p>范例:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ipvsadm -A -t 10.0.0.100:80 -s wrr</span><br></pre></td></tr></table></figure>

<p><strong>删除：</strong></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ipvsadm -D -t|u|f service-address</span><br></pre></td></tr></table></figure>

<p><strong>管理集群上的RS：增、改、删</strong></p>
<p>增、改：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ipvsadm -a|e -t|u|f service-address -r server-address [-g|i|m] [-w weight] </span><br></pre></td></tr></table></figure>

<p>删：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ipvsadm -d -t|u|f service-address -r server-address</span><br></pre></td></tr></table></figure>

<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">server-address：</span><br><span class="line">     rip[:port] 如省略port，不作端口映射</span><br><span class="line">     </span><br><span class="line">选项：</span><br><span class="line">lvs类型：</span><br><span class="line">    -g: gateway, dr类型，默认</span><br><span class="line">    -i: ipip, tun类型</span><br><span class="line">    -m: masquerade, nat类型        </span><br><span class="line">-w weight：权重</span><br></pre></td></tr></table></figure>

<p>范例:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ipvsadm -a -t 10.0.0.100:80 -r 10.0.0.8:8080 -m -w 3</span><br></pre></td></tr></table></figure>

<p><strong>清空定义的所有内容：</strong></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ipvsadm -C</span><br></pre></td></tr></table></figure>

<p><strong>清空计数器：</strong></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ipvsadm -Z [-t|u|f service-address]</span><br></pre></td></tr></table></figure>

<p><strong>查看：</strong></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ipvsadm -L|l [options]</span><br></pre></td></tr></table></figure>

<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">--numeric, -n：以数字形式输出地址和端口号</span><br><span class="line">--exact：扩展信息，精确值     </span><br><span class="line">--connection，-c：当前IPVS连接输出</span><br><span class="line">--stats：统计信息</span><br><span class="line">--rate ：输出速率信息</span><br></pre></td></tr></table></figure>

<p><strong>ipvs规则：</strong></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/proc/net/ip_vs</span><br></pre></td></tr></table></figure>

<p><strong>ipvs连接：</strong></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/proc/net/ip_vs_conn</span><br></pre></td></tr></table></figure>

<p><strong>保存：建议保存至/etc/sysconfig/ipvsadm</strong></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ipvsadm-save &gt; /PATH/TO/IPVSADM_FILE</span><br><span class="line">ipvsadm -S &gt; /PATH/TO/IPVSADM_FILE</span><br><span class="line">systemctl stop ipvsadm.service  <span class="comment">#会自动保存规则至/etc/sysconfig/ipvsadm</span></span><br></pre></td></tr></table></figure>

<p><strong>重载：</strong> </p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ipvsadm-restore &lt; /PATH/FROM/IPVSADM_FILE</span><br><span class="line">systemctl  start ipvsadm.service  <span class="comment">#会自动加载/etc/sysconfig/ipvsadm中规则</span></span><br></pre></td></tr></table></figure>

<p>范例： Ubuntu系统保存规则和开机加载规则</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#保存规则</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#方法1</span></span><br><span class="line">[root@ubuntu2204 ~]<span class="comment"># service ipvsadm save</span></span><br><span class="line"> * Saving IPVS configuration...                                                   </span><br><span class="line">                                              [ OK ]</span><br><span class="line">[root@ubuntu2204 ~]<span class="comment">#cat /etc/ipvsadm.rules</span></span><br><span class="line"><span class="comment"># ipvsadm.rules</span></span><br><span class="line">-A -t 192.168.10.100:80 -s wlc</span><br><span class="line">-a -t 192.168.10.100:80 -r 10.0.0.7:80 -g -w 1</span><br><span class="line">-a -t 192.168.10.100:80 -r 10.0.0.17:80 -g -w 1</span><br><span class="line"></span><br><span class="line"><span class="comment">#方法2</span></span><br><span class="line">[root@ubuntu2004 ~]<span class="comment">#ipvsadm-save -n &gt; /etc/ipvsadm.rules</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#开机自启</span></span><br><span class="line">[root@ubuntu2004 ~]<span class="comment">#vim /etc/default/ipvsadm</span></span><br><span class="line">AUTO=<span class="string">&quot;true&quot;</span></span><br></pre></td></tr></table></figure>

<p>范例：红帽系统保存规则和开机加载规则</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#保存规则</span></span><br><span class="line">[root@rocky8 ~]<span class="comment">#ipvsadm-save -n &gt; /etc/sysconfig/ipvsadm</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#开机自启</span></span><br><span class="line">[root@rocky8 ~]<span class="comment">#systemctl enable ipvsadm.service</span></span><br></pre></td></tr></table></figure>

<h2 id="防火墙标记"><a href="#防火墙标记" class="headerlink" title="防火墙标记"></a>防火墙标记</h2><p>FWM：FireWall Mark </p>
<p>MARK target 可用于给特定的报文打标记</p>
<p>–set-mark value </p>
<p>其中：value 可为0xffff格式，表示十六进制数字</p>
<p>借助于防火墙标记来分类报文，而后基于标记定义集群服务；可将多个不同的应用使用同一个集群服务进行调度</p>
<p>实现方法：</p>
<p>在Director主机打标记：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">iptables -t mangle -A PREROUTING -d <span class="variable">$vip</span> -p <span class="variable">$proto</span> -m multiport --dports <span class="variable">$port1</span>,<span class="variable">$port2</span>,… -j MARK --set-mark NUMBER </span><br></pre></td></tr></table></figure>

<p>在Director主机基于标记定义集群服务：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ipvsadm -A -f NUMBER [options]</span><br></pre></td></tr></table></figure>

<p>范例:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">[root@lvs ~]<span class="comment"># iptables -t mangle -A PREROUTING -d 172.16.0.100 -p tcp -m multiport --dports 80,443 -j MARK --set-mark 10 </span></span><br><span class="line">[root@lvs ~]<span class="comment"># ipvsadm -C</span></span><br><span class="line">[root@lvs ~]<span class="comment"># ipvsadm -A -f 10 -s rr</span></span><br><span class="line">[root@lvs ~]<span class="comment"># ipvsadm -a -f 10 -r 10.0.0.7 -g</span></span><br><span class="line">[root@lvs ~]<span class="comment"># ipvsadm -a -f 10 -r 10.0.0.17 -g</span></span><br><span class="line">[root@lvs ~]<span class="comment"># ipvsadm -Ln</span></span><br><span class="line">IP Virtual Server version 1.2.1 (size=4096)</span><br><span class="line">Prot LocalAddress:Port Scheduler Flags</span><br><span class="line">  -&gt; RemoteAddress:Port           Forward Weight ActiveConn InActConn</span><br><span class="line">FWM  10 rr</span><br><span class="line">  -&gt; 10.0.0.7:0                   Route   1      0          0         </span><br><span class="line">  -&gt; 10.0.0.17:0                 Route   1      0          0         </span><br><span class="line">[root@lvs ~]<span class="comment"># cat /proc/net/ip_vs</span></span><br><span class="line">IP Virtual Server version 1.2.1 (size=4096)</span><br><span class="line">Prot LocalAddress:Port Scheduler Flags</span><br><span class="line">  -&gt; RemoteAddress:Port Forward Weight ActiveConn InActConn</span><br><span class="line">FWM 0000000A rr </span><br><span class="line">  -&gt; 0A000011:0000     Route   1      0          9         </span><br><span class="line">  -&gt; 0A000007:0000     Route   1      0          9</span><br></pre></td></tr></table></figure>

<p>范例:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">[root@lvs ~]<span class="comment"># ipvsadm -A -f 10 </span></span><br><span class="line">[root@lvs ~]<span class="comment"># ipvsadm -a -f 10 -r 10.0.0.7 -g</span></span><br><span class="line">[root@lvs ~]<span class="comment"># ipvsadm -a -f 10 -r 10.0.0.17 -g</span></span><br><span class="line">[root@lvs ~]<span class="comment"># ipvsadm -Ln</span></span><br><span class="line">IP Virtual Server version 1.2.1 (size=4096)</span><br><span class="line">Prot LocalAddress:Port Scheduler Flags</span><br><span class="line">  -&gt; RemoteAddress:Port           Forward Weight ActiveConn InActConn</span><br><span class="line">FWM  10 wlc</span><br><span class="line">  -&gt; 10.0.0.7:0               Route   1      0          0         </span><br><span class="line">  -&gt; 10.0.0.17:0             Route   1      0          0</span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line">[root@LVS ~]<span class="comment">#cat /proc/net/ip_vs</span></span><br><span class="line">IP Virtual Server version 1.2.1 (size=4096)</span><br><span class="line">Prot LocalAddress:Port Scheduler Flags</span><br><span class="line">  -&gt; RemoteAddress:Port Forward Weight ActiveConn InActConn</span><br><span class="line">TCP AC14C8C8:0050 rr  </span><br><span class="line">  -&gt; 0A000011:0050     Masq    1      0          0         </span><br><span class="line">  -&gt; 0A000007:0050     Masq    1      0          0  </span><br></pre></td></tr></table></figure>

<h2 id="LVS-持久连接"><a href="#LVS-持久连接" class="headerlink" title="LVS 持久连接"></a>LVS 持久连接</h2><p>session 绑定：对共享同一组RS的多个集群服务，需要统一进行绑定，lvs sh算法无法实现 </p>
<p>持久连接（ lvs persistence ）模板：实现无论使用任何调度算法，在一段时间内（默认360s ），能够实现将来自同一个地址的请求始终发往同一个RS</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ipvsadm -A|E -t|u|f service-address [-s scheduler] [-p [<span class="built_in">timeout</span>]]</span><br></pre></td></tr></table></figure>

<p>持久连接实现方式：</p>
<ul>
<li>每端口持久（PPC）：每个端口定义为一个集群服务，每集群服务单独调度</li>
<li>每防火墙标记持久（PFWMC）：基于防火墙标记定义集群服务；可实现将多个端口上的应用统一 调度，即所谓的port Affinity</li>
<li>每客户端持久（PCC）：基于0端口（表示所有服务）定义集群服务，即将客户端对所有应用的请求都调度至后端主机，必须定义为持久模式</li>
</ul>
<p>范例：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line">[root@lvs ~]<span class="comment"># ipvsadm -E -f 10 -p </span></span><br><span class="line">[root@lvs ~]<span class="comment"># ipvsadm -Ln</span></span><br><span class="line">IP Virtual Server version 1.2.1 (size=4096)</span><br><span class="line">Prot LocalAddress:Port Scheduler Flags</span><br><span class="line">  -&gt; RemoteAddress:Port           Forward Weight ActiveConn InActConn</span><br><span class="line">FWM  10 wlc persistent 360</span><br><span class="line">  -&gt; 10.0.0.7:0               Route   1      0          15        </span><br><span class="line">  -&gt; 10.0.0.17:0             Route   1      0          7         </span><br><span class="line">  </span><br><span class="line">[root@lvs ~]<span class="comment"># ipvsadm -E -f 10 -p 3600</span></span><br><span class="line">[root@lvs ~]<span class="comment"># ipvsadm -Ln</span></span><br><span class="line">IP Virtual Server version 1.2.1 (size=4096)</span><br><span class="line">Prot LocalAddress:Port Scheduler Flags</span><br><span class="line">  -&gt; RemoteAddress:Port           Forward Weight ActiveConn InActConn</span><br><span class="line">FWM  10 wlc persistent 3600</span><br><span class="line">  -&gt; 10.0.0.7:0               Route   1      0          79        </span><br><span class="line">  -&gt; 10.0.0.17:0             Route   1      0          7</span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line">[root@lvs ~]<span class="comment"># cat /proc/net/ip_vs_conn</span></span><br><span class="line">Pro FromIP   FPrt ToIP     TPrt DestIP   DPrt State       Expires PEName PEData</span><br><span class="line">TCP C0A80006 C816 AC100064 01BB 0A000011 01BB FIN_WAIT         67</span><br><span class="line">TCP C0A80006 C812 AC100064 01BB 0A000011 01BB FIN_WAIT         67</span><br><span class="line">TCP C0A80006 9A36 AC100064 0050 0A000011 0050 FIN_WAIT         65</span><br><span class="line">TCP C0A80006 C806 AC100064 01BB 0A000011 01BB FIN_WAIT         65</span><br><span class="line">TCP C0A80006 9A3E AC100064 0050 0A000011 0050 FIN_WAIT         66</span><br><span class="line">TCP C0A80006 C81A AC100064 01BB 0A000011 01BB FIN_WAIT         67</span><br><span class="line">TCP C0A80006 C80A AC100064 01BB 0A000011 01BB FIN_WAIT         66</span><br><span class="line">TCP C0A80006 9A3A AC100064 0050 0A000011 0050 FIN_WAIT         66</span><br><span class="line">TCP C0A80006 9A4E AC100064 0050 0A000011 0050 FIN_WAIT         68</span><br><span class="line">TCP C0A80006 9A42 AC100064 0050 0A000011 0050 FIN_WAIT         67</span><br><span class="line">TCP C0A80006 9A46 AC100064 0050 0A000011 0050 FIN_WAIT         67</span><br><span class="line">TCP C0A80006 C81E AC100064 01BB 0A000011 01BB FIN_WAIT         68</span><br><span class="line">IP C0A80006 0000 0000000A 0000 0A000011 0000 NONE            948</span><br><span class="line">TCP C0A80006 C80E AC100064 01BB 0A000011 01BB FIN_WAIT         66</span><br><span class="line">TCP C0A80006 9A4A AC100064 0050 0A000011 0050 FIN_WAIT         67</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@lvs ~]<span class="comment"># ipvsadm -Lnc</span></span><br><span class="line">IPVS connection entries</span><br><span class="line">pro expire state       <span class="built_in">source</span>             virtual           destination</span><br><span class="line">TCP 00:46 FIN_WAIT    192.168.10.6:51222  172.16.0.100:443   10.0.0.17:443</span><br><span class="line">TCP 00:46 FIN_WAIT    192.168.10.6:51218  172.16.0.100:443   10.0.0.17:443</span><br><span class="line">TCP 00:45 FIN_WAIT    192.168.10.6:39478  172.16.0.100:80    10.0.0.17:80</span><br><span class="line">TCP 00:45 FIN_WAIT    192.168.10.6:51206  172.16.0.100:443   10.0.0.17:443</span><br><span class="line">TCP 00:46 FIN_WAIT    192.168.10.6:39486  172.16.0.100:80    10.0.0.17:80</span><br><span class="line">TCP 00:47 FIN_WAIT    192.168.10.6:51226  172.16.0.100:443   10.0.0.17:443</span><br><span class="line">TCP 00:45 FIN_WAIT    192.168.10.6:51210  172.16.0.100:443   10.0.0.17:443</span><br><span class="line">TCP 00:45 FIN_WAIT    192.168.10.6:39482  172.16.0.100:80    10.0.0.17:80</span><br><span class="line">TCP 00:47 FIN_WAIT    192.168.10.6:39502  172.16.0.100:80    10.0.0.17:80</span><br><span class="line">TCP 00:46 FIN_WAIT    192.168.10.6:39490  172.16.0.100:80    10.0.0.17:80</span><br><span class="line">TCP 00:46 FIN_WAIT    192.168.10.6:39494  172.16.0.100:80    10.0.0.17:80</span><br><span class="line">TCP 00:47 FIN_WAIT    192.168.10.6:51230  172.16.0.100:443   10.0.0.17:443</span><br><span class="line">IP  15:27 NONE        192.168.10.6:0      0.0.0.10:0         10.0.0.17:0</span><br><span class="line">TCP 00:46 FIN_WAIT    192.168.10.6:51214  172.16.0.100:443   10.0.0.17:443</span><br><span class="line">TCP 00:47 FIN_WAIT    192.168.10.6:39498  172.16.0.100:80    10.0.0.17:80</span><br></pre></td></tr></table></figure>

<h1 id="LVS-实战案例"><a href="#LVS-实战案例" class="headerlink" title="LVS 实战案例"></a>LVS 实战案例</h1><h2 id="LVS-NAT模式案例"><a href="#LVS-NAT模式案例" class="headerlink" title="LVS-NAT模式案例"></a>LVS-NAT模式案例</h2><p><img src="../../../../images/SRE/day27/16.png" alt="16"></p>
<p>环境：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">共四台主机</span><br><span class="line">一台： internet client：192.168.10.6/24   GW:无 仅主机</span><br><span class="line"></span><br><span class="line">一台：lvs  </span><br><span class="line">eth1 仅主机 192.168.10.100/16</span><br><span class="line">eth0 NAT 10.0.0.8/24</span><br><span class="line"></span><br><span class="line">两台RS：</span><br><span class="line">RS1: 10.0.0.7/24 GW：10.0.0.8 NAT</span><br><span class="line">RS2: 10.0.0.17/24 GW：10.0.0.8 NAT</span><br></pre></td></tr></table></figure>

<p>配置过程：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br></pre></td><td class="code"><pre><span class="line">[root@internet ~]<span class="comment"># cat /etc/sysconfig/network-scripts/ifcfg-eth0 </span></span><br><span class="line">DEVICE=eth0</span><br><span class="line">NAME=eth0</span><br><span class="line">BOOTPROTO=static</span><br><span class="line">IPADDR=192.168.10.6</span><br><span class="line">PREFIX=24</span><br><span class="line">ONBOOT=<span class="built_in">yes</span></span><br><span class="line"></span><br><span class="line">[root@lvs network-scripts]<span class="comment"># cat ifcfg-eth0</span></span><br><span class="line">DEVICE=eth0</span><br><span class="line">NAME=eth0</span><br><span class="line">BOOTPROTO=static</span><br><span class="line">IPADDR=10.0.0.8</span><br><span class="line">PREFIX=24</span><br><span class="line">ONBOOT=<span class="built_in">yes</span></span><br><span class="line"></span><br><span class="line">[root@lvs network-scripts]<span class="comment"># cat ifcfg-eth1</span></span><br><span class="line">DEVICE=eth1</span><br><span class="line">NAME=eth1</span><br><span class="line">BOOTPROTO=static</span><br><span class="line">IPADDR=192.168.10.100</span><br><span class="line">PREFIX=24</span><br><span class="line">ONBOOT=<span class="built_in">yes</span></span><br><span class="line"></span><br><span class="line">[root@rs1 ~]<span class="comment"># cat /etc/sysconfig/network-scripts/ifcfg-eth0</span></span><br><span class="line">DEVICE=eth0</span><br><span class="line">NAME=eth0</span><br><span class="line">BOOTPROTO=static</span><br><span class="line">IPADDR=10.0.0.7</span><br><span class="line">PREFIX=24</span><br><span class="line">GATEWAY=10.0.0.8</span><br><span class="line">ONBOOT=<span class="built_in">yes</span></span><br><span class="line"></span><br><span class="line">[root@rs2 ~]<span class="comment"># cat /etc/sysconfig/network-scripts/ifcfg-eth0 </span></span><br><span class="line">DEVICE=eth0</span><br><span class="line">NAME=eth0</span><br><span class="line">BOOTPROTO=static</span><br><span class="line">IPADDR=10.0.0.17</span><br><span class="line">PREFIX=24</span><br><span class="line">GATEWAY=10.0.0.8</span><br><span class="line">ONBOOT=<span class="built_in">yes</span></span><br><span class="line"></span><br><span class="line">[root@rs1 ~]<span class="comment"># curl 10.0.0.7</span></span><br><span class="line">10.0.0.7 RS1</span><br><span class="line"></span><br><span class="line">[root@rs2 ~]<span class="comment"># curl 10.0.0.17</span></span><br><span class="line">10.0.0.17 RS2</span><br><span class="line"></span><br><span class="line">[root@lvs-server ~]<span class="comment"># vim /etc/sysctl.conf</span></span><br><span class="line">net.ipv4.ip_forward = 1</span><br><span class="line"></span><br><span class="line">[root@lvs-server ~]<span class="comment"># sysctl -p</span></span><br><span class="line">net.ipv4.ip_forward = 1</span><br><span class="line"></span><br><span class="line">[root@lvs-server ~]<span class="comment"># ipvsadm -A -t 192.168.10.100:80 -s wrr </span></span><br><span class="line">[root@lvs-server ~]<span class="comment"># ipvsadm -a -t 192.168.10.100:80 -r 10.0.0.7:80 -m</span></span><br><span class="line">[root@lvs-server ~]<span class="comment"># ipvsadm -a -t 192.168.10.100:80 -r 10.0.0.17:80 -m</span></span><br><span class="line"></span><br><span class="line">[root@lvs-server ~]<span class="comment"># ipvsadm -Ln</span></span><br><span class="line">IP Virtual Server version 1.2.1 (size=4096)</span><br><span class="line">Prot LocalAddress:Port Scheduler Flags</span><br><span class="line">  -&gt; RemoteAddress:Port           Forward Weight ActiveConn InActConn</span><br><span class="line">TCP  192.168.10.100:80 wrr</span><br><span class="line">  -&gt; 10.0.0.7:80                  Masq    1      1          0         </span><br><span class="line">  -&gt; 10.0.0.17:80                 Masq    1      0          0   </span><br><span class="line">  </span><br><span class="line">[root@internet ~]<span class="comment"># while :;do curl 192.168.10.100;sleep 0.5;done</span></span><br><span class="line">rs1.wang.org</span><br><span class="line">rs2.wang.org</span><br><span class="line">rs1.wang.org</span><br><span class="line">rs2.wang.org</span><br><span class="line">rs1.wang.org</span><br><span class="line">rs2.wang.org</span><br><span class="line"></span><br><span class="line">[root@lvs-server ~]<span class="comment"># ipvsadm -Ln --stats</span></span><br><span class="line">IP Virtual Server version 1.2.1 (size=4096)</span><br><span class="line">Prot LocalAddress:Port               Conns   InPkts OutPkts InBytes OutBytes</span><br><span class="line">  -&gt; RemoteAddress:Port</span><br><span class="line">TCP  192.168.10.100:80                  67      405      255    32436    30092</span><br><span class="line">  -&gt; 10.0.0.7:80                        34      203      128    16244    15072</span><br><span class="line">  -&gt; 10.0.0.17:80                       33      202      127    16192    15020</span><br><span class="line">  </span><br><span class="line">[root@lvs-server ~]<span class="comment"># cat /proc/net/ip_vs</span></span><br><span class="line">IP Virtual Server version 1.2.1 (size=4096)</span><br><span class="line">Prot LocalAddress:Port Scheduler Flags</span><br><span class="line">  -&gt; RemoteAddress:Port Forward Weight ActiveConn InActConn</span><br><span class="line">TCP C0A80A64:0050 wrr  </span><br><span class="line">  -&gt; 0A000011:0050     Masq    1      0          98        </span><br><span class="line">  -&gt; 0A000007:0050     Masq    1      0          97  </span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line">[root@lvs-server ~]<span class="comment"># ipvsadm -Lnc</span></span><br><span class="line">IPVS connection entries</span><br><span class="line">pro expire state       <span class="built_in">source</span>             virtual           destination</span><br><span class="line">TCP 01:55 TIME_WAIT   192.168.10.6:43486 192.168.10.100:80  10.0.0.17:80</span><br><span class="line">TCP 00:19 TIME_WAIT   192.168.10.6:43476 192.168.10.100:80  10.0.0.7:80</span><br><span class="line">TCP 01:58 TIME_WAIT   192.168.10.6:43500 192.168.10.100:80  10.0.0.7:80</span><br><span class="line">TCP 01:58 TIME_WAIT   192.168.10.6:43498 192.168.10.100:80  10.0.0.17:80</span><br><span class="line">TCP 01:59 TIME_WAIT   192.168.10.6:43502 192.168.10.100:80  10.0.0.17:80</span><br><span class="line">TCP 01:57 TIME_WAIT   192.168.10.6:43494 192.168.10.100:80  10.0.0.17:80</span><br><span class="line">TCP 01:57 TIME_WAIT   192.168.10.6:43496 192.168.10.100:80  10.0.0.7:80</span><br><span class="line">TCP 01:56 TIME_WAIT   192.168.10.6:43490 192.168.10.100:80  10.0.0.17:80</span><br><span class="line">TCP 00:20 TIME_WAIT   192.168.10.6:43480 192.168.10.100:80  10.0.0.7:80</span><br><span class="line">TCP 01:56 TIME_WAIT   192.168.10.6:43492 192.168.10.100:80  10.0.0.7:80</span><br><span class="line">TCP 01:55 TIME_WAIT   192.168.10.6:43488 192.168.10.100:80  10.0.0.7:80</span><br><span class="line">TCP 00:20 TIME_WAIT   192.168.10.6:43478 192.168.10.100:80  10.0.0.17:80</span><br><span class="line">TCP 01:59 TIME_WAIT   192.168.10.6:43504 192.168.10.100:80  10.0.0.7:80</span><br><span class="line">TCP 01:54 TIME_WAIT   192.168.10.6:43484 192.168.10.100:80  10.0.0.7:80</span><br><span class="line">TCP 01:54 TIME_WAIT   192.168.10.6:43482 192.168.10.100:80  10.0.0.17:80</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@lvs-server ~]<span class="comment"># cat /proc/net/ip_vs_conn</span></span><br><span class="line">Pro FromIP   FPrt ToIP     TPrt DestIP   DPrt State       Expires PEName PEData</span><br><span class="line">TCP C0A80A06 A9DE C0A80A64 0050 0A000011 0050 TIME_WAIT        72</span><br><span class="line">TCP C0A80A06 A9EC C0A80A64 0050 0A000007 0050 TIME_WAIT        76</span><br><span class="line">TCP C0A80A06 AA64 C0A80A64 0050 0A000007 0050 TIME_WAIT       106</span><br><span class="line">TCP C0A80A06 AA0C C0A80A64 0050 0A000007 0050 TIME_WAIT        84</span><br><span class="line">TCP C0A80A06 AA3A C0A80A64 0050 0A000011 0050 TIME_WAIT        95</span><br><span class="line">TCP C0A80A06 AA86 C0A80A64 0050 0A000011 0050 TIME_WAIT       115</span><br><span class="line">TCP C0A80A06 AA78 C0A80A64 0050 0A000007 0050 TIME_WAIT       111</span><br><span class="line">TCP C0A80A06 AA06 C0A80A64 0050 0A000011 0050 TIME_WAIT        82</span><br><span class="line">TCP C0A80A06 AA44 C0A80A64 0050 0A000007 0050 TIME_WAIT        98</span><br><span class="line">TCP C0A80A06 AA2C C0A80A64 0050 0A000007 0050 TIME_WAIT        92</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#保存规则</span></span><br><span class="line">[root@lvs-server ~]<span class="comment"># ipvsadm -Sn &gt; /etc/sysconfig/ipvsadm</span></span><br><span class="line">[root@lvs-server ~]<span class="comment"># systemctl enable --now ipvsadm.service</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#问题:LVS 打开监听VIP相关的端口吗?</span></span><br></pre></td></tr></table></figure>

<p>范例2：</p>
<p><img src="../../../../images/SRE/day27/17.png" alt="17"></p>
<ol>
<li>Director 服务器采用双网卡，一个是桥接网卡连接外网，一个是仅主机网卡与后端Web服务器相连</li>
<li>Web服务器采用仅主机网卡与director相连</li>
<li>Web服务器网关指向10.0.0.200</li>
<li>后端web服务器不需要连接外网</li>
</ol>
<p>环境：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">共四台主机</span><br><span class="line">一台： internet client ：172.20.200.6/16   GW:无</span><br><span class="line"></span><br><span class="line">一台：lvs  </span><br><span class="line">eth1 桥接 172.20.200.200/16</span><br><span class="line">eth0 NAT 10.0.0.200/24</span><br><span class="line"></span><br><span class="line">两台RS：</span><br><span class="line">RS1: 10.0.0.7/24 GW： 10.0.0.200</span><br><span class="line">RS2: 10.0.0.17/24 GW： 10.0.0.200</span><br></pre></td></tr></table></figure>

<p>配置过程</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#LVS启用IP_FORWORD功能</span></span><br><span class="line">[root@lvs ~]<span class="comment"># vim /etc/sysctl.conf</span></span><br><span class="line">net.ipv4.ip_forward = 1</span><br><span class="line"></span><br><span class="line">[root@lvs ~]<span class="comment"># sysctl -p</span></span><br><span class="line">[root@lvs ~]<span class="comment"># ipvsadm -A -t 172.20.200.200:80 -s rr</span></span><br><span class="line">[root@lvs ~]<span class="comment"># ipvsadm -a -t 172.20.200.200:80 -r 10.0.0.7 -m</span></span><br><span class="line">[root@lvs ~]<span class="comment"># ipvsadm -a -t 172.20.200.200:80 -r 10.0.0.17 -m</span></span><br><span class="line">[root@LVS ~]<span class="comment"># ipvsadm -Ln</span></span><br><span class="line">IP Virtual Server version 1.2.1 (size=4096)</span><br><span class="line">Prot LocalAddress:Port Scheduler Flags</span><br><span class="line">  -&gt; RemoteAddress:Port           Forward Weight ActiveConn InActConn</span><br><span class="line">TCP  172.20.200.200:80 rr</span><br><span class="line">  -&gt; 10.0.0.7:80                  Masq    1      0          0         </span><br><span class="line">  -&gt; 10.0.0.17:80                 Masq    1      0          0  </span><br><span class="line"></span><br><span class="line"><span class="comment">#测试</span></span><br><span class="line">[root@client ~]<span class="comment"># curl 172.20.200.200</span></span><br><span class="line">RS2 Server on 10.0.0.17</span><br><span class="line"></span><br><span class="line">[root@client ~]<span class="comment"># curl 172.20.200.200</span></span><br><span class="line">RS1 Server on 10.0.0.7</span><br><span class="line"></span><br><span class="line">[root@client ~]<span class="comment"># curl 172.20.200.200</span></span><br><span class="line">RS2 Server on 10.0.0.17</span><br><span class="line"></span><br><span class="line">[root@client ~]<span class="comment"># curl 172.20.200.200</span></span><br><span class="line">RS1 Server on 10.0.0.7</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@LVS ~]<span class="comment"># cat /proc/net/ip_vs_conn</span></span><br><span class="line">Pro FromIP   FPrt ToIP     TPrt DestIP   DPrt State       Expires PEName PEData</span><br><span class="line">TCP AC14C806 BD6A AC14C8C8 0050 0A000011 0050 TIME_WAIT        97</span><br><span class="line">TCP AC14C806 BD6C AC14C8C8 0050 0A000007 0050 TIME_WAIT        97</span><br><span class="line">TCP AC14C806 BD66 AC14C8C8 0050 0A000011 0050 TIME_WAIT        90</span><br><span class="line">TCP AC14C806 BD68 AC14C8C8 0050 0A000007 0050 TIME_WAIT        92</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#保存规则</span></span><br><span class="line">[root@LVS ~]<span class="comment"># ipvsadm -Sn &gt; /etc/sysconfig/ipvsadm</span></span><br><span class="line">[root@LVS ~]<span class="comment"># cat /etc/sysconfig/ipvsadm</span></span><br><span class="line">-A -t 172.20.200.200:80 -s rr</span><br><span class="line">-a -t 172.20.200.200:80 -r 10.0.0.7:80 -m -w 1</span><br><span class="line">-a -t 172.20.200.200:80 -r 10.0.0.17:80 -m -w 1</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#清除规则</span></span><br><span class="line">[root@LVS ~]<span class="comment"># ipvsadm -C</span></span><br><span class="line">[root@LVS ~]<span class="comment"># ipvsadm -Ln</span></span><br><span class="line">IP Virtual Server version 1.2.1 (size=4096)</span><br><span class="line">Prot LocalAddress:Port Scheduler Flags</span><br><span class="line">  -&gt; RemoteAddress:Port           Forward Weight ActiveConn InActConn</span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line"><span class="comment">#重新加载规则</span></span><br><span class="line">[root@LVS ~]<span class="comment"># ipvsadm -R &lt; /etc/sysconfig/ipvsadm</span></span><br><span class="line">[root@LVS ~]<span class="comment"># ipvsadm -Ln</span></span><br><span class="line">IP Virtual Server version 1.2.1 (size=4096)</span><br><span class="line">Prot LocalAddress:Port Scheduler Flags</span><br><span class="line">  -&gt; RemoteAddress:Port           Forward Weight ActiveConn InActConn</span><br><span class="line">TCP  172.20.200.200:80 rr</span><br><span class="line">  -&gt; 10.0.0.7:80                 Masq    1      0          0         </span><br><span class="line">  -&gt; 10.0.0.17:80 </span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line"><span class="comment">#开机加载ipvs规则</span></span><br><span class="line">[root@LVS ~]<span class="comment"># ipvsadm -C</span></span><br><span class="line">[root@LVS ~]<span class="comment"># ipvsadm -Ln</span></span><br><span class="line">IP Virtual Server version 1.2.1 (size=4096)</span><br><span class="line">Prot LocalAddress:Port Scheduler Flags</span><br><span class="line">  -&gt; RemoteAddress:Port           Forward Weight ActiveConn InActConn</span><br><span class="line">  </span><br><span class="line">[root@LVS ~]<span class="comment"># systemctl enable --now ipvsadm.service </span></span><br><span class="line">[root@LVS ~]<span class="comment"># ipvsadm -Ln</span></span><br><span class="line">IP Virtual Server version 1.2.1 (size=4096)</span><br><span class="line">Prot LocalAddress:Port Scheduler Flags</span><br><span class="line">  -&gt; RemoteAddress:Port           Forward Weight ActiveConn InActConn</span><br><span class="line">TCP  172.20.200.200:80 rr</span><br><span class="line">  -&gt; 10.0.0.7:80                  Masq    1      0          0         </span><br><span class="line">  -&gt; 10.0.0.17:80                 Masq    1      0          0</span><br><span class="line">  </span><br><span class="line">[root@rs1 ~]<span class="comment"># tail /var/log/httpd/access_log</span></span><br><span class="line">172.20.200.6 - - [24/Mar/2020:16:38:29 +0800] <span class="string">&quot;GET / HTTP/1.1&quot;</span> 200 23 <span class="string">&quot;-&quot;</span></span><br><span class="line"><span class="string">&quot;curl/7.19.7 (x86_64-redhat-linux-gnu) libcurl/7.19.7 NSS/3.27.1 zlib/1.2.3 </span></span><br><span class="line"><span class="string">libidn/1.18 libssh2/1.4.2&quot;</span></span><br><span class="line">172.20.200.6 - - [24/Mar/2020:16:38:35 +0800] <span class="string">&quot;GET / HTTP/1.1&quot;</span> 200 23 <span class="string">&quot;-&quot;</span></span><br><span class="line"><span class="string">&quot;curl/7.19.7 (x86_64-redhat-linux-gnu) libcurl/7.19.7 NSS/3.27.1 zlib/1.2.3 </span></span><br><span class="line"><span class="string">libidn/1.18 libssh2/1.4.2&quot;</span></span><br><span class="line">172.20.200.6 - - [24/Mar/2020:16:52:16 +0800] <span class="string">&quot;GET / HTTP/1.1&quot;</span> 200 23 <span class="string">&quot;-&quot;</span></span><br><span class="line"><span class="string">&quot;curl/7.19.7 (x86_64-redhat-linux-gnu) libcurl/7.19.7 NSS/3.27.1 zlib/1.2.3 </span></span><br><span class="line"><span class="string">libidn/1.18 libssh2/1.4.2&quot;</span></span><br><span class="line">172.20.200.6 - - [24/Mar/2020:16:52:17 +0800] <span class="string">&quot;GET / HTTP/1.1&quot;</span> 200 23 <span class="string">&quot;-&quot;</span></span><br><span class="line"><span class="string">&quot;curl/7.19.7 (x86_64-redhat-linux-gnu) libcurl/7.19.7 NSS/3.27.1 zlib/1.2.3 </span></span><br><span class="line"><span class="string">libidn/1.18 libssh2/1.4.2&quot;</span></span><br><span class="line">172.20.200.6 - - [24/Mar/2020:16:53:36 +0800] <span class="string">&quot;GET / HTTP/1.1&quot;</span> 200 23 <span class="string">&quot;-&quot;</span></span><br><span class="line"><span class="string">&quot;curl/7.19.7 (x86_64-redhat-linux-gnu) libcurl/7.19.7 NSS/3.27.1 zlib/1.2.3 </span></span><br><span class="line"><span class="string">libidn/1.18 libssh2/1.4.2&quot;</span></span><br><span class="line">172.20.200.6 - - [24/Mar/2020:16:53:37 +0800] <span class="string">&quot;GET / HTTP/1.1&quot;</span> 200 23 <span class="string">&quot;-&quot;</span></span><br><span class="line"><span class="string">&quot;curl/7.19.7 (x86_64-redhat-linux-gnu) libcurl/7.19.7 NSS/3.27.1 zlib/1.2.3 </span></span><br><span class="line"><span class="string">libidn/1.18 libssh2/1.4.2&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#修改调度算法为 WRR 和后端服务器的端口</span></span><br><span class="line">[root@LVS ~]<span class="comment"># ipvsadm -E -t 172.20.200.200:80 -s wrr</span></span><br><span class="line">[root@LVS ~]<span class="comment"># ipvsadm -d -t 172.20.200.200:80 -r 10.0.0.7</span></span><br><span class="line">[root@LVS ~]<span class="comment"># ipvsadm -a -t 172.20.200.200:80 -r 10.0.0.7:8080 -m -w 3</span></span><br><span class="line">[root@LVS ~]<span class="comment"># ipvsadm -Ln</span></span><br><span class="line">IP Virtual Server version 1.2.1 (size=4096)</span><br><span class="line">Prot LocalAddress:Port Scheduler Flags</span><br><span class="line">  -&gt; RemoteAddress:Port           Forward Weight ActiveConn InActConn</span><br><span class="line">TCP  172.20.200.200:80 wrr</span><br><span class="line">  -&gt; 10.0.0.7:8080                Masq    3      0          0         </span><br><span class="line">  -&gt; 10.0.0.17:80                 Masq    1      0          1  </span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line">[root@rs1 ~]<span class="comment"># vim /etc/httpd/conf/httpd.conf </span></span><br><span class="line">Listen 8080</span><br><span class="line"></span><br><span class="line">[root@rs1 ~]<span class="comment"># systemctl restart httpd</span></span><br><span class="line">[root@client ~]<span class="comment"># curl 172.20.200.200</span></span><br><span class="line">RS1 Server on 10.0.0.7</span><br><span class="line">[root@client ~]<span class="comment"># curl 172.20.200.200</span></span><br><span class="line">RS1 Server on 10.0.0.7</span><br><span class="line">[root@client ~]<span class="comment"># curl 172.20.200.200</span></span><br><span class="line">RS1 Server on 10.0.0.7</span><br><span class="line">[root@client ~]<span class="comment"># curl 172.20.200.200</span></span><br><span class="line">RS2 Server on 10.0.0.17</span><br></pre></td></tr></table></figure>

<h2 id="LVS-DR模式单网段案例"><a href="#LVS-DR模式单网段案例" class="headerlink" title="LVS-DR模式单网段案例"></a>LVS-DR模式单网段案例</h2><p>DR模型中各主机上均需要配置VIP，解决地址冲突的方式有三种：</p>
<p>(1) 在前端网关做静态绑定</p>
<p>(2) 在各RS使用arptables</p>
<p>(3) 在各RS修改内核参数，来限制arp响应和通告的级别</p>
<p><strong>限制响应级别：arp_ignore</strong> </p>
<ul>
<li>0：默认值，表示可使用本地任意接口上配置的任意地址进行响应</li>
<li>1：仅在请求的目标IP配置在本地主机的接收到请求报文的接口上时，才给予响应 </li>
</ul>
<p><strong>限制通告级别：arp_announce</strong></p>
<ul>
<li><p>0：默认值，把本机所有接口的所有信息向每个接口的网络进行通告</p>
</li>
<li><p>1：尽量避免将接口信息向非直接连接网络进行通告</p>
</li>
<li><p>2：必须避免将接口信息向非本网络进行通告</p>
<p><strong>配置要点</strong></p>
<ol>
<li>Director 服务器采用双IP桥接网络，一个是VIP，一个DIP </li>
<li>Web服务器采用和DIP相同的网段和Director连接 </li>
<li>每个Web服务器配置VIP </li>
<li>每个web服务器可以出外网</li>
</ol>
</li>
</ul>
<p>范例:</p>
<p><img src="../../../../images/SRE/day27/18.png" alt="18"></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">环境：五台主机</span><br><span class="line">一台：客户端 eth0:仅主机 192.168.10.6/24 GW:192.168.10.200</span><br><span class="line"></span><br><span class="line">一台：ROUTER</span><br><span class="line">eth0 :NAT  10.0.0.200/24</span><br><span class="line">eth1: 仅主机 192.168.10.200/24</span><br><span class="line">启用 IP_FORWARD</span><br><span class="line"></span><br><span class="line">一台：LVS</span><br><span class="line">eth0:NAT:DIP:10.0.0.8/24 GW:10.0.0.200</span><br><span class="line"></span><br><span class="line">两台RS：</span><br><span class="line">RS1：eth0:NAT:10.0.0.7/24   GW：10.0.0.200</span><br><span class="line">RS2：eth0:NAT:10.0.0.17/24  GW：10.0.0.200</span><br></pre></td></tr></table></figure>

<h3 id="LVS的网络配置"><a href="#LVS的网络配置" class="headerlink" title="LVS的网络配置"></a>LVS的网络配置</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#所有主机禁用iptables和SELinux</span></span><br><span class="line"><span class="comment">#internet主机环境</span></span><br><span class="line">[root@internet ~]<span class="comment"># hostname</span></span><br><span class="line">internet</span><br><span class="line"></span><br><span class="line">[root@internet ~]<span class="comment"># hostname -I</span></span><br><span class="line">192.168.10.6</span><br><span class="line"></span><br><span class="line">[root@internet ~]<span class="comment"># route -n</span></span><br><span class="line">Kernel IP routing table</span><br><span class="line">Destination     Gateway         Genmask         Flags Metric Ref   Use Iface</span><br><span class="line">192.168.10.0     0.0.0.0         255.255.255.0   U     1      0        0 eth0</span><br><span class="line">0.0.0.0         192.168.10.200   0.0.0.0         UG    0      0        0 eth0</span><br><span class="line"></span><br><span class="line">[root@internet ~]<span class="comment"># ping 10.0.0.7 -c1</span></span><br><span class="line">PING 10.0.0.7 (10.0.0.7) 56(84) bytes of data.</span><br><span class="line">64 bytes from 10.0.0.7: icmp_seq=1 ttl=63 time=0.565 ms</span><br><span class="line"></span><br><span class="line">[root@internet ~]<span class="comment"># ping 10.0.0.17 -c1</span></span><br><span class="line">PING 10.0.0.7 (10.0.0.17) 56(84) bytes of data.</span><br><span class="line">64 bytes from 10.0.0.17: icmp_seq=1 ttl=63 time=0.565 ms</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">######################################################################################</span></span><br><span class="line"><span class="comment">#路由器的网络配置</span></span><br><span class="line">[root@router ~]<span class="comment"># echo &#x27;net.ipv4.ip_forward=1&#x27; &gt;&gt; /etc/sysctl.conf </span></span><br><span class="line">[root@router ~]<span class="comment"># sysctl -p</span></span><br><span class="line">[root@router network-scripts]<span class="comment"># pwd</span></span><br><span class="line">/etc/sysconfig/network-scripts</span><br><span class="line"></span><br><span class="line">[root@router network-scripts]<span class="comment"># cat ifcfg-eth0</span></span><br><span class="line">DEVICE=eth0</span><br><span class="line">NAME=eth0</span><br><span class="line">BOOTPROTO=static</span><br><span class="line">IPADDR=10.0.0.200</span><br><span class="line">PREFIX=24</span><br><span class="line">ONBOOT=<span class="built_in">yes</span></span><br><span class="line"></span><br><span class="line">[root@router network-scripts]<span class="comment"># cat ifcfg-eth1</span></span><br><span class="line">DEVICE=eth1</span><br><span class="line">NAME=eth1</span><br><span class="line">BOOTPROTO=static</span><br><span class="line">IPADDR=192.168.10.200</span><br><span class="line">PREFIX=24</span><br><span class="line">ONBOOT=<span class="built_in">yes</span></span><br><span class="line"></span><br><span class="line"><span class="comment">######################################################################################</span></span><br><span class="line"><span class="comment">#RS1的网络配置</span></span><br><span class="line">[root@rs1 ~]<span class="comment"># hostname </span></span><br><span class="line">rs1.wang.org</span><br><span class="line"></span><br><span class="line">[root@rs1 ~]<span class="comment"># hostname -I</span></span><br><span class="line">10.0.0.7</span><br><span class="line"></span><br><span class="line">[root@rs1 ~]<span class="comment"># cat /etc/sysconfig/network-scripts/ifcfg-eth0 </span></span><br><span class="line">DEVICE=eth0</span><br><span class="line">NAME=eth0</span><br><span class="line">BOOTPROTO=static</span><br><span class="line">IPADDR=10.0.0.7</span><br><span class="line">PREFIX=24</span><br><span class="line">GATEWAY=10.0.0.200</span><br><span class="line">ONBOOT=<span class="built_in">yes</span></span><br><span class="line"></span><br><span class="line">[root@rs1 ~]<span class="comment"># route -n</span></span><br><span class="line">Kernel IP routing table</span><br><span class="line">Destination     Gateway         Genmask         Flags Metric Ref   Use Iface</span><br><span class="line">0.0.0.0         10.0.0.200      0.0.0.0         UG    100    0        0 eth0</span><br><span class="line">10.0.0.0        0.0.0.0         255.255.255.0   U     100    0        0 eth0</span><br><span class="line"></span><br><span class="line">[root@rs1 ~]<span class="comment"># yum -y install httpd</span></span><br><span class="line">[root@rs1 ~]<span class="comment"># systemctl enable --now httpd </span></span><br><span class="line">[root@rs1 ~]<span class="comment"># hostname -I &gt; /var/www/html/index.html</span></span><br><span class="line">[root@rs1 ~]<span class="comment"># ping 192.168.10.6 -c1</span></span><br><span class="line">PING 192.168.10.6 (192.168.10.6) 56(84) bytes of data.</span><br><span class="line">64 bytes from 192.168.10.6: icmp_seq=1 ttl=63 time=1.14 ms</span><br><span class="line"></span><br><span class="line">[root@rs1 ~]<span class="comment">#curl 10.0.0.7</span></span><br><span class="line">10.0.0.7 </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">######################################################################################</span></span><br><span class="line"><span class="comment">#RS2 的网络配置</span></span><br><span class="line">[root@rs2 ~]<span class="comment"># cat /etc/sysconfig/network-scripts/ifcfg-eth0</span></span><br><span class="line">DEVICE=eth0</span><br><span class="line">NAME=eth0</span><br><span class="line">BOOTPROTO=static</span><br><span class="line">IPADDR=10.0.0.17</span><br><span class="line">PREFIX=24</span><br><span class="line">GATEWAY=10.0.0.200</span><br><span class="line">ONBOOT=<span class="built_in">yes</span></span><br><span class="line">[root@rs2 ~]<span class="comment"># route -n</span></span><br><span class="line">Kernel IP routing table</span><br><span class="line">Destination     Gateway         Genmask         Flags Metric Ref   Use Iface</span><br><span class="line">0.0.0.0         10.0.0.200      0.0.0.0         UG    100    0        0 eth0</span><br><span class="line">10.0.0.0        0.0.0.0         255.255.255.0   U     100    0        0 eth0</span><br><span class="line"></span><br><span class="line">[root@rs2 ~]<span class="comment"># yum -y install httpd</span></span><br><span class="line">[root@rs2 ~]<span class="comment"># systemctl enable --now httpd</span></span><br><span class="line">[root@rs2 ~]<span class="comment"># hostname -I &gt; /var/www/html/index.html</span></span><br><span class="line">[root@rs2 ~]<span class="comment"># curl 10.0.0.17</span></span><br><span class="line">10.0.0.17 </span><br><span class="line"></span><br><span class="line">[root@rs1 ~]<span class="comment"># ping 192.168.10.6 -c1</span></span><br><span class="line">PING 192.168.10.6 (192.168.10.6) 56(84) bytes of data.</span><br><span class="line">64 bytes from 192.168.10.6: icmp_seq=1 ttl=63 time=1.14 ms</span><br><span class="line"></span><br><span class="line">[root@rs2 ~]<span class="comment"># curl 10.0.0.17</span></span><br><span class="line">10.0.0.17</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">######################################################################################</span></span><br><span class="line"><span class="comment">#LVS的网络配置</span></span><br><span class="line">[root@lvs ~]<span class="comment"># hostname </span></span><br><span class="line">lvs.wang.org</span><br><span class="line"></span><br><span class="line">[root@lvs ~]<span class="comment"># hostname -I</span></span><br><span class="line">10.0.0.8 </span><br><span class="line"></span><br><span class="line">[root@lvs ~]<span class="comment"># cat /etc/sysconfig/network-scripts/ifcfg-eth0</span></span><br><span class="line">DEVICE=eth0</span><br><span class="line">NAME=eth0</span><br><span class="line">BOOTPROTO=static</span><br><span class="line">IPADDR=10.0.0.8</span><br><span class="line">PREFIX=24</span><br><span class="line">GATEWAY=10.0.0.200</span><br><span class="line">ONBOOT=<span class="built_in">yes</span></span><br><span class="line"></span><br><span class="line">[root@lvs ~]<span class="comment"># route -n</span></span><br><span class="line">Kernel IP routing table</span><br><span class="line">Destination     Gateway         Genmask         Flags Metric Ref   Use Iface</span><br><span class="line">0.0.0.0         10.0.0.200      0.0.0.0         UG    100    0        0 eth0</span><br><span class="line">10.0.0.0        0.0.0.0         255.255.255.0   U     100    0        0 eth0</span><br><span class="line"></span><br><span class="line">[root@lvs ~]<span class="comment"># ping 192.168.10.6 -c1</span></span><br><span class="line">PING 192.168.10.6 (192.168.10.6) 56(84) bytes of data.</span><br><span class="line">64 bytes from 192.168.10.6: icmp_seq=1 ttl=63 time=2.32 ms</span><br></pre></td></tr></table></figure>

<h3 id="后端RS的IPVS配置"><a href="#后端RS的IPVS配置" class="headerlink" title="后端RS的IPVS配置"></a>后端RS的IPVS配置</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#RS1的IPVS配置</span></span><br><span class="line">[root@rs1 ~]<span class="comment"># echo 1 &gt;   /proc/sys/net/ipv4/conf/all/arp_ignore</span></span><br><span class="line">[root@rs1 ~]<span class="comment"># echo 2 &gt;   /proc/sys/net/ipv4/conf/all/arp_announce </span></span><br><span class="line">[root@rs1 ~]<span class="comment"># echo 1 &gt;   /proc/sys/net/ipv4/conf/lo/arp_ignore</span></span><br><span class="line">[root@rs1 ~]<span class="comment"># echo 2 &gt;   /proc/sys/net/ipv4/conf/lo/arp_announce </span></span><br><span class="line">[root@rs1 ~]<span class="comment"># ifconfig lo:1 10.0.0.100/32</span></span><br><span class="line">[root@rs1 ~]<span class="comment"># ip a</span></span><br><span class="line">1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group </span><br><span class="line">default qlen 1000</span><br><span class="line">   <span class="built_in">link</span>/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00</span><br><span class="line">   inet 127.0.0.1/8 scope host lo</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">   inet 10.0.0.100/0 scope global lo:1</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">   inet6 ::1/128 scope host </span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">2: eth0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc pfifo_fast state UP </span><br><span class="line">group default qlen 1000</span><br><span class="line">   <span class="built_in">link</span>/ether 00:0c:29:01:f9:48 brd ff:ff:ff:ff:ff:ff</span><br><span class="line">   inet 10.0.0.7/24 brd 10.0.0.255 scope global noprefixroute eth0</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">   inet6 fe80::20c:29ff:fe01:f948/64 scope <span class="built_in">link</span> </span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    </span><br><span class="line"><span class="comment">#RS2的IPVS配置</span></span><br><span class="line">[root@rs2 ~]<span class="comment"># echo 1 &gt;   /proc/sys/net/ipv4/conf/all/arp_ignore</span></span><br><span class="line">[root@rs2 ~]<span class="comment"># echo 1 &gt;   /proc/sys/net/ipv4/conf/lo/arp_ignore</span></span><br><span class="line">[root@rs2 ~]<span class="comment"># echo 2 &gt;   /proc/sys/net/ipv4/conf/all/arp_announce </span></span><br><span class="line">[root@rs2 ~]<span class="comment"># echo 2 &gt;   /proc/sys/net/ipv4/conf/lo/arp_announce</span></span><br><span class="line">[root@rs2 ~]<span class="comment"># ifconfig lo:1 10.0.0.100/32</span></span><br><span class="line">[root@rs2 ~]<span class="comment"># ip a</span></span><br><span class="line">1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group </span><br><span class="line">default qlen 1000</span><br><span class="line">   <span class="built_in">link</span>/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00</span><br><span class="line">   inet 127.0.0.1/8 scope host lo</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">   inet 10.0.0.100/0 scope global lo:1</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">   inet6 ::1/128 scope host </span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">2: eth0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc pfifo_fast state UP </span><br><span class="line">group default qlen 1000</span><br><span class="line">   <span class="built_in">link</span>/ether 00:0c:29:94:1a:f6 brd ff:ff:ff:ff:ff:ff</span><br><span class="line">   inet 10.0.0.17/24 brd 10.0.0.255 scope global noprefixroute eth0</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">   inet6 fe80::20c:29ff:fe94:1af6/64 scope <span class="built_in">link</span> </span><br><span class="line">       valid_lft forever preferred_lft forever</span><br></pre></td></tr></table></figure>

<h3 id="LVS主机的配置"><a href="#LVS主机的配置" class="headerlink" title="LVS主机的配置"></a>LVS主机的配置</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#在LVS上添加VIP</span></span><br><span class="line">[root@lvs ~]<span class="comment"># ifconfig lo:1 10.0.0.100/32</span></span><br><span class="line">[root@lvs ~]<span class="comment"># ip a</span></span><br><span class="line">1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group </span><br><span class="line">default qlen 1000</span><br><span class="line">   <span class="built_in">link</span>/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00</span><br><span class="line">   inet 127.0.0.1/8 scope host lo</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">   inet 10.0.0.100/0 scope global lo:1</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">   inet6 ::1/128 scope host </span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">2: eth0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc fq_codel state UP </span><br><span class="line">group default qlen 1000</span><br><span class="line">   <span class="built_in">link</span>/ether 00:0c:29:8a:51:21 brd ff:ff:ff:ff:ff:ff</span><br><span class="line">   inet 10.0.0.8/24 brd 10.0.0.255 scope global noprefixroute eth0</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">       </span><br><span class="line">       </span><br><span class="line"><span class="comment">#实现LVS 规则</span></span><br><span class="line">[root@lvs ~]<span class="comment"># dnf -y install ipvsadm</span></span><br><span class="line">[root@lvs ~]<span class="comment"># ipvsadm -A -t 10.0.0.100:80 -s rr</span></span><br><span class="line">[root@lvs ~]<span class="comment"># ipvsadm -a -t 10.0.0.100:80 -r 10.0.0.7:80 -g </span></span><br><span class="line">[root@lvs ~]<span class="comment"># ipvsadm -a -t 10.0.0.100:80 -r 10.0.0.17:80 -g </span></span><br><span class="line">[root@lvs ~]<span class="comment"># ipvsadm -Ln</span></span><br><span class="line">IP Virtual Server version 1.2.1 (size=4096)</span><br><span class="line">Prot LocalAddress:Port Scheduler Flags</span><br><span class="line">  -&gt; RemoteAddress:Port           Forward Weight ActiveConn InActConn</span><br><span class="line">TCP  10.0.0.100:80 rr</span><br><span class="line">  -&gt; 10.0.0.7:80                  Route   1      0          0         </span><br><span class="line">  -&gt; 10.0.0.17:80                 Route   1      0          0 </span><br></pre></td></tr></table></figure>

<h3 id="测试访问"><a href="#测试访问" class="headerlink" title="测试访问"></a>测试访问</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[root@internet ~]<span class="comment"># curl 10.0.0.100</span></span><br><span class="line">10.0.0.17 </span><br><span class="line"></span><br><span class="line">[root@internet ~]<span class="comment"># curl 10.0.0.100</span></span><br><span class="line">10.0.0.7 </span><br><span class="line"></span><br><span class="line">[root@rs1 ~]<span class="comment"># tail -f /var/log/httpd/access_log -n0</span></span><br><span class="line">192.168.10.6 - - [12/Jul/2020:10:36:21 +0800] <span class="string">&quot;GET / HTTP/1.1&quot;</span> 200 10 <span class="string">&quot;-&quot;</span></span><br><span class="line"><span class="string">&quot;curl/7.19.7 (x86_64-redhat-linux-gnu) libcurl/7.19.7 NSS/3.27.1 zlib/1.2.3 </span></span><br><span class="line"><span class="string">libidn/1.18 libssh2/1.4.2&quot;</span></span><br></pre></td></tr></table></figure>

<p><img src="../../../../images/SRE/day27/19.png" alt="19"></p>
<h3 id="思考"><a href="#思考" class="headerlink" title="思考"></a>思考</h3><h4 id="LVS的eth0的网关可否不配置？如果随便配置，发现什么问题？如果不配-置，怎么解决？"><a href="#LVS的eth0的网关可否不配置？如果随便配置，发现什么问题？如果不配-置，怎么解决？" class="headerlink" title="LVS的eth0的网关可否不配置？如果随便配置，发现什么问题？如果不配 置，怎么解决？"></a>LVS的eth0的网关可否不配置？如果随便配置，发现什么问题？如果不配 置，怎么解决？</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#默认值为1</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># cat /proc/sys/net/ipv4/conf/all/rp_filter</span></span><br><span class="line">1</span><br><span class="line"></span><br><span class="line"><span class="comment">#修改内核参数为0</span></span><br><span class="line">[root@lvs ~]<span class="comment"># echo &quot;0&quot; &gt; /proc/sys/net/ipv4/conf/all/rp_filter</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#说明:参数rp_filter用来控制系统是否开启对数据包源地址的校验。</span></span><br><span class="line"><span class="comment">#0标示不开启地址校验</span></span><br><span class="line"><span class="comment">#1表开启严格的反向路径校验。对每一个收到的数据包，校验其反向路径是否是最佳路径。如果反向路径不是最佳路径，则直接丢弃该数据包；</span></span><br><span class="line"><span class="comment">#2表示开启松散的反向路径校验，对每个收到的数据包，校验其源地址是否可以到达，即反向路径是否可以ping通，如反向路径不通，则直接丢弃该数据包。</span></span><br></pre></td></tr></table></figure>

<h4 id="LVS的VIP可以配置到lo网卡-但必须使用32位的netmask-为什么"><a href="#LVS的VIP可以配置到lo网卡-但必须使用32位的netmask-为什么" class="headerlink" title="LVS的VIP可以配置到lo网卡,但必须使用32位的netmask,为什么?"></a>LVS的VIP可以配置到lo网卡,但必须使用32位的netmask,为什么?</h4><p>范例：</p>
<p><img src="../../../../images/SRE/day27/20.png" alt="20"></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">环境：五台主机</span><br><span class="line">一台：客户端 172.20.200.6/16 GW:172.20.200.200</span><br><span class="line"></span><br><span class="line">一台：ROUTER</span><br><span class="line">eth0 :NAT 10.0.0.200/24 VIP</span><br><span class="line">eth1: 桥接 172.20.200.200/16</span><br><span class="line">启用 IP_FORWARD</span><br><span class="line"></span><br><span class="line">一台：LVS</span><br><span class="line">eth0: 10.0.0.8/24 GW:10.0.0.200</span><br><span class="line"></span><br><span class="line">两台RS：</span><br><span class="line">RS1：10.0.0.7/24 GW：10.0.0.200</span><br><span class="line">RS2：10.0.0.17/24 GW：10.0.0.200</span><br></pre></td></tr></table></figure>

<p>配置：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br></pre></td><td class="code"><pre><span class="line">[root@client ~]<span class="comment"># cat /etc/sysconfig/network-scripts/ifcfg-eth0 </span></span><br><span class="line">DEVICE=eth0</span><br><span class="line">NAME=eth0</span><br><span class="line">BOOTPROTO=static</span><br><span class="line">IPADDR=172.20.200.6</span><br><span class="line">PREFIX=16</span><br><span class="line">GATEWAY=172.20.200.200</span><br><span class="line">ONBOOT=<span class="built_in">yes</span></span><br><span class="line"></span><br><span class="line">[root@Router ~]<span class="comment"># cat /etc/sysconfig/network-scripts/ifcfg-eth0</span></span><br><span class="line">DEVICE=eth0</span><br><span class="line">NAME=eth0</span><br><span class="line">BOOTPROTO=static</span><br><span class="line">IPADDR=10.0.0.200</span><br><span class="line">PREFIX=24</span><br><span class="line">ONBOOT=<span class="built_in">yes</span></span><br><span class="line"></span><br><span class="line">[root@Router ~]<span class="comment"># cat /etc/sysconfig/network-scripts/ifcfg-eth1</span></span><br><span class="line">DEVICE=eth1</span><br><span class="line">NAME=eth1</span><br><span class="line">BOOTPROTO=static</span><br><span class="line">IPADDR=172.20.200.200</span><br><span class="line">PREFIX=16</span><br><span class="line">ONBOOT=<span class="built_in">yes</span></span><br><span class="line"></span><br><span class="line">[root@Router ~]<span class="comment"># cat /etc/sysctl.conf </span></span><br><span class="line">net.ipv4.ip_forward=1</span><br><span class="line"></span><br><span class="line">[root@Router ~]<span class="comment"># sysctl -p </span></span><br><span class="line">[root@rs1 ~]<span class="comment"># cat /etc/sysconfig/network-scripts/ifcfg-eth0 </span></span><br><span class="line">DEVICE=eth0</span><br><span class="line">NAME=eth0</span><br><span class="line">BOOTPROTO=static</span><br><span class="line">IPADDR=10.0.0.7</span><br><span class="line">PREFIX=24</span><br><span class="line">GATEWAY=10.0.0.200</span><br><span class="line">ONBOOT=<span class="built_in">yes</span></span><br><span class="line"></span><br><span class="line">[root@rs1 ~]<span class="comment"># echo 1 &gt;   /proc/sys/net/ipv4/conf/all/arp_ignore</span></span><br><span class="line">[root@rs1 ~]<span class="comment"># echo 2 &gt;   /proc/sys/net/ipv4/conf/all/arp_announce </span></span><br><span class="line">[root@rs1 ~]<span class="comment"># echo 1 &gt;   /proc/sys/net/ipv4/conf/lo/arp_ignore</span></span><br><span class="line">[root@rs1 ~]<span class="comment"># echo 2 &gt;   /proc/sys/net/ipv4/conf/lo/arp_announce </span></span><br><span class="line">[root@rs1 ~]<span class="comment"># ifconfig lo:1 10.0.0.100/32</span></span><br><span class="line">[root@rs1 ~]<span class="comment"># ip a</span></span><br><span class="line">1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group </span><br><span class="line">default qlen 1000</span><br><span class="line">   <span class="built_in">link</span>/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00</span><br><span class="line">   inet 127.0.0.1/8 scope host lo</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">   inet 10.0.0.100/0 scope global lo:1</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">   inet6 ::1/128 scope host </span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">2: eth0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc pfifo_fast state UP </span><br><span class="line">group default qlen 1000</span><br><span class="line">   <span class="built_in">link</span>/ether 00:0c:29:32:80:38 brd ff:ff:ff:ff:ff:ff</span><br><span class="line">   inet 10.0.0.7/24 brd 10.0.0.255 scope global noprefixroute eth0</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">   inet6 fe80::20c:29ff:fe32:8038/64 scope <span class="built_in">link</span> </span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">       </span><br><span class="line">[root@rs2 ~]<span class="comment"># cat /etc/sysconfig/network-scripts/ifcfg-eth0 </span></span><br><span class="line">DEVICE=eth0</span><br><span class="line">NAME=eth0</span><br><span class="line">BOOTPROTO=static</span><br><span class="line">IPADDR=10.0.0.17</span><br><span class="line">PREFIX=24</span><br><span class="line">GATEWAY=10.0.0.200</span><br><span class="line">ONBOOT=<span class="built_in">yes</span></span><br><span class="line"></span><br><span class="line">[root@rs2 ~]<span class="comment"># echo 1 &gt;   /proc/sys/net/ipv4/conf/all/arp_ignore</span></span><br><span class="line">[root@rs2 ~]<span class="comment"># echo 2 &gt;   /proc/sys/net/ipv4/conf/all/arp_announce </span></span><br><span class="line">[root@rs2 ~]<span class="comment"># echo 1 &gt;   /proc/sys/net/ipv4/conf/lo/arp_ignore</span></span><br><span class="line">[root@rs2 ~]<span class="comment"># echo 2 &gt;   /proc/sys/net/ipv4/conf/lo/arp_announce</span></span><br><span class="line">[root@rs2 ~]<span class="comment"># ifconfig lo:1 10.0.0.100/32</span></span><br><span class="line">[root@LVS ~]<span class="comment"># cat /etc/sysconfig/network-scripts/ifcfg-eth0 </span></span><br><span class="line">DEVICE=eth0</span><br><span class="line">NAME=eth0</span><br><span class="line">BOOTPROTO=static</span><br><span class="line">IPADDR=10.0.0.8</span><br><span class="line">PREFIX=24</span><br><span class="line">GATEWAY=10.0.0.200</span><br><span class="line">ONBOOT=<span class="built_in">yes</span></span><br><span class="line"></span><br><span class="line">[root@LVS ~]<span class="comment"># ifconfig lo:1 10.0.0.100/32</span></span><br><span class="line">[root@LVS ~]<span class="comment"># ipvsadm -A -t 10.0.0.100:80 -s wrr </span></span><br><span class="line">[root@LVS ~]<span class="comment"># ipvsadm -a -t 10.0.0.100:80 -r 10.0.0.7 -g -w 3 </span></span><br><span class="line">[root@LVS ~]<span class="comment"># ipvsadm -a -t 10.0.0.100:80 -r 10.0.0.17 -g </span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#如果LVS没有配置网关（网关随意，只有要即可），也可以通过修改内核关闭路径反向校验实现</span></span><br><span class="line">[root@lvs ~]<span class="comment"># echo &quot;0&quot; &gt; /proc/sys/net/ipv4/conf/all/rp_filter</span></span><br><span class="line">[root@lvs ~]<span class="comment"># echo &quot;0&quot; &gt; /proc/sys/net/ipv4/conf/eth0/rp_filter</span></span><br></pre></td></tr></table></figure>

<h2 id="LVS-DR模式多网段案例"><a href="#LVS-DR模式多网段案例" class="headerlink" title="LVS-DR模式多网段案例"></a>LVS-DR模式多网段案例</h2><p>单网段的DR模式容易暴露后端RS服务器地址信息,可以使用跨网面的DR模型,实现更高的安全性</p>
<p><img src="../../../../images/SRE/day27/21.png" alt="21"></p>
<p>范例:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#internet主机的网络配置和4.2一样</span></span><br><span class="line">[root@internet ~]<span class="comment"># hostname -I</span></span><br><span class="line">192.168.10.6</span><br><span class="line"></span><br><span class="line"><span class="comment">#router的网络配置在4.2基础上添加172.16.0.200/24的地址</span></span><br><span class="line">[root@router ~]<span class="comment"># ip addr add 172.16.0.200/24 dev eth0</span></span><br><span class="line">[root@router ~]<span class="comment"># ip a</span></span><br><span class="line">1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group </span><br><span class="line">default qlen 1000</span><br><span class="line">   <span class="built_in">link</span>/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00</span><br><span class="line">   inet 127.0.0.1/8 scope host lo</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">   inet6 ::1/128 scope host </span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">2: eth0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc fq_codel state UP </span><br><span class="line">group default qlen 1000</span><br><span class="line">   <span class="built_in">link</span>/ether 00:0c:29:ab:8f:2b brd ff:ff:ff:ff:ff:ff</span><br><span class="line">   inet 10.0.0.200/24 brd 10.0.0.255 scope global noprefixroute eth0</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">   inet 172.16.0.200/24 brd 172.16.0.255 scope global noprefixroute eth0</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">   inet6 fe80::20c:29ff:feab:8f2b/64 scope <span class="built_in">link</span> tentative </span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">3: eth1: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc fq_codel state UP </span><br><span class="line">group default qlen 1000</span><br><span class="line">   <span class="built_in">link</span>/ether 00:0c:29:ab:8f:35 brd ff:ff:ff:ff:ff:ff</span><br><span class="line">   inet 192.168.10200/24 brd 192.168.10255 scope global noprefixroute eth1</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">   inet6 fe80::20c:29ff:feab:8f35/64 scope <span class="built_in">link</span> </span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line"></span><br><span class="line">[root@router ~]<span class="comment"># hostname -I</span></span><br><span class="line">10.0.0.200 172.16.0.200 192.168.10200 </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#LVS主机的网络配置和4.2一样</span></span><br><span class="line">[root@lvs ~]<span class="comment"># hostname -I</span></span><br><span class="line">10.0.0.8</span><br><span class="line"></span><br><span class="line">[root@lvs ~]<span class="comment"># route -n</span></span><br><span class="line">Kernel IP routing table</span><br><span class="line">Destination     Gateway         Genmask         Flags Metric Ref   Use Iface</span><br><span class="line">0.0.0.0         10.0.0.200      0.0.0.0         UG    0      0        0 eth0</span><br><span class="line">10.0.0.0        0.0.0.0         255.255.255.0   U     100    0        0 eth0</span><br><span class="line"></span><br><span class="line">[root@rs1 ~]<span class="comment"># hostname -I</span></span><br><span class="line">10.0.0.7 </span><br><span class="line"></span><br><span class="line">[root@rs1 ~]<span class="comment"># route -n</span></span><br><span class="line">Kernel IP routing table</span><br><span class="line">Destination     Gateway         Genmask         Flags Metric Ref   Use Iface</span><br><span class="line">0.0.0.0         10.0.0.200      0.0.0.0         UG    100    0        0 eth0</span><br><span class="line">10.0.0.0        0.0.0.0         255.255.255.0   U     100    0        0 eth0</span><br><span class="line"></span><br><span class="line"><span class="comment">#RS主机的网络配置和4.2一样</span></span><br><span class="line">[root@rs2 ~]<span class="comment"># hostname -I</span></span><br><span class="line">10.0.0.17 </span><br><span class="line"></span><br><span class="line">[root@rs2 ~]<span class="comment"># route -n</span></span><br><span class="line">Kernel IP routing table</span><br><span class="line">Destination     Gateway         Genmask         Flags Metric Ref   Use Iface</span><br><span class="line">0.0.0.0         10.0.0.200      0.0.0.0         UG    100    0        0 eth0</span><br><span class="line">10.0.0.0        0.0.0.0         255.255.255.0   U     100    0        0 eth0</span><br><span class="line"></span><br><span class="line"><span class="comment">#在LVS主机运行的脚本</span></span><br><span class="line"><span class="comment">#注意:VIP如果配置在LO网卡上,必须使用32bit子网掩码,如果VIP绑定在eth0上,可以是其它netmask</span></span><br><span class="line">[root@lvs ~]<span class="comment"># cat lvs_dr_vs.sh </span></span><br><span class="line"><span class="comment">#!/bin/bash</span></span><br><span class="line"><span class="comment">#Author:wangxiaochun</span></span><br><span class="line"><span class="comment">#Date:2017-08-13</span></span><br><span class="line">vip=<span class="string">&#x27;172.16.0.100&#x27;</span></span><br><span class="line">iface=<span class="string">&#x27;lo:1&#x27;</span></span><br><span class="line">mask=<span class="string">&#x27;255.255.255.255&#x27;</span></span><br><span class="line">port=<span class="string">&#x27;80&#x27;</span></span><br><span class="line">rs1=<span class="string">&#x27;10.0.0.7&#x27;</span></span><br><span class="line">rs2=<span class="string">&#x27;10.0.0.17&#x27;</span></span><br><span class="line">scheduler=<span class="string">&#x27;wrr&#x27;</span></span><br><span class="line"><span class="built_in">type</span>=<span class="string">&#x27;-g&#x27;</span></span><br><span class="line">rpm -q ipvsadm &amp;&gt; /dev/null || yum -y install ipvsadm &amp;&gt; /dev/null</span><br><span class="line"><span class="keyword">case</span> <span class="variable">$1</span> <span class="keyword">in</span></span><br><span class="line">start)</span><br><span class="line">   ifconfig <span class="variable">$iface</span> <span class="variable">$vip</span> netmask <span class="variable">$mask</span> <span class="comment">#broadcast $vip up</span></span><br><span class="line">   iptables -F</span><br><span class="line">   ipvsadm -A -t <span class="variable">$&#123;vip&#125;</span>:<span class="variable">$&#123;port&#125;</span> -s <span class="variable">$scheduler</span></span><br><span class="line">   ipvsadm -a -t <span class="variable">$&#123;vip&#125;</span>:<span class="variable">$&#123;port&#125;</span> -r <span class="variable">$&#123;rs1&#125;</span> <span class="variable">$type</span> -w 1</span><br><span class="line">   ipvsadm -a -t <span class="variable">$&#123;vip&#125;</span>:<span class="variable">$&#123;port&#125;</span> -r <span class="variable">$&#123;rs2&#125;</span> <span class="variable">$type</span> -w 1</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;The VS Server is Ready!&quot;</span></span><br><span class="line">   ;;</span><br><span class="line">stop)</span><br><span class="line">   ipvsadm -C</span><br><span class="line">   ifconfig <span class="variable">$iface</span> down</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;The VS Server is Canceled!&quot;</span></span><br><span class="line">   ;;</span><br><span class="line">*)</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;Usage: <span class="subst">$(basename $0)</span> start|stop&quot;</span></span><br><span class="line">    <span class="built_in">exit</span> 1</span><br><span class="line">   ;;</span><br><span class="line"><span class="keyword">esac</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@lvs ~]<span class="comment"># bash lvs_dr_vs.sh start</span></span><br><span class="line">The VS Server is Ready!</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#在RS后端服务器运行的脚本</span></span><br><span class="line">[root@rs1 ~]<span class="comment">#cat lvs_dr_rs.sh </span></span><br><span class="line"><span class="comment">#!/bin/bash</span></span><br><span class="line"><span class="comment">#Author:wangxiaochun</span></span><br><span class="line"><span class="comment">#Date:2017-08-13</span></span><br><span class="line">vip=172.16.0.100</span><br><span class="line">mask=<span class="string">&#x27;255.255.255.255&#x27;</span></span><br><span class="line">dev=lo:1</span><br><span class="line">rpm -q httpd &amp;&gt; /dev/null || yum -y install httpd &amp;&gt;/dev/null</span><br><span class="line">service httpd start &amp;&gt; /dev/null &amp;&amp; <span class="built_in">echo</span> <span class="string">&quot;The httpd Server is Ready!&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;`hostname -I`&quot;</span> &gt; /var/www/html/index.html</span><br><span class="line"><span class="keyword">case</span> <span class="variable">$1</span> <span class="keyword">in</span></span><br><span class="line">start)</span><br><span class="line">    <span class="built_in">echo</span> 1 &gt; /proc/sys/net/ipv4/conf/all/arp_ignore</span><br><span class="line">    <span class="built_in">echo</span> 1 &gt; /proc/sys/net/ipv4/conf/lo/arp_ignore</span><br><span class="line">    <span class="built_in">echo</span> 2 &gt; /proc/sys/net/ipv4/conf/all/arp_announce</span><br><span class="line">    <span class="built_in">echo</span> 2 &gt; /proc/sys/net/ipv4/conf/lo/arp_announce</span><br><span class="line">   ifconfig <span class="variable">$dev</span> <span class="variable">$vip</span> netmask <span class="variable">$mask</span> <span class="comment">#broadcast $vip up</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;The RS Server is Ready!&quot;</span></span><br><span class="line">   ;;</span><br><span class="line">stop)</span><br><span class="line">   ifconfig <span class="variable">$dev</span> down</span><br><span class="line">    <span class="built_in">echo</span> 0 &gt; /proc/sys/net/ipv4/conf/all/arp_ignore</span><br><span class="line">    <span class="built_in">echo</span> 0 &gt; /proc/sys/net/ipv4/conf/lo/arp_ignore</span><br><span class="line">    <span class="built_in">echo</span> 0 &gt; /proc/sys/net/ipv4/conf/all/arp_announce</span><br><span class="line">    <span class="built_in">echo</span> 0 &gt; /proc/sys/net/ipv4/conf/lo/arp_announce</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;The RS Server is Canceled!&quot;</span></span><br><span class="line">   ;;</span><br><span class="line">*) </span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;Usage: <span class="subst">$(basename $0)</span> start|stop&quot;</span></span><br><span class="line">    <span class="built_in">exit</span> 1</span><br><span class="line">   ;;</span><br><span class="line"><span class="keyword">esac</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@rs1 ~]<span class="comment"># bash lvs_dr_rs.sh start</span></span><br><span class="line">The RS Server is Ready!</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#在RS后端服务器运行的脚本和RS1是一样的</span></span><br><span class="line">[root@rs2 ~]<span class="comment"># bash lvs_dr_rs.sh start</span></span><br><span class="line">The RS Server is Ready!</span><br><span class="line"></span><br><span class="line"><span class="comment">#测试访问</span></span><br><span class="line">[root@internet ~]<span class="comment">#curl 172.16.0.100</span></span><br><span class="line">10.0.0.7 </span><br><span class="line"></span><br><span class="line">[root@internet ~]<span class="comment">#curl 172.16.0.100</span></span><br><span class="line">10.0.0.17 </span><br></pre></td></tr></table></figure>

<p>范例2</p>
<p><img src="../../../../images/SRE/day27/22.png" alt="22"></p>
<p><strong>RS 的配置脚本</strong></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line">vip=10.0.0.100</span><br><span class="line">mask=<span class="string">&#x27;255.255.255.255&#x27;</span></span><br><span class="line">dev=lo:1</span><br><span class="line"><span class="keyword">case</span> <span class="variable">$1</span> <span class="keyword">in</span></span><br><span class="line">start)</span><br><span class="line">     <span class="built_in">echo</span> 1 &gt; /proc/sys/net/ipv4/conf/all/arp_ignore</span><br><span class="line">     <span class="built_in">echo</span> 1 &gt; /proc/sys/net/ipv4/conf/lo/arp_ignore</span><br><span class="line">     <span class="built_in">echo</span> 2 &gt; /proc/sys/net/ipv4/conf/all/arp_announce</span><br><span class="line">     <span class="built_in">echo</span> 2 &gt; /proc/sys/net/ipv4/conf/lo/arp_announce</span><br><span class="line">     ifconfig <span class="variable">$dev</span> <span class="variable">$vip</span> netmask <span class="variable">$You</span> can<span class="string">&#x27;t use &#x27;</span>macro parameter character <span class="comment">#&#x27; in </span></span><br><span class="line">math modemask <span class="comment">#broadcast $vip up</span></span><br><span class="line">     <span class="comment">#route add -host $vip dev $dev</span></span><br><span class="line">     ;;</span><br><span class="line">stop)</span><br><span class="line">     ifconfig <span class="variable">$dev</span> down</span><br><span class="line">     <span class="built_in">echo</span> 0 &gt; /proc/sys/net/ipv4/conf/all/arp_ignore</span><br><span class="line">     <span class="built_in">echo</span> 0 &gt; /proc/sys/net/ipv4/conf/lo/arp_ignore</span><br><span class="line">     <span class="built_in">echo</span> 0 &gt; /proc/sys/net/ipv4/conf/all/arp_announce</span><br><span class="line">     <span class="built_in">echo</span> 0 &gt; /proc/sys/net/ipv4/conf/lo/arp_announce</span><br><span class="line">     ;;</span><br><span class="line">*) </span><br><span class="line">     <span class="built_in">echo</span> <span class="string">&quot;Usage: <span class="subst">$(basename $0)</span> start|stop&quot;</span></span><br><span class="line">     <span class="built_in">exit</span> 1</span><br><span class="line">     ;;</span><br><span class="line"><span class="keyword">esac</span></span><br></pre></td></tr></table></figure>

<p><strong>VS的配置脚本</strong></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line">vip=<span class="string">&#x27;10.0.0.100&#x27;</span></span><br><span class="line">iface=<span class="string">&#x27;lo:1&#x27;</span></span><br><span class="line">mask=<span class="string">&#x27;255.255.255.255&#x27;</span></span><br><span class="line">port=<span class="string">&#x27;80&#x27;</span></span><br><span class="line">rs1=<span class="string">&#x27;192.168.8.101&#x27;</span></span><br><span class="line">rs2=<span class="string">&#x27;192.168.8.102&#x27;</span></span><br><span class="line">scheduler=<span class="string">&#x27;wrr&#x27;</span></span><br><span class="line"><span class="built_in">type</span>=<span class="string">&#x27;-g&#x27;</span></span><br><span class="line"><span class="keyword">case</span> <span class="variable">$1</span> <span class="keyword">in</span></span><br><span class="line">start)</span><br><span class="line"> ifconfig <span class="variable">$iface</span> <span class="variable">$vip</span> netmask <span class="variable">$mask</span> <span class="comment">#broadcast $vip up</span></span><br><span class="line"> iptables -F</span><br><span class="line"> ipvsadm -A -t <span class="variable">$&#123;vip&#125;</span>:<span class="variable">$&#123;port&#125;</span> -s <span class="variable">$scheduler</span></span><br><span class="line"> ipvsadm -a -t <span class="variable">$&#123;vip&#125;</span>:<span class="variable">$&#123;port&#125;</span> -r <span class="variable">$&#123;rs1&#125;</span> <span class="variable">$type</span> -w 1</span><br><span class="line"> ipvsadm -a -t <span class="variable">$&#123;vip&#125;</span>:<span class="variable">$&#123;port&#125;</span> -r <span class="variable">$&#123;rs2&#125;</span> <span class="variable">$type</span> -w 1</span><br><span class="line"> ;;</span><br><span class="line">stop)</span><br><span class="line"> ipvsadm -C</span><br><span class="line"> ifconfig <span class="variable">$iface</span> down</span><br><span class="line"> ;;</span><br><span class="line">*)</span><br><span class="line"> <span class="built_in">echo</span> <span class="string">&quot;Usage <span class="subst">$(basename $0)</span> start|stop“</span></span><br><span class="line"><span class="string"> exit 1</span></span><br><span class="line"><span class="string">esac</span></span><br></pre></td></tr></table></figure>

<p><strong>范例3: 跨网段DR模型案例</strong></p>
<p><img src="../../../../images/SRE/day27/23.png" alt="23"></p>
<p><strong>配置</strong></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br></pre></td><td class="code"><pre><span class="line">[root@rs1 ~]<span class="comment"># cat lvs_dr_rs.sh </span></span><br><span class="line"><span class="comment">#!/bin/bash</span></span><br><span class="line"><span class="comment">#Author:wangxiaochun</span></span><br><span class="line"><span class="comment">#Date:2017-08-13</span></span><br><span class="line">vip=192.168.10100</span><br><span class="line">mask=<span class="string">&#x27;255.255.255.255&#x27;</span></span><br><span class="line">dev=lo:1</span><br><span class="line"><span class="comment">#rpm -q httpd &amp;&gt; /dev/null || yum -y install httpd &amp;&gt;/dev/null</span></span><br><span class="line"><span class="comment">#service httpd start &amp;&gt; /dev/null &amp;&amp; echo &quot;The httpd Server is Ready!&quot;</span></span><br><span class="line"><span class="comment">#echo &quot;&lt;h1&gt;`hostname`&lt;/h1&gt;&quot; &gt; /var/www/html/index.html</span></span><br><span class="line"><span class="keyword">case</span> <span class="variable">$1</span> <span class="keyword">in</span></span><br><span class="line">start)</span><br><span class="line">    <span class="built_in">echo</span> 1 &gt; /proc/sys/net/ipv4/conf/all/arp_ignore</span><br><span class="line">    <span class="built_in">echo</span> 1 &gt; /proc/sys/net/ipv4/conf/lo/arp_ignore</span><br><span class="line">    <span class="built_in">echo</span> 2 &gt; /proc/sys/net/ipv4/conf/all/arp_announce</span><br><span class="line">    <span class="built_in">echo</span> 2 &gt; /proc/sys/net/ipv4/conf/lo/arp_announce</span><br><span class="line">   ifconfig <span class="variable">$dev</span> <span class="variable">$vip</span> netmask <span class="variable">$mask</span> <span class="comment">#broadcast $vip up</span></span><br><span class="line">    <span class="comment">#route add -host $vip dev $dev</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;The RS Server is Ready!&quot;</span></span><br><span class="line">   ;;</span><br><span class="line">stop)</span><br><span class="line">   ifconfig <span class="variable">$dev</span> down</span><br><span class="line">    <span class="built_in">echo</span> 0 &gt; /proc/sys/net/ipv4/conf/all/arp_ignore</span><br><span class="line">    <span class="built_in">echo</span> 0 &gt; /proc/sys/net/ipv4/conf/lo/arp_ignore</span><br><span class="line">    <span class="built_in">echo</span> 0 &gt; /proc/sys/net/ipv4/conf/all/arp_announce</span><br><span class="line">    <span class="built_in">echo</span> 0 &gt; /proc/sys/net/ipv4/conf/lo/arp_announce</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;The RS Server is Canceled!&quot;</span></span><br><span class="line">   ;;</span><br><span class="line">*) </span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;Usage: <span class="subst">$(basename $0)</span> start|stop&quot;</span></span><br><span class="line">    <span class="built_in">exit</span> 1</span><br><span class="line">   ;;</span><br><span class="line"><span class="keyword">esac</span></span><br><span class="line"></span><br><span class="line">[root@rs1 ~]<span class="comment"># bash lvs_dr_rs.sh start</span></span><br><span class="line">[root@rs2 ~]<span class="comment"># bash lvs_dr_rs.sh start</span></span><br><span class="line">[root@LVS ~]<span class="comment"># cat lvs_dr_vs.sh </span></span><br><span class="line"><span class="comment">#!/bin/bash</span></span><br><span class="line"><span class="comment">#Author:wangxiaochun</span></span><br><span class="line"><span class="comment">#Date:2017-08-13</span></span><br><span class="line">vip=<span class="string">&#x27;192.168.10100&#x27;</span></span><br><span class="line">iface=<span class="string">&#x27;lo:1&#x27;</span></span><br><span class="line">mask=<span class="string">&#x27;255.255.255.255&#x27;</span></span><br><span class="line">port=<span class="string">&#x27;80&#x27;</span></span><br><span class="line">rs1=<span class="string">&#x27;10.0.0.7&#x27;</span></span><br><span class="line">rs2=<span class="string">&#x27;10.0.0.17&#x27;</span></span><br><span class="line">scheduler=<span class="string">&#x27;wrr&#x27;</span></span><br><span class="line"><span class="built_in">type</span>=<span class="string">&#x27;-g&#x27;</span></span><br><span class="line">rpm -q ipvsadm &amp;&gt; /dev/null || yum -y install ipvsadm &amp;&gt; /dev/null</span><br><span class="line"><span class="keyword">case</span> <span class="variable">$1</span> <span class="keyword">in</span></span><br><span class="line">start)</span><br><span class="line">   ifconfig <span class="variable">$iface</span> <span class="variable">$vip</span> netmask <span class="variable">$mask</span> <span class="comment">#broadcast $vip up</span></span><br><span class="line">   iptables -F</span><br><span class="line">   ipvsadm -A -t <span class="variable">$&#123;vip&#125;</span>:<span class="variable">$&#123;port&#125;</span> -s <span class="variable">$scheduler</span></span><br><span class="line">   ipvsadm -a -t <span class="variable">$&#123;vip&#125;</span>:<span class="variable">$&#123;port&#125;</span> -r <span class="variable">$&#123;rs1&#125;</span> <span class="variable">$type</span> -w 1</span><br><span class="line">   ipvsadm -a -t <span class="variable">$&#123;vip&#125;</span>:<span class="variable">$&#123;port&#125;</span> -r <span class="variable">$&#123;rs2&#125;</span> <span class="variable">$type</span> -w 1</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;The VS Server is Ready!&quot;</span></span><br><span class="line">   ;;</span><br><span class="line">stop)</span><br><span class="line">   ipvsadm -C</span><br><span class="line">   ifconfig <span class="variable">$iface</span> down</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;The VS Server is Canceled!&quot;</span></span><br><span class="line">   ;;</span><br><span class="line">*)</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;Usage: <span class="subst">$(basename $0)</span> start|stop&quot;</span></span><br><span class="line">    <span class="built_in">exit</span> 1</span><br><span class="line">   ;;</span><br><span class="line"><span class="keyword">esac</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@LVS ~]<span class="comment"># bash lvs_dr_vs.sh start</span></span><br><span class="line">[root@Router ~]<span class="comment"># nmcli connection modify eth0 +ipv4.addresses 192.168.10200/24 </span></span><br><span class="line">[root@Router ~]<span class="comment"># nmcli connection reload</span></span><br><span class="line">[root@Router ~]<span class="comment"># nmcli connection up eth0</span></span><br><span class="line">[root@Router ~]<span class="comment"># ip a</span></span><br><span class="line">1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group </span><br><span class="line">default qlen 1000</span><br><span class="line">   <span class="built_in">link</span>/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00</span><br><span class="line">   inet 127.0.0.1/8 scope host lo</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">   inet6 ::1/128 scope host </span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">2: eth0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc fq_codel state UP </span><br><span class="line">group default qlen 1000</span><br><span class="line">   <span class="built_in">link</span>/ether 00:0c:29:4d:ef:3e brd ff:ff:ff:ff:ff:ff</span><br><span class="line">   inet 10.0.0.200/24 brd 10.0.0.255 scope global noprefixroute eth0</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">   inet 192.168.10200/24 brd 192.168.10255 scope global noprefixroute eth0</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">   inet6 fe80::20c:29ff:fe4d:ef3e/64 scope <span class="built_in">link</span> </span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">3: eth1: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc fq_codel state UP </span><br><span class="line">group default qlen 1000</span><br><span class="line">   <span class="built_in">link</span>/ether 00:0c:29:4d:ef:48 brd ff:ff:ff:ff:ff:ff</span><br><span class="line">   inet 172.20.200.200/16 brd 172.20.255.255 scope global noprefixroute eth1</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">   inet6 fe80::20c:29ff:fe4d:ef48/64 scope <span class="built_in">link</span> </span><br><span class="line">       valid_lft forever preferred_lft forever</span><br></pre></td></tr></table></figure>

<h2 id="LVS-TUNNEL隧道模式案例"><a href="#LVS-TUNNEL隧道模式案例" class="headerlink" title="LVS-TUNNEL隧道模式案例"></a>LVS-TUNNEL隧道模式案例</h2><p><img src="../../../../images/SRE/day27/24.png" alt="24"></p>
<h3 id="LVS服务器配置"><a href="#LVS服务器配置" class="headerlink" title="LVS服务器配置"></a>LVS服务器配置</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line">[root@centos8 ~]<span class="comment"># ip a</span></span><br><span class="line">1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group </span><br><span class="line">default qlen 1000</span><br><span class="line">   <span class="built_in">link</span>/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00</span><br><span class="line">   inet 127.0.0.1/8 scope host lo</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">   inet6 ::1/128 scope host </span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">2: eth0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc fq_codel state UP </span><br><span class="line">group default qlen 1000</span><br><span class="line">   <span class="built_in">link</span>/ether 00:0c:29:44:c3:fe brd ff:ff:ff:ff:ff:ff</span><br><span class="line">   inet 10.0.0.8/24 brd 10.0.0.255 scope global noprefixroute eth0</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">   inet6 fe80::20c:29ff:fe44:c3fe/64 scope <span class="built_in">link</span> </span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">       </span><br><span class="line"><span class="comment">#开启tunnel网卡并配置VIP</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># ifconfig tunl0 10.0.0.100 netmask 255.255.255.255 up</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#或者下面方法,注意设备名必须为tunl0</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># ip addr add 10.0.0.100/32 dev tunl0</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># ip link set up tunl0</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#自动加载ipip模块</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># lsmod |grep ipip</span></span><br><span class="line">ipip                   16384  0</span><br><span class="line">tunnel4                16384  1 ipip</span><br><span class="line">ip_tunnel              28672  1 ipip</span><br><span class="line"></span><br><span class="line">[root@centos8 ~]<span class="comment"># ip a</span></span><br><span class="line">1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group </span><br><span class="line">default qlen 1000</span><br><span class="line">   <span class="built_in">link</span>/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00</span><br><span class="line">   inet 127.0.0.1/8 scope host lo</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">   inet6 ::1/128 scope host </span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">2: eth0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc fq_codel state UP </span><br><span class="line">group default qlen 1000</span><br><span class="line">   <span class="built_in">link</span>/ether 00:0c:29:44:c3:fe brd ff:ff:ff:ff:ff:ff</span><br><span class="line">   inet 10.0.0.8/24 brd 10.0.0.255 scope global noprefixroute eth0</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">   inet6 fe80::20c:29ff:fe44:c3fe/64 scope <span class="built_in">link</span> </span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">3: tunl0@NONE: &lt;NOARP,UP,LOWER_UP&gt; mtu 1480 qdisc noqueue state UNKNOWN group </span><br><span class="line">default qlen 1000</span><br><span class="line">   <span class="built_in">link</span>/ipip 0.0.0.0 brd 0.0.0.0</span><br><span class="line">   inet 10.0.0.100/32 scope global tunl0</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line"></span><br><span class="line">[root@centos8 ~]<span class="comment"># yum -y install ipvsadm</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># ipvsadm -A -t 10.0.0.100:80 -s rr</span></span><br><span class="line">[root@centos8 ~]<span class="comment"># ipvsadm -a -t 10.0.0.100:80 -r 10.0.0.7 -i </span></span><br><span class="line">[root@centos8 ~]<span class="comment"># ipvsadm -a -t 10.0.0.100:80 -r 10.0.0.17 -i </span></span><br><span class="line">[root@centos8 ~]<span class="comment"># ipvsadm -Ln</span></span><br><span class="line">IP Virtual Server version 1.2.1 (size=4096)</span><br><span class="line">Prot LocalAddress:Port Scheduler Flags</span><br><span class="line">  -&gt; RemoteAddress:Port           Forward Weight ActiveConn InActConn</span><br><span class="line">TCP  10.0.0.100:80 rr</span><br><span class="line">  -&gt; 10.0.0.7:80                  Tunnel  1      0          0         </span><br><span class="line">  -&gt; 10.0.0.17:80                 Tunnel  1      0          0 </span><br></pre></td></tr></table></figure>

<h3 id="RS服务器配置"><a href="#RS服务器配置" class="headerlink" title="RS服务器配置"></a>RS服务器配置</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#RS服务器配置,RS1和RS2配置相同</span></span><br><span class="line">[root@rs1 ~]<span class="comment">#hostname </span></span><br><span class="line">rs1.wang.org</span><br><span class="line">[root@rs1 ~]<span class="comment">#hostname -I</span></span><br><span class="line">10.0.0.7 </span><br><span class="line">[root@rs1 ~]<span class="comment">#route -n</span></span><br><span class="line">Kernel IP routing table</span><br><span class="line">Destination     Gateway         Genmask         Flags Metric Ref   Use Iface</span><br><span class="line">0.0.0.0         10.0.0.200      0.0.0.0         UG    100    0        0 eth0</span><br><span class="line">10.0.0.0        0.0.0.0         255.255.255.0   U     100    0        0 eth0</span><br><span class="line"><span class="comment">#开启tunnel网卡并配置VIP</span></span><br><span class="line">[root@rs1 ~]<span class="comment">#ifconfig tunl0 10.0.0.100 netmask 255.255.255.255 up </span></span><br><span class="line">[root@rs1 ~]<span class="comment">#ip a</span></span><br><span class="line">1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group </span><br><span class="line">default qlen 1000</span><br><span class="line">   <span class="built_in">link</span>/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00</span><br><span class="line">   inet 127.0.0.1/8 scope host lo</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">   inet6 ::1/128 scope host </span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">2: eth0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc pfifo_fast state UP </span><br><span class="line">group default qlen 1000</span><br><span class="line">   <span class="built_in">link</span>/ether 00:0c:29:01:f9:48 brd ff:ff:ff:ff:ff:ff</span><br><span class="line">   inet 10.0.0.7/24 brd 10.0.0.255 scope global noprefixroute eth0</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">   inet6 fe80::20c:29ff:fe01:f948/64 scope <span class="built_in">link</span> </span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">3: tunl0@NONE: &lt;NOARP,UP,LOWER_UP&gt; mtu 1480 qdisc noqueue state UNKNOWN group </span><br><span class="line">default qlen 1000</span><br><span class="line">   <span class="built_in">link</span>/ipip 0.0.0.0 brd 0.0.0.0</span><br><span class="line">   inet 10.0.0.100/32 scope global tunl0</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">       </span><br><span class="line"><span class="comment">#修改内核参数  </span></span><br><span class="line">[root@rs1 ~]<span class="comment">#echo &quot;1&quot; &gt; /proc/sys/net/ipv4/conf/tunl0/arp_ignore        </span></span><br><span class="line">[root@rs1 ~]<span class="comment">#echo &quot;2&quot; &gt; /proc/sys/net/ipv4/conf/tunl0/arp_announce</span></span><br><span class="line">[root@rs1 ~]<span class="comment">#echo &quot;1&quot; &gt; /proc/sys/net/ipv4/conf/all/arp_ignore</span></span><br><span class="line">[root@rs1 ~]<span class="comment">#echo &quot;2&quot; &gt; /proc/sys/net/ipv4/conf/all/arp_announce</span></span><br><span class="line"><span class="comment">#以下参数用来控制系统是否开启对数据包源地址的校验。0表示不开启地址校验；1表示开启严格的反向路径</span></span><br><span class="line">校验。对每一个进行的数据包，校验其反向路径是否是最佳路径。如果反向路径不是最佳路径，则直接丢弃该</span><br><span class="line">数据包；2标示开启松散的反向路径校验，对每个进行的数据包，校验其源地址是否可以到达，即反向路径是否</span><br><span class="line">可以ping通，如反向路径不通，则直接丢弃该数据包。</span><br><span class="line"><span class="comment">#默认值为1</span></span><br><span class="line">[root@centos8 ~]<span class="comment">#cat /proc/sys/net/ipv4/conf/all/rp_filter</span></span><br><span class="line">1</span><br><span class="line"><span class="comment">#必须修改内核参数为0或2</span></span><br><span class="line">[root@rs1 ~]<span class="comment">#echo &quot;0&quot; &gt; /proc/sys/net/ipv4/conf/tunl0/rp_filter</span></span><br><span class="line"><span class="comment">#可选项</span></span><br><span class="line">[root@rs1 ~]<span class="comment">#echo &quot;0&quot; &gt; /proc/sys/net/ipv4/conf/all/rp_filter</span></span><br><span class="line">[root@rs1 ~]<span class="comment">#yum -y install httpd</span></span><br><span class="line">[root@rs1 ~]<span class="comment">#systemctl enable --now httpd</span></span><br><span class="line">[root@rs1 ~]<span class="comment">#hostname &gt; /var/www/html/index.html</span></span><br></pre></td></tr></table></figure>

<h3 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@internet ~]<span class="comment"># while :;do curl 10.0.0.100;sleep 0.3;done</span></span><br><span class="line">rs2.wang.org</span><br><span class="line">rs1.wang.org</span><br><span class="line">rs2.wang.org</span><br><span class="line">rs1.wang.org</span><br></pre></td></tr></table></figure>

<p><img src="../../../../images/SRE/day27/25.png" alt="25"></p>
<p><img src="../../../../images/SRE/day27/26.png" alt="26"></p>
<h1 id="LVS-高可用性实现"><a href="#LVS-高可用性实现" class="headerlink" title="LVS 高可用性实现"></a>LVS 高可用性实现</h1><p><strong>LVS 不可用时：</strong></p>
<p>Director不可用，整个系统将不可用；SPoF Single Point of Failure</p>
<p>解决方案：高可用，keepalived、heartbeat/corosync</p>
<p><strong>RS 不可用时：</strong></p>
<p>某RS不可用时，Director依然会调度请求至此RS</p>
<p>解决方案： 由Director对各RS健康状态进行检查，失败时禁用，成功时启用</p>
<p>常用解决方案：</p>
<ul>
<li>keepalived</li>
<li>heartbeat/corosync</li>
<li>ldirectord</li>
</ul>
<p>检测方式：</p>
<ul>
<li>网络层检测，icmp</li>
<li>传输层检测，端口探测</li>
<li>应用层检测，请求某关键资源 </li>
</ul>
<p>RS全不用时：backup server, sorry server</p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="http://example.com">૮(˶ᵔ ᵕ ᵔ˶)ა</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="http://example.com/2025/02/21/SRE-LVS/">http://example.com/2025/02/21/SRE-LVS/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="http://example.com" target="_blank">૮(˶ᵔ ᵕ ᵔ˶)ა</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/LVS/">LVS</a><a class="post-meta__tags" href="/tags/SRE/">SRE</a></div><div class="post_share"><div class="social-share" data-image="/../images/SRE/day27/3.png" data-sites="wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2025/02/21/ST-%E9%85%8D%E7%BD%AElinux%E9%82%AE%E7%AE%B1%E5%8F%91%E9%80%81/" title="配置linux邮箱"><img class="cover" src="/../images/TITLE/network.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">配置linux邮箱</div></div></a></div><div class="next-post pull-right"><a href="/2025/03/03/SRE-Nginx/" title="企业级高性能WEB服务Nginx"><img class="cover" src="/../images/TITLE/nginx_logo.png" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">企业级高性能WEB服务Nginx</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><div><a href="/2023/04/10/DN-LVS%E9%9B%86%E7%BE%A4/" title="LVS集群"><img class="cover" src="/../images/TITLE/lvs.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-04-10</div><div class="title">LVS集群</div></div></a></div><div><a href="/2025/04/16/SRE-Keepalived/" title="高可用性集群Keepalived"><img class="cover" src="/../images/SRE/day48/1.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2025-04-16</div><div class="title">高可用性集群Keepalived</div></div></a></div><div><a href="/2025/04/15/SRE-HAProxy/" title="高可用性集群HAProxy"><img class="cover" src="/../images/SRE/day47/1.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2025-04-15</div><div class="title">高可用性集群HAProxy</div></div></a></div><div><a href="/2024/04/24/SRE-Linux%E5%9F%BA%E6%9C%AC%E6%93%8D%E4%BD%9C%E5%92%8C%E5%B8%AE%E5%8A%A9/" title="Linux基本操作和帮助"><img class="cover" src="/../images/TITLE/linux2.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-04-24</div><div class="title">Linux基本操作和帮助</div></div></a></div><div><a href="/2024/08/27/SRE-Linux%E6%96%87%E4%BB%B6%E7%AE%A1%E7%90%86%E5%92%8CIO%E9%87%8D%E5%AE%9A%E5%90%91/" title="Linux文件管理和IO重定向"><img class="cover" src="/../images/TITLE/linux3.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-08-27</div><div class="title">Linux文件管理和IO重定向</div></div></a></div><div><a href="/2024/12/08/SRE-Linux%E9%98%B2%E7%81%AB%E5%A2%99/" title="Linux防火墙"><img class="cover" src="/../images/SRE/day17/12.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-12-08</div><div class="title">Linux防火墙</div></div></a></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="/../images/TITLE/user.webp" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">૮(˶ᵔ ᵕ ᵔ˶)ა</div><div class="author-info__description">这家伙很勤奋，什么都留下了</div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">99</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">41</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">34</div></a></div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content is-expand"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E9%9B%86%E7%BE%A4%E5%92%8C%E5%88%86%E5%B8%83%E5%BC%8F"><span class="toc-number">1.</span> <span class="toc-text">集群和分布式</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%9B%86%E7%BE%A4-Cluster"><span class="toc-number">1.1.</span> <span class="toc-text">集群 Cluster</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%86%E5%B8%83%E5%BC%8F%E7%B3%BB%E7%BB%9F"><span class="toc-number">1.2.</span> <span class="toc-text">分布式系统</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%9B%86%E7%BE%A4%E5%92%8C%E5%88%86%E5%B8%83%E5%BC%8F-1"><span class="toc-number">1.3.</span> <span class="toc-text">集群和分布式</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#LB-Cluster-%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E9%9B%86%E7%BE%A4"><span class="toc-number">1.4.</span> <span class="toc-text">LB Cluster 负载均衡集群</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%8C%89%E5%AE%9E%E7%8E%B0%E6%96%B9%E5%BC%8F%E5%88%92%E5%88%86"><span class="toc-number">1.4.1.</span> <span class="toc-text">按实现方式划分</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9F%BA%E4%BA%8E%E5%B7%A5%E4%BD%9C%E7%9A%84%E5%8D%8F%E8%AE%AE%E5%B1%82%E6%AC%A1%E5%88%92%E5%88%86"><span class="toc-number">1.4.2.</span> <span class="toc-text">基于工作的协议层次划分</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E7%9A%84%E4%BC%9A%E8%AF%9D%E4%BF%9D%E6%8C%81"><span class="toc-number">1.4.3.</span> <span class="toc-text">负载均衡的会话保持</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#HA-%E9%AB%98%E5%8F%AF%E7%94%A8%E9%9B%86%E7%BE%A4%E5%AE%9E%E7%8E%B0"><span class="toc-number">1.5.</span> <span class="toc-text">HA 高可用集群实现</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Linux-Virtual-Server-%E7%AE%80%E4%BB%8B"><span class="toc-number">2.</span> <span class="toc-text">Linux Virtual Server 简介</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#LVS-%E4%BB%8B%E7%BB%8D"><span class="toc-number">2.1.</span> <span class="toc-text">LVS 介绍</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#LVS-%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86"><span class="toc-number">2.2.</span> <span class="toc-text">LVS 工作原理</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#LVS-%E9%9B%86%E7%BE%A4%E4%BD%93%E7%B3%BB%E6%9E%B6%E6%9E%84"><span class="toc-number">2.3.</span> <span class="toc-text">LVS 集群体系架构</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#LVS-%E9%9B%86%E7%BE%A4%E7%B1%BB%E5%9E%8B%E4%B8%AD%E7%9A%84%E6%9C%AF%E8%AF%AD"><span class="toc-number">2.4.</span> <span class="toc-text">LVS 集群类型中的术语</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#LVS-%E5%B7%A5%E4%BD%9C%E6%A8%A1%E5%BC%8F%E5%92%8C%E7%9B%B8%E5%85%B3%E5%91%BD%E4%BB%A4"><span class="toc-number">3.</span> <span class="toc-text">LVS 工作模式和相关命令</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#LVS-%E9%9B%86%E7%BE%A4%E7%9A%84%E5%B7%A5%E4%BD%9C%E6%A8%A1%E5%BC%8F"><span class="toc-number">3.1.</span> <span class="toc-text">LVS 集群的工作模式</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#LVS-%E7%9A%84-NAT-%E6%A8%A1%E5%BC%8F"><span class="toc-number">3.1.1.</span> <span class="toc-text">LVS 的 NAT 模式</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#LVS-%E7%9A%84-DR-%E6%A8%A1%E5%BC%8F"><span class="toc-number">3.1.2.</span> <span class="toc-text">LVS 的 DR 模式</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#LVS-%E7%9A%84-TUN-%E6%A8%A1%E5%BC%8F"><span class="toc-number">3.1.3.</span> <span class="toc-text">LVS 的 TUN 模式</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#LVS-%E7%9A%84-FULLNAT-%E6%A8%A1%E5%BC%8F"><span class="toc-number">3.1.4.</span> <span class="toc-text">LVS 的 FULLNAT 模式</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#LVS%E5%B7%A5%E4%BD%9C%E6%A8%A1%E5%BC%8F%E6%80%BB%E7%BB%93%E5%92%8C%E6%AF%94%E8%BE%83"><span class="toc-number">3.1.5.</span> <span class="toc-text">LVS工作模式总结和比较</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#LVS-%E8%B0%83%E5%BA%A6%E7%AE%97%E6%B3%95"><span class="toc-number">3.2.</span> <span class="toc-text">LVS 调度算法</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%9D%99%E6%80%81%E6%96%B9%E6%B3%95"><span class="toc-number">3.2.1.</span> <span class="toc-text">静态方法</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8A%A8%E6%80%81%E6%96%B9%E6%B3%95"><span class="toc-number">3.2.2.</span> <span class="toc-text">动态方法</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%86%85%E6%A0%B8%E7%89%88%E6%9C%AC-4-15-%E7%89%88%E6%9C%AC%E5%90%8E%E6%96%B0%E5%A2%9E%E8%B0%83%E5%BA%A6%E7%AE%97%E6%B3%95%EF%BC%9AFO%E5%92%8COVF"><span class="toc-number">3.2.3.</span> <span class="toc-text">内核版本 4.15 版本后新增调度算法：FO和OVF</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#LVS-%E7%9B%B8%E5%85%B3%E8%BD%AF%E4%BB%B6"><span class="toc-number">3.3.</span> <span class="toc-text">LVS 相关软件</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%A8%8B%E5%BA%8F%E5%8C%85%EF%BC%9Aipvsadm"><span class="toc-number">3.3.1.</span> <span class="toc-text">程序包：ipvsadm</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ipvsadm-%E5%91%BD%E4%BB%A4"><span class="toc-number">3.3.2.</span> <span class="toc-text">ipvsadm 命令</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%98%B2%E7%81%AB%E5%A2%99%E6%A0%87%E8%AE%B0"><span class="toc-number">3.4.</span> <span class="toc-text">防火墙标记</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#LVS-%E6%8C%81%E4%B9%85%E8%BF%9E%E6%8E%A5"><span class="toc-number">3.5.</span> <span class="toc-text">LVS 持久连接</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#LVS-%E5%AE%9E%E6%88%98%E6%A1%88%E4%BE%8B"><span class="toc-number">4.</span> <span class="toc-text">LVS 实战案例</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#LVS-NAT%E6%A8%A1%E5%BC%8F%E6%A1%88%E4%BE%8B"><span class="toc-number">4.1.</span> <span class="toc-text">LVS-NAT模式案例</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#LVS-DR%E6%A8%A1%E5%BC%8F%E5%8D%95%E7%BD%91%E6%AE%B5%E6%A1%88%E4%BE%8B"><span class="toc-number">4.2.</span> <span class="toc-text">LVS-DR模式单网段案例</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#LVS%E7%9A%84%E7%BD%91%E7%BB%9C%E9%85%8D%E7%BD%AE"><span class="toc-number">4.2.1.</span> <span class="toc-text">LVS的网络配置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%90%8E%E7%AB%AFRS%E7%9A%84IPVS%E9%85%8D%E7%BD%AE"><span class="toc-number">4.2.2.</span> <span class="toc-text">后端RS的IPVS配置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#LVS%E4%B8%BB%E6%9C%BA%E7%9A%84%E9%85%8D%E7%BD%AE"><span class="toc-number">4.2.3.</span> <span class="toc-text">LVS主机的配置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B5%8B%E8%AF%95%E8%AE%BF%E9%97%AE"><span class="toc-number">4.2.4.</span> <span class="toc-text">测试访问</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%80%9D%E8%80%83"><span class="toc-number">4.2.5.</span> <span class="toc-text">思考</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#LVS%E7%9A%84eth0%E7%9A%84%E7%BD%91%E5%85%B3%E5%8F%AF%E5%90%A6%E4%B8%8D%E9%85%8D%E7%BD%AE%EF%BC%9F%E5%A6%82%E6%9E%9C%E9%9A%8F%E4%BE%BF%E9%85%8D%E7%BD%AE%EF%BC%8C%E5%8F%91%E7%8E%B0%E4%BB%80%E4%B9%88%E9%97%AE%E9%A2%98%EF%BC%9F%E5%A6%82%E6%9E%9C%E4%B8%8D%E9%85%8D-%E7%BD%AE%EF%BC%8C%E6%80%8E%E4%B9%88%E8%A7%A3%E5%86%B3%EF%BC%9F"><span class="toc-number">4.2.5.1.</span> <span class="toc-text">LVS的eth0的网关可否不配置？如果随便配置，发现什么问题？如果不配 置，怎么解决？</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#LVS%E7%9A%84VIP%E5%8F%AF%E4%BB%A5%E9%85%8D%E7%BD%AE%E5%88%B0lo%E7%BD%91%E5%8D%A1-%E4%BD%86%E5%BF%85%E9%A1%BB%E4%BD%BF%E7%94%A832%E4%BD%8D%E7%9A%84netmask-%E4%B8%BA%E4%BB%80%E4%B9%88"><span class="toc-number">4.2.5.2.</span> <span class="toc-text">LVS的VIP可以配置到lo网卡,但必须使用32位的netmask,为什么?</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#LVS-DR%E6%A8%A1%E5%BC%8F%E5%A4%9A%E7%BD%91%E6%AE%B5%E6%A1%88%E4%BE%8B"><span class="toc-number">4.3.</span> <span class="toc-text">LVS-DR模式多网段案例</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#LVS-TUNNEL%E9%9A%A7%E9%81%93%E6%A8%A1%E5%BC%8F%E6%A1%88%E4%BE%8B"><span class="toc-number">4.4.</span> <span class="toc-text">LVS-TUNNEL隧道模式案例</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#LVS%E6%9C%8D%E5%8A%A1%E5%99%A8%E9%85%8D%E7%BD%AE"><span class="toc-number">4.4.1.</span> <span class="toc-text">LVS服务器配置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#RS%E6%9C%8D%E5%8A%A1%E5%99%A8%E9%85%8D%E7%BD%AE"><span class="toc-number">4.4.2.</span> <span class="toc-text">RS服务器配置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B5%8B%E8%AF%95"><span class="toc-number">4.4.3.</span> <span class="toc-text">测试</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#LVS-%E9%AB%98%E5%8F%AF%E7%94%A8%E6%80%A7%E5%AE%9E%E7%8E%B0"><span class="toc-number">5.</span> <span class="toc-text">LVS 高可用性实现</span></a></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2025/04/21/SRE-kafka/" title="消息队列和微服务"><img src="/../images/SRE/day52/30.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="消息队列和微服务"/></a><div class="content"><a class="title" href="/2025/04/21/SRE-kafka/" title="消息队列和微服务">消息队列和微服务</a><time datetime="2025-04-21T15:34:02.000Z" title="发表于 2025-04-21 23:34:02">2025-04-21</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2025/04/19/SRE-redis/" title="企业级NoSQL数据库Redis"><img src="/../images/SRE/day49/1.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="企业级NoSQL数据库Redis"/></a><div class="content"><a class="title" href="/2025/04/19/SRE-redis/" title="企业级NoSQL数据库Redis">企业级NoSQL数据库Redis</a><time datetime="2025-04-19T15:34:02.000Z" title="发表于 2025-04-19 23:34:02">2025-04-19</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2025/04/16/SRE-Keepalived/" title="高可用性集群Keepalived"><img src="/../images/SRE/day48/1.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="高可用性集群Keepalived"/></a><div class="content"><a class="title" href="/2025/04/16/SRE-Keepalived/" title="高可用性集群Keepalived">高可用性集群Keepalived</a><time datetime="2025-04-16T09:15:13.000Z" title="发表于 2025-04-16 17:15:13">2025-04-16</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2025/04/15/SRE-HAProxy/" title="高可用性集群HAProxy"><img src="/../images/SRE/day47/1.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="高可用性集群HAProxy"/></a><div class="content"><a class="title" href="/2025/04/15/SRE-HAProxy/" title="高可用性集群HAProxy">高可用性集群HAProxy</a><time datetime="2025-04-15T15:51:45.000Z" title="发表于 2025-04-15 23:51:45">2025-04-15</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2023 - 2025 By ૮(˶ᵔ ᵕ ᵔ˶)ა</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div><div class="footer_custom_text"><a target="_blank" rel="noopener" href="https://beian.miit.gov.cn/#/Integrated/index"><img src="../images/BEIAN/icp.png" width="15" height="15">豫ICP备2023009931号</a></br><a href="http://www.beian.gov.cn/portal/registerSystemInfo?recordcode=41162702000178" target="_blank"><img src="../images/BEIAN/beian.png" width="15" height="15">豫公网安备 41162702000178号</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.umd.min.js"></script><script src="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.js"></script><script>function panguFn () {
  if (typeof pangu === 'object') pangu.autoSpacingPage()
  else {
    getScript('https://cdn.jsdelivr.net/npm/pangu/dist/browser/pangu.min.js')
      .then(() => {
        pangu.autoSpacingPage()
      })
  }
}

function panguInit () {
  if (true){
    GLOBAL_CONFIG_SITE.isPost && panguFn()
  } else {
    panguFn()
  }
}

document.addEventListener('DOMContentLoaded', panguInit)</script><div class="js-pjax"></div><canvas id="universe"></canvas><script src="/js/universe.js"></script><canvas class="fireworks" mobile="true"></canvas><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/fireworks.min.js"></script><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/activate-power-mode.min.js"></script><script>POWERMODE.colorful = true;
POWERMODE.shake = false;
POWERMODE.mobile = false;
document.body.addEventListener('input', POWERMODE);
</script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>